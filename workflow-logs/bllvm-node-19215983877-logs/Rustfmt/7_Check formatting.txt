2025-11-09T23:19:31.8472759Z ##[group]Run cargo fmt -- --check
2025-11-09T23:19:31.8473072Z [36;1mcargo fmt -- --check[0m
2025-11-09T23:19:31.8505033Z shell: /usr/bin/bash -e {0}
2025-11-09T23:19:31.8505302Z env:
2025-11-09T23:19:31.8505497Z   CARGO_TERM_COLOR: always
2025-11-09T23:19:31.8505736Z   CARGO_HOME: /home/jswift/.cargo
2025-11-09T23:19:31.8505983Z   CARGO_INCREMENTAL: 0
2025-11-09T23:19:31.8506188Z ##[endgroup]
2025-11-09T23:19:32.1196692Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:332:
2025-11-09T23:19:32.1197914Z  pub enum PruningMode {
2025-11-09T23:19:32.1198321Z      /// No pruning (keep all blocks)
2025-11-09T23:19:32.1198713Z      Disabled,
2025-11-09T23:19:32.1198991Z -    
2025-11-09T23:19:32.1199243Z +
2025-11-09T23:19:32.1199605Z      /// Normal pruning (keep recent blocks for verification)
2025-11-09T23:19:32.1200072Z      Normal {
2025-11-09T23:19:32.1200418Z          /// Keep blocks from this height onwards
2025-11-09T23:19:32.1203268Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:342:
2025-11-09T23:19:32.1204070Z          #[serde(default = "default_min_recent_blocks")]
2025-11-09T23:19:32.1204833Z          min_recent_blocks: u64,
2025-11-09T23:19:32.1205189Z      },
2025-11-09T23:19:32.1205435Z -    
2025-11-09T23:19:32.1205684Z +
2025-11-09T23:19:32.1205983Z      /// Aggressive pruning with UTXO commitments
2025-11-09T23:19:32.1206574Z      /// Requires: utxo-commitments feature enabled
2025-11-09T23:19:32.1207407Z      Aggressive {
2025-11-09T23:19:32.1208363Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:359:
2025-11-09T23:19:32.1209096Z          #[serde(default = "default_min_blocks")]
2025-11-09T23:19:32.1209513Z          min_blocks: u64,
2025-11-09T23:19:32.1209832Z      },
2025-11-09T23:19:32.1210083Z -    
2025-11-09T23:19:32.1210327Z +
2025-11-09T23:19:32.1210917Z      /// Custom pruning configuration
2025-11-09T23:19:32.1211292Z      Custom {
2025-11-09T23:19:32.1211724Z          /// Keep block headers (always required for PoW verification)
2025-11-09T23:19:32.1212523Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:408:
2025-11-09T23:19:32.1213203Z      /// Pruning mode
2025-11-09T23:19:32.1213550Z      #[serde(default = "default_pruning_mode")]
2025-11-09T23:19:32.1213981Z      pub mode: PruningMode,
2025-11-09T23:19:32.1214503Z -    
2025-11-09T23:19:32.1214760Z +
2025-11-09T23:19:32.1227896Z      /// Automatic pruning (prune periodically as chain grows)
2025-11-09T23:19:32.1228481Z      #[serde(default = "default_false")]
2025-11-09T23:19:32.1228924Z      pub auto_prune: bool,
2025-11-09T23:19:32.1229483Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:415:
2025-11-09T23:19:32.1229942Z -    
2025-11-09T23:19:32.1230113Z +
2025-11-09T23:19:32.1230313Z      /// Automatic pruning interval (blocks)
2025-11-09T23:19:32.1230640Z      /// Prune every N blocks if auto_prune is enabled
2025-11-09T23:19:32.1230980Z      #[serde(default = "default_auto_prune_interval")]
2025-11-09T23:19:32.1231731Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:419:
2025-11-09T23:19:32.1232226Z      pub auto_prune_interval: u64,
2025-11-09T23:19:32.1232471Z -    
2025-11-09T23:19:32.1232634Z +
2025-11-09T23:19:32.1232833Z      /// Minimum blocks to keep (safety margin)
2025-11-09T23:19:32.1233185Z      /// Even with aggressive pruning, keep at least this many blocks
2025-11-09T23:19:32.1233557Z      #[serde(default = "default_min_blocks_to_keep")]
2025-11-09T23:19:32.1234019Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:424:
2025-11-09T23:19:32.1234733Z      pub min_blocks_to_keep: u64,
2025-11-09T23:19:32.1234970Z -    
2025-11-09T23:19:32.1235151Z +
2025-11-09T23:19:32.1235378Z      /// Prune on startup (prune old blocks when node starts)
2025-11-09T23:19:32.1235694Z      #[serde(default = "default_false")]
2025-11-09T23:19:32.1235969Z      pub prune_on_startup: bool,
2025-11-09T23:19:32.1236657Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:429:
2025-11-09T23:19:32.1237080Z -    
2025-11-09T23:19:32.1237239Z +
2025-11-09T23:19:32.1237559Z      /// Allow incremental pruning during IBD (requires UTXO commitments + aggressive mode)
2025-11-09T23:19:32.1238092Z      /// When enabled, old blocks are pruned incrementally during sync, keeping only a window
2025-11-09T23:19:32.1240036Z      /// of recent blocks. This prevents the need to download the full blockchain before pruning.
2025-11-09T23:19:32.1240609Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:433:
2025-11-09T23:19:32.1241028Z      #[serde(default = "default_false")]
2025-11-09T23:19:32.1241308Z      pub incremental_prune_during_ibd: bool,
2025-11-09T23:19:32.1241553Z -    
2025-11-09T23:19:32.1241719Z +
2025-11-09T23:19:32.1242000Z      /// Block window size for incremental pruning (number of recent blocks to keep)
2025-11-09T23:19:32.1242543Z      /// Only used when incremental_prune_during_ibd is true
2025-11-09T23:19:32.1242968Z      #[serde(default = "default_prune_window_size")]
2025-11-09T23:19:32.1243405Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:439:
2025-11-09T23:19:32.1243835Z      pub prune_window_size: u64,
2025-11-09T23:19:32.1244054Z -    
2025-11-09T23:19:32.1244219Z +
2025-11-09T23:19:32.1244685Z      /// Minimum blocks before starting incremental pruning during IBD
2025-11-09T23:19:32.1245066Z      /// Prevents pruning too early in the sync process
2025-11-09T23:19:32.1245420Z      #[serde(default = "default_min_blocks_for_incremental_prune")]
2025-11-09T23:19:32.1246064Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:444:
2025-11-09T23:19:32.1246509Z      pub min_blocks_for_incremental_prune: u64,
2025-11-09T23:19:32.1246943Z -    
2025-11-09T23:19:32.1247105Z +
2025-11-09T23:19:32.1247279Z      /// UTXO commitments integration
2025-11-09T23:19:32.1247547Z      #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.1247880Z      pub utxo_commitments: Option<UtxoCommitmentsPruningConfig>,
2025-11-09T23:19:32.1248377Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:449:
2025-11-09T23:19:32.1248775Z -    
2025-11-09T23:19:32.1248934Z +
2025-11-09T23:19:32.1249105Z      /// BIP158 filter integration
2025-11-09T23:19:32.1249352Z      #[cfg(feature = "bip158")]
2025-11-09T23:19:32.1249621Z      pub bip158_filters: Option<Bip158PruningConfig>,
2025-11-09T23:19:32.1250063Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:486:
2025-11-09T23:19:32.1250493Z                  keep_filtered_blocks: false,
2025-11-09T23:19:32.1250764Z                  min_blocks: 144, // ~1 day at 10 min/block
2025-11-09T23:19:32.1251018Z              },
2025-11-09T23:19:32.1251247Z -            auto_prune: true, // Enable automatic pruning
2025-11-09T23:19:32.1251584Z +            auto_prune: true,         // Enable automatic pruning
2025-11-09T23:19:32.1251919Z              auto_prune_interval: 144, // Prune every ~1 day
2025-11-09T23:19:32.1252202Z              min_blocks_to_keep: 144,
2025-11-09T23:19:32.1252496Z -            prune_on_startup: false, // Still false for safety
2025-11-09T23:19:32.1252907Z -            incremental_prune_during_ibd: true, // Enable incremental pruning during IBD
2025-11-09T23:19:32.1253378Z -            prune_window_size: 144, // Keep sliding window of 144 blocks during IBD
2025-11-09T23:19:32.1253788Z +            prune_on_startup: false,               // Still false for safety
2025-11-09T23:19:32.1254230Z +            incremental_prune_during_ibd: true,    // Enable incremental pruning during IBD
2025-11-09T23:19:32.1254929Z +            prune_window_size: 144,                // Keep sliding window of 144 blocks during IBD
2025-11-09T23:19:32.1255407Z              min_blocks_for_incremental_prune: 288, // Start pruning after 288 blocks (~2 days)
2025-11-09T23:19:32.1255972Z              #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.1256280Z              utxo_commitments: None,
2025-11-09T23:19:32.1256697Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:508:
2025-11-09T23:19:32.1257130Z      /// Keep UTXO commitments for pruned blocks
2025-11-09T23:19:32.1257407Z      #[serde(default = "default_true")]
2025-11-09T23:19:32.1257670Z      pub keep_commitments: bool,
2025-11-09T23:19:32.1257885Z -    
2025-11-09T23:19:32.1258045Z +
2025-11-09T23:19:32.1258268Z      /// Keep filtered blocks (spam-filtered) for pruned range
2025-11-09T23:19:32.1258577Z      #[serde(default = "default_false")]
2025-11-09T23:19:32.1258831Z      pub keep_filtered_blocks: bool,
2025-11-09T23:19:32.1259234Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:515:
2025-11-09T23:19:32.1259630Z -    
2025-11-09T23:19:32.1259785Z +
2025-11-09T23:19:32.1260029Z      /// Generate commitments before pruning (if not already generated)
2025-11-09T23:19:32.1260381Z      #[serde(default = "default_true")]
2025-11-09T23:19:32.1260634Z      pub generate_before_prune: bool,
2025-11-09T23:19:32.1261031Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:519:
2025-11-09T23:19:32.1261426Z -    
2025-11-09T23:19:32.1261580Z +
2025-11-09T23:19:32.1261797Z      /// Maximum age for commitments (days, 0 = keep forever)
2025-11-09T23:19:32.1262125Z      #[serde(default = "default_commitment_max_age")]
2025-11-09T23:19:32.1262415Z      pub max_commitment_age_days: u32,
2025-11-09T23:19:32.1262816Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:546:
2025-11-09T23:19:32.1263338Z      /// Keep BIP158 filters for pruned blocks
2025-11-09T23:19:32.1263606Z      #[serde(default = "default_true")]
2025-11-09T23:19:32.1263859Z      pub keep_filters: bool,
2025-11-09T23:19:32.1264201Z -    
2025-11-09T23:19:32.1264574Z +
2025-11-09T23:19:32.1264817Z      /// Keep filter header chain (always required for verification)
2025-11-09T23:19:32.1265151Z      #[serde(default = "default_true")]
2025-11-09T23:19:32.1265394Z      pub keep_filter_headers: bool,
2025-11-09T23:19:32.1265827Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:553:
2025-11-09T23:19:32.1266225Z -    
2025-11-09T23:19:32.1268220Z +
2025-11-09T23:19:32.1268433Z      /// Maximum age for filters (days, 0 = keep forever)
2025-11-09T23:19:32.1268734Z      #[serde(default = "default_filter_max_age")]
2025-11-09T23:19:32.1269012Z      pub max_filter_age_days: u32,
2025-11-09T23:19:32.1269407Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:578:
2025-11-09T23:19:32.1269826Z      /// Database backend selection
2025-11-09T23:19:32.1270091Z      #[serde(default = "default_database_backend")]
2025-11-09T23:19:32.1270404Z      pub database_backend: DatabaseBackendConfig,
2025-11-09T23:19:32.1270662Z -    
2025-11-09T23:19:32.1270818Z +
2025-11-09T23:19:32.1270988Z      /// Storage path
2025-11-09T23:19:32.1271211Z      #[serde(default = "default_storage_path")]
2025-11-09T23:19:32.1271481Z      pub data_dir: String,
2025-11-09T23:19:32.1271856Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:585:
2025-11-09T23:19:32.1272255Z -    
2025-11-09T23:19:32.1272404Z +
2025-11-09T23:19:32.1272653Z      /// Pruning configuration
2025-11-09T23:19:32.1273059Z      pub pruning: Option<PruningConfig>,
2025-11-09T23:19:32.1273314Z -    
2025-11-09T23:19:32.1273467Z +
2025-11-09T23:19:32.1273629Z      /// Cache sizes
2025-11-09T23:19:32.1273848Z      pub cache: Option<StorageCacheConfig>,
2025-11-09T23:19:32.1274103Z  }
2025-11-09T23:19:32.1274660Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:616:
2025-11-09T23:19:32.1275093Z      /// Block cache size (MB)
2025-11-09T23:19:32.1275358Z      #[serde(default = "default_block_cache_mb")]
2025-11-09T23:19:32.1275631Z      pub block_cache_mb: usize,
2025-11-09T23:19:32.1276013Z -    
2025-11-09T23:19:32.1276164Z +
2025-11-09T23:19:32.1276333Z      /// UTXO cache size (MB)
2025-11-09T23:19:32.1276575Z      #[serde(default = "default_utxo_cache_mb")]
2025-11-09T23:19:32.1276867Z      pub utxo_cache_mb: usize,
2025-11-09T23:19:32.1277473Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:623:
2025-11-09T23:19:32.1277949Z -    
2025-11-09T23:19:32.1278114Z +
2025-11-09T23:19:32.1278281Z      /// Header cache size (MB)
2025-11-09T23:19:32.1280350Z      #[serde(default = "default_header_cache_mb")]
2025-11-09T23:19:32.1280628Z      pub header_cache_mb: usize,
2025-11-09T23:19:32.1281027Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:668:
2025-11-09T23:19:32.1281453Z                  pruning.validate()?;
2025-11-09T23:19:32.1281692Z              }
2025-11-09T23:19:32.1281869Z          }
2025-11-09T23:19:32.1282037Z -        
2025-11-09T23:19:32.1282201Z +
2025-11-09T23:19:32.1282356Z          Ok(())
2025-11-09T23:19:32.1282525Z      }
2025-11-09T23:19:32.1282681Z  }
2025-11-09T23:19:32.1283008Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:686:
2025-11-09T23:19:32.1283414Z                  ));
2025-11-09T23:19:32.1283600Z              }
2025-11-09T23:19:32.1283763Z          }
2025-11-09T23:19:32.1283924Z -        
2025-11-09T23:19:32.1284078Z +
2025-11-09T23:19:32.1284464Z          // Validate min_blocks_to_keep is reasonable
2025-11-09T23:19:32.1284867Z          if self.min_blocks_to_keep == 0 {
2025-11-09T23:19:32.1291364Z              return Err(anyhow::anyhow!(
2025-11-09T23:19:32.1291853Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:693:
2025-11-09T23:19:32.1292360Z                  "min_blocks_to_keep must be greater than 0 for safety"
2025-11-09T23:19:32.1292854Z              ));
2025-11-09T23:19:32.1293041Z          }
2025-11-09T23:19:32.1293208Z -        
2025-11-09T23:19:32.1293377Z +
2025-11-09T23:19:32.1293561Z          // Validate auto_prune_interval
2025-11-09T23:19:32.1293870Z          if self.auto_prune && self.auto_prune_interval == 0 {
2025-11-09T23:19:32.1294194Z              return Err(anyhow::anyhow!(
2025-11-09T23:19:32.1294869Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:700:
2025-11-09T23:19:32.1295397Z                  "auto_prune_interval must be greater than 0 when auto_prune is enabled"
2025-11-09T23:19:32.1295732Z              ));
2025-11-09T23:19:32.1295911Z          }
2025-11-09T23:19:32.1296078Z -        
2025-11-09T23:19:32.1296354Z +
2025-11-09T23:19:32.1296667Z          // Validate mode-specific settings
2025-11-09T23:19:32.1297095Z          match &self.mode {
2025-11-09T23:19:32.1297458Z -            PruningMode::Normal { min_recent_blocks, .. } => {
2025-11-09T23:19:32.1297766Z +            PruningMode::Normal {
2025-11-09T23:19:32.1298019Z +                min_recent_blocks, ..
2025-11-09T23:19:32.1298254Z +            } => {
2025-11-09T23:19:32.1298461Z                  if *min_recent_blocks == 0 {
2025-11-09T23:19:32.1298735Z                      return Err(anyhow::anyhow!(
2025-11-09T23:19:32.1299081Z                          "min_recent_blocks must be greater than 0 in Normal pruning mode"
2025-11-09T23:19:32.1299586Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:728:
2025-11-09T23:19:32.1300002Z                  // No validation needed
2025-11-09T23:19:32.1300236Z              }
2025-11-09T23:19:32.1300397Z          }
2025-11-09T23:19:32.1300560Z -        
2025-11-09T23:19:32.1300713Z +
2025-11-09T23:19:32.1300868Z          Ok(())
2025-11-09T23:19:32.1301247Z      }
2025-11-09T23:19:32.1301407Z  }
2025-11-09T23:19:32.1301709Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/lib.rs:25:
2025-11-09T23:19:32.1302098Z  #[global_allocator]
2025-11-09T23:19:32.1302442Z  static GLOBAL: mimalloc::MiMalloc = mimalloc::MiMalloc;
2025-11-09T23:19:32.1302721Z  
2025-11-09T23:19:32.1303048Z -pub mod storage;
2025-11-09T23:19:32.1303252Z +pub mod bip21;
2025-11-09T23:19:32.1303431Z +pub mod config;
2025-11-09T23:19:32.1303614Z +pub mod module;
2025-11-09T23:19:32.1303788Z  pub mod network;
2025-11-09T23:19:32.1303967Z -pub mod rpc;
2025-11-09T23:19:32.1304137Z  pub mod node;
2025-11-09T23:19:32.1304502Z -pub mod config;
2025-11-09T23:19:32.1304745Z +pub mod rpc;
2025-11-09T23:19:32.1304918Z +pub mod storage;
2025-11-09T23:19:32.1305121Z  #[cfg(feature = "production")]
2025-11-09T23:19:32.1305347Z  pub mod validation;
2025-11-09T23:19:32.1305542Z -pub mod module;
2025-11-09T23:19:32.1305715Z -pub mod bip21;
2025-11-09T23:19:32.1305889Z  
2025-11-09T23:19:32.1306053Z  // Re-export config module
2025-11-09T23:19:32.1306283Z  pub use config::*;
2025-11-09T23:19:32.1306621Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/lib.rs:40:
2025-11-09T23:19:32.1307019Z  
2025-11-09T23:19:32.1307235Z  // Re-export commonly used types from protocol-engine
2025-11-09T23:19:32.1307711Z  // This allows depending only on protocol-engine (which transitively provides consensus-proof)
2025-11-09T23:19:32.1308166Z +pub use bllvm_protocol::mempool::Mempool;
2025-11-09T23:19:32.1310336Z  pub use bllvm_protocol::{
2025-11-09T23:19:32.1310681Z -    Block, BlockHeader, Transaction, TransactionInput, TransactionOutput,
2025-11-09T23:19:32.1311170Z -    OutPoint, UTXO, UtxoSet, ValidationResult, Hash, ByteString, Natural, Integer,
2025-11-09T23:19:32.1311562Z -    ConsensusError, Result,
2025-11-09T23:19:32.1311954Z +    Block, BlockHeader, ByteString, ConsensusError, Hash, Integer, Natural, OutPoint, Result,
2025-11-09T23:19:32.1312522Z +    Transaction, TransactionInput, TransactionOutput, UtxoSet, ValidationResult, UTXO,
2025-11-09T23:19:32.1312912Z  };
2025-11-09T23:19:32.1313105Z -pub use bllvm_protocol::mempool::Mempool;
2025-11-09T23:19:32.1313522Z  
2025-11-09T23:19:32.1313695Z  // Re-export protocol-engine types
2025-11-09T23:19:32.1314138Z  pub use bllvm_protocol::{BitcoinProtocolEngine, ProtocolVersion};
2025-11-09T23:19:32.1315133Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/lib.rs:81:
2025-11-09T23:19:32.1315614Z          // Test that protocol-engine works in reference-node context
2025-11-09T23:19:32.1316049Z          let node = ReferenceNode::new(Some(ProtocolVersion::Regtest)).unwrap();
2025-11-09T23:19:32.1316409Z          let protocol = node.protocol();
2025-11-09T23:19:32.1316651Z -        
2025-11-09T23:19:32.1318623Z +
2025-11-09T23:19:32.1318803Z          // Verify protocol version
2025-11-09T23:19:32.1319174Z          assert_eq!(protocol.get_protocol_version(), ProtocolVersion::Regtest);
2025-11-09T23:19:32.1319516Z -        
2025-11-09T23:19:32.1319671Z +
2025-11-09T23:19:32.1319841Z          // Test feature support
2025-11-09T23:19:32.1320120Z          assert!(protocol.supports_feature("fast_mining"));
2025-11-09T23:19:32.1320416Z      }
2025-11-09T23:19:32.1320738Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/lib.rs:94:
2025-11-09T23:19:32.1321180Z          // Test consensus validation through protocol-engine
2025-11-09T23:19:32.1321567Z          let node = ReferenceNode::new(None).unwrap(); // Uses default Regtest
2025-11-09T23:19:32.1321910Z          let protocol = node.protocol();
2025-11-09T23:19:32.1322152Z -        
2025-11-09T23:19:32.1322308Z +
2025-11-09T23:19:32.1322485Z          // Create a simple transaction
2025-11-09T23:19:32.1322730Z          let tx = Transaction {
2025-11-09T23:19:32.1322954Z              version: 1,
2025-11-09T23:19:32.1323306Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/lib.rs:105:
2025-11-09T23:19:32.1323684Z              }],
2025-11-09T23:19:32.1323871Z              lock_time: 0,
2025-11-09T23:19:32.1324067Z          };
2025-11-09T23:19:32.1324229Z -        
2025-11-09T23:19:32.1324582Z +
2025-11-09T23:19:32.1324771Z          // Test transaction validation
2025-11-09T23:19:32.1325056Z          let result = protocol.validate_transaction(&tx);
2025-11-09T23:19:32.1325508Z          assert!(result.is_ok());
2025-11-09T23:19:32.1325879Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/lib.rs:115:
2025-11-09T23:19:32.1326287Z      fn test_reference_node_creation() {
2025-11-09T23:19:32.1326555Z          // Test default (Regtest) creation
2025-11-09T23:19:32.1326844Z          let node = ReferenceNode::new(None).unwrap();
2025-11-09T23:19:32.1327252Z -        assert_eq!(node.protocol().get_protocol_version(), ProtocolVersion::Regtest);
2025-11-09T23:19:32.1327613Z -        
2025-11-09T23:19:32.1327787Z +        assert_eq!(
2025-11-09T23:19:32.1328004Z +            node.protocol().get_protocol_version(),
2025-11-09T23:19:32.1328292Z +            ProtocolVersion::Regtest
2025-11-09T23:19:32.1328524Z +        );
2025-11-09T23:19:32.1328791Z +
2025-11-09T23:19:32.1329034Z          // Test mainnet creation
2025-11-09T23:19:32.1329410Z          let mainnet_node = ReferenceNode::new(Some(ProtocolVersion::BitcoinV1)).unwrap();
2025-11-09T23:19:32.1329960Z -        assert_eq!(mainnet_node.protocol().get_protocol_version(), ProtocolVersion::BitcoinV1);
2025-11-09T23:19:32.1330352Z +        assert_eq!(
2025-11-09T23:19:32.1332480Z +            mainnet_node.protocol().get_protocol_version(),
2025-11-09T23:19:32.1332776Z +            ProtocolVersion::BitcoinV1
2025-11-09T23:19:32.1333019Z +        );
2025-11-09T23:19:32.1333179Z      }
2025-11-09T23:19:32.1333337Z  }
2025-11-09T23:19:32.1333490Z +
2025-11-09T23:19:32.1333840Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/api/hub.rs:81:
2025-11-09T23:19:32.1334513Z              .validate_request(module_id, &request.payload)?;
2025-11-09T23:19:32.1334809Z  
2025-11-09T23:19:32.1335079Z          // Handle handshake specially (no validation needed, just acknowledge)
2025-11-09T23:19:32.1335631Z -        if let RequestPayload::Handshake { module_id: handshake_id, module_name, version } = &request.payload {
2025-11-09T23:19:32.1336268Z +        if let RequestPayload::Handshake {
2025-11-09T23:19:32.1336542Z +            module_id: handshake_id,
2025-11-09T23:19:32.1336785Z +            module_name,
2025-11-09T23:19:32.1336987Z +            version,
2025-11-09T23:19:32.1337182Z +        } = &request.payload
2025-11-09T23:19:32.1337393Z +        {
2025-11-09T23:19:32.1337569Z              // Verify module_id matches
2025-11-09T23:19:32.1337828Z              if handshake_id != module_id {
2025-11-09T23:19:32.1338109Z -                return Err(ModuleError::OperationError(
2025-11-09T23:19:32.1338539Z -                    format!("Handshake module_id mismatch: expected {}, got {}", module_id, handshake_id)
2025-11-09T23:19:32.1338923Z -                ));
2025-11-09T23:19:32.1339172Z +                return Err(ModuleError::OperationError(format!(
2025-11-09T23:19:32.1339519Z +                    "Handshake module_id mismatch: expected {}, got {}",
2025-11-09T23:19:32.1339832Z +                    module_id, handshake_id
2025-11-09T23:19:32.1341937Z +                )));
2025-11-09T23:19:32.1342121Z              }
2025-11-09T23:19:32.1342293Z -            
2025-11-09T23:19:32.1342608Z -            info!("Handshake from module {} (name={}, version={})", module_id, module_name, version);
2025-11-09T23:19:32.1342978Z +
2025-11-09T23:19:32.1343128Z +            info!(
2025-11-09T23:19:32.1343365Z +                "Handshake from module {} (name={}, version={})",
2025-11-09T23:19:32.1343665Z +                module_id, module_name, version
2025-11-09T23:19:32.1343915Z +            );
2025-11-09T23:19:32.1344123Z              return Ok(ResponseMessage::success(
2025-11-09T23:19:32.1344628Z                  request.correlation_id,
2025-11-09T23:19:32.1344918Z                  ResponsePayload::HandshakeAck {
2025-11-09T23:19:32.1345580Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/api/hub.rs:96:
2025-11-09T23:19:32.1346430Z                      node_version: env!("CARGO_PKG_VERSION").to_string(),
2025-11-09T23:19:32.1346956Z -                }
2025-11-09T23:19:32.1347472Z +                },
2025-11-09T23:19:32.1347666Z              ));
2025-11-09T23:19:32.1347837Z          }
2025-11-09T23:19:32.1348003Z  
2025-11-09T23:19:32.1348364Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/api/hub.rs:108:
2025-11-09T23:19:32.1348846Z              RequestPayload::Handshake { .. } => {
2025-11-09T23:19:32.1351002Z                  // Handshake is handled at connection level, not here
2025-11-09T23:19:32.1351375Z                  return Err(crate::module::traits::ModuleError::IpcError(
2025-11-09T23:19:32.1351773Z -                    "Handshake should be handled at connection level".to_string()
2025-11-09T23:19:32.1352189Z +                    "Handshake should be handled at connection level".to_string(),
2025-11-09T23:19:32.1352510Z                  ));
2025-11-09T23:19:32.1352691Z              }
2025-11-09T23:19:32.1352914Z              RequestPayload::GetBlock { hash } => {
2025-11-09T23:19:32.1353375Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/ipc/protocol.rs:76:
2025-11-09T23:19:32.1353871Z  #[derive(Debug, Clone, Serialize, Deserialize)]
2025-11-09T23:19:32.1354152Z  pub enum RequestPayload {
2025-11-09T23:19:32.1354586Z      /// Handshake: Module identifies itself (first message)
2025-11-09T23:19:32.1354985Z -    Handshake { module_id: String, module_name: String, version: String },
2025-11-09T23:19:32.1355335Z -    GetBlock { hash: Hash },
2025-11-09T23:19:32.1355575Z -    GetBlockHeader { hash: Hash },
2025-11-09T23:19:32.1355820Z -    GetTransaction { hash: Hash },
2025-11-09T23:19:32.1356060Z -    HasTransaction { hash: Hash },
2025-11-09T23:19:32.1356283Z +    Handshake {
2025-11-09T23:19:32.1356474Z +        module_id: String,
2025-11-09T23:19:32.1356686Z +        module_name: String,
2025-11-09T23:19:32.1356908Z +        version: String,
2025-11-09T23:19:32.1357282Z +    },
2025-11-09T23:19:32.1357441Z +    GetBlock {
2025-11-09T23:19:32.1357625Z +        hash: Hash,
2025-11-09T23:19:32.1357809Z +    },
2025-11-09T23:19:32.1357978Z +    GetBlockHeader {
2025-11-09T23:19:32.1358166Z +        hash: Hash,
2025-11-09T23:19:32.1358350Z +    },
2025-11-09T23:19:32.1358513Z +    GetTransaction {
2025-11-09T23:19:32.1360631Z +        hash: Hash,
2025-11-09T23:19:32.1360808Z +    },
2025-11-09T23:19:32.1360968Z +    HasTransaction {
2025-11-09T23:19:32.1361154Z +        hash: Hash,
2025-11-09T23:19:32.1361327Z +    },
2025-11-09T23:19:32.1361488Z      GetChainTip,
2025-11-09T23:19:32.1361671Z      GetBlockHeight,
2025-11-09T23:19:32.1361878Z -    GetUtxo { outpoint: OutPoint },
2025-11-09T23:19:32.1362158Z -    SubscribeEvents { event_types: Vec<EventType> },
2025-11-09T23:19:32.1362438Z +    GetUtxo {
2025-11-09T23:19:32.1362621Z +        outpoint: OutPoint,
2025-11-09T23:19:32.1362830Z +    },
2025-11-09T23:19:32.1362992Z +    SubscribeEvents {
2025-11-09T23:19:32.1363205Z +        event_types: Vec<EventType>,
2025-11-09T23:19:32.1363436Z +    },
2025-11-09T23:19:32.1363583Z  }
2025-11-09T23:19:32.1363741Z  
2025-11-09T23:19:32.1363916Z  /// Response message from node to module
2025-11-09T23:19:32.1364676Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/ipc/protocol.rs:100:
2025-11-09T23:19:32.1365179Z  #[derive(Debug, Clone, Serialize, Deserialize)]
2025-11-09T23:19:32.1365469Z  pub enum ResponsePayload {
2025-11-09T23:19:32.1365723Z      /// Handshake acknowledgment with node version
2025-11-09T23:19:32.1366016Z -    HandshakeAck { node_version: String },
2025-11-09T23:19:32.1368158Z +    HandshakeAck {
2025-11-09T23:19:32.1368350Z +        node_version: String,
2025-11-09T23:19:32.1368564Z +    },
2025-11-09T23:19:32.1368732Z      Block(Option<Block>),
2025-11-09T23:19:32.1368965Z      BlockHeader(Option<BlockHeader>),
2025-11-09T23:19:32.1369219Z      Transaction(Option<Transaction>),
2025-11-09T23:19:32.1369707Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/ipc/server.rs:124:
2025-11-09T23:19:32.1370163Z              Some(Ok(bytes)) => {
2025-11-09T23:19:32.1370645Z                  let message: ModuleMessage = bincode::deserialize(bytes.as_ref())
2025-11-09T23:19:32.1371069Z                      .map_err(|e| ModuleError::SerializationError(e.to_string()))?;
2025-11-09T23:19:32.1371381Z -                
2025-11-09T23:19:32.1371564Z +
2025-11-09T23:19:32.1371728Z                  match message {
2025-11-09T23:19:32.1371986Z                      ModuleMessage::Request(request) => {
2025-11-09T23:19:32.1372430Z -                        if let RequestPayload::Handshake { module_id, module_name, version } = request.payload {
2025-11-09T23:19:32.1372867Z +                        if let RequestPayload::Handshake {
2025-11-09T23:19:32.1373152Z +                            module_id,
2025-11-09T23:19:32.1373402Z +                            module_name,
2025-11-09T23:19:32.1373646Z +                            version,
2025-11-09T23:19:32.1373900Z +                        } = request.payload
2025-11-09T23:19:32.1374138Z +                        {
2025-11-09T23:19:32.1382422Z                              info!(
2025-11-09T23:19:32.1382942Z                                  "Module handshake: id={}, name={}, version={}",
2025-11-09T23:19:32.1383282Z                                  module_id, module_name, version
2025-11-09T23:19:32.1383760Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/ipc/server.rs:134:
2025-11-09T23:19:32.1384204Z                              );
2025-11-09T23:19:32.1384592Z -                            
2025-11-09T23:19:32.1384808Z +
2025-11-09T23:19:32.1384993Z                              // Send handshake acknowledgment
2025-11-09T23:19:32.1385288Z                              let ack = ResponseMessage {
2025-11-09T23:19:32.1385588Z                                  correlation_id: request.correlation_id,
2025-11-09T23:19:32.1386063Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/ipc/server.rs:142:
2025-11-09T23:19:32.1386709Z                                  }),
2025-11-09T23:19:32.1386957Z                                  error: None,
2025-11-09T23:19:32.1387203Z                              };
2025-11-09T23:19:32.1387410Z -                            
2025-11-09T23:19:32.1387612Z +
2025-11-09T23:19:32.1387885Z                              let ack_bytes = bincode::serialize(&ModuleMessage::Response(ack))
2025-11-09T23:19:32.1388311Z                                  .map_err(|e| ModuleError::SerializationError(e.to_string()))?;
2025-11-09T23:19:32.1388691Z -                            writer.send(bytes::Bytes::from(ack_bytes)).await
2025-11-09T23:19:32.1389125Z -                                .map_err(|e| ModuleError::IpcError(format!("Failed to send handshake ack: {}", e)))?;
2025-11-09T23:19:32.1389728Z -                            
2025-11-09T23:19:32.1390101Z +                            writer
2025-11-09T23:19:32.1390560Z +                                .send(bytes::Bytes::from(ack_bytes))
2025-11-09T23:19:32.1390860Z +                                .await
2025-11-09T23:19:32.1391109Z +                                .map_err(|e| {
2025-11-09T23:19:32.1391389Z +                                    ModuleError::IpcError(format!(
2025-11-09T23:19:32.1391678Z +                                        "Failed to send handshake ack: {}",
2025-11-09T23:19:32.1391950Z +                                        e
2025-11-09T23:19:32.1392189Z +                                    ))
2025-11-09T23:19:32.1392426Z +                                })?;
2025-11-09T23:19:32.1392636Z +
2025-11-09T23:19:32.1392803Z                              module_id
2025-11-09T23:19:32.1393023Z                          } else {
2025-11-09T23:19:32.1393322Z                              // No handshake - use fallback ID (backward compatibility)
2025-11-09T23:19:32.1393837Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/ipc/server.rs:162:
2025-11-09T23:19:32.1394269Z                      }
2025-11-09T23:19:32.1394601Z                      _ => {
2025-11-09T23:19:32.1395008Z                          return Err(ModuleError::IpcError(
2025-11-09T23:19:32.1395344Z -                            "First message must be a handshake request".to_string()
2025-11-09T23:19:32.1395713Z +                            "First message must be a handshake request".to_string(),
2025-11-09T23:19:32.1396019Z                          ));
2025-11-09T23:19:32.1396224Z                      }
2025-11-09T23:19:32.1396402Z                  }
2025-11-09T23:19:32.1396778Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/ipc/server.rs:169:
2025-11-09T23:19:32.1397195Z              }
2025-11-09T23:19:32.1397378Z              Some(Err(e)) => {
2025-11-09T23:19:32.1397729Z -                return Err(ModuleError::IpcError(format!("Failed to read handshake: {}", e)));
2025-11-09T23:19:32.1398149Z +                return Err(ModuleError::IpcError(format!(
2025-11-09T23:19:32.1398443Z +                    "Failed to read handshake: {}",
2025-11-09T23:19:32.1398699Z +                    e
2025-11-09T23:19:32.1398892Z +                )));
2025-11-09T23:19:32.1399068Z              }
2025-11-09T23:19:32.1399243Z              None => {
2025-11-09T23:19:32.1399585Z -                return Err(ModuleError::IpcError("Connection closed before handshake".to_string()));
2025-11-09T23:19:32.1400009Z +                return Err(ModuleError::IpcError(
2025-11-09T23:19:32.1400318Z +                    "Connection closed before handshake".to_string(),
2025-11-09T23:19:32.1400604Z +                ));
2025-11-09T23:19:32.1400779Z              }
2025-11-09T23:19:32.1400947Z          };
2025-11-09T23:19:32.1401353Z  
2025-11-09T23:19:32.1401712Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/ipc/server.rs:372:
2025-11-09T23:19:32.1402181Z                  // Handshake is handled at connection level
2025-11-09T23:19:32.1402472Z                  Ok(ResponseMessage::success(
2025-11-09T23:19:32.1402878Z                      request.correlation_id,
2025-11-09T23:19:32.1403295Z -                    ResponsePayload::HandshakeAck { node_version: env!("CARGO_PKG_VERSION").to_string() },
2025-11-09T23:19:32.1403728Z +                    ResponsePayload::HandshakeAck {
2025-11-09T23:19:32.1404037Z +                        node_version: env!("CARGO_PKG_VERSION").to_string(),
2025-11-09T23:19:32.1404459Z +                    },
2025-11-09T23:19:32.1404652Z                  ))
2025-11-09T23:19:32.1404824Z              }
2025-11-09T23:19:32.1405026Z              RequestPayload::GetBlock { hash } => {
2025-11-09T23:19:32.1405524Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/manager.rs:159:
2025-11-09T23:19:32.1406379Z          // This allows both to access the process for different purposes
2025-11-09T23:19:32.1406717Z          use std::sync::Arc;
2025-11-09T23:19:32.1407018Z          let shared_process = Arc::new(tokio::sync::Mutex::new(process));
2025-11-09T23:19:32.1407339Z -        
2025-11-09T23:19:32.1407499Z +
2025-11-09T23:19:32.1407683Z          // Create monitor with shared process
2025-11-09T23:19:32.1408036Z          let monitor = ModuleProcessMonitor::new(self.crash_tx.clone());
2025-11-09T23:19:32.1408404Z          let module_name_clone = module_name.to_string();
2025-11-09T23:19:32.1417425Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:87:
2025-11-09T23:19:32.1418239Z  
2025-11-09T23:19:32.1418550Z              // Check heartbeat via IPC
2025-11-09T23:19:32.1419020Z              if let Some(client) = process.client_mut() {
2025-11-09T23:19:32.1419476Z +                use crate::module::ipc::protocol::MessageType;
2025-11-09T23:19:32.1419821Z                  use crate::module::ipc::protocol::RequestMessage;
2025-11-09T23:19:32.1420155Z                  use crate::module::ipc::protocol::RequestPayload;
2025-11-09T23:19:32.1420473Z -                use crate::module::ipc::protocol::MessageType;
2025-11-09T23:19:32.1420762Z -                
2025-11-09T23:19:32.1420939Z +
2025-11-09T23:19:32.1421342Z                  // Use GetChainTip as a lightweight heartbeat check
2025-11-09T23:19:32.1421722Z                  let heartbeat_request = RequestMessage {
2025-11-09T23:19:32.1422094Z                      correlation_id: 0, // Use 0 for heartbeat (won't match any real request)
2025-11-09T23:19:32.1422651Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:97:
2025-11-09T23:19:32.1423145Z                      request_type: MessageType::GetChainTip,
2025-11-09T23:19:32.1423450Z                      payload: RequestPayload::GetChainTip,
2025-11-09T23:19:32.1423703Z                  };
2025-11-09T23:19:32.1423878Z -                
2025-11-09T23:19:32.1424048Z +
2025-11-09T23:19:32.1424229Z                  // Send heartbeat with timeout
2025-11-09T23:19:32.1424826Z -                let heartbeat_result = tokio::time::timeout(
2025-11-09T23:19:32.1425136Z -                    Duration::from_secs(2),
2025-11-09T23:19:32.1425405Z -                    client.request(heartbeat_request)
2025-11-09T23:19:32.1425668Z -                ).await;
2025-11-09T23:19:32.1425858Z -                
2025-11-09T23:19:32.1426054Z +                let heartbeat_result =
2025-11-09T23:19:32.1428331Z +                    tokio::time::timeout(Duration::from_secs(2), client.request(heartbeat_request))
2025-11-09T23:19:32.1428842Z +                        .await;
2025-11-09T23:19:32.1429072Z +
2025-11-09T23:19:32.1429248Z                  match heartbeat_result {
2025-11-09T23:19:32.1429593Z                      Ok(Ok(_)) => {
2025-11-09T23:19:32.1430027Z                          // Heartbeat successful - module is responsive
2025-11-09T23:19:32.1430662Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:120:
2025-11-09T23:19:32.1431107Z                  }
2025-11-09T23:19:32.1431285Z              } else {
2025-11-09T23:19:32.1431695Z                  // No IPC client available - can't check heartbeat
2025-11-09T23:19:32.1432071Z -                debug!("Module {} has no IPC client for heartbeat check", module_name);
2025-11-09T23:19:32.1432415Z +                debug!(
2025-11-09T23:19:32.1432664Z +                    "Module {} has no IPC client for heartbeat check",
2025-11-09T23:19:32.1432954Z +                    module_name
2025-11-09T23:19:32.1433164Z +                );
2025-11-09T23:19:32.1433343Z              }
2025-11-09T23:19:32.1433509Z -            
2025-11-09T23:19:32.1433677Z +
2025-11-09T23:19:32.1433863Z              // Loop continues to next iteration
2025-11-09T23:19:32.1434105Z          }
2025-11-09T23:19:32.1434269Z      }
2025-11-09T23:19:32.1434781Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:145:
2025-11-09T23:19:32.1435306Z                  let mut process_guard = shared_process.lock().await;
2025-11-09T23:19:32.1435603Z                  process_guard.is_running()
2025-11-09T23:19:32.1435847Z              };
2025-11-09T23:19:32.1436014Z -            
2025-11-09T23:19:32.1436181Z +
2025-11-09T23:19:32.1436339Z              if !is_running {
2025-11-09T23:19:32.1436579Z                  // Process exited, check exit status
2025-11-09T23:19:32.1436841Z                  let exit_status = {
2025-11-09T23:19:32.1437281Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:152:
2025-11-09T23:19:32.1437783Z                      let mut process_guard = shared_process.lock().await;
2025-11-09T23:19:32.1438082Z                      process_guard.wait().await?
2025-11-09T23:19:32.1438328Z                  };
2025-11-09T23:19:32.1438499Z -                
2025-11-09T23:19:32.1438674Z +
2025-11-09T23:19:32.1438833Z                  match exit_status {
2025-11-09T23:19:32.1439067Z                      Some(status) => {
2025-11-09T23:19:32.1439315Z                          if status.success() {
2025-11-09T23:19:32.1439767Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:182:
2025-11-09T23:19:32.1440346Z              {
2025-11-09T23:19:32.1440567Z                  let mut process_guard = shared_process.lock().await;
2025-11-09T23:19:32.1440895Z                  if let Some(client) = process_guard.client_mut() {
2025-11-09T23:19:32.1443086Z +                    use crate::module::ipc::protocol::MessageType;
2025-11-09T23:19:32.1443411Z                      use crate::module::ipc::protocol::RequestMessage;
2025-11-09T23:19:32.1443732Z                      use crate::module::ipc::protocol::RequestPayload;
2025-11-09T23:19:32.1444241Z -                    use crate::module::ipc::protocol::MessageType;
2025-11-09T23:19:32.1444791Z -                    
2025-11-09T23:19:32.1444979Z +
2025-11-09T23:19:32.1445194Z                      // Use GetChainTip as a lightweight heartbeat check
2025-11-09T23:19:32.1445508Z                      let heartbeat_request = RequestMessage {
2025-11-09T23:19:32.1445884Z                          correlation_id: 0, // Use 0 for heartbeat (won't match any real request)
2025-11-09T23:19:32.1446438Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:192:
2025-11-09T23:19:32.1446932Z                          request_type: MessageType::GetChainTip,
2025-11-09T23:19:32.1447240Z                          payload: RequestPayload::GetChainTip,
2025-11-09T23:19:32.1447503Z                      };
2025-11-09T23:19:32.1447700Z -                    
2025-11-09T23:19:32.1447876Z +
2025-11-09T23:19:32.1448052Z                      // Send heartbeat with timeout
2025-11-09T23:19:32.1448347Z                      let heartbeat_result = tokio::time::timeout(
2025-11-09T23:19:32.1448639Z                          Duration::from_secs(2),
2025-11-09T23:19:32.1449095Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:199:
2025-11-09T23:19:32.1451442Z -                        client.request(heartbeat_request)
2025-11-09T23:19:32.1451887Z -                    ).await;
2025-11-09T23:19:32.1452093Z -                    
2025-11-09T23:19:32.1452315Z +                        client.request(heartbeat_request),
2025-11-09T23:19:32.1452568Z +                    )
2025-11-09T23:19:32.1452754Z +                    .await;
2025-11-09T23:19:32.1452945Z +
2025-11-09T23:19:32.1453118Z                      match heartbeat_result {
2025-11-09T23:19:32.1453360Z                          Ok(Ok(_)) => {
2025-11-09T23:19:32.1453631Z                              // Heartbeat successful - module is responsive
2025-11-09T23:19:32.1454114Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:215:
2025-11-09T23:19:32.1454689Z                      }
2025-11-09T23:19:32.1454875Z                  } else {
2025-11-09T23:19:32.1455112Z                      // No IPC client available - can't check heartbeat
2025-11-09T23:19:32.1455484Z -                    debug!("Module {} has no IPC client for heartbeat check", module_name);
2025-11-09T23:19:32.1455816Z +                    debug!(
2025-11-09T23:19:32.1456074Z +                        "Module {} has no IPC client for heartbeat check",
2025-11-09T23:19:32.1456354Z +                        module_name
2025-11-09T23:19:32.1456575Z +                    );
2025-11-09T23:19:32.1456753Z                  }
2025-11-09T23:19:32.1456923Z              }
2025-11-09T23:19:32.1457087Z -            
2025-11-09T23:19:32.1457246Z +
2025-11-09T23:19:32.1457422Z              // Loop continues to next iteration
2025-11-09T23:19:32.1457664Z          }
2025-11-09T23:19:32.1457825Z      }
2025-11-09T23:19:32.1458195Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:229:
2025-11-09T23:19:32.1458699Z              ModuleHealth::Crashed("Process exited".to_string())
2025-11-09T23:19:32.1459024Z          } else if let Some(client) = process.client_mut() {
2025-11-09T23:19:32.1459328Z              // Check heartbeat via IPC with short timeout
2025-11-09T23:19:32.1459731Z -            use crate::module::ipc::protocol::{RequestMessage, RequestPayload, MessageType};
2025-11-09T23:19:32.1460370Z +            use crate::module::ipc::protocol::{MessageType, RequestMessage, RequestPayload};
2025-11-09T23:19:32.1460746Z              use tokio::time::timeout;
2025-11-09T23:19:32.1460969Z -            
2025-11-09T23:19:32.1461130Z +
2025-11-09T23:19:32.1461311Z              let heartbeat_request = RequestMessage {
2025-11-09T23:19:32.1461581Z                  correlation_id: 0,
2025-11-09T23:19:32.1461849Z                  request_type: MessageType::GetChainTip,
2025-11-09T23:19:32.1462321Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:238:
2025-11-09T23:19:32.1462802Z                  payload: RequestPayload::GetChainTip,
2025-11-09T23:19:32.1463050Z              };
2025-11-09T23:19:32.1463220Z -            
2025-11-09T23:19:32.1463377Z +
2025-11-09T23:19:32.1463612Z              // Use tokio::runtime::Handle to run async code in sync context
2025-11-09T23:19:32.1464032Z              // This is a simplified check - in production would use proper async context
2025-11-09T23:19:32.1464550Z              match tokio::runtime::Handle::try_current() {
2025-11-09T23:19:32.1465028Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:244:
2025-11-09T23:19:32.1465477Z                  Ok(handle) => {
2025-11-09T23:19:32.1465722Z                      let result = handle.block_on(timeout(
2025-11-09T23:19:32.1465992Z                          Duration::from_secs(1),
2025-11-09T23:19:32.1466261Z -                        client.request(heartbeat_request)
2025-11-09T23:19:32.1466540Z +                        client.request(heartbeat_request),
2025-11-09T23:19:32.1466794Z                      ));
2025-11-09T23:19:32.1466979Z -                    
2025-11-09T23:19:32.1467154Z +
2025-11-09T23:19:32.1467312Z                      match result {
2025-11-09T23:19:32.1467694Z                          Ok(Ok(_)) => ModuleHealth::Healthy,
2025-11-09T23:19:32.1467974Z                          _ => ModuleHealth::Unresponsive,
2025-11-09T23:19:32.1517160Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/sandbox/process.rs:99:
2025-11-09T23:19:32.1517817Z                  if let Some(max_memory) = limits.max_memory_bytes {
2025-11-09T23:19:32.1518135Z                      let soft_limit = max_memory as u64;
2025-11-09T23:19:32.1518414Z                      let hard_limit = max_memory as u64;
2025-11-09T23:19:32.1518746Z -                    setrlimit(Resource::RLIMIT_AS, soft_limit, hard_limit)
2025-11-09T23:19:32.1519063Z -                        .map_err(|e| {
2025-11-09T23:19:32.1519344Z -                            ModuleError::OperationError(format!(
2025-11-09T23:19:32.1519644Z -                                "Failed to set memory limit: {}",
2025-11-09T23:19:32.1519914Z -                                e
2025-11-09T23:19:32.1520147Z -                            ))
2025-11-09T23:19:32.1520354Z -                        })?;
2025-11-09T23:19:32.1520674Z +                    setrlimit(Resource::RLIMIT_AS, soft_limit, hard_limit).map_err(|e| {
2025-11-09T23:19:32.1521144Z +                        ModuleError::OperationError(format!("Failed to set memory limit: {}", e))
2025-11-09T23:19:32.1522965Z +                    })?;
2025-11-09T23:19:32.1523206Z                      debug!("Set memory limit: {} bytes", max_memory);
2025-11-09T23:19:32.1523479Z                  }
2025-11-09T23:19:32.1523654Z  
2025-11-09T23:19:32.1524035Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/sandbox/process.rs:116:
2025-11-09T23:19:32.1524798Z                      #[cfg(feature = "nix")]
2025-11-09T23:19:32.1525043Z                      {
2025-11-09T23:19:32.1525287Z                          use nix::sys::resource::{setrlimit, Resource};
2025-11-09T23:19:32.1525648Z -                        setrlimit(Resource::RLIMIT_NOFILE, soft_limit, hard_limit)
2025-11-09T23:19:32.1525983Z -                            .map_err(|e| {
2025-11-09T23:19:32.1526514Z +                        setrlimit(Resource::RLIMIT_NOFILE, soft_limit, hard_limit).map_err(
2025-11-09T23:19:32.1526855Z +                            |e| {
2025-11-09T23:19:32.1527124Z                                  ModuleError::OperationError(format!(
2025-11-09T23:19:32.1527526Z                                      "Failed to set file descriptor limit: {}",
2025-11-09T23:19:32.1528008Z                                      e
2025-11-09T23:19:32.1528466Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/sandbox/process.rs:124:
2025-11-09T23:19:32.1528955Z                                  ))
2025-11-09T23:19:32.1529337Z -                            })?;
2025-11-09T23:19:32.1529577Z +                            },
2025-11-09T23:19:32.1529792Z +                        )?;
2025-11-09T23:19:32.1531531Z                      }
2025-11-09T23:19:32.1531742Z                      #[cfg(not(feature = "nix"))]
2025-11-09T23:19:32.1531985Z                      {
2025-11-09T23:19:32.1532394Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/sandbox/process.rs:139:
2025-11-09T23:19:32.1532855Z                      #[cfg(feature = "nix")]
2025-11-09T23:19:32.1533126Z                      let hard_limit = max_children as u64;
2025-11-09T23:19:32.1533391Z                      #[cfg(feature = "nix")]
2025-11-09T23:19:32.1533711Z -                    setrlimit(Resource::RLIMIT_NPROC, soft_limit, hard_limit)
2025-11-09T23:19:32.1534033Z -                        .map_err(|e| {
2025-11-09T23:19:32.1534301Z -                            ModuleError::OperationError(format!(
2025-11-09T23:19:32.1534728Z -                                "Failed to set process limit: {}",
2025-11-09T23:19:32.1534994Z -                                e
2025-11-09T23:19:32.1535209Z -                            ))
2025-11-09T23:19:32.1535413Z -                        })?;
2025-11-09T23:19:32.1535917Z +                    setrlimit(Resource::RLIMIT_NPROC, soft_limit, hard_limit).map_err(|e| {
2025-11-09T23:19:32.1536408Z +                        ModuleError::OperationError(format!("Failed to set process limit: {}", e))
2025-11-09T23:19:32.1536779Z +                    })?;
2025-11-09T23:19:32.1537021Z                      debug!("Set process limit: {}", max_children);
2025-11-09T23:19:32.1537294Z                  }
2025-11-09T23:19:32.1537568Z  
2025-11-09T23:19:32.1538229Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/sandbox/process.rs:191:
2025-11-09T23:19:32.1538957Z                          // Field 23 (index 22): rss - Resident Set Size (pages)
2025-11-09T23:19:32.1539357Z                          let utime: u64 = fields.get(13).and_then(|s| s.parse().ok()).unwrap_or(0);
2025-11-09T23:19:32.1539793Z                          let stime: u64 = fields.get(14).and_then(|s| s.parse().ok()).unwrap_or(0);
2025-11-09T23:19:32.1540242Z -                        let rss_pages: u64 = fields.get(22).and_then(|s| s.parse().ok()).unwrap_or(0);
2025-11-09T23:19:32.1540609Z +                        let rss_pages: u64 =
2025-11-09T23:19:32.1540920Z +                            fields.get(22).and_then(|s| s.parse().ok()).unwrap_or(0);
2025-11-09T23:19:32.1541215Z  
2025-11-09T23:19:32.1541418Z                          // Get page size (typically 4096 bytes on Linux)
2025-11-09T23:19:32.1541705Z                          #[cfg(feature = "libc")]
2025-11-09T23:19:32.1542206Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/security/validator.rs:155:
2025-11-09T23:19:32.1542729Z          let mut limiters = self.rate_limiters.lock().unwrap();
2025-11-09T23:19:32.1543008Z  
2025-11-09T23:19:32.1543196Z          // Get or create rate limiter for this module
2025-11-09T23:19:32.1543461Z -        let limiter = limiters
2025-11-09T23:19:32.1543697Z -            .entry(module_id.to_string())
2025-11-09T23:19:32.1543943Z -            .or_insert_with(|| {
2025-11-09T23:19:32.1544295Z -                RateLimiter::new(self.max_requests_per_second, self.time_window_seconds)
2025-11-09T23:19:32.1544942Z -            });
2025-11-09T23:19:32.1545235Z +        let limiter = limiters.entry(module_id.to_string()).or_insert_with(|| {
2025-11-09T23:19:32.1545689Z +            RateLimiter::new(self.max_requests_per_second, self.time_window_seconds)
2025-11-09T23:19:32.1546019Z +        });
2025-11-09T23:19:32.1546184Z  
2025-11-09T23:19:32.1546345Z          // Check rate limit
2025-11-09T23:19:32.1546709Z          if !limiter.check_rate_limit(self.max_requests_per_second, self.time_window_seconds) {
2025-11-09T23:19:32.1621893Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:104:
2025-11-09T23:19:32.1623087Z      pub fn add_address(&mut self, addr: NetworkAddress, services: u64) {
2025-11-09T23:19:32.1623880Z          // Convert NetworkAddress to SocketAddr for key
2025-11-09T23:19:32.1624498Z          let socket_addr = self.network_addr_to_socket(&addr);
2025-11-09T23:19:32.1624998Z -        
2025-11-09T23:19:32.1625163Z +
2025-11-09T23:19:32.1625370Z          match self.addresses.get_mut(&socket_addr) {
2025-11-09T23:19:32.1625645Z              Some(entry) => {
2025-11-09T23:19:32.1625871Z                  // Update existing entry
2025-11-09T23:19:32.1626319Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:116:
2025-11-09T23:19:32.1626800Z                  if self.addresses.len() >= self.max_addresses {
2025-11-09T23:19:32.1627085Z                      self.evict_oldest();
2025-11-09T23:19:32.1627313Z                  }
2025-11-09T23:19:32.1627632Z -                self.addresses.insert(socket_addr, AddressEntry::new(addr, services));
2025-11-09T23:19:32.1628003Z +                self.addresses
2025-11-09T23:19:32.1628301Z +                    .insert(socket_addr, AddressEntry::new(addr, services));
2025-11-09T23:19:32.1628603Z              }
2025-11-09T23:19:32.1628976Z          }
2025-11-09T23:19:32.1629141Z      }
2025-11-09T23:19:32.1629507Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:136:
2025-11-09T23:19:32.1630023Z              .filter(|entry| entry.is_fresh(self.expiration_seconds))
2025-11-09T23:19:32.1630341Z              .map(|entry| entry.addr.clone())
2025-11-09T23:19:32.1630675Z              .collect();
2025-11-09T23:19:32.1630866Z -        
2025-11-09T23:19:32.1631028Z +
2025-11-09T23:19:32.1631215Z          // Sort by last_seen (most recent first)
2025-11-09T23:19:32.1631475Z          fresh.sort_by_key(|addr| {
2025-11-09T23:19:32.1631753Z              let socket = self.network_addr_to_socket(addr);
2025-11-09T23:19:32.1632224Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:146:
2025-11-09T23:19:32.1632671Z                  .unwrap_or(0)
2025-11-09T23:19:32.1632876Z          });
2025-11-09T23:19:32.1633052Z          fresh.reverse();
2025-11-09T23:19:32.1633250Z -        
2025-11-09T23:19:32.1633417Z +
2025-11-09T23:19:32.1633597Z          fresh.into_iter().take(count).collect()
2025-11-09T23:19:32.1633848Z      }
2025-11-09T23:19:32.1633998Z  
2025-11-09T23:19:32.1634597Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:158:
2025-11-09T23:19:32.1635055Z      /// Remove expired addresses
2025-11-09T23:19:32.1635319Z      pub fn remove_expired(&mut self) -> usize {
2025-11-09T23:19:32.1635597Z          let before = self.addresses.len();
2025-11-09T23:19:32.1635975Z -        self.addresses.retain(|_, entry| entry.is_fresh(self.expiration_seconds));
2025-11-09T23:19:32.1636343Z +        self.addresses
2025-11-09T23:19:32.1636608Z +            .retain(|_, entry| entry.is_fresh(self.expiration_seconds));
2025-11-09T23:19:32.1636933Z          before - self.addresses.len()
2025-11-09T23:19:32.1637161Z      }
2025-11-09T23:19:32.1637314Z  
2025-11-09T23:19:32.1637665Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:196:
2025-11-09T23:19:32.1638116Z                      || ipv4.is_link_local()
2025-11-09T23:19:32.1638531Z                      || ipv4.is_broadcast()
2025-11-09T23:19:32.1638765Z              }
2025-11-09T23:19:32.1638959Z -            IpAddr::V6(ipv6) => {
2025-11-09T23:19:32.1639227Z -                ipv6.is_loopback() || ipv6.is_unspecified()
2025-11-09T23:19:32.1639493Z -            }
2025-11-09T23:19:32.1641485Z +            IpAddr::V6(ipv6) => ipv6.is_loopback() || ipv6.is_unspecified(),
2025-11-09T23:19:32.1642001Z          }
2025-11-09T23:19:32.1642278Z      }
2025-11-09T23:19:32.1642542Z  
2025-11-09T23:19:32.1643138Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:238:
2025-11-09T23:19:32.1643586Z                      ip: [0; 16],
2025-11-09T23:19:32.1643813Z                      port: 0,
2025-11-09T23:19:32.1644025Z                  };
2025-11-09T23:19:32.1644603Z -                self.iroh_addresses.insert(node_id, AddressEntry::new(placeholder_addr, services));
2025-11-09T23:19:32.1645076Z +                self.iroh_addresses
2025-11-09T23:19:32.1645410Z +                    .insert(node_id, AddressEntry::new(placeholder_addr, services));
2025-11-09T23:19:32.1645723Z              }
2025-11-09T23:19:32.1645899Z          }
2025-11-09T23:19:32.1646052Z      }
2025-11-09T23:19:32.1646422Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:252:
2025-11-09T23:19:32.1646917Z              .filter(|(_, entry)| entry.is_fresh(self.expiration_seconds))
2025-11-09T23:19:32.1647235Z              .map(|(node_id, _)| *node_id)
2025-11-09T23:19:32.1647474Z              .collect();
2025-11-09T23:19:32.1647666Z -        
2025-11-09T23:19:32.1647822Z +
2025-11-09T23:19:32.1648000Z          // Sort by last_seen (most recent first)
2025-11-09T23:19:32.1648336Z          fresh.sort_by_key(|node_id| {
2025-11-09T23:19:32.1648761Z              self.iroh_addresses
2025-11-09T23:19:32.1651525Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:261:
2025-11-09T23:19:32.1651987Z                  .unwrap_or(0)
2025-11-09T23:19:32.1652336Z          });
2025-11-09T23:19:32.1652647Z          fresh.reverse();
2025-11-09T23:19:32.1652904Z -        
2025-11-09T23:19:32.1653072Z +
2025-11-09T23:19:32.1653260Z          fresh.into_iter().take(count).collect()
2025-11-09T23:19:32.1653513Z      }
2025-11-09T23:19:32.1653668Z  
2025-11-09T23:19:32.1654029Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:319:
2025-11-09T23:19:32.1665177Z      }
2025-11-09T23:19:32.1665534Z  
2025-11-09T23:19:32.1665771Z      /// Convert NetworkAddress to SocketAddr
2025-11-09T23:19:32.1666046Z -    /// 
2025-11-09T23:19:32.1666221Z +    ///
2025-11-09T23:19:32.1666511Z      /// Note: This is public for use in NetworkManager when connecting to peers.
2025-11-09T23:19:32.1666996Z      pub fn network_addr_to_socket(&self, addr: &NetworkAddress) -> SocketAddr {
2025-11-09T23:19:32.1667408Z          // Convert IPv6 address bytes to SocketAddr
2025-11-09T23:19:32.1667889Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:327:
2025-11-09T23:19:32.1668429Z          let ip = if addr.ip[0..12] == [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0xff, 0xff] {
2025-11-09T23:19:32.1668770Z              // IPv4-mapped IPv6 address
2025-11-09T23:19:32.1669064Z              IpAddr::V4(std::net::Ipv4Addr::new(
2025-11-09T23:19:32.1669375Z -                addr.ip[12], addr.ip[13], addr.ip[14], addr.ip[15],
2025-11-09T23:19:32.1669670Z +                addr.ip[12],
2025-11-09T23:19:32.1669894Z +                addr.ip[13],
2025-11-09T23:19:32.1670097Z +                addr.ip[14],
2025-11-09T23:19:32.1670304Z +                addr.ip[15],
2025-11-09T23:19:32.1670500Z              ))
2025-11-09T23:19:32.1670682Z          } else {
2025-11-09T23:19:32.1670865Z              // Native IPv6
2025-11-09T23:19:32.1671282Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:342:
2025-11-09T23:19:32.1671777Z                  u16::from_be_bytes([addr.ip[14], addr.ip[15]]),
2025-11-09T23:19:32.1672252Z              ];
2025-11-09T23:19:32.1672468Z              IpAddr::V6(std::net::Ipv6Addr::new(
2025-11-09T23:19:32.1672770Z -                segments[0], segments[1], segments[2], segments[3],
2025-11-09T23:19:32.1673111Z -                segments[4], segments[5], segments[6], segments[7],
2025-11-09T23:19:32.1673391Z +                segments[0],
2025-11-09T23:19:32.1673609Z +                segments[1],
2025-11-09T23:19:32.1673813Z +                segments[2],
2025-11-09T23:19:32.1674019Z +                segments[3],
2025-11-09T23:19:32.1674229Z +                segments[4],
2025-11-09T23:19:32.1674577Z +                segments[5],
2025-11-09T23:19:32.1674788Z +                segments[6],
2025-11-09T23:19:32.1674991Z +                segments[7],
2025-11-09T23:19:32.1675196Z              ))
2025-11-09T23:19:32.1675376Z          };
2025-11-09T23:19:32.1675574Z          SocketAddr::new(ip, addr.port)
2025-11-09T23:19:32.1676336Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:406:
2025-11-09T23:19:32.1676987Z          let addr2 = create_test_address("192.168.1.2", 8333);
2025-11-09T23:19:32.1677298Z          db.add_address(addr1.clone(), 1);
2025-11-09T23:19:32.1677560Z          db.add_address(addr2.clone(), 1);
2025-11-09T23:19:32.1677796Z -        
2025-11-09T23:19:32.1677955Z +
2025-11-09T23:19:32.1678144Z          let fresh = db.get_fresh_addresses(10);
2025-11-09T23:19:32.1678404Z          assert_eq!(fresh.len(), 2);
2025-11-09T23:19:32.1678630Z      }
2025-11-09T23:19:32.1678989Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:417:
2025-11-09T23:19:32.1679464Z          let addr = create_test_address("192.168.1.1", 8333);
2025-11-09T23:19:32.1679753Z          db.add_address(addr.clone(), 1);
2025-11-09T23:19:32.1680169Z          assert_eq!(db.len(), 1);
2025-11-09T23:19:32.1680396Z -        
2025-11-09T23:19:32.1682131Z +
2025-11-09T23:19:32.1682309Z          // Wait for expiration
2025-11-09T23:19:32.1682590Z          std::thread::sleep(std::time::Duration::from_secs(2));
2025-11-09T23:19:32.1682877Z -        
2025-11-09T23:19:32.1683102Z +
2025-11-09T23:19:32.1683406Z          let fresh = db.get_fresh_addresses(10);
2025-11-09T23:19:32.1683868Z          assert_eq!(fresh.len(), 0); // Should be expired
2025-11-09T23:19:32.1684141Z      }
2025-11-09T23:19:32.1684660Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:433:
2025-11-09T23:19:32.1685123Z          db.add_address(addr1.clone(), 1);
2025-11-09T23:19:32.1685386Z          db.add_address(addr2.clone(), 1);
2025-11-09T23:19:32.1685635Z          assert_eq!(db.len(), 2);
2025-11-09T23:19:32.1685859Z -        
2025-11-09T23:19:32.1686067Z +
2025-11-09T23:19:32.1686369Z          // Wait for expiration
2025-11-09T23:19:32.1686847Z          std::thread::sleep(std::time::Duration::from_secs(2));
2025-11-09T23:19:32.1687244Z -        
2025-11-09T23:19:32.1687412Z +
2025-11-09T23:19:32.1687591Z          let removed = db.remove_expired();
2025-11-09T23:19:32.1687849Z          assert_eq!(removed, 2);
2025-11-09T23:19:32.1688071Z          assert_eq!(db.len(), 0);
2025-11-09T23:19:32.1688490Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:448:
2025-11-09T23:19:32.1688971Z          let localhost = create_test_address("127.0.0.1", 8333);
2025-11-09T23:19:32.1689298Z          let private = create_test_address("192.168.1.1", 8333);
2025-11-09T23:19:32.1689608Z          let public = create_test_address("8.8.8.8", 8333);
2025-11-09T23:19:32.1689875Z -        
2025-11-09T23:19:32.1690085Z +
2025-11-09T23:19:32.1690250Z          assert!(db.is_local(&localhost));
2025-11-09T23:19:32.1690509Z          assert!(db.is_local(&private));
2025-11-09T23:19:32.1690762Z          assert!(!db.is_local(&public));
2025-11-09T23:19:32.1691213Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:460:
2025-11-09T23:19:32.1691857Z          let addr = create_test_address("192.168.1.1", 8333);
2025-11-09T23:19:32.1692224Z          let socket = SocketAddr::new("192.168.1.1".parse().unwrap(), 8333);
2025-11-09T23:19:32.1692566Z          let mut ban_list = HashMap::new();
2025-11-09T23:19:32.1692808Z -        
2025-11-09T23:19:32.1692967Z +
2025-11-09T23:19:32.1693122Z          // Not banned
2025-11-09T23:19:32.1693378Z          assert!(!db.is_banned(&addr, &ban_list));
2025-11-09T23:19:32.1693820Z -        
2025-11-09T23:19:32.1694094Z +
2025-11-09T23:19:32.1694471Z          // Banned (permanent)
2025-11-09T23:19:32.1694918Z          ban_list.insert(socket, u64::MAX);
2025-11-09T23:19:32.1695219Z          assert!(db.is_banned(&addr, &ban_list));
2025-11-09T23:19:32.1695691Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:470:
2025-11-09T23:19:32.1696135Z -        
2025-11-09T23:19:32.1696301Z +
2025-11-09T23:19:32.1696484Z          // Banned (temporary, not expired)
2025-11-09T23:19:32.1696739Z          ban_list.clear();
2025-11-09T23:19:32.1696994Z          let future_time = std::time::SystemTime::now()
2025-11-09T23:19:32.1697460Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:474:
2025-11-09T23:19:32.1697931Z              .duration_since(std::time::UNIX_EPOCH)
2025-11-09T23:19:32.1698187Z              .unwrap()
2025-11-09T23:19:32.1698393Z -            .as_secs() + 3600;
2025-11-09T23:19:32.1698606Z +            .as_secs()
2025-11-09T23:19:32.1698801Z +            + 3600;
2025-11-09T23:19:32.1699016Z          ban_list.insert(socket, future_time);
2025-11-09T23:19:32.1699290Z          assert!(db.is_banned(&addr, &ban_list));
2025-11-09T23:19:32.1699543Z -        
2025-11-09T23:19:32.1699702Z +
2025-11-09T23:19:32.1699871Z          // Banned (expired)
2025-11-09T23:19:32.1700086Z          ban_list.clear();
2025-11-09T23:19:32.1700489Z          let past_time = std::time::SystemTime::now()
2025-11-09T23:19:32.1702848Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:483:
2025-11-09T23:19:32.1703320Z              .duration_since(std::time::UNIX_EPOCH)
2025-11-09T23:19:32.1703579Z              .unwrap()
2025-11-09T23:19:32.1703776Z -            .as_secs() - 3600;
2025-11-09T23:19:32.1703996Z +            .as_secs()
2025-11-09T23:19:32.1704181Z +            - 3600;
2025-11-09T23:19:32.1704754Z          ban_list.insert(socket, past_time);
2025-11-09T23:19:32.1705051Z          assert!(!db.is_banned(&addr, &ban_list));
2025-11-09T23:19:32.1705307Z      }
2025-11-09T23:19:32.1705684Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:493:
2025-11-09T23:19:32.1706177Z          let local = create_test_address("127.0.0.1", 8333);
2025-11-09T23:19:32.1706508Z          let banned = create_test_address("192.168.1.1", 8333);
2025-11-09T23:19:32.1706834Z          let public = create_test_address("8.8.8.8", 8333);
2025-11-09T23:19:32.1707103Z -        
2025-11-09T23:19:32.1707277Z +
2025-11-09T23:19:32.1707560Z          let socket_banned = SocketAddr::new("192.168.1.1".parse().unwrap(), 8333);
2025-11-09T23:19:32.1708009Z          let socket_connected = SocketAddr::new("8.8.8.8".parse().unwrap(), 8333);
2025-11-09T23:19:32.1708381Z          let mut ban_list = HashMap::new();
2025-11-09T23:19:32.1708827Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:500:
2025-11-09T23:19:32.1709299Z          ban_list.insert(socket_banned, u64::MAX);
2025-11-09T23:19:32.1709607Z          let connected_peers = vec![socket_connected];
2025-11-09T23:19:32.1709869Z -        
2025-11-09T23:19:32.1712016Z +
2025-11-09T23:19:32.1712638Z          let addresses = vec![local, banned, public];
2025-11-09T23:19:32.1713023Z          let filtered = db.filter_addresses(addresses, &ban_list, &connected_peers);
2025-11-09T23:19:32.1713376Z -        
2025-11-09T23:19:32.1713538Z +
2025-11-09T23:19:32.1713737Z          // Should filter out local, banned, and connected
2025-11-09T23:19:32.1714522Z          assert_eq!(filtered.len(), 0);
2025-11-09T23:19:32.1714768Z      }
2025-11-09T23:19:32.1715134Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:513:
2025-11-09T23:19:32.1715617Z          let addr1 = create_test_address("192.168.1.1", 8333);
2025-11-09T23:19:32.1715973Z          let addr2 = create_test_address("192.168.1.2", 8333);
2025-11-09T23:19:32.1716283Z          let addr3 = create_test_address("192.168.1.3", 8333);
2025-11-09T23:19:32.1716552Z -        
2025-11-09T23:19:32.1716719Z +
2025-11-09T23:19:32.1716898Z          db.add_address(addr1.clone(), 1);
2025-11-09T23:19:32.1717163Z          db.add_address(addr2.clone(), 1);
2025-11-09T23:19:32.1717415Z          assert_eq!(db.len(), 2);
2025-11-09T23:19:32.1717853Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:520:
2025-11-09T23:19:32.1718288Z -        
2025-11-09T23:19:32.1718446Z +
2025-11-09T23:19:32.1718630Z          // Adding third should evict oldest
2025-11-09T23:19:32.1718889Z          db.add_address(addr3.clone(), 1);
2025-11-09T23:19:32.1719161Z          assert_eq!(db.len(), 2); // Should still be 2
2025-11-09T23:19:32.1719630Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:528:
2025-11-09T23:19:32.1720081Z      fn test_add_iroh_address() {
2025-11-09T23:19:32.1722582Z          use iroh_net::NodeId;
2025-11-09T23:19:32.1722852Z          let mut db = AddressDatabase::new(100);
2025-11-09T23:19:32.1723101Z -        
2025-11-09T23:19:32.1723261Z +
2025-11-09T23:19:32.1723439Z          // Create a test NodeId (32 bytes)
2025-11-09T23:19:32.1723689Z          let node_id_bytes = [0u8; 32];
2025-11-09T23:19:32.1723996Z          let node_id = NodeId::from_bytes(&node_id_bytes).unwrap();
2025-11-09T23:19:32.1724717Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:535:
2025-11-09T23:19:32.1725906Z -        
2025-11-09T23:19:32.1726094Z +
2025-11-09T23:19:32.1726274Z          db.add_iroh_address(node_id, 1);
2025-11-09T23:19:32.1726539Z          assert_eq!(db.total_count(), 1);
2025-11-09T23:19:32.1726776Z -        
2025-11-09T23:19:32.1726932Z +
2025-11-09T23:19:32.1727157Z          // Add same address again (should update, not duplicate)
2025-11-09T23:19:32.1727467Z          db.add_iroh_address(node_id, 2);
2025-11-09T23:19:32.1727713Z          assert_eq!(db.total_count(), 1);
2025-11-09T23:19:32.1728159Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:546:
2025-11-09T23:19:32.1728616Z      fn test_get_fresh_iroh_addresses() {
2025-11-09T23:19:32.1728882Z          use iroh_net::NodeId;
2025-11-09T23:19:32.1729124Z          let mut db = AddressDatabase::new(100);
2025-11-09T23:19:32.1729373Z -        
2025-11-09T23:19:32.1729527Z +
2025-11-09T23:19:32.1731619Z          let node_id1_bytes = [1u8; 32];
2025-11-09T23:19:32.1731869Z          let node_id2_bytes = [2u8; 32];
2025-11-09T23:19:32.1732171Z          let node_id1 = NodeId::from_bytes(&node_id1_bytes).unwrap();
2025-11-09T23:19:32.1732668Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:553:
2025-11-09T23:19:32.1733154Z          let node_id2 = NodeId::from_bytes(&node_id2_bytes).unwrap();
2025-11-09T23:19:32.1733436Z -        
2025-11-09T23:19:32.1733587Z +
2025-11-09T23:19:32.1733762Z          db.add_iroh_address(node_id1, 1);
2025-11-09T23:19:32.1734020Z          db.add_iroh_address(node_id2, 1);
2025-11-09T23:19:32.1734260Z -        
2025-11-09T23:19:32.1734697Z +
2025-11-09T23:19:32.1734922Z          let fresh = db.get_fresh_iroh_addresses(10);
2025-11-09T23:19:32.1735209Z          assert_eq!(fresh.len(), 2);
2025-11-09T23:19:32.1735432Z      }
2025-11-09T23:19:32.1735797Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:564:
2025-11-09T23:19:32.1736256Z      fn test_total_count_includes_iroh() {
2025-11-09T23:19:32.1736713Z          use iroh_net::NodeId;
2025-11-09T23:19:32.1736958Z          let mut db = AddressDatabase::new(100);
2025-11-09T23:19:32.1737211Z -        
2025-11-09T23:19:32.1737372Z +
2025-11-09T23:19:32.1737537Z          // Add SocketAddr address
2025-11-09T23:19:32.1737808Z          let addr = create_test_address("192.168.1.1", 8333);
2025-11-09T23:19:32.1737889Z          db.add_address(addr, 1);
2025-11-09T23:19:32.1738159Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:571:
2025-11-09T23:19:32.1738251Z          assert_eq!(db.total_count(), 1);
2025-11-09T23:19:32.1738317Z -        
2025-11-09T23:19:32.1738382Z +
2025-11-09T23:19:32.1738460Z          // Add Iroh address
2025-11-09T23:19:32.1738554Z          let node_id_bytes = [0u8; 32];
2025-11-09T23:19:32.1738692Z          let node_id = NodeId::from_bytes(&node_id_bytes).unwrap();
2025-11-09T23:19:32.1740593Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:15:
2025-11-09T23:19:32.1740700Z  /// - Combine reasons from all sources
2025-11-09T23:19:32.1740884Z  pub fn merge_ban_lists(ban_lists: Vec<&BanListMessage>) -> Vec<BanEntry> {
2025-11-09T23:19:32.1741064Z      let mut merged: HashMap<NetworkAddress, BanEntry> = HashMap::new();
2025-11-09T23:19:32.1741136Z -    
2025-11-09T23:19:32.1741199Z +
2025-11-09T23:19:32.1741284Z      for ban_list in ban_lists {
2025-11-09T23:19:32.1741366Z          if !ban_list.is_full {
2025-11-09T23:19:32.1741488Z              continue; // Skip hash-only responses
2025-11-09T23:19:32.1741829Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:22:
2025-11-09T23:19:32.1741897Z          }
2025-11-09T23:19:32.1741969Z -        
2025-11-09T23:19:32.1742034Z +
2025-11-09T23:19:32.1742130Z          for entry in &ban_list.ban_entries {
2025-11-09T23:19:32.1742354Z              let addr = entry.addr.clone();
2025-11-09T23:19:32.1742429Z -            
2025-11-09T23:19:32.1742494Z +
2025-11-09T23:19:32.1742588Z              match merged.get_mut(&addr) {
2025-11-09T23:19:32.1742676Z                  Some(existing) => {
2025-11-09T23:19:32.1742786Z                      // Conflict resolution: use longest ban
2025-11-09T23:19:32.1743082Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:36:
2025-11-09T23:19:32.1743215Z                              existing.unban_timestamp = entry.unban_timestamp;
2025-11-09T23:19:32.1743291Z                          }
2025-11-09T23:19:32.1743361Z                      }
2025-11-09T23:19:32.1743429Z -                    
2025-11-09T23:19:32.1743499Z +
2025-11-09T23:19:32.1743584Z                      // Merge reasons
2025-11-09T23:19:32.1743692Z                      if let Some(ref reason) = entry.reason {
2025-11-09T23:19:32.1743838Z -                        existing.reason = existing.reason.as_ref().map(|r| {
2025-11-09T23:19:32.1743938Z -                            format!("{}; {}", r, reason)
2025-11-09T23:19:32.1744044Z -                        }).or_else(|| Some(reason.clone()));
2025-11-09T23:19:32.1744138Z +                        existing.reason = existing
2025-11-09T23:19:32.1744219Z +                            .reason
2025-11-09T23:19:32.1744430Z +                            .as_ref()
2025-11-09T23:19:32.1744537Z +                            .map(|r| format!("{}; {}", r, reason))
2025-11-09T23:19:32.1744645Z +                            .or_else(|| Some(reason.clone()));
2025-11-09T23:19:32.1744712Z                      }
2025-11-09T23:19:32.1744780Z                  }
2025-11-09T23:19:32.1744853Z                  None => {
2025-11-09T23:19:32.1745147Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:50:
2025-11-09T23:19:32.1745215Z              }
2025-11-09T23:19:32.1745280Z          }
2025-11-09T23:19:32.1745348Z      }
2025-11-09T23:19:32.1745416Z -    
2025-11-09T23:19:32.1745480Z +
2025-11-09T23:19:32.1745564Z      // Convert to sorted vector
2025-11-09T23:19:32.1745856Z      let mut result: Vec<BanEntry> = merged.into_values().collect();
2025-11-09T23:19:32.1745939Z      result.sort_by(|a, b| {
2025-11-09T23:19:32.1746224Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:57:
2025-11-09T23:19:32.1746336Z          // Sort by address for deterministic output
2025-11-09T23:19:32.1746425Z -        a.addr.ip.cmp(&b.addr.ip)
2025-11-09T23:19:32.1746495Z +        a.addr
2025-11-09T23:19:32.1746569Z +            .ip
2025-11-09T23:19:32.1746651Z +            .cmp(&b.addr.ip)
2025-11-09T23:19:32.1746765Z              .then_with(|| a.addr.port.cmp(&b.addr.port))
2025-11-09T23:19:32.1746833Z      });
2025-11-09T23:19:32.1746901Z -    
2025-11-09T23:19:32.1746965Z +
2025-11-09T23:19:32.1747030Z      result
2025-11-09T23:19:32.1747095Z  }
2025-11-09T23:19:32.1747166Z  
2025-11-09T23:19:32.1747456Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:72:
2025-11-09T23:19:32.1747550Z              .duration_since(UNIX_EPOCH)
2025-11-09T23:19:32.1747629Z              .unwrap()
2025-11-09T23:19:32.1747702Z              .as_secs();
2025-11-09T23:19:32.1747768Z -        
2025-11-09T23:19:32.1747831Z +
2025-11-09T23:19:32.1747929Z          if now >= entry.unban_timestamp {
2025-11-09T23:19:32.1748026Z              return false; // Ban already expired
2025-11-09T23:19:32.1748092Z          }
2025-11-09T23:19:32.1748382Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:79:
2025-11-09T23:19:32.1748449Z      }
2025-11-09T23:19:32.1748514Z -    
2025-11-09T23:19:32.1748578Z +
2025-11-09T23:19:32.1748681Z      // Additional validation could include:
2025-11-09T23:19:32.1748771Z      // - IP address format validation
2025-11-09T23:19:32.1748853Z      // - Reason length limits
2025-11-09T23:19:32.1749137Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:84:
2025-11-09T23:19:32.1749328Z      // - etc.
2025-11-09T23:19:32.1749396Z -    
2025-11-09T23:19:32.1749464Z +
2025-11-09T23:19:32.1749529Z      true
2025-11-09T23:19:32.1749595Z  }
2025-11-09T23:19:32.1749660Z  
2025-11-09T23:19:32.1749963Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:89:
2025-11-09T23:19:32.1750077Z  /// Calculate hash of ban list (for verification)
2025-11-09T23:19:32.1750240Z  pub fn calculate_ban_list_hash(entries: &[BanEntry]) -> [u8; 32] {
2025-11-09T23:19:32.1750334Z -    use sha2::{Sha256, Digest};
2025-11-09T23:19:32.1750400Z -    
2025-11-09T23:19:32.1750482Z +    use sha2::{Digest, Sha256};
2025-11-09T23:19:32.1750547Z +
2025-11-09T23:19:32.1750655Z      // Sort entries for deterministic hashing
2025-11-09T23:19:32.1750745Z      let mut sorted = entries.to_vec();
2025-11-09T23:19:32.1750828Z      sorted.sort_by(|a, b| {
2025-11-09T23:19:32.1751128Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:96:
2025-11-09T23:19:32.1751219Z -        a.addr.ip.cmp(&b.addr.ip)
2025-11-09T23:19:32.1751287Z +        a.addr
2025-11-09T23:19:32.1751356Z +            .ip
2025-11-09T23:19:32.1751442Z +            .cmp(&b.addr.ip)
2025-11-09T23:19:32.1751556Z              .then_with(|| a.addr.port.cmp(&b.addr.port))
2025-11-09T23:19:32.1751623Z      });
2025-11-09T23:19:32.1751692Z -    
2025-11-09T23:19:32.1751758Z +
2025-11-09T23:19:32.1751836Z      // Serialize and hash
2025-11-09T23:19:32.1752007Z      let serialized = bincode::serialize(&sorted).unwrap_or_default();
2025-11-09T23:19:32.1752110Z      let hash = Sha256::digest(&serialized);
2025-11-09T23:19:32.1752405Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:103:
2025-11-09T23:19:32.1752473Z -    
2025-11-09T23:19:32.1752542Z +
2025-11-09T23:19:32.1752623Z      let mut result = [0u8; 32];
2025-11-09T23:19:32.1752716Z      result.copy_from_slice(&hash);
2025-11-09T23:19:32.1752784Z      result
2025-11-09T23:19:32.1753180Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:111:
2025-11-09T23:19:32.1753302Z      let calculated = calculate_ban_list_hash(entries);
2025-11-09T23:19:32.1753390Z      calculated == *expected_hash
2025-11-09T23:19:32.1753460Z  }
2025-11-09T23:19:32.1753524Z -
2025-11-09T23:19:32.1753587Z -
2025-11-09T23:19:32.1753649Z -
2025-11-09T23:19:32.1753717Z  
2025-11-09T23:19:32.1754003Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_signing.rs:2:
2025-11-09T23:19:32.1754067Z  //!
2025-11-09T23:19:32.1754240Z  //! Provides functions to sign and verify ban lists for authenticity.
2025-11-09T23:19:32.1754427Z  
2025-11-09T23:19:32.1754578Z -use crate::network::protocol::{BanListMessage, BanEntry};
2025-11-09T23:19:32.1754783Z -use secp256k1::{Secp256k1, Message, ecdsa::Signature, SecretKey, PublicKey};
2025-11-09T23:19:32.1754926Z +use crate::network::protocol::{BanEntry, BanListMessage};
2025-11-09T23:19:32.1755115Z +use secp256k1::{ecdsa::Signature, Message, PublicKey, Secp256k1, SecretKey};
2025-11-09T23:19:32.1755185Z  
2025-11-09T23:19:32.1755283Z  /// Sign a ban list with a private key
2025-11-09T23:19:32.1755348Z  ///
2025-11-09T23:19:32.1755640Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_signing.rs:13:
2025-11-09T23:19:32.1755730Z      private_key: &SecretKey,
2025-11-09T23:19:32.1755824Z  ) -> Result<Vec<u8>, secp256k1::Error> {
2025-11-09T23:19:32.1755913Z      let secp = Secp256k1::new();
2025-11-09T23:19:32.1755980Z -    
2025-11-09T23:19:32.1756048Z +
2025-11-09T23:19:32.1756136Z      // Serialize ban list for signing
2025-11-09T23:19:32.1756251Z -    let serialized = bincode::serialize(ban_list)
2025-11-09T23:19:32.1756377Z -        .map_err(|_| secp256k1::Error::InvalidMessage)?;
2025-11-09T23:19:32.1756440Z -    
2025-11-09T23:19:32.1756816Z +    let serialized = bincode::serialize(ban_list).map_err(|_| secp256k1::Error::InvalidMessage)?;
2025-11-09T23:19:32.1756894Z +
2025-11-09T23:19:32.1756976Z      // Hash the serialized data
2025-11-09T23:19:32.1757056Z -    use sha2::{Sha256, Digest};
2025-11-09T23:19:32.1757136Z +    use sha2::{Digest, Sha256};
2025-11-09T23:19:32.1757241Z      let hash = Sha256::digest(&serialized);
2025-11-09T23:19:32.1757307Z -    
2025-11-09T23:19:32.1757373Z +
2025-11-09T23:19:32.1757452Z      // Create message from hash
2025-11-09T23:19:32.1757559Z -    let message = Message::from_slice(&hash)
2025-11-09T23:19:32.1757677Z -        .map_err(|_| secp256k1::Error::InvalidMessage)?;
2025-11-09T23:19:32.1757742Z -    
2025-11-09T23:19:32.1757968Z +    let message = Message::from_slice(&hash).map_err(|_| secp256k1::Error::InvalidMessage)?;
2025-11-09T23:19:32.1758032Z +
2025-11-09T23:19:32.1758099Z      // Sign
2025-11-09T23:19:32.1758237Z      let signature = secp.sign_ecdsa(&message, private_key);
2025-11-09T23:19:32.1758305Z -    
2025-11-09T23:19:32.1758368Z +
2025-11-09T23:19:32.1758448Z      // Serialize signature
2025-11-09T23:19:32.1758564Z      Ok(signature.serialize_compact().to_vec())
2025-11-09T23:19:32.1758629Z  }
2025-11-09T23:19:32.1758925Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_signing.rs:44:
2025-11-09T23:19:32.1759012Z      if signature.len() != 64 {
2025-11-09T23:19:32.1759089Z          return Ok(false);
2025-11-09T23:19:32.1759155Z      }
2025-11-09T23:19:32.1759220Z -    
2025-11-09T23:19:32.1759288Z +
2025-11-09T23:19:32.1759375Z      let secp = Secp256k1::new();
2025-11-09T23:19:32.1759439Z -    
2025-11-09T23:19:32.1759507Z +
2025-11-09T23:19:32.1759582Z      // Serialize ban list
2025-11-09T23:19:32.1759695Z -    let serialized = bincode::serialize(ban_list)
2025-11-09T23:19:32.1759813Z -        .map_err(|_| secp256k1::Error::InvalidMessage)?;
2025-11-09T23:19:32.1759882Z -    
2025-11-09T23:19:32.1760125Z +    let serialized = bincode::serialize(ban_list).map_err(|_| secp256k1::Error::InvalidMessage)?;
2025-11-09T23:19:32.1760193Z +
2025-11-09T23:19:32.1760279Z      // Hash the serialized data
2025-11-09T23:19:32.1760481Z -    use sha2::{Sha256, Digest};
2025-11-09T23:19:32.1760563Z +    use sha2::{Digest, Sha256};
2025-11-09T23:19:32.1760661Z      let hash = Sha256::digest(&serialized);
2025-11-09T23:19:32.1760730Z -    
2025-11-09T23:19:32.1760791Z +
2025-11-09T23:19:32.1760871Z      // Create message from hash
2025-11-09T23:19:32.1761018Z -    let message = Message::from_slice(&hash)
2025-11-09T23:19:32.1761220Z -        .map_err(|_| secp256k1::Error::InvalidMessage)?;
2025-11-09T23:19:32.1761338Z -    
2025-11-09T23:19:32.1761721Z +    let message = Message::from_slice(&hash).map_err(|_| secp256k1::Error::InvalidMessage)?;
2025-11-09T23:19:32.1761847Z +
2025-11-09T23:19:32.1761986Z      // Parse signature
2025-11-09T23:19:32.1762185Z -    let sig = Signature::from_compact(signature)
2025-11-09T23:19:32.1762402Z -        .map_err(|_| secp256k1::Error::InvalidSignature)?;
2025-11-09T23:19:32.1762529Z -    
2025-11-09T23:19:32.1762827Z +    let sig = Signature::from_compact(signature).map_err(|_| secp256k1::Error::InvalidSignature)?;
2025-11-09T23:19:32.1762898Z +
2025-11-09T23:19:32.1762973Z      // Verify
2025-11-09T23:19:32.1763113Z      Ok(secp.verify_ecdsa(&message, &sig, public_key).is_ok())
2025-11-09T23:19:32.1763178Z  }
2025-11-09T23:19:32.1763486Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_signing.rs:86:
2025-11-09T23:19:32.1763582Z      ) -> Result<Self, secp256k1::Error> {
2025-11-09T23:19:32.1763673Z          let secp = Secp256k1::new();
2025-11-09T23:19:32.1763843Z          let public_key = PublicKey::from_secret_key(&secp, private_key);
2025-11-09T23:19:32.1763910Z -        
2025-11-09T23:19:32.1763976Z +
2025-11-09T23:19:32.1764109Z          let signature = sign_ban_list(&ban_list, private_key)?;
2025-11-09T23:19:32.1764180Z -        
2025-11-09T23:19:32.1764261Z +
2025-11-09T23:19:32.1764677Z          Ok(Self {
2025-11-09T23:19:32.1764758Z              ban_list,
2025-11-09T23:19:32.1764834Z              signature,
2025-11-09T23:19:32.1765153Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_signing.rs:95:
2025-11-09T23:19:32.1765231Z              public_key,
2025-11-09T23:19:32.1765303Z          })
2025-11-09T23:19:32.1765371Z      }
2025-11-09T23:19:32.1765438Z -    
2025-11-09T23:19:32.1765511Z +
2025-11-09T23:19:32.1765592Z      /// Verify the signature
2025-11-09T23:19:32.1765737Z      pub fn verify(&self) -> Result<bool, secp256k1::Error> {
2025-11-09T23:19:32.1765941Z          verify_ban_list_signature(&self.ban_list, &self.signature, &self.public_key)
2025-11-09T23:19:32.1766251Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_signing.rs:102:
2025-11-09T23:19:32.1766317Z      }
2025-11-09T23:19:32.1766381Z  }
2025-11-09T23:19:32.1766451Z -
2025-11-09T23:19:32.1766516Z -
2025-11-09T23:19:32.1766582Z  
2025-11-09T23:19:32.1766873Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:4:
2025-11-09T23:19:32.1766976Z  //! using the BlockFilterService.
2025-11-09T23:19:32.1767041Z  
2025-11-09T23:19:32.1767183Z  use crate::network::filter_service::BlockFilterService;
2025-11-09T23:19:32.1767273Z -use crate::storage::Storage;
2025-11-09T23:19:32.1767367Z  use crate::network::protocol::{
2025-11-09T23:19:32.1767640Z      CfcheckptMessage, CfheadersMessage, CfilterMessage, FilterHeaderData, GetCfcheckptMessage,
2025-11-09T23:19:32.1767811Z      GetCfheadersMessage, GetCfiltersMessage, ProtocolMessage,
2025-11-09T23:19:32.1768308Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:11:
2025-11-09T23:19:32.1768422Z  };
2025-11-09T23:19:32.1768575Z +use crate::storage::Storage;
2025-11-09T23:19:32.1768678Z  use anyhow::{anyhow, Result};
2025-11-09T23:19:32.1768769Z  use bllvm_protocol::Hash;
2025-11-09T23:19:32.1768847Z  use std::sync::Arc;
2025-11-09T23:19:32.1769145Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:30:
2025-11-09T23:19:32.1769401Z          // Get current height to determine stop height
2025-11-09T23:19:32.1769584Z          let current_height = storage.chain().get_height()?.unwrap_or(0) as u32;
2025-11-09T23:19:32.1769692Z          let start_height = request.start_height;
2025-11-09T23:19:32.1769761Z -        
2025-11-09T23:19:32.1769824Z +
2025-11-09T23:19:32.1769987Z          // Find stop height by iterating from start until we find stop_hash
2025-11-09T23:19:32.1770087Z          let mut stop_height = start_height;
2025-11-09T23:19:32.1770172Z          let mut found_stop = false;
2025-11-09T23:19:32.1770458Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:37:
2025-11-09T23:19:32.1770530Z -        
2025-11-09T23:19:32.1770593Z +
2025-11-09T23:19:32.1770696Z          // Iterate through blocks from start_height
2025-11-09T23:19:32.1770879Z          for height in start_height..=current_height.min(start_height + 2000) {
2025-11-09T23:19:32.1770989Z              // Get block hash by height, then get block
2025-11-09T23:19:32.1772582Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:41:
2025-11-09T23:19:32.1772782Z              if let Ok(Some(block_hash)) = storage.blocks().get_hash_by_height(height as u64) {
2025-11-09T23:19:32.1772932Z                  if let Ok(Some(block)) = storage.blocks().get_block(&block_hash) {
2025-11-09T23:19:32.1773001Z -                
2025-11-09T23:19:32.1773104Z                      // Calculate block hash properly
2025-11-09T23:19:32.1773224Z                      use crate::storage::hashing::double_sha256;
2025-11-09T23:19:32.1773323Z                      let mut header_data = Vec::new();
2025-11-09T23:19:32.1773608Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:51:
2025-11-09T23:19:32.1773881Z                      header_data.extend_from_slice(&block.header.bits.to_le_bytes());
2025-11-09T23:19:32.1774053Z                      header_data.extend_from_slice(&block.header.nonce.to_le_bytes());
2025-11-09T23:19:32.1774187Z                      let calculated_hash = double_sha256(&header_data);
2025-11-09T23:19:32.1774260Z -                    
2025-11-09T23:19:32.1774459Z +
2025-11-09T23:19:32.1774555Z                      // Check if this is the stop hash
2025-11-09T23:19:32.1774664Z                      if calculated_hash == request.stop_hash {
2025-11-09T23:19:32.1774757Z                          found_stop = true;
2025-11-09T23:19:32.1775040Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:58:
2025-11-09T23:19:32.1775130Z                          stop_height = height;
2025-11-09T23:19:32.1775204Z                      }
2025-11-09T23:19:32.1775270Z -                    
2025-11-09T23:19:32.1775336Z +
2025-11-09T23:19:32.1775430Z                      // Try to get cached filter
2025-11-09T23:19:32.1775627Z                      let filter = if let Some(cached) = filter_service.get_filter(&calculated_hash) {
2025-11-09T23:19:32.1775707Z                          cached
2025-11-09T23:19:32.1775987Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:72:
2025-11-09T23:19:32.1776067Z                                  }
2025-11-09T23:19:32.1776139Z                              }
2025-11-09T23:19:32.1776209Z                          }
2025-11-09T23:19:32.1776284Z -                        
2025-11-09T23:19:32.1776349Z +
2025-11-09T23:19:32.1776551Z                          filter_service.generate_and_cache_filter(&block, &prev_scripts, height)?
2025-11-09T23:19:32.1776619Z                      };
2025-11-09T23:19:32.1776693Z -                    
2025-11-09T23:19:32.1776756Z +
2025-11-09T23:19:32.1776918Z                      responses.push(ProtocolMessage::Cfilter(CfilterMessage {
2025-11-09T23:19:32.1777015Z                          filter_type: 0,
2025-11-09T23:19:32.1777111Z                          block_hash: calculated_hash,
2025-11-09T23:19:32.1777519Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:82:
2025-11-09T23:19:32.1777624Z                          filter_data: filter.filter_data,
2025-11-09T23:19:32.1777726Z                          num_elements: filter.num_elements,
2025-11-09T23:19:32.1777798Z                      }));
2025-11-09T23:19:32.1777865Z -                    
2025-11-09T23:19:32.1777932Z +
2025-11-09T23:19:32.1778011Z                      if found_stop {
2025-11-09T23:19:32.1778083Z                          break;
2025-11-09T23:19:32.1778155Z                      }
2025-11-09T23:19:32.1778430Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:89:
2025-11-09T23:19:32.1778498Z                  }
2025-11-09T23:19:32.1778567Z              }
2025-11-09T23:19:32.1778638Z          }
2025-11-09T23:19:32.1778708Z -        
2025-11-09T23:19:32.1778771Z +
2025-11-09T23:19:32.1778888Z          if !found_stop && stop_height < current_height {
2025-11-09T23:19:32.1779041Z              // Stop hash not found in reasonable range, return what we have
2025-11-09T23:19:32.1779107Z          }
2025-11-09T23:19:32.1779380Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip70_handler.rs:3:
2025-11-09T23:19:32.1779526Z  //! Handles incoming BIP70 messages from the P2P network.
2025-11-09T23:19:32.1779626Z  //! Similar to bip157_handler.rs pattern.
2025-11-09T23:19:32.1779689Z  
2025-11-09T23:19:32.1780006Z -use bllvm_protocol::payment::{Bip70Error, PaymentProtocolClient, PaymentProtocolServer, PaymentRequest};
2025-11-09T23:19:32.1780099Z  use crate::network::protocol::{
2025-11-09T23:19:32.1780352Z      GetPaymentRequestMessage, PaymentACKMessage, PaymentMessage, PaymentRequestMessage,
2025-11-09T23:19:32.1780434Z      ProtocolMessage,
2025-11-09T23:19:32.1780717Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip70_handler.rs:10:
2025-11-09T23:19:32.1780907Z  };
2025-11-09T23:19:32.1780989Z  use anyhow::Result;
2025-11-09T23:19:32.1781080Z +use bllvm_protocol::payment::{
2025-11-09T23:19:32.1781288Z +    Bip70Error, PaymentProtocolClient, PaymentProtocolServer, PaymentRequest,
2025-11-09T23:19:32.1781355Z +};
2025-11-09T23:19:32.1781430Z +use hex;
2025-11-09T23:19:32.1781516Z  use std::collections::HashMap;
2025-11-09T23:19:32.1781600Z  use std::sync::{Arc, Mutex};
2025-11-09T23:19:32.1781666Z -use hex;
2025-11-09T23:19:32.1781735Z  
2025-11-09T23:19:32.1781983Z  /// In-memory payment request store (simplified - would use persistent storage in production)
2025-11-09T23:19:32.1782177Z  type PaymentRequestStore = Arc<Mutex<HashMap<String, PaymentRequest>>>;
2025-11-09T23:19:32.1782466Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip70_handler.rs:25:
2025-11-09T23:19:32.1782563Z  ) -> Result<PaymentRequestMessage> {
2025-11-09T23:19:32.1782662Z      if let Some(store) = payment_store {
2025-11-09T23:19:32.1782759Z          let store = store.lock().unwrap();
2025-11-09T23:19:32.1783013Z -        let key = format!("{}_{}", hex::encode(&request.payment_id), hex::encode(&request.merchant_pubkey));
2025-11-09T23:19:32.1783093Z +        let key = format!(
2025-11-09T23:19:32.1783163Z +            "{}_{}",
2025-11-09T23:19:32.1783267Z +            hex::encode(&request.payment_id),
2025-11-09T23:19:32.1783370Z +            hex::encode(&request.merchant_pubkey)
2025-11-09T23:19:32.1783450Z +        );
2025-11-09T23:19:32.1783570Z          if let Some(payment_request) = store.get(&key) {
2025-11-09T23:19:32.1783670Z              // Convert to P2P message format
2025-11-09T23:19:32.1783904Z              // Note: In production, merchant_signature would be generated by signing payment_request
2025-11-09T23:19:32.1784192Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip70_handler.rs:37:
2025-11-09T23:19:32.1784264Z              });
2025-11-09T23:19:32.1784457Z          }
2025-11-09T23:19:32.1784575Z      }
2025-11-09T23:19:32.1784830Z -    
2025-11-09T23:19:32.1784896Z +
2025-11-09T23:19:32.1785040Z      Err(anyhow::anyhow!("Payment request not found"))
2025-11-09T23:19:32.1785105Z  }
2025-11-09T23:19:32.1785170Z  
2025-11-09T23:19:32.1785462Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip70_handler.rs:58:
2025-11-09T23:19:32.1785537Z      } else {
2025-11-09T23:19:32.1785630Z          None
2025-11-09T23:19:32.1785747Z      };
2025-11-09T23:19:32.1785871Z -    
2025-11-09T23:19:32.1785986Z +
2025-11-09T23:19:32.1786166Z      if let Some(request) = original_request {
2025-11-09T23:19:32.1786339Z          // Use existing process_payment function
2025-11-09T23:19:32.1786587Z          use bllvm_protocol::payment::PaymentProtocolServer;
2025-11-09T23:19:32.1788441Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip70_handler.rs:65:
2025-11-09T23:19:32.1789030Z -        let payment_ack = PaymentProtocolServer::process_payment(&payment_msg.payment, &request, merchant_private_key)
2025-11-09T23:19:32.1789344Z -            .map_err(|e| anyhow::anyhow!("Payment processing failed: {:?}", e))?;
2025-11-09T23:19:32.1789458Z -        
2025-11-09T23:19:32.1789713Z +        let payment_ack = PaymentProtocolServer::process_payment(
2025-11-09T23:19:32.1789861Z +            &payment_msg.payment,
2025-11-09T23:19:32.1797608Z +            &request,
2025-11-09T23:19:32.1797815Z +            merchant_private_key,
2025-11-09T23:19:32.1797922Z +        )
2025-11-09T23:19:32.1798128Z +        .map_err(|e| anyhow::anyhow!("Payment processing failed: {:?}", e))?;
2025-11-09T23:19:32.1798203Z +
2025-11-09T23:19:32.1798303Z          // Convert to P2P message format
2025-11-09T23:19:32.1798396Z          Ok(PaymentACKMessage {
2025-11-09T23:19:32.1798478Z              payment_ack,
2025-11-09T23:19:32.1798790Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip70_handler.rs:79:
2025-11-09T23:19:32.1799134Z  /// Validate PaymentRequest message from P2P network
2025-11-09T23:19:32.1799414Z  pub fn validate_payment_request_message(msg: &PaymentRequestMessage) -> Result<(), Bip70Error> {
2025-11-09T23:19:32.1799567Z      use bllvm_protocol::payment::PaymentProtocolClient;
2025-11-09T23:19:32.1799866Z -    PaymentProtocolClient::validate_payment_request(&msg.payment_request, Some(&msg.merchant_pubkey))
2025-11-09T23:19:32.1799992Z +    PaymentProtocolClient::validate_payment_request(
2025-11-09T23:19:32.1800082Z +        &msg.payment_request,
2025-11-09T23:19:32.1800169Z +        Some(&msg.merchant_pubkey),
2025-11-09T23:19:32.1800235Z +    )
2025-11-09T23:19:32.1800303Z  }
2025-11-09T23:19:32.1800366Z  
2025-11-09T23:19:32.1800475Z  /// Validate PaymentACK message from merchant
2025-11-09T23:19:32.1800765Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip70_handler.rs:88:
2025-11-09T23:19:32.1800854Z      merchant_pubkey: &[u8],
2025-11-09T23:19:32.1800942Z  ) -> Result<(), Bip70Error> {
2025-11-09T23:19:32.1801305Z      use bllvm_protocol::payment::PaymentProtocolClient;
2025-11-09T23:19:32.1801627Z -    PaymentProtocolClient::validate_payment_ack(&ack.payment_ack, &ack.merchant_signature, merchant_pubkey)
2025-11-09T23:19:32.1801744Z +    PaymentProtocolClient::validate_payment_ack(
2025-11-09T23:19:32.1801824Z +        &ack.payment_ack,
2025-11-09T23:19:32.1801910Z +        &ack.merchant_signature,
2025-11-09T23:19:32.1801990Z +        merchant_pubkey,
2025-11-09T23:19:32.1802055Z +    )
2025-11-09T23:19:32.1802119Z  }
2025-11-09T23:19:32.1802186Z  
2025-11-09T23:19:32.1802550Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/chain_access.rs:3:
2025-11-09T23:19:32.1802726Z  //! Implements ChainStateAccess trait to bridge node storage modules
2025-11-09T23:19:32.1802942Z  //! (BlockStore, TxIndex, MempoolManager) with protocol layer network processing.
2025-11-09T23:19:32.1803014Z  
2025-11-09T23:19:32.1803121Z +use crate::node::mempool::MempoolManager;
2025-11-09T23:19:32.1803276Z +use crate::storage::{blockstore::BlockStore, txindex::TxIndex};
2025-11-09T23:19:32.1803492Z  use anyhow::Result;
2025-11-09T23:19:32.1803653Z  use bllvm_protocol::network::{ChainObject, ChainStateAccess};
2025-11-09T23:19:32.1803801Z  use bllvm_protocol::{Block, BlockHeader, Hash, Transaction};
2025-11-09T23:19:32.1804084Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/chain_access.rs:9:
2025-11-09T23:19:32.1804189Z -use crate::node::mempool::MempoolManager;
2025-11-09T23:19:32.1804614Z -use crate::storage::{blockstore::BlockStore, txindex::TxIndex};
2025-11-09T23:19:32.1804730Z  use std::sync::Arc;
2025-11-09T23:19:32.1804799Z  
2025-11-09T23:19:32.1805014Z  /// Chain state access implementation that bridges node storage to protocol layer
2025-11-09T23:19:32.1805312Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/chain_access.rs:68:
2025-11-09T23:19:32.1805449Z      /// This implements the Bitcoin block locator algorithm
2025-11-09T23:19:32.1805667Z      fn get_headers_for_locator(&self, locator: &[Hash], stop: &Hash) -> Vec<BlockHeader> {
2025-11-09T23:19:32.1805766Z          let mut headers = Vec::new();
2025-11-09T23:19:32.1805839Z -        
2025-11-09T23:19:32.1805903Z +
2025-11-09T23:19:32.1805996Z          // Bitcoin block locator algorithm:
2025-11-09T23:19:32.1806106Z          // 1. Start with the most recent block hash
2025-11-09T23:19:32.1806290Z          // 2. Go back exponentially (1, 2, 4, 8, 16, ...) until we find a common ancestor
2025-11-09T23:19:32.1806575Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/chain_access.rs:75:
2025-11-09T23:19:32.1806715Z          // 3. Stop when we reach the stop hash or run out of hashes
2025-11-09T23:19:32.1806783Z -        
2025-11-09T23:19:32.1806846Z +
2025-11-09T23:19:32.1806927Z          for hash in locator {
2025-11-09T23:19:32.1807033Z              // If we've reached the stop hash, stop
2025-11-09T23:19:32.1807281Z              if hash == stop {
2025-11-09T23:19:32.1807559Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/chain_access.rs:80:
2025-11-09T23:19:32.1807636Z                  break;
2025-11-09T23:19:32.1807704Z              }
2025-11-09T23:19:32.1807768Z -            
2025-11-09T23:19:32.1807830Z +
2025-11-09T23:19:32.1807919Z              // Try to get the header
2025-11-09T23:19:32.1808064Z              if let Ok(Some(header)) = self.blockstore.get_header(hash) {
2025-11-09T23:19:32.1808152Z                  headers.push(header);
2025-11-09T23:19:32.1808421Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/chain_access.rs:89:
2025-11-09T23:19:32.1808494Z                  continue;
2025-11-09T23:19:32.1808558Z              }
2025-11-09T23:19:32.1808622Z          }
2025-11-09T23:19:32.1808688Z -        
2025-11-09T23:19:32.1808751Z +
2025-11-09T23:19:32.1808818Z          headers
2025-11-09T23:19:32.1808891Z      }
2025-11-09T23:19:32.1808955Z  
2025-11-09T23:19:32.1809228Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/chain_access.rs:130:
2025-11-09T23:19:32.1809317Z      height: Option<u64>,
2025-11-09T23:19:32.1809458Z  ) -> Result<bllvm_protocol::network::NetworkResponse> {
2025-11-09T23:19:32.1809653Z      use bllvm_protocol::network::{process_network_message, ChainStateAccess};
2025-11-09T23:19:32.1809717Z -    
2025-11-09T23:19:32.1809785Z +
2025-11-09T23:19:32.1809871Z      process_network_message(
2025-11-09T23:19:32.1809937Z          engine,
2025-11-09T23:19:32.1810002Z          message,
2025-11-09T23:19:32.1810289Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/chain_access.rs:138:
2025-11-09T23:19:32.1810402Z          Some(chain_access as &dyn ChainStateAccess),
2025-11-09T23:19:32.1810471Z          utxo_set,
2025-11-09T23:19:32.1810541Z          height,
2025-11-09T23:19:32.1810711Z -    ).map_err(|e| anyhow::anyhow!("Network message processing error: {}", e))
2025-11-09T23:19:32.1810780Z +    )
2025-11-09T23:19:32.1810949Z +    .map_err(|e| anyhow::anyhow!("Network message processing error: {}", e))
2025-11-09T23:19:32.1811142Z  }
2025-11-09T23:19:32.1811205Z -
2025-11-09T23:19:32.1812780Z  
2025-11-09T23:19:32.1813130Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dns_seeds.rs:38:
2025-11-09T23:19:32.1813216Z      max_addresses: usize,
2025-11-09T23:19:32.1813301Z  ) -> Vec<NetworkAddress> {
2025-11-09T23:19:32.1813391Z      let mut addresses = Vec::new();
2025-11-09T23:19:32.1813457Z -    
2025-11-09T23:19:32.1813526Z +
2025-11-09T23:19:32.1813601Z      for seed in seeds {
2025-11-09T23:19:32.1813711Z          match resolve_dns_seed(*seed, port).await {
2025-11-09T23:19:32.1813793Z              Ok(mut addrs) => {
2025-11-09T23:19:32.1814055Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dns_seeds.rs:53:
2025-11-09T23:19:32.1814123Z              }
2025-11-09T23:19:32.1814191Z          }
2025-11-09T23:19:32.1814260Z      }
2025-11-09T23:19:32.1814451Z -    
2025-11-09T23:19:32.1814520Z +
2025-11-09T23:19:32.1814610Z      // Limit to max_addresses
2025-11-09T23:19:32.1814705Z      addresses.truncate(max_addresses);
2025-11-09T23:19:32.1814774Z      addresses
2025-11-09T23:19:32.1815027Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dns_seeds.rs:63:
2025-11-09T23:19:32.1815245Z  async fn resolve_dns_seed(seed: &str, port: u16) -> Result<Vec<NetworkAddress>, String> {
2025-11-09T23:19:32.1815355Z      // Create hostname:port string for DNS lookup
2025-11-09T23:19:32.1815457Z      let hostname = format!("{}:{}", seed, port);
2025-11-09T23:19:32.1815528Z -    
2025-11-09T23:19:32.1815589Z +
2025-11-09T23:19:32.1815675Z      // Perform DNS lookup with timeout
2025-11-09T23:19:32.1815771Z      let timeout = Duration::from_secs(5);
2025-11-09T23:19:32.1815958Z      let lookup_result = tokio::time::timeout(timeout, lookup_host(&hostname))
2025-11-09T23:19:32.1816349Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dns_seeds.rs:70:
2025-11-09T23:19:32.1816421Z          .await
2025-11-09T23:19:32.1816561Z          .map_err(|_| format!("DNS lookup timeout for {}", seed))?;
2025-11-09T23:19:32.1816625Z -    
2025-11-09T23:19:32.1816713Z -    let socket_addrs = lookup_result
2025-11-09T23:19:32.1816859Z -        .map_err(|e| format!("DNS lookup failed for {}: {}", seed, e))?;
2025-11-09T23:19:32.1816922Z -    
2025-11-09T23:19:32.1816983Z +
2025-11-09T23:19:32.1817065Z +    let socket_addrs =
2025-11-09T23:19:32.1817251Z +        lookup_result.map_err(|e| format!("DNS lookup failed for {}: {}", seed, e))?;
2025-11-09T23:19:32.1817315Z +
2025-11-09T23:19:32.1817414Z      // Convert SocketAddr to NetworkAddress
2025-11-09T23:19:32.1817508Z      let mut addresses = Vec::new();
2025-11-09T23:19:32.1817594Z      for socket_addr in socket_addrs {
2025-11-09T23:19:32.1818282Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dns_seeds.rs:79:
2025-11-09T23:19:32.1818451Z          addresses.push(socket_addr_to_network_address(socket_addr));
2025-11-09T23:19:32.1818526Z      }
2025-11-09T23:19:32.1818591Z -    
2025-11-09T23:19:32.1820533Z +
2025-11-09T23:19:32.1820668Z      Ok(addresses)
2025-11-09T23:19:32.1820784Z  }
2025-11-09T23:19:32.1820896Z  
2025-11-09T23:19:32.1821366Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dns_seeds.rs:85:
2025-11-09T23:19:32.1821546Z  /// Convert SocketAddr to NetworkAddress
2025-11-09T23:19:32.1821901Z  fn socket_addr_to_network_address(socket_addr: SocketAddr) -> NetworkAddress {
2025-11-09T23:19:32.1822068Z      use std::net::IpAddr;
2025-11-09T23:19:32.1822176Z -    
2025-11-09T23:19:32.1822241Z +
2025-11-09T23:19:32.1822340Z      let ip_bytes = match socket_addr.ip() {
2025-11-09T23:19:32.1822426Z          IpAddr::V4(ipv4) => {
2025-11-09T23:19:32.1822520Z              // IPv4-mapped IPv6 format
2025-11-09T23:19:32.1822789Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dns_seeds.rs:95:
2025-11-09T23:19:32.1823089Z              bytes[12..16].copy_from_slice(&ipv4.octets());
2025-11-09T23:19:32.1823165Z              bytes
2025-11-09T23:19:32.1823230Z          }
2025-11-09T23:19:32.1823315Z -        IpAddr::V6(ipv6) => {
2025-11-09T23:19:32.1823398Z -            ipv6.octets()
2025-11-09T23:19:32.1823470Z -        }
2025-11-09T23:19:32.1823564Z +        IpAddr::V6(ipv6) => ipv6.octets(),
2025-11-09T23:19:32.1823630Z      };
2025-11-09T23:19:32.1823699Z -    
2025-11-09T23:19:32.1823762Z +
2025-11-09T23:19:32.1823839Z      NetworkAddress {
2025-11-09T23:19:32.1823957Z          services: 0, // Will be updated when we connect
2025-11-09T23:19:32.1824035Z          ip: ip_bytes,
2025-11-09T23:19:32.1824518Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dns_seeds.rs:125:
2025-11-09T23:19:32.1824611Z          assert_eq!(addr.ip[15], 1);
2025-11-09T23:19:32.1824685Z      }
2025-11-09T23:19:32.1824749Z  }
2025-11-09T23:19:32.1824813Z -
2025-11-09T23:19:32.1824881Z  
2025-11-09T23:19:32.1825165Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:9:
2025-11-09T23:19:32.1825244Z  use std::sync::Arc;
2025-11-09T23:19:32.1825341Z  use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:19:32.1825425Z  use tokio::sync::Mutex;
2025-11-09T23:19:32.1825518Z -use tracing::{debug, warn, error};
2025-11-09T23:19:32.1825605Z +use tracing::{debug, error, warn};
2025-11-09T23:19:32.1825672Z  
2025-11-09T23:19:32.1825853Z  /// Connection rate limiter (tracks connection attempts per time window)
2025-11-09T23:19:32.1825946Z  pub struct ConnectionRateLimiter {
2025-11-09T23:19:32.1826236Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:40:
2025-11-09T23:19:32.1826305Z  
2025-11-09T23:19:32.1826419Z          // Clean up old entries outside the time window
2025-11-09T23:19:32.1826683Z          let cutoff = now.saturating_sub(self.window_seconds);
2025-11-09T23:19:32.1826755Z -        
2025-11-09T23:19:32.1826828Z +
2025-11-09T23:19:32.1827031Z          let attempts = self.connection_attempts.entry(ip).or_insert_with(Vec::new);
2025-11-09T23:19:32.1827160Z          attempts.retain(|&timestamp| timestamp > cutoff);
2025-11-09T23:19:32.1827224Z  
2025-11-09T23:19:32.1827502Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:47:
2025-11-09T23:19:32.1827593Z          // Check if we're within the limit
2025-11-09T23:19:32.1827729Z          if attempts.len() >= self.max_connections_per_window {
2025-11-09T23:19:32.1827928Z -            warn!("Connection rate limit exceeded for IP {}: {} attempts in {} seconds", 
2025-11-09T23:19:32.1828036Z -                  ip, attempts.len(), self.window_seconds);
2025-11-09T23:19:32.1828113Z +            warn!(
2025-11-09T23:19:32.1828290Z +                "Connection rate limit exceeded for IP {}: {} attempts in {} seconds",
2025-11-09T23:19:32.1828365Z +                ip,
2025-11-09T23:19:32.1828452Z +                attempts.len(),
2025-11-09T23:19:32.1828537Z +                self.window_seconds
2025-11-09T23:19:32.1828604Z +            );
2025-11-09T23:19:32.1828673Z              false
2025-11-09T23:19:32.1828744Z          } else {
2025-11-09T23:19:32.1828838Z              // Record this connection attempt
2025-11-09T23:19:32.1829118Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:72:
2025-11-09T23:19:32.1829189Z  
2025-11-09T23:19:32.1830904Z      /// Get current connection attempt count for an IP
2025-11-09T23:19:32.1831030Z      pub fn get_attempt_count(&self, ip: IpAddr) -> usize {
2025-11-09T23:19:32.1831197Z -        self.connection_attempts.get(&ip).map(|v| v.len()).unwrap_or(0)
2025-11-09T23:19:32.1831288Z +        self.connection_attempts
2025-11-09T23:19:32.1831361Z +            .get(&ip)
2025-11-09T23:19:32.1831439Z +            .map(|v| v.len())
2025-11-09T23:19:32.1831526Z +            .unwrap_or(0)
2025-11-09T23:19:32.1831592Z      }
2025-11-09T23:19:32.1831656Z  }
2025-11-09T23:19:32.1831850Z  
2025-11-09T23:19:32.1832143Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:171:
2025-11-09T23:19:32.1832233Z      /// Create with default settings
2025-11-09T23:19:32.1832317Z      pub fn default() -> Self {
2025-11-09T23:19:32.1832396Z          Self::new(
2025-11-09T23:19:32.1832508Z -            10,   // Max 10 connections per IP per window
2025-11-09T23:19:32.1832589Z -            60,   // 60 second window
2025-11-09T23:19:32.1832693Z +            10,    // Max 10 connections per IP per window
2025-11-09T23:19:32.1832775Z +            60,    // 60 second window
2025-11-09T23:19:32.1832863Z              10000, // Max 10k messages in queue
2025-11-09T23:19:32.1832948Z -            200,  // Max 200 active connections
2025-11-09T23:19:32.1833043Z +            200,   // Max 200 active connections
2025-11-09T23:19:32.1833114Z          )
2025-11-09T23:19:32.1833177Z      }
2025-11-09T23:19:32.1833242Z  
2025-11-09T23:19:32.1833533Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:194:
2025-11-09T23:19:32.1833640Z              metrics.connection_rate_violations += 1;
2025-11-09T23:19:32.1833703Z  
2025-11-09T23:19:32.1833826Z              if *count >= self.auto_ban_connection_violations {
2025-11-09T23:19:32.1834035Z -                warn!("Auto-banning IP {} for repeated connection rate violations ({} violations)", 
2025-11-09T23:19:32.1834113Z -                      ip, *count);
2025-11-09T23:19:32.1834190Z +                warn!(
2025-11-09T23:19:32.1834637Z +                    "Auto-banning IP {} for repeated connection rate violations ({} violations)",
2025-11-09T23:19:32.1834726Z +                    ip, *count
2025-11-09T23:19:32.1834792Z +                );
2025-11-09T23:19:32.1834900Z                  metrics.auto_bans_applied += 1;
2025-11-09T23:19:32.1835168Z                  // Return false to reject, caller should ban
2025-11-09T23:19:32.1835247Z                  return false;
2025-11-09T23:19:32.1835566Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:212:
2025-11-09T23:19:32.1835663Z      /// Check if message queue is within limits
2025-11-09T23:19:32.1835854Z      pub async fn check_message_queue_size(&self, current_size: usize) -> bool {
2025-11-09T23:19:32.1835975Z          if current_size > self.max_message_queue_size {
2025-11-09T23:19:32.1836187Z -            warn!("Message queue size exceeded: {} > {}", current_size, self.max_message_queue_size);
2025-11-09T23:19:32.1836255Z +            warn!(
2025-11-09T23:19:32.1836351Z +                "Message queue size exceeded: {} > {}",
2025-11-09T23:19:32.1836460Z +                current_size, self.max_message_queue_size
2025-11-09T23:19:32.1836527Z +            );
2025-11-09T23:19:32.1836641Z              let mut metrics = self.metrics.lock().await;
2025-11-09T23:19:32.1836752Z              metrics.message_queue_overflows += 1;
2025-11-09T23:19:32.1836821Z              false
2025-11-09T23:19:32.1837111Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:224:
2025-11-09T23:19:32.1837213Z      /// Check if we can accept more connections
2025-11-09T23:19:32.1837400Z      pub async fn check_active_connections(&self, current_count: usize) -> bool {
2025-11-09T23:19:32.1837516Z          if current_count >= self.max_active_connections {
2025-11-09T23:19:32.1837761Z -            warn!("Active connection limit exceeded: {} >= {}", current_count, self.max_active_connections);
2025-11-09T23:19:32.1837837Z +            warn!(
2025-11-09T23:19:32.1837949Z +                "Active connection limit exceeded: {} >= {}",
2025-11-09T23:19:32.1838055Z +                current_count, self.max_active_connections
2025-11-09T23:19:32.1838127Z +            );
2025-11-09T23:19:32.1838234Z              let mut metrics = self.metrics.lock().await;
2025-11-09T23:19:32.1838343Z              metrics.active_connection_limit_hits += 1;
2025-11-09T23:19:32.1838567Z              false
2025-11-09T23:19:32.1838857Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:262:
2025-11-09T23:19:32.1838963Z      /// Check if we're under DoS attack (heuristic)
2025-11-09T23:19:32.1839072Z      pub async fn detect_dos_attack(&self) -> bool {
2025-11-09T23:19:32.1841091Z          let metrics = self.resource_metrics.lock().await;
2025-11-09T23:19:32.1841161Z -        
2025-11-09T23:19:32.1841229Z +
2025-11-09T23:19:32.1841416Z          // Heuristic: If message queue is > 80% full and connections are > 80% of max
2025-11-09T23:19:32.1841596Z          let queue_threshold = (self.max_message_queue_size as f64 * 0.8) as usize;
2025-11-09T23:19:32.1841768Z          let conn_threshold = (self.max_active_connections as f64 * 0.8) as usize;
2025-11-09T23:19:32.1842060Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:269:
2025-11-09T23:19:32.1842128Z  
2025-11-09T23:19:32.1842244Z -        metrics.message_queue_size > queue_threshold 
2025-11-09T23:19:32.1842356Z -            && metrics.active_connections > conn_threshold
2025-11-09T23:19:32.1842603Z +        metrics.message_queue_size > queue_threshold && metrics.active_connections > conn_threshold
2025-11-09T23:19:32.1842669Z      }
2025-11-09T23:19:32.1842733Z  
2025-11-09T23:19:32.1842843Z      /// Cleanup old connection rate limiter entries
2025-11-09T23:19:32.1843125Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:368:
2025-11-09T23:19:32.1843220Z          assert!(dos.should_auto_ban(ip).await);
2025-11-09T23:19:32.1843285Z      }
2025-11-09T23:19:32.1843353Z  }
2025-11-09T23:19:32.1843414Z -
2025-11-09T23:19:32.1843476Z  
2025-11-09T23:19:32.1843786Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/filter_service.rs:3:
2025-11-09T23:19:32.1844088Z  //! Generates, caches, and serves compact block filters for light client support.
2025-11-09T23:19:32.1844243Z  //! Maintains filter header chain for efficient verification.
2025-11-09T23:19:32.1844437Z  
2025-11-09T23:19:32.1844534Z +use anyhow::{anyhow, Result};
2025-11-09T23:19:32.1844622Z  use bllvm_protocol::bip157;
2025-11-09T23:19:32.1844801Z  use bllvm_protocol::bip158::{build_block_filter, CompactBlockFilter};
2025-11-09T23:19:32.1844896Z -use anyhow::{anyhow, Result};
2025-11-09T23:19:32.1845048Z  use bllvm_protocol::{Block, BlockHeader, Hash, Transaction};
2025-11-09T23:19:32.1845138Z  use std::collections::HashMap;
2025-11-09T23:19:32.1845218Z  use std::sync::{Arc, RwLock};
2025-11-09T23:19:32.1845515Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/filter_service.rs:211:
2025-11-09T23:19:32.1845715Z      pub fn remove_filter_for_pruned_block(&self, block_hash: &Hash) -> Result<()> {
2025-11-09T23:19:32.1845801Z          // Remove filter from cache
2025-11-09T23:19:32.1845938Z          self.filters.write().unwrap().remove(block_hash);
2025-11-09T23:19:32.1846004Z -        
2025-11-09T23:19:32.1846072Z +
2025-11-09T23:19:32.1846254Z          // Note: We do NOT remove the filter header - it's required for verification
2025-11-09T23:19:32.1846405Z          // The filter header chain must remain intact even after pruning
2025-11-09T23:19:32.1846469Z -        
2025-11-09T23:19:32.1846533Z +
2025-11-09T23:19:32.1846604Z          Ok(())
2025-11-09T23:19:32.1846668Z      }
2025-11-09T23:19:32.1846730Z  
2025-11-09T23:19:32.1856033Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/message_bridge.rs:80:
2025-11-09T23:19:32.1856299Z      /// 3. Convert the `NetworkResponse` to wire format messages using `extract_send_messages()`
2025-11-09T23:19:32.1856370Z      ///
2025-11-09T23:19:32.1856556Z      /// For now, this method only handles message conversion, not processing.
2025-11-09T23:19:32.1856653Z -    pub fn process_incoming_message(
2025-11-09T23:19:32.1856739Z -        data: &[u8],
2025-11-09T23:19:32.1856829Z -        transport: TransportType,
2025-11-09T23:19:32.1857095Z -    ) -> Result<Vec<Vec<u8>>> {
2025-11-09T23:19:32.1857356Z +    pub fn process_incoming_message(data: &[u8], transport: TransportType) -> Result<Vec<Vec<u8>>> {
2025-11-09T23:19:32.1857447Z          // Convert to protocol message
2025-11-09T23:19:32.1857634Z          let protocol_msg = Self::from_transport_message(data, transport)?;
2025-11-09T23:19:32.1857698Z  
2025-11-09T23:19:32.2649413Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:4:
2025-11-09T23:19:32.2654740Z  //! message handling for communication with other Bitcoin nodes.
2025-11-09T23:19:32.2654891Z  
2025-11-09T23:19:32.2655036Z  pub mod address_db;
2025-11-09T23:19:32.2655189Z +pub mod ban_list_merging;
2025-11-09T23:19:32.2655349Z +pub mod ban_list_signing;
2025-11-09T23:19:32.2655492Z  pub mod chain_access;
2025-11-09T23:19:32.2655624Z  pub mod dns_seeds;
2025-11-09T23:19:32.2655813Z +pub mod dos_protection;
2025-11-09T23:19:32.2655945Z  pub mod inventory;
2025-11-09T23:19:32.2656095Z  pub mod message_bridge;
2025-11-09T23:19:32.2656221Z  pub mod peer;
2025-11-09T23:19:32.2656686Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:12:
2025-11-09T23:19:32.2656823Z  pub mod protocol;
2025-11-09T23:19:32.2656970Z  pub mod protocol_adapter;
2025-11-09T23:19:32.2657125Z  pub mod protocol_extensions;
2025-11-09T23:19:32.2657264Z -pub mod ban_list_merging;
2025-11-09T23:19:32.2657404Z -pub mod ban_list_signing;
2025-11-09T23:19:32.2657548Z -pub mod dos_protection;
2025-11-09T23:19:32.2657671Z  pub mod relay;
2025-11-09T23:19:32.2657806Z  pub mod tcp_transport;
2025-11-09T23:19:32.2657938Z  pub mod transport;
2025-11-09T23:19:32.2658384Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:40:
2025-11-09T23:19:32.2658580Z  // Payment Protocol (BIP70) - P2P handlers
2025-11-09T23:19:32.2659086Z  pub mod bip70_handler;
2025-11-09T23:19:32.2659206Z  
2025-11-09T23:19:32.2659317Z -
2025-11-09T23:19:32.2659484Z  // Privacy and Performance Enhancements
2025-11-09T23:19:32.2659639Z  #[cfg(feature = "dandelion")]
2025-11-09T23:19:32.2659973Z  pub mod dandelion; // Dandelion++ privacy-preserving transaction relay
2025-11-09T23:19:32.2660416Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:50:
2025-11-09T23:19:32.2660654Z  pub mod txhash; // Non-consensus hashing helpers for relay
2025-11-09T23:19:32.2660773Z  
2025-11-09T23:19:32.2661097Z  use crate::network::protocol::{ProtocolMessage, ProtocolParser};
2025-11-09T23:19:32.2661275Z +use crate::node::mempool::MempoolManager;
2025-11-09T23:19:32.2661423Z +use crate::storage::Storage;
2025-11-09T23:19:32.2661562Z  use anyhow::Result;
2025-11-09T23:19:32.2661726Z  use bllvm_protocol::mempool::Mempool;
2025-11-09T23:19:32.2662053Z  use bllvm_protocol::{BitcoinProtocolEngine, ConsensusProof, UtxoSet};
2025-11-09T23:19:32.2662504Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:58:
2025-11-09T23:19:32.2662654Z  use std::sync::{Arc, Mutex};
2025-11-09T23:19:32.2662795Z  use tokio::sync::mpsc;
2025-11-09T23:19:32.2662957Z  use tracing::{error, info, warn};
2025-11-09T23:19:32.2663099Z -use crate::storage::Storage;
2025-11-09T23:19:32.2663277Z -use crate::node::mempool::MempoolManager;
2025-11-09T23:19:32.2663390Z  
2025-11-09T23:19:32.2663599Z  use crate::network::tcp_transport::TcpTransport;
2025-11-09T23:19:32.2663753Z  use crate::network::transport::{
2025-11-09T23:19:32.2664182Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:86:
2025-11-09T23:19:32.2664498Z  }
2025-11-09T23:19:32.2664621Z  
2025-11-09T23:19:32.2664811Z  /// Peer manager for tracking connected peers
2025-11-09T23:19:32.2664932Z -/// 
2025-11-09T23:19:32.2665045Z +///
2025-11-09T23:19:32.2665394Z  /// Uses TransportAddr as key to support all transport types (TCP, Quinn, Iroh).
2025-11-09T23:19:32.2665742Z  /// This allows proper peer identification for Iroh (NodeId) while maintaining
2025-11-09T23:19:32.2666138Z  /// compatibility with TCP/Quinn (SocketAddr).
2025-11-09T23:19:32.2666575Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:130:
2025-11-09T23:19:32.2666796Z      pub fn peer_addresses(&self) -> Vec<TransportAddr> {
2025-11-09T23:19:32.2666973Z          self.peers.keys().cloned().collect()
2025-11-09T23:19:32.2667086Z      }
2025-11-09T23:19:32.2667197Z -    
2025-11-09T23:19:32.2667307Z +
2025-11-09T23:19:32.2667593Z      /// Get peer addresses as SocketAddr (for backward compatibility)
2025-11-09T23:19:32.2667871Z      /// Only returns SocketAddr for TCP/Quinn peers, skips Iroh peers
2025-11-09T23:19:32.2668097Z      pub fn peer_socket_addresses(&self) -> Vec<SocketAddr> {
2025-11-09T23:19:32.2668550Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:137:
2025-11-09T23:19:32.2668693Z -        self.peers.keys()
2025-11-09T23:19:32.2668823Z +        self.peers
2025-11-09T23:19:32.2668949Z +            .keys()
2025-11-09T23:19:32.2669100Z              .filter_map(|addr| {
2025-11-09T23:19:32.2669230Z                  match addr {
2025-11-09T23:19:32.2669422Z                      TransportAddr::Tcp(sock) => Some(*sock),
2025-11-09T23:19:32.2669867Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:150:
2025-11-09T23:19:32.2670037Z      pub fn can_accept_peer(&self) -> bool {
2025-11-09T23:19:32.2670200Z          self.peers.len() < self.max_peers
2025-11-09T23:19:32.2670323Z      }
2025-11-09T23:19:32.2670436Z -    
2025-11-09T23:19:32.2670898Z +
2025-11-09T23:19:32.2671081Z      /// Select best peers based on quality score
2025-11-09T23:19:32.2671207Z -    /// 
2025-11-09T23:19:32.2671321Z +    ///
2025-11-09T23:19:32.2671557Z      /// Returns peers sorted by quality score (highest first)
2025-11-09T23:19:32.2671854Z      pub fn select_best_peers(&self, count: usize) -> Vec<TransportAddr> {
2025-11-09T23:19:32.2672214Z -        let mut peers: Vec<_> = self.peers.iter()
2025-11-09T23:19:32.2672372Z +        let mut peers: Vec<_> = self
2025-11-09T23:19:32.2672494Z +            .peers
2025-11-09T23:19:32.2672643Z +            .iter()
2025-11-09T23:19:32.2672854Z              .map(|(addr, peer)| (addr.clone(), peer.quality_score()))
2025-11-09T23:19:32.2672972Z              .collect();
2025-11-09T23:19:32.2673089Z -        
2025-11-09T23:19:32.2673189Z +
2025-11-09T23:19:32.2673334Z          // Sort by quality score (descending)
2025-11-09T23:19:32.2673653Z          peers.sort_by(|a, b| b.1.partial_cmp(&a.1).unwrap_or(std::cmp::Ordering::Equal));
2025-11-09T23:19:32.2673765Z -        
2025-11-09T23:19:32.2673871Z +
2025-11-09T23:19:32.2674006Z          // Return top N addresses
2025-11-09T23:19:32.2674135Z -        peers.into_iter()
2025-11-09T23:19:32.2674247Z +        peers
2025-11-09T23:19:32.2674515Z +            .into_iter()
2025-11-09T23:19:32.2674635Z              .take(count)
2025-11-09T23:19:32.2674779Z              .map(|(addr, _)| addr)
2025-11-09T23:19:32.2674893Z              .collect()
2025-11-09T23:19:32.2675313Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:170:
2025-11-09T23:19:32.2675424Z      }
2025-11-09T23:19:32.2675526Z -    
2025-11-09T23:19:32.2675626Z +
2025-11-09T23:19:32.2675772Z      /// Select reliable peers only
2025-11-09T23:19:32.2675876Z -    /// 
2025-11-09T23:19:32.2675976Z +    ///
2025-11-09T23:19:32.2676162Z      /// Returns peers that meet reliability criteria
2025-11-09T23:19:32.2676400Z      pub fn select_reliable_peers(&self) -> Vec<TransportAddr> {
2025-11-09T23:19:32.2676527Z -        self.peers.iter()
2025-11-09T23:19:32.2676640Z +        self.peers
2025-11-09T23:19:32.2676755Z +            .iter()
2025-11-09T23:19:32.2677123Z              .filter(|(_, peer)| peer.quality_score() > 0.5) // Use quality_score as reliability indicator
2025-11-09T23:19:32.2677268Z              .map(|(addr, _)| addr.clone())
2025-11-09T23:19:32.2677383Z              .collect()
2025-11-09T23:19:32.2677805Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:180:
2025-11-09T23:19:32.2678099Z      }
2025-11-09T23:19:32.2678195Z -    
2025-11-09T23:19:32.2678297Z +
2025-11-09T23:19:32.2678435Z      /// Get peer quality statistics
2025-11-09T23:19:32.2678645Z      pub fn get_quality_stats(&self) -> (usize, usize, f64) {
2025-11-09T23:19:32.2678795Z          let total = self.peers.len();
2025-11-09T23:19:32.2679218Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:185:
2025-11-09T23:19:32.2679372Z -        let reliable = self.peers.values()
2025-11-09T23:19:32.2679498Z +        let reliable = self
2025-11-09T23:19:32.2679614Z +            .peers
2025-11-09T23:19:32.2679724Z +            .values()
2025-11-09T23:19:32.2680069Z              .filter(|peer| peer.quality_score() > 0.5) // Use quality_score as reliability indicator
2025-11-09T23:19:32.2680196Z              .count();
2025-11-09T23:19:32.2680333Z          let avg_quality = if total > 0 {
2025-11-09T23:19:32.2680738Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:189:
2025-11-09T23:19:32.2680878Z -            self.peers.values()
2025-11-09T23:19:32.2680998Z +            self.peers
2025-11-09T23:19:32.2681116Z +                .values()
2025-11-09T23:19:32.2681273Z                  .map(|peer| peer.quality_score())
2025-11-09T23:19:32.2681433Z -                .sum::<f64>() / total as f64
2025-11-09T23:19:32.2681564Z +                .sum::<f64>()
2025-11-09T23:19:32.2681685Z +                / total as f64
2025-11-09T23:19:32.2681793Z          } else {
2025-11-09T23:19:32.2681909Z              0.0
2025-11-09T23:19:32.2682016Z          };
2025-11-09T23:19:32.2682436Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:195:
2025-11-09T23:19:32.2682561Z -        
2025-11-09T23:19:32.2682671Z +
2025-11-09T23:19:32.2683000Z          (total, reliable, avg_quality)
2025-11-09T23:19:32.2683112Z      }
2025-11-09T23:19:32.2683227Z -    
2025-11-09T23:19:32.2683341Z +
2025-11-09T23:19:32.2683572Z      /// Find peer by SocketAddr (tries TCP and Quinn variants)
2025-11-09T23:19:32.2683735Z      /// Returns the TransportAddr if found
2025-11-09T23:19:32.2684107Z      pub fn find_transport_addr_by_socket(&self, addr: SocketAddr) -> Option<TransportAddr> {
2025-11-09T23:19:32.2684666Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:204:
2025-11-09T23:19:32.2684834Z          if self.peers.contains_key(&tcp_addr) {
2025-11-09T23:19:32.2684973Z              return Some(tcp_addr);
2025-11-09T23:19:32.2685084Z          }
2025-11-09T23:19:32.2685195Z -        
2025-11-09T23:19:32.2685310Z +
2025-11-09T23:19:32.2685425Z          // Try Quinn
2025-11-09T23:19:32.2685557Z          #[cfg(feature = "quinn")]
2025-11-09T23:19:32.2685668Z          {
2025-11-09T23:19:32.2686115Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:213:
2025-11-09T23:19:32.2686282Z                  return Some(quinn_addr);
2025-11-09T23:19:32.2686407Z              }
2025-11-09T23:19:32.2686528Z          }
2025-11-09T23:19:32.2686641Z -        
2025-11-09T23:19:32.2686752Z +
2025-11-09T23:19:32.2686869Z          None
2025-11-09T23:19:32.2686988Z      }
2025-11-09T23:19:32.2687096Z  }
2025-11-09T23:19:32.2687520Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:245:
2025-11-09T23:19:32.2687665Z              last_refill: now,
2025-11-09T23:19:32.2687778Z          }
2025-11-09T23:19:32.2687890Z      }
2025-11-09T23:19:32.2687998Z -    
2025-11-09T23:19:32.2688109Z +
2025-11-09T23:19:32.2688330Z      /// Check if a message can be consumed and consume a token
2025-11-09T23:19:32.2688523Z      pub fn check_and_consume(&mut self) -> bool {
2025-11-09T23:19:32.2688659Z          self.refill();
2025-11-09T23:19:32.2689106Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:256:
2025-11-09T23:19:32.2689236Z              false
2025-11-09T23:19:32.2689346Z          }
2025-11-09T23:19:32.2689705Z      }
2025-11-09T23:19:32.2689818Z -    
2025-11-09T23:19:32.2689928Z +
2025-11-09T23:19:32.2690102Z      /// Refill tokens based on elapsed time
2025-11-09T23:19:32.2690244Z      fn refill(&mut self) {
2025-11-09T23:19:32.2690430Z          use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:19:32.2690880Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:264:
2025-11-09T23:19:32.2691453Z              .duration_since(UNIX_EPOCH)
2025-11-09T23:19:32.2691601Z              .unwrap()
2025-11-09T23:19:32.2691730Z              .as_secs();
2025-11-09T23:19:32.2691855Z -        
2025-11-09T23:19:32.2691971Z +
2025-11-09T23:19:32.2692120Z          if now > self.last_refill {
2025-11-09T23:19:32.2692298Z              let elapsed = now - self.last_refill;
2025-11-09T23:19:32.2692515Z              let tokens_to_add = (elapsed as u32) * self.rate;
2025-11-09T23:19:32.2692985Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:271:
2025-11-09T23:19:32.2693350Z -            self.tokens = self.tokens.saturating_add(tokens_to_add).min(self.burst_limit);
2025-11-09T23:19:32.2693499Z +            self.tokens = self
2025-11-09T23:19:32.2693624Z +                .tokens
2025-11-09T23:19:32.2693784Z +                .saturating_add(tokens_to_add)
2025-11-09T23:19:32.2693934Z +                .min(self.burst_limit);
2025-11-09T23:19:32.2694081Z              self.last_refill = now;
2025-11-09T23:19:32.2694196Z          }
2025-11-09T23:19:32.2694487Z      }
2025-11-09T23:19:32.2694954Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:452:
2025-11-09T23:19:32.2695253Z              enable_self_advertisement: true, // Default: advertise ourselves
2025-11-09T23:19:32.2695366Z          }
2025-11-09T23:19:32.2695481Z      }
2025-11-09T23:19:32.2695594Z -    
2025-11-09T23:19:32.2695998Z +
2025-11-09T23:19:32.2696225Z      /// Set dependencies for protocol message processing
2025-11-09T23:19:32.2696377Z      pub fn with_dependencies(
2025-11-09T23:19:32.2696487Z          mut self,
2025-11-09T23:19:32.2696913Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:525:
2025-11-09T23:19:32.2697154Z      /// Discover peers from DNS seeds and add to address database
2025-11-09T23:19:32.2697511Z      pub async fn discover_peers_from_dns(&self, network: &str, port: u16) -> Result<()> {
2025-11-09T23:19:32.2697666Z          use crate::network::dns_seeds;
2025-11-09T23:19:32.2697788Z -        
2025-11-09T23:19:32.2697897Z +
2025-11-09T23:19:32.2698043Z          let seeds = match network {
2025-11-09T23:19:32.2698233Z              "mainnet" => dns_seeds::MAINNET_DNS_SEEDS,
2025-11-09T23:19:32.2698421Z              "testnet" => dns_seeds::TESTNET_DNS_SEEDS,
2025-11-09T23:19:32.2698865Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:534:
2025-11-09T23:19:32.2699010Z                  return Ok(());
2025-11-09T23:19:32.2699138Z              }
2025-11-09T23:19:32.2699263Z          };
2025-11-09T23:19:32.2699377Z -        
2025-11-09T23:19:32.2699487Z +
2025-11-09T23:19:32.2699733Z          info!("Discovering peers from DNS seeds for {}", network);
2025-11-09T23:19:32.2700036Z          let addresses = dns_seeds::resolve_dns_seeds(seeds, port, 100).await;
2025-11-09T23:19:32.2700150Z -        
2025-11-09T23:19:32.2700268Z +
2025-11-09T23:19:32.2700424Z          // Add discovered addresses to database
2025-11-09T23:19:32.2700530Z          {
2025-11-09T23:19:32.2700723Z              let mut db = self.address_database.lock().unwrap();
2025-11-09T23:19:32.2701364Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:545:
2025-11-09T23:19:32.2701623Z                  db.add_address(addr, 0); // Services will be updated on connection
2025-11-09T23:19:32.2701739Z              }
2025-11-09T23:19:32.2701865Z          }
2025-11-09T23:19:32.2701967Z -        
2025-11-09T23:19:32.2702066Z +
2025-11-09T23:19:32.2702335Z          info!("Discovered {} addresses from DNS seeds", addresses.len());
2025-11-09T23:19:32.2702647Z          Ok(())
2025-11-09T23:19:32.2702762Z      }
2025-11-09T23:19:32.2703212Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:555:
2025-11-09T23:19:32.2703395Z          for peer_addr in persistent_peers {
2025-11-09T23:19:32.2703552Z              // Add to persistent peer set
2025-11-09T23:19:32.2703730Z              self.add_persistent_peer(*peer_addr);
2025-11-09T23:19:32.2703850Z -            
2025-11-09T23:19:32.2703956Z +
2025-11-09T23:19:32.2704082Z              // Try to connect
2025-11-09T23:19:32.2704479Z              info!("Connecting to persistent peer: {}", peer_addr);
2025-11-09T23:19:32.2704720Z              if let Err(e) = self.connect_to_peer(*peer_addr).await {
2025-11-09T23:19:32.2705176Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:566:
2025-11-09T23:19:32.2705314Z      }
2025-11-09T23:19:32.2705435Z  
2025-11-09T23:19:32.2705656Z      /// Discover Iroh peers and add to address database
2025-11-09T23:19:32.2705771Z -    /// 
2025-11-09T23:19:32.2705886Z +    ///
2025-11-09T23:19:32.2706068Z      /// Iroh peers are discovered through:
2025-11-09T23:19:32.2706329Z      /// 1. Incoming connections (automatically stored)
2025-11-09T23:19:32.2706488Z      /// 2. DERP servers (if configured)
2025-11-09T23:19:32.2706949Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:573:
2025-11-09T23:19:32.2707708Z      /// 3. Gossip discovery (if available)
2025-11-09T23:19:32.2707843Z -    /// 
2025-11-09T23:19:32.2707965Z +    ///
2025-11-09T23:19:32.2708336Z      /// This method can be extended to use Iroh's gossip discovery APIs when available.
2025-11-09T23:19:32.2708483Z      #[cfg(feature = "iroh")]
2025-11-09T23:19:32.2708736Z      pub async fn discover_iroh_peers(&self) -> Result<usize> {
2025-11-09T23:19:32.2709451Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:579:
2025-11-09T23:19:32.2709761Z          // 1. Incoming connections (handled automatically in accept loop)
2025-11-09T23:19:32.2709964Z          // 2. DERP servers (configured in IrohTransport)
2025-11-09T23:19:32.2710257Z          // 3. Gossip discovery (would require iroh-gossip-discovery crate)
2025-11-09T23:19:32.2710377Z -        
2025-11-09T23:19:32.2710490Z +
2025-11-09T23:19:32.2710630Z          // For now, we rely on:
2025-11-09T23:19:32.2710813Z          // - Persistent Iroh peers from config
2025-11-09T23:19:32.2711020Z          // - Incoming connections (stored automatically)
2025-11-09T23:19:32.2711459Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:586:
2025-11-09T23:19:32.2711665Z          // - DERP servers (handled by Iroh's MagicEndpoint)
2025-11-09T23:19:32.2711786Z -        
2025-11-09T23:19:32.2711894Z +
2025-11-09T23:19:32.2712162Z          // Future: Integrate with iroh-gossip-discovery when available
2025-11-09T23:19:32.2712534Z          info!("Iroh peer discovery: relying on DERP servers and incoming connections");
2025-11-09T23:19:32.2712859Z          Ok(0) // Return 0 for now - discovery happens through Iroh's native mechanisms
2025-11-09T23:19:32.2713310Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:593:
2025-11-09T23:19:32.2713499Z      /// Connect to Iroh peers from address database
2025-11-09T23:19:32.2713652Z      #[cfg(feature = "iroh")]
2025-11-09T23:19:32.2714073Z      pub async fn connect_iroh_peers_from_database(&self, target_count: usize) -> Result<usize> {
2025-11-09T23:19:32.2714495Z -        use crate::network::transport::TransportAddr;
2025-11-09T23:19:32.2714690Z          use crate::network::peer::Peer;
2025-11-09T23:19:32.2714804Z -        
2025-11-09T23:19:32.2715008Z +        use crate::network::transport::TransportAddr;
2025-11-09T23:19:32.2715141Z +
2025-11-09T23:19:32.2715292Z          // Count current Iroh peers
2025-11-09T23:19:32.2715438Z          let current_iroh_count = {
2025-11-09T23:19:32.2715859Z              let pm = self.peer_manager.lock().unwrap();
2025-11-09T23:19:32.2716315Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:604:
2025-11-09T23:19:32.2716566Z                  .filter(|addr| matches!(addr, TransportAddr::Iroh(_)))
2025-11-09T23:19:32.2716699Z                  .count()
2025-11-09T23:19:32.2716827Z          };
2025-11-09T23:19:32.2716945Z -        
2025-11-09T23:19:32.2717057Z +
2025-11-09T23:19:32.2717225Z          if current_iroh_count >= target_count {
2025-11-09T23:19:32.2717366Z              return Ok(0);
2025-11-09T23:19:32.2717477Z          }
2025-11-09T23:19:32.2717907Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:611:
2025-11-09T23:19:32.2718020Z -        
2025-11-09T23:19:32.2718124Z +
2025-11-09T23:19:32.2718314Z          let needed = target_count - current_iroh_count;
2025-11-09T23:19:32.2718718Z -        info!("Need {} more Iroh peers (current: {}, target: {})", needed, current_iroh_count, target_count);
2025-11-09T23:19:32.2718842Z -        
2025-11-09T23:19:32.2718952Z +        info!(
2025-11-09T23:19:32.2719147Z +            "Need {} more Iroh peers (current: {}, target: {})",
2025-11-09T23:19:32.2719322Z +            needed, current_iroh_count, target_count
2025-11-09T23:19:32.2719430Z +        );
2025-11-09T23:19:32.2719533Z +
2025-11-09T23:19:32.2719693Z          // Get fresh Iroh NodeIds from database
2025-11-09T23:19:32.2719807Z          let node_ids = {
2025-11-09T23:19:32.2719987Z              let db = self.address_database.lock().unwrap();
2025-11-09T23:19:32.2720416Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:618:
2025-11-09T23:19:32.2720705Z              db.get_fresh_iroh_addresses(needed * 2) // Get 2x needed for retries
2025-11-09T23:19:32.2720817Z          };
2025-11-09T23:19:32.2721146Z -        
2025-11-09T23:19:32.2721266Z +
2025-11-09T23:19:32.2721413Z          if node_ids.is_empty() {
2025-11-09T23:19:32.2721639Z              warn!("No fresh Iroh addresses available in database");
2025-11-09T23:19:32.2721769Z              return Ok(0);
2025-11-09T23:19:32.2722199Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:624:
2025-11-09T23:19:32.2722310Z          }
2025-11-09T23:19:32.2722418Z -        
2025-11-09T23:19:32.2722539Z +
2025-11-09T23:19:32.2722683Z          // Get Iroh transport
2025-11-09T23:19:32.2722889Z          let iroh_transport = match &self.iroh_transport {
2025-11-09T23:19:32.2723053Z              Some(transport) => transport,
2025-11-09T23:19:32.2723500Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:631:
2025-11-09T23:19:32.2723635Z                  return Ok(0);
2025-11-09T23:19:32.2723752Z              }
2025-11-09T23:19:32.2723876Z          };
2025-11-09T23:19:32.2724004Z -        
2025-11-09T23:19:32.2724117Z +
2025-11-09T23:19:32.2724463Z          // Try to connect to Iroh peers
2025-11-09T23:19:32.2724637Z          let mut connected = 0;
2025-11-09T23:19:32.2724859Z          for node_id in node_ids.into_iter().take(needed * 2) {
2025-11-09T23:19:32.2725296Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:638:
2025-11-09T23:19:32.2725487Z              let node_id_bytes = node_id.as_bytes().to_vec();
2025-11-09T23:19:32.2725788Z              let transport_addr = TransportAddr::Iroh(node_id_bytes.clone());
2025-11-09T23:19:32.2725906Z -            
2025-11-09T23:19:32.2726027Z +
2025-11-09T23:19:32.2726200Z              // Connect directly using Iroh transport
2025-11-09T23:19:32.2726473Z              match iroh_transport.connect(transport_addr.clone()).await {
2025-11-09T23:19:32.2726599Z                  Ok(conn) => {
2025-11-09T23:19:32.2727019Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:650:
2025-11-09T23:19:32.2727185Z                          transport_addr.clone(),
2025-11-09T23:19:32.2727337Z                          self.peer_tx.clone(),
2025-11-09T23:19:32.2727702Z                      );
2025-11-09T23:19:32.2727822Z -                    
2025-11-09T23:19:32.2727939Z +
2025-11-09T23:19:32.2728088Z                      // Add peer to manager
2025-11-09T23:19:32.2728206Z                      {
2025-11-09T23:19:32.2728402Z                          let mut pm = self.peer_manager.lock().unwrap();
2025-11-09T23:19:32.2728822Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:659:
2025-11-09T23:19:32.2728971Z                              continue;
2025-11-09T23:19:32.2729096Z                          }
2025-11-09T23:19:32.2729216Z                      }
2025-11-09T23:19:32.2729355Z -                    
2025-11-09T23:19:32.2729538Z +
2025-11-09T23:19:32.2729715Z                      // Store mapping for Iroh (if needed)
2025-11-09T23:19:32.2729839Z                      {
2025-11-09T23:19:32.2730175Z                          let mut socket_to_transport = self.socket_to_transport.lock().unwrap();
2025-11-09T23:19:32.2730626Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:666:
2025-11-09T23:19:32.2730976Z                          socket_to_transport.insert(placeholder_socket, transport_addr.clone());
2025-11-09T23:19:32.2731098Z                      }
2025-11-09T23:19:32.2731218Z -                    
2025-11-09T23:19:32.2731328Z +
2025-11-09T23:19:32.2731589Z                      info!("Successfully connected to Iroh peer: {}", node_id);
2025-11-09T23:19:32.2731733Z                      connected += 1;
2025-11-09T23:19:32.2731882Z                      if connected >= needed {
2025-11-09T23:19:32.2732323Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:677:
2025-11-09T23:19:32.2732446Z                  }
2025-11-09T23:19:32.2732557Z              }
2025-11-09T23:19:32.2732672Z          }
2025-11-09T23:19:32.2733039Z -        
2025-11-09T23:19:32.2733363Z -        info!("Connected to {} new Iroh peers from address database", connected);
2025-11-09T23:19:32.2733484Z +
2025-11-09T23:19:32.2733610Z +        info!(
2025-11-09T23:19:32.2733849Z +            "Connected to {} new Iroh peers from address database",
2025-11-09T23:19:32.2733968Z +            connected
2025-11-09T23:19:32.2734077Z +        );
2025-11-09T23:19:32.2734203Z          Ok(connected)
2025-11-09T23:19:32.2734485Z      }
2025-11-09T23:19:32.2734595Z  
2025-11-09T23:19:32.2735035Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:685:
2025-11-09T23:19:32.2735302Z      /// Connect to peers from address database when below target count
2025-11-09T23:19:32.2735409Z -    /// 
2025-11-09T23:19:32.2735525Z +    ///
2025-11-09T23:19:32.2735853Z      /// Works with both SocketAddr-based addresses (TCP/Quinn) and Iroh NodeIds.
2025-11-09T23:19:32.2736249Z      pub async fn connect_peers_from_database(&self, target_count: usize) -> Result<usize> {
2025-11-09T23:19:32.2736431Z          let current_count = self.peer_count();
2025-11-09T23:19:32.2736887Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:692:
2025-11-09T23:19:32.2737646Z          }
2025-11-09T23:19:32.2737908Z  
2025-11-09T23:19:32.2738180Z          let needed = target_count - current_count;
2025-11-09T23:19:32.2755829Z -        info!("Need {} more peers (current: {}, target: {})", needed, current_count, target_count);
2025-11-09T23:19:32.2756015Z +        info!(
2025-11-09T23:19:32.2756253Z +            "Need {} more peers (current: {}, target: {})",
2025-11-09T23:19:32.2756431Z +            needed, current_count, target_count
2025-11-09T23:19:32.2756547Z +        );
2025-11-09T23:19:32.2756674Z  
2025-11-09T23:19:32.2756845Z          // Get fresh addresses from database
2025-11-09T23:19:32.2757079Z          let ban_list = self.ban_list.lock().unwrap().clone();
2025-11-09T23:19:32.2757555Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:715:
2025-11-09T23:19:32.2757762Z          // Convert addresses to SocketAddrs first
2025-11-09T23:19:32.2758177Z          let sockets: Vec<SocketAddr> = {
2025-11-09T23:19:32.2758379Z              let db = self.address_database.lock().unwrap();
2025-11-09T23:19:32.2758536Z -            addresses.iter()
2025-11-09T23:19:32.2758670Z +            addresses
2025-11-09T23:19:32.2761072Z +                .iter()
2025-11-09T23:19:32.2761257Z                  .take(needed * 2)
2025-11-09T23:19:32.2761465Z                  .map(|addr| db.network_addr_to_socket(addr))
2025-11-09T23:19:32.2761598Z                  .collect()
2025-11-09T23:19:32.2762074Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:724:
2025-11-09T23:19:32.2762242Z          // Try to connect to addresses
2025-11-09T23:19:32.2762387Z          let mut connected = 0;
2025-11-09T23:19:32.2762532Z          for socket in sockets {
2025-11-09T23:19:32.2762670Z -
2025-11-09T23:19:32.2762890Z              if let Err(e) = self.connect_to_peer(socket).await {
2025-11-09T23:19:32.2763119Z                  debug!("Failed to connect to {}: {}", socket, e);
2025-11-09T23:19:32.2763295Z                  // Continue trying other addresses
2025-11-09T23:19:32.2763771Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:737:
2025-11-09T23:19:32.2763891Z          }
2025-11-09T23:19:32.2764006Z  
2025-11-09T23:19:32.2764546Z          info!("Connected to {} new peers from address database", connected);
2025-11-09T23:19:32.2764676Z -        
2025-11-09T23:19:32.2764791Z +
2025-11-09T23:19:32.2765002Z          // Also try to connect Iroh peers if Iroh is enabled
2025-11-09T23:19:32.2765157Z          #[cfg(feature = "iroh")]
2025-11-09T23:19:32.2765358Z          if self.transport_preference.allows_iroh() {
2025-11-09T23:19:32.2765815Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:744:
2025-11-09T23:19:32.2766479Z              let iroh_connected = self.connect_iroh_peers_from_database(target_count).await?;
2025-11-09T23:19:32.2766652Z              connected += iroh_connected;
2025-11-09T23:19:32.2766768Z          }
2025-11-09T23:19:32.2766891Z -        
2025-11-09T23:19:32.2767003Z +
2025-11-09T23:19:32.2767131Z          Ok(connected)
2025-11-09T23:19:32.2767249Z      }
2025-11-09T23:19:32.2767373Z  
2025-11-09T23:19:32.2768395Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:751:
2025-11-09T23:19:32.2768603Z      /// Initialize peer connections after startup
2025-11-09T23:19:32.2768724Z -    /// 
2025-11-09T23:19:32.2768832Z +    ///
2025-11-09T23:19:32.2769033Z      /// This is automatically called by `start()` to:
2025-11-09T23:19:32.2769302Z      /// 1. Discover peers from DNS seeds (for TCP/Quinn transports)
2025-11-09T23:19:32.2769501Z      /// 2. Connect to persistent peers from config
2025-11-09T23:19:32.2769953Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:756:
2025-11-09T23:19:32.2770320Z      /// 3. Discover Iroh peers (if Iroh is enabled) - uses Iroh's DERP servers and gossip
2025-11-09T23:19:32.2770601Z      /// 4. Connect to peers from address database to reach target count
2025-11-09T23:19:32.2770710Z -    /// 
2025-11-09T23:19:32.2770818Z +    ///
2025-11-09T23:19:32.2771213Z      /// Note: The address database now supports both SocketAddr-based addresses (TCP/Quinn)
2025-11-09T23:19:32.2771432Z      /// and Iroh NodeIds. Iroh peers are discovered through:
2025-11-09T23:19:32.2771634Z      /// - DERP servers (handled by Iroh's MagicEndpoint)
2025-11-09T23:19:32.2772074Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:770:
2025-11-09T23:19:32.2772230Z          target_peer_count: usize,
2025-11-09T23:19:32.2772354Z      ) -> Result<()> {
2025-11-09T23:19:32.2772635Z          // 1. Discover peers from DNS seeds (only for TCP/Quinn, not Iroh)
2025-11-09T23:19:32.2772966Z -        let should_discover_dns = self.transport_preference.allows_tcp() || 
2025-11-09T23:19:32.2773270Z +        let should_discover_dns = self.transport_preference.allows_tcp() || {
2025-11-09T23:19:32.2773628Z +            #[cfg(feature = "quinn")]
2025-11-09T23:19:32.2773747Z              {
2025-11-09T23:19:32.2773891Z -                #[cfg(feature = "quinn")]
2025-11-09T23:19:32.2774001Z -                {
2025-11-09T23:19:32.2774188Z -                    self.transport_preference.allows_quinn()
2025-11-09T23:19:32.2774305Z -                }
2025-11-09T23:19:32.2774625Z -                #[cfg(not(feature = "quinn"))]
2025-11-09T23:19:32.2774734Z -                {
2025-11-09T23:19:32.2774867Z -                    false
2025-11-09T23:19:32.2774978Z -                }
2025-11-09T23:19:32.2775097Z -            };
2025-11-09T23:19:32.2775293Z +                self.transport_preference.allows_quinn()
2025-11-09T23:19:32.2775420Z +            }
2025-11-09T23:19:32.2775574Z +            #[cfg(not(feature = "quinn"))]
2025-11-09T23:19:32.2775699Z +            {
2025-11-09T23:19:32.2775827Z +                false
2025-11-09T23:19:32.2775953Z +            }
2025-11-09T23:19:32.2776067Z +        };
2025-11-09T23:19:32.2776210Z          if should_discover_dns {
2025-11-09T23:19:32.2776497Z              if let Err(e) = self.discover_peers_from_dns(network, port).await {
2025-11-09T23:19:32.2776683Z                  warn!("DNS seed discovery failed: {}", e);
2025-11-09T23:19:32.2777143Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:807:
2025-11-09T23:19:32.2777433Z          // 4. Connect to peers from address database to reach target count
2025-11-09T23:19:32.2777644Z          // Wait a bit for persistent peers to connect first
2025-11-09T23:19:32.2777918Z          tokio::time::sleep(tokio::time::Duration::from_secs(2)).await;
2025-11-09T23:19:32.2778042Z -        
2025-11-09T23:19:32.2778158Z +
2025-11-09T23:19:32.2778482Z          if let Err(e) = self.connect_peers_from_database(target_peer_count).await {
2025-11-09T23:19:32.2778938Z              warn!("Failed to connect peers from database: {}", e);
2025-11-09T23:19:32.2779076Z          }
2025-11-09T23:19:32.2779533Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:821:
2025-11-09T23:19:32.2779804Z              "Starting network manager with transport preference: {:?}",
2025-11-09T23:19:32.2779970Z              self.transport_preference
2025-11-09T23:19:32.2780086Z          );
2025-11-09T23:19:32.2780203Z -        
2025-11-09T23:19:32.2780315Z +
2025-11-09T23:19:32.2780465Z          // Start listening first
2025-11-09T23:19:32.2780576Z  
2025-11-09T23:19:32.2780746Z          // Initialize Quinn transport if enabled
2025-11-09T23:19:32.2781195Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:886:
2025-11-09T23:19:32.2781349Z                              let ip = socket_addr.ip();
2025-11-09T23:19:32.2781544Z                              if !dos_protection.check_connection(ip).await {
2025-11-09T23:19:32.2781914Z                                  warn!("Connection rate limit exceeded for IP {}, rejecting connection", ip);
2025-11-09T23:19:32.2782039Z -                                
2025-11-09T23:19:32.2782141Z +
2025-11-09T23:19:32.2782370Z                                  // Check if we should auto-ban
2025-11-09T23:19:32.2782591Z                                  if dos_protection.should_auto_ban(ip).await {
2025-11-09T23:19:32.2782923Z                                      warn!("Auto-banning IP {} for repeated connection rate violations", ip);
2025-11-09T23:19:32.2783378Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:899:
2025-11-09T23:19:32.2783610Z                                      let mut ban_list_guard = ban_list.lock().unwrap();
2025-11-09T23:19:32.2783845Z                                      ban_list_guard.insert(socket_addr, unban_timestamp);
2025-11-09T23:19:32.2783973Z                                  }
2025-11-09T23:19:32.2784114Z -                                
2025-11-09T23:19:32.2784228Z +
2025-11-09T23:19:32.2784832Z                                  // Close connection immediately
2025-11-09T23:19:32.2784985Z                                  drop(conn);
2025-11-09T23:19:32.2785135Z                                  continue;
2025-11-09T23:19:32.2785601Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:910:
2025-11-09T23:19:32.2785814Z                                  let pm = peer_manager_clone.lock().unwrap();
2025-11-09T23:19:32.2785984Z                                  pm.peer_count()
2025-11-09T23:19:32.2786113Z                              };
2025-11-09T23:19:32.2786477Z -                            if !dos_protection.check_active_connections(current_connections).await {
2025-11-09T23:19:32.2786651Z +                            if !dos_protection
2025-11-09T23:19:32.2786881Z +                                .check_active_connections(current_connections)
2025-11-09T23:19:32.2787029Z +                                .await
2025-11-09T23:19:32.2787156Z +                            {
2025-11-09T23:19:32.2787599Z                                  warn!("Active connection limit exceeded, rejecting connection from {}", socket_addr);
2025-11-09T23:19:32.2787749Z                                  drop(conn);
2025-11-09T23:19:32.2787892Z                                  continue;
2025-11-09T23:19:32.2788369Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:918:
2025-11-09T23:19:32.2788487Z  
2025-11-09T23:19:32.2788666Z                              // Send connection notification
2025-11-09T23:19:32.2788946Z                              let transport_addr = TransportAddr::Tcp(socket_addr);
2025-11-09T23:19:32.2789355Z -                            let _ = peer_tx.send(NetworkMessage::PeerConnected(transport_addr.clone()));
2025-11-09T23:19:32.2789494Z +                            let _ =
2025-11-09T23:19:32.2789835Z +                                peer_tx.send(NetworkMessage::PeerConnected(transport_addr.clone()));
2025-11-09T23:19:32.2790207Z  
2025-11-09T23:19:32.2790520Z                              // Handle connection in background with graceful error handling
2025-11-09T23:19:32.2790709Z                              let peer_tx_clone = peer_tx.clone();
2025-11-09T23:19:32.2791180Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:927:
2025-11-09T23:19:32.2791368Z                                  // Create peer from transport connection
2025-11-09T23:19:32.2791560Z                                  use crate::network::peer::Peer;
2025-11-09T23:19:32.2791783Z                                  use crate::network::transport::TransportAddr;
2025-11-09T23:19:32.2791910Z -                                
2025-11-09T23:19:32.2792025Z +
2025-11-09T23:19:32.2792263Z                                  let peer = peer::Peer::from_transport_connection(
2025-11-09T23:19:32.2792404Z                                      conn,
2025-11-09T23:19:32.2792560Z                                      socket_addr,
2025-11-09T23:19:32.2793030Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:934:
2025-11-09T23:19:32.2793236Z                                      TransportAddr::Tcp(socket_addr),
2025-11-09T23:19:32.2793405Z                                      peer_tx_clone.clone(),
2025-11-09T23:19:32.2793535Z                                  );
2025-11-09T23:19:32.2793671Z -                                
2025-11-09T23:19:32.2793786Z +
2025-11-09T23:19:32.2794020Z                                  // Add peer to manager (with graceful error handling)
2025-11-09T23:19:32.2794215Z                                  match peer_manager_for_peer.lock() {
2025-11-09T23:19:32.2794550Z                                      Ok(mut pm) => {
2025-11-09T23:19:32.2795013Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:941:
2025-11-09T23:19:32.2795290Z                                          if let Err(e) = pm.add_peer(transport_addr.clone(), peer) {
2025-11-09T23:19:32.2795539Z                                              warn!("Failed to add peer {}: {}", socket_addr, e);
2025-11-09T23:19:32.2796202Z -                                            let _ = peer_tx_clone.send(NetworkMessage::PeerDisconnected(transport_addr.clone()));
2025-11-09T23:19:32.2796382Z +                                            let _ = peer_tx_clone.send(
2025-11-09T23:19:32.2796599Z +                                                NetworkMessage::PeerDisconnected(
2025-11-09T23:19:32.2796779Z +                                                    transport_addr.clone(),
2025-11-09T23:19:32.2796923Z +                                                ),
2025-11-09T23:19:32.2797070Z +                                            );
2025-11-09T23:19:32.2797218Z                                              return;
2025-11-09T23:19:32.2797350Z                                          }
2025-11-09T23:19:32.2797770Z -                                        info!("Successfully added peer {} (transport: {:?})", socket_addr, transport_addr);
2025-11-09T23:19:32.2797922Z +                                        info!(
2025-11-09T23:19:32.2798149Z +                                            "Successfully added peer {} (transport: {:?})",
2025-11-09T23:19:32.2798325Z +                                            socket_addr, transport_addr
2025-11-09T23:19:32.2798473Z +                                        );
2025-11-09T23:19:32.2798604Z                                      }
2025-11-09T23:19:32.2798748Z                                      Err(e) => {
2025-11-09T23:19:32.2799043Z -                                        warn!("Failed to lock peer manager for {}: {}", socket_addr, e);
2025-11-09T23:19:32.2799465Z -                                        let _ = peer_tx_clone.send(NetworkMessage::PeerDisconnected(transport_addr.clone()));
2025-11-09T23:19:32.2799603Z +                                        warn!(
2025-11-09T23:19:32.2800040Z +                                            "Failed to lock peer manager for {}: {}",
2025-11-09T23:19:32.2800212Z +                                            socket_addr, e
2025-11-09T23:19:32.2800347Z +                                        );
2025-11-09T23:19:32.2800898Z +                                        let _ =
2025-11-09T23:19:32.2801361Z +                                            peer_tx_clone.send(NetworkMessage::PeerDisconnected(
2025-11-09T23:19:32.2801544Z +                                                transport_addr.clone(),
2025-11-09T23:19:32.2801680Z +                                            ));
2025-11-09T23:19:32.2801828Z                                          return;
2025-11-09T23:19:32.2801958Z                                      }
2025-11-09T23:19:32.2802085Z                                  }
2025-11-09T23:19:32.2802549Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:954:
2025-11-09T23:19:32.2802696Z -                                
2025-11-09T23:19:32.2802810Z +
2025-11-09T23:19:32.2803235Z                                  // Connection will be cleaned up automatically when read/write tasks exit
2025-11-09T23:19:32.2803627Z                                  // Peer removal happens in process_messages when PeerDisconnected is received
2025-11-09T23:19:32.2803753Z                              });
2025-11-09T23:19:32.2804193Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:974:
2025-11-09T23:19:32.2804590Z                      let peer_manager = Arc::clone(&self.peer_manager);
2025-11-09T23:19:32.2804839Z                      let dos_protection = Arc::clone(&self.dos_protection);
2025-11-09T23:19:32.2805032Z                      let ban_list = Arc::clone(&self.ban_list);
2025-11-09T23:19:32.2805165Z -                    
2025-11-09T23:19:32.2805280Z +
2025-11-09T23:19:32.2805449Z                      tokio::spawn(async move {
2025-11-09T23:19:32.2805590Z                          loop {
2025-11-09T23:19:32.2805781Z                              match quinn_listener.accept().await {
2025-11-09T23:19:32.2806464Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:993:
2025-11-09T23:19:32.2806626Z                                      let ip = socket_addr.ip();
2025-11-09T23:19:32.2808660Z                                      if !dos_protection.check_connection(ip).await {
2025-11-09T23:19:32.2809076Z                                          warn!("Connection rate limit exceeded for IP {}, rejecting Quinn connection", ip);
2025-11-09T23:19:32.2809208Z -                                        
2025-11-09T23:19:32.2809329Z +
2025-11-09T23:19:32.2809534Z                                          if dos_protection.should_auto_ban(ip).await {
2025-11-09T23:19:32.2809865Z                                              warn!("Auto-banning IP {} for repeated connection rate violations", ip);
2025-11-09T23:19:32.2810121Z                                              let unban_timestamp = std::time::SystemTime::now()
2025-11-09T23:19:32.2811242Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1013:
2025-11-09T23:19:32.2811452Z                                          let pm = peer_manager.lock().unwrap();
2025-11-09T23:19:32.2811632Z                                          pm.peer_count()
2025-11-09T23:19:32.2811763Z                                      };
2025-11-09T23:19:32.2812118Z -                                    if !dos_protection.check_active_connections(current_connections).await {
2025-11-09T23:19:32.2812289Z +                                    if !dos_protection
2025-11-09T23:19:32.2812512Z +                                        .check_active_connections(current_connections)
2025-11-09T23:19:32.2812656Z +                                        .await
2025-11-09T23:19:32.2812786Z +                                    {
2025-11-09T23:19:32.2813253Z                                          warn!("Active connection limit exceeded, rejecting Quinn connection from {}", socket_addr);
2025-11-09T23:19:32.2813634Z                                          drop(conn);
2025-11-09T23:19:32.2813789Z                                          continue;
2025-11-09T23:19:32.2814253Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1021:
2025-11-09T23:19:32.2814530Z  
2025-11-09T23:19:32.2814718Z                                      // Send connection notification
2025-11-09T23:19:32.2815031Z                                      let quinn_transport_addr = TransportAddr::Quinn(socket_addr);
2025-11-09T23:19:32.2815429Z -                                    let _ = peer_tx.send(NetworkMessage::PeerConnected(quinn_transport_addr.clone()));
2025-11-09T23:19:32.2815662Z +                                    let _ = peer_tx.send(NetworkMessage::PeerConnected(
2025-11-09T23:19:32.2815850Z +                                        quinn_transport_addr.clone(),
2025-11-09T23:19:32.2815994Z +                                    ));
2025-11-09T23:19:32.2816109Z  
2025-11-09T23:19:32.2816400Z                                      // Handle connection in background with graceful error handling
2025-11-09T23:19:32.2816603Z                                      let peer_tx_clone = peer_tx.clone();
2025-11-09T23:19:32.2817052Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1029:
2025-11-09T23:19:32.2817230Z                                      tokio::spawn(async move {
2025-11-09T23:19:32.2817423Z                                          use crate::network::peer::Peer;
2025-11-09T23:19:32.2817647Z                                          use crate::network::transport::TransportAddr;
2025-11-09T23:19:32.2817784Z -                                        
2025-11-09T23:19:32.2817905Z +
2025-11-09T23:19:32.2818147Z                                          let quinn_addr = TransportAddr::Quinn(socket_addr);
2025-11-09T23:19:32.2818380Z                                          let peer = peer::Peer::from_transport_connection(
2025-11-09T23:19:32.2818542Z                                              conn,
2025-11-09T23:19:32.2819199Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1037:
2025-11-09T23:19:32.2819355Z                                              quinn_addr,
2025-11-09T23:19:32.2819527Z                                              peer_tx_clone.clone(),
2025-11-09T23:19:32.2819667Z                                          );
2025-11-09T23:19:32.2819796Z -                                        
2025-11-09T23:19:32.2819910Z +
2025-11-09T23:19:32.2820150Z                                          // Add peer to manager (with graceful error handling)
2025-11-09T23:19:32.2820332Z                                          match peer_manager_clone.lock() {
2025-11-09T23:19:32.2822152Z                                              Ok(mut pm) => {
2025-11-09T23:19:32.2822604Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1044:
2025-11-09T23:19:32.2822851Z -                                                if let Err(e) = pm.add_peer(quinn_addr.clone(), peer) {
2025-11-09T23:19:32.2823115Z -                                                    warn!("Failed to add Quinn peer {}: {}", socket_addr, e);
2025-11-09T23:19:32.2823522Z -                                                    let _ = peer_tx_clone.send(NetworkMessage::PeerDisconnected(quinn_addr.clone()));
2025-11-09T23:19:32.2823682Z +                                                if let Err(e) =
2025-11-09T23:19:32.2823878Z +                                                    pm.add_peer(quinn_addr.clone(), peer)
2025-11-09T23:19:32.2824014Z +                                                {
2025-11-09T23:19:32.2824172Z +                                                    warn!(
2025-11-09T23:19:32.2824499Z +                                                        "Failed to add Quinn peer {}: {}",
2025-11-09T23:19:32.2824655Z +                                                        socket_addr, e
2025-11-09T23:19:32.2824974Z +                                                    );
2025-11-09T23:19:32.2825141Z +                                                    let _ = peer_tx_clone.send(
2025-11-09T23:19:32.2825324Z +                                                        NetworkMessage::PeerDisconnected(
2025-11-09T23:19:32.2825481Z +                                                            quinn_addr.clone(),
2025-11-09T23:19:32.2825605Z +                                                        ),
2025-11-09T23:19:32.2825728Z +                                                    );
2025-11-09T23:19:32.2825879Z                                                      return;
2025-11-09T23:19:32.2826011Z                                                  }
2025-11-09T23:19:32.2826262Z -                                                info!("Successfully added Quinn peer {}", socket_addr);
2025-11-09T23:19:32.2826401Z +                                                info!(
2025-11-09T23:19:32.2826606Z +                                                    "Successfully added Quinn peer {}",
2025-11-09T23:19:32.2826774Z +                                                    socket_addr
2025-11-09T23:19:32.2826935Z +                                                );
2025-11-09T23:19:32.2827079Z                                              }
2025-11-09T23:19:32.2827230Z                                              Err(e) => {
2025-11-09T23:19:32.2827577Z                                                  warn!("Failed to lock peer manager for Quinn peer {}: {}", socket_addr, e);
2025-11-09T23:19:32.2828037Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1053:
2025-11-09T23:19:32.2828433Z -                                                let _ = peer_tx_clone.send(NetworkMessage::PeerDisconnected(quinn_addr.clone()));
2025-11-09T23:19:32.2828614Z +                                                let _ = peer_tx_clone.send(
2025-11-09T23:19:32.2828836Z +                                                    NetworkMessage::PeerDisconnected(
2025-11-09T23:19:32.2829268Z +                                                        quinn_addr.clone(),
2025-11-09T23:19:32.2829412Z +                                                    ),
2025-11-09T23:19:32.2829560Z +                                                );
2025-11-09T23:19:32.2829725Z                                                  return;
2025-11-09T23:19:32.2829866Z                                              }
2025-11-09T23:19:32.2830000Z                                          }
2025-11-09T23:19:32.2830464Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1065:
2025-11-09T23:19:32.2830597Z                      });
2025-11-09T23:19:32.2830720Z                  }
2025-11-09T23:19:32.2831264Z                  Err(e) => {
2025-11-09T23:19:32.2831578Z -                    warn!("Failed to start Quinn listener (graceful degradation): {}", e);
2025-11-09T23:19:32.2831707Z +                    warn!(
2025-11-09T23:19:32.2831957Z +                        "Failed to start Quinn listener (graceful degradation): {}",
2025-11-09T23:19:32.2832085Z +                        e
2025-11-09T23:19:32.2832193Z +                    );
2025-11-09T23:19:32.2832454Z                      // Continue with other transports - don't fail entire startup
2025-11-09T23:19:32.2832561Z                  }
2025-11-09T23:19:32.2832675Z              }
2025-11-09T23:19:32.2833109Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1107:
2025-11-09T23:19:32.2833289Z                                          let pm = peer_manager.lock().unwrap();
2025-11-09T23:19:32.2833441Z                                          pm.peer_count()
2025-11-09T23:19:32.2833560Z                                      };
2025-11-09T23:19:32.2833894Z -                                    if !dos_protection.check_active_connections(current_connections).await {
2025-11-09T23:19:32.2834204Z +                                    if !dos_protection
2025-11-09T23:19:32.2834592Z +                                        .check_active_connections(current_connections)
2025-11-09T23:19:32.2834737Z +                                        .await
2025-11-09T23:19:32.2834859Z +                                    {
2025-11-09T23:19:32.2835180Z                                          warn!("Active connection limit exceeded, rejecting Iroh connection");
2025-11-09T23:19:32.2835325Z                                          drop(conn);
2025-11-09T23:19:32.2835457Z                                          continue;
2025-11-09T23:19:32.2835894Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1114:
2025-11-09T23:19:32.2836013Z                                      }
2025-11-09T23:19:32.2836117Z  
2025-11-09T23:19:32.2836382Z                                      // Send connection notification using TransportAddr directly
2025-11-09T23:19:32.2836724Z -                                    let _ = peer_tx.send(NetworkMessage::PeerConnected(iroh_addr.clone()));
2025-11-09T23:19:32.2836882Z +                                    let _ = peer_tx
2025-11-09T23:19:32.2837146Z +                                        .send(NetworkMessage::PeerConnected(iroh_addr.clone()));
2025-11-09T23:19:32.2837260Z  
2025-11-09T23:19:32.2837534Z                                      // Handle connection in background with graceful error handling
2025-11-09T23:19:32.2837717Z                                      let peer_tx_clone = peer_tx.clone();
2025-11-09T23:19:32.2838158Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1121:
2025-11-09T23:19:32.2838381Z                                      let peer_manager_clone = Arc::clone(&peer_manager);
2025-11-09T23:19:32.2838557Z                                      let iroh_addr_clone = iroh_addr.clone();
2025-11-09T23:19:32.2840631Z -                                    let socket_to_transport_clone = Arc::clone(&socket_to_transport);
2025-11-09T23:19:32.2840824Z +                                    let socket_to_transport_clone =
2025-11-09T23:19:32.2841222Z +                                        Arc::clone(&socket_to_transport);
2025-11-09T23:19:32.2841513Z                                      let address_database_clone = Arc::clone(&address_database);
2025-11-09T23:19:32.2841678Z                                      tokio::spawn(async move {
2025-11-09T23:19:32.2841852Z                                          use crate::network::peer::Peer;
2025-11-09T23:19:32.2842295Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1127:
2025-11-09T23:19:32.2842432Z -                                        
2025-11-09T23:19:32.2842545Z +
2025-11-09T23:19:32.2842842Z                                          // For Iroh, we need a SocketAddr for Peer::from_transport_connection
2025-11-09T23:19:32.2843118Z                                          // Generate a unique placeholder based on key hash for lookups
2025-11-09T23:19:32.2843506Z -                                        let placeholder_socket = if let TransportAddr::Iroh(ref key) = iroh_addr_clone {
2025-11-09T23:19:32.2843887Z -                                            // Use first 4 bytes of key for IP, last 2 bytes for port to create unique placeholder
2025-11-09T23:19:32.2844085Z -                                            let ip_bytes = if key.len() >= 4 {
2025-11-09T23:19:32.2844260Z -                                                [key[0], key[1], key[2], key[3]]
2025-11-09T23:19:32.2844595Z +                                        let placeholder_socket =
2025-11-09T23:19:32.2844875Z +                                            if let TransportAddr::Iroh(ref key) = iroh_addr_clone {
2025-11-09T23:19:32.2845244Z +                                                // Use first 4 bytes of key for IP, last 2 bytes for port to create unique placeholder
2025-11-09T23:19:32.2845430Z +                                                let ip_bytes = if key.len() >= 4 {
2025-11-09T23:19:32.2846051Z +                                                    [key[0], key[1], key[2], key[3]]
2025-11-09T23:19:32.2846222Z +                                                } else {
2025-11-09T23:19:32.2846376Z +                                                    [0, 0, 0, 0]
2025-11-09T23:19:32.2846526Z +                                                };
2025-11-09T23:19:32.2846712Z +                                                let port = if key.len() >= 6 {
2025-11-09T23:19:32.2846895Z +                                                    u16::from_be_bytes([
2025-11-09T23:19:32.2847072Z +                                                        key[key.len() - 2],
2025-11-09T23:19:32.2847248Z +                                                        key[key.len() - 1],
2025-11-09T23:19:32.2847387Z +                                                    ])
2025-11-09T23:19:32.2847525Z +                                                } else {
2025-11-09T23:19:32.2847682Z +                                                    0
2025-11-09T23:19:32.2847811Z +                                                };
2025-11-09T23:19:32.2848035Z +                                                std::net::SocketAddr::from((ip_bytes, port))
2025-11-09T23:19:32.2848184Z                                              } else {
2025-11-09T23:19:32.2848336Z -                                                [0, 0, 0, 0]
2025-11-09T23:19:32.2848550Z +                                                std::net::SocketAddr::from(([0, 0, 0, 0], 0))
2025-11-09T23:19:32.2848693Z                                              };
2025-11-09T23:19:32.2848874Z -                                            let port = if key.len() >= 6 {
2025-11-09T23:19:32.2849112Z -                                                u16::from_be_bytes([key[key.len()-2], key[key.len()-1]])
2025-11-09T23:19:32.2851536Z -                                            } else {
2025-11-09T23:19:32.2851706Z -                                                0
2025-11-09T23:19:32.2851855Z -                                            };
2025-11-09T23:19:32.2852078Z -                                            std::net::SocketAddr::from((ip_bytes, port))
2025-11-09T23:19:32.2852461Z -                                        } else {
2025-11-09T23:19:32.2852675Z -                                            std::net::SocketAddr::from(([0, 0, 0, 0], 0))
2025-11-09T23:19:32.2852818Z -                                        };
2025-11-09T23:19:32.2852967Z -                                        
2025-11-09T23:19:32.2853083Z +
2025-11-09T23:19:32.2853353Z                                          let peer = peer::Peer::from_transport_connection(
2025-11-09T23:19:32.2853522Z                                              conn,
2025-11-09T23:19:32.2853704Z                                              placeholder_socket,
2025-11-09T23:19:32.2854162Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1150:
2025-11-09T23:19:32.2854522Z                                              iroh_addr_clone.clone(),
2025-11-09T23:19:32.2854711Z                                              peer_tx_clone.clone(),
2025-11-09T23:19:32.2854853Z                                          );
2025-11-09T23:19:32.2854988Z -                                        
2025-11-09T23:19:32.2855106Z +
2025-11-09T23:19:32.2855342Z                                          // Add peer to manager (with graceful error handling)
2025-11-09T23:19:32.2855529Z                                          match peer_manager_clone.lock() {
2025-11-09T23:19:32.2855686Z                                              Ok(mut pm) => {
2025-11-09T23:19:32.2856145Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1157:
2025-11-09T23:19:32.2856441Z -                                                if let Err(e) = pm.add_peer(iroh_addr_clone.clone(), peer) {
2025-11-09T23:19:32.2856600Z +                                                if let Err(e) =
2025-11-09T23:19:32.2857049Z +                                                    pm.add_peer(iroh_addr_clone.clone(), peer)
2025-11-09T23:19:32.2857199Z +                                                {
2025-11-09T23:19:32.2857396Z                                                      warn!("Failed to add Iroh peer: {}", e);
2025-11-09T23:19:32.2857830Z -                                                    let _ = peer_tx_clone.send(NetworkMessage::PeerDisconnected(iroh_addr_clone.clone()));
2025-11-09T23:19:32.2858012Z +                                                    let _ = peer_tx_clone.send(
2025-11-09T23:19:32.2858217Z +                                                        NetworkMessage::PeerDisconnected(
2025-11-09T23:19:32.2858407Z +                                                            iroh_addr_clone.clone(),
2025-11-09T23:19:32.2858557Z +                                                        ),
2025-11-09T23:19:32.2858699Z +                                                    );
2025-11-09T23:19:32.2858858Z                                                      return;
2025-11-09T23:19:32.2858987Z                                                  }
2025-11-09T23:19:32.2859347Z                                                  // Store mapping from placeholder SocketAddr to TransportAddr for Iroh lookups
2025-11-09T23:19:32.2859781Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1163:
2025-11-09T23:19:32.2860261Z -                                                socket_to_transport_clone.lock().unwrap().insert(placeholder_socket, iroh_addr_clone.clone());
2025-11-09T23:19:32.2860398Z -                                                
2025-11-09T23:19:32.2860625Z +                                                socket_to_transport_clone.lock().unwrap().insert(
2025-11-09T23:19:32.2862810Z +                                                    placeholder_socket,
2025-11-09T23:19:32.2862983Z +                                                    iroh_addr_clone.clone(),
2025-11-09T23:19:32.2863128Z +                                                );
2025-11-09T23:19:32.2863248Z +
2025-11-09T23:19:32.2863665Z                                                  // Store Iroh NodeId in address database
2025-11-09T23:19:32.2863978Z -                                                if let TransportAddr::Iroh(ref node_id_bytes) = iroh_addr_clone {
2025-11-09T23:19:32.2864214Z +                                                if let TransportAddr::Iroh(ref node_id_bytes) =
2025-11-09T23:19:32.2864549Z +                                                    iroh_addr_clone
2025-11-09T23:19:32.2864689Z +                                                {
2025-11-09T23:19:32.2864868Z                                                      if node_id_bytes.len() == 32 {
2025-11-09T23:19:32.2865066Z                                                          use iroh_net::NodeId;
2025-11-09T23:19:32.2865323Z -                                                        if let Ok(node_id) = NodeId::from_bytes(node_id_bytes) {
2025-11-09T23:19:32.2865598Z -                                                            let address_db_clone = address_database_clone.clone();
2025-11-09T23:19:32.2865789Z +                                                        if let Ok(node_id) =
2025-11-09T23:19:32.2865977Z +                                                            NodeId::from_bytes(node_id_bytes)
2025-11-09T23:19:32.2866112Z +                                                        {
2025-11-09T23:19:32.2866277Z +                                                            let address_db_clone =
2025-11-09T23:19:32.2866451Z +                                                                address_database_clone.clone();
2025-11-09T23:19:32.2866625Z                                                              tokio::spawn(async move {
2025-11-09T23:19:32.2866864Z -                                                                let mut db = address_db_clone.lock().unwrap();
2025-11-09T23:19:32.2867236Z -                                                                db.add_iroh_address(node_id, 0); // Services will be updated on version exchange
2025-11-09T23:19:32.2867654Z +                                                                let mut db = address_db_clone
2025-11-09T23:19:32.2867822Z +                                                                    .lock()
2025-11-09T23:19:32.2867987Z +                                                                    .unwrap();
2025-11-09T23:19:32.2868176Z +                                                                db.add_iroh_address(node_id, 0);
2025-11-09T23:19:32.2868397Z +                                                                // Services will be updated on version exchange
2025-11-09T23:19:32.2868547Z                                                              });
2025-11-09T23:19:32.2868685Z                                                          }
2025-11-09T23:19:32.2868826Z                                                      }
2025-11-09T23:19:32.2869288Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1177:
2025-11-09T23:19:32.2869436Z                                                  }
2025-11-09T23:19:32.2869576Z -                                                
2025-11-09T23:19:32.2869698Z +
2025-11-09T23:19:32.2870052Z                                                  info!("Successfully added Iroh peer (transport: {:?})", iroh_addr_clone);
2025-11-09T23:19:32.2870184Z                                              }
2025-11-09T23:19:32.2872401Z                                              Err(e) => {
2025-11-09T23:19:32.2872838Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1182:
2025-11-09T23:19:32.2873090Z -                                                warn!("Failed to lock peer manager for Iroh peer: {}", e);
2025-11-09T23:19:32.2873505Z -                                                let _ = peer_tx_clone.send(NetworkMessage::PeerDisconnected(iroh_addr_clone.clone()));
2025-11-09T23:19:32.2873652Z +                                                warn!(
2025-11-09T23:19:32.2874160Z +                                                    "Failed to lock peer manager for Iroh peer: {}",
2025-11-09T23:19:32.2874474Z +                                                    e
2025-11-09T23:19:32.2874623Z +                                                );
2025-11-09T23:19:32.2874796Z +                                                let _ = peer_tx_clone.send(
2025-11-09T23:19:32.2875001Z +                                                    NetworkMessage::PeerDisconnected(
2025-11-09T23:19:32.2875180Z +                                                        iroh_addr_clone.clone(),
2025-11-09T23:19:32.2875316Z +                                                    ),
2025-11-09T23:19:32.2875447Z +                                                );
2025-11-09T23:19:32.2875595Z                                                  return;
2025-11-09T23:19:32.2875731Z                                              }
2025-11-09T23:19:32.2875874Z                                          }
2025-11-09T23:19:32.2876342Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1195:
2025-11-09T23:19:32.2876472Z                      });
2025-11-09T23:19:32.2876594Z                  }
2025-11-09T23:19:32.2876725Z                  Err(e) => {
2025-11-09T23:19:32.2877037Z -                    warn!("Failed to start Iroh listener (graceful degradation): {}", e);
2025-11-09T23:19:32.2877163Z +                    warn!(
2025-11-09T23:19:32.2877406Z +                        "Failed to start Iroh listener (graceful degradation): {}",
2025-11-09T23:19:32.2877531Z +                        e
2025-11-09T23:19:32.2877644Z +                    );
2025-11-09T23:19:32.2877914Z                      // Continue with other transports - don't fail entire startup
2025-11-09T23:19:32.2878038Z                  }
2025-11-09T23:19:32.2878160Z              }
2025-11-09T23:19:32.2878857Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1203:
2025-11-09T23:19:32.2878979Z  
2025-11-09T23:19:32.2879166Z          // Start periodic ban cleanup task
2025-11-09T23:19:32.2879320Z          self.start_ban_cleanup_task();
2025-11-09T23:19:32.2879435Z -        
2025-11-09T23:19:32.2879547Z +
2025-11-09T23:19:32.2879723Z          // Start pending request cleanup task
2025-11-09T23:19:32.2879887Z          self.start_request_cleanup_task();
2025-11-09T23:19:32.2880003Z -        
2025-11-09T23:19:32.2880119Z +
2025-11-09T23:19:32.2880283Z          // Start DoS protection cleanup task
2025-11-09T23:19:32.2880463Z          self.start_dos_protection_cleanup_task();
2025-11-09T23:19:32.2880578Z -        
2025-11-09T23:19:32.2880696Z +
2025-11-09T23:19:32.2881038Z          // Note: Peer connection initialization (DNS seeds, persistent peers, etc.)
2025-11-09T23:19:32.2881389Z          // should be called separately via initialize_peer_connections() after start()
2025-11-09T23:19:32.2881751Z          // This allows the caller to provide config, network type, and target peer count
2025-11-09T23:19:32.2882200Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1216:
2025-11-09T23:19:32.2882312Z -        
2025-11-09T23:19:32.2882424Z +
2025-11-09T23:19:32.2882546Z          Ok(())
2025-11-09T23:19:32.2882659Z      }
2025-11-09T23:19:32.2882770Z -    
2025-11-09T23:19:32.2882886Z +
2025-11-09T23:19:32.2883171Z      /// Generate a new request ID for async request-response patterns
2025-11-09T23:19:32.2883355Z      pub fn generate_request_id(&self) -> u64 {
2025-11-09T23:19:32.2883605Z          let mut counter = self.request_id_counter.lock().unwrap();
2025-11-09T23:19:32.2884047Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1224:
2025-11-09T23:19:32.2884217Z          *counter = counter.wrapping_add(1);
2025-11-09T23:19:32.2884513Z          id
2025-11-09T23:19:32.2884639Z      }
2025-11-09T23:19:32.2884762Z -    
2025-11-09T23:19:32.2884872Z +
2025-11-09T23:19:32.2885146Z      /// Register a pending request and return the response receiver
2025-11-09T23:19:32.2885664Z      /// Returns (request_id, response_receiver)
2025-11-09T23:19:32.2886166Z -    pub fn register_request(&self, peer_addr: SocketAddr) -> (u64, tokio::sync::oneshot::Receiver<Vec<u8>>) {
2025-11-09T23:19:32.2886311Z +    pub fn register_request(
2025-11-09T23:19:32.2886443Z +        &self,
2025-11-09T23:19:32.2886586Z +        peer_addr: SocketAddr,
2025-11-09T23:19:32.2886799Z +    ) -> (u64, tokio::sync::oneshot::Receiver<Vec<u8>>) {
2025-11-09T23:19:32.2887023Z          self.register_request_with_priority(peer_addr, 0)
2025-11-09T23:19:32.2887140Z      }
2025-11-09T23:19:32.2887253Z -    
2025-11-09T23:19:32.2887363Z +
2025-11-09T23:19:32.2887718Z      /// Register a pending request with priority and return the response receiver
2025-11-09T23:19:32.2887896Z      /// Returns (request_id, response_receiver)
2025-11-09T23:19:32.2888093Z      /// Priority: 0 = normal, higher = more important
2025-11-09T23:19:32.2888598Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1237:
2025-11-09T23:19:32.2889262Z -    pub fn register_request_with_priority(&self, peer_addr: SocketAddr, priority: u8) -> (u64, tokio::sync::oneshot::Receiver<Vec<u8>>) {
2025-11-09T23:19:32.2889439Z +    pub fn register_request_with_priority(
2025-11-09T23:19:32.2889563Z +        &self,
2025-11-09T23:19:32.2889703Z +        peer_addr: SocketAddr,
2025-11-09T23:19:32.2889835Z +        priority: u8,
2025-11-09T23:19:32.2890032Z +    ) -> (u64, tokio::sync::oneshot::Receiver<Vec<u8>>) {
2025-11-09T23:19:32.2890216Z          let request_id = self.generate_request_id();
2025-11-09T23:19:32.2890397Z          let (tx, rx) = tokio::sync::oneshot::channel();
2025-11-09T23:19:32.2890503Z -        
2025-11-09T23:19:32.2890611Z +
2025-11-09T23:19:32.2890775Z          use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:19:32.2890941Z          let timestamp = SystemTime::now()
2025-11-09T23:19:32.2891307Z              .duration_since(UNIX_EPOCH)
2025-11-09T23:19:32.2891756Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1244:
2025-11-09T23:19:32.2891884Z              .unwrap()
2025-11-09T23:19:32.2892010Z              .as_secs();
2025-11-09T23:19:32.2892136Z -        
2025-11-09T23:19:32.2892246Z +
2025-11-09T23:19:32.2892418Z          let pending_req = PendingRequest {
2025-11-09T23:19:32.2892554Z              sender: tx,
2025-11-09T23:19:32.2892676Z              peer_addr,
2025-11-09T23:19:32.2893124Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1251:
2025-11-09T23:19:32.2893240Z              priority,
2025-11-09T23:19:32.2893372Z              retry_count: 0,
2025-11-09T23:19:32.2893483Z          };
2025-11-09T23:19:32.2893597Z -        
2025-11-09T23:19:32.2893943Z -        self.pending_requests.lock().unwrap().insert(request_id, pending_req);
2025-11-09T23:19:32.2894067Z +
2025-11-09T23:19:32.2894211Z +        self.pending_requests
2025-11-09T23:19:32.2894508Z +            .lock()
2025-11-09T23:19:32.2894656Z +            .unwrap()
2025-11-09T23:19:32.2894817Z +            .insert(request_id, pending_req);
2025-11-09T23:19:32.2894940Z          (request_id, rx)
2025-11-09T23:19:32.2895055Z      }
2025-11-09T23:19:32.2895164Z -    
2025-11-09T23:19:32.2895279Z +
2025-11-09T23:19:32.2895497Z      /// Complete a pending request by sending the response
2025-11-09T23:19:32.2895817Z      pub fn complete_request(&self, request_id: u64, response: Vec<u8>) -> bool {
2025-11-09T23:19:32.2896046Z          let mut pending = self.pending_requests.lock().unwrap();
2025-11-09T23:19:32.2896497Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1266:
2025-11-09T23:19:32.2896619Z              false
2025-11-09T23:19:32.2896734Z          }
2025-11-09T23:19:32.2896847Z      }
2025-11-09T23:19:32.2896959Z -    
2025-11-09T23:19:32.2897078Z +
2025-11-09T23:19:32.2897226Z      /// Cancel a pending request
2025-11-09T23:19:32.2897439Z      pub fn cancel_request(&self, request_id: u64) -> bool {
2025-11-09T23:19:32.2897886Z          let mut pending = self.pending_requests.lock().unwrap();
2025-11-09T23:19:32.2898337Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1273:
2025-11-09T23:19:32.2898508Z          pending.remove(&request_id).is_some()
2025-11-09T23:19:32.2898634Z      }
2025-11-09T23:19:32.2898753Z -    
2025-11-09T23:19:32.2898867Z +
2025-11-09T23:19:32.2899053Z      /// Get pending requests for a specific peer
2025-11-09T23:19:32.2899421Z      pub fn get_pending_requests_for_peer(&self, peer_addr: SocketAddr) -> Vec<u64> {
2025-11-09T23:19:32.2899648Z          let pending = self.pending_requests.lock().unwrap();
2025-11-09T23:19:32.2900094Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1279:
2025-11-09T23:19:32.2900241Z -        pending.iter()
2025-11-09T23:19:32.2900361Z +        pending
2025-11-09T23:19:32.2900490Z +            .iter()
2025-11-09T23:19:32.2900685Z              .filter(|(_, req)| req.peer_addr == peer_addr)
2025-11-09T23:19:32.2900841Z              .map(|(id, _)| *id)
2025-11-09T23:19:32.2900966Z              .collect()
2025-11-09T23:19:32.2901694Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1283:
2025-11-09T23:19:32.2901823Z      }
2025-11-09T23:19:32.2901937Z -    
2025-11-09T23:19:32.2902052Z +
2025-11-09T23:19:32.2904275Z      /// Clean up expired requests (older than max_age_seconds)
2025-11-09T23:19:32.2904774Z      pub fn cleanup_expired_requests(&self, max_age_seconds: u64) -> usize {
2025-11-09T23:19:32.2904968Z          use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:19:32.2905402Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1289:
2025-11-09T23:19:32.2905570Z              .duration_since(UNIX_EPOCH)
2025-11-09T23:19:32.2905702Z              .unwrap()
2025-11-09T23:19:32.2906066Z              .as_secs();
2025-11-09T23:19:32.2906193Z -        
2025-11-09T23:19:32.2906306Z +
2025-11-09T23:19:32.2906557Z          let mut pending = self.pending_requests.lock().unwrap();
2025-11-09T23:19:32.2906734Z -        let expired: Vec<u64> = pending.iter()
2025-11-09T23:19:32.2906895Z +        let expired: Vec<u64> = pending
2025-11-09T23:19:32.2907009Z +            .iter()
2025-11-09T23:19:32.2907307Z              .filter(|(_, req)| now.saturating_sub(req.timestamp) > max_age_seconds)
2025-11-09T23:19:32.2907455Z              .map(|(id, _)| *id)
2025-11-09T23:19:32.2907584Z              .collect();
2025-11-09T23:19:32.2908034Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1298:
2025-11-09T23:19:32.2908148Z -        
2025-11-09T23:19:32.2908265Z +
2025-11-09T23:19:32.2908402Z          for id in &expired {
2025-11-09T23:19:32.2908539Z              pending.remove(id);
2025-11-09T23:19:32.2908651Z          }
2025-11-09T23:19:32.2909077Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1302:
2025-11-09T23:19:32.2909209Z -        
2025-11-09T23:19:32.2909331Z +
2025-11-09T23:19:32.2909469Z          expired.len()
2025-11-09T23:19:32.2909581Z      }
2025-11-09T23:19:32.2909690Z -    
2025-11-09T23:19:32.2909809Z +
2025-11-09T23:19:32.2910068Z      /// Start periodic task to clean up expired pending requests
2025-11-09T23:19:32.2910240Z      fn start_request_cleanup_task(&self) {
2025-11-09T23:19:32.2910515Z          let pending_requests = Arc::clone(&self.pending_requests);
2025-11-09T23:19:32.2910979Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1309:
2025-11-09T23:19:32.2911097Z -        
2025-11-09T23:19:32.2911214Z +
2025-11-09T23:19:32.2911382Z          tokio::spawn(async move {
2025-11-09T23:19:32.2911725Z              let mut interval = tokio::time::interval(tokio::time::Duration::from_secs(60));
2025-11-09T23:19:32.2911841Z              loop {
2025-11-09T23:19:32.2912289Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1313:
2025-11-09T23:19:32.2914684Z                  interval.tick().await;
2025-11-09T23:19:32.2914802Z -                
2025-11-09T23:19:32.2914909Z +
2025-11-09T23:19:32.2915133Z                  // Clean up old pending requests (older than 5 minutes)
2025-11-09T23:19:32.2915314Z                  use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:19:32.2915469Z                  let now = SystemTime::now()
2025-11-09T23:19:32.2915920Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1319:
2025-11-09T23:19:32.2916052Z                      .unwrap()
2025-11-09T23:19:32.2916189Z                      .as_secs();
2025-11-09T23:19:32.2916360Z                  let timeout_seconds = 300; // 5 minutes
2025-11-09T23:19:32.2916471Z -                
2025-11-09T23:19:32.2916582Z +
2025-11-09T23:19:32.2916804Z                  let mut pending = pending_requests.lock().unwrap();
2025-11-09T23:19:32.2916988Z                  let initial_count = pending.len();
2025-11-09T23:19:32.2917141Z -                pending.retain(|_, req| {
2025-11-09T23:19:32.2917367Z -                    now.saturating_sub(req.timestamp) < timeout_seconds
2025-11-09T23:19:32.2917484Z -                });
2025-11-09T23:19:32.2917825Z +                pending.retain(|_, req| now.saturating_sub(req.timestamp) < timeout_seconds);
2025-11-09T23:19:32.2918014Z                  let removed = initial_count - pending.len();
2025-11-09T23:19:32.2918143Z                  if removed > 0 {
2025-11-09T23:19:32.2918550Z -                    debug!("Cleaned up {} stale pending requests (older than {}s)", removed, timeout_seconds);
2025-11-09T23:19:32.2918678Z +                    debug!(
2025-11-09T23:19:32.2918921Z +                        "Cleaned up {} stale pending requests (older than {}s)",
2025-11-09T23:19:32.2919092Z +                        removed, timeout_seconds
2025-11-09T23:19:32.2919212Z +                    );
2025-11-09T23:19:32.2919573Z                  }
2025-11-09T23:19:32.2919753Z                  if !pending.is_empty() {
2025-11-09T23:19:32.2919962Z                      debug!("Pending requests: {}", pending.len());
2025-11-09T23:19:32.2920404Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1335:
2025-11-09T23:19:32.2920515Z              }
2025-11-09T23:19:32.2920630Z          });
2025-11-09T23:19:32.2920739Z      }
2025-11-09T23:19:32.2920845Z -    
2025-11-09T23:19:32.2920955Z +
2025-11-09T23:19:32.2921728Z      /// Start periodic task to clean up DoS protection data
2025-11-09T23:19:32.2921935Z      fn start_dos_protection_cleanup_task(&self) {
2025-11-09T23:19:32.2922184Z          let dos_protection = Arc::clone(&self.dos_protection);
2025-11-09T23:19:32.2922652Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1342:
2025-11-09T23:19:32.2922843Z          let ban_list = Arc::clone(&self.ban_list);
2025-11-09T23:19:32.2922973Z -        
2025-11-09T23:19:32.2923088Z +
2025-11-09T23:19:32.2923243Z          tokio::spawn(async move {
2025-11-09T23:19:32.2923690Z              let mut interval = tokio::time::interval(tokio::time::Duration::from_secs(300)); // Every 5 minutes
2025-11-09T23:19:32.2923826Z              loop {
2025-11-09T23:19:32.2924467Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1347:
2025-11-09T23:19:32.2924637Z                  interval.tick().await;
2025-11-09T23:19:32.2924759Z -                
2025-11-09T23:19:32.2924877Z +
2025-11-09T23:19:32.2925076Z                  // Cleanup old connection rate limiter entries
2025-11-09T23:19:32.2925250Z                  dos_protection.cleanup().await;
2025-11-09T23:19:32.2925375Z -                
2025-11-09T23:19:32.2925486Z +
2025-11-09T23:19:32.2925660Z                  // Auto-ban IPs that should be banned
2025-11-09T23:19:32.2926075Z                  // Note: This is a simplified version - in production, you'd want more sophisticated logic
2025-11-09T23:19:32.2926304Z                  let dos_clone = Arc::clone(&dos_protection);
2025-11-09T23:19:32.2926756Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1361:
2025-11-09T23:19:32.2927124Z              }
2025-11-09T23:19:32.2927251Z          });
2025-11-09T23:19:32.2927363Z      }
2025-11-09T23:19:32.2927473Z -    
2025-11-09T23:19:32.2927587Z +
2025-11-09T23:19:32.2927787Z      /// Start periodic task to clean up expired bans
2025-11-09T23:19:32.2927942Z      fn start_ban_cleanup_task(&self) {
2025-11-09T23:19:32.2928124Z          let ban_list = Arc::clone(&self.ban_list);
2025-11-09T23:19:32.2930783Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1369:
2025-11-09T23:19:32.2931557Z              let mut interval = tokio::time::interval(tokio::time::Duration::from_secs(300)); // Every 5 minutes
2025-11-09T23:19:32.2931701Z              loop {
2025-11-09T23:19:32.2931862Z                  interval.tick().await;
2025-11-09T23:19:32.2931994Z -                
2025-11-09T23:19:32.2932111Z +
2025-11-09T23:19:32.2932319Z                  use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:19:32.2932497Z                  let now = SystemTime::now()
2025-11-09T23:19:32.2932657Z                      .duration_since(UNIX_EPOCH)
2025-11-09T23:19:32.2933110Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1376:
2025-11-09T23:19:32.2933252Z                      .unwrap()
2025-11-09T23:19:32.2933385Z                      .as_secs();
2025-11-09T23:19:32.2933501Z -                
2025-11-09T23:19:32.2933620Z +
2025-11-09T23:19:32.2933834Z                  let mut ban_list_guard = ban_list.lock().unwrap();
2025-11-09T23:19:32.2934028Z                  let expired: Vec<SocketAddr> = ban_list_guard
2025-11-09T23:19:32.2934165Z                      .iter()
2025-11-09T23:19:32.2934817Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1384:
2025-11-09T23:19:32.2935211Z                      })
2025-11-09T23:19:32.2935370Z                      .map(|(addr, _)| *addr)
2025-11-09T23:19:32.2935518Z                      .collect();
2025-11-09T23:19:32.2935636Z -                
2025-11-09T23:19:32.2935750Z +
2025-11-09T23:19:32.2935909Z                  for addr in expired {
2025-11-09T23:19:32.2936076Z                      ban_list_guard.remove(&addr);
2025-11-09T23:19:32.2936283Z                      debug!("Cleaned up expired ban for {}", addr);
2025-11-09T23:19:32.2936738Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1391:
2025-11-09T23:19:32.2936871Z                  }
2025-11-09T23:19:32.2936990Z -                
2025-11-09T23:19:32.2937102Z +
2025-11-09T23:19:32.2937258Z                  if !expired.is_empty() {
2025-11-09T23:19:32.2937486Z                      info!("Cleaned up {} expired ban(s)", expired.len());
2025-11-09T23:19:32.2937602Z                  }
2025-11-09T23:19:32.2938050Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1406:
2025-11-09T23:19:32.2938289Z      pub fn peer_addresses(&self) -> Vec<SocketAddr> {
2025-11-09T23:19:32.2938559Z          self.peer_manager.lock().unwrap().peer_socket_addresses()
2025-11-09T23:19:32.2938680Z      }
2025-11-09T23:19:32.2938802Z -    
2025-11-09T23:19:32.2938915Z +
2025-11-09T23:19:32.2939098Z      /// Get all peer addresses (as TransportAddr)
2025-11-09T23:19:32.2941287Z      pub fn peer_transport_addresses(&self) -> Vec<TransportAddr> {
2025-11-09T23:19:32.2941917Z          self.peer_manager.lock().unwrap().peer_addresses()
2025-11-09T23:19:32.2942373Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1429:
2025-11-09T23:19:32.2942671Z      /// Uses peer quality to prioritize reliable peers for critical messages
2025-11-09T23:19:32.2943049Z      pub async fn broadcast_with_quality_priority(&self, message: Vec<u8>) -> Result<()> {
2025-11-09T23:19:32.2943227Z          let pm = self.peer_manager.lock().unwrap();
2025-11-09T23:19:32.2943349Z -        
2025-11-09T23:19:32.2943460Z +
2025-11-09T23:19:32.2943608Z          // Get reliable peers first
2025-11-09T23:19:32.2944045Z          let reliable_peers = pm.select_reliable_peers();
2025-11-09T23:19:32.2944176Z          drop(pm);
2025-11-09T23:19:32.2944802Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1436:
2025-11-09T23:19:32.2944922Z -        
2025-11-09T23:19:32.2945031Z +
2025-11-09T23:19:32.2945199Z          // Send to reliable peers first
2025-11-09T23:19:32.2945354Z          for addr in &reliable_peers {
2025-11-09T23:19:32.2945718Z -            if let Err(e) = self.send_to_peer_by_transport(addr.clone(), message.clone()).await {
2025-11-09T23:19:32.2945874Z +            if let Err(e) = self
2025-11-09T23:19:32.2946124Z +                .send_to_peer_by_transport(addr.clone(), message.clone())
2025-11-09T23:19:32.2946249Z +                .await
2025-11-09T23:19:32.2946365Z +            {
2025-11-09T23:19:32.2946623Z                  warn!("Failed to send to reliable peer {:?}: {}", addr, e);
2025-11-09T23:19:32.2946750Z              }
2025-11-09T23:19:32.2946862Z          }
2025-11-09T23:19:32.2947319Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1443:
2025-11-09T23:19:32.2947438Z -        
2025-11-09T23:19:32.2947551Z +
2025-11-09T23:19:32.2947709Z          // Then send to remaining peers
2025-11-09T23:19:32.2947907Z          let pm = self.peer_manager.lock().unwrap();
2025-11-09T23:19:32.2948077Z          let all_peers = pm.peer_addresses();
2025-11-09T23:19:32.2948513Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1447:
2025-11-09T23:19:32.2948724Z -        let remaining_peers: Vec<_> = all_peers.iter()
2025-11-09T23:19:32.2948897Z +        let remaining_peers: Vec<_> = all_peers
2025-11-09T23:19:32.2949018Z +            .iter()
2025-11-09T23:19:32.2949304Z              .filter(|addr| !reliable_peers.contains(addr))
2025-11-09T23:19:32.2949702Z              .collect();
2025-11-09T23:19:32.2949834Z          drop(pm);
2025-11-09T23:19:32.2950297Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1451:
2025-11-09T23:19:32.2950424Z -        
2025-11-09T23:19:32.2950535Z +
2025-11-09T23:19:32.2950690Z          for addr in remaining_peers {
2025-11-09T23:19:32.2951055Z -            if let Err(e) = self.send_to_peer_by_transport(addr.clone(), message.clone()).await {
2025-11-09T23:19:32.2951193Z +            if let Err(e) = self
2025-11-09T23:19:32.2951437Z +                .send_to_peer_by_transport(addr.clone(), message.clone())
2025-11-09T23:19:32.2951560Z +                .await
2025-11-09T23:19:32.2951697Z +            {
2025-11-09T23:19:32.2961602Z                  warn!("Failed to send to peer {:?}: {}", addr, e);
2025-11-09T23:19:32.2961793Z              }
2025-11-09T23:19:32.2961918Z          }
2025-11-09T23:19:32.2962424Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1457:
2025-11-09T23:19:32.2962561Z -        
2025-11-09T23:19:32.2962676Z +
2025-11-09T23:19:32.2962804Z          Ok(())
2025-11-09T23:19:32.2962923Z      }
2025-11-09T23:19:32.2963052Z  
2025-11-09T23:19:32.2963534Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1464:
2025-11-09T23:19:32.2963735Z          let pm = self.peer_manager.lock().unwrap();
2025-11-09T23:19:32.2963922Z          let best_peers = pm.select_best_peers(1);
2025-11-09T23:19:32.2964060Z          drop(pm);
2025-11-09T23:19:32.2964177Z -        
2025-11-09T23:19:32.2964288Z +
2025-11-09T23:19:32.2964640Z          if let Some(addr) = best_peers.first() {
2025-11-09T23:19:32.2964918Z -            self.send_to_peer_by_transport(addr.clone(), message).await?;
2025-11-09T23:19:32.2965160Z +            self.send_to_peer_by_transport(addr.clone(), message)
2025-11-09T23:19:32.2965285Z +                .await?;
2025-11-09T23:19:32.2965430Z              Ok(addr.clone())
2025-11-09T23:19:32.2965561Z          } else {
2025-11-09T23:19:32.2965770Z              Err(anyhow::anyhow!("No peers available"))
2025-11-09T23:19:32.2966513Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1479:
2025-11-09T23:19:32.2968423Z          let pm = self.peer_manager.lock().unwrap();
2025-11-09T23:19:32.2968633Z          let reliable_peers = pm.select_reliable_peers();
2025-11-09T23:19:32.2968771Z          drop(pm);
2025-11-09T23:19:32.2968889Z -        
2025-11-09T23:19:32.2969005Z +
2025-11-09T23:19:32.2969164Z          if reliable_peers.is_empty() {
2025-11-09T23:19:32.2969455Z              return Err(anyhow::anyhow!("No reliable peers available"));
2025-11-09T23:19:32.2969571Z          }
2025-11-09T23:19:32.2970041Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1486:
2025-11-09T23:19:32.2970164Z -        
2025-11-09T23:19:32.2970273Z +
2025-11-09T23:19:32.2970430Z          // Select best reliable peer
2025-11-09T23:19:32.2970632Z          let pm = self.peer_manager.lock().unwrap();
2025-11-09T23:19:32.2971242Z -        let best_reliable = reliable_peers.iter()
2025-11-09T23:19:32.2971411Z -            .max_by(|a, b| {
2025-11-09T23:19:32.2971737Z -                let score_a = pm.get_peer(a).map(|p| p.quality_score()).unwrap_or(0.0);
2025-11-09T23:19:32.2972035Z -                let score_b = pm.get_peer(b).map(|p| p.quality_score()).unwrap_or(0.0);
2025-11-09T23:19:32.2972353Z -                score_a.partial_cmp(&score_b).unwrap_or(std::cmp::Ordering::Equal)
2025-11-09T23:19:32.2972470Z -            });
2025-11-09T23:19:32.2972726Z +        let best_reliable = reliable_peers.iter().max_by(|a, b| {
2025-11-09T23:19:32.2973012Z +            let score_a = pm.get_peer(a).map(|p| p.quality_score()).unwrap_or(0.0);
2025-11-09T23:19:32.2973290Z +            let score_b = pm.get_peer(b).map(|p| p.quality_score()).unwrap_or(0.0);
2025-11-09T23:19:32.2973412Z +            score_a
2025-11-09T23:19:32.2973576Z +                .partial_cmp(&score_b)
2025-11-09T23:19:32.2974001Z +                .unwrap_or(std::cmp::Ordering::Equal)
2025-11-09T23:19:32.2974138Z +        });
2025-11-09T23:19:32.2974273Z          drop(pm);
2025-11-09T23:19:32.2974541Z -        
2025-11-09T23:19:32.2974655Z +
2025-11-09T23:19:32.2974823Z          if let Some(addr) = best_reliable {
2025-11-09T23:19:32.2975099Z -            self.send_to_peer_by_transport(addr.clone(), message).await?;
2025-11-09T23:19:32.2975322Z +            self.send_to_peer_by_transport(addr.clone(), message)
2025-11-09T23:19:32.2975451Z +                .await?;
2025-11-09T23:19:32.2975594Z              Ok(addr.clone())
2025-11-09T23:19:32.2975715Z          } else {
2025-11-09T23:19:32.2975942Z              Err(anyhow::anyhow!("No reliable peers available"))
2025-11-09T23:19:32.2976406Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1509:
2025-11-09T23:19:32.2976546Z          let transport_addr = {
2025-11-09T23:19:32.2976724Z              let pm = self.peer_manager.lock().unwrap();
2025-11-09T23:19:32.2976906Z              pm.find_transport_addr_by_socket(addr)
2025-11-09T23:19:32.2977044Z -                .or_else(|| {
2025-11-09T23:19:32.2977313Z -                    self.socket_to_transport.lock().unwrap().get(&addr).cloned()
2025-11-09T23:19:32.2977423Z -                })
2025-11-09T23:19:32.2977736Z +                .or_else(|| self.socket_to_transport.lock().unwrap().get(&addr).cloned())
2025-11-09T23:19:32.2977846Z          };
2025-11-09T23:19:32.2977953Z -        
2025-11-09T23:19:32.2978060Z +
2025-11-09T23:19:32.2978263Z          if let Some(transport_addr) = transport_addr {
2025-11-09T23:19:32.2978533Z -            self.send_to_peer_by_transport(transport_addr, message).await
2025-11-09T23:19:32.2978765Z +            self.send_to_peer_by_transport(transport_addr, message)
2025-11-09T23:19:32.2978957Z +                .await
2025-11-09T23:19:32.2979072Z          } else {
2025-11-09T23:19:32.2979279Z              // Fallback: try TCP (for backward compatibility)
2025-11-09T23:19:32.2979615Z -            self.send_to_peer_by_transport(TransportAddr::Tcp(addr), message).await
2025-11-09T23:19:32.2980118Z +            self.send_to_peer_by_transport(TransportAddr::Tcp(addr), message)
2025-11-09T23:19:32.2980238Z +                .await
2025-11-09T23:19:32.2980352Z          }
2025-11-09T23:19:32.2980465Z      }
2025-11-09T23:19:32.2980580Z -    
2025-11-09T23:19:32.2980695Z +
2025-11-09T23:19:32.2981072Z      /// Send a message to a specific peer (by TransportAddr - supports all transports)
2025-11-09T23:19:32.2981535Z -    pub async fn send_to_peer_by_transport(&self, addr: TransportAddr, message: Vec<u8>) -> Result<()> {
2025-11-09T23:19:32.2981708Z +    pub async fn send_to_peer_by_transport(
2025-11-09T23:19:32.2981821Z +        &self,
2025-11-09T23:19:32.2981971Z +        addr: TransportAddr,
2025-11-09T23:19:32.2982103Z +        message: Vec<u8>,
2025-11-09T23:19:32.2982235Z +    ) -> Result<()> {
2025-11-09T23:19:32.2982406Z          let message_len = message.len();
2025-11-09T23:19:32.2982554Z          // Track bytes sent
2025-11-09T23:19:32.2982736Z          self.track_bytes_sent(message_len as u64);
2025-11-09T23:19:32.2983221Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1530:
2025-11-09T23:19:32.2983354Z -        
2025-11-09T23:19:32.2983467Z +
2025-11-09T23:19:32.2983676Z          let mut pm = self.peer_manager.lock().unwrap();
2025-11-09T23:19:32.2983868Z          if let Some(peer) = pm.get_peer_mut(&addr) {
2025-11-09T23:19:32.2984039Z              peer.send_message(message).await?;
2025-11-09T23:19:32.2984662Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1539:
2025-11-09T23:19:32.2984785Z      }
2025-11-09T23:19:32.2984890Z  
2025-11-09T23:19:32.2985067Z      /// Connect to a peer at the given address
2025-11-09T23:19:32.2985187Z -    /// 
2025-11-09T23:19:32.2985310Z +    ///
2025-11-09T23:19:32.2985658Z      /// Attempts to connect using available transports with graceful degradation:
2025-11-09T23:19:32.2986229Z      /// 1. Tries preferred transport (based on transport_preference)
2025-11-09T23:19:32.2986474Z      /// 2. Falls back to TCP if preferred transport fails
2025-11-09T23:19:32.2986936Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1547:
2025-11-09T23:19:32.2987250Z      pub async fn connect_to_peer(&self, addr: SocketAddr) -> Result<()> {
2025-11-09T23:19:32.2987426Z          use crate::network::peer::Peer;
2025-11-09T23:19:32.2987639Z          use crate::network::transport::TransportAddr;
2025-11-09T23:19:32.2987756Z -        
2025-11-09T23:19:32.2987872Z +
2025-11-09T23:19:32.2988244Z          // Check DoS protection: connection rate limiting (for outgoing connections too)
2025-11-09T23:19:32.2988389Z          let ip = addr.ip();
2025-11-09T23:19:32.2990413Z          if !self.dos_protection.check_connection(ip).await {
2025-11-09T23:19:32.2990860Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1554:
2025-11-09T23:19:32.2991287Z -            warn!("Connection rate limit exceeded for IP {}, rejecting outgoing connection", ip);
2025-11-09T23:19:32.2991416Z -            
2025-11-09T23:19:32.2991535Z +            warn!(
2025-11-09T23:19:32.2991883Z +                "Connection rate limit exceeded for IP {}, rejecting outgoing connection",
2025-11-09T23:19:32.2991998Z +                ip
2025-11-09T23:19:32.2992114Z +            );
2025-11-09T23:19:32.2992235Z +
2025-11-09T23:19:32.2992382Z              // Check if we should auto-ban
2025-11-09T23:19:32.2992604Z              if self.dos_protection.should_auto_ban(ip).await {
2025-11-09T23:19:32.2992910Z -                warn!("Auto-banning IP {} for repeated connection rate violations", ip);
2025-11-09T23:19:32.2993045Z +                warn!(
2025-11-09T23:19:32.2993317Z +                    "Auto-banning IP {} for repeated connection rate violations",
2025-11-09T23:19:32.2993439Z +                    ip
2025-11-09T23:19:32.2993578Z +                );
2025-11-09T23:19:32.2993709Z                  // Ban the IP
2025-11-09T23:19:32.2993934Z                  let unban_timestamp = std::time::SystemTime::now()
2025-11-09T23:19:32.2995024Z                      .duration_since(std::time::UNIX_EPOCH)
2025-11-09T23:19:32.2995538Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1564:
2025-11-09T23:19:32.2995685Z                      + 3600; // Ban for 1 hour
2025-11-09T23:19:32.2995901Z                  let mut ban_list = self.ban_list.lock().unwrap();
2025-11-09T23:19:32.2996093Z                  ban_list.insert(addr, unban_timestamp);
2025-11-09T23:19:32.2996464Z -                return Err(anyhow::anyhow!("IP {} is banned due to connection rate violations", ip));
2025-11-09T23:19:32.2996620Z +                return Err(anyhow::anyhow!(
2025-11-09T23:19:32.2996845Z +                    "IP {} is banned due to connection rate violations",
2025-11-09T23:19:32.2996973Z +                    ip
2025-11-09T23:19:32.2997104Z +                ));
2025-11-09T23:19:32.2997222Z              }
2025-11-09T23:19:32.2997334Z -            
2025-11-09T23:19:32.2997703Z -            return Err(anyhow::anyhow!("Connection rate limit exceeded for IP {}", ip));
2025-11-09T23:19:32.2997810Z +
2025-11-09T23:19:32.2997974Z +            return Err(anyhow::anyhow!(
2025-11-09T23:19:32.2998168Z +                "Connection rate limit exceeded for IP {}",
2025-11-09T23:19:32.2998285Z +                ip
2025-11-09T23:19:32.2998402Z +            ));
2025-11-09T23:19:32.2998517Z          }
2025-11-09T23:19:32.2998623Z -        
2025-11-09T23:19:32.2998727Z +
2025-11-09T23:19:32.2998936Z          // Eclipse attack prevention: check IP diversity
2025-11-09T23:19:32.2999120Z          if !self.check_eclipse_prevention(ip) {
2025-11-09T23:19:32.2999292Z              let prefix = self.get_ip_prefix(ip);
2025-11-09T23:19:32.2999762Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1576:
2025-11-09T23:19:32.3000515Z              warn!("Eclipse attack prevention: too many connections from IP range {:?}, rejecting connection from {}", 
2025-11-09T23:19:32.3000670Z                    prefix, ip);
2025-11-09T23:19:32.3003271Z -            return Err(anyhow::anyhow!("Eclipse attack prevention: too many connections from IP range"));
2025-11-09T23:19:32.3003441Z +            return Err(anyhow::anyhow!(
2025-11-09T23:19:32.3003739Z +                "Eclipse attack prevention: too many connections from IP range"
2025-11-09T23:19:32.3003855Z +            ));
2025-11-09T23:19:32.3003979Z          }
2025-11-09T23:19:32.3004091Z -        
2025-11-09T23:19:32.3004197Z +
2025-11-09T23:19:32.3004483Z          let mut last_error = None;
2025-11-09T23:19:32.3004595Z -        
2025-11-09T23:19:32.3004714Z +
2025-11-09T23:19:32.3004993Z          // Try transports in preference order with graceful degradation
2025-11-09T23:19:32.3005274Z          let transports_to_try = self.get_transports_for_connection();
2025-11-09T23:19:32.3005402Z -        
2025-11-09T23:19:32.3005505Z +
2025-11-09T23:19:32.3005686Z          for transport_type in transports_to_try {
2025-11-09T23:19:32.3005989Z              match self.try_connect_with_transport(&transport_type, addr).await {
2025-11-09T23:19:32.3006153Z                  Ok((peer, transport_addr)) => {
2025-11-09T23:19:32.3006596Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1591:
2025-11-09T23:19:32.3006806Z                          let mut pm = self.peer_manager.lock().unwrap();
2025-11-09T23:19:32.3007002Z                          pm.add_peer(transport_addr.clone(), peer)?;
2025-11-09T23:19:32.3007120Z                      }
2025-11-09T23:19:32.3007247Z -                    
2025-11-09T23:19:32.3007360Z +
2025-11-09T23:19:32.3007661Z                      // Note: Peer handler is managed by Peer::from_transport_connection
2025-11-09T23:19:32.3007844Z                      // No need to spawn additional handler task
2025-11-09T23:19:32.3007966Z -                    
2025-11-09T23:19:32.3008426Z -                    info!("Successfully connected to {} via {:?} (transport: {:?})", addr, transport_type, transport_addr);
2025-11-09T23:19:32.3008765Z +
2025-11-09T23:19:32.3008904Z +                    info!(
2025-11-09T23:19:32.3009166Z +                        "Successfully connected to {} via {:?} (transport: {:?})",
2025-11-09T23:19:32.3009349Z +                        addr, transport_type, transport_addr
2025-11-09T23:19:32.3009470Z +                    );
2025-11-09T23:19:32.3009606Z                      return Ok(());
2025-11-09T23:19:32.3009713Z                  }
2025-11-09T23:19:32.3009842Z                  Err(e) => {
2025-11-09T23:19:32.3010297Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1602:
2025-11-09T23:19:32.3010603Z -                    warn!("Failed to connect to {} via {:?}: {}", addr, transport_type, e);
2025-11-09T23:19:32.3010731Z +                    warn!(
2025-11-09T23:19:32.3010925Z +                        "Failed to connect to {} via {:?}: {}",
2025-11-09T23:19:32.3011083Z +                        addr, transport_type, e
2025-11-09T23:19:32.3011212Z +                    );
2025-11-09T23:19:32.3011365Z                      last_error = Some(e);
2025-11-09T23:19:32.3011524Z                      // Continue to next transport
2025-11-09T23:19:32.3011630Z                  }
2025-11-09T23:19:32.3012066Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1606:
2025-11-09T23:19:32.3012192Z              }
2025-11-09T23:19:32.3012306Z          }
2025-11-09T23:19:32.3012411Z -        
2025-11-09T23:19:32.3012524Z +
2025-11-09T23:19:32.3012669Z          // All transports failed
2025-11-09T23:19:32.3013041Z          Err(last_error.unwrap_or_else(|| anyhow::anyhow!("All transport attempts failed")))
2025-11-09T23:19:32.3013165Z      }
2025-11-09T23:19:32.3013605Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1612:
2025-11-09T23:19:32.3013930Z -    
2025-11-09T23:19:32.3014035Z +
2025-11-09T23:19:32.3014772Z      /// Helper: Get list of transports to try for a connection
2025-11-09T23:19:32.3015225Z      fn get_transports_for_connection(&self) -> Vec<crate::network::transport::TransportType> {
2025-11-09T23:19:32.3015393Z          let mut transports = Vec::new();
2025-11-09T23:19:32.3015840Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1616:
2025-11-09T23:19:32.3015954Z -        
2025-11-09T23:19:32.3016060Z +
2025-11-09T23:19:32.3016219Z          // Add transports in preference order
2025-11-09T23:19:32.3016406Z          if self.transport_preference.allows_tcp() {
2025-11-09T23:19:32.3016713Z              transports.push(crate::network::transport::TransportType::Tcp);
2025-11-09T23:19:32.3017167Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1620:
2025-11-09T23:19:32.3017289Z          }
2025-11-09T23:19:32.3017396Z -        
2025-11-09T23:19:32.3017516Z +
2025-11-09T23:19:32.3017665Z          #[cfg(feature = "quinn")]
2025-11-09T23:19:32.3017861Z          if self.transport_preference.allows_quinn() {
2025-11-09T23:19:32.3018068Z              if let Some(ref _quinn) = self.quinn_transport {
2025-11-09T23:19:32.3018491Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1625:
2025-11-09T23:19:32.3018822Z                  transports.push(crate::network::transport::TransportType::Quinn);
2025-11-09T23:19:32.3018937Z              }
2025-11-09T23:19:32.3019048Z          }
2025-11-09T23:19:32.3019167Z -        
2025-11-09T23:19:32.3019273Z +
2025-11-09T23:19:32.3019402Z          #[cfg(feature = "iroh")]
2025-11-09T23:19:32.3019588Z          if self.transport_preference.allows_iroh() {
2025-11-09T23:19:32.3019784Z              if let Some(ref _iroh) = self.iroh_transport {
2025-11-09T23:19:32.3020209Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1632:
2025-11-09T23:19:32.3020515Z                  transports.push(crate::network::transport::TransportType::Iroh);
2025-11-09T23:19:32.3020631Z              }
2025-11-09T23:19:32.3022459Z          }
2025-11-09T23:19:32.3022572Z -        
2025-11-09T23:19:32.3022690Z +
2025-11-09T23:19:32.3022903Z          // Always try TCP as fallback if not already in list
2025-11-09T23:19:32.3023296Z -        if !transports.iter().any(|t| matches!(t, crate::network::transport::TransportType::Tcp)) {
2025-11-09T23:19:32.3023428Z +        if !transports
2025-11-09T23:19:32.3023557Z +            .iter()
2025-11-09T23:19:32.3023824Z +            .any(|t| matches!(t, crate::network::transport::TransportType::Tcp))
2025-11-09T23:19:32.3023937Z +        {
2025-11-09T23:19:32.3024240Z              transports.push(crate::network::transport::TransportType::Tcp);
2025-11-09T23:19:32.3024569Z          }
2025-11-09T23:19:32.3024691Z -        
2025-11-09T23:19:32.3024794Z +
2025-11-09T23:19:32.3024919Z          transports
2025-11-09T23:19:32.3025034Z      }
2025-11-09T23:19:32.3025157Z -    
2025-11-09T23:19:32.3025274Z +
2025-11-09T23:19:32.3025481Z      /// Helper: Try connecting with a specific transport
2025-11-09T23:19:32.3026282Z -    async fn try_connect_with_transport(&self, transport_type: &crate::network::transport::TransportType, addr: SocketAddr) -> Result<(peer::Peer, TransportAddr)> {
2025-11-09T23:19:32.3026482Z -        use crate::network::transport::TransportAddr;
2025-11-09T23:19:32.3026646Z +    async fn try_connect_with_transport(
2025-11-09T23:19:32.3026762Z +        &self,
2025-11-09T23:19:32.3027015Z +        transport_type: &crate::network::transport::TransportType,
2025-11-09T23:19:32.3027156Z +        addr: SocketAddr,
2025-11-09T23:19:32.3027327Z +    ) -> Result<(peer::Peer, TransportAddr)> {
2025-11-09T23:19:32.3027478Z          use crate::network::peer::Peer;
2025-11-09T23:19:32.3027589Z -        
2025-11-09T23:19:32.3027770Z +        use crate::network::transport::TransportAddr;
2025-11-09T23:19:32.3027873Z +
2025-11-09T23:19:32.3028241Z          match transport_type {
2025-11-09T23:19:32.3028481Z              crate::network::transport::TransportType::Tcp => {
2025-11-09T23:19:32.3028689Z                  // Use TcpTransport to create connection properly
2025-11-09T23:19:32.3029130Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1684:
2025-11-09T23:19:32.3029355Z              crate::network::transport::TransportType::Iroh => {
2025-11-09T23:19:32.3029531Z                  // Iroh requires public key, not SocketAddr
2025-11-09T23:19:32.3029835Z                  // For now, return error - would need peer discovery or address resolution
2025-11-09T23:19:32.3030169Z -                Err(anyhow::anyhow!("Iroh transport requires public key, not SocketAddr"))
2025-11-09T23:19:32.3030663Z +                Err(anyhow::anyhow!(
2025-11-09T23:19:32.3030894Z +                    "Iroh transport requires public key, not SocketAddr"
2025-11-09T23:19:32.3031019Z +                ))
2025-11-09T23:19:32.3031144Z              }
2025-11-09T23:19:32.3031250Z          }
2025-11-09T23:19:32.3031358Z      }
2025-11-09T23:19:32.3031792Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1691:
2025-11-09T23:19:32.3031907Z -    
2025-11-09T23:19:32.3032015Z +
2025-11-09T23:19:32.3032182Z      /// Send ping message to all connected peers
2025-11-09T23:19:32.3032397Z      pub async fn ping_all_peers(&self) -> Result<()> {
2025-11-09T23:19:32.3032753Z -        use crate::network::protocol::{ProtocolMessage, ProtocolParser, PingMessage};
2025-11-09T23:19:32.3033098Z +        use crate::network::protocol::{PingMessage, ProtocolMessage, ProtocolParser};
2025-11-09T23:19:32.3033268Z          use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:19:32.3033380Z -        
2025-11-09T23:19:32.3033485Z +
2025-11-09T23:19:32.3033640Z          // Generate nonce for ping
2025-11-09T23:19:32.3033797Z          let nonce = SystemTime::now()
2025-11-09T23:19:32.3033943Z              .duration_since(UNIX_EPOCH)
2025-11-09T23:19:32.3034541Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1700:
2025-11-09T23:19:32.3034942Z              .unwrap()
2025-11-09T23:19:32.3035071Z              .as_nanos() as u64;
2025-11-09T23:19:32.3035180Z -        
2025-11-09T23:19:32.3035294Z +
2025-11-09T23:19:32.3035558Z          let ping_msg = ProtocolMessage::Ping(PingMessage { nonce });
2025-11-09T23:19:32.3035825Z          let wire_msg = ProtocolParser::serialize_message(&ping_msg)?;
2025-11-09T23:19:32.3035935Z -        
2025-11-09T23:19:32.3036041Z +
2025-11-09T23:19:32.3036321Z          let peer_addrs = self.peer_manager.lock().unwrap().peer_addresses();
2025-11-09T23:19:32.3036449Z          for addr in peer_addrs {
2025-11-09T23:19:32.3036828Z              // Convert TransportAddr to SocketAddr for send_to_peer, or use send_to_peer_by_transport
2025-11-09T23:19:32.3037235Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1726:
2025-11-09T23:19:32.3037347Z                  }
2025-11-09T23:19:32.3037451Z              }
2025-11-09T23:19:32.3037559Z          }
2025-11-09T23:19:32.3037665Z -        
2025-11-09T23:19:32.3037763Z +
2025-11-09T23:19:32.3037872Z          Ok(())
2025-11-09T23:19:32.3037980Z      }
2025-11-09T23:19:32.3038076Z  
2025-11-09T23:19:32.3038466Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1761:
2025-11-09T23:19:32.3038775Z          // Track message queue size manually (unbounded channel doesn't have len())
2025-11-09T23:19:32.3038921Z          let mut message_count = 0u64;
2025-11-09T23:19:32.3039166Z          let mut last_metrics_update = std::time::SystemTime::now();
2025-11-09T23:19:32.3039279Z -        
2025-11-09T23:19:32.3039393Z +
2025-11-09T23:19:32.3039616Z          while let Some(message) = self.peer_rx.recv().await {
2025-11-09T23:19:32.3039759Z              message_count += 1;
2025-11-09T23:19:32.3039880Z -            
2025-11-09T23:19:32.3039992Z +
2025-11-09T23:19:32.3040539Z              // Update metrics periodically (every 100 messages or 10 seconds)
2025-11-09T23:19:32.3040735Z              let now = std::time::SystemTime::now();
2025-11-09T23:19:32.3040926Z -            let should_update = message_count % 100 == 0 
2025-11-09T23:19:32.3041108Z +            let should_update = message_count % 100 == 0
2025-11-09T23:19:32.3041407Z                  || now.duration_since(last_metrics_update).unwrap().as_secs() >= 10;
2025-11-09T23:19:32.3041534Z -            
2025-11-09T23:19:32.3041644Z +
2025-11-09T23:19:32.3041853Z              if should_update {
2025-11-09T23:19:32.3042055Z                  let pm = self.peer_manager.lock().unwrap();
2025-11-09T23:19:32.3042246Z                  let active_connections = pm.peer_count();
2025-11-09T23:19:32.3042696Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1776:
2025-11-09T23:19:32.3042964Z                  let bytes_received = *self.bytes_received.lock().unwrap();
2025-11-09T23:19:32.3043193Z                  let bytes_sent = *self.bytes_sent.lock().unwrap();
2025-11-09T23:19:32.3043313Z -                
2025-11-09T23:19:32.3043437Z +
2025-11-09T23:19:32.3043731Z                  // Approximate queue size (messages processed since last check)
2025-11-09T23:19:32.3043917Z                  let queue_size = message_count as usize;
2025-11-09T23:19:32.3044033Z -                
2025-11-09T23:19:32.3044150Z +
2025-11-09T23:19:32.3044447Z                  // Check message queue size limit
2025-11-09T23:19:32.3044757Z -                if !self.dos_protection.check_message_queue_size(queue_size).await {
2025-11-09T23:19:32.3045202Z -                    warn!("Message queue size limit exceeded (processed {} messages), potential DoS", queue_size);
2025-11-09T23:19:32.3045341Z +                if !self
2025-11-09T23:19:32.3045480Z +                    .dos_protection
2025-11-09T23:19:32.3045654Z +                    .check_message_queue_size(queue_size)
2025-11-09T23:19:32.3045785Z +                    .await
2025-11-09T23:19:32.3045913Z +                {
2025-11-09T23:19:32.3046035Z +                    warn!(
2025-11-09T23:19:32.3046645Z +                        "Message queue size limit exceeded (processed {} messages), potential DoS",
2025-11-09T23:19:32.3046791Z +                        queue_size
2025-11-09T23:19:32.3046911Z +                    );
2025-11-09T23:19:32.3047078Z                      // Optionally detect DoS attack
2025-11-09T23:19:32.3047312Z                      if self.dos_protection.detect_dos_attack().await {
2025-11-09T23:19:32.3047669Z                          warn!("DoS attack detected - message queue and connections at high levels");
2025-11-09T23:19:32.3048126Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1790:
2025-11-09T23:19:32.3048319Z                      // Reset counter to prevent false positives
2025-11-09T23:19:32.3048464Z                      message_count = 0;
2025-11-09T23:19:32.3048579Z                  }
2025-11-09T23:19:32.3048701Z -                
2025-11-09T23:19:32.3048868Z -                self.dos_protection.update_metrics(
2025-11-09T23:19:32.3049025Z -                    active_connections,
2025-11-09T23:19:32.3049169Z -                    queue_size,
2025-11-09T23:19:32.3049310Z -                    bytes_received,
2025-11-09T23:19:32.3049437Z -                    bytes_sent,
2025-11-09T23:19:32.3049554Z -                ).await;
2025-11-09T23:19:32.3049665Z -                
2025-11-09T23:19:32.3049774Z +
2025-11-09T23:19:32.3049912Z +                self.dos_protection
2025-11-09T23:19:32.3050275Z +                    .update_metrics(active_connections, queue_size, bytes_received, bytes_sent)
2025-11-09T23:19:32.3050413Z +                    .await;
2025-11-09T23:19:32.3050526Z +
2025-11-09T23:19:32.3050683Z                  last_metrics_update = now;
2025-11-09T23:19:32.3050869Z                  message_count = 0; // Reset after update
2025-11-09T23:19:32.3050980Z              }
2025-11-09T23:19:32.3051410Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1811:
2025-11-09T23:19:32.3051848Z                      let mut pm = self.peer_manager.lock().unwrap();
2025-11-09T23:19:32.3052052Z                      // Remove peer directly using TransportAddr
2025-11-09T23:19:32.3052189Z                      pm.remove_peer(&addr);
2025-11-09T23:19:32.3052304Z -                    
2025-11-09T23:19:32.3052424Z +
2025-11-09T23:19:32.3052699Z                      // Clean up per-IP connection count (only for TCP/Quinn, not Iroh)
2025-11-09T23:19:32.3052846Z                      if let Some(ip) = match &addr {
2025-11-09T23:19:32.3053047Z                          TransportAddr::Tcp(sock) => Some(sock.ip()),
2025-11-09T23:19:32.3053463Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1828:
2025-11-09T23:19:32.3053588Z                              }
2025-11-09T23:19:32.3053703Z                          }
2025-11-09T23:19:32.3053815Z                      }
2025-11-09T23:19:32.3053929Z -                    
2025-11-09T23:19:32.3054027Z +
2025-11-09T23:19:32.3054479Z                      // Clean up rate limiter (use SocketAddr for TCP/Quinn, or a key for Iroh)
2025-11-09T23:19:32.3054614Z                      {
2025-11-09T23:19:32.3054861Z                          let mut rates = self.peer_message_rates.lock().unwrap();
2025-11-09T23:19:32.3055271Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1844:
2025-11-09T23:19:32.3055428Z                              rates.remove(&sock_addr);
2025-11-09T23:19:32.3055535Z                          }
2025-11-09T23:19:32.3055638Z                      }
2025-11-09T23:19:32.3055749Z -                    
2025-11-09T23:19:32.3055849Z +
2025-11-09T23:19:32.3056027Z                      // Clean up eclipse attack prevention tracking
2025-11-09T23:19:32.3056175Z                      if let Some(ip) = match &addr {
2025-11-09T23:19:32.3056362Z                          TransportAddr::Tcp(sock) => Some(sock.ip()),
2025-11-09T23:19:32.3058781Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1967:
2025-11-09T23:19:32.3059099Z                      {
2025-11-09T23:19:32.3059299Z                          let mut pm = self.peer_manager.lock().unwrap();
2025-11-09T23:19:32.3059537Z                          // Try to find peer by SocketAddr (TCP or Quinn, or Iroh mapping)
2025-11-09T23:19:32.3059799Z -                        let transport_addr = pm.find_transport_addr_by_socket(peer_addr)
2025-11-09T23:19:32.3059932Z -                            .or_else(|| {
2025-11-09T23:19:32.3060068Z +                        let transport_addr =
2025-11-09T23:19:32.3060297Z +                            pm.find_transport_addr_by_socket(peer_addr).or_else(|| {
2025-11-09T23:19:32.3060790Z                                  // Check Iroh mapping
2025-11-09T23:19:32.3061083Z -                                self.socket_to_transport.lock().unwrap().get(&peer_addr).cloned()
2025-11-09T23:19:32.3061248Z +                                self.socket_to_transport
2025-11-09T23:19:32.3061381Z +                                    .lock()
2025-11-09T23:19:32.3061516Z +                                    .unwrap()
2025-11-09T23:19:32.3061653Z +                                    .get(&peer_addr)
2025-11-09T23:19:32.3061774Z +                                    .cloned()
2025-11-09T23:19:32.3061893Z                              });
2025-11-09T23:19:32.3062079Z                          if let Some(transport_addr) = transport_addr {
2025-11-09T23:19:32.3062303Z                              if let Some(peer) = pm.get_peer_mut(&transport_addr) {
2025-11-09T23:19:32.3062746Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1978:
2025-11-09T23:19:32.3062874Z                              }
2025-11-09T23:19:32.3062997Z                          }
2025-11-09T23:19:32.3063115Z                      }
2025-11-09T23:19:32.3063268Z -                    
2025-11-09T23:19:32.3063592Z +
2025-11-09T23:19:32.3063784Z                      // Check rate limiting before processing
2025-11-09T23:19:32.3064040Z                      let mut rates = self.peer_message_rates.lock().unwrap();
2025-11-09T23:19:32.3064490Z                      let rate_limiter = rates.entry(peer_addr).or_insert_with(|| {
2025-11-09T23:19:32.3064953Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1985:
2025-11-09T23:19:32.3065149Z                          // Default: 100 burst, 10 messages/second
2025-11-09T23:19:32.3065337Z                          PeerRateLimiter::new(100, 10)
2025-11-09T23:19:32.3065462Z                      });
2025-11-09T23:19:32.3065584Z -                    
2025-11-09T23:19:32.3065705Z +
2025-11-09T23:19:32.3065887Z                      if !rate_limiter.check_and_consume() {
2025-11-09T23:19:32.3066204Z -                        warn!("Rate limit exceeded for peer {}, dropping message", peer_addr);
2025-11-09T23:19:32.3066340Z +                        warn!(
2025-11-09T23:19:32.3066586Z +                            "Rate limit exceeded for peer {}, dropping message",
2025-11-09T23:19:32.3066742Z +                            peer_addr
2025-11-09T23:19:32.3066870Z +                        );
2025-11-09T23:19:32.3067135Z                          // Optionally ban peer after repeated rate limit violations
2025-11-09T23:19:32.3067307Z                          // For now, just drop the message
2025-11-09T23:19:32.3067442Z                          continue;
2025-11-09T23:19:32.3067895Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1994:
2025-11-09T23:19:32.3068018Z                      }
2025-11-09T23:19:32.3068151Z                      drop(rates);
2025-11-09T23:19:32.3068277Z -                    
2025-11-09T23:19:32.3068387Z +
2025-11-09T23:19:32.3070487Z                      // Check if this is a response to a pending request (UTXOSet or FilteredBlock)
2025-11-09T23:19:32.3070801Z                      // Extract request_id from message and route to correct pending request
2025-11-09T23:19:32.3071080Z                      if let Ok(parsed) = ProtocolParser::parse_message(&data) {
2025-11-09T23:19:32.3071806Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2002:
2025-11-09T23:19:32.3072117Z                              ProtocolMessage::FilteredBlock(msg) => Some(msg.request_id),
2025-11-09T23:19:32.3072260Z                              _ => None,
2025-11-09T23:19:32.3072384Z                          };
2025-11-09T23:19:32.3072505Z -                        
2025-11-09T23:19:32.3072620Z +
2025-11-09T23:19:32.3072807Z                          if let Some(request_id) = request_id_opt {
2025-11-09T23:19:32.3072991Z                              // Route to pending request by request_id
2025-11-09T23:19:32.3073247Z                              let mut pending = self.pending_requests.lock().unwrap();
2025-11-09T23:19:32.3074201Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2015:
2025-11-09T23:19:32.3074537Z                              }
2025-11-09T23:19:32.3074669Z                          }
2025-11-09T23:19:32.3074806Z                      }
2025-11-09T23:19:32.3074930Z -                    
2025-11-09T23:19:32.3075046Z +
2025-11-09T23:19:32.3075235Z                      // Process through protocol layer
2025-11-09T23:19:32.3075526Z                      if let Err(e) = self.handle_incoming_wire_tcp(peer_addr, data).await {
2025-11-09T23:19:32.3075790Z                          warn!("Failed to process message from {}: {}", peer_addr, e);
2025-11-09T23:19:32.3076239Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2034:
2025-11-09T23:19:32.3076455Z      /// 3. Creates NodeChainAccess from storage modules
2025-11-09T23:19:32.3076720Z      /// 4. Calls bllvm_protocol::network::process_network_message()
2025-11-09T23:19:32.3077055Z      /// 5. Converts NetworkResponse back to wire format and enqueues for sending
2025-11-09T23:19:32.3077733Z -    pub async fn handle_incoming_wire_tcp(&self, peer_addr: SocketAddr, data: Vec<u8>) -> Result<()> {
2025-11-09T23:19:32.3077918Z +    pub async fn handle_incoming_wire_tcp(
2025-11-09T23:19:32.3078041Z +        &self,
2025-11-09T23:19:32.3078190Z +        peer_addr: SocketAddr,
2025-11-09T23:19:32.3078318Z +        data: Vec<u8>,
2025-11-09T23:19:32.3078448Z +    ) -> Result<()> {
2025-11-09T23:19:32.3078590Z          // Track bytes received
2025-11-09T23:19:32.3078793Z          self.track_bytes_received(data.len() as u64);
2025-11-09T23:19:32.3078912Z -        
2025-11-09T23:19:32.3079026Z +
2025-11-09T23:19:32.3079171Z          // Check if peer is banned
2025-11-09T23:19:32.3079325Z          if self.is_banned(peer_addr) {
2025-11-09T23:19:32.3079581Z              warn!("Rejecting message from banned peer: {}", peer_addr);
2025-11-09T23:19:32.3081399Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2044:
2025-11-09T23:19:32.3081633Z              return Ok(()); // Silently drop messages from banned peers
2025-11-09T23:19:32.3081754Z          }
2025-11-09T23:19:32.3081987Z          let parsed = ProtocolParser::parse_message(&data)?;
2025-11-09T23:19:32.3082104Z -        
2025-11-09T23:19:32.3082218Z +
2025-11-09T23:19:32.3082471Z          // Handle special cases that don't go through protocol layer
2025-11-09T23:19:32.3082611Z          match parsed {
2025-11-09T23:19:32.3082728Z              // BIP331
2025-11-09T23:19:32.3083160Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2097:
2025-11-09T23:19:32.3083341Z                  // Continue to protocol layer processing
2025-11-09T23:19:32.3083461Z              }
2025-11-09T23:19:32.3083573Z          }
2025-11-09T23:19:32.3083688Z -        
2025-11-09T23:19:32.3083803Z +
2025-11-09T23:19:32.3084056Z          // Process with protocol layer if dependencies are available
2025-11-09T23:19:32.3084588Z -        if let (Some(ref protocol_engine), Some(ref storage), Some(ref mempool_manager)) = 
2025-11-09T23:19:32.3085005Z -            (self.protocol_engine.as_ref(), self.storage.as_ref(), self.mempool_manager.as_ref()) {
2025-11-09T23:19:32.3085375Z -            
2025-11-09T23:19:32.3085740Z +        if let (Some(ref protocol_engine), Some(ref storage), Some(ref mempool_manager)) = (
2025-11-09T23:19:32.3085904Z +            self.protocol_engine.as_ref(),
2025-11-09T23:19:32.3086053Z +            self.storage.as_ref(),
2025-11-09T23:19:32.3086201Z +            self.mempool_manager.as_ref(),
2025-11-09T23:19:32.3086316Z +        ) {
2025-11-09T23:19:32.3086644Z              // Convert ProtocolMessage to bllvm_protocol::network::NetworkMessage
2025-11-09T23:19:32.3086877Z              use crate::network::protocol_adapter::ProtocolAdapter;
2025-11-09T23:19:32.3087236Z              let protocol_msg = ProtocolAdapter::protocol_to_consensus_message(&parsed)?;
2025-11-09T23:19:32.3087678Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2108:
2025-11-09T23:19:32.3087804Z -            
2025-11-09T23:19:32.3087914Z +
2025-11-09T23:19:32.3088063Z              // Get or create PeerState
2025-11-09T23:19:32.3088315Z              let mut peer_states = self.peer_states.lock().unwrap();
2025-11-09T23:19:32.3088515Z -            let peer_state = peer_states.entry(peer_addr)
2025-11-09T23:19:32.3088669Z +            let peer_state = peer_states
2025-11-09T23:19:32.3088819Z +                .entry(peer_addr)
2025-11-09T23:19:32.3089083Z                  .or_insert_with(|| bllvm_protocol::network::PeerState::new());
2025-11-09T23:19:32.3089199Z -            
2025-11-09T23:19:32.3089318Z +
2025-11-09T23:19:32.3089469Z              // Create NodeChainAccess
2025-11-09T23:19:32.3089690Z              use crate::network::chain_access::NodeChainAccess;
2025-11-09T23:19:32.3089875Z              let chain_access = NodeChainAccess::new(
2025-11-09T23:19:32.3090332Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2118:
2025-11-09T23:19:32.3093002Z                  storage.transactions(),
2025-11-09T23:19:32.3093194Z                  Arc::clone(mempool_manager),
2025-11-09T23:19:32.3093331Z              );
2025-11-09T23:19:32.3093445Z -            
2025-11-09T23:19:32.3093548Z +
2025-11-09T23:19:32.3093691Z              // Get UTXO set and height
2025-11-09T23:19:32.3093902Z -            let utxo_set = storage.utxos().get_all_utxos()
2025-11-09T23:19:32.3094045Z +            let utxo_set = storage
2025-11-09T23:19:32.3094175Z +                .utxos()
2025-11-09T23:19:32.3094486Z +                .get_all_utxos()
2025-11-09T23:19:32.3094767Z                  .map_err(|e| anyhow::anyhow!("Failed to get UTXO set: {}", e))?;
2025-11-09T23:19:32.3094952Z -            let height = storage.chain().get_height()
2025-11-09T23:19:32.3095086Z +            let height = storage
2025-11-09T23:19:32.3095208Z +                .chain()
2025-11-09T23:19:32.3095337Z +                .get_height()
2025-11-09T23:19:32.3095589Z                  .map_err(|e| anyhow::anyhow!("Failed to get height: {}", e))?
2025-11-09T23:19:32.3095745Z                  .unwrap_or(0);
2025-11-09T23:19:32.3095863Z -            
2025-11-09T23:19:32.3095973Z +
2025-11-09T23:19:32.3096155Z              // Process message with protocol layer
2025-11-09T23:19:32.3096492Z              use bllvm_protocol::network::{process_network_message, ChainStateAccess};
2025-11-09T23:19:32.3096642Z              match process_network_message(
2025-11-09T23:19:32.3097094Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2140:
2025-11-09T23:19:32.3097372Z                      // Convert response to wire format and send via transport layer
2025-11-09T23:19:32.3097594Z                      use crate::network::message_bridge::MessageBridge;
2025-11-09T23:19:32.3097800Z                      use crate::network::transport::TransportType;
2025-11-09T23:19:32.3098251Z -                    if let Ok(wire_messages) = MessageBridge::extract_send_messages(&response, TransportType::Tcp) {
2025-11-09T23:19:32.3098421Z +                    if let Ok(wire_messages) =
2025-11-09T23:19:32.3098821Z +                        MessageBridge::extract_send_messages(&response, TransportType::Tcp)
2025-11-09T23:19:32.3099190Z +                    {
2025-11-09T23:19:32.3099364Z                          for wire_msg in wire_messages {
2025-11-09T23:19:32.3099624Z                              if let Err(e) = self.send_to_peer(peer_addr, wire_msg).await {
2025-11-09T23:19:32.3099914Z                                  warn!("Failed to send protocol response to {}: {}", peer_addr, e);
2025-11-09T23:19:32.3100361Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2158:
2025-11-09T23:19:32.3102681Z              // Dependencies not set - fall back to old behavior
2025-11-09T23:19:32.3103057Z              debug!("Protocol layer dependencies not set, skipping protocol processing");
2025-11-09T23:19:32.3103174Z          }
2025-11-09T23:19:32.3103287Z -        
2025-11-09T23:19:32.3103481Z +
2025-11-09T23:19:32.3103605Z          Ok(())
2025-11-09T23:19:32.3103715Z      }
2025-11-09T23:19:32.3103830Z  
2025-11-09T23:19:32.3104276Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2360:
2025-11-09T23:19:32.3104662Z          // Handle the request with storage and filter service
2025-11-09T23:19:32.3104899Z          let storage = self.storage.as_ref().map(Arc::clone);
2025-11-09T23:19:32.3105036Z          let response =
2025-11-09T23:19:32.3105493Z -            handle_get_filtered_block(get_filtered_block_msg, storage, Some(&self.filter_service)).await?;
2025-11-09T23:19:32.3105882Z +            handle_get_filtered_block(get_filtered_block_msg, storage, Some(&self.filter_service))
2025-11-09T23:19:32.3106006Z +                .await?;
2025-11-09T23:19:32.3106121Z  
2025-11-09T23:19:32.3106276Z          // Serialize and send response
2025-11-09T23:19:32.3106409Z          let response_wire =
2025-11-09T23:19:32.3106856Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2466:
2025-11-09T23:19:32.3107297Z      /// Handle GetAddr request - return known addresses
2025-11-09T23:19:32.3107599Z      async fn handle_get_addr(&self, peer_addr: SocketAddr) -> Result<()> {
2025-11-09T23:19:32.3107952Z          use crate::network::protocol::{AddrMessage, ProtocolMessage, ProtocolParser};
2025-11-09T23:19:32.3108072Z -        
2025-11-09T23:19:32.3108182Z +
2025-11-09T23:19:32.3108468Z          // Get fresh addresses from database (up to 2500, Bitcoin Core limit)
2025-11-09T23:19:32.3108680Z          let ban_list = self.ban_list.lock().unwrap().clone();
2025-11-09T23:19:32.3108851Z          let connected_peers: Vec<SocketAddr> = {
2025-11-09T23:19:32.3109296Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2473:
2025-11-09T23:19:32.3109492Z              let pm = self.peer_manager.lock().unwrap();
2025-11-09T23:19:32.3109649Z              pm.peer_socket_addresses()
2025-11-09T23:19:32.3109776Z          };
2025-11-09T23:19:32.3109888Z -        
2025-11-09T23:19:32.3110003Z +
2025-11-09T23:19:32.3110134Z          let addresses = {
2025-11-09T23:19:32.3110346Z              let mut db = self.address_database.lock().unwrap();
2025-11-09T23:19:32.3110521Z              let fresh = db.get_fresh_addresses(2500);
2025-11-09T23:19:32.3110956Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2480:
2025-11-09T23:19:32.3111188Z              db.filter_addresses(fresh, &ban_list, &connected_peers)
2025-11-09T23:19:32.3111302Z          };
2025-11-09T23:19:32.3111417Z -        
2025-11-09T23:19:32.3111527Z +
2025-11-09T23:19:32.3111665Z          // Create Addr message
2025-11-09T23:19:32.3111835Z          let addr_msg = AddrMessage { addresses };
2025-11-09T23:19:32.3112041Z          let response = ProtocolMessage::Addr(addr_msg);
2025-11-09T23:19:32.3112468Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2486:
2025-11-09T23:19:32.3112752Z          let wire_msg = ProtocolParser::serialize_message(&response)?;
2025-11-09T23:19:32.3112867Z -        
2025-11-09T23:19:32.3113186Z +
2025-11-09T23:19:32.3113320Z          // Send response
2025-11-09T23:19:32.3113528Z          self.send_to_peer(peer_addr, wire_msg).await?;
2025-11-09T23:19:32.3113650Z          Ok(())
2025-11-09T23:19:32.3114077Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2493:
2025-11-09T23:19:32.3114917Z      /// Handle Addr message - store addresses and optionally relay
2025-11-09T23:19:32.3115277Z      async fn handle_addr(&self, peer_addr: SocketAddr, msg: AddrMessage) -> Result<()> {
2025-11-09T23:19:32.3115475Z          use crate::network::protocol::NetworkAddress;
2025-11-09T23:19:32.3115583Z -        
2025-11-09T23:19:32.3115696Z +
2025-11-09T23:19:32.3115853Z          // Get peer services from peer state
2025-11-09T23:19:32.3115986Z          let peer_services = {
2025-11-09T23:19:32.3116202Z              let peer_states = self.peer_states.lock().unwrap();
2025-11-09T23:19:32.3116642Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2502:
2025-11-09T23:19:32.3116798Z                  .map(|state| state.services)
2025-11-09T23:19:32.3116930Z                  .unwrap_or(0)
2025-11-09T23:19:32.3117049Z          };
2025-11-09T23:19:32.3117161Z -        
2025-11-09T23:19:32.3117275Z +
2025-11-09T23:19:32.3117427Z          // Store addresses in database
2025-11-09T23:19:32.3117533Z          {
2025-11-09T23:19:32.3117731Z              let mut db = self.address_database.lock().unwrap();
2025-11-09T23:19:32.3118165Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2510:
2025-11-09T23:19:32.3118353Z                  db.add_address(addr.clone(), peer_services);
2025-11-09T23:19:32.3118464Z              }
2025-11-09T23:19:32.3118567Z          }
2025-11-09T23:19:32.3118683Z -        
2025-11-09T23:19:32.3118784Z +
2025-11-09T23:19:32.3118993Z          // Relay addresses to other peers (with rate limiting)
2025-11-09T23:19:32.3119453Z          self.relay_addresses(peer_addr, &msg.addresses).await?;
2025-11-09T23:19:32.3119586Z -        
2025-11-09T23:19:32.3119702Z +
2025-11-09T23:19:32.3119819Z          Ok(())
2025-11-09T23:19:32.3119938Z      }
2025-11-09T23:19:32.3120050Z  
2025-11-09T23:19:32.3120500Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2525:
2025-11-09T23:19:32.3121016Z      ) -> Result<()> {
2025-11-09T23:19:32.3121398Z          use crate::network::protocol::{AddrMessage, ProtocolMessage, ProtocolParser};
2025-11-09T23:19:32.3121580Z          use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:19:32.3121694Z -        
2025-11-09T23:19:32.3121804Z +
2025-11-09T23:19:32.3122186Z          // Rate limiting: don't send addr messages too frequently (Bitcoin Core: ~every 2.4 hours)
2025-11-09T23:19:32.3122345Z          let now = SystemTime::now()
2025-11-09T23:19:32.3122510Z              .duration_since(UNIX_EPOCH)
2025-11-09T23:19:32.3122977Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2532:
2025-11-09T23:19:32.3123112Z              .unwrap()
2025-11-09T23:19:32.3123243Z              .as_secs();
2025-11-09T23:19:32.3123490Z          let min_interval = 2 * 60 * 60 + 24 * 60; // 2.4 hours in seconds
2025-11-09T23:19:32.3123604Z -        
2025-11-09T23:19:32.3123717Z +
2025-11-09T23:19:32.3123840Z          {
2025-11-09T23:19:32.3124066Z              let last_sent = *self.last_addr_sent.lock().unwrap();
2025-11-09T23:19:32.3124272Z              if now.saturating_sub(last_sent) < min_interval {
2025-11-09T23:19:32.3124936Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2540:
2025-11-09T23:19:32.3125075Z                  return Ok(());
2025-11-09T23:19:32.3125195Z              }
2025-11-09T23:19:32.3125308Z          }
2025-11-09T23:19:32.3125428Z -        
2025-11-09T23:19:32.3125536Z +
2025-11-09T23:19:32.3125804Z          // Filter addresses (exclude local, banned, already connected)
2025-11-09T23:19:32.3126041Z          let ban_list = self.ban_list.lock().unwrap().clone();
2025-11-09T23:19:32.3127068Z          let connected_peers: Vec<SocketAddr> = {
2025-11-09T23:19:32.3127546Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2547:
2025-11-09T23:19:32.3127751Z              let pm = self.peer_manager.lock().unwrap();
2025-11-09T23:19:32.3127912Z              pm.peer_socket_addresses()
2025-11-09T23:19:32.3128031Z          };
2025-11-09T23:19:32.3128145Z -        
2025-11-09T23:19:32.3128257Z +
2025-11-09T23:19:32.3128393Z          let filtered = {
2025-11-09T23:19:32.3128586Z              let db = self.address_database.lock().unwrap();
2025-11-09T23:19:32.3128894Z              db.filter_addresses(addresses.to_vec(), &ban_list, &connected_peers)
2025-11-09T23:19:32.3129345Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2554:
2025-11-09T23:19:32.3129466Z          };
2025-11-09T23:19:32.3129586Z -        
2025-11-09T23:19:32.3129702Z +
2025-11-09T23:19:32.3129853Z          if filtered.is_empty() {
2025-11-09T23:19:32.3129999Z              return Ok(());
2025-11-09T23:19:32.3130113Z          }
2025-11-09T23:19:32.3130552Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2559:
2025-11-09T23:19:32.3130675Z -        
2025-11-09T23:19:32.3130792Z +
2025-11-09T23:19:32.3131035Z          // Limit to 1000 addresses per message (Bitcoin Core limit)
2025-11-09T23:19:32.3131458Z          let addresses_to_relay: Vec<NetworkAddress> = filtered.into_iter().take(1000).collect();
2025-11-09T23:19:32.3131583Z -        
2025-11-09T23:19:32.3131698Z +
2025-11-09T23:19:32.3131837Z          // Create Addr message
2025-11-09T23:19:32.3131990Z          let addr_msg = AddrMessage {
2025-11-09T23:19:32.3132157Z              addresses: addresses_to_relay,
2025-11-09T23:19:32.3133095Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2566:
2025-11-09T23:19:32.3133510Z          };
2025-11-09T23:19:32.3133755Z          let relay_msg = ProtocolMessage::Addr(addr_msg);
2025-11-09T23:19:32.3134037Z          let wire_msg = ProtocolParser::serialize_message(&relay_msg)?;
2025-11-09T23:19:32.3134154Z -        
2025-11-09T23:19:32.3134480Z +
2025-11-09T23:19:32.3134666Z          // Send to all peers except sender
2025-11-09T23:19:32.3134833Z          let peer_addrs: Vec<SocketAddr> = {
2025-11-09T23:19:32.3135067Z              let pm = self.peer_manager.lock().unwrap();
2025-11-09T23:19:32.3135529Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2575:
2025-11-09T23:19:32.3135700Z                  .filter(|addr| *addr != sender_addr)
2025-11-09T23:19:32.3135826Z                  .collect()
2025-11-09T23:19:32.3135950Z          };
2025-11-09T23:19:32.3136065Z -        
2025-11-09T23:19:32.3136174Z +
2025-11-09T23:19:32.3136327Z          for peer_addr in peer_addrs {
2025-11-09T23:19:32.3137004Z              if let Err(e) = self.send_to_peer(peer_addr, wire_msg.clone()).await {
2025-11-09T23:19:32.3137271Z                  warn!("Failed to relay addresses to {}: {}", peer_addr, e);
2025-11-09T23:19:32.3137737Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2582:
2025-11-09T23:19:32.3137866Z              }
2025-11-09T23:19:32.3137983Z          }
2025-11-09T23:19:32.3138095Z -        
2025-11-09T23:19:32.3138200Z +
2025-11-09T23:19:32.3138345Z          // Update last sent time
2025-11-09T23:19:32.3138521Z          *self.last_addr_sent.lock().unwrap() = now;
2025-11-09T23:19:32.3138628Z -        
2025-11-09T23:19:32.3138739Z +
2025-11-09T23:19:32.3138848Z          Ok(())
2025-11-09T23:19:32.3138954Z      }
2025-11-09T23:19:32.3139059Z  
2025-11-09T23:19:32.3139499Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2593:
2025-11-09T23:19:32.3139672Z          if !self.enable_self_advertisement {
2025-11-09T23:19:32.3139869Z              return Ok(()); // Self-advertisement disabled
2025-11-09T23:19:32.3139988Z          }
2025-11-09T23:19:32.3140330Z -        
2025-11-09T23:19:32.3140810Z -        use crate::network::protocol::{AddrMessage, NetworkAddress, ProtocolMessage, ProtocolParser};
2025-11-09T23:19:32.3140933Z +
2025-11-09T23:19:32.3141096Z +        use crate::network::protocol::{
2025-11-09T23:19:32.3141391Z +            AddrMessage, NetworkAddress, ProtocolMessage, ProtocolParser,
2025-11-09T23:19:32.3141502Z +        };
2025-11-09T23:19:32.3141648Z          use std::net::IpAddr;
2025-11-09T23:19:32.3141759Z -        
2025-11-09T23:19:32.3141871Z +
2025-11-09T23:19:32.3142041Z          // Convert SocketAddr to NetworkAddress
2025-11-09T23:19:32.3142218Z          let ip_bytes = match listen_addr.ip() {
2025-11-09T23:19:32.3142365Z              IpAddr::V4(ipv4) => {
2025-11-09T23:19:32.3142816Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2607:
2025-11-09T23:19:32.3143037Z                  bytes[12..16].copy_from_slice(&ipv4.octets());
2025-11-09T23:19:32.3143158Z                  bytes
2025-11-09T23:19:32.3143280Z              }
2025-11-09T23:19:32.3143428Z -            IpAddr::V6(ipv6) => {
2025-11-09T23:19:32.3143562Z -                ipv6.octets()
2025-11-09T23:19:32.3143676Z -            }
2025-11-09T23:19:32.3143843Z +            IpAddr::V6(ipv6) => ipv6.octets(),
2025-11-09T23:19:32.3143966Z          };
2025-11-09T23:19:32.3144078Z -        
2025-11-09T23:19:32.3144189Z +
2025-11-09T23:19:32.3144540Z          let our_addr = NetworkAddress {
2025-11-09T23:19:32.3144673Z              services,
2025-11-09T23:19:32.3144803Z              ip: ip_bytes,
2025-11-09T23:19:32.3145250Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2618:
2025-11-09T23:19:32.3145414Z              port: listen_addr.port(),
2025-11-09T23:19:32.3145531Z          };
2025-11-09T23:19:32.3145653Z -        
2025-11-09T23:19:32.3145780Z +
2025-11-09T23:19:32.3146204Z          // Create Addr message with just our address
2025-11-09T23:19:32.3146360Z          let addr_msg = AddrMessage {
2025-11-09T23:19:32.3146532Z              addresses: vec![our_addr.clone()],
2025-11-09T23:19:32.3146985Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2624:
2025-11-09T23:19:32.3147104Z          };
2025-11-09T23:19:32.3147393Z          let relay_msg = ProtocolMessage::Addr(addr_msg);
2025-11-09T23:19:32.3147680Z          let wire_msg = ProtocolParser::serialize_message(&relay_msg)?;
2025-11-09T23:19:32.3147794Z -        
2025-11-09T23:19:32.3147903Z +
2025-11-09T23:19:32.3148077Z          // Send to all connected peers
2025-11-09T23:19:32.3148241Z          let peer_addrs: Vec<SocketAddr> = {
2025-11-09T23:19:32.3148436Z              let pm = self.peer_manager.lock().unwrap();
2025-11-09T23:19:32.3150556Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2631:
2025-11-09T23:19:32.3151080Z              pm.peer_socket_addresses()
2025-11-09T23:19:32.3151223Z          };
2025-11-09T23:19:32.3157209Z -        
2025-11-09T23:19:32.3157370Z +
2025-11-09T23:19:32.3157564Z          for peer_addr in peer_addrs {
2025-11-09T23:19:32.3157858Z              if let Err(e) = self.send_to_peer(peer_addr, wire_msg.clone()).await {
2025-11-09T23:19:32.3158098Z                  warn!("Failed to advertise self to {}: {}", peer_addr, e);
2025-11-09T23:19:32.3158556Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2637:
2025-11-09T23:19:32.3158678Z              }
2025-11-09T23:19:32.3158796Z          }
2025-11-09T23:19:32.3158924Z -        
2025-11-09T23:19:32.3159037Z +
2025-11-09T23:19:32.3159212Z          // Also store our own address in database
2025-11-09T23:19:32.3159328Z          {
2025-11-09T23:19:32.3159556Z              let mut db = self.address_database.lock().unwrap();
2025-11-09T23:19:32.3160014Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2643:
2025-11-09T23:19:32.3160200Z              db.add_address(our_addr, services);
2025-11-09T23:19:32.3160330Z          }
2025-11-09T23:19:32.3160772Z -        
2025-11-09T23:19:32.3160892Z +
2025-11-09T23:19:32.3161015Z          Ok(())
2025-11-09T23:19:32.3161136Z      }
2025-11-09T23:19:32.3161249Z  
2025-11-09T23:19:32.3161716Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2649:
2025-11-09T23:19:32.3161877Z      /// Get list of banned peers
2025-11-09T23:19:32.3162132Z      pub fn get_banned_peers(&self) -> Vec<(SocketAddr, u64)> {
2025-11-09T23:19:32.3162329Z          let ban_list = self.ban_list.lock().unwrap();
2025-11-09T23:19:32.3162624Z -        ban_list.iter().map(|(addr, timestamp)| (*addr, *timestamp)).collect()
2025-11-09T23:19:32.3162761Z +        ban_list
2025-11-09T23:19:32.3162882Z +            .iter()
2025-11-09T23:19:32.3163074Z +            .map(|(addr, timestamp)| (*addr, *timestamp))
2025-11-09T23:19:32.3163209Z +            .collect()
2025-11-09T23:19:32.3163332Z      }
2025-11-09T23:19:32.3163445Z  
2025-11-09T23:19:32.3163633Z      /// Get peer addresses (async version for RPC)
2025-11-09T23:19:32.3164105Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2714:
2025-11-09T23:19:32.3164250Z          peer_addr: SocketAddr,
2025-11-09T23:19:32.3164664Z          msg: crate::network::protocol::GetBanListMessage,
2025-11-09T23:19:32.3164792Z      ) -> Result<()> {
2025-11-09T23:19:32.3165117Z -        use crate::network::protocol::{BanEntry, BanListMessage, NetworkAddress};
2025-11-09T23:19:32.3165379Z          use crate::network::ban_list_merging::calculate_ban_list_hash;
2025-11-09T23:19:32.3165711Z +        use crate::network::protocol::{BanEntry, BanListMessage, NetworkAddress};
2025-11-09T23:19:32.3165898Z          use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:19:32.3166013Z  
2025-11-09T23:19:32.3166292Z -        debug!("GetBanList request from {}: full={}, min_duration={}", 
2025-11-09T23:19:32.3168652Z -               peer_addr, msg.request_full, msg.min_ban_duration);
2025-11-09T23:19:32.3168776Z +        debug!(
2025-11-09T23:19:32.3169027Z +            "GetBanList request from {}: full={}, min_duration={}",
2025-11-09T23:19:32.3169243Z +            peer_addr, msg.request_full, msg.min_ban_duration
2025-11-09T23:19:32.3169357Z +        );
2025-11-09T23:19:32.3169464Z  
2025-11-09T23:19:32.3169610Z          // Get current ban list
2025-11-09T23:19:32.3169798Z          let ban_list = self.ban_list.lock().unwrap();
2025-11-09T23:19:32.3170246Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2776:
2025-11-09T23:19:32.3170828Z          let response = BanListMessage {
2025-11-09T23:19:32.3171016Z              is_full: msg.request_full,
2025-11-09T23:19:32.3171149Z              ban_list_hash,
2025-11-09T23:19:32.3171468Z -            ban_entries: if msg.request_full { ban_entries } else { Vec::new() },
2025-11-09T23:19:32.3171645Z +            ban_entries: if msg.request_full {
2025-11-09T23:19:32.3171788Z +                ban_entries
2025-11-09T23:19:32.3171909Z +            } else {
2025-11-09T23:19:32.3172054Z +                Vec::new()
2025-11-09T23:19:32.3172183Z +            },
2025-11-09T23:19:32.3172318Z              timestamp: now,
2025-11-09T23:19:32.3172430Z          };
2025-11-09T23:19:32.3172554Z  
2025-11-09T23:19:32.3173019Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2785:
2025-11-09T23:19:32.3173352Z          let serialized = ProtocolParser::serialize_message(&response_msg)?;
2025-11-09T23:19:32.3173568Z          self.send_to_peer(peer_addr, serialized).await?;
2025-11-09T23:19:32.3173684Z  
2025-11-09T23:19:32.3173951Z -        debug!("Sent BanList response to {}: {} entries", peer_addr, 
2025-11-09T23:19:32.3174179Z -               if msg.request_full { ban_entries.len() } else { 0 });
2025-11-09T23:19:32.3174305Z +        debug!(
2025-11-09T23:19:32.3174656Z +            "Sent BanList response to {}: {} entries",
2025-11-09T23:19:32.3174801Z +            peer_addr,
2025-11-09T23:19:32.3174952Z +            if msg.request_full {
2025-11-09T23:19:32.3175355Z +                ban_entries.len()
2025-11-09T23:19:32.3175481Z +            } else {
2025-11-09T23:19:32.3175601Z +                0
2025-11-09T23:19:32.3175722Z +            }
2025-11-09T23:19:32.3175838Z +        );
2025-11-09T23:19:32.3175951Z  
2025-11-09T23:19:32.3176077Z          Ok(())
2025-11-09T23:19:32.3176193Z      }
2025-11-09T23:19:32.3176652Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2800:
2025-11-09T23:19:32.3177009Z          use crate::network::ban_list_merging::{validate_ban_entry, verify_ban_list_hash};
2025-11-09T23:19:32.3177165Z          use std::net::IpAddr;
2025-11-09T23:19:32.3177277Z  
2025-11-09T23:19:32.3177509Z -        debug!("BanList received from {}: full={}, {} entries", 
2025-11-09T23:19:32.3177723Z -               peer_addr, msg.is_full, msg.ban_entries.len());
2025-11-09T23:19:32.3179768Z +        debug!(
2025-11-09T23:19:32.3179970Z +            "BanList received from {}: full={}, {} entries",
2025-11-09T23:19:32.3180107Z +            peer_addr,
2025-11-09T23:19:32.3180229Z +            msg.is_full,
2025-11-09T23:19:32.3180371Z +            msg.ban_entries.len()
2025-11-09T23:19:32.3180490Z +        );
2025-11-09T23:19:32.3180610Z  
2025-11-09T23:19:32.3180778Z          // Verify hash if full list provided
2025-11-09T23:19:32.3180910Z          if msg.is_full {
2025-11-09T23:19:32.3181362Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2813:
2025-11-09T23:19:32.3181488Z  
2025-11-09T23:19:32.3181748Z          // If hash-only, we can't merge (would need to request full list)
2025-11-09T23:19:32.3181881Z          if !msg.is_full {
2025-11-09T23:19:32.3182210Z -            debug!("Received hash-only ban list from {}, skipping merge", peer_addr);
2025-11-09T23:19:32.3182331Z +            debug!(
2025-11-09T23:19:32.3182569Z +                "Received hash-only ban list from {}, skipping merge",
2025-11-09T23:19:32.3182937Z +                peer_addr
2025-11-09T23:19:32.3183065Z +            );
2025-11-09T23:19:32.3183194Z              return Ok(());
2025-11-09T23:19:32.3183308Z          }
2025-11-09T23:19:32.3183427Z  
2025-11-09T23:19:32.3183944Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2831:
2025-11-09T23:19:32.3184109Z                  // IPv4-mapped IPv6 address
2025-11-09T23:19:32.3184299Z                  let ipv4_bytes = &entry.addr.ip[12..16];
2025-11-09T23:19:32.3184641Z                  IpAddr::V4(std::net::Ipv4Addr::new(
2025-11-09T23:19:32.3184879Z -                    ipv4_bytes[0], ipv4_bytes[1], ipv4_bytes[2], ipv4_bytes[3]
2025-11-09T23:19:32.3185027Z +                    ipv4_bytes[0],
2025-11-09T23:19:32.3185163Z +                    ipv4_bytes[1],
2025-11-09T23:19:32.3185294Z +                    ipv4_bytes[2],
2025-11-09T23:19:32.3185424Z +                    ipv4_bytes[3],
2025-11-09T23:19:32.3185561Z                  ))
2025-11-09T23:19:32.3185682Z              } else {
2025-11-09T23:19:32.3185816Z                  // IPv6 address
2025-11-09T23:19:32.3186287Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2882:
2025-11-09T23:19:32.3186421Z              ban_list.len()
2025-11-09T23:19:32.3186529Z          };
2025-11-09T23:19:32.3186798Z          let resource_metrics = self.dos_protection.get_metrics().await;
2025-11-09T23:19:32.3186928Z -        
2025-11-09T23:19:32.3187042Z +
2025-11-09T23:19:32.3187222Z          crate::node::metrics::NetworkMetrics {
2025-11-09T23:19:32.3187397Z              peer_count: active_connections,
2025-11-09T23:19:32.3188060Z              bytes_sent: sent,
2025-11-09T23:19:32.3188541Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2889:
2025-11-09T23:19:32.3188700Z              bytes_received: received,
2025-11-09T23:19:32.3188907Z -            messages_sent: 0, // Would need to track this
2025-11-09T23:19:32.3189434Z +            messages_sent: 0,     // Would need to track this
2025-11-09T23:19:32.3189647Z              messages_received: 0, // Would need to track this
2025-11-09T23:19:32.3190043Z              active_connections,
2025-11-09T23:19:32.3190217Z              banned_peers: banned_peers_count,
2025-11-09T23:19:32.3190666Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2894:
2025-11-09T23:19:32.3190897Z              connection_attempts: 0, // Would need to track this
2025-11-09T23:19:32.3191113Z              connection_failures: 0, // Would need to track this
2025-11-09T23:19:32.3191340Z              dos_protection: crate::node::metrics::DosMetrics {
2025-11-09T23:19:32.3191604Z -                connection_rate_violations: 0, // Would need to track this
2025-11-09T23:19:32.3191787Z -                auto_bans: 0, // Would need to track this
2025-11-09T23:19:32.3192025Z -                message_queue_overflows: 0, // Would need to track this
2025-11-09T23:19:32.3192300Z +                connection_rate_violations: 0,   // Would need to track this
2025-11-09T23:19:32.3192529Z +                auto_bans: 0,                    // Would need to track this
2025-11-09T23:19:32.3192782Z +                message_queue_overflows: 0,      // Would need to track this
2025-11-09T23:19:32.3193035Z                  active_connection_limit_hits: 0, // Would need to track this
2025-11-09T23:19:32.3193290Z -                resource_exhaustion_events: 0, // Would need to track this
2025-11-09T23:19:32.3193552Z +                resource_exhaustion_events: 0,   // Would need to track this
2025-11-09T23:19:32.3193671Z              },
2025-11-09T23:19:32.3193791Z          }
2025-11-09T23:19:32.3193906Z      }
2025-11-09T23:19:32.3194512Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2913:
2025-11-09T23:19:32.3194704Z      /// Create version message with service flags
2025-11-09T23:19:32.3194830Z      ///
2025-11-09T23:19:32.3195398Z      /// Creates version message with service flags for all supported features
2025-11-09T23:19:32.3195516Z -    /// 
2025-11-09T23:19:32.3195645Z +    ///
2025-11-09T23:19:32.3195795Z      /// Sets service flags based on:
2025-11-09T23:19:32.3196118Z      /// - BIP157: NODE_COMPACT_FILTERS (always enabled if filter service exists)
2025-11-09T23:19:32.3196378Z      /// - UTXO Commitments: NODE_UTXO_COMMITMENTS (if feature enabled)
2025-11-09T23:19:32.3196837Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2937:
2025-11-09T23:19:32.3196950Z  
2025-11-09T23:19:32.3197133Z          // Add service flags for supported features
2025-11-09T23:19:32.3197317Z          let mut services_with_filters = services;
2025-11-09T23:19:32.3197428Z -        
2025-11-09T23:19:32.3197538Z +
2025-11-09T23:19:32.3197852Z          // BIP157 Compact Block Filters (always enabled if filter service exists)
2025-11-09T23:19:32.3198067Z          services_with_filters |= NODE_COMPACT_FILTERS;
2025-11-09T23:19:32.3198189Z -        
2025-11-09T23:19:32.3198295Z +
2025-11-09T23:19:32.3198470Z          // UTXO Commitments (if feature enabled)
2025-11-09T23:19:32.3198644Z          #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.3198757Z          {
2025-11-09T23:19:32.3199208Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2947:
2025-11-09T23:19:32.3199560Z              services_with_filters |= crate::network::protocol::NODE_UTXO_COMMITMENTS;
2025-11-09T23:19:32.3199667Z          }
2025-11-09T23:19:32.3199772Z -        
2025-11-09T23:19:32.3199879Z +
2025-11-09T23:19:32.3200027Z          // Ban List Sharing (if config enabled)
2025-11-09T23:19:32.3200204Z          if self.ban_list_sharing_config.is_some() {
2025-11-09T23:19:32.3200549Z              services_with_filters |= crate::network::protocol::NODE_BAN_LIST_SHARING;
2025-11-09T23:19:32.3201000Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2953:
2025-11-09T23:19:32.3201385Z          }
2025-11-09T23:19:32.3201508Z -        
2025-11-09T23:19:32.3201619Z +
2025-11-09T23:19:32.3202014Z          // Dandelion (if feature enabled)
2025-11-09T23:19:32.3202168Z          #[cfg(feature = "dandelion")]
2025-11-09T23:19:32.3202294Z          {
2025-11-09T23:19:32.3202756Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2958:
2025-11-09T23:19:32.3203073Z              services_with_filters |= crate::network::protocol::NODE_DANDELION;
2025-11-09T23:19:32.3203196Z          }
2025-11-09T23:19:32.3203313Z -        
2025-11-09T23:19:32.3203426Z +
2025-11-09T23:19:32.3203604Z          // Package Relay (BIP331) - always enabled
2025-11-09T23:19:32.3203940Z          services_with_filters |= crate::network::protocol::NODE_PACKAGE_RELAY;
2025-11-09T23:19:32.3204048Z -        
2025-11-09T23:19:32.3204146Z +
2025-11-09T23:19:32.3204295Z          // FIBRE - always enabled
2025-11-09T23:19:32.3204729Z          services_with_filters |= crate::network::protocol::NODE_FIBRE;
2025-11-09T23:19:32.3204854Z  
2025-11-09T23:19:32.3205381Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/package_relay.rs:138:
2025-11-09T23:19:32.3205731Z      pub fn new(transactions: Vec<Transaction>) -> Result<Self, PackageError> {
2025-11-09T23:19:32.3205927Z          Self::new_with_utxo_set(transactions, None)
2025-11-09T23:19:32.3206042Z      }
2025-11-09T23:19:32.3206162Z -    
2025-11-09T23:19:32.3206283Z +
2025-11-09T23:19:32.3206590Z      /// Create a new transaction package with UTXO set for fee calculation
2025-11-09T23:19:32.3206737Z      pub fn new_with_utxo_set(
2025-11-09T23:19:32.3206892Z          transactions: Vec<Transaction>,
2025-11-09T23:19:32.3207816Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/package_relay.rs:168:
2025-11-09T23:19:32.3208055Z          // Calculate combined fee from UTXO set if provided
2025-11-09T23:19:32.3208296Z          let combined_fee = if let Some(utxo_set) = utxo_set {
2025-11-09T23:19:32.3208824Z              // Calculate fee for each transaction: sum(inputs) - sum(outputs)
2025-11-09T23:19:32.3209008Z -            transactions.iter().map(|tx| {
2025-11-09T23:19:32.3209200Z -                let input_total: u64 = tx.inputs.iter()
2025-11-09T23:19:32.3209404Z -                    .filter_map(|inp| utxo_set.get(&inp.prevout))
2025-11-09T23:19:32.3209571Z -                    .map(|utxo| utxo.value as u64)
2025-11-09T23:19:32.3209706Z -                    .sum();
2025-11-09T23:19:32.3209896Z -                let output_total: u64 = tx.outputs.iter()
2025-11-09T23:19:32.3210055Z -                    .map(|out| out.value as u64)
2025-11-09T23:19:32.3210175Z -                    .sum();
2025-11-09T23:19:32.3210344Z -                if input_total > output_total {
2025-11-09T23:19:32.3210878Z -                    input_total - output_total
2025-11-09T23:19:32.3211022Z -                } else {
2025-11-09T23:19:32.3211153Z -                    0
2025-11-09T23:19:32.3211287Z -                }
2025-11-09T23:19:32.3211408Z -            }).sum()
2025-11-09T23:19:32.3211539Z +            transactions
2025-11-09T23:19:32.3211678Z +                .iter()
2025-11-09T23:19:32.3211809Z +                .map(|tx| {
2025-11-09T23:19:32.3211967Z +                    let input_total: u64 = tx
2025-11-09T23:19:32.3212109Z +                        .inputs
2025-11-09T23:19:32.3212238Z +                        .iter()
2025-11-09T23:19:32.3212448Z +                        .filter_map(|inp| utxo_set.get(&inp.prevout))
2025-11-09T23:19:32.3212615Z +                        .map(|utxo| utxo.value as u64)
2025-11-09T23:19:32.3212753Z +                        .sum();
2025-11-09T23:19:32.3213088Z +                    let output_total: u64 = tx.outputs.iter().map(|out| out.value as u64).sum();
2025-11-09T23:19:32.3213255Z +                    if input_total > output_total {
2025-11-09T23:19:32.3213428Z +                        input_total - output_total
2025-11-09T23:19:32.3213554Z +                    } else {
2025-11-09T23:19:32.3213686Z +                        0
2025-11-09T23:19:32.3213814Z +                    }
2025-11-09T23:19:32.3214166Z +                })
2025-11-09T23:19:32.3214287Z +                .sum()
2025-11-09T23:19:32.3214572Z          } else {
2025-11-09T23:19:32.3214755Z              0 // Fee calculation requires UTXO set
2025-11-09T23:19:32.3214863Z          };
2025-11-09T23:19:32.3215297Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:4:
2025-11-09T23:19:32.3215423Z  
2025-11-09T23:19:32.3215572Z  use anyhow::Result;
2025-11-09T23:19:32.3215722Z  use std::net::SocketAddr;
2025-11-09T23:19:32.3215851Z +use std::sync::Arc;
2025-11-09T23:19:32.3216034Z  use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:19:32.3216175Z  use tokio::sync::mpsc;
2025-11-09T23:19:32.3216333Z  use tracing::{debug, info, warn};
2025-11-09T23:19:32.3216787Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:10:
2025-11-09T23:19:32.3216933Z -use std::sync::Arc;
2025-11-09T23:19:32.3217047Z  
2025-11-09T23:19:32.3217326Z +use super::transport::{TransportAddr, TransportConnection};
2025-11-09T23:19:32.3217494Z  use super::NetworkMessage;
2025-11-09T23:19:32.3217760Z -use super::transport::{TransportConnection, TransportAddr};
2025-11-09T23:19:32.3217875Z  
2025-11-09T23:19:32.3218029Z  /// Peer connection state
2025-11-09T23:19:32.3218140Z -/// 
2025-11-09T23:19:32.3218252Z +///
2025-11-09T23:19:32.3218650Z  /// Supports multiple transport types (TCP, Quinn, Iroh) via TransportConnection trait
2025-11-09T23:19:32.3218794Z  pub struct Peer {
2025-11-09T23:19:32.3218923Z      addr: SocketAddr,
2025-11-09T23:19:32.3219369Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:48:
2025-11-09T23:19:32.3219492Z  
2025-11-09T23:19:32.3219619Z  impl Peer {
2025-11-09T23:19:32.3219867Z      /// Create a new peer connection from a TransportConnection
2025-11-09T23:19:32.3219984Z -    /// 
2025-11-09T23:19:32.3220307Z +    ///
2025-11-09T23:19:32.3220659Z      /// This is the preferred method as it supports all transport types (TCP, Quinn, Iroh).
2025-11-09T23:19:32.3220937Z      /// The connection is managed via channels for concurrent read/write.
2025-11-09T23:19:32.3222726Z      pub fn from_transport_connection<C: TransportConnection + 'static>(
2025-11-09T23:19:32.3223139Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:59:
2025-11-09T23:19:32.3223249Z      ) -> Self {
2025-11-09T23:19:32.3223407Z          // Create channel for sending messages
2025-11-09T23:19:32.3223637Z          let (send_tx, send_rx) = mpsc::unbounded_channel::<Vec<u8>>();
2025-11-09T23:19:32.3223743Z -        
2025-11-09T23:19:32.3223846Z +
2025-11-09T23:19:32.3224045Z          let transport_addr_clone = transport_addr.clone();
2025-11-09T23:19:32.3224202Z          let message_tx_clone = message_tx.clone();
2025-11-09T23:19:32.3224457Z -        
2025-11-09T23:19:32.3224577Z +
2025-11-09T23:19:32.3224874Z          // Wrap connection in Arc<Mutex> to share between read and write tasks
2025-11-09T23:19:32.3225006Z          use std::sync::Arc;
2025-11-09T23:19:32.3225149Z          use tokio::sync::Mutex;
2025-11-09T23:19:32.3225552Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:69:
2025-11-09T23:19:32.3225702Z          let conn = Arc::new(Mutex::new(conn));
2025-11-09T23:19:32.3225844Z          let conn_read = Arc::clone(&conn);
2025-11-09T23:19:32.3225993Z          let conn_write = Arc::clone(&conn);
2025-11-09T23:19:32.3226096Z -        
2025-11-09T23:19:32.3226195Z +
2025-11-09T23:19:32.3226416Z          // Spawn read task using TransportConnection::recv
2025-11-09T23:19:32.3226574Z          tokio::spawn(async move {
2025-11-09T23:19:32.3226694Z              loop {
2025-11-09T23:19:32.3227138Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:83:
2025-11-09T23:19:32.3227271Z                          }
2025-11-09T23:19:32.3227401Z                      }
2025-11-09T23:19:32.3227523Z                  };
2025-11-09T23:19:32.3227642Z -                
2025-11-09T23:19:32.3228006Z +
2025-11-09T23:19:32.3228154Z                  if data.is_empty() {
2025-11-09T23:19:32.3228273Z                      break;
2025-11-09T23:19:32.3228387Z                  }
2025-11-09T23:19:32.3228846Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:90:
2025-11-09T23:19:32.3228956Z -                
2025-11-09T23:19:32.3229059Z +
2025-11-09T23:19:32.3229258Z                  let peer_addr = match &transport_addr_clone {
2025-11-09T23:19:32.3229558Z                      super::transport::TransportAddr::Tcp(sock) => *sock,
2025-11-09T23:19:32.3229706Z                      #[cfg(feature = "quinn")]
2025-11-09T23:19:32.3231830Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:100:
2025-11-09T23:19:32.3232248Z                  let _ = message_tx_clone.send(NetworkMessage::RawMessageReceived(data, peer_addr));
2025-11-09T23:19:32.3232371Z              }
2025-11-09T23:19:32.3232485Z          });
2025-11-09T23:19:32.3232605Z -        
2025-11-09T23:19:32.3232728Z +
2025-11-09T23:19:32.3232965Z          // Spawn write task using TransportConnection::send
2025-11-09T23:19:32.3233124Z          tokio::spawn(async move {
2025-11-09T23:19:32.3233263Z              let mut send_rx = send_rx;
2025-11-09T23:19:32.3233703Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:107:
2025-11-09T23:19:32.3233820Z -            
2025-11-09T23:19:32.3233926Z +
2025-11-09T23:19:32.3234039Z              loop {
2025-11-09T23:19:32.3234186Z                  match send_rx.recv().await {
2025-11-09T23:19:32.3234487Z                      Some(data) => {
2025-11-09T23:19:32.3234925Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:124:
2025-11-09T23:19:32.3235037Z                      }
2025-11-09T23:19:32.3235151Z                  }
2025-11-09T23:19:32.3235461Z              }
2025-11-09T23:19:32.3235569Z -            
2025-11-09T23:19:32.3235673Z +
2025-11-09T23:19:32.3235882Z              // Gracefully close connection on write task exit
2025-11-09T23:19:32.3236100Z              // Connection will be closed when conn_guard is dropped
2025-11-09T23:19:32.3236209Z          });
2025-11-09T23:19:32.3236637Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:131:
2025-11-09T23:19:32.3236744Z -        
2025-11-09T23:19:32.3236848Z +
2025-11-09T23:19:32.3236993Z          let now = SystemTime::now()
2025-11-09T23:19:32.3237149Z              .duration_since(UNIX_EPOCH)
2025-11-09T23:19:32.3237267Z              .unwrap()
2025-11-09T23:19:32.3237704Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:135:
2025-11-09T23:19:32.3237843Z              .as_secs();
2025-11-09T23:19:32.3237956Z -        
2025-11-09T23:19:32.3238063Z +
2025-11-09T23:19:32.3238172Z          Self {
2025-11-09T23:19:32.3238296Z              addr,
2025-11-09T23:19:32.3238430Z              transport_addr,
2025-11-09T23:19:32.3238861Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:153:
2025-11-09T23:19:32.3239019Z              last_tx_received: None,
2025-11-09T23:19:32.3239126Z          }
2025-11-09T23:19:32.3241074Z      }
2025-11-09T23:19:32.3241190Z -    
2025-11-09T23:19:32.3241303Z +
2025-11-09T23:19:32.3241636Z      /// Create a new peer connection from a TCP stream (backward compatibility)
2025-11-09T23:19:32.3241759Z -    /// 
2025-11-09T23:19:32.3241886Z +    ///
2025-11-09T23:19:32.3242214Z      /// This is a convenience method that wraps a TcpStream in a TcpConnection.
2025-11-09T23:19:32.3242610Z      #[deprecated(note = "Use from_transport_connection instead for transport abstraction")]
2025-11-09T23:19:32.3242746Z      pub fn new(
2025-11-09T23:19:32.3243192Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:165:
2025-11-09T23:19:32.3243327Z      ) -> Self {
2025-11-09T23:19:32.3243522Z          use super::tcp_transport::TcpConnection;
2025-11-09T23:19:32.3243992Z          use super::transport::TransportAddr;
2025-11-09T23:19:32.3244105Z -        
2025-11-09T23:19:32.3244216Z +
2025-11-09T23:19:32.3244619Z          let peer_addr = stream.peer_addr().unwrap_or(addr);
2025-11-09T23:19:32.3244776Z          let tcp_conn = TcpConnection {
2025-11-09T23:19:32.3244895Z              stream,
2025-11-09T23:19:32.3245342Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:172:
2025-11-09T23:19:32.3245548Z              peer_addr: TransportAddr::Tcp(peer_addr),
2025-11-09T23:19:32.3245687Z              connected: true,
2025-11-09T23:19:32.3245896Z          };
2025-11-09T23:19:32.3246023Z -        
2025-11-09T23:19:32.3246137Z +
2025-11-09T23:19:32.3246609Z          Self::from_transport_connection(tcp_conn, addr, TransportAddr::Tcp(addr), message_tx)
2025-11-09T23:19:32.3246729Z      }
2025-11-09T23:19:32.3246848Z  
2025-11-09T23:19:32.3247292Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:189:
2025-11-09T23:19:32.3247474Z          self.handle_peer_communication().await?;
2025-11-09T23:19:32.3247589Z  
2025-11-09T23:19:32.3247748Z          // Send disconnection notification
2025-11-09T23:19:32.3247873Z -        let _ = self
2025-11-09T23:19:32.3248003Z -            .message_tx
2025-11-09T23:19:32.3248342Z -            .send(NetworkMessage::PeerDisconnected(self.transport_addr.clone()));
2025-11-09T23:19:32.3248615Z +        let _ = self.message_tx.send(NetworkMessage::PeerDisconnected(
2025-11-09T23:19:32.3248772Z +            self.transport_addr.clone(),
2025-11-09T23:19:32.3250777Z +        ));
2025-11-09T23:19:32.3250890Z  
2025-11-09T23:19:32.3251004Z          Ok(())
2025-11-09T23:19:32.3251121Z      }
2025-11-09T23:19:32.3251572Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:198:
2025-11-09T23:19:32.3251685Z  
2025-11-09T23:19:32.3252095Z      /// Handle peer communication loop
2025-11-09T23:19:32.3252219Z -    /// 
2025-11-09T23:19:32.3252339Z +    ///
2025-11-09T23:19:32.3252630Z      /// Note: The read loop is now handled in `new()` via stream splitting.
2025-11-09T23:19:32.3252853Z      /// This method just waits for the connection to close.
2025-11-09T23:19:32.3253115Z      async fn handle_peer_communication(&mut self) -> Result<()> {
2025-11-09T23:19:32.3253563Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:205:
2025-11-09T23:19:32.3253771Z          // We just wait here to detect when connection closes
2025-11-09T23:19:32.3254086Z          // In a real implementation, we'd monitor the read task or connection state
2025-11-09T23:19:32.3254527Z          tokio::time::sleep(tokio::time::Duration::from_secs(1)).await;
2025-11-09T23:19:32.3254651Z -        
2025-11-09T23:19:32.3254771Z +
2025-11-09T23:19:32.3255202Z          // Connection close is automatically detected by the read task in from_transport_connection
2025-11-09T23:19:32.3255588Z          // When recv() returns empty data or error, the task breaks and sends PeerDisconnected
2025-11-09T23:19:32.3255827Z          self.connected = false;
2025-11-09T23:19:32.3256276Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:248:
2025-11-09T23:19:32.3256392Z      }
2025-11-09T23:19:32.3256507Z  
2025-11-09T23:19:32.3256655Z      /// Send a message to the peer
2025-11-09T23:19:32.3256770Z -    /// 
2025-11-09T23:19:32.3256880Z +    ///
2025-11-09T23:19:32.3257141Z      /// Messages are sent via a channel to a background write task.
2025-11-09T23:19:32.3257413Z      pub async fn send_message(&self, message: Vec<u8>) -> Result<()> {
2025-11-09T23:19:32.3257564Z          let message_len = message.len();
2025-11-09T23:19:32.3258097Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol.rs:2:
2025-11-09T23:19:32.3258204Z  //!
2025-11-09T23:19:32.3258564Z  //! Implements Bitcoin P2P protocol message serialization and deserialization.
2025-11-09T23:19:32.3258688Z  
2025-11-09T23:19:32.3259133Z -use bllvm_protocol::bip157::NODE_COMPACT_FILTERS;
2025-11-09T23:19:32.3259339Z  use crate::network::transport::TransportType;
2025-11-09T23:19:32.3259472Z  use anyhow::Result;
2025-11-09T23:19:32.3259669Z +use bllvm_protocol::bip157::NODE_COMPACT_FILTERS;
2025-11-09T23:19:32.3259927Z  use bllvm_protocol::{Block, BlockHeader, Hash, Transaction};
2025-11-09T23:19:32.3260108Z  use serde::{Deserialize, Serialize};
2025-11-09T23:19:32.3260221Z  
2025-11-09T23:19:32.3260697Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol.rs:145:
2025-11-09T23:19:32.3260912Z      pub fn supports_utxo_commitments(&self) -> bool {
2025-11-09T23:19:32.3261098Z          (self.services & NODE_UTXO_COMMITMENTS) != 0
2025-11-09T23:19:32.3261212Z      }
2025-11-09T23:19:32.3261328Z -    
2025-11-09T23:19:32.3261442Z +
2025-11-09T23:19:32.3261616Z      /// Check if peer supports ban list sharing
2025-11-09T23:19:32.3261830Z      pub fn supports_ban_list_sharing(&self) -> bool {
2025-11-09T23:19:32.3262026Z          (self.services & NODE_BAN_LIST_SHARING) != 0
2025-11-09T23:19:32.3262491Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol.rs:152:
2025-11-09T23:19:32.3262602Z      }
2025-11-09T23:19:32.3262720Z -    
2025-11-09T23:19:32.3262824Z +
2025-11-09T23:19:32.3263040Z      /// Check if peer supports BIP157 compact block filters
2025-11-09T23:19:32.3263220Z      pub fn supports_compact_filters(&self) -> bool {
2025-11-09T23:19:32.3263437Z          use bllvm_protocol::bip157::NODE_COMPACT_FILTERS;
2025-11-09T23:19:32.3263895Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol.rs:157:
2025-11-09T23:19:32.3264080Z          (self.services & NODE_COMPACT_FILTERS) != 0
2025-11-09T23:19:32.3264197Z      }
2025-11-09T23:19:32.3264603Z -    
2025-11-09T23:19:32.3264734Z +
2025-11-09T23:19:32.3265195Z      /// Check if peer supports package relay (BIP331)
2025-11-09T23:19:32.3265408Z      pub fn supports_package_relay(&self) -> bool {
2025-11-09T23:19:32.3265593Z          (self.services & NODE_PACKAGE_RELAY) != 0
2025-11-09T23:19:32.3266084Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol.rs:163:
2025-11-09T23:19:32.3266219Z      }
2025-11-09T23:19:32.3266332Z -    
2025-11-09T23:19:32.3266443Z +
2025-11-09T23:19:32.3266612Z      /// Check if peer supports FIBRE
2025-11-09T23:19:32.3266779Z      pub fn supports_fibre(&self) -> bool {
2025-11-09T23:19:32.3266936Z          (self.services & NODE_FIBRE) != 0
2025-11-09T23:19:32.3267415Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol.rs:168:
2025-11-09T23:19:32.3267537Z      }
2025-11-09T23:19:32.3267650Z -    
2025-11-09T23:19:32.3267759Z +
2025-11-09T23:19:32.3267912Z      #[cfg(feature = "dandelion")]
2025-11-09T23:19:32.3268070Z      /// Check if peer supports Dandelion
2025-11-09T23:19:32.3268251Z      pub fn supports_dandelion(&self) -> bool {
2025-11-09T23:19:32.3268768Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol_extensions.rs:7:
2025-11-09T23:19:32.3269000Z  //! - FilteredBlock: Response with filtered transactions
2025-11-09T23:19:32.3269108Z  
2025-11-09T23:19:32.3269275Z  use crate::network::protocol::*;
2025-11-09T23:19:32.3269427Z -use crate::storage::Storage;
2025-11-09T23:19:32.3269597Z  use crate::network::txhash::calculate_txid;
2025-11-09T23:19:32.3269738Z +use crate::storage::Storage;
2025-11-09T23:19:32.3269862Z  use anyhow::Result;
2025-11-09T23:19:32.3270017Z  #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.3270303Z  use bllvm_protocol::utxo_commitments::merkle_tree::UtxoMerkleTree;
2025-11-09T23:19:32.3270843Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol_extensions.rs:41:
2025-11-09T23:19:32.3270991Z      // Get UTXO set from storage
2025-11-09T23:19:32.3271194Z      let utxo_set = storage.utxos().get_all_utxos()?;
2025-11-09T23:19:32.3271352Z      let utxo_count = utxo_set.len() as u64;
2025-11-09T23:19:32.3271693Z -    
2025-11-09T23:19:32.3271805Z +
2025-11-09T23:19:32.3271953Z      // Calculate total supply
2025-11-09T23:19:32.3272288Z      let total_supply: u64 = utxo_set.values().map(|utxo| utxo.value as u64).sum();
2025-11-09T23:19:32.3272409Z  
2025-11-09T23:19:32.3272960Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol_extensions.rs:49:
2025-11-09T23:19:32.3273130Z      #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.3273326Z      let mut utxo_tree = UtxoMerkleTree::new()
2025-11-09T23:19:32.3273660Z          .map_err(|e| anyhow::anyhow!("Failed to create UTXO Merkle tree: {:?}", e))?;
2025-11-09T23:19:32.3273775Z -    
2025-11-09T23:19:32.3273894Z +
2025-11-09T23:19:32.3274053Z      #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.3274208Z      for (outpoint, utxo) in &utxo_set {
2025-11-09T23:19:32.3274851Z -        utxo_tree.insert(*outpoint, utxo.clone())
2025-11-09T23:19:32.3275000Z +        utxo_tree
2025-11-09T23:19:32.3275177Z +            .insert(*outpoint, utxo.clone())
2025-11-09T23:19:32.3275499Z              .map_err(|e| anyhow::anyhow!("Failed to insert UTXO into tree: {:?}", e))?;
2025-11-09T23:19:32.3275627Z      }
2025-11-09T23:19:32.3275737Z  
2025-11-09T23:19:32.3276356Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol_extensions.rs:68:
2025-11-09T23:19:32.3278360Z      // Generate commitment
2025-11-09T23:19:32.3278531Z      #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.3278858Z      let commitment = utxo_tree.generate_commitment(block_hash, block_height);
2025-11-09T23:19:32.3278973Z -    
2025-11-09T23:19:32.3279092Z +
2025-11-09T23:19:32.3279265Z      #[cfg(not(feature = "utxo-commitments"))]
2025-11-09T23:19:32.3279532Z      let commitment = crate::network::protocol::UTXOCommitment {
2025-11-09T23:19:32.3279683Z          merkle_root: [0; 32],
2025-11-09T23:19:32.3280493Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol_extensions.rs:161:
2025-11-09T23:19:32.3280670Z      #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.3281108Z      let (filtered_txs, spam_summary_from_filter) = spam_filter.filter_block(&block.transactions);
2025-11-09T23:19:32.3281295Z      #[cfg(not(feature = "utxo-commitments"))]
2025-11-09T23:19:32.3282299Z -    let (filtered_txs, spam_summary_from_filter): (Vec<bllvm_protocol::Transaction>, crate::network::protocol::SpamSummary) = (block.transactions.clone(), crate::network::protocol::SpamSummary {
2025-11-09T23:19:32.3282448Z -        filtered_count: 0,
2025-11-09T23:19:32.3282589Z -        filtered_size: 0,
2025-11-09T23:19:32.3282806Z -        by_type: crate::network::protocol::SpamBreakdown {
2025-11-09T23:19:32.3282924Z -            ordinals: 0,
2025-11-09T23:19:32.3283065Z -            inscriptions: 0,
2025-11-09T23:19:32.3283187Z -            dust: 0,
2025-11-09T23:19:32.3283322Z -            brc20: 0,
2025-11-09T23:19:32.3283520Z +    let (filtered_txs, spam_summary_from_filter): (
2025-11-09T23:19:32.3283709Z +        Vec<bllvm_protocol::Transaction>,
2025-11-09T23:19:32.3283886Z +        crate::network::protocol::SpamSummary,
2025-11-09T23:19:32.3283994Z +    ) = (
2025-11-09T23:19:32.3284151Z +        block.transactions.clone(),
2025-11-09T23:19:32.3284493Z +        crate::network::protocol::SpamSummary {
2025-11-09T23:19:32.3284626Z +            filtered_count: 0,
2025-11-09T23:19:32.3284748Z +            filtered_size: 0,
2025-11-09T23:19:32.3284954Z +            by_type: crate::network::protocol::SpamBreakdown {
2025-11-09T23:19:32.3285070Z +                ordinals: 0,
2025-11-09T23:19:32.3285197Z +                inscriptions: 0,
2025-11-09T23:19:32.3285320Z +                dust: 0,
2025-11-09T23:19:32.3285436Z +                brc20: 0,
2025-11-09T23:19:32.3285545Z +            },
2025-11-09T23:19:32.3285655Z          },
2025-11-09T23:19:32.3285791Z -    });
2025-11-09T23:19:32.3285904Z -    
2025-11-09T23:19:32.3286019Z +    );
2025-11-09T23:19:32.3286140Z +
2025-11-09T23:19:32.3286546Z      // Convert spam summary to protocol types
2025-11-09T23:19:32.3286710Z      let spam_summary = SpamSummary {
2025-11-09T23:19:32.3286968Z          filtered_count: spam_summary_from_filter.filtered_count,
2025-11-09T23:19:32.3287542Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol_extensions.rs:186:
2025-11-09T23:19:32.3287658Z  
2025-11-09T23:19:32.3288078Z      // Generate transaction indices (positions of filtered transactions in original block)
2025-11-09T23:19:32.3288277Z      let mut transaction_indices = Vec::new();
2025-11-09T23:19:32.3288592Z -    let filtered_txids: std::collections::HashSet<_> = filtered_txs.iter()
2025-11-09T23:19:32.3288747Z -        .map(|tx| calculate_txid(tx))
2025-11-09T23:19:32.3288880Z -        .collect();
2025-11-09T23:19:32.3289088Z +    let filtered_txids: std::collections::HashSet<_> =
2025-11-09T23:19:32.3291107Z +        filtered_txs.iter().map(|tx| calculate_txid(tx)).collect();
2025-11-09T23:19:32.3291388Z      for (original_idx, tx) in block.transactions.iter().enumerate() {
2025-11-09T23:19:32.3291559Z          let txid = calculate_txid(tx);
2025-11-09T23:19:32.3291721Z          if filtered_txids.contains(&txid) {
2025-11-09T23:19:32.3292279Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol_extensions.rs:200:
2025-11-09T23:19:32.3292452Z      #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.3292626Z      let mut utxo_tree = UtxoMerkleTree::new()
2025-11-09T23:19:32.3293360Z          .map_err(|e| anyhow::anyhow!("Failed to create UTXO Merkle tree: {:?}", e))?;
2025-11-09T23:19:32.3293499Z -    
2025-11-09T23:19:32.3293614Z +
2025-11-09T23:19:32.3293777Z      #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.3293941Z      // Add outputs from filtered transactions
2025-11-09T23:19:32.3294090Z      for tx in &filtered_txs {
2025-11-09T23:19:32.3295059Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol_extensions.rs:227:
2025-11-09T23:19:32.3295239Z      // Generate commitment for filtered block
2025-11-09T23:19:32.3295396Z      #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.3295772Z      let commitment = utxo_tree.generate_commitment(message.block_hash, block_height);
2025-11-09T23:19:32.3295891Z -    
2025-11-09T23:19:32.3296007Z +
2025-11-09T23:19:32.3296178Z      #[cfg(not(feature = "utxo-commitments"))]
2025-11-09T23:19:32.3296449Z      let commitment = crate::network::protocol::UTXOCommitment {
2025-11-09T23:19:32.3296587Z          merkle_root: [0; 32],
2025-11-09T23:19:32.3297118Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/stratum_v2/pool.rs:191:
2025-11-09T23:19:32.3297233Z  
2025-11-09T23:19:32.3297372Z          // Store template
2025-11-09T23:19:32.3297561Z          self.current_template = Some(template);
2025-11-09T23:19:32.3297680Z -        
2025-11-09T23:19:32.3297808Z +
2025-11-09T23:19:32.3297944Z          (job_id, messages)
2025-11-09T23:19:32.3298060Z      }
2025-11-09T23:19:32.3298176Z  
2025-11-09T23:19:32.3298692Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/stratum_v2/pool.rs:463:
2025-11-09T23:19:32.3298941Z          if let Some(coinbase) = template.transactions.first() {
2025-11-09T23:19:32.3299096Z              // Serialize coinbase transaction
2025-11-09T23:19:32.3299349Z              let coinbase_bytes = self.serialize_transaction(coinbase);
2025-11-09T23:19:32.3299464Z -            
2025-11-09T23:19:32.3299582Z +
2025-11-09T23:19:32.3299792Z              // Extract merkle path from coinbase (index 0) to root
2025-11-09T23:19:32.3300029Z              let merkle_path = self.extract_merkle_path(template, 0);
2025-11-09T23:19:32.3300146Z -            
2025-11-09T23:19:32.3300256Z +
2025-11-09T23:19:32.3300583Z              // For Stratum V2, coinbase prefix is the full coinbase (miners can modify it)
2025-11-09T23:19:32.3300804Z              // Coinbase suffix is empty (not used in Stratum V2)
2025-11-09T23:19:32.3300978Z              (coinbase_bytes, vec![], merkle_path)
2025-11-09T23:19:32.3301989Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/stratum_v2/pool.rs:477:
2025-11-09T23:19:32.3302098Z  
2025-11-09T23:19:32.3302384Z      /// Extract merkle path from a specific transaction index to root
2025-11-09T23:19:32.3302716Z      fn extract_merkle_path(&self, block: &Block, tx_index: usize) -> Vec<Hash> {
2025-11-09T23:19:32.3302921Z -        use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:19:32.3303108Z          use crate::storage::hashing::double_sha256;
2025-11-09T23:19:32.3303296Z +        use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:19:32.3303405Z  
2025-11-09T23:19:32.3303733Z          if block.transactions.is_empty() || tx_index >= block.transactions.len() {
2025-11-09T23:19:32.3303872Z              return vec![];
2025-11-09T23:19:32.3304567Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/stratum_v2/pool.rs:485:
2025-11-09T23:19:32.3304703Z          }
2025-11-09T23:19:32.3304821Z  
2025-11-09T23:19:32.3304989Z          // Calculate all transaction hashes
2025-11-09T23:19:32.3305227Z -        let mut tx_hashes: Vec<Hash> = block.transactions.iter()
2025-11-09T23:19:32.3305393Z +        let mut tx_hashes: Vec<Hash> = block
2025-11-09T23:19:32.3305517Z +            .transactions
2025-11-09T23:19:32.3305638Z +            .iter()
2025-11-09T23:19:32.3305792Z              .map(|tx| calculate_tx_id(tx))
2025-11-09T23:19:32.3305926Z              .collect();
2025-11-09T23:19:32.3306036Z  
2025-11-09T23:19:32.3306548Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/stratum_v2/pool.rs:528:
2025-11-09T23:19:32.3306743Z                      combined.extend_from_slice(&chunk[0]);
2025-11-09T23:19:32.3306937Z                      let parent_hash = double_sha256(&combined);
2025-11-09T23:19:32.3307334Z                      next_level.push(parent_hash);
2025-11-09T23:19:32.3307455Z -                    
2025-11-09T23:19:32.3307583Z +
2025-11-09T23:19:32.3307868Z                      // If current_index is the last (odd) transaction, no sibling to add
2025-11-09T23:19:32.3308037Z                      let pair_start = pair_idx * 2;
2025-11-09T23:19:32.3308207Z                      if current_index == pair_start {
2025-11-09T23:19:32.3313355Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/stratum_v2/server.rs:214:
2025-11-09T23:19:32.3313602Z          // Get block template from MiningCoordinator
2025-11-09T23:19:32.3313756Z          let template = {
2025-11-09T23:19:32.3314038Z              let mut coordinator = self.mining_coordinator.write().await;
2025-11-09T23:19:32.3314245Z -            coordinator.generate_block_template().await
2025-11-09T23:19:32.3314936Z -                .map_err(|e| StratumV2Error::MiningJob(format!("Failed to generate block template: {}", e)))?
2025-11-09T23:19:32.3315242Z +            coordinator.generate_block_template().await.map_err(|e| {
2025-11-09T23:19:32.3315666Z +                StratumV2Error::MiningJob(format!("Failed to generate block template: {}", e))
2025-11-09T23:19:32.3315796Z +            })?
2025-11-09T23:19:32.3315909Z          };
2025-11-09T23:19:32.3316024Z  
2025-11-09T23:19:32.3316469Z -        debug!("Generated new block template with {} transactions", template.transactions.len());
2025-11-09T23:19:32.3316603Z +        debug!(
2025-11-09T23:19:32.3316836Z +            "Generated new block template with {} transactions",
2025-11-09T23:19:32.3317007Z +            template.transactions.len()
2025-11-09T23:19:32.3317129Z +        );
2025-11-09T23:19:32.3317237Z  
2025-11-09T23:19:32.3317469Z          // Set template in pool and get distribution messages
2025-11-09T23:19:32.3317626Z          let (job_id, messages) = {
2025-11-09T23:19:32.3318183Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/stratum_v2/server.rs:273:
2025-11-09T23:19:32.3318358Z          if let Some(ref mut conn) = *conn {
2025-11-09T23:19:32.3319008Z              // Use channel-specific sending - transports that support channels (QUIC/Iroh)
2025-11-09T23:19:32.3319377Z              // will route to the appropriate channel stream, others will use default send()
2025-11-09T23:19:32.3319665Z -            conn.send_on_channel(channel_id, &encoded).await.map_err(|e| {
2025-11-09T23:19:32.3320013Z -                StratumV2Error::Network(format!("Failed to send job message: {}", e))
2025-11-09T23:19:32.3320141Z -            })?;
2025-11-09T23:19:32.3320334Z +            conn.send_on_channel(channel_id, &encoded)
2025-11-09T23:19:32.3320462Z +                .await
2025-11-09T23:19:32.3320611Z +                .map_err(|e| {
2025-11-09T23:19:32.3320942Z +                    StratumV2Error::Network(format!("Failed to send job message: {}", e))
2025-11-09T23:19:32.3321056Z +                })?;
2025-11-09T23:19:32.3321177Z          } else {
2025-11-09T23:19:32.3321432Z              return Err(StratumV2Error::Connection(anyhow::anyhow!(
2025-11-09T23:19:32.3321606Z                  "Connection not available"
2025-11-09T23:19:32.3402712Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:101:
2025-11-09T23:19:32.3402908Z                  {
2025-11-09T23:19:32.3403147Z                      use crate::network::transport::TransportAddr;
2025-11-09T23:19:32.3403288Z                      use hex;
2025-11-09T23:19:32.3403409Z -                    
2025-11-09T23:19:32.3403523Z +
2025-11-09T23:19:32.3403792Z                      let node_id_hex = peer_id.strip_prefix("iroh:").ok_or_else(|| {
2025-11-09T23:19:32.3404260Z                          bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-09T23:19:32.3404638Z                              format!("Invalid Iroh peer_id format: {}", peer_id)
2025-11-09T23:19:32.3405204Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:108:
2025-11-09T23:19:32.3405610Z                          )
2025-11-09T23:19:32.3405746Z                      })?;
2025-11-09T23:19:32.3405868Z -                    
2025-11-09T23:19:32.3405989Z +
2025-11-09T23:19:32.3406263Z                      let node_id_bytes = hex::decode(node_id_hex).map_err(|e| {
2025-11-09T23:19:32.3406730Z                          bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-09T23:19:32.3406931Z                              format!("Invalid Iroh node ID hex: {}", e)
2025-11-09T23:19:32.3407521Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:114:
2025-11-09T23:19:32.3407650Z                          )
2025-11-09T23:19:32.3407769Z                      })?;
2025-11-09T23:19:32.3407895Z -                    
2025-11-09T23:19:32.3408007Z +
2025-11-09T23:19:32.3408259Z                      // Validate node ID length (Iroh uses 32-byte public keys)
2025-11-09T23:19:32.3408447Z                      if node_id_bytes.len() != 32 {
2025-11-09T23:19:32.3410737Z                          return Err(bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-09T23:19:32.3411337Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:120:
2025-11-09T23:19:32.3411732Z                              format!("Invalid Iroh node ID length: expected 32 bytes, got {}", node_id_bytes.len())
2025-11-09T23:19:32.3411859Z                          ));
2025-11-09T23:19:32.3411980Z                      }
2025-11-09T23:19:32.3412109Z -                    
2025-11-09T23:19:32.3412222Z +
2025-11-09T23:19:32.3412534Z                      // Create placeholder SocketAddr for Iroh (same approach as mod.rs)
2025-11-09T23:19:32.3412776Z                      // Use first 4 bytes of key for IP, last 2 bytes for port
2025-11-09T23:19:32.3413149Z -                    let ip_bytes = [node_id_bytes[0], node_id_bytes[1], node_id_bytes[2], node_id_bytes[3]];
2025-11-09T23:19:32.3413526Z +                    let ip_bytes = [
2025-11-09T23:19:32.3413679Z +                        node_id_bytes[0],
2025-11-09T23:19:32.3413819Z +                        node_id_bytes[1],
2025-11-09T23:19:32.3413957Z +                        node_id_bytes[2],
2025-11-09T23:19:32.3414092Z +                        node_id_bytes[3],
2025-11-09T23:19:32.3414221Z +                    ];
2025-11-09T23:19:32.3414817Z                      let port = u16::from_be_bytes([node_id_bytes[30], node_id_bytes[31]]);
2025-11-09T23:19:32.3415151Z                      let placeholder_addr = std::net::SocketAddr::from((ip_bytes, port));
2025-11-09T23:19:32.3415283Z -                    
2025-11-09T23:19:32.3415394Z +
2025-11-09T23:19:32.3415654Z                      let transport_addr = TransportAddr::Iroh(node_id_bytes);
2025-11-09T23:19:32.3415871Z                      Some((placeholder_addr, Some(transport_addr)))
2025-11-09T23:19:32.3415997Z                  }
2025-11-09T23:19:32.3416578Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:148:
2025-11-09T23:19:32.3416712Z                      ));
2025-11-09T23:19:32.3416838Z                  }
2025-11-09T23:19:32.3416955Z              };
2025-11-09T23:19:32.3417071Z -            
2025-11-09T23:19:32.3417188Z +
2025-11-09T23:19:32.3417360Z              // Store TransportAddr mapping if Iroh
2025-11-09T23:19:32.3417570Z              if let Some(transport_addr) = transport_addr_opt {
2025-11-09T23:19:32.3417760Z                  let network = network_manager.read().await;
2025-11-09T23:19:32.3420592Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:155:
2025-11-09T23:19:32.3420886Z                  // Store mapping from placeholder SocketAddr to TransportAddr
2025-11-09T23:19:32.3421276Z -                network.socket_to_transport.lock().unwrap().insert(peer_addr, transport_addr);
2025-11-09T23:19:32.3421669Z +                network
2025-11-09T23:19:32.3421840Z +                    .socket_to_transport
2025-11-09T23:19:32.3421970Z +                    .lock()
2025-11-09T23:19:32.3422105Z +                    .unwrap()
2025-11-09T23:19:32.3422293Z +                    .insert(peer_addr, transport_addr);
2025-11-09T23:19:32.3422432Z                  drop(network);
2025-11-09T23:19:32.3422548Z              }
2025-11-09T23:19:32.3422669Z  
2025-11-09T23:19:32.3423256Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:160:
2025-11-09T23:19:32.3423541Z              // Check if peer supports UTXO commitments before sending request
2025-11-09T23:19:32.3423733Z              let network = network_manager.read().await;
2025-11-09T23:19:32.3423851Z -            
2025-11-09T23:19:32.3423963Z +
2025-11-09T23:19:32.3424140Z              // Get peer version to check capabilities
2025-11-09T23:19:32.3424493Z              let peer_supports_utxo_commitments = {
2025-11-09T23:19:32.3424745Z                  let peer_states = network.peer_states.lock().unwrap();
2025-11-09T23:19:32.3425336Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:178:
2025-11-09T23:19:32.3425477Z                      false
2025-11-09T23:19:32.3425593Z                  }
2025-11-09T23:19:32.3425702Z              };
2025-11-09T23:19:32.3425825Z -            
2025-11-09T23:19:32.3425940Z +
2025-11-09T23:19:32.3426247Z              // If we know the peer doesn't support UTXO commitments, return error early
2025-11-09T23:19:32.3426419Z              if !peer_supports_utxo_commitments {
2025-11-09T23:19:32.3426556Z                  drop(network);
2025-11-09T23:19:32.3427114Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:186:
2025-11-09T23:19:32.3427606Z                      format!("Peer {} does not support UTXO commitments (missing NODE_UTXO_COMMITMENTS service flag)", peer_id)
2025-11-09T23:19:32.3427751Z                  ));
2025-11-09T23:19:32.3428102Z              }
2025-11-09T23:19:32.3428219Z -            
2025-11-09T23:19:32.3428338Z +
2025-11-09T23:19:32.3428527Z              // Register pending request before sending
2025-11-09T23:19:32.3428833Z              let (request_id, response_rx) = network.register_request(peer_addr);
2025-11-09T23:19:32.3430832Z              drop(network); // Release read lock before async wait
2025-11-09T23:19:32.3431418Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:193:
2025-11-09T23:19:32.3431537Z -            
2025-11-09T23:19:32.3431647Z +
2025-11-09T23:19:32.3431840Z              // Create GetUTXOSet message with request_id
2025-11-09T23:19:32.3432035Z -            let get_utxo_set_msg = GetUTXOSetMessage { 
2025-11-09T23:19:32.3432293Z +            let get_utxo_set_msg = GetUTXOSetMessage {
2025-11-09T23:19:32.3432442Z                  request_id,
2025-11-09T23:19:32.3432626Z -                height, 
2025-11-09T23:19:32.3432753Z -                block_hash 
2025-11-09T23:19:32.3432882Z +                height,
2025-11-09T23:19:32.3433019Z +                block_hash,
2025-11-09T23:19:32.3433135Z              };
2025-11-09T23:19:32.3433245Z  
2025-11-09T23:19:32.3433575Z              // Serialize message using protocol adapter (handles TCP vs Iroh format)
2025-11-09T23:19:32.3434167Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:203:
2025-11-09T23:19:32.3434869Z                  .map_err(|e| bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-09T23:19:32.3435092Z                      format!("Failed to serialize GetUTXOSet: {}", e)
2025-11-09T23:19:32.3435221Z                  ))?;
2025-11-09T23:19:32.3435336Z -            
2025-11-09T23:19:32.3435471Z +
2025-11-09T23:19:32.3435652Z              // Send message to peer via NetworkManager
2025-11-09T23:19:32.3436040Z              {
2025-11-09T23:19:32.3436237Z                  let network = network_manager.read().await;
2025-11-09T23:19:32.3436835Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:212:
2025-11-09T23:19:32.3437127Z                          format!("Failed to send GetUTXOSet to peer {}: {}", peer_addr, e)
2025-11-09T23:19:32.3443295Z                      ))?;
2025-11-09T23:19:32.3443458Z              }
2025-11-09T23:19:32.3443582Z -            
2025-11-09T23:19:32.3443695Z +
2025-11-09T23:19:32.3443894Z              // Await response with timeout (30 seconds)
2025-11-09T23:19:32.3444045Z              tokio::select! {
2025-11-09T23:19:32.3444220Z                  result = response_rx => {
2025-11-09T23:19:32.3445050Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:224:
2025-11-09T23:19:32.3445600Z                                  .map_err(|e| bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-09T23:19:32.3445866Z                                      format!("Failed to parse UTXOSet response: {}", e)
2025-11-09T23:19:32.3445999Z                                  ))?;
2025-11-09T23:19:32.3446136Z -                            
2025-11-09T23:19:32.3446249Z +
2025-11-09T23:19:32.3448307Z                              match parsed {
2025-11-09T23:19:32.3448520Z                                  ProtocolMessage::UTXOSet(utxo_set_msg) => {
2025-11-09T23:19:32.3448700Z                                      // Convert to UtxoCommitment
2025-11-09T23:19:32.3449293Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:291:
2025-11-09T23:19:32.3449408Z                  {
2025-11-09T23:19:32.3449636Z                      use crate::network::transport::TransportAddr;
2025-11-09T23:19:32.3449764Z                      use hex;
2025-11-09T23:19:32.3449896Z -                    
2025-11-09T23:19:32.3450016Z +
2025-11-09T23:19:32.3450268Z                      let node_id_hex = peer_id.strip_prefix("iroh:").ok_or_else(|| {
2025-11-09T23:19:32.3450990Z                          bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-09T23:19:32.3451229Z                              format!("Invalid Iroh peer_id format: {}", peer_id)
2025-11-09T23:19:32.3451795Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:298:
2025-11-09T23:19:32.3451911Z                          )
2025-11-09T23:19:32.3452025Z                      })?;
2025-11-09T23:19:32.3452144Z -                    
2025-11-09T23:19:32.3452257Z +
2025-11-09T23:19:32.3452513Z                      let node_id_bytes = hex::decode(node_id_hex).map_err(|e| {
2025-11-09T23:19:32.3452976Z                          bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-09T23:19:32.3453185Z                              format!("Invalid Iroh node ID hex: {}", e)
2025-11-09T23:19:32.3453740Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:304:
2025-11-09T23:19:32.3453887Z                          )
2025-11-09T23:19:32.3454008Z                      })?;
2025-11-09T23:19:32.3454127Z -                    
2025-11-09T23:19:32.3454243Z +
2025-11-09T23:19:32.3454685Z                      // Validate node ID length (Iroh uses 32-byte public keys)
2025-11-09T23:19:32.3454849Z                      if node_id_bytes.len() != 32 {
2025-11-09T23:19:32.3455378Z                          return Err(bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-09T23:19:32.3455970Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:310:
2025-11-09T23:19:32.3456356Z                              format!("Invalid Iroh node ID length: expected 32 bytes, got {}", node_id_bytes.len())
2025-11-09T23:19:32.3456741Z                          ));
2025-11-09T23:19:32.3456877Z                      }
2025-11-09T23:19:32.3456983Z -                    
2025-11-09T23:19:32.3457085Z +
2025-11-09T23:19:32.3457398Z                      // Create placeholder SocketAddr for Iroh (same approach as mod.rs)
2025-11-09T23:19:32.3457629Z                      // Use first 4 bytes of key for IP, last 2 bytes for port
2025-11-09T23:19:32.3457975Z -                    let ip_bytes = [node_id_bytes[0], node_id_bytes[1], node_id_bytes[2], node_id_bytes[3]];
2025-11-09T23:19:32.3459929Z +                    let ip_bytes = [
2025-11-09T23:19:32.3460084Z +                        node_id_bytes[0],
2025-11-09T23:19:32.3460227Z +                        node_id_bytes[1],
2025-11-09T23:19:32.3460362Z +                        node_id_bytes[2],
2025-11-09T23:19:32.3460512Z +                        node_id_bytes[3],
2025-11-09T23:19:32.3460636Z +                    ];
2025-11-09T23:19:32.3460958Z                      let port = u16::from_be_bytes([node_id_bytes[30], node_id_bytes[31]]);
2025-11-09T23:19:32.3461298Z                      let placeholder_addr = std::net::SocketAddr::from((ip_bytes, port));
2025-11-09T23:19:32.3461418Z -                    
2025-11-09T23:19:32.3461532Z +
2025-11-09T23:19:32.3461786Z                      let transport_addr = TransportAddr::Iroh(node_id_bytes);
2025-11-09T23:19:32.3462000Z                      Some((placeholder_addr, Some(transport_addr)))
2025-11-09T23:19:32.3462118Z                  }
2025-11-09T23:19:32.3462701Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:338:
2025-11-09T23:19:32.3462839Z                      ));
2025-11-09T23:19:32.3462956Z                  }
2025-11-09T23:19:32.3463071Z              };
2025-11-09T23:19:32.3463193Z -            
2025-11-09T23:19:32.3463305Z +
2025-11-09T23:19:32.3463487Z              // Store TransportAddr mapping if Iroh
2025-11-09T23:19:32.3463710Z              if let Some(transport_addr) = transport_addr_opt {
2025-11-09T23:19:32.3463902Z                  let network = network_manager.read().await;
2025-11-09T23:19:32.3464872Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:345:
2025-11-09T23:19:32.3465149Z                  // Store mapping from placeholder SocketAddr to TransportAddr
2025-11-09T23:19:32.3465544Z -                network.socket_to_transport.lock().unwrap().insert(peer_addr, transport_addr);
2025-11-09T23:19:32.3465670Z +                network
2025-11-09T23:19:32.3465819Z +                    .socket_to_transport
2025-11-09T23:19:32.3465953Z +                    .lock()
2025-11-09T23:19:32.3466085Z +                    .unwrap()
2025-11-09T23:19:32.3466263Z +                    .insert(peer_addr, transport_addr);
2025-11-09T23:19:32.3466393Z                  drop(network);
2025-11-09T23:19:32.3468361Z              }
2025-11-09T23:19:32.3468477Z  
2025-11-09T23:19:32.3469070Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:351:
2025-11-09T23:19:32.3469274Z              let network = network_manager.read().await;
2025-11-09T23:19:32.3469577Z              let (request_id, response_rx) = network.register_request(peer_addr);
2025-11-09T23:19:32.3469806Z              drop(network); // Release read lock before async wait
2025-11-09T23:19:32.3469927Z -            
2025-11-09T23:19:32.3470048Z +
2025-11-09T23:19:32.3470262Z              // Create GetFilteredBlock message with request_id
2025-11-09T23:19:32.3470488Z              use crate::network::protocol::FilterPreferences;
2025-11-09T23:19:32.3470734Z              let get_filtered_block_msg = GetFilteredBlockMessage {
2025-11-09T23:19:32.3471314Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:371:
2025-11-09T23:19:32.3471808Z                  .map_err(|e| bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-09T23:19:32.3472307Z                      format!("Failed to serialize GetFilteredBlock: {}", e)
2025-11-09T23:19:32.3472443Z                  ))?;
2025-11-09T23:19:32.3472557Z -            
2025-11-09T23:19:32.3472669Z +
2025-11-09T23:19:32.3472867Z              // Send message to peer via NetworkManager
2025-11-09T23:19:32.3472986Z              {
2025-11-09T23:19:32.3473177Z                  let network = network_manager.read().await;
2025-11-09T23:19:32.3473769Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:380:
2025-11-09T23:19:32.3474092Z                          format!("Failed to send GetFilteredBlock to peer {}: {}", peer_addr, e)
2025-11-09T23:19:32.3474221Z                      ))?;
2025-11-09T23:19:32.3474527Z              }
2025-11-09T23:19:32.3474649Z -            
2025-11-09T23:19:32.3474763Z +
2025-11-09T23:19:32.3474947Z              // Await response with timeout (30 seconds)
2025-11-09T23:19:32.3475122Z              tokio::select! {
2025-11-09T23:19:32.3475276Z                  result = response_rx => {
2025-11-09T23:19:32.3475864Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:392:
2025-11-09T23:19:32.3476400Z                                  .map_err(|e| bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-09T23:19:32.3476654Z                                      format!("Failed to parse FilteredBlock response: {}", e)
2025-11-09T23:19:32.3476779Z                                  ))?;
2025-11-09T23:19:32.3476910Z -                            
2025-11-09T23:19:32.3477015Z +
2025-11-09T23:19:32.3477153Z                              match parsed {
2025-11-09T23:19:32.3477417Z                                  ProtocolMessage::FilteredBlock(filtered_block_msg) => {
2025-11-09T23:19:32.3477587Z                                      // Convert to FilteredBlock
2025-11-09T23:19:32.3480004Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/health.rs:144:
2025-11-09T23:19:32.3480153Z          // Determine overall status
2025-11-09T23:19:32.3480773Z          let overall_status = if components.iter().any(|c| c.status == HealthStatus::Down) {
2025-11-09T23:19:32.3480939Z              HealthStatus::Down
2025-11-09T23:19:32.3481257Z -        } else if components.iter().any(|c| c.status == HealthStatus::Unhealthy) {
2025-11-09T23:19:32.3481395Z +        } else if components
2025-11-09T23:19:32.3481506Z +            .iter()
2025-11-09T23:19:32.3481690Z +            .any(|c| c.status == HealthStatus::Unhealthy)
2025-11-09T23:19:32.3481806Z +        {
2025-11-09T23:19:32.3481946Z              HealthStatus::Unhealthy
2025-11-09T23:19:32.3482246Z -        } else if components.iter().any(|c| c.status == HealthStatus::Degraded) {
2025-11-09T23:19:32.3482374Z +        } else if components
2025-11-09T23:19:32.3482492Z +            .iter()
2025-11-09T23:19:32.3482667Z +            .any(|c| c.status == HealthStatus::Degraded)
2025-11-09T23:19:32.3482782Z +        {
2025-11-09T23:19:32.3482934Z              HealthStatus::Degraded
2025-11-09T23:19:32.3483053Z          } else {
2025-11-09T23:19:32.3483190Z              HealthStatus::Healthy
2025-11-09T23:19:32.3483614Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/health.rs:180:
2025-11-09T23:19:32.3483745Z          Self::new()
2025-11-09T23:19:32.3483852Z      }
2025-11-09T23:19:32.3483958Z  }
2025-11-09T23:19:32.3484068Z -
2025-11-09T23:19:32.3484174Z  
2025-11-09T23:19:32.3486861Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:1:
2025-11-09T23:19:32.3488465Z  //! Mempool manager
2025-11-09T23:19:32.3488579Z -//! 
2025-11-09T23:19:32.3488691Z +//!
2025-11-09T23:19:32.3488996Z  //! Handles transaction mempool management, validation, and relay.
2025-11-09T23:19:32.3489109Z  
2025-11-09T23:19:32.3489249Z  use anyhow::Result;
2025-11-09T23:19:32.3489703Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:6:
2025-11-09T23:19:32.3490165Z -use bllvm_protocol::{Transaction, UtxoSet, Hash, OutPoint};
2025-11-09T23:19:32.3490348Z  use bllvm_protocol::mempool::Mempool;
2025-11-09T23:19:32.3490591Z +use bllvm_protocol::{Hash, OutPoint, Transaction, UtxoSet};
2025-11-09T23:19:32.3490775Z  use std::collections::{HashMap, HashSet};
2025-11-09T23:19:32.3490917Z  use tracing::{debug, info};
2025-11-09T23:19:32.3491024Z  
2025-11-09T23:19:32.3491473Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:31:
2025-11-09T23:19:32.3491647Z              spent_outputs: HashSet::new(),
2025-11-09T23:19:32.3491766Z          }
2025-11-09T23:19:32.3491886Z      }
2025-11-09T23:19:32.3491998Z -    
2025-11-09T23:19:32.3492112Z +
2025-11-09T23:19:32.3492258Z      /// Start the mempool manager
2025-11-09T23:19:32.3492462Z      pub async fn start(&mut self) -> Result<()> {
2025-11-09T23:19:32.3492624Z          info!("Starting mempool manager");
2025-11-09T23:19:32.3493079Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:38:
2025-11-09T23:19:32.3493210Z -        
2025-11-09T23:19:32.3493322Z +
2025-11-09T23:19:32.3493462Z          // Initialize mempool
2025-11-09T23:19:32.3493622Z          self.initialize_mempool().await?;
2025-11-09T23:19:32.3493742Z -        
2025-11-09T23:19:32.3493850Z +
2025-11-09T23:19:32.3494008Z          // Start mempool processing loop
2025-11-09T23:19:32.3494168Z          self.process_loop().await?;
2025-11-09T23:19:32.3494481Z -        
2025-11-09T23:19:32.3494599Z +
2025-11-09T23:19:32.3494717Z          Ok(())
2025-11-09T23:19:32.3494834Z      }
2025-11-09T23:19:32.3494944Z -    
2025-11-09T23:19:32.3495059Z +
2025-11-09T23:19:32.3495254Z      /// Run mempool processing once (for testing)
2025-11-09T23:19:32.3495477Z      pub async fn process_once(&mut self) -> Result<()> {
2025-11-09T23:19:32.3495636Z          // Process pending transactions
2025-11-09T23:19:32.3496096Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:51:
2025-11-09T23:19:32.3496298Z          self.process_pending_transactions().await?;
2025-11-09T23:19:32.3496653Z -        
2025-11-09T23:19:32.3496766Z +
2025-11-09T23:19:32.3496927Z          // Clean up old transactions
2025-11-09T23:19:32.3497097Z          self.cleanup_old_transactions().await?;
2025-11-09T23:19:32.3497211Z -        
2025-11-09T23:19:32.3497324Z +
2025-11-09T23:19:32.3497447Z          Ok(())
2025-11-09T23:19:32.3497552Z      }
2025-11-09T23:19:32.3497664Z -    
2025-11-09T23:19:32.3497786Z +
2025-11-09T23:19:32.3497924Z      /// Initialize mempool
2025-11-09T23:19:32.3498159Z      async fn initialize_mempool(&mut self) -> Result<()> {
2025-11-09T23:19:32.3498318Z          debug!("Initializing mempool");
2025-11-09T23:19:32.3498774Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:62:
2025-11-09T23:19:32.3498894Z -        
2025-11-09T23:19:32.3499005Z +
2025-11-09T23:19:32.3499227Z          // Load existing mempool from storage if available
2025-11-09T23:19:32.3499482Z          // In a real implementation, this would restore mempool state
2025-11-09T23:19:32.3499606Z -        
2025-11-09T23:19:32.3499716Z +
2025-11-09T23:19:32.3499842Z          Ok(())
2025-11-09T23:19:32.3499951Z      }
2025-11-09T23:19:32.3500064Z -    
2025-11-09T23:19:32.3500184Z +
2025-11-09T23:19:32.3500778Z      /// Main mempool processing loop
2025-11-09T23:19:32.3501009Z      async fn process_loop(&mut self) -> Result<()> {
2025-11-09T23:19:32.3501336Z          loop {
2025-11-09T23:19:32.3501786Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:72:
2025-11-09T23:19:32.3501945Z              // Process pending transactions
2025-11-09T23:19:32.3502130Z              self.process_pending_transactions().await?;
2025-11-09T23:19:32.3502247Z -            
2025-11-09T23:19:32.3502361Z +
2025-11-09T23:19:32.3502516Z              // Clean up old transactions
2025-11-09T23:19:32.3502956Z              self.cleanup_old_transactions().await?;
2025-11-09T23:19:32.3503076Z -            
2025-11-09T23:19:32.3503188Z +
2025-11-09T23:19:32.3503437Z              // Small delay to prevent busy waiting
2025-11-09T23:19:32.3503732Z              tokio::time::sleep(tokio::time::Duration::from_millis(100)).await;
2025-11-09T23:19:32.3503841Z          }
2025-11-09T23:19:32.3504273Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:81:
2025-11-09T23:19:32.3504571Z      }
2025-11-09T23:19:32.3504677Z -    
2025-11-09T23:19:32.3504793Z +
2025-11-09T23:19:32.3504960Z      /// Process pending transactions
2025-11-09T23:19:32.3505247Z      async fn process_pending_transactions(&mut self) -> Result<()> {
2025-11-09T23:19:32.3505415Z          // In a real implementation, this would:
2025-11-09T23:19:32.3505857Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:87:
2025-11-09T23:19:32.3506068Z          // 2. Validate transactions using consensus-proof
2025-11-09T23:19:32.3506235Z          // 3. Add valid transactions to mempool
2025-11-09T23:19:32.3506398Z          // 4. Relay transactions to peers
2025-11-09T23:19:32.3506513Z -        
2025-11-09T23:19:32.3506636Z +
2025-11-09T23:19:32.3506824Z          debug!("Processing pending transactions");
2025-11-09T23:19:32.3506945Z          Ok(())
2025-11-09T23:19:32.3507068Z      }
2025-11-09T23:19:32.3507503Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:94:
2025-11-09T23:19:32.3507621Z -    
2025-11-09T23:19:32.3507733Z +
2025-11-09T23:19:32.3507890Z      /// Clean up old transactions
2025-11-09T23:19:32.3508158Z      async fn cleanup_old_transactions(&mut self) -> Result<()> {
2025-11-09T23:19:32.3508334Z          // In a real implementation, this would:
2025-11-09T23:19:32.3508785Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:98:
2025-11-09T23:19:32.3508963Z          // 1. Remove transactions that are too old
2025-11-09T23:19:32.3509199Z          // 2. Remove transactions that conflict with new blocks
2025-11-09T23:19:32.3509636Z          // 3. Update transaction priorities
2025-11-09T23:19:32.3509755Z -        
2025-11-09T23:19:32.3509868Z +
2025-11-09T23:19:32.3510041Z          debug!("Cleaning up old transactions");
2025-11-09T23:19:32.3510166Z          Ok(())
2025-11-09T23:19:32.3510277Z      }
2025-11-09T23:19:32.3510722Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:105:
2025-11-09T23:19:32.3510849Z -    
2025-11-09T23:19:32.3510960Z +
2025-11-09T23:19:32.3511111Z      /// Add transaction to mempool
2025-11-09T23:19:32.3511960Z      pub async fn add_transaction(&mut self, tx: Transaction) -> Result<bool> {
2025-11-09T23:19:32.3512165Z          debug!("Adding transaction to mempool");
2025-11-09T23:19:32.3512621Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:109:
2025-11-09T23:19:32.3512741Z -        
2025-11-09T23:19:32.3512872Z +
2025-11-09T23:19:32.3513116Z          // Check for conflicts with existing mempool transactions
2025-11-09T23:19:32.3513275Z          for input in &tx.inputs {
2025-11-09T23:19:32.3513503Z              if self.spent_outputs.contains(&input.prevout) {
2025-11-09T23:19:32.3513966Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:114:
2025-11-09T23:19:32.3514111Z                  return Ok(false);
2025-11-09T23:19:32.3514228Z              }
2025-11-09T23:19:32.3514531Z          }
2025-11-09T23:19:32.3514650Z -        
2025-11-09T23:19:32.3514764Z +
2025-11-09T23:19:32.3514998Z          // Add transaction to mempool (store full transaction)
2025-11-09T23:19:32.3515224Z          use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:19:32.3515386Z          let tx_hash = calculate_tx_id(&tx);
2025-11-09T23:19:32.3515841Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:121:
2025-11-09T23:19:32.3516307Z          self.transactions.insert(tx_hash, tx.clone());
2025-11-09T23:19:32.3516473Z          self.mempool.insert(tx_hash);
2025-11-09T23:19:32.3516599Z -        
2025-11-09T23:19:32.3516718Z +
2025-11-09T23:19:32.3516860Z          // Track spent outputs
2025-11-09T23:19:32.3517006Z          for input in &tx.inputs {
2025-11-09T23:19:32.3517235Z              self.spent_outputs.insert(input.prevout.clone());
2025-11-09T23:19:32.3517681Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:127:
2025-11-09T23:19:32.3517791Z          }
2025-11-09T23:19:32.3517905Z -        
2025-11-09T23:19:32.3518032Z +
2025-11-09T23:19:32.3518153Z          Ok(true)
2025-11-09T23:19:32.3518263Z      }
2025-11-09T23:19:32.3518374Z -    
2025-11-09T23:19:32.3520410Z +
2025-11-09T23:19:32.3520546Z      /// Get mempool size
2025-11-09T23:19:32.3520697Z      pub fn size(&self) -> usize {
2025-11-09T23:19:32.3520856Z          self.transactions.len()
2025-11-09T23:19:32.3521304Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:135:
2025-11-09T23:19:32.3521433Z      }
2025-11-09T23:19:32.3521553Z -    
2025-11-09T23:19:32.3521660Z +
2025-11-09T23:19:32.3521823Z      /// Get mempool transaction hashes
2025-11-09T23:19:32.3522017Z      pub fn transaction_hashes(&self) -> Vec<Hash> {
2025-11-09T23:19:32.3522201Z          self.transactions.keys().cloned().collect()
2025-11-09T23:19:32.3522648Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:140:
2025-11-09T23:19:32.3522764Z      }
2025-11-09T23:19:32.3522876Z -    
2025-11-09T23:19:32.3522986Z +
2025-11-09T23:19:32.3523139Z      /// Get transaction by hash
2025-11-09T23:19:32.3523430Z      pub fn get_transaction(&self, hash: &Hash) -> Option<Transaction> {
2025-11-09T23:19:32.3523603Z          self.transactions.get(hash).cloned()
2025-11-09T23:19:32.3524060Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:145:
2025-11-09T23:19:32.3524187Z      }
2025-11-09T23:19:32.3524483Z -    
2025-11-09T23:19:32.3524606Z +
2025-11-09T23:19:32.3524753Z      /// Get all transactions
2025-11-09T23:19:32.3525233Z      pub fn get_transactions(&self) -> Vec<Transaction> {
2025-11-09T23:19:32.3525440Z          self.transactions.values().cloned().collect()
2025-11-09T23:19:32.3525902Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:150:
2025-11-09T23:19:32.3526018Z      }
2025-11-09T23:19:32.3526135Z -    
2025-11-09T23:19:32.3526253Z +
2025-11-09T23:19:32.3526436Z      /// Get prioritized transactions by fee rate
2025-11-09T23:19:32.3526546Z -    /// 
2025-11-09T23:19:32.3526658Z +    ///
2025-11-09T23:19:32.3527053Z      /// Returns transactions sorted by fee rate (satoshis per vbyte) in descending order.
2025-11-09T23:19:32.3527231Z      /// Requires UTXO set to calculate fee rates.
2025-11-09T23:19:32.3527680Z -    pub fn get_prioritized_transactions(&self, limit: usize, utxo_set: &UtxoSet) -> Vec<Transaction> {
2025-11-09T23:19:32.3527869Z +    pub fn get_prioritized_transactions(
2025-11-09T23:19:32.3527985Z +        &self,
2025-11-09T23:19:32.3528120Z +        limit: usize,
2025-11-09T23:19:32.3528253Z +        utxo_set: &UtxoSet,
2025-11-09T23:19:32.3528394Z +    ) -> Vec<Transaction> {
2025-11-09T23:19:32.3528638Z          let mut tx_with_fees: Vec<(Transaction, u64)> = Vec::new();
2025-11-09T23:19:32.3528752Z -        
2025-11-09T23:19:32.3528871Z +
2025-11-09T23:19:32.3529043Z          for tx in self.transactions.values() {
2025-11-09T23:19:32.3529212Z              // Calculate fee for this transaction
2025-11-09T23:19:32.3529428Z              let fee = self.calculate_transaction_fee(tx, utxo_set);
2025-11-09T23:19:32.3529879Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:162:
2025-11-09T23:19:32.3529985Z -            
2025-11-09T23:19:32.3530085Z +
2025-11-09T23:19:32.3530807Z              // Calculate transaction size (simplified - use serialized size estimate)
2025-11-09T23:19:32.3531274Z              let size = self.estimate_transaction_size(tx);
2025-11-09T23:19:32.3531396Z -            
2025-11-09T23:19:32.3533417Z +
2025-11-09T23:19:32.3533609Z              // Calculate fee rate (satoshis per vbyte)
2025-11-09T23:19:32.3533761Z              let fee_rate = if size > 0 {
2025-11-09T23:19:32.3534134Z                  fee * 1000 / size as u64 // Convert to satoshis per vbyte (multiply by 1000 for precision)
2025-11-09T23:19:32.3534777Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:169:
2025-11-09T23:19:32.3534906Z              } else {
2025-11-09T23:19:32.3535025Z                  0
2025-11-09T23:19:32.3535144Z              };
2025-11-09T23:19:32.3535254Z -            
2025-11-09T23:19:32.3535365Z +
2025-11-09T23:19:32.3535542Z              tx_with_fees.push((tx.clone(), fee_rate));
2025-11-09T23:19:32.3535658Z          }
2025-11-09T23:19:32.3535769Z -        
2025-11-09T23:19:32.3535882Z +
2025-11-09T23:19:32.3536045Z          // Sort by fee rate (descending)
2025-11-09T23:19:32.3536223Z          tx_with_fees.sort_by(|a, b| b.1.cmp(&a.1));
2025-11-09T23:19:32.3536331Z -        
2025-11-09T23:19:32.3536428Z +
2025-11-09T23:19:32.3536568Z          // Return top N transactions
2025-11-09T23:19:32.3536703Z -        tx_with_fees.into_iter()
2025-11-09T23:19:32.3536821Z +        tx_with_fees
2025-11-09T23:19:32.3536943Z +            .into_iter()
2025-11-09T23:19:32.3537052Z              .take(limit)
2025-11-09T23:19:32.3537175Z              .map(|(tx, _)| tx)
2025-11-09T23:19:32.3537296Z              .collect()
2025-11-09T23:19:32.3537722Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:184:
2025-11-09T23:19:32.3537832Z      }
2025-11-09T23:19:32.3537944Z -    
2025-11-09T23:19:32.3538058Z +
2025-11-09T23:19:32.3538212Z      /// Calculate transaction fee
2025-11-09T23:19:32.3538324Z -    /// 
2025-11-09T23:19:32.3538436Z +    ///
2025-11-09T23:19:32.3538610Z      /// Fee = sum of inputs - sum of outputs
2025-11-09T23:19:32.3538999Z      pub fn calculate_transaction_fee(&self, tx: &Transaction, utxo_set: &UtxoSet) -> u64 {
2025-11-09T23:19:32.3539388Z          let mut input_total = 0u64;
2025-11-09T23:19:32.3539844Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:191:
2025-11-09T23:19:32.3539958Z -        
2025-11-09T23:19:32.3540066Z +
2025-11-09T23:19:32.3540215Z          // Sum input values from UTXO set
2025-11-09T23:19:32.3540359Z          for input in &tx.inputs {
2025-11-09T23:19:32.3540559Z              if let Some(utxo) = utxo_set.get(&input.prevout) {
2025-11-09T23:19:32.3540996Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:195:
2025-11-09T23:19:32.3541170Z                  input_total += utxo.value as u64;
2025-11-09T23:19:32.3541287Z              }
2025-11-09T23:19:32.3541401Z          }
2025-11-09T23:19:32.3541521Z -        
2025-11-09T23:19:32.3541628Z +
2025-11-09T23:19:32.3541761Z          // Sum output values
2025-11-09T23:19:32.3542096Z          let output_total: u64 = tx.outputs.iter().map(|out| out.value as u64).sum();
2025-11-09T23:19:32.3542231Z -        
2025-11-09T23:19:32.3542342Z +
2025-11-09T23:19:32.3542513Z          // Fee is difference (inputs - outputs)
2025-11-09T23:19:32.3542672Z          if input_total > output_total {
2025-11-09T23:19:32.3542820Z              input_total - output_total
2025-11-09T23:19:32.3543262Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:206:
2025-11-09T23:19:32.3543377Z              0
2025-11-09T23:19:32.3543498Z          }
2025-11-09T23:19:32.3543607Z      }
2025-11-09T23:19:32.3543715Z -    
2025-11-09T23:19:32.3543833Z +
2025-11-09T23:19:32.3543997Z      /// Estimate transaction size in vbytes
2025-11-09T23:19:32.3544109Z -    /// 
2025-11-09T23:19:32.3544219Z +    ///
2025-11-09T23:19:32.3544747Z      /// Simplified estimation - in production, would use actual serialized size
2025-11-09T23:19:32.3545033Z      fn estimate_transaction_size(&self, tx: &Transaction) -> usize {
2025-11-09T23:19:32.3545509Z          // Base transaction size: version (4) + locktime (4) = 8 bytes
2025-11-09T23:19:32.3545952Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:215:
2025-11-09T23:19:32.3546084Z          let mut size = 8;
2025-11-09T23:19:32.3546198Z -        
2025-11-09T23:19:32.3546307Z +
2025-11-09T23:19:32.3546558Z          // Input size: prevout (36) + script_sig (var) + sequence (4)
2025-11-09T23:19:32.3546698Z          for input in &tx.inputs {
2025-11-09T23:19:32.3546831Z              size += 36; // prevout
2025-11-09T23:19:32.3547278Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:220:
2025-11-09T23:19:32.3547437Z              size += input.script_sig.len();
2025-11-09T23:19:32.3547565Z              size += 4; // sequence
2025-11-09T23:19:32.3547679Z          }
2025-11-09T23:19:32.3547803Z -        
2025-11-09T23:19:32.3547913Z +
2025-11-09T23:19:32.3548117Z          // Output size: value (8) + script_pubkey (var)
2025-11-09T23:19:32.3548276Z          for output in &tx.outputs {
2025-11-09T23:19:32.3548421Z              size += 8; // value
2025-11-09T23:19:32.3550918Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:227:
2025-11-09T23:19:32.3551119Z              size += output.script_pubkey.len();
2025-11-09T23:19:32.3551236Z          }
2025-11-09T23:19:32.3551349Z -        
2025-11-09T23:19:32.3551462Z +
2025-11-09T23:19:32.3551798Z          // Add witness discount if segwit (simplified - assume no witness for now)
2025-11-09T23:19:32.3551920Z          size
2025-11-09T23:19:32.3552027Z      }
2025-11-09T23:19:32.3552482Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:233:
2025-11-09T23:19:32.3552600Z -    
2025-11-09T23:19:32.3552710Z +
2025-11-09T23:19:32.3552870Z      /// Remove transaction from mempool
2025-11-09T23:19:32.3553129Z      pub fn remove_transaction(&mut self, hash: &Hash) -> bool {
2025-11-09T23:19:32.3553358Z          if let Some(tx) = self.transactions.remove(hash) {
2025-11-09T23:19:32.3554094Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:237:
2025-11-09T23:19:32.3554265Z              self.mempool.remove(hash);
2025-11-09T23:19:32.3554523Z -            
2025-11-09T23:19:32.3554640Z +
2025-11-09T23:19:32.3554809Z              // Remove spent outputs tracking
2025-11-09T23:19:32.3554971Z              for input in &tx.inputs {
2025-11-09T23:19:32.3555175Z                  self.spent_outputs.remove(&input.prevout);
2025-11-09T23:19:32.3555626Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:242:
2025-11-09T23:19:32.3555754Z              }
2025-11-09T23:19:32.3555867Z -            
2025-11-09T23:19:32.3555980Z +
2025-11-09T23:19:32.3556098Z              true
2025-11-09T23:19:32.3556220Z          } else {
2025-11-09T23:19:32.3556340Z              false
2025-11-09T23:19:32.3556817Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:247:
2025-11-09T23:19:32.3556940Z          }
2025-11-09T23:19:32.3557065Z      }
2025-11-09T23:19:32.3557171Z -    
2025-11-09T23:19:32.3557279Z +
2025-11-09T23:19:32.3557416Z      /// Clear mempool
2025-11-09T23:19:32.3557561Z      pub fn clear(&mut self) {
2025-11-09T23:19:32.3557716Z          self.transactions.clear();
2025-11-09T23:19:32.3558164Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:253:
2025-11-09T23:19:32.3558318Z          self.mempool.clear();
2025-11-09T23:19:32.3558477Z          self.spent_outputs.clear();
2025-11-09T23:19:32.3558591Z      }
2025-11-09T23:19:32.3560597Z -    
2025-11-09T23:19:32.3560710Z +
2025-11-09T23:19:32.3560882Z      /// Save mempool to disk for persistence
2025-11-09T23:19:32.3561243Z      pub fn save_to_disk<P: AsRef<std::path::Path>>(&self, path: P) -> Result<()> {
2025-11-09T23:19:32.3561587Z +        use bllvm_protocol::serialization::transaction::serialize_transaction;
2025-11-09T23:19:32.3561995Z          use std::fs::File;
2025-11-09T23:19:32.3562144Z          use std::io::Write;
2025-11-09T23:19:32.3562491Z -        use bllvm_protocol::serialization::transaction::serialize_transaction;
2025-11-09T23:19:32.3562608Z -        
2025-11-09T23:19:32.3562719Z +
2025-11-09T23:19:32.3562916Z          let transactions = self.get_transactions();
2025-11-09T23:19:32.3563088Z          let mut file = File::create(path)?;
2025-11-09T23:19:32.3563201Z -        
2025-11-09T23:19:32.3563315Z +
2025-11-09T23:19:32.3563459Z          // Write transaction count
2025-11-09T23:19:32.3563717Z          file.write_all(&(transactions.len() as u32).to_le_bytes())?;
2025-11-09T23:19:32.3563831Z -        
2025-11-09T23:19:32.3563949Z +
2025-11-09T23:19:32.3564091Z          // Write each transaction
2025-11-09T23:19:32.3564234Z          for tx in transactions {
2025-11-09T23:19:32.3564572Z              let serialized = serialize_transaction(&tx);
2025-11-09T23:19:32.3565042Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:272:
2025-11-09T23:19:32.3565301Z              file.write_all(&(serialized.len() as u32).to_le_bytes())?;
2025-11-09T23:19:32.3565460Z              file.write_all(&serialized)?;
2025-11-09T23:19:32.3565586Z          }
2025-11-09T23:19:32.3565701Z -        
2025-11-09T23:19:32.3565808Z +
2025-11-09T23:19:32.3565948Z          file.sync_all()?;
2025-11-09T23:19:32.3566063Z          Ok(())
2025-11-09T23:19:32.3566175Z      }
2025-11-09T23:19:32.3566625Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:279:
2025-11-09T23:19:32.3566750Z  }
2025-11-09T23:19:32.3566860Z  
2025-11-09T23:19:32.3567022Z  impl Default for MempoolManager {
2025-11-09T23:19:32.3567195Z -    fn default() -> Self { Self::new() }
2025-11-09T23:19:32.3567336Z +    fn default() -> Self {
2025-11-09T23:19:32.3567461Z +        Self::new()
2025-11-09T23:19:32.3567572Z +    }
2025-11-09T23:19:32.3567690Z  }
2025-11-09T23:19:32.3567804Z  
2025-11-09T23:19:32.3568156Z  // Implement MempoolProvider trait for integration with MiningCoordinator
2025-11-09T23:19:32.3568859Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:298:
2025-11-09T23:19:32.3568990Z          self.size()
2025-11-09T23:19:32.3569104Z      }
2025-11-09T23:19:32.3569215Z  
2025-11-09T23:19:32.3569858Z -    fn get_prioritized_transactions(&self, limit: usize, utxo_set: &bllvm_protocol::UtxoSet) -> Vec<bllvm_protocol::Transaction> {
2025-11-09T23:19:32.3570035Z +    fn get_prioritized_transactions(
2025-11-09T23:19:32.3570150Z +        &self,
2025-11-09T23:19:32.3570281Z +        limit: usize,
2025-11-09T23:19:32.3570452Z +        utxo_set: &bllvm_protocol::UtxoSet,
2025-11-09T23:19:32.3570620Z +    ) -> Vec<bllvm_protocol::Transaction> {
2025-11-09T23:19:32.3570846Z          self.get_prioritized_transactions(limit, utxo_set)
2025-11-09T23:19:32.3570964Z      }
2025-11-09T23:19:32.3571074Z  
2025-11-09T23:19:32.3571537Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:312:
2025-11-09T23:19:32.3571693Z  impl MempoolManager {
2025-11-09T23:19:32.3571834Z      /// Load mempool from disk
2025-11-09T23:19:32.3572195Z      pub fn load_from_disk<P: AsRef<std::path::Path>>(&mut self, path: P) -> Result<()> {
2025-11-09T23:19:32.3572547Z +        use bllvm_protocol::serialization::transaction::deserialize_transaction;
2025-11-09T23:19:32.3572689Z          use std::fs::File;
2025-11-09T23:19:32.3572822Z          use std::io::Read;
2025-11-09T23:19:32.3573148Z -        use bllvm_protocol::serialization::transaction::deserialize_transaction;
2025-11-09T23:19:32.3573273Z -        
2025-11-09T23:19:32.3573385Z +
2025-11-09T23:19:32.3573555Z          let mut file = File::open(path)?;
2025-11-09T23:19:32.3573711Z          let mut count_bytes = [0u8; 4];
2025-11-09T23:19:32.3573866Z          file.read_exact(&mut count_bytes)?;
2025-11-09T23:19:32.3574460Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:322:
2025-11-09T23:19:32.3574936Z          let count = u32::from_le_bytes(count_bytes) as usize;
2025-11-09T23:19:32.3575062Z -        
2025-11-09T23:19:32.3575177Z +
2025-11-09T23:19:32.3575311Z          for _ in 0..count {
2025-11-09T23:19:32.3575468Z              let mut len_bytes = [0u8; 4];
2025-11-09T23:19:32.3575630Z              file.read_exact(&mut len_bytes)?;
2025-11-09T23:19:32.3576084Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:327:
2025-11-09T23:19:32.3576301Z              let len = u32::from_le_bytes(len_bytes) as usize;
2025-11-09T23:19:32.3576595Z -            
2025-11-09T23:19:32.3576714Z +
2025-11-09T23:19:32.3576876Z              let mut tx_bytes = vec![0u8; len];
2025-11-09T23:19:32.3577040Z              file.read_exact(&mut tx_bytes)?;
2025-11-09T23:19:32.3577155Z -            
2025-11-09T23:19:32.3577261Z +
2025-11-09T23:19:32.3577465Z              let tx = deserialize_transaction(&tx_bytes)?;
2025-11-09T23:19:32.3577634Z              let _ = self.add_transaction(tx);
2025-11-09T23:19:32.3577749Z          }
2025-11-09T23:19:32.3578206Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:335:
2025-11-09T23:19:32.3578326Z -        
2025-11-09T23:19:32.3578435Z +
2025-11-09T23:19:32.3578555Z          Ok(())
2025-11-09T23:19:32.3578674Z      }
2025-11-09T23:19:32.3578784Z  }
2025-11-09T23:19:32.3579249Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/metrics.rs:2:
2025-11-09T23:19:32.3579366Z  //!
2025-11-09T23:19:32.3579783Z  //! Provides comprehensive metrics for monitoring node health, performance, and behavior.
2025-11-09T23:19:32.3579896Z  
2025-11-09T23:19:32.3580449Z +use serde::{Deserialize, Serialize};
2025-11-09T23:19:32.3580613Z  use std::sync::Arc;
2025-11-09T23:19:32.3580744Z  use std::sync::Mutex;
2025-11-09T23:19:32.3580954Z  use std::time::{Duration, SystemTime, UNIX_EPOCH};
2025-11-09T23:19:32.3581400Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/metrics.rs:8:
2025-11-09T23:19:32.3581581Z -use serde::{Deserialize, Serialize};
2025-11-09T23:19:32.3581927Z  
2025-11-09T23:19:32.3582089Z  /// Comprehensive node metrics
2025-11-09T23:19:32.3582282Z  #[derive(Debug, Clone, Serialize, Deserialize)]
2025-11-09T23:19:32.3582801Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/metrics.rs:251:
2025-11-09T23:19:32.3582948Z          Self::new()
2025-11-09T23:19:32.3583068Z      }
2025-11-09T23:19:32.3583180Z  }
2025-11-09T23:19:32.3583293Z -
2025-11-09T23:19:32.3583408Z  
2025-11-09T23:19:32.3631266Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/miner.rs:20:
2025-11-09T23:19:32.3632045Z  
2025-11-09T23:19:32.3632389Z      /// Get prioritized transactions (by fee rate)
2025-11-09T23:19:32.3632927Z      /// Requires UTXO set for accurate fee calculation
2025-11-09T23:19:32.3633846Z -    fn get_prioritized_transactions(&self, limit: usize, utxo_set: &bllvm_protocol::UtxoSet) -> Vec<Transaction>;
2025-11-09T23:19:32.3634905Z +    fn get_prioritized_transactions(
2025-11-09T23:19:32.3635356Z +        &self,
2025-11-09T23:19:32.3635671Z +        limit: usize,
2025-11-09T23:19:32.3636065Z +        utxo_set: &bllvm_protocol::UtxoSet,
2025-11-09T23:19:32.3636526Z +    ) -> Vec<Transaction>;
2025-11-09T23:19:32.3636877Z  
2025-11-09T23:19:32.3637189Z      /// Remove transaction from mempool
2025-11-09T23:19:32.3637732Z      fn remove_transaction(&mut self, hash: &[u8; 32]) -> bool;
2025-11-09T23:19:32.3640434Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/miner.rs:57:
2025-11-09T23:19:32.3641141Z  
2025-11-09T23:19:32.3641438Z      /// Select transactions for block
2025-11-09T23:19:32.3642050Z      /// Note: Requires UTXO set for fee calculation - caller must provide it
2025-11-09T23:19:32.3643165Z -    pub fn select_transactions(&self, mempool: &dyn MempoolProvider, utxo_set: &bllvm_protocol::UtxoSet) -> Vec<Transaction> {
2025-11-09T23:19:32.3644637Z +    pub fn select_transactions(
2025-11-09T23:19:32.3645048Z +        &self,
2025-11-09T23:19:32.3645408Z +        mempool: &dyn MempoolProvider,
2025-11-09T23:19:32.3645941Z +        utxo_set: &bllvm_protocol::UtxoSet,
2025-11-09T23:19:32.3646397Z +    ) -> Vec<Transaction> {
2025-11-09T23:19:32.3646797Z          let mut selected = Vec::new();
2025-11-09T23:19:32.3647238Z          let mut current_size = 0;
2025-11-09T23:19:32.3647652Z          let mut current_weight = 0;
2025-11-09T23:19:32.3648379Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/miner.rs:392:
2025-11-09T23:19:32.3650707Z  
2025-11-09T23:19:32.3651112Z          // Get chain tip from storage for prev_block_hash and difficulty
2025-11-09T23:19:32.3651871Z          let (prev_block_hash, bits, height) = if let Some(ref storage) = self.storage {
2025-11-09T23:19:32.3652617Z -            if let Some(tip_header) = storage.chain().get_tip_header()
2025-11-09T23:19:32.3653325Z -                .map_err(|e| anyhow::anyhow!("Failed to get tip header: {}", e))? {
2025-11-09T23:19:32.3654039Z -                let tip_hash = storage.chain().get_tip_hash()
2025-11-09T23:19:32.3654820Z +            if let Some(tip_header) = storage
2025-11-09T23:19:32.3655250Z +                .chain()
2025-11-09T23:19:32.3655602Z +                .get_tip_header()
2025-11-09T23:19:32.3656127Z +                .map_err(|e| anyhow::anyhow!("Failed to get tip header: {}", e))?
2025-11-09T23:19:32.3656630Z +            {
2025-11-09T23:19:32.3656929Z +                let tip_hash = storage
2025-11-09T23:19:32.3657317Z +                    .chain()
2025-11-09T23:19:32.3657654Z +                    .get_tip_hash()
2025-11-09T23:19:32.3658170Z                      .map_err(|e| anyhow::anyhow!("Failed to get tip hash: {}", e))?
2025-11-09T23:19:32.3660564Z                      .unwrap_or([0u8; 32]);
2025-11-09T23:19:32.3661041Z -                let chain_height = storage.chain().get_height()
2025-11-09T23:19:32.3661534Z +                let chain_height = storage
2025-11-09T23:19:32.3661919Z +                    .chain()
2025-11-09T23:19:32.3662255Z +                    .get_height()
2025-11-09T23:19:32.3662981Z                      .map_err(|e| anyhow::anyhow!("Failed to get chain height: {}", e))?
2025-11-09T23:19:32.3663486Z                      .unwrap_or(0);
2025-11-09T23:19:32.3663909Z                  (tip_hash, tip_header.bits, chain_height)
2025-11-09T23:19:32.3664796Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/miner.rs:412:
2025-11-09T23:19:32.3665452Z  
2025-11-09T23:19:32.3665752Z          // Get UTXO set from storage for fee calculation
2025-11-09T23:19:32.3666274Z          let utxo_set = if let Some(ref storage) = self.storage {
2025-11-09T23:19:32.3666772Z -            storage.utxos().get_all_utxos()
2025-11-09T23:19:32.3667162Z +            storage
2025-11-09T23:19:32.3667451Z +                .utxos()
2025-11-09T23:19:32.3667761Z +                .get_all_utxos()
2025-11-09T23:19:32.3668241Z                  .map_err(|e| anyhow::anyhow!("Failed to get UTXO set: {}", e))?
2025-11-09T23:19:32.3670599Z          } else {
2025-11-09T23:19:32.3670997Z              // No storage - use empty UTXO set (will result in 0 fees)
2025-11-09T23:19:32.3671745Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/miner.rs:616:
2025-11-09T23:19:32.3672433Z          self.transactions.len()
2025-11-09T23:19:32.3672788Z      }
2025-11-09T23:19:32.3673068Z  
2025-11-09T23:19:32.3673758Z -    fn get_prioritized_transactions(&self, limit: usize, _utxo_set: &bllvm_protocol::UtxoSet) -> Vec<Transaction> {
2025-11-09T23:19:32.3674792Z +    fn get_prioritized_transactions(
2025-11-09T23:19:32.3675226Z +        &self,
2025-11-09T23:19:32.3675526Z +        limit: usize,
2025-11-09T23:19:32.3675909Z +        _utxo_set: &bllvm_protocol::UtxoSet,
2025-11-09T23:19:32.3676353Z +    ) -> Vec<Transaction> {
2025-11-09T23:19:32.3676945Z          // Mock implementation ignores UTXO set and uses pre-calculated priorities
2025-11-09T23:19:32.3677874Z          self.prioritized_transactions
2025-11-09T23:19:32.3678302Z              .iter()
2025-11-09T23:19:32.3678950Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/miner.rs:786:
2025-11-09T23:19:32.3679742Z          assert_eq!(mempool.get_mempool_size(), 0);
2025-11-09T23:19:32.3680297Z          assert!(mempool.get_transactions().is_empty());
2025-11-09T23:19:32.3682542Z          let empty_utxo_set = bllvm_protocol::UtxoSet::new();
2025-11-09T23:19:32.3683347Z -        assert!(mempool.get_prioritized_transactions(10, &empty_utxo_set).is_empty());
2025-11-09T23:19:32.3684021Z +        assert!(mempool
2025-11-09T23:19:32.3684645Z +            .get_prioritized_transactions(10, &empty_utxo_set)
2025-11-09T23:19:32.3685170Z +            .is_empty());
2025-11-09T23:19:32.3685514Z      }
2025-11-09T23:19:32.3685778Z  
2025-11-09T23:19:32.3686031Z      #[test]
2025-11-09T23:19:32.3772956Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:5:
2025-11-09T23:19:32.3773781Z  
2025-11-09T23:19:32.3774099Z  pub mod block_processor;
2025-11-09T23:19:32.3774675Z  pub mod event_publisher;
2025-11-09T23:19:32.3781943Z +pub mod health;
2025-11-09T23:19:32.3782324Z  pub mod mempool;
2025-11-09T23:19:32.3782673Z -pub mod miner;
2025-11-09T23:19:32.3783015Z -pub mod sync;
2025-11-09T23:19:32.3783335Z  pub mod metrics;
2025-11-09T23:19:32.3783680Z -pub mod health;
2025-11-09T23:19:32.3784007Z +pub mod miner;
2025-11-09T23:19:32.3784597Z  pub mod performance;
2025-11-09T23:19:32.3784975Z +pub mod sync;
2025-11-09T23:19:32.3785284Z  
2025-11-09T23:19:32.3785593Z  use anyhow::Result;
2025-11-09T23:19:32.3785943Z  use std::net::SocketAddr;
2025-11-09T23:19:32.3786610Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:70:
2025-11-09T23:19:32.3787314Z  
2025-11-09T23:19:32.3787615Z          // Initialize components
2025-11-09T23:19:32.3788247Z          let protocol_version = protocol_version.unwrap_or(ProtocolVersion::Regtest);
2025-11-09T23:19:32.3790827Z -        let protocol =
2025-11-09T23:19:32.3791256Z -            BitcoinProtocolEngine::new(protocol_version)?;
2025-11-09T23:19:32.3792209Z +        let protocol = BitcoinProtocolEngine::new(protocol_version)?;
2025-11-09T23:19:32.3792841Z          let protocol_arc = Arc::new(protocol);
2025-11-09T23:19:32.3793316Z          let storage = Storage::new(data_dir)?;
2025-11-09T23:19:32.3793784Z          let storage_arc = Arc::new(storage);
2025-11-09T23:19:32.3794704Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:78:
2025-11-09T23:19:32.3795617Z          let mempool_manager_arc = Arc::new(mempool::MempoolManager::new());
2025-11-09T23:19:32.3796299Z -        let network = NetworkManager::new(network_addr)
2025-11-09T23:19:32.3797157Z -            .with_dependencies(Arc::clone(&protocol_arc), Arc::clone(&storage_arc), Arc::clone(&mempool_manager_arc));
2025-11-09T23:19:32.3798133Z +        let network = NetworkManager::new(network_addr).with_dependencies(
2025-11-09T23:19:32.3800659Z +            Arc::clone(&protocol_arc),
2025-11-09T23:19:32.3801400Z +            Arc::clone(&storage_arc),
2025-11-09T23:19:32.3801854Z +            Arc::clone(&mempool_manager_arc),
2025-11-09T23:19:32.3802282Z +        );
2025-11-09T23:19:32.3802605Z          let network_arc = Arc::new(network);
2025-11-09T23:19:32.3803147Z          let metrics_arc = Arc::new(MetricsCollector::new());
2025-11-09T23:19:32.3803785Z          let profiler_arc = Arc::new(PerformanceProfiler::new(1000));
2025-11-09T23:19:32.3804796Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:187:
2025-11-09T23:19:32.3805562Z          info!("Sync coordinator initialized");
2025-11-09T23:19:32.3806046Z          info!("Mempool manager initialized");
2025-11-09T23:19:32.3806551Z          info!("Mining coordinator initialized");
2025-11-09T23:19:32.3806991Z -        
2025-11-09T23:19:32.3807279Z +
2025-11-09T23:19:32.3807835Z          // Start network manager
2025-11-09T23:19:32.3808360Z          if let Err(e) = self.network.start(self.network_addr).await {
2025-11-09T23:19:32.3808999Z              warn!("Failed to start network manager: {}", e);
2025-11-09T23:19:32.3809769Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:194:
2025-11-09T23:19:32.3810564Z              // Continue anyway - network might be optional
2025-11-09T23:19:32.3811021Z          }
2025-11-09T23:19:32.3811291Z -        
2025-11-09T23:19:32.3811537Z +
2025-11-09T23:19:32.3811884Z          // Initialize peer connections automatically
2025-11-09T23:19:32.3812449Z          self.initialize_peer_connections().await?;
2025-11-09T23:19:32.3812901Z  
2025-11-09T23:19:32.3813441Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:203:
2025-11-09T23:19:32.3814120Z              if config.prune_on_startup {
2025-11-09T23:19:32.3814911Z                  let current_height = self.storage.chain().get_height()?.unwrap_or(0);
2025-11-09T23:19:32.3815584Z                  let is_ibd = current_height == 0;
2025-11-09T23:19:32.3815994Z -                
2025-11-09T23:19:32.3816305Z +
2025-11-09T23:19:32.3816663Z                  if !is_ibd && pruning_manager.is_enabled() {
2025-11-09T23:19:32.3817309Z                      info!("Prune on startup enabled, checking if pruning is needed...");
2025-11-09T23:19:32.3817904Z -                    
2025-11-09T23:19:32.3818229Z +
2025-11-09T23:19:32.3818587Z                      // Calculate prune height based on configuration
2025-11-09T23:19:32.3819151Z                      let prune_height = match &config.mode {
2025-11-09T23:19:32.3819690Z                          crate::config::PruningMode::Disabled => {
2025-11-09T23:19:32.3822116Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:213:
2025-11-09T23:19:32.3822837Z                              // Skip if disabled
2025-11-09T23:19:32.3823284Z                              None
2025-11-09T23:19:32.3823676Z                          }
2025-11-09T23:19:32.3824200Z -                        crate::config::PruningMode::Normal { keep_from_height, .. } => {
2025-11-09T23:19:32.3825318Z +                        crate::config::PruningMode::Normal {
2025-11-09T23:19:32.3825817Z +                            keep_from_height, ..
2025-11-09T23:19:32.3826262Z +                        } => {
2025-11-09T23:19:32.3826673Z                              // Prune up to keep_from_height
2025-11-09T23:19:32.3827182Z                              Some(*keep_from_height)
2025-11-09T23:19:32.3827612Z                          }
2025-11-09T23:19:32.3828240Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:220:
2025-11-09T23:19:32.3828976Z                          #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.3829593Z -                        crate::config::PruningMode::Aggressive { keep_from_height, .. } => {
2025-11-09T23:19:32.3831856Z +                        crate::config::PruningMode::Aggressive {
2025-11-09T23:19:32.3832362Z +                            keep_from_height, ..
2025-11-09T23:19:32.3832805Z +                        } => {
2025-11-09T23:19:32.3833224Z                              // Prune up to keep_from_height
2025-11-09T23:19:32.3833706Z                              Some(*keep_from_height)
2025-11-09T23:19:32.3834130Z                          }
2025-11-09T23:19:32.3834955Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:228:
2025-11-09T23:19:32.3835777Z                              // Fall back to no pruning if feature is disabled
2025-11-09T23:19:32.3836304Z                              None
2025-11-09T23:19:32.3836683Z                          }
2025-11-09T23:19:32.3837246Z -                        crate::config::PruningMode::Custom { keep_bodies_from_height, .. } => {
2025-11-09T23:19:32.3837933Z +                        crate::config::PruningMode::Custom {
2025-11-09T23:19:32.3838444Z +                            keep_bodies_from_height,
2025-11-09T23:19:32.3839141Z +                            ..
2025-11-09T23:19:32.3839492Z +                        } => {
2025-11-09T23:19:32.3839923Z                              // Prune up to keep_bodies_from_height
2025-11-09T23:19:32.3840443Z                              Some(*keep_bodies_from_height)
2025-11-09T23:19:32.3840885Z                          }
2025-11-09T23:19:32.3841531Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:235:
2025-11-09T23:19:32.3842228Z                      };
2025-11-09T23:19:32.3842563Z -                    
2025-11-09T23:19:32.3842884Z +
2025-11-09T23:19:32.3843234Z                      if let Some(prune_to_height) = prune_height {
2025-11-09T23:19:32.3843779Z                          if prune_to_height < current_height {
2025-11-09T23:19:32.3844699Z -                            match pruning_manager.prune_to_height(prune_to_height, current_height, is_ibd) {
2025-11-09T23:19:32.3845531Z +                            match pruning_manager.prune_to_height(
2025-11-09T23:19:32.3846060Z +                                prune_to_height,
2025-11-09T23:19:32.3846542Z +                                current_height,
2025-11-09T23:19:32.3846975Z +                                is_ibd,
2025-11-09T23:19:32.3847391Z +                            ) {
2025-11-09T23:19:32.3847789Z                                  Ok(stats) => {
2025-11-09T23:19:32.3848414Z                                      info!("Startup pruning completed: {} blocks pruned, {} blocks kept", 
2025-11-09T23:19:32.3850591Z                                            stats.blocks_pruned, stats.blocks_kept);
2025-11-09T23:19:32.3851397Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:243:
2025-11-09T23:19:32.3852211Z                                      // Flush storage to persist pruning changes
2025-11-09T23:19:32.3852766Z                                      if let Err(e) = self.storage.flush() {
2025-11-09T23:19:32.3854557Z -                                        warn!("Failed to flush storage after startup pruning: {}", e);
2025-11-09T23:19:32.3855217Z +                                        warn!(
2025-11-09T23:19:32.3856029Z +                                            "Failed to flush storage after startup pruning: {}",
2025-11-09T23:19:32.3856591Z +                                            e
2025-11-09T23:19:32.3857023Z +                                        );
2025-11-09T23:19:32.3857447Z                                      }
2025-11-09T23:19:32.3857834Z                                  }
2025-11-09T23:19:32.3858239Z                                  Err(e) => {
2025-11-09T23:19:32.3860672Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:292:
2025-11-09T23:19:32.3861379Z      }
2025-11-09T23:19:32.3861656Z  
2025-11-09T23:19:32.3861991Z      /// Initialize peer connections automatically
2025-11-09T23:19:32.3862460Z -    /// 
2025-11-09T23:19:32.3862740Z +    ///
2025-11-09T23:19:32.3863268Z      /// Determines network type from protocol version and uses config if available.
2025-11-09T23:19:32.3864011Z      async fn initialize_peer_connections(&self) -> Result<()> {
2025-11-09T23:19:32.3864799Z          // Determine network type from protocol version
2025-11-09T23:19:32.3865551Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:306:
2025-11-09T23:19:32.3866312Z                  if let Some(ref config) = self.config {
2025-11-09T23:19:32.3866888Z                      if let Some(ref persistent_peers) = config.persistent_peers {
2025-11-09T23:19:32.3867460Z                          if !persistent_peers.is_empty() {
2025-11-09T23:19:32.3868176Z -                            if let Err(e) = self.network.connect_persistent_peers(persistent_peers).await {
2025-11-09T23:19:32.3868817Z +                            if let Err(e) = self
2025-11-09T23:19:32.3869249Z +                                .network
2025-11-09T23:19:32.3869747Z +                                .connect_persistent_peers(persistent_peers)
2025-11-09T23:19:32.3870467Z +                                .await
2025-11-09T23:19:32.3870879Z +                            {
2025-11-09T23:19:32.3871469Z                                  warn!("Failed to connect to some persistent peers: {}", e);
2025-11-09T23:19:32.3872005Z                              }
2025-11-09T23:19:32.3872350Z                          }
2025-11-09T23:19:32.3873004Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:315:
2025-11-09T23:19:32.3873726Z                  return Ok(());
2025-11-09T23:19:32.3874091Z              }
2025-11-09T23:19:32.3874581Z          };
2025-11-09T23:19:32.3874873Z -        
2025-11-09T23:19:32.3875163Z +
2025-11-09T23:19:32.3875530Z          // Get port from network address
2025-11-09T23:19:32.3876017Z          let port = self.network_addr.port();
2025-11-09T23:19:32.3876454Z -        
2025-11-09T23:19:32.3876731Z +
2025-11-09T23:19:32.3877225Z          // Default target peer count (Bitcoin Core uses 8-125, we'll use 8 as default)
2025-11-09T23:19:32.3877883Z          let target_peer_count = 8;
2025-11-09T23:19:32.3878296Z -        
2025-11-09T23:19:32.3878567Z +
2025-11-09T23:19:32.3878911Z          // Use config if available, otherwise use defaults
2025-11-09T23:19:32.3879428Z          let default_config = NodeConfig {
2025-11-09T23:19:32.3879885Z              listen_addr: Some(self.network_addr),
2025-11-09T23:19:32.3881098Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:328:
2025-11-09T23:19:32.3881865Z              ..Default::default()
2025-11-09T23:19:32.3882220Z          };
2025-11-09T23:19:32.3882637Z          let config = self.config.as_ref().unwrap_or(&default_config);
2025-11-09T23:19:32.3883238Z -        
2025-11-09T23:19:32.3883561Z +
2025-11-09T23:19:32.3883845Z          // Initialize peer connections
2025-11-09T23:19:32.3884495Z -        if let Err(e) = self.network.initialize_peer_connections(
2025-11-09T23:19:32.3884975Z -            config,
2025-11-09T23:19:32.3885279Z -            network,
2025-11-09T23:19:32.3885595Z -            port,
2025-11-09T23:19:32.3886172Z -            target_peer_count,
2025-11-09T23:19:32.3886541Z -        ).await {
2025-11-09T23:19:32.3886866Z +        if let Err(e) = self
2025-11-09T23:19:32.3887224Z +            .network
2025-11-09T23:19:32.3887762Z +            .initialize_peer_connections(config, network, port, target_peer_count)
2025-11-09T23:19:32.3888375Z +            .await
2025-11-09T23:19:32.3888674Z +        {
2025-11-09T23:19:32.3889061Z              warn!("Failed to initialize peer connections: {}", e);
2025-11-09T23:19:32.3889668Z              // Don't fail startup - peer connections are best-effort
2025-11-09T23:19:32.3890146Z          }
2025-11-09T23:19:32.3890728Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:342:
2025-11-09T23:19:32.3891422Z -        
2025-11-09T23:19:32.3891680Z +
2025-11-09T23:19:32.3891922Z          Ok(())
2025-11-09T23:19:32.3892196Z      }
2025-11-09T23:19:32.3892434Z  
2025-11-09T23:19:32.3892937Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:368:
2025-11-09T23:19:32.3893579Z                  ) {
2025-11-09T23:19:32.3893864Z                      Ok(true) => {
2025-11-09T23:19:32.3894497Z                          info!("Block accepted at height {}", current_height);
2025-11-09T23:19:32.3895015Z -                        
2025-11-09T23:19:32.3895357Z +
2025-11-09T23:19:32.3895724Z                          // Persist UTXO set to storage after block validation
2025-11-09T23:19:32.3896415Z                          // This is critical for commitment generation and incremental pruning
2025-11-09T23:19:32.3897152Z                          if let Err(e) = self.storage.utxos().store_utxo_set(&utxo_set) {
2025-11-09T23:19:32.3897995Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:375:
2025-11-09T23:19:32.3898909Z -                            warn!("Failed to persist UTXO set after block {}: {}", current_height, e);
2025-11-09T23:19:32.3899850Z +                            warn!(
2025-11-09T23:19:32.3900345Z +                                "Failed to persist UTXO set after block {}: {}",
2025-11-09T23:19:32.3900878Z +                                current_height, e
2025-11-09T23:19:32.3901489Z +                            );
2025-11-09T23:19:32.3901851Z                          }
2025-11-09T23:19:32.3902195Z -                        
2025-11-09T23:19:32.3902528Z +
2025-11-09T23:19:32.3902912Z                          // Generate UTXO commitment from current state (if enabled)
2025-11-09T23:19:32.3903637Z                          // Use current_height (the block that was just validated) before incrementing
2025-11-09T23:19:32.3904485Z                          #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.3905785Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:381:
2025-11-09T23:19:32.3906535Z                          {
2025-11-09T23:19:32.3907000Z                              if let Some(pruning_manager) = self.storage.pruning() {
2025-11-09T23:19:32.3907637Z -                                if let (Some(commitment_store), Some(_utxostore)) = 
2025-11-09T23:19:32.3908333Z -                                    (pruning_manager.commitment_store(), pruning_manager.utxostore()) 
2025-11-09T23:19:32.3908947Z -                                {
2025-11-09T23:19:32.3909444Z +                                if let (Some(commitment_store), Some(_utxostore)) = (
2025-11-09T23:19:32.3909998Z +                                    pruning_manager.commitment_store(),
2025-11-09T23:19:32.3910519Z +                                    pruning_manager.utxostore(),
2025-11-09T23:19:32.3910977Z +                                ) {
2025-11-09T23:19:32.3911529Z                                      // Get block hash from storage (block was just stored at current_height)
2025-11-09T23:19:32.3912193Z                                      let blocks_arc = self.storage.blocks();
2025-11-09T23:19:32.3912901Z -                                    if let Ok(Some(block_hash)) = blocks_arc.get_hash_by_height(current_height) {
2025-11-09T23:19:32.3913802Z +                                    if let Ok(Some(block_hash)) =
2025-11-09T23:19:32.3914502Z +                                        blocks_arc.get_hash_by_height(current_height)
2025-11-09T23:19:32.3914988Z +                                    {
2025-11-09T23:19:32.3915452Z                                          // Generate commitment from current UTXO set state
2025-11-09T23:19:32.3916112Z -                                        if let Err(e) = pruning_manager.generate_commitment_from_current_state(
2025-11-09T23:19:32.3916726Z -                                            &block_hash,
2025-11-09T23:19:32.3917199Z -                                            current_height,
2025-11-09T23:19:32.3917625Z -                                            &utxo_set,
2025-11-09T23:19:32.3918038Z -                                            &commitment_store,
2025-11-09T23:19:32.3918465Z -                                        ) {
2025-11-09T23:19:32.3919044Z -                                            warn!("Failed to generate commitment for block {}: {}", current_height, e);
2025-11-09T23:19:32.3919674Z +                                        if let Err(e) = pruning_manager
2025-11-09T23:19:32.3920169Z +                                            .generate_commitment_from_current_state(
2025-11-09T23:19:32.3920643Z +                                                &block_hash,
2025-11-09T23:19:32.3921073Z +                                                current_height,
2025-11-09T23:19:32.3921495Z +                                                &utxo_set,
2025-11-09T23:19:32.3921924Z +                                                &commitment_store,
2025-11-09T23:19:32.3922331Z +                                            )
2025-11-09T23:19:32.3922711Z +                                        {
2025-11-09T23:19:32.3923349Z +                                            warn!(
2025-11-09T23:19:32.3923871Z +                                                "Failed to generate commitment for block {}: {}",
2025-11-09T23:19:32.3924627Z +                                                current_height, e
2025-11-09T23:19:32.3925041Z +                                            );
2025-11-09T23:19:32.3925424Z                                          } else {
2025-11-09T23:19:32.3925961Z -                                            debug!("Generated UTXO commitment for block {}", current_height);
2025-11-09T23:19:32.3926523Z +                                            debug!(
2025-11-09T23:19:32.3926964Z +                                                "Generated UTXO commitment for block {}",
2025-11-09T23:19:32.3927435Z +                                                current_height
2025-11-09T23:19:32.3927852Z +                                            );
2025-11-09T23:19:32.3928271Z                                          }
2025-11-09T23:19:32.3930592Z                                      } else {
2025-11-09T23:19:32.3931215Z                                          warn!("Could not find block hash for height {} to generate commitment", current_height);
2025-11-09T23:19:32.3932196Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:403:
2025-11-09T23:19:32.3932935Z                                  }
2025-11-09T23:19:32.3933322Z                              }
2025-11-09T23:19:32.3933692Z                          }
2025-11-09T23:19:32.3934037Z -                        
2025-11-09T23:19:32.3934546Z +
2025-11-09T23:19:32.3934882Z                          // Increment height after processing
2025-11-09T23:19:32.3935375Z                          current_height += 1;
2025-11-09T23:19:32.3935758Z -                        
2025-11-09T23:19:32.3936063Z +
2025-11-09T23:19:32.3936361Z                          // Check for incremental pruning during IBD
2025-11-09T23:19:32.3937026Z                          // Consider IBD if we're still syncing (height < tip or no recent blocks)
2025-11-09T23:19:32.3937888Z                          let is_ibd = current_height < 1000; // Simple heuristic: consider IBD if < 1000 blocks
2025-11-09T23:19:32.3939110Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:413:
2025-11-09T23:19:32.3940024Z                          if let Some(pruning_manager) = self.storage.pruning() {
2025-11-09T23:19:32.3942640Z -                            if let Ok(Some(prune_stats)) = pruning_manager.incremental_prune_during_ibd(current_height, is_ibd) {
2025-11-09T23:19:32.3943555Z +                            if let Ok(Some(prune_stats)) =
2025-11-09T23:19:32.3944226Z +                                pruning_manager.incremental_prune_during_ibd(current_height, is_ibd)
2025-11-09T23:19:32.3945027Z +                            {
2025-11-09T23:19:32.3945624Z                                  info!("Incremental pruning during IBD: {} blocks pruned, {} bytes freed", 
2025-11-09T23:19:32.3946396Z                                        prune_stats.blocks_pruned, prune_stats.storage_freed);
2025-11-09T23:19:32.3947018Z                                  // Flush storage to persist pruning changes
2025-11-09T23:19:32.3947770Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:418:
2025-11-09T23:19:32.3948484Z                                  if let Err(e) = self.storage.flush() {
2025-11-09T23:19:32.3951130Z -                                    warn!("Failed to flush storage after incremental pruning: {}", e);
2025-11-09T23:19:32.3951721Z +                                    warn!(
2025-11-09T23:19:32.3952256Z +                                        "Failed to flush storage after incremental pruning: {}",
2025-11-09T23:19:32.3952805Z +                                        e
2025-11-09T23:19:32.3953214Z +                                    );
2025-11-09T23:19:32.3953587Z                                  }
2025-11-09T23:19:32.3953927Z                              }
2025-11-09T23:19:32.3954671Z                          }
2025-11-09T23:19:32.3955307Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:423:
2025-11-09T23:19:32.3956034Z -                        
2025-11-09T23:19:32.3956348Z +
2025-11-09T23:19:32.3956687Z                          // Check for automatic pruning after block acceptance
2025-11-09T23:19:32.3957269Z                          if let Some(pruning_manager) = self.storage.pruning() {
2025-11-09T23:19:32.3957855Z                              let stats = pruning_manager.get_stats();
2025-11-09T23:19:32.3958560Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:427:
2025-11-09T23:19:32.3960780Z -                            let should_prune = pruning_manager.should_auto_prune(
2025-11-09T23:19:32.3961288Z -                                current_height,
2025-11-09T23:19:32.3961708Z -                                stats.last_prune_height,
2025-11-09T23:19:32.3962135Z -                            );
2025-11-09T23:19:32.3962515Z -                            
2025-11-09T23:19:32.3962891Z +                            let should_prune = pruning_manager
2025-11-09T23:19:32.3963440Z +                                .should_auto_prune(current_height, stats.last_prune_height);
2025-11-09T23:19:32.3963945Z +
2025-11-09T23:19:32.3964213Z                              if should_prune {
2025-11-09T23:19:32.3964946Z                                  info!("Automatic pruning triggered at height {}", current_height);
2025-11-09T23:19:32.3965499Z -                                
2025-11-09T23:19:32.3965822Z +
2025-11-09T23:19:32.3966146Z                                  // Calculate prune height based on configuration
2025-11-09T23:19:32.3966702Z                                  let prune_height = match &pruning_manager.config.mode {
2025-11-09T23:19:32.3967282Z                                      crate::config::PruningMode::Disabled => None,
2025-11-09T23:19:32.3968734Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:438:
2025-11-09T23:19:32.3970080Z -                                    crate::config::PruningMode::Normal { keep_from_height, .. } => {
2025-11-09T23:19:32.3970915Z +                                    crate::config::PruningMode::Normal {
2025-11-09T23:19:32.3971380Z +                                        keep_from_height, ..
2025-11-09T23:19:32.3971788Z +                                    } => {
2025-11-09T23:19:32.3972264Z                                          // Prune to keep_from_height, but ensure we keep min_blocks
2025-11-09T23:19:32.3972967Z                                          let min_keep = pruning_manager.config.min_blocks_to_keep;
2025-11-09T23:19:32.3973806Z -                                        let effective_keep = (*keep_from_height).max(current_height.saturating_sub(min_keep));
2025-11-09T23:19:32.3974755Z +                                        let effective_keep = (*keep_from_height)
2025-11-09T23:19:32.3975377Z +                                            .max(current_height.saturating_sub(min_keep));
2025-11-09T23:19:32.3975875Z                                          Some(effective_keep)
2025-11-09T23:19:32.3976325Z                                      }
2025-11-09T23:19:32.3976742Z                                      #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.3977470Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:445:
2025-11-09T23:19:32.3978460Z -                                    crate::config::PruningMode::Aggressive { keep_from_height, min_blocks, .. } => {
2025-11-09T23:19:32.3979210Z +                                    crate::config::PruningMode::Aggressive {
2025-11-09T23:19:32.3979737Z +                                        keep_from_height,
2025-11-09T23:19:32.3980184Z +                                        min_blocks,
2025-11-09T23:19:32.3980629Z +                                        ..
2025-11-09T23:19:32.3981054Z +                                    } => {
2025-11-09T23:19:32.3981839Z                                          // Prune to keep_from_height, respecting min_blocks
2025-11-09T23:19:32.3982672Z -                                        let effective_keep = (*keep_from_height).max(current_height.saturating_sub(*min_blocks));
2025-11-09T23:19:32.3983438Z +                                        let effective_keep = (*keep_from_height)
2025-11-09T23:19:32.3984020Z +                                            .max(current_height.saturating_sub(*min_blocks));
2025-11-09T23:19:32.3984708Z                                          Some(effective_keep)
2025-11-09T23:19:32.3985111Z                                      }
2025-11-09T23:19:32.3985524Z                                      #[cfg(not(feature = "utxo-commitments"))]
2025-11-09T23:19:32.3986235Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:453:
2025-11-09T23:19:32.3987043Z                                          // Fall back to no pruning if feature is disabled
2025-11-09T23:19:32.3987581Z                                          None
2025-11-09T23:19:32.3987999Z                                      }
2025-11-09T23:19:32.3988613Z -                                    crate::config::PruningMode::Custom { keep_bodies_from_height, .. } => {
2025-11-09T23:19:32.3989292Z +                                    crate::config::PruningMode::Custom {
2025-11-09T23:19:32.3989815Z +                                        keep_bodies_from_height,
2025-11-09T23:19:32.3990273Z +                                        ..
2025-11-09T23:19:32.3990673Z +                                    } => {
2025-11-09T23:19:32.3991180Z                                          // Prune to keep_bodies_from_height, respecting min_blocks
2025-11-09T23:19:32.3992403Z                                          let min_keep = pruning_manager.config.min_blocks_to_keep;
2025-11-09T23:19:32.3993326Z -                                        let effective_keep = (*keep_bodies_from_height).max(current_height.saturating_sub(min_keep));
2025-11-09T23:19:32.3994170Z +                                        let effective_keep = (*keep_bodies_from_height)
2025-11-09T23:19:32.3995229Z +                                            .max(current_height.saturating_sub(min_keep));
2025-11-09T23:19:32.3995772Z                                          Some(effective_keep)
2025-11-09T23:19:32.3996216Z                                      }
2025-11-09T23:19:32.3996592Z                                  };
2025-11-09T23:19:32.3997256Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:463:
2025-11-09T23:19:32.3997971Z -                                
2025-11-09T23:19:32.3999919Z +
2025-11-09T23:19:32.4000271Z                                  if let Some(prune_to_height) = prune_height {
2025-11-09T23:19:32.4000896Z                                      if prune_to_height < current_height {
2025-11-09T23:19:32.4001862Z -                                        match pruning_manager.prune_to_height(prune_to_height, current_height, false) {
2025-11-09T23:19:32.4002611Z +                                        match pruning_manager.prune_to_height(
2025-11-09T23:19:32.4003101Z +                                            prune_to_height,
2025-11-09T23:19:32.4003594Z +                                            current_height,
2025-11-09T23:19:32.4004028Z +                                            false,
2025-11-09T23:19:32.4004665Z +                                        ) {
2025-11-09T23:19:32.4005084Z                                              Ok(prune_stats) => {
2025-11-09T23:19:32.4005742Z                                                  info!("Automatic pruning completed: {} blocks pruned, {} blocks kept", 
2025-11-09T23:19:32.4006498Z                                                        prune_stats.blocks_pruned, prune_stats.blocks_kept);
2025-11-09T23:19:32.4008698Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:596:
2025-11-09T23:19:32.4009713Z      /// Get health report
2025-11-09T23:19:32.4010183Z      pub fn health_check(&self) -> health::HealthReport {
2025-11-09T23:19:32.4010735Z          use crate::node::health::HealthChecker;
2025-11-09T23:19:32.4011179Z -        
2025-11-09T23:19:32.4011443Z +
2025-11-09T23:19:32.4011764Z          let checker = HealthChecker::new();
2025-11-09T23:19:32.4012294Z          let network_healthy = self.network.is_network_active();
2025-11-09T23:19:32.4013019Z          let storage_healthy = self.storage.check_storage_bounds().unwrap_or(false);
2025-11-09T23:19:32.4013920Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:603:
2025-11-09T23:19:32.4014960Z          let rpc_healthy = true; // RPC is always healthy if node is running
2025-11-09T23:19:32.4015492Z -        
2025-11-09T23:19:32.4015741Z +
2025-11-09T23:19:32.4016053Z          // Get metrics if available (simplified for now)
2025-11-09T23:19:32.4016499Z          checker.check_health(
2025-11-09T23:19:32.4016853Z              network_healthy,
2025-11-09T23:19:32.4017508Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/performance.rs:2:
2025-11-09T23:19:32.4018214Z  //!
2025-11-09T23:19:32.4019230Z  //! Provides performance tracking, profiling hooks, and performance metrics collection.
2025-11-09T23:19:32.4019874Z  
2025-11-09T23:19:32.4020162Z +use serde::{Deserialize, Serialize};
2025-11-09T23:19:32.4020553Z  use std::sync::Arc;
2025-11-09T23:19:32.4020860Z  use std::sync::Mutex;
2025-11-09T23:19:32.4022616Z  use std::time::{Duration, Instant};
2025-11-09T23:19:32.4023393Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/performance.rs:8:
2025-11-09T23:19:32.4024191Z -use serde::{Deserialize, Serialize};
2025-11-09T23:19:32.4024777Z  
2025-11-09T23:19:32.4025165Z  /// Performance profiler for tracking operation timings
2025-11-09T23:19:32.4036137Z  pub struct PerformanceProfiler {
2025-11-09T23:19:32.4036954Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/performance.rs:87:
2025-11-09T23:19:32.4037766Z          let total: Duration = times.iter().sum();
2025-11-09T23:19:32.4038541Z          let count = times.len();
2025-11-09T23:19:32.4038980Z          let avg = total / count as u32;
2025-11-09T23:19:32.4039395Z -        
2025-11-09T23:19:32.4039677Z +
2025-11-09T23:19:32.4039980Z          let mut sorted = times.to_vec();
2025-11-09T23:19:32.4040438Z          sorted.sort();
2025-11-09T23:19:32.4040776Z -        
2025-11-09T23:19:32.4042739Z +
2025-11-09T23:19:32.4043047Z          let p50 = sorted[count / 2];
2025-11-09T23:19:32.4043517Z          let p95 = sorted[(count * 95) / 100];
2025-11-09T23:19:32.4043982Z          let p99 = sorted[(count * 99) / 100];
2025-11-09T23:19:32.4044991Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/performance.rs:166:
2025-11-09T23:19:32.4045831Z      /// Stop the timer and record the duration
2025-11-09T23:19:32.4046321Z      pub fn stop(self) -> Duration {
2025-11-09T23:19:32.4046808Z          let duration = self.start.elapsed();
2025-11-09T23:19:32.4047238Z -        
2025-11-09T23:19:32.4047355Z +
2025-11-09T23:19:32.4047522Z          match self.operation_type {
2025-11-09T23:19:32.4047716Z              OperationType::BlockProcessing => {
2025-11-09T23:19:32.4047944Z                  self.profiler.record_block_processing(duration);
2025-11-09T23:19:32.4048448Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/performance.rs:181:
2025-11-09T23:19:32.4048676Z                  self.profiler.record_network_operation(duration);
2025-11-09T23:19:32.4048791Z              }
2025-11-09T23:19:32.4048917Z          }
2025-11-09T23:19:32.4049034Z -        
2025-11-09T23:19:32.4049146Z +
2025-11-09T23:19:32.4049267Z          duration
2025-11-09T23:19:32.4049389Z      }
2025-11-09T23:19:32.4049502Z  }
2025-11-09T23:19:32.4049977Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/performance.rs:191:
2025-11-09T23:19:32.4050155Z          Self::new(1000) // Keep last 1000 samples
2025-11-09T23:19:32.4050488Z      }
2025-11-09T23:19:32.4051065Z  }
2025-11-09T23:19:32.4051210Z -
2025-11-09T23:19:32.4051336Z  
2025-11-09T23:19:32.4051794Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/sync.rs:188:
2025-11-09T23:19:32.4051975Z          metrics: Option<Arc<MetricsCollector>>,
2025-11-09T23:19:32.4052179Z          profiler: Option<Arc<PerformanceProfiler>>,
2025-11-09T23:19:32.4052314Z      ) -> Result<bool> {
2025-11-09T23:19:32.4052497Z -        let _timer = profiler.as_ref().map(|p| {
2025-11-09T23:19:32.4052874Z -            PerformanceTimer::start(Arc::clone(p), OperationType::BlockProcessing)
2025-11-09T23:19:32.4052996Z -        });
2025-11-09T23:19:32.4053141Z +        let _timer = profiler
2025-11-09T23:19:32.4053262Z +            .as_ref()
2025-11-09T23:19:32.4053650Z +            .map(|p| PerformanceTimer::start(Arc::clone(p), OperationType::BlockProcessing));
2025-11-09T23:19:32.4053801Z          let start_time = Instant::now();
2025-11-09T23:19:32.4053916Z  
2025-11-09T23:19:32.4054144Z          // Parse block from wire format (extracts witness data)
2025-11-09T23:19:32.4054792Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/sync.rs:231:
2025-11-09T23:19:32.4054977Z                  metrics.update_performance(|m| {
2025-11-09T23:19:32.4055203Z                      let time_ms = processing_time.as_secs_f64() * 1000.0;
2025-11-09T23:19:32.4055526Z                      // Update average block processing time (exponential moving average)
2025-11-09T23:19:32.4055701Z -                    m.avg_block_processing_time_ms = 
2025-11-09T23:19:32.4055866Z +                    m.avg_block_processing_time_ms =
2025-11-09T23:19:32.4056110Z                          (m.avg_block_processing_time_ms * 0.9) + (time_ms * 0.1);
2025-11-09T23:19:32.4056261Z                      // Update blocks per second
2025-11-09T23:19:32.4056440Z                      if processing_time.as_secs_f64() > 0.0 {
2025-11-09T23:19:32.4058703Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/sync.rs:240:
2025-11-09T23:19:32.4059065Z                  });
2025-11-09T23:19:32.4059176Z              }
2025-11-09T23:19:32.4059288Z  
2025-11-09T23:19:32.4059726Z -            info!("Block validated and stored at height {} (took {:?})", current_height, processing_time);
2025-11-09T23:19:32.4059848Z +            info!(
2025-11-09T23:19:32.4060156Z +                "Block validated and stored at height {} (took {:?})",
2025-11-09T23:19:32.4060344Z +                current_height, processing_time
2025-11-09T23:19:32.4060466Z +            );
2025-11-09T23:19:32.4060583Z              Ok(true)
2025-11-09T23:19:32.4060698Z          } else {
2025-11-09T23:19:32.4060977Z              error!("Block validation failed at height {}", current_height);
2025-11-09T23:19:32.4061411Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:85:
2025-11-09T23:19:32.4061632Z          let elapsed = now.saturating_sub(self.last_refill);
2025-11-09T23:19:32.4061789Z          if elapsed > 0 {
2025-11-09T23:19:32.4062059Z              let tokens_to_add = (elapsed as u32).saturating_mul(self.rate);
2025-11-09T23:19:32.4062433Z -            self.tokens = self.tokens.saturating_add(tokens_to_add).min(self.burst_limit);
2025-11-09T23:19:32.4062576Z +            self.tokens = self
2025-11-09T23:19:32.4062692Z +                .tokens
2025-11-09T23:19:32.4062849Z +                .saturating_add(tokens_to_add)
2025-11-09T23:19:32.4062990Z +                .min(self.burst_limit);
2025-11-09T23:19:32.4063124Z              self.last_refill = now;
2025-11-09T23:19:32.4063227Z          }
2025-11-09T23:19:32.4063328Z  
2025-11-09T23:19:32.4063831Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:134:
2025-11-09T23:19:32.4063956Z      }
2025-11-09T23:19:32.4064069Z  
2025-11-09T23:19:32.4064230Z      /// Create with custom rate limits
2025-11-09T23:19:32.4064542Z -    pub fn with_rate_limits(
2025-11-09T23:19:32.4064913Z -        auth_required: bool,
2025-11-09T23:19:32.4065064Z -        default_burst: u32,
2025-11-09T23:19:32.4065216Z -        default_rate: u32,
2025-11-09T23:19:32.4065340Z -    ) -> Self {
2025-11-09T23:19:32.4065775Z +    pub fn with_rate_limits(auth_required: bool, default_burst: u32, default_rate: u32) -> Self {
2025-11-09T23:19:32.4065897Z          Self {
2025-11-09T23:19:32.4066130Z              valid_tokens: Arc::new(Mutex::new(HashMap::new())),
2025-11-09T23:19:32.4066393Z              valid_certificates: Arc::new(Mutex::new(HashMap::new())),
2025-11-09T23:19:32.4066827Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:154:
2025-11-09T23:19:32.4067088Z          let user_id = UserId::Token(AuthToken::new(token.clone()));
2025-11-09T23:19:32.4067288Z          let mut tokens = self.valid_tokens.lock().await;
2025-11-09T23:19:32.4067458Z          tokens.insert(token, user_id.clone());
2025-11-09T23:19:32.4067587Z -        
2025-11-09T23:19:32.4067717Z +
2025-11-09T23:19:32.4067883Z          // Initialize rate limiter for this user
2025-11-09T23:19:32.4068162Z          let (burst, rate) = self.get_rate_limit_for_user(&user_id).await;
2025-11-09T23:19:32.4068384Z          let mut limiters = self.rate_limiters.lock().await;
2025-11-09T23:19:32.4068809Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:161:
2025-11-09T23:19:32.4070790Z          limiters.insert(user_id, RpcRateLimiter::new(burst, rate));
2025-11-09T23:19:32.4071420Z -        
2025-11-09T23:19:32.4071532Z +
2025-11-09T23:19:32.4071640Z          Ok(())
2025-11-09T23:19:32.4071750Z      }
2025-11-09T23:19:32.4071860Z  
2025-11-09T23:19:32.4072304Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:178:
2025-11-09T23:19:32.4072566Z          let user_id = UserId::Certificate(fingerprint.clone());
2025-11-09T23:19:32.4072795Z          let mut certs = self.valid_certificates.lock().await;
2025-11-09T23:19:32.4072999Z          certs.insert(fingerprint, user_id.clone());
2025-11-09T23:19:32.4073115Z -        
2025-11-09T23:19:32.4073237Z +
2025-11-09T23:19:32.4073660Z          // Initialize rate limiter for this user
2025-11-09T23:19:32.4073925Z          let (burst, rate) = self.get_rate_limit_for_user(&user_id).await;
2025-11-09T23:19:32.4074143Z          let mut limiters = self.rate_limiters.lock().await;
2025-11-09T23:19:32.4074767Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:185:
2025-11-09T23:19:32.4075065Z          limiters.insert(user_id, RpcRateLimiter::new(burst, rate));
2025-11-09T23:19:32.4075199Z -        
2025-11-09T23:19:32.4075315Z +
2025-11-09T23:19:32.4075433Z          Ok(())
2025-11-09T23:19:32.4075554Z      }
2025-11-09T23:19:32.4075677Z  
2025-11-09T23:19:32.4076114Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:201:
2025-11-09T23:19:32.4076462Z      pub async fn set_user_rate_limit(&self, user_id: &UserId, burst: u32, rate: u32) {
2025-11-09T23:19:32.4076707Z          let mut limits = self.user_rate_limits.lock().await;
2025-11-09T23:19:32.4076911Z          limits.insert(user_id.clone(), (burst, rate));
2025-11-09T23:19:32.4077035Z -        
2025-11-09T23:19:32.4077146Z +
2025-11-09T23:19:32.4077337Z          // Update existing rate limiter if present
2025-11-09T23:19:32.4077550Z          let mut limiters = self.rate_limiters.lock().await;
2025-11-09T23:19:32.4077756Z          if let Some(limiter) = limiters.get_mut(user_id) {
2025-11-09T23:19:32.4078208Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:212:
2025-11-09T23:19:32.4078460Z      /// Get rate limit for a user (checks per-user limits first)
2025-11-09T23:19:32.4078773Z      async fn get_rate_limit_for_user(&self, user_id: &UserId) -> (u32, u32) {
2025-11-09T23:19:32.4078978Z          let limits = self.user_rate_limits.lock().await;
2025-11-09T23:19:32.4081184Z -        limits.get(user_id).copied().unwrap_or(self.default_rate_limit)
2025-11-09T23:19:32.4081518Z +        limits
2025-11-09T23:19:32.4081650Z +            .get(user_id)
2025-11-09T23:19:32.4081785Z +            .copied()
2025-11-09T23:19:32.4081939Z +            .unwrap_or(self.default_rate_limit)
2025-11-09T23:19:32.4082041Z      }
2025-11-09T23:19:32.4082149Z  
2025-11-09T23:19:32.4082314Z      /// Authenticate a request from HTTP headers
2025-11-09T23:19:32.4082713Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:283:
2025-11-09T23:19:32.4082860Z      /// Check rate limit for a user
2025-11-09T23:19:32.4083128Z      pub async fn check_rate_limit(&self, user_id: &UserId) -> bool {
2025-11-09T23:19:32.4083340Z          let mut limiters = self.rate_limiters.lock().await;
2025-11-09T23:19:32.4083454Z -        
2025-11-09T23:19:32.4083565Z +
2025-11-09T23:19:32.4083738Z          // Get or create rate limiter for this user
2025-11-09T23:19:32.4084004Z          let limiter = limiters.entry(user_id.clone()).or_insert_with(|| {
2025-11-09T23:19:32.4084186Z              let (burst, rate) = self.default_rate_limit;
2025-11-09T23:19:32.4084875Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:290:
2025-11-09T23:19:32.4085054Z              RpcRateLimiter::new(burst, rate)
2025-11-09T23:19:32.4085163Z          });
2025-11-09T23:19:32.4085290Z -        
2025-11-09T23:19:32.4085399Z +
2025-11-09T23:19:32.4085546Z          limiter.check_and_consume()
2025-11-09T23:19:32.4085656Z      }
2025-11-09T23:19:32.4085773Z  
2025-11-09T23:19:32.4086205Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:311:
2025-11-09T23:19:32.4086466Z          auth.add_token("test-token-123".to_string()).await.unwrap();
2025-11-09T23:19:32.4086591Z  
2025-11-09T23:19:32.4086781Z          let mut headers = hyper::HeaderMap::new();
2025-11-09T23:19:32.4086911Z -        headers.insert(
2025-11-09T23:19:32.4087046Z -            "authorization",
2025-11-09T23:19:32.4087770Z -            "***".parse().unwrap(),
2025-11-09T23:19:32.4087899Z -        );
2025-11-09T23:19:32.4088330Z +        headers.insert("authorization", "***".parse().unwrap());
2025-11-09T23:19:32.4088705Z  
2025-11-09T23:19:32.4088936Z          let addr: SocketAddr = "127.0.0.1:8080".parse().unwrap();
2025-11-09T23:19:32.4089200Z          let result = auth.authenticate_request(&headers, addr).await;
2025-11-09T23:19:32.4089632Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:329:
2025-11-09T23:19:32.4089867Z          auth.add_token("valid-token".to_string()).await.unwrap();
2025-11-09T23:19:32.4089983Z  
2025-11-09T23:19:32.4090164Z          let mut headers = hyper::HeaderMap::new();
2025-11-09T23:19:32.4090293Z -        headers.insert(
2025-11-09T23:19:32.4090422Z -            "authorization",
2025-11-09T23:19:32.4090645Z -            "***".parse().unwrap(),
2025-11-09T23:19:32.4090760Z -        );
2025-11-09T23:19:32.4091133Z +        headers.insert("authorization", "***".parse().unwrap());
2025-11-09T23:19:32.4091245Z  
2025-11-09T23:19:32.4091475Z          let addr: SocketAddr = "127.0.0.1:8080".parse().unwrap();
2025-11-09T23:19:32.4091739Z          let result = auth.authenticate_request(&headers, addr).await;
2025-11-09T23:19:32.4092177Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:368:
2025-11-09T23:19:32.4092328Z          assert!(result.error.is_none());
2025-11-09T23:19:32.4092434Z      }
2025-11-09T23:19:32.4092547Z  }
2025-11-09T23:19:32.4092652Z -
2025-11-09T23:19:32.4092756Z  
2025-11-09T23:19:32.4170469Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:30:
2025-11-09T23:19:32.4170642Z  
2025-11-09T23:19:32.4170794Z      /// Create with dependencies
2025-11-09T23:19:32.4171061Z      pub fn with_dependencies(storage: Arc<Storage>) -> Self {
2025-11-09T23:19:32.4171222Z -        Self { storage: Some(storage) }
2025-11-09T23:19:32.4171336Z +        Self {
2025-11-09T23:19:32.4171492Z +            storage: Some(storage),
2025-11-09T23:19:32.4171866Z +        }
2025-11-09T23:19:32.4171982Z      }
2025-11-09T23:19:32.4172095Z  
2025-11-09T23:19:32.4172353Z      /// Calculate difficulty from bits (compact target format)
2025-11-09T23:19:32.4172844Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:39:
2025-11-09T23:19:32.4173330Z          // MAX_TARGET for Bitcoin mainnet is 0x00000000FFFF0000000000000000000000000000000000000000000000000000
2025-11-09T23:19:32.4173633Z          // But we use a simpler calculation: difficulty = 2^256 / (target + 1)
2025-11-09T23:19:32.4173922Z          // For display purposes, we normalize to genesis difficulty = 1.0
2025-11-09T23:19:32.4174551Z -        const MAX_TARGET: u128 = 0x00000000FFFF0000000000000000000000000000000000000000000000000000u128;
2025-11-09T23:19:32.4174685Z -        
2025-11-09T23:19:32.4174834Z +        const MAX_TARGET: u128 =
2025-11-09T23:19:32.4175171Z +            0x00000000FFFF0000000000000000000000000000000000000000000000000000u128;
2025-11-09T23:19:32.4175294Z +
2025-11-09T23:19:32.4175475Z          // Simplified difficulty calculation
2025-11-09T23:19:32.4175769Z          // For display purposes, use a simple approximation based on bits
2025-11-09T23:19:32.4175947Z          if let Ok(_target) = expand_target(bits) {
2025-11-09T23:19:32.4176428Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:73:
2025-11-09T23:19:32.4176634Z      fn calculate_block_subsidy(height: u64) -> u64 {
2025-11-09T23:19:32.4176908Z          const INITIAL_SUBSIDY: u64 = 50_000_000_000; // 50 BTC in satoshis
2025-11-09T23:19:32.4177079Z          const HALVING_INTERVAL: u64 = 210_000;
2025-11-09T23:19:32.4177195Z -        
2025-11-09T23:19:32.4177307Z +
2025-11-09T23:19:32.4177534Z          let halvings = height / HALVING_INTERVAL;
2025-11-09T23:19:32.4177658Z -        
2025-11-09T23:19:32.4177771Z +
2025-11-09T23:19:32.4177960Z          // Subsidy halves each halving, but can't go below 0
2025-11-09T23:19:32.4178099Z          if halvings >= 64 {
2025-11-09T23:19:32.4178341Z              // After 64 halvings, subsidy is 0 (satoshi precision limit)
2025-11-09T23:19:32.4178970Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:82:
2025-11-09T23:19:32.4179082Z              return 0;
2025-11-09T23:19:32.4179194Z          }
2025-11-09T23:19:32.4179296Z -        
2025-11-09T23:19:32.4179398Z +
2025-11-09T23:19:32.4179539Z          INITIAL_SUBSIDY >> halvings
2025-11-09T23:19:32.4179647Z      }
2025-11-09T23:19:32.4179755Z  
2025-11-09T23:19:32.4180201Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:88:
2025-11-09T23:19:32.4180447Z      /// Calculate hash_serialized_2 for UTXO set (double SHA256)
2025-11-09T23:19:32.4180553Z -    /// 
2025-11-09T23:19:32.4180663Z +    ///
2025-11-09T23:19:32.4180998Z      /// Serializes UTXO set deterministically and computes double SHA256 hash.
2025-11-09T23:19:32.4181325Z      /// Matches Bitcoin Core's gettxoutsetinfo hash_serialized_2 calculation.
2025-11-09T23:19:32.4181686Z      fn calculate_utxo_set_hash(utxo_set: &bllvm_protocol::UtxoSet) -> [u8; 32] {
2025-11-09T23:19:32.4182124Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:93:
2025-11-09T23:19:32.4182265Z -        use sha2::{Sha256, Digest};
2025-11-09T23:19:32.4182452Z          use crate::storage::hashing::double_sha256;
2025-11-09T23:19:32.4182564Z -        
2025-11-09T23:19:32.4182713Z +        use sha2::{Digest, Sha256};
2025-11-09T23:19:32.4182821Z +
2025-11-09T23:19:32.4183158Z          // Sort UTXOs for deterministic hashing (by outpoint: hash first, then index)
2025-11-09T23:19:32.4183380Z          let mut entries: Vec<_> = utxo_set.iter().collect();
2025-11-09T23:19:32.4183536Z -        entries.sort_by(|(a, _), (b, _)| {
2025-11-09T23:19:32.4183693Z -            match a.hash.cmp(&b.hash) {
2025-11-09T23:19:32.4183923Z -                std::cmp::Ordering::Equal => a.index.cmp(&b.index),
2025-11-09T23:19:32.4184562Z -                other => other,
2025-11-09T23:19:32.4184695Z -            }
2025-11-09T23:19:32.4184960Z +        entries.sort_by(|(a, _), (b, _)| match a.hash.cmp(&b.hash) {
2025-11-09T23:19:32.4185207Z +            std::cmp::Ordering::Equal => a.index.cmp(&b.index),
2025-11-09T23:19:32.4185344Z +            other => other,
2025-11-09T23:19:32.4185460Z          });
2025-11-09T23:19:32.4185589Z -        
2025-11-09T23:19:32.4185705Z +
2025-11-09T23:19:32.4185860Z          // Serialize each UTXO entry
2025-11-09T23:19:32.4186026Z          let mut serialized = Vec::new();
2025-11-09T23:19:32.4186197Z          for (outpoint, utxo) in entries {
2025-11-09T23:19:32.4186679Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:108:
2025-11-09T23:19:32.4186968Z              // Serialize outpoint (32-byte hash + 8-byte index, little-endian)
2025-11-09T23:19:32.4187202Z              serialized.extend_from_slice(&outpoint.hash);
2025-11-09T23:19:32.4187489Z              serialized.extend_from_slice(&outpoint.index.to_le_bytes());
2025-11-09T23:19:32.4187613Z -            
2025-11-09T23:19:32.4187727Z +
2025-11-09T23:19:32.4188072Z              // Serialize UTXO (8-byte value + script_pubkey + 8-byte height, little-endian)
2025-11-09T23:19:32.4188326Z              serialized.extend_from_slice(&utxo.value.to_le_bytes());
2025-11-09T23:19:32.4188559Z              serialized.extend_from_slice(&utxo.script_pubkey);
2025-11-09T23:19:32.4189029Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:115:
2025-11-09T23:19:32.4189302Z              serialized.extend_from_slice(&utxo.height.to_le_bytes());
2025-11-09T23:19:32.4189429Z          }
2025-11-09T23:19:32.4189543Z -        
2025-11-09T23:19:32.4189645Z +
2025-11-09T23:19:32.4189776Z          // Double SHA256 hash
2025-11-09T23:19:32.4189932Z          double_sha256(&serialized)
2025-11-09T23:19:32.4190043Z      }
2025-11-09T23:19:32.4190515Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:121:
2025-11-09T23:19:32.4190648Z -    
2025-11-09T23:19:32.4190759Z +
2025-11-09T23:19:32.4191175Z      /// Calculate confirmations for a block
2025-11-09T23:19:32.4191515Z      fn calculate_confirmations(block_height: u64, tip_height: u64) -> i64 {
2025-11-09T23:19:32.4191678Z          if block_height > tip_height {
2025-11-09T23:19:32.4192149Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:222:
2025-11-09T23:19:32.4192270Z              }))
2025-11-09T23:19:32.4192393Z          } else {
2025-11-09T23:19:32.4192726Z              // Graceful degradation: return default values when storage unavailable
2025-11-09T23:19:32.4193225Z -            tracing::debug!("getblockchaininfo called but storage not available, returning default values");
2025-11-09T23:19:32.4193373Z +            tracing::debug!(
2025-11-09T23:19:32.4193764Z +                "getblockchaininfo called but storage not available, returning default values"
2025-11-09T23:19:32.4193886Z +            );
2025-11-09T23:19:32.4194011Z              Ok(json!({
2025-11-09T23:19:32.4194152Z                  "chain": "main",
2025-11-09T23:19:32.4194465Z                  "blocks": 0,
2025-11-09T23:19:32.4194942Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:311:
2025-11-09T23:19:32.4195199Z          debug!("RPC: getblockheader {} verbose={}", hash, verbose);
2025-11-09T23:19:32.4195313Z  
2025-11-09T23:19:32.4195485Z          if let Some(ref storage) = self.storage {
2025-11-09T23:19:32.4195656Z -            let hash_bytes = hex::decode(hash)
2025-11-09T23:19:32.4195894Z -                .map_err(|e| anyhow::anyhow!("Invalid hash: {}", e))?;
2025-11-09T23:19:32.4196029Z +            let hash_bytes =
2025-11-09T23:19:32.4196333Z +                hex::decode(hash).map_err(|e| anyhow::anyhow!("Invalid hash: {}", e))?;
2025-11-09T23:19:32.4196486Z              if hash_bytes.len() != 32 {
2025-11-09T23:19:32.4196706Z                  return Err(anyhow::anyhow!("Invalid hash length"));
2025-11-09T23:19:32.4197736Z              }
2025-11-09T23:19:32.4198215Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:319:
2025-11-09T23:19:32.4198378Z              let mut hash_array = [0u8; 32];
2025-11-09T23:19:32.4198550Z              hash_array.copy_from_slice(&hash_bytes);
2025-11-09T23:19:32.4198669Z -            
2025-11-09T23:19:32.4198778Z +
2025-11-09T23:19:32.4199043Z              if let Ok(Some(header)) = storage.blocks().get_header(&hash_array) {
2025-11-09T23:19:32.4199175Z                  if verbose {
2025-11-09T23:19:32.4199377Z                      // Find block height by searching height index
2025-11-09T23:19:32.4199829Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:360:
2025-11-09T23:19:32.4199940Z  
2025-11-09T23:19:32.4200094Z                      // Find next block hash
2025-11-09T23:19:32.4200297Z                      let next_blockhash = block_height.and_then(|h| {
2025-11-09T23:19:32.4200446Z -                        storage.blocks()
2025-11-09T23:19:32.4200567Z +                        storage
2025-11-09T23:19:32.4200708Z +                            .blocks()
2025-11-09T23:19:32.4200858Z                              .get_hash_by_height(h + 1)
2025-11-09T23:19:32.4200985Z                              .ok()
2025-11-09T23:19:32.4201324Z                              .flatten()
2025-11-09T23:19:32.4201790Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:380:
2025-11-09T23:19:32.4201914Z                          }
2025-11-09T23:19:32.4202564Z                          Self::format_chainwork(total_work)
2025-11-09T23:19:32.4202692Z                      } else {
2025-11-09T23:19:32.4203029Z -                        "0000000000000000000000000000000000000000000000000000000000000000".to_string()
2025-11-09T23:19:32.4203301Z +                        "0000000000000000000000000000000000000000000000000000000000000000"
2025-11-09T23:19:32.4203456Z +                            .to_string()
2025-11-09T23:19:32.4203573Z                      };
2025-11-09T23:19:32.4203909Z  
2025-11-09T23:19:32.4204041Z                      Ok(json!({
2025-11-09T23:19:32.4204710Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:443:
2025-11-09T23:19:32.4204941Z              if let Ok(Some(hash)) = storage.chain().get_tip_hash() {
2025-11-09T23:19:32.4205102Z                  Ok(json!(hex::encode(hash)))
2025-11-09T23:19:32.4205209Z              } else {
2025-11-09T23:19:32.4205514Z -                Ok(json!("0000000000000000000000000000000000000000000000000000000000000000"))
2025-11-09T23:19:32.4205646Z +                Ok(json!(
2025-11-09T23:19:32.4205915Z +                    "0000000000000000000000000000000000000000000000000000000000000000"
2025-11-09T23:19:32.4206019Z +                ))
2025-11-09T23:19:32.4206122Z              }
2025-11-09T23:19:32.4206236Z          } else {
2025-11-09T23:19:32.4206530Z -            Ok(json!("0000000000000000000000000000000000000000000000000000000000000000"))
2025-11-09T23:19:32.4206639Z +            Ok(json!(
2025-11-09T23:19:32.4206891Z +                "0000000000000000000000000000000000000000000000000000000000000000"
2025-11-09T23:19:32.4207000Z +            ))
2025-11-09T23:19:32.4207100Z          }
2025-11-09T23:19:32.4207199Z      }
2025-11-09T23:19:32.4207303Z  
2025-11-09T23:19:32.4207733Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:494:
2025-11-09T23:19:32.4207915Z              let utxos = storage.utxos().get_all_utxos()?;
2025-11-09T23:19:32.4208053Z              let txouts = utxos.len();
2025-11-09T23:19:32.4208343Z              let total_amount: u64 = utxos.values().map(|utxo| utxo.value as u64).sum();
2025-11-09T23:19:32.4208445Z -            
2025-11-09T23:19:32.4208541Z +
2025-11-09T23:19:32.4208949Z              // Calculate hash_serialized_2 (double SHA256 of serialized UTXO set)
2025-11-09T23:19:32.4209459Z              let hash_serialized_2 = Self::calculate_utxo_set_hash(&utxos);
2025-11-09T23:19:32.4209572Z  
2025-11-09T23:19:32.4210067Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:540:
2025-11-09T23:19:32.4210415Z              // Use protocol engine which provides the correct validate_block signature
2025-11-09T23:19:32.4210729Z              let engine = BitcoinProtocolEngine::new(ProtocolVersion::Regtest)
2025-11-09T23:19:32.4211061Z                  .map_err(|e| anyhow::anyhow!("Failed to create protocol engine: {}", e))?;
2025-11-09T23:19:32.4211178Z -            
2025-11-09T23:19:32.4211291Z +
2025-11-09T23:19:32.4211481Z              let check_level = checklevel.unwrap_or(3);
2025-11-09T23:19:32.4211660Z              let num_blocks = numblocks.unwrap_or(288);
2025-11-09T23:19:32.4211773Z -            
2025-11-09T23:19:32.4211884Z +
2025-11-09T23:19:32.4212143Z              let tip_height = storage.chain().get_height()?.unwrap_or(0);
2025-11-09T23:19:32.4212282Z              if tip_height == 0 {
2025-11-09T23:19:32.4212479Z                  return Ok(json!(true)); // Empty chain is valid
2025-11-09T23:19:32.4212950Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:557:
2025-11-09T23:19:32.4213075Z              };
2025-11-09T23:19:32.4213182Z  
2025-11-09T23:19:32.4213341Z              let mut errors = Vec::new();
2025-11-09T23:19:32.4213560Z -            let mut utxo_set = storage.utxos().get_all_utxos()
2025-11-09T23:19:32.4213704Z +            let mut utxo_set = storage
2025-11-09T23:19:32.4213829Z +                .utxos()
2025-11-09T23:19:32.4213970Z +                .get_all_utxos()
2025-11-09T23:19:32.4214233Z                  .map_err(|e| anyhow::anyhow!("Failed to get UTXO set: {}", e))?;
2025-11-09T23:19:32.4214531Z  
2025-11-09T23:19:32.4214717Z              // Verify blocks from start_height to tip
2025-11-09T23:19:32.4215213Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:572:
2025-11-09T23:19:32.4215378Z                                  // For now, just continue
2025-11-09T23:19:32.4215502Z                              }
2025-11-09T23:19:32.4216030Z                              Ok(bllvm_protocol::ValidationResult::Invalid(reason)) => {
2025-11-09T23:19:32.4216353Z -                                errors.push(format!("Block at height {} invalid: {}", height, reason));
2025-11-09T23:19:32.4216512Z +                                errors.push(format!(
2025-11-09T23:19:32.4216704Z +                                    "Block at height {} invalid: {}",
2025-11-09T23:19:32.4216856Z +                                    height, reason
2025-11-09T23:19:32.4216979Z +                                ));
2025-11-09T23:19:32.4217132Z                                  if check_level >= 4 {
2025-11-09T23:19:32.4217311Z                                      // Level 4: Stop on first error
2025-11-09T23:19:32.4217447Z                                      break;
2025-11-09T23:19:32.4217932Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:579:
2025-11-09T23:19:32.4218072Z                                  }
2025-11-09T23:19:32.4218207Z                              }
2025-11-09T23:19:32.4218345Z                              Err(e) => {
2025-11-09T23:19:32.4220546Z -                                errors.push(format!("Block at height {} validation error: {}", height, e));
2025-11-09T23:19:32.4220701Z +                                errors.push(format!(
2025-11-09T23:19:32.4220889Z +                                    "Block at height {} validation error: {}",
2025-11-09T23:19:32.4221035Z +                                    height, e
2025-11-09T23:19:32.4221171Z +                                ));
2025-11-09T23:19:32.4221323Z                                  if check_level >= 4 {
2025-11-09T23:19:32.4221457Z                                      break;
2025-11-09T23:19:32.4221592Z                                  }
2025-11-09T23:19:32.4222060Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:588:
2025-11-09T23:19:32.4222421Z  
2025-11-09T23:19:32.4222649Z                          // Check level 3: Verify block header linkage
2025-11-09T23:19:32.4222820Z                          if check_level >= 3 && height > 0 {
2025-11-09T23:19:32.4223163Z -                            if let Ok(Some(prev_hash)) = storage.blocks().get_hash_by_height(height - 1) {
2025-11-09T23:19:32.4223325Z +                            if let Ok(Some(prev_hash)) =
2025-11-09T23:19:32.4223549Z +                                storage.blocks().get_hash_by_height(height - 1)
2025-11-09T23:19:32.4223668Z +                            {
2025-11-09T23:19:32.4223870Z                                  if block.header.prev_block_hash != prev_hash {
2025-11-09T23:19:32.4224029Z                                      errors.push(format!(
2025-11-09T23:19:32.4224480Z                                          "Block at height {} has incorrect prev_block_hash: expected {}, got {}",
2025-11-09T23:19:32.4224952Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:606:
2025-11-09T23:19:32.4225130Z                          // Check level 2: Verify merkle root
2025-11-09T23:19:32.4225274Z                          if check_level >= 2 {
2025-11-09T23:19:32.4225507Z                              use bllvm_protocol::mining::calculate_merkle_root;
2025-11-09T23:19:32.4225827Z -                            if let Ok(calculated_root) = calculate_merkle_root(&block.transactions) {
2025-11-09T23:19:32.4226139Z +                            if let Ok(calculated_root) = calculate_merkle_root(&block.transactions)
2025-11-09T23:19:32.4226260Z +                            {
2025-11-09T23:19:32.4226481Z                                  if calculated_root != block.header.merkle_root {
2025-11-09T23:19:32.4226646Z                                      errors.push(format!(
2025-11-09T23:19:32.4226852Z                                          "Block at height {} has incorrect merkle root",
2025-11-09T23:19:32.4227322Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:657:
2025-11-09T23:19:32.4227699Z          if let Some(ref storage) = self.storage {
2025-11-09T23:19:32.4227862Z              // Get all chain tips (including forks)
2025-11-09T23:19:32.4228010Z              let mut tips = Vec::new();
2025-11-09T23:19:32.4228130Z -            
2025-11-09T23:19:32.4228238Z +
2025-11-09T23:19:32.4230219Z              // Add active tip
2025-11-09T23:19:32.4230457Z              if let Ok(Some(tip_hash)) = storage.chain().get_tip_hash() {
2025-11-09T23:19:32.4230719Z                  let tip_height = storage.chain().get_height()?.unwrap_or(0);
2025-11-09T23:19:32.4231196Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:668:
2025-11-09T23:19:32.4231339Z                      "status": "active"
2025-11-09T23:19:32.4231465Z                  }));
2025-11-09T23:19:32.4231581Z              }
2025-11-09T23:19:32.4231702Z -            
2025-11-09T23:19:32.4231824Z +
2025-11-09T23:19:32.4231992Z              // Add other tracked tips (forks, etc.)
2025-11-09T23:19:32.4232235Z              if let Ok(chain_tips) = storage.chain().get_chain_tips() {
2025-11-09T23:19:32.4232445Z                  for (hash, height, branchlen, status) in chain_tips {
2025-11-09T23:19:32.4232899Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:678:
2025-11-09T23:19:32.4233027Z                              continue;
2025-11-09T23:19:32.4233146Z                          }
2025-11-09T23:19:32.4233271Z                      }
2025-11-09T23:19:32.4233387Z -                    
2025-11-09T23:19:32.4233496Z +
2025-11-09T23:19:32.4233639Z                      tips.push(json!({
2025-11-09T23:19:32.4233793Z                          "height": height,
2025-11-09T23:19:32.4233955Z                          "hash": hex::encode(hash),
2025-11-09T23:19:32.4234567Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:687:
2025-11-09T23:19:32.4235023Z                      }));
2025-11-09T23:19:32.4235151Z                  }
2025-11-09T23:19:32.4235264Z              }
2025-11-09T23:19:32.4235378Z -            
2025-11-09T23:19:32.4235504Z +
2025-11-09T23:19:32.4235639Z              Ok(json!(tips))
2025-11-09T23:19:32.4235759Z          } else {
2025-11-09T23:19:32.4235896Z              Ok(json!([]))
2025-11-09T23:19:32.4236373Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:700:
2025-11-09T23:19:32.4236702Z      pub async fn get_chain_tx_stats(&self, params: &Value) -> Result<Value> {
2025-11-09T23:19:32.4236876Z          debug!("RPC: getchaintxstats");
2025-11-09T23:19:32.4236993Z  
2025-11-09T23:19:32.4237136Z -        let nblocks = params
2025-11-09T23:19:32.4237254Z -            .get(0)
2025-11-09T23:19:32.4237410Z -            .and_then(|p| p.as_u64())
2025-11-09T23:19:32.4237665Z -            .unwrap_or(144); // Default: 1 day (144 blocks at 10 min/block)
2025-11-09T23:19:32.4238161Z +        let nblocks = params.get(0).and_then(|p| p.as_u64()).unwrap_or(144); // Default: 1 day (144 blocks at 10 min/block)
2025-11-09T23:19:32.4238288Z  
2025-11-09T23:19:32.4238482Z          if let Some(ref storage) = self.storage {
2025-11-09T23:19:32.4238779Z              let tip_height = storage.chain().get_height()?.unwrap_or(0);
2025-11-09T23:19:32.4239258Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:710:
2025-11-09T23:19:32.4239384Z -            
2025-11-09T23:19:32.4239496Z +
2025-11-09T23:19:32.4239633Z              if tip_height == 0 {
2025-11-09T23:19:32.4239774Z                  return Ok(json!({
2025-11-09T23:19:32.4239902Z                      "time": 0,
2025-11-09T23:19:32.4240369Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:729:
2025-11-09T23:19:32.4240555Z              // Get timestamps and transaction counts
2025-11-09T23:19:32.4240732Z              let mut timestamps = Vec::new();
2025-11-09T23:19:32.4240897Z              let mut tx_counts = Vec::new();
2025-11-09T23:19:32.4241280Z -            
2025-11-09T23:19:32.4241399Z +
2025-11-09T23:19:32.4241593Z              for height in start_height..=tip_height {
2025-11-09T23:19:32.4241887Z                  if let Ok(Some(hash)) = storage.blocks().get_hash_by_height(height) {
2025-11-09T23:19:32.4242136Z                      if let Ok(Some(block)) = storage.blocks().get_block(&hash) {
2025-11-09T23:19:32.4242618Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:756:
2025-11-09T23:19:32.4242949Z              let window_interval = last_timestamp.saturating_sub(first_timestamp);
2025-11-09T23:19:32.4243168Z              let window_tx_count: u64 = tx_counts.iter().sum();
2025-11-09T23:19:32.4243378Z              let window_block_count = timestamps.len() as u64;
2025-11-09T23:19:32.4243487Z -            
2025-11-09T23:19:32.4243592Z +
2025-11-09T23:19:32.4243765Z              let txrate = if window_interval > 0 {
2025-11-09T23:19:32.4243957Z                  window_tx_count as f64 / window_interval as f64
2025-11-09T23:19:32.4244079Z              } else {
2025-11-09T23:19:32.4244764Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:794:
2025-11-09T23:19:32.4245070Z      pub async fn get_block_stats(&self, params: &Value) -> Result<Value> {
2025-11-09T23:19:32.4245222Z          debug!("RPC: getblockstats");
2025-11-09T23:19:32.4245329Z  
2025-11-09T23:19:32.4245549Z -        let hash_or_height: Option<String> = params.get(0)
2025-11-09T23:19:32.4245729Z +        let hash_or_height: Option<String> = params
2025-11-09T23:19:32.4245842Z +            .get(0)
2025-11-09T23:19:32.4245986Z              .and_then(|p| p.as_str())
2025-11-09T23:19:32.4246126Z              .map(|s| s.to_string())
2025-11-09T23:19:32.4246252Z              .or_else(|| {
2025-11-09T23:19:32.4246734Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:801:
2025-11-09T23:19:32.4247131Z -                params.get(0)
2025-11-09T23:19:32.4247258Z +                params
2025-11-09T23:19:32.4247388Z +                    .get(0)
2025-11-09T23:19:32.4247558Z                      .and_then(|p| p.as_u64())
2025-11-09T23:19:32.4247708Z                      .map(|h| h.to_string())
2025-11-09T23:19:32.4247825Z              });
2025-11-09T23:19:32.4248320Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:808:
2025-11-09T23:19:32.4248540Z              let block_hash = if let Some(hoh) = hash_or_height {
2025-11-09T23:19:32.4250513Z                  // Try to parse as height first
2025-11-09T23:19:32.4250710Z                  if let Ok(height) = hoh.parse::<u64>() {
2025-11-09T23:19:32.4250915Z -                    storage.blocks().get_hash_by_height(height)?
2025-11-09T23:19:32.4251037Z +                    storage
2025-11-09T23:19:32.4251160Z +                        .blocks()
2025-11-09T23:19:32.4251333Z +                        .get_hash_by_height(height)?
2025-11-09T23:19:32.4251647Z                          .ok_or_else(|| anyhow::anyhow!("Block at height {} not found", height))?
2025-11-09T23:19:32.4251782Z                  } else {
2025-11-09T23:19:32.4251929Z                      // Parse as hash
2025-11-09T23:19:32.4252388Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:823:
2025-11-09T23:19:32.4252497Z                  }
2025-11-09T23:19:32.4252609Z              } else {
2025-11-09T23:19:32.4252743Z                  // Default to tip
2025-11-09T23:19:32.4252891Z -                storage.chain().get_tip_hash()?
2025-11-09T23:19:32.4253004Z +                storage
2025-11-09T23:19:32.4253123Z +                    .chain()
2025-11-09T23:19:32.4253245Z +                    .get_tip_hash()?
2025-11-09T23:19:32.4253477Z                      .ok_or_else(|| anyhow::anyhow!("Chain not initialized"))?
2025-11-09T23:19:32.4253598Z              };
2025-11-09T23:19:32.4253723Z  
2025-11-09T23:19:32.4254200Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:831:
2025-11-09T23:19:32.4254854Z                  let tx_count = block.transactions.len();
2025-11-09T23:19:32.4255109Z                  let block_size = bincode::serialize(&block)?.len();
2025-11-09T23:19:32.4255472Z                  let block_weight = block_size; // Simplified - would calculate weight properly
2025-11-09T23:19:32.4255587Z -                
2025-11-09T23:19:32.4255701Z +
2025-11-09T23:19:32.4255834Z                  // Get block height
2025-11-09T23:19:32.4256114Z -                let height = storage.blocks().get_height_by_hash(&block_hash)?
2025-11-09T23:19:32.4256254Z +                let height = storage
2025-11-09T23:19:32.4256386Z +                    .blocks()
2025-11-09T23:19:32.4256543Z +                    .get_height_by_hash(&block_hash)?
2025-11-09T23:19:32.4256666Z                      .unwrap_or(0);
2025-11-09T23:19:32.4256776Z -                
2025-11-09T23:19:32.4256888Z +
2025-11-09T23:19:32.4257032Z                  // Count inputs and outputs
2025-11-09T23:19:32.4257267Z -                let input_count: usize = block.transactions.iter()
2025-11-09T23:19:32.4257429Z -                    .map(|tx| tx.inputs.len())
2025-11-09T23:19:32.4257550Z -                    .sum();
2025-11-09T23:19:32.4257774Z -                let output_count: usize = block.transactions.iter()
2025-11-09T23:19:32.4257936Z -                    .map(|tx| tx.outputs.len())
2025-11-09T23:19:32.4258057Z -                    .sum();
2025-11-09T23:19:32.4258162Z -                
2025-11-09T23:19:32.4258520Z +                let input_count: usize = block.transactions.iter().map(|tx| tx.inputs.len()).sum();
2025-11-09T23:19:32.4258666Z +                let output_count: usize =
2025-11-09T23:19:32.4260787Z +                    block.transactions.iter().map(|tx| tx.outputs.len()).sum();
2025-11-09T23:19:32.4260893Z +
2025-11-09T23:19:32.4261034Z                  // Sum output values
2025-11-09T23:19:32.4261454Z -                let total_out: u64 = block.transactions.iter()
2025-11-09T23:19:32.4261593Z +                let total_out: u64 = block
2025-11-09T23:19:32.4261720Z +                    .transactions
2025-11-09T23:19:32.4261829Z +                    .iter()
2025-11-09T23:19:32.4261977Z                      .flat_map(|tx| tx.outputs.iter())
2025-11-09T23:19:32.4262113Z                      .map(|out| out.value as u64)
2025-11-09T23:19:32.4262242Z                      .sum::<u64>();
2025-11-09T23:19:32.4262711Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:852:
2025-11-09T23:19:32.4262827Z -                
2025-11-09T23:19:32.4262943Z +
2025-11-09T23:19:32.4263085Z                  // Calculate block subsidy
2025-11-09T23:19:32.4263315Z                  let subsidy = Self::calculate_block_subsidy(height);
2025-11-09T23:19:32.4263432Z -                
2025-11-09T23:19:32.4263533Z +
2025-11-09T23:19:32.4263903Z                  // Calculate total fees (simplified - would need UTXO set for accurate calculation)
2025-11-09T23:19:32.4264189Z                  // For now, estimate: total_out - (subsidy * 100_000_000) if coinbase exists
2025-11-09T23:19:32.4264583Z                  let total_fees = if !block.transactions.is_empty() {
2025-11-09T23:19:32.4265010Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:859:
2025-11-09T23:19:32.4265154Z                      // Coinbase is first transaction
2025-11-09T23:19:32.4265427Z -                    let coinbase_outputs: u64 = block.transactions[0].outputs.iter()
2025-11-09T23:19:32.4265615Z +                    let coinbase_outputs: u64 = block.transactions[0]
2025-11-09T23:19:32.4265740Z +                        .outputs
2025-11-09T23:19:32.4265868Z +                        .iter()
2025-11-09T23:19:32.4266019Z                          .map(|out| out.value as u64)
2025-11-09T23:19:32.4266140Z                          .sum();
2025-11-09T23:19:32.4266415Z                      // Fee = total outputs - (coinbase outputs which include subsidy)
2025-11-09T23:19:32.4266860Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:903:
2025-11-09T23:19:32.4267157Z              }
2025-11-09T23:19:32.4267260Z          } else {
2025-11-09T23:19:32.4267589Z              // Graceful degradation: return informative error instead of failing silently
2025-11-09T23:19:32.4268013Z -            Err(anyhow::anyhow!("Storage not available. This operation requires storage to be initialized."))
2025-11-09T23:19:32.4268142Z +            Err(anyhow::anyhow!(
2025-11-09T23:19:32.4268458Z +                "Storage not available. This operation requires storage to be initialized."
2025-11-09T23:19:32.4268558Z +            ))
2025-11-09T23:19:32.4268658Z          }
2025-11-09T23:19:32.4268756Z      }
2025-11-09T23:19:32.4268860Z  
2025-11-09T23:19:32.4269287Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:913:
2025-11-09T23:19:32.4269610Z      pub async fn prune_blockchain(&self, params: &Value) -> Result<Value> {
2025-11-09T23:19:32.4269796Z          debug!("RPC: pruneblockchain");
2025-11-09T23:19:32.4269910Z  
2025-11-09T23:19:32.4270059Z -        let height = params.get(0)
2025-11-09T23:19:32.4270197Z +        let height = params
2025-11-09T23:19:32.4270324Z +            .get(0)
2025-11-09T23:19:32.4270472Z              .and_then(|p| p.as_u64())
2025-11-09T23:19:32.4270733Z              .ok_or_else(|| anyhow::anyhow!("Height parameter required"))?;
2025-11-09T23:19:32.4270846Z  
2025-11-09T23:19:32.4271280Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:920:
2025-11-09T23:19:32.4271460Z          if let Some(ref storage) = self.storage {
2025-11-09T23:19:32.4271706Z              let tip_height = storage.chain().get_height()?.unwrap_or(0);
2025-11-09T23:19:32.4271814Z -            
2025-11-09T23:19:32.4271915Z +
2025-11-09T23:19:32.4272172Z              // Check if IBD is in progress (height == 0 indicates no blocks synced)
2025-11-09T23:19:32.4272552Z              let is_ibd = tip_height == 0;
2025-11-09T23:19:32.4272677Z -            
2025-11-09T23:19:32.4272790Z +
2025-11-09T23:19:32.4272941Z              if height >= tip_height {
2025-11-09T23:19:32.4273404Z -                return Err(anyhow::anyhow!("Cannot prune to height >= tip height ({} >= {})", height, tip_height));
2025-11-09T23:19:32.4273565Z +                return Err(anyhow::anyhow!(
2025-11-09T23:19:32.4273780Z +                    "Cannot prune to height >= tip height ({} >= {})",
2025-11-09T23:19:32.4273912Z +                    height,
2025-11-09T23:19:32.4274038Z +                    tip_height
2025-11-09T23:19:32.4274152Z +                ));
2025-11-09T23:19:32.4274276Z              }
2025-11-09T23:19:32.4274560Z  
2025-11-09T23:19:32.4274704Z              // Get pruning manager
2025-11-09T23:19:32.4275175Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:931:
2025-11-09T23:19:32.4275407Z              if let Some(pruning_manager) = storage.pruning() {
2025-11-09T23:19:32.4275555Z                  // Perform pruning
2025-11-09T23:19:32.4275877Z                  let stats = pruning_manager.prune_to_height(height, tip_height, is_ibd)?;
2025-11-09T23:19:32.4276002Z -                
2025-11-09T23:19:32.4276115Z +
2025-11-09T23:19:32.4276284Z                  // Flush storage to persist changes
2025-11-09T23:19:32.4276437Z                  storage.flush()?;
2025-11-09T23:19:32.4276553Z -                
2025-11-09T23:19:32.4276663Z +
2025-11-09T23:19:32.4276787Z                  Ok(json!({
2025-11-09T23:19:32.4276950Z                      "pruned_height": height,
2025-11-09T23:19:32.4277115Z                      "blocks_pruned": stats.blocks_pruned,
2025-11-09T23:19:32.4277575Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:943:
2025-11-09T23:19:32.4277770Z                      "storage_freed_bytes": stats.storage_freed,
2025-11-09T23:19:32.4277899Z                  }))
2025-11-09T23:19:32.4278015Z              } else {
2025-11-09T23:19:32.4278639Z -                Err(anyhow::anyhow!("Pruning is not enabled. Configure pruning in node configuration."))
2025-11-09T23:19:32.4278797Z +                Err(anyhow::anyhow!(
2025-11-09T23:19:32.4279078Z +                    "Pruning is not enabled. Configure pruning in node configuration."
2025-11-09T23:19:32.4279188Z +                ))
2025-11-09T23:19:32.4279311Z              }
2025-11-09T23:19:32.4279428Z          } else {
2025-11-09T23:19:32.4279768Z              // Graceful degradation: return informative error instead of failing silently
2025-11-09T23:19:32.4280228Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:950:
2025-11-09T23:19:32.4280698Z -            Err(anyhow::anyhow!("Storage not available. This operation requires storage to be initialized."))
2025-11-09T23:19:32.4282811Z +            Err(anyhow::anyhow!(
2025-11-09T23:19:32.4283182Z +                "Storage not available. This operation requires storage to be initialized."
2025-11-09T23:19:32.4283307Z +            ))
2025-11-09T23:19:32.4283418Z          }
2025-11-09T23:19:32.4283525Z      }
2025-11-09T23:19:32.4283639Z  
2025-11-09T23:19:32.4284089Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:960:
2025-11-09T23:19:32.4284260Z          if let Some(ref storage) = self.storage {
2025-11-09T23:19:32.4284749Z              let tip_height = storage.chain().get_height()?.unwrap_or(0);
2025-11-09T23:19:32.4284968Z              let is_pruning_enabled = storage.is_pruning_enabled();
2025-11-09T23:19:32.4285082Z -            
2025-11-09T23:19:32.4285189Z +
2025-11-09T23:19:32.4285397Z              if let Some(pruning_manager) = storage.pruning() {
2025-11-09T23:19:32.4285572Z                  let stats = pruning_manager.get_stats();
2025-11-09T23:19:32.4285740Z                  let config = &pruning_manager.config;
2025-11-09T23:19:32.4286399Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:967:
2025-11-09T23:19:32.4286512Z -                
2025-11-09T23:19:32.4286617Z +
2025-11-09T23:19:32.4286766Z                  // Determine pruning mode
2025-11-09T23:19:32.4286938Z                  let mode_str = match &config.mode {
2025-11-09T23:19:32.4287160Z                      crate::config::PruningMode::Disabled => "disabled",
2025-11-09T23:19:32.4287572Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:975:
2025-11-09T23:19:32.4287814Z                      _ => "unknown", // Fallback for Aggressive if feature not enabled
2025-11-09T23:19:32.4288026Z                      crate::config::PruningMode::Custom { .. } => "custom",
2025-11-09T23:19:32.4288131Z                  };
2025-11-09T23:19:32.4288238Z -                
2025-11-09T23:19:32.4288337Z +
2025-11-09T23:19:32.4288454Z                  Ok(json!({
2025-11-09T23:19:32.4288676Z                      "pruning_enabled": is_pruning_enabled,
2025-11-09T23:19:32.4288819Z                      "mode": mode_str,
2025-11-09T23:19:32.4289816Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1013:
2025-11-09T23:19:32.4290150Z      pub async fn invalidate_block(&self, params: &Value) -> Result<Value> {
2025-11-09T23:19:32.4290330Z          debug!("RPC: invalidateblock");
2025-11-09T23:19:32.4290444Z  
2025-11-09T23:19:32.4292450Z -        let blockhash = params.get(0)
2025-11-09T23:19:32.4292585Z +        let blockhash = params
2025-11-09T23:19:32.4292689Z +            .get(0)
2025-11-09T23:19:32.4292819Z              .and_then(|p| p.as_str())
2025-11-09T23:19:32.4293072Z              .ok_or_else(|| anyhow::anyhow!("Block hash parameter required"))?;
2025-11-09T23:19:32.4293181Z  
2025-11-09T23:19:32.4293607Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1020:
2025-11-09T23:19:32.4293764Z -        let hash_bytes = hex::decode(blockhash)
2025-11-09T23:19:32.4294003Z -            .map_err(|e| anyhow::anyhow!("Invalid block hash: {}", e))?;
2025-11-09T23:19:32.4294556Z +        let hash_bytes =
2025-11-09T23:19:32.4294910Z +            hex::decode(blockhash).map_err(|e| anyhow::anyhow!("Invalid block hash: {}", e))?;
2025-11-09T23:19:32.4295044Z          if hash_bytes.len() != 32 {
2025-11-09T23:19:32.4295279Z              return Err(anyhow::anyhow!("Block hash must be 32 bytes"));
2025-11-09T23:19:32.4295380Z          }
2025-11-09T23:19:32.4295807Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1028:
2025-11-09T23:19:32.4295971Z          if let Some(ref storage) = self.storage {
2025-11-09T23:19:32.4296098Z              // Mark block as invalid
2025-11-09T23:19:32.4296242Z              storage.chain().mark_invalid(&hash)?;
2025-11-09T23:19:32.4296348Z -            
2025-11-09T23:19:32.4296446Z +
2025-11-09T23:19:32.4296734Z              // Check if this is the current tip - if so, we'd need to trigger a reorg
2025-11-09T23:19:32.4297059Z              // For now, we just mark it as invalid and let the node handle it on next block
2025-11-09T23:19:32.4297321Z              if let Ok(Some(tip_hash)) = storage.chain().get_tip_hash() {
2025-11-09T23:19:32.4297782Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1040:
2025-11-09T23:19:32.4297917Z              Ok(json!(null))
2025-11-09T23:19:32.4298040Z          } else {
2025-11-09T23:19:32.4298391Z              // Graceful degradation: return informative error instead of failing silently
2025-11-09T23:19:32.4300500Z -            Err(anyhow::anyhow!("Storage not available. This operation requires storage to be initialized."))
2025-11-09T23:19:32.4300647Z +            Err(anyhow::anyhow!(
2025-11-09T23:19:32.4300986Z +                "Storage not available. This operation requires storage to be initialized."
2025-11-09T23:19:32.4301310Z +            ))
2025-11-09T23:19:32.4301429Z          }
2025-11-09T23:19:32.4301789Z      }
2025-11-09T23:19:32.4301901Z  
2025-11-09T23:19:32.4302369Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1050:
2025-11-09T23:19:32.4302706Z      pub async fn reconsider_block(&self, params: &Value) -> Result<Value> {
2025-11-09T23:19:32.4302891Z          debug!("RPC: reconsiderblock");
2025-11-09T23:19:32.4303013Z  
2025-11-09T23:19:32.4303176Z -        let blockhash = params.get(0)
2025-11-09T23:19:32.4303317Z +        let blockhash = params
2025-11-09T23:19:32.4303433Z +            .get(0)
2025-11-09T23:19:32.4303586Z              .and_then(|p| p.as_str())
2025-11-09T23:19:32.4303862Z              .ok_or_else(|| anyhow::anyhow!("Block hash parameter required"))?;
2025-11-09T23:19:32.4303974Z  
2025-11-09T23:19:32.4304624Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1057:
2025-11-09T23:19:32.4304814Z -        let hash_bytes = hex::decode(blockhash)
2025-11-09T23:19:32.4305056Z -            .map_err(|e| anyhow::anyhow!("Invalid block hash: {}", e))?;
2025-11-09T23:19:32.4305201Z +        let hash_bytes =
2025-11-09T23:19:32.4305556Z +            hex::decode(blockhash).map_err(|e| anyhow::anyhow!("Invalid block hash: {}", e))?;
2025-11-09T23:19:32.4305706Z          if hash_bytes.len() != 32 {
2025-11-09T23:19:32.4317239Z              return Err(anyhow::anyhow!("Block hash must be 32 bytes"));
2025-11-09T23:19:32.4317396Z          }
2025-11-09T23:19:32.4317870Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1065:
2025-11-09T23:19:32.4318046Z          if let Some(ref storage) = self.storage {
2025-11-09T23:19:32.4318192Z              // Remove from invalid blocks set
2025-11-09T23:19:32.4318374Z              storage.chain().unmark_invalid(&hash)?;
2025-11-09T23:19:32.4318501Z -            
2025-11-09T23:19:32.4318617Z +
2025-11-09T23:19:32.4318924Z              // If this block is now valid, it may be reconsidered for chain inclusion
2025-11-09T23:19:32.4319131Z              // The node will handle this on next block processing
2025-11-09T23:19:32.4319253Z  
2025-11-09T23:19:32.4319694Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1072:
2025-11-09T23:19:32.4320052Z              Ok(json!(null))
2025-11-09T23:19:32.4320167Z          } else {
2025-11-09T23:19:32.4320501Z              // Graceful degradation: return informative error instead of failing silently
2025-11-09T23:19:32.4320980Z -            Err(anyhow::anyhow!("Storage not available. This operation requires storage to be initialized."))
2025-11-09T23:19:32.4321128Z +            Err(anyhow::anyhow!(
2025-11-09T23:19:32.4321456Z +                "Storage not available. This operation requires storage to be initialized."
2025-11-09T23:19:32.4321561Z +            ))
2025-11-09T23:19:32.4321663Z          }
2025-11-09T23:19:32.4321771Z      }
2025-11-09T23:19:32.4321872Z  
2025-11-09T23:19:32.4322312Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1079:
2025-11-09T23:19:32.4322452Z      /// Wait for new block
2025-11-09T23:19:32.4322556Z      ///
2025-11-09T23:19:32.4322848Z      /// Params: ["timeout"] (optional, timeout in seconds, default: no timeout)
2025-11-09T23:19:32.4322950Z -    /// 
2025-11-09T23:19:32.4323057Z +    ///
2025-11-09T23:19:32.4323352Z      /// Note: Full implementation requires async notification infrastructure.
2025-11-09T23:19:32.4323650Z      /// Currently returns current tip immediately. Future enhancement will:
2025-11-09T23:19:32.4323829Z      /// 1. Subscribe to block notifications
2025-11-09T23:19:32.4324483Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1088:
2025-11-09T23:19:32.4324815Z      pub async fn wait_for_new_block(&self, params: &Value) -> Result<Value> {
2025-11-09T23:19:32.4324983Z          debug!("RPC: waitfornewblock");
2025-11-09T23:19:32.4325093Z  
2025-11-09T23:19:32.4325246Z -        let _timeout = params.get(0)
2025-11-09T23:19:32.4325649Z +        let _timeout = params
2025-11-09T23:19:32.4325780Z +            .get(0)
2025-11-09T23:19:32.4325932Z              .and_then(|p| p.as_u64())
2025-11-09T23:19:32.4326154Z              .map(|t| tokio::time::Duration::from_secs(t));
2025-11-09T23:19:32.4326277Z  
2025-11-09T23:19:32.4326748Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1104:
2025-11-09T23:19:32.4326867Z              }
2025-11-09T23:19:32.4326982Z          } else {
2025-11-09T23:19:32.4327351Z              // Graceful degradation: return informative error instead of failing silently
2025-11-09T23:19:32.4327826Z -            Err(anyhow::anyhow!("Storage not available. This operation requires storage to be initialized."))
2025-11-09T23:19:32.4329982Z +            Err(anyhow::anyhow!(
2025-11-09T23:19:32.4330344Z +                "Storage not available. This operation requires storage to be initialized."
2025-11-09T23:19:32.4330463Z +            ))
2025-11-09T23:19:32.4330573Z          }
2025-11-09T23:19:32.4330703Z      }
2025-11-09T23:19:32.4330815Z  
2025-11-09T23:19:32.4331287Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1111:
2025-11-09T23:19:32.4331449Z      /// Wait for specific block
2025-11-09T23:19:32.4331567Z      ///
2025-11-09T23:19:32.4331836Z      /// Params: ["blockhash", "timeout"] (block hash, optional timeout)
2025-11-09T23:19:32.4331953Z -    /// 
2025-11-09T23:19:32.4332067Z +    ///
2025-11-09T23:19:32.4332382Z      /// Note: Full implementation requires async notification infrastructure.
2025-11-09T23:19:32.4332700Z      /// Currently checks if block exists immediately. Future enhancement will:
2025-11-09T23:19:32.4332866Z      /// 1. Subscribe to block notifications
2025-11-09T23:19:32.4333338Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1120:
2025-11-09T23:19:32.4333638Z      pub async fn wait_for_block(&self, params: &Value) -> Result<Value> {
2025-11-09T23:19:32.4333794Z          debug!("RPC: waitforblock");
2025-11-09T23:19:32.4333930Z  
2025-11-09T23:19:32.4334157Z -        let blockhash = params.get(0)
2025-11-09T23:19:32.4334731Z +        let blockhash = params
2025-11-09T23:19:32.4334859Z +            .get(0)
2025-11-09T23:19:32.4335013Z              .and_then(|p| p.as_str())
2025-11-09T23:19:32.4335313Z              .ok_or_else(|| anyhow::anyhow!("Block hash parameter required"))?;
2025-11-09T23:19:32.4335426Z  
2025-11-09T23:19:32.4335925Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1127:
2025-11-09T23:19:32.4336074Z -        let _timeout = params.get(1)
2025-11-09T23:19:32.4336208Z +        let _timeout = params
2025-11-09T23:19:32.4336329Z +            .get(1)
2025-11-09T23:19:32.4336475Z              .and_then(|p| p.as_u64())
2025-11-09T23:19:32.4336680Z              .map(|t| tokio::time::Duration::from_secs(t));
2025-11-09T23:19:32.4336790Z  
2025-11-09T23:19:32.4337278Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1131:
2025-11-09T23:19:32.4337456Z -        let hash_bytes = hex::decode(blockhash)
2025-11-09T23:19:32.4337708Z -            .map_err(|e| anyhow::anyhow!("Invalid block hash: {}", e))?;
2025-11-09T23:19:32.4339722Z +        let hash_bytes =
2025-11-09T23:19:32.4340156Z +            hex::decode(blockhash).map_err(|e| anyhow::anyhow!("Invalid block hash: {}", e))?;
2025-11-09T23:19:32.4340311Z          if hash_bytes.len() != 32 {
2025-11-09T23:19:32.4340590Z              return Err(anyhow::anyhow!("Block hash must be 32 bytes"));
2025-11-09T23:19:32.4340704Z          }
2025-11-09T23:19:32.4341161Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1140:
2025-11-09T23:19:32.4341339Z          // For now, check if block exists immediately
2025-11-09T23:19:32.4341525Z          if let Some(ref storage) = self.storage {
2025-11-09T23:19:32.4341768Z              if let Ok(Some(_block)) = storage.blocks().get_block(&hash) {
2025-11-09T23:19:32.4342227Z -                let height = storage.blocks().get_height_by_hash(&hash)?
2025-11-09T23:19:32.4342367Z -                    .unwrap_or(0);
2025-11-09T23:19:32.4342668Z +                let height = storage.blocks().get_height_by_hash(&hash)?.unwrap_or(0);
2025-11-09T23:19:32.4342782Z                  Ok(json!({
2025-11-09T23:19:32.4342915Z                      "hash": blockhash,
2025-11-09T23:19:32.4343036Z                      "height": height
2025-11-09T23:19:32.4343476Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1151:
2025-11-09T23:19:32.4343581Z              }
2025-11-09T23:19:32.4343696Z          } else {
2025-11-09T23:19:32.4344028Z              // Graceful degradation: return informative error instead of failing silently
2025-11-09T23:19:32.4344661Z -            Err(anyhow::anyhow!("Storage not available. This operation requires storage to be initialized."))
2025-11-09T23:19:32.4344819Z +            Err(anyhow::anyhow!(
2025-11-09T23:19:32.4345160Z +                "Storage not available. This operation requires storage to be initialized."
2025-11-09T23:19:32.4345265Z +            ))
2025-11-09T23:19:32.4345380Z          }
2025-11-09T23:19:32.4345484Z      }
2025-11-09T23:19:32.4345584Z  
2025-11-09T23:19:32.4346021Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1158:
2025-11-09T23:19:32.4346156Z      /// Wait for block height
2025-11-09T23:19:32.4346257Z      ///
2025-11-09T23:19:32.4346502Z      /// Params: ["height", "timeout"] (block height, optional timeout)
2025-11-09T23:19:32.4346613Z -    /// 
2025-11-09T23:19:32.4346715Z +    ///
2025-11-09T23:19:32.4347050Z      /// Note: Full implementation requires async notification infrastructure.
2025-11-09T23:19:32.4347436Z      /// Currently checks if block at height exists immediately. Future enhancement will:
2025-11-09T23:19:32.4347616Z      /// 1. Subscribe to block notifications
2025-11-09T23:19:32.4348091Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1167:
2025-11-09T23:19:32.4348446Z      pub async fn wait_for_block_height(&self, params: &Value) -> Result<Value> {
2025-11-09T23:19:32.4348835Z          debug!("RPC: waitforblockheight");
2025-11-09T23:19:32.4348939Z  
2025-11-09T23:19:32.4349075Z -        let height = params.get(0)
2025-11-09T23:19:32.4349211Z +        let height = params
2025-11-09T23:19:32.4349318Z +            .get(0)
2025-11-09T23:19:32.4349450Z              .and_then(|p| p.as_u64())
2025-11-09T23:19:32.4349706Z              .ok_or_else(|| anyhow::anyhow!("Height parameter required"))?;
2025-11-09T23:19:32.4349818Z  
2025-11-09T23:19:32.4350264Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1174:
2025-11-09T23:19:32.4350404Z -        let _timeout = params.get(1)
2025-11-09T23:19:32.4350537Z +        let _timeout = params
2025-11-09T23:19:32.4350642Z +            .get(1)
2025-11-09T23:19:32.4350782Z              .and_then(|p| p.as_u64())
2025-11-09T23:19:32.4350994Z              .map(|t| tokio::time::Duration::from_secs(t));
2025-11-09T23:19:32.4351182Z          if let Some(ref storage) = self.storage {
2025-11-09T23:19:32.4351674Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1186:
2025-11-09T23:19:32.4351948Z                      Err(anyhow::anyhow!("Block at height {} not found", height))
2025-11-09T23:19:32.4352077Z                  }
2025-11-09T23:19:32.4352200Z              } else {
2025-11-09T23:19:32.4352607Z -                Err(anyhow::anyhow!("Block at height {} not yet available (tip: {})", height, tip_height))
2025-11-09T23:19:32.4352769Z +                Err(anyhow::anyhow!(
2025-11-09T23:19:32.4352987Z +                    "Block at height {} not yet available (tip: {})",
2025-11-09T23:19:32.4353119Z +                    height,
2025-11-09T23:19:32.4353256Z +                    tip_height
2025-11-09T23:19:32.4353380Z +                ))
2025-11-09T23:19:32.4353490Z              }
2025-11-09T23:19:32.4353796Z          } else {
2025-11-09T23:19:32.4354162Z              // Graceful degradation: return informative error instead of failing silently
2025-11-09T23:19:32.4354802Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1193:
2025-11-09T23:19:32.4355267Z -            Err(anyhow::anyhow!("Storage not available. This operation requires storage to be initialized."))
2025-11-09T23:19:32.4355408Z +            Err(anyhow::anyhow!(
2025-11-09T23:19:32.4355751Z +                "Storage not available. This operation requires storage to be initialized."
2025-11-09T23:19:32.4355860Z +            ))
2025-11-09T23:19:32.4355967Z          }
2025-11-09T23:19:32.4356080Z      }
2025-11-09T23:19:32.4356184Z  
2025-11-09T23:19:32.4356636Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1200:
2025-11-09T23:19:32.4356940Z      pub async fn get_block_filter(&self, params: &Value) -> Result<Value> {
2025-11-09T23:19:32.4357088Z          debug!("RPC: getblockfilter");
2025-11-09T23:19:32.4357202Z  
2025-11-09T23:19:32.4357354Z -        let blockhash = params.get(0)
2025-11-09T23:19:32.4357517Z +        let blockhash = params
2025-11-09T23:19:32.4357636Z +            .get(0)
2025-11-09T23:19:32.4357775Z              .and_then(|p| p.as_str())
2025-11-09T23:19:32.4358054Z              .ok_or_else(|| anyhow::anyhow!("Block hash parameter required"))?;
2025-11-09T23:19:32.4358160Z  
2025-11-09T23:19:32.4358644Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1207:
2025-11-09T23:19:32.4358842Z -        let filtertype = params.get(1)
2025-11-09T23:19:32.4358985Z -            .and_then(|p| p.as_u64())
2025-11-09T23:19:32.4359151Z -            .unwrap_or(0); // Default: Basic filter
2025-11-09T23:19:32.4360934Z +        let filtertype = params.get(1).and_then(|p| p.as_u64()).unwrap_or(0); // Default: Basic filter
2025-11-09T23:19:32.4361049Z  
2025-11-09T23:19:32.4361182Z          if filtertype != 0 {
2025-11-09T23:19:32.4361499Z              return Err(anyhow::anyhow!("Only filter type 0 (Basic) is supported"));
2025-11-09T23:19:32.4362150Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1213:
2025-11-09T23:19:32.4362261Z          }
2025-11-09T23:19:32.4362366Z  
2025-11-09T23:19:32.4362533Z -        let hash_bytes = hex::decode(blockhash)
2025-11-09T23:19:32.4362781Z -            .map_err(|e| anyhow::anyhow!("Invalid block hash: {}", e))?;
2025-11-09T23:19:32.4362905Z +        let hash_bytes =
2025-11-09T23:19:32.4363253Z +            hex::decode(blockhash).map_err(|e| anyhow::anyhow!("Invalid block hash: {}", e))?;
2025-11-09T23:19:32.4363397Z          if hash_bytes.len() != 32 {
2025-11-09T23:19:32.4363649Z              return Err(anyhow::anyhow!("Block hash must be 32 bytes"));
2025-11-09T23:19:32.4363758Z          }
2025-11-09T23:19:32.4364227Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1226:
2025-11-09T23:19:32.4364689Z                  // Get filter service from network manager (if available)
2025-11-09T23:19:32.4364854Z                  // For now, generate filter directly
2025-11-09T23:19:32.4365070Z                  use bllvm_protocol::bip158::build_block_filter;
2025-11-09T23:19:32.4365181Z -                
2025-11-09T23:19:32.4365284Z +
2025-11-09T23:19:32.4365470Z                  // Get previous outpoint scripts from UTXO set
2025-11-09T23:19:32.4365705Z                  // For each input, find the UTXO and get its script_pubkey
2025-11-09T23:19:32.4365874Z                  let mut previous_scripts = Vec::new();
2025-11-09T23:19:32.4366330Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1239:
2025-11-09T23:19:32.4366457Z                          }
2025-11-09T23:19:32.4366571Z                      }
2025-11-09T23:19:32.4366680Z                  }
2025-11-09T23:19:32.4366788Z -                
2025-11-09T23:19:32.4366901Z +
2025-11-09T23:19:32.4367204Z                  match build_block_filter(&block.transactions, &previous_scripts) {
2025-11-09T23:19:32.4367508Z                      Ok(filter) => {
2025-11-09T23:19:32.4367651Z                          Ok(json!({
2025-11-09T23:19:32.4368105Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1247:
2025-11-09T23:19:32.4368375Z                              "header": hex::encode([0u8; 32]), // Would calculate filter header
2025-11-09T23:19:32.4368504Z                          }))
2025-11-09T23:19:32.4368615Z                      }
2025-11-09T23:19:32.4368862Z -                    Err(e) => Err(anyhow::anyhow!("Failed to build filter: {}", e))
2025-11-09T23:19:32.4369105Z +                    Err(e) => Err(anyhow::anyhow!("Failed to build filter: {}", e)),
2025-11-09T23:19:32.4369227Z                  }
2025-11-09T23:19:32.4369342Z              } else {
2025-11-09T23:19:32.4369518Z                  Err(anyhow::anyhow!("Block not found"))
2025-11-09T23:19:32.4369997Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1254:
2025-11-09T23:19:32.4370127Z              }
2025-11-09T23:19:32.4370251Z          } else {
2025-11-09T23:19:32.4371008Z              // Graceful degradation: return informative error instead of failing silently
2025-11-09T23:19:32.4371493Z -            Err(anyhow::anyhow!("Storage not available. This operation requires storage to be initialized."))
2025-11-09T23:19:32.4371635Z +            Err(anyhow::anyhow!(
2025-11-09T23:19:32.4371988Z +                "Storage not available. This operation requires storage to be initialized."
2025-11-09T23:19:32.4372117Z +            ))
2025-11-09T23:19:32.4372228Z          }
2025-11-09T23:19:32.4372341Z      }
2025-11-09T23:19:32.4372452Z  
2025-11-09T23:19:32.4372986Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/control.rs:89:
2025-11-09T23:19:32.4373314Z      pub async fn getmemoryinfo(&self, params: &Value) -> RpcResult<Value> {
2025-11-09T23:19:32.4373483Z          debug!("RPC: getmemoryinfo");
2025-11-09T23:19:32.4373607Z  
2025-11-09T23:19:32.4373745Z -        let mode = params
2025-11-09T23:19:32.4374119Z -            .get(0)
2025-11-09T23:19:32.4374269Z -            .and_then(|p| p.as_str())
2025-11-09T23:19:32.4374576Z -            .unwrap_or("stats");
2025-11-09T23:19:32.4374874Z +        let mode = params.get(0).and_then(|p| p.as_str()).unwrap_or("stats");
2025-11-09T23:19:32.4374990Z  
2025-11-09T23:19:32.4375111Z          match mode {
2025-11-09T23:19:32.4375238Z              "stats" => {
2025-11-09T23:19:32.4375681Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/control.rs:224:
2025-11-09T23:19:32.4375802Z          } else {
2025-11-09T23:19:32.4376023Z              // No command specified, return list of all commands
2025-11-09T23:19:32.4376162Z              let commands = vec![
2025-11-09T23:19:32.4376482Z -                "getblockchaininfo", "getblock", "getblockhash", "getblockheader",
2025-11-09T23:19:32.4376834Z -                "getbestblockhash", "getblockcount", "getdifficulty", "gettxoutsetinfo",
2025-11-09T23:19:32.4377243Z -                "verifychain", "getrawtransaction", "sendrawtransaction", "testmempoolaccept",
2025-11-09T23:19:32.4377615Z -                "decoderawtransaction", "gettxout", "gettxoutproof", "verifytxoutproof",
2025-11-09T23:19:32.4377959Z -                "getmempoolinfo", "getrawmempool", "savemempool", "getnetworkinfo",
2025-11-09T23:19:32.4378320Z -                "getpeerinfo", "getconnectioncount", "ping", "addnode", "disconnectnode",
2025-11-09T23:19:32.4378645Z -                "getnettotals", "clearbanned", "setban", "listbanned", "getmininginfo",
2025-11-09T23:19:32.4378990Z -                "getblocktemplate", "submitblock", "estimatesmartfee", "stop", "uptime",
2025-11-09T23:19:32.4379209Z -                "getmemoryinfo", "getrpcinfo", "help", "logging",
2025-11-09T23:19:32.4379421Z +                "getblockchaininfo",
2025-11-09T23:19:32.4379558Z +                "getblock",
2025-11-09T23:19:32.4379939Z +                "getblockhash",
2025-11-09T23:19:32.4380087Z +                "getblockheader",
2025-11-09T23:19:32.4380703Z +                "getbestblockhash",
2025-11-09T23:19:32.4380876Z +                "getblockcount",
2025-11-09T23:19:32.4381010Z +                "getdifficulty",
2025-11-09T23:19:32.4381142Z +                "gettxoutsetinfo",
2025-11-09T23:19:32.4382800Z +                "verifychain",
2025-11-09T23:19:32.4382943Z +                "getrawtransaction",
2025-11-09T23:19:32.4383089Z +                "sendrawtransaction",
2025-11-09T23:19:32.4383242Z +                "testmempoolaccept",
2025-11-09T23:19:32.4383406Z +                "decoderawtransaction",
2025-11-09T23:19:32.4383537Z +                "gettxout",
2025-11-09T23:19:32.4383676Z +                "gettxoutproof",
2025-11-09T23:19:32.4383824Z +                "verifytxoutproof",
2025-11-09T23:19:32.4383964Z +                "getmempoolinfo",
2025-11-09T23:19:32.4384094Z +                "getrawmempool",
2025-11-09T23:19:32.4384247Z +                "savemempool",
2025-11-09T23:19:32.4384574Z +                "getnetworkinfo",
2025-11-09T23:19:32.4384725Z +                "getpeerinfo",
2025-11-09T23:19:32.4384877Z +                "getconnectioncount",
2025-11-09T23:19:32.4385009Z +                "ping",
2025-11-09T23:19:32.4385133Z +                "addnode",
2025-11-09T23:19:32.4385272Z +                "disconnectnode",
2025-11-09T23:19:32.4385414Z +                "getnettotals",
2025-11-09T23:19:32.4385543Z +                "clearbanned",
2025-11-09T23:19:32.4385664Z +                "setban",
2025-11-09T23:19:32.4385786Z +                "listbanned",
2025-11-09T23:19:32.4385917Z +                "getmininginfo",
2025-11-09T23:19:32.4386056Z +                "getblocktemplate",
2025-11-09T23:19:32.4386183Z +                "submitblock",
2025-11-09T23:19:32.4386313Z +                "estimatesmartfee",
2025-11-09T23:19:32.4386428Z +                "stop",
2025-11-09T23:19:32.4386544Z +                "uptime",
2025-11-09T23:19:32.4386693Z +                "getmemoryinfo",
2025-11-09T23:19:32.4386829Z +                "getrpcinfo",
2025-11-09T23:19:32.4387195Z +                "help",
2025-11-09T23:19:32.4387325Z +                "logging",
2025-11-09T23:19:32.4387444Z              ];
2025-11-09T23:19:32.4387554Z  
2025-11-09T23:19:32.4387714Z              Ok(json!(commands.join("\n")))
2025-11-09T23:19:32.4388161Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/control.rs:275:
2025-11-09T23:19:32.4388350Z          // 1. Store a reference to the EnvFilter layer
2025-11-09T23:19:32.4388574Z          // 2. Provide methods to update the filter dynamically
2025-11-09T23:19:32.4388760Z          // 3. Rebuild the subscriber with the new filter
2025-11-09T23:19:32.4388884Z -        
2025-11-09T23:19:32.4388994Z +
2025-11-09T23:19:32.4389167Z          // Check current filter state from environment
2025-11-09T23:19:32.4389373Z -        let current_filter = std::env::var("RUST_LOG")
2025-11-09T23:19:32.4389546Z -            .unwrap_or_else(|_| "info".to_string());
2025-11-09T23:19:32.4389652Z -        
2025-11-09T23:19:32.4390008Z +        let current_filter = std::env::var("RUST_LOG").unwrap_or_else(|_| "info".to_string());
2025-11-09T23:19:32.4390113Z +
2025-11-09T23:19:32.4390324Z          // Determine if debug logging is active based on filter
2025-11-09T23:19:32.4390528Z -        let active = current_filter.contains("debug") || 
2025-11-09T23:19:32.4390706Z -                     current_filter.contains("trace") ||
2025-11-09T23:19:32.4390883Z -                     !exclude.contains(&"all".to_string());
2025-11-09T23:19:32.4391074Z +        let active = current_filter.contains("debug")
2025-11-09T23:19:32.4391245Z +            || current_filter.contains("trace")
2025-11-09T23:19:32.4391412Z +            || !exclude.contains(&"all".to_string());
2025-11-09T23:19:32.4391526Z  
2025-11-09T23:19:32.4391652Z          Ok(json!({
2025-11-09T23:19:32.4391785Z              "active": active,
2025-11-09T23:19:32.4392521Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/control.rs:297:
2025-11-09T23:19:32.4392794Z      /// Returns comprehensive health report for all node components
2025-11-09T23:19:32.4393086Z      pub async fn gethealth(&self, _params: &Value) -> RpcResult<Value> {
2025-11-09T23:19:32.4393227Z          debug!("RPC: gethealth");
2025-11-09T23:19:32.4393343Z -        
2025-11-09T23:19:32.4393463Z +
2025-11-09T23:19:32.4393742Z          // This would need access to Node instance to get full health report
2025-11-09T23:19:32.4393910Z          // For now, return basic health status
2025-11-09T23:19:32.4394029Z          Ok(json!({
2025-11-09T23:19:32.4394675Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/control.rs:312:
2025-11-09T23:19:32.4394880Z      /// Returns comprehensive metrics for monitoring
2025-11-09T23:19:32.4395173Z      pub async fn getmetrics(&self, _params: &Value) -> RpcResult<Value> {
2025-11-09T23:19:32.4395333Z          debug!("RPC: getmetrics");
2025-11-09T23:19:32.4395449Z -        
2025-11-09T23:19:32.4395557Z +
2025-11-09T23:19:32.4395838Z          // This would need access to MetricsCollector to get full metrics
2025-11-09T23:19:32.4395989Z          // For now, return basic metrics
2025-11-09T23:19:32.4396188Z          let uptime = self.start_time.elapsed().as_secs();
2025-11-09T23:19:32.4396627Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/control.rs:328:
2025-11-09T23:19:32.4396773Z          Self::new()
2025-11-09T23:19:32.4396884Z      }
2025-11-09T23:19:32.4397001Z  }
2025-11-09T23:19:32.4397116Z -
2025-11-09T23:19:32.4397226Z  
2025-11-09T23:19:32.4397661Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:23:
2025-11-09T23:19:32.4397796Z  impl MempoolRpc {
2025-11-09T23:19:32.4397957Z      /// Create a new mempool RPC handler
2025-11-09T23:19:32.4398091Z      pub fn new() -> Self {
2025-11-09T23:19:32.4398249Z -        Self { mempool: None, storage: None }
2025-11-09T23:19:32.4398375Z +        Self {
2025-11-09T23:19:32.4398499Z +            mempool: None,
2025-11-09T23:19:32.4398858Z +            storage: None,
2025-11-09T23:19:32.4398966Z +        }
2025-11-09T23:19:32.4399085Z      }
2025-11-09T23:19:32.4399195Z  
2025-11-09T23:19:32.4399342Z      /// Create with dependencies
2025-11-09T23:19:32.4399758Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:30:
2025-11-09T23:19:32.4400135Z      pub fn with_dependencies(mempool: Arc<MempoolManager>, storage: Arc<Storage>) -> Self {
2025-11-09T23:19:32.4400362Z -        Self { mempool: Some(mempool), storage: Some(storage) }
2025-11-09T23:19:32.4400478Z +        Self {
2025-11-09T23:19:32.4400635Z +            mempool: Some(mempool),
2025-11-09T23:19:32.4400774Z +            storage: Some(storage),
2025-11-09T23:19:32.4401580Z +        }
2025-11-09T23:19:32.4401739Z      }
2025-11-09T23:19:32.4401855Z  
2025-11-09T23:19:32.4402005Z      /// Get mempool information
2025-11-09T23:19:32.4402464Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:40:
2025-11-09T23:19:32.4402666Z          if let Some(ref mempool) = self.mempool {
2025-11-09T23:19:32.4402821Z              let size = mempool.size();
2025-11-09T23:19:32.4403023Z              let transactions = mempool.get_transactions();
2025-11-09T23:19:32.4403237Z -            let bytes: usize = transactions.iter().map(|tx| {
2025-11-09T23:19:32.4403582Z -                use bllvm_protocol::serialization::transaction::serialize_transaction;
2025-11-09T23:19:32.4403753Z -                serialize_transaction(tx).len()
2025-11-09T23:19:32.4403883Z -            }).sum();
2025-11-09T23:19:32.4404044Z +            let bytes: usize = transactions
2025-11-09T23:19:32.4404166Z +                .iter()
2025-11-09T23:19:32.4404296Z +                .map(|tx| {
2025-11-09T23:19:32.4404891Z +                    use bllvm_protocol::serialization::transaction::serialize_transaction;
2025-11-09T23:19:32.4405317Z +                    serialize_transaction(tx).len()
2025-11-09T23:19:32.4405428Z +                })
2025-11-09T23:19:32.4405560Z +                .sum();
2025-11-09T23:19:32.4405664Z  
2025-11-09T23:19:32.4405777Z              Ok(json!({
2025-11-09T23:19:32.4405910Z                  "loaded": true,
2025-11-09T23:19:32.4406359Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:56:
2025-11-09T23:19:32.4406478Z              }))
2025-11-09T23:19:32.4406596Z          } else {
2025-11-09T23:19:32.4406950Z              // Graceful degradation: return empty mempool info when mempool unavailable
2025-11-09T23:19:32.4407401Z -            tracing::debug!("getmempoolinfo called but mempool not available, returning empty mempool");
2025-11-09T23:19:32.4407528Z +            tracing::debug!(
2025-11-09T23:19:32.4407882Z +                "getmempoolinfo called but mempool not available, returning empty mempool"
2025-11-09T23:19:32.4408002Z +            );
2025-11-09T23:19:32.4408133Z              Ok(json!({
2025-11-09T23:19:32.4408267Z                  "loaded": false,
2025-11-09T23:19:32.4408407Z                  "size": 0,
2025-11-09T23:19:32.4408843Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:82:
2025-11-09T23:19:32.4409042Z              let transactions = mempool.get_transactions();
2025-11-09T23:19:32.4409252Z              use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:19:32.4409578Z              use bllvm_protocol::serialization::transaction::serialize_transaction;
2025-11-09T23:19:32.4409692Z -            
2025-11-09T23:19:32.4409811Z +
2025-11-09T23:19:32.4409940Z              if verbose {
2025-11-09T23:19:32.4410121Z                  let mut result = serde_json::Map::new();
2025-11-09T23:19:32.4410272Z                  for tx in transactions {
2025-11-09T23:19:32.4410701Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:90:
2025-11-09T23:19:32.4410868Z                      let txid_hex = hex::encode(txid);
2025-11-09T23:19:32.4411032Z                      let txid_hex_clone = txid_hex.clone();
2025-11-09T23:19:32.4411454Z                      let size = serialize_transaction(&tx).len();
2025-11-09T23:19:32.4411574Z -                    
2025-11-09T23:19:32.4411687Z +
2025-11-09T23:19:32.4411848Z                      result.insert(txid_hex, json!({
2025-11-09T23:19:32.4411991Z                          "size": size,
2025-11-09T23:19:32.4412409Z                          "fee": if let (Some(ref mempool), Some(ref storage)) = (self.mempool.as_ref(), self.storage.as_ref()) {
2025-11-09T23:19:32.4412856Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:126:
2025-11-09T23:19:32.4412982Z                  }
2025-11-09T23:19:32.4413116Z                  Ok(json!(result))
2025-11-09T23:19:32.4413232Z              } else {
2025-11-09T23:19:32.4413475Z -                let txids: Vec<String> = transactions.iter().map(|tx| {
2025-11-09T23:19:32.4413650Z -                    let txid = calculate_tx_id(tx);
2025-11-09T23:19:32.4413800Z -                    hex::encode(txid)
2025-11-09T23:19:32.4413932Z -                }).collect();
2025-11-09T23:19:32.4414105Z +                let txids: Vec<String> = transactions
2025-11-09T23:19:32.4414230Z +                    .iter()
2025-11-09T23:19:32.4414535Z +                    .map(|tx| {
2025-11-09T23:19:32.4414716Z +                        let txid = calculate_tx_id(tx);
2025-11-09T23:19:32.4414863Z +                        hex::encode(txid)
2025-11-09T23:19:32.4414986Z +                    })
2025-11-09T23:19:32.4415115Z +                    .collect();
2025-11-09T23:19:32.4415258Z                  Ok(json!(txids))
2025-11-09T23:19:32.4415370Z              }
2025-11-09T23:19:32.4415486Z          } else {
2025-11-09T23:19:32.4415941Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:174:
2025-11-09T23:19:32.4416117Z          if let Some(mempool) = &self.mempool {
2025-11-09T23:19:32.4416677Z              let data_dir = std::env::var("DATA_DIR").unwrap_or_else(|_| "data".to_string());
2025-11-09T23:19:32.4417016Z              let mempool_path = std::path::Path::new(&data_dir).join("mempool.dat");
2025-11-09T23:19:32.4417133Z -            
2025-11-09T23:19:32.4417242Z +
2025-11-09T23:19:32.4417476Z              // Arc implements Deref, so we can call methods directly
2025-11-09T23:19:32.4417705Z              if let Err(e) = mempool.save_to_disk(&mempool_path) {
2025-11-09T23:19:32.4417961Z -                return Err(crate::rpc::errors::RpcError::internal_error(
2025-11-09T23:19:32.4418151Z -                    format!("Failed to save mempool: {}", e)
2025-11-09T23:19:32.4418276Z -                ));
2025-11-09T23:19:32.4418563Z +                return Err(crate::rpc::errors::RpcError::internal_error(format!(
2025-11-09T23:19:32.4418728Z +                    "Failed to save mempool: {}",
2025-11-09T23:19:32.4418856Z +                    e
2025-11-09T23:19:32.4418975Z +                )));
2025-11-09T23:19:32.4419098Z              }
2025-11-09T23:19:32.4419227Z              Ok(json!(null))
2025-11-09T23:19:32.4419353Z          } else {
2025-11-09T23:19:32.4419800Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:186:
2025-11-09T23:19:32.4420016Z              Err(crate::rpc::errors::RpcError::internal_error(
2025-11-09T23:19:32.4420198Z -                "Mempool not initialized".to_string()
2025-11-09T23:19:32.4420370Z +                "Mempool not initialized".to_string(),
2025-11-09T23:19:32.4420485Z              ))
2025-11-09T23:19:32.4420596Z          }
2025-11-09T23:19:32.4420709Z      }
2025-11-09T23:19:32.4421147Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:195:
2025-11-09T23:19:32.4421512Z      pub async fn getmempoolancestors(&self, params: &Value) -> RpcResult<Value> {
2025-11-09T23:19:32.4421695Z          debug!("RPC: getmempoolancestors");
2025-11-09T23:19:32.4421802Z  
2025-11-09T23:19:32.4421961Z -        let txid = params.get(0)
2025-11-09T23:19:32.4422117Z -            .and_then(|p| p.as_str())
2025-11-09T23:19:32.4422824Z -            .ok_or_else(|| crate::rpc::errors::RpcError::invalid_params("Transaction ID required".to_string()))?;
2025-11-09T23:19:32.4423090Z +        let txid = params.get(0).and_then(|p| p.as_str()).ok_or_else(|| {
2025-11-09T23:19:32.4423532Z +            crate::rpc::errors::RpcError::invalid_params("Transaction ID required".to_string())
2025-11-09T23:19:32.4423662Z +        })?;
2025-11-09T23:19:32.4423773Z  
2025-11-09T23:19:32.4424077Z          let verbose = params.get(1).and_then(|p| p.as_bool()).unwrap_or(false);
2025-11-09T23:19:32.4424200Z  
2025-11-09T23:19:32.4424818Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:204:
2025-11-09T23:19:32.4424997Z -        let hash_bytes = hex::decode(txid)
2025-11-09T23:19:32.4425453Z -            .map_err(|e| crate::rpc::errors::RpcError::invalid_params(format!("Invalid transaction ID: {}", e)))?;
2025-11-09T23:19:32.4425673Z +        let hash_bytes = hex::decode(txid).map_err(|e| {
2025-11-09T23:19:32.4426073Z +            crate::rpc::errors::RpcError::invalid_params(format!("Invalid transaction ID: {}", e))
2025-11-09T23:19:32.4426186Z +        })?;
2025-11-09T23:19:32.4426334Z          if hash_bytes.len() != 32 {
2025-11-09T23:19:32.4426819Z -            return Err(crate::rpc::errors::RpcError::invalid_params("Transaction ID must be 32 bytes".to_string()));
2025-11-09T23:19:32.4427069Z +            return Err(crate::rpc::errors::RpcError::invalid_params(
2025-11-09T23:19:32.4427279Z +                "Transaction ID must be 32 bytes".to_string(),
2025-11-09T23:19:32.4427394Z +            ));
2025-11-09T23:19:32.4427508Z          }
2025-11-09T23:19:32.4427658Z          let mut hash = [0u8; 32];
2025-11-09T23:19:32.4427815Z          hash.copy_from_slice(&hash_bytes);
2025-11-09T23:19:32.4428271Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:222:
2025-11-09T23:19:32.4428761Z                          let ancestor_txid_clone = ancestor_txid.clone();
2025-11-09T23:19:32.4429130Z                          use bllvm_protocol::serialization::transaction::serialize_transaction;
2025-11-09T23:19:32.4429357Z                          let size = serialize_transaction(&ancestor_tx).len();
2025-11-09T23:19:32.4429480Z -                        
2025-11-09T23:19:32.4429602Z +
2025-11-09T23:19:32.4429766Z                          result.insert(ancestor_txid, json!({
2025-11-09T23:19:32.4429895Z                              "size": size,
2025-11-09T23:19:32.4431559Z                              "fee": if let Some(ref storage) = self.storage {
2025-11-09T23:19:32.4431989Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:278:
2025-11-09T23:19:32.4432354Z      pub async fn getmempooldescendants(&self, params: &Value) -> RpcResult<Value> {
2025-11-09T23:19:32.4432521Z          debug!("RPC: getmempooldescendants");
2025-11-09T23:19:32.4432644Z  
2025-11-09T23:19:32.4432774Z -        let txid = params.get(0)
2025-11-09T23:19:32.4432911Z -            .and_then(|p| p.as_str())
2025-11-09T23:19:32.4433374Z -            .ok_or_else(|| crate::rpc::errors::RpcError::invalid_params("Transaction ID required".to_string()))?;
2025-11-09T23:19:32.4433637Z +        let txid = params.get(0).and_then(|p| p.as_str()).ok_or_else(|| {
2025-11-09T23:19:32.4433995Z +            crate::rpc::errors::RpcError::invalid_params("Transaction ID required".to_string())
2025-11-09T23:19:32.4434114Z +        })?;
2025-11-09T23:19:32.4434215Z  
2025-11-09T23:19:32.4434677Z          let verbose = params.get(1).and_then(|p| p.as_bool()).unwrap_or(false);
2025-11-09T23:19:32.4434784Z  
2025-11-09T23:19:32.4435225Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:287:
2025-11-09T23:19:32.4435383Z -        let hash_bytes = hex::decode(txid)
2025-11-09T23:19:32.4435817Z -            .map_err(|e| crate::rpc::errors::RpcError::invalid_params(format!("Invalid transaction ID: {}", e)))?;
2025-11-09T23:19:32.4436019Z +        let hash_bytes = hex::decode(txid).map_err(|e| {
2025-11-09T23:19:32.4436612Z +            crate::rpc::errors::RpcError::invalid_params(format!("Invalid transaction ID: {}", e))
2025-11-09T23:19:32.4436727Z +        })?;
2025-11-09T23:19:32.4436927Z          if hash_bytes.len() != 32 {
2025-11-09T23:19:32.4437402Z -            return Err(crate::rpc::errors::RpcError::invalid_params("Transaction ID must be 32 bytes".to_string()));
2025-11-09T23:19:32.4437630Z +            return Err(crate::rpc::errors::RpcError::invalid_params(
2025-11-09T23:19:32.4437815Z +                "Transaction ID must be 32 bytes".to_string(),
2025-11-09T23:19:32.4437929Z +            ));
2025-11-09T23:19:32.4438029Z          }
2025-11-09T23:19:32.4438152Z          let mut hash = [0u8; 32];
2025-11-09T23:19:32.4438316Z          hash.copy_from_slice(&hash_bytes);
2025-11-09T23:19:32.4438771Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:295:
2025-11-09T23:19:32.4438959Z          if let Some(ref mempool) = self.mempool {
2025-11-09T23:19:32.4439384Z              // Find descendants by checking which transactions spend outputs created by this transaction
2025-11-09T23:19:32.4439540Z              let mut descendants = Vec::new();
2025-11-09T23:19:32.4439645Z -            
2025-11-09T23:19:32.4439744Z +
2025-11-09T23:19:32.4439939Z              if let Some(tx) = mempool.get_transaction(&hash) {
2025-11-09T23:19:32.4440759Z                  // Get all output outpoints from this transaction
2025-11-09T23:19:32.4440989Z                  let mut output_outpoints = Vec::new();
2025-11-09T23:19:32.4441460Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:329:
2025-11-09T23:19:32.4441697Z                          let descendant_txid_clone = descendant_txid.clone();
2025-11-09T23:19:32.4442037Z                          use bllvm_protocol::serialization::transaction::serialize_transaction;
2025-11-09T23:19:32.4442519Z                          let size = serialize_transaction(&descendant_tx).len();
2025-11-09T23:19:32.4442659Z -                        
2025-11-09T23:19:32.4442774Z +
2025-11-09T23:19:32.4442960Z                          result.insert(descendant_txid, json!({
2025-11-09T23:19:32.4443109Z                              "size": size,
2025-11-09T23:19:32.4443312Z                              "fee": if let Some(ref storage) = self.storage {
2025-11-09T23:19:32.4443759Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:385:
2025-11-09T23:19:32.4444103Z      pub async fn getmempoolentry(&self, params: &Value) -> RpcResult<Value> {
2025-11-09T23:19:32.4444266Z          debug!("RPC: getmempoolentry");
2025-11-09T23:19:32.4444569Z  
2025-11-09T23:19:32.4444732Z -        let txid = params.get(0)
2025-11-09T23:19:32.4444889Z -            .and_then(|p| p.as_str())
2025-11-09T23:19:32.4445436Z -            .ok_or_else(|| crate::rpc::errors::RpcError::invalid_params("Transaction ID required".to_string()))?;
2025-11-09T23:19:32.4445725Z +        let txid = params.get(0).and_then(|p| p.as_str()).ok_or_else(|| {
2025-11-09T23:19:32.4446605Z +            crate::rpc::errors::RpcError::invalid_params("Transaction ID required".to_string())
2025-11-09T23:19:32.4446751Z +        })?;
2025-11-09T23:19:32.4446864Z  
2025-11-09T23:19:32.4447195Z          let verbose = params.get(1).and_then(|p| p.as_bool()).unwrap_or(false);
2025-11-09T23:19:32.4447343Z  
2025-11-09T23:19:32.4447801Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:394:
2025-11-09T23:19:32.4447970Z -        let hash_bytes = hex::decode(txid)
2025-11-09T23:19:32.4448428Z -            .map_err(|e| crate::rpc::errors::RpcError::invalid_params(format!("Invalid transaction ID: {}", e)))?;
2025-11-09T23:19:32.4448622Z +        let hash_bytes = hex::decode(txid).map_err(|e| {
2025-11-09T23:19:32.4449022Z +            crate::rpc::errors::RpcError::invalid_params(format!("Invalid transaction ID: {}", e))
2025-11-09T23:19:32.4449149Z +        })?;
2025-11-09T23:19:32.4449294Z          if hash_bytes.len() != 32 {
2025-11-09T23:19:32.4450062Z -            return Err(crate::rpc::errors::RpcError::invalid_params("Transaction ID must be 32 bytes".to_string()));
2025-11-09T23:19:32.4450316Z +            return Err(crate::rpc::errors::RpcError::invalid_params(
2025-11-09T23:19:32.4450508Z +                "Transaction ID must be 32 bytes".to_string(),
2025-11-09T23:19:32.4450632Z +            ));
2025-11-09T23:19:32.4450742Z          }
2025-11-09T23:19:32.4450877Z          let mut hash = [0u8; 32];
2025-11-09T23:19:32.4451032Z          hash.copy_from_slice(&hash_bytes);
2025-11-09T23:19:32.4451485Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:403:
2025-11-09T23:19:32.4451693Z              if let Some(tx) = mempool.get_transaction(&hash) {
2025-11-09T23:19:32.4452027Z                  use bllvm_protocol::serialization::transaction::serialize_transaction;
2025-11-09T23:19:32.4452232Z                  let size = serialize_transaction(&tx).len();
2025-11-09T23:19:32.4452348Z -                
2025-11-09T23:19:32.4452468Z +
2025-11-09T23:19:32.4452630Z                  // Get ancestors and descendants
2025-11-09T23:19:32.4452848Z                  let ancestors = self.get_ancestors(mempool, &hash);
2025-11-09T23:19:32.4453086Z                  let descendants = self.get_descendants(mempool, &hash);
2025-11-09T23:19:32.4453533Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:410:
2025-11-09T23:19:32.4453657Z -                
2025-11-09T23:19:32.4453763Z +
2025-11-09T23:19:32.4453929Z                  let ancestor_count = ancestors.len();
2025-11-09T23:19:32.4454112Z                  let descendant_count = descendants.len();
2025-11-09T23:19:32.4454482Z -                let ancestor_size: usize = ancestors.iter()
2025-11-09T23:19:32.4454659Z +                let ancestor_size: usize = ancestors
2025-11-09T23:19:32.4455003Z +                    .iter()
2025-11-09T23:19:32.4455193Z                      .filter_map(|h| mempool.get_transaction(h))
2025-11-09T23:19:32.4455387Z                      .map(|tx| serialize_transaction(&tx).len())
2025-11-09T23:19:32.4455511Z                      .sum();
2025-11-09T23:19:32.4455959Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:417:
2025-11-09T23:19:32.4456162Z -                let descendant_size: usize = descendants.iter()
2025-11-09T23:19:32.4456340Z +                let descendant_size: usize = descendants
2025-11-09T23:19:32.4458373Z +                    .iter()
2025-11-09T23:19:32.4458561Z                      .filter_map(|h| mempool.get_transaction(h))
2025-11-09T23:19:32.4458728Z                      .map(|tx| serialize_transaction(&tx).len())
2025-11-09T23:19:32.4458845Z                      .sum();
2025-11-09T23:19:32.4459271Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:454:
2025-11-09T23:19:32.4459428Z                      "bip125-replaceable": false
2025-11-09T23:19:32.4459540Z                  }))
2025-11-09T23:19:32.4459696Z              } else {
2025-11-09T23:19:32.4459917Z -                Err(crate::rpc::errors::RpcError::invalid_params(
2025-11-09T23:19:32.4460142Z -                    format!("Transaction {} not found in mempool", txid)
2025-11-09T23:19:32.4460268Z -                ))
2025-11-09T23:19:32.4460516Z +                Err(crate::rpc::errors::RpcError::invalid_params(format!(
2025-11-09T23:19:32.4460691Z +                    "Transaction {} not found in mempool",
2025-11-09T23:19:32.4460808Z +                    txid
2025-11-09T23:19:32.4460929Z +                )))
2025-11-09T23:19:32.4461044Z              }
2025-11-09T23:19:32.4461160Z          } else {
2025-11-09T23:19:32.4461378Z              Err(crate::rpc::errors::RpcError::internal_error(
2025-11-09T23:19:32.4461992Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:463:
2025-11-09T23:19:32.4462172Z -                "Mempool not initialized".to_string()
2025-11-09T23:19:32.4462340Z +                "Mempool not initialized".to_string(),
2025-11-09T23:19:32.4462686Z              ))
2025-11-09T23:19:32.4462801Z          }
2025-11-09T23:19:32.4462912Z      }
2025-11-09T23:19:32.4463377Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:468:
2025-11-09T23:19:32.4463551Z      /// Helper: Get ancestors for a transaction
2025-11-09T23:19:32.4463897Z      fn get_ancestors(&self, mempool: &MempoolManager, tx_hash: &Hash) -> Vec<Hash> {
2025-11-09T23:19:32.4464053Z          let mut ancestors = Vec::new();
2025-11-09T23:19:32.4464225Z -        
2025-11-09T23:19:32.4464497Z +
2025-11-09T23:19:32.4464722Z          if let Some(tx) = mempool.get_transaction(tx_hash) {
2025-11-09T23:19:32.4465083Z              // Find transactions that this transaction depends on (spends their outputs)
2025-11-09T23:19:32.4465289Z              use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:19:32.4465730Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:478:
2025-11-09T23:19:32.4465900Z                  for ancestor_tx in transactions {
2025-11-09T23:19:32.4466121Z                      let ancestor_hash = calculate_tx_id(&ancestor_tx);
2025-11-09T23:19:32.4466381Z                      for (idx, _output) in ancestor_tx.outputs.iter().enumerate() {
2025-11-09T23:19:32.4466749Z -                        if input.prevout.hash == ancestor_hash && input.prevout.index == idx as u64 {
2025-11-09T23:19:32.4467092Z +                        if input.prevout.hash == ancestor_hash && input.prevout.index == idx as u64
2025-11-09T23:19:32.4467215Z +                        {
2025-11-09T23:19:32.4467402Z                              if !ancestors.contains(&ancestor_hash) {
2025-11-09T23:19:32.4467579Z                                  ancestors.push(ancestor_hash);
2025-11-09T23:19:32.4467695Z                              }
2025-11-09T23:19:32.4468355Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:487:
2025-11-09T23:19:32.4468474Z                  }
2025-11-09T23:19:32.4468589Z              }
2025-11-09T23:19:32.4468692Z          }
2025-11-09T23:19:32.4470679Z -        
2025-11-09T23:19:32.4470786Z +
2025-11-09T23:19:32.4470906Z          ancestors
2025-11-09T23:19:32.4471020Z      }
2025-11-09T23:19:32.4471134Z  
2025-11-09T23:19:32.4471559Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:494:
2025-11-09T23:19:32.4471740Z      /// Helper: Get descendants for a transaction
2025-11-09T23:19:32.4472115Z      fn get_descendants(&self, mempool: &MempoolManager, tx_hash: &Hash) -> Vec<Hash> {
2025-11-09T23:19:32.4472283Z          let mut descendants = Vec::new();
2025-11-09T23:19:32.4472398Z -        
2025-11-09T23:19:32.4472512Z +
2025-11-09T23:19:32.4472731Z          if let Some(tx) = mempool.get_transaction(tx_hash) {
2025-11-09T23:19:32.4472930Z              // Get all output outpoints from this transaction
2025-11-09T23:19:32.4473115Z              let mut output_outpoints = Vec::new();
2025-11-09T23:19:32.4473572Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:520:
2025-11-09T23:19:32.4473691Z                  }
2025-11-09T23:19:32.4473808Z              }
2025-11-09T23:19:32.4473922Z          }
2025-11-09T23:19:32.4474041Z -        
2025-11-09T23:19:32.4474147Z +
2025-11-09T23:19:32.4474269Z          descendants
2025-11-09T23:19:32.4474562Z      }
2025-11-09T23:19:32.4474679Z  }
2025-11-09T23:19:32.4498909Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:1:
2025-11-09T23:19:32.4499418Z  //! Mining RPC methods
2025-11-09T23:19:32.4499752Z -//! 
2025-11-09T23:19:32.4499867Z +//!
2025-11-09T23:19:32.4500283Z  //! Implements mining-related JSON-RPC methods for block template generation and mining.
2025-11-09T23:19:32.4500537Z  //! Uses formally verified consensus-proof mining functions.
2025-11-09T23:19:32.4500672Z  
2025-11-09T23:19:32.4501331Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:6:
2025-11-09T23:19:32.4501723Z -use serde_json::{Value, json};
2025-11-09T23:19:32.4501874Z -use tracing::{debug, warn};
2025-11-09T23:19:32.4501989Z -use hex;
2025-11-09T23:19:32.4502171Z +use crate::node::mempool::MempoolManager;
2025-11-09T23:19:32.4502371Z  use crate::rpc::errors::{RpcError, RpcResult};
2025-11-09T23:19:32.4503024Z -use bllvm_protocol::{ConsensusProof, types::{BlockHeader, Transaction, UtxoSet, Natural, ByteString, Hash}, ValidationResult};
2025-11-09T23:19:32.4503274Z -use bllvm_protocol::serialization::serialize_transaction;
2025-11-09T23:19:32.4503419Z +use crate::storage::Storage;
2025-11-09T23:19:32.4503604Z  use bllvm_protocol::mining::BlockTemplate;
2025-11-09T23:19:32.4503912Z -use bllvm_protocol::serialization::deserialize_block_with_witnesses;
2025-11-09T23:19:32.4504081Z  use bllvm_protocol::pow::expand_target;
2025-11-09T23:19:32.4504218Z -use std::sync::Arc;
2025-11-09T23:19:32.4504712Z -use crate::storage::Storage;
2025-11-09T23:19:32.4504889Z -use crate::node::mempool::MempoolManager;
2025-11-09T23:19:32.4505210Z +use bllvm_protocol::serialization::deserialize_block_with_witnesses;
2025-11-09T23:19:32.4505456Z +use bllvm_protocol::serialization::serialize_transaction;
2025-11-09T23:19:32.4505598Z +use bllvm_protocol::{
2025-11-09T23:19:32.4505924Z +    types::{BlockHeader, ByteString, Hash, Natural, Transaction, UtxoSet},
2025-11-09T23:19:32.4506099Z +    ConsensusProof, ValidationResult,
2025-11-09T23:19:32.4506211Z +};
2025-11-09T23:19:32.4506328Z +use hex;
2025-11-09T23:19:32.4506477Z +use serde_json::{json, Value};
2025-11-09T23:19:32.4506617Z  use sha2::{Digest, Sha256};
2025-11-09T23:19:32.4506747Z +use std::sync::Arc;
2025-11-09T23:19:32.4506894Z +use tracing::{debug, warn};
2025-11-09T23:19:32.4507005Z  
2025-11-09T23:19:32.4507165Z  /// Mining RPC methods with dependencies
2025-11-09T23:19:32.4507299Z  pub struct MiningRpc {
2025-11-09T23:19:32.4507915Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:36:
2025-11-09T23:19:32.4508053Z              mempool: None,
2025-11-09T23:19:32.4508155Z          }
2025-11-09T23:19:32.4508275Z      }
2025-11-09T23:19:32.4508383Z -    
2025-11-09T23:19:32.4508484Z +
2025-11-09T23:19:32.4508687Z      /// Create with dependencies (storage and mempool)
2025-11-09T23:19:32.4509104Z      pub fn with_dependencies(storage: Arc<Storage>, mempool: Arc<MempoolManager>) -> Self {
2025-11-09T23:19:32.4509221Z          Self {
2025-11-09T23:19:32.4509646Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:45:
2025-11-09T23:19:32.4509809Z              mempool: Some(mempool),
2025-11-09T23:19:32.4509920Z          }
2025-11-09T23:19:32.4510031Z      }
2025-11-09T23:19:32.4510143Z -    
2025-11-09T23:19:32.4510257Z +
2025-11-09T23:19:32.4510399Z      /// Get mining information
2025-11-09T23:19:32.4510636Z      pub async fn get_mining_info(&self) -> RpcResult<Value> {
2025-11-09T23:19:32.4510804Z          debug!("RPC: getmininginfo");
2025-11-09T23:19:32.4511229Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:52:
2025-11-09T23:19:32.4511354Z -        
2025-11-09T23:19:32.4511462Z +
2025-11-09T23:19:32.4511644Z          // Get current block height from storage
2025-11-09T23:19:32.4511870Z          let blocks = if let Some(ref storage) = self.storage {
2025-11-09T23:19:32.4512031Z -            storage.chain().get_height()
2025-11-09T23:19:32.4512161Z +            storage
2025-11-09T23:19:32.4512293Z +                .chain()
2025-11-09T23:19:32.4512427Z +                .get_height()
2025-11-09T23:19:32.4512789Z                  .map_err(|e| RpcError::internal_error(format!("Failed to get height: {}", e)))?
2025-11-09T23:19:32.4512932Z                  .unwrap_or(0)
2025-11-09T23:19:32.4513052Z          } else {
2025-11-09T23:19:32.4513478Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:59:
2025-11-09T23:19:32.4513616Z              0
2025-11-09T23:19:32.4513730Z          };
2025-11-09T23:19:32.4513844Z -        
2025-11-09T23:19:32.4514211Z +
2025-11-09T23:19:32.4514604Z          // Get mempool size
2025-11-09T23:19:32.4514861Z          let pooledtx = if let Some(ref mempool) = self.mempool {
2025-11-09T23:19:32.4515001Z              mempool.size()
2025-11-09T23:19:32.4515446Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:65:
2025-11-09T23:19:32.4515561Z          } else {
2025-11-09T23:19:32.4515671Z              0
2025-11-09T23:19:32.4515790Z          };
2025-11-09T23:19:32.4515903Z -        
2025-11-09T23:19:32.4516014Z +
2025-11-09T23:19:32.4516325Z          // Get difficulty from latest block's bits field (graceful degradation)
2025-11-09T23:19:32.4516577Z          let difficulty = if let Some(ref storage) = self.storage {
2025-11-09T23:19:32.4516844Z              if let Ok(Some(tip_header)) = storage.chain().get_tip_header() {
2025-11-09T23:19:32.4517290Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:78:
2025-11-09T23:19:32.4517609Z              tracing::debug!("Storage not available, using default difficulty");
2025-11-09T23:19:32.4517776Z              1.0 // Graceful fallback if no storage
2025-11-09T23:19:32.4517892Z          };
2025-11-09T23:19:32.4518000Z -        
2025-11-09T23:19:32.4518121Z +
2025-11-09T23:19:32.4518494Z          // Calculate network hashrate from recent block timestamps (graceful degradation)
2025-11-09T23:19:32.4518770Z          let networkhashps = if let Some(ref storage) = self.storage {
2025-11-09T23:19:32.4519060Z -            self.calculate_network_hashrate(storage).unwrap_or_else(|e| {
2025-11-09T23:19:32.4519399Z -                tracing::debug!("Failed to calculate network hashrate: {}, using 0.0", e);
2025-11-09T23:19:32.4519526Z -                0.0
2025-11-09T23:19:32.4519641Z -            })
2025-11-09T23:19:32.4520685Z +            self.calculate_network_hashrate(storage)
2025-11-09T23:19:32.4521094Z +                .unwrap_or_else(|e| {
2025-11-09T23:19:32.4521444Z +                    tracing::debug!("Failed to calculate network hashrate: {}, using 0.0", e);
2025-11-09T23:19:32.4521569Z +                    0.0
2025-11-09T23:19:32.4521676Z +                })
2025-11-09T23:19:32.4521795Z          } else {
2025-11-09T23:19:32.4522104Z              tracing::debug!("Storage not available, network hashrate unavailable");
2025-11-09T23:19:32.4522218Z              0.0
2025-11-09T23:19:32.4522646Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:91:
2025-11-09T23:19:32.4522764Z          };
2025-11-09T23:19:32.4522875Z -        
2025-11-09T23:19:32.4522985Z +
2025-11-09T23:19:32.4523190Z          // Get current block template info (if available)
2025-11-09T23:19:32.4523331Z          let currentblocksize = 0;
2025-11-09T23:19:32.4523476Z          let currentblockweight = 0;
2025-11-09T23:19:32.4523887Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:96:
2025-11-09T23:19:32.4524048Z          let currentblocktx = 0;
2025-11-09T23:19:32.4524168Z -        
2025-11-09T23:19:32.4524451Z +
2025-11-09T23:19:32.4533270Z          // Determine chain name from storage chain params
2025-11-09T23:19:32.4533541Z          let chain = if let Some(ref storage) = self.storage {
2025-11-09T23:19:32.4533760Z              if let Ok(Some(info)) = storage.chain().load_chain_info() {
2025-11-09T23:19:32.4534188Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:110:
2025-11-09T23:19:32.4534495Z          } else {
2025-11-09T23:19:32.4534628Z              "main" // Default
2025-11-09T23:19:32.4534737Z          };
2025-11-09T23:19:32.4534851Z -        
2025-11-09T23:19:32.4534952Z +
2025-11-09T23:19:32.4535061Z          Ok(json!({
2025-11-09T23:19:32.4535178Z              "blocks": blocks,
2025-11-09T23:19:32.4535349Z              "currentblocksize": currentblocksize,
2025-11-09T23:19:32.4535791Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:123:
2025-11-09T23:19:32.4535931Z              "warnings": ""
2025-11-09T23:19:32.4538235Z          }))
2025-11-09T23:19:32.4538353Z      }
2025-11-09T23:19:32.4538470Z -    
2025-11-09T23:19:32.4538583Z +
2025-11-09T23:19:32.4538735Z      /// Get block template
2025-11-09T23:19:32.4538844Z -    /// 
2025-11-09T23:19:32.4538955Z +    ///
2025-11-09T23:19:32.4539137Z      /// Params: [template_request (optional)]
2025-11-09T23:19:32.4539252Z -    /// 
2025-11-09T23:19:32.4539368Z +    ///
2025-11-09T23:19:32.4539780Z      /// Uses formally verified consensus-proof::mining::create_block_template() function
2025-11-09T23:19:32.4540127Z      /// which has Kani proofs ensuring correctness per Orange Paper Section 12.4
2025-11-09T23:19:32.4540457Z      pub async fn get_block_template(&self, params: &Value) -> RpcResult<Value> {
2025-11-09T23:19:32.4540908Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:134:
2025-11-09T23:19:32.4541096Z          debug!("RPC: getblocktemplate");
2025-11-09T23:19:32.4541210Z -        
2025-11-09T23:19:32.4541324Z +
2025-11-09T23:19:32.4541470Z          // 1. Get current chainstate
2025-11-09T23:19:32.4541662Z -        let height: Natural = self.get_current_height()?
2025-11-09T23:19:32.4541793Z +        let height: Natural = self
2025-11-09T23:19:32.4541917Z +            .get_current_height()?
2025-11-09T23:19:32.4542193Z              .ok_or_else(|| RpcError::internal_error("Chain not initialized"))?;
2025-11-09T23:19:32.4542357Z -        let prev_header = self.get_tip_header()?
2025-11-09T23:19:32.4542494Z +        let prev_header = self
2025-11-09T23:19:32.4542632Z +            .get_tip_header()?
2025-11-09T23:19:32.4542867Z              .ok_or_else(|| RpcError::internal_error("No chain tip"))?;
2025-11-09T23:19:32.4543098Z          let prev_headers = self.get_headers_for_difficulty()?;
2025-11-09T23:19:32.4543228Z -        
2025-11-09T23:19:32.4543343Z +
2025-11-09T23:19:32.4543747Z          // 2. Get mempool transactions
2025-11-09T23:19:32.4544061Z          let mempool_txs: Vec<Transaction> = self.get_mempool_transactions()?;
2025-11-09T23:19:32.4544197Z -        
2025-11-09T23:19:32.4544484Z +
2025-11-09T23:19:32.4544623Z          // 3. Get UTXO set
2025-11-09T23:19:32.4544791Z          let utxo_set = self.get_utxo_set()?;
2025-11-09T23:19:32.4544916Z -        
2025-11-09T23:19:32.4545022Z +
2025-11-09T23:19:32.4545278Z          // 4. Extract coinbase parameters from request or use defaults
2025-11-09T23:19:32.4545638Z          let coinbase_script = self.extract_coinbase_script(params).unwrap_or_default();
2025-11-09T23:19:32.4545996Z          let coinbase_address = self.extract_coinbase_address(params).unwrap_or_default();
2025-11-09T23:19:32.4546479Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:152:
2025-11-09T23:19:32.4546599Z -        
2025-11-09T23:19:32.4546703Z +
2025-11-09T23:19:32.4546927Z          // 5. Use formally verified function from consensus-proof
2025-11-09T23:19:32.4547264Z          // This function has Kani proofs: kani_create_block_template_completeness
2025-11-09T23:19:32.4547532Z          let template = match self.consensus.create_block_template(
2025-11-09T23:19:32.4547958Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:164:
2025-11-09T23:19:32.4550582Z              Ok(t) => t,
2025-11-09T23:19:32.4550748Z              Err(e) => {
2025-11-09T23:19:32.4550954Z                  warn!("Failed to create block template: {}", e);
2025-11-09T23:19:32.4551342Z -                return Err(RpcError::internal_error(format!("Template creation failed: {}", e)));
2025-11-09T23:19:32.4551552Z +                return Err(RpcError::internal_error(format!(
2025-11-09T23:19:32.4551709Z +                    "Template creation failed: {}",
2025-11-09T23:19:32.4551826Z +                    e
2025-11-09T23:19:32.4551930Z +                )));
2025-11-09T23:19:32.4552045Z              }
2025-11-09T23:19:32.4552162Z          };
2025-11-09T23:19:32.4552265Z -        
2025-11-09T23:19:32.4552385Z +
2025-11-09T23:19:32.4552852Z          // 6. Convert to JSON-RPC format (BIP 22/23)
2025-11-09T23:19:32.4553122Z          self.template_to_json_rpc(&template, &prev_header, height)
2025-11-09T23:19:32.4553239Z      }
2025-11-09T23:19:32.4553694Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:174:
2025-11-09T23:19:32.4553815Z -    
2025-11-09T23:19:32.4553928Z +
2025-11-09T23:19:32.4554121Z      /// Convert BlockTemplate to JSON-RPC format
2025-11-09T23:19:32.4554262Z      fn template_to_json_rpc(
2025-11-09T23:19:32.4554576Z          &self,
2025-11-09T23:19:32.4555101Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:181:
2025-11-09T23:19:32.4555385Z      ) -> RpcResult<Value> {
2025-11-09T23:19:32.4555596Z          // Convert previous block hash to hex (big-endian)
2025-11-09T23:19:32.4555868Z          let prev_hash_hex = hex::encode(prev_header.prev_block_hash);
2025-11-09T23:19:32.4556012Z -        
2025-11-09T23:19:32.4556126Z +
2025-11-09T23:19:32.4556497Z          // Convert target to hex (64 characters, big-endian)
2025-11-09T23:19:32.4556786Z          let target_hex = format!("{:064x}", template.target);
2025-11-09T23:19:32.4556899Z -        
2025-11-09T23:19:32.4557004Z +
2025-11-09T23:19:32.4557169Z          // Convert bits to hex (8 characters)
2025-11-09T23:19:32.4557396Z          let bits_hex = format!("{:08x}", template.header.bits);
2025-11-09T23:19:32.4557504Z -        
2025-11-09T23:19:32.4557604Z +
2025-11-09T23:19:32.4557758Z          // Convert transactions to JSON array
2025-11-09T23:19:32.4557993Z -        let transactions_json: Vec<Value> = template.transactions
2025-11-09T23:19:32.4558159Z +        let transactions_json: Vec<Value> = template
2025-11-09T23:19:32.4558351Z +            .transactions
2025-11-09T23:19:32.4558538Z              .iter()
2025-11-09T23:19:32.4558701Z              .map(|tx| self.transaction_to_json(tx))
2025-11-09T23:19:32.4559099Z              .collect();
2025-11-09T23:19:32.4560172Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:196:
2025-11-09T23:19:32.4560298Z -        
2025-11-09T23:19:32.4560397Z +
2025-11-09T23:19:32.4560567Z          // Calculate coinbase value (subsidy + fees)
2025-11-09T23:19:32.4560884Z          let coinbase_value = self.calculate_coinbase_value(template, height);
2025-11-09T23:19:32.4560994Z -        
2025-11-09T23:19:32.4561095Z +
2025-11-09T23:19:32.4561255Z          // Get active rules (BIP 9 feature flags)
2025-11-09T23:19:32.4561407Z          let rules = self.get_active_rules(height);
2025-11-09T23:19:32.4561509Z -        
2025-11-09T23:19:32.4561620Z +
2025-11-09T23:19:32.4561827Z          // Get minimum time (median time + 1)
2025-11-09T23:19:32.4561999Z          let min_time = self.get_min_time(height);
2025-11-09T23:19:32.4562114Z -        
2025-11-09T23:19:32.4562228Z +
2025-11-09T23:19:32.4562352Z          Ok(json!({
2025-11-09T23:19:32.4562522Z              "capabilities": ["proposal"],
2025-11-09T23:19:32.4562707Z              "version": template.header.version as i32,
2025-11-09T23:19:32.4563199Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:228:
2025-11-09T23:19:32.4563340Z              "height": template.height
2025-11-09T23:19:32.4563442Z          }))
2025-11-09T23:19:32.4563550Z      }
2025-11-09T23:19:32.4563650Z -    
2025-11-09T23:19:32.4563758Z +
2025-11-09T23:19:32.4563948Z      // Helper methods - access chainstate and mempool
2025-11-09T23:19:32.4564058Z -    
2025-11-09T23:19:32.4564156Z +
2025-11-09T23:19:32.4564564Z      fn get_current_height(&self) -> RpcResult<Option<Natural>> {
2025-11-09T23:19:32.4564728Z          if let Some(ref storage) = self.storage {
2025-11-09T23:19:32.4564867Z -            storage.chain().get_height()
2025-11-09T23:19:32.4564975Z +            storage
2025-11-09T23:19:32.4565090Z +                .chain()
2025-11-09T23:19:32.4565226Z +                .get_height()
2025-11-09T23:19:32.4565547Z                  .map_err(|e| RpcError::internal_error(format!("Failed to get height: {}", e)))
2025-11-09T23:19:32.4565945Z          } else {
2025-11-09T23:19:32.4566058Z              Ok(None)
2025-11-09T23:19:32.4566482Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:240:
2025-11-09T23:19:32.4566590Z          }
2025-11-09T23:19:32.4566701Z      }
2025-11-09T23:19:32.4566799Z -    
2025-11-09T23:19:32.4566894Z +
2025-11-09T23:19:32.4567113Z      fn get_tip_header(&self) -> RpcResult<Option<BlockHeader>> {
2025-11-09T23:19:32.4567283Z          if let Some(ref storage) = self.storage {
2025-11-09T23:19:32.4567439Z -            storage.chain().get_tip_header()
2025-11-09T23:19:32.4567552Z +            storage
2025-11-09T23:19:32.4567668Z +                .chain()
2025-11-09T23:19:32.4567788Z +                .get_tip_header()
2025-11-09T23:19:32.4568117Z                  .map_err(|e| RpcError::internal_error(format!("Failed to get tip header: {}", e)))
2025-11-09T23:19:32.4568244Z          } else {
2025-11-09T23:19:32.4568371Z              Ok(None)
2025-11-09T23:19:32.4568770Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:249:
2025-11-09T23:19:32.4568871Z          }
2025-11-09T23:19:32.4568981Z      }
2025-11-09T23:19:32.4569081Z -    
2025-11-09T23:19:32.4569178Z +
2025-11-09T23:19:32.4569442Z      fn get_headers_for_difficulty(&self) -> RpcResult<Vec<BlockHeader>> {
2025-11-09T23:19:32.4569603Z          if let Some(ref storage) = self.storage {
2025-11-09T23:19:32.4569801Z              // Get last 2016 headers for difficulty adjustment
2025-11-09T23:19:32.4570231Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:255:
2025-11-09T23:19:32.4570544Z              // For now, return just the tip (full implementation would get last 2016)
2025-11-09T23:19:32.4570760Z -            if let Some(tip) = storage.chain().get_tip_header()
2025-11-09T23:19:32.4571121Z +            if let Some(tip) = storage
2025-11-09T23:19:32.4571248Z +                .chain()
2025-11-09T23:19:32.4571385Z +                .get_tip_header()
2025-11-09T23:19:32.4571703Z                  .map_err(|e| RpcError::internal_error(format!("Failed to get tip: {}", e)))?
2025-11-09T23:19:32.4571818Z              {
2025-11-09T23:19:32.4571960Z                  Ok(vec![tip])
2025-11-09T23:19:32.4572391Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:264:
2025-11-09T23:19:32.4572519Z              Ok(vec![])
2025-11-09T23:19:32.4572644Z          }
2025-11-09T23:19:32.4572754Z      }
2025-11-09T23:19:32.4572863Z -    
2025-11-09T23:19:32.4572975Z +
2025-11-09T23:19:32.4573280Z      fn get_mempool_transactions(&self) -> RpcResult<Vec<Transaction>> {
2025-11-09T23:19:32.4573456Z          if let Some(ref mempool) = self.mempool {
2025-11-09T23:19:32.4573612Z              // Get UTXO set for fee calculation
2025-11-09T23:19:32.4574050Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:271:
2025-11-09T23:19:32.4574224Z              let utxo_set = self.get_utxo_set()?;
2025-11-09T23:19:32.4574561Z -            
2025-11-09T23:19:32.4574683Z +
2025-11-09T23:19:32.4575064Z              // Get prioritized transactions (limit to reasonable number for block template)
2025-11-09T23:19:32.4575249Z              let limit = 1000;
2025-11-09T23:19:32.4575553Z              Ok(mempool.get_prioritized_transactions(limit, &utxo_set))
2025-11-09T23:19:32.4575994Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:277:
2025-11-09T23:19:32.4576117Z              Ok(vec![])
2025-11-09T23:19:32.4576229Z          }
2025-11-09T23:19:32.4576349Z      }
2025-11-09T23:19:32.4576458Z -    
2025-11-09T23:19:32.4576563Z +
2025-11-09T23:19:32.4576807Z      /// Calculate difficulty from bits (compact target format)
2025-11-09T23:19:32.4577079Z      /// Uses the same logic as BlockchainRpc::calculate_difficulty
2025-11-09T23:19:32.4577275Z      fn calculate_difficulty(bits: u64) -> f64 {
2025-11-09T23:19:32.4577706Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:284:
2025-11-09T23:19:32.4578130Z          // Difficulty = MAX_TARGET / target
2025-11-09T23:19:32.4578580Z          // MAX_TARGET for Bitcoin mainnet is 0x00000000FFFF0000000000000000000000000000000000000000000000000000
2025-11-09T23:19:32.4578858Z          // For display purposes, we normalize to genesis difficulty = 1.0
2025-11-09T23:19:32.4579369Z -        const MAX_TARGET: u128 = 0x00000000FFFF0000000000000000000000000000000000000000000000000000u128;
2025-11-09T23:19:32.4579485Z -        
2025-11-09T23:19:32.4579617Z +        const MAX_TARGET: u128 =
2025-11-09T23:19:32.4579909Z +            0x00000000FFFF0000000000000000000000000000000000000000000000000000u128;
2025-11-09T23:19:32.4580018Z +
2025-11-09T23:19:32.4580235Z          // Simplified difficulty calculation using bits directly
2025-11-09T23:19:32.4580526Z          // For display purposes, use a simple approximation based on bits
2025-11-09T23:19:32.4580707Z          let mantissa = (bits & 0x00ffffff) as f64;
2025-11-09T23:19:32.4581126Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:295:
2025-11-09T23:19:32.4581275Z          let max_mantissa = 0x00ffff00 as f64;
2025-11-09T23:19:32.4581422Z          (max_mantissa / mantissa).max(1.0)
2025-11-09T23:19:32.4581525Z      }
2025-11-09T23:19:32.4581627Z -    
2025-11-09T23:19:32.4581726Z +
2025-11-09T23:19:32.4581952Z      /// Calculate network hashrate from recent block timestamps
2025-11-09T23:19:32.4582204Z      /// Estimates hashrate based on the time between recent blocks
2025-11-09T23:19:32.4582606Z      fn calculate_network_hashrate(&self, storage: &Storage) -> Result<f64, anyhow::Error> {
2025-11-09T23:19:32.4583044Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:302:
2025-11-09T23:19:32.4583180Z          // Get tip height
2025-11-09T23:19:32.4583597Z -        let tip_height = storage.chain().get_height()?
2025-11-09T23:19:32.4583742Z +        let tip_height = storage
2025-11-09T23:19:32.4583867Z +            .chain()
2025-11-09T23:19:32.4583994Z +            .get_height()?
2025-11-09T23:19:32.4584229Z              .ok_or_else(|| anyhow::anyhow!("Chain not initialized"))?;
2025-11-09T23:19:32.4584522Z -        
2025-11-09T23:19:32.4584640Z +
2025-11-09T23:19:32.4584834Z          // Need at least 2 blocks to calculate hashrate
2025-11-09T23:19:32.4584979Z          if tip_height < 1 {
2025-11-09T23:19:32.4585104Z              return Ok(0.0);
2025-11-09T23:19:32.4585528Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:309:
2025-11-09T23:19:32.4585642Z          }
2025-11-09T23:19:32.4585762Z -        
2025-11-09T23:19:32.4585871Z +
2025-11-09T23:19:32.4586109Z          // Get last 144 blocks (approximately 1 day at 10 min/block)
2025-11-09T23:19:32.4586288Z          // Or use fewer blocks if chain is shorter
2025-11-09T23:19:32.4586471Z          let num_blocks = (tip_height + 1).min(144);
2025-11-09T23:19:32.4586910Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:314:
2025-11-09T23:19:32.4587201Z          let start_height = tip_height.saturating_sub(num_blocks - 1);
2025-11-09T23:19:32.4587314Z -        
2025-11-09T23:19:32.4587425Z +
2025-11-09T23:19:32.4587581Z          // Get timestamps from blocks
2025-11-09T23:19:32.4587759Z          let mut timestamps = Vec::new();
2025-11-09T23:19:32.4587937Z          for height in start_height..=tip_height {
2025-11-09T23:19:32.4588371Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:322:
2025-11-09T23:19:32.4588498Z                  }
2025-11-09T23:19:32.4588613Z              }
2025-11-09T23:19:32.4588725Z          }
2025-11-09T23:19:32.4588834Z -        
2025-11-09T23:19:32.4588949Z +
2025-11-09T23:19:32.4589097Z          if timestamps.len() < 2 {
2025-11-09T23:19:32.4589233Z              return Ok(0.0);
2025-11-09T23:19:32.4589362Z          }
2025-11-09T23:19:32.4589797Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:329:
2025-11-09T23:19:32.4590134Z -        
2025-11-09T23:19:32.4590244Z +
2025-11-09T23:19:32.4590431Z          // Calculate average time between blocks
2025-11-09T23:19:32.4590605Z          let first_timestamp = timestamps[0].1;
2025-11-09T23:19:32.4590850Z          let last_timestamp = timestamps[timestamps.len() - 1].1;
2025-11-09T23:19:32.4591259Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:333:
2025-11-09T23:19:32.4591505Z          let time_span = last_timestamp.saturating_sub(first_timestamp);
2025-11-09T23:19:32.4591666Z          let num_intervals = timestamps.len() - 1;
2025-11-09T23:19:32.4591779Z -        
2025-11-09T23:19:32.4591904Z +
2025-11-09T23:19:32.4592076Z          if time_span == 0 || num_intervals == 0 {
2025-11-09T23:19:32.4592212Z              return Ok(0.0);
2025-11-09T23:19:32.4592345Z          }
2025-11-09T23:19:32.4592776Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:339:
2025-11-09T23:19:32.4592904Z -        
2025-11-09T23:19:32.4593013Z +
2025-11-09T23:19:32.4593286Z          let avg_time_per_block = time_span as f64 / num_intervals as f64;
2025-11-09T23:19:32.4593399Z -        
2025-11-09T23:19:32.4593511Z +
2025-11-09T23:19:32.4593673Z          // Get difficulty from tip block
2025-11-09T23:19:32.4593937Z -        let tip_hash = storage.blocks().get_hash_by_height(tip_height)?
2025-11-09T23:19:32.4594074Z +        let tip_hash = storage
2025-11-09T23:19:32.4594207Z +            .blocks()
2025-11-09T23:19:32.4594541Z +            .get_hash_by_height(tip_height)?
2025-11-09T23:19:32.4594778Z              .ok_or_else(|| anyhow::anyhow!("Tip block not found"))?;
2025-11-09T23:19:32.4595004Z -        let tip_block = storage.blocks().get_block(&tip_hash)?
2025-11-09T23:19:32.4595148Z +        let tip_block = storage
2025-11-09T23:19:32.4595495Z +            .blocks()
2025-11-09T23:19:32.4595632Z +            .get_block(&tip_hash)?
2025-11-09T23:19:32.4595867Z              .ok_or_else(|| anyhow::anyhow!("Tip block not found"))?;
2025-11-09T23:19:32.4596168Z          let difficulty = Self::calculate_difficulty(tip_block.header.bits);
2025-11-09T23:19:32.4596287Z -        
2025-11-09T23:19:32.4598305Z +
2025-11-09T23:19:32.4598571Z          // Calculate hashrate: difficulty * 2^32 / avg_time_per_block
2025-11-09T23:19:32.4598819Z          // This estimates the network hashrate in hashes per second
2025-11-09T23:19:32.4599165Z          // 2^32 is the number of hashes needed on average to find a block at difficulty 1.0
2025-11-09T23:19:32.4599628Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:352:
2025-11-09T23:19:32.4599852Z          const HASHES_PER_DIFFICULTY: f64 = 4294967296.0; // 2^32
2025-11-09T23:19:32.4600179Z          let hashrate = (difficulty * HASHES_PER_DIFFICULTY) / avg_time_per_block;
2025-11-09T23:19:32.4600320Z -        
2025-11-09T23:19:32.4600428Z +
2025-11-09T23:19:32.4600552Z          Ok(hashrate)
2025-11-09T23:19:32.4600675Z      }
2025-11-09T23:19:32.4600798Z -    
2025-11-09T23:19:32.4600909Z +
2025-11-09T23:19:32.4601370Z      fn get_utxo_set(&self) -> RpcResult<UtxoSet> {
2025-11-09T23:19:32.4601560Z          if let Some(ref storage) = self.storage {
2025-11-09T23:19:32.4601714Z              // Get UTXO set from storage
2025-11-09T23:19:32.4602151Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:361:
2025-11-09T23:19:32.4602307Z -            storage.utxos().get_all_utxos()
2025-11-09T23:19:32.4602434Z +            storage
2025-11-09T23:19:32.4602561Z +                .utxos()
2025-11-09T23:19:32.4602702Z +                .get_all_utxos()
2025-11-09T23:19:32.4603056Z                  .map_err(|e| RpcError::internal_error(format!("Failed to get UTXO set: {}", e)))
2025-11-09T23:19:32.4603164Z          } else {
2025-11-09T23:19:32.4603307Z              Ok(UtxoSet::new())
2025-11-09T23:19:32.4603708Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:365:
2025-11-09T23:19:32.4604057Z          }
2025-11-09T23:19:32.4604170Z      }
2025-11-09T23:19:32.4604296Z -    
2025-11-09T23:19:32.4604673Z +
2025-11-09T23:19:32.4605028Z      fn extract_coinbase_script(&self, params: &Value) -> Option<ByteString> {
2025-11-09T23:19:32.4605251Z          // Extract coinbase script from params if provided
2025-11-09T23:19:32.4605455Z          if let Some(template_request) = params.get(0) {
2025-11-09T23:19:32.4605944Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:379:
2025-11-09T23:19:32.4606081Z          // Default: empty script
2025-11-09T23:19:32.4606205Z          Some(vec![])
2025-11-09T23:19:32.4606314Z      }
2025-11-09T23:19:32.4606420Z -    
2025-11-09T23:19:32.4606526Z +
2025-11-09T23:19:32.4606856Z      fn extract_coinbase_address(&self, params: &Value) -> Option<ByteString> {
2025-11-09T23:19:32.4607085Z          // Extract coinbase address from params if provided
2025-11-09T23:19:32.4607275Z          if let Some(template_request) = params.get(0) {
2025-11-09T23:19:32.4607697Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:393:
2025-11-09T23:19:32.4607820Z          // Default: empty
2025-11-09T23:19:32.4607936Z          Some(vec![])
2025-11-09T23:19:32.4608054Z      }
2025-11-09T23:19:32.4608157Z -    
2025-11-09T23:19:32.4608258Z +
2025-11-09T23:19:32.4610775Z      fn transaction_to_json(&self, tx: &Transaction) -> Value {
2025-11-09T23:19:32.4610963Z          // Convert transaction to JSON-RPC format
2025-11-09T23:19:32.4611126Z          let tx_bytes = serialize_transaction(tx);
2025-11-09T23:19:32.4611551Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:401:
2025-11-09T23:19:32.4611755Z          let fee = self.calculate_transaction_fee(tx);
2025-11-09T23:19:32.4611922Z          let sigops = self.count_sigops(tx);
2025-11-09T23:19:32.4612348Z          let weight = self.calculate_weight(tx);
2025-11-09T23:19:32.4612476Z -        
2025-11-09T23:19:32.4612597Z +
2025-11-09T23:19:32.4612711Z          json!({
2025-11-09T23:19:32.4612874Z              "data": hex::encode(&tx_bytes),
2025-11-09T23:19:32.4613040Z              "txid": hex::encode(tx_hash),
2025-11-09T23:19:32.4613496Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:410:
2025-11-09T23:19:32.4613636Z              "weight": weight,
2025-11-09T23:19:32.4613759Z          })
2025-11-09T23:19:32.4613869Z      }
2025-11-09T23:19:32.4613977Z -    
2025-11-09T23:19:32.4614081Z +
2025-11-09T23:19:32.4614500Z      fn calculate_tx_hash(&self, tx_bytes: &[u8]) -> [u8; 32] {
2025-11-09T23:19:32.4614802Z          // Transaction hash is double SHA256 of transaction bytes
2025-11-09T23:19:32.4614974Z          let hash1 = Sha256::digest(tx_bytes);
2025-11-09T23:19:32.4615420Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:417:
2025-11-09T23:19:32.4615596Z          let hash2 = Sha256::digest(hash1);
2025-11-09T23:19:32.4615720Z -        
2025-11-09T23:19:32.4615838Z +
2025-11-09T23:19:32.4615973Z          let mut result = [0u8; 32];
2025-11-09T23:19:32.4616124Z          result.copy_from_slice(&hash2);
2025-11-09T23:19:32.4616238Z          result
2025-11-09T23:19:32.4616672Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:422:
2025-11-09T23:19:32.4616791Z      }
2025-11-09T23:19:32.4616895Z -    
2025-11-09T23:19:32.4617015Z +
2025-11-09T23:19:32.4617292Z      fn calculate_transaction_fee(&self, tx: &Transaction) -> u64 {
2025-11-09T23:19:32.4617507Z          // Use MempoolManager's fee calculation if available
2025-11-09T23:19:32.4617678Z          if let Some(ref mempool) = self.mempool {
2025-11-09T23:19:32.4618123Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:447:
2025-11-09T23:19:32.4618238Z              0
2025-11-09T23:19:32.4618359Z          }
2025-11-09T23:19:32.4618464Z      }
2025-11-09T23:19:32.4618562Z -    
2025-11-09T23:19:32.4618877Z +
2025-11-09T23:19:32.4619089Z      fn count_sigops(&self, tx: &Transaction) -> u32 {
2025-11-09T23:19:32.4619275Z          // Use consensus layer sigop counting
2025-11-09T23:19:32.4619409Z          #[cfg(feature = "sigop")]
2025-11-09T23:19:32.4619808Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:456:
2025-11-09T23:19:32.4620072Z              // Convert protocol transaction to consensus transaction format
2025-11-09T23:19:32.4620225Z              let consensus_tx = ConsensusTx {
2025-11-09T23:19:32.4620371Z                  version: tx.version,
2025-11-09T23:19:32.4620701Z -                inputs: tx.inputs.iter().map(|inp| bllvm_protocol::TransactionInput {
2025-11-09T23:19:32.4622868Z -                    prevout: bllvm_protocol::OutPoint {
2025-11-09T23:19:32.4623032Z -                        hash: inp.prevout.hash,
2025-11-09T23:19:32.4623202Z -                        index: inp.prevout.index,
2025-11-09T23:19:32.4623335Z -                    },
2025-11-09T23:19:32.4623516Z -                    script_sig: inp.script_sig.clone(),
2025-11-09T23:19:32.4623672Z -                    sequence: inp.sequence,
2025-11-09T23:19:32.4623814Z -                }).collect(),
2025-11-09T23:19:32.4624154Z -                outputs: tx.outputs.iter().map(|out| bllvm_protocol::TransactionOutput {
2025-11-09T23:19:32.4624479Z -                    value: out.value,
2025-11-09T23:19:32.4624675Z -                    script_pubkey: out.script_pubkey.clone(),
2025-11-09T23:19:32.4624816Z -                }).collect(),
2025-11-09T23:19:32.4624945Z +                inputs: tx
2025-11-09T23:19:32.4625067Z +                    .inputs
2025-11-09T23:19:32.4625196Z +                    .iter()
2025-11-09T23:19:32.4625405Z +                    .map(|inp| bllvm_protocol::TransactionInput {
2025-11-09T23:19:32.4625587Z +                        prevout: bllvm_protocol::OutPoint {
2025-11-09T23:19:32.4626003Z +                            hash: inp.prevout.hash,
2025-11-09T23:19:32.4626169Z +                            index: inp.prevout.index,
2025-11-09T23:19:32.4626296Z +                        },
2025-11-09T23:19:32.4626473Z +                        script_sig: inp.script_sig.clone(),
2025-11-09T23:19:32.4626635Z +                        sequence: inp.sequence,
2025-11-09T23:19:32.4626754Z +                    })
2025-11-09T23:19:32.4626884Z +                    .collect(),
2025-11-09T23:19:32.4627022Z +                outputs: tx
2025-11-09T23:19:32.4627153Z +                    .outputs
2025-11-09T23:19:32.4627274Z +                    .iter()
2025-11-09T23:19:32.4627482Z +                    .map(|out| bllvm_protocol::TransactionOutput {
2025-11-09T23:19:32.4627622Z +                        value: out.value,
2025-11-09T23:19:32.4627792Z +                        script_pubkey: out.script_pubkey.clone(),
2025-11-09T23:19:32.4627896Z +                    })
2025-11-09T23:19:32.4628034Z +                    .collect(),
2025-11-09T23:19:32.4628168Z                  lock_time: tx.lock_time,
2025-11-09T23:19:32.4628278Z              };
2025-11-09T23:19:32.4628472Z              use bllvm_protocol::sigop::get_legacy_sigop_count;
2025-11-09T23:19:32.4628906Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:480:
2025-11-09T23:19:32.4629056Z              for output in &tx.outputs {
2025-11-09T23:19:32.4629229Z                  for &byte in &output.script_pubkey {
2025-11-09T23:19:32.4629373Z                      match byte {
2025-11-09T23:19:32.4629541Z -                        0xac => count += 1, // OP_CHECKSIG
2025-11-09T23:19:32.4629720Z -                        0xad => count += 1, // OP_CHECKSIGVERIFY
2025-11-09T23:19:32.4629901Z -                        0xae => count += 1, // OP_CHECKMULTISIG
2025-11-09T23:19:32.4630062Z +                        0xac => count += 1,  // OP_CHECKSIG
2025-11-09T23:19:32.4632224Z +                        0xad => count += 1,  // OP_CHECKSIGVERIFY
2025-11-09T23:19:32.4632400Z +                        0xae => count += 1,  // OP_CHECKMULTISIG
2025-11-09T23:19:32.4632829Z                          0xaf => count += 20, // OP_CHECKMULTISIGVERIFY
2025-11-09T23:19:32.4632951Z                          _ => {}
2025-11-09T23:19:32.4633068Z                      }
2025-11-09T23:19:32.4633511Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:491:
2025-11-09T23:19:32.4633627Z              count
2025-11-09T23:19:32.4633741Z          }
2025-11-09T23:19:32.4633859Z      }
2025-11-09T23:19:32.4633966Z -    
2025-11-09T23:19:32.4634077Z +
2025-11-09T23:19:32.4634481Z      fn calculate_weight(&self, tx: &Transaction) -> u64 {
2025-11-09T23:19:32.4634877Z          // Transaction weight = (base_size * 3) + total_size (for SegWit)
2025-11-09T23:19:32.4635103Z          // For now, return base size * 4 (non-SegWit transaction)
2025-11-09T23:19:32.4635539Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:498:
2025-11-09T23:19:32.4635783Z          let base_size = serialize_transaction(tx).len() as u64;
2025-11-09T23:19:32.4635912Z          base_size * 4
2025-11-09T23:19:32.4636026Z      }
2025-11-09T23:19:32.4636131Z -    
2025-11-09T23:19:32.4636243Z +
2025-11-09T23:19:32.4636641Z      fn calculate_coinbase_value(&self, template: &BlockTemplate, _height: Natural) -> u64 {
2025-11-09T23:19:32.4636897Z          // Use consensus-proof's get_block_subsidy (formally verified)
2025-11-09T23:19:32.4637213Z          let subsidy = self.consensus.get_block_subsidy(template.height) as u64;
2025-11-09T23:19:32.4637645Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:505:
2025-11-09T23:19:32.4637755Z -        
2025-11-09T23:19:32.4637865Z +
2025-11-09T23:19:32.4638027Z          // Calculate total fees from transactions
2025-11-09T23:19:32.4638186Z -        let fees: u64 = template.transactions
2025-11-09T23:19:32.4638317Z +        let fees: u64 = template
2025-11-09T23:19:32.4638650Z +            .transactions
2025-11-09T23:19:32.4638759Z              .iter()
2025-11-09T23:19:32.4638954Z              .map(|tx| self.calculate_transaction_fee(tx))
2025-11-09T23:19:32.4639070Z              .sum();
2025-11-09T23:19:32.4639486Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:511:
2025-11-09T23:19:32.4639595Z -        
2025-11-09T23:19:32.4639698Z +
2025-11-09T23:19:32.4639824Z          subsidy + fees
2025-11-09T23:19:32.4639929Z      }
2025-11-09T23:19:32.4640033Z -    
2025-11-09T23:19:32.4640143Z +
2025-11-09T23:19:32.4640379Z      fn get_active_rules(&self, height: Natural) -> Vec<String> {
2025-11-09T23:19:32.4640971Z          // Determine active BIP 9 rules based on height
2025-11-09T23:19:32.4641266Z          let mut rules = vec!["csv".to_string()]; // CSV always active after height
2025-11-09T23:19:32.4641698Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:518:
2025-11-09T23:19:32.4641821Z -        
2025-11-09T23:19:32.4642018Z -        if height >= 481824 { // SegWit activation (mainnet)
2025-11-09T23:19:32.4642141Z +
2025-11-09T23:19:32.4642265Z +        if height >= 481824 {
2025-11-09T23:19:32.4642424Z +            // SegWit activation (mainnet)
2025-11-09T23:19:32.4642599Z              rules.push("segwit".to_string());
2025-11-09T23:19:32.4642743Z          }
2025-11-09T23:19:32.4642861Z -        
2025-11-09T23:19:32.4643062Z -        if height >= 709632 { // Taproot activation (mainnet)
2025-11-09T23:19:32.4643174Z +
2025-11-09T23:19:32.4643299Z +        if height >= 709632 {
2025-11-09T23:19:32.4643449Z +            // Taproot activation (mainnet)
2025-11-09T23:19:32.4643606Z              rules.push("taproot".to_string());
2025-11-09T23:19:32.4643720Z          }
2025-11-09T23:19:32.4643826Z -        
2025-11-09T23:19:32.4643929Z +
2025-11-09T23:19:32.4644046Z          rules
2025-11-09T23:19:32.4644150Z      }
2025-11-09T23:19:32.4644255Z -    
2025-11-09T23:19:32.4644535Z +
2025-11-09T23:19:32.4644744Z      fn get_min_time(&self, _height: Natural) -> Natural {
2025-11-09T23:19:32.4645032Z          // Get minimum time (median time of last 11 blocks + 1)
2025-11-09T23:19:32.4645381Z          // For now, return current time
2025-11-09T23:19:32.4645816Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:535:
2025-11-09T23:19:32.4645931Z              .unwrap()
2025-11-09T23:19:32.4646062Z              .as_secs() as Natural
2025-11-09T23:19:32.4646173Z      }
2025-11-09T23:19:32.4646278Z -    
2025-11-09T23:19:32.4646386Z +
2025-11-09T23:19:32.4646531Z      /// Submit a block to the network
2025-11-09T23:19:32.4646653Z -    /// 
2025-11-09T23:19:32.4646766Z +    ///
2025-11-09T23:19:32.4646908Z      /// Params: ["hexdata", "dummy"]
2025-11-09T23:19:32.4647200Z      pub async fn submit_block(&self, params: &Value) -> RpcResult<Value> {
2025-11-09T23:19:32.4647345Z          debug!("RPC: submitblock");
2025-11-09T23:19:32.4647769Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:544:
2025-11-09T23:19:32.4647893Z -        
2025-11-09T23:19:32.4648051Z -        let hex_data = params.get(0)
2025-11-09T23:19:32.4648160Z +
2025-11-09T23:19:32.4648294Z +        let hex_data = params
2025-11-09T23:19:32.4648412Z +            .get(0)
2025-11-09T23:19:32.4648557Z              .and_then(|p| p.as_str())
2025-11-09T23:19:32.4648861Z              .ok_or_else(|| RpcError::invalid_params("Missing hexdata parameter"))?;
2025-11-09T23:19:32.4649024Z -        
2025-11-09T23:19:32.4649134Z +
2025-11-09T23:19:32.4649250Z          // Decode hex
2025-11-09T23:19:32.4649413Z          let block_bytes = hex::decode(hex_data)
2025-11-09T23:19:32.4649732Z              .map_err(|e| RpcError::invalid_params(format!("Invalid hex data: {}", e)))?;
2025-11-09T23:19:32.4650146Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:552:
2025-11-09T23:19:32.4650253Z -        
2025-11-09T23:19:32.4650356Z +
2025-11-09T23:19:32.4650686Z          // Deserialize block
2025-11-09T23:19:32.4650982Z          let (block, witnesses) = deserialize_block_with_witnesses(&block_bytes)
2025-11-09T23:19:32.4651359Z              .map_err(|e| RpcError::invalid_params(format!("Failed to deserialize block: {}", e)))?;
2025-11-09T23:19:32.4651782Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:556:
2025-11-09T23:19:32.4651890Z -        
2025-11-09T23:19:32.4651995Z +
2025-11-09T23:19:32.4652136Z          // Get current chain state
2025-11-09T23:19:32.4652295Z -        let height = self.get_current_height()?
2025-11-09T23:19:32.4652423Z +        let height = self
2025-11-09T23:19:32.4652609Z +            .get_current_height()?
2025-11-09T23:19:32.4652882Z              .ok_or_else(|| RpcError::internal_error("Chain not initialized"))?;
2025-11-09T23:19:32.4653033Z          let utxo_set = self.get_utxo_set()?;
2025-11-09T23:19:32.4653139Z -        
2025-11-09T23:19:32.4653256Z +
2025-11-09T23:19:32.4653424Z          // Validate block using consensus layer
2025-11-09T23:19:32.4653773Z          // Note: This validates consensus rules, but doesn't check if block extends chain
2025-11-09T23:19:32.4653942Z          // In production, would also check:
2025-11-09T23:19:32.4654516Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:572:
2025-11-09T23:19:32.4654696Z                  debug!("Block submitted successfully");
2025-11-09T23:19:32.4654823Z                  Ok(json!(null))
2025-11-09T23:19:32.4654943Z              }
2025-11-09T23:19:32.4655136Z -            Ok((ValidationResult::Invalid(reason), _)) => {
2025-11-09T23:19:32.4655431Z -                Err(RpcError::invalid_params(format!("Invalid block: {}", reason)))
2025-11-09T23:19:32.4655570Z -            }
2025-11-09T23:19:32.4655698Z -            Err(e) => {
2025-11-09T23:19:32.4656004Z -                Err(RpcError::internal_error(format!("Validation error: {}", e)))
2025-11-09T23:19:32.4656129Z -            }
2025-11-09T23:19:32.4656520Z +            Ok((ValidationResult::Invalid(reason), _)) => Err(RpcError::invalid_params(format!(
2025-11-09T23:19:32.4656877Z +                "Invalid block: {}",
2025-11-09T23:19:32.4657006Z +                reason
2025-11-09T23:19:32.4657120Z +            ))),
2025-11-09T23:19:32.4657441Z +            Err(e) => Err(RpcError::internal_error(format!("Validation error: {}", e))),
2025-11-09T23:19:32.4657562Z          }
2025-11-09T23:19:32.4657675Z      }
2025-11-09T23:19:32.4658133Z -    
2025-11-09T23:19:32.4658256Z +
2025-11-09T23:19:32.4658407Z      /// Estimate smart fee rate
2025-11-09T23:19:32.4658522Z -    /// 
2025-11-09T23:19:32.4658638Z +    ///
2025-11-09T23:19:32.4659063Z      /// Params: [conf_target (optional, default: 6), estimate_mode (optional, default: "conservative")]
2025-11-09T23:19:32.4659393Z      pub async fn estimate_smart_fee(&self, params: &Value) -> RpcResult<Value> {
2025-11-09T23:19:32.4659545Z          debug!("RPC: estimatesmartfee");
2025-11-09T23:19:32.4659990Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:589:
2025-11-09T23:19:32.4660116Z -        
2025-11-09T23:19:32.4660272Z -        let conf_target = params.get(0)
2025-11-09T23:19:32.4660726Z -            .and_then(|p| p.as_u64())
2025-11-09T23:19:32.4660880Z -            .unwrap_or(6);
2025-11-09T23:19:32.4660993Z -        
2025-11-09T23:19:32.4661154Z -        let estimate_mode = params.get(1)
2025-11-09T23:19:32.4661266Z +
2025-11-09T23:19:32.4661590Z +        let conf_target = params.get(0).and_then(|p| p.as_u64()).unwrap_or(6);
2025-11-09T23:19:32.4661705Z +
2025-11-09T23:19:32.4661855Z +        let estimate_mode = params
2025-11-09T23:19:32.4661987Z +            .get(1)
2025-11-09T23:19:32.4662143Z              .and_then(|p| p.as_str())
2025-11-09T23:19:32.4662305Z              .unwrap_or("conservative");
2025-11-09T23:19:32.4662414Z -        
2025-11-09T23:19:32.4662533Z +
2025-11-09T23:19:32.4662676Z          // Validate estimate_mode
2025-11-09T23:19:32.4663072Z          match estimate_mode {
2025-11-09T23:19:32.4663279Z              "unset" | "economical" | "conservative" => {}
2025-11-09T23:19:32.4663741Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:601:
2025-11-09T23:19:32.4664653Z -            _ => return Err(RpcError::invalid_params(format!("Invalid estimate_mode: {}. Must be 'unset', 'economical', or 'conservative'", estimate_mode)))
2025-11-09T23:19:32.4664791Z +            _ => {
2025-11-09T23:19:32.4665002Z +                return Err(RpcError::invalid_params(format!(
2025-11-09T23:19:32.4665353Z +                    "Invalid estimate_mode: {}. Must be 'unset', 'economical', or 'conservative'",
2025-11-09T23:19:32.4665492Z +                    estimate_mode
2025-11-09T23:19:32.4665615Z +                )))
2025-11-09T23:19:32.4665723Z +            }
2025-11-09T23:19:32.4665836Z          }
2025-11-09T23:19:32.4665965Z -        
2025-11-09T23:19:32.4666079Z +
2025-11-09T23:19:32.4666337Z          // Get mempool transactions and UTXO set for fee calculation
2025-11-09T23:19:32.4666611Z          let mempool_txs = if let Some(ref mempool) = self.mempool {
2025-11-09T23:19:32.4666791Z              let utxo_set = self.get_utxo_set()?;
2025-11-09T23:19:32.4667245Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:608:
2025-11-09T23:19:32.4667360Z          } else {
2025-11-09T23:19:32.4667481Z              vec![]
2025-11-09T23:19:32.4667593Z          };
2025-11-09T23:19:32.4667707Z -        
2025-11-09T23:19:32.4667815Z +
2025-11-09T23:19:32.4668002Z          // Calculate fee rate based on mempool state
2025-11-09T23:19:32.4668261Z          // Simple algorithm: use median fee rate of top transactions
2025-11-09T23:19:32.4668442Z          let fee_rate = if !mempool_txs.is_empty() {
2025-11-09T23:19:32.4668892Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:615:
2025-11-09T23:19:32.4669052Z              let utxo_set = self.get_utxo_set()?;
2025-11-09T23:19:32.4669233Z              let mut fee_rates = Vec::new();
2025-11-09T23:19:32.4669357Z -            
2025-11-09T23:19:32.4669735Z +
2025-11-09T23:19:32.4670159Z              // MempoolManager.get_prioritized_transactions() already calculates fees correctly
2025-11-09T23:19:32.4670537Z              // We can extract fee rates from the prioritized list, but for now calculate directly
2025-11-09T23:19:32.4670694Z              for tx in &mempool_txs {
2025-11-09T23:19:32.4671140Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:621:
2025-11-09T23:19:32.4671421Z                  let fee = self.calculate_transaction_fee(tx); // Now uses UTXO set
2025-11-09T23:19:32.4671619Z                  let size = self.calculate_weight(tx) as usize;
2025-11-09T23:19:32.4671731Z -                
2025-11-09T23:19:32.4671841Z +
2025-11-09T23:19:32.4671980Z                  if size > 0 {
2025-11-09T23:19:32.4672134Z                      // Fee rate in BTC per vbyte
2025-11-09T23:19:32.4672458Z                      let rate = (fee as f64) / (size as f64) / 100_000_000.0; // Convert satoshis to BTC
2025-11-09T23:19:32.4672913Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:627:
2025-11-09T23:19:32.4673076Z                      fee_rates.push(rate);
2025-11-09T23:19:32.4673192Z                  }
2025-11-09T23:19:32.4673305Z              }
2025-11-09T23:19:32.4673427Z -            
2025-11-09T23:19:32.4673538Z +
2025-11-09T23:19:32.4673754Z              // Use median fee rate, or minimum if no transactions
2025-11-09T23:19:32.4673902Z              if !fee_rates.is_empty() {
2025-11-09T23:19:32.4674260Z                  fee_rates.sort_by(|a, b| a.partial_cmp(b).unwrap_or(std::cmp::Ordering::Equal));
2025-11-09T23:19:32.4674892Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:640:
2025-11-09T23:19:32.4675102Z              // No mempool transactions - return minimum fee
2025-11-09T23:19:32.4675241Z              0.00001 // 1 sat/vB
2025-11-09T23:19:32.4675574Z          };
2025-11-09T23:19:32.4675680Z -        
2025-11-09T23:19:32.4675790Z +
2025-11-09T23:19:32.4675948Z          // Adjust based on estimate_mode
2025-11-09T23:19:32.4676112Z          let adjusted_rate = match estimate_mode {
2025-11-09T23:19:32.4676350Z -            "economical" => fee_rate * 0.8, // 20% lower for economical
2025-11-09T23:19:32.4676608Z +            "economical" => fee_rate * 0.8,   // 20% lower for economical
2025-11-09T23:19:32.4676870Z              "conservative" => fee_rate * 1.2, // 20% higher for conservative
2025-11-09T23:19:32.4676985Z              _ => fee_rate,
2025-11-09T23:19:32.4677097Z          };
2025-11-09T23:19:32.4677516Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:650:
2025-11-09T23:19:32.4677626Z -        
2025-11-09T23:19:32.4677741Z +
2025-11-09T23:19:32.4677863Z          Ok(json!({
2025-11-09T23:19:32.4678009Z              "feerate": adjusted_rate,
2025-11-09T23:19:32.4678156Z              "blocks": conf_target
2025-11-09T23:19:32.4678587Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:660:
2025-11-09T23:19:32.4678960Z      pub async fn prioritise_transaction(&self, params: &Value) -> RpcResult<Value> {
2025-11-09T23:19:32.4679137Z          debug!("RPC: prioritisetransaction");
2025-11-09T23:19:32.4679256Z  
2025-11-09T23:19:32.4679395Z -        let txid = params.get(0)
2025-11-09T23:19:32.4679532Z +        let txid = params
2025-11-09T23:19:32.4679654Z +            .get(0)
2025-11-09T23:19:32.4679805Z              .and_then(|p| p.as_str())
2025-11-09T23:19:32.4680179Z              .ok_or_else(|| RpcError::invalid_params("Transaction ID required".to_string()))?;
2025-11-09T23:19:32.4680291Z  
2025-11-09T23:19:32.4680719Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:667:
2025-11-09T23:19:32.4680875Z -        let fee_delta = params.get(1)
2025-11-09T23:19:32.4681011Z +        let fee_delta = params
2025-11-09T23:19:32.4681140Z +            .get(1)
2025-11-09T23:19:32.4681281Z              .and_then(|p| p.as_i64())
2025-11-09T23:19:32.4681861Z              .ok_or_else(|| RpcError::invalid_params("Fee delta required".to_string()))?;
2025-11-09T23:19:32.4681972Z  
2025-11-09T23:19:32.4682401Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:671:
2025-11-09T23:19:32.4682569Z          let hash_bytes = hex::decode(txid)
2025-11-09T23:19:32.4682928Z              .map_err(|e| RpcError::invalid_params(format!("Invalid transaction ID: {}", e)))?;
2025-11-09T23:19:32.4683071Z          if hash_bytes.len() != 32 {
2025-11-09T23:19:32.4683471Z -            return Err(RpcError::invalid_params("Transaction ID must be 32 bytes".to_string()));
2025-11-09T23:19:32.4683646Z +            return Err(RpcError::invalid_params(
2025-11-09T23:19:32.4683847Z +                "Transaction ID must be 32 bytes".to_string(),
2025-11-09T23:19:32.4683970Z +            ));
2025-11-09T23:19:32.4684090Z          }
2025-11-09T23:19:32.4684227Z          let mut hash = [0u8; 32];
2025-11-09T23:19:32.4684582Z          hash.copy_from_slice(&hash_bytes);
2025-11-09T23:19:32.4685041Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:681:
2025-11-09T23:19:32.4685235Z              if mempool.get_transaction(&hash).is_some() {
2025-11-09T23:19:32.4685511Z                  // Note: In production, would update transaction priority/fee delta
2025-11-09T23:19:32.4685674Z                  // For now, just return success
2025-11-09T23:19:32.4685991Z -                debug!("Transaction {} prioritized with fee delta: {}", txid, fee_delta);
2025-11-09T23:19:32.4686113Z +                debug!(
2025-11-09T23:19:32.4686322Z +                    "Transaction {} prioritized with fee delta: {}",
2025-11-09T23:19:32.4686461Z +                    txid, fee_delta
2025-11-09T23:19:32.4686578Z +                );
2025-11-09T23:19:32.4686709Z                  Ok(json!(true))
2025-11-09T23:19:32.4687057Z              } else {
2025-11-09T23:19:32.4687237Z -                Err(RpcError::invalid_params(
2025-11-09T23:19:32.4687467Z -                    format!("Transaction {} not found in mempool", txid)
2025-11-09T23:19:32.4687587Z -                ))
2025-11-09T23:19:32.4687761Z +                Err(RpcError::invalid_params(format!(
2025-11-09T23:19:32.4687936Z +                    "Transaction {} not found in mempool",
2025-11-09T23:19:32.4688064Z +                    txid
2025-11-09T23:19:32.4688190Z +                )))
2025-11-09T23:19:32.4688306Z              }
2025-11-09T23:19:32.4688421Z          } else {
2025-11-09T23:19:32.4688732Z -            Err(RpcError::internal_error("Mempool not initialized".to_string()))
2025-11-09T23:19:32.4688895Z +            Err(RpcError::internal_error(
2025-11-09T23:19:32.4689068Z +                "Mempool not initialized".to_string(),
2025-11-09T23:19:32.4689181Z +            ))
2025-11-09T23:19:32.4689298Z          }
2025-11-09T23:19:32.4689410Z      }
2025-11-09T23:19:32.4689528Z  }
2025-11-09T23:19:32.4689975Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:696:
2025-11-09T23:19:32.4690089Z  
2025-11-09T23:19:32.4690236Z  impl Default for MiningRpc {
2025-11-09T23:19:32.4690395Z -    fn default() -> Self { Self::new() }
2025-11-09T23:19:32.4690541Z +    fn default() -> Self {
2025-11-09T23:19:32.4690659Z +        Self::new()
2025-11-09T23:19:32.4690766Z +    }
2025-11-09T23:19:32.4690881Z  }
2025-11-09T23:19:32.4690987Z  
2025-11-09T23:19:32.4691392Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mod.rs:120:
2025-11-09T23:19:32.4691520Z          self.mining_rpc =
2025-11-09T23:19:32.4691906Z              mining::MiningRpc::with_dependencies(Arc::clone(&storage), Arc::clone(&mempool));
2025-11-09T23:19:32.4692337Z          self.blockchain_rpc = blockchain::BlockchainRpc::with_dependencies(Arc::clone(&storage));
2025-11-09T23:19:32.4692822Z -        let mempool_rpc = mempool::MempoolRpc::with_dependencies(Arc::clone(&mempool), Arc::clone(&storage));
2025-11-09T23:19:32.4692978Z +        let mempool_rpc =
2025-11-09T23:19:32.4693600Z +            mempool::MempoolRpc::with_dependencies(Arc::clone(&mempool), Arc::clone(&storage));
2025-11-09T23:19:32.4693818Z          let rawtx_rpc = rawtx::RawTxRpc::with_dependencies(
2025-11-09T23:19:32.4693957Z              Arc::clone(&storage),
2025-11-09T23:19:32.4694083Z              Arc::clone(&mempool),
2025-11-09T23:19:32.4694690Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mod.rs:148:
2025-11-09T23:19:32.4694818Z      }
2025-11-09T23:19:32.4694929Z  
2025-11-09T23:19:32.4695077Z      /// Set network manager dependency
2025-11-09T23:19:32.4695558Z -    pub fn with_network_manager(mut self, network_manager: Arc<crate::network::NetworkManager>) -> Self {
2025-11-09T23:19:32.4695703Z +    pub fn with_network_manager(
2025-11-09T23:19:32.4695811Z +        mut self,
2025-11-09T23:19:32.4696032Z +        network_manager: Arc<crate::network::NetworkManager>,
2025-11-09T23:19:32.4696169Z +    ) -> Self {
2025-11-09T23:19:32.4698192Z          self.network_rpc = network::NetworkRpc::with_dependencies(Arc::clone(&network_manager));
2025-11-09T23:19:32.4698377Z          self.network_manager = Some(network_manager);
2025-11-09T23:19:32.4698483Z          self
2025-11-09T23:19:32.4699313Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mod.rs:196:
2025-11-09T23:19:32.4699443Z          ));
2025-11-09T23:19:32.4699553Z  
2025-11-09T23:19:32.4699760Z          // Create server with or without authentication
2025-11-09T23:19:32.4700221Z -        let server = if let (Some(ref storage), Some(ref mempool)) = (self.storage.as_ref(), self.mempool.as_ref()) {
2025-11-09T23:19:32.4700671Z -            let blockchain = Arc::new(blockchain::BlockchainRpc::with_dependencies(Arc::clone(storage)));
2025-11-09T23:19:32.4701434Z -            let mempool_rpc = Arc::new(mempool::MempoolRpc::with_dependencies(Arc::clone(mempool), Arc::clone(&storage)));
2025-11-09T23:19:32.4702303Z -            let rawtx_rpc = Arc::new(rawtx::RawTxRpc::with_dependencies(Arc::clone(storage), Arc::clone(mempool), None, None));
2025-11-09T23:19:32.4702793Z -            let mining = Arc::new(mining::MiningRpc::with_dependencies(Arc::clone(storage), Arc::clone(mempool)));
2025-11-09T23:19:32.4703055Z +        let server = if let (Some(ref storage), Some(ref mempool)) =
2025-11-09T23:19:32.4703256Z +            (self.storage.as_ref(), self.mempool.as_ref())
2025-11-09T23:19:32.4703370Z +        {
2025-11-09T23:19:32.4703747Z +            let blockchain = Arc::new(blockchain::BlockchainRpc::with_dependencies(Arc::clone(
2025-11-09T23:19:32.4703863Z +                storage,
2025-11-09T23:19:32.4703965Z +            )));
2025-11-09T23:19:32.4704251Z +            let mempool_rpc = Arc::new(mempool::MempoolRpc::with_dependencies(
2025-11-09T23:19:32.4704581Z +                Arc::clone(mempool),
2025-11-09T23:19:32.4704732Z +                Arc::clone(&storage),
2025-11-09T23:19:32.4704850Z +            ));
2025-11-09T23:19:32.4705099Z +            let rawtx_rpc = Arc::new(rawtx::RawTxRpc::with_dependencies(
2025-11-09T23:19:32.4705247Z +                Arc::clone(storage),
2025-11-09T23:19:32.4705378Z +                Arc::clone(mempool),
2025-11-09T23:19:32.4705498Z +                None,
2025-11-09T23:19:32.4705615Z +                None,
2025-11-09T23:19:32.4705719Z +            ));
2025-11-09T23:19:32.4705953Z +            let mining = Arc::new(mining::MiningRpc::with_dependencies(
2025-11-09T23:19:32.4706079Z +                Arc::clone(storage),
2025-11-09T23:19:32.4706203Z +                Arc::clone(mempool),
2025-11-09T23:19:32.4706312Z +            ));
2025-11-09T23:19:32.4706587Z              let network = if let Some(ref network_manager) = self.network_manager {
2025-11-09T23:19:32.4706929Z -                Arc::new(network::NetworkRpc::with_dependencies(Arc::clone(network_manager)))
2025-11-09T23:19:32.4707169Z +                Arc::new(network::NetworkRpc::with_dependencies(Arc::clone(
2025-11-09T23:19:32.4707314Z +                    network_manager,
2025-11-09T23:19:32.4718425Z +                )))
2025-11-09T23:19:32.4718863Z              } else {
2025-11-09T23:19:32.4719067Z                  Arc::new(network::NetworkRpc::new())
2025-11-09T23:19:32.4719199Z              };
2025-11-09T23:19:32.4719638Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mod.rs:209:
2025-11-09T23:19:32.4719760Z -            
2025-11-09T23:19:32.4719871Z +
2025-11-09T23:19:32.4720049Z              // Use auth manager if configured
2025-11-09T23:19:32.4720259Z              if let Some(ref auth_manager) = self.auth_manager {
2025-11-09T23:19:32.4720477Z                  server::RpcServer::with_dependencies_and_auth(
2025-11-09T23:19:32.4720899Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mod.rs:233:
2025-11-09T23:19:32.4721022Z          } else {
2025-11-09T23:19:32.4721216Z              // No dependencies - use auth if configured
2025-11-09T23:19:32.4721441Z              if let Some(ref auth_manager) = self.auth_manager {
2025-11-09T23:19:32.4721608Z -                server::RpcServer::with_auth(
2025-11-09T23:19:32.4721758Z -                    self.server_addr,
2025-11-09T23:19:32.4721921Z -                    Arc::clone(auth_manager),
2025-11-09T23:19:32.4722047Z -                )
2025-11-09T23:19:32.4722373Z +                server::RpcServer::with_auth(self.server_addr, Arc::clone(auth_manager))
2025-11-09T23:19:32.4722495Z              } else {
2025-11-09T23:19:32.4722694Z                  server::RpcServer::new(self.server_addr)
2025-11-09T23:19:32.4722814Z              }
2025-11-09T23:19:32.4723331Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:18:
2025-11-09T23:19:32.4723475Z  impl NetworkRpc {
2025-11-09T23:19:32.4723632Z      /// Create a new network RPC handler
2025-11-09T23:19:32.4723769Z      pub fn new() -> Self {
2025-11-09T23:19:32.4723909Z -        Self { network_manager: None }
2025-11-09T23:19:32.4724239Z +        Self {
2025-11-09T23:19:32.4724579Z +            network_manager: None,
2025-11-09T23:19:32.4724715Z +        }
2025-11-09T23:19:32.4724840Z      }
2025-11-09T23:19:32.4724956Z  
2025-11-09T23:19:32.4725104Z      /// Create with dependencies
2025-11-09T23:19:32.4725545Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:25:
2025-11-09T23:19:32.4725897Z      pub fn with_dependencies(network_manager: Arc<NetworkManager>) -> Self {
2025-11-09T23:19:32.4726103Z -        Self { network_manager: Some(network_manager) }
2025-11-09T23:19:32.4726222Z +        Self {
2025-11-09T23:19:32.4726413Z +            network_manager: Some(network_manager),
2025-11-09T23:19:32.4726529Z +        }
2025-11-09T23:19:32.4726642Z      }
2025-11-09T23:19:32.4726745Z  
2025-11-09T23:19:32.4726883Z      /// Get network information
2025-11-09T23:19:32.4727311Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:103:
2025-11-09T23:19:32.4727516Z          if let Some(ref network) = self.network_manager {
2025-11-09T23:19:32.4727697Z              let peer_manager = network.peer_manager();
2025-11-09T23:19:32.4727930Z              let peer_addresses = peer_manager.peer_addresses();
2025-11-09T23:19:32.4728182Z -            let peers: Vec<Value> = peer_addresses.iter().map(|addr| {
2025-11-09T23:19:32.4728404Z -                if let Some(peer) = peer_manager.get_peer(addr) {
2025-11-09T23:19:32.4728536Z -                    json!({
2025-11-09T23:19:32.4730587Z -                        "id": addr.port().unwrap_or(0) as u64, // Use port as peer ID (unique per connection)
2025-11-09T23:19:32.4730754Z -                        "addr": addr.to_string(),
2025-11-09T23:19:32.4730911Z -                        "addrlocal": "",
2025-11-09T23:19:32.4731066Z -                        "services": "0000000000000001",
2025-11-09T23:19:32.4731211Z -                        "relaytxes": true,
2025-11-09T23:19:32.4731381Z -                        "lastsend": peer.last_send(),
2025-11-09T23:19:32.4731553Z -                        "lastrecv": peer.last_recv(),
2025-11-09T23:19:32.4731969Z -                        "bytessent": peer.bytes_sent(),
2025-11-09T23:19:32.4732142Z -                        "bytesrecv": peer.bytes_recv(),
2025-11-09T23:19:32.4732308Z -                        "conntime": peer.conntime(),
2025-11-09T23:19:32.4732449Z -                        "timeoffset": 0,
2025-11-09T23:19:32.4732591Z -                        "pingtime": 0.0,
2025-11-09T23:19:32.4732736Z -                        "minping": 0.0,
2025-11-09T23:19:32.4732876Z -                        "version": 70015,
2025-11-09T23:19:32.4733042Z -                        "subver": "/reference-node:0.1.0/",
2025-11-09T23:19:32.4733190Z -                        "inbound": false,
2025-11-09T23:19:32.4733330Z -                        "addnode": false,
2025-11-09T23:19:32.4733486Z -                        "startingheight": 0,
2025-11-09T23:19:32.4733640Z -                        "synced_headers": -1,
2025-11-09T23:19:32.4733804Z -                        "synced_blocks": -1,
2025-11-09T23:19:32.4733944Z -                        "inflight": [],
2025-11-09T23:19:32.4734103Z -                        "whitelisted": false,
2025-11-09T23:19:32.4734278Z -                        "minfeefilter": 0.00001000,
2025-11-09T23:19:32.4734616Z -                        "bytessent_per_msg": {},
2025-11-09T23:19:32.4734770Z -                        "bytesrecv_per_msg": {}
2025-11-09T23:19:32.4734899Z -                    })
2025-11-09T23:19:32.4735025Z -                } else {
2025-11-09T23:19:32.4735153Z -                    json!({})
2025-11-09T23:19:32.4735264Z -                }
2025-11-09T23:19:32.4735400Z -            }).collect();
2025-11-09T23:19:32.4735567Z +            let peers: Vec<Value> = peer_addresses
2025-11-09T23:19:32.4735690Z +                .iter()
2025-11-09T23:19:32.4735826Z +                .map(|addr| {
2025-11-09T23:19:32.4736043Z +                    if let Some(peer) = peer_manager.get_peer(addr) {
2025-11-09T23:19:32.4736381Z +                        json!({
2025-11-09T23:19:32.4736728Z +                            "id": addr.port().unwrap_or(0) as u64, // Use port as peer ID (unique per connection)
2025-11-09T23:19:32.4736904Z +                            "addr": addr.to_string(),
2025-11-09T23:19:32.4737051Z +                            "addrlocal": "",
2025-11-09T23:19:32.4737210Z +                            "services": "0000000000000001",
2025-11-09T23:19:32.4737363Z +                            "relaytxes": true,
2025-11-09T23:19:32.4737522Z +                            "lastsend": peer.last_send(),
2025-11-09T23:19:32.4737680Z +                            "lastrecv": peer.last_recv(),
2025-11-09T23:19:32.4737849Z +                            "bytessent": peer.bytes_sent(),
2025-11-09T23:19:32.4738010Z +                            "bytesrecv": peer.bytes_recv(),
2025-11-09T23:19:32.4738177Z +                            "conntime": peer.conntime(),
2025-11-09T23:19:32.4738322Z +                            "timeoffset": 0,
2025-11-09T23:19:32.4738484Z +                            "pingtime": 0.0,
2025-11-09T23:19:32.4740541Z +                            "minping": 0.0,
2025-11-09T23:19:32.4741117Z +                            "version": 70015,
2025-11-09T23:19:32.4741311Z +                            "subver": "/reference-node:0.1.0/",
2025-11-09T23:19:32.4741458Z +                            "inbound": false,
2025-11-09T23:19:32.4741597Z +                            "addnode": false,
2025-11-09T23:19:32.4741757Z +                            "startingheight": 0,
2025-11-09T23:19:32.4741915Z +                            "synced_headers": -1,
2025-11-09T23:19:32.4742070Z +                            "synced_blocks": -1,
2025-11-09T23:19:32.4742213Z +                            "inflight": [],
2025-11-09T23:19:32.4742375Z +                            "whitelisted": false,
2025-11-09T23:19:32.4742536Z +                            "minfeefilter": 0.00001000,
2025-11-09T23:19:32.4742701Z +                            "bytessent_per_msg": {},
2025-11-09T23:19:32.4742879Z +                            "bytesrecv_per_msg": {}
2025-11-09T23:19:32.4743239Z +                        })
2025-11-09T23:19:32.4743367Z +                    } else {
2025-11-09T23:19:32.4743492Z +                        json!({})
2025-11-09T23:19:32.4743618Z +                    }
2025-11-09T23:19:32.4743733Z +                })
2025-11-09T23:19:32.4743865Z +                .collect();
2025-11-09T23:19:32.4744007Z              Ok(json!(peers))
2025-11-09T23:19:32.4744121Z          } else {
2025-11-09T23:19:32.4744249Z              Ok(json!([]))
2025-11-09T23:19:32.4744893Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:164:
2025-11-09T23:19:32.4745117Z          if let Some(ref network) = self.network_manager {
2025-11-09T23:19:32.4745272Z              // Send ping to all peers
2025-11-09T23:19:32.4745477Z              if let Err(e) = network.ping_all_peers().await {
2025-11-09T23:19:32.4745869Z -                return Err(RpcError::internal_error(format!("Failed to ping peers: {}", e)));
2025-11-09T23:19:32.4746073Z +                return Err(RpcError::internal_error(format!(
2025-11-09T23:19:32.4746232Z +                    "Failed to ping peers: {}",
2025-11-09T23:19:32.4746357Z +                    e
2025-11-09T23:19:32.4746473Z +                )));
2025-11-09T23:19:32.4746587Z              }
2025-11-09T23:19:32.4746774Z              debug!("Sent ping to all connected peers");
2025-11-09T23:19:32.4746900Z          }
2025-11-09T23:19:32.4747315Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:205:
2025-11-09T23:19:32.4747435Z                  "onetry" => {
2025-11-09T23:19:32.4747581Z                      // Try to connect to node once
2025-11-09T23:19:32.4747779Z                      if let Err(e) = network.connect_to_peer(addr).await {
2025-11-09T23:19:32.4748150Z -                        return Err(RpcError::internal_error(format!("Failed to connect to {}: {}", addr, e)));
2025-11-09T23:19:32.4748572Z +                        return Err(RpcError::internal_error(format!(
2025-11-09T23:19:32.4748751Z +                            "Failed to connect to {}: {}",
2025-11-09T23:19:32.4748878Z +                            addr, e
2025-11-09T23:19:32.4748999Z +                        )));
2025-11-09T23:19:32.4749120Z                      }
2025-11-09T23:19:32.4749309Z                      debug!("Connected to node {} (onetry)", addr);
2025-11-09T23:19:32.4749428Z                      Ok(json!(null))
2025-11-09T23:19:32.4749845Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:310:
2025-11-09T23:19:32.4749993Z                  active_connection_limit_hits: 0,
2025-11-09T23:19:32.4750135Z                  resource_exhaustion_events: 0,
2025-11-09T23:19:32.4750236Z              };
2025-11-09T23:19:32.4750346Z -            
2025-11-09T23:19:32.4750445Z +
2025-11-09T23:19:32.4750554Z              Ok(json!({
2025-11-09T23:19:32.4750683Z                  "metrics": {
2025-11-09T23:19:32.4752737Z                      "connection_rate_violations": metrics.connection_rate_violations,
2025-11-09T23:19:32.4753182Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:365:
2025-11-09T23:19:32.4753350Z          let addr: SocketAddr = subnet
2025-11-09T23:19:32.4753476Z              .parse()
2025-11-09T23:19:32.4753870Z              .map_err(|_| RpcError::invalid_params(format!("Invalid address/subnet: {}", subnet)))?;
2025-11-09T23:19:32.4753987Z -        
2025-11-09T23:19:32.4754105Z +
2025-11-09T23:19:32.4754280Z          // Parse bantime (seconds) - 0 = permanent
2025-11-09T23:19:32.4754820Z          let bantime = params.get(2).and_then(|p| p.as_u64()).unwrap_or(86400); // Default 24 hours
2025-11-09T23:19:32.4754950Z -        
2025-11-09T23:19:32.4755062Z +
2025-11-09T23:19:32.4755367Z          // Parse absolute (whether bantime is absolute timestamp or relative)
2025-11-09T23:19:32.4755676Z          let absolute = params.get(3).and_then(|p| p.as_bool()).unwrap_or(false);
2025-11-09T23:19:32.4755806Z -        
2025-11-09T23:19:32.4756130Z +
2025-11-09T23:19:32.4756337Z          if let Some(ref network) = self.network_manager {
2025-11-09T23:19:32.4756528Z              use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:19:32.4756685Z              let now = SystemTime::now()
2025-11-09T23:19:32.4757138Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:378:
2025-11-09T23:19:32.4757307Z                  .duration_since(UNIX_EPOCH)
2025-11-09T23:19:32.4757435Z                  .unwrap()
2025-11-09T23:19:32.4757564Z                  .as_secs();
2025-11-09T23:19:32.4757674Z -            
2025-11-09T23:19:32.4757796Z +
2025-11-09T23:19:32.4757961Z              let unban_timestamp = if absolute {
2025-11-09T23:19:32.4758120Z                  bantime // Already a timestamp
2025-11-09T23:19:32.4758271Z              } else if bantime == 0 {
2025-11-09T23:19:32.4758722Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:386:
2025-11-09T23:19:32.4758857Z              } else {
2025-11-09T23:19:32.4759022Z                  now + bantime // Relative ban
2025-11-09T23:19:32.4759146Z              };
2025-11-09T23:19:32.4759260Z -            
2025-11-09T23:19:32.4759372Z +
2025-11-09T23:19:32.4759518Z              match command {
2025-11-09T23:19:32.4759646Z                  "add" => {
2025-11-09T23:19:32.4759833Z                      network.ban_peer(addr, unban_timestamp);
2025-11-09T23:19:32.4761518Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:422:
2025-11-09T23:19:32.4761641Z  
2025-11-09T23:19:32.4761839Z          if let Some(ref network) = self.network_manager {
2025-11-09T23:19:32.4762013Z              let banned = network.get_banned_peers();
2025-11-09T23:19:32.4762321Z -            let result: Vec<Value> = banned.iter().map(|(addr, unban_timestamp)| {
2025-11-09T23:19:32.4762447Z -                json!({
2025-11-09T23:19:32.4762871Z -                    "address": addr.to_string(),
2025-11-09T23:19:32.4763113Z -                    "banned_until": if *unban_timestamp == u64::MAX {
2025-11-09T23:19:32.4763312Z -                        serde_json::Value::Null // Permanent ban
2025-11-09T23:19:32.4763440Z -                    } else {
2025-11-09T23:19:32.4763671Z -                        serde_json::Value::Number((*unban_timestamp).into())
2025-11-09T23:19:32.4763799Z -                    },
2025-11-09T23:19:32.4764033Z -                    "banned_until_absolute": *unban_timestamp == u64::MAX
2025-11-09T23:19:32.4764193Z +            let result: Vec<Value> = banned
2025-11-09T23:19:32.4764563Z +                .iter()
2025-11-09T23:19:32.4764744Z +                .map(|(addr, unban_timestamp)| {
2025-11-09T23:19:32.4764875Z +                    json!({
2025-11-09T23:19:32.4765040Z +                        "address": addr.to_string(),
2025-11-09T23:19:32.4765279Z +                        "banned_until": if *unban_timestamp == u64::MAX {
2025-11-09T23:19:32.4765497Z +                            serde_json::Value::Null // Permanent ban
2025-11-09T23:19:32.4765633Z +                        } else {
2025-11-09T23:19:32.4765876Z +                            serde_json::Value::Number((*unban_timestamp).into())
2025-11-09T23:19:32.4766001Z +                        },
2025-11-09T23:19:32.4766236Z +                        "banned_until_absolute": *unban_timestamp == u64::MAX
2025-11-09T23:19:32.4766367Z +                    })
2025-11-09T23:19:32.4766477Z                  })
2025-11-09T23:19:32.4766599Z -            }).collect();
2025-11-09T23:19:32.4766729Z +                .collect();
2025-11-09T23:19:32.4766873Z              Ok(json!(result))
2025-11-09T23:19:32.4766988Z          } else {
2025-11-09T23:19:32.4767105Z              Ok(json!([]))
2025-11-09T23:19:32.4767562Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:445:
2025-11-09T23:19:32.4767899Z      pub async fn getaddednodeinfo(&self, params: &Value) -> RpcResult<Value> {
2025-11-09T23:19:32.4768061Z          debug!("RPC: getaddednodeinfo");
2025-11-09T23:19:32.4768384Z  
2025-11-09T23:19:32.4768523Z -        let node = params.get(0)
2025-11-09T23:19:32.4768648Z +        let node = params
2025-11-09T23:19:32.4768754Z +            .get(0)
2025-11-09T23:19:32.4768892Z              .and_then(|p| p.as_str())
2025-11-09T23:19:32.4769206Z              .ok_or_else(|| RpcError::invalid_params("Node address required".to_string()))?;
2025-11-09T23:19:32.4769315Z  
2025-11-09T23:19:32.4769741Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:453:
2025-11-09T23:19:32.4769845Z  
2025-11-09T23:19:32.4770030Z          if let Some(ref network) = self.network_manager {
2025-11-09T23:19:32.4770647Z              // Parse node address
2025-11-09T23:19:32.4770826Z -            let addr: SocketAddr = node.parse()
2025-11-09T23:19:32.4772616Z +            let addr: SocketAddr = node
2025-11-09T23:19:32.4772756Z +                .parse()
2025-11-09T23:19:32.4773127Z                  .map_err(|e| RpcError::invalid_params(format!("Invalid node address: {}", e)))?;
2025-11-09T23:19:32.4773253Z  
2025-11-09T23:19:32.4773436Z              // Check if node is in persistent peer list
2025-11-09T23:19:32.4773861Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:494:
2025-11-09T23:19:32.4774209Z      pub async fn getnodeaddresses(&self, params: &Value) -> RpcResult<Value> {
2025-11-09T23:19:32.4774600Z          debug!("RPC: getnodeaddresses");
2025-11-09T23:19:32.4774725Z  
2025-11-09T23:19:32.4774886Z -        let count = params.get(0)
2025-11-09T23:19:32.4775040Z -            .and_then(|p| p.as_u64())
2025-11-09T23:19:32.4775172Z -            .unwrap_or(1)
2025-11-09T23:19:32.4775340Z -            .min(100) as usize; // Limit to 100
2025-11-09T23:19:32.4775744Z +        let count = params.get(0).and_then(|p| p.as_u64()).unwrap_or(1).min(100) as usize; // Limit to 100
2025-11-09T23:19:32.4776103Z  
2025-11-09T23:19:32.4776311Z          if let Some(ref network) = self.network_manager {
2025-11-09T23:19:32.4776475Z              // Get peer addresses
2025-11-09T23:19:32.4776927Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:504:
2025-11-09T23:19:32.4777152Z              let peer_addrs = network.get_peer_addresses().await;
2025-11-09T23:19:32.4777283Z -            
2025-11-09T23:19:32.4777397Z +
2025-11-09T23:19:32.4777560Z              // Convert to node address format
2025-11-09T23:19:32.4777734Z              let mut addresses = Vec::new();
2025-11-09T23:19:32.4777935Z              for addr in peer_addrs.into_iter().take(count) {
2025-11-09T23:19:32.4778376Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:551:
2025-11-09T23:19:32.4778705Z      pub async fn setnetworkactive(&self, params: &Value) -> RpcResult<Value> {
2025-11-09T23:19:32.4778858Z          debug!("RPC: setnetworkactive");
2025-11-09T23:19:32.4778969Z  
2025-11-09T23:19:32.4779100Z -        let state = params.get(0)
2025-11-09T23:19:32.4779244Z -            .and_then(|p| p.as_bool())
2025-11-09T23:19:32.4781661Z -            .ok_or_else(|| RpcError::invalid_params("State parameter required (true/false)".to_string()))?;
2025-11-09T23:19:32.4781931Z +        let state = params.get(0).and_then(|p| p.as_bool()).ok_or_else(|| {
2025-11-09T23:19:32.4782270Z +            RpcError::invalid_params("State parameter required (true/false)".to_string())
2025-11-09T23:19:32.4782377Z +        })?;
2025-11-09T23:19:32.4782481Z  
2025-11-09T23:19:32.4782680Z          if let Some(ref network) = self.network_manager {
2025-11-09T23:19:32.4782869Z -            network.set_network_active(state).await
2025-11-09T23:19:32.4783231Z -                .map_err(|e| RpcError::internal_error(format!("Failed to set network active: {}", e)))?;
2025-11-09T23:19:32.4783441Z +            network.set_network_active(state).await.map_err(|e| {
2025-11-09T23:19:32.4783754Z +                RpcError::internal_error(format!("Failed to set network active: {}", e))
2025-11-09T23:19:32.4783870Z +            })?;
2025-11-09T23:19:32.4784190Z              Ok(json!(state))
2025-11-09T23:19:32.4784463Z          } else {
2025-11-09T23:19:32.4784823Z -            Err(RpcError::internal_error("Network manager not available".to_string()))
2025-11-09T23:19:32.4784988Z +            Err(RpcError::internal_error(
2025-11-09T23:19:32.4785181Z +                "Network manager not available".to_string(),
2025-11-09T23:19:32.4785309Z +            ))
2025-11-09T23:19:32.4785424Z          }
2025-11-09T23:19:32.4785539Z      }
2025-11-09T23:19:32.4785662Z  }
2025-11-09T23:19:32.4833919Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:68:
2025-11-09T23:19:32.4834162Z          let tx_bytes = hex::decode(hex_string)
2025-11-09T23:19:32.4834723Z              .map_err(|e| RpcError::invalid_params(format!("Invalid hex string: {}", e)))?;
2025-11-09T23:19:32.4834841Z  
2025-11-09T23:19:32.4835280Z -        if let (Some(ref storage), Some(ref mempool)) = (self.storage.as_ref(), self.mempool.as_ref()) {
2025-11-09T23:19:32.4835496Z +        if let (Some(ref storage), Some(ref mempool)) =
2025-11-09T23:19:32.4835702Z +            (self.storage.as_ref(), self.mempool.as_ref())
2025-11-09T23:19:32.4835817Z +        {
2025-11-09T23:19:32.4836179Z              use bllvm_protocol::serialization::transaction::deserialize_transaction;
2025-11-09T23:19:32.4836369Z -            let tx = deserialize_transaction(&tx_bytes)
2025-11-09T23:19:32.4836759Z -                .map_err(|e| RpcError::invalid_params(format!("Failed to parse transaction: {}", e)))?;
2025-11-09T23:19:32.4836877Z -            
2025-11-09T23:19:32.4837124Z +            let tx = deserialize_transaction(&tx_bytes).map_err(|e| {
2025-11-09T23:19:32.4837451Z +                RpcError::invalid_params(format!("Failed to parse transaction: {}", e))
2025-11-09T23:19:32.4837568Z +            })?;
2025-11-09T23:19:32.4837674Z +
2025-11-09T23:19:32.4838119Z              use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:19:32.4838279Z              let txid = calculate_tx_id(&tx);
2025-11-09T23:19:32.4838403Z -            
2025-11-09T23:19:32.4838509Z +
2025-11-09T23:19:32.4838660Z              // Check if already in mempool
2025-11-09T23:19:32.4838859Z              if mempool.get_transaction(&txid).is_some() {
2025-11-09T23:19:32.4839199Z                  return Err(RpcError::invalid_params("Transaction already in mempool"));
2025-11-09T23:19:32.4839629Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:82:
2025-11-09T23:19:32.4839759Z              }
2025-11-09T23:19:32.4842125Z -            
2025-11-09T23:19:32.4842272Z +
2025-11-09T23:19:32.4842412Z              // Check if in chain
2025-11-09T23:19:32.4842743Z -            if storage.transactions().has_transaction(&txid).unwrap_or(false) {
2025-11-09T23:19:32.4842870Z +            if storage
2025-11-09T23:19:32.4843007Z +                .transactions()
2025-11-09T23:19:32.4843171Z +                .has_transaction(&txid)
2025-11-09T23:19:32.4843310Z +                .unwrap_or(false)
2025-11-09T23:19:32.4843432Z +            {
2025-11-09T23:19:32.4843770Z                  return Err(RpcError::invalid_params("Transaction already in chain"));
2025-11-09T23:19:32.4843889Z              }
2025-11-09T23:19:32.4843999Z -            
2025-11-09T23:19:32.4844111Z +
2025-11-09T23:19:32.4844486Z              // Validate transaction using consensus layer
2025-11-09T23:19:32.4844701Z -            let _timer = self.profiler.as_ref().map(|p| {
2025-11-09T23:19:32.4845044Z -                PerformanceTimer::start(Arc::clone(p), OperationType::TxValidation)
2025-11-09T23:19:32.4845168Z -            });
2025-11-09T23:19:32.4845306Z +            let _timer = self
2025-11-09T23:19:32.4845436Z +                .profiler
2025-11-09T23:19:32.4845558Z +                .as_ref()
2025-11-09T23:19:32.4845951Z +                .map(|p| PerformanceTimer::start(Arc::clone(p), OperationType::TxValidation));
2025-11-09T23:19:32.4846141Z              let validation_start = Instant::now();
2025-11-09T23:19:32.4846535Z              use bllvm_protocol::ConsensusProof;
2025-11-09T23:19:32.4846715Z              let consensus = ConsensusProof::new();
2025-11-09T23:19:32.4847164Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:97:
2025-11-09T23:19:32.4847387Z                  Ok(bllvm_protocol::ValidationResult::Valid) => {
2025-11-09T23:19:32.4847618Z                      let validation_time = validation_start.elapsed();
2025-11-09T23:19:32.4847793Z                      // Timer will record duration when dropped
2025-11-09T23:19:32.4847904Z -                    
2025-11-09T23:19:32.4848010Z +
2025-11-09T23:19:32.4848154Z                      // Update metrics
2025-11-09T23:19:32.4848329Z                      if let Some(ref metrics) = self.metrics {
2025-11-09T23:19:32.4848497Z                          metrics.update_performance(|m| {
2025-11-09T23:19:32.4848939Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:104:
2025-11-09T23:19:32.4849161Z                              let time_ms = validation_time.as_secs_f64() * 1000.0;
2025-11-09T23:19:32.4849522Z                              // Update average transaction validation time (exponential moving average)
2025-11-09T23:19:32.4849688Z -                            m.avg_tx_validation_time_ms = 
2025-11-09T23:19:32.4849840Z +                            m.avg_tx_validation_time_ms =
2025-11-09T23:19:32.4850047Z                                  (m.avg_tx_validation_time_ms * 0.9) + (time_ms * 0.1);
2025-11-09T23:19:32.4850214Z                              // Update transactions per second
2025-11-09T23:19:32.4850381Z                              if validation_time.as_secs_f64() > 0.0 {
2025-11-09T23:19:32.4850785Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:111:
2025-11-09T23:19:32.4850898Z                              }
2025-11-09T23:19:32.4851216Z                          });
2025-11-09T23:19:32.4851323Z                      }
2025-11-09T23:19:32.4851427Z -                    
2025-11-09T23:19:32.4851540Z +
2025-11-09T23:19:32.4852216Z                      // Transaction structure is valid, now check inputs against UTXO set
2025-11-09T23:19:32.4852417Z -                    let utxo_set = storage.utxos().get_all_utxos()
2025-11-09T23:19:32.4852772Z -                        .map_err(|e| RpcError::internal_error(format!("Failed to get UTXO set: {}", e)))?;
2025-11-09T23:19:32.4852887Z -                    
2025-11-09T23:19:32.4853122Z +                    let utxo_set = storage.utxos().get_all_utxos().map_err(|e| {
2025-11-09T23:19:32.4853404Z +                        RpcError::internal_error(format!("Failed to get UTXO set: {}", e))
2025-11-09T23:19:32.4853521Z +                    })?;
2025-11-09T23:19:32.4853626Z +
2025-11-09T23:19:32.4853783Z                      // Check if all inputs exist in UTXO set
2025-11-09T23:19:32.4853938Z                      for input in &tx.inputs {
2025-11-09T23:19:32.4854140Z                          if !utxo_set.contains_key(&input.prevout) {
2025-11-09T23:19:32.4854771Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:126:
2025-11-09T23:19:32.4854908Z                              )));
2025-11-09T23:19:32.4855043Z                          }
2025-11-09T23:19:32.4855164Z                      }
2025-11-09T23:19:32.4855279Z -                    
2025-11-09T23:19:32.4855400Z +
2025-11-09T23:19:32.4855543Z                      // Add to mempool
2025-11-09T23:19:32.4855899Z                      // Note: add_transaction requires &mut self, but we have Arc<MempoolManager>
2025-11-09T23:19:32.4856241Z                      // In production, this would need to use interior mutability (Mutex/RwLock)
2025-11-09T23:19:32.4856653Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:133:
2025-11-09T23:19:32.4856915Z                      // For now, we'll skip adding to mempool as it requires mutable access
2025-11-09T23:19:32.4857335Z -                    debug!("Transaction validated but not added to mempool (requires mutable access)");
2025-11-09T23:19:32.4858147Z +                    debug!(
2025-11-09T23:19:32.4858506Z +                        "Transaction validated but not added to mempool (requires mutable access)"
2025-11-09T23:19:32.4858630Z +                    );
2025-11-09T23:19:32.4860607Z                  }
2025-11-09T23:19:32.4860891Z                  Ok(bllvm_protocol::ValidationResult::Invalid(reason)) => {
2025-11-09T23:19:32.4861339Z -                    return Err(RpcError::invalid_params(format!("Transaction validation failed: {}", reason)));
2025-11-09T23:19:32.4861547Z +                    return Err(RpcError::invalid_params(format!(
2025-11-09T23:19:32.4861728Z +                        "Transaction validation failed: {}",
2025-11-09T23:19:32.4861856Z +                        reason
2025-11-09T23:19:32.4861983Z +                    )));
2025-11-09T23:19:32.4862099Z                  }
2025-11-09T23:19:32.4862214Z                  Err(e) => {
2025-11-09T23:19:32.4862622Z -                    return Err(RpcError::internal_error(format!("Transaction validation error: {}", e)));
2025-11-09T23:19:32.4862843Z +                    return Err(RpcError::internal_error(format!(
2025-11-09T23:19:32.4863026Z +                        "Transaction validation error: {}",
2025-11-09T23:19:32.4863157Z +                        e
2025-11-09T23:19:32.4863285Z +                    )));
2025-11-09T23:19:32.4863400Z                  }
2025-11-09T23:19:32.4863515Z              }
2025-11-09T23:19:32.4863631Z -            
2025-11-09T23:19:32.4863750Z +
2025-11-09T23:19:32.4863907Z              Ok(json!(hex::encode(txid)))
2025-11-09T23:19:32.4864025Z          } else {
2025-11-09T23:19:32.4864550Z -            Err(RpcError::invalid_params("RPC not initialized with dependencies"))
2025-11-09T23:19:32.4864725Z +            Err(RpcError::invalid_params(
2025-11-09T23:19:32.4865157Z +                "RPC not initialized with dependencies",
2025-11-09T23:19:32.4865275Z +            ))
2025-11-09T23:19:32.4865406Z          }
2025-11-09T23:19:32.4865832Z      }
2025-11-09T23:19:32.4865956Z  
2025-11-09T23:19:32.4866419Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:175:
2025-11-09T23:19:32.4866611Z          let consensus = ConsensusProof::new();
2025-11-09T23:19:32.4866899Z          let validation_result = consensus.validate_transaction(&tx);
2025-11-09T23:19:32.4867013Z  
2025-11-09T23:19:32.4867441Z -        let allowed = matches!(validation_result, Ok(bllvm_protocol::ValidationResult::Valid));
2025-11-09T23:19:32.4867600Z +        let allowed = matches!(
2025-11-09T23:19:32.4867739Z +            validation_result,
2025-11-09T23:19:32.4867928Z +            Ok(bllvm_protocol::ValidationResult::Valid)
2025-11-09T23:19:32.4868047Z +        );
2025-11-09T23:19:32.4868217Z          let reject_reason = if !allowed {
2025-11-09T23:19:32.4868379Z              match validation_result {
2025-11-09T23:19:32.4868714Z                  Ok(bllvm_protocol::ValidationResult::Invalid(reason)) => Some(reason),
2025-11-09T23:19:32.4869180Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:232:
2025-11-09T23:19:32.4869533Z          use bllvm_protocol::serialization::transaction::deserialize_transaction;
2025-11-09T23:19:32.4869716Z          let tx = deserialize_transaction(&tx_bytes)
2025-11-09T23:19:32.4870127Z              .map_err(|e| RpcError::invalid_params(format!("Failed to parse transaction: {}", e)))?;
2025-11-09T23:19:32.4870247Z -        
2025-11-09T23:19:32.4870359Z +
2025-11-09T23:19:32.4870565Z          use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:19:32.4870716Z          let txid = calculate_tx_id(&tx);
2025-11-09T23:19:32.4871254Z          let txid_hex = hex::encode(txid);
2025-11-09T23:19:32.4873494Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:239:
2025-11-09T23:19:32.4873660Z          let size = tx_bytes.len();
2025-11-09T23:19:32.4873779Z -        
2025-11-09T23:19:32.4873890Z +
2025-11-09T23:19:32.4874266Z          Ok(json!({
2025-11-09T23:19:32.4874595Z              "txid": txid_hex.clone(),
2025-11-09T23:19:32.4874731Z              "hash": txid_hex,
2025-11-09T23:19:32.4875184Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:295:
2025-11-09T23:19:32.4875511Z              if let Ok(Some(tx)) = storage.transactions().get_transaction(&txid_array) {
2025-11-09T23:19:32.4875853Z                  use bllvm_protocol::serialization::transaction::serialize_transaction;
2025-11-09T23:19:32.4876091Z                  let tx_hex = hex::encode(serialize_transaction(&tx));
2025-11-09T23:19:32.4876215Z -                
2025-11-09T23:19:32.4876329Z +
2025-11-09T23:19:32.4876461Z                  if verbose {
2025-11-09T23:19:32.4876683Z                      use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:19:32.4876888Z                      let calculated_txid = calculate_tx_id(&tx);
2025-11-09T23:19:32.4877337Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:417:
2025-11-09T23:19:32.4877601Z              if let Ok(Some(utxo)) = storage.utxos().get_utxo(&outpoint) {
2025-11-09T23:19:32.4877902Z                  let best_hash = storage.chain().get_tip_hash()?.unwrap_or([0u8; 32]);
2025-11-09T23:19:32.4878166Z                  let tip_height = storage.chain().get_height()?.unwrap_or(0);
2025-11-09T23:19:32.4878282Z -                
2025-11-09T23:19:32.4878395Z +
2025-11-09T23:19:32.4878602Z                  // Find block height containing this transaction
2025-11-09T23:19:32.4878775Z                  let mut tx_height: Option<u64> = None;
2025-11-09T23:19:32.4878936Z                  for h in 0..=tip_height {
2025-11-09T23:19:32.4879375Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:437:
2025-11-09T23:19:32.4879501Z                          }
2025-11-09T23:19:32.4879842Z                      }
2025-11-09T23:19:32.4879956Z                  }
2025-11-09T23:19:32.4880070Z -                
2025-11-09T23:19:32.4880188Z +
2025-11-09T23:19:32.4880366Z                  let confirmations = tx_height
2025-11-09T23:19:32.4880498Z                      .map(|h| {
2025-11-09T23:19:32.4880645Z                          if h > tip_height {
2025-11-09T23:19:32.4881091Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:447:
2025-11-09T23:19:32.4881224Z                          }
2025-11-09T23:19:32.4881340Z                      })
2025-11-09T23:19:32.4881481Z                      .unwrap_or(0);
2025-11-09T23:19:32.4881603Z -                
2025-11-09T23:19:32.4881711Z +
2025-11-09T23:19:32.4881837Z                  Ok(json!({
2025-11-09T23:19:32.4882026Z                      "bestblock": hex::encode(best_hash),
2025-11-09T23:19:32.4882193Z                      "confirmations": confirmations,
2025-11-09T23:19:32.4882632Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:470:
2025-11-09T23:19:32.4882756Z      }
2025-11-09T23:19:32.4882878Z  
2025-11-09T23:19:32.4883084Z      /// Build merkle proof for transactions in a block
2025-11-09T23:19:32.4883724Z -    fn build_merkle_proof(transactions: &[bllvm_protocol::Transaction], tx_indices: &[usize]) -> Result<Vec<[u8; 32]>, RpcError> {
2025-11-09T23:19:32.4883942Z -        use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:19:32.4884082Z +    fn build_merkle_proof(
2025-11-09T23:19:32.4884431Z +        transactions: &[bllvm_protocol::Transaction],
2025-11-09T23:19:32.4884578Z +        tx_indices: &[usize],
2025-11-09T23:19:32.4884744Z +    ) -> Result<Vec<[u8; 32]>, RpcError> {
2025-11-09T23:19:32.4884931Z          use crate::storage::hashing::double_sha256;
2025-11-09T23:19:32.4885122Z +        use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:19:32.4885247Z  
2025-11-09T23:19:32.4885403Z          if transactions.is_empty() {
2025-11-09T23:19:32.4885793Z -            return Err(RpcError::internal_error("Block has no transactions".to_string()));
2025-11-09T23:19:32.4886202Z +            return Err(RpcError::internal_error(
2025-11-09T23:19:32.4886384Z +                "Block has no transactions".to_string(),
2025-11-09T23:19:32.4886499Z +            ));
2025-11-09T23:19:32.4886612Z          }
2025-11-09T23:19:32.4886730Z  
2025-11-09T23:19:32.4886890Z          // Calculate all transaction hashes
2025-11-09T23:19:32.4887332Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:482:
2025-11-09T23:19:32.4887568Z -        let mut tx_hashes: Vec<[u8; 32]> = transactions.iter()
2025-11-09T23:19:32.4887723Z -            .map(|tx| calculate_tx_id(tx))
2025-11-09T23:19:32.4887845Z -            .collect();
2025-11-09T23:19:32.4890033Z +        let mut tx_hashes: Vec<[u8; 32]> =
2025-11-09T23:19:32.4890329Z +            transactions.iter().map(|tx| calculate_tx_id(tx)).collect();
2025-11-09T23:19:32.4890439Z  
2025-11-09T23:19:32.4890606Z          let mut proof = Vec::new();
2025-11-09T23:19:32.4890794Z          let mut current_level = tx_hashes.clone();
2025-11-09T23:19:32.4891254Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:501:
2025-11-09T23:19:32.4891434Z                      combined.extend_from_slice(&chunk[1]);
2025-11-09T23:19:32.4891634Z                      let parent_hash = double_sha256(&combined);
2025-11-09T23:19:32.4891803Z                      next_level.push(parent_hash);
2025-11-09T23:19:32.4891922Z -                    
2025-11-09T23:19:32.4892029Z +
2025-11-09T23:19:32.4892218Z                      // Check if we need to add sibling to proof
2025-11-09T23:19:32.4892363Z                      if !proof_added {
2025-11-09T23:19:32.4892516Z                          for &idx in tx_indices {
2025-11-09T23:19:32.4892962Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:581:
2025-11-09T23:19:32.4893129Z                              for tx in &b.transactions {
2025-11-09T23:19:32.4893506Z                                  let txid = calculate_tx_id(tx);
2025-11-09T23:19:32.4893704Z                                  let txid_hex = hex::encode(txid);
2025-11-09T23:19:32.4894006Z -                                if txids.iter().any(|tid| tid.as_str() == Some(txid_hex.as_str())) {
2025-11-09T23:19:32.4894143Z +                                if txids
2025-11-09T23:19:32.4894456Z +                                    .iter()
2025-11-09T23:19:32.4894691Z +                                    .any(|tid| tid.as_str() == Some(txid_hex.as_str()))
2025-11-09T23:19:32.4894822Z +                                {
2025-11-09T23:19:32.4894973Z                                      block = Some(b);
2025-11-09T23:19:32.4895117Z                                      break;
2025-11-09T23:19:32.4895240Z                                  }
2025-11-09T23:19:32.4895689Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:601:
2025-11-09T23:19:32.4895951Z                  for (idx, tx) in block.transactions.iter().enumerate() {
2025-11-09T23:19:32.4896108Z                      let txid = calculate_tx_id(tx);
2025-11-09T23:19:32.4896288Z                      let txid_hex = hex::encode(txid);
2025-11-09T23:19:32.4896575Z -                    if txids.iter().any(|tid| tid.as_str() == Some(txid_hex.as_str())) {
2025-11-09T23:19:32.4896711Z +                    if txids
2025-11-09T23:19:32.4896837Z +                        .iter()
2025-11-09T23:19:32.4897048Z +                        .any(|tid| tid.as_str() == Some(txid_hex.as_str()))
2025-11-09T23:19:32.4897174Z +                    {
2025-11-09T23:19:32.4897331Z                          tx_indices.push(idx);
2025-11-09T23:19:32.4897446Z                      }
2025-11-09T23:19:32.4897560Z                  }
2025-11-09T23:19:32.4899725Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:608:
2025-11-09T23:19:32.4899836Z  
2025-11-09T23:19:32.4899989Z                  if tx_indices.is_empty() {
2025-11-09T23:19:32.4900459Z -                    return Err(RpcError::invalid_params("None of the specified transactions found in block"));
2025-11-09T23:19:32.4900875Z +                    return Err(RpcError::invalid_params(
2025-11-09T23:19:32.4901325Z +                        "None of the specified transactions found in block",
2025-11-09T23:19:32.4901455Z +                    ));
2025-11-09T23:19:32.4901567Z                  }
2025-11-09T23:19:32.4901676Z  
2025-11-09T23:19:32.4901823Z                  // Build merkle proof
2025-11-09T23:19:32.4902270Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:614:
2025-11-09T23:19:32.4902638Z                  let proof_hashes = Self::build_merkle_proof(&block.transactions, &tx_indices)
2025-11-09T23:19:32.4903048Z -                    .map_err(|e| RpcError::internal_error(format!("Failed to build merkle proof: {}", e)))?;
2025-11-09T23:19:32.4903190Z +                    .map_err(|e| {
2025-11-09T23:19:32.4903551Z +                        RpcError::internal_error(format!("Failed to build merkle proof: {}", e))
2025-11-09T23:19:32.4903679Z +                    })?;
2025-11-09T23:19:32.4903794Z  
2025-11-09T23:19:32.4904136Z                  // Serialize proof (simplified - Bitcoin Core uses a more complex format)
2025-11-09T23:19:32.4904474Z                  let mut proof_bytes = Vec::new();
2025-11-09T23:19:32.4904945Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:626:
2025-11-09T23:19:32.4905166Z                  Err(RpcError::invalid_params("Block not found"))
2025-11-09T23:19:32.4905282Z              }
2025-11-09T23:19:32.4905397Z          } else {
2025-11-09T23:19:32.4905743Z -            Err(RpcError::invalid_params("RPC not initialized with dependencies"))
2025-11-09T23:19:32.4905909Z +            Err(RpcError::invalid_params(
2025-11-09T23:19:32.4906098Z +                "RPC not initialized with dependencies",
2025-11-09T23:19:32.4906220Z +            ))
2025-11-09T23:19:32.4906556Z          }
2025-11-09T23:19:32.4906673Z      }
2025-11-09T23:19:32.4906785Z  
2025-11-09T23:19:32.4907256Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:650:
2025-11-09T23:19:32.4907393Z              // Decode proof
2025-11-09T23:19:32.4907580Z              let proof_bytes = hex::decode(proof_hex)
2025-11-09T23:19:32.4907936Z                  .map_err(|e| RpcError::invalid_params(format!("Invalid proof hex: {}", e)))?;
2025-11-09T23:19:32.4908053Z -            
2025-11-09T23:19:32.4908162Z +
2025-11-09T23:19:32.4908323Z              if proof_bytes.is_empty() {
2025-11-09T23:19:32.4908562Z                  return Err(RpcError::invalid_params("Empty proof"));
2025-11-09T23:19:32.4908680Z              }
2025-11-09T23:19:32.4909117Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:681:
2025-11-09T23:19:32.4909425Z              if let Ok(Some(block)) = storage.blocks().get_block(&blockhash_array) {
2025-11-09T23:19:32.4909605Z                  // Calculate merkle root from block
2025-11-09T23:19:32.4909833Z                  use bllvm_protocol::mining::calculate_merkle_root;
2025-11-09T23:19:32.4910144Z -                let calculated_root = calculate_merkle_root(&block.transactions)
2025-11-09T23:19:32.4910959Z -                    .map_err(|e| RpcError::internal_error(format!("Failed to calculate merkle root: {}", e)))?;
2025-11-09T23:19:32.4911363Z +                let calculated_root = calculate_merkle_root(&block.transactions).map_err(|e| {
2025-11-09T23:19:32.4911733Z +                    RpcError::internal_error(format!("Failed to calculate merkle root: {}", e))
2025-11-09T23:19:32.4911850Z +                })?;
2025-11-09T23:19:32.4911963Z  
2025-11-09T23:19:32.4912358Z                  // Verify proof by reconstructing root (simplified - would need txids from proof)
2025-11-09T23:19:32.4912641Z                  // For now, just verify the block's merkle root matches the header
2025-11-09T23:19:32.4913103Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:690:
2025-11-09T23:19:32.4913213Z  
2025-11-09T23:19:32.4913921Z                  // Extract transaction IDs from proof (simplified - full implementation would decode txids)
2025-11-09T23:19:32.4914117Z                  use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:19:32.4914499Z -                let txids: Vec<String> = block.transactions.iter()
2025-11-09T23:19:32.4914654Z +                let txids: Vec<String> = block
2025-11-09T23:19:32.4914775Z +                    .transactions
2025-11-09T23:19:32.4914885Z +                    .iter()
2025-11-09T23:19:32.4915064Z                      .map(|tx| hex::encode(calculate_tx_id(tx)))
2025-11-09T23:19:32.4915176Z                      .collect();
2025-11-09T23:19:32.4915273Z  
2025-11-09T23:19:32.4915677Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:703:
2025-11-09T23:19:32.4915874Z                  Err(RpcError::invalid_params("Block not found"))
2025-11-09T23:19:32.4915986Z              }
2025-11-09T23:19:32.4916087Z          } else {
2025-11-09T23:19:32.4916406Z -            Err(RpcError::invalid_params("RPC not initialized with dependencies"))
2025-11-09T23:19:32.4916549Z +            Err(RpcError::invalid_params(
2025-11-09T23:19:32.4916714Z +                "RPC not initialized with dependencies",
2025-11-09T23:19:32.4916822Z +            ))
2025-11-09T23:19:32.4916926Z          }
2025-11-09T23:19:32.4917027Z      }
2025-11-09T23:19:32.4917125Z  }
2025-11-09T23:19:32.4974202Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:54:
2025-11-09T23:19:32.4974518Z      }
2025-11-09T23:19:32.4974642Z  
2025-11-09T23:19:32.4974846Z      /// Create a new RPC server with authentication
2025-11-09T23:19:32.4974983Z -    pub fn with_auth(
2025-11-09T23:19:32.4975118Z -        addr: SocketAddr,
2025-11-09T23:19:32.4975326Z -        auth_manager: Arc<auth::RpcAuthManager>,
2025-11-09T23:19:32.4975681Z -    ) -> Self {
2025-11-09T23:19:32.4976082Z +    pub fn with_auth(addr: SocketAddr, auth_manager: Arc<auth::RpcAuthManager>) -> Self {
2025-11-09T23:19:32.4976213Z          Self {
2025-11-09T23:19:32.4976328Z              addr,
2025-11-09T23:19:32.4976580Z              blockchain: Arc::new(blockchain::BlockchainRpc::new()),
2025-11-09T23:19:32.4977032Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:134:
2025-11-09T23:19:32.4977209Z              control: Arc::clone(&self.control),
2025-11-09T23:19:32.4977386Z              auth_manager: self.auth_manager.clone(),
2025-11-09T23:19:32.4977501Z          });
2025-11-09T23:19:32.4977619Z -        
2025-11-09T23:19:32.4977730Z +
2025-11-09T23:19:32.4977847Z          loop {
2025-11-09T23:19:32.4978010Z              match listener.accept().await {
2025-11-09T23:19:32.4978162Z                  Ok((stream, addr)) => {
2025-11-09T23:19:32.4978610Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:141:
2025-11-09T23:19:32.4978806Z                      debug!("New RPC connection from {}", addr);
2025-11-09T23:19:32.4978972Z                      let peer_addr = addr;
2025-11-09T23:19:32.4979136Z                      let server = Arc::clone(&server);
2025-11-09T23:19:32.4979252Z -                    
2025-11-09T23:19:32.4979370Z +
2025-11-09T23:19:32.4979535Z                      // Spawn task to handle connection
2025-11-09T23:19:32.4979692Z                      tokio::spawn(async move {
2025-11-09T23:19:32.4980004Z                          // Use hyper for HTTP - it will handle protocol detection and parsing
2025-11-09T23:19:32.4980450Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:148:
2025-11-09T23:19:32.4980611Z                          let io = TokioIo::new(stream);
2025-11-09T23:19:32.4980777Z                          let service = service_fn(move |req| {
2025-11-09T23:19:32.4981493Z -                            Self::handle_http_request_with_server(Arc::clone(&server), req, peer_addr)
2025-11-09T23:19:32.4981701Z +                            Self::handle_http_request_with_server(
2025-11-09T23:19:32.4982045Z +                                Arc::clone(&server),
2025-11-09T23:19:32.4982179Z +                                req,
2025-11-09T23:19:32.4982314Z +                                peer_addr,
2025-11-09T23:19:32.4982428Z +                            )
2025-11-09T23:19:32.4982548Z                          });
2025-11-09T23:19:32.4982665Z -                        
2025-11-09T23:19:32.4982770Z +
2025-11-09T23:19:32.4982918Z                          // Try to serve as HTTP
2025-11-09T23:19:32.4983108Z -                        if let Err(e) = http1::Builder::new()
2025-11-09T23:19:32.4983266Z -                            .serve_connection(io, service)
2025-11-09T23:19:32.4983385Z -                            .await
2025-11-09T23:19:32.4983514Z -                        {
2025-11-09T23:19:32.4984478Z +                        if let Err(e) = http1::Builder::new().serve_connection(io, service).await {
2025-11-09T23:19:32.4984707Z                              // If hyper fails, it might be raw TCP
2025-11-09T23:19:32.4985011Z                              // But we can't recover here since hyper consumed the connection
2025-11-09T23:19:32.4985329Z                              // For now, log and continue - raw TCP support would need separate port
2025-11-09T23:19:32.4985792Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:161:
2025-11-09T23:19:32.4986163Z -                            debug!("HTTP connection failed from {} (might be raw TCP): {}", peer_addr, e);
2025-11-09T23:19:32.4986303Z +                            debug!(
2025-11-09T23:19:32.4986551Z +                                "HTTP connection failed from {} (might be raw TCP): {}",
2025-11-09T23:19:32.4986698Z +                                peer_addr, e
2025-11-09T23:19:32.4986830Z +                            );
2025-11-09T23:19:32.4986950Z                          }
2025-11-09T23:19:32.4987303Z                      });
2025-11-09T23:19:32.4987426Z                  }
2025-11-09T23:19:32.4987883Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:185:
2025-11-09T23:19:32.4987998Z  
2025-11-09T23:19:32.4988196Z          // Extract headers before consuming request body
2025-11-09T23:19:32.4988373Z          let headers = req.headers().clone();
2025-11-09T23:19:32.4988487Z -        
2025-11-09T23:19:32.4988596Z +
2025-11-09T23:19:32.4988746Z          // Check Content-Type
2025-11-09T23:19:32.4988995Z          if let Some(content_type) = headers.get("content-type") {
2025-11-09T23:19:32.4989177Z              if content_type != "application/json" {
2025-11-09T23:19:32.4989633Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:196:
2025-11-09T23:19:32.4989805Z          // Read request body with size limit
2025-11-09T23:19:32.4989953Z          let body = req.collect().await?;
2025-11-09T23:19:32.4990123Z          let body_bytes = body.to_bytes();
2025-11-09T23:19:32.4990247Z -        
2025-11-09T23:19:32.4990357Z +
2025-11-09T23:19:32.4990517Z          // Enforce maximum request size
2025-11-09T23:19:32.4990683Z          if body_bytes.len() > MAX_REQUEST_SIZE {
2025-11-09T23:19:32.4990871Z              return Ok(Self::http_error_response(
2025-11-09T23:19:32.4991742Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:203:
2025-11-09T23:19:32.4991943Z                  StatusCode::PAYLOAD_TOO_LARGE,
2025-11-09T23:19:32.4992520Z -                &format!("Request body too large: {} bytes (max: {} bytes)", body_bytes.len(), MAX_REQUEST_SIZE),
2025-11-09T23:19:32.4992650Z +                &format!(
2025-11-09T23:19:32.4992869Z +                    "Request body too large: {} bytes (max: {} bytes)",
2025-11-09T23:19:32.4993024Z +                    body_bytes.len(),
2025-11-09T23:19:32.4993163Z +                    MAX_REQUEST_SIZE
2025-11-09T23:19:32.4993282Z +                ),
2025-11-09T23:19:32.4993408Z              ));
2025-11-09T23:19:32.4993524Z          }
2025-11-09T23:19:32.4993625Z  
2025-11-09T23:19:32.4994506Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:221:
2025-11-09T23:19:32.4994763Z          // Authenticate request if authentication is enabled
2025-11-09T23:19:32.4994978Z          if let Some(ref auth_manager) = server.auth_manager {
2025-11-09T23:19:32.4995314Z              let auth_result = auth_manager.authenticate_request(&headers, addr).await;
2025-11-09T23:19:32.4995441Z -            
2025-11-09T23:19:32.4995557Z +
2025-11-09T23:19:32.4995725Z              // Check if authentication failed
2025-11-09T23:19:32.4995903Z              if let Some(error) = auth_result.error {
2025-11-09T23:19:32.4996095Z -                return Ok(Self::http_error_response(
2025-11-09T23:19:32.4996262Z -                    StatusCode::UNAUTHORIZED,
2025-11-09T23:19:32.4996388Z -                    &error,
2025-11-09T23:19:32.4996518Z -                ));
2025-11-09T23:19:32.4996856Z +                return Ok(Self::http_error_response(StatusCode::UNAUTHORIZED, &error));
2025-11-09T23:19:32.4996981Z              }
2025-11-09T23:19:32.4997098Z  
2025-11-09T23:19:32.4997237Z              // Check rate limiting
2025-11-09T23:19:32.4997686Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:243:
2025-11-09T23:19:32.4997796Z  
2025-11-09T23:19:32.4998110Z          // Process JSON-RPC request (reuse server instance with cached handlers)
2025-11-09T23:19:32.4998430Z          let response = Self::process_request_with_server(server, &json_body).await;
2025-11-09T23:19:32.4998568Z -        let response_json =
2025-11-09T23:19:32.4998880Z -            serde_json::to_string(&response).unwrap_or_else(|_| "{}".to_string());
2025-11-09T23:19:32.4999294Z +        let response_json = serde_json::to_string(&response).unwrap_or_else(|_| "{}".to_string());
2025-11-09T23:19:32.4999408Z  
2025-11-09T23:19:32.4999551Z          // Build HTTP response
2025-11-09T23:19:32.4999962Z          Ok(Response::builder()
2025-11-09T23:19:32.5000415Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:255:
2025-11-09T23:19:32.5000552Z              .unwrap())
2025-11-09T23:19:32.5000674Z      }
2025-11-09T23:19:32.5000781Z  
2025-11-09T23:19:32.5000890Z -
2025-11-09T23:19:32.5001246Z      /// Create HTTP error response
2025-11-09T23:19:32.5001644Z      fn http_error_response(status: StatusCode, message: &str) -> Response<Full<Bytes>> {
2025-11-09T23:19:32.5001777Z          let body = json!({
2025-11-09T23:19:32.5002216Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:321:
2025-11-09T23:19:32.5002643Z      async fn call_method(&self, method: &str, params: Value) -> Result<Value, errors::RpcError> {
2025-11-09T23:19:32.5002767Z          match method {
2025-11-09T23:19:32.5002930Z              // Blockchain methods
2025-11-09T23:19:32.5003086Z -            "getblockchaininfo" => {
2025-11-09T23:19:32.5003226Z -                self.blockchain
2025-11-09T23:19:32.5003370Z -                    .get_blockchain_info()
2025-11-09T23:19:32.5003497Z -                    .await
2025-11-09T23:19:32.5003741Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:19:32.5003855Z -            }
2025-11-09T23:19:32.5004012Z +            "getblockchaininfo" => self
2025-11-09T23:19:32.5004139Z +                .blockchain
2025-11-09T23:19:32.5004459Z +                .get_blockchain_info()
2025-11-09T23:19:32.5004587Z +                .await
2025-11-09T23:19:32.5004872Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:19:32.5005004Z              "getblock" => {
2025-11-09T23:19:32.5005277Z                  let hash = params.get(0).and_then(|p| p.as_str()).unwrap_or("");
2025-11-09T23:19:32.5005426Z                  self.blockchain
2025-11-09T23:19:32.5005872Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:349:
2025-11-09T23:19:32.5006008Z                      .await
2025-11-09T23:19:32.5006275Z                      .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:19:32.5006620Z              }
2025-11-09T23:19:32.5006765Z -            "getbestblockhash" => {
2025-11-09T23:19:32.5006898Z -                self.blockchain
2025-11-09T23:19:32.5007044Z -                    .get_best_block_hash()
2025-11-09T23:19:32.5018603Z -                    .await
2025-11-09T23:19:32.5018965Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:19:32.5019090Z -            }
2025-11-09T23:19:32.5019238Z -            "getblockcount" => {
2025-11-09T23:19:32.5019388Z -                self.blockchain
2025-11-09T23:19:32.5019532Z -                    .get_block_count()
2025-11-09T23:19:32.5019659Z -                    .await
2025-11-09T23:19:32.5019940Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:19:32.5020072Z -            }
2025-11-09T23:19:32.5020220Z -            "getdifficulty" => {
2025-11-09T23:19:32.5020368Z -                self.blockchain
2025-11-09T23:19:32.5020518Z -                    .get_difficulty()
2025-11-09T23:19:32.5020637Z -                    .await
2025-11-09T23:19:32.5020892Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:19:32.5021010Z -            }
2025-11-09T23:19:32.5021149Z -            "gettxoutsetinfo" => {
2025-11-09T23:19:32.5021278Z -                self.blockchain
2025-11-09T23:19:32.5021417Z -                    .get_txoutset_info()
2025-11-09T23:19:32.5021540Z -                    .await
2025-11-09T23:19:32.5021782Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:19:32.5021890Z -            }
2025-11-09T23:19:32.5022047Z +            "getbestblockhash" => self
2025-11-09T23:19:32.5022169Z +                .blockchain
2025-11-09T23:19:32.5022570Z +                .get_best_block_hash()
2025-11-09T23:19:32.5022685Z +                .await
2025-11-09T23:19:32.5022952Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:19:32.5023105Z +            "getblockcount" => self
2025-11-09T23:19:32.5023232Z +                .blockchain
2025-11-09T23:19:32.5023368Z +                .get_block_count()
2025-11-09T23:19:32.5023481Z +                .await
2025-11-09T23:19:32.5023731Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:19:32.5023879Z +            "getdifficulty" => self
2025-11-09T23:19:32.5024002Z +                .blockchain
2025-11-09T23:19:32.5024132Z +                .get_difficulty()
2025-11-09T23:19:32.5024242Z +                .await
2025-11-09T23:19:32.5024667Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:19:32.5024814Z +            "gettxoutsetinfo" => self
2025-11-09T23:19:32.5024937Z +                .blockchain
2025-11-09T23:19:32.5025096Z +                .get_txoutset_info()
2025-11-09T23:19:32.5025217Z +                .await
2025-11-09T23:19:32.5025493Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:19:32.5025634Z              "verifychain" => {
2025-11-09T23:19:32.5025893Z                  let checklevel = params.get(0).and_then(|p| p.as_u64());
2025-11-09T23:19:32.5026133Z                  let numblocks = params.get(1).and_then(|p| p.as_u64());
2025-11-09T23:19:32.5026603Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:381:
2025-11-09T23:19:32.5026747Z                      .await
2025-11-09T23:19:32.5027023Z                      .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:19:32.5027140Z              }
2025-11-09T23:19:32.5027291Z -            "getchaintips" => {
2025-11-09T23:19:32.5027426Z -                self.blockchain
2025-11-09T23:19:32.5027568Z -                    .get_chain_tips()
2025-11-09T23:19:32.5027701Z -                    .await
2025-11-09T23:19:32.5027985Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:19:32.5028350Z -            }
2025-11-09T23:19:32.5028505Z -            "getchaintxstats" => {
2025-11-09T23:19:32.5030503Z -                self.blockchain
2025-11-09T23:19:32.5030670Z -                    .get_chain_tx_stats(&params)
2025-11-09T23:19:32.5031312Z -                    .await
2025-11-09T23:19:32.5031635Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:19:32.5031768Z -            }
2025-11-09T23:19:32.5032004Z -            "getblockstats" => {
2025-11-09T23:19:32.5032147Z -                self.blockchain
2025-11-09T23:19:32.5032317Z -                    .get_block_stats(&params)
2025-11-09T23:19:32.5032440Z -                    .await
2025-11-09T23:19:32.5032710Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:19:32.5032852Z -            }
2025-11-09T23:19:32.5033003Z -            "pruneblockchain" => {
2025-11-09T23:19:32.5033141Z -                self.blockchain
2025-11-09T23:19:32.5033308Z -                    .prune_blockchain(&params)
2025-11-09T23:19:32.5033442Z -                    .await
2025-11-09T23:19:32.5033705Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:19:32.5033825Z -            }
2025-11-09T23:19:32.5033981Z -            "getpruneinfo" => {
2025-11-09T23:19:32.5034116Z -                self.blockchain
2025-11-09T23:19:32.5034273Z -                    .get_prune_info(&params)
2025-11-09T23:19:32.5034555Z -                    .await
2025-11-09T23:19:32.5034831Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:19:32.5034950Z -            }
2025-11-09T23:19:32.5035098Z -            "invalidateblock" => {
2025-11-09T23:19:32.5035240Z -                self.blockchain
2025-11-09T23:19:32.5035403Z -                    .invalidate_block(&params)
2025-11-09T23:19:32.5035762Z -                    .await
2025-11-09T23:19:32.5036029Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:19:32.5036163Z -            }
2025-11-09T23:19:32.5036305Z -            "reconsiderblock" => {
2025-11-09T23:19:32.5036441Z -                self.blockchain
2025-11-09T23:19:32.5036609Z -                    .reconsider_block(&params)
2025-11-09T23:19:32.5036732Z -                    .await
2025-11-09T23:19:32.5036991Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:19:32.5037116Z -            }
2025-11-09T23:19:32.5037263Z -            "waitfornewblock" => {
2025-11-09T23:19:32.5037395Z -                self.blockchain
2025-11-09T23:19:32.5037555Z -                    .wait_for_new_block(&params)
2025-11-09T23:19:32.5037689Z -                    .await
2025-11-09T23:19:32.5037948Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:19:32.5038080Z -            }
2025-11-09T23:19:32.5038228Z -            "waitforblock" => {
2025-11-09T23:19:32.5038368Z -                self.blockchain
2025-11-09T23:19:32.5038526Z -                    .wait_for_block(&params)
2025-11-09T23:19:32.5038649Z -                    .await
2025-11-09T23:19:32.5040796Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:19:32.5040913Z -            }
2025-11-09T23:19:32.5041076Z -            "waitforblockheight" => {
2025-11-09T23:19:32.5041224Z -                self.blockchain
2025-11-09T23:19:32.5041399Z -                    .wait_for_block_height(&params)
2025-11-09T23:19:32.5041521Z -                    .await
2025-11-09T23:19:32.5041784Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:19:32.5041912Z -            }
2025-11-09T23:19:32.5042057Z +            "getchaintips" => self
2025-11-09T23:19:32.5042185Z +                .blockchain
2025-11-09T23:19:32.5042340Z +                .get_chain_tips()
2025-11-09T23:19:32.5042460Z +                .await
2025-11-09T23:19:32.5042944Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:19:32.5043103Z +            "getchaintxstats" => self
2025-11-09T23:19:32.5043245Z +                .blockchain
2025-11-09T23:19:32.5043405Z +                .get_chain_tx_stats(&params)
2025-11-09T23:19:32.5043525Z +                .await
2025-11-09T23:19:32.5043799Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:19:32.5043942Z +            "getblockstats" => self
2025-11-09T23:19:32.5044070Z +                .blockchain
2025-11-09T23:19:32.5044230Z +                .get_block_stats(&params)
2025-11-09T23:19:32.5044499Z +                .await
2025-11-09T23:19:32.5044774Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:19:32.5044931Z +            "pruneblockchain" => self
2025-11-09T23:19:32.5045079Z +                .blockchain
2025-11-09T23:19:32.5045236Z +                .prune_blockchain(&params)
2025-11-09T23:19:32.5045365Z +                .await
2025-11-09T23:19:32.5045631Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:19:32.5045773Z +            "getpruneinfo" => self
2025-11-09T23:19:32.5045900Z +                .blockchain
2025-11-09T23:19:32.5046048Z +                .get_prune_info(&params)
2025-11-09T23:19:32.5046183Z +                .await
2025-11-09T23:19:32.5046439Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:19:32.5046595Z +            "invalidateblock" => self
2025-11-09T23:19:32.5046732Z +                .blockchain
2025-11-09T23:19:32.5046884Z +                .invalidate_block(&params)
2025-11-09T23:19:32.5047001Z +                .await
2025-11-09T23:19:32.5047251Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:19:32.5047627Z +            "reconsiderblock" => self
2025-11-09T23:19:32.5047758Z +                .blockchain
2025-11-09T23:19:32.5047912Z +                .reconsider_block(&params)
2025-11-09T23:19:32.5048049Z +                .await
2025-11-09T23:19:32.5048312Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:19:32.5048461Z +            "waitfornewblock" => self
2025-11-09T23:19:32.5048592Z +                .blockchain
2025-11-09T23:19:32.5048751Z +                .wait_for_new_block(&params)
2025-11-09T23:19:32.5048871Z +                .await
2025-11-09T23:19:32.5049120Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:19:32.5049270Z +            "waitforblock" => self
2025-11-09T23:19:32.5049398Z +                .blockchain
2025-11-09T23:19:32.5049542Z +                .wait_for_block(&params)
2025-11-09T23:19:32.5049660Z +                .await
2025-11-09T23:19:32.5049899Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:19:32.5050056Z +            "waitforblockheight" => self
2025-11-09T23:19:32.5050174Z +                .blockchain
2025-11-09T23:19:32.5050340Z +                .wait_for_block_height(&params)
2025-11-09T23:19:32.5050822Z +                .await
2025-11-09T23:19:32.5051074Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:19:32.5051187Z  
2025-11-09T23:19:32.5051334Z              // Raw Transaction methods
2025-11-09T23:19:32.5051488Z -            "getrawtransaction" => {
2025-11-09T23:19:32.5051694Z -                self.rawtx.getrawtransaction(&params).await
2025-11-09T23:19:32.5051812Z -            }
2025-11-09T23:19:32.5051960Z -            "sendrawtransaction" => {
2025-11-09T23:19:32.5052168Z -                self.rawtx.sendrawtransaction(&params).await
2025-11-09T23:19:32.5052291Z -            }
2025-11-09T23:19:32.5052446Z -            "testmempoolaccept" => {
2025-11-09T23:19:32.5052655Z -                self.rawtx.testmempoolaccept(&params).await
2025-11-09T23:19:32.5052787Z -            }
2025-11-09T23:19:32.5052940Z -            "decoderawtransaction" => {
2025-11-09T23:19:32.5053381Z -                self.rawtx.decoderawtransaction(&params).await
2025-11-09T23:19:32.5053492Z -            }
2025-11-09T23:19:32.5053627Z -            "gettxout" => {
2025-11-09T23:19:32.5053794Z -                self.rawtx.gettxout(&params).await
2025-11-09T23:19:32.5053907Z -            }
2025-11-09T23:19:32.5054060Z -            "gettxoutproof" => {
2025-11-09T23:19:32.5054256Z -                self.rawtx.gettxoutproof(&params).await
2025-11-09T23:19:32.5054527Z -            }
2025-11-09T23:19:32.5054683Z -            "verifytxoutproof" => {
2025-11-09T23:19:32.5054897Z -                self.rawtx.verifytxoutproof(&params).await
2025-11-09T23:19:32.5055012Z -            }
2025-11-09T23:19:32.5055354Z +            "getrawtransaction" => self.rawtx.getrawtransaction(&params).await,
2025-11-09T23:19:32.5055714Z +            "sendrawtransaction" => self.rawtx.sendrawtransaction(&params).await,
2025-11-09T23:19:32.5056060Z +            "testmempoolaccept" => self.rawtx.testmempoolaccept(&params).await,
2025-11-09T23:19:32.5056449Z +            "decoderawtransaction" => self.rawtx.decoderawtransaction(&params).await,
2025-11-09T23:19:32.5056672Z +            "gettxout" => self.rawtx.gettxout(&params).await,
2025-11-09T23:19:32.5056943Z +            "gettxoutproof" => self.rawtx.gettxoutproof(&params).await,
2025-11-09T23:19:32.5057261Z +            "verifytxoutproof" => self.rawtx.verifytxoutproof(&params).await,
2025-11-09T23:19:32.5057375Z  
2025-11-09T23:19:32.5057525Z              // Mempool methods
2025-11-09T23:19:32.5057668Z -            "getmempoolinfo" => {
2025-11-09T23:19:32.5057866Z -                self.mempool.getmempoolinfo(&params).await
2025-11-09T23:19:32.5057994Z -            }
2025-11-09T23:19:32.5058132Z -            "getrawmempool" => {
2025-11-09T23:19:32.5058334Z -                self.mempool.getrawmempool(&params).await
2025-11-09T23:19:32.5058716Z -            }
2025-11-09T23:19:32.5060630Z -            "savemempool" => {
2025-11-09T23:19:32.5060840Z -                self.mempool.savemempool(&params).await
2025-11-09T23:19:32.5060958Z -            }
2025-11-09T23:19:32.5061127Z -            "getmempoolancestors" => {
2025-11-09T23:19:32.5061363Z -                self.mempool.getmempoolancestors(&params).await
2025-11-09T23:19:32.5061483Z -            }
2025-11-09T23:19:32.5061652Z -            "getmempooldescendants" => {
2025-11-09T23:19:32.5061911Z -                self.mempool.getmempooldescendants(&params).await
2025-11-09T23:19:32.5062030Z -            }
2025-11-09T23:19:32.5062174Z -            "getmempoolentry" => {
2025-11-09T23:19:32.5062403Z -                self.mempool.getmempoolentry(&params).await
2025-11-09T23:19:32.5062518Z -            }
2025-11-09T23:19:32.5062821Z +            "getmempoolinfo" => self.mempool.getmempoolinfo(&params).await,
2025-11-09T23:19:32.5063120Z +            "getrawmempool" => self.mempool.getrawmempool(&params).await,
2025-11-09T23:19:32.5063395Z +            "savemempool" => self.mempool.savemempool(&params).await,
2025-11-09T23:19:32.5063776Z +            "getmempoolancestors" => self.mempool.getmempoolancestors(&params).await,
2025-11-09T23:19:32.5064179Z +            "getmempooldescendants" => self.mempool.getmempooldescendants(&params).await,
2025-11-09T23:19:32.5064648Z +            "getmempoolentry" => self.mempool.getmempoolentry(&params).await,
2025-11-09T23:19:32.5064768Z  
2025-11-09T23:19:32.5064909Z              // Network methods
2025-11-09T23:19:32.5065068Z -            "getnetworkinfo" => {
2025-11-09T23:19:32.5065241Z -                self.network.get_network_info().await
2025-11-09T23:19:32.5065357Z -            }
2025-11-09T23:19:32.5065504Z -            "getpeerinfo" => {
2025-11-09T23:19:32.5065662Z -                self.network.get_peer_info().await
2025-11-09T23:19:32.5065781Z -            }
2025-11-09T23:19:32.5065938Z -            "getconnectioncount" => {
2025-11-09T23:19:32.5066184Z -                self.network.get_connection_count(&params).await
2025-11-09T23:19:32.5066301Z -            }
2025-11-09T23:19:32.5066662Z -            "ping" => {
2025-11-09T23:19:32.5066854Z -                self.network.ping(&params).await
2025-11-09T23:19:32.5066971Z -            }
2025-11-09T23:19:32.5067102Z -            "addnode" => {
2025-11-09T23:19:32.5067276Z -                self.network.add_node(&params).await
2025-11-09T23:19:32.5067404Z -            }
2025-11-09T23:19:32.5067549Z -            "disconnectnode" => {
2025-11-09T23:19:32.5067758Z -                self.network.disconnect_node(&params).await
2025-11-09T23:19:32.5067882Z -            }
2025-11-09T23:19:32.5068021Z -            "getnettotals" => {
2025-11-09T23:19:32.5068218Z -                self.network.get_net_totals(&params).await
2025-11-09T23:19:32.5068333Z -            }
2025-11-09T23:19:32.5068476Z -            "clearbanned" => {
2025-11-09T23:19:32.5070554Z -                self.network.clear_banned(&params).await
2025-11-09T23:19:32.5070678Z -            }
2025-11-09T23:19:32.5070815Z -            "setban" => {
2025-11-09T23:19:32.5071000Z -                self.network.set_ban(&params).await
2025-11-09T23:19:32.5071118Z -            }
2025-11-09T23:19:32.5071255Z -            "listbanned" => {
2025-11-09T23:19:32.5071445Z -                self.network.list_banned(&params).await
2025-11-09T23:19:32.5071565Z -            }
2025-11-09T23:19:32.5071713Z -            "getaddednodeinfo" => {
2025-11-09T23:19:32.5071937Z -                self.network.getaddednodeinfo(&params).await
2025-11-09T23:19:32.5072046Z -            }
2025-11-09T23:19:32.5072188Z -            "getnodeaddresses" => {
2025-11-09T23:19:32.5072401Z -                self.network.getnodeaddresses(&params).await
2025-11-09T23:19:32.5072526Z -            }
2025-11-09T23:19:32.5072668Z -            "setnetworkactive" => {
2025-11-09T23:19:32.5072876Z -                self.network.setnetworkactive(&params).await
2025-11-09T23:19:32.5072999Z -            }
2025-11-09T23:19:32.5073538Z +            "getnetworkinfo" => self.network.get_network_info().await,
2025-11-09T23:19:32.5073785Z +            "getpeerinfo" => self.network.get_peer_info().await,
2025-11-09T23:19:32.5074154Z +            "getconnectioncount" => self.network.get_connection_count(&params).await,
2025-11-09T23:19:32.5074561Z +            "ping" => self.network.ping(&params).await,
2025-11-09T23:19:32.5074787Z +            "addnode" => self.network.add_node(&params).await,
2025-11-09T23:19:32.5075097Z +            "disconnectnode" => self.network.disconnect_node(&params).await,
2025-11-09T23:19:32.5075388Z +            "getnettotals" => self.network.get_net_totals(&params).await,
2025-11-09T23:19:32.5075649Z +            "clearbanned" => self.network.clear_banned(&params).await,
2025-11-09T23:19:32.5075856Z +            "setban" => self.network.set_ban(&params).await,
2025-11-09T23:19:32.5076106Z +            "listbanned" => self.network.list_banned(&params).await,
2025-11-09T23:19:32.5076448Z +            "getaddednodeinfo" => self.network.getaddednodeinfo(&params).await,
2025-11-09T23:19:32.5076778Z +            "getnodeaddresses" => self.network.getnodeaddresses(&params).await,
2025-11-09T23:19:32.5077108Z +            "setnetworkactive" => self.network.setnetworkactive(&params).await,
2025-11-09T23:19:32.5077221Z  
2025-11-09T23:19:32.5077351Z              // Mining methods
2025-11-09T23:19:32.5077487Z -            "getmininginfo" => {
2025-11-09T23:19:32.5077660Z -                self.mining.get_mining_info().await
2025-11-09T23:19:32.5077769Z -            }
2025-11-09T23:19:32.5077908Z -            "getblocktemplate" => {
2025-11-09T23:19:32.5078114Z -                self.mining.get_block_template(&params).await
2025-11-09T23:19:32.5078222Z -            }
2025-11-09T23:19:32.5078352Z -            "submitblock" => {
2025-11-09T23:19:32.5078528Z -                self.mining.submit_block(&params).await
2025-11-09T23:19:32.5078643Z -            }
2025-11-09T23:19:32.5078789Z -            "estimatesmartfee" => {
2025-11-09T23:19:32.5079003Z -                self.mining.estimate_smart_fee(&params).await
2025-11-09T23:19:32.5079325Z -            }
2025-11-09T23:19:32.5079489Z -            "prioritisetransaction" => {
2025-11-09T23:19:32.5079711Z -                self.mining.prioritise_transaction(&params).await
2025-11-09T23:19:32.5079827Z -            }
2025-11-09T23:19:32.5079964Z -            "getblockfilter" => {
2025-11-09T23:19:32.5080094Z -                self.blockchain
2025-11-09T23:19:32.5080245Z -                    .get_block_filter(&params)
2025-11-09T23:19:32.5080367Z -                    .await
2025-11-09T23:19:32.5083028Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:19:32.5083146Z -            }
2025-11-09T23:19:32.5083283Z -            "getindexinfo" => {
2025-11-09T23:19:32.5083410Z -                self.blockchain
2025-11-09T23:19:32.5083556Z -                    .get_index_info(&params)
2025-11-09T23:19:32.5083673Z -                    .await
2025-11-09T23:19:32.5083945Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:19:32.5084064Z -            }
2025-11-09T23:19:32.5084451Z +            "getmininginfo" => self.mining.get_mining_info().await,
2025-11-09T23:19:32.5084797Z +            "getblocktemplate" => self.mining.get_block_template(&params).await,
2025-11-09T23:19:32.5085048Z +            "submitblock" => self.mining.submit_block(&params).await,
2025-11-09T23:19:32.5085359Z +            "estimatesmartfee" => self.mining.estimate_smart_fee(&params).await,
2025-11-09T23:19:32.5085738Z +            "prioritisetransaction" => self.mining.prioritise_transaction(&params).await,
2025-11-09T23:19:32.5085882Z +            "getblockfilter" => self
2025-11-09T23:19:32.5086009Z +                .blockchain
2025-11-09T23:19:32.5086162Z +                .get_block_filter(&params)
2025-11-09T23:19:32.5086283Z +                .await
2025-11-09T23:19:32.5086548Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:19:32.5086949Z +            "getindexinfo" => self
2025-11-09T23:19:32.5087094Z +                .blockchain
2025-11-09T23:19:32.5087249Z +                .get_index_info(&params)
2025-11-09T23:19:32.5087370Z +                .await
2025-11-09T23:19:32.5087650Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:19:32.5087768Z  
2025-11-09T23:19:32.5087905Z              // Control methods
2025-11-09T23:19:32.5088045Z -            "stop" => {
2025-11-09T23:19:32.5088222Z -                self.control.stop(&params).await
2025-11-09T23:19:32.5088339Z -            }
2025-11-09T23:19:32.5088472Z -            "uptime" => {
2025-11-09T23:19:32.5088658Z -                self.control.uptime(&params).await
2025-11-09T23:19:32.5088776Z -            }
2025-11-09T23:19:32.5088918Z -            "getmemoryinfo" => {
2025-11-09T23:19:32.5089125Z -                self.control.getmemoryinfo(&params).await
2025-11-09T23:19:32.5089253Z -            }
2025-11-09T23:19:32.5089388Z -            "getrpcinfo" => {
2025-11-09T23:19:32.5089574Z -                self.control.getrpcinfo(&params).await
2025-11-09T23:19:32.5089702Z -            }
2025-11-09T23:19:32.5089826Z -            "help" => {
2025-11-09T23:19:32.5089992Z -                self.control.help(&params).await
2025-11-09T23:19:32.5090117Z -            }
2025-11-09T23:19:32.5090248Z -            "logging" => {
2025-11-09T23:19:32.5090422Z -                self.control.logging(&params).await
2025-11-09T23:19:32.5092533Z -            }
2025-11-09T23:19:32.5092664Z -            "gethealth" => {
2025-11-09T23:19:32.5092845Z -                self.control.gethealth(&params).await
2025-11-09T23:19:32.5092959Z -            }
2025-11-09T23:19:32.5093102Z -            "getmetrics" => {
2025-11-09T23:19:32.5093283Z -                self.control.getmetrics(&params).await
2025-11-09T23:19:32.5093402Z -            }
2025-11-09T23:19:32.5093601Z +            "stop" => self.control.stop(&params).await,
2025-11-09T23:19:32.5093821Z +            "uptime" => self.control.uptime(&params).await,
2025-11-09T23:19:32.5094103Z +            "getmemoryinfo" => self.control.getmemoryinfo(&params).await,
2025-11-09T23:19:32.5094833Z +            "getrpcinfo" => self.control.getrpcinfo(&params).await,
2025-11-09T23:19:32.5095036Z +            "help" => self.control.help(&params).await,
2025-11-09T23:19:32.5095250Z +            "logging" => self.control.logging(&params).await,
2025-11-09T23:19:32.5095483Z +            "gethealth" => self.control.gethealth(&params).await,
2025-11-09T23:19:32.5095731Z +            "getmetrics" => self.control.getmetrics(&params).await,
2025-11-09T23:19:32.5095843Z  
2025-11-09T23:19:32.5096070Z              _ => Err(errors::RpcError::method_not_found(method)),
2025-11-09T23:19:32.5096194Z          }
2025-11-09T23:19:32.5096642Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:605:
2025-11-09T23:19:32.5096799Z          // Start server on random port
2025-11-09T23:19:32.5097134Z          let listener = tokio::net::TcpListener::bind("127.0.0.1:0").await.unwrap();
2025-11-09T23:19:32.5097343Z          let server_addr = listener.local_addr().unwrap();
2025-11-09T23:19:32.5097450Z -        
2025-11-09T23:19:32.5097555Z +
2025-11-09T23:19:32.5097722Z          // Spawn server task using hyper
2025-11-09T23:19:32.5097913Z          let server_handle = tokio::spawn(async move {
2025-11-09T23:19:32.5098035Z              loop {
2025-11-09T23:19:32.5098457Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:617:
2025-11-09T23:19:32.5098634Z                              let service = service_fn(move |req| {
2025-11-09T23:19:32.5098854Z                                  RpcServer::handle_http_request(req, peer_addr)
2025-11-09T23:19:32.5098983Z                              });
2025-11-09T23:19:32.5099164Z -                            let _ = http1::Builder::new()
2025-11-09T23:19:32.5099336Z -                                .serve_connection(io, service)
2025-11-09T23:19:32.5099682Z -                                .await;
2025-11-09T23:19:32.5099972Z +                            let _ = http1::Builder::new().serve_connection(io, service).await;
2025-11-09T23:19:32.5100110Z                          });
2025-11-09T23:19:32.5100227Z                      }
2025-11-09T23:19:32.5100364Z                      Err(_) => break,
2025-11-09T23:19:32.5100799Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:632:
2025-11-09T23:19:32.5100909Z  
2025-11-09T23:19:32.5102729Z          // Connect to server
2025-11-09T23:19:32.5103057Z          let mut client = TokioTcpStream::connect(server_addr).await.unwrap();
2025-11-09T23:19:32.5103174Z -        
2025-11-09T23:19:32.5103286Z +
2025-11-09T23:19:32.5103438Z          // Send HTTP POST request
2025-11-09T23:19:32.5103722Z          let json_body = r#"{"jsonrpc":"2.0","method":"ping","params":[],"id":1}"#;
2025-11-09T23:19:32.5103866Z          let http_request = format!(
2025-11-09T23:19:32.5104307Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:645:
2025-11-09T23:19:32.5104606Z              json_body.len(),
2025-11-09T23:19:32.5104725Z              json_body
2025-11-09T23:19:32.5104838Z          );
2025-11-09T23:19:32.5104958Z -        
2025-11-09T23:19:32.5105066Z +
2025-11-09T23:19:32.5105307Z          client.write_all(http_request.as_bytes()).await.unwrap();
2025-11-09T23:19:32.5105413Z -        
2025-11-09T23:19:32.5105518Z +
2025-11-09T23:19:32.5105634Z          // Read response
2025-11-09T23:19:32.5105775Z          let mut response = vec![0u8; 4096];
2025-11-09T23:19:32.5105938Z          let n = tokio::time::timeout(
2025-11-09T23:19:32.5106904Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:654:
2025-11-09T23:19:32.5107098Z              tokio::time::Duration::from_secs(2),
2025-11-09T23:19:32.5107253Z -            client.read(&mut response)
2025-11-09T23:19:32.5107410Z -        ).await.unwrap().unwrap();
2025-11-09T23:19:32.5107535Z -        
2025-11-09T23:19:32.5107691Z +            client.read(&mut response),
2025-11-09T23:19:32.5108079Z +        )
2025-11-09T23:19:32.5108202Z +        .await
2025-11-09T23:19:32.5108319Z +        .unwrap()
2025-11-09T23:19:32.5108433Z +        .unwrap();
2025-11-09T23:19:32.5108553Z +
2025-11-09T23:19:32.5108828Z          let response_str = String::from_utf8_lossy(&response[..n]);
2025-11-09T23:19:32.5108940Z -        
2025-11-09T23:19:32.5109061Z +
2025-11-09T23:19:32.5109282Z          // Verify HTTP response (hyper uses lowercase headers)
2025-11-09T23:19:32.5111862Z -        assert!(response_str.contains("HTTP/1.1 200 OK") || response_str.contains("200 OK"), "Response: {}", response_str);
2025-11-09T23:19:32.5112531Z -        assert!(response_str.contains("content-type: application/json") || response_str.contains("Content-Type: application/json"));
2025-11-09T23:19:32.5112656Z +        assert!(
2025-11-09T23:19:32.5113006Z +            response_str.contains("HTTP/1.1 200 OK") || response_str.contains("200 OK"),
2025-11-09T23:19:32.5113158Z +            "Response: {}",
2025-11-09T23:19:32.5113305Z +            response_str
2025-11-09T23:19:32.5113420Z +        );
2025-11-09T23:19:32.5113537Z +        assert!(
2025-11-09T23:19:32.5113805Z +            response_str.contains("content-type: application/json")
2025-11-09T23:19:32.5114059Z +                || response_str.contains("Content-Type: application/json")
2025-11-09T23:19:32.5114174Z +        );
2025-11-09T23:19:32.5114535Z          assert!(response_str.contains("jsonrpc"));
2025-11-09T23:19:32.5114749Z          assert!(response_str.contains("\"result\""));
2025-11-09T23:19:32.5114864Z -        
2025-11-09T23:19:32.5114975Z +
2025-11-09T23:19:32.5115127Z          server_handle.abort();
2025-11-09T23:19:32.5115239Z      }
2025-11-09T23:19:32.5115350Z  
2025-11-09T23:19:32.5115797Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:669:
2025-11-09T23:19:32.5116161Z -
2025-11-09T23:19:32.5116306Z      #[tokio::test]
2025-11-09T23:19:32.5116491Z      async fn test_process_request_valid_json() {
2025-11-09T23:19:32.5116853Z          let request = r#"{"jsonrpc":"2.0","method":"getblockchaininfo","params":[],"id":1}"#;
2025-11-09T23:19:32.5117295Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:684:
2025-11-09T23:19:32.5117406Z  
2025-11-09T23:19:32.5117581Z          assert_eq!(response["jsonrpc"], "2.0");
2025-11-09T23:19:32.5117782Z          assert_eq!(response["error"]["code"], -32700);
2025-11-09T23:19:32.5118127Z -        assert!(response["error"]["message"].as_str().unwrap().contains("Parse error") || 
2025-11-09T23:19:32.5118446Z -                response["error"]["message"].as_str().unwrap().contains("Invalid JSON"));
2025-11-09T23:19:32.5118573Z +        assert!(
2025-11-09T23:19:32.5118725Z +            response["error"]["message"]
2025-11-09T23:19:32.5118851Z +                .as_str()
2025-11-09T23:19:32.5118982Z +                .unwrap()
2025-11-09T23:19:32.5119139Z +                .contains("Parse error")
2025-11-09T23:19:32.5119297Z +                || response["error"]["message"]
2025-11-09T23:19:32.5119439Z +                    .as_str()
2025-11-09T23:19:32.5119562Z +                    .unwrap()
2025-11-09T23:19:32.5119717Z +                    .contains("Invalid JSON")
2025-11-09T23:19:32.5119830Z +        );
2025-11-09T23:19:32.5119949Z      }
2025-11-09T23:19:32.5120059Z  
2025-11-09T23:19:32.5120193Z      #[tokio::test]
2025-11-09T23:19:32.5120645Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:695:
2025-11-09T23:19:32.5120768Z  
2025-11-09T23:19:32.5120929Z          assert_eq!(response["jsonrpc"], "2.0");
2025-11-09T23:19:32.5121118Z          assert_eq!(response["error"]["code"], -32601);
2025-11-09T23:19:32.5121487Z -        assert!(response["error"]["message"].as_str().unwrap().contains("Method not found"));
2025-11-09T23:19:32.5121647Z +        assert!(response["error"]["message"]
2025-11-09T23:19:32.5121773Z +            .as_str()
2025-11-09T23:19:32.5121896Z +            .unwrap()
2025-11-09T23:19:32.5122302Z +            .contains("Method not found"));
2025-11-09T23:19:32.5122450Z          assert_eq!(response["id"], 1);
2025-11-09T23:19:32.5122559Z      }
2025-11-09T23:19:32.5122674Z  
2025-11-09T23:19:32.5123108Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:822:
2025-11-09T23:19:32.5123223Z  
2025-11-09T23:19:32.5123398Z          assert_eq!(response["jsonrpc"], "2.0");
2025-11-09T23:19:32.5123593Z          assert_eq!(response["error"]["code"], -32700);
2025-11-09T23:19:32.5123944Z -        assert!(response["error"]["message"].as_str().unwrap().contains("Parse error") ||
2025-11-09T23:19:32.5124249Z -                response["error"]["message"].as_str().unwrap().contains("Invalid JSON"));
2025-11-09T23:19:32.5124550Z +        assert!(
2025-11-09T23:19:32.5124709Z +            response["error"]["message"]
2025-11-09T23:19:32.5124843Z +                .as_str()
2025-11-09T23:19:32.5124974Z +                .unwrap()
2025-11-09T23:19:32.5125121Z +                .contains("Parse error")
2025-11-09T23:19:32.5125286Z +                || response["error"]["message"]
2025-11-09T23:19:32.5125415Z +                    .as_str()
2025-11-09T23:19:32.5125540Z +                    .unwrap()
2025-11-09T23:19:32.5125693Z +                    .contains("Invalid JSON")
2025-11-09T23:19:32.5125808Z +        );
2025-11-09T23:19:32.5125934Z      }
2025-11-09T23:19:32.5126044Z  
2025-11-09T23:19:32.5126177Z      #[tokio::test]
2025-11-09T23:19:32.5126618Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:833:
2025-11-09T23:19:32.5126731Z  
2025-11-09T23:19:32.5126891Z          assert_eq!(response["jsonrpc"], "2.0");
2025-11-09T23:19:32.5127079Z          assert_eq!(response["error"]["code"], -32601);
2025-11-09T23:19:32.5127443Z -        assert!(response["error"]["message"].as_str().unwrap().contains("Method not found"));
2025-11-09T23:19:32.5127843Z +        assert!(response["error"]["message"]
2025-11-09T23:19:32.5127968Z +            .as_str()
2025-11-09T23:19:32.5128099Z +            .unwrap()
2025-11-09T23:19:32.5128255Z +            .contains("Method not found"));
2025-11-09T23:19:32.5128591Z          assert!(response["error"]["data"].is_string() || response["error"]["data"].is_null());
2025-11-09T23:19:32.5128737Z          assert_eq!(response["id"], 42);
2025-11-09T23:19:32.5128857Z      }
2025-11-09T23:19:32.5129279Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:855:
2025-11-09T23:19:32.5129386Z  
2025-11-09T23:19:32.5129555Z          assert_eq!(response["jsonrpc"], "2.0");
2025-11-09T23:19:32.5129736Z          assert_eq!(response["error"]["code"], -32601);
2025-11-09T23:19:32.5130088Z -        assert!(response["error"]["message"].as_str().unwrap().contains("Method not found"));
2025-11-09T23:19:32.5130262Z +        assert!(response["error"]["message"]
2025-11-09T23:19:32.5130396Z +            .as_str()
2025-11-09T23:19:32.5130521Z +            .unwrap()
2025-11-09T23:19:32.5130680Z +            .contains("Method not found"));
2025-11-09T23:19:32.5130847Z          assert_eq!(response["id"], 1);
2025-11-09T23:19:32.5132495Z      }
2025-11-09T23:19:32.5132600Z  
2025-11-09T23:19:32.5133131Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/blockstore.rs:2:
2025-11-09T23:19:32.5133245Z  //!
2025-11-09T23:19:32.5133496Z  //! Stores blocks by hash and maintains block index by height.
2025-11-09T23:19:32.5133618Z  
2025-11-09T23:19:32.5133823Z +use crate::storage::database::{Database, Tree};
2025-11-09T23:19:32.5133959Z  use anyhow::Result;
2025-11-09T23:19:32.5134133Z  use bllvm_protocol::segwit::Witness;
2025-11-09T23:19:32.5134495Z  use bllvm_protocol::{Block, BlockHeader, Hash};
2025-11-09T23:19:32.5134980Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/blockstore.rs:8:
2025-11-09T23:19:32.5135190Z -use crate::storage::database::{Database, Tree};
2025-11-09T23:19:32.5135337Z  use std::sync::Arc;
2025-11-09T23:19:32.5135452Z  
2025-11-09T23:19:32.5135822Z  /// Block storage manager
2025-11-09T23:19:32.5136317Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/blockstore.rs:45:
2025-11-09T23:19:32.5136435Z  
2025-11-09T23:19:32.5136681Z          self.blocks.insert(block_hash.as_slice(), &block_data)?;
2025-11-09T23:19:32.5136928Z          let header_data = bincode::serialize(&block.header)?;
2025-11-09T23:19:32.5137057Z -        self.headers
2025-11-09T23:19:32.5137258Z -            .insert(block_hash.as_slice(), &header_data)?;
2025-11-09T23:19:32.5137524Z +        self.headers.insert(block_hash.as_slice(), &header_data)?;
2025-11-09T23:19:32.5137644Z  
2025-11-09T23:19:32.5137845Z          // Store header for median time-past calculation
2025-11-09T23:19:32.5138179Z          // We'll need height passed separately, so this will be called after store_height
2025-11-09T23:19:32.5138657Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/blockstore.rs:81:
2025-11-09T23:19:32.5138811Z      /// Store witness data for a block
2025-11-09T23:19:32.5139152Z      pub fn store_witness(&self, block_hash: &Hash, witness: &[Witness]) -> Result<()> {
2025-11-09T23:19:32.5139358Z          let witness_data = bincode::serialize(witness)?;
2025-11-09T23:19:32.5139641Z -        self.witnesses.insert(block_hash.as_slice(), &witness_data)?;
2025-11-09T23:19:32.5139774Z +        self.witnesses
2025-11-09T23:19:32.5139965Z +            .insert(block_hash.as_slice(), &witness_data)?;
2025-11-09T23:19:32.5140083Z          Ok(())
2025-11-09T23:19:32.5140187Z      }
2025-11-09T23:19:32.5140680Z  
2025-11-09T23:19:32.5141172Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/chainstate.rs:2:
2025-11-09T23:19:32.5141278Z  //!
2025-11-09T23:19:32.5141575Z  //! Stores chain metadata including tip, height, and chain parameters.
2025-11-09T23:19:32.5141692Z  
2025-11-09T23:19:32.5142144Z +use crate::storage::database::{Database, Tree};
2025-11-09T23:19:32.5142282Z  use anyhow::Result;
2025-11-09T23:19:32.5142465Z  use bllvm_protocol::{BlockHeader, Hash};
2025-11-09T23:19:32.5142637Z  use serde::{Deserialize, Serialize};
2025-11-09T23:19:32.5143111Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/chainstate.rs:8:
2025-11-09T23:19:32.5143310Z -use crate::storage::database::{Database, Tree};
2025-11-09T23:19:32.5143447Z  use std::sync::Arc;
2025-11-09T23:19:32.5143557Z  
2025-11-09T23:19:32.5143697Z  /// Chain state information
2025-11-09T23:19:32.5144183Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/chainstate.rs:223:
2025-11-09T23:19:32.5144475Z      }
2025-11-09T23:19:32.5144590Z  
2025-11-09T23:19:32.5144757Z      /// Add a chain tip (for fork tracking)
2025-11-09T23:19:32.5145184Z -    pub fn add_chain_tip(&self, hash: &Hash, height: u64, branchlen: u64, status: &str) -> Result<()> {
2025-11-09T23:19:32.5145341Z +    pub fn add_chain_tip(
2025-11-09T23:19:32.5145459Z +        &self,
2025-11-09T23:19:32.5145577Z +        hash: &Hash,
2025-11-09T23:19:32.5145715Z +        height: u64,
2025-11-09T23:19:32.5145847Z +        branchlen: u64,
2025-11-09T23:19:32.5145975Z +        status: &str,
2025-11-09T23:19:32.5146111Z +    ) -> Result<()> {
2025-11-09T23:19:32.5146272Z          #[derive(Serialize, Deserialize)]
2025-11-09T23:19:32.5146407Z          struct TipInfo {
2025-11-09T23:19:32.5146531Z              height: u64,
2025-11-09T23:19:32.5148460Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/chainstate.rs:230:
2025-11-09T23:19:32.5148589Z              branchlen: u64,
2025-11-09T23:19:32.5148717Z              status: String,
2025-11-09T23:19:32.5148839Z          }
2025-11-09T23:19:32.5148951Z -        
2025-11-09T23:19:32.5149056Z +
2025-11-09T23:19:32.5149192Z          let tip_info = TipInfo {
2025-11-09T23:19:32.5149311Z              height,
2025-11-09T23:19:32.5149425Z              branchlen,
2025-11-09T23:19:32.5149899Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/chainstate.rs:255:
2025-11-09T23:19:32.5150226Z              branchlen: u64,
2025-11-09T23:19:32.5150349Z              status: String,
2025-11-09T23:19:32.5150455Z          }
2025-11-09T23:19:32.5150561Z -        
2025-11-09T23:19:32.5150672Z +
2025-11-09T23:19:32.5150815Z          let mut tips = Vec::new();
2025-11-09T23:19:32.5150978Z          for result in self.chain_tips.iter() {
2025-11-09T23:19:32.5151124Z              let (key, data) = result?;
2025-11-09T23:19:32.5151620Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/commitment_store.rs:4:
2025-11-09T23:19:32.5151783Z  //! without requiring full block history.
2025-11-09T23:19:32.5151898Z  
2025-11-09T23:19:32.5152066Z  #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.5152287Z +use crate::storage::database::{Database, Tree};
2025-11-09T23:19:32.5152451Z +#[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.5152594Z  use anyhow::Result;
2025-11-09T23:19:32.5152740Z  #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.5153054Z  use bllvm_protocol::utxo_commitments::data_structures::UtxoCommitment;
2025-11-09T23:19:32.5153568Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/commitment_store.rs:10:
2025-11-09T23:19:32.5153714Z  #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.5153852Z  use bllvm_protocol::Hash;
2025-11-09T23:19:32.5154002Z  #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.5154180Z -use crate::storage::database::{Database, Tree};
2025-11-09T23:19:32.5154484Z -#[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.5154612Z  use std::sync::Arc;
2025-11-09T23:19:32.5154724Z  
2025-11-09T23:19:32.5154869Z  /// UTXO Commitment storage manager
2025-11-09T23:19:32.5155368Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/commitment_store.rs:48:
2025-11-09T23:19:32.5155603Z          let commitment_data = bincode::serialize(commitment)?;
2025-11-09T23:19:32.5155887Z  
2025-11-09T23:19:32.5156018Z          // Store by block hash
2025-11-09T23:19:32.5156320Z -        self.commitments.insert(block_hash.as_slice(), commitment_data)?;
2025-11-09T23:19:32.5156454Z +        self.commitments
2025-11-09T23:19:32.5156650Z +            .insert(block_hash.as_slice(), commitment_data)?;
2025-11-09T23:19:32.5157407Z  
2025-11-09T23:19:32.5157585Z          // Store height index for quick lookup
2025-11-09T23:19:32.5157748Z          let height_bytes = height.to_be_bytes();
2025-11-09T23:19:32.5158235Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/commitment_store.rs:55:
2025-11-09T23:19:32.5158517Z -        self.height_index.insert(height_bytes, block_hash.as_slice())?;
2025-11-09T23:19:32.5158648Z +        self.height_index
2025-11-09T23:19:32.5158842Z +            .insert(height_bytes, block_hash.as_slice())?;
2025-11-09T23:19:32.5158951Z  
2025-11-09T23:19:32.5159076Z          Ok(())
2025-11-09T23:19:32.5159200Z      }
2025-11-09T23:19:32.5159726Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/commitment_store.rs:128:
2025-11-09T23:19:32.5160009Z          Err(anyhow::anyhow!("UTXO commitments feature not enabled"))
2025-11-09T23:19:32.5160122Z      }
2025-11-09T23:19:32.5160232Z  }
2025-11-09T23:19:32.5160343Z -
2025-11-09T23:19:32.5160458Z  
2025-11-09T23:19:32.5162885Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:7:
2025-11-09T23:19:32.5163279Z  use std::path::Path;
2025-11-09T23:19:32.5163494Z  
2025-11-09T23:19:32.5163700Z  /// Database abstraction trait
2025-11-09T23:19:32.5163825Z -/// 
2025-11-09T23:19:32.5163942Z +///
2025-11-09T23:19:32.5164259Z  /// Provides a unified interface for key-value storage operations
2025-11-09T23:19:32.5164691Z  /// that can be implemented by different backends (sled, redb).
2025-11-09T23:19:32.5164861Z  pub trait Database: Send + Sync {
2025-11-09T23:19:32.5165331Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:14:
2025-11-09T23:19:32.5165455Z      /// Open a named tree/table
2025-11-09T23:19:32.5165880Z      fn open_tree(&self, name: &str) -> Result<Box<dyn Tree>>;
2025-11-09T23:19:32.5165976Z -    
2025-11-09T23:19:32.5166070Z +
2025-11-09T23:19:32.5166192Z      /// Flush all pending writes
2025-11-09T23:19:32.5166321Z      fn flush(&self) -> Result<()>;
2025-11-09T23:19:32.5166414Z  }
2025-11-09T23:19:32.5166812Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:20:
2025-11-09T23:19:32.5166912Z  
2025-11-09T23:19:32.5167035Z  /// Tree/Table abstraction trait
2025-11-09T23:19:32.5167127Z -/// 
2025-11-09T23:19:32.5167218Z +///
2025-11-09T23:19:32.5167494Z  /// Represents a named collection of key-value pairs within a database.
2025-11-09T23:19:32.5167615Z  pub trait Tree: Send + Sync {
2025-11-09T23:19:32.5167735Z      /// Insert a key-value pair
2025-11-09T23:19:32.5168132Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:26:
2025-11-09T23:19:32.5168321Z      fn insert(&self, key: &[u8], value: &[u8]) -> Result<()>;
2025-11-09T23:19:32.5168419Z -    
2025-11-09T23:19:32.5170020Z +
2025-11-09T23:19:32.5170129Z      /// Get a value by key
2025-11-09T23:19:32.5170300Z      fn get(&self, key: &[u8]) -> Result<Option<Vec<u8>>>;
2025-11-09T23:19:32.5170390Z -    
2025-11-09T23:19:32.5170486Z +
2025-11-09T23:19:32.5170601Z      /// Remove a key-value pair
2025-11-09T23:19:32.5170741Z      fn remove(&self, key: &[u8]) -> Result<()>;
2025-11-09T23:19:32.5170836Z -    
2025-11-09T23:19:32.5170926Z +
2025-11-09T23:19:32.5171038Z      /// Check if a key exists
2025-11-09T23:19:32.5171208Z      fn contains_key(&self, key: &[u8]) -> Result<bool>;
2025-11-09T23:19:32.5171305Z -    
2025-11-09T23:19:32.5171396Z +
2025-11-09T23:19:32.5171502Z      /// Clear all entries
2025-11-09T23:19:32.5171622Z      fn clear(&self) -> Result<()>;
2025-11-09T23:19:32.5171879Z -    
2025-11-09T23:19:32.5171971Z +
2025-11-09T23:19:32.5172087Z      /// Get number of entries
2025-11-09T23:19:32.5172218Z      fn len(&self) -> Result<usize>;
2025-11-09T23:19:32.5172312Z -    
2025-11-09T23:19:32.5172403Z +
2025-11-09T23:19:32.5172523Z      /// Check if tree is empty
2025-11-09T23:19:32.5172655Z      fn is_empty(&self) -> Result<bool> {
2025-11-09T23:19:32.5172766Z          Ok(self.len()? == 0)
2025-11-09T23:19:32.5173173Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:46:
2025-11-09T23:19:32.5173268Z      }
2025-11-09T23:19:32.5173359Z -    
2025-11-09T23:19:32.5173450Z +
2025-11-09T23:19:32.5173589Z      /// Iterate over all key-value pairs
2025-11-09T23:19:32.5173847Z      fn iter(&self) -> Box<dyn Iterator<Item = Result<(Vec<u8>, Vec<u8>)>> + '_>;
2025-11-09T23:19:32.5173940Z  }
2025-11-09T23:19:32.5174570Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:63:
2025-11-09T23:19:32.5174739Z  ) -> Result<Box<dyn Database>> {
2025-11-09T23:19:32.5174848Z      match backend {
2025-11-09T23:19:32.5174962Z          #[cfg(feature = "sled")]
2025-11-09T23:19:32.5175106Z -        DatabaseBackend::Sled => {
2025-11-09T23:19:32.5175301Z -            Ok(Box::new(sled_impl::SledDatabase::new(data_dir)?))
2025-11-09T23:19:32.5175397Z -        }
2025-11-09T23:19:32.5175654Z +        DatabaseBackend::Sled => Ok(Box::new(sled_impl::SledDatabase::new(data_dir)?)),
2025-11-09T23:19:32.5175753Z          #[cfg(not(feature = "sled"))]
2025-11-09T23:19:32.5175855Z -        DatabaseBackend::Sled => {
2025-11-09T23:19:32.5176069Z -            Err(anyhow::anyhow!("Sled backend not available (feature not enabled)"))
2025-11-09T23:19:32.5176149Z -        }
2025-11-09T23:19:32.5176278Z +        DatabaseBackend::Sled => Err(anyhow::anyhow!(
2025-11-09T23:19:32.5176417Z +            "Sled backend not available (feature not enabled)"
2025-11-09T23:19:32.5176498Z +        )),
2025-11-09T23:19:32.5176586Z          #[cfg(feature = "redb")]
2025-11-09T23:19:32.5176685Z -        DatabaseBackend::Redb => {
2025-11-09T23:19:32.5176835Z -            Ok(Box::new(redb_impl::RedbDatabase::new(data_dir)?))
2025-11-09T23:19:32.5177057Z -        }
2025-11-09T23:19:32.5177288Z +        DatabaseBackend::Redb => Ok(Box::new(redb_impl::RedbDatabase::new(data_dir)?)),
2025-11-09T23:19:32.5177384Z          #[cfg(not(feature = "redb"))]
2025-11-09T23:19:32.5177488Z -        DatabaseBackend::Redb => {
2025-11-09T23:19:32.5177691Z -            Err(anyhow::anyhow!("Redb backend not available (feature not enabled)"))
2025-11-09T23:19:32.5177765Z -        }
2025-11-09T23:19:32.5177896Z +        DatabaseBackend::Redb => Err(anyhow::anyhow!(
2025-11-09T23:19:32.5178032Z +            "Redb backend not available (feature not enabled)"
2025-11-09T23:19:32.5178110Z +        )),
2025-11-09T23:19:32.5178184Z      }
2025-11-09T23:19:32.5178261Z  }
2025-11-09T23:19:32.5178337Z  
2025-11-09T23:19:32.5178652Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:84:
2025-11-09T23:19:32.5178762Z  /// Get default database backend
2025-11-09T23:19:32.5178838Z -/// 
2025-11-09T23:19:32.5178909Z +///
2025-11-09T23:19:32.5179110Z  /// Returns the preferred backend (redb if available, otherwise sled).
2025-11-09T23:19:32.5179365Z  /// This function will not panic - it returns a backend if at least one is available.
2025-11-09T23:19:32.5179495Z  pub fn default_backend() -> DatabaseBackend {
2025-11-09T23:19:32.5179818Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:104:
2025-11-09T23:19:32.5179897Z  }
2025-11-09T23:19:32.5179971Z  
2025-11-09T23:19:32.5180067Z  /// Get fallback database backend
2025-11-09T23:19:32.5180146Z -/// 
2025-11-09T23:19:32.5180220Z +///
2025-11-09T23:19:32.5180370Z  /// Returns an alternative backend if the primary fails.
2025-11-09T23:19:32.5180482Z  /// Returns None if no fallback is available.
2025-11-09T23:19:32.5180727Z  pub fn fallback_backend(primary: DatabaseBackend) -> Option<DatabaseBackend> {
2025-11-09T23:19:32.5181159Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:148:
2025-11-09T23:19:32.5181256Z      impl SledDatabase {
2025-11-09T23:19:32.5181417Z          pub fn new<P: AsRef<Path>>(data_dir: P) -> Result<Self> {
2025-11-09T23:19:32.5181521Z              let db = sled::open(data_dir)?;
2025-11-09T23:19:32.5181601Z -            Ok(Self {
2025-11-09T23:19:32.5181690Z -                db: Arc::new(db),
2025-11-09T23:19:32.5181771Z -            })
2025-11-09T23:19:32.5181869Z +            Ok(Self { db: Arc::new(db) })
2025-11-09T23:19:32.5181942Z          }
2025-11-09T23:19:32.5182021Z      }
2025-11-09T23:19:32.5182095Z  
2025-11-09T23:19:32.5182407Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:224:
2025-11-09T23:19:32.5182677Z      static HEADERS_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("headers");
2025-11-09T23:19:32.5182969Z      static HEIGHT_INDEX_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("height_index");
2025-11-09T23:19:32.5183251Z      static WITNESSES_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("witnesses");
2025-11-09T23:19:32.5183567Z -    static RECENT_HEADERS_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("recent_headers");
2025-11-09T23:19:32.5183737Z +    static RECENT_HEADERS_TABLE: TableDefinition<&[u8], &[u8]> =
2025-11-09T23:19:32.5183851Z +        TableDefinition::new("recent_headers");
2025-11-09T23:19:32.5184092Z      static UTXOS_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("utxos");
2025-11-09T23:19:32.5184821Z -    static SPENT_OUTPUTS_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("spent_outputs");
2025-11-09T23:19:32.5184996Z +    static SPENT_OUTPUTS_TABLE: TableDefinition<&[u8], &[u8]> =
2025-11-09T23:19:32.5185116Z +        TableDefinition::new("spent_outputs");
2025-11-09T23:19:32.5185395Z      static CHAIN_INFO_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("chain_info");
2025-11-09T23:19:32.5185651Z      static WORK_CACHE_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("work_cache");
2025-11-09T23:19:32.5186030Z      static TX_BY_HASH_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("tx_by_hash");
2025-11-09T23:19:32.5186309Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:233:
2025-11-09T23:19:32.5188472Z      static TX_BY_BLOCK_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("tx_by_block");
2025-11-09T23:19:32.5188708Z      static TX_METADATA_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("tx_metadata");
2025-11-09T23:19:32.5188978Z -    static INVALID_BLOCKS_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("invalid_blocks");
2025-11-09T23:19:32.5189128Z +    static INVALID_BLOCKS_TABLE: TableDefinition<&[u8], &[u8]> =
2025-11-09T23:19:32.5189252Z +        TableDefinition::new("invalid_blocks");
2025-11-09T23:19:32.5189487Z      static CHAIN_TIPS_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("chain_tips");
2025-11-09T23:19:32.5189559Z  
2025-11-09T23:19:32.5189661Z      pub struct RedbDatabase {
2025-11-09T23:19:32.5189929Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:243:
2025-11-09T23:19:32.5190077Z          pub fn new<P: AsRef<Path>>(data_dir: P) -> Result<Self> {
2025-11-09T23:19:32.5190196Z              let db_path = data_dir.as_ref().join("redb.db");
2025-11-09T23:19:32.5190302Z              let db = RedbDb::create(&db_path)?;
2025-11-09T23:19:32.5190371Z -            
2025-11-09T23:19:32.5190437Z +
2025-11-09T23:19:32.5190564Z              // Initialize all tables in a write transaction
2025-11-09T23:19:32.5190660Z              let write_txn = db.begin_write()?;
2025-11-09T23:19:32.5190729Z              {
2025-11-09T23:19:32.5190994Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:264:
2025-11-09T23:19:32.5191119Z                  let _ = write_txn.open_table(CHAIN_TIPS_TABLE)?;
2025-11-09T23:19:32.5191307Z              }
2025-11-09T23:19:32.5191392Z              write_txn.commit()?;
2025-11-09T23:19:32.5191468Z -            
2025-11-09T23:19:32.5191541Z -            Ok(Self {
2025-11-09T23:19:32.5191623Z -                db: Arc::new(db),
2025-11-09T23:19:32.5191696Z -            })
2025-11-09T23:19:32.5191791Z +
2025-11-09T23:19:32.5208846Z +            Ok(Self { db: Arc::new(db) })
2025-11-09T23:19:32.5209048Z          }
2025-11-09T23:19:32.5209170Z -        
2025-11-09T23:19:32.5209598Z -        fn get_table_def(&self, name: &str) -> Option<TableDefinition<&'static [u8], &'static [u8]>> {
2025-11-09T23:19:32.5209704Z +
2025-11-09T23:19:32.5209835Z +        fn get_table_def(
2025-11-09T23:19:32.5209957Z +            &self,
2025-11-09T23:19:32.5210485Z +            name: &str,
2025-11-09T23:19:32.5210759Z +        ) -> Option<TableDefinition<&'static [u8], &'static [u8]>> {
2025-11-09T23:19:32.5211162Z              match name {
2025-11-09T23:19:32.5211350Z                  "blocks" => Some(BLOCKS_TABLE),
2025-11-09T23:19:32.5211497Z                  "headers" => Some(HEADERS_TABLE),
2025-11-09T23:19:32.5211981Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:293:
2025-11-09T23:19:32.5212085Z  
2025-11-09T23:19:32.5212240Z      impl Database for RedbDatabase {
2025-11-09T23:19:32.5212461Z          fn open_tree(&self, name: &str) -> Result<Box<dyn Tree>> {
2025-11-09T23:19:32.5212625Z -            let table_def = self.get_table_def(name)
2025-11-09T23:19:32.5213056Z -                .ok_or_else(|| anyhow::anyhow!("Unknown table name: {}. Redb requires pre-defined tables.", name))?;
2025-11-09T23:19:32.5213173Z -            
2025-11-09T23:19:32.5213393Z +            let table_def = self.get_table_def(name).ok_or_else(|| {
2025-11-09T23:19:32.5213527Z +                anyhow::anyhow!(
2025-11-09T23:19:32.5213777Z +                    "Unknown table name: {}. Redb requires pre-defined tables.",
2025-11-09T23:19:32.5213901Z +                    name
2025-11-09T23:19:32.5214010Z +                )
2025-11-09T23:19:32.5214586Z +            })?;
2025-11-09T23:19:32.5214692Z +
2025-11-09T23:19:32.5214828Z              Ok(Box::new(RedbTree {
2025-11-09T23:19:32.5214976Z                  db: Arc::clone(&self.db),
2025-11-09T23:19:32.5215095Z                  table_def,
2025-11-09T23:19:32.5215555Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:374:
2025-11-09T23:19:32.5215737Z              let read_txn = match self.db.begin_read() {
2025-11-09T23:19:32.5215879Z                  Ok(txn) => txn,
2025-11-09T23:19:32.5216005Z                  Err(e) => {
2025-11-09T23:19:32.5216442Z -                    return Box::new(std::iter::once(Err(anyhow::anyhow!("Failed to begin read transaction: {}", e))));
2025-11-09T23:19:32.5216688Z +                    return Box::new(std::iter::once(Err(anyhow::anyhow!(
2025-11-09T23:19:32.5216880Z +                        "Failed to begin read transaction: {}",
2025-11-09T23:19:32.5217013Z +                        e
2025-11-09T23:19:32.5217145Z +                    ))));
2025-11-09T23:19:32.5217271Z                  }
2025-11-09T23:19:32.5217387Z              };
2025-11-09T23:19:32.5217503Z -            
2025-11-09T23:19:32.5217630Z +
2025-11-09T23:19:32.5217868Z              let table = match read_txn.open_table(self.table_def) {
2025-11-09T23:19:32.5218002Z                  Ok(tbl) => tbl,
2025-11-09T23:19:32.5218138Z                  Err(e) => {
2025-11-09T23:19:32.5218628Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:384:
2025-11-09T23:19:32.5219002Z -                    return Box::new(std::iter::once(Err(anyhow::anyhow!("Failed to open table: {}", e))));
2025-11-09T23:19:32.5219229Z +                    return Box::new(std::iter::once(Err(anyhow::anyhow!(
2025-11-09T23:19:32.5219403Z +                        "Failed to open table: {}",
2025-11-09T23:19:32.5219529Z +                        e
2025-11-09T23:19:32.5219875Z +                    ))));
2025-11-09T23:19:32.5220002Z                  }
2025-11-09T23:19:32.5220130Z              };
2025-11-09T23:19:32.5220246Z -            
2025-11-09T23:19:32.5220365Z +
2025-11-09T23:19:32.5220576Z              let items: Vec<Result<(Vec<u8>, Vec<u8>)>> = table
2025-11-09T23:19:32.5220700Z                  .iter()
2025-11-09T23:19:32.5220831Z                  .map(|item| {
2025-11-09T23:19:32.5223122Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:392:
2025-11-09T23:19:32.5223391Z                          .map_err(|e| anyhow::anyhow!("Redb iteration error: {}", e))
2025-11-09T23:19:32.5223511Z                  })
2025-11-09T23:19:32.5223651Z                  .collect();
2025-11-09T23:19:32.5223767Z -            
2025-11-09T23:19:32.5223874Z +
2025-11-09T23:19:32.5224031Z              Box::new(items.into_iter())
2025-11-09T23:19:32.5224155Z          }
2025-11-09T23:19:32.5224266Z      }
2025-11-09T23:19:32.5229958Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:399:
2025-11-09T23:19:32.5230119Z  }
2025-11-09T23:19:32.5230231Z -
2025-11-09T23:19:32.5232223Z  
2025-11-09T23:19:32.5239221Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:4:
2025-11-09T23:19:32.5239581Z  //! Supports multiple database backends via feature flags (sled, redb).
2025-11-09T23:19:32.5239753Z  
2025-11-09T23:19:32.5239891Z  pub mod blockstore;
2025-11-09T23:19:32.5240024Z +pub mod chainstate;
2025-11-09T23:19:32.5240194Z  #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.5240353Z  pub mod commitment_store;
2025-11-09T23:19:32.5240486Z -pub mod chainstate;
2025-11-09T23:19:32.5242943Z  pub mod database;
2025-11-09T23:19:32.5243106Z  pub mod hashing;
2025-11-09T23:19:32.5243238Z  pub mod pruning;
2025-11-09T23:19:32.5243690Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:13:
2025-11-09T23:19:32.5243840Z  pub mod txindex;
2025-11-09T23:19:32.5243978Z  pub mod utxostore;
2025-11-09T23:19:32.5244092Z  
2025-11-09T23:19:32.5244262Z +use crate::config::PruningConfig;
2025-11-09T23:19:32.5244846Z  use anyhow::Result;
2025-11-09T23:19:32.5245307Z  use database::{create_database, default_backend, fallback_backend, Database, DatabaseBackend};
2025-11-09T23:19:32.5245444Z  use std::path::Path;
2025-11-09T23:19:32.5245889Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:19:
2025-11-09T23:19:32.5246016Z  use std::sync::Arc;
2025-11-09T23:19:32.5246156Z -use tracing::{warn, info};
2025-11-09T23:19:32.5246315Z -use crate::config::PruningConfig;
2025-11-09T23:19:32.5246452Z +use tracing::{info, warn};
2025-11-09T23:19:32.5246566Z  
2025-11-09T23:19:32.5246803Z  /// Storage manager that coordinates all storage operations
2025-11-09T23:19:32.5246949Z  pub struct Storage {
2025-11-09T23:19:32.5247386Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:32:
2025-11-09T23:19:32.5247513Z  
2025-11-09T23:19:32.5247641Z  impl Storage {
2025-11-09T23:19:32.5247869Z      /// Create a new storage instance with default backend
2025-11-09T23:19:32.5247995Z -    /// 
2025-11-09T23:19:32.5248115Z +    ///
2025-11-09T23:19:32.5248434Z      /// Attempts to use the default backend (redb), and gracefully falls back
2025-11-09T23:19:32.5248619Z      /// to sled if redb fails and sled is available.
2025-11-09T23:19:32.5248845Z      pub fn new<P: AsRef<Path>>(data_dir: P) -> Result<Self> {
2025-11-09T23:19:32.5249279Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:39:
2025-11-09T23:19:32.5249448Z          let default = default_backend();
2025-11-09T23:19:32.5249564Z -        
2025-11-09T23:19:32.5249674Z +
2025-11-09T23:19:32.5249837Z          // Try default backend first
2025-11-09T23:19:32.5251967Z          match Self::with_backend(data_dir.as_ref(), default) {
2025-11-09T23:19:32.5252118Z              Ok(storage) => Ok(storage),
2025-11-09T23:19:32.5252792Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:44:
2025-11-09T23:19:32.5252935Z              Err(e) => {
2025-11-09T23:19:32.5253109Z                  // If default backend fails, try fallback
2025-11-09T23:19:32.5253358Z                  if let Some(fallback_backend) = fallback_backend(default) {
2025-11-09T23:19:32.5253782Z -                    warn!("Failed to initialize {:?} backend: {}. Falling back to {:?}.", default, e, fallback_backend);
2025-11-09T23:19:32.5254169Z -                    info!("Attempting to initialize storage with fallback backend: {:?}", fallback_backend);
2025-11-09T23:19:32.5254294Z +                    warn!(
2025-11-09T23:19:32.5254747Z +                        "Failed to initialize {:?} backend: {}. Falling back to {:?}.",
2025-11-09T23:19:32.5254917Z +                        default, e, fallback_backend
2025-11-09T23:19:32.5255038Z +                    );
2025-11-09T23:19:32.5255170Z +                    info!(
2025-11-09T23:19:32.5255474Z +                        "Attempting to initialize storage with fallback backend: {:?}",
2025-11-09T23:19:32.5255624Z +                        fallback_backend
2025-11-09T23:19:32.5255745Z +                    );
2025-11-09T23:19:32.5255970Z                      Self::with_backend(data_dir, fallback_backend)
2025-11-09T23:19:32.5256097Z                  } else {
2025-11-09T23:19:32.5256248Z                      Err(anyhow::anyhow!(
2025-11-09T23:19:32.5256695Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:52:
2025-11-09T23:19:32.5257007Z                          "Failed to initialize {:?} backend: {}. No fallback backend available.",
2025-11-09T23:19:32.5257141Z -                        default, e
2025-11-09T23:19:32.5257273Z +                        default,
2025-11-09T23:19:32.5257399Z +                        e
2025-11-09T23:19:32.5257518Z                      ))
2025-11-09T23:19:32.5257632Z                  }
2025-11-09T23:19:32.5257764Z              }
2025-11-09T23:19:32.5258210Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:145:
2025-11-09T23:19:32.5258601Z      pub fn flush(&self) -> Result<()> {
2025-11-09T23:19:32.5258730Z          self.db.flush()
2025-11-09T23:19:32.5258839Z      }
2025-11-09T23:19:32.5258941Z -    
2025-11-09T23:19:32.5259039Z +
2025-11-09T23:19:32.5259255Z      /// Get approximate disk size used by storage (in bytes)
2025-11-09T23:19:32.5259356Z -    /// 
2025-11-09T23:19:32.5259456Z +    ///
2025-11-09T23:19:32.5259745Z      /// Returns an estimate based on tree sizes. If any operation fails,
2025-11-09T23:19:32.5259931Z      /// returns 0 gracefully rather than erroring.
2025-11-09T23:19:32.5260124Z      /// Includes bounds checking to prevent overflow.
2025-11-09T23:19:32.5260569Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:154:
2025-11-09T23:19:32.5260752Z      pub fn disk_size(&self) -> Result<u64> {
2025-11-09T23:19:32.5261031Z          // Estimate based on tree sizes (graceful degradation if counts fail)
2025-11-09T23:19:32.5261161Z          let mut size = 0u64;
2025-11-09T23:19:32.5261287Z -        
2025-11-09T23:19:32.5261394Z +
2025-11-09T23:19:32.5261686Z          // Block size estimate (gracefully handle errors, with bounds checking)
2025-11-09T23:19:32.5261891Z          if let Ok(count) = self.blockstore.block_count() {
2025-11-09T23:19:32.5262135Z              const MAX_BLOCKS: u64 = 10_000_000; // 10M blocks max (safety limit)
2025-11-09T23:19:32.5262576Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:162:
2025-11-09T23:19:32.5262802Z              const BYTES_PER_BLOCK: u64 = 1_024_000; // ~1MB per block
2025-11-09T23:19:32.5263116Z              size = size.saturating_add(safe_count.saturating_mul(BYTES_PER_BLOCK));
2025-11-09T23:19:32.5263228Z          }
2025-11-09T23:19:32.5263335Z -        
2025-11-09T23:19:32.5263440Z +
2025-11-09T23:19:32.5263715Z          // UTXO size estimate (gracefully handle errors, with bounds checking)
2025-11-09T23:19:32.5264094Z          if let Ok(count) = self.utxostore.utxo_count() {
2025-11-09T23:19:32.5264500Z              const MAX_UTXOS: u64 = 1_000_000_000; // 1B UTXOs max (safety limit)
2025-11-09T23:19:32.5264931Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:170:
2025-11-09T23:19:32.5265129Z              const BYTES_PER_UTXO: u64 = 100; // ~100 bytes per UTXO
2025-11-09T23:19:32.5265405Z              size = size.saturating_add(safe_count.saturating_mul(BYTES_PER_UTXO));
2025-11-09T23:19:32.5265525Z          }
2025-11-09T23:19:32.5265639Z -        
2025-11-09T23:19:32.5265751Z +
2025-11-09T23:19:32.5266106Z          // Transaction size estimate (gracefully handle errors, with bounds checking)
2025-11-09T23:19:32.5266330Z          if let Ok(count) = self.txindex.transaction_count() {
2025-11-09T23:19:32.5266603Z              const MAX_TXS: u64 = 1_000_000_000; // 1B transactions max (safety limit)
2025-11-09T23:19:32.5268416Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:178:
2025-11-09T23:19:32.5268673Z              const BYTES_PER_TX: u64 = 500; // ~500 bytes per transaction
2025-11-09T23:19:32.5268975Z              size = size.saturating_add(safe_count.saturating_mul(BYTES_PER_TX));
2025-11-09T23:19:32.5269089Z          }
2025-11-09T23:19:32.5269211Z -        
2025-11-09T23:19:32.5269323Z +
2025-11-09T23:19:32.5269570Z          // Final bounds check: prevent returning unrealistic values
2025-11-09T23:19:32.5269846Z          const MAX_DISK_SIZE: u64 = 10_000_000_000_000; // 10TB max (safety limit)
2025-11-09T23:19:32.5269995Z          Ok(size.min(MAX_DISK_SIZE))
2025-11-09T23:19:32.5270433Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:185:
2025-11-09T23:19:32.5270936Z      }
2025-11-09T23:19:32.5271066Z -    
2025-11-09T23:19:32.5271179Z +
2025-11-09T23:19:32.5271357Z      /// Check storage bounds before operations
2025-11-09T23:19:32.5271716Z      /// Returns true if storage is within safe bounds, false if approaching limits
2025-11-09T23:19:32.5272217Z      pub fn check_storage_bounds(&self) -> Result<bool> {
2025-11-09T23:19:32.5272659Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:190:
2025-11-09T23:19:32.5272863Z          const MAX_BLOCKS: usize = 10_000_000; // 10M blocks
2025-11-09T23:19:32.5273052Z          const MAX_UTXOS: usize = 1_000_000_000; // 1B UTXOs
2025-11-09T23:19:32.5273265Z          const MAX_TXS: usize = 1_000_000_000; // 1B transactions
2025-11-09T23:19:32.5273383Z -        
2025-11-09T23:19:32.5273507Z +
2025-11-09T23:19:32.5273773Z          let block_count = self.blockstore.block_count().unwrap_or(0);
2025-11-09T23:19:32.5274015Z          let utxo_count = self.utxostore.utxo_count().unwrap_or(0);
2025-11-09T23:19:32.5274279Z          let tx_count = self.txindex.transaction_count().unwrap_or(0);
2025-11-09T23:19:32.5274837Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:197:
2025-11-09T23:19:32.5274957Z -        
2025-11-09T23:19:32.5275066Z +
2025-11-09T23:19:32.5275262Z          // Check if we're approaching limits (80% threshold)
2025-11-09T23:19:32.5275453Z          let blocks_ok = block_count < (MAX_BLOCKS * 8 / 10);
2025-11-09T23:19:32.5275648Z          let utxos_ok = utxo_count < (MAX_UTXOS * 8 / 10);
2025-11-09T23:19:32.5276091Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:201:
2025-11-09T23:19:32.5276266Z          let txs_ok = tx_count < (MAX_TXS * 8 / 10);
2025-11-09T23:19:32.5276383Z -        
2025-11-09T23:19:32.5276504Z +
2025-11-09T23:19:32.5276636Z          if !blocks_ok {
2025-11-09T23:19:32.5277033Z -            warn!("Storage bounds: block count ({}) approaching limit ({})", block_count, MAX_BLOCKS);
2025-11-09T23:19:32.5277155Z +            warn!(
2025-11-09T23:19:32.5277403Z +                "Storage bounds: block count ({}) approaching limit ({})",
2025-11-09T23:19:32.5277751Z +                block_count, MAX_BLOCKS
2025-11-09T23:19:32.5277860Z +            );
2025-11-09T23:19:32.5277987Z          }
2025-11-09T23:19:32.5278105Z          if !utxos_ok {
2025-11-09T23:19:32.5278449Z -            warn!("Storage bounds: UTXO count ({}) approaching limit ({})", utxo_count, MAX_UTXOS);
2025-11-09T23:19:32.5278564Z +            warn!(
2025-11-09T23:19:32.5278788Z +                "Storage bounds: UTXO count ({}) approaching limit ({})",
2025-11-09T23:19:32.5278918Z +                utxo_count, MAX_UTXOS
2025-11-09T23:19:32.5279021Z +            );
2025-11-09T23:19:32.5279129Z          }
2025-11-09T23:19:32.5279242Z          if !txs_ok {
2025-11-09T23:19:32.5279611Z -            warn!("Storage bounds: transaction count ({}) approaching limit ({})", tx_count, MAX_TXS);
2025-11-09T23:19:32.5279740Z +            warn!(
2025-11-09T23:19:32.5280027Z +                "Storage bounds: transaction count ({}) approaching limit ({})",
2025-11-09T23:19:32.5280164Z +                tx_count, MAX_TXS
2025-11-09T23:19:32.5280290Z +            );
2025-11-09T23:19:32.5280412Z          }
2025-11-09T23:19:32.5280533Z -        
2025-11-09T23:19:32.5280645Z +
2025-11-09T23:19:32.5280810Z          Ok(blocks_ok && utxos_ok && txs_ok)
2025-11-09T23:19:32.5280922Z      }
2025-11-09T23:19:32.5281035Z -    
2025-11-09T23:19:32.5281145Z +
2025-11-09T23:19:32.5281312Z      /// Get transaction count from txindex
2025-11-09T23:19:32.5281518Z      pub fn transaction_count(&self) -> Result<usize> {
2025-11-09T23:19:32.5281687Z          self.txindex.transaction_count()
2025-11-09T23:19:32.5336892Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:7:
2025-11-09T23:19:32.5337233Z  //! - Custom: Fine-grained control over what to keep
2025-11-09T23:19:32.5337353Z  
2025-11-09T23:19:32.5337584Z  use crate::config::{PruningConfig, PruningMode};
2025-11-09T23:19:32.5337728Z +#[cfg(feature = "bip158")]
2025-11-09T23:19:32.5337973Z +use crate::network::filter_service::BlockFilterService;
2025-11-09T23:19:32.5338177Z  use crate::storage::blockstore::BlockStore;
2025-11-09T23:19:32.5338348Z  #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.5338856Z  use crate::storage::commitment_store::CommitmentStore;
2025-11-09T23:19:32.5341787Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:13:
2025-11-09T23:19:32.5341983Z  #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.5342172Z  use crate::storage::utxostore::UtxoStore;
2025-11-09T23:19:32.5342315Z -#[cfg(feature = "bip158")]
2025-11-09T23:19:32.5342569Z -use crate::network::filter_service::BlockFilterService;
2025-11-09T23:19:32.5342724Z  use anyhow::{anyhow, Result};
2025-11-09T23:19:32.5342883Z  #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.5343032Z  use bllvm_protocol::Hash;
2025-11-09T23:19:32.5343535Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:89:
2025-11-09T23:19:32.5343678Z      pub fn with_features(
2025-11-09T23:19:32.5343838Z          config: PruningConfig,
2025-11-09T23:19:32.5344001Z          blockstore: Arc<BlockStore>,
2025-11-09T23:19:32.5344181Z -        #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.5344610Z -        commitment_store: Option<Arc<CommitmentStore>>,
2025-11-09T23:19:32.5344785Z -        #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.5344955Z -        utxostore: Option<Arc<UtxoStore>>,
2025-11-09T23:19:32.5345099Z -        #[cfg(feature = "bip158")]
2025-11-09T23:19:32.5345315Z -        filter_service: Option<Arc<BlockFilterService>>,
2025-11-09T23:19:32.5345723Z +        #[cfg(feature = "utxo-commitments")] commitment_store: Option<Arc<CommitmentStore>>,
2025-11-09T23:19:32.5346034Z +        #[cfg(feature = "utxo-commitments")] utxostore: Option<Arc<UtxoStore>>,
2025-11-09T23:19:32.5346358Z +        #[cfg(feature = "bip158")] filter_service: Option<Arc<BlockFilterService>>,
2025-11-09T23:19:32.5346495Z      ) -> Self {
2025-11-09T23:19:32.5346611Z          Self {
2025-11-09T23:19:32.5347066Z              config,
2025-11-09T23:19:32.5347559Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:153:
2025-11-09T23:19:32.5347701Z          {
2025-11-09T23:19:32.5347883Z              // Check if UTXO commitments are available
2025-11-09T23:19:32.5348277Z              let has_commitments = self.commitment_store.is_some() && self.utxostore.is_some();
2025-11-09T23:19:32.5348399Z -            
2025-11-09T23:19:32.5348514Z +
2025-11-09T23:19:32.5348712Z              // Check if mode supports incremental pruning
2025-11-09T23:19:32.5348872Z              let mode_supports = matches!(
2025-11-09T23:19:32.5349022Z                  &self.config.mode,
2025-11-09T23:19:32.5349496Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:160:
2025-11-09T23:19:32.5349896Z -                PruningMode::Aggressive { .. } | PruningMode::Custom { keep_commitments: true, .. }
2025-11-09T23:19:32.5350081Z +                PruningMode::Aggressive { .. }
2025-11-09T23:19:32.5350248Z +                    | PruningMode::Custom {
2025-11-09T23:19:32.5350409Z +                        keep_commitments: true,
2025-11-09T23:19:32.5350546Z +                        ..
2025-11-09T23:19:32.5350664Z +                    }
2025-11-09T23:19:32.5351141Z              );
2025-11-09T23:19:32.5351286Z -            
2025-11-09T23:19:32.5351399Z +
2025-11-09T23:19:32.5351574Z              has_commitments && mode_supports
2025-11-09T23:19:32.5351695Z          }
2025-11-09T23:19:32.5351871Z          #[cfg(not(feature = "utxo-commitments"))]
2025-11-09T23:19:32.5352363Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:169:
2025-11-09T23:19:32.5352478Z      }
2025-11-09T23:19:32.5352598Z  
2025-11-09T23:19:32.5352756Z      /// Incremental prune during IBD
2025-11-09T23:19:32.5352874Z -    /// 
2025-11-09T23:19:32.5352999Z +    ///
2025-11-09T23:19:32.5353376Z      /// This method prunes old blocks while keeping a sliding window of recent blocks.
2025-11-09T23:19:32.5353770Z      /// It's designed to be called periodically during IBD to prevent storage from growing
2025-11-09T23:19:32.5354726Z      /// unbounded. Only works when incremental_prune_during_ibd is enabled and UTXO
2025-11-09T23:19:32.5355246Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:203:
2025-11-09T23:19:32.5355363Z  
2025-11-09T23:19:32.5355686Z          // Calculate prune height: keep only the last prune_window_size blocks
2025-11-09T23:19:32.5356096Z          let prune_to_height = current_height.saturating_sub(self.config.prune_window_size);
2025-11-09T23:19:32.5356211Z -        
2025-11-09T23:19:32.5356323Z +
2025-11-09T23:19:32.5356577Z          // Don't prune if window size is larger than current height
2025-11-09T23:19:32.5356828Z          if prune_to_height == 0 || prune_to_height >= current_height {
2025-11-09T23:19:32.5356960Z              return Ok(None);
2025-11-09T23:19:32.5357429Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:245:
2025-11-09T23:19:32.5357637Z              // 1. Incremental pruning is explicitly enabled
2025-11-09T23:19:32.5357890Z              // 2. UTXO commitments are available (for state verification)
2025-11-09T23:19:32.5358109Z              // 3. Aggressive or Custom mode with commitments enabled
2025-11-09T23:19:32.5358434Z -            let can_incremental_prune = self.config.incremental_prune_during_ibd
2025-11-09T23:19:32.5358620Z -                && self.can_incremental_prune_during_ibd();
2025-11-09T23:19:32.5358730Z -            
2025-11-09T23:19:32.5358881Z +            let can_incremental_prune =
2025-11-09T23:19:32.5359294Z +                self.config.incremental_prune_during_ibd && self.can_incremental_prune_during_ibd();
2025-11-09T23:19:32.5359413Z +
2025-11-09T23:19:32.5364674Z              if !can_incremental_prune {
2025-11-09T23:19:32.5364850Z                  return Err(anyhow!(
2025-11-09T23:19:32.5365551Z                      "Cannot prune during initial block download. Wait for IBD to complete, or enable incremental_prune_during_ibd with UTXO commitments."
2025-11-09T23:19:32.5366323Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:254:
2025-11-09T23:19:32.5366456Z                  ));
2025-11-09T23:19:32.5366577Z              }
2025-11-09T23:19:32.5366694Z -            
2025-11-09T23:19:32.5366810Z +
2025-11-09T23:19:32.5367121Z              // For incremental pruning during IBD, ensure we have enough blocks
2025-11-09T23:19:32.5367431Z              if current_height < self.config.min_blocks_for_incremental_prune {
2025-11-09T23:19:32.5367573Z                  return Err(anyhow!(
2025-11-09T23:19:32.5368065Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:295:
2025-11-09T23:19:32.5368231Z              PruningMode::Normal {
2025-11-09T23:19:32.5368364Z                  keep_from_height,
2025-11-09T23:19:32.5368509Z                  min_recent_blocks,
2025-11-09T23:19:32.5368973Z -            } => self.prune_normal(prune_to_height, current_height, *keep_from_height, *min_recent_blocks)?,
2025-11-09T23:19:32.5369125Z +            } => self.prune_normal(
2025-11-09T23:19:32.5369277Z +                prune_to_height,
2025-11-09T23:19:32.5369411Z +                current_height,
2025-11-09T23:19:32.5369549Z +                *keep_from_height,
2025-11-09T23:19:32.5369685Z +                *min_recent_blocks,
2025-11-09T23:19:32.5369814Z +            )?,
2025-11-09T23:19:32.5369976Z              PruningMode::Aggressive {
2025-11-09T23:19:32.5370114Z                  keep_from_height,
2025-11-09T23:19:32.5370262Z                  keep_commitments,
2025-11-09T23:19:32.5372578Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:370:
2025-11-09T23:19:32.5372766Z          let mut stats = PruningStats::default();
2025-11-09T23:19:32.5372877Z  
2025-11-09T23:19:32.5373241Z          // Calculate actual keep height (max of keep_from_height and min_recent_blocks)
2025-11-09T23:19:32.5373560Z -        let effective_keep_height = keep_from_height.max(
2025-11-09T23:19:32.5373976Z -            current_height.saturating_sub(min_recent_blocks)
2025-11-09T23:19:32.5374096Z -        );
2025-11-09T23:19:32.5374246Z +        let effective_keep_height =
2025-11-09T23:19:32.5374753Z +            keep_from_height.max(current_height.saturating_sub(min_recent_blocks));
2025-11-09T23:19:32.5374883Z  
2025-11-09T23:19:32.5378988Z          // Ensure we don't prune below effective keep height
2025-11-09T23:19:32.5379365Z          let actual_prune_height = prune_to_height.min(effective_keep_height);
2025-11-09T23:19:32.5379873Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:415:
2025-11-09T23:19:32.5380088Z          let mut stats = PruningStats::default();
2025-11-09T23:19:32.5380205Z  
2025-11-09T23:19:32.5380793Z          // Calculate effective keep height
2025-11-09T23:19:32.5381055Z -        let effective_keep_height = keep_from_height.max(
2025-11-09T23:19:32.5381252Z -            current_height.saturating_sub(min_blocks)
2025-11-09T23:19:32.5381381Z -        );
2025-11-09T23:19:32.5381839Z +        let effective_keep_height = keep_from_height.max(current_height.saturating_sub(min_blocks));
2025-11-09T23:19:32.5381962Z  
2025-11-09T23:19:32.5382261Z          let actual_prune_height = prune_to_height.min(effective_keep_height);
2025-11-09T23:19:32.5382370Z  
2025-11-09T23:19:32.5382838Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:428:
2025-11-09T23:19:32.5382944Z  
2025-11-09T23:19:32.5383166Z          // Generate UTXO commitments before pruning if enabled
2025-11-09T23:19:32.5383313Z          if keep_commitments {
2025-11-09T23:19:32.5383571Z -            if let (Some(ref commitment_store), Some(ref utxostore)) = 
2025-11-09T23:19:32.5383837Z -                (self.commitment_store.as_ref(), self.utxostore.as_ref()) 
2025-11-09T23:19:32.5384497Z +            if let (Some(ref commitment_store), Some(ref utxostore)) =
2025-11-09T23:19:32.5384766Z +                (self.commitment_store.as_ref(), self.utxostore.as_ref())
2025-11-09T23:19:32.5384901Z              {
2025-11-09T23:19:32.5385195Z                  info!("Generating UTXO commitments for blocks to be pruned...");
2025-11-09T23:19:32.5385384Z                  self.generate_commitments_before_prune(
2025-11-09T23:19:32.5385863Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:439:
2025-11-09T23:19:32.5385989Z                      utxostore,
2025-11-09T23:19:32.5386094Z                  )?;
2025-11-09T23:19:32.5386205Z              } else {
2025-11-09T23:19:32.5386604Z -                warn!("UTXO commitments requested but commitment store or UTXO store not available");
2025-11-09T23:19:32.5386714Z +                warn!(
2025-11-09T23:19:32.5387071Z +                    "UTXO commitments requested but commitment store or UTXO store not available"
2025-11-09T23:19:32.5387190Z +                );
2025-11-09T23:19:32.5387294Z              }
2025-11-09T23:19:32.5387406Z          }
2025-11-09T23:19:32.5387537Z  
2025-11-09T23:19:32.5388019Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:464:
2025-11-09T23:19:32.5388237Z                      // Remove filter from cache but keep filter header
2025-11-09T23:19:32.5388410Z                      if filter_service.has_filter(&hash) {
2025-11-09T23:19:32.5388666Z                          filter_service.remove_filter_for_pruned_block(&hash)?;
2025-11-09T23:19:32.5389058Z -                        debug!("Removed BIP158 filter for pruned block at height {} (header kept)", height);
2025-11-09T23:19:32.5389190Z +                        debug!(
2025-11-09T23:19:32.5389515Z +                            "Removed BIP158 filter for pruned block at height {} (header kept)",
2025-11-09T23:19:32.5389645Z +                            height
2025-11-09T23:19:32.5389767Z +                        );
2025-11-09T23:19:32.5389900Z                      }
2025-11-09T23:19:32.5390020Z                  }
2025-11-09T23:19:32.5390388Z              }
2025-11-09T23:19:32.5390863Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:524:
2025-11-09T23:19:32.5391016Z                  if keep_commitments {
2025-11-09T23:19:32.5391191Z                      #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.5391297Z                      {
2025-11-09T23:19:32.5391533Z -                        if let (Some(ref commitment_store), Some(ref utxostore)) = 
2025-11-09T23:19:32.5391788Z -                            (self.commitment_store.as_ref(), self.utxostore.as_ref()) 
2025-11-09T23:19:32.5392025Z +                        if let (Some(ref commitment_store), Some(ref utxostore)) =
2025-11-09T23:19:32.5392289Z +                            (self.commitment_store.as_ref(), self.utxostore.as_ref())
2025-11-09T23:19:32.5392415Z                          {
2025-11-09T23:19:32.5392607Z                              // Generate commitment if not exists
2025-11-09T23:19:32.5392812Z                              if !commitment_store.has_commitment(&hash)? {
2025-11-09T23:19:32.5393299Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:547:
2025-11-09T23:19:32.5393551Z                          // Filter headers are always kept for chain verification
2025-11-09T23:19:32.5393735Z                          if filter_service.has_filter(&hash) {
2025-11-09T23:19:32.5393995Z                              filter_service.remove_filter_for_pruned_block(&hash)?;
2025-11-09T23:19:32.5394553Z -                            debug!("Removed BIP158 filter for pruned block at height {} (header kept)", height);
2025-11-09T23:19:32.5394681Z +                            debug!(
2025-11-09T23:19:32.5394992Z +                                "Removed BIP158 filter for pruned block at height {} (header kept)",
2025-11-09T23:19:32.5395117Z +                                height
2025-11-09T23:19:32.5395444Z +                            );
2025-11-09T23:19:32.5395576Z                          }
2025-11-09T23:19:32.5395703Z                      }
2025-11-09T23:19:32.5395814Z                  }
2025-11-09T23:19:32.5396266Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:569:
2025-11-09T23:19:32.5396445Z          commitment_store: &CommitmentStore,
2025-11-09T23:19:32.5396586Z          utxostore: &UtxoStore,
2025-11-09T23:19:32.5396715Z      ) -> Result<()> {
2025-11-09T23:19:32.5397044Z -        info!("Generating UTXO commitments for heights 0..{}", prune_to_height);
2025-11-09T23:19:32.5397154Z +        info!(
2025-11-09T23:19:32.5397353Z +            "Generating UTXO commitments for heights 0..{}",
2025-11-09T23:19:32.5397473Z +            prune_to_height
2025-11-09T23:19:32.5397580Z +        );
2025-11-09T23:19:32.5397676Z  
2025-11-09T23:19:32.5397878Z          // For each block to be pruned, generate a commitment
2025-11-09T23:19:32.5398184Z          // We'll generate commitments at checkpoint intervals to save computation
2025-11-09T23:19:32.5398612Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:601:
2025-11-09T23:19:32.5398774Z          commitment_store: &CommitmentStore,
2025-11-09T23:19:32.5398907Z          utxostore: &UtxoStore,
2025-11-09T23:19:32.5399027Z      ) -> Result<()> {
2025-11-09T23:19:32.5399185Z -        #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.5399486Z -        use bllvm_protocol::utxo_commitments::merkle_tree::UtxoMerkleTree;
2025-11-09T23:19:32.5399669Z          use bllvm_protocol::block::connect_block;
2025-11-09T23:19:32.5399822Z          use bllvm_protocol::segwit::Witness;
2025-11-09T23:19:32.5399976Z +        #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.5400251Z +        use bllvm_protocol::utxo_commitments::merkle_tree::UtxoMerkleTree;
2025-11-09T23:19:32.5400362Z  
2025-11-09T23:19:32.5400636Z          // Reconstruct UTXO set at historical height by replaying blocks
2025-11-09T23:19:32.5403137Z          let utxo_set = self.reconstruct_utxo_set_at_height(height, utxostore)?;
2025-11-09T23:19:32.5403861Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:614:
2025-11-09T23:19:32.5404168Z              .map_err(|e| anyhow::anyhow!("Failed to create UTXO Merkle tree: {:?}", e))?;
2025-11-09T23:19:32.5404276Z  
2025-11-09T23:19:32.5404632Z          for (outpoint, utxo) in &utxo_set {
2025-11-09T23:19:32.5404807Z -            utxo_tree.insert(*outpoint, utxo.clone())
2025-11-09T23:19:32.5404924Z +            utxo_tree
2025-11-09T23:19:32.5405086Z +                .insert(*outpoint, utxo.clone())
2025-11-09T23:19:32.5405343Z                  .map_err(|e| anyhow::anyhow!("Failed to insert UTXO: {:?}", e))?;
2025-11-09T23:19:32.5405458Z          }
2025-11-09T23:19:32.5405567Z  
2025-11-09T23:19:32.5406007Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:624:
2025-11-09T23:19:32.5406155Z          // Store commitment
2025-11-09T23:19:32.5406470Z          commitment_store.store_commitment(block_hash, height, &commitment)?;
2025-11-09T23:19:32.5406596Z  
2025-11-09T23:19:32.5406888Z -        debug!("Generated and stored commitment for height {} (hash: {})", 
2025-11-09T23:19:32.5407057Z -               height, hex::encode(block_hash));
2025-11-09T23:19:32.5407179Z +        debug!(
2025-11-09T23:19:32.5407435Z +            "Generated and stored commitment for height {} (hash: {})",
2025-11-09T23:19:32.5407543Z +            height,
2025-11-09T23:19:32.5407683Z +            hex::encode(block_hash)
2025-11-09T23:19:32.5407801Z +        );
2025-11-09T23:19:32.5407910Z  
2025-11-09T23:19:32.5408025Z          Ok(())
2025-11-09T23:19:32.5408147Z      }
2025-11-09T23:19:32.5408627Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:632:
2025-11-09T23:19:32.5408746Z  
2025-11-09T23:19:32.5408986Z      /// Generate UTXO commitment from current UTXO set state
2025-11-09T23:19:32.5411314Z -    /// 
2025-11-09T23:19:32.5411439Z +    ///
2025-11-09T23:19:32.5411874Z      /// This method generates a commitment from the current UTXO set without replaying blocks.
2025-11-09T23:19:32.5412579Z      /// Used during incremental sync when the UTXO set is maintained incrementally.
2025-11-09T23:19:32.5412712Z -    /// 
2025-11-09T23:19:32.5412825Z +    ///
2025-11-09T23:19:32.5412949Z      /// # Arguments
2025-11-09T23:19:32.5413171Z      /// * `block_hash` - Hash of the block at this height
2025-11-09T23:19:32.5413316Z      /// * `height` - Block height
2025-11-09T23:19:32.5413782Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:641:
2025-11-09T23:19:32.5414030Z      /// * `utxo_set` - Current UTXO set (from incremental updates)
2025-11-09T23:19:32.5414535Z      /// * `commitment_store` - Commitment store to save the commitment
2025-11-09T23:19:32.5414667Z -    /// 
2025-11-09T23:19:32.5414791Z +    ///
2025-11-09T23:19:32.5414926Z      /// # Returns
2025-11-09T23:19:32.5415099Z      /// Result indicating success or failure
2025-11-09T23:19:32.5415660Z      #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.5416166Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:658:
2025-11-09T23:19:32.5416508Z              .map_err(|e| anyhow::anyhow!("Failed to create UTXO Merkle tree: {:?}", e))?;
2025-11-09T23:19:32.5416622Z  
2025-11-09T23:19:32.5416795Z          for (outpoint, utxo) in utxo_set {
2025-11-09T23:19:32.5416983Z -            utxo_tree.insert(*outpoint, utxo.clone())
2025-11-09T23:19:32.5417108Z +            utxo_tree
2025-11-09T23:19:32.5417270Z +                .insert(*outpoint, utxo.clone())
2025-11-09T23:19:32.5417550Z                  .map_err(|e| anyhow::anyhow!("Failed to insert UTXO: {:?}", e))?;
2025-11-09T23:19:32.5417667Z          }
2025-11-09T23:19:32.5417780Z  
2025-11-09T23:19:32.5418257Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:668:
2025-11-09T23:19:32.5418407Z          // Store commitment
2025-11-09T23:19:32.5418728Z          commitment_store.store_commitment(block_hash, height, &commitment)?;
2025-11-09T23:19:32.5419094Z  
2025-11-09T23:19:32.5419448Z -        debug!("Generated commitment from current state for height {} (hash: {})", 
2025-11-09T23:19:32.5419625Z -               height, hex::encode(block_hash));
2025-11-09T23:19:32.5419743Z +        debug!(
2025-11-09T23:19:32.5420065Z +            "Generated commitment from current state for height {} (hash: {})",
2025-11-09T23:19:32.5420186Z +            height,
2025-11-09T23:19:32.5420336Z +            hex::encode(block_hash)
2025-11-09T23:19:32.5420460Z +        );
2025-11-09T23:19:32.5420573Z  
2025-11-09T23:19:32.5420689Z          Ok(())
2025-11-09T23:19:32.5420801Z      }
2025-11-09T23:19:32.5421389Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:676:
2025-11-09T23:19:32.5421503Z  
2025-11-09T23:19:32.5421752Z      /// Reconstruct UTXO set at a specific historical height
2025-11-09T23:19:32.5421878Z -    /// 
2025-11-09T23:19:32.5422002Z +    ///
2025-11-09T23:19:32.5422285Z      /// This function replays blocks from genesis to the target height
2025-11-09T23:19:32.5422549Z      /// to reconstruct the exact UTXO set at that point in history.
2025-11-09T23:19:32.5422722Z      #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.5423189Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:703:
2025-11-09T23:19:32.5423322Z                  // Get block
2025-11-09T23:19:32.5423594Z                  if let Some(block) = self.blockstore.get_block(&block_hash)? {
2025-11-09T23:19:32.5423759Z                      // Get witnesses for this block
2025-11-09T23:19:32.5424016Z -                    let witnesses = self.blockstore.get_witness(&block_hash)?
2025-11-09T23:19:32.5424175Z -                        .unwrap_or_else(|| {
2025-11-09T23:19:32.5433095Z -                            // If no witnesses stored, create empty witnesses
2025-11-09T23:19:32.5433693Z -                            block.transactions.iter().map(|_| Vec::new()).collect()
2025-11-09T23:19:32.5433835Z -                        });
2025-11-09T23:19:32.5433975Z +                    let witnesses =
2025-11-09T23:19:32.5434120Z +                        self.blockstore
2025-11-09T23:19:32.5434463Z +                            .get_witness(&block_hash)?
2025-11-09T23:19:32.5434643Z +                            .unwrap_or_else(|| {
2025-11-09T23:19:32.5434863Z +                                // If no witnesses stored, create empty witnesses
2025-11-09T23:19:32.5435145Z +                                block.transactions.iter().map(|_| Vec::new()).collect()
2025-11-09T23:19:32.5435288Z +                            });
2025-11-09T23:19:32.5435409Z  
2025-11-09T23:19:32.5435615Z                      // Apply block to UTXO set using connect_block
2025-11-09T23:19:32.5435983Z                      // This properly handles coinbase transactions and input/output processing
2025-11-09T23:19:32.5436501Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:714:
2025-11-09T23:19:32.5436756Z                      let (validation_result, new_utxo_set) = connect_block(
2025-11-09T23:19:32.5436888Z -                        &block,
2025-11-09T23:19:32.5437029Z -                        &witnesses,
2025-11-09T23:19:32.5437161Z -                        utxo_set,
2025-11-09T23:19:32.5437289Z -                        height,
2025-11-09T23:19:32.5437476Z +                        &block, &witnesses, utxo_set, height,
2025-11-09T23:19:32.5437717Z                          None, // No recent headers needed for historical replay
2025-11-09T23:19:32.5437837Z                      )?;
2025-11-09T23:19:32.5437949Z  
2025-11-09T23:19:32.5438445Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:722:
2025-11-09T23:19:32.5438607Z                      // Check validation result
2025-11-09T23:19:32.5438984Z                      if !matches!(validation_result, bllvm_protocol::ValidationResult::Valid) {
2025-11-09T23:19:32.5441158Z -                        warn!("Block at height {} failed validation during UTXO reconstruction", height);
2025-11-09T23:19:32.5441289Z +                        warn!(
2025-11-09T23:19:32.5441587Z +                            "Block at height {} failed validation during UTXO reconstruction",
2025-11-09T23:19:32.5441728Z +                            height
2025-11-09T23:19:32.5441851Z +                        );
2025-11-09T23:19:32.5442144Z                          // Continue anyway - this might be expected for some edge cases
2025-11-09T23:19:32.5442271Z                      }
2025-11-09T23:19:32.5442381Z  
2025-11-09T23:19:32.5442867Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:740:
2025-11-09T23:19:32.5442989Z              }
2025-11-09T23:19:32.5443110Z          }
2025-11-09T23:19:32.5443223Z  
2025-11-09T23:19:32.5443653Z -        debug!("Reconstructed UTXO set at height {} with {} UTXOs", target_height, utxo_set.len());
2025-11-09T23:19:32.5443789Z +        debug!(
2025-11-09T23:19:32.5444643Z +            "Reconstructed UTXO set at height {} with {} UTXOs",
2025-11-09T23:19:32.5444801Z +            target_height,
2025-11-09T23:19:32.5444926Z +            utxo_set.len()
2025-11-09T23:19:32.5445043Z +        );
2025-11-09T23:19:32.5445175Z          Ok(utxo_set)
2025-11-09T23:19:32.5445290Z      }
2025-11-09T23:19:32.5445404Z  }
2025-11-09T23:19:32.5445881Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:747:
2025-11-09T23:19:32.5445998Z -
2025-11-09T23:19:32.5446107Z  
2025-11-09T23:19:32.5446398Z error[internal]: left behind trailing whitespace
2025-11-09T23:19:32.5452226Z   --> /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:91:91:1
2025-11-09T23:19:32.5452379Z    |
2025-11-09T23:19:32.5452508Z 91 |                 
2025-11-09T23:19:32.5452915Z    | ^^^^^^^^^^^^^^^^
2025-11-09T23:19:32.5453029Z    |
2025-11-09T23:19:32.5453038Z 
2025-11-09T23:19:32.5453335Z warning: rustfmt has failed to format. See previous 1 errors.
2025-11-09T23:19:32.5453356Z 
2025-11-09T23:19:32.5453822Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/txindex.rs:2:
2025-11-09T23:19:32.5453937Z  //!
2025-11-09T23:19:32.5454543Z  //! Provides fast lookup of transactions by hash and maintains transaction metadata.
2025-11-09T23:19:32.5454675Z  
2025-11-09T23:19:32.5454882Z +use crate::storage::database::{Database, Tree};
2025-11-09T23:19:32.5455016Z  use anyhow::Result;
2025-11-09T23:19:32.5455201Z  use bllvm_protocol::{Hash, Transaction};
2025-11-09T23:19:32.5455363Z  use serde::{Deserialize, Serialize};
2025-11-09T23:19:32.5455826Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/txindex.rs:8:
2025-11-09T23:19:32.5456023Z -use crate::storage::database::{Database, Tree};
2025-11-09T23:19:32.5456154Z  use std::sync::Arc;
2025-11-09T23:19:32.5456263Z  
2025-11-09T23:19:32.5456391Z  /// Transaction metadata
2025-11-09T23:19:32.5456875Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/txindex.rs:68:
2025-11-09T23:19:32.5456992Z          };
2025-11-09T23:19:32.5457099Z  
2025-11-09T23:19:32.5457338Z          let metadata_data = bincode::serialize(&metadata)?;
2025-11-09T23:19:32.5457600Z -        self.tx_metadata.insert(tx_hash.as_slice(), &metadata_data)?;
2025-11-09T23:19:32.5457727Z +        self.tx_metadata
2025-11-09T23:19:32.5457901Z +            .insert(tx_hash.as_slice(), &metadata_data)?;
2025-11-09T23:19:32.5458017Z  
2025-11-09T23:19:32.5458147Z          // Index by block
2025-11-09T23:19:32.5458378Z          let block_key = self.block_tx_key(block_hash, tx_index);
2025-11-09T23:19:32.5458851Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/utxostore.rs:2:
2025-11-09T23:19:32.5458956Z  //!
2025-11-09T23:19:32.5459250Z  //! Stores and manages the UTXO set for efficient transaction validation.
2025-11-09T23:19:32.5459372Z  
2025-11-09T23:19:32.5459552Z +use crate::storage::database::{Database, Tree};
2025-11-09T23:19:32.5459926Z  use anyhow::Result;
2025-11-09T23:19:32.5460125Z  use bllvm_protocol::{OutPoint, UtxoSet, UTXO};
2025-11-09T23:19:32.5460329Z -use crate::storage::database::{Database, Tree};
2025-11-09T23:19:32.5460478Z  use std::collections::HashMap;
2025-11-09T23:19:32.5460611Z  use std::sync::Arc;
2025-11-09T23:19:32.5460733Z  
2025-11-09T23:19:32.5461207Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/validation/mod.rs:51:
2025-11-09T23:19:32.5461378Z          context: &BlockValidationContext,
2025-11-09T23:19:32.5461550Z      ) -> Result<(ValidationResult, UtxoSet)> {
2025-11-09T23:19:32.5461747Z          // Create empty witnesses for each transaction
2025-11-09T23:19:32.5462209Z -        let witnesses: Vec<Witness> = context.block.transactions.iter().map(|_| Vec::new()).collect();
2025-11-09T23:19:32.5462383Z +        let witnesses: Vec<Witness> = context
2025-11-09T23:19:32.5462507Z +            .block
2025-11-09T23:19:32.5462642Z +            .transactions
2025-11-09T23:19:32.5462751Z +            .iter()
2025-11-09T23:19:32.5462894Z +            .map(|_| Vec::new())
2025-11-09T23:19:32.5463018Z +            .collect();
2025-11-09T23:19:32.5463143Z          connect_block(
2025-11-09T23:19:32.5463274Z              &context.block,
2025-11-09T23:19:32.5463402Z              &witnesses,
2025-11-09T23:19:32.5463864Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/validation/mod.rs:87:
2025-11-09T23:19:32.5463995Z              .par_iter()
2025-11-09T23:19:32.5464136Z              .map(|context| {
2025-11-09T23:19:32.5464508Z                  // Create empty witnesses for each transaction
2025-11-09T23:19:32.5464994Z -                let witnesses: Vec<Witness> = context.block.transactions.iter().map(|_| Vec::new()).collect();
2025-11-09T23:19:32.5465163Z +                let witnesses: Vec<Witness> = context
2025-11-09T23:19:32.5465512Z +                    .block
2025-11-09T23:19:32.5465638Z +                    .transactions
2025-11-09T23:19:32.5465767Z +                    .iter()
2025-11-09T23:19:32.5465925Z +                    .map(|_| Vec::new())
2025-11-09T23:19:32.5466048Z +                    .collect();
2025-11-09T23:19:32.5466178Z                  connect_block(
2025-11-09T23:19:32.5466310Z                      &context.block,
2025-11-09T23:19:32.5466434Z                      &witnesses,
2025-11-09T23:19:32.5466899Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/validation/mod.rs:116:
2025-11-09T23:19:32.5467014Z  
2025-11-09T23:19:32.5467165Z          for context in contexts {
2025-11-09T23:19:32.5467352Z              // Create empty witnesses for each transaction
2025-11-09T23:19:32.5467809Z -            let witnesses: Vec<Witness> = context.block.transactions.iter().map(|_| Vec::new()).collect();
2025-11-09T23:19:32.5467987Z +            let witnesses: Vec<Witness> = context
2025-11-09T23:19:32.5468118Z +                .block
2025-11-09T23:19:32.5468249Z +                .transactions
2025-11-09T23:19:32.5468369Z +                .iter()
2025-11-09T23:19:32.5469991Z +                .map(|_| Vec::new())
2025-11-09T23:19:32.5470121Z +                .collect();
2025-11-09T23:19:32.5470663Z              let result = connect_block(
2025-11-09T23:19:32.5470806Z                  &context.block,
2025-11-09T23:19:32.5470932Z                  &witnesses,
2025-11-09T23:19:32.5476005Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:9:
2025-11-09T23:19:32.5476210Z  async fn test_request_id_matching() {
2025-11-09T23:19:32.5478262Z      // Test that requests are matched by request_id, not FIFO
2025-11-09T23:19:32.5478575Z      let manager = NetworkManager::new(TransportPreference::TcpOnly);
2025-11-09T23:19:32.5478693Z -    
2025-11-09T23:19:32.5478813Z +
2025-11-09T23:19:32.5479076Z      let peer_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:19:32.5479204Z -    
2025-11-09T23:19:32.5479317Z +
2025-11-09T23:19:32.5479714Z      // Register multiple requests
2025-11-09T23:19:32.5479938Z      let (id1, rx1) = manager.register_request(peer_addr);
2025-11-09T23:19:32.5480146Z      let (id2, rx2) = manager.register_request(peer_addr);
2025-11-09T23:19:32.5480690Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:18:
2025-11-09T23:19:32.5480905Z      let (id3, rx3) = manager.register_request(peer_addr);
2025-11-09T23:19:32.5481016Z -    
2025-11-09T23:19:32.5481126Z +
2025-11-09T23:19:32.5481277Z      // Complete requests out of order
2025-11-09T23:19:32.5481420Z      let response2 = vec![2, 2, 2];
2025-11-09T23:19:32.5481562Z      let response1 = vec![1, 1, 1];
2025-11-09T23:19:32.5482085Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:23:
2025-11-09T23:19:32.5482232Z      let response3 = vec![3, 3, 3];
2025-11-09T23:19:32.5482355Z -    
2025-11-09T23:19:32.5482472Z +
2025-11-09T23:19:32.5482734Z      assert!(manager.complete_request(id2, response2.clone()));
2025-11-09T23:19:32.5482993Z      assert!(manager.complete_request(id1, response1.clone()));
2025-11-09T23:19:32.5483226Z      assert!(manager.complete_request(id3, response3.clone()));
2025-11-09T23:19:32.5483725Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:28:
2025-11-09T23:19:32.5483834Z -    
2025-11-09T23:19:32.5483943Z +
2025-11-09T23:19:32.5484149Z      // Verify each receiver got the correct response
2025-11-09T23:19:32.5484287Z      tokio::select! {
2025-11-09T23:19:32.5484575Z          result = rx1 => {
2025-11-09T23:19:32.5485107Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:35:
2025-11-09T23:19:32.5485264Z              panic!("Request 1 timeout");
2025-11-09T23:19:32.5485385Z          }
2025-11-09T23:19:32.5485495Z      }
2025-11-09T23:19:32.5485813Z -    
2025-11-09T23:19:32.5485925Z +
2025-11-09T23:19:32.5486066Z      tokio::select! {
2025-11-09T23:19:32.5486211Z          result = rx2 => {
2025-11-09T23:19:32.5486394Z              assert_eq!(result.unwrap(), response2);
2025-11-09T23:19:32.5486905Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:44:
2025-11-09T23:19:32.5487062Z              panic!("Request 2 timeout");
2025-11-09T23:19:32.5487186Z          }
2025-11-09T23:19:32.5487300Z      }
2025-11-09T23:19:32.5487410Z -    
2025-11-09T23:19:32.5487532Z +
2025-11-09T23:19:32.5487675Z      tokio::select! {
2025-11-09T23:19:32.5487809Z          result = rx3 => {
2025-11-09T23:19:32.5489775Z              assert_eq!(result.unwrap(), response3);
2025-11-09T23:19:32.5490299Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:59:
2025-11-09T23:19:32.5490461Z  async fn test_request_cancellation() {
2025-11-09T23:19:32.5490761Z      let manager = NetworkManager::new(TransportPreference::TcpOnly);
2025-11-09T23:19:32.5491043Z      let peer_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:19:32.5491161Z -    
2025-11-09T23:19:32.5491272Z +
2025-11-09T23:19:32.5491519Z      let (request_id, rx) = manager.register_request(peer_addr);
2025-11-09T23:19:32.5491645Z -    
2025-11-09T23:19:32.5491759Z +
2025-11-09T23:19:32.5491896Z      // Cancel the request
2025-11-09T23:19:32.5492100Z      assert!(manager.cancel_request(request_id));
2025-11-09T23:19:32.5492215Z -    
2025-11-09T23:19:32.5492330Z +
2025-11-09T23:19:32.5492489Z      // Try to complete it (should fail)
2025-11-09T23:19:32.5492774Z      assert!(!manager.complete_request(request_id, vec![1, 2, 3]));
2025-11-09T23:19:32.5492893Z -    
2025-11-09T23:19:32.5493010Z +
2025-11-09T23:19:32.5493167Z      // Receiver should be closed
2025-11-09T23:19:32.5493312Z      assert!(rx.await.is_err());
2025-11-09T23:19:32.5493433Z  }
2025-11-09T23:19:32.5493961Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:76:
2025-11-09T23:19:32.5494134Z  async fn test_timestamp_cleanup() {
2025-11-09T23:19:32.5494880Z      let manager = NetworkManager::new(TransportPreference::TcpOnly);
2025-11-09T23:19:32.5495159Z      let peer_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:19:32.5495264Z -    
2025-11-09T23:19:32.5495375Z +
2025-11-09T23:19:32.5495515Z      // Register a request
2025-11-09T23:19:32.5495764Z      let (request_id, _rx) = manager.register_request(peer_addr);
2025-11-09T23:19:32.5495864Z -    
2025-11-09T23:19:32.5495973Z +
2025-11-09T23:19:32.5496232Z      // Cleanup requests older than 0 seconds (should remove all)
2025-11-09T23:19:32.5496451Z      let cleaned = manager.cleanup_expired_requests(0);
2025-11-09T23:19:32.5496593Z      assert_eq!(cleaned, 1);
2025-11-09T23:19:32.5497113Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:86:
2025-11-09T23:19:32.5497238Z -    
2025-11-09T23:19:32.5497363Z +
2025-11-09T23:19:32.5497508Z      // Request should be gone
2025-11-09T23:19:32.5497790Z      assert!(!manager.complete_request(request_id, vec![1, 2, 3]));
2025-11-09T23:19:32.5497911Z  }
2025-11-09T23:19:32.5498430Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:92:
2025-11-09T23:19:32.5498673Z  async fn test_multiple_concurrent_requests_per_peer() {
2025-11-09T23:19:32.5498987Z      let manager = NetworkManager::new(TransportPreference::TcpOnly);
2025-11-09T23:19:32.5499243Z      let peer_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:19:32.5511290Z -    
2025-11-09T23:19:32.5511466Z +
2025-11-09T23:19:32.5511679Z      // Register multiple requests from same peer
2025-11-09T23:19:32.5511903Z      let (id1, rx1) = manager.register_request(peer_addr);
2025-11-09T23:19:32.5512118Z      let (id2, rx2) = manager.register_request(peer_addr);
2025-11-09T23:19:32.5512655Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:99:
2025-11-09T23:19:32.5513134Z      let (id3, rx3) = manager.register_request(peer_addr);
2025-11-09T23:19:32.5513259Z -    
2025-11-09T23:19:32.5513382Z +
2025-11-09T23:19:32.5513528Z      // All should be registered
2025-11-09T23:19:32.5513814Z      let pending = manager.get_pending_requests_for_peer(peer_addr);
2025-11-09T23:19:32.5513982Z      assert_eq!(pending.len(), 3);
2025-11-09T23:19:32.5514733Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:104:
2025-11-09T23:19:32.5514913Z      assert!(pending.contains(&id1));
2025-11-09T23:19:32.5515074Z      assert!(pending.contains(&id2));
2025-11-09T23:19:32.5515239Z      assert!(pending.contains(&id3));
2025-11-09T23:19:32.5515351Z -    
2025-11-09T23:19:32.5515467Z +
2025-11-09T23:19:32.5515610Z      // Complete all
2025-11-09T23:19:32.5515786Z      manager.complete_request(id1, vec![1]);
2025-11-09T23:19:32.5515954Z      manager.complete_request(id2, vec![2]);
2025-11-09T23:19:32.5516483Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:111:
2025-11-09T23:19:32.5516679Z      manager.complete_request(id3, vec![3]);
2025-11-09T23:19:32.5516793Z -    
2025-11-09T23:19:32.5516906Z +
2025-11-09T23:19:32.5517074Z      // All should receive responses
2025-11-09T23:19:32.5517246Z      assert_eq!(rx1.await.unwrap(), vec![1]);
2025-11-09T23:19:32.5517411Z      assert_eq!(rx2.await.unwrap(), vec![2]);
2025-11-09T23:19:32.5517910Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:120:
2025-11-09T23:19:32.5518081Z  async fn test_request_metrics() {
2025-11-09T23:19:32.5518394Z      let manager = NetworkManager::new(TransportPreference::TcpOnly);
2025-11-09T23:19:32.5518654Z      let peer_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:19:32.5518780Z -    
2025-11-09T23:19:32.5518892Z +
2025-11-09T23:19:32.5519047Z      // Register and complete a request
2025-11-09T23:19:32.5519284Z      let (id1, _rx1) = manager.register_request(peer_addr);
2025-11-09T23:19:32.5520292Z      manager.complete_request(id1, vec![1, 2, 3]);
2025-11-09T23:19:32.5523392Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:127:
2025-11-09T23:19:32.5523526Z -    
2025-11-09T23:19:32.5523650Z +
2025-11-09T23:19:32.5523780Z      // Check metrics
2025-11-09T23:19:32.5524012Z      let metrics = manager.get_request_metrics(peer_addr);
2025-11-09T23:19:32.5524171Z      assert!(metrics.is_some());
2025-11-09T23:19:32.5524835Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:132:
2025-11-09T23:19:32.5525006Z      assert_eq!(m.total_requests, 1);
2025-11-09T23:19:32.5525186Z      assert_eq!(m.successful_responses, 1);
2025-11-09T23:19:32.5525345Z      assert_eq!(m.failed_requests, 0);
2025-11-09T23:19:32.5525461Z -    
2025-11-09T23:19:32.5525576Z +
2025-11-09T23:19:32.5525722Z      // Record a failure
2025-11-09T23:19:32.5525955Z      let (id2, _rx2) = manager.register_request(peer_addr);
2025-11-09T23:19:32.5526119Z      manager.record_failed_request(id2);
2025-11-09T23:19:32.5526646Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:139:
2025-11-09T23:19:32.5526761Z -    
2025-11-09T23:19:32.5526876Z +
2025-11-09T23:19:32.5527105Z      let metrics = manager.get_request_metrics(peer_addr);
2025-11-09T23:19:32.5527261Z      let m = metrics.unwrap();
2025-11-09T23:19:32.5527414Z      assert_eq!(m.total_requests, 2);
2025-11-09T23:19:32.5527920Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:148:
2025-11-09T23:19:32.5528085Z  async fn test_request_priority() {
2025-11-09T23:19:32.5528389Z      let manager = NetworkManager::new(TransportPreference::TcpOnly);
2025-11-09T23:19:32.5528647Z      let peer_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:19:32.5528771Z -    
2025-11-09T23:19:32.5529149Z +
2025-11-09T23:19:32.5529348Z      // Register requests with different priorities
2025-11-09T23:19:32.5529640Z      let (_id1, _rx1) = manager.register_request_with_priority(peer_addr, 0);
2025-11-09T23:19:32.5529923Z      let (_id2, _rx2) = manager.register_request_with_priority(peer_addr, 5);
2025-11-09T23:19:32.5532833Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:155:
2025-11-09T23:19:32.5533144Z      let (_id3, _rx3) = manager.register_request_with_priority(peer_addr, 10);
2025-11-09T23:19:32.5533269Z -    
2025-11-09T23:19:32.5533383Z +
2025-11-09T23:19:32.5533529Z      // All should be registered
2025-11-09T23:19:32.5533800Z      let pending = manager.get_pending_requests_for_peer(peer_addr);
2025-11-09T23:19:32.5533957Z      assert_eq!(pending.len(), 3);
2025-11-09T23:19:32.5534608Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:160:
2025-11-09T23:19:32.5534726Z  }
2025-11-09T23:19:32.5534864Z -
2025-11-09T23:19:32.5534976Z -
2025-11-09T23:19:32.5535093Z -
2025-11-09T23:19:32.5535202Z  
2025-11-09T23:19:32.5535761Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:8:
2025-11-09T23:19:32.5535933Z  async fn test_ban_list_operations() {
2025-11-09T23:19:32.5536151Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:19:32.5536353Z      let manager = NetworkManager::new(addr);
2025-11-09T23:19:32.5536466Z -    
2025-11-09T23:19:32.5536576Z +
2025-11-09T23:19:32.5536824Z      let test_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:19:32.5536942Z -    
2025-11-09T23:19:32.5537052Z +
2025-11-09T23:19:32.5537173Z      // Test ban
2025-11-09T23:19:32.5537336Z      let now = SystemTime::now()
2025-11-09T23:19:32.5537489Z          .duration_since(UNIX_EPOCH)
2025-11-09T23:19:32.5538052Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:18:
2025-11-09T23:19:32.5538204Z          .as_secs();
2025-11-09T23:19:32.5538423Z      let future_timestamp = now + 3600; // 1 hour from now
2025-11-09T23:19:32.5538875Z      manager.ban_peer(test_addr, future_timestamp);
2025-11-09T23:19:32.5538986Z -    
2025-11-09T23:19:32.5539102Z +
2025-11-09T23:19:32.5539267Z      assert!(manager.is_banned(test_addr));
2025-11-09T23:19:32.5539377Z -    
2025-11-09T23:19:32.5539494Z +
2025-11-09T23:19:32.5540332Z      // Test unban
2025-11-09T23:19:32.5540512Z      manager.unban_peer(test_addr);
2025-11-09T23:19:32.5540681Z      assert!(!manager.is_banned(test_addr));
2025-11-09T23:19:32.5541351Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:30:
2025-11-09T23:19:32.5541524Z  async fn test_ban_list_expiration() {
2025-11-09T23:19:32.5541743Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:19:32.5541944Z      let manager = NetworkManager::new(addr);
2025-11-09T23:19:32.5542064Z -    
2025-11-09T23:19:32.5542188Z +
2025-11-09T23:19:32.5542439Z      let test_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:19:32.5542576Z -    
2025-11-09T23:19:32.5542691Z +
2025-11-09T23:19:32.5542858Z      // Ban with expiration in the past
2025-11-09T23:19:32.5543027Z      let now = SystemTime::now()
2025-11-09T23:19:32.5543182Z          .duration_since(UNIX_EPOCH)
2025-11-09T23:19:32.5543755Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:40:
2025-11-09T23:19:32.5543896Z          .as_secs();
2025-11-09T23:19:32.5544087Z      let past_timestamp = now - 3600; // 1 hour ago
2025-11-09T23:19:32.5544280Z      manager.ban_peer(test_addr, past_timestamp);
2025-11-09T23:19:32.5544589Z -    
2025-11-09T23:19:32.5544721Z +
2025-11-09T23:19:32.5544932Z      // is_banned should automatically check expiration
2025-11-09T23:19:32.5545102Z      assert!(!manager.is_banned(test_addr));
2025-11-09T23:19:32.5545225Z  }
2025-11-09T23:19:32.5545778Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:49:
2025-11-09T23:19:32.5546188Z  async fn test_ban_list_permanent() {
2025-11-09T23:19:32.5546411Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:19:32.5546611Z      let manager = NetworkManager::new(addr);
2025-11-09T23:19:32.5546728Z -    
2025-11-09T23:19:32.5547429Z +
2025-11-09T23:19:32.5547801Z      let test_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:19:32.5547921Z -    
2025-11-09T23:19:32.5548033Z +
2025-11-09T23:19:32.5548176Z      // Permanent ban (timestamp = 0)
2025-11-09T23:19:32.5548338Z      manager.ban_peer(test_addr, 0);
2025-11-09T23:19:32.5548506Z      assert!(manager.is_banned(test_addr));
2025-11-09T23:19:32.5549052Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:58:
2025-11-09T23:19:32.5549171Z -    
2025-11-09T23:19:32.5549279Z +
2025-11-09T23:19:32.5549406Z      // Clear all bans
2025-11-09T23:19:32.5549555Z      manager.clear_bans();
2025-11-09T23:19:32.5549725Z      assert!(!manager.is_banned(test_addr));
2025-11-09T23:19:32.5550273Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:66:
2025-11-09T23:19:32.5550444Z  async fn test_ban_list_multiple_peers() {
2025-11-09T23:19:32.5550675Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:19:32.5550863Z      let manager = NetworkManager::new(addr);
2025-11-09T23:19:32.5551443Z -    
2025-11-09T23:19:32.5551579Z +
2025-11-09T23:19:32.5551821Z      let addr1: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:19:32.5552045Z      let addr2: SocketAddr = "127.0.0.1:8334".parse().unwrap();
2025-11-09T23:19:32.5552272Z      let addr3: SocketAddr = "127.0.0.1:8335".parse().unwrap();
2025-11-09T23:19:32.5552837Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:73:
2025-11-09T23:19:32.5552958Z -    
2025-11-09T23:19:32.5553086Z +
2025-11-09T23:19:32.5553257Z      let now = SystemTime::now()
2025-11-09T23:19:32.5553411Z          .duration_since(UNIX_EPOCH)
2025-11-09T23:19:32.5553800Z          .unwrap()
2025-11-09T23:19:32.5554535Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:77:
2025-11-09T23:19:32.5554688Z          .as_secs();
2025-11-09T23:19:32.5554803Z -    
2025-11-09T23:19:32.5554916Z +
2025-11-09T23:19:32.5555086Z      manager.ban_peer(addr1, now + 3600);
2025-11-09T23:19:32.5555256Z      manager.ban_peer(addr2, 0); // Permanent
2025-11-09T23:19:32.5555502Z      manager.ban_peer(addr3, now + 7200);
2025-11-09T23:19:32.5556064Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:82:
2025-11-09T23:19:32.5556183Z -    
2025-11-09T23:19:32.5556296Z +
2025-11-09T23:19:32.5556501Z      assert_eq!(manager.get_banned_peers().len(), 3);
2025-11-09T23:19:32.5556666Z      assert!(manager.is_banned(addr1));
2025-11-09T23:19:32.5556831Z      assert!(manager.is_banned(addr2));
2025-11-09T23:19:32.5557373Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:86:
2025-11-09T23:19:32.5557545Z      assert!(manager.is_banned(addr3));
2025-11-09T23:19:32.5557658Z -    
2025-11-09T23:19:32.5557770Z +
2025-11-09T23:19:32.5557892Z      // Unban one
2025-11-09T23:19:32.5558049Z      manager.unban_peer(addr2);
2025-11-09T23:19:32.5558253Z      assert_eq!(manager.get_banned_peers().len(), 2);
2025-11-09T23:19:32.5558808Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:91:
2025-11-09T23:19:32.5558982Z      assert!(!manager.is_banned(addr2));
2025-11-09T23:19:32.5559093Z  }
2025-11-09T23:19:32.5559204Z -
2025-11-09T23:19:32.5559316Z  
2025-11-09T23:19:32.5559798Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_tests.rs:22:
2025-11-09T23:19:32.5559950Z          .duration_since(UNIX_EPOCH)
2025-11-09T23:19:32.5560324Z          .unwrap()
2025-11-09T23:19:32.5560459Z          .as_secs();
2025-11-09T23:19:32.5560573Z -    
2025-11-09T23:19:32.5560694Z +
2025-11-09T23:19:32.5560893Z      // Create two ban lists with overlapping entries
2025-11-09T23:19:32.5561056Z      let list1 = BanListMessage {
2025-11-09T23:19:32.5561188Z          is_full: true,
2025-11-09T23:19:32.5561655Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_tests.rs:29:
2025-11-09T23:19:32.5561804Z          ban_list_hash: [0; 32],
2025-11-09T23:19:32.5561943Z          ban_entries: vec![
2025-11-09T23:19:32.5562263Z -            create_test_ban_entry([127, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 8333, now + 3600),
2025-11-09T23:19:32.5562592Z -            create_test_ban_entry([192, 168, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 8333, now + 7200),
2025-11-09T23:19:32.5562739Z +            create_test_ban_entry(
2025-11-09T23:19:32.5562910Z +                [127, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
2025-11-09T23:19:32.5563044Z +                8333,
2025-11-09T23:19:32.5563188Z +                now + 3600,
2025-11-09T23:19:32.5563313Z +            ),
2025-11-09T23:19:32.5563457Z +            create_test_ban_entry(
2025-11-09T23:19:32.5563648Z +                [192, 168, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
2025-11-09T23:19:32.5563766Z +                8333,
2025-11-09T23:19:32.5563896Z +                now + 7200,
2025-11-09T23:19:32.5564014Z +            ),
2025-11-09T23:19:32.5564140Z          ],
2025-11-09T23:19:32.5564276Z          timestamp: now,
2025-11-09T23:19:32.5564565Z      };
2025-11-09T23:19:32.5565052Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_tests.rs:36:
2025-11-09T23:19:32.5565172Z -    
2025-11-09T23:19:32.5565286Z +
2025-11-09T23:19:32.5565437Z      let list2 = BanListMessage {
2025-11-09T23:19:32.5565576Z          is_full: true,
2025-11-09T23:19:32.5565714Z          ban_list_hash: [0; 32],
2025-11-09T23:19:32.5566170Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_tests.rs:40:
2025-11-09T23:19:32.5566330Z          ban_entries: vec![
2025-11-09T23:19:32.5566712Z              // Same address, longer ban
2025-11-09T23:19:32.5567029Z -            create_test_ban_entry([127, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 8333, now + 7200),
2025-11-09T23:19:32.5567180Z +            create_test_ban_entry(
2025-11-09T23:19:32.5567350Z +                [127, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
2025-11-09T23:19:32.5567470Z +                8333,
2025-11-09T23:19:32.5567599Z +                now + 7200,
2025-11-09T23:19:32.5567724Z +            ),
2025-11-09T23:19:32.5567849Z              // New address
2025-11-09T23:19:32.5568148Z -            create_test_ban_entry([10, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 8333, now + 1800),
2025-11-09T23:19:32.5569776Z +            create_test_ban_entry(
2025-11-09T23:19:32.5569940Z +                [10, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
2025-11-09T23:19:32.5570072Z +                8333,
2025-11-09T23:19:32.5570200Z +                now + 1800,
2025-11-09T23:19:32.5570335Z +            ),
2025-11-09T23:19:32.5570454Z          ],
2025-11-09T23:19:32.5570589Z          timestamp: now,
2025-11-09T23:19:32.5570718Z      };
2025-11-09T23:19:32.5571170Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_tests.rs:48:
2025-11-09T23:19:32.5571278Z -    
2025-11-09T23:19:32.5571386Z +
2025-11-09T23:19:32.5571589Z      let merged = merge_ban_lists(vec![&list1, &list2]);
2025-11-09T23:19:32.5571695Z -    
2025-11-09T23:19:32.5571799Z +
2025-11-09T23:19:32.5571949Z      // Should have 3 unique addresses
2025-11-09T23:19:32.5572090Z      assert_eq!(merged.len(), 3);
2025-11-09T23:19:32.5572211Z -    
2025-11-09T23:19:32.5572325Z +
2025-11-09T23:19:32.5572487Z      // 127.0.0.1 should have longer ban (7200)
2025-11-09T23:19:32.5572630Z -    let entry_127 = merged.iter()
2025-11-09T23:19:32.5572775Z -        .find(|e| e.addr.ip[0] == 127)
2025-11-09T23:19:32.5573135Z -        .unwrap();
2025-11-09T23:19:32.5573417Z +    let entry_127 = merged.iter().find(|e| e.addr.ip[0] == 127).unwrap();
2025-11-09T23:19:32.5573627Z      assert_eq!(entry_127.unban_timestamp, now + 7200);
2025-11-09T23:19:32.5573739Z  }
2025-11-09T23:19:32.5573860Z  
2025-11-09T23:19:32.5574519Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_tests.rs:64:
2025-11-09T23:19:32.5574684Z          .duration_since(UNIX_EPOCH)
2025-11-09T23:19:32.5574814Z          .unwrap()
2025-11-09T23:19:32.5574938Z          .as_secs();
2025-11-09T23:19:32.5575054Z -    
2025-11-09T23:19:32.5575161Z +
2025-11-09T23:19:32.5575308Z      // Valid future ban
2025-11-09T23:19:32.5575706Z -    let future_ban = create_test_ban_entry([127, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 8333, now + 3600);
2025-11-09T23:19:32.5575881Z +    let future_ban = create_test_ban_entry(
2025-11-09T23:19:32.5576063Z +        [127, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
2025-11-09T23:19:32.5576198Z +        8333,
2025-11-09T23:19:32.5576323Z +        now + 3600,
2025-11-09T23:19:32.5576449Z +    );
2025-11-09T23:19:32.5576635Z      assert!(validate_ban_entry(&future_ban));
2025-11-09T23:19:32.5576751Z -    
2025-11-09T23:19:32.5576863Z +
2025-11-09T23:19:32.5577014Z      // Valid permanent ban
2025-11-09T23:19:32.5577462Z -    let permanent_ban = create_test_ban_entry([192, 168, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 8333, u64::MAX);
2025-11-09T23:19:32.5577642Z +    let permanent_ban = create_test_ban_entry(
2025-11-09T23:19:32.5577812Z +        [192, 168, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
2025-11-09T23:19:32.5577937Z +        8333,
2025-11-09T23:19:32.5578062Z +        u64::MAX,
2025-11-09T23:19:32.5578177Z +    );
2025-11-09T23:19:32.5578375Z      assert!(validate_ban_entry(&permanent_ban));
2025-11-09T23:19:32.5578491Z -    
2025-11-09T23:19:32.5578601Z +
2025-11-09T23:19:32.5578758Z      // Expired ban (should be invalid)
2025-11-09T23:19:32.5579210Z -    let expired_ban = create_test_ban_entry([10, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 8333, now.saturating_sub(3600));
2025-11-09T23:19:32.5579674Z +    let expired_ban = create_test_ban_entry(
2025-11-09T23:19:32.5579835Z +        [10, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
2025-11-09T23:19:32.5579961Z +        8333,
2025-11-09T23:19:32.5580112Z +        now.saturating_sub(3600),
2025-11-09T23:19:32.5580225Z +    );
2025-11-09T23:19:32.5580412Z      assert!(!validate_ban_entry(&expired_ban));
2025-11-09T23:19:32.5580518Z  }
2025-11-09T23:19:32.5580624Z  
2025-11-09T23:19:32.5581097Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_tests.rs:84:
2025-11-09T23:19:32.5581263Z          .duration_since(UNIX_EPOCH)
2025-11-09T23:19:32.5581383Z          .unwrap()
2025-11-09T23:19:32.5581503Z          .as_secs();
2025-11-09T23:19:32.5581628Z -    
2025-11-09T23:19:32.5581740Z +
2025-11-09T23:19:32.5581878Z      let entries = vec![
2025-11-09T23:19:32.5582211Z -        create_test_ban_entry([127, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 8333, now + 3600),
2025-11-09T23:19:32.5582535Z -        create_test_ban_entry([192, 168, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 8333, now + 7200),
2025-11-09T23:19:32.5582676Z +        create_test_ban_entry(
2025-11-09T23:19:32.5582847Z +            [127, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
2025-11-09T23:19:32.5582974Z +            8333,
2025-11-09T23:19:32.5583094Z +            now + 3600,
2025-11-09T23:19:32.5583211Z +        ),
2025-11-09T23:19:32.5583352Z +        create_test_ban_entry(
2025-11-09T23:19:32.5583524Z +            [192, 168, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
2025-11-09T23:19:32.5583643Z +            8333,
2025-11-09T23:19:32.5583779Z +            now + 7200,
2025-11-09T23:19:32.5583895Z +        ),
2025-11-09T23:19:32.5584009Z      ];
2025-11-09T23:19:32.5584123Z -    
2025-11-09T23:19:32.5584245Z +
2025-11-09T23:19:32.5584624Z      let hash1 = calculate_ban_list_hash(&entries);
2025-11-09T23:19:32.5585075Z      let hash2 = calculate_ban_list_hash(&entries);
2025-11-09T23:19:32.5585199Z -    
2025-11-09T23:19:32.5585317Z +
2025-11-09T23:19:32.5585485Z      // Same entries should produce same hash
2025-11-09T23:19:32.5585625Z      assert_eq!(hash1, hash2);
2025-11-09T23:19:32.5585740Z -    
2025-11-09T23:19:32.5585848Z +
2025-11-09T23:19:32.5585975Z      // Verify hash
2025-11-09T23:19:32.5586181Z      assert!(verify_ban_list_hash(&entries, &hash1));
2025-11-09T23:19:32.5586295Z  }
2025-11-09T23:19:32.5588512Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_tests.rs:102:
2025-11-09T23:19:32.5588623Z -
2025-11-09T23:19:32.5588738Z -
2025-11-09T23:19:32.5589544Z -
2025-11-09T23:19:32.5589758Z  
2025-11-09T23:19:32.5590353Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip158_implementation_tests.rs:1:
2025-11-09T23:19:32.5590531Z  //! Tests for BIP158 implementation
2025-11-09T23:19:32.5590643Z  
2025-11-09T23:19:32.5591011Z  use bllvm_node::bip158::{build_block_filter, match_filter, CompactBlockFilter};
2025-11-09T23:19:32.5591441Z -use bllvm_protocol::{Transaction, TransactionInput, TransactionOutput, OutPoint};
2025-11-09T23:19:32.5591886Z +use bllvm_protocol::{OutPoint, Transaction, TransactionInput, TransactionOutput};
2025-11-09T23:19:32.5591999Z  
2025-11-09T23:19:32.5592120Z  #[test]
2025-11-09T23:19:32.5592305Z  fn test_build_block_filter_with_transactions() {
2025-11-09T23:19:32.5592871Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip158_implementation_tests.rs:15:
2025-11-09T23:19:32.5593000Z          }],
2025-11-09T23:19:32.5593128Z          lock_time: 0,
2025-11-09T23:19:32.5593242Z      };
2025-11-09T23:19:32.5593353Z -    
2025-11-09T23:19:32.5593474Z +
2025-11-09T23:19:32.5593614Z      let tx2 = Transaction {
2025-11-09T23:19:32.5593739Z          version: 1,
2025-11-09T23:19:32.5593909Z          inputs: vec![],
2025-11-09T23:19:32.5594626Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip158_implementation_tests.rs:25:
2025-11-09T23:19:32.5594757Z          }],
2025-11-09T23:19:32.5595121Z          lock_time: 0,
2025-11-09T23:19:32.5595240Z      };
2025-11-09T23:19:32.5595354Z -    
2025-11-09T23:19:32.5595462Z +
2025-11-09T23:19:32.5595708Z      let filter = build_block_filter(&[tx1, tx2], &[]).unwrap();
2025-11-09T23:19:32.5595867Z      assert_eq!(filter.num_elements, 2);
2025-11-09T23:19:32.5596062Z      assert!(!filter.filter_data.is_empty());
2025-11-09T23:19:32.5596614Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip158_implementation_tests.rs:42:
2025-11-09T23:19:32.5596729Z          }],
2025-11-09T23:19:32.5596859Z          lock_time: 0,
2025-11-09T23:19:32.5596976Z      };
2025-11-09T23:19:32.5597091Z -    
2025-11-09T23:19:32.5597201Z +
2025-11-09T23:19:32.5597553Z      let filter = build_block_filter(&[tx.clone()], &[]).unwrap();
2025-11-09T23:19:32.5597664Z -    
2025-11-09T23:19:32.5597776Z +
2025-11-09T23:19:32.5599806Z      // Script that's in the filter should match
2025-11-09T23:19:32.5600060Z      assert!(match_filter(&filter, &tx.outputs[0].script_pubkey));
2025-11-09T23:19:32.5600186Z  }
2025-11-09T23:19:32.5600767Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip158_implementation_tests.rs:67:
2025-11-09T23:19:32.5600890Z          }],
2025-11-09T23:19:32.5601248Z          lock_time: 0,
2025-11-09T23:19:32.5601359Z      };
2025-11-09T23:19:32.5601477Z -    
2025-11-09T23:19:32.5601589Z +
2025-11-09T23:19:32.5601782Z      // Previous output script (UTXO being spent)
2025-11-09T23:19:32.5601977Z      let prev_script = vec![0x54, 0x55]; // OP_4 OP_5
2025-11-09T23:19:32.5602096Z -    
2025-11-09T23:19:32.5602204Z +
2025-11-09T23:19:32.5602517Z      let filter = build_block_filter(&[tx], &[prev_script.clone()]).unwrap();
2025-11-09T23:19:32.5602640Z -    
2025-11-09T23:19:32.5602752Z +
2025-11-09T23:19:32.5602980Z      // Both output script and previous script should match
2025-11-09T23:19:32.5603405Z      assert!(filter.num_elements >= 1);
2025-11-09T23:19:32.5603527Z  }
2025-11-09T23:19:32.5604106Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip158_implementation_tests.rs:79:
2025-11-09T23:19:32.5604236Z -
2025-11-09T23:19:32.5604541Z  
2025-11-09T23:19:32.5605011Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:1:
2025-11-09T23:19:32.5605226Z  //! Tests for BIP70 payment verification and signing
2025-11-09T23:19:32.5605344Z  
2025-11-09T23:19:32.5605789Z -use bllvm_node::bip70::{PaymentRequest, Payment, PaymentOutput, PaymentProtocolServer};
2025-11-09T23:19:32.5606013Z -use bllvm_node::network::protocol::PaymentMessage;
2025-11-09T23:19:32.5606416Z -use bllvm_protocol::{Transaction, TransactionInput, TransactionOutput, OutPoint};
2025-11-09T23:19:32.5606742Z  use bllvm_consensus::serialization::transaction::serialize_transaction;
2025-11-09T23:19:32.5607155Z +use bllvm_node::bip70::{Payment, PaymentOutput, PaymentProtocolServer, PaymentRequest};
2025-11-09T23:19:32.5607389Z +use bllvm_node::network::protocol::PaymentMessage;
2025-11-09T23:19:32.5607790Z +use bllvm_protocol::{OutPoint, Transaction, TransactionInput, TransactionOutput};
2025-11-09T23:19:32.5607941Z  use secp256k1::{Secp256k1, SecretKey};
2025-11-09T23:19:32.5608053Z  
2025-11-09T23:19:32.5608175Z  #[test]
2025-11-09T23:19:32.5608625Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:13:
2025-11-09T23:19:32.5610587Z          script: vec![0x51], // OP_1
2025-11-09T23:19:32.5610732Z          amount: Some(1000),
2025-11-09T23:19:32.5610847Z      };
2025-11-09T23:19:32.5610963Z -    
2025-11-09T23:19:32.5611164Z -    let payment_request = PaymentRequest::new(
2025-11-09T23:19:32.5611310Z -        "main".to_string(),
2025-11-09T23:19:32.5611450Z -        vec![output.clone()],
2025-11-09T23:19:32.5611565Z -        1234567890,
2025-11-09T23:19:32.5611688Z -    );
2025-11-09T23:19:32.5611803Z -    
2025-11-09T23:19:32.5611908Z +
2025-11-09T23:19:32.5612372Z +    let payment_request = PaymentRequest::new("main".to_string(), vec![output.clone()], 1234567890);
2025-11-09T23:19:32.5612727Z +
2025-11-09T23:19:32.5612882Z      // Create a payment transaction
2025-11-09T23:19:32.5613018Z      let tx = Transaction {
2025-11-09T23:19:32.5613150Z          version: 1,
2025-11-09T23:19:32.5613615Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:37:
2025-11-09T23:19:32.5613736Z          }],
2025-11-09T23:19:32.5613867Z          lock_time: 0,
2025-11-09T23:19:32.5613995Z      };
2025-11-09T23:19:32.5614110Z -    
2025-11-09T23:19:32.5614223Z +
2025-11-09T23:19:32.5614610Z      let tx_bytes = serialize_transaction(&tx);
2025-11-09T23:19:32.5614730Z -    
2025-11-09T23:19:32.5614844Z +
2025-11-09T23:19:32.5615037Z      let payment = Payment::new(vec![tx_bytes]);
2025-11-09T23:19:32.5615155Z -    
2025-11-09T23:19:32.5615268Z +
2025-11-09T23:19:32.5615412Z      // Create payment message
2025-11-09T23:19:32.5615585Z      let payment_msg = PaymentMessage {
2025-11-09T23:19:32.5615714Z          payment,
2025-11-09T23:19:32.5616156Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:48:
2025-11-09T23:19:32.5616310Z          payment_id: vec![1, 2, 3, 4],
2025-11-09T23:19:32.5616426Z      };
2025-11-09T23:19:32.5616529Z -    
2025-11-09T23:19:32.5616637Z +
2025-11-09T23:19:32.5616844Z      // Process payment (without merchant key for now)
2025-11-09T23:19:32.5617099Z      let result = PaymentProtocolServer::process_payment(
2025-11-09T23:19:32.5617232Z          &payment_msg,
2025-11-09T23:19:32.5617689Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:54:
2025-11-09T23:19:32.5617842Z          &payment_request,
2025-11-09T23:19:32.5617988Z          None, // No merchant key
2025-11-09T23:19:32.5618102Z      );
2025-11-09T23:19:32.5618225Z -    
2025-11-09T23:19:32.5618336Z +
2025-11-09T23:19:32.5618504Z      // Should succeed (validation passes)
2025-11-09T23:19:32.5618888Z      assert!(result.is_ok());
2025-11-09T23:19:32.5619012Z  }
2025-11-09T23:19:32.5619473Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:63:
2025-11-09T23:19:32.5619633Z  fn test_payment_ack_signing() {
2025-11-09T23:19:32.5619796Z      let secp = Secp256k1::new();
2025-11-09T23:19:32.5620039Z      let merchant_key = SecretKey::from_slice(&[1; 32]).unwrap();
2025-11-09T23:19:32.5620152Z -    
2025-11-09T23:19:32.5620262Z +
2025-11-09T23:19:32.5620450Z      // Create payment request with merchant pubkey
2025-11-09T23:19:32.5620601Z      let output = PaymentOutput {
2025-11-09T23:19:32.5620734Z          script: vec![0x51],
2025-11-09T23:19:32.5623183Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:70:
2025-11-09T23:19:32.5623313Z          amount: Some(1000),
2025-11-09T23:19:32.5623422Z      };
2025-11-09T23:19:32.5623528Z -    
2025-11-09T23:19:32.5623728Z -    let mut payment_request = PaymentRequest::new(
2025-11-09T23:19:32.5623866Z -        "main".to_string(),
2025-11-09T23:19:32.5623993Z -        vec![output],
2025-11-09T23:19:32.5624122Z -        1234567890,
2025-11-09T23:19:32.5624229Z -    );
2025-11-09T23:19:32.5624534Z -    
2025-11-09T23:19:32.5624648Z +
2025-11-09T23:19:32.5625103Z +    let mut payment_request = PaymentRequest::new("main".to_string(), vec![output], 1234567890);
2025-11-09T23:19:32.5625217Z +
2025-11-09T23:19:32.5625361Z      // Set merchant pubkey
2025-11-09T23:19:32.5625755Z      let merchant_pubkey = secp256k1::PublicKey::from_secret_key(&secp, &merchant_key);
2025-11-09T23:19:32.5626129Z      payment_request.merchant_pubkey = Some(merchant_pubkey.serialize().to_vec());
2025-11-09T23:19:32.5626586Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:82:
2025-11-09T23:19:32.5626708Z -    
2025-11-09T23:19:32.5626818Z +
2025-11-09T23:19:32.5626945Z      // Create payment
2025-11-09T23:19:32.5627085Z      let tx = Transaction {
2025-11-09T23:19:32.5627225Z          version: 1,
2025-11-09T23:19:32.5627651Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:97:
2025-11-09T23:19:32.5627978Z          }],
2025-11-09T23:19:32.5628107Z          lock_time: 0,
2025-11-09T23:19:32.5628224Z      };
2025-11-09T23:19:32.5628335Z -    
2025-11-09T23:19:32.5628446Z +
2025-11-09T23:19:32.5628637Z      let tx_bytes = serialize_transaction(&tx);
2025-11-09T23:19:32.5628826Z      let payment = Payment::new(vec![tx_bytes]);
2025-11-09T23:19:32.5628940Z -    
2025-11-09T23:19:32.5629052Z +
2025-11-09T23:19:32.5629204Z      let payment_msg = PaymentMessage {
2025-11-09T23:19:32.5629318Z          payment,
2025-11-09T23:19:32.5629454Z          payment_id: vec![1, 2, 3, 4],
2025-11-09T23:19:32.5631316Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:107:
2025-11-09T23:19:32.5631431Z      };
2025-11-09T23:19:32.5631545Z -    
2025-11-09T23:19:32.5631659Z +
2025-11-09T23:19:32.5631823Z      // Process payment with merchant key
2025-11-09T23:19:32.5632051Z -    let result = PaymentProtocolServer::process_payment(
2025-11-09T23:19:32.5632181Z -        &payment_msg,
2025-11-09T23:19:32.5632321Z -        &payment_request,
2025-11-09T23:19:32.5632458Z -        Some(&merchant_key),
2025-11-09T23:19:32.5632575Z -    );
2025-11-09T23:19:32.5632697Z -    
2025-11-09T23:19:32.5632818Z +    let result =
2025-11-09T23:19:32.5633299Z +        PaymentProtocolServer::process_payment(&payment_msg, &payment_request, Some(&merchant_key));
2025-11-09T23:19:32.5633410Z +
2025-11-09T23:19:32.5633557Z      assert!(result.is_ok());
2025-11-09T23:19:32.5635190Z      let ack_msg = result.unwrap();
2025-11-09T23:19:32.5635341Z -    
2025-11-09T23:19:32.5635462Z +
2025-11-09T23:19:32.5635674Z      // Verify signature is present when key provided
2025-11-09T23:19:32.5635881Z      assert!(!ack_msg.merchant_signature.is_empty());
2025-11-09T23:19:32.5635996Z  }
2025-11-09T23:19:32.5636437Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:122:
2025-11-09T23:19:32.5636787Z -
2025-11-09T23:19:32.5636896Z  
2025-11-09T23:19:32.5637329Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:1:
2025-11-09T23:19:32.5637510Z -use bllvm_protocol::ProtocolVersion;
2025-11-09T23:19:32.5637709Z  use bllvm_node::storage::blockstore::BlockStore;
2025-11-09T23:19:32.5637908Z  use bllvm_node::storage::chainstate::ChainState;
2025-11-09T23:19:32.5638077Z  use bllvm_node::storage::txindex::TxIndex;
2025-11-09T23:19:32.5638486Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:9:
2025-11-09T23:19:32.5638632Z  use bllvm_node::OutPoint;
2025-11-09T23:19:32.5638783Z  use bllvm_node::Transaction;
2025-11-09T23:19:32.5639077Z  use bllvm_node::{ByteString, TransactionInput, TransactionOutput};
2025-11-09T23:19:32.5639246Z +use bllvm_protocol::ProtocolVersion;
2025-11-09T23:19:32.5639399Z  use std::collections::HashMap;
2025-11-09T23:19:32.5639544Z  use tempfile::TempDir;
2025-11-09T23:19:32.5639652Z  
2025-11-09T23:19:32.5640245Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:1:
2025-11-09T23:19:32.5640432Z  //! Tests for fee calculation functionality
2025-11-09T23:19:32.5640544Z  
2025-11-09T23:19:32.5640728Z  use bllvm_node::node::mempool::MempoolManager;
2025-11-09T23:19:32.5640983Z -use bllvm_protocol::{Transaction, UtxoSet, OutPoint, UTXO};
2025-11-09T23:19:32.5641227Z +use bllvm_protocol::{OutPoint, Transaction, UtxoSet, UTXO};
2025-11-09T23:19:32.5641335Z  
2025-11-09T23:19:32.5641459Z  #[test]
2025-11-09T23:19:32.5641619Z  fn test_calculate_transaction_fee() {
2025-11-09T23:19:32.5642133Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:8:
2025-11-09T23:19:32.5642307Z      let mempool = MempoolManager::new();
2025-11-09T23:19:32.5642418Z -    
2025-11-09T23:19:32.5642527Z +
2025-11-09T23:19:32.5642675Z      // Create a simple transaction
2025-11-09T23:19:32.5642844Z      let mut utxo_set = UtxoSet::new();
2025-11-09T23:19:32.5642953Z -    
2025-11-09T23:19:32.5643315Z +
2025-11-09T23:19:32.5643442Z      // Add a UTXO
2025-11-09T23:19:32.5643602Z      let outpoint = OutPoint {
2025-11-09T23:19:32.5643735Z          hash: [0u8; 32],
2025-11-09T23:19:32.5644267Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:16:
2025-11-09T23:19:32.5644643Z          index: 0,
2025-11-09T23:19:32.5644768Z      };
2025-11-09T23:19:32.5644899Z      let utxo = UTXO {
2025-11-09T23:19:32.5645045Z -        value: 100_000_000, // 1 BTC
2025-11-09T23:19:32.5645220Z +        value: 100_000_000,                    // 1 BTC
2025-11-09T23:19:32.5645438Z          script_pubkey: vec![0x76, 0xa9, 0x14], // P2PKH script
2025-11-09T23:19:32.5645548Z      };
2025-11-09T23:19:32.5645707Z      utxo_set.insert(outpoint, utxo);
2025-11-09T23:19:32.5646215Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:23:
2025-11-09T23:19:32.5646338Z -    
2025-11-09T23:19:32.5648298Z +
2025-11-09T23:19:32.5648497Z      // Create transaction with 1 input and 1 output
2025-11-09T23:19:32.5648649Z      let tx = Transaction {
2025-11-09T23:19:32.5648774Z          version: 1,
2025-11-09T23:19:32.5649300Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:36:
2025-11-09T23:19:32.5649421Z          }],
2025-11-09T23:19:32.5649552Z          lock_time: 0,
2025-11-09T23:19:32.5649679Z      };
2025-11-09T23:19:32.5649790Z -    
2025-11-09T23:19:32.5649903Z +
2025-11-09T23:19:32.5650156Z      let fee = mempool.calculate_transaction_fee(&tx, &utxo_set);
2025-11-09T23:19:32.5650277Z -    
2025-11-09T23:19:32.5650389Z +
2025-11-09T23:19:32.5650641Z      // Fee should be 1 BTC - 0.99 BTC = 0.01 BTC = 1,000,000 satoshis
2025-11-09T23:19:32.5650794Z      assert_eq!(fee, 1_000_000);
2025-11-09T23:19:32.5650908Z  }
2025-11-09T23:19:32.5651430Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:46:
2025-11-09T23:19:32.5651804Z  #[test]
2025-11-09T23:19:32.5652014Z  fn test_calculate_transaction_fee_zero_fee() {
2025-11-09T23:19:32.5652198Z      let mempool = MempoolManager::new();
2025-11-09T23:19:32.5652311Z -    
2025-11-09T23:19:32.5652431Z +
2025-11-09T23:19:32.5652584Z      let mut utxo_set = UtxoSet::new();
2025-11-09T23:19:32.5652725Z      let outpoint = OutPoint {
2025-11-09T23:19:32.5652853Z          hash: [0u8; 32],
2025-11-09T23:19:32.5653371Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:57:
2025-11-09T23:19:32.5653513Z          script_pubkey: vec![],
2025-11-09T23:19:32.5653627Z      };
2025-11-09T23:19:32.5653793Z      utxo_set.insert(outpoint, utxo);
2025-11-09T23:19:32.5653907Z -    
2025-11-09T23:19:32.5654017Z +
2025-11-09T23:19:32.5654218Z      // Transaction with same input and output (no fee)
2025-11-09T23:19:32.5654617Z      let tx = Transaction {
2025-11-09T23:19:32.5654767Z          version: 1,
2025-11-09T23:19:32.5655278Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:73:
2025-11-09T23:19:32.5655401Z          }],
2025-11-09T23:19:32.5655527Z          lock_time: 0,
2025-11-09T23:19:32.5655632Z      };
2025-11-09T23:19:32.5655734Z -    
2025-11-09T23:19:32.5655853Z +
2025-11-09T23:19:32.5656104Z      let fee = mempool.calculate_transaction_fee(&tx, &utxo_set);
2025-11-09T23:19:32.5656243Z      assert_eq!(fee, 0);
2025-11-09T23:19:32.5656361Z  }
2025-11-09T23:19:32.5656840Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:81:
2025-11-09T23:19:32.5656951Z  #[test]
2025-11-09T23:19:32.5657151Z  fn test_calculate_transaction_fee_missing_utxo() {
2025-11-09T23:19:32.5657344Z      let mempool = MempoolManager::new();
2025-11-09T23:19:32.5657459Z -    
2025-11-09T23:19:32.5657568Z +
2025-11-09T23:19:32.5657776Z      let utxo_set = UtxoSet::new(); // Empty UTXO set
2025-11-09T23:19:32.5657900Z -    
2025-11-09T23:19:32.5658009Z +
2025-11-09T23:19:32.5660433Z      let outpoint = OutPoint {
2025-11-09T23:19:32.5660853Z          hash: [0u8; 32],
2025-11-09T23:19:32.5660982Z          index: 0,
2025-11-09T23:19:32.5661523Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:90:
2025-11-09T23:19:32.5661650Z      };
2025-11-09T23:19:32.5661766Z -    
2025-11-09T23:19:32.5661881Z +
2025-11-09T23:19:32.5662021Z      let tx = Transaction {
2025-11-09T23:19:32.5662156Z          version: 1,
2025-11-09T23:19:32.5662336Z          inputs: vec![bllvm_protocol::TxIn {
2025-11-09T23:19:32.5662871Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:103:
2025-11-09T23:19:32.5662994Z          }],
2025-11-09T23:19:32.5663117Z          lock_time: 0,
2025-11-09T23:19:32.5663230Z      };
2025-11-09T23:19:32.5663347Z -    
2025-11-09T23:19:32.5663459Z +
2025-11-09T23:19:32.5663716Z      let fee = mempool.calculate_transaction_fee(&tx, &utxo_set);
2025-11-09T23:19:32.5664106Z      // If UTXO is missing, input_total will be 0, so fee will be 0 (or negative, but we return 0)
2025-11-09T23:19:32.5664258Z      assert_eq!(fee, 0);
2025-11-09T23:19:32.5665029Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:110:
2025-11-09T23:19:32.5665145Z  }
2025-11-09T23:19:32.5665258Z -
2025-11-09T23:19:32.5665370Z  
2025-11-09T23:19:32.5665895Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/iroh_peer_tracking_tests.rs:1:
2025-11-09T23:19:32.5666098Z  //! Tests for Iroh peer tracking with TransportAddr
2025-11-09T23:19:32.5666212Z  
2025-11-09T23:19:32.5666457Z -use bllvm_node::network::{NetworkManager, PeerManager};
2025-11-09T23:19:32.5666660Z  use bllvm_node::network::transport::TransportAddr;
2025-11-09T23:19:32.5666894Z +use bllvm_node::network::{NetworkManager, PeerManager};
2025-11-09T23:19:32.5667030Z  use std::net::SocketAddr;
2025-11-09T23:19:32.5667347Z  
2025-11-09T23:19:32.5667457Z  #[test]
2025-11-09T23:19:32.5668005Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/iroh_peer_tracking_tests.rs:8:
2025-11-09T23:19:32.5668181Z  fn test_peer_manager_transport_addr() {
2025-11-09T23:19:32.5668360Z      let mut manager = PeerManager::new(10);
2025-11-09T23:19:32.5668481Z -    
2025-11-09T23:19:32.5668590Z +
2025-11-09T23:19:32.5668836Z      let addr1: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:19:32.5669061Z      let addr2: SocketAddr = "127.0.0.1:8334".parse().unwrap();
2025-11-09T23:19:32.5669168Z -    
2025-11-09T23:19:32.5669283Z +
2025-11-09T23:19:32.5669413Z      // Test TCP peer
2025-11-09T23:19:32.5669608Z      let tcp_addr1 = TransportAddr::Tcp(addr1);
2025-11-09T23:19:32.5669782Z      let tcp_addr2 = TransportAddr::Tcp(addr2);
2025-11-09T23:19:32.5670319Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/iroh_peer_tracking_tests.rs:17:
2025-11-09T23:19:32.5670452Z -    
2025-11-09T23:19:32.5670558Z +
2025-11-09T23:19:32.5670841Z      // Create mock peers (would need actual Peer instances in real test)
2025-11-09T23:19:32.5672958Z      // For now, just test that TransportAddr works as HashMap key
2025-11-09T23:19:32.5673125Z      assert_ne!(tcp_addr1, tcp_addr2);
2025-11-09T23:19:32.5673648Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/iroh_peer_tracking_tests.rs:21:
2025-11-09T23:19:32.5673766Z -    
2025-11-09T23:19:32.5673874Z +
2025-11-09T23:19:32.5674057Z      // Test Iroh peer (different transport type)
2025-11-09T23:19:32.5674192Z      #[cfg(feature = "iroh")]
2025-11-09T23:19:32.5674537Z      {
2025-11-09T23:19:32.5675065Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/iroh_peer_tracking_tests.rs:31:
2025-11-09T23:19:32.5675185Z  #[test]
2025-11-09T23:19:32.5675349Z  fn test_find_transport_addr_by_socket() {
2025-11-09T23:19:32.5675521Z      let mut manager = PeerManager::new(10);
2025-11-09T23:19:32.5675647Z -    
2025-11-09T23:19:32.5675753Z +
2025-11-09T23:19:32.5675978Z      let addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:19:32.5676412Z      let tcp_addr = TransportAddr::Tcp(addr);
2025-11-09T23:19:32.5676533Z -    
2025-11-09T23:19:32.5676642Z +
2025-11-09T23:19:32.5676807Z      // Should not find peer that doesn't exist
2025-11-09T23:19:32.5677081Z      assert!(manager.find_transport_addr_by_socket(addr).is_none());
2025-11-09T23:19:32.5677187Z -    
2025-11-09T23:19:32.5677292Z +
2025-11-09T23:19:32.5677434Z      // After adding, should find it
2025-11-09T23:19:32.5677642Z      // Note: Would need actual Peer instance to test fully
2025-11-09T23:19:32.5677798Z      // This test validates the lookup logic
2025-11-09T23:19:32.5678313Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/iroh_peer_tracking_tests.rs:46:
2025-11-09T23:19:32.5678431Z  #[test]
2025-11-09T23:19:32.5678576Z  fn test_peer_socket_addresses() {
2025-11-09T23:19:32.5678742Z      let mut manager = PeerManager::new(10);
2025-11-09T23:19:32.5678861Z -    
2025-11-09T23:19:32.5678966Z +
2025-11-09T23:19:32.5679208Z      let addr1: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:19:32.5679428Z      let addr2: SocketAddr = "127.0.0.1:8334".parse().unwrap();
2025-11-09T23:19:32.5679541Z -    
2025-11-09T23:19:32.5679646Z +
2025-11-09T23:19:32.5679772Z      // Add TCP peers
2025-11-09T23:19:32.5679967Z      let tcp_addr1 = TransportAddr::Tcp(addr1);
2025-11-09T23:19:32.5680143Z      let tcp_addr2 = TransportAddr::Tcp(addr2);
2025-11-09T23:19:32.5682489Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/iroh_peer_tracking_tests.rs:56:
2025-11-09T23:19:32.5682605Z -    
2025-11-09T23:19:32.5682725Z +
2025-11-09T23:19:32.5682980Z      // Test that peer_socket_addresses returns TCP/Quinn addresses
2025-11-09T23:19:32.5683131Z      // and skips Iroh addresses
2025-11-09T23:19:32.5683354Z      let socket_addrs = manager.peer_socket_addresses();
2025-11-09T23:19:32.5684122Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/iroh_peer_tracking_tests.rs:60:
2025-11-09T23:19:32.5684598Z      // Should be empty since no peers added, but validates method exists
2025-11-09T23:19:32.5684767Z      assert_eq!(socket_addrs.len(), 0);
2025-11-09T23:19:32.5684881Z  }
2025-11-09T23:19:32.5684990Z -
2025-11-09T23:19:32.5685098Z  
2025-11-09T23:19:32.5685578Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:1:
2025-11-09T23:19:32.5685753Z  //! Tests for MempoolManager refactoring
2025-11-09T23:19:32.5685866Z  
2025-11-09T23:19:32.5686084Z  use bllvm_node::node::mempool::MempoolManager;
2025-11-09T23:19:32.5686588Z -use bllvm_protocol::{Transaction, TransactionInput, TransactionOutput, OutPoint, UtxoSet, UTXO};
2025-11-09T23:19:32.5687070Z +use bllvm_protocol::{OutPoint, Transaction, TransactionInput, TransactionOutput, UtxoSet, UTXO};
2025-11-09T23:19:32.5687236Z  use std::collections::HashMap;
2025-11-09T23:19:32.5687361Z  
2025-11-09T23:19:32.5687492Z  #[tokio::test]
2025-11-09T23:19:32.5687958Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:8:
2025-11-09T23:19:32.5688190Z  async fn test_mempool_stores_full_transactions() {
2025-11-09T23:19:32.5688375Z      let mut mempool = MempoolManager::new();
2025-11-09T23:19:32.5688492Z -    
2025-11-09T23:19:32.5688606Z +
2025-11-09T23:19:32.5688751Z      // Create a test transaction
2025-11-09T23:19:32.5688887Z      let tx = Transaction {
2025-11-09T23:19:32.5689011Z          version: 1,
2025-11-09T23:19:32.5689492Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:25:
2025-11-09T23:19:32.5689609Z          }],
2025-11-09T23:19:32.5689738Z          lock_time: 0,
2025-11-09T23:19:32.5689863Z      };
2025-11-09T23:19:32.5689976Z -    
2025-11-09T23:19:32.5690087Z +
2025-11-09T23:19:32.5690217Z      // Add transaction
2025-11-09T23:19:32.5690499Z      let added = mempool.add_transaction(tx.clone()).await.unwrap();
2025-11-09T23:19:32.5690639Z      assert!(added);
2025-11-09T23:19:32.5691106Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:32:
2025-11-09T23:19:32.5691499Z -    
2025-11-09T23:19:32.5691615Z +
2025-11-09T23:19:32.5691768Z      // Verify we can retrieve it
2025-11-09T23:19:32.5691979Z      use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:19:32.5692145Z      let tx_hash = calculate_tx_id(&tx);
2025-11-09T23:19:32.5692622Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:42:
2025-11-09T23:19:32.5692854Z  async fn test_mempool_get_prioritized_transactions() {
2025-11-09T23:19:32.5693033Z      let mut mempool = MempoolManager::new();
2025-11-09T23:19:32.5693203Z      let mut utxo_set: UtxoSet = HashMap::new();
2025-11-09T23:19:32.5693315Z -    
2025-11-09T23:19:32.5693441Z +
2025-11-09T23:19:32.5693582Z      // Create UTXO for input
2025-11-09T23:19:32.5693719Z      let outpoint = OutPoint {
2025-11-09T23:19:32.5693850Z          hash: [0u8; 32],
2025-11-09T23:19:32.5694467Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:49:
2025-11-09T23:19:32.5694618Z          index: 0,
2025-11-09T23:19:32.5694733Z      };
2025-11-09T23:19:32.5694917Z -    utxo_set.insert(outpoint.clone(), UTXO {
2025-11-09T23:19:32.5695033Z -        value: 10000,
2025-11-09T23:19:32.5695178Z -        script_pubkey: vec![0x51],
2025-11-09T23:19:32.5695291Z -    });
2025-11-09T23:19:32.5695408Z -    
2025-11-09T23:19:32.5695528Z +    utxo_set.insert(
2025-11-09T23:19:32.5695663Z +        outpoint.clone(),
2025-11-09T23:19:32.5695788Z +        UTXO {
2025-11-09T23:19:32.5695915Z +            value: 10000,
2025-11-09T23:19:32.5696064Z +            script_pubkey: vec![0x51],
2025-11-09T23:19:32.5696177Z +        },
2025-11-09T23:19:32.5696301Z +    );
2025-11-09T23:19:32.5696418Z +
2025-11-09T23:19:32.5696632Z      // Create two transactions with different fee rates
2025-11-09T23:19:32.5697036Z      // High fee transaction
2025-11-09T23:19:32.5697196Z      let high_fee_tx = Transaction {
2025-11-09T23:19:32.5697647Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:68:
2025-11-09T23:19:32.5697768Z          }],
2025-11-09T23:19:32.5712323Z          lock_time: 0,
2025-11-09T23:19:32.5712496Z      };
2025-11-09T23:19:32.5712614Z -    
2025-11-09T23:19:32.5712729Z +
2025-11-09T23:19:32.5712892Z      // Low fee transaction
2025-11-09T23:19:32.5713045Z      let low_fee_tx = Transaction {
2025-11-09T23:19:32.5713171Z          version: 1,
2025-11-09T23:19:32.5713660Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:86:
2025-11-09T23:19:32.5713792Z          }],
2025-11-09T23:19:32.5713926Z          lock_time: 0,
2025-11-09T23:19:32.5714046Z      };
2025-11-09T23:19:32.5714168Z -    
2025-11-09T23:19:32.5714279Z +
2025-11-09T23:19:32.5714609Z      // Add both transactions
2025-11-09T23:19:32.5714892Z      mempool.add_transaction(low_fee_tx.clone()).await.unwrap();
2025-11-09T23:19:32.5715197Z      mempool.add_transaction(high_fee_tx.clone()).await.unwrap();
2025-11-09T23:19:32.5715683Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:93:
2025-11-09T23:19:32.5715800Z -    
2025-11-09T23:19:32.5715918Z +
2025-11-09T23:19:32.5716121Z      // Get prioritized (should return high fee first)
2025-11-09T23:19:32.5716443Z      let prioritized = mempool.get_prioritized_transactions(10, &utxo_set);
2025-11-09T23:19:32.5716710Z      assert_eq!(prioritized.len(), 1); // Only one has valid UTXO
2025-11-09T23:19:32.5717168Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:97:
2025-11-09T23:19:32.5717282Z -    
2025-11-09T23:19:32.5717396Z +
2025-11-09T23:19:32.5717571Z      // Verify high fee transaction is first
2025-11-09T23:19:32.5717778Z      use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:19:32.5717982Z      let high_fee_hash = calculate_tx_id(&high_fee_tx);
2025-11-09T23:19:32.5718467Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:104:
2025-11-09T23:19:32.5718872Z  #[tokio::test]
2025-11-09T23:19:32.5719053Z  async fn test_mempool_remove_transaction() {
2025-11-09T23:19:32.5719234Z      let mut mempool = MempoolManager::new();
2025-11-09T23:19:32.5719344Z -    
2025-11-09T23:19:32.5719451Z +
2025-11-09T23:19:32.5719582Z      let tx = Transaction {
2025-11-09T23:19:32.5719712Z          version: 1,
2025-11-09T23:19:32.5719876Z          inputs: vec![TransactionInput {
2025-11-09T23:19:32.5720344Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:121:
2025-11-09T23:19:32.5720470Z          }],
2025-11-09T23:19:32.5720597Z          lock_time: 0,
2025-11-09T23:19:32.5720711Z      };
2025-11-09T23:19:32.5720825Z -    
2025-11-09T23:19:32.5720944Z +
2025-11-09T23:19:32.5721169Z      mempool.add_transaction(tx.clone()).await.unwrap();
2025-11-09T23:19:32.5721330Z      assert_eq!(mempool.size(), 1);
2025-11-09T23:19:32.5721450Z -    
2025-11-09T23:19:32.5721561Z +
2025-11-09T23:19:32.5721766Z      use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:19:32.5721923Z      let tx_hash = calculate_tx_id(&tx);
2025-11-09T23:19:32.5722152Z      let removed = mempool.remove_transaction(&tx_hash);
2025-11-09T23:19:32.5722625Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:131:
2025-11-09T23:19:32.5722758Z      assert!(removed);
2025-11-09T23:19:32.5722919Z      assert_eq!(mempool.size(), 0);
2025-11-09T23:19:32.5723031Z  }
2025-11-09T23:19:32.5723145Z -
2025-11-09T23:19:32.5723254Z  
2025-11-09T23:19:32.5723715Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:1:
2025-11-09T23:19:32.5723898Z -use bllvm_protocol::ProtocolVersion;
2025-11-09T23:19:32.5724107Z  use bllvm_node::storage::blockstore::BlockStore;
2025-11-09T23:19:32.5724489Z  use bllvm_node::storage::chainstate::ChainState;
2025-11-09T23:19:32.5724918Z  use bllvm_node::storage::txindex::TxIndex;
2025-11-09T23:19:32.5725350Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:9:
2025-11-09T23:19:32.5725510Z  use bllvm_node::OutPoint;
2025-11-09T23:19:32.5725654Z  use bllvm_node::Transaction;
2025-11-09T23:19:32.5725946Z  use bllvm_node::{ByteString, TransactionInput, TransactionOutput};
2025-11-09T23:19:32.5726128Z +use bllvm_protocol::ProtocolVersion;
2025-11-09T23:19:32.5726279Z  use std::collections::HashMap;
2025-11-09T23:19:32.5726411Z  use tempfile::TempDir;
2025-11-09T23:19:32.5726521Z  
2025-11-09T23:19:32.5727022Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_property_tests.rs:2:
2025-11-09T23:19:32.5727127Z  //!
2025-11-09T23:19:32.5727493Z  //! Uses proptest to verify invariants and properties that should hold for all inputs.
2025-11-09T23:19:32.5727605Z  
2025-11-09T23:19:32.5727725Z -use hex;
2025-11-09T23:19:32.5727877Z -use proptest::prelude::*;
2025-11-09T23:19:32.5728080Z +use bllvm_node::node::mempool::MempoolManager;
2025-11-09T23:19:32.5728238Z +use bllvm_node::rpc::mining::MiningRpc;
2025-11-09T23:19:32.5728400Z +use bllvm_node::storage::Storage;
2025-11-09T23:19:32.5728664Z  use bllvm_protocol::serialization::serialize_transaction;
2025-11-09T23:19:32.5728811Z  use bllvm_protocol::types::{
2025-11-09T23:19:32.5729376Z      BlockHeader, OutPoint, Transaction, TransactionInput, TransactionOutput,
2025-11-09T23:19:32.5729928Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_property_tests.rs:10:
2025-11-09T23:19:32.5730061Z  };
2025-11-09T23:19:32.5730269Z -use bllvm_node::node::mempool::MempoolManager;
2025-11-09T23:19:32.5730437Z -use bllvm_node::rpc::mining::MiningRpc;
2025-11-09T23:19:32.5730601Z -use bllvm_node::storage::Storage;
2025-11-09T23:19:32.5730718Z +use hex;
2025-11-09T23:19:32.5730872Z +use proptest::prelude::*;
2025-11-09T23:19:32.5731021Z  use sha2::{Digest, Sha256};
2025-11-09T23:19:32.5731163Z  use std::sync::Arc;
2025-11-09T23:19:32.5731316Z  use tempfile::TempDir;
2025-11-09T23:19:32.5731917Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_rpc_implementation_tests.rs:1:
2025-11-09T23:19:32.5732330Z  //! Tests for mining RPC implementation
2025-11-09T23:19:32.5732442Z  
2025-11-09T23:19:32.5732645Z +use bllvm_node::node::mempool::MempoolManager;
2025-11-09T23:19:32.5732817Z  use bllvm_node::rpc::mining::MiningRpc;
2025-11-09T23:19:32.5732973Z  use bllvm_node::storage::Storage;
2025-11-09T23:19:32.5733166Z -use bllvm_node::node::mempool::MempoolManager;
2025-11-09T23:19:32.5733302Z +use serde_json::json;
2025-11-09T23:19:32.5733441Z  use std::sync::Arc;
2025-11-09T23:19:32.5733579Z  use tempfile::TempDir;
2025-11-09T23:19:32.5733717Z -use serde_json::json;
2025-11-09T23:19:32.5733838Z  
2025-11-09T23:19:32.5733966Z  #[tokio::test]
2025-11-09T23:19:32.5734114Z  async fn test_get_mining_info() {
2025-11-09T23:19:32.5734958Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_rpc_implementation_tests.rs:12:
2025-11-09T23:19:32.5735173Z      let temp_dir = TempDir::new().unwrap();
2025-11-09T23:19:32.5735417Z      let storage = Storage::new(temp_dir.path()).unwrap();
2025-11-09T23:19:32.5735588Z      let mempool = MempoolManager::new();
2025-11-09T23:19:32.5735711Z -    
2025-11-09T23:19:32.5735829Z +
2025-11-09T23:19:32.5736216Z      let mining_rpc = MiningRpc::with_dependencies(Arc::new(storage), Arc::new(mempool));
2025-11-09T23:19:32.5736344Z -    
2025-11-09T23:19:32.5736455Z +
2025-11-09T23:19:32.5736677Z      let info = mining_rpc.get_mining_info().await.unwrap();
2025-11-09T23:19:32.5736783Z -    
2025-11-09T23:19:32.5736901Z +
2025-11-09T23:19:32.5737048Z      // Verify response structure
2025-11-09T23:19:32.5737209Z      assert!(info.get("blocks").is_some());
2025-11-09T23:19:32.5737391Z      assert!(info.get("pooledtx").is_some());
2025-11-09T23:19:32.5737993Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_rpc_implementation_tests.rs:29:
2025-11-09T23:19:32.5738391Z      let temp_dir = TempDir::new().unwrap();
2025-11-09T23:19:32.5738622Z      let storage = Storage::new(temp_dir.path()).unwrap();
2025-11-09T23:19:32.5738802Z      let mempool = MempoolManager::new();
2025-11-09T23:19:32.5738915Z -    
2025-11-09T23:19:32.5739030Z +
2025-11-09T23:19:32.5739409Z      let mining_rpc = MiningRpc::with_dependencies(Arc::new(storage), Arc::new(mempool));
2025-11-09T23:19:32.5739522Z -    
2025-11-09T23:19:32.5739637Z +
2025-11-09T23:19:32.5739788Z      let params = json!([]);
2025-11-09T23:19:32.5740058Z      let template = mining_rpc.get_block_template(&params).await;
2025-11-09T23:19:32.5740172Z -    
2025-11-09T23:19:32.5740282Z +
2025-11-09T23:19:32.5740469Z      // Should either succeed or fail gracefully
2025-11-09T23:19:32.5740690Z      // (may fail if chain not initialized, which is expected)
2025-11-09T23:19:32.5740884Z      assert!(template.is_ok() || template.is_err());
2025-11-09T23:19:32.5741488Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_rpc_implementation_tests.rs:45:
2025-11-09T23:19:32.5741683Z      let temp_dir = TempDir::new().unwrap();
2025-11-09T23:19:32.5741908Z      let storage = Storage::new(temp_dir.path()).unwrap();
2025-11-09T23:19:32.5742080Z      let mempool = MempoolManager::new();
2025-11-09T23:19:32.5742194Z -    
2025-11-09T23:19:32.5742307Z +
2025-11-09T23:19:32.5742685Z      let mining_rpc = MiningRpc::with_dependencies(Arc::new(storage), Arc::new(mempool));
2025-11-09T23:19:32.5742806Z -    
2025-11-09T23:19:32.5742917Z +
2025-11-09T23:19:32.5743260Z      // Create a minimal invalid block hex (will fail validation, which is expected)
2025-11-09T23:19:32.5743641Z      let invalid_block_hex = "0000000000000000000000000000000000000000000000000000000000000000";
2025-11-09T23:19:32.5743827Z      let params = json!([invalid_block_hex, ""]);
2025-11-09T23:19:32.5744589Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_rpc_implementation_tests.rs:54:
2025-11-09T23:19:32.5744722Z -    
2025-11-09T23:19:32.5744843Z +
2025-11-09T23:19:32.5745065Z      let result = mining_rpc.submit_block(&params).await;
2025-11-09T23:19:32.5745407Z -    
2025-11-09T23:19:32.5745528Z +
2025-11-09T23:19:32.5745754Z      // Should fail validation (expected for invalid block)
2025-11-09T23:19:32.5745895Z      assert!(result.is_err());
2025-11-09T23:19:32.5746002Z  }
2025-11-09T23:19:32.5746606Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_rpc_implementation_tests.rs:63:
2025-11-09T23:19:32.5746784Z      let temp_dir = TempDir::new().unwrap();
2025-11-09T23:19:32.5747005Z      let storage = Storage::new(temp_dir.path()).unwrap();
2025-11-09T23:19:32.5747173Z      let mempool = MempoolManager::new();
2025-11-09T23:19:32.5747283Z -    
2025-11-09T23:19:32.5747392Z +
2025-11-09T23:19:32.5747773Z      let mining_rpc = MiningRpc::with_dependencies(Arc::new(storage), Arc::new(mempool));
2025-11-09T23:19:32.5747894Z -    
2025-11-09T23:19:32.5748006Z +
2025-11-09T23:19:32.5748172Z      let params = json!([6, "conservative"]);
2025-11-09T23:19:32.5750327Z      let fee_estimate = mining_rpc.estimate_smart_fee(&params).await.unwrap();
2025-11-09T23:19:32.5750437Z -    
2025-11-09T23:19:32.5750545Z +
2025-11-09T23:19:32.5750701Z      // Verify response structure
2025-11-09T23:19:32.5750898Z      assert!(fee_estimate.get("feerate").is_some());
2025-11-09T23:19:32.5751082Z      assert!(fee_estimate.get("blocks").is_some());
2025-11-09T23:19:32.5751655Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_rpc_implementation_tests.rs:75:
2025-11-09T23:19:32.5751932Z      assert_eq!(fee_estimate.get("blocks").unwrap().as_u64().unwrap(), 6);
2025-11-09T23:19:32.5752032Z  }
2025-11-09T23:19:32.5752131Z -
2025-11-09T23:19:32.5752240Z  
2025-11-09T23:19:32.5752636Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:1:
2025-11-09T23:19:32.5752796Z -use bllvm_protocol::ProtocolVersion;
2025-11-09T23:19:32.5753187Z  use bllvm_node::storage::blockstore::BlockStore;
2025-11-09T23:19:32.5753377Z  use bllvm_node::storage::chainstate::ChainState;
2025-11-09T23:19:32.5753568Z  use bllvm_node::storage::txindex::TxIndex;
2025-11-09T23:19:32.5753990Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:9:
2025-11-09T23:19:32.5754143Z  use bllvm_node::OutPoint;
2025-11-09T23:19:32.5754451Z  use bllvm_node::Transaction;
2025-11-09T23:19:32.5754748Z  use bllvm_node::{ByteString, TransactionInput, TransactionOutput};
2025-11-09T23:19:32.5754930Z +use bllvm_protocol::ProtocolVersion;
2025-11-09T23:19:32.5755084Z  use std::collections::HashMap;
2025-11-09T23:19:32.5755226Z  use tempfile::TempDir;
2025-11-09T23:19:32.5755347Z  
2025-11-09T23:19:32.5766513Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_rpc_tests.rs:1:
2025-11-09T23:19:32.5766713Z  //! Unit tests for Mining RPC methods
2025-11-09T23:19:32.5766835Z  
2025-11-09T23:19:32.5767118Z -use bllvm_protocol::serialization::serialize_transaction;
2025-11-09T23:19:32.5767517Z -use bllvm_protocol::{BlockHeader, Natural, OutPoint, Transaction, UtxoSet, UTXO};
2025-11-09T23:19:32.5767743Z  use bllvm_node::node::mempool::MempoolManager;
2025-11-09T23:19:32.5767911Z  use bllvm_node::rpc::mining::MiningRpc;
2025-11-09T23:19:32.5768065Z  use bllvm_node::storage::Storage;
2025-11-09T23:19:32.5768555Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_rpc_tests.rs:8:
2025-11-09T23:19:32.5768827Z +use bllvm_protocol::serialization::serialize_transaction;
2025-11-09T23:19:32.5769217Z +use bllvm_protocol::{BlockHeader, Natural, OutPoint, Transaction, UtxoSet, UTXO};
2025-11-09T23:19:32.5769355Z  use std::sync::Arc;
2025-11-09T23:19:32.5769514Z  use tempfile::TempDir;
2025-11-09T23:19:32.5769676Z  // Sha256 not needed directly in tests
2025-11-09T23:19:32.5773063Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/module_process_sharing_tests.rs:3:
2025-11-09T23:19:32.5773416Z  use bllvm_node::module::process::monitor::ModuleProcessMonitor;
2025-11-09T23:19:32.5774061Z  use bllvm_node::module::process::spawner::{ModuleProcess, ModuleProcessSpawner};
2025-11-09T23:19:32.5774201Z  use std::sync::{Arc, Mutex};
2025-11-09T23:19:32.5774592Z -use tokio::sync::mpsc;
2025-11-09T23:19:32.5774721Z  use tempfile::TempDir;
2025-11-09T23:19:32.5774836Z +use tokio::sync::mpsc;
2025-11-09T23:19:32.5774949Z  
2025-11-09T23:19:32.5775069Z  #[tokio::test]
2025-11-09T23:19:32.5775239Z  async fn test_monitor_module_shared() {
2025-11-09T23:19:32.5775804Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/module_process_sharing_tests.rs:11:
2025-11-09T23:19:32.5775989Z      let temp_dir = TempDir::new().unwrap();
2025-11-09T23:19:32.5776212Z      let (crash_tx, _crash_rx) = mpsc::unbounded_channel();
2025-11-09T23:19:32.5776429Z      let monitor = ModuleProcessMonitor::new(crash_tx);
2025-11-09T23:19:32.5776551Z -    
2025-11-09T23:19:32.5776671Z +
2025-11-09T23:19:32.5776967Z      // Create a dummy process (using true command which exits immediately)
2025-11-09T23:19:32.5777193Z -    let process = tokio::process::Command::new("true")
2025-11-09T23:19:32.5777313Z -        .spawn()
2025-11-09T23:19:32.5777431Z -        .unwrap();
2025-11-09T23:19:32.5777542Z -    
2025-11-09T23:19:32.5777837Z +    let process = tokio::process::Command::new("true").spawn().unwrap();
2025-11-09T23:19:32.5777947Z +
2025-11-09T23:19:32.5778110Z      let module_process = ModuleProcess {
2025-11-09T23:19:32.5778267Z          module_name: "test".to_string(),
2025-11-09T23:19:32.5778389Z          process,
2025-11-09T23:19:32.5778960Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/module_process_sharing_tests.rs:23:
2025-11-09T23:19:32.5779138Z          socket_path: std::path::PathBuf::new(),
2025-11-09T23:19:32.5779272Z          client: None,
2025-11-09T23:19:32.5779385Z      };
2025-11-09T23:19:32.5779496Z -    
2025-11-09T23:19:32.5779857Z +
2025-11-09T23:19:32.5780107Z      let shared_process = Arc::new(Mutex::new(module_process));
2025-11-09T23:19:32.5780218Z -    
2025-11-09T23:19:32.5780334Z +
2025-11-09T23:19:32.5780533Z      // Test that monitor_module_shared can be called
2025-11-09T23:19:32.5780746Z      // (will exit quickly since process exits immediately)
2025-11-09T23:19:32.5781134Z -    let result = monitor.monitor_module_shared("test".to_string(), shared_process).await;
2025-11-09T23:19:32.5781252Z -    
2025-11-09T23:19:32.5781380Z +    let result = monitor
2025-11-09T23:19:32.5781630Z +        .monitor_module_shared("test".to_string(), shared_process)
2025-11-09T23:19:32.5781753Z +        .await;
2025-11-09T23:19:32.5781860Z +
2025-11-09T23:19:32.5782030Z      // Should succeed (process exits normally)
2025-11-09T23:19:32.5782170Z      assert!(result.is_ok());
2025-11-09T23:19:32.5782285Z  }
2025-11-09T23:19:32.5782853Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/module_process_sharing_tests.rs:36:
2025-11-09T23:19:32.5782974Z -
2025-11-09T23:19:32.5783094Z  
2025-11-09T23:19:32.5803319Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:1:
2025-11-09T23:19:32.5803565Z -use bllvm_protocol::ProtocolVersion;
2025-11-09T23:19:32.5803792Z  use bllvm_node::storage::blockstore::BlockStore;
2025-11-09T23:19:32.5803994Z  use bllvm_node::storage::chainstate::ChainState;
2025-11-09T23:19:32.5804171Z  use bllvm_node::storage::txindex::TxIndex;
2025-11-09T23:19:32.5804812Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:9:
2025-11-09T23:19:32.5804983Z  use bllvm_node::OutPoint;
2025-11-09T23:19:32.5805133Z  use bllvm_node::Transaction;
2025-11-09T23:19:32.5805444Z  use bllvm_node::{ByteString, TransactionInput, TransactionOutput};
2025-11-09T23:19:32.5805632Z +use bllvm_protocol::ProtocolVersion;
2025-11-09T23:19:32.5805784Z  use std::collections::HashMap;
2025-11-09T23:19:32.5805925Z  use tempfile::TempDir;
2025-11-09T23:19:32.5806046Z  
2025-11-09T23:19:32.5888101Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:8:
2025-11-09T23:19:32.5888764Z  use std::net::SocketAddr;
2025-11-09T23:19:32.5888914Z  use tokio::sync::mpsc;
2025-11-09T23:19:32.5889030Z  mod common;
2025-11-09T23:19:32.5889153Z -use common::*;
2025-11-09T23:19:32.5889489Z  use bllvm_node::network::inventory::{InventoryRequest, MSG_BLOCK, MSG_TX};
2025-11-09T23:19:32.5889821Z  use bllvm_node::network::protocol::InventoryItem as NetworkInventoryItem;
2025-11-09T23:19:32.5889952Z +use common::*;
2025-11-09T23:19:32.5890079Z  
2025-11-09T23:19:32.5890206Z  #[tokio::test]
2025-11-09T23:19:32.5890384Z  async fn test_network_manager_creation() {
2025-11-09T23:19:32.5890853Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:878:
2025-11-09T23:19:32.5891030Z  async fn test_persistent_peers() {
2025-11-09T23:19:32.5891249Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:19:32.5891444Z      let manager = NetworkManager::new(addr);
2025-11-09T23:19:32.5891567Z -    
2025-11-09T23:19:32.5891682Z +
2025-11-09T23:19:32.5891926Z      let peer1: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:19:32.5892127Z      let peer2: SocketAddr = "127.0.0.1:8334".parse().unwrap();
2025-11-09T23:19:32.5892230Z -    
2025-11-09T23:19:32.5892323Z +
2025-11-09T23:19:32.5892472Z      // Test adding persistent peers
2025-11-09T23:19:32.5892646Z      manager.add_persistent_peer(peer1);
2025-11-09T23:19:32.5892808Z      manager.add_persistent_peer(peer2);
2025-11-09T23:19:32.5893281Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:888:
2025-11-09T23:19:32.5893402Z -    
2025-11-09T23:19:32.5893511Z +
2025-11-09T23:19:32.5893718Z      let persistent = manager.get_persistent_peers();
2025-11-09T23:19:32.5893873Z      assert_eq!(persistent.len(), 2);
2025-11-09T23:19:32.5894052Z      assert!(persistent.contains(&peer1));
2025-11-09T23:19:32.5894710Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:892:
2025-11-09T23:19:32.5895129Z      assert!(persistent.contains(&peer2));
2025-11-09T23:19:32.5895252Z -    
2025-11-09T23:19:32.5895368Z +
2025-11-09T23:19:32.5895524Z      // Test removing persistent peer
2025-11-09T23:19:32.5895707Z      manager.remove_persistent_peer(peer1);
2025-11-09T23:19:32.5895911Z      let persistent = manager.get_persistent_peers();
2025-11-09T23:19:32.5896372Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:903:
2025-11-09T23:19:32.5896525Z  async fn test_ban_list() {
2025-11-09T23:19:32.5896737Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:19:32.5896922Z      let manager = NetworkManager::new(addr);
2025-11-09T23:19:32.5897031Z -    
2025-11-09T23:19:32.5897146Z +
2025-11-09T23:19:32.5897414Z      let banned_peer: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:19:32.5897528Z -    
2025-11-09T23:19:32.5897659Z +
2025-11-09T23:19:32.5897830Z      // Test banning a peer (permanent ban)
2025-11-09T23:19:32.5897992Z      manager.ban_peer(banned_peer, 0);
2025-11-09T23:19:32.5898175Z      assert!(manager.is_banned(banned_peer));
2025-11-09T23:19:32.5898659Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:912:
2025-11-09T23:19:32.5898771Z -    
2025-11-09T23:19:32.5898883Z +
2025-11-09T23:19:32.5899037Z      // Test getting banned peers
2025-11-09T23:19:32.5899208Z      let banned = manager.get_banned_peers();
2025-11-09T23:19:32.5899353Z      assert_eq!(banned.len(), 1);
2025-11-09T23:19:32.5899815Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:916:
2025-11-09T23:19:32.5899982Z      assert_eq!(banned[0].0, banned_peer);
2025-11-09T23:19:32.5900096Z -    
2025-11-09T23:19:32.5900205Z +
2025-11-09T23:19:32.5900340Z      // Test unbanning
2025-11-09T23:19:32.5900496Z      manager.unban_peer(banned_peer);
2025-11-09T23:19:32.5900678Z      assert!(!manager.is_banned(banned_peer));
2025-11-09T23:19:32.5901443Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:921:
2025-11-09T23:19:32.5901760Z -    
2025-11-09T23:19:32.5901868Z +
2025-11-09T23:19:32.5902004Z      // Test temporary ban
2025-11-09T23:19:32.5902183Z      use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:19:32.5902327Z      let now = SystemTime::now()
2025-11-09T23:19:32.5902786Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:928:
2025-11-09T23:19:32.5902978Z      let unban_time = now + 3600; // 1 hour from now
2025-11-09T23:19:32.5903157Z      manager.ban_peer(banned_peer, unban_time);
2025-11-09T23:19:32.5903322Z      assert!(manager.is_banned(banned_peer));
2025-11-09T23:19:32.5903430Z -    
2025-11-09T23:19:32.5903553Z +
2025-11-09T23:19:32.5903695Z      // Test clearing all bans
2025-11-09T23:19:32.5903835Z      manager.clear_bans();
2025-11-09T23:19:32.5904020Z      assert!(!manager.is_banned(banned_peer));
2025-11-09T23:19:32.5904673Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:939:
2025-11-09T23:19:32.5904845Z  async fn test_network_stats() {
2025-11-09T23:19:32.5905068Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:19:32.5905259Z      let manager = NetworkManager::new(addr);
2025-11-09T23:19:32.5905372Z -    
2025-11-09T23:19:32.5905487Z +
2025-11-09T23:19:32.5905649Z      // Initially stats should be zero
2025-11-09T23:19:32.5905851Z      let (sent, received) = manager.get_network_stats();
2025-11-09T23:19:32.5905981Z      assert_eq!(sent, 0);
2025-11-09T23:19:32.5906445Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:946:
2025-11-09T23:19:32.5906586Z      assert_eq!(received, 0);
2025-11-09T23:19:32.5906696Z -    
2025-11-09T23:19:32.5906805Z +
2025-11-09T23:19:32.5906947Z      // Track some bytes
2025-11-09T23:19:32.5907095Z      manager.track_bytes_sent(100);
2025-11-09T23:19:32.5907470Z      manager.track_bytes_received(200);
2025-11-09T23:19:32.5907950Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:951:
2025-11-09T23:19:32.5908080Z -    
2025-11-09T23:19:32.5908192Z +
2025-11-09T23:19:32.5908398Z      let (sent, received) = manager.get_network_stats();
2025-11-09T23:19:32.5908545Z      assert_eq!(sent, 100);
2025-11-09T23:19:32.5908687Z      assert_eq!(received, 200);
2025-11-09T23:19:32.5909150Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:955:
2025-11-09T23:19:32.5909272Z -    
2025-11-09T23:19:32.5909385Z +
2025-11-09T23:19:32.5909552Z      // Track more bytes (should accumulate)
2025-11-09T23:19:32.5909698Z      manager.track_bytes_sent(50);
2025-11-09T23:19:32.5909859Z      manager.track_bytes_received(75);
2025-11-09T23:19:32.5910787Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:959:
2025-11-09T23:19:32.5910914Z -    
2025-11-09T23:19:32.5911044Z +
2025-11-09T23:19:32.5911255Z      let (sent, received) = manager.get_network_stats();
2025-11-09T23:19:32.5911401Z      assert_eq!(sent, 150);
2025-11-09T23:19:32.5911546Z      assert_eq!(received, 275);
2025-11-09T23:19:32.5912018Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:966:
2025-11-09T23:19:32.5912174Z  async fn test_ping_all_peers() {
2025-11-09T23:19:32.5912386Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:19:32.5912581Z      let manager = NetworkManager::new(addr);
2025-11-09T23:19:32.5912696Z -    
2025-11-09T23:19:32.5912807Z +
2025-11-09T23:19:32.5912998Z      // Test ping with no peers (should not error)
2025-11-09T23:19:32.5913186Z      let result = manager.ping_all_peers().await;
2025-11-09T23:19:32.5913331Z      assert!(result.is_ok());
2025-11-09T23:19:32.5913804Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:973:
2025-11-09T23:19:32.5913936Z -    
2025-11-09T23:19:32.5914047Z +
2025-11-09T23:19:32.5914541Z      // Note: Testing with actual peers would require setting up connections,
2025-11-09T23:19:32.5915091Z      // which is more complex. This test verifies the method doesn't panic.
2025-11-09T23:19:32.5915196Z  }
2025-11-09T23:19:32.5922895Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:1:
2025-11-09T23:19:32.5923131Z -use bllvm_protocol::ProtocolVersion;
2025-11-09T23:19:32.5923341Z  use bllvm_node::storage::blockstore::BlockStore;
2025-11-09T23:19:32.5923540Z  use bllvm_node::storage::chainstate::ChainState;
2025-11-09T23:19:32.5923712Z  use bllvm_node::storage::txindex::TxIndex;
2025-11-09T23:19:32.5924135Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:9:
2025-11-09T23:19:32.5924287Z  use bllvm_node::OutPoint;
2025-11-09T23:19:32.5924575Z  use bllvm_node::Transaction;
2025-11-09T23:19:32.5924892Z  use bllvm_node::{ByteString, TransactionInput, TransactionOutput};
2025-11-09T23:19:32.5925081Z +use bllvm_protocol::ProtocolVersion;
2025-11-09T23:19:32.5925236Z  use std::collections::HashMap;
2025-11-09T23:19:32.5925391Z  use tempfile::TempDir;
2025-11-09T23:19:32.5925505Z  
2025-11-09T23:19:32.5958538Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/node_tests.rs:5:
2025-11-09T23:19:32.5958748Z  use std::net::SocketAddr;
2025-11-09T23:19:32.5958893Z  use tempfile::TempDir;
2025-11-09T23:19:32.5959019Z  mod common;
2025-11-09T23:19:32.5959139Z -use common::*;
2025-11-09T23:19:32.5959320Z  use bllvm_protocol::ProtocolVersion;
2025-11-09T23:19:32.5959446Z +use common::*;
2025-11-09T23:19:32.5959558Z  
2025-11-09T23:19:32.5959695Z  #[tokio::test]
2025-11-09T23:19:32.5959850Z  async fn test_node_creation() {
2025-11-09T23:19:32.5967354Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/peer_stats_tests.rs:3:
2025-11-09T23:19:32.5967572Z  use bllvm_node::network::peer::Peer;
2025-11-09T23:19:32.5967736Z  use bllvm_node::network::NetworkMessage;
2025-11-09T23:19:32.5968093Z  use std::net::SocketAddr;
2025-11-09T23:19:32.5968210Z -use tokio::sync::mpsc;
2025-11-09T23:19:32.5968340Z  use tokio::net::TcpStream;
2025-11-09T23:19:32.5968451Z +use tokio::sync::mpsc;
2025-11-09T23:19:32.5968546Z  
2025-11-09T23:19:32.5968654Z  #[tokio::test]
2025-11-09T23:19:32.5968816Z  async fn test_peer_stats_initialization() {
2025-11-09T23:19:32.5969247Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/peer_stats_tests.rs:11:
2025-11-09T23:19:32.5969451Z      let addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:19:32.5969605Z      let (tx, _rx) = mpsc::unbounded_channel();
2025-11-09T23:19:32.5969700Z -    
2025-11-09T23:19:32.5969792Z +
2025-11-09T23:19:32.5969905Z      // Create a mock stream
2025-11-09T23:19:32.5970183Z      let listener = tokio::net::TcpListener::bind("127.0.0.1:0").await.unwrap();
2025-11-09T23:19:32.5970352Z      let local_addr = listener.local_addr().unwrap();
2025-11-09T23:19:32.5970767Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/peer_stats_tests.rs:17:
2025-11-09T23:19:32.5971030Z      let stream = tokio::net::TcpStream::connect(local_addr).await.unwrap();
2025-11-09T23:19:32.5971125Z -    
2025-11-09T23:19:32.5971217Z +
2025-11-09T23:19:32.5971362Z      let peer = Peer::new(stream, addr, tx);
2025-11-09T23:19:32.5971455Z -    
2025-11-09T23:19:32.5971548Z +
2025-11-09T23:19:32.5971662Z      // Check initial stats
2025-11-09T23:19:32.5971797Z      assert!(peer.conntime() > 0);
2025-11-09T23:19:32.5971959Z      assert_eq!(peer.conntime(), peer.last_send());
2025-11-09T23:19:32.5972370Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/peer_stats_tests.rs:30:
2025-11-09T23:19:32.5972574Z  async fn test_peer_record_send() {
2025-11-09T23:19:32.5972840Z      let addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:19:32.5972987Z      let (tx, _rx) = mpsc::unbounded_channel();
2025-11-09T23:19:32.5973089Z -    
2025-11-09T23:19:32.5973199Z +
2025-11-09T23:19:32.5973588Z      let listener = tokio::net::TcpListener::bind("127.0.0.1:0").await.unwrap();
2025-11-09T23:19:32.5974070Z      let local_addr = listener.local_addr().unwrap();
2025-11-09T23:19:32.5974635Z      let stream = tokio::net::TcpStream::connect(local_addr).await.unwrap();
2025-11-09T23:19:32.5975112Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/peer_stats_tests.rs:37:
2025-11-09T23:19:32.5975211Z -    
2025-11-09T23:19:32.5975313Z +
2025-11-09T23:19:32.5975470Z      let mut peer = Peer::new(stream, addr, tx);
2025-11-09T23:19:32.5975569Z -    
2025-11-09T23:19:32.5975661Z +
2025-11-09T23:19:32.5975802Z      let initial_send = peer.last_send();
2025-11-09T23:19:32.5975936Z      let initial_bytes = peer.bytes_sent();
2025-11-09T23:19:32.5976033Z -    
2025-11-09T23:19:32.5976128Z +
2025-11-09T23:19:32.5976233Z      // Record a send
2025-11-09T23:19:32.5976352Z      peer.record_send(100);
2025-11-09T23:19:32.5976447Z -    
2025-11-09T23:19:32.5976557Z +
2025-11-09T23:19:32.5976700Z      assert!(peer.last_send() >= initial_send);
2025-11-09T23:19:32.5976880Z      assert_eq!(peer.bytes_sent(), initial_bytes + 100);
2025-11-09T23:19:32.5976979Z  }
2025-11-09T23:19:32.5977379Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/peer_stats_tests.rs:51:
2025-11-09T23:19:32.5977515Z  async fn test_peer_record_receive() {
2025-11-09T23:19:32.5977706Z      let addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:19:32.5977855Z      let (tx, _rx) = mpsc::unbounded_channel();
2025-11-09T23:19:32.5977948Z -    
2025-11-09T23:19:32.5978039Z +
2025-11-09T23:19:32.5978302Z      let listener = tokio::net::TcpListener::bind("127.0.0.1:0").await.unwrap();
2025-11-09T23:19:32.5978465Z      let local_addr = listener.local_addr().unwrap();
2025-11-09T23:19:32.5980594Z      let stream = tokio::net::TcpStream::connect(local_addr).await.unwrap();
2025-11-09T23:19:32.5980993Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/peer_stats_tests.rs:58:
2025-11-09T23:19:32.5981240Z -    
2025-11-09T23:19:32.5981332Z +
2025-11-09T23:19:32.5981480Z      let mut peer = Peer::new(stream, addr, tx);
2025-11-09T23:19:32.5981581Z -    
2025-11-09T23:19:32.5981673Z +
2025-11-09T23:19:32.5981801Z      let initial_recv = peer.last_recv();
2025-11-09T23:19:32.5981938Z      let initial_bytes = peer.bytes_recv();
2025-11-09T23:19:32.5982031Z -    
2025-11-09T23:19:32.5982123Z +
2025-11-09T23:19:32.5982843Z      // Record a receive
2025-11-09T23:19:32.5982979Z      peer.record_receive(200);
2025-11-09T23:19:32.5983075Z -    
2025-11-09T23:19:32.5983167Z +
2025-11-09T23:19:32.5983320Z      assert!(peer.last_recv() >= initial_recv);
2025-11-09T23:19:32.5983492Z      assert_eq!(peer.bytes_recv(), initial_bytes + 200);
2025-11-09T23:19:32.5983586Z  }
2025-11-09T23:19:32.5983980Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/peer_stats_tests.rs:70:
2025-11-09T23:19:32.5984079Z -
2025-11-09T23:19:32.5984176Z  
2025-11-09T23:19:32.5984932Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/protocol_message_processing_tests.rs:1:
2025-11-09T23:19:32.5985127Z  //! Tests for protocol message processing integration
2025-11-09T23:19:32.5985223Z  
2025-11-09T23:19:32.5985343Z  use bllvm_node::network;
2025-11-09T23:19:32.5985476Z -use bllvm_node::storage::Storage;
2025-11-09T23:19:32.5985597Z  use bllvm_node::node::mempool::MempoolManager;
2025-11-09T23:19:32.5985692Z +use bllvm_node::storage::Storage;
2025-11-09T23:19:32.5985864Z  use bllvm_protocol::{BitcoinProtocolEngine, ProtocolVersion};
2025-11-09T23:19:32.5985944Z -use std::sync::Arc;
2025-11-09T23:19:32.5986029Z  use std::net::SocketAddr;
2025-11-09T23:19:32.5986105Z +use std::sync::Arc;
2025-11-09T23:19:32.5986192Z  use tempfile::TempDir;
2025-11-09T23:19:32.5986260Z  
2025-11-09T23:19:32.5986337Z  #[tokio::test]
2025-11-09T23:19:32.5986693Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/protocol_message_processing_tests.rs:14:
2025-11-09T23:19:32.5986860Z      let storage = Arc::new(Storage::new(temp_dir.path()).unwrap());
2025-11-09T23:19:32.5987134Z      let mempool = Arc::new(MempoolManager::new());
2025-11-09T23:19:32.5987418Z      let protocol_engine = Arc::new(BitcoinProtocolEngine::new(ProtocolVersion::Regtest).unwrap());
2025-11-09T23:19:32.5987488Z -    
2025-11-09T23:19:32.5987556Z +
2025-11-09T23:19:32.5987709Z      let network_addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:19:32.5987883Z -    let network_manager = network::NetworkManager::new(network_addr)
2025-11-09T23:19:32.5988026Z -        .with_dependencies(protocol_engine, storage, mempool);
2025-11-09T23:19:32.5988093Z -    
2025-11-09T23:19:32.5988330Z +    let network_manager = network::NetworkManager::new(network_addr).with_dependencies(
2025-11-09T23:19:32.5988414Z +        protocol_engine,
2025-11-09T23:19:32.5988487Z +        storage,
2025-11-09T23:19:32.5988565Z +        mempool,
2025-11-09T23:19:32.5988638Z +    );
2025-11-09T23:19:32.5988706Z +
2025-11-09T23:19:32.5988798Z      // Verify dependencies are set
2025-11-09T23:19:32.5989016Z      // (NetworkManager doesn't expose these, but we can verify it was created)
2025-11-09T23:19:32.5989133Z      assert!(true); // If we got here, setup worked
2025-11-09T23:19:32.5989502Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/protocol_message_processing_tests.rs:29:
2025-11-09T23:19:32.5989609Z      let temp_dir = TempDir::new().unwrap();
2025-11-09T23:19:32.5989745Z      let storage = Storage::new(temp_dir.path()).unwrap();
2025-11-09T23:19:32.5989857Z      let mempool = Arc::new(MempoolManager::new());
2025-11-09T23:19:32.5989929Z -    
2025-11-09T23:19:32.5990002Z +
2025-11-09T23:19:32.5990140Z      // Verify we can create NodeChainAccess with Storage Arcs
2025-11-09T23:19:32.5990278Z      use bllvm_node::network::chain_access::NodeChainAccess;
2025-11-09T23:19:32.5990390Z -    let chain_access = NodeChainAccess::new(
2025-11-09T23:19:32.5990591Z -        storage.blocks(),
2025-11-09T23:19:32.5990680Z -        storage.transactions(),
2025-11-09T23:19:32.5990758Z -        mempool,
2025-11-09T23:19:32.5990831Z -    );
2025-11-09T23:19:32.5990900Z -    
2025-11-09T23:19:32.5991161Z +    let chain_access = NodeChainAccess::new(storage.blocks(), storage.transactions(), mempool);
2025-11-09T23:19:32.5991234Z +
2025-11-09T23:19:32.5991313Z      // Test that it works
2025-11-09T23:19:32.5991391Z      let hash = [0u8; 32];
2025-11-09T23:19:32.5991539Z      assert!(!chain_access.has_object(&hash)); // Empty storage
2025-11-09T23:19:32.5991890Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/protocol_message_processing_tests.rs:44:
2025-11-09T23:19:32.5991958Z  }
2025-11-09T23:19:32.5992025Z -
2025-11-09T23:19:32.5992098Z  
2025-11-09T23:19:32.6009816Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:1:
2025-11-09T23:19:32.6010022Z -use bllvm_protocol::ProtocolVersion;
2025-11-09T23:19:32.6010254Z  use bllvm_node::storage::blockstore::BlockStore;
2025-11-09T23:19:32.6010408Z  use bllvm_node::storage::chainstate::ChainState;
2025-11-09T23:19:32.6010518Z  use bllvm_node::storage::txindex::TxIndex;
2025-11-09T23:19:32.6010782Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:9:
2025-11-09T23:19:32.6010873Z  use bllvm_node::OutPoint;
2025-11-09T23:19:32.6010961Z  use bllvm_node::Transaction;
2025-11-09T23:19:32.6011148Z  use bllvm_node::{ByteString, TransactionInput, TransactionOutput};
2025-11-09T23:19:32.6011253Z +use bllvm_protocol::ProtocolVersion;
2025-11-09T23:19:32.6011342Z  use std::collections::HashMap;
2025-11-09T23:19:32.6011424Z  use tempfile::TempDir;
2025-11-09T23:19:32.6013396Z  
2025-11-09T23:19:32.6053490Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:10:
2025-11-09T23:19:32.6053714Z  #[tokio::test]
2025-11-09T23:19:32.6053935Z  async fn test_message_size_validation() {
2025-11-09T23:19:32.6054481Z      use bllvm_node::network::protocol::MAX_PROTOCOL_MESSAGE_LENGTH;
2025-11-09T23:19:32.6054638Z -    
2025-11-09T23:19:32.6055086Z +
2025-11-09T23:19:32.6055325Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:19:32.6055451Z      let manager = NetworkManager::new(addr);
2025-11-09T23:19:32.6055530Z -    
2025-11-09T23:19:32.6055604Z +
2025-11-09T23:19:32.6055721Z      // Test that oversized messages are rejected
2025-11-09T23:19:32.6055916Z      // This is tested at the TransportConnection level, but we can verify
2025-11-09T23:19:32.6056029Z      // the protocol parser also validates size
2025-11-09T23:19:32.6056335Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:20:
2025-11-09T23:19:32.6056483Z      use bllvm_node::network::protocol::ProtocolParser;
2025-11-09T23:19:32.6056558Z -    
2025-11-09T23:19:32.6056628Z +
2025-11-09T23:19:32.6056730Z      // Create a message that's too large
2025-11-09T23:19:32.6056910Z      let oversized_data = vec![0u8; MAX_PROTOCOL_MESSAGE_LENGTH + 1];
2025-11-09T23:19:32.6057084Z      let result = ProtocolParser::parse_message(&oversized_data);
2025-11-09T23:19:32.6057381Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:29:
2025-11-09T23:19:32.6057485Z  async fn test_rate_limiting() {
2025-11-09T23:19:32.6057626Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:19:32.6057740Z      let manager = NetworkManager::new(addr);
2025-11-09T23:19:32.6057813Z -    
2025-11-09T23:19:32.6057891Z +
2025-11-09T23:19:32.6058070Z      // Rate limiting is tested implicitly through message processing
2025-11-09T23:19:32.6058269Z      // The rate limiter is checked in process_messages for RawMessageReceived
2025-11-09T23:19:32.6058445Z      // This test verifies the rate limiter structure exists and works
2025-11-09T23:19:32.6058737Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:36:
2025-11-09T23:19:32.6058945Z -    
2025-11-09T23:19:32.6059022Z +
2025-11-09T23:19:32.6059131Z      // Add a peer address to test rate limiting
2025-11-09T23:19:32.6059299Z      let test_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:19:32.6059371Z -    
2025-11-09T23:19:32.6059448Z +
2025-11-09T23:19:32.6059605Z      // Rate limiter should be created when first message arrives
2025-11-09T23:19:32.6059793Z      // We can't easily test this without a real connection, but the structure
2025-11-09T23:19:32.6059936Z      // is in place and will be tested in integration tests
2025-11-09T23:19:32.6060233Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:47:
2025-11-09T23:19:32.6060344Z  async fn test_per_ip_connection_limit() {
2025-11-09T23:19:32.6060484Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:19:32.6060598Z      let manager = NetworkManager::new(addr);
2025-11-09T23:19:32.6060670Z -    
2025-11-09T23:19:32.6060740Z +
2025-11-09T23:19:32.6060855Z      // Test that per-IP limits are enforced
2025-11-09T23:19:32.6061025Z      // This is tested in connect_to_peer, but we need a mock transport
2025-11-09T23:19:32.6061129Z      // For now, verify the structure exists
2025-11-09T23:19:32.6061425Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:54:
2025-11-09T23:19:32.6061530Z      let test_ip = "127.0.0.1".parse().unwrap();
2025-11-09T23:19:32.6061603Z -    
2025-11-09T23:19:32.6061674Z +
2025-11-09T23:19:32.6061815Z      // Connection limits are enforced in connect_to_peer
2025-11-09T23:19:32.6061938Z      // Integration test needed for full verification
2025-11-09T23:19:32.6062126Z      assert!(true); // Placeholder - per-IP limits tested in integration
2025-11-09T23:19:32.6062432Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:62:
2025-11-09T23:19:32.6062532Z  async fn test_ban_list_cleanup() {
2025-11-09T23:19:32.6062666Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:19:32.6062787Z      let manager = NetworkManager::new(addr);
2025-11-09T23:19:32.6062859Z -    
2025-11-09T23:19:32.6063048Z +
2025-11-09T23:19:32.6063152Z      // Test that expired bans are cleaned up
2025-11-09T23:19:32.6063265Z      use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:19:32.6063360Z      let now = SystemTime::now()
2025-11-09T23:19:32.6063655Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:69:
2025-11-09T23:19:32.6063756Z          .duration_since(UNIX_EPOCH)
2025-11-09T23:19:32.6063834Z          .unwrap()
2025-11-09T23:19:32.6063910Z          .as_secs();
2025-11-09T23:19:32.6063982Z -    
2025-11-09T23:19:32.6064059Z +
2025-11-09T23:19:32.6064215Z      let test_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:19:32.6064289Z -    
2025-11-09T23:19:32.6064644Z +
2025-11-09T23:19:32.6064775Z      // Ban with expiration in the past
2025-11-09T23:19:32.6064895Z      let past_timestamp = now - 3600; // 1 hour ago
2025-11-09T23:19:32.6065023Z      manager.ban_peer(test_addr, past_timestamp);
2025-11-09T23:19:32.6065320Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:78:
2025-11-09T23:19:32.6065397Z -    
2025-11-09T23:19:32.6065468Z +
2025-11-09T23:19:32.6065608Z      // is_banned should automatically clean up expired bans
2025-11-09T23:19:32.6065713Z      let was_banned = manager.is_banned(test_addr);
2025-11-09T23:19:32.6065878Z      assert!(!was_banned, "Expired ban should be automatically removed");
2025-11-09T23:19:32.6066151Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:82:
2025-11-09T23:19:32.6066216Z -    
2025-11-09T23:19:32.6066283Z +
2025-11-09T23:19:32.6066364Z      // Verify ban was removed
2025-11-09T23:19:32.6066469Z      let banned = manager.get_banned_peers();
2025-11-09T23:19:32.6066610Z -    assert!(!banned.iter().any(|(addr, _)| *addr == test_addr), 
2025-11-09T23:19:32.6066714Z -            "Expired ban should not be in ban list");
2025-11-09T23:19:32.6066940Z +    assert!(
2025-11-09T23:19:32.6067061Z +        !banned.iter().any(|(addr, _)| *addr == test_addr),
2025-11-09T23:19:32.6067165Z +        "Expired ban should not be in ban list"
2025-11-09T23:19:32.6067318Z +    );
2025-11-09T23:19:32.6067392Z  }
2025-11-09T23:19:32.6067455Z  
2025-11-09T23:19:32.6067532Z  #[tokio::test]
2025-11-09T23:19:32.6067797Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:90:
2025-11-09T23:19:32.6067949Z  async fn test_ban_list_permanent() {
2025-11-09T23:19:32.6068081Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:19:32.6068184Z      let manager = NetworkManager::new(addr);
2025-11-09T23:19:32.6068248Z -    
2025-11-09T23:19:32.6068316Z +
2025-11-09T23:19:32.6068458Z      let test_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:19:32.6068521Z -    
2025-11-09T23:19:32.6068588Z +
2025-11-09T23:19:32.6068683Z      // Test permanent ban (timestamp = 0)
2025-11-09T23:19:32.6068773Z      manager.ban_peer(test_addr, 0);
2025-11-09T23:19:32.6068960Z -    assert!(manager.is_banned(test_addr), "Permanent ban should be active");
2025-11-09T23:19:32.6069030Z -    
2025-11-09T23:19:32.6069097Z +    assert!(
2025-11-09T23:19:32.6069248Z +        manager.is_banned(test_addr),
2025-11-09T23:19:32.6069409Z +        "Permanent ban should be active"
2025-11-09T23:19:32.6069528Z +    );
2025-11-09T23:19:32.6069640Z +
2025-11-09T23:19:32.6069757Z      // Clean up
2025-11-09T23:19:32.6069912Z      manager.unban_peer(test_addr);
2025-11-09T23:19:32.6070242Z -    assert!(!manager.is_banned(test_addr), "Unbanned peer should not be banned");
2025-11-09T23:19:32.6070363Z +    assert!(
2025-11-09T23:19:32.6070517Z +        !manager.is_banned(test_addr),
2025-11-09T23:19:32.6070722Z +        "Unbanned peer should not be banned"
2025-11-09T23:19:32.6070845Z +    );
2025-11-09T23:19:32.6070955Z  }
2025-11-09T23:19:32.6071064Z  
2025-11-09T23:19:32.6071203Z  #[tokio::test]
2025-11-09T23:19:32.6071673Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:106:
2025-11-09T23:19:32.6072039Z  async fn test_ban_list_temporary() {
2025-11-09T23:19:32.6072245Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:19:32.6072428Z      let manager = NetworkManager::new(addr);
2025-11-09T23:19:32.6072537Z -    
2025-11-09T23:19:32.6072643Z +
2025-11-09T23:19:32.6072808Z      use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:19:32.6072952Z      let now = SystemTime::now()
2025-11-09T23:19:32.6073097Z          .duration_since(UNIX_EPOCH)
2025-11-09T23:19:32.6073401Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:113:
2025-11-09T23:19:32.6073480Z          .unwrap()
2025-11-09T23:19:32.6073551Z          .as_secs();
2025-11-09T23:19:32.6073616Z -    
2025-11-09T23:19:32.6073685Z +
2025-11-09T23:19:32.6073831Z      let test_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:19:32.6073900Z -    
2025-11-09T23:19:32.6073963Z +
2025-11-09T23:19:32.6074060Z      // Test temporary ban (1 hour from now)
2025-11-09T23:19:32.6074152Z      let future_timestamp = now + 3600;
2025-11-09T23:19:32.6074266Z      manager.ban_peer(test_addr, future_timestamp);
2025-11-09T23:19:32.6074657Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:121:
2025-11-09T23:19:32.6074856Z -    assert!(manager.is_banned(test_addr), "Active temporary ban should be active");
2025-11-09T23:19:32.6074921Z -    
2025-11-09T23:19:32.6074998Z +    assert!(
2025-11-09T23:19:32.6075088Z +        manager.is_banned(test_addr),
2025-11-09T23:19:32.6075187Z +        "Active temporary ban should be active"
2025-11-09T23:19:32.6075251Z +    );
2025-11-09T23:19:32.6075320Z +
2025-11-09T23:19:32.6075387Z      // Clean up
2025-11-09T23:19:32.6075474Z      manager.unban_peer(test_addr);
2025-11-09T23:19:32.6075538Z  }
2025-11-09T23:19:32.6075796Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:128:
2025-11-09T23:19:32.6076038Z  async fn test_clear_bans() {
2025-11-09T23:19:32.6076167Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:19:32.6076314Z      let manager = NetworkManager::new(addr);
2025-11-09T23:19:32.6076377Z -    
2025-11-09T23:19:32.6076442Z +
2025-11-09T23:19:32.6076591Z      let test_addr1: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:19:32.6076732Z      let test_addr2: SocketAddr = "127.0.0.1:8334".parse().unwrap();
2025-11-09T23:19:32.6076795Z -    
2025-11-09T23:19:32.6076858Z +
2025-11-09T23:19:32.6076941Z      // Add multiple bans
2025-11-09T23:19:32.6077030Z      manager.ban_peer(test_addr1, 0);
2025-11-09T23:19:32.6077116Z      manager.ban_peer(test_addr2, 0);
2025-11-09T23:19:32.6077377Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:138:
2025-11-09T23:19:32.6077440Z -    
2025-11-09T23:19:32.6077502Z +
2025-11-09T23:19:32.6077622Z      assert_eq!(manager.get_banned_peers().len(), 2);
2025-11-09T23:19:32.6077739Z -    
2025-11-09T23:19:32.6077856Z +
2025-11-09T23:19:32.6077984Z      // Clear all bans
2025-11-09T23:19:32.6078127Z      manager.clear_bans();
2025-11-09T23:19:32.6078237Z -    
2025-11-09T23:19:32.6078346Z +
2025-11-09T23:19:32.6078543Z      assert_eq!(manager.get_banned_peers().len(), 0);
2025-11-09T23:19:32.6078713Z      assert!(!manager.is_banned(test_addr1));
2025-11-09T23:19:32.6078811Z      assert!(!manager.is_banned(test_addr2));
2025-11-09T23:19:32.6079085Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:147:
2025-11-09T23:19:32.6079148Z  }
2025-11-09T23:19:32.6079213Z -
2025-11-09T23:19:32.6079276Z  
2025-11-09T23:19:32.6079552Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:2:
2025-11-09T23:19:32.6079618Z  
2025-11-09T23:19:32.6079688Z  #[cfg(test)]
2025-11-09T23:19:32.6079761Z  mod tests {
2025-11-09T23:19:32.6079897Z +    use bllvm_node::network::protocol::NetworkAddress;
2025-11-09T23:19:32.6080019Z      use bllvm_node::network::protocol::VersionMessage;
2025-11-09T23:19:32.6080488Z -    use bllvm_node::network::protocol::{NODE_UTXO_COMMITMENTS, NODE_BAN_LIST_SHARING, NODE_PACKAGE_RELAY, NODE_FIBRE};
2025-11-09T23:19:32.6080593Z +    use bllvm_node::network::protocol::{
2025-11-09T23:19:32.6080789Z +        NODE_BAN_LIST_SHARING, NODE_FIBRE, NODE_PACKAGE_RELAY, NODE_UTXO_COMMITMENTS,
2025-11-09T23:19:32.6080855Z +    };
2025-11-09T23:19:32.6080979Z      use bllvm_protocol::bip157::NODE_COMPACT_FILTERS;
2025-11-09T23:19:32.6081101Z -    use bllvm_node::network::protocol::NetworkAddress;
2025-11-09T23:19:32.6081164Z  
2025-11-09T23:19:32.6081320Z      fn create_version_message(services: u64) -> VersionMessage {
2025-11-09T23:19:32.6081399Z          VersionMessage {
2025-11-09T23:19:32.6081682Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:36:
2025-11-09T23:19:32.6081784Z              // Peer with UTXO commitments support
2025-11-09T23:19:32.6081885Z              let services = NODE_UTXO_COMMITMENTS;
2025-11-09T23:19:32.6088935Z              let version = create_version_message(services);
2025-11-09T23:19:32.6089364Z -            assert!(version.supports_utxo_commitments(), "Should support UTXO commitments");
2025-11-09T23:19:32.6089456Z +            assert!(
2025-11-09T23:19:32.6089575Z +                version.supports_utxo_commitments(),
2025-11-09T23:19:32.6089679Z +                "Should support UTXO commitments"
2025-11-09T23:19:32.6089748Z +            );
2025-11-09T23:19:32.6089823Z  
2025-11-09T23:19:32.6089931Z              // Peer without UTXO commitments support
2025-11-09T23:19:32.6090014Z              let services = 0;
2025-11-09T23:19:32.6090327Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:43:
2025-11-09T23:19:32.6090448Z              let version = create_version_message(services);
2025-11-09T23:19:32.6090881Z -            assert!(!version.supports_utxo_commitments(), "Should not support UTXO commitments");
2025-11-09T23:19:32.6090960Z +            assert!(
2025-11-09T23:19:32.6091073Z +                !version.supports_utxo_commitments(),
2025-11-09T23:19:32.6091170Z +                "Should not support UTXO commitments"
2025-11-09T23:19:32.6091238Z +            );
2025-11-09T23:19:32.6091309Z  
2025-11-09T23:19:32.6091447Z              // Peer with multiple flags including UTXO commitments
2025-11-09T23:19:32.6091655Z              let services = NODE_UTXO_COMMITMENTS | NODE_COMPACT_FILTERS | NODE_PACKAGE_RELAY;
2025-11-09T23:19:32.6091944Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:48:
2025-11-09T23:19:32.6092058Z              let version = create_version_message(services);
2025-11-09T23:19:32.6092327Z -            assert!(version.supports_utxo_commitments(), "Should support UTXO commitments with other flags");
2025-11-09T23:19:32.6092556Z -            assert!(version.supports_compact_filters(), "Should also support compact filters");
2025-11-09T23:19:32.6092775Z -            assert!(version.supports_package_relay(), "Should also support package relay");
2025-11-09T23:19:32.6092846Z +            assert!(
2025-11-09T23:19:32.6092947Z +                version.supports_utxo_commitments(),
2025-11-09T23:19:32.6093078Z +                "Should support UTXO commitments with other flags"
2025-11-09T23:19:32.6093147Z +            );
2025-11-09T23:19:32.6093215Z +            assert!(
2025-11-09T23:19:32.6093322Z +                version.supports_compact_filters(),
2025-11-09T23:19:32.6093421Z +                "Should also support compact filters"
2025-11-09T23:19:32.6093487Z +            );
2025-11-09T23:19:32.6093558Z +            assert!(
2025-11-09T23:19:32.6093664Z +                version.supports_package_relay(),
2025-11-09T23:19:32.6093762Z +                "Should also support package relay"
2025-11-09T23:19:32.6093829Z +            );
2025-11-09T23:19:32.6093905Z          }
2025-11-09T23:19:32.6093970Z      }
2025-11-09T23:19:32.6094034Z  
2025-11-09T23:19:32.6094840Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:57:
2025-11-09T23:19:32.6094958Z          // Peer with ban list sharing support
2025-11-09T23:19:32.6095056Z          let services = NODE_BAN_LIST_SHARING;
2025-11-09T23:19:32.6095179Z          let version = create_version_message(services);
2025-11-09T23:19:32.6095402Z -        assert!(version.supports_ban_list_sharing(), "Should support ban list sharing");
2025-11-09T23:19:32.6095474Z +        assert!(
2025-11-09T23:19:32.6095578Z +            version.supports_ban_list_sharing(),
2025-11-09T23:19:32.6095678Z +            "Should support ban list sharing"
2025-11-09T23:19:32.6095747Z +        );
2025-11-09T23:19:32.6095813Z  
2025-11-09T23:19:32.6095910Z          // Peer without ban list sharing support
2025-11-09T23:19:32.6095996Z          let services = 0;
2025-11-09T23:19:32.6096298Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:64:
2025-11-09T23:19:32.6096459Z          let version = create_version_message(services);
2025-11-09T23:19:32.6096848Z -        assert!(!version.supports_ban_list_sharing(), "Should not support ban list sharing");
2025-11-09T23:19:32.6097956Z +        assert!(
2025-11-09T23:19:32.6098359Z +            !version.supports_ban_list_sharing(),
2025-11-09T23:19:32.6098840Z +            "Should not support ban list sharing"
2025-11-09T23:19:32.6099106Z +        );
2025-11-09T23:19:32.6099273Z  
2025-11-09T23:19:32.6099503Z          // Peer with multiple flags including ban list sharing
2025-11-09T23:19:32.6099907Z          let services = NODE_BAN_LIST_SHARING | NODE_COMPACT_FILTERS | NODE_FIBRE;
2025-11-09T23:19:32.6101324Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:69:
2025-11-09T23:19:32.6101836Z          let version = create_version_message(services);
2025-11-09T23:19:32.6102505Z -        assert!(version.supports_ban_list_sharing(), "Should support ban list sharing with other flags");
2025-11-09T23:19:32.6103087Z -        assert!(version.supports_compact_filters(), "Should also support compact filters");
2025-11-09T23:19:32.6103462Z +        assert!(
2025-11-09T23:19:32.6103678Z +            version.supports_ban_list_sharing(),
2025-11-09T23:19:32.6103987Z +            "Should support ban list sharing with other flags"
2025-11-09T23:19:32.6104266Z +        );
2025-11-09T23:19:32.6104590Z +        assert!(
2025-11-09T23:19:32.6104804Z +            version.supports_compact_filters(),
2025-11-09T23:19:32.6105095Z +            "Should also support compact filters"
2025-11-09T23:19:32.6105352Z +        );
2025-11-09T23:19:32.6105614Z          assert!(version.supports_fibre(), "Should also support FIBRE");
2025-11-09T23:19:32.6105931Z      }
2025-11-09T23:19:32.6106098Z  
2025-11-09T23:19:32.6106493Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:77:
2025-11-09T23:19:32.6107331Z          // Peer with compact filters support
2025-11-09T23:19:32.6107799Z          let services = NODE_COMPACT_FILTERS;
2025-11-09T23:19:32.6108285Z          let version = create_version_message(services);
2025-11-09T23:19:32.6108971Z -        assert!(version.supports_compact_filters(), "Should support compact filters");
2025-11-09T23:19:32.6109613Z +        assert!(
2025-11-09T23:19:32.6109957Z +            version.supports_compact_filters(),
2025-11-09T23:19:32.6110418Z +            "Should support compact filters"
2025-11-09T23:19:32.6110749Z +        );
2025-11-09T23:19:32.6110915Z  
2025-11-09T23:19:32.6111106Z          // Peer without compact filters support
2025-11-09T23:19:32.6111366Z          let services = 0;
2025-11-09T23:19:32.6111787Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:84:
2025-11-09T23:19:32.6112272Z          let version = create_version_message(services);
2025-11-09T23:19:32.6112694Z -        assert!(!version.supports_compact_filters(), "Should not support compact filters");
2025-11-09T23:19:32.6113246Z +        assert!(
2025-11-09T23:19:32.6113450Z +            !version.supports_compact_filters(),
2025-11-09T23:19:32.6113733Z +            "Should not support compact filters"
2025-11-09T23:19:32.6114021Z +        );
2025-11-09T23:19:32.6114201Z      }
2025-11-09T23:19:32.6114508Z  
2025-11-09T23:19:32.6114671Z      #[test]
2025-11-09T23:19:32.6115206Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:90:
2025-11-09T23:19:32.6115739Z          // Peer with package relay support
2025-11-09T23:19:32.6116047Z          let services = NODE_PACKAGE_RELAY;
2025-11-09T23:19:32.6116326Z          let version = create_version_message(services);
2025-11-09T23:19:32.6116727Z -        assert!(version.supports_package_relay(), "Should support package relay");
2025-11-09T23:19:32.6117096Z +        assert!(
2025-11-09T23:19:32.6117305Z +            version.supports_package_relay(),
2025-11-09T23:19:32.6117574Z +            "Should support package relay"
2025-11-09T23:19:32.6117814Z +        );
2025-11-09T23:19:32.6117966Z  
2025-11-09T23:19:32.6118140Z          // Peer without package relay support
2025-11-09T23:19:32.6118395Z          let services = 0;
2025-11-09T23:19:32.6118817Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:97:
2025-11-09T23:19:32.6119305Z          let version = create_version_message(services);
2025-11-09T23:19:32.6119699Z -        assert!(!version.supports_package_relay(), "Should not support package relay");
2025-11-09T23:19:32.6120444Z +        assert!(
2025-11-09T23:19:32.6120645Z +            !version.supports_package_relay(),
2025-11-09T23:19:32.6120926Z +            "Should not support package relay"
2025-11-09T23:19:32.6121174Z +        );
2025-11-09T23:19:32.6121330Z      }
2025-11-09T23:19:32.6121486Z  
2025-11-09T23:19:32.6121633Z      #[test]
2025-11-09T23:19:32.6122204Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:115:
2025-11-09T23:19:32.6122658Z      fn test_multiple_flags() {
2025-11-09T23:19:32.6122894Z          // Peer with all flags
2025-11-09T23:19:32.6123126Z          #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.6123523Z -        let services = NODE_UTXO_COMMITMENTS | NODE_BAN_LIST_SHARING | NODE_COMPACT_FILTERS | 
2025-11-09T23:19:32.6123927Z -                      NODE_PACKAGE_RELAY | NODE_FIBRE;
2025-11-09T23:19:32.6124200Z +        let services = NODE_UTXO_COMMITMENTS
2025-11-09T23:19:32.6124722Z +            | NODE_BAN_LIST_SHARING
2025-11-09T23:19:32.6124965Z +            | NODE_COMPACT_FILTERS
2025-11-09T23:19:32.6125200Z +            | NODE_PACKAGE_RELAY
2025-11-09T23:19:32.6125428Z +            | NODE_FIBRE;
2025-11-09T23:19:32.6125663Z          #[cfg(not(feature = "utxo-commitments"))]
2025-11-09T23:19:32.6126001Z -        let services = NODE_BAN_LIST_SHARING | NODE_COMPACT_FILTERS | 
2025-11-09T23:19:32.6126352Z -                      NODE_PACKAGE_RELAY | NODE_FIBRE;
2025-11-09T23:19:32.6126609Z +        let services =
2025-11-09T23:19:32.6126936Z +            NODE_BAN_LIST_SHARING | NODE_COMPACT_FILTERS | NODE_PACKAGE_RELAY | NODE_FIBRE;
2025-11-09T23:19:32.6127345Z          let version = create_version_message(services);
2025-11-09T23:19:32.6127603Z -        
2025-11-09T23:19:32.6127765Z +
2025-11-09T23:19:32.6127943Z          #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.6128345Z -        assert!(version.supports_utxo_commitments(), "Should support UTXO commitments");
2025-11-09T23:19:32.6128853Z -        assert!(version.supports_ban_list_sharing(), "Should support ban list sharing");
2025-11-09T23:19:32.6129354Z -        assert!(version.supports_compact_filters(), "Should support compact filters");
2025-11-09T23:19:32.6129847Z -        assert!(version.supports_package_relay(), "Should support package relay");
2025-11-09T23:19:32.6130200Z +        assert!(
2025-11-09T23:19:32.6130414Z +            version.supports_utxo_commitments(),
2025-11-09T23:19:32.6130694Z +            "Should support UTXO commitments"
2025-11-09T23:19:32.6131086Z +        );
2025-11-09T23:19:32.6131248Z +        assert!(
2025-11-09T23:19:32.6131455Z +            version.supports_ban_list_sharing(),
2025-11-09T23:19:32.6131727Z +            "Should support ban list sharing"
2025-11-09T23:19:32.6131965Z +        );
2025-11-09T23:19:32.6132124Z +        assert!(
2025-11-09T23:19:32.6132318Z +            version.supports_compact_filters(),
2025-11-09T23:19:32.6132591Z +            "Should support compact filters"
2025-11-09T23:19:32.6132827Z +        );
2025-11-09T23:19:32.6132984Z +        assert!(
2025-11-09T23:19:32.6133175Z +            version.supports_package_relay(),
2025-11-09T23:19:32.6133438Z +            "Should support package relay"
2025-11-09T23:19:32.6133674Z +        );
2025-11-09T23:19:32.6133912Z          assert!(version.supports_fibre(), "Should support FIBRE");
2025-11-09T23:19:32.6134209Z      }
2025-11-09T23:19:32.6134579Z  
2025-11-09T23:19:32.6135014Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:137:
2025-11-09T23:19:32.6135462Z          {
2025-11-09T23:19:32.6135657Z              let services = NODE_UTXO_COMMITMENTS;
2025-11-09T23:19:32.6135950Z              let version = create_version_message(services);
2025-11-09T23:19:32.6136213Z -            
2025-11-09T23:19:32.6136530Z -            assert!(version.supports_utxo_commitments(), "Should support UTXO commitments");
2025-11-09T23:19:32.6137059Z -            assert!(!version.supports_ban_list_sharing(), "Should not support ban list sharing");
2025-11-09T23:19:32.6137586Z -            assert!(!version.supports_compact_filters(), "Should not support compact filters");
2025-11-09T23:19:32.6137951Z +
2025-11-09T23:19:32.6138105Z +            assert!(
2025-11-09T23:19:32.6138320Z +                version.supports_utxo_commitments(),
2025-11-09T23:19:32.6140496Z +                "Should support UTXO commitments"
2025-11-09T23:19:32.6140892Z +            );
2025-11-09T23:19:32.6141066Z +            assert!(
2025-11-09T23:19:32.6141282Z +                !version.supports_ban_list_sharing(),
2025-11-09T23:19:32.6141562Z +                "Should not support ban list sharing"
2025-11-09T23:19:32.6141799Z +            );
2025-11-09T23:19:32.6141967Z +            assert!(
2025-11-09T23:19:32.6142175Z +                !version.supports_compact_filters(),
2025-11-09T23:19:32.6142449Z +                "Should not support compact filters"
2025-11-09T23:19:32.6142695Z +            );
2025-11-09T23:19:32.6142859Z          }
2025-11-09T23:19:32.6143017Z      }
2025-11-09T23:19:32.6143166Z  
2025-11-09T23:19:32.6143542Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:149:
2025-11-09T23:19:32.6144007Z          // Verify bit positions don't overlap
2025-11-09T23:19:32.6144523Z          #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.6144843Z          {
2025-11-09T23:19:32.6145151Z -            assert_eq!(NODE_UTXO_COMMITMENTS, 1 << 27, "UTXO commitments should be bit 27");
2025-11-09T23:19:32.6145525Z +            assert_eq!(
2025-11-09T23:19:32.6145733Z +                NODE_UTXO_COMMITMENTS,
2025-11-09T23:19:32.6145969Z +                1 << 27,
2025-11-09T23:19:32.6146189Z +                "UTXO commitments should be bit 27"
2025-11-09T23:19:32.6146435Z +            );
2025-11-09T23:19:32.6146595Z          }
2025-11-09T23:19:32.6146879Z -        assert_eq!(NODE_BAN_LIST_SHARING, 1 << 28, "Ban list sharing should be bit 28");
2025-11-09T23:19:32.6147328Z -        assert_eq!(NODE_PACKAGE_RELAY, 1 << 25, "Package relay should be bit 25");
2025-11-09T23:19:32.6147665Z +        assert_eq!(
2025-11-09T23:19:32.6147864Z +            NODE_BAN_LIST_SHARING,
2025-11-09T23:19:32.6148090Z +            1 << 28,
2025-11-09T23:19:32.6148299Z +            "Ban list sharing should be bit 28"
2025-11-09T23:19:32.6150339Z +        );
2025-11-09T23:19:32.6150502Z +        assert_eq!(
2025-11-09T23:19:32.6150697Z +            NODE_PACKAGE_RELAY,
2025-11-09T23:19:32.6150910Z +            1 << 25,
2025-11-09T23:19:32.6151284Z +            "Package relay should be bit 25"
2025-11-09T23:19:32.6151528Z +        );
2025-11-09T23:19:32.6151751Z          assert_eq!(NODE_FIBRE, 1 << 26, "FIBRE should be bit 26");
2025-11-09T23:19:32.6152037Z -        
2025-11-09T23:19:32.6152194Z +
2025-11-09T23:19:32.6152353Z          // Verify no overlap
2025-11-09T23:19:32.6152591Z          #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.6152822Z          {
2025-11-09T23:19:32.6153196Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:161:
2025-11-09T23:19:32.6153787Z -            assert_eq!(NODE_UTXO_COMMITMENTS & NODE_BAN_LIST_SHARING, 0, "Flags should not overlap");
2025-11-09T23:19:32.6154442Z -            assert_eq!(NODE_UTXO_COMMITMENTS & NODE_PACKAGE_RELAY, 0, "Flags should not overlap");
2025-11-09T23:19:32.6154947Z -            assert_eq!(NODE_UTXO_COMMITMENTS & NODE_FIBRE, 0, "Flags should not overlap");
2025-11-09T23:19:32.6155555Z +            assert_eq!(
2025-11-09T23:19:32.6155994Z +                NODE_UTXO_COMMITMENTS & NODE_BAN_LIST_SHARING,
2025-11-09T23:19:32.6156450Z +                0,
2025-11-09T23:19:32.6156775Z +                "Flags should not overlap"
2025-11-09T23:19:32.6157152Z +            );
2025-11-09T23:19:32.6157339Z +            assert_eq!(
2025-11-09T23:19:32.6157576Z +                NODE_UTXO_COMMITMENTS & NODE_PACKAGE_RELAY,
2025-11-09T23:19:32.6157839Z +                0,
2025-11-09T23:19:32.6158031Z +                "Flags should not overlap"
2025-11-09T23:19:32.6158268Z +            );
2025-11-09T23:19:32.6158444Z +            assert_eq!(
2025-11-09T23:19:32.6158659Z +                NODE_UTXO_COMMITMENTS & NODE_FIBRE,
2025-11-09T23:19:32.6158910Z +                0,
2025-11-09T23:19:32.6159100Z +                "Flags should not overlap"
2025-11-09T23:19:32.6159332Z +            );
2025-11-09T23:19:32.6159674Z          }
2025-11-09T23:19:32.6159988Z -        assert_eq!(NODE_BAN_LIST_SHARING & NODE_PACKAGE_RELAY, 0, "Flags should not overlap");
2025-11-09T23:19:32.6162453Z -        assert_eq!(NODE_BAN_LIST_SHARING & NODE_FIBRE, 0, "Flags should not overlap");
2025-11-09T23:19:32.6162909Z -        assert_eq!(NODE_PACKAGE_RELAY & NODE_FIBRE, 0, "Flags should not overlap");
2025-11-09T23:19:32.6163251Z +        assert_eq!(
2025-11-09T23:19:32.6163474Z +            NODE_BAN_LIST_SHARING & NODE_PACKAGE_RELAY,
2025-11-09T23:19:32.6163730Z +            0,
2025-11-09T23:19:32.6163914Z +            "Flags should not overlap"
2025-11-09T23:19:32.6164145Z +        );
2025-11-09T23:19:32.6164429Z +        assert_eq!(
2025-11-09T23:19:32.6164641Z +            NODE_BAN_LIST_SHARING & NODE_FIBRE,
2025-11-09T23:19:32.6164884Z +            0,
2025-11-09T23:19:32.6165071Z +            "Flags should not overlap"
2025-11-09T23:19:32.6165287Z +        );
2025-11-09T23:19:32.6165447Z +        assert_eq!(
2025-11-09T23:19:32.6165658Z +            NODE_PACKAGE_RELAY & NODE_FIBRE,
2025-11-09T23:19:32.6165890Z +            0,
2025-11-09T23:19:32.6166072Z +            "Flags should not overlap"
2025-11-09T23:19:32.6166295Z +        );
2025-11-09T23:19:32.6166456Z      }
2025-11-09T23:19:32.6166608Z  }
2025-11-09T23:19:32.6166758Z -
2025-11-09T23:19:32.6166908Z  
2025-11-09T23:19:32.6167270Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/storage_arcs_tests.rs:1:
2025-11-09T23:19:32.6167720Z  //! Tests for Storage Arc refactoring
2025-11-09T23:19:32.6167951Z  
2025-11-09T23:19:32.6168129Z -use bllvm_node::storage::Storage;
2025-11-09T23:19:32.6168421Z  use bllvm_node::network::chain_access::NodeChainAccess;
2025-11-09T23:19:32.6168739Z  use bllvm_node::node::mempool::MempoolManager;
2025-11-09T23:19:32.6169008Z +use bllvm_node::storage::Storage;
2025-11-09T23:19:32.6169238Z  use std::sync::Arc;
2025-11-09T23:19:32.6169426Z  use tempfile::TempDir;
2025-11-09T23:19:32.6169616Z  
2025-11-09T23:19:32.6169972Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/storage_arcs_tests.rs:10:
2025-11-09T23:19:32.6172016Z  fn test_storage_returns_arcs() {
2025-11-09T23:19:32.6172406Z      let temp_dir = TempDir::new().unwrap();
2025-11-09T23:19:32.6172708Z      let storage = Storage::new(temp_dir.path()).unwrap();
2025-11-09T23:19:32.6172985Z -    
2025-11-09T23:19:32.6173130Z +
2025-11-09T23:19:32.6173295Z      // Verify blocks() returns Arc
2025-11-09T23:19:32.6173538Z      let blocks_arc = storage.blocks();
2025-11-09T23:19:32.6173792Z      let blocks_arc2 = storage.blocks();
2025-11-09T23:19:32.6174226Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/storage_arcs_tests.rs:17:
2025-11-09T23:19:32.6174776Z -    
2025-11-09T23:19:32.6174922Z +
2025-11-09T23:19:32.6175094Z      // Both should be valid Arcs (can clone)
2025-11-09T23:19:32.6175497Z      assert!(Arc::ptr_eq(&blocks_arc, &blocks_arc2) || blocks_arc.block_count().is_ok());
2025-11-09T23:19:32.6175998Z -    
2025-11-09T23:19:32.6176281Z +
2025-11-09T23:19:32.6176573Z      // Verify transactions() returns Arc
2025-11-09T23:19:32.6177018Z      let tx_arc = storage.transactions();
2025-11-09T23:19:32.6177411Z      let tx_arc2 = storage.transactions();
2025-11-09T23:19:32.6177868Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/storage_arcs_tests.rs:24:
2025-11-09T23:19:32.6178385Z -    
2025-11-09T23:19:32.6178539Z +
2025-11-09T23:19:32.6178816Z      assert!(Arc::ptr_eq(&tx_arc, &tx_arc2) || tx_arc.has_transaction(&[0u8; 32]).is_ok());
2025-11-09T23:19:32.6179152Z  }
2025-11-09T23:19:32.6179302Z  
2025-11-09T23:19:32.6179661Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/storage_arcs_tests.rs:30:
2025-11-09T23:19:32.6180231Z      let temp_dir = TempDir::new().unwrap();
2025-11-09T23:19:32.6180753Z      let storage = Storage::new(temp_dir.path()).unwrap();
2025-11-09T23:19:32.6181290Z      let mempool = Arc::new(MempoolManager::new());
2025-11-09T23:19:32.6181627Z -    
2025-11-09T23:19:32.6181947Z +
2025-11-09T23:19:32.6182191Z      // Should be able to create NodeChainAccess with Arcs from Storage
2025-11-09T23:19:32.6182538Z -    let chain_access = NodeChainAccess::new(
2025-11-09T23:19:32.6182805Z -        storage.blocks(),
2025-11-09T23:19:32.6183020Z -        storage.transactions(),
2025-11-09T23:19:32.6183237Z -        mempool,
2025-11-09T23:19:32.6183406Z -    );
2025-11-09T23:19:32.6183560Z -    
2025-11-09T23:19:32.6183889Z +    let chain_access = NodeChainAccess::new(storage.blocks(), storage.transactions(), mempool);
2025-11-09T23:19:32.6184407Z +
2025-11-09T23:19:32.6184630Z      // Verify it works
2025-11-09T23:19:32.6184909Z      let hash = [0u8; 32];
2025-11-09T23:19:32.6185155Z      let has_object = chain_access.has_object(&hash);
2025-11-09T23:19:32.6185620Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/storage_arcs_tests.rs:44:
2025-11-09T23:19:32.6186115Z      assert!(!has_object); // Empty storage, so should be false
2025-11-09T23:19:32.6186397Z  }
2025-11-09T23:19:32.6186545Z -
2025-11-09T23:19:32.6186687Z  
2025-11-09T23:19:32.6186997Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:1:
2025-11-09T23:19:32.6187415Z -use bllvm_protocol::ProtocolVersion;
2025-11-09T23:19:32.6187703Z  use bllvm_node::storage::blockstore::BlockStore;
2025-11-09T23:19:32.6188008Z  use bllvm_node::storage::chainstate::ChainState;
2025-11-09T23:19:32.6188289Z  use bllvm_node::storage::txindex::TxIndex;
2025-11-09T23:19:32.6190619Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:9:
2025-11-09T23:19:32.6191015Z  use bllvm_node::OutPoint;
2025-11-09T23:19:32.6191239Z  use bllvm_node::Transaction;
2025-11-09T23:19:32.6191550Z  use bllvm_node::{ByteString, TransactionInput, TransactionOutput};
2025-11-09T23:19:32.6191891Z +use bllvm_protocol::ProtocolVersion;
2025-11-09T23:19:32.6192141Z  use std::collections::HashMap;
2025-11-09T23:19:32.6192363Z  use tempfile::TempDir;
2025-11-09T23:19:32.6192557Z  
2025-11-09T23:19:32.6192907Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/storage_tests.rs:4:
2025-11-09T23:19:32.6193485Z  use bllvm_node::storage::*;
2025-11-09T23:19:32.6193707Z  use tempfile::TempDir;
2025-11-09T23:19:32.6193903Z  mod common;
2025-11-09T23:19:32.6194074Z -use common::*;
2025-11-09T23:19:32.6194422Z  use bllvm_node::storage::blockstore::BlockStore;
2025-11-09T23:19:32.6194734Z  use bllvm_node::storage::chainstate::ChainState;
2025-11-09T23:19:32.6195020Z  use bllvm_node::storage::txindex::TxIndex;
2025-11-09T23:19:32.6195465Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/storage_tests.rs:11:
2025-11-09T23:19:32.6195914Z  use bllvm_node::storage::utxostore::UtxoStore;
2025-11-09T23:19:32.6196178Z +use common::*;
2025-11-09T23:19:32.6196344Z  
2025-11-09T23:19:32.6196491Z  #[test]
2025-11-09T23:19:32.6196668Z  fn test_storage_creation() {
2025-11-09T23:19:32.6197042Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:1:
2025-11-09T23:19:32.6197462Z -use bllvm_protocol::ProtocolVersion;
2025-11-09T23:19:32.6197743Z  use bllvm_node::storage::blockstore::BlockStore;
2025-11-09T23:19:32.6198049Z  use bllvm_node::storage::chainstate::ChainState;
2025-11-09T23:19:32.6198326Z  use bllvm_node::storage::txindex::TxIndex;
2025-11-09T23:19:32.6200563Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:9:
2025-11-09T23:19:32.6200959Z  use bllvm_node::OutPoint;
2025-11-09T23:19:32.6201370Z  use bllvm_node::Transaction;
2025-11-09T23:19:32.6201681Z  use bllvm_node::{ByteString, TransactionInput, TransactionOutput};
2025-11-09T23:19:32.6202023Z +use bllvm_protocol::ProtocolVersion;
2025-11-09T23:19:32.6202276Z  use std::collections::HashMap;
2025-11-09T23:19:32.6202501Z  use tempfile::TempDir;
2025-11-09T23:19:32.6202686Z  
2025-11-09T23:19:32.6203222Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/stratum_v2_mining_tests.rs:1:
2025-11-09T23:19:32.6203905Z  //! Unit tests for Stratum V2 mining and share validation
2025-11-09T23:19:32.6204175Z  
2025-11-09T23:19:32.6204567Z -use bllvm_protocol::types::{Block, BlockHeader, Hash, Natural};
2025-11-09T23:19:32.6204945Z  use bllvm_node::network::stratum_v2::messages::ShareData;
2025-11-09T23:19:32.6205321Z  use bllvm_node::network::stratum_v2::pool::{JobInfo, StratumV2Pool};
2025-11-09T23:19:32.6205711Z +use bllvm_protocol::types::{Block, BlockHeader, Hash, Natural};
2025-11-09T23:19:32.6206024Z  use tempfile::TempDir;
2025-11-09T23:19:32.6206218Z  mod common;
2025-11-09T23:19:32.6206383Z  use common::*;
2025-11-09T23:19:32.6248356Z ##[error]Process completed with exit code 1.
