2025-11-09T23:19:24.7775301Z Current runner version: '2.329.0'
2025-11-09T23:19:24.7783813Z Runner name: 'linode-runner-02'
2025-11-09T23:19:24.7784770Z Runner group name: 'default'
2025-11-09T23:19:24.7785794Z Machine name: 'localhost'
2025-11-09T23:19:24.7788856Z ##[group]GITHUB_TOKEN Permissions
2025-11-09T23:19:24.7794173Z Contents: read
2025-11-09T23:19:24.7795324Z Metadata: read
2025-11-09T23:19:24.7796277Z Packages: read
2025-11-09T23:19:24.7797161Z ##[endgroup]
2025-11-09T23:19:24.7802099Z Secret source: Actions
2025-11-09T23:19:24.7803401Z Prepare workflow directory
2025-11-09T23:19:24.8483725Z Prepare all required actions
2025-11-09T23:19:24.8559335Z Getting action download info
2025-11-09T23:19:25.2236352Z Download action repository 'actions/checkout@v4' (SHA:08eba0b27e820071cde6df949e0beb9ba4906955)
2025-11-09T23:19:25.6868607Z Download action repository 'dtolnay/rust-toolchain@master' (SHA:6d653acede28d24f02e3cd41383119e8b1b35921)
2025-11-09T23:19:26.0541235Z Complete job name: Rustfmt
2025-11-09T23:19:26.1174660Z A job started hook has been configured by the self-hosted runner administrator
2025-11-09T23:19:26.1339157Z ##[group]Run '/home/jswift/actions-runner-org2/cleanup-hooks/job-started.sh'
2025-11-09T23:19:26.1373478Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2025-11-09T23:19:26.1375064Z ##[endgroup]
2025-11-09T23:19:26.1568117Z Job started: Sun Nov  9 11:19:26 PM UTC 2025
2025-11-09T23:19:26.1585987Z Available disk space: 12G
2025-11-09T23:19:26.1625388Z Disk usage is 76% - no cleanup needed
2025-11-09T23:19:26.1937740Z ##[group]Run actions/checkout@v4
2025-11-09T23:19:26.1938408Z with:
2025-11-09T23:19:26.1938884Z   repository: BTCDecoded/bllvm-node
2025-11-09T23:19:26.1939697Z   token: ***
2025-11-09T23:19:26.1940159Z   ssh-strict: true
2025-11-09T23:19:26.1940641Z   ssh-user: git
2025-11-09T23:19:26.1941109Z   persist-credentials: true
2025-11-09T23:19:26.1941649Z   clean: true
2025-11-09T23:19:26.1942115Z   sparse-checkout-cone-mode: true
2025-11-09T23:19:26.1942700Z   fetch-depth: 1
2025-11-09T23:19:26.1943184Z   fetch-tags: false
2025-11-09T23:19:26.1943655Z   show-progress: true
2025-11-09T23:19:26.1944142Z   lfs: false
2025-11-09T23:19:26.1944772Z   submodules: false
2025-11-09T23:19:26.1945246Z   set-safe-directory: true
2025-11-09T23:19:26.1945739Z env:
2025-11-09T23:19:26.1947965Z   CARGO_TERM_COLOR: always
2025-11-09T23:19:26.1948476Z ##[endgroup]
2025-11-09T23:19:26.3284065Z Syncing repository: BTCDecoded/bllvm-node
2025-11-09T23:19:26.3286457Z ##[group]Getting Git version info
2025-11-09T23:19:26.3287599Z Working directory is '/home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node'
2025-11-09T23:19:26.3288949Z [command]/usr/bin/git version
2025-11-09T23:19:26.3301339Z git version 2.43.0
2025-11-09T23:19:26.3335599Z ##[endgroup]
2025-11-09T23:19:26.3353234Z Copying '/home/jswift/.gitconfig' to '/home/jswift/actions-runner-org2/_work/_temp/3d878635-442b-4f04-9226-f31eeb98b604/.gitconfig'
2025-11-09T23:19:26.3367363Z Temporarily overriding HOME='/home/jswift/actions-runner-org2/_work/_temp/3d878635-442b-4f04-9226-f31eeb98b604' before making global git config changes
2025-11-09T23:19:26.3370959Z Adding repository directory to the temporary git global config as a safe directory
2025-11-09T23:19:26.3385555Z [command]/usr/bin/git config --global --add safe.directory /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node
2025-11-09T23:19:26.3435486Z [command]/usr/bin/git config --local --get remote.origin.url
2025-11-09T23:19:26.3464782Z https://github.com/BTCDecoded/bllvm-node
2025-11-09T23:19:26.3483977Z ##[group]Removing previously created refs, to avoid conflicts
2025-11-09T23:19:26.3489649Z [command]/usr/bin/git rev-parse --symbolic-full-name --verify --quiet HEAD
2025-11-09T23:19:26.3516264Z refs/heads/main
2025-11-09T23:19:26.3528427Z [command]/usr/bin/git checkout --detach
2025-11-09T23:19:26.3616966Z HEAD is now at 60b79f7 feat: Automatic peer connection initialization on startup
2025-11-09T23:19:26.3671385Z [command]/usr/bin/git branch --delete --force main
2025-11-09T23:19:26.3710137Z Deleted branch main (was 60b79f7).
2025-11-09T23:19:26.3761656Z ##[endgroup]
2025-11-09T23:19:26.3764507Z [command]/usr/bin/git submodule status
2025-11-09T23:19:26.4049541Z ##[group]Cleaning the repository
2025-11-09T23:19:26.4054258Z [command]/usr/bin/git clean -ffdx
2025-11-09T23:19:26.4147560Z [command]/usr/bin/git reset --hard HEAD
2025-11-09T23:19:26.4274187Z HEAD is now at 60b79f7 feat: Automatic peer connection initialization on startup
2025-11-09T23:19:26.4285734Z ##[endgroup]
2025-11-09T23:19:26.4287185Z ##[group]Disabling automatic garbage collection
2025-11-09T23:19:26.4291458Z [command]/usr/bin/git config --local gc.auto 0
2025-11-09T23:19:26.4337071Z ##[endgroup]
2025-11-09T23:19:26.4338306Z ##[group]Setting up auth
2025-11-09T23:19:26.4342927Z [command]/usr/bin/git config --local --name-only --get-regexp core\.sshCommand
2025-11-09T23:19:26.4380770Z [command]/usr/bin/git submodule foreach --recursive sh -c "git config --local --name-only --get-regexp 'core\.sshCommand' && git config --local --unset-all 'core.sshCommand' || :"
2025-11-09T23:19:26.4706584Z [command]/usr/bin/git config --local --name-only --get-regexp http\.https\:\/\/github\.com\/\.extraheader
2025-11-09T23:19:26.4746059Z [command]/usr/bin/git submodule foreach --recursive sh -c "git config --local --name-only --get-regexp 'http\.https\:\/\/github\.com\/\.extraheader' && git config --local --unset-all 'http.https://github.com/.extraheader' || :"
2025-11-09T23:19:26.5048700Z [command]/usr/bin/git config --local http.https://github.com/.extraheader AUTHORIZATION: basic ***
2025-11-09T23:19:26.5092978Z ##[endgroup]
2025-11-09T23:19:26.5094649Z ##[group]Fetching the repository
2025-11-09T23:19:26.5105341Z [command]/usr/bin/git -c protocol.version=2 fetch --no-tags --prune --no-recurse-submodules --depth=1 origin +7454b9d214921fb679a00d4f1212adf8aa8e0f4b:refs/remotes/origin/main
2025-11-09T23:19:26.7473458Z From https://github.com/BTCDecoded/bllvm-node
2025-11-09T23:19:26.7477701Z  + 60b79f7...7454b9d 7454b9d214921fb679a00d4f1212adf8aa8e0f4b -> origin/main  (forced update)
2025-11-09T23:19:26.7505205Z ##[endgroup]
2025-11-09T23:19:26.7508982Z ##[group]Determining the checkout info
2025-11-09T23:19:26.7511105Z ##[endgroup]
2025-11-09T23:19:26.7515305Z [command]/usr/bin/git sparse-checkout disable
2025-11-09T23:19:26.7579796Z [command]/usr/bin/git config --local --unset-all extensions.worktreeConfig
2025-11-09T23:19:26.7610789Z ##[group]Checking out the ref
2025-11-09T23:19:26.7615346Z [command]/usr/bin/git checkout --progress --force -B main refs/remotes/origin/main
2025-11-09T23:19:26.7700457Z Warning: you are leaving 1 commit behind, not connected to
2025-11-09T23:19:26.7704853Z any of your branches:
2025-11-09T23:19:26.7705853Z 
2025-11-09T23:19:26.7707000Z   60b79f7 feat: Automatic peer connection initialization on startup
2025-11-09T23:19:26.7708441Z 
2025-11-09T23:19:26.7709378Z If you want to keep it by creating a new branch, this may be a good time
2025-11-09T23:19:26.7711449Z to do so with:
2025-11-09T23:19:26.7712141Z 
2025-11-09T23:19:26.7712993Z  git branch <new-branch-name> 60b79f7
2025-11-09T23:19:26.7714646Z 
2025-11-09T23:19:26.7715324Z Switched to a new branch 'main'
2025-11-09T23:19:26.7716950Z branch 'main' set up to track 'origin/main'.
2025-11-09T23:19:26.7725390Z ##[endgroup]
2025-11-09T23:19:26.7770440Z [command]/usr/bin/git log -1 --format=%H
2025-11-09T23:19:26.7801451Z 7454b9d214921fb679a00d4f1212adf8aa8e0f4b
2025-11-09T23:19:26.8291494Z ##[group]Run actions/checkout@v4
2025-11-09T23:19:26.8293321Z with:
2025-11-09T23:19:26.8295093Z   repository: BTCDecoded/protocol-engine
2025-11-09T23:19:26.8297233Z   path: _temp-protocol-engine
2025-11-09T23:19:26.8302064Z   token: ***
2025-11-09T23:19:26.8303054Z   ssh-strict: true
2025-11-09T23:19:26.8304126Z   ssh-user: git
2025-11-09T23:19:26.8305337Z   persist-credentials: true
2025-11-09T23:19:26.8306822Z   clean: true
2025-11-09T23:19:26.8310034Z   sparse-checkout-cone-mode: true
2025-11-09T23:19:26.8311147Z   fetch-depth: 1
2025-11-09T23:19:26.8312036Z   fetch-tags: false
2025-11-09T23:19:26.8313213Z   show-progress: true
2025-11-09T23:19:26.8314261Z   lfs: false
2025-11-09T23:19:26.8315236Z   submodules: false
2025-11-09T23:19:26.8316140Z   set-safe-directory: true
2025-11-09T23:19:26.8317078Z env:
2025-11-09T23:19:26.8317857Z   CARGO_TERM_COLOR: always
2025-11-09T23:19:26.8318840Z ##[endgroup]
2025-11-09T23:19:26.9649198Z Syncing repository: BTCDecoded/protocol-engine
2025-11-09T23:19:26.9656399Z ##[group]Getting Git version info
2025-11-09T23:19:26.9658676Z Working directory is '/home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/_temp-protocol-engine'
2025-11-09T23:19:26.9704226Z [command]/usr/bin/git version
2025-11-09T23:19:26.9762381Z git version 2.43.0
2025-11-09T23:19:26.9808506Z ##[endgroup]
2025-11-09T23:19:26.9823914Z Copying '/home/jswift/.gitconfig' to '/home/jswift/actions-runner-org2/_work/_temp/da32b2f8-8348-4470-8589-20c07fa58b71/.gitconfig'
2025-11-09T23:19:26.9843255Z Temporarily overriding HOME='/home/jswift/actions-runner-org2/_work/_temp/da32b2f8-8348-4470-8589-20c07fa58b71' before making global git config changes
2025-11-09T23:19:26.9850846Z Adding repository directory to the temporary git global config as a safe directory
2025-11-09T23:19:26.9854009Z [command]/usr/bin/git config --global --add safe.directory /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/_temp-protocol-engine
2025-11-09T23:19:26.9905846Z ##[group]Initializing the repository
2025-11-09T23:19:26.9913838Z [command]/usr/bin/git init /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/_temp-protocol-engine
2025-11-09T23:19:26.9972932Z Initialized empty Git repository in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/_temp-protocol-engine/.git/
2025-11-09T23:19:26.9983590Z [command]/usr/bin/git remote add origin https://github.com/BTCDecoded/protocol-engine
2025-11-09T23:19:27.0020432Z ##[endgroup]
2025-11-09T23:19:27.0023831Z ##[group]Disabling automatic garbage collection
2025-11-09T23:19:27.0026665Z [command]/usr/bin/git config --local gc.auto 0
2025-11-09T23:19:27.0059668Z ##[endgroup]
2025-11-09T23:19:27.0061292Z ##[group]Setting up auth
2025-11-09T23:19:27.0064180Z [command]/usr/bin/git config --local --name-only --get-regexp core\.sshCommand
2025-11-09T23:19:27.0101723Z [command]/usr/bin/git submodule foreach --recursive sh -c "git config --local --name-only --get-regexp 'core\.sshCommand' && git config --local --unset-all 'core.sshCommand' || :"
2025-11-09T23:19:27.0394490Z [command]/usr/bin/git config --local --name-only --get-regexp http\.https\:\/\/github\.com\/\.extraheader
2025-11-09T23:19:27.0436829Z [command]/usr/bin/git submodule foreach --recursive sh -c "git config --local --name-only --get-regexp 'http\.https\:\/\/github\.com\/\.extraheader' && git config --local --unset-all 'http.https://github.com/.extraheader' || :"
2025-11-09T23:19:27.0734460Z [command]/usr/bin/git config --local http.https://github.com/.extraheader AUTHORIZATION: basic ***
2025-11-09T23:19:27.0783399Z ##[endgroup]
2025-11-09T23:19:27.0785830Z ##[group]Determining the default branch
2025-11-09T23:19:27.0787735Z Retrieving the default branch name
2025-11-09T23:19:27.5220967Z Default branch 'main'
2025-11-09T23:19:27.5223958Z ##[endgroup]
2025-11-09T23:19:27.5226149Z ##[group]Fetching the repository
2025-11-09T23:19:27.5231909Z [command]/usr/bin/git -c protocol.version=2 fetch --no-tags --prune --no-recurse-submodules --depth=1 origin +refs/heads/main:refs/remotes/origin/main
2025-11-09T23:19:29.7543491Z From https://github.com/BTCDecoded/protocol-engine
2025-11-09T23:19:29.7544545Z  * [new branch]      main       -> origin/main
2025-11-09T23:19:29.7567388Z ##[endgroup]
2025-11-09T23:19:29.7568183Z ##[group]Determining the checkout info
2025-11-09T23:19:29.7574705Z ##[endgroup]
2025-11-09T23:19:29.7575518Z [command]/usr/bin/git sparse-checkout disable
2025-11-09T23:19:29.7626478Z [command]/usr/bin/git config --local --unset-all extensions.worktreeConfig
2025-11-09T23:19:29.7663042Z ##[group]Checking out the ref
2025-11-09T23:19:29.7667407Z [command]/usr/bin/git checkout --progress --force -B main refs/remotes/origin/main
2025-11-09T23:19:30.4400765Z Reset branch 'main'
2025-11-09T23:19:30.4401607Z branch 'main' set up to track 'origin/main'.
2025-11-09T23:19:30.4466472Z ##[endgroup]
2025-11-09T23:19:30.4514688Z [command]/usr/bin/git log -1 --format=%H
2025-11-09T23:19:30.4554829Z 2a58c93c82c793f4d2179fcddc426fc76b304e68
2025-11-09T23:19:30.4727750Z ##[group]Run if [ -d "../protocol-engine" ]; then rm -rf ../protocol-engine; fi
2025-11-09T23:19:30.4728414Z [36;1mif [ -d "../protocol-engine" ]; then rm -rf ../protocol-engine; fi[0m
2025-11-09T23:19:30.4730633Z [36;1mmv _temp-protocol-engine ../protocol-engine[0m
2025-11-09T23:19:30.4766627Z shell: /usr/bin/bash -e {0}
2025-11-09T23:19:30.4766905Z env:
2025-11-09T23:19:30.4767117Z   CARGO_TERM_COLOR: always
2025-11-09T23:19:30.4767365Z ##[endgroup]
2025-11-09T23:19:30.5364804Z ##[group]Run dtolnay/rust-toolchain@master
2025-11-09T23:19:30.5365148Z with:
2025-11-09T23:19:30.5365336Z   toolchain: 1.88.0
2025-11-09T23:19:30.5365572Z   components: rustfmt
2025-11-09T23:19:30.5365773Z env:
2025-11-09T23:19:30.5365955Z   CARGO_TERM_COLOR: always
2025-11-09T23:19:30.5366168Z ##[endgroup]
2025-11-09T23:19:30.5482878Z ##[group]Run : parse toolchain version
2025-11-09T23:19:30.5483237Z [36;1m: parse toolchain version[0m
2025-11-09T23:19:30.5483548Z [36;1mif [[ -z $toolchain ]]; then[0m
2025-11-09T23:19:30.5484054Z [36;1m  # GitHub does not enforce `required: true` inputs itself. https://github.com/actions/runner/issues/1070[0m
2025-11-09T23:19:30.5484769Z [36;1m  echo "'toolchain' is a required input" >&2[0m
2025-11-09T23:19:30.5485063Z [36;1m  exit 1[0m
2025-11-09T23:19:30.5485372Z [36;1melif [[ $toolchain =~ ^stable' '[0-9]+' '(year|month|week|day)s?' 'ago$ ]]; then[0m
2025-11-09T23:19:30.5485761Z [36;1m  if [[ Linux == macOS ]]; then[0m
2025-11-09T23:19:30.5486364Z [36;1m    echo "toolchain=1.$((($(date -v-$(sed 's/stable \([0-9]*\) \(.\).*/\1\2/' <<< $toolchain) +%s)/60/60/24-16569)/7/6))" >> $GITHUB_OUTPUT[0m
2025-11-09T23:19:30.5486841Z [36;1m  else[0m
2025-11-09T23:19:30.5487215Z [36;1m    echo "toolchain=1.$((($(date --date "${toolchain#stable }" +%s)/60/60/24-16569)/7/6))" >> $GITHUB_OUTPUT[0m
2025-11-09T23:19:30.5487632Z [36;1m  fi[0m
2025-11-09T23:19:30.5487910Z [36;1melif [[ $toolchain =~ ^stable' 'minus' '[0-9]+' 'releases?$ ]]; then[0m
2025-11-09T23:19:30.5488404Z [36;1m  echo "toolchain=1.$((($(date +%s)/60/60/24-16569)/7/6-${toolchain//[^0-9]/}))" >> $GITHUB_OUTPUT[0m
2025-11-09T23:19:30.5488827Z [36;1melif [[ $toolchain =~ ^1\.[0-9]+$ ]]; then[0m
2025-11-09T23:19:30.5489300Z [36;1m  echo "toolchain=1.$((i=${toolchain#1.}, c=($(date +%s)/60/60/24-16569)/7/6, i+9*i*(10*i<=c)+90*i*(100*i<=c)))" >> $GITHUB_OUTPUT[0m
2025-11-09T23:19:30.5489740Z [36;1melse[0m
2025-11-09T23:19:30.5489979Z [36;1m  echo "toolchain=$toolchain" >> $GITHUB_OUTPUT[0m
2025-11-09T23:19:30.5490268Z [36;1mfi[0m
2025-11-09T23:19:30.5523046Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2025-11-09T23:19:30.5523412Z env:
2025-11-09T23:19:30.5523604Z   CARGO_TERM_COLOR: always
2025-11-09T23:19:30.5523835Z   toolchain: 1.88.0
2025-11-09T23:19:30.5524039Z ##[endgroup]
2025-11-09T23:19:30.5657007Z ##[group]Run : construct rustup command line
2025-11-09T23:19:30.5657351Z [36;1m: construct rustup command line[0m
2025-11-09T23:19:30.5657796Z [36;1mecho "targets=$(for t in ${targets//,/ }; do echo -n ' --target' $t; done)" >> $GITHUB_OUTPUT[0m
2025-11-09T23:19:30.5658426Z [36;1mecho "components=$(for c in ${components//,/ }; do echo -n ' --component' $c; done)" >> $GITHUB_OUTPUT[0m
2025-11-09T23:19:30.5660775Z [36;1mecho "downgrade=" >> $GITHUB_OUTPUT[0m
2025-11-09T23:19:30.5693472Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2025-11-09T23:19:30.5693829Z env:
2025-11-09T23:19:30.5694027Z   CARGO_TERM_COLOR: always
2025-11-09T23:19:30.5694256Z   targets: 
2025-11-09T23:19:30.5694680Z   components: rustfmt
2025-11-09T23:19:30.5694893Z ##[endgroup]
2025-11-09T23:19:30.5801519Z ##[group]Run : set $CARGO_HOME
2025-11-09T23:19:30.5802111Z [36;1m: set $CARGO_HOME[0m
2025-11-09T23:19:30.5802433Z [36;1mecho CARGO_HOME=${CARGO_HOME:-"$HOME/.cargo"} >> $GITHUB_ENV[0m
2025-11-09T23:19:30.5834077Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2025-11-09T23:19:30.5834706Z env:
2025-11-09T23:19:30.5834904Z   CARGO_TERM_COLOR: always
2025-11-09T23:19:30.5835135Z ##[endgroup]
2025-11-09T23:19:30.5926679Z ##[group]Run : install rustup if needed
2025-11-09T23:19:30.5926992Z [36;1m: install rustup if needed[0m
2025-11-09T23:19:30.5927290Z [36;1mif ! command -v rustup &>/dev/null; then[0m
2025-11-09T23:19:30.5928017Z [36;1m  curl --proto '=https' --tlsv1.2 --retry 10 --retry-connrefused --location --silent --show-error --fail https://sh.rustup.rs | sh -s -- --default-toolchain none -y[0m
2025-11-09T23:19:30.5930671Z [36;1m  echo "$CARGO_HOME/bin" >> $GITHUB_PATH[0m
2025-11-09T23:19:30.5931003Z [36;1mfi[0m
2025-11-09T23:19:30.5961680Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2025-11-09T23:19:30.5962051Z env:
2025-11-09T23:19:30.5962239Z   CARGO_TERM_COLOR: always
2025-11-09T23:19:30.5962595Z   CARGO_HOME: /home/jswift/.cargo
2025-11-09T23:19:30.5962872Z ##[endgroup]
2025-11-09T23:19:30.7082655Z info: downloading installer
2025-11-09T23:19:31.2689985Z warn: It looks like you have an existing rustup settings file at:
2025-11-09T23:19:31.2692489Z warn: /home/jswift/.rustup/settings.toml
2025-11-09T23:19:31.2693188Z warn: Rustup will install the default toolchain as specified in the settings file,
2025-11-09T23:19:31.2694003Z warn: instead of the one inferred from the default host triple.
2025-11-09T23:19:31.2960519Z info: profile set to 'default'
2025-11-09T23:19:31.2960977Z 
2025-11-09T23:19:31.2960991Z 
2025-11-09T23:19:31.2961181Z Rust is installed now. Great!
2025-11-09T23:19:31.2961427Z 
2025-11-09T23:19:31.2961700Z To get started you may need to restart your current shell.
2025-11-09T23:19:31.2962382Z This would reload your PATH environment variable to include
2025-11-09T23:19:31.2962958Z Cargo's bin directory ($HOME/.cargo/bin).
2025-11-09T23:19:31.2963196Z 
2025-11-09T23:19:31.2963349Z To configure your current shell, you need to source
2025-11-09T23:19:31.2963746Z the corresponding env file under $HOME/.cargo.
2025-11-09T23:19:31.2963990Z 
2025-11-09T23:19:31.2964211Z This is usually done by running one of the following (note the leading DOT):
2025-11-09T23:19:31.2964990Z . "$HOME/.cargo/env"            # For sh/bash/zsh/ash/dash/pdksh
2025-11-09T23:19:31.2965403Z source "$HOME/.cargo/env.fish"  # For fish
2025-11-09T23:19:31.2965785Z source $"($nu.home-path)/.cargo/env.nu"  # For nushell
2025-11-09T23:19:31.2966228Z info: default host triple is x86_64-unknown-linux-gnu
2025-11-09T23:19:31.2966736Z info: skipping toolchain installation
2025-11-09T23:19:31.3092407Z ##[group]Run rustup toolchain install 1.88.0 --component rustfmt --profile minimal --no-self-update
2025-11-09T23:19:31.3093067Z [36;1mrustup toolchain install 1.88.0 --component rustfmt --profile minimal --no-self-update[0m
2025-11-09T23:19:31.3122990Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2025-11-09T23:19:31.3123338Z env:
2025-11-09T23:19:31.3123528Z   CARGO_TERM_COLOR: always
2025-11-09T23:19:31.3123777Z   CARGO_HOME: /home/jswift/.cargo
2025-11-09T23:19:31.3124014Z ##[endgroup]
2025-11-09T23:19:31.4032743Z info: syncing channel updates for '1.88.0-x86_64-unknown-linux-gnu'
2025-11-09T23:19:31.5108170Z info: latest update on 2025-06-26, rust version 1.88.0 (6b00bc388 2025-06-23)
2025-11-09T23:19:31.5511244Z info: component 'rustfmt' for target 'x86_64-unknown-linux-gnu' is up to date
2025-11-09T23:19:31.5537965Z 
2025-11-09T23:19:31.5656791Z   1.88.0-x86_64-unknown-linux-gnu unchanged - rustc 1.88.0 (6b00bc388 2025-06-23)
2025-11-09T23:19:31.5659194Z 
2025-11-09T23:19:31.5731473Z ##[group]Run rustup default 1.88.0
2025-11-09T23:19:31.5731981Z [36;1mrustup default 1.88.0[0m
2025-11-09T23:19:31.5777733Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2025-11-09T23:19:31.5778296Z env:
2025-11-09T23:19:31.5778934Z   CARGO_TERM_COLOR: always
2025-11-09T23:19:31.5779355Z   CARGO_HOME: /home/jswift/.cargo
2025-11-09T23:19:31.5779767Z ##[endgroup]
2025-11-09T23:19:31.5921137Z info: using existing install for '1.88.0-x86_64-unknown-linux-gnu'
2025-11-09T23:19:31.6298029Z info: default toolchain set to '1.88.0-x86_64-unknown-linux-gnu'
2025-11-09T23:19:31.6298504Z 
2025-11-09T23:19:31.6417884Z   1.88.0-x86_64-unknown-linux-gnu unchanged - rustc 1.88.0 (6b00bc388 2025-06-23)
2025-11-09T23:19:31.6418480Z 
2025-11-09T23:19:31.6421119Z info: note that the toolchain '1.88.0-x86_64-unknown-linux-gnu' is currently in use (overridden by '/home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/rust-toolchain.toml')
2025-11-09T23:19:31.6476923Z ##[group]Run : create cachekey
2025-11-09T23:19:31.6477229Z [36;1m: create cachekey[0m
2025-11-09T23:19:31.6477923Z [36;1mDATE=$(rustc +1.88.0 --version --verbose | sed -ne 's/^commit-date: \(20[0-9][0-9]\)-\([01][0-9]\)-\([0-3][0-9]\)$/\1\2\3/p')[0m
2025-11-09T23:19:31.6478543Z [36;1mHASH=$(rustc +1.88.0 --version --verbose | sed -ne 's/^commit-hash: //p')[0m
2025-11-09T23:19:31.6479031Z [36;1mecho "cachekey=$(echo $DATE$HASH | head -c12)" >> $GITHUB_OUTPUT[0m
2025-11-09T23:19:31.6507535Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2025-11-09T23:19:31.6507867Z env:
2025-11-09T23:19:31.6508051Z   CARGO_TERM_COLOR: always
2025-11-09T23:19:31.6508280Z   CARGO_HOME: /home/jswift/.cargo
2025-11-09T23:19:31.6510759Z ##[endgroup]
2025-11-09T23:19:31.7008838Z ##[group]Run : disable incremental compilation
2025-11-09T23:19:31.7009239Z [36;1m: disable incremental compilation[0m
2025-11-09T23:19:31.7077258Z [36;1mif [ -z "${CARGO_INCREMENTAL+set}" ]; then[0m
2025-11-09T23:19:31.7077657Z [36;1m  echo CARGO_INCREMENTAL=0 >> $GITHUB_ENV[0m
2025-11-09T23:19:31.7078046Z [36;1mfi[0m
2025-11-09T23:19:31.7111698Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2025-11-09T23:19:31.7112118Z env:
2025-11-09T23:19:31.7112339Z   CARGO_TERM_COLOR: always
2025-11-09T23:19:31.7112636Z   CARGO_HOME: /home/jswift/.cargo
2025-11-09T23:19:31.7112933Z ##[endgroup]
2025-11-09T23:19:31.7185067Z ##[group]Run : enable colors in Cargo output
2025-11-09T23:19:31.7185407Z [36;1m: enable colors in Cargo output[0m
2025-11-09T23:19:31.7185726Z [36;1mif [ -z "${CARGO_TERM_COLOR+set}" ]; then[0m
2025-11-09T23:19:31.7186080Z [36;1m  echo CARGO_TERM_COLOR=always >> $GITHUB_ENV[0m
2025-11-09T23:19:31.7186377Z [36;1mfi[0m
2025-11-09T23:19:31.7216001Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2025-11-09T23:19:31.7218208Z env:
2025-11-09T23:19:31.7218407Z   CARGO_TERM_COLOR: always
2025-11-09T23:19:31.7218658Z   CARGO_HOME: /home/jswift/.cargo
2025-11-09T23:19:31.7218924Z   CARGO_INCREMENTAL: 0
2025-11-09T23:19:31.7219141Z ##[endgroup]
2025-11-09T23:19:31.7292220Z ##[group]Run : enable Cargo sparse registry
2025-11-09T23:19:31.7292535Z [36;1m: enable Cargo sparse registry[0m
2025-11-09T23:19:31.7292877Z [36;1m# implemented in 1.66, stabilized in 1.68, made default in 1.70[0m
2025-11-09T23:19:31.7293635Z [36;1mif [ -z "${CARGO_REGISTRIES_CRATES_IO_PROTOCOL+set}" -o -f "/home/jswift/actions-runner-org2/_work/_temp"/.implicit_cargo_registries_crates_io_protocol ]; then[0m
2025-11-09T23:19:31.7294620Z [36;1m  if rustc +1.88.0 --version --verbose | grep -q '^release: 1\.6[89]\.'; then[0m
2025-11-09T23:19:31.7295228Z [36;1m    touch "/home/jswift/actions-runner-org2/_work/_temp"/.implicit_cargo_registries_crates_io_protocol || true[0m
2025-11-09T23:19:31.7295799Z [36;1m    echo CARGO_REGISTRIES_CRATES_IO_PROTOCOL=sparse >> $GITHUB_ENV[0m
2025-11-09T23:19:31.7296251Z [36;1m  elif rustc +1.88.0 --version --verbose | grep -q '^release: 1\.6[67]\.'; then[0m
2025-11-09T23:19:31.7298629Z [36;1m    touch "/home/jswift/actions-runner-org2/_work/_temp"/.implicit_cargo_registries_crates_io_protocol || true[0m
2025-11-09T23:19:31.7299192Z [36;1m    echo CARGO_REGISTRIES_CRATES_IO_PROTOCOL=git >> $GITHUB_ENV[0m
2025-11-09T23:19:31.7299508Z [36;1m  fi[0m
2025-11-09T23:19:31.7299861Z [36;1mfi[0m
2025-11-09T23:19:31.7325246Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2025-11-09T23:19:31.7325565Z env:
2025-11-09T23:19:31.7325741Z   CARGO_TERM_COLOR: always
2025-11-09T23:19:31.7325972Z   CARGO_HOME: /home/jswift/.cargo
2025-11-09T23:19:31.7326199Z   CARGO_INCREMENTAL: 0
2025-11-09T23:19:31.7326398Z ##[endgroup]
2025-11-09T23:19:31.7808240Z ##[group]Run : work around spurious network errors in curl 8.0
2025-11-09T23:19:31.7808810Z [36;1m: work around spurious network errors in curl 8.0[0m
2025-11-09T23:19:31.7809479Z [36;1m# https://rust-lang.zulipchat.com/#narrow/stream/246057-t-cargo/topic/timeout.20investigation[0m
2025-11-09T23:19:31.7810215Z [36;1mif rustc +1.88.0 --version --verbose | grep -q '^release: 1\.7[01]\.'; then[0m
2025-11-09T23:19:31.7810962Z [36;1m  echo CARGO_HTTP_MULTIPLEXING=false >> $GITHUB_ENV[0m
2025-11-09T23:19:31.7811329Z [36;1mfi[0m
2025-11-09T23:19:31.7841135Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2025-11-09T23:19:31.7841510Z env:
2025-11-09T23:19:31.7841711Z   CARGO_TERM_COLOR: always
2025-11-09T23:19:31.7841959Z   CARGO_HOME: /home/jswift/.cargo
2025-11-09T23:19:31.7842214Z   CARGO_INCREMENTAL: 0
2025-11-09T23:19:31.7842432Z ##[endgroup]
2025-11-09T23:19:31.8118156Z ##[group]Run rustc +1.88.0 --version --verbose
2025-11-09T23:19:31.8118510Z [36;1mrustc +1.88.0 --version --verbose[0m
2025-11-09T23:19:31.8151242Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2025-11-09T23:19:31.8151586Z env:
2025-11-09T23:19:31.8151779Z   CARGO_TERM_COLOR: always
2025-11-09T23:19:31.8152017Z   CARGO_HOME: /home/jswift/.cargo
2025-11-09T23:19:31.8152281Z   CARGO_INCREMENTAL: 0
2025-11-09T23:19:31.8152498Z ##[endgroup]
2025-11-09T23:19:31.8383363Z rustc 1.88.0 (6b00bc388 2025-06-23)
2025-11-09T23:19:31.8384801Z binary: rustc
2025-11-09T23:19:31.8385577Z commit-hash: 6b00bc3880198600130e1cf62b8f8a93494488cc
2025-11-09T23:19:31.8386504Z commit-date: 2025-06-23
2025-11-09T23:19:31.8386925Z host: x86_64-unknown-linux-gnu
2025-11-09T23:19:31.8387433Z release: 1.88.0
2025-11-09T23:19:31.8387866Z LLVM version: 20.1.5
2025-11-09T23:19:31.8472768Z ##[group]Run cargo fmt -- --check
2025-11-09T23:19:31.8473076Z [36;1mcargo fmt -- --check[0m
2025-11-09T23:19:31.8505047Z shell: /usr/bin/bash -e {0}
2025-11-09T23:19:31.8505306Z env:
2025-11-09T23:19:31.8505500Z   CARGO_TERM_COLOR: always
2025-11-09T23:19:31.8505739Z   CARGO_HOME: /home/jswift/.cargo
2025-11-09T23:19:31.8505986Z   CARGO_INCREMENTAL: 0
2025-11-09T23:19:31.8506191Z ##[endgroup]
2025-11-09T23:19:32.1196728Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:332:
2025-11-09T23:19:32.1197918Z  pub enum PruningMode {
2025-11-09T23:19:32.1198324Z      /// No pruning (keep all blocks)
2025-11-09T23:19:32.1198717Z      Disabled,
2025-11-09T23:19:32.1198994Z -    
2025-11-09T23:19:32.1199246Z +
2025-11-09T23:19:32.1199608Z      /// Normal pruning (keep recent blocks for verification)
2025-11-09T23:19:32.1200075Z      Normal {
2025-11-09T23:19:32.1200422Z          /// Keep blocks from this height onwards
2025-11-09T23:19:32.1203315Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:342:
2025-11-09T23:19:32.1204073Z          #[serde(default = "default_min_recent_blocks")]
2025-11-09T23:19:32.1204837Z          min_recent_blocks: u64,
2025-11-09T23:19:32.1205193Z      },
2025-11-09T23:19:32.1205438Z -    
2025-11-09T23:19:32.1205687Z +
2025-11-09T23:19:32.1205986Z      /// Aggressive pruning with UTXO commitments
2025-11-09T23:19:32.1206579Z      /// Requires: utxo-commitments feature enabled
2025-11-09T23:19:32.1207413Z      Aggressive {
2025-11-09T23:19:32.1208367Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:359:
2025-11-09T23:19:32.1209100Z          #[serde(default = "default_min_blocks")]
2025-11-09T23:19:32.1209516Z          min_blocks: u64,
2025-11-09T23:19:32.1209834Z      },
2025-11-09T23:19:32.1210086Z -    
2025-11-09T23:19:32.1210330Z +
2025-11-09T23:19:32.1210921Z      /// Custom pruning configuration
2025-11-09T23:19:32.1211295Z      Custom {
2025-11-09T23:19:32.1211733Z          /// Keep block headers (always required for PoW verification)
2025-11-09T23:19:32.1212526Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:408:
2025-11-09T23:19:32.1213206Z      /// Pruning mode
2025-11-09T23:19:32.1213553Z      #[serde(default = "default_pruning_mode")]
2025-11-09T23:19:32.1213985Z      pub mode: PruningMode,
2025-11-09T23:19:32.1214506Z -    
2025-11-09T23:19:32.1214763Z +
2025-11-09T23:19:32.1227921Z      /// Automatic pruning (prune periodically as chain grows)
2025-11-09T23:19:32.1228486Z      #[serde(default = "default_false")]
2025-11-09T23:19:32.1228928Z      pub auto_prune: bool,
2025-11-09T23:19:32.1229488Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:415:
2025-11-09T23:19:32.1229945Z -    
2025-11-09T23:19:32.1230115Z +
2025-11-09T23:19:32.1230316Z      /// Automatic pruning interval (blocks)
2025-11-09T23:19:32.1230647Z      /// Prune every N blocks if auto_prune is enabled
2025-11-09T23:19:32.1230982Z      #[serde(default = "default_auto_prune_interval")]
2025-11-09T23:19:32.1231743Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:419:
2025-11-09T23:19:32.1232229Z      pub auto_prune_interval: u64,
2025-11-09T23:19:32.1232473Z -    
2025-11-09T23:19:32.1232636Z +
2025-11-09T23:19:32.1232835Z      /// Minimum blocks to keep (safety margin)
2025-11-09T23:19:32.1233187Z      /// Even with aggressive pruning, keep at least this many blocks
2025-11-09T23:19:32.1233559Z      #[serde(default = "default_min_blocks_to_keep")]
2025-11-09T23:19:32.1234021Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:424:
2025-11-09T23:19:32.1234737Z      pub min_blocks_to_keep: u64,
2025-11-09T23:19:32.1234973Z -    
2025-11-09T23:19:32.1235154Z +
2025-11-09T23:19:32.1235381Z      /// Prune on startup (prune old blocks when node starts)
2025-11-09T23:19:32.1235697Z      #[serde(default = "default_false")]
2025-11-09T23:19:32.1236235Z      pub prune_on_startup: bool,
2025-11-09T23:19:32.1236660Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:429:
2025-11-09T23:19:32.1237083Z -    
2025-11-09T23:19:32.1237241Z +
2025-11-09T23:19:32.1237561Z      /// Allow incremental pruning during IBD (requires UTXO commitments + aggressive mode)
2025-11-09T23:19:32.1238094Z      /// When enabled, old blocks are pruned incrementally during sync, keeping only a window
2025-11-09T23:19:32.1240038Z      /// of recent blocks. This prevents the need to download the full blockchain before pruning.
2025-11-09T23:19:32.1240610Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:433:
2025-11-09T23:19:32.1241030Z      #[serde(default = "default_false")]
2025-11-09T23:19:32.1241310Z      pub incremental_prune_during_ibd: bool,
2025-11-09T23:19:32.1241555Z -    
2025-11-09T23:19:32.1241722Z +
2025-11-09T23:19:32.1242006Z      /// Block window size for incremental pruning (number of recent blocks to keep)
2025-11-09T23:19:32.1242548Z      /// Only used when incremental_prune_during_ibd is true
2025-11-09T23:19:32.1242971Z      #[serde(default = "default_prune_window_size")]
2025-11-09T23:19:32.1243407Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:439:
2025-11-09T23:19:32.1243837Z      pub prune_window_size: u64,
2025-11-09T23:19:32.1244057Z -    
2025-11-09T23:19:32.1244221Z +
2025-11-09T23:19:32.1244689Z      /// Minimum blocks before starting incremental pruning during IBD
2025-11-09T23:19:32.1245068Z      /// Prevents pruning too early in the sync process
2025-11-09T23:19:32.1245425Z      #[serde(default = "default_min_blocks_for_incremental_prune")]
2025-11-09T23:19:32.1246067Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:444:
2025-11-09T23:19:32.1246511Z      pub min_blocks_for_incremental_prune: u64,
2025-11-09T23:19:32.1246946Z -    
2025-11-09T23:19:32.1247107Z +
2025-11-09T23:19:32.1247285Z      /// UTXO commitments integration
2025-11-09T23:19:32.1247549Z      #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.1247882Z      pub utxo_commitments: Option<UtxoCommitmentsPruningConfig>,
2025-11-09T23:19:32.1248379Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:449:
2025-11-09T23:19:32.1248777Z -    
2025-11-09T23:19:32.1248936Z +
2025-11-09T23:19:32.1249107Z      /// BIP158 filter integration
2025-11-09T23:19:32.1249354Z      #[cfg(feature = "bip158")]
2025-11-09T23:19:32.1249624Z      pub bip158_filters: Option<Bip158PruningConfig>,
2025-11-09T23:19:32.1250066Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:486:
2025-11-09T23:19:32.1250495Z                  keep_filtered_blocks: false,
2025-11-09T23:19:32.1250766Z                  min_blocks: 144, // ~1 day at 10 min/block
2025-11-09T23:19:32.1251021Z              },
2025-11-09T23:19:32.1251249Z -            auto_prune: true, // Enable automatic pruning
2025-11-09T23:19:32.1251590Z +            auto_prune: true,         // Enable automatic pruning
2025-11-09T23:19:32.1251921Z              auto_prune_interval: 144, // Prune every ~1 day
2025-11-09T23:19:32.1252204Z              min_blocks_to_keep: 144,
2025-11-09T23:19:32.1252498Z -            prune_on_startup: false, // Still false for safety
2025-11-09T23:19:32.1252909Z -            incremental_prune_during_ibd: true, // Enable incremental pruning during IBD
2025-11-09T23:19:32.1253380Z -            prune_window_size: 144, // Keep sliding window of 144 blocks during IBD
2025-11-09T23:19:32.1253791Z +            prune_on_startup: false,               // Still false for safety
2025-11-09T23:19:32.1254233Z +            incremental_prune_during_ibd: true,    // Enable incremental pruning during IBD
2025-11-09T23:19:32.1254933Z +            prune_window_size: 144,                // Keep sliding window of 144 blocks during IBD
2025-11-09T23:19:32.1255567Z              min_blocks_for_incremental_prune: 288, // Start pruning after 288 blocks (~2 days)
2025-11-09T23:19:32.1255975Z              #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.1256282Z              utxo_commitments: None,
2025-11-09T23:19:32.1256700Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:508:
2025-11-09T23:19:32.1257133Z      /// Keep UTXO commitments for pruned blocks
2025-11-09T23:19:32.1257409Z      #[serde(default = "default_true")]
2025-11-09T23:19:32.1257672Z      pub keep_commitments: bool,
2025-11-09T23:19:32.1257887Z -    
2025-11-09T23:19:32.1258048Z +
2025-11-09T23:19:32.1258270Z      /// Keep filtered blocks (spam-filtered) for pruned range
2025-11-09T23:19:32.1258579Z      #[serde(default = "default_false")]
2025-11-09T23:19:32.1258833Z      pub keep_filtered_blocks: bool,
2025-11-09T23:19:32.1259236Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:515:
2025-11-09T23:19:32.1259632Z -    
2025-11-09T23:19:32.1259787Z +
2025-11-09T23:19:32.1260035Z      /// Generate commitments before pruning (if not already generated)
2025-11-09T23:19:32.1260383Z      #[serde(default = "default_true")]
2025-11-09T23:19:32.1260636Z      pub generate_before_prune: bool,
2025-11-09T23:19:32.1261033Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:519:
2025-11-09T23:19:32.1261428Z -    
2025-11-09T23:19:32.1261582Z +
2025-11-09T23:19:32.1261799Z      /// Maximum age for commitments (days, 0 = keep forever)
2025-11-09T23:19:32.1262127Z      #[serde(default = "default_commitment_max_age")]
2025-11-09T23:19:32.1262417Z      pub max_commitment_age_days: u32,
2025-11-09T23:19:32.1262819Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:546:
2025-11-09T23:19:32.1263340Z      /// Keep BIP158 filters for pruned blocks
2025-11-09T23:19:32.1263608Z      #[serde(default = "default_true")]
2025-11-09T23:19:32.1263861Z      pub keep_filters: bool,
2025-11-09T23:19:32.1264204Z -    
2025-11-09T23:19:32.1264579Z +
2025-11-09T23:19:32.1264825Z      /// Keep filter header chain (always required for verification)
2025-11-09T23:19:32.1265153Z      #[serde(default = "default_true")]
2025-11-09T23:19:32.1265396Z      pub keep_filter_headers: bool,
2025-11-09T23:19:32.1265829Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:553:
2025-11-09T23:19:32.1266227Z -    
2025-11-09T23:19:32.1268223Z +
2025-11-09T23:19:32.1268436Z      /// Maximum age for filters (days, 0 = keep forever)
2025-11-09T23:19:32.1268736Z      #[serde(default = "default_filter_max_age")]
2025-11-09T23:19:32.1269014Z      pub max_filter_age_days: u32,
2025-11-09T23:19:32.1269410Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:578:
2025-11-09T23:19:32.1269828Z      /// Database backend selection
2025-11-09T23:19:32.1270093Z      #[serde(default = "default_database_backend")]
2025-11-09T23:19:32.1270407Z      pub database_backend: DatabaseBackendConfig,
2025-11-09T23:19:32.1270670Z -    
2025-11-09T23:19:32.1270824Z +
2025-11-09T23:19:32.1270991Z      /// Storage path
2025-11-09T23:19:32.1271213Z      #[serde(default = "default_storage_path")]
2025-11-09T23:19:32.1271484Z      pub data_dir: String,
2025-11-09T23:19:32.1271859Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:585:
2025-11-09T23:19:32.1272257Z -    
2025-11-09T23:19:32.1272406Z +
2025-11-09T23:19:32.1272657Z      /// Pruning configuration
2025-11-09T23:19:32.1273062Z      pub pruning: Option<PruningConfig>,
2025-11-09T23:19:32.1273316Z -    
2025-11-09T23:19:32.1273469Z +
2025-11-09T23:19:32.1273631Z      /// Cache sizes
2025-11-09T23:19:32.1273857Z      pub cache: Option<StorageCacheConfig>,
2025-11-09T23:19:32.1274106Z  }
2025-11-09T23:19:32.1274664Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:616:
2025-11-09T23:19:32.1275096Z      /// Block cache size (MB)
2025-11-09T23:19:32.1275360Z      #[serde(default = "default_block_cache_mb")]
2025-11-09T23:19:32.1275784Z      pub block_cache_mb: usize,
2025-11-09T23:19:32.1276016Z -    
2025-11-09T23:19:32.1276166Z +
2025-11-09T23:19:32.1276335Z      /// UTXO cache size (MB)
2025-11-09T23:19:32.1276578Z      #[serde(default = "default_utxo_cache_mb")]
2025-11-09T23:19:32.1276869Z      pub utxo_cache_mb: usize,
2025-11-09T23:19:32.1277478Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:623:
2025-11-09T23:19:32.1277951Z -    
2025-11-09T23:19:32.1278116Z +
2025-11-09T23:19:32.1278283Z      /// Header cache size (MB)
2025-11-09T23:19:32.1280352Z      #[serde(default = "default_header_cache_mb")]
2025-11-09T23:19:32.1280630Z      pub header_cache_mb: usize,
2025-11-09T23:19:32.1281030Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:668:
2025-11-09T23:19:32.1281455Z                  pruning.validate()?;
2025-11-09T23:19:32.1281694Z              }
2025-11-09T23:19:32.1281878Z          }
2025-11-09T23:19:32.1282039Z -        
2025-11-09T23:19:32.1282207Z +
2025-11-09T23:19:32.1282358Z          Ok(())
2025-11-09T23:19:32.1282527Z      }
2025-11-09T23:19:32.1282683Z  }
2025-11-09T23:19:32.1283010Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:686:
2025-11-09T23:19:32.1283416Z                  ));
2025-11-09T23:19:32.1283602Z              }
2025-11-09T23:19:32.1283765Z          }
2025-11-09T23:19:32.1283926Z -        
2025-11-09T23:19:32.1284080Z +
2025-11-09T23:19:32.1284468Z          // Validate min_blocks_to_keep is reasonable
2025-11-09T23:19:32.1284871Z          if self.min_blocks_to_keep == 0 {
2025-11-09T23:19:32.1291377Z              return Err(anyhow::anyhow!(
2025-11-09T23:19:32.1291856Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:693:
2025-11-09T23:19:32.1292363Z                  "min_blocks_to_keep must be greater than 0 for safety"
2025-11-09T23:19:32.1292864Z              ));
2025-11-09T23:19:32.1293044Z          }
2025-11-09T23:19:32.1293215Z -        
2025-11-09T23:19:32.1293379Z +
2025-11-09T23:19:32.1293563Z          // Validate auto_prune_interval
2025-11-09T23:19:32.1293872Z          if self.auto_prune && self.auto_prune_interval == 0 {
2025-11-09T23:19:32.1294196Z              return Err(anyhow::anyhow!(
2025-11-09T23:19:32.1294874Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:700:
2025-11-09T23:19:32.1295400Z                  "auto_prune_interval must be greater than 0 when auto_prune is enabled"
2025-11-09T23:19:32.1295734Z              ));
2025-11-09T23:19:32.1295913Z          }
2025-11-09T23:19:32.1296080Z -        
2025-11-09T23:19:32.1296358Z +
2025-11-09T23:19:32.1296671Z          // Validate mode-specific settings
2025-11-09T23:19:32.1297099Z          match &self.mode {
2025-11-09T23:19:32.1297461Z -            PruningMode::Normal { min_recent_blocks, .. } => {
2025-11-09T23:19:32.1297769Z +            PruningMode::Normal {
2025-11-09T23:19:32.1298022Z +                min_recent_blocks, ..
2025-11-09T23:19:32.1298260Z +            } => {
2025-11-09T23:19:32.1298464Z                  if *min_recent_blocks == 0 {
2025-11-09T23:19:32.1298738Z                      return Err(anyhow::anyhow!(
2025-11-09T23:19:32.1299083Z                          "min_recent_blocks must be greater than 0 in Normal pruning mode"
2025-11-09T23:19:32.1299588Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:728:
2025-11-09T23:19:32.1300004Z                  // No validation needed
2025-11-09T23:19:32.1300238Z              }
2025-11-09T23:19:32.1300399Z          }
2025-11-09T23:19:32.1300562Z -        
2025-11-09T23:19:32.1300716Z +
2025-11-09T23:19:32.1300870Z          Ok(())
2025-11-09T23:19:32.1301250Z      }
2025-11-09T23:19:32.1301409Z  }
2025-11-09T23:19:32.1301712Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/lib.rs:25:
2025-11-09T23:19:32.1302101Z  #[global_allocator]
2025-11-09T23:19:32.1302444Z  static GLOBAL: mimalloc::MiMalloc = mimalloc::MiMalloc;
2025-11-09T23:19:32.1302884Z  
2025-11-09T23:19:32.1303051Z -pub mod storage;
2025-11-09T23:19:32.1303254Z +pub mod bip21;
2025-11-09T23:19:32.1303433Z +pub mod config;
2025-11-09T23:19:32.1303616Z +pub mod module;
2025-11-09T23:19:32.1303790Z  pub mod network;
2025-11-09T23:19:32.1303969Z -pub mod rpc;
2025-11-09T23:19:32.1304139Z  pub mod node;
2025-11-09T23:19:32.1304508Z -pub mod config;
2025-11-09T23:19:32.1304747Z +pub mod rpc;
2025-11-09T23:19:32.1304920Z +pub mod storage;
2025-11-09T23:19:32.1305124Z  #[cfg(feature = "production")]
2025-11-09T23:19:32.1305349Z  pub mod validation;
2025-11-09T23:19:32.1305544Z -pub mod module;
2025-11-09T23:19:32.1305717Z -pub mod bip21;
2025-11-09T23:19:32.1305891Z  
2025-11-09T23:19:32.1306056Z  // Re-export config module
2025-11-09T23:19:32.1306286Z  pub use config::*;
2025-11-09T23:19:32.1306624Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/lib.rs:40:
2025-11-09T23:19:32.1307021Z  
2025-11-09T23:19:32.1307241Z  // Re-export commonly used types from protocol-engine
2025-11-09T23:19:32.1307714Z  // This allows depending only on protocol-engine (which transitively provides consensus-proof)
2025-11-09T23:19:32.1308168Z +pub use bllvm_protocol::mempool::Mempool;
2025-11-09T23:19:32.1310339Z  pub use bllvm_protocol::{
2025-11-09T23:19:32.1310684Z -    Block, BlockHeader, Transaction, TransactionInput, TransactionOutput,
2025-11-09T23:19:32.1311172Z -    OutPoint, UTXO, UtxoSet, ValidationResult, Hash, ByteString, Natural, Integer,
2025-11-09T23:19:32.1311565Z -    ConsensusError, Result,
2025-11-09T23:19:32.1311956Z +    Block, BlockHeader, ByteString, ConsensusError, Hash, Integer, Natural, OutPoint, Result,
2025-11-09T23:19:32.1312524Z +    Transaction, TransactionInput, TransactionOutput, UtxoSet, ValidationResult, UTXO,
2025-11-09T23:19:32.1312914Z  };
2025-11-09T23:19:32.1313108Z -pub use bllvm_protocol::mempool::Mempool;
2025-11-09T23:19:32.1313524Z  
2025-11-09T23:19:32.1313698Z  // Re-export protocol-engine types
2025-11-09T23:19:32.1314145Z  pub use bllvm_protocol::{BitcoinProtocolEngine, ProtocolVersion};
2025-11-09T23:19:32.1315140Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/lib.rs:81:
2025-11-09T23:19:32.1315616Z          // Test that protocol-engine works in reference-node context
2025-11-09T23:19:32.1316052Z          let node = ReferenceNode::new(Some(ProtocolVersion::Regtest)).unwrap();
2025-11-09T23:19:32.1316412Z          let protocol = node.protocol();
2025-11-09T23:19:32.1316653Z -        
2025-11-09T23:19:32.1318626Z +
2025-11-09T23:19:32.1318806Z          // Verify protocol version
2025-11-09T23:19:32.1319177Z          assert_eq!(protocol.get_protocol_version(), ProtocolVersion::Regtest);
2025-11-09T23:19:32.1319519Z -        
2025-11-09T23:19:32.1319672Z +
2025-11-09T23:19:32.1319844Z          // Test feature support
2025-11-09T23:19:32.1320123Z          assert!(protocol.supports_feature("fast_mining"));
2025-11-09T23:19:32.1320418Z      }
2025-11-09T23:19:32.1320744Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/lib.rs:94:
2025-11-09T23:19:32.1321182Z          // Test consensus validation through protocol-engine
2025-11-09T23:19:32.1321569Z          let node = ReferenceNode::new(None).unwrap(); // Uses default Regtest
2025-11-09T23:19:32.1321913Z          let protocol = node.protocol();
2025-11-09T23:19:32.1322154Z -        
2025-11-09T23:19:32.1322310Z +
2025-11-09T23:19:32.1322487Z          // Create a simple transaction
2025-11-09T23:19:32.1322733Z          let tx = Transaction {
2025-11-09T23:19:32.1322957Z              version: 1,
2025-11-09T23:19:32.1323309Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/lib.rs:105:
2025-11-09T23:19:32.1323686Z              }],
2025-11-09T23:19:32.1323874Z              lock_time: 0,
2025-11-09T23:19:32.1324069Z          };
2025-11-09T23:19:32.1324231Z -        
2025-11-09T23:19:32.1324586Z +
2025-11-09T23:19:32.1324773Z          // Test transaction validation
2025-11-09T23:19:32.1325210Z          let result = protocol.validate_transaction(&tx);
2025-11-09T23:19:32.1325511Z          assert!(result.is_ok());
2025-11-09T23:19:32.1325881Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/lib.rs:115:
2025-11-09T23:19:32.1326290Z      fn test_reference_node_creation() {
2025-11-09T23:19:32.1326557Z          // Test default (Regtest) creation
2025-11-09T23:19:32.1326847Z          let node = ReferenceNode::new(None).unwrap();
2025-11-09T23:19:32.1327254Z -        assert_eq!(node.protocol().get_protocol_version(), ProtocolVersion::Regtest);
2025-11-09T23:19:32.1327615Z -        
2025-11-09T23:19:32.1327789Z +        assert_eq!(
2025-11-09T23:19:32.1328006Z +            node.protocol().get_protocol_version(),
2025-11-09T23:19:32.1328294Z +            ProtocolVersion::Regtest
2025-11-09T23:19:32.1328526Z +        );
2025-11-09T23:19:32.1328795Z +
2025-11-09T23:19:32.1329036Z          // Test mainnet creation
2025-11-09T23:19:32.1329417Z          let mainnet_node = ReferenceNode::new(Some(ProtocolVersion::BitcoinV1)).unwrap();
2025-11-09T23:19:32.1329962Z -        assert_eq!(mainnet_node.protocol().get_protocol_version(), ProtocolVersion::BitcoinV1);
2025-11-09T23:19:32.1330354Z +        assert_eq!(
2025-11-09T23:19:32.1332482Z +            mainnet_node.protocol().get_protocol_version(),
2025-11-09T23:19:32.1332778Z +            ProtocolVersion::BitcoinV1
2025-11-09T23:19:32.1333021Z +        );
2025-11-09T23:19:32.1333181Z      }
2025-11-09T23:19:32.1333340Z  }
2025-11-09T23:19:32.1333497Z +
2025-11-09T23:19:32.1333843Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/api/hub.rs:81:
2025-11-09T23:19:32.1334517Z              .validate_request(module_id, &request.payload)?;
2025-11-09T23:19:32.1334811Z  
2025-11-09T23:19:32.1335082Z          // Handle handshake specially (no validation needed, just acknowledge)
2025-11-09T23:19:32.1335634Z -        if let RequestPayload::Handshake { module_id: handshake_id, module_name, version } = &request.payload {
2025-11-09T23:19:32.1336274Z +        if let RequestPayload::Handshake {
2025-11-09T23:19:32.1336544Z +            module_id: handshake_id,
2025-11-09T23:19:32.1336787Z +            module_name,
2025-11-09T23:19:32.1336989Z +            version,
2025-11-09T23:19:32.1337185Z +        } = &request.payload
2025-11-09T23:19:32.1337395Z +        {
2025-11-09T23:19:32.1337571Z              // Verify module_id matches
2025-11-09T23:19:32.1337830Z              if handshake_id != module_id {
2025-11-09T23:19:32.1338112Z -                return Err(ModuleError::OperationError(
2025-11-09T23:19:32.1338542Z -                    format!("Handshake module_id mismatch: expected {}, got {}", module_id, handshake_id)
2025-11-09T23:19:32.1338926Z -                ));
2025-11-09T23:19:32.1339175Z +                return Err(ModuleError::OperationError(format!(
2025-11-09T23:19:32.1339522Z +                    "Handshake module_id mismatch: expected {}, got {}",
2025-11-09T23:19:32.1339834Z +                    module_id, handshake_id
2025-11-09T23:19:32.1341943Z +                )));
2025-11-09T23:19:32.1342123Z              }
2025-11-09T23:19:32.1342295Z -            
2025-11-09T23:19:32.1342610Z -            info!("Handshake from module {} (name={}, version={})", module_id, module_name, version);
2025-11-09T23:19:32.1342980Z +
2025-11-09T23:19:32.1343130Z +            info!(
2025-11-09T23:19:32.1343368Z +                "Handshake from module {} (name={}, version={})",
2025-11-09T23:19:32.1343672Z +                module_id, module_name, version
2025-11-09T23:19:32.1343917Z +            );
2025-11-09T23:19:32.1344125Z              return Ok(ResponseMessage::success(
2025-11-09T23:19:32.1344633Z                  request.correlation_id,
2025-11-09T23:19:32.1344920Z                  ResponsePayload::HandshakeAck {
2025-11-09T23:19:32.1345586Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/api/hub.rs:96:
2025-11-09T23:19:32.1346438Z                      node_version: env!("CARGO_PKG_VERSION").to_string(),
2025-11-09T23:19:32.1347185Z -                }
2025-11-09T23:19:32.1347475Z +                },
2025-11-09T23:19:32.1347669Z              ));
2025-11-09T23:19:32.1347840Z          }
2025-11-09T23:19:32.1348005Z  
2025-11-09T23:19:32.1348367Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/api/hub.rs:108:
2025-11-09T23:19:32.1348848Z              RequestPayload::Handshake { .. } => {
2025-11-09T23:19:32.1351005Z                  // Handshake is handled at connection level, not here
2025-11-09T23:19:32.1351378Z                  return Err(crate::module::traits::ModuleError::IpcError(
2025-11-09T23:19:32.1351775Z -                    "Handshake should be handled at connection level".to_string()
2025-11-09T23:19:32.1352191Z +                    "Handshake should be handled at connection level".to_string(),
2025-11-09T23:19:32.1352512Z                  ));
2025-11-09T23:19:32.1352694Z              }
2025-11-09T23:19:32.1352916Z              RequestPayload::GetBlock { hash } => {
2025-11-09T23:19:32.1353381Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/ipc/protocol.rs:76:
2025-11-09T23:19:32.1353873Z  #[derive(Debug, Clone, Serialize, Deserialize)]
2025-11-09T23:19:32.1354155Z  pub enum RequestPayload {
2025-11-09T23:19:32.1354589Z      /// Handshake: Module identifies itself (first message)
2025-11-09T23:19:32.1354987Z -    Handshake { module_id: String, module_name: String, version: String },
2025-11-09T23:19:32.1355337Z -    GetBlock { hash: Hash },
2025-11-09T23:19:32.1355578Z -    GetBlockHeader { hash: Hash },
2025-11-09T23:19:32.1355822Z -    GetTransaction { hash: Hash },
2025-11-09T23:19:32.1356062Z -    HasTransaction { hash: Hash },
2025-11-09T23:19:32.1356285Z +    Handshake {
2025-11-09T23:19:32.1356476Z +        module_id: String,
2025-11-09T23:19:32.1356688Z +        module_name: String,
2025-11-09T23:19:32.1356910Z +        version: String,
2025-11-09T23:19:32.1357285Z +    },
2025-11-09T23:19:32.1357443Z +    GetBlock {
2025-11-09T23:19:32.1357631Z +        hash: Hash,
2025-11-09T23:19:32.1357812Z +    },
2025-11-09T23:19:32.1357980Z +    GetBlockHeader {
2025-11-09T23:19:32.1358168Z +        hash: Hash,
2025-11-09T23:19:32.1358352Z +    },
2025-11-09T23:19:32.1358515Z +    GetTransaction {
2025-11-09T23:19:32.1360633Z +        hash: Hash,
2025-11-09T23:19:32.1360810Z +    },
2025-11-09T23:19:32.1360969Z +    HasTransaction {
2025-11-09T23:19:32.1361156Z +        hash: Hash,
2025-11-09T23:19:32.1361329Z +    },
2025-11-09T23:19:32.1361490Z      GetChainTip,
2025-11-09T23:19:32.1361673Z      GetBlockHeight,
2025-11-09T23:19:32.1361881Z -    GetUtxo { outpoint: OutPoint },
2025-11-09T23:19:32.1362161Z -    SubscribeEvents { event_types: Vec<EventType> },
2025-11-09T23:19:32.1362439Z +    GetUtxo {
2025-11-09T23:19:32.1362624Z +        outpoint: OutPoint,
2025-11-09T23:19:32.1362832Z +    },
2025-11-09T23:19:32.1362998Z +    SubscribeEvents {
2025-11-09T23:19:32.1363207Z +        event_types: Vec<EventType>,
2025-11-09T23:19:32.1363438Z +    },
2025-11-09T23:19:32.1363589Z  }
2025-11-09T23:19:32.1363743Z  
2025-11-09T23:19:32.1363918Z  /// Response message from node to module
2025-11-09T23:19:32.1364680Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/ipc/protocol.rs:100:
2025-11-09T23:19:32.1365182Z  #[derive(Debug, Clone, Serialize, Deserialize)]
2025-11-09T23:19:32.1365471Z  pub enum ResponsePayload {
2025-11-09T23:19:32.1365725Z      /// Handshake acknowledgment with node version
2025-11-09T23:19:32.1366019Z -    HandshakeAck { node_version: String },
2025-11-09T23:19:32.1368160Z +    HandshakeAck {
2025-11-09T23:19:32.1368352Z +        node_version: String,
2025-11-09T23:19:32.1368566Z +    },
2025-11-09T23:19:32.1368734Z      Block(Option<Block>),
2025-11-09T23:19:32.1368967Z      BlockHeader(Option<BlockHeader>),
2025-11-09T23:19:32.1369222Z      Transaction(Option<Transaction>),
2025-11-09T23:19:32.1369709Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/ipc/server.rs:124:
2025-11-09T23:19:32.1370304Z              Some(Ok(bytes)) => {
2025-11-09T23:19:32.1370648Z                  let message: ModuleMessage = bincode::deserialize(bytes.as_ref())
2025-11-09T23:19:32.1371072Z                      .map_err(|e| ModuleError::SerializationError(e.to_string()))?;
2025-11-09T23:19:32.1371383Z -                
2025-11-09T23:19:32.1371566Z +
2025-11-09T23:19:32.1371730Z                  match message {
2025-11-09T23:19:32.1371988Z                      ModuleMessage::Request(request) => {
2025-11-09T23:19:32.1372433Z -                        if let RequestPayload::Handshake { module_id, module_name, version } = request.payload {
2025-11-09T23:19:32.1372869Z +                        if let RequestPayload::Handshake {
2025-11-09T23:19:32.1373154Z +                            module_id,
2025-11-09T23:19:32.1373404Z +                            module_name,
2025-11-09T23:19:32.1373648Z +                            version,
2025-11-09T23:19:32.1373902Z +                        } = request.payload
2025-11-09T23:19:32.1374144Z +                        {
2025-11-09T23:19:32.1382438Z                              info!(
2025-11-09T23:19:32.1382946Z                                  "Module handshake: id={}, name={}, version={}",
2025-11-09T23:19:32.1383284Z                                  module_id, module_name, version
2025-11-09T23:19:32.1383762Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/ipc/server.rs:134:
2025-11-09T23:19:32.1384206Z                              );
2025-11-09T23:19:32.1384595Z -                            
2025-11-09T23:19:32.1384810Z +
2025-11-09T23:19:32.1384996Z                              // Send handshake acknowledgment
2025-11-09T23:19:32.1385290Z                              let ack = ResponseMessage {
2025-11-09T23:19:32.1385596Z                                  correlation_id: request.correlation_id,
2025-11-09T23:19:32.1386066Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/ipc/server.rs:142:
2025-11-09T23:19:32.1386717Z                                  }),
2025-11-09T23:19:32.1386960Z                                  error: None,
2025-11-09T23:19:32.1387206Z                              };
2025-11-09T23:19:32.1387413Z -                            
2025-11-09T23:19:32.1387615Z +
2025-11-09T23:19:32.1387888Z                              let ack_bytes = bincode::serialize(&ModuleMessage::Response(ack))
2025-11-09T23:19:32.1388313Z                                  .map_err(|e| ModuleError::SerializationError(e.to_string()))?;
2025-11-09T23:19:32.1388693Z -                            writer.send(bytes::Bytes::from(ack_bytes)).await
2025-11-09T23:19:32.1389128Z -                                .map_err(|e| ModuleError::IpcError(format!("Failed to send handshake ack: {}", e)))?;
2025-11-09T23:19:32.1389733Z -                            
2025-11-09T23:19:32.1390106Z +                            writer
2025-11-09T23:19:32.1390565Z +                                .send(bytes::Bytes::from(ack_bytes))
2025-11-09T23:19:32.1390867Z +                                .await
2025-11-09T23:19:32.1391111Z +                                .map_err(|e| {
2025-11-09T23:19:32.1391392Z +                                    ModuleError::IpcError(format!(
2025-11-09T23:19:32.1391680Z +                                        "Failed to send handshake ack: {}",
2025-11-09T23:19:32.1391952Z +                                        e
2025-11-09T23:19:32.1392191Z +                                    ))
2025-11-09T23:19:32.1392428Z +                                })?;
2025-11-09T23:19:32.1392639Z +
2025-11-09T23:19:32.1392805Z                              module_id
2025-11-09T23:19:32.1393025Z                          } else {
2025-11-09T23:19:32.1393324Z                              // No handshake - use fallback ID (backward compatibility)
2025-11-09T23:19:32.1393840Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/ipc/server.rs:162:
2025-11-09T23:19:32.1394406Z                      }
2025-11-09T23:19:32.1394766Z                      _ => {
2025-11-09T23:19:32.1395011Z                          return Err(ModuleError::IpcError(
2025-11-09T23:19:32.1395346Z -                            "First message must be a handshake request".to_string()
2025-11-09T23:19:32.1395716Z +                            "First message must be a handshake request".to_string(),
2025-11-09T23:19:32.1396022Z                          ));
2025-11-09T23:19:32.1396226Z                      }
2025-11-09T23:19:32.1396405Z                  }
2025-11-09T23:19:32.1396781Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/ipc/server.rs:169:
2025-11-09T23:19:32.1397197Z              }
2025-11-09T23:19:32.1397380Z              Some(Err(e)) => {
2025-11-09T23:19:32.1397732Z -                return Err(ModuleError::IpcError(format!("Failed to read handshake: {}", e)));
2025-11-09T23:19:32.1398151Z +                return Err(ModuleError::IpcError(format!(
2025-11-09T23:19:32.1398445Z +                    "Failed to read handshake: {}",
2025-11-09T23:19:32.1398705Z +                    e
2025-11-09T23:19:32.1398894Z +                )));
2025-11-09T23:19:32.1399070Z              }
2025-11-09T23:19:32.1399245Z              None => {
2025-11-09T23:19:32.1399588Z -                return Err(ModuleError::IpcError("Connection closed before handshake".to_string()));
2025-11-09T23:19:32.1400011Z +                return Err(ModuleError::IpcError(
2025-11-09T23:19:32.1400321Z +                    "Connection closed before handshake".to_string(),
2025-11-09T23:19:32.1400606Z +                ));
2025-11-09T23:19:32.1400781Z              }
2025-11-09T23:19:32.1400949Z          };
2025-11-09T23:19:32.1401356Z  
2025-11-09T23:19:32.1401715Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/ipc/server.rs:372:
2025-11-09T23:19:32.1402184Z                  // Handshake is handled at connection level
2025-11-09T23:19:32.1402474Z                  Ok(ResponseMessage::success(
2025-11-09T23:19:32.1402884Z                      request.correlation_id,
2025-11-09T23:19:32.1403298Z -                    ResponsePayload::HandshakeAck { node_version: env!("CARGO_PKG_VERSION").to_string() },
2025-11-09T23:19:32.1403731Z +                    ResponsePayload::HandshakeAck {
2025-11-09T23:19:32.1404045Z +                        node_version: env!("CARGO_PKG_VERSION").to_string(),
2025-11-09T23:19:32.1404462Z +                    },
2025-11-09T23:19:32.1404654Z                  ))
2025-11-09T23:19:32.1404826Z              }
2025-11-09T23:19:32.1405028Z              RequestPayload::GetBlock { hash } => {
2025-11-09T23:19:32.1405529Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/manager.rs:159:
2025-11-09T23:19:32.1406382Z          // This allows both to access the process for different purposes
2025-11-09T23:19:32.1406725Z          use std::sync::Arc;
2025-11-09T23:19:32.1407021Z          let shared_process = Arc::new(tokio::sync::Mutex::new(process));
2025-11-09T23:19:32.1407341Z -        
2025-11-09T23:19:32.1407500Z +
2025-11-09T23:19:32.1407689Z          // Create monitor with shared process
2025-11-09T23:19:32.1408039Z          let monitor = ModuleProcessMonitor::new(self.crash_tx.clone());
2025-11-09T23:19:32.1408406Z          let module_name_clone = module_name.to_string();
2025-11-09T23:19:32.1417445Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:87:
2025-11-09T23:19:32.1418244Z  
2025-11-09T23:19:32.1418556Z              // Check heartbeat via IPC
2025-11-09T23:19:32.1419024Z              if let Some(client) = process.client_mut() {
2025-11-09T23:19:32.1419479Z +                use crate::module::ipc::protocol::MessageType;
2025-11-09T23:19:32.1419824Z                  use crate::module::ipc::protocol::RequestMessage;
2025-11-09T23:19:32.1420158Z                  use crate::module::ipc::protocol::RequestPayload;
2025-11-09T23:19:32.1420475Z -                use crate::module::ipc::protocol::MessageType;
2025-11-09T23:19:32.1420765Z -                
2025-11-09T23:19:32.1421119Z +
2025-11-09T23:19:32.1421344Z                  // Use GetChainTip as a lightweight heartbeat check
2025-11-09T23:19:32.1421725Z                  let heartbeat_request = RequestMessage {
2025-11-09T23:19:32.1422097Z                      correlation_id: 0, // Use 0 for heartbeat (won't match any real request)
2025-11-09T23:19:32.1422653Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:97:
2025-11-09T23:19:32.1423148Z                      request_type: MessageType::GetChainTip,
2025-11-09T23:19:32.1423452Z                      payload: RequestPayload::GetChainTip,
2025-11-09T23:19:32.1423705Z                  };
2025-11-09T23:19:32.1423880Z -                
2025-11-09T23:19:32.1424049Z +
2025-11-09T23:19:32.1424231Z                  // Send heartbeat with timeout
2025-11-09T23:19:32.1424830Z -                let heartbeat_result = tokio::time::timeout(
2025-11-09T23:19:32.1425139Z -                    Duration::from_secs(2),
2025-11-09T23:19:32.1425411Z -                    client.request(heartbeat_request)
2025-11-09T23:19:32.1425670Z -                ).await;
2025-11-09T23:19:32.1425860Z -                
2025-11-09T23:19:32.1426056Z +                let heartbeat_result =
2025-11-09T23:19:32.1428336Z +                    tokio::time::timeout(Duration::from_secs(2), client.request(heartbeat_request))
2025-11-09T23:19:32.1428845Z +                        .await;
2025-11-09T23:19:32.1429075Z +
2025-11-09T23:19:32.1429250Z                  match heartbeat_result {
2025-11-09T23:19:32.1429597Z                      Ok(Ok(_)) => {
2025-11-09T23:19:32.1430033Z                          // Heartbeat successful - module is responsive
2025-11-09T23:19:32.1430665Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:120:
2025-11-09T23:19:32.1431115Z                  }
2025-11-09T23:19:32.1431288Z              } else {
2025-11-09T23:19:32.1431698Z                  // No IPC client available - can't check heartbeat
2025-11-09T23:19:32.1432077Z -                debug!("Module {} has no IPC client for heartbeat check", module_name);
2025-11-09T23:19:32.1432417Z +                debug!(
2025-11-09T23:19:32.1432666Z +                    "Module {} has no IPC client for heartbeat check",
2025-11-09T23:19:32.1432957Z +                    module_name
2025-11-09T23:19:32.1433166Z +                );
2025-11-09T23:19:32.1433345Z              }
2025-11-09T23:19:32.1433511Z -            
2025-11-09T23:19:32.1433679Z +
2025-11-09T23:19:32.1433866Z              // Loop continues to next iteration
2025-11-09T23:19:32.1434107Z          }
2025-11-09T23:19:32.1434401Z      }
2025-11-09T23:19:32.1434784Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:145:
2025-11-09T23:19:32.1435308Z                  let mut process_guard = shared_process.lock().await;
2025-11-09T23:19:32.1435605Z                  process_guard.is_running()
2025-11-09T23:19:32.1435850Z              };
2025-11-09T23:19:32.1436020Z -            
2025-11-09T23:19:32.1436183Z +
2025-11-09T23:19:32.1436341Z              if !is_running {
2025-11-09T23:19:32.1436581Z                  // Process exited, check exit status
2025-11-09T23:19:32.1436844Z                  let exit_status = {
2025-11-09T23:19:32.1437283Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:152:
2025-11-09T23:19:32.1437786Z                      let mut process_guard = shared_process.lock().await;
2025-11-09T23:19:32.1438084Z                      process_guard.wait().await?
2025-11-09T23:19:32.1438330Z                  };
2025-11-09T23:19:32.1438501Z -                
2025-11-09T23:19:32.1438676Z +
2025-11-09T23:19:32.1438835Z                  match exit_status {
2025-11-09T23:19:32.1439069Z                      Some(status) => {
2025-11-09T23:19:32.1439317Z                          if status.success() {
2025-11-09T23:19:32.1439898Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:182:
2025-11-09T23:19:32.1440349Z              {
2025-11-09T23:19:32.1440569Z                  let mut process_guard = shared_process.lock().await;
2025-11-09T23:19:32.1440897Z                  if let Some(client) = process_guard.client_mut() {
2025-11-09T23:19:32.1443088Z +                    use crate::module::ipc::protocol::MessageType;
2025-11-09T23:19:32.1443413Z                      use crate::module::ipc::protocol::RequestMessage;
2025-11-09T23:19:32.1443734Z                      use crate::module::ipc::protocol::RequestPayload;
2025-11-09T23:19:32.1444245Z -                    use crate::module::ipc::protocol::MessageType;
2025-11-09T23:19:32.1444797Z -                    
2025-11-09T23:19:32.1444982Z +
2025-11-09T23:19:32.1445196Z                      // Use GetChainTip as a lightweight heartbeat check
2025-11-09T23:19:32.1445510Z                      let heartbeat_request = RequestMessage {
2025-11-09T23:19:32.1445890Z                          correlation_id: 0, // Use 0 for heartbeat (won't match any real request)
2025-11-09T23:19:32.1446440Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:192:
2025-11-09T23:19:32.1446934Z                          request_type: MessageType::GetChainTip,
2025-11-09T23:19:32.1447243Z                          payload: RequestPayload::GetChainTip,
2025-11-09T23:19:32.1447505Z                      };
2025-11-09T23:19:32.1447702Z -                    
2025-11-09T23:19:32.1447878Z +
2025-11-09T23:19:32.1448055Z                      // Send heartbeat with timeout
2025-11-09T23:19:32.1448349Z                      let heartbeat_result = tokio::time::timeout(
2025-11-09T23:19:32.1448642Z                          Duration::from_secs(2),
2025-11-09T23:19:32.1449098Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:199:
2025-11-09T23:19:32.1451444Z -                        client.request(heartbeat_request)
2025-11-09T23:19:32.1451894Z -                    ).await;
2025-11-09T23:19:32.1452100Z -                    
2025-11-09T23:19:32.1452318Z +                        client.request(heartbeat_request),
2025-11-09T23:19:32.1452570Z +                    )
2025-11-09T23:19:32.1452757Z +                    .await;
2025-11-09T23:19:32.1452947Z +
2025-11-09T23:19:32.1453120Z                      match heartbeat_result {
2025-11-09T23:19:32.1453362Z                          Ok(Ok(_)) => {
2025-11-09T23:19:32.1453634Z                              // Heartbeat successful - module is responsive
2025-11-09T23:19:32.1454116Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:215:
2025-11-09T23:19:32.1454692Z                      }
2025-11-09T23:19:32.1454877Z                  } else {
2025-11-09T23:19:32.1455115Z                      // No IPC client available - can't check heartbeat
2025-11-09T23:19:32.1455486Z -                    debug!("Module {} has no IPC client for heartbeat check", module_name);
2025-11-09T23:19:32.1455822Z +                    debug!(
2025-11-09T23:19:32.1456077Z +                        "Module {} has no IPC client for heartbeat check",
2025-11-09T23:19:32.1456356Z +                        module_name
2025-11-09T23:19:32.1456577Z +                    );
2025-11-09T23:19:32.1456759Z                  }
2025-11-09T23:19:32.1456925Z              }
2025-11-09T23:19:32.1457089Z -            
2025-11-09T23:19:32.1457248Z +
2025-11-09T23:19:32.1457425Z              // Loop continues to next iteration
2025-11-09T23:19:32.1457667Z          }
2025-11-09T23:19:32.1457827Z      }
2025-11-09T23:19:32.1458197Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:229:
2025-11-09T23:19:32.1458702Z              ModuleHealth::Crashed("Process exited".to_string())
2025-11-09T23:19:32.1459026Z          } else if let Some(client) = process.client_mut() {
2025-11-09T23:19:32.1459331Z              // Check heartbeat via IPC with short timeout
2025-11-09T23:19:32.1459867Z -            use crate::module::ipc::protocol::{RequestMessage, RequestPayload, MessageType};
2025-11-09T23:19:32.1460372Z +            use crate::module::ipc::protocol::{MessageType, RequestMessage, RequestPayload};
2025-11-09T23:19:32.1460748Z              use tokio::time::timeout;
2025-11-09T23:19:32.1460971Z -            
2025-11-09T23:19:32.1461132Z +
2025-11-09T23:19:32.1461313Z              let heartbeat_request = RequestMessage {
2025-11-09T23:19:32.1461583Z                  correlation_id: 0,
2025-11-09T23:19:32.1461851Z                  request_type: MessageType::GetChainTip,
2025-11-09T23:19:32.1462324Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:238:
2025-11-09T23:19:32.1462804Z                  payload: RequestPayload::GetChainTip,
2025-11-09T23:19:32.1463052Z              };
2025-11-09T23:19:32.1463222Z -            
2025-11-09T23:19:32.1463379Z +
2025-11-09T23:19:32.1463614Z              // Use tokio::runtime::Handle to run async code in sync context
2025-11-09T23:19:32.1464038Z              // This is a simplified check - in production would use proper async context
2025-11-09T23:19:32.1464553Z              match tokio::runtime::Handle::try_current() {
2025-11-09T23:19:32.1465030Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:244:
2025-11-09T23:19:32.1465479Z                  Ok(handle) => {
2025-11-09T23:19:32.1465724Z                      let result = handle.block_on(timeout(
2025-11-09T23:19:32.1465994Z                          Duration::from_secs(1),
2025-11-09T23:19:32.1466263Z -                        client.request(heartbeat_request)
2025-11-09T23:19:32.1466543Z +                        client.request(heartbeat_request),
2025-11-09T23:19:32.1466797Z                      ));
2025-11-09T23:19:32.1466985Z -                    
2025-11-09T23:19:32.1467156Z +
2025-11-09T23:19:32.1467314Z                      match result {
2025-11-09T23:19:32.1467697Z                          Ok(Ok(_)) => ModuleHealth::Healthy,
2025-11-09T23:19:32.1467980Z                          _ => ModuleHealth::Unresponsive,
2025-11-09T23:19:32.1517172Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/sandbox/process.rs:99:
2025-11-09T23:19:32.1517820Z                  if let Some(max_memory) = limits.max_memory_bytes {
2025-11-09T23:19:32.1518138Z                      let soft_limit = max_memory as u64;
2025-11-09T23:19:32.1518416Z                      let hard_limit = max_memory as u64;
2025-11-09T23:19:32.1518749Z -                    setrlimit(Resource::RLIMIT_AS, soft_limit, hard_limit)
2025-11-09T23:19:32.1519065Z -                        .map_err(|e| {
2025-11-09T23:19:32.1519347Z -                            ModuleError::OperationError(format!(
2025-11-09T23:19:32.1519646Z -                                "Failed to set memory limit: {}",
2025-11-09T23:19:32.1519917Z -                                e
2025-11-09T23:19:32.1520149Z -                            ))
2025-11-09T23:19:32.1520361Z -                        })?;
2025-11-09T23:19:32.1520677Z +                    setrlimit(Resource::RLIMIT_AS, soft_limit, hard_limit).map_err(|e| {
2025-11-09T23:19:32.1521146Z +                        ModuleError::OperationError(format!("Failed to set memory limit: {}", e))
2025-11-09T23:19:32.1522968Z +                    })?;
2025-11-09T23:19:32.1523208Z                      debug!("Set memory limit: {} bytes", max_memory);
2025-11-09T23:19:32.1523481Z                  }
2025-11-09T23:19:32.1523656Z  
2025-11-09T23:19:32.1524038Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/sandbox/process.rs:116:
2025-11-09T23:19:32.1524802Z                      #[cfg(feature = "nix")]
2025-11-09T23:19:32.1525046Z                      {
2025-11-09T23:19:32.1525289Z                          use nix::sys::resource::{setrlimit, Resource};
2025-11-09T23:19:32.1525651Z -                        setrlimit(Resource::RLIMIT_NOFILE, soft_limit, hard_limit)
2025-11-09T23:19:32.1526163Z -                            .map_err(|e| {
2025-11-09T23:19:32.1526517Z +                        setrlimit(Resource::RLIMIT_NOFILE, soft_limit, hard_limit).map_err(
2025-11-09T23:19:32.1526858Z +                            |e| {
2025-11-09T23:19:32.1527126Z                                  ModuleError::OperationError(format!(
2025-11-09T23:19:32.1527531Z                                      "Failed to set file descriptor limit: {}",
2025-11-09T23:19:32.1528012Z                                      e
2025-11-09T23:19:32.1528468Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/sandbox/process.rs:124:
2025-11-09T23:19:32.1528959Z                                  ))
2025-11-09T23:19:32.1529343Z -                            })?;
2025-11-09T23:19:32.1529580Z +                            },
2025-11-09T23:19:32.1529794Z +                        )?;
2025-11-09T23:19:32.1531533Z                      }
2025-11-09T23:19:32.1531744Z                      #[cfg(not(feature = "nix"))]
2025-11-09T23:19:32.1531990Z                      {
2025-11-09T23:19:32.1532396Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/sandbox/process.rs:139:
2025-11-09T23:19:32.1532858Z                      #[cfg(feature = "nix")]
2025-11-09T23:19:32.1533129Z                      let hard_limit = max_children as u64;
2025-11-09T23:19:32.1533394Z                      #[cfg(feature = "nix")]
2025-11-09T23:19:32.1533713Z -                    setrlimit(Resource::RLIMIT_NPROC, soft_limit, hard_limit)
2025-11-09T23:19:32.1534036Z -                        .map_err(|e| {
2025-11-09T23:19:32.1534424Z -                            ModuleError::OperationError(format!(
2025-11-09T23:19:32.1534731Z -                                "Failed to set process limit: {}",
2025-11-09T23:19:32.1534996Z -                                e
2025-11-09T23:19:32.1535212Z -                            ))
2025-11-09T23:19:32.1535415Z -                        })?;
2025-11-09T23:19:32.1535924Z +                    setrlimit(Resource::RLIMIT_NPROC, soft_limit, hard_limit).map_err(|e| {
2025-11-09T23:19:32.1536414Z +                        ModuleError::OperationError(format!("Failed to set process limit: {}", e))
2025-11-09T23:19:32.1536782Z +                    })?;
2025-11-09T23:19:32.1537023Z                      debug!("Set process limit: {}", max_children);
2025-11-09T23:19:32.1537296Z                  }
2025-11-09T23:19:32.1537573Z  
2025-11-09T23:19:32.1538235Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/sandbox/process.rs:191:
2025-11-09T23:19:32.1538961Z                          // Field 23 (index 22): rss - Resident Set Size (pages)
2025-11-09T23:19:32.1539359Z                          let utime: u64 = fields.get(13).and_then(|s| s.parse().ok()).unwrap_or(0);
2025-11-09T23:19:32.1539795Z                          let stime: u64 = fields.get(14).and_then(|s| s.parse().ok()).unwrap_or(0);
2025-11-09T23:19:32.1540249Z -                        let rss_pages: u64 = fields.get(22).and_then(|s| s.parse().ok()).unwrap_or(0);
2025-11-09T23:19:32.1540612Z +                        let rss_pages: u64 =
2025-11-09T23:19:32.1540923Z +                            fields.get(22).and_then(|s| s.parse().ok()).unwrap_or(0);
2025-11-09T23:19:32.1541217Z  
2025-11-09T23:19:32.1541421Z                          // Get page size (typically 4096 bytes on Linux)
2025-11-09T23:19:32.1541712Z                          #[cfg(feature = "libc")]
2025-11-09T23:19:32.1542209Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/security/validator.rs:155:
2025-11-09T23:19:32.1542732Z          let mut limiters = self.rate_limiters.lock().unwrap();
2025-11-09T23:19:32.1543011Z  
2025-11-09T23:19:32.1543198Z          // Get or create rate limiter for this module
2025-11-09T23:19:32.1543463Z -        let limiter = limiters
2025-11-09T23:19:32.1543699Z -            .entry(module_id.to_string())
2025-11-09T23:19:32.1543945Z -            .or_insert_with(|| {
2025-11-09T23:19:32.1544579Z -                RateLimiter::new(self.max_requests_per_second, self.time_window_seconds)
2025-11-09T23:19:32.1544945Z -            });
2025-11-09T23:19:32.1545237Z +        let limiter = limiters.entry(module_id.to_string()).or_insert_with(|| {
2025-11-09T23:19:32.1545691Z +            RateLimiter::new(self.max_requests_per_second, self.time_window_seconds)
2025-11-09T23:19:32.1546021Z +        });
2025-11-09T23:19:32.1546187Z  
2025-11-09T23:19:32.1546347Z          // Check rate limit
2025-11-09T23:19:32.1546711Z          if !limiter.check_rate_limit(self.max_requests_per_second, self.time_window_seconds) {
2025-11-09T23:19:32.1621909Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:104:
2025-11-09T23:19:32.1623093Z      pub fn add_address(&mut self, addr: NetworkAddress, services: u64) {
2025-11-09T23:19:32.1623884Z          // Convert NetworkAddress to SocketAddr for key
2025-11-09T23:19:32.1624504Z          let socket_addr = self.network_addr_to_socket(&addr);
2025-11-09T23:19:32.1625001Z -        
2025-11-09T23:19:32.1625171Z +
2025-11-09T23:19:32.1625373Z          match self.addresses.get_mut(&socket_addr) {
2025-11-09T23:19:32.1625647Z              Some(entry) => {
2025-11-09T23:19:32.1625874Z                  // Update existing entry
2025-11-09T23:19:32.1626321Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:116:
2025-11-09T23:19:32.1626803Z                  if self.addresses.len() >= self.max_addresses {
2025-11-09T23:19:32.1627088Z                      self.evict_oldest();
2025-11-09T23:19:32.1627315Z                  }
2025-11-09T23:19:32.1627635Z -                self.addresses.insert(socket_addr, AddressEntry::new(addr, services));
2025-11-09T23:19:32.1628005Z +                self.addresses
2025-11-09T23:19:32.1628303Z +                    .insert(socket_addr, AddressEntry::new(addr, services));
2025-11-09T23:19:32.1628605Z              }
2025-11-09T23:19:32.1628979Z          }
2025-11-09T23:19:32.1629143Z      }
2025-11-09T23:19:32.1629513Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:136:
2025-11-09T23:19:32.1630025Z              .filter(|entry| entry.is_fresh(self.expiration_seconds))
2025-11-09T23:19:32.1630343Z              .map(|entry| entry.addr.clone())
2025-11-09T23:19:32.1630678Z              .collect();
2025-11-09T23:19:32.1630868Z -        
2025-11-09T23:19:32.1631030Z +
2025-11-09T23:19:32.1631217Z          // Sort by last_seen (most recent first)
2025-11-09T23:19:32.1631477Z          fresh.sort_by_key(|addr| {
2025-11-09T23:19:32.1631756Z              let socket = self.network_addr_to_socket(addr);
2025-11-09T23:19:32.1632227Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:146:
2025-11-09T23:19:32.1632673Z                  .unwrap_or(0)
2025-11-09T23:19:32.1632879Z          });
2025-11-09T23:19:32.1633055Z          fresh.reverse();
2025-11-09T23:19:32.1633252Z -        
2025-11-09T23:19:32.1633419Z +
2025-11-09T23:19:32.1633603Z          fresh.into_iter().take(count).collect()
2025-11-09T23:19:32.1633851Z      }
2025-11-09T23:19:32.1634000Z  
2025-11-09T23:19:32.1634601Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:158:
2025-11-09T23:19:32.1635058Z      /// Remove expired addresses
2025-11-09T23:19:32.1635321Z      pub fn remove_expired(&mut self) -> usize {
2025-11-09T23:19:32.1635600Z          let before = self.addresses.len();
2025-11-09T23:19:32.1635978Z -        self.addresses.retain(|_, entry| entry.is_fresh(self.expiration_seconds));
2025-11-09T23:19:32.1636345Z +        self.addresses
2025-11-09T23:19:32.1636610Z +            .retain(|_, entry| entry.is_fresh(self.expiration_seconds));
2025-11-09T23:19:32.1636935Z          before - self.addresses.len()
2025-11-09T23:19:32.1637163Z      }
2025-11-09T23:19:32.1637316Z  
2025-11-09T23:19:32.1637667Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:196:
2025-11-09T23:19:32.1638281Z                      || ipv4.is_link_local()
2025-11-09T23:19:32.1638533Z                      || ipv4.is_broadcast()
2025-11-09T23:19:32.1638768Z              }
2025-11-09T23:19:32.1638961Z -            IpAddr::V6(ipv6) => {
2025-11-09T23:19:32.1639229Z -                ipv6.is_loopback() || ipv6.is_unspecified()
2025-11-09T23:19:32.1639496Z -            }
2025-11-09T23:19:32.1641487Z +            IpAddr::V6(ipv6) => ipv6.is_loopback() || ipv6.is_unspecified(),
2025-11-09T23:19:32.1642005Z          }
2025-11-09T23:19:32.1642282Z      }
2025-11-09T23:19:32.1642546Z  
2025-11-09T23:19:32.1643141Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:238:
2025-11-09T23:19:32.1643588Z                      ip: [0; 16],
2025-11-09T23:19:32.1643816Z                      port: 0,
2025-11-09T23:19:32.1644027Z                  };
2025-11-09T23:19:32.1644608Z -                self.iroh_addresses.insert(node_id, AddressEntry::new(placeholder_addr, services));
2025-11-09T23:19:32.1645083Z +                self.iroh_addresses
2025-11-09T23:19:32.1645413Z +                    .insert(node_id, AddressEntry::new(placeholder_addr, services));
2025-11-09T23:19:32.1645725Z              }
2025-11-09T23:19:32.1645901Z          }
2025-11-09T23:19:32.1646054Z      }
2025-11-09T23:19:32.1646424Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:252:
2025-11-09T23:19:32.1646920Z              .filter(|(_, entry)| entry.is_fresh(self.expiration_seconds))
2025-11-09T23:19:32.1647238Z              .map(|(node_id, _)| *node_id)
2025-11-09T23:19:32.1647476Z              .collect();
2025-11-09T23:19:32.1647668Z -        
2025-11-09T23:19:32.1647824Z +
2025-11-09T23:19:32.1648002Z          // Sort by last_seen (most recent first)
2025-11-09T23:19:32.1648340Z          fresh.sort_by_key(|node_id| {
2025-11-09T23:19:32.1648766Z              self.iroh_addresses
2025-11-09T23:19:32.1651534Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:261:
2025-11-09T23:19:32.1651990Z                  .unwrap_or(0)
2025-11-09T23:19:32.1652342Z          });
2025-11-09T23:19:32.1652651Z          fresh.reverse();
2025-11-09T23:19:32.1652907Z -        
2025-11-09T23:19:32.1653074Z +
2025-11-09T23:19:32.1653262Z          fresh.into_iter().take(count).collect()
2025-11-09T23:19:32.1653515Z      }
2025-11-09T23:19:32.1653670Z  
2025-11-09T23:19:32.1654032Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:319:
2025-11-09T23:19:32.1665195Z      }
2025-11-09T23:19:32.1665539Z  
2025-11-09T23:19:32.1665775Z      /// Convert NetworkAddress to SocketAddr
2025-11-09T23:19:32.1666048Z -    /// 
2025-11-09T23:19:32.1666223Z +    ///
2025-11-09T23:19:32.1666514Z      /// Note: This is public for use in NetworkManager when connecting to peers.
2025-11-09T23:19:32.1666998Z      pub fn network_addr_to_socket(&self, addr: &NetworkAddress) -> SocketAddr {
2025-11-09T23:19:32.1667415Z          // Convert IPv6 address bytes to SocketAddr
2025-11-09T23:19:32.1667892Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:327:
2025-11-09T23:19:32.1668432Z          let ip = if addr.ip[0..12] == [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0xff, 0xff] {
2025-11-09T23:19:32.1668780Z              // IPv4-mapped IPv6 address
2025-11-09T23:19:32.1669066Z              IpAddr::V4(std::net::Ipv4Addr::new(
2025-11-09T23:19:32.1669378Z -                addr.ip[12], addr.ip[13], addr.ip[14], addr.ip[15],
2025-11-09T23:19:32.1669673Z +                addr.ip[12],
2025-11-09T23:19:32.1669896Z +                addr.ip[13],
2025-11-09T23:19:32.1670099Z +                addr.ip[14],
2025-11-09T23:19:32.1670306Z +                addr.ip[15],
2025-11-09T23:19:32.1670502Z              ))
2025-11-09T23:19:32.1670684Z          } else {
2025-11-09T23:19:32.1670867Z              // Native IPv6
2025-11-09T23:19:32.1671284Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:342:
2025-11-09T23:19:32.1671974Z                  u16::from_be_bytes([addr.ip[14], addr.ip[15]]),
2025-11-09T23:19:32.1672255Z              ];
2025-11-09T23:19:32.1672470Z              IpAddr::V6(std::net::Ipv6Addr::new(
2025-11-09T23:19:32.1672773Z -                segments[0], segments[1], segments[2], segments[3],
2025-11-09T23:19:32.1673113Z -                segments[4], segments[5], segments[6], segments[7],
2025-11-09T23:19:32.1673393Z +                segments[0],
2025-11-09T23:19:32.1673611Z +                segments[1],
2025-11-09T23:19:32.1673822Z +                segments[2],
2025-11-09T23:19:32.1674021Z +                segments[3],
2025-11-09T23:19:32.1674232Z +                segments[4],
2025-11-09T23:19:32.1674580Z +                segments[5],
2025-11-09T23:19:32.1674791Z +                segments[6],
2025-11-09T23:19:32.1674993Z +                segments[7],
2025-11-09T23:19:32.1675198Z              ))
2025-11-09T23:19:32.1675378Z          };
2025-11-09T23:19:32.1675576Z          SocketAddr::new(ip, addr.port)
2025-11-09T23:19:32.1676348Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:406:
2025-11-09T23:19:32.1676990Z          let addr2 = create_test_address("192.168.1.2", 8333);
2025-11-09T23:19:32.1677300Z          db.add_address(addr1.clone(), 1);
2025-11-09T23:19:32.1677561Z          db.add_address(addr2.clone(), 1);
2025-11-09T23:19:32.1677799Z -        
2025-11-09T23:19:32.1677957Z +
2025-11-09T23:19:32.1678146Z          let fresh = db.get_fresh_addresses(10);
2025-11-09T23:19:32.1678407Z          assert_eq!(fresh.len(), 2);
2025-11-09T23:19:32.1678632Z      }
2025-11-09T23:19:32.1678992Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:417:
2025-11-09T23:19:32.1679466Z          let addr = create_test_address("192.168.1.1", 8333);
2025-11-09T23:19:32.1679755Z          db.add_address(addr.clone(), 1);
2025-11-09T23:19:32.1680172Z          assert_eq!(db.len(), 1);
2025-11-09T23:19:32.1680399Z -        
2025-11-09T23:19:32.1682137Z +
2025-11-09T23:19:32.1682311Z          // Wait for expiration
2025-11-09T23:19:32.1682592Z          std::thread::sleep(std::time::Duration::from_secs(2));
2025-11-09T23:19:32.1682879Z -        
2025-11-09T23:19:32.1683108Z +
2025-11-09T23:19:32.1683412Z          let fresh = db.get_fresh_addresses(10);
2025-11-09T23:19:32.1683870Z          assert_eq!(fresh.len(), 0); // Should be expired
2025-11-09T23:19:32.1684143Z      }
2025-11-09T23:19:32.1684663Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:433:
2025-11-09T23:19:32.1685125Z          db.add_address(addr1.clone(), 1);
2025-11-09T23:19:32.1685388Z          db.add_address(addr2.clone(), 1);
2025-11-09T23:19:32.1685637Z          assert_eq!(db.len(), 2);
2025-11-09T23:19:32.1685861Z -        
2025-11-09T23:19:32.1686072Z +
2025-11-09T23:19:32.1686374Z          // Wait for expiration
2025-11-09T23:19:32.1686851Z          std::thread::sleep(std::time::Duration::from_secs(2));
2025-11-09T23:19:32.1687251Z -        
2025-11-09T23:19:32.1687419Z +
2025-11-09T23:19:32.1687594Z          let removed = db.remove_expired();
2025-11-09T23:19:32.1687852Z          assert_eq!(removed, 2);
2025-11-09T23:19:32.1688073Z          assert_eq!(db.len(), 0);
2025-11-09T23:19:32.1688492Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:448:
2025-11-09T23:19:32.1688973Z          let localhost = create_test_address("127.0.0.1", 8333);
2025-11-09T23:19:32.1689300Z          let private = create_test_address("192.168.1.1", 8333);
2025-11-09T23:19:32.1689610Z          let public = create_test_address("8.8.8.8", 8333);
2025-11-09T23:19:32.1689877Z -        
2025-11-09T23:19:32.1690088Z +
2025-11-09T23:19:32.1690253Z          assert!(db.is_local(&localhost));
2025-11-09T23:19:32.1690511Z          assert!(db.is_local(&private));
2025-11-09T23:19:32.1690764Z          assert!(!db.is_local(&public));
2025-11-09T23:19:32.1691376Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:460:
2025-11-09T23:19:32.1691860Z          let addr = create_test_address("192.168.1.1", 8333);
2025-11-09T23:19:32.1692227Z          let socket = SocketAddr::new("192.168.1.1".parse().unwrap(), 8333);
2025-11-09T23:19:32.1692569Z          let mut ban_list = HashMap::new();
2025-11-09T23:19:32.1692810Z -        
2025-11-09T23:19:32.1692969Z +
2025-11-09T23:19:32.1693124Z          // Not banned
2025-11-09T23:19:32.1693383Z          assert!(!db.is_banned(&addr, &ban_list));
2025-11-09T23:19:32.1693824Z -        
2025-11-09T23:19:32.1694098Z +
2025-11-09T23:19:32.1694477Z          // Banned (permanent)
2025-11-09T23:19:32.1694923Z          ban_list.insert(socket, u64::MAX);
2025-11-09T23:19:32.1695222Z          assert!(db.is_banned(&addr, &ban_list));
2025-11-09T23:19:32.1695693Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:470:
2025-11-09T23:19:32.1696142Z -        
2025-11-09T23:19:32.1696303Z +
2025-11-09T23:19:32.1696490Z          // Banned (temporary, not expired)
2025-11-09T23:19:32.1696741Z          ban_list.clear();
2025-11-09T23:19:32.1696996Z          let future_time = std::time::SystemTime::now()
2025-11-09T23:19:32.1697463Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:474:
2025-11-09T23:19:32.1697933Z              .duration_since(std::time::UNIX_EPOCH)
2025-11-09T23:19:32.1698189Z              .unwrap()
2025-11-09T23:19:32.1698395Z -            .as_secs() + 3600;
2025-11-09T23:19:32.1698615Z +            .as_secs()
2025-11-09T23:19:32.1698803Z +            + 3600;
2025-11-09T23:19:32.1699019Z          ban_list.insert(socket, future_time);
2025-11-09T23:19:32.1699293Z          assert!(db.is_banned(&addr, &ban_list));
2025-11-09T23:19:32.1699545Z -        
2025-11-09T23:19:32.1699704Z +
2025-11-09T23:19:32.1699873Z          // Banned (expired)
2025-11-09T23:19:32.1700088Z          ban_list.clear();
2025-11-09T23:19:32.1700491Z          let past_time = std::time::SystemTime::now()
2025-11-09T23:19:32.1702854Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:483:
2025-11-09T23:19:32.1703323Z              .duration_since(std::time::UNIX_EPOCH)
2025-11-09T23:19:32.1703581Z              .unwrap()
2025-11-09T23:19:32.1703779Z -            .as_secs() - 3600;
2025-11-09T23:19:32.1703998Z +            .as_secs()
2025-11-09T23:19:32.1704183Z +            - 3600;
2025-11-09T23:19:32.1704759Z          ban_list.insert(socket, past_time);
2025-11-09T23:19:32.1705053Z          assert!(!db.is_banned(&addr, &ban_list));
2025-11-09T23:19:32.1705310Z      }
2025-11-09T23:19:32.1705686Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:493:
2025-11-09T23:19:32.1706180Z          let local = create_test_address("127.0.0.1", 8333);
2025-11-09T23:19:32.1706510Z          let banned = create_test_address("192.168.1.1", 8333);
2025-11-09T23:19:32.1706837Z          let public = create_test_address("8.8.8.8", 8333);
2025-11-09T23:19:32.1707108Z -        
2025-11-09T23:19:32.1707279Z +
2025-11-09T23:19:32.1707563Z          let socket_banned = SocketAddr::new("192.168.1.1".parse().unwrap(), 8333);
2025-11-09T23:19:32.1708011Z          let socket_connected = SocketAddr::new("8.8.8.8".parse().unwrap(), 8333);
2025-11-09T23:19:32.1708384Z          let mut ban_list = HashMap::new();
2025-11-09T23:19:32.1708835Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:500:
2025-11-09T23:19:32.1709302Z          ban_list.insert(socket_banned, u64::MAX);
2025-11-09T23:19:32.1709610Z          let connected_peers = vec![socket_connected];
2025-11-09T23:19:32.1709871Z -        
2025-11-09T23:19:32.1712018Z +
2025-11-09T23:19:32.1712641Z          let addresses = vec![local, banned, public];
2025-11-09T23:19:32.1713026Z          let filtered = db.filter_addresses(addresses, &ban_list, &connected_peers);
2025-11-09T23:19:32.1713378Z -        
2025-11-09T23:19:32.1713540Z +
2025-11-09T23:19:32.1713946Z          // Should filter out local, banned, and connected
2025-11-09T23:19:32.1714527Z          assert_eq!(filtered.len(), 0);
2025-11-09T23:19:32.1714770Z      }
2025-11-09T23:19:32.1715136Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:513:
2025-11-09T23:19:32.1715621Z          let addr1 = create_test_address("192.168.1.1", 8333);
2025-11-09T23:19:32.1715975Z          let addr2 = create_test_address("192.168.1.2", 8333);
2025-11-09T23:19:32.1716285Z          let addr3 = create_test_address("192.168.1.3", 8333);
2025-11-09T23:19:32.1716554Z -        
2025-11-09T23:19:32.1716722Z +
2025-11-09T23:19:32.1716900Z          db.add_address(addr1.clone(), 1);
2025-11-09T23:19:32.1717165Z          db.add_address(addr2.clone(), 1);
2025-11-09T23:19:32.1717417Z          assert_eq!(db.len(), 2);
2025-11-09T23:19:32.1717855Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:520:
2025-11-09T23:19:32.1718290Z -        
2025-11-09T23:19:32.1718451Z +
2025-11-09T23:19:32.1718632Z          // Adding third should evict oldest
2025-11-09T23:19:32.1718891Z          db.add_address(addr3.clone(), 1);
2025-11-09T23:19:32.1719163Z          assert_eq!(db.len(), 2); // Should still be 2
2025-11-09T23:19:32.1719632Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:528:
2025-11-09T23:19:32.1720084Z      fn test_add_iroh_address() {
2025-11-09T23:19:32.1722585Z          use iroh_net::NodeId;
2025-11-09T23:19:32.1722854Z          let mut db = AddressDatabase::new(100);
2025-11-09T23:19:32.1723104Z -        
2025-11-09T23:19:32.1723263Z +
2025-11-09T23:19:32.1723441Z          // Create a test NodeId (32 bytes)
2025-11-09T23:19:32.1723691Z          let node_id_bytes = [0u8; 32];
2025-11-09T23:19:32.1723999Z          let node_id = NodeId::from_bytes(&node_id_bytes).unwrap();
2025-11-09T23:19:32.1724721Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:535:
2025-11-09T23:19:32.1725915Z -        
2025-11-09T23:19:32.1726096Z +
2025-11-09T23:19:32.1726277Z          db.add_iroh_address(node_id, 1);
2025-11-09T23:19:32.1726541Z          assert_eq!(db.total_count(), 1);
2025-11-09T23:19:32.1726779Z -        
2025-11-09T23:19:32.1726940Z +
2025-11-09T23:19:32.1727160Z          // Add same address again (should update, not duplicate)
2025-11-09T23:19:32.1727469Z          db.add_iroh_address(node_id, 2);
2025-11-09T23:19:32.1727715Z          assert_eq!(db.total_count(), 1);
2025-11-09T23:19:32.1728161Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:546:
2025-11-09T23:19:32.1728618Z      fn test_get_fresh_iroh_addresses() {
2025-11-09T23:19:32.1728885Z          use iroh_net::NodeId;
2025-11-09T23:19:32.1729126Z          let mut db = AddressDatabase::new(100);
2025-11-09T23:19:32.1729375Z -        
2025-11-09T23:19:32.1729534Z +
2025-11-09T23:19:32.1731622Z          let node_id1_bytes = [1u8; 32];
2025-11-09T23:19:32.1731875Z          let node_id2_bytes = [2u8; 32];
2025-11-09T23:19:32.1732173Z          let node_id1 = NodeId::from_bytes(&node_id1_bytes).unwrap();
2025-11-09T23:19:32.1732670Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:553:
2025-11-09T23:19:32.1733156Z          let node_id2 = NodeId::from_bytes(&node_id2_bytes).unwrap();
2025-11-09T23:19:32.1733438Z -        
2025-11-09T23:19:32.1733589Z +
2025-11-09T23:19:32.1733764Z          db.add_iroh_address(node_id1, 1);
2025-11-09T23:19:32.1734022Z          db.add_iroh_address(node_id2, 1);
2025-11-09T23:19:32.1734262Z -        
2025-11-09T23:19:32.1734704Z +
2025-11-09T23:19:32.1734925Z          let fresh = db.get_fresh_iroh_addresses(10);
2025-11-09T23:19:32.1735211Z          assert_eq!(fresh.len(), 2);
2025-11-09T23:19:32.1735434Z      }
2025-11-09T23:19:32.1735799Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:564:
2025-11-09T23:19:32.1736436Z      fn test_total_count_includes_iroh() {
2025-11-09T23:19:32.1736716Z          use iroh_net::NodeId;
2025-11-09T23:19:32.1736960Z          let mut db = AddressDatabase::new(100);
2025-11-09T23:19:32.1737213Z -        
2025-11-09T23:19:32.1737373Z +
2025-11-09T23:19:32.1737539Z          // Add SocketAddr address
2025-11-09T23:19:32.1737810Z          let addr = create_test_address("192.168.1.1", 8333);
2025-11-09T23:19:32.1737892Z          db.add_address(addr, 1);
2025-11-09T23:19:32.1738161Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:571:
2025-11-09T23:19:32.1738253Z          assert_eq!(db.total_count(), 1);
2025-11-09T23:19:32.1738319Z -        
2025-11-09T23:19:32.1738384Z +
2025-11-09T23:19:32.1738463Z          // Add Iroh address
2025-11-09T23:19:32.1738556Z          let node_id_bytes = [0u8; 32];
2025-11-09T23:19:32.1738694Z          let node_id = NodeId::from_bytes(&node_id_bytes).unwrap();
2025-11-09T23:19:32.1740599Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:15:
2025-11-09T23:19:32.1740702Z  /// - Combine reasons from all sources
2025-11-09T23:19:32.1740887Z  pub fn merge_ban_lists(ban_lists: Vec<&BanListMessage>) -> Vec<BanEntry> {
2025-11-09T23:19:32.1741066Z      let mut merged: HashMap<NetworkAddress, BanEntry> = HashMap::new();
2025-11-09T23:19:32.1741138Z -    
2025-11-09T23:19:32.1741201Z +
2025-11-09T23:19:32.1741286Z      for ban_list in ban_lists {
2025-11-09T23:19:32.1741368Z          if !ban_list.is_full {
2025-11-09T23:19:32.1741491Z              continue; // Skip hash-only responses
2025-11-09T23:19:32.1741831Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:22:
2025-11-09T23:19:32.1741900Z          }
2025-11-09T23:19:32.1741971Z -        
2025-11-09T23:19:32.1742036Z +
2025-11-09T23:19:32.1742132Z          for entry in &ban_list.ban_entries {
2025-11-09T23:19:32.1742357Z              let addr = entry.addr.clone();
2025-11-09T23:19:32.1742432Z -            
2025-11-09T23:19:32.1742500Z +
2025-11-09T23:19:32.1742590Z              match merged.get_mut(&addr) {
2025-11-09T23:19:32.1742678Z                  Some(existing) => {
2025-11-09T23:19:32.1742788Z                      // Conflict resolution: use longest ban
2025-11-09T23:19:32.1743084Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:36:
2025-11-09T23:19:32.1743221Z                              existing.unban_timestamp = entry.unban_timestamp;
2025-11-09T23:19:32.1743293Z                          }
2025-11-09T23:19:32.1743363Z                      }
2025-11-09T23:19:32.1743430Z -                    
2025-11-09T23:19:32.1743501Z +
2025-11-09T23:19:32.1743586Z                      // Merge reasons
2025-11-09T23:19:32.1743694Z                      if let Some(ref reason) = entry.reason {
2025-11-09T23:19:32.1743840Z -                        existing.reason = existing.reason.as_ref().map(|r| {
2025-11-09T23:19:32.1743944Z -                            format!("{}; {}", r, reason)
2025-11-09T23:19:32.1744046Z -                        }).or_else(|| Some(reason.clone()));
2025-11-09T23:19:32.1744140Z +                        existing.reason = existing
2025-11-09T23:19:32.1744221Z +                            .reason
2025-11-09T23:19:32.1744432Z +                            .as_ref()
2025-11-09T23:19:32.1744539Z +                            .map(|r| format!("{}; {}", r, reason))
2025-11-09T23:19:32.1744647Z +                            .or_else(|| Some(reason.clone()));
2025-11-09T23:19:32.1744715Z                      }
2025-11-09T23:19:32.1744782Z                  }
2025-11-09T23:19:32.1744855Z                  None => {
2025-11-09T23:19:32.1745150Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:50:
2025-11-09T23:19:32.1745217Z              }
2025-11-09T23:19:32.1745282Z          }
2025-11-09T23:19:32.1745350Z      }
2025-11-09T23:19:32.1745419Z -    
2025-11-09T23:19:32.1745481Z +
2025-11-09T23:19:32.1745696Z      // Convert to sorted vector
2025-11-09T23:19:32.1745858Z      let mut result: Vec<BanEntry> = merged.into_values().collect();
2025-11-09T23:19:32.1745941Z      result.sort_by(|a, b| {
2025-11-09T23:19:32.1746226Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:57:
2025-11-09T23:19:32.1746338Z          // Sort by address for deterministic output
2025-11-09T23:19:32.1746428Z -        a.addr.ip.cmp(&b.addr.ip)
2025-11-09T23:19:32.1746497Z +        a.addr
2025-11-09T23:19:32.1746571Z +            .ip
2025-11-09T23:19:32.1746653Z +            .cmp(&b.addr.ip)
2025-11-09T23:19:32.1746767Z              .then_with(|| a.addr.port.cmp(&b.addr.port))
2025-11-09T23:19:32.1746835Z      });
2025-11-09T23:19:32.1746903Z -    
2025-11-09T23:19:32.1746967Z +
2025-11-09T23:19:32.1747033Z      result
2025-11-09T23:19:32.1747103Z  }
2025-11-09T23:19:32.1747168Z  
2025-11-09T23:19:32.1747462Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:72:
2025-11-09T23:19:32.1747552Z              .duration_since(UNIX_EPOCH)
2025-11-09T23:19:32.1747631Z              .unwrap()
2025-11-09T23:19:32.1747704Z              .as_secs();
2025-11-09T23:19:32.1747770Z -        
2025-11-09T23:19:32.1747838Z +
2025-11-09T23:19:32.1747931Z          if now >= entry.unban_timestamp {
2025-11-09T23:19:32.1748028Z              return false; // Ban already expired
2025-11-09T23:19:32.1748095Z          }
2025-11-09T23:19:32.1748385Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:79:
2025-11-09T23:19:32.1748451Z      }
2025-11-09T23:19:32.1748516Z -    
2025-11-09T23:19:32.1748584Z +
2025-11-09T23:19:32.1748683Z      // Additional validation could include:
2025-11-09T23:19:32.1748773Z      // - IP address format validation
2025-11-09T23:19:32.1748855Z      // - Reason length limits
2025-11-09T23:19:32.1749139Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:84:
2025-11-09T23:19:32.1749333Z      // - etc.
2025-11-09T23:19:32.1749398Z -    
2025-11-09T23:19:32.1749466Z +
2025-11-09T23:19:32.1749531Z      true
2025-11-09T23:19:32.1749597Z  }
2025-11-09T23:19:32.1749661Z  
2025-11-09T23:19:32.1749965Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:89:
2025-11-09T23:19:32.1750079Z  /// Calculate hash of ban list (for verification)
2025-11-09T23:19:32.1750242Z  pub fn calculate_ban_list_hash(entries: &[BanEntry]) -> [u8; 32] {
2025-11-09T23:19:32.1750336Z -    use sha2::{Sha256, Digest};
2025-11-09T23:19:32.1750402Z -    
2025-11-09T23:19:32.1750484Z +    use sha2::{Digest, Sha256};
2025-11-09T23:19:32.1750549Z +
2025-11-09T23:19:32.1750657Z      // Sort entries for deterministic hashing
2025-11-09T23:19:32.1750747Z      let mut sorted = entries.to_vec();
2025-11-09T23:19:32.1750830Z      sorted.sort_by(|a, b| {
2025-11-09T23:19:32.1751133Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:96:
2025-11-09T23:19:32.1751221Z -        a.addr.ip.cmp(&b.addr.ip)
2025-11-09T23:19:32.1751289Z +        a.addr
2025-11-09T23:19:32.1751359Z +            .ip
2025-11-09T23:19:32.1751444Z +            .cmp(&b.addr.ip)
2025-11-09T23:19:32.1751558Z              .then_with(|| a.addr.port.cmp(&b.addr.port))
2025-11-09T23:19:32.1751625Z      });
2025-11-09T23:19:32.1751694Z -    
2025-11-09T23:19:32.1751760Z +
2025-11-09T23:19:32.1751838Z      // Serialize and hash
2025-11-09T23:19:32.1752009Z      let serialized = bincode::serialize(&sorted).unwrap_or_default();
2025-11-09T23:19:32.1752112Z      let hash = Sha256::digest(&serialized);
2025-11-09T23:19:32.1752408Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:103:
2025-11-09T23:19:32.1752475Z -    
2025-11-09T23:19:32.1752544Z +
2025-11-09T23:19:32.1752625Z      let mut result = [0u8; 32];
2025-11-09T23:19:32.1752718Z      result.copy_from_slice(&hash);
2025-11-09T23:19:32.1752882Z      result
2025-11-09T23:19:32.1753183Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:111:
2025-11-09T23:19:32.1753304Z      let calculated = calculate_ban_list_hash(entries);
2025-11-09T23:19:32.1753392Z      calculated == *expected_hash
2025-11-09T23:19:32.1753462Z  }
2025-11-09T23:19:32.1753526Z -
2025-11-09T23:19:32.1753589Z -
2025-11-09T23:19:32.1753656Z -
2025-11-09T23:19:32.1753719Z  
2025-11-09T23:19:32.1754005Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_signing.rs:2:
2025-11-09T23:19:32.1754069Z  //!
2025-11-09T23:19:32.1754242Z  //! Provides functions to sign and verify ban lists for authenticity.
2025-11-09T23:19:32.1754429Z  
2025-11-09T23:19:32.1754581Z -use crate::network::protocol::{BanListMessage, BanEntry};
2025-11-09T23:19:32.1754785Z -use secp256k1::{Secp256k1, Message, ecdsa::Signature, SecretKey, PublicKey};
2025-11-09T23:19:32.1754929Z +use crate::network::protocol::{BanEntry, BanListMessage};
2025-11-09T23:19:32.1755121Z +use secp256k1::{ecdsa::Signature, Message, PublicKey, Secp256k1, SecretKey};
2025-11-09T23:19:32.1755187Z  
2025-11-09T23:19:32.1755286Z  /// Sign a ban list with a private key
2025-11-09T23:19:32.1755349Z  ///
2025-11-09T23:19:32.1755642Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_signing.rs:13:
2025-11-09T23:19:32.1755733Z      private_key: &SecretKey,
2025-11-09T23:19:32.1755826Z  ) -> Result<Vec<u8>, secp256k1::Error> {
2025-11-09T23:19:32.1755915Z      let secp = Secp256k1::new();
2025-11-09T23:19:32.1755982Z -    
2025-11-09T23:19:32.1756050Z +
2025-11-09T23:19:32.1756138Z      // Serialize ban list for signing
2025-11-09T23:19:32.1756253Z -    let serialized = bincode::serialize(ban_list)
2025-11-09T23:19:32.1756378Z -        .map_err(|_| secp256k1::Error::InvalidMessage)?;
2025-11-09T23:19:32.1756442Z -    
2025-11-09T23:19:32.1756822Z +    let serialized = bincode::serialize(ban_list).map_err(|_| secp256k1::Error::InvalidMessage)?;
2025-11-09T23:19:32.1756896Z +
2025-11-09T23:19:32.1756978Z      // Hash the serialized data
2025-11-09T23:19:32.1757059Z -    use sha2::{Sha256, Digest};
2025-11-09T23:19:32.1757138Z +    use sha2::{Digest, Sha256};
2025-11-09T23:19:32.1757244Z      let hash = Sha256::digest(&serialized);
2025-11-09T23:19:32.1757309Z -    
2025-11-09T23:19:32.1757375Z +
2025-11-09T23:19:32.1757458Z      // Create message from hash
2025-11-09T23:19:32.1757561Z -    let message = Message::from_slice(&hash)
2025-11-09T23:19:32.1757679Z -        .map_err(|_| secp256k1::Error::InvalidMessage)?;
2025-11-09T23:19:32.1757744Z -    
2025-11-09T23:19:32.1757970Z +    let message = Message::from_slice(&hash).map_err(|_| secp256k1::Error::InvalidMessage)?;
2025-11-09T23:19:32.1758034Z +
2025-11-09T23:19:32.1758101Z      // Sign
2025-11-09T23:19:32.1758239Z      let signature = secp.sign_ecdsa(&message, private_key);
2025-11-09T23:19:32.1758307Z -    
2025-11-09T23:19:32.1758370Z +
2025-11-09T23:19:32.1758454Z      // Serialize signature
2025-11-09T23:19:32.1758566Z      Ok(signature.serialize_compact().to_vec())
2025-11-09T23:19:32.1758631Z  }
2025-11-09T23:19:32.1758927Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_signing.rs:44:
2025-11-09T23:19:32.1759014Z      if signature.len() != 64 {
2025-11-09T23:19:32.1759092Z          return Ok(false);
2025-11-09T23:19:32.1759157Z      }
2025-11-09T23:19:32.1759221Z -    
2025-11-09T23:19:32.1759290Z +
2025-11-09T23:19:32.1759377Z      let secp = Secp256k1::new();
2025-11-09T23:19:32.1759441Z -    
2025-11-09T23:19:32.1759509Z +
2025-11-09T23:19:32.1759584Z      // Serialize ban list
2025-11-09T23:19:32.1759698Z -    let serialized = bincode::serialize(ban_list)
2025-11-09T23:19:32.1759815Z -        .map_err(|_| secp256k1::Error::InvalidMessage)?;
2025-11-09T23:19:32.1759884Z -    
2025-11-09T23:19:32.1760127Z +    let serialized = bincode::serialize(ban_list).map_err(|_| secp256k1::Error::InvalidMessage)?;
2025-11-09T23:19:32.1760195Z +
2025-11-09T23:19:32.1760399Z      // Hash the serialized data
2025-11-09T23:19:32.1760483Z -    use sha2::{Sha256, Digest};
2025-11-09T23:19:32.1760564Z +    use sha2::{Digest, Sha256};
2025-11-09T23:19:32.1760663Z      let hash = Sha256::digest(&serialized);
2025-11-09T23:19:32.1760732Z -    
2025-11-09T23:19:32.1760793Z +
2025-11-09T23:19:32.1760872Z      // Create message from hash
2025-11-09T23:19:32.1761022Z -    let message = Message::from_slice(&hash)
2025-11-09T23:19:32.1761225Z -        .map_err(|_| secp256k1::Error::InvalidMessage)?;
2025-11-09T23:19:32.1761341Z -    
2025-11-09T23:19:32.1761726Z +    let message = Message::from_slice(&hash).map_err(|_| secp256k1::Error::InvalidMessage)?;
2025-11-09T23:19:32.1761851Z +
2025-11-09T23:19:32.1761990Z      // Parse signature
2025-11-09T23:19:32.1762189Z -    let sig = Signature::from_compact(signature)
2025-11-09T23:19:32.1762406Z -        .map_err(|_| secp256k1::Error::InvalidSignature)?;
2025-11-09T23:19:32.1762533Z -    
2025-11-09T23:19:32.1762833Z +    let sig = Signature::from_compact(signature).map_err(|_| secp256k1::Error::InvalidSignature)?;
2025-11-09T23:19:32.1762900Z +
2025-11-09T23:19:32.1762975Z      // Verify
2025-11-09T23:19:32.1763115Z      Ok(secp.verify_ecdsa(&message, &sig, public_key).is_ok())
2025-11-09T23:19:32.1763180Z  }
2025-11-09T23:19:32.1763488Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_signing.rs:86:
2025-11-09T23:19:32.1763584Z      ) -> Result<Self, secp256k1::Error> {
2025-11-09T23:19:32.1763675Z          let secp = Secp256k1::new();
2025-11-09T23:19:32.1763846Z          let public_key = PublicKey::from_secret_key(&secp, private_key);
2025-11-09T23:19:32.1763913Z -        
2025-11-09T23:19:32.1763978Z +
2025-11-09T23:19:32.1764112Z          let signature = sign_ban_list(&ban_list, private_key)?;
2025-11-09T23:19:32.1764182Z -        
2025-11-09T23:19:32.1764264Z +
2025-11-09T23:19:32.1764681Z          Ok(Self {
2025-11-09T23:19:32.1764760Z              ban_list,
2025-11-09T23:19:32.1764840Z              signature,
2025-11-09T23:19:32.1765155Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_signing.rs:95:
2025-11-09T23:19:32.1765234Z              public_key,
2025-11-09T23:19:32.1765306Z          })
2025-11-09T23:19:32.1765374Z      }
2025-11-09T23:19:32.1765440Z -    
2025-11-09T23:19:32.1765513Z +
2025-11-09T23:19:32.1765594Z      /// Verify the signature
2025-11-09T23:19:32.1765739Z      pub fn verify(&self) -> Result<bool, secp256k1::Error> {
2025-11-09T23:19:32.1765943Z          verify_ban_list_signature(&self.ban_list, &self.signature, &self.public_key)
2025-11-09T23:19:32.1766254Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_signing.rs:102:
2025-11-09T23:19:32.1766319Z      }
2025-11-09T23:19:32.1766383Z  }
2025-11-09T23:19:32.1766453Z -
2025-11-09T23:19:32.1766518Z -
2025-11-09T23:19:32.1766584Z  
2025-11-09T23:19:32.1766879Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:4:
2025-11-09T23:19:32.1766978Z  //! using the BlockFilterService.
2025-11-09T23:19:32.1767043Z  
2025-11-09T23:19:32.1767185Z  use crate::network::filter_service::BlockFilterService;
2025-11-09T23:19:32.1767276Z -use crate::storage::Storage;
2025-11-09T23:19:32.1767369Z  use crate::network::protocol::{
2025-11-09T23:19:32.1767643Z      CfcheckptMessage, CfheadersMessage, CfilterMessage, FilterHeaderData, GetCfcheckptMessage,
2025-11-09T23:19:32.1767813Z      GetCfheadersMessage, GetCfiltersMessage, ProtocolMessage,
2025-11-09T23:19:32.1768314Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:11:
2025-11-09T23:19:32.1768427Z  };
2025-11-09T23:19:32.1768579Z +use crate::storage::Storage;
2025-11-09T23:19:32.1768681Z  use anyhow::{anyhow, Result};
2025-11-09T23:19:32.1768771Z  use bllvm_protocol::Hash;
2025-11-09T23:19:32.1768849Z  use std::sync::Arc;
2025-11-09T23:19:32.1769281Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:30:
2025-11-09T23:19:32.1769403Z          // Get current height to determine stop height
2025-11-09T23:19:32.1769586Z          let current_height = storage.chain().get_height()?.unwrap_or(0) as u32;
2025-11-09T23:19:32.1769694Z          let start_height = request.start_height;
2025-11-09T23:19:32.1769763Z -        
2025-11-09T23:19:32.1769827Z +
2025-11-09T23:19:32.1769989Z          // Find stop height by iterating from start until we find stop_hash
2025-11-09T23:19:32.1770089Z          let mut stop_height = start_height;
2025-11-09T23:19:32.1770174Z          let mut found_stop = false;
2025-11-09T23:19:32.1770460Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:37:
2025-11-09T23:19:32.1770532Z -        
2025-11-09T23:19:32.1770595Z +
2025-11-09T23:19:32.1770698Z          // Iterate through blocks from start_height
2025-11-09T23:19:32.1770884Z          for height in start_height..=current_height.min(start_height + 2000) {
2025-11-09T23:19:32.1770991Z              // Get block hash by height, then get block
2025-11-09T23:19:32.1772584Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:41:
2025-11-09T23:19:32.1772784Z              if let Ok(Some(block_hash)) = storage.blocks().get_hash_by_height(height as u64) {
2025-11-09T23:19:32.1772934Z                  if let Ok(Some(block)) = storage.blocks().get_block(&block_hash) {
2025-11-09T23:19:32.1773003Z -                
2025-11-09T23:19:32.1773106Z                      // Calculate block hash properly
2025-11-09T23:19:32.1773226Z                      use crate::storage::hashing::double_sha256;
2025-11-09T23:19:32.1773325Z                      let mut header_data = Vec::new();
2025-11-09T23:19:32.1773610Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:51:
2025-11-09T23:19:32.1773884Z                      header_data.extend_from_slice(&block.header.bits.to_le_bytes());
2025-11-09T23:19:32.1774058Z                      header_data.extend_from_slice(&block.header.nonce.to_le_bytes());
2025-11-09T23:19:32.1774190Z                      let calculated_hash = double_sha256(&header_data);
2025-11-09T23:19:32.1774263Z -                    
2025-11-09T23:19:32.1774461Z +
2025-11-09T23:19:32.1774558Z                      // Check if this is the stop hash
2025-11-09T23:19:32.1774672Z                      if calculated_hash == request.stop_hash {
2025-11-09T23:19:32.1774759Z                          found_stop = true;
2025-11-09T23:19:32.1775042Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:58:
2025-11-09T23:19:32.1775133Z                          stop_height = height;
2025-11-09T23:19:32.1775206Z                      }
2025-11-09T23:19:32.1775272Z -                    
2025-11-09T23:19:32.1775338Z +
2025-11-09T23:19:32.1775432Z                      // Try to get cached filter
2025-11-09T23:19:32.1775632Z                      let filter = if let Some(cached) = filter_service.get_filter(&calculated_hash) {
2025-11-09T23:19:32.1775709Z                          cached
2025-11-09T23:19:32.1775989Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:72:
2025-11-09T23:19:32.1776069Z                                  }
2025-11-09T23:19:32.1776141Z                              }
2025-11-09T23:19:32.1776211Z                          }
2025-11-09T23:19:32.1776286Z -                        
2025-11-09T23:19:32.1776351Z +
2025-11-09T23:19:32.1776553Z                          filter_service.generate_and_cache_filter(&block, &prev_scripts, height)?
2025-11-09T23:19:32.1776627Z                      };
2025-11-09T23:19:32.1776695Z -                    
2025-11-09T23:19:32.1776758Z +
2025-11-09T23:19:32.1776921Z                      responses.push(ProtocolMessage::Cfilter(CfilterMessage {
2025-11-09T23:19:32.1777017Z                          filter_type: 0,
2025-11-09T23:19:32.1777236Z                          block_hash: calculated_hash,
2025-11-09T23:19:32.1777521Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:82:
2025-11-09T23:19:32.1777626Z                          filter_data: filter.filter_data,
2025-11-09T23:19:32.1777728Z                          num_elements: filter.num_elements,
2025-11-09T23:19:32.1777800Z                      }));
2025-11-09T23:19:32.1777867Z -                    
2025-11-09T23:19:32.1777933Z +
2025-11-09T23:19:32.1778013Z                      if found_stop {
2025-11-09T23:19:32.1778085Z                          break;
2025-11-09T23:19:32.1778157Z                      }
2025-11-09T23:19:32.1778432Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:89:
2025-11-09T23:19:32.1778500Z                  }
2025-11-09T23:19:32.1778569Z              }
2025-11-09T23:19:32.1778640Z          }
2025-11-09T23:19:32.1778709Z -        
2025-11-09T23:19:32.1778772Z +
2025-11-09T23:19:32.1778894Z          if !found_stop && stop_height < current_height {
2025-11-09T23:19:32.1779044Z              // Stop hash not found in reasonable range, return what we have
2025-11-09T23:19:32.1779109Z          }
2025-11-09T23:19:32.1779386Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip70_handler.rs:3:
2025-11-09T23:19:32.1779528Z  //! Handles incoming BIP70 messages from the P2P network.
2025-11-09T23:19:32.1779628Z  //! Similar to bip157_handler.rs pattern.
2025-11-09T23:19:32.1779691Z  
2025-11-09T23:19:32.1780008Z -use bllvm_protocol::payment::{Bip70Error, PaymentProtocolClient, PaymentProtocolServer, PaymentRequest};
2025-11-09T23:19:32.1780101Z  use crate::network::protocol::{
2025-11-09T23:19:32.1780354Z      GetPaymentRequestMessage, PaymentACKMessage, PaymentMessage, PaymentRequestMessage,
2025-11-09T23:19:32.1780436Z      ProtocolMessage,
2025-11-09T23:19:32.1780719Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip70_handler.rs:10:
2025-11-09T23:19:32.1780913Z  };
2025-11-09T23:19:32.1780994Z  use anyhow::Result;
2025-11-09T23:19:32.1781082Z +use bllvm_protocol::payment::{
2025-11-09T23:19:32.1781290Z +    Bip70Error, PaymentProtocolClient, PaymentProtocolServer, PaymentRequest,
2025-11-09T23:19:32.1781357Z +};
2025-11-09T23:19:32.1781432Z +use hex;
2025-11-09T23:19:32.1781518Z  use std::collections::HashMap;
2025-11-09T23:19:32.1781602Z  use std::sync::{Arc, Mutex};
2025-11-09T23:19:32.1781673Z -use hex;
2025-11-09T23:19:32.1781737Z  
2025-11-09T23:19:32.1781986Z  /// In-memory payment request store (simplified - would use persistent storage in production)
2025-11-09T23:19:32.1782179Z  type PaymentRequestStore = Arc<Mutex<HashMap<String, PaymentRequest>>>;
2025-11-09T23:19:32.1782468Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip70_handler.rs:25:
2025-11-09T23:19:32.1782566Z  ) -> Result<PaymentRequestMessage> {
2025-11-09T23:19:32.1782664Z      if let Some(store) = payment_store {
2025-11-09T23:19:32.1782764Z          let store = store.lock().unwrap();
2025-11-09T23:19:32.1783015Z -        let key = format!("{}_{}", hex::encode(&request.payment_id), hex::encode(&request.merchant_pubkey));
2025-11-09T23:19:32.1783095Z +        let key = format!(
2025-11-09T23:19:32.1783167Z +            "{}_{}",
2025-11-09T23:19:32.1783269Z +            hex::encode(&request.payment_id),
2025-11-09T23:19:32.1783372Z +            hex::encode(&request.merchant_pubkey)
2025-11-09T23:19:32.1783452Z +        );
2025-11-09T23:19:32.1783572Z          if let Some(payment_request) = store.get(&key) {
2025-11-09T23:19:32.1783672Z              // Convert to P2P message format
2025-11-09T23:19:32.1783910Z              // Note: In production, merchant_signature would be generated by signing payment_request
2025-11-09T23:19:32.1784194Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip70_handler.rs:37:
2025-11-09T23:19:32.1784266Z              });
2025-11-09T23:19:32.1784459Z          }
2025-11-09T23:19:32.1784752Z      }
2025-11-09T23:19:32.1784832Z -    
2025-11-09T23:19:32.1784898Z +
2025-11-09T23:19:32.1785042Z      Err(anyhow::anyhow!("Payment request not found"))
2025-11-09T23:19:32.1785107Z  }
2025-11-09T23:19:32.1785172Z  
2025-11-09T23:19:32.1785465Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip70_handler.rs:58:
2025-11-09T23:19:32.1785539Z      } else {
2025-11-09T23:19:32.1785634Z          None
2025-11-09T23:19:32.1785751Z      };
2025-11-09T23:19:32.1785874Z -    
2025-11-09T23:19:32.1785989Z +
2025-11-09T23:19:32.1786170Z      if let Some(request) = original_request {
2025-11-09T23:19:32.1786343Z          // Use existing process_payment function
2025-11-09T23:19:32.1786591Z          use bllvm_protocol::payment::PaymentProtocolServer;
2025-11-09T23:19:32.1788445Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip70_handler.rs:65:
2025-11-09T23:19:32.1789042Z -        let payment_ack = PaymentProtocolServer::process_payment(&payment_msg.payment, &request, merchant_private_key)
2025-11-09T23:19:32.1789348Z -            .map_err(|e| anyhow::anyhow!("Payment processing failed: {:?}", e))?;
2025-11-09T23:19:32.1789461Z -        
2025-11-09T23:19:32.1789716Z +        let payment_ack = PaymentProtocolServer::process_payment(
2025-11-09T23:19:32.1789864Z +            &payment_msg.payment,
2025-11-09T23:19:32.1797625Z +            &request,
2025-11-09T23:19:32.1797820Z +            merchant_private_key,
2025-11-09T23:19:32.1797925Z +        )
2025-11-09T23:19:32.1798136Z +        .map_err(|e| anyhow::anyhow!("Payment processing failed: {:?}", e))?;
2025-11-09T23:19:32.1798206Z +
2025-11-09T23:19:32.1798305Z          // Convert to P2P message format
2025-11-09T23:19:32.1798398Z          Ok(PaymentACKMessage {
2025-11-09T23:19:32.1798480Z              payment_ack,
2025-11-09T23:19:32.1798792Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip70_handler.rs:79:
2025-11-09T23:19:32.1799141Z  /// Validate PaymentRequest message from P2P network
2025-11-09T23:19:32.1799418Z  pub fn validate_payment_request_message(msg: &PaymentRequestMessage) -> Result<(), Bip70Error> {
2025-11-09T23:19:32.1799569Z      use bllvm_protocol::payment::PaymentProtocolClient;
2025-11-09T23:19:32.1799868Z -    PaymentProtocolClient::validate_payment_request(&msg.payment_request, Some(&msg.merchant_pubkey))
2025-11-09T23:19:32.1799998Z +    PaymentProtocolClient::validate_payment_request(
2025-11-09T23:19:32.1800084Z +        &msg.payment_request,
2025-11-09T23:19:32.1800171Z +        Some(&msg.merchant_pubkey),
2025-11-09T23:19:32.1800237Z +    )
2025-11-09T23:19:32.1800306Z  }
2025-11-09T23:19:32.1800368Z  
2025-11-09T23:19:32.1800477Z  /// Validate PaymentACK message from merchant
2025-11-09T23:19:32.1800772Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip70_handler.rs:88:
2025-11-09T23:19:32.1800856Z      merchant_pubkey: &[u8],
2025-11-09T23:19:32.1800945Z  ) -> Result<(), Bip70Error> {
2025-11-09T23:19:32.1801311Z      use bllvm_protocol::payment::PaymentProtocolClient;
2025-11-09T23:19:32.1801629Z -    PaymentProtocolClient::validate_payment_ack(&ack.payment_ack, &ack.merchant_signature, merchant_pubkey)
2025-11-09T23:19:32.1801747Z +    PaymentProtocolClient::validate_payment_ack(
2025-11-09T23:19:32.1801826Z +        &ack.payment_ack,
2025-11-09T23:19:32.1801913Z +        &ack.merchant_signature,
2025-11-09T23:19:32.1801992Z +        merchant_pubkey,
2025-11-09T23:19:32.1802057Z +    )
2025-11-09T23:19:32.1802121Z  }
2025-11-09T23:19:32.1802188Z  
2025-11-09T23:19:32.1802552Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/chain_access.rs:3:
2025-11-09T23:19:32.1802729Z  //! Implements ChainStateAccess trait to bridge node storage modules
2025-11-09T23:19:32.1802945Z  //! (BlockStore, TxIndex, MempoolManager) with protocol layer network processing.
2025-11-09T23:19:32.1803016Z  
2025-11-09T23:19:32.1803123Z +use crate::node::mempool::MempoolManager;
2025-11-09T23:19:32.1803410Z +use crate::storage::{blockstore::BlockStore, txindex::TxIndex};
2025-11-09T23:19:32.1803494Z  use anyhow::Result;
2025-11-09T23:19:32.1803655Z  use bllvm_protocol::network::{ChainObject, ChainStateAccess};
2025-11-09T23:19:32.1803803Z  use bllvm_protocol::{Block, BlockHeader, Hash, Transaction};
2025-11-09T23:19:32.1804086Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/chain_access.rs:9:
2025-11-09T23:19:32.1804191Z -use crate::node::mempool::MempoolManager;
2025-11-09T23:19:32.1804619Z -use crate::storage::{blockstore::BlockStore, txindex::TxIndex};
2025-11-09T23:19:32.1804733Z  use std::sync::Arc;
2025-11-09T23:19:32.1804801Z  
2025-11-09T23:19:32.1805017Z  /// Chain state access implementation that bridges node storage to protocol layer
2025-11-09T23:19:32.1805314Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/chain_access.rs:68:
2025-11-09T23:19:32.1805451Z      /// This implements the Bitcoin block locator algorithm
2025-11-09T23:19:32.1805674Z      fn get_headers_for_locator(&self, locator: &[Hash], stop: &Hash) -> Vec<BlockHeader> {
2025-11-09T23:19:32.1805768Z          let mut headers = Vec::new();
2025-11-09T23:19:32.1805842Z -        
2025-11-09T23:19:32.1805905Z +
2025-11-09T23:19:32.1805999Z          // Bitcoin block locator algorithm:
2025-11-09T23:19:32.1806109Z          // 1. Start with the most recent block hash
2025-11-09T23:19:32.1806292Z          // 2. Go back exponentially (1, 2, 4, 8, 16, ...) until we find a common ancestor
2025-11-09T23:19:32.1806577Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/chain_access.rs:75:
2025-11-09T23:19:32.1806717Z          // 3. Stop when we reach the stop hash or run out of hashes
2025-11-09T23:19:32.1806785Z -        
2025-11-09T23:19:32.1806848Z +
2025-11-09T23:19:32.1806930Z          for hash in locator {
2025-11-09T23:19:32.1807035Z              // If we've reached the stop hash, stop
2025-11-09T23:19:32.1807283Z              if hash == stop {
2025-11-09T23:19:32.1807564Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/chain_access.rs:80:
2025-11-09T23:19:32.1807638Z                  break;
2025-11-09T23:19:32.1807706Z              }
2025-11-09T23:19:32.1807770Z -            
2025-11-09T23:19:32.1807832Z +
2025-11-09T23:19:32.1807921Z              // Try to get the header
2025-11-09T23:19:32.1808067Z              if let Ok(Some(header)) = self.blockstore.get_header(hash) {
2025-11-09T23:19:32.1808154Z                  headers.push(header);
2025-11-09T23:19:32.1808423Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/chain_access.rs:89:
2025-11-09T23:19:32.1808496Z                  continue;
2025-11-09T23:19:32.1808560Z              }
2025-11-09T23:19:32.1808624Z          }
2025-11-09T23:19:32.1808691Z -        
2025-11-09T23:19:32.1808754Z +
2025-11-09T23:19:32.1808820Z          headers
2025-11-09T23:19:32.1808893Z      }
2025-11-09T23:19:32.1808956Z  
2025-11-09T23:19:32.1809233Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/chain_access.rs:130:
2025-11-09T23:19:32.1809319Z      height: Option<u64>,
2025-11-09T23:19:32.1809461Z  ) -> Result<bllvm_protocol::network::NetworkResponse> {
2025-11-09T23:19:32.1809655Z      use bllvm_protocol::network::{process_network_message, ChainStateAccess};
2025-11-09T23:19:32.1809720Z -    
2025-11-09T23:19:32.1809786Z +
2025-11-09T23:19:32.1809873Z      process_network_message(
2025-11-09T23:19:32.1809939Z          engine,
2025-11-09T23:19:32.1810009Z          message,
2025-11-09T23:19:32.1810292Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/chain_access.rs:138:
2025-11-09T23:19:32.1810404Z          Some(chain_access as &dyn ChainStateAccess),
2025-11-09T23:19:32.1810473Z          utxo_set,
2025-11-09T23:19:32.1810542Z          height,
2025-11-09T23:19:32.1810713Z -    ).map_err(|e| anyhow::anyhow!("Network message processing error: {}", e))
2025-11-09T23:19:32.1810783Z +    )
2025-11-09T23:19:32.1811074Z +    .map_err(|e| anyhow::anyhow!("Network message processing error: {}", e))
2025-11-09T23:19:32.1811144Z  }
2025-11-09T23:19:32.1811207Z -
2025-11-09T23:19:32.1812782Z  
2025-11-09T23:19:32.1813133Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dns_seeds.rs:38:
2025-11-09T23:19:32.1813219Z      max_addresses: usize,
2025-11-09T23:19:32.1813303Z  ) -> Vec<NetworkAddress> {
2025-11-09T23:19:32.1813393Z      let mut addresses = Vec::new();
2025-11-09T23:19:32.1813459Z -    
2025-11-09T23:19:32.1813528Z +
2025-11-09T23:19:32.1813603Z      for seed in seeds {
2025-11-09T23:19:32.1813713Z          match resolve_dns_seed(*seed, port).await {
2025-11-09T23:19:32.1813796Z              Ok(mut addrs) => {
2025-11-09T23:19:32.1814057Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dns_seeds.rs:53:
2025-11-09T23:19:32.1814125Z              }
2025-11-09T23:19:32.1814193Z          }
2025-11-09T23:19:32.1814263Z      }
2025-11-09T23:19:32.1814457Z -    
2025-11-09T23:19:32.1814522Z +
2025-11-09T23:19:32.1814612Z      // Limit to max_addresses
2025-11-09T23:19:32.1814707Z      addresses.truncate(max_addresses);
2025-11-09T23:19:32.1814776Z      addresses
2025-11-09T23:19:32.1815030Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dns_seeds.rs:63:
2025-11-09T23:19:32.1815248Z  async fn resolve_dns_seed(seed: &str, port: u16) -> Result<Vec<NetworkAddress>, String> {
2025-11-09T23:19:32.1815357Z      // Create hostname:port string for DNS lookup
2025-11-09T23:19:32.1815459Z      let hostname = format!("{}:{}", seed, port);
2025-11-09T23:19:32.1815530Z -    
2025-11-09T23:19:32.1815591Z +
2025-11-09T23:19:32.1815678Z      // Perform DNS lookup with timeout
2025-11-09T23:19:32.1815773Z      let timeout = Duration::from_secs(5);
2025-11-09T23:19:32.1815960Z      let lookup_result = tokio::time::timeout(timeout, lookup_host(&hostname))
2025-11-09T23:19:32.1816355Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dns_seeds.rs:70:
2025-11-09T23:19:32.1816423Z          .await
2025-11-09T23:19:32.1816564Z          .map_err(|_| format!("DNS lookup timeout for {}", seed))?;
2025-11-09T23:19:32.1816626Z -    
2025-11-09T23:19:32.1816715Z -    let socket_addrs = lookup_result
2025-11-09T23:19:32.1816862Z -        .map_err(|e| format!("DNS lookup failed for {}: {}", seed, e))?;
2025-11-09T23:19:32.1816924Z -    
2025-11-09T23:19:32.1816985Z +
2025-11-09T23:19:32.1817068Z +    let socket_addrs =
2025-11-09T23:19:32.1817254Z +        lookup_result.map_err(|e| format!("DNS lookup failed for {}: {}", seed, e))?;
2025-11-09T23:19:32.1817317Z +
2025-11-09T23:19:32.1817416Z      // Convert SocketAddr to NetworkAddress
2025-11-09T23:19:32.1817510Z      let mut addresses = Vec::new();
2025-11-09T23:19:32.1817596Z      for socket_addr in socket_addrs {
2025-11-09T23:19:32.1818285Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dns_seeds.rs:79:
2025-11-09T23:19:32.1818462Z          addresses.push(socket_addr_to_network_address(socket_addr));
2025-11-09T23:19:32.1818528Z      }
2025-11-09T23:19:32.1818593Z -    
2025-11-09T23:19:32.1820539Z +
2025-11-09T23:19:32.1820671Z      Ok(addresses)
2025-11-09T23:19:32.1820788Z  }
2025-11-09T23:19:32.1820899Z  
2025-11-09T23:19:32.1821370Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dns_seeds.rs:85:
2025-11-09T23:19:32.1821550Z  /// Convert SocketAddr to NetworkAddress
2025-11-09T23:19:32.1821906Z  fn socket_addr_to_network_address(socket_addr: SocketAddr) -> NetworkAddress {
2025-11-09T23:19:32.1822072Z      use std::net::IpAddr;
2025-11-09T23:19:32.1822178Z -    
2025-11-09T23:19:32.1822243Z +
2025-11-09T23:19:32.1822342Z      let ip_bytes = match socket_addr.ip() {
2025-11-09T23:19:32.1822433Z          IpAddr::V4(ipv4) => {
2025-11-09T23:19:32.1822522Z              // IPv4-mapped IPv6 format
2025-11-09T23:19:32.1822966Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dns_seeds.rs:95:
2025-11-09T23:19:32.1823092Z              bytes[12..16].copy_from_slice(&ipv4.octets());
2025-11-09T23:19:32.1823168Z              bytes
2025-11-09T23:19:32.1823232Z          }
2025-11-09T23:19:32.1823317Z -        IpAddr::V6(ipv6) => {
2025-11-09T23:19:32.1823400Z -            ipv6.octets()
2025-11-09T23:19:32.1823472Z -        }
2025-11-09T23:19:32.1823566Z +        IpAddr::V6(ipv6) => ipv6.octets(),
2025-11-09T23:19:32.1823632Z      };
2025-11-09T23:19:32.1823701Z -    
2025-11-09T23:19:32.1823764Z +
2025-11-09T23:19:32.1823841Z      NetworkAddress {
2025-11-09T23:19:32.1823964Z          services: 0, // Will be updated when we connect
2025-11-09T23:19:32.1824037Z          ip: ip_bytes,
2025-11-09T23:19:32.1824522Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dns_seeds.rs:125:
2025-11-09T23:19:32.1824613Z          assert_eq!(addr.ip[15], 1);
2025-11-09T23:19:32.1824686Z      }
2025-11-09T23:19:32.1824751Z  }
2025-11-09T23:19:32.1824814Z -
2025-11-09T23:19:32.1824889Z  
2025-11-09T23:19:32.1825168Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:9:
2025-11-09T23:19:32.1825246Z  use std::sync::Arc;
2025-11-09T23:19:32.1825343Z  use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:19:32.1825427Z  use tokio::sync::Mutex;
2025-11-09T23:19:32.1825521Z -use tracing::{debug, warn, error};
2025-11-09T23:19:32.1825606Z +use tracing::{debug, error, warn};
2025-11-09T23:19:32.1825674Z  
2025-11-09T23:19:32.1825856Z  /// Connection rate limiter (tracks connection attempts per time window)
2025-11-09T23:19:32.1825947Z  pub struct ConnectionRateLimiter {
2025-11-09T23:19:32.1826238Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:40:
2025-11-09T23:19:32.1826307Z  
2025-11-09T23:19:32.1826421Z          // Clean up old entries outside the time window
2025-11-09T23:19:32.1826686Z          let cutoff = now.saturating_sub(self.window_seconds);
2025-11-09T23:19:32.1826762Z -        
2025-11-09T23:19:32.1826830Z +
2025-11-09T23:19:32.1827034Z          let attempts = self.connection_attempts.entry(ip).or_insert_with(Vec::new);
2025-11-09T23:19:32.1827162Z          attempts.retain(|&timestamp| timestamp > cutoff);
2025-11-09T23:19:32.1827225Z  
2025-11-09T23:19:32.1827504Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:47:
2025-11-09T23:19:32.1827595Z          // Check if we're within the limit
2025-11-09T23:19:32.1827731Z          if attempts.len() >= self.max_connections_per_window {
2025-11-09T23:19:32.1827930Z -            warn!("Connection rate limit exceeded for IP {}: {} attempts in {} seconds", 
2025-11-09T23:19:32.1828039Z -                  ip, attempts.len(), self.window_seconds);
2025-11-09T23:19:32.1828115Z +            warn!(
2025-11-09T23:19:32.1828292Z +                "Connection rate limit exceeded for IP {}: {} attempts in {} seconds",
2025-11-09T23:19:32.1828367Z +                ip,
2025-11-09T23:19:32.1828459Z +                attempts.len(),
2025-11-09T23:19:32.1828539Z +                self.window_seconds
2025-11-09T23:19:32.1828605Z +            );
2025-11-09T23:19:32.1828674Z              false
2025-11-09T23:19:32.1828746Z          } else {
2025-11-09T23:19:32.1828840Z              // Record this connection attempt
2025-11-09T23:19:32.1829120Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:72:
2025-11-09T23:19:32.1829191Z  
2025-11-09T23:19:32.1830906Z      /// Get current connection attempt count for an IP
2025-11-09T23:19:32.1831032Z      pub fn get_attempt_count(&self, ip: IpAddr) -> usize {
2025-11-09T23:19:32.1831200Z -        self.connection_attempts.get(&ip).map(|v| v.len()).unwrap_or(0)
2025-11-09T23:19:32.1831291Z +        self.connection_attempts
2025-11-09T23:19:32.1831363Z +            .get(&ip)
2025-11-09T23:19:32.1831441Z +            .map(|v| v.len())
2025-11-09T23:19:32.1831529Z +            .unwrap_or(0)
2025-11-09T23:19:32.1831594Z      }
2025-11-09T23:19:32.1831783Z  }
2025-11-09T23:19:32.1831852Z  
2025-11-09T23:19:32.1832146Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:171:
2025-11-09T23:19:32.1832236Z      /// Create with default settings
2025-11-09T23:19:32.1832320Z      pub fn default() -> Self {
2025-11-09T23:19:32.1832398Z          Self::new(
2025-11-09T23:19:32.1832510Z -            10,   // Max 10 connections per IP per window
2025-11-09T23:19:32.1832591Z -            60,   // 60 second window
2025-11-09T23:19:32.1832695Z +            10,    // Max 10 connections per IP per window
2025-11-09T23:19:32.1832777Z +            60,    // 60 second window
2025-11-09T23:19:32.1832865Z              10000, // Max 10k messages in queue
2025-11-09T23:19:32.1832950Z -            200,  // Max 200 active connections
2025-11-09T23:19:32.1833045Z +            200,   // Max 200 active connections
2025-11-09T23:19:32.1833116Z          )
2025-11-09T23:19:32.1833179Z      }
2025-11-09T23:19:32.1833254Z  
2025-11-09T23:19:32.1833535Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:194:
2025-11-09T23:19:32.1833643Z              metrics.connection_rate_violations += 1;
2025-11-09T23:19:32.1833705Z  
2025-11-09T23:19:32.1833828Z              if *count >= self.auto_ban_connection_violations {
2025-11-09T23:19:32.1834038Z -                warn!("Auto-banning IP {} for repeated connection rate violations ({} violations)", 
2025-11-09T23:19:32.1834116Z -                      ip, *count);
2025-11-09T23:19:32.1834192Z +                warn!(
2025-11-09T23:19:32.1834641Z +                    "Auto-banning IP {} for repeated connection rate violations ({} violations)",
2025-11-09T23:19:32.1834728Z +                    ip, *count
2025-11-09T23:19:32.1834794Z +                );
2025-11-09T23:19:32.1834902Z                  metrics.auto_bans_applied += 1;
2025-11-09T23:19:32.1835171Z                  // Return false to reject, caller should ban
2025-11-09T23:19:32.1835254Z                  return false;
2025-11-09T23:19:32.1835568Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:212:
2025-11-09T23:19:32.1835665Z      /// Check if message queue is within limits
2025-11-09T23:19:32.1835856Z      pub async fn check_message_queue_size(&self, current_size: usize) -> bool {
2025-11-09T23:19:32.1835977Z          if current_size > self.max_message_queue_size {
2025-11-09T23:19:32.1836189Z -            warn!("Message queue size exceeded: {} > {}", current_size, self.max_message_queue_size);
2025-11-09T23:19:32.1836257Z +            warn!(
2025-11-09T23:19:32.1836353Z +                "Message queue size exceeded: {} > {}",
2025-11-09T23:19:32.1836462Z +                current_size, self.max_message_queue_size
2025-11-09T23:19:32.1836530Z +            );
2025-11-09T23:19:32.1836643Z              let mut metrics = self.metrics.lock().await;
2025-11-09T23:19:32.1836754Z              metrics.message_queue_overflows += 1;
2025-11-09T23:19:32.1836827Z              false
2025-11-09T23:19:32.1837113Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:224:
2025-11-09T23:19:32.1837215Z      /// Check if we can accept more connections
2025-11-09T23:19:32.1837402Z      pub async fn check_active_connections(&self, current_count: usize) -> bool {
2025-11-09T23:19:32.1837518Z          if current_count >= self.max_active_connections {
2025-11-09T23:19:32.1837763Z -            warn!("Active connection limit exceeded: {} >= {}", current_count, self.max_active_connections);
2025-11-09T23:19:32.1837839Z +            warn!(
2025-11-09T23:19:32.1837951Z +                "Active connection limit exceeded: {} >= {}",
2025-11-09T23:19:32.1838057Z +                current_count, self.max_active_connections
2025-11-09T23:19:32.1838129Z +            );
2025-11-09T23:19:32.1838236Z              let mut metrics = self.metrics.lock().await;
2025-11-09T23:19:32.1838489Z              metrics.active_connection_limit_hits += 1;
2025-11-09T23:19:32.1838569Z              false
2025-11-09T23:19:32.1838859Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:262:
2025-11-09T23:19:32.1838965Z      /// Check if we're under DoS attack (heuristic)
2025-11-09T23:19:32.1839074Z      pub async fn detect_dos_attack(&self) -> bool {
2025-11-09T23:19:32.1841093Z          let metrics = self.resource_metrics.lock().await;
2025-11-09T23:19:32.1841163Z -        
2025-11-09T23:19:32.1841230Z +
2025-11-09T23:19:32.1841418Z          // Heuristic: If message queue is > 80% full and connections are > 80% of max
2025-11-09T23:19:32.1841599Z          let queue_threshold = (self.max_message_queue_size as f64 * 0.8) as usize;
2025-11-09T23:19:32.1841770Z          let conn_threshold = (self.max_active_connections as f64 * 0.8) as usize;
2025-11-09T23:19:32.1842062Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:269:
2025-11-09T23:19:32.1842130Z  
2025-11-09T23:19:32.1842250Z -        metrics.message_queue_size > queue_threshold 
2025-11-09T23:19:32.1842359Z -            && metrics.active_connections > conn_threshold
2025-11-09T23:19:32.1842605Z +        metrics.message_queue_size > queue_threshold && metrics.active_connections > conn_threshold
2025-11-09T23:19:32.1842671Z      }
2025-11-09T23:19:32.1842735Z  
2025-11-09T23:19:32.1842845Z      /// Cleanup old connection rate limiter entries
2025-11-09T23:19:32.1843128Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:368:
2025-11-09T23:19:32.1843222Z          assert!(dos.should_auto_ban(ip).await);
2025-11-09T23:19:32.1843292Z      }
2025-11-09T23:19:32.1843355Z  }
2025-11-09T23:19:32.1843415Z -
2025-11-09T23:19:32.1843478Z  
2025-11-09T23:19:32.1843789Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/filter_service.rs:3:
2025-11-09T23:19:32.1844095Z  //! Generates, caches, and serves compact block filters for light client support.
2025-11-09T23:19:32.1844245Z  //! Maintains filter header chain for efficient verification.
2025-11-09T23:19:32.1844439Z  
2025-11-09T23:19:32.1844536Z +use anyhow::{anyhow, Result};
2025-11-09T23:19:32.1844624Z  use bllvm_protocol::bip157;
2025-11-09T23:19:32.1844806Z  use bllvm_protocol::bip158::{build_block_filter, CompactBlockFilter};
2025-11-09T23:19:32.1844898Z -use anyhow::{anyhow, Result};
2025-11-09T23:19:32.1845050Z  use bllvm_protocol::{Block, BlockHeader, Hash, Transaction};
2025-11-09T23:19:32.1845140Z  use std::collections::HashMap;
2025-11-09T23:19:32.1845224Z  use std::sync::{Arc, RwLock};
2025-11-09T23:19:32.1845517Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/filter_service.rs:211:
2025-11-09T23:19:32.1845718Z      pub fn remove_filter_for_pruned_block(&self, block_hash: &Hash) -> Result<()> {
2025-11-09T23:19:32.1845803Z          // Remove filter from cache
2025-11-09T23:19:32.1845940Z          self.filters.write().unwrap().remove(block_hash);
2025-11-09T23:19:32.1846010Z -        
2025-11-09T23:19:32.1846074Z +
2025-11-09T23:19:32.1846256Z          // Note: We do NOT remove the filter header - it's required for verification
2025-11-09T23:19:32.1846407Z          // The filter header chain must remain intact even after pruning
2025-11-09T23:19:32.1846472Z -        
2025-11-09T23:19:32.1846535Z +
2025-11-09T23:19:32.1846606Z          Ok(())
2025-11-09T23:19:32.1846670Z      }
2025-11-09T23:19:32.1846732Z  
2025-11-09T23:19:32.1856044Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/message_bridge.rs:80:
2025-11-09T23:19:32.1856302Z      /// 3. Convert the `NetworkResponse` to wire format messages using `extract_send_messages()`
2025-11-09T23:19:32.1856372Z      ///
2025-11-09T23:19:32.1856558Z      /// For now, this method only handles message conversion, not processing.
2025-11-09T23:19:32.1856656Z -    pub fn process_incoming_message(
2025-11-09T23:19:32.1856742Z -        data: &[u8],
2025-11-09T23:19:32.1856997Z -        transport: TransportType,
2025-11-09T23:19:32.1857098Z -    ) -> Result<Vec<Vec<u8>>> {
2025-11-09T23:19:32.1857359Z +    pub fn process_incoming_message(data: &[u8], transport: TransportType) -> Result<Vec<Vec<u8>>> {
2025-11-09T23:19:32.1857450Z          // Convert to protocol message
2025-11-09T23:19:32.1857636Z          let protocol_msg = Self::from_transport_message(data, transport)?;
2025-11-09T23:19:32.1857700Z  
2025-11-09T23:19:32.2649450Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:4:
2025-11-09T23:19:32.2654752Z  //! message handling for communication with other Bitcoin nodes.
2025-11-09T23:19:32.2654894Z  
2025-11-09T23:19:32.2655041Z  pub mod address_db;
2025-11-09T23:19:32.2655201Z +pub mod ban_list_merging;
2025-11-09T23:19:32.2655353Z +pub mod ban_list_signing;
2025-11-09T23:19:32.2655498Z  pub mod chain_access;
2025-11-09T23:19:32.2655627Z  pub mod dns_seeds;
2025-11-09T23:19:32.2655818Z +pub mod dos_protection;
2025-11-09T23:19:32.2655961Z  pub mod inventory;
2025-11-09T23:19:32.2656099Z  pub mod message_bridge;
2025-11-09T23:19:32.2656225Z  pub mod peer;
2025-11-09T23:19:32.2656690Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:12:
2025-11-09T23:19:32.2656826Z  pub mod protocol;
2025-11-09T23:19:32.2656973Z  pub mod protocol_adapter;
2025-11-09T23:19:32.2657128Z  pub mod protocol_extensions;
2025-11-09T23:19:32.2657267Z -pub mod ban_list_merging;
2025-11-09T23:19:32.2657407Z -pub mod ban_list_signing;
2025-11-09T23:19:32.2657551Z -pub mod dos_protection;
2025-11-09T23:19:32.2657674Z  pub mod relay;
2025-11-09T23:19:32.2657810Z  pub mod tcp_transport;
2025-11-09T23:19:32.2657942Z  pub mod transport;
2025-11-09T23:19:32.2658389Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:40:
2025-11-09T23:19:32.2658584Z  // Payment Protocol (BIP70) - P2P handlers
2025-11-09T23:19:32.2659089Z  pub mod bip70_handler;
2025-11-09T23:19:32.2659210Z  
2025-11-09T23:19:32.2659320Z -
2025-11-09T23:19:32.2659495Z  // Privacy and Performance Enhancements
2025-11-09T23:19:32.2659644Z  #[cfg(feature = "dandelion")]
2025-11-09T23:19:32.2659977Z  pub mod dandelion; // Dandelion++ privacy-preserving transaction relay
2025-11-09T23:19:32.2660419Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:50:
2025-11-09T23:19:32.2660658Z  pub mod txhash; // Non-consensus hashing helpers for relay
2025-11-09T23:19:32.2660776Z  
2025-11-09T23:19:32.2661101Z  use crate::network::protocol::{ProtocolMessage, ProtocolParser};
2025-11-09T23:19:32.2661279Z +use crate::node::mempool::MempoolManager;
2025-11-09T23:19:32.2661433Z +use crate::storage::Storage;
2025-11-09T23:19:32.2661565Z  use anyhow::Result;
2025-11-09T23:19:32.2661729Z  use bllvm_protocol::mempool::Mempool;
2025-11-09T23:19:32.2662057Z  use bllvm_protocol::{BitcoinProtocolEngine, ConsensusProof, UtxoSet};
2025-11-09T23:19:32.2662513Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:58:
2025-11-09T23:19:32.2662657Z  use std::sync::{Arc, Mutex};
2025-11-09T23:19:32.2662799Z  use tokio::sync::mpsc;
2025-11-09T23:19:32.2662960Z  use tracing::{error, info, warn};
2025-11-09T23:19:32.2663102Z -use crate::storage::Storage;
2025-11-09T23:19:32.2663280Z -use crate::node::mempool::MempoolManager;
2025-11-09T23:19:32.2663394Z  
2025-11-09T23:19:32.2663603Z  use crate::network::tcp_transport::TcpTransport;
2025-11-09T23:19:32.2663757Z  use crate::network::transport::{
2025-11-09T23:19:32.2664185Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:86:
2025-11-09T23:19:32.2664502Z  }
2025-11-09T23:19:32.2664624Z  
2025-11-09T23:19:32.2664815Z  /// Peer manager for tracking connected peers
2025-11-09T23:19:32.2664936Z -/// 
2025-11-09T23:19:32.2665048Z +///
2025-11-09T23:19:32.2665397Z  /// Uses TransportAddr as key to support all transport types (TCP, Quinn, Iroh).
2025-11-09T23:19:32.2665944Z  /// This allows proper peer identification for Iroh (NodeId) while maintaining
2025-11-09T23:19:32.2666140Z  /// compatibility with TCP/Quinn (SocketAddr).
2025-11-09T23:19:32.2666579Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:130:
2025-11-09T23:19:32.2666800Z      pub fn peer_addresses(&self) -> Vec<TransportAddr> {
2025-11-09T23:19:32.2666976Z          self.peers.keys().cloned().collect()
2025-11-09T23:19:32.2667090Z      }
2025-11-09T23:19:32.2667200Z -    
2025-11-09T23:19:32.2667310Z +
2025-11-09T23:19:32.2667596Z      /// Get peer addresses as SocketAddr (for backward compatibility)
2025-11-09T23:19:32.2667874Z      /// Only returns SocketAddr for TCP/Quinn peers, skips Iroh peers
2025-11-09T23:19:32.2668101Z      pub fn peer_socket_addresses(&self) -> Vec<SocketAddr> {
2025-11-09T23:19:32.2668554Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:137:
2025-11-09T23:19:32.2668696Z -        self.peers.keys()
2025-11-09T23:19:32.2668826Z +        self.peers
2025-11-09T23:19:32.2668959Z +            .keys()
2025-11-09T23:19:32.2669103Z              .filter_map(|addr| {
2025-11-09T23:19:32.2669233Z                  match addr {
2025-11-09T23:19:32.2669426Z                      TransportAddr::Tcp(sock) => Some(*sock),
2025-11-09T23:19:32.2669871Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:150:
2025-11-09T23:19:32.2670041Z      pub fn can_accept_peer(&self) -> bool {
2025-11-09T23:19:32.2670204Z          self.peers.len() < self.max_peers
2025-11-09T23:19:32.2670326Z      }
2025-11-09T23:19:32.2670439Z -    
2025-11-09T23:19:32.2670902Z +
2025-11-09T23:19:32.2671085Z      /// Select best peers based on quality score
2025-11-09T23:19:32.2671211Z -    /// 
2025-11-09T23:19:32.2671324Z +    ///
2025-11-09T23:19:32.2671561Z      /// Returns peers sorted by quality score (highest first)
2025-11-09T23:19:32.2671857Z      pub fn select_best_peers(&self, count: usize) -> Vec<TransportAddr> {
2025-11-09T23:19:32.2672225Z -        let mut peers: Vec<_> = self.peers.iter()
2025-11-09T23:19:32.2672376Z +        let mut peers: Vec<_> = self
2025-11-09T23:19:32.2672497Z +            .peers
2025-11-09T23:19:32.2672646Z +            .iter()
2025-11-09T23:19:32.2672858Z              .map(|(addr, peer)| (addr.clone(), peer.quality_score()))
2025-11-09T23:19:32.2672976Z              .collect();
2025-11-09T23:19:32.2673092Z -        
2025-11-09T23:19:32.2673192Z +
2025-11-09T23:19:32.2673337Z          // Sort by quality score (descending)
2025-11-09T23:19:32.2673662Z          peers.sort_by(|a, b| b.1.partial_cmp(&a.1).unwrap_or(std::cmp::Ordering::Equal));
2025-11-09T23:19:32.2673768Z -        
2025-11-09T23:19:32.2673875Z +
2025-11-09T23:19:32.2674009Z          // Return top N addresses
2025-11-09T23:19:32.2674138Z -        peers.into_iter()
2025-11-09T23:19:32.2674250Z +        peers
2025-11-09T23:19:32.2674519Z +            .into_iter()
2025-11-09T23:19:32.2674646Z              .take(count)
2025-11-09T23:19:32.2674783Z              .map(|(addr, _)| addr)
2025-11-09T23:19:32.2674902Z              .collect()
2025-11-09T23:19:32.2675317Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:170:
2025-11-09T23:19:32.2675427Z      }
2025-11-09T23:19:32.2675529Z -    
2025-11-09T23:19:32.2675629Z +
2025-11-09T23:19:32.2675776Z      /// Select reliable peers only
2025-11-09T23:19:32.2675879Z -    /// 
2025-11-09T23:19:32.2675978Z +    ///
2025-11-09T23:19:32.2676166Z      /// Returns peers that meet reliability criteria
2025-11-09T23:19:32.2676404Z      pub fn select_reliable_peers(&self) -> Vec<TransportAddr> {
2025-11-09T23:19:32.2676531Z -        self.peers.iter()
2025-11-09T23:19:32.2676643Z +        self.peers
2025-11-09T23:19:32.2676757Z +            .iter()
2025-11-09T23:19:32.2677127Z              .filter(|(_, peer)| peer.quality_score() > 0.5) // Use quality_score as reliability indicator
2025-11-09T23:19:32.2677271Z              .map(|(addr, _)| addr.clone())
2025-11-09T23:19:32.2677385Z              .collect()
2025-11-09T23:19:32.2677994Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:180:
2025-11-09T23:19:32.2678102Z      }
2025-11-09T23:19:32.2678198Z -    
2025-11-09T23:19:32.2678300Z +
2025-11-09T23:19:32.2678438Z      /// Get peer quality statistics
2025-11-09T23:19:32.2678649Z      pub fn get_quality_stats(&self) -> (usize, usize, f64) {
2025-11-09T23:19:32.2678799Z          let total = self.peers.len();
2025-11-09T23:19:32.2679221Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:185:
2025-11-09T23:19:32.2679376Z -        let reliable = self.peers.values()
2025-11-09T23:19:32.2679501Z +        let reliable = self
2025-11-09T23:19:32.2679617Z +            .peers
2025-11-09T23:19:32.2679728Z +            .values()
2025-11-09T23:19:32.2680073Z              .filter(|peer| peer.quality_score() > 0.5) // Use quality_score as reliability indicator
2025-11-09T23:19:32.2680199Z              .count();
2025-11-09T23:19:32.2680336Z          let avg_quality = if total > 0 {
2025-11-09T23:19:32.2680749Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:189:
2025-11-09T23:19:32.2680882Z -            self.peers.values()
2025-11-09T23:19:32.2681001Z +            self.peers
2025-11-09T23:19:32.2681119Z +                .values()
2025-11-09T23:19:32.2681277Z                  .map(|peer| peer.quality_score())
2025-11-09T23:19:32.2681436Z -                .sum::<f64>() / total as f64
2025-11-09T23:19:32.2681568Z +                .sum::<f64>()
2025-11-09T23:19:32.2681688Z +                / total as f64
2025-11-09T23:19:32.2681797Z          } else {
2025-11-09T23:19:32.2681913Z              0.0
2025-11-09T23:19:32.2682020Z          };
2025-11-09T23:19:32.2682441Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:195:
2025-11-09T23:19:32.2682564Z -        
2025-11-09T23:19:32.2682674Z +
2025-11-09T23:19:32.2683004Z          (total, reliable, avg_quality)
2025-11-09T23:19:32.2683115Z      }
2025-11-09T23:19:32.2683237Z -    
2025-11-09T23:19:32.2683345Z +
2025-11-09T23:19:32.2683577Z      /// Find peer by SocketAddr (tries TCP and Quinn variants)
2025-11-09T23:19:32.2683739Z      /// Returns the TransportAddr if found
2025-11-09T23:19:32.2684111Z      pub fn find_transport_addr_by_socket(&self, addr: SocketAddr) -> Option<TransportAddr> {
2025-11-09T23:19:32.2684671Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:204:
2025-11-09T23:19:32.2684845Z          if self.peers.contains_key(&tcp_addr) {
2025-11-09T23:19:32.2684977Z              return Some(tcp_addr);
2025-11-09T23:19:32.2685088Z          }
2025-11-09T23:19:32.2685198Z -        
2025-11-09T23:19:32.2685313Z +
2025-11-09T23:19:32.2685429Z          // Try Quinn
2025-11-09T23:19:32.2685562Z          #[cfg(feature = "quinn")]
2025-11-09T23:19:32.2685672Z          {
2025-11-09T23:19:32.2686120Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:213:
2025-11-09T23:19:32.2686293Z                  return Some(quinn_addr);
2025-11-09T23:19:32.2686411Z              }
2025-11-09T23:19:32.2686532Z          }
2025-11-09T23:19:32.2686644Z -        
2025-11-09T23:19:32.2686756Z +
2025-11-09T23:19:32.2686873Z          None
2025-11-09T23:19:32.2686992Z      }
2025-11-09T23:19:32.2687100Z  }
2025-11-09T23:19:32.2687525Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:245:
2025-11-09T23:19:32.2687670Z              last_refill: now,
2025-11-09T23:19:32.2687783Z          }
2025-11-09T23:19:32.2687894Z      }
2025-11-09T23:19:32.2688003Z -    
2025-11-09T23:19:32.2688112Z +
2025-11-09T23:19:32.2688334Z      /// Check if a message can be consumed and consume a token
2025-11-09T23:19:32.2688527Z      pub fn check_and_consume(&mut self) -> bool {
2025-11-09T23:19:32.2688663Z          self.refill();
2025-11-09T23:19:32.2689110Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:256:
2025-11-09T23:19:32.2689239Z              false
2025-11-09T23:19:32.2689576Z          }
2025-11-09T23:19:32.2689708Z      }
2025-11-09T23:19:32.2689821Z -    
2025-11-09T23:19:32.2689932Z +
2025-11-09T23:19:32.2690107Z      /// Refill tokens based on elapsed time
2025-11-09T23:19:32.2690247Z      fn refill(&mut self) {
2025-11-09T23:19:32.2690434Z          use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:19:32.2690885Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:264:
2025-11-09T23:19:32.2691462Z              .duration_since(UNIX_EPOCH)
2025-11-09T23:19:32.2691607Z              .unwrap()
2025-11-09T23:19:32.2691734Z              .as_secs();
2025-11-09T23:19:32.2691860Z -        
2025-11-09T23:19:32.2691976Z +
2025-11-09T23:19:32.2692124Z          if now > self.last_refill {
2025-11-09T23:19:32.2692303Z              let elapsed = now - self.last_refill;
2025-11-09T23:19:32.2692519Z              let tokens_to_add = (elapsed as u32) * self.rate;
2025-11-09T23:19:32.2692997Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:271:
2025-11-09T23:19:32.2693354Z -            self.tokens = self.tokens.saturating_add(tokens_to_add).min(self.burst_limit);
2025-11-09T23:19:32.2693504Z +            self.tokens = self
2025-11-09T23:19:32.2693628Z +                .tokens
2025-11-09T23:19:32.2693788Z +                .saturating_add(tokens_to_add)
2025-11-09T23:19:32.2693937Z +                .min(self.burst_limit);
2025-11-09T23:19:32.2694084Z              self.last_refill = now;
2025-11-09T23:19:32.2694200Z          }
2025-11-09T23:19:32.2694492Z      }
2025-11-09T23:19:32.2694960Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:452:
2025-11-09T23:19:32.2695258Z              enable_self_advertisement: true, // Default: advertise ourselves
2025-11-09T23:19:32.2695370Z          }
2025-11-09T23:19:32.2695485Z      }
2025-11-09T23:19:32.2695599Z -    
2025-11-09T23:19:32.2696006Z +
2025-11-09T23:19:32.2696236Z      /// Set dependencies for protocol message processing
2025-11-09T23:19:32.2696381Z      pub fn with_dependencies(
2025-11-09T23:19:32.2696490Z          mut self,
2025-11-09T23:19:32.2696917Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:525:
2025-11-09T23:19:32.2697157Z      /// Discover peers from DNS seeds and add to address database
2025-11-09T23:19:32.2697516Z      pub async fn discover_peers_from_dns(&self, network: &str, port: u16) -> Result<()> {
2025-11-09T23:19:32.2697670Z          use crate::network::dns_seeds;
2025-11-09T23:19:32.2697792Z -        
2025-11-09T23:19:32.2697900Z +
2025-11-09T23:19:32.2698047Z          let seeds = match network {
2025-11-09T23:19:32.2698237Z              "mainnet" => dns_seeds::MAINNET_DNS_SEEDS,
2025-11-09T23:19:32.2698426Z              "testnet" => dns_seeds::TESTNET_DNS_SEEDS,
2025-11-09T23:19:32.2698869Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:534:
2025-11-09T23:19:32.2699014Z                  return Ok(());
2025-11-09T23:19:32.2699147Z              }
2025-11-09T23:19:32.2699266Z          };
2025-11-09T23:19:32.2699381Z -        
2025-11-09T23:19:32.2699490Z +
2025-11-09T23:19:32.2699738Z          info!("Discovering peers from DNS seeds for {}", network);
2025-11-09T23:19:32.2700040Z          let addresses = dns_seeds::resolve_dns_seeds(seeds, port, 100).await;
2025-11-09T23:19:32.2700155Z -        
2025-11-09T23:19:32.2700271Z +
2025-11-09T23:19:32.2700428Z          // Add discovered addresses to database
2025-11-09T23:19:32.2700533Z          {
2025-11-09T23:19:32.2700726Z              let mut db = self.address_database.lock().unwrap();
2025-11-09T23:19:32.2701369Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:545:
2025-11-09T23:19:32.2701626Z                  db.add_address(addr, 0); // Services will be updated on connection
2025-11-09T23:19:32.2701743Z              }
2025-11-09T23:19:32.2701869Z          }
2025-11-09T23:19:32.2701970Z -        
2025-11-09T23:19:32.2702069Z +
2025-11-09T23:19:32.2702531Z          info!("Discovered {} addresses from DNS seeds", addresses.len());
2025-11-09T23:19:32.2702650Z          Ok(())
2025-11-09T23:19:32.2702766Z      }
2025-11-09T23:19:32.2703217Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:555:
2025-11-09T23:19:32.2703399Z          for peer_addr in persistent_peers {
2025-11-09T23:19:32.2703556Z              // Add to persistent peer set
2025-11-09T23:19:32.2703734Z              self.add_persistent_peer(*peer_addr);
2025-11-09T23:19:32.2703853Z -            
2025-11-09T23:19:32.2703959Z +
2025-11-09T23:19:32.2704085Z              // Try to connect
2025-11-09T23:19:32.2704484Z              info!("Connecting to persistent peer: {}", peer_addr);
2025-11-09T23:19:32.2704725Z              if let Err(e) = self.connect_to_peer(*peer_addr).await {
2025-11-09T23:19:32.2705181Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:566:
2025-11-09T23:19:32.2705318Z      }
2025-11-09T23:19:32.2705448Z  
2025-11-09T23:19:32.2705660Z      /// Discover Iroh peers and add to address database
2025-11-09T23:19:32.2705774Z -    /// 
2025-11-09T23:19:32.2705890Z +    ///
2025-11-09T23:19:32.2706072Z      /// Iroh peers are discovered through:
2025-11-09T23:19:32.2706334Z      /// 1. Incoming connections (automatically stored)
2025-11-09T23:19:32.2706493Z      /// 2. DERP servers (if configured)
2025-11-09T23:19:32.2706954Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:573:
2025-11-09T23:19:32.2707718Z      /// 3. Gossip discovery (if available)
2025-11-09T23:19:32.2707848Z -    /// 
2025-11-09T23:19:32.2707978Z +    ///
2025-11-09T23:19:32.2708341Z      /// This method can be extended to use Iroh's gossip discovery APIs when available.
2025-11-09T23:19:32.2708488Z      #[cfg(feature = "iroh")]
2025-11-09T23:19:32.2708740Z      pub async fn discover_iroh_peers(&self) -> Result<usize> {
2025-11-09T23:19:32.2709467Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:579:
2025-11-09T23:19:32.2709766Z          // 1. Incoming connections (handled automatically in accept loop)
2025-11-09T23:19:32.2709968Z          // 2. DERP servers (configured in IrohTransport)
2025-11-09T23:19:32.2710262Z          // 3. Gossip discovery (would require iroh-gossip-discovery crate)
2025-11-09T23:19:32.2710381Z -        
2025-11-09T23:19:32.2710494Z +
2025-11-09T23:19:32.2710634Z          // For now, we rely on:
2025-11-09T23:19:32.2710817Z          // - Persistent Iroh peers from config
2025-11-09T23:19:32.2711023Z          // - Incoming connections (stored automatically)
2025-11-09T23:19:32.2711463Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:586:
2025-11-09T23:19:32.2711669Z          // - DERP servers (handled by Iroh's MagicEndpoint)
2025-11-09T23:19:32.2711789Z -        
2025-11-09T23:19:32.2711897Z +
2025-11-09T23:19:32.2712173Z          // Future: Integrate with iroh-gossip-discovery when available
2025-11-09T23:19:32.2712539Z          info!("Iroh peer discovery: relying on DERP servers and incoming connections");
2025-11-09T23:19:32.2712864Z          Ok(0) // Return 0 for now - discovery happens through Iroh's native mechanisms
2025-11-09T23:19:32.2713315Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:593:
2025-11-09T23:19:32.2713513Z      /// Connect to Iroh peers from address database
2025-11-09T23:19:32.2713657Z      #[cfg(feature = "iroh")]
2025-11-09T23:19:32.2714077Z      pub async fn connect_iroh_peers_from_database(&self, target_count: usize) -> Result<usize> {
2025-11-09T23:19:32.2714503Z -        use crate::network::transport::TransportAddr;
2025-11-09T23:19:32.2714694Z          use crate::network::peer::Peer;
2025-11-09T23:19:32.2714808Z -        
2025-11-09T23:19:32.2715012Z +        use crate::network::transport::TransportAddr;
2025-11-09T23:19:32.2715145Z +
2025-11-09T23:19:32.2715295Z          // Count current Iroh peers
2025-11-09T23:19:32.2715657Z          let current_iroh_count = {
2025-11-09T23:19:32.2715863Z              let pm = self.peer_manager.lock().unwrap();
2025-11-09T23:19:32.2716319Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:604:
2025-11-09T23:19:32.2716570Z                  .filter(|addr| matches!(addr, TransportAddr::Iroh(_)))
2025-11-09T23:19:32.2716703Z                  .count()
2025-11-09T23:19:32.2716832Z          };
2025-11-09T23:19:32.2716949Z -        
2025-11-09T23:19:32.2717061Z +
2025-11-09T23:19:32.2717229Z          if current_iroh_count >= target_count {
2025-11-09T23:19:32.2717369Z              return Ok(0);
2025-11-09T23:19:32.2717481Z          }
2025-11-09T23:19:32.2717910Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:611:
2025-11-09T23:19:32.2718023Z -        
2025-11-09T23:19:32.2718127Z +
2025-11-09T23:19:32.2718317Z          let needed = target_count - current_iroh_count;
2025-11-09T23:19:32.2718736Z -        info!("Need {} more Iroh peers (current: {}, target: {})", needed, current_iroh_count, target_count);
2025-11-09T23:19:32.2718845Z -        
2025-11-09T23:19:32.2718955Z +        info!(
2025-11-09T23:19:32.2719150Z +            "Need {} more Iroh peers (current: {}, target: {})",
2025-11-09T23:19:32.2719325Z +            needed, current_iroh_count, target_count
2025-11-09T23:19:32.2719433Z +        );
2025-11-09T23:19:32.2719536Z +
2025-11-09T23:19:32.2719697Z          // Get fresh Iroh NodeIds from database
2025-11-09T23:19:32.2719810Z          let node_ids = {
2025-11-09T23:19:32.2719991Z              let db = self.address_database.lock().unwrap();
2025-11-09T23:19:32.2720419Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:618:
2025-11-09T23:19:32.2720709Z              db.get_fresh_iroh_addresses(needed * 2) // Get 2x needed for retries
2025-11-09T23:19:32.2720821Z          };
2025-11-09T23:19:32.2721150Z -        
2025-11-09T23:19:32.2721269Z +
2025-11-09T23:19:32.2721422Z          if node_ids.is_empty() {
2025-11-09T23:19:32.2721643Z              warn!("No fresh Iroh addresses available in database");
2025-11-09T23:19:32.2721772Z              return Ok(0);
2025-11-09T23:19:32.2722203Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:624:
2025-11-09T23:19:32.2722314Z          }
2025-11-09T23:19:32.2722420Z -        
2025-11-09T23:19:32.2722543Z +
2025-11-09T23:19:32.2722686Z          // Get Iroh transport
2025-11-09T23:19:32.2722893Z          let iroh_transport = match &self.iroh_transport {
2025-11-09T23:19:32.2723057Z              Some(transport) => transport,
2025-11-09T23:19:32.2723504Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:631:
2025-11-09T23:19:32.2723640Z                  return Ok(0);
2025-11-09T23:19:32.2723756Z              }
2025-11-09T23:19:32.2723880Z          };
2025-11-09T23:19:32.2724007Z -        
2025-11-09T23:19:32.2724121Z +
2025-11-09T23:19:32.2724479Z          // Try to connect to Iroh peers
2025-11-09T23:19:32.2724641Z          let mut connected = 0;
2025-11-09T23:19:32.2724863Z          for node_id in node_ids.into_iter().take(needed * 2) {
2025-11-09T23:19:32.2725300Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:638:
2025-11-09T23:19:32.2725490Z              let node_id_bytes = node_id.as_bytes().to_vec();
2025-11-09T23:19:32.2725793Z              let transport_addr = TransportAddr::Iroh(node_id_bytes.clone());
2025-11-09T23:19:32.2725910Z -            
2025-11-09T23:19:32.2726031Z +
2025-11-09T23:19:32.2726204Z              // Connect directly using Iroh transport
2025-11-09T23:19:32.2726477Z              match iroh_transport.connect(transport_addr.clone()).await {
2025-11-09T23:19:32.2726602Z                  Ok(conn) => {
2025-11-09T23:19:32.2727022Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:650:
2025-11-09T23:19:32.2727189Z                          transport_addr.clone(),
2025-11-09T23:19:32.2727563Z                          self.peer_tx.clone(),
2025-11-09T23:19:32.2727706Z                      );
2025-11-09T23:19:32.2727826Z -                    
2025-11-09T23:19:32.2727943Z +
2025-11-09T23:19:32.2728100Z                      // Add peer to manager
2025-11-09T23:19:32.2728209Z                      {
2025-11-09T23:19:32.2728406Z                          let mut pm = self.peer_manager.lock().unwrap();
2025-11-09T23:19:32.2728826Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:659:
2025-11-09T23:19:32.2728975Z                              continue;
2025-11-09T23:19:32.2729100Z                          }
2025-11-09T23:19:32.2729221Z                      }
2025-11-09T23:19:32.2729359Z -                    
2025-11-09T23:19:32.2729543Z +
2025-11-09T23:19:32.2729721Z                      // Store mapping for Iroh (if needed)
2025-11-09T23:19:32.2729842Z                      {
2025-11-09T23:19:32.2730187Z                          let mut socket_to_transport = self.socket_to_transport.lock().unwrap();
2025-11-09T23:19:32.2730632Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:666:
2025-11-09T23:19:32.2730981Z                          socket_to_transport.insert(placeholder_socket, transport_addr.clone());
2025-11-09T23:19:32.2731102Z                      }
2025-11-09T23:19:32.2731221Z -                    
2025-11-09T23:19:32.2731332Z +
2025-11-09T23:19:32.2731595Z                      info!("Successfully connected to Iroh peer: {}", node_id);
2025-11-09T23:19:32.2731738Z                      connected += 1;
2025-11-09T23:19:32.2731886Z                      if connected >= needed {
2025-11-09T23:19:32.2732327Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:677:
2025-11-09T23:19:32.2732449Z                  }
2025-11-09T23:19:32.2732561Z              }
2025-11-09T23:19:32.2732683Z          }
2025-11-09T23:19:32.2733044Z -        
2025-11-09T23:19:32.2733374Z -        info!("Connected to {} new Iroh peers from address database", connected);
2025-11-09T23:19:32.2733488Z +
2025-11-09T23:19:32.2733615Z +        info!(
2025-11-09T23:19:32.2733853Z +            "Connected to {} new Iroh peers from address database",
2025-11-09T23:19:32.2733971Z +            connected
2025-11-09T23:19:32.2734087Z +        );
2025-11-09T23:19:32.2734206Z          Ok(connected)
2025-11-09T23:19:32.2734489Z      }
2025-11-09T23:19:32.2734598Z  
2025-11-09T23:19:32.2735040Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:685:
2025-11-09T23:19:32.2735306Z      /// Connect to peers from address database when below target count
2025-11-09T23:19:32.2735412Z -    /// 
2025-11-09T23:19:32.2735528Z +    ///
2025-11-09T23:19:32.2735858Z      /// Works with both SocketAddr-based addresses (TCP/Quinn) and Iroh NodeIds.
2025-11-09T23:19:32.2736253Z      pub async fn connect_peers_from_database(&self, target_count: usize) -> Result<usize> {
2025-11-09T23:19:32.2736442Z          let current_count = self.peer_count();
2025-11-09T23:19:32.2736892Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:692:
2025-11-09T23:19:32.2737658Z          }
2025-11-09T23:19:32.2737914Z  
2025-11-09T23:19:32.2738185Z          let needed = target_count - current_count;
2025-11-09T23:19:32.2755849Z -        info!("Need {} more peers (current: {}, target: {})", needed, current_count, target_count);
2025-11-09T23:19:32.2756020Z +        info!(
2025-11-09T23:19:32.2756258Z +            "Need {} more peers (current: {}, target: {})",
2025-11-09T23:19:32.2756435Z +            needed, current_count, target_count
2025-11-09T23:19:32.2756550Z +        );
2025-11-09T23:19:32.2756678Z  
2025-11-09T23:19:32.2756850Z          // Get fresh addresses from database
2025-11-09T23:19:32.2757082Z          let ban_list = self.ban_list.lock().unwrap().clone();
2025-11-09T23:19:32.2757559Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:715:
2025-11-09T23:19:32.2758003Z          // Convert addresses to SocketAddrs first
2025-11-09T23:19:32.2758181Z          let sockets: Vec<SocketAddr> = {
2025-11-09T23:19:32.2758383Z              let db = self.address_database.lock().unwrap();
2025-11-09T23:19:32.2758541Z -            addresses.iter()
2025-11-09T23:19:32.2758674Z +            addresses
2025-11-09T23:19:32.2761081Z +                .iter()
2025-11-09T23:19:32.2761261Z                  .take(needed * 2)
2025-11-09T23:19:32.2761469Z                  .map(|addr| db.network_addr_to_socket(addr))
2025-11-09T23:19:32.2761603Z                  .collect()
2025-11-09T23:19:32.2762079Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:724:
2025-11-09T23:19:32.2762247Z          // Try to connect to addresses
2025-11-09T23:19:32.2762391Z          let mut connected = 0;
2025-11-09T23:19:32.2762536Z          for socket in sockets {
2025-11-09T23:19:32.2762674Z -
2025-11-09T23:19:32.2762903Z              if let Err(e) = self.connect_to_peer(socket).await {
2025-11-09T23:19:32.2763123Z                  debug!("Failed to connect to {}: {}", socket, e);
2025-11-09T23:19:32.2763299Z                  // Continue trying other addresses
2025-11-09T23:19:32.2763776Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:737:
2025-11-09T23:19:32.2763895Z          }
2025-11-09T23:19:32.2764009Z  
2025-11-09T23:19:32.2764554Z          info!("Connected to {} new peers from address database", connected);
2025-11-09T23:19:32.2764680Z -        
2025-11-09T23:19:32.2764795Z +
2025-11-09T23:19:32.2765016Z          // Also try to connect Iroh peers if Iroh is enabled
2025-11-09T23:19:32.2765161Z          #[cfg(feature = "iroh")]
2025-11-09T23:19:32.2765363Z          if self.transport_preference.allows_iroh() {
2025-11-09T23:19:32.2765820Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:744:
2025-11-09T23:19:32.2766493Z              let iroh_connected = self.connect_iroh_peers_from_database(target_count).await?;
2025-11-09T23:19:32.2766657Z              connected += iroh_connected;
2025-11-09T23:19:32.2766772Z          }
2025-11-09T23:19:32.2766894Z -        
2025-11-09T23:19:32.2767006Z +
2025-11-09T23:19:32.2767135Z          Ok(connected)
2025-11-09T23:19:32.2767255Z      }
2025-11-09T23:19:32.2767377Z  
2025-11-09T23:19:32.2768406Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:751:
2025-11-09T23:19:32.2768608Z      /// Initialize peer connections after startup
2025-11-09T23:19:32.2768727Z -    /// 
2025-11-09T23:19:32.2768836Z +    ///
2025-11-09T23:19:32.2769037Z      /// This is automatically called by `start()` to:
2025-11-09T23:19:32.2769306Z      /// 1. Discover peers from DNS seeds (for TCP/Quinn transports)
2025-11-09T23:19:32.2769506Z      /// 2. Connect to persistent peers from config
2025-11-09T23:19:32.2769958Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:756:
2025-11-09T23:19:32.2770332Z      /// 3. Discover Iroh peers (if Iroh is enabled) - uses Iroh's DERP servers and gossip
2025-11-09T23:19:32.2770604Z      /// 4. Connect to peers from address database to reach target count
2025-11-09T23:19:32.2770713Z -    /// 
2025-11-09T23:19:32.2770821Z +    ///
2025-11-09T23:19:32.2771217Z      /// Note: The address database now supports both SocketAddr-based addresses (TCP/Quinn)
2025-11-09T23:19:32.2771435Z      /// and Iroh NodeIds. Iroh peers are discovered through:
2025-11-09T23:19:32.2771638Z      /// - DERP servers (handled by Iroh's MagicEndpoint)
2025-11-09T23:19:32.2772078Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:770:
2025-11-09T23:19:32.2772234Z          target_peer_count: usize,
2025-11-09T23:19:32.2772358Z      ) -> Result<()> {
2025-11-09T23:19:32.2772639Z          // 1. Discover peers from DNS seeds (only for TCP/Quinn, not Iroh)
2025-11-09T23:19:32.2772969Z -        let should_discover_dns = self.transport_preference.allows_tcp() || 
2025-11-09T23:19:32.2773483Z +        let should_discover_dns = self.transport_preference.allows_tcp() || {
2025-11-09T23:19:32.2773631Z +            #[cfg(feature = "quinn")]
2025-11-09T23:19:32.2773750Z              {
2025-11-09T23:19:32.2773894Z -                #[cfg(feature = "quinn")]
2025-11-09T23:19:32.2774005Z -                {
2025-11-09T23:19:32.2774192Z -                    self.transport_preference.allows_quinn()
2025-11-09T23:19:32.2774469Z -                }
2025-11-09T23:19:32.2774629Z -                #[cfg(not(feature = "quinn"))]
2025-11-09T23:19:32.2774737Z -                {
2025-11-09T23:19:32.2774871Z -                    false
2025-11-09T23:19:32.2774981Z -                }
2025-11-09T23:19:32.2775101Z -            };
2025-11-09T23:19:32.2775296Z +                self.transport_preference.allows_quinn()
2025-11-09T23:19:32.2775423Z +            }
2025-11-09T23:19:32.2775577Z +            #[cfg(not(feature = "quinn"))]
2025-11-09T23:19:32.2775702Z +            {
2025-11-09T23:19:32.2775838Z +                false
2025-11-09T23:19:32.2775955Z +            }
2025-11-09T23:19:32.2776070Z +        };
2025-11-09T23:19:32.2776213Z          if should_discover_dns {
2025-11-09T23:19:32.2776501Z              if let Err(e) = self.discover_peers_from_dns(network, port).await {
2025-11-09T23:19:32.2776687Z                  warn!("DNS seed discovery failed: {}", e);
2025-11-09T23:19:32.2777147Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:807:
2025-11-09T23:19:32.2777437Z          // 4. Connect to peers from address database to reach target count
2025-11-09T23:19:32.2777647Z          // Wait a bit for persistent peers to connect first
2025-11-09T23:19:32.2777923Z          tokio::time::sleep(tokio::time::Duration::from_secs(2)).await;
2025-11-09T23:19:32.2778046Z -        
2025-11-09T23:19:32.2778161Z +
2025-11-09T23:19:32.2778487Z          if let Err(e) = self.connect_peers_from_database(target_peer_count).await {
2025-11-09T23:19:32.2778950Z              warn!("Failed to connect peers from database: {}", e);
2025-11-09T23:19:32.2779081Z          }
2025-11-09T23:19:32.2779537Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:821:
2025-11-09T23:19:32.2779808Z              "Starting network manager with transport preference: {:?}",
2025-11-09T23:19:32.2779974Z              self.transport_preference
2025-11-09T23:19:32.2780089Z          );
2025-11-09T23:19:32.2780207Z -        
2025-11-09T23:19:32.2780319Z +
2025-11-09T23:19:32.2780469Z          // Start listening first
2025-11-09T23:19:32.2780580Z  
2025-11-09T23:19:32.2780750Z          // Initialize Quinn transport if enabled
2025-11-09T23:19:32.2781199Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:886:
2025-11-09T23:19:32.2781352Z                              let ip = socket_addr.ip();
2025-11-09T23:19:32.2781547Z                              if !dos_protection.check_connection(ip).await {
2025-11-09T23:19:32.2781924Z                                  warn!("Connection rate limit exceeded for IP {}, rejecting connection", ip);
2025-11-09T23:19:32.2782043Z -                                
2025-11-09T23:19:32.2782144Z +
2025-11-09T23:19:32.2782375Z                                  // Check if we should auto-ban
2025-11-09T23:19:32.2782596Z                                  if dos_protection.should_auto_ban(ip).await {
2025-11-09T23:19:32.2782927Z                                      warn!("Auto-banning IP {} for repeated connection rate violations", ip);
2025-11-09T23:19:32.2783382Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:899:
2025-11-09T23:19:32.2783614Z                                      let mut ban_list_guard = ban_list.lock().unwrap();
2025-11-09T23:19:32.2783849Z                                      ban_list_guard.insert(socket_addr, unban_timestamp);
2025-11-09T23:19:32.2783977Z                                  }
2025-11-09T23:19:32.2784118Z -                                
2025-11-09T23:19:32.2784614Z +
2025-11-09T23:19:32.2784838Z                                  // Close connection immediately
2025-11-09T23:19:32.2784991Z                                  drop(conn);
2025-11-09T23:19:32.2785139Z                                  continue;
2025-11-09T23:19:32.2785606Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:910:
2025-11-09T23:19:32.2785819Z                                  let pm = peer_manager_clone.lock().unwrap();
2025-11-09T23:19:32.2785988Z                                  pm.peer_count()
2025-11-09T23:19:32.2786117Z                              };
2025-11-09T23:19:32.2786482Z -                            if !dos_protection.check_active_connections(current_connections).await {
2025-11-09T23:19:32.2786656Z +                            if !dos_protection
2025-11-09T23:19:32.2786885Z +                                .check_active_connections(current_connections)
2025-11-09T23:19:32.2787033Z +                                .await
2025-11-09T23:19:32.2787169Z +                            {
2025-11-09T23:19:32.2787605Z                                  warn!("Active connection limit exceeded, rejecting connection from {}", socket_addr);
2025-11-09T23:19:32.2787752Z                                  drop(conn);
2025-11-09T23:19:32.2787896Z                                  continue;
2025-11-09T23:19:32.2788374Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:918:
2025-11-09T23:19:32.2788491Z  
2025-11-09T23:19:32.2788670Z                              // Send connection notification
2025-11-09T23:19:32.2788950Z                              let transport_addr = TransportAddr::Tcp(socket_addr);
2025-11-09T23:19:32.2789361Z -                            let _ = peer_tx.send(NetworkMessage::PeerConnected(transport_addr.clone()));
2025-11-09T23:19:32.2789498Z +                            let _ =
2025-11-09T23:19:32.2789848Z +                                peer_tx.send(NetworkMessage::PeerConnected(transport_addr.clone()));
2025-11-09T23:19:32.2790219Z  
2025-11-09T23:19:32.2790525Z                              // Handle connection in background with graceful error handling
2025-11-09T23:19:32.2790714Z                              let peer_tx_clone = peer_tx.clone();
2025-11-09T23:19:32.2791184Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:927:
2025-11-09T23:19:32.2791373Z                                  // Create peer from transport connection
2025-11-09T23:19:32.2791563Z                                  use crate::network::peer::Peer;
2025-11-09T23:19:32.2791787Z                                  use crate::network::transport::TransportAddr;
2025-11-09T23:19:32.2791914Z -                                
2025-11-09T23:19:32.2792029Z +
2025-11-09T23:19:32.2792268Z                                  let peer = peer::Peer::from_transport_connection(
2025-11-09T23:19:32.2792408Z                                      conn,
2025-11-09T23:19:32.2792571Z                                      socket_addr,
2025-11-09T23:19:32.2793035Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:934:
2025-11-09T23:19:32.2793241Z                                      TransportAddr::Tcp(socket_addr),
2025-11-09T23:19:32.2793410Z                                      peer_tx_clone.clone(),
2025-11-09T23:19:32.2793539Z                                  );
2025-11-09T23:19:32.2793676Z -                                
2025-11-09T23:19:32.2793790Z +
2025-11-09T23:19:32.2794024Z                                  // Add peer to manager (with graceful error handling)
2025-11-09T23:19:32.2794220Z                                  match peer_manager_for_peer.lock() {
2025-11-09T23:19:32.2794556Z                                      Ok(mut pm) => {
2025-11-09T23:19:32.2795018Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:941:
2025-11-09T23:19:32.2795296Z                                          if let Err(e) = pm.add_peer(transport_addr.clone(), peer) {
2025-11-09T23:19:32.2795757Z                                              warn!("Failed to add peer {}: {}", socket_addr, e);
2025-11-09T23:19:32.2796207Z -                                            let _ = peer_tx_clone.send(NetworkMessage::PeerDisconnected(transport_addr.clone()));
2025-11-09T23:19:32.2796387Z +                                            let _ = peer_tx_clone.send(
2025-11-09T23:19:32.2796604Z +                                                NetworkMessage::PeerDisconnected(
2025-11-09T23:19:32.2796784Z +                                                    transport_addr.clone(),
2025-11-09T23:19:32.2796928Z +                                                ),
2025-11-09T23:19:32.2797075Z +                                            );
2025-11-09T23:19:32.2797222Z                                              return;
2025-11-09T23:19:32.2797354Z                                          }
2025-11-09T23:19:32.2797781Z -                                        info!("Successfully added peer {} (transport: {:?})", socket_addr, transport_addr);
2025-11-09T23:19:32.2797926Z +                                        info!(
2025-11-09T23:19:32.2798153Z +                                            "Successfully added peer {} (transport: {:?})",
2025-11-09T23:19:32.2798342Z +                                            socket_addr, transport_addr
2025-11-09T23:19:32.2798477Z +                                        );
2025-11-09T23:19:32.2798608Z                                      }
2025-11-09T23:19:32.2798753Z                                      Err(e) => {
2025-11-09T23:19:32.2799049Z -                                        warn!("Failed to lock peer manager for {}: {}", socket_addr, e);
2025-11-09T23:19:32.2799470Z -                                        let _ = peer_tx_clone.send(NetworkMessage::PeerDisconnected(transport_addr.clone()));
2025-11-09T23:19:32.2799606Z +                                        warn!(
2025-11-09T23:19:32.2800056Z +                                            "Failed to lock peer manager for {}: {}",
2025-11-09T23:19:32.2800217Z +                                            socket_addr, e
2025-11-09T23:19:32.2800351Z +                                        );
2025-11-09T23:19:32.2800908Z +                                        let _ =
2025-11-09T23:19:32.2801366Z +                                            peer_tx_clone.send(NetworkMessage::PeerDisconnected(
2025-11-09T23:19:32.2801548Z +                                                transport_addr.clone(),
2025-11-09T23:19:32.2801685Z +                                            ));
2025-11-09T23:19:32.2801832Z                                          return;
2025-11-09T23:19:32.2801962Z                                      }
2025-11-09T23:19:32.2802090Z                                  }
2025-11-09T23:19:32.2802553Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:954:
2025-11-09T23:19:32.2802700Z -                                
2025-11-09T23:19:32.2802814Z +
2025-11-09T23:19:32.2803259Z                                  // Connection will be cleaned up automatically when read/write tasks exit
2025-11-09T23:19:32.2803631Z                                  // Peer removal happens in process_messages when PeerDisconnected is received
2025-11-09T23:19:32.2803756Z                              });
2025-11-09T23:19:32.2804197Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:974:
2025-11-09T23:19:32.2804597Z                      let peer_manager = Arc::clone(&self.peer_manager);
2025-11-09T23:19:32.2804844Z                      let dos_protection = Arc::clone(&self.dos_protection);
2025-11-09T23:19:32.2805036Z                      let ban_list = Arc::clone(&self.ban_list);
2025-11-09T23:19:32.2805170Z -                    
2025-11-09T23:19:32.2805286Z +
2025-11-09T23:19:32.2805453Z                      tokio::spawn(async move {
2025-11-09T23:19:32.2805594Z                          loop {
2025-11-09T23:19:32.2806007Z                              match quinn_listener.accept().await {
2025-11-09T23:19:32.2806470Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:993:
2025-11-09T23:19:32.2806640Z                                      let ip = socket_addr.ip();
2025-11-09T23:19:32.2808666Z                                      if !dos_protection.check_connection(ip).await {
2025-11-09T23:19:32.2809080Z                                          warn!("Connection rate limit exceeded for IP {}, rejecting Quinn connection", ip);
2025-11-09T23:19:32.2809212Z -                                        
2025-11-09T23:19:32.2809332Z +
2025-11-09T23:19:32.2809537Z                                          if dos_protection.should_auto_ban(ip).await {
2025-11-09T23:19:32.2809870Z                                              warn!("Auto-banning IP {} for repeated connection rate violations", ip);
2025-11-09T23:19:32.2810125Z                                              let unban_timestamp = std::time::SystemTime::now()
2025-11-09T23:19:32.2811259Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1013:
2025-11-09T23:19:32.2811456Z                                          let pm = peer_manager.lock().unwrap();
2025-11-09T23:19:32.2811637Z                                          pm.peer_count()
2025-11-09T23:19:32.2811767Z                                      };
2025-11-09T23:19:32.2812123Z -                                    if !dos_protection.check_active_connections(current_connections).await {
2025-11-09T23:19:32.2812293Z +                                    if !dos_protection
2025-11-09T23:19:32.2812515Z +                                        .check_active_connections(current_connections)
2025-11-09T23:19:32.2812660Z +                                        .await
2025-11-09T23:19:32.2812790Z +                                    {
2025-11-09T23:19:32.2813258Z                                          warn!("Active connection limit exceeded, rejecting Quinn connection from {}", socket_addr);
2025-11-09T23:19:32.2813645Z                                          drop(conn);
2025-11-09T23:19:32.2813794Z                                          continue;
2025-11-09T23:19:32.2814258Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1021:
2025-11-09T23:19:32.2814535Z  
2025-11-09T23:19:32.2814721Z                                      // Send connection notification
2025-11-09T23:19:32.2815035Z                                      let quinn_transport_addr = TransportAddr::Quinn(socket_addr);
2025-11-09T23:19:32.2815434Z -                                    let _ = peer_tx.send(NetworkMessage::PeerConnected(quinn_transport_addr.clone()));
2025-11-09T23:19:32.2815666Z +                                    let _ = peer_tx.send(NetworkMessage::PeerConnected(
2025-11-09T23:19:32.2815854Z +                                        quinn_transport_addr.clone(),
2025-11-09T23:19:32.2815997Z +                                    ));
2025-11-09T23:19:32.2816112Z  
2025-11-09T23:19:32.2816412Z                                      // Handle connection in background with graceful error handling
2025-11-09T23:19:32.2816607Z                                      let peer_tx_clone = peer_tx.clone();
2025-11-09T23:19:32.2817057Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1029:
2025-11-09T23:19:32.2817233Z                                      tokio::spawn(async move {
2025-11-09T23:19:32.2817427Z                                          use crate::network::peer::Peer;
2025-11-09T23:19:32.2817653Z                                          use crate::network::transport::TransportAddr;
2025-11-09T23:19:32.2817788Z -                                        
2025-11-09T23:19:32.2817909Z +
2025-11-09T23:19:32.2818152Z                                          let quinn_addr = TransportAddr::Quinn(socket_addr);
2025-11-09T23:19:32.2818384Z                                          let peer = peer::Peer::from_transport_connection(
2025-11-09T23:19:32.2818745Z                                              conn,
2025-11-09T23:19:32.2819204Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1037:
2025-11-09T23:19:32.2819359Z                                              quinn_addr,
2025-11-09T23:19:32.2819539Z                                              peer_tx_clone.clone(),
2025-11-09T23:19:32.2819671Z                                          );
2025-11-09T23:19:32.2819800Z -                                        
2025-11-09T23:19:32.2819914Z +
2025-11-09T23:19:32.2820154Z                                          // Add peer to manager (with graceful error handling)
2025-11-09T23:19:32.2820336Z                                          match peer_manager_clone.lock() {
2025-11-09T23:19:32.2822156Z                                              Ok(mut pm) => {
2025-11-09T23:19:32.2822608Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1044:
2025-11-09T23:19:32.2822864Z -                                                if let Err(e) = pm.add_peer(quinn_addr.clone(), peer) {
2025-11-09T23:19:32.2823119Z -                                                    warn!("Failed to add Quinn peer {}: {}", socket_addr, e);
2025-11-09T23:19:32.2823526Z -                                                    let _ = peer_tx_clone.send(NetworkMessage::PeerDisconnected(quinn_addr.clone()));
2025-11-09T23:19:32.2823686Z +                                                if let Err(e) =
2025-11-09T23:19:32.2823882Z +                                                    pm.add_peer(quinn_addr.clone(), peer)
2025-11-09T23:19:32.2824026Z +                                                {
2025-11-09T23:19:32.2824175Z +                                                    warn!(
2025-11-09T23:19:32.2824504Z +                                                        "Failed to add Quinn peer {}: {}",
2025-11-09T23:19:32.2824659Z +                                                        socket_addr, e
2025-11-09T23:19:32.2824984Z +                                                    );
2025-11-09T23:19:32.2825144Z +                                                    let _ = peer_tx_clone.send(
2025-11-09T23:19:32.2825327Z +                                                        NetworkMessage::PeerDisconnected(
2025-11-09T23:19:32.2825484Z +                                                            quinn_addr.clone(),
2025-11-09T23:19:32.2825608Z +                                                        ),
2025-11-09T23:19:32.2825731Z +                                                    );
2025-11-09T23:19:32.2825883Z                                                      return;
2025-11-09T23:19:32.2826014Z                                                  }
2025-11-09T23:19:32.2826265Z -                                                info!("Successfully added Quinn peer {}", socket_addr);
2025-11-09T23:19:32.2826404Z +                                                info!(
2025-11-09T23:19:32.2826618Z +                                                    "Successfully added Quinn peer {}",
2025-11-09T23:19:32.2826782Z +                                                    socket_addr
2025-11-09T23:19:32.2826939Z +                                                );
2025-11-09T23:19:32.2827083Z                                              }
2025-11-09T23:19:32.2827234Z                                              Err(e) => {
2025-11-09T23:19:32.2827582Z                                                  warn!("Failed to lock peer manager for Quinn peer {}: {}", socket_addr, e);
2025-11-09T23:19:32.2828041Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1053:
2025-11-09T23:19:32.2828438Z -                                                let _ = peer_tx_clone.send(NetworkMessage::PeerDisconnected(quinn_addr.clone()));
2025-11-09T23:19:32.2828618Z +                                                let _ = peer_tx_clone.send(
2025-11-09T23:19:32.2829075Z +                                                    NetworkMessage::PeerDisconnected(
2025-11-09T23:19:32.2829272Z +                                                        quinn_addr.clone(),
2025-11-09T23:19:32.2829416Z +                                                    ),
2025-11-09T23:19:32.2829574Z +                                                );
2025-11-09T23:19:32.2829729Z                                                  return;
2025-11-09T23:19:32.2829871Z                                              }
2025-11-09T23:19:32.2830004Z                                          }
2025-11-09T23:19:32.2830469Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1065:
2025-11-09T23:19:32.2830602Z                      });
2025-11-09T23:19:32.2830724Z                  }
2025-11-09T23:19:32.2831270Z                  Err(e) => {
2025-11-09T23:19:32.2831581Z -                    warn!("Failed to start Quinn listener (graceful degradation): {}", e);
2025-11-09T23:19:32.2831711Z +                    warn!(
2025-11-09T23:19:32.2831967Z +                        "Failed to start Quinn listener (graceful degradation): {}",
2025-11-09T23:19:32.2832088Z +                        e
2025-11-09T23:19:32.2832197Z +                    );
2025-11-09T23:19:32.2832458Z                      // Continue with other transports - don't fail entire startup
2025-11-09T23:19:32.2832564Z                  }
2025-11-09T23:19:32.2832678Z              }
2025-11-09T23:19:32.2833113Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1107:
2025-11-09T23:19:32.2833292Z                                          let pm = peer_manager.lock().unwrap();
2025-11-09T23:19:32.2833445Z                                          pm.peer_count()
2025-11-09T23:19:32.2833563Z                                      };
2025-11-09T23:19:32.2833898Z -                                    if !dos_protection.check_active_connections(current_connections).await {
2025-11-09T23:19:32.2834213Z +                                    if !dos_protection
2025-11-09T23:19:32.2834603Z +                                        .check_active_connections(current_connections)
2025-11-09T23:19:32.2834741Z +                                        .await
2025-11-09T23:19:32.2834862Z +                                    {
2025-11-09T23:19:32.2835186Z                                          warn!("Active connection limit exceeded, rejecting Iroh connection");
2025-11-09T23:19:32.2835329Z                                          drop(conn);
2025-11-09T23:19:32.2835460Z                                          continue;
2025-11-09T23:19:32.2835897Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1114:
2025-11-09T23:19:32.2836016Z                                      }
2025-11-09T23:19:32.2836121Z  
2025-11-09T23:19:32.2836394Z                                      // Send connection notification using TransportAddr directly
2025-11-09T23:19:32.2836729Z -                                    let _ = peer_tx.send(NetworkMessage::PeerConnected(iroh_addr.clone()));
2025-11-09T23:19:32.2836891Z +                                    let _ = peer_tx
2025-11-09T23:19:32.2837149Z +                                        .send(NetworkMessage::PeerConnected(iroh_addr.clone()));
2025-11-09T23:19:32.2837263Z  
2025-11-09T23:19:32.2837537Z                                      // Handle connection in background with graceful error handling
2025-11-09T23:19:32.2837721Z                                      let peer_tx_clone = peer_tx.clone();
2025-11-09T23:19:32.2838162Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1121:
2025-11-09T23:19:32.2838384Z                                      let peer_manager_clone = Arc::clone(&peer_manager);
2025-11-09T23:19:32.2838560Z                                      let iroh_addr_clone = iroh_addr.clone();
2025-11-09T23:19:32.2840636Z -                                    let socket_to_transport_clone = Arc::clone(&socket_to_transport);
2025-11-09T23:19:32.2841024Z +                                    let socket_to_transport_clone =
2025-11-09T23:19:32.2841226Z +                                        Arc::clone(&socket_to_transport);
2025-11-09T23:19:32.2841516Z                                      let address_database_clone = Arc::clone(&address_database);
2025-11-09T23:19:32.2841681Z                                      tokio::spawn(async move {
2025-11-09T23:19:32.2841855Z                                          use crate::network::peer::Peer;
2025-11-09T23:19:32.2842299Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1127:
2025-11-09T23:19:32.2842436Z -                                        
2025-11-09T23:19:32.2842548Z +
2025-11-09T23:19:32.2842847Z                                          // For Iroh, we need a SocketAddr for Peer::from_transport_connection
2025-11-09T23:19:32.2843122Z                                          // Generate a unique placeholder based on key hash for lookups
2025-11-09T23:19:32.2843519Z -                                        let placeholder_socket = if let TransportAddr::Iroh(ref key) = iroh_addr_clone {
2025-11-09T23:19:32.2843893Z -                                            // Use first 4 bytes of key for IP, last 2 bytes for port to create unique placeholder
2025-11-09T23:19:32.2844089Z -                                            let ip_bytes = if key.len() >= 4 {
2025-11-09T23:19:32.2844265Z -                                                [key[0], key[1], key[2], key[3]]
2025-11-09T23:19:32.2844602Z +                                        let placeholder_socket =
2025-11-09T23:19:32.2844880Z +                                            if let TransportAddr::Iroh(ref key) = iroh_addr_clone {
2025-11-09T23:19:32.2845249Z +                                                // Use first 4 bytes of key for IP, last 2 bytes for port to create unique placeholder
2025-11-09T23:19:32.2845434Z +                                                let ip_bytes = if key.len() >= 4 {
2025-11-09T23:19:32.2846069Z +                                                    [key[0], key[1], key[2], key[3]]
2025-11-09T23:19:32.2846226Z +                                                } else {
2025-11-09T23:19:32.2846380Z +                                                    [0, 0, 0, 0]
2025-11-09T23:19:32.2846530Z +                                                };
2025-11-09T23:19:32.2846716Z +                                                let port = if key.len() >= 6 {
2025-11-09T23:19:32.2846899Z +                                                    u16::from_be_bytes([
2025-11-09T23:19:32.2847076Z +                                                        key[key.len() - 2],
2025-11-09T23:19:32.2847253Z +                                                        key[key.len() - 1],
2025-11-09T23:19:32.2847390Z +                                                    ])
2025-11-09T23:19:32.2847529Z +                                                } else {
2025-11-09T23:19:32.2847686Z +                                                    0
2025-11-09T23:19:32.2847820Z +                                                };
2025-11-09T23:19:32.2848038Z +                                                std::net::SocketAddr::from((ip_bytes, port))
2025-11-09T23:19:32.2848188Z                                              } else {
2025-11-09T23:19:32.2848340Z -                                                [0, 0, 0, 0]
2025-11-09T23:19:32.2848554Z +                                                std::net::SocketAddr::from(([0, 0, 0, 0], 0))
2025-11-09T23:19:32.2848697Z                                              };
2025-11-09T23:19:32.2848878Z -                                            let port = if key.len() >= 6 {
2025-11-09T23:19:32.2849116Z -                                                u16::from_be_bytes([key[key.len()-2], key[key.len()-1]])
2025-11-09T23:19:32.2851545Z -                                            } else {
2025-11-09T23:19:32.2851710Z -                                                0
2025-11-09T23:19:32.2851858Z -                                            };
2025-11-09T23:19:32.2852301Z -                                            std::net::SocketAddr::from((ip_bytes, port))
2025-11-09T23:19:32.2852466Z -                                        } else {
2025-11-09T23:19:32.2852680Z -                                            std::net::SocketAddr::from(([0, 0, 0, 0], 0))
2025-11-09T23:19:32.2852822Z -                                        };
2025-11-09T23:19:32.2852971Z -                                        
2025-11-09T23:19:32.2853087Z +
2025-11-09T23:19:32.2853359Z                                          let peer = peer::Peer::from_transport_connection(
2025-11-09T23:19:32.2853527Z                                              conn,
2025-11-09T23:19:32.2853708Z                                              placeholder_socket,
2025-11-09T23:19:32.2854167Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1150:
2025-11-09T23:19:32.2854528Z                                              iroh_addr_clone.clone(),
2025-11-09T23:19:32.2854723Z                                              peer_tx_clone.clone(),
2025-11-09T23:19:32.2854856Z                                          );
2025-11-09T23:19:32.2854992Z -                                        
2025-11-09T23:19:32.2855111Z +
2025-11-09T23:19:32.2855346Z                                          // Add peer to manager (with graceful error handling)
2025-11-09T23:19:32.2855533Z                                          match peer_manager_clone.lock() {
2025-11-09T23:19:32.2855690Z                                              Ok(mut pm) => {
2025-11-09T23:19:32.2856160Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1157:
2025-11-09T23:19:32.2856445Z -                                                if let Err(e) = pm.add_peer(iroh_addr_clone.clone(), peer) {
2025-11-09T23:19:32.2856604Z +                                                if let Err(e) =
2025-11-09T23:19:32.2857062Z +                                                    pm.add_peer(iroh_addr_clone.clone(), peer)
2025-11-09T23:19:32.2857203Z +                                                {
2025-11-09T23:19:32.2857400Z                                                      warn!("Failed to add Iroh peer: {}", e);
2025-11-09T23:19:32.2857835Z -                                                    let _ = peer_tx_clone.send(NetworkMessage::PeerDisconnected(iroh_addr_clone.clone()));
2025-11-09T23:19:32.2858016Z +                                                    let _ = peer_tx_clone.send(
2025-11-09T23:19:32.2858221Z +                                                        NetworkMessage::PeerDisconnected(
2025-11-09T23:19:32.2858411Z +                                                            iroh_addr_clone.clone(),
2025-11-09T23:19:32.2858561Z +                                                        ),
2025-11-09T23:19:32.2858702Z +                                                    );
2025-11-09T23:19:32.2858862Z                                                      return;
2025-11-09T23:19:32.2858997Z                                                  }
2025-11-09T23:19:32.2859351Z                                                  // Store mapping from placeholder SocketAddr to TransportAddr for Iroh lookups
2025-11-09T23:19:32.2859785Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1163:
2025-11-09T23:19:32.2860265Z -                                                socket_to_transport_clone.lock().unwrap().insert(placeholder_socket, iroh_addr_clone.clone());
2025-11-09T23:19:32.2860401Z -                                                
2025-11-09T23:19:32.2860629Z +                                                socket_to_transport_clone.lock().unwrap().insert(
2025-11-09T23:19:32.2862815Z +                                                    placeholder_socket,
2025-11-09T23:19:32.2862987Z +                                                    iroh_addr_clone.clone(),
2025-11-09T23:19:32.2863132Z +                                                );
2025-11-09T23:19:32.2863460Z +
2025-11-09T23:19:32.2863670Z                                                  // Store Iroh NodeId in address database
2025-11-09T23:19:32.2863983Z -                                                if let TransportAddr::Iroh(ref node_id_bytes) = iroh_addr_clone {
2025-11-09T23:19:32.2864219Z +                                                if let TransportAddr::Iroh(ref node_id_bytes) =
2025-11-09T23:19:32.2864555Z +                                                    iroh_addr_clone
2025-11-09T23:19:32.2864693Z +                                                {
2025-11-09T23:19:32.2864882Z                                                      if node_id_bytes.len() == 32 {
2025-11-09T23:19:32.2865069Z                                                          use iroh_net::NodeId;
2025-11-09T23:19:32.2865327Z -                                                        if let Ok(node_id) = NodeId::from_bytes(node_id_bytes) {
2025-11-09T23:19:32.2865611Z -                                                            let address_db_clone = address_database_clone.clone();
2025-11-09T23:19:32.2865792Z +                                                        if let Ok(node_id) =
2025-11-09T23:19:32.2865982Z +                                                            NodeId::from_bytes(node_id_bytes)
2025-11-09T23:19:32.2866116Z +                                                        {
2025-11-09T23:19:32.2866280Z +                                                            let address_db_clone =
2025-11-09T23:19:32.2866455Z +                                                                address_database_clone.clone();
2025-11-09T23:19:32.2866629Z                                                              tokio::spawn(async move {
2025-11-09T23:19:32.2866868Z -                                                                let mut db = address_db_clone.lock().unwrap();
2025-11-09T23:19:32.2867247Z -                                                                db.add_iroh_address(node_id, 0); // Services will be updated on version exchange
2025-11-09T23:19:32.2867660Z +                                                                let mut db = address_db_clone
2025-11-09T23:19:32.2867827Z +                                                                    .lock()
2025-11-09T23:19:32.2867991Z +                                                                    .unwrap();
2025-11-09T23:19:32.2868179Z +                                                                db.add_iroh_address(node_id, 0);
2025-11-09T23:19:32.2868402Z +                                                                // Services will be updated on version exchange
2025-11-09T23:19:32.2868551Z                                                              });
2025-11-09T23:19:32.2868688Z                                                          }
2025-11-09T23:19:32.2868839Z                                                      }
2025-11-09T23:19:32.2869301Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1177:
2025-11-09T23:19:32.2869440Z                                                  }
2025-11-09T23:19:32.2869580Z -                                                
2025-11-09T23:19:32.2869701Z +
2025-11-09T23:19:32.2870056Z                                                  info!("Successfully added Iroh peer (transport: {:?})", iroh_addr_clone);
2025-11-09T23:19:32.2870187Z                                              }
2025-11-09T23:19:32.2872406Z                                              Err(e) => {
2025-11-09T23:19:32.2872841Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1182:
2025-11-09T23:19:32.2873093Z -                                                warn!("Failed to lock peer manager for Iroh peer: {}", e);
2025-11-09T23:19:32.2873509Z -                                                let _ = peer_tx_clone.send(NetworkMessage::PeerDisconnected(iroh_addr_clone.clone()));
2025-11-09T23:19:32.2873928Z +                                                warn!(
2025-11-09T23:19:32.2874165Z +                                                    "Failed to lock peer manager for Iroh peer: {}",
2025-11-09T23:19:32.2874489Z +                                                    e
2025-11-09T23:19:32.2874627Z +                                                );
2025-11-09T23:19:32.2874801Z +                                                let _ = peer_tx_clone.send(
2025-11-09T23:19:32.2875004Z +                                                    NetworkMessage::PeerDisconnected(
2025-11-09T23:19:32.2875184Z +                                                        iroh_addr_clone.clone(),
2025-11-09T23:19:32.2875320Z +                                                    ),
2025-11-09T23:19:32.2875450Z +                                                );
2025-11-09T23:19:32.2875599Z                                                  return;
2025-11-09T23:19:32.2875735Z                                              }
2025-11-09T23:19:32.2875885Z                                          }
2025-11-09T23:19:32.2876347Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1195:
2025-11-09T23:19:32.2876476Z                      });
2025-11-09T23:19:32.2876598Z                  }
2025-11-09T23:19:32.2876729Z                  Err(e) => {
2025-11-09T23:19:32.2877042Z -                    warn!("Failed to start Iroh listener (graceful degradation): {}", e);
2025-11-09T23:19:32.2877167Z +                    warn!(
2025-11-09T23:19:32.2877409Z +                        "Failed to start Iroh listener (graceful degradation): {}",
2025-11-09T23:19:32.2877535Z +                        e
2025-11-09T23:19:32.2877647Z +                    );
2025-11-09T23:19:32.2877920Z                      // Continue with other transports - don't fail entire startup
2025-11-09T23:19:32.2878042Z                  }
2025-11-09T23:19:32.2878164Z              }
2025-11-09T23:19:32.2878864Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1203:
2025-11-09T23:19:32.2878995Z  
2025-11-09T23:19:32.2879170Z          // Start periodic ban cleanup task
2025-11-09T23:19:32.2879324Z          self.start_ban_cleanup_task();
2025-11-09T23:19:32.2879439Z -        
2025-11-09T23:19:32.2879561Z +
2025-11-09T23:19:32.2879727Z          // Start pending request cleanup task
2025-11-09T23:19:32.2879892Z          self.start_request_cleanup_task();
2025-11-09T23:19:32.2880007Z -        
2025-11-09T23:19:32.2880122Z +
2025-11-09T23:19:32.2880287Z          // Start DoS protection cleanup task
2025-11-09T23:19:32.2880467Z          self.start_dos_protection_cleanup_task();
2025-11-09T23:19:32.2880589Z -        
2025-11-09T23:19:32.2880700Z +
2025-11-09T23:19:32.2881043Z          // Note: Peer connection initialization (DNS seeds, persistent peers, etc.)
2025-11-09T23:19:32.2881393Z          // should be called separately via initialize_peer_connections() after start()
2025-11-09T23:19:32.2881763Z          // This allows the caller to provide config, network type, and target peer count
2025-11-09T23:19:32.2882204Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1216:
2025-11-09T23:19:32.2882315Z -        
2025-11-09T23:19:32.2882428Z +
2025-11-09T23:19:32.2882550Z          Ok(())
2025-11-09T23:19:32.2882663Z      }
2025-11-09T23:19:32.2882773Z -    
2025-11-09T23:19:32.2882890Z +
2025-11-09T23:19:32.2883177Z      /// Generate a new request ID for async request-response patterns
2025-11-09T23:19:32.2883359Z      pub fn generate_request_id(&self) -> u64 {
2025-11-09T23:19:32.2883609Z          let mut counter = self.request_id_counter.lock().unwrap();
2025-11-09T23:19:32.2884051Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1224:
2025-11-09T23:19:32.2884221Z          *counter = counter.wrapping_add(1);
2025-11-09T23:19:32.2884519Z          id
2025-11-09T23:19:32.2884642Z      }
2025-11-09T23:19:32.2884765Z -    
2025-11-09T23:19:32.2884876Z +
2025-11-09T23:19:32.2885457Z      /// Register a pending request and return the response receiver
2025-11-09T23:19:32.2885670Z      /// Returns (request_id, response_receiver)
2025-11-09T23:19:32.2886170Z -    pub fn register_request(&self, peer_addr: SocketAddr) -> (u64, tokio::sync::oneshot::Receiver<Vec<u8>>) {
2025-11-09T23:19:32.2886323Z +    pub fn register_request(
2025-11-09T23:19:32.2886447Z +        &self,
2025-11-09T23:19:32.2886590Z +        peer_addr: SocketAddr,
2025-11-09T23:19:32.2886805Z +    ) -> (u64, tokio::sync::oneshot::Receiver<Vec<u8>>) {
2025-11-09T23:19:32.2887027Z          self.register_request_with_priority(peer_addr, 0)
2025-11-09T23:19:32.2887144Z      }
2025-11-09T23:19:32.2887258Z -    
2025-11-09T23:19:32.2887373Z +
2025-11-09T23:19:32.2887723Z      /// Register a pending request with priority and return the response receiver
2025-11-09T23:19:32.2887901Z      /// Returns (request_id, response_receiver)
2025-11-09T23:19:32.2888097Z      /// Priority: 0 = normal, higher = more important
2025-11-09T23:19:32.2888612Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1237:
2025-11-09T23:19:32.2889269Z -    pub fn register_request_with_priority(&self, peer_addr: SocketAddr, priority: u8) -> (u64, tokio::sync::oneshot::Receiver<Vec<u8>>) {
2025-11-09T23:19:32.2889444Z +    pub fn register_request_with_priority(
2025-11-09T23:19:32.2889566Z +        &self,
2025-11-09T23:19:32.2889707Z +        peer_addr: SocketAddr,
2025-11-09T23:19:32.2889839Z +        priority: u8,
2025-11-09T23:19:32.2890043Z +    ) -> (u64, tokio::sync::oneshot::Receiver<Vec<u8>>) {
2025-11-09T23:19:32.2890219Z          let request_id = self.generate_request_id();
2025-11-09T23:19:32.2890401Z          let (tx, rx) = tokio::sync::oneshot::channel();
2025-11-09T23:19:32.2890506Z -        
2025-11-09T23:19:32.2890614Z +
2025-11-09T23:19:32.2890779Z          use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:19:32.2890944Z          let timestamp = SystemTime::now()
2025-11-09T23:19:32.2891311Z              .duration_since(UNIX_EPOCH)
2025-11-09T23:19:32.2891766Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1244:
2025-11-09T23:19:32.2891888Z              .unwrap()
2025-11-09T23:19:32.2892014Z              .as_secs();
2025-11-09T23:19:32.2892139Z -        
2025-11-09T23:19:32.2892250Z +
2025-11-09T23:19:32.2892422Z          let pending_req = PendingRequest {
2025-11-09T23:19:32.2892557Z              sender: tx,
2025-11-09T23:19:32.2892680Z              peer_addr,
2025-11-09T23:19:32.2893128Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1251:
2025-11-09T23:19:32.2893243Z              priority,
2025-11-09T23:19:32.2893376Z              retry_count: 0,
2025-11-09T23:19:32.2893486Z          };
2025-11-09T23:19:32.2893602Z -        
2025-11-09T23:19:32.2893948Z -        self.pending_requests.lock().unwrap().insert(request_id, pending_req);
2025-11-09T23:19:32.2894071Z +
2025-11-09T23:19:32.2894215Z +        self.pending_requests
2025-11-09T23:19:32.2894520Z +            .lock()
2025-11-09T23:19:32.2894660Z +            .unwrap()
2025-11-09T23:19:32.2894821Z +            .insert(request_id, pending_req);
2025-11-09T23:19:32.2894943Z          (request_id, rx)
2025-11-09T23:19:32.2895058Z      }
2025-11-09T23:19:32.2895168Z -    
2025-11-09T23:19:32.2895282Z +
2025-11-09T23:19:32.2895501Z      /// Complete a pending request by sending the response
2025-11-09T23:19:32.2895820Z      pub fn complete_request(&self, request_id: u64, response: Vec<u8>) -> bool {
2025-11-09T23:19:32.2896050Z          let mut pending = self.pending_requests.lock().unwrap();
2025-11-09T23:19:32.2896501Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1266:
2025-11-09T23:19:32.2896623Z              false
2025-11-09T23:19:32.2896737Z          }
2025-11-09T23:19:32.2896849Z      }
2025-11-09T23:19:32.2896962Z -    
2025-11-09T23:19:32.2897081Z +
2025-11-09T23:19:32.2897230Z      /// Cancel a pending request
2025-11-09T23:19:32.2897633Z      pub fn cancel_request(&self, request_id: u64) -> bool {
2025-11-09T23:19:32.2897891Z          let mut pending = self.pending_requests.lock().unwrap();
2025-11-09T23:19:32.2898342Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1273:
2025-11-09T23:19:32.2898512Z          pending.remove(&request_id).is_some()
2025-11-09T23:19:32.2898639Z      }
2025-11-09T23:19:32.2898757Z -    
2025-11-09T23:19:32.2898871Z +
2025-11-09T23:19:32.2899056Z      /// Get pending requests for a specific peer
2025-11-09T23:19:32.2899426Z      pub fn get_pending_requests_for_peer(&self, peer_addr: SocketAddr) -> Vec<u64> {
2025-11-09T23:19:32.2899653Z          let pending = self.pending_requests.lock().unwrap();
2025-11-09T23:19:32.2900098Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1279:
2025-11-09T23:19:32.2900244Z -        pending.iter()
2025-11-09T23:19:32.2900365Z +        pending
2025-11-09T23:19:32.2900494Z +            .iter()
2025-11-09T23:19:32.2900697Z              .filter(|(_, req)| req.peer_addr == peer_addr)
2025-11-09T23:19:32.2900845Z              .map(|(id, _)| *id)
2025-11-09T23:19:32.2900970Z              .collect()
2025-11-09T23:19:32.2901700Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1283:
2025-11-09T23:19:32.2901827Z      }
2025-11-09T23:19:32.2901941Z -    
2025-11-09T23:19:32.2902056Z +
2025-11-09T23:19:32.2904279Z      /// Clean up expired requests (older than max_age_seconds)
2025-11-09T23:19:32.2904780Z      pub fn cleanup_expired_requests(&self, max_age_seconds: u64) -> usize {
2025-11-09T23:19:32.2904973Z          use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:19:32.2905406Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1289:
2025-11-09T23:19:32.2905575Z              .duration_since(UNIX_EPOCH)
2025-11-09T23:19:32.2905706Z              .unwrap()
2025-11-09T23:19:32.2906071Z              .as_secs();
2025-11-09T23:19:32.2906196Z -        
2025-11-09T23:19:32.2906318Z +
2025-11-09T23:19:32.2906563Z          let mut pending = self.pending_requests.lock().unwrap();
2025-11-09T23:19:32.2906738Z -        let expired: Vec<u64> = pending.iter()
2025-11-09T23:19:32.2906898Z +        let expired: Vec<u64> = pending
2025-11-09T23:19:32.2907012Z +            .iter()
2025-11-09T23:19:32.2907311Z              .filter(|(_, req)| now.saturating_sub(req.timestamp) > max_age_seconds)
2025-11-09T23:19:32.2907460Z              .map(|(id, _)| *id)
2025-11-09T23:19:32.2907587Z              .collect();
2025-11-09T23:19:32.2908039Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1298:
2025-11-09T23:19:32.2908151Z -        
2025-11-09T23:19:32.2908270Z +
2025-11-09T23:19:32.2908406Z          for id in &expired {
2025-11-09T23:19:32.2908543Z              pending.remove(id);
2025-11-09T23:19:32.2908655Z          }
2025-11-09T23:19:32.2909082Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1302:
2025-11-09T23:19:32.2909220Z -        
2025-11-09T23:19:32.2909334Z +
2025-11-09T23:19:32.2909472Z          expired.len()
2025-11-09T23:19:32.2909585Z      }
2025-11-09T23:19:32.2909693Z -    
2025-11-09T23:19:32.2909813Z +
2025-11-09T23:19:32.2910073Z      /// Start periodic task to clean up expired pending requests
2025-11-09T23:19:32.2910244Z      fn start_request_cleanup_task(&self) {
2025-11-09T23:19:32.2910520Z          let pending_requests = Arc::clone(&self.pending_requests);
2025-11-09T23:19:32.2910984Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1309:
2025-11-09T23:19:32.2911102Z -        
2025-11-09T23:19:32.2911219Z +
2025-11-09T23:19:32.2911386Z          tokio::spawn(async move {
2025-11-09T23:19:32.2911729Z              let mut interval = tokio::time::interval(tokio::time::Duration::from_secs(60));
2025-11-09T23:19:32.2911844Z              loop {
2025-11-09T23:19:32.2912490Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1313:
2025-11-09T23:19:32.2914689Z                  interval.tick().await;
2025-11-09T23:19:32.2914805Z -                
2025-11-09T23:19:32.2914912Z +
2025-11-09T23:19:32.2915136Z                  // Clean up old pending requests (older than 5 minutes)
2025-11-09T23:19:32.2915317Z                  use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:19:32.2915472Z                  let now = SystemTime::now()
2025-11-09T23:19:32.2915925Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1319:
2025-11-09T23:19:32.2916056Z                      .unwrap()
2025-11-09T23:19:32.2916193Z                      .as_secs();
2025-11-09T23:19:32.2916363Z                  let timeout_seconds = 300; // 5 minutes
2025-11-09T23:19:32.2916474Z -                
2025-11-09T23:19:32.2916586Z +
2025-11-09T23:19:32.2916808Z                  let mut pending = pending_requests.lock().unwrap();
2025-11-09T23:19:32.2916993Z                  let initial_count = pending.len();
2025-11-09T23:19:32.2917152Z -                pending.retain(|_, req| {
2025-11-09T23:19:32.2917370Z -                    now.saturating_sub(req.timestamp) < timeout_seconds
2025-11-09T23:19:32.2917487Z -                });
2025-11-09T23:19:32.2917829Z +                pending.retain(|_, req| now.saturating_sub(req.timestamp) < timeout_seconds);
2025-11-09T23:19:32.2918017Z                  let removed = initial_count - pending.len();
2025-11-09T23:19:32.2918146Z                  if removed > 0 {
2025-11-09T23:19:32.2918555Z -                    debug!("Cleaned up {} stale pending requests (older than {}s)", removed, timeout_seconds);
2025-11-09T23:19:32.2918682Z +                    debug!(
2025-11-09T23:19:32.2918925Z +                        "Cleaned up {} stale pending requests (older than {}s)",
2025-11-09T23:19:32.2919096Z +                        removed, timeout_seconds
2025-11-09T23:19:32.2919215Z +                    );
2025-11-09T23:19:32.2919588Z                  }
2025-11-09T23:19:32.2919763Z                  if !pending.is_empty() {
2025-11-09T23:19:32.2919966Z                      debug!("Pending requests: {}", pending.len());
2025-11-09T23:19:32.2920408Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1335:
2025-11-09T23:19:32.2920518Z              }
2025-11-09T23:19:32.2920634Z          });
2025-11-09T23:19:32.2920742Z      }
2025-11-09T23:19:32.2920848Z -    
2025-11-09T23:19:32.2920959Z +
2025-11-09T23:19:32.2921736Z      /// Start periodic task to clean up DoS protection data
2025-11-09T23:19:32.2921939Z      fn start_dos_protection_cleanup_task(&self) {
2025-11-09T23:19:32.2922189Z          let dos_protection = Arc::clone(&self.dos_protection);
2025-11-09T23:19:32.2922658Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1342:
2025-11-09T23:19:32.2922847Z          let ban_list = Arc::clone(&self.ban_list);
2025-11-09T23:19:32.2922976Z -        
2025-11-09T23:19:32.2923092Z +
2025-11-09T23:19:32.2923253Z          tokio::spawn(async move {
2025-11-09T23:19:32.2923696Z              let mut interval = tokio::time::interval(tokio::time::Duration::from_secs(300)); // Every 5 minutes
2025-11-09T23:19:32.2923830Z              loop {
2025-11-09T23:19:32.2924476Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1347:
2025-11-09T23:19:32.2924642Z                  interval.tick().await;
2025-11-09T23:19:32.2924763Z -                
2025-11-09T23:19:32.2924881Z +
2025-11-09T23:19:32.2925080Z                  // Cleanup old connection rate limiter entries
2025-11-09T23:19:32.2925254Z                  dos_protection.cleanup().await;
2025-11-09T23:19:32.2925379Z -                
2025-11-09T23:19:32.2925489Z +
2025-11-09T23:19:32.2925664Z                  // Auto-ban IPs that should be banned
2025-11-09T23:19:32.2926087Z                  // Note: This is a simplified version - in production, you'd want more sophisticated logic
2025-11-09T23:19:32.2926308Z                  let dos_clone = Arc::clone(&dos_protection);
2025-11-09T23:19:32.2926991Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1361:
2025-11-09T23:19:32.2927128Z              }
2025-11-09T23:19:32.2927256Z          });
2025-11-09T23:19:32.2927367Z      }
2025-11-09T23:19:32.2927476Z -    
2025-11-09T23:19:32.2927590Z +
2025-11-09T23:19:32.2927791Z      /// Start periodic task to clean up expired bans
2025-11-09T23:19:32.2927946Z      fn start_ban_cleanup_task(&self) {
2025-11-09T23:19:32.2928135Z          let ban_list = Arc::clone(&self.ban_list);
2025-11-09T23:19:32.2930791Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1369:
2025-11-09T23:19:32.2931567Z              let mut interval = tokio::time::interval(tokio::time::Duration::from_secs(300)); // Every 5 minutes
2025-11-09T23:19:32.2931704Z              loop {
2025-11-09T23:19:32.2931867Z                  interval.tick().await;
2025-11-09T23:19:32.2931998Z -                
2025-11-09T23:19:32.2932115Z +
2025-11-09T23:19:32.2932332Z                  use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:19:32.2932501Z                  let now = SystemTime::now()
2025-11-09T23:19:32.2932661Z                      .duration_since(UNIX_EPOCH)
2025-11-09T23:19:32.2933122Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1376:
2025-11-09T23:19:32.2933256Z                      .unwrap()
2025-11-09T23:19:32.2933388Z                      .as_secs();
2025-11-09T23:19:32.2933505Z -                
2025-11-09T23:19:32.2933624Z +
2025-11-09T23:19:32.2933839Z                  let mut ban_list_guard = ban_list.lock().unwrap();
2025-11-09T23:19:32.2934033Z                  let expired: Vec<SocketAddr> = ban_list_guard
2025-11-09T23:19:32.2934169Z                      .iter()
2025-11-09T23:19:32.2934825Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1384:
2025-11-09T23:19:32.2935219Z                      })
2025-11-09T23:19:32.2935381Z                      .map(|(addr, _)| *addr)
2025-11-09T23:19:32.2935522Z                      .collect();
2025-11-09T23:19:32.2935640Z -                
2025-11-09T23:19:32.2935754Z +
2025-11-09T23:19:32.2935914Z                  for addr in expired {
2025-11-09T23:19:32.2936080Z                      ban_list_guard.remove(&addr);
2025-11-09T23:19:32.2936289Z                      debug!("Cleaned up expired ban for {}", addr);
2025-11-09T23:19:32.2936754Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1391:
2025-11-09T23:19:32.2936875Z                  }
2025-11-09T23:19:32.2936994Z -                
2025-11-09T23:19:32.2937106Z +
2025-11-09T23:19:32.2937261Z                  if !expired.is_empty() {
2025-11-09T23:19:32.2937490Z                      info!("Cleaned up {} expired ban(s)", expired.len());
2025-11-09T23:19:32.2937605Z                  }
2025-11-09T23:19:32.2938067Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1406:
2025-11-09T23:19:32.2938300Z      pub fn peer_addresses(&self) -> Vec<SocketAddr> {
2025-11-09T23:19:32.2938566Z          self.peer_manager.lock().unwrap().peer_socket_addresses()
2025-11-09T23:19:32.2938684Z      }
2025-11-09T23:19:32.2938806Z -    
2025-11-09T23:19:32.2938919Z +
2025-11-09T23:19:32.2939103Z      /// Get all peer addresses (as TransportAddr)
2025-11-09T23:19:32.2941292Z      pub fn peer_transport_addresses(&self) -> Vec<TransportAddr> {
2025-11-09T23:19:32.2941925Z          self.peer_manager.lock().unwrap().peer_addresses()
2025-11-09T23:19:32.2942378Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1429:
2025-11-09T23:19:32.2942674Z      /// Uses peer quality to prioritize reliable peers for critical messages
2025-11-09T23:19:32.2943052Z      pub async fn broadcast_with_quality_priority(&self, message: Vec<u8>) -> Result<()> {
2025-11-09T23:19:32.2943230Z          let pm = self.peer_manager.lock().unwrap();
2025-11-09T23:19:32.2943353Z -        
2025-11-09T23:19:32.2943464Z +
2025-11-09T23:19:32.2943834Z          // Get reliable peers first
2025-11-09T23:19:32.2944048Z          let reliable_peers = pm.select_reliable_peers();
2025-11-09T23:19:32.2944180Z          drop(pm);
2025-11-09T23:19:32.2944810Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1436:
2025-11-09T23:19:32.2944925Z -        
2025-11-09T23:19:32.2945034Z +
2025-11-09T23:19:32.2945203Z          // Send to reliable peers first
2025-11-09T23:19:32.2945359Z          for addr in &reliable_peers {
2025-11-09T23:19:32.2945723Z -            if let Err(e) = self.send_to_peer_by_transport(addr.clone(), message.clone()).await {
2025-11-09T23:19:32.2945879Z +            if let Err(e) = self
2025-11-09T23:19:32.2946128Z +                .send_to_peer_by_transport(addr.clone(), message.clone())
2025-11-09T23:19:32.2946252Z +                .await
2025-11-09T23:19:32.2946369Z +            {
2025-11-09T23:19:32.2946636Z                  warn!("Failed to send to reliable peer {:?}: {}", addr, e);
2025-11-09T23:19:32.2946753Z              }
2025-11-09T23:19:32.2946867Z          }
2025-11-09T23:19:32.2947325Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1443:
2025-11-09T23:19:32.2947442Z -        
2025-11-09T23:19:32.2947556Z +
2025-11-09T23:19:32.2947713Z          // Then send to remaining peers
2025-11-09T23:19:32.2947911Z          let pm = self.peer_manager.lock().unwrap();
2025-11-09T23:19:32.2948081Z          let all_peers = pm.peer_addresses();
2025-11-09T23:19:32.2948519Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1447:
2025-11-09T23:19:32.2948729Z -        let remaining_peers: Vec<_> = all_peers.iter()
2025-11-09T23:19:32.2948901Z +        let remaining_peers: Vec<_> = all_peers
2025-11-09T23:19:32.2949023Z +            .iter()
2025-11-09T23:19:32.2949309Z              .filter(|addr| !reliable_peers.contains(addr))
2025-11-09T23:19:32.2949711Z              .collect();
2025-11-09T23:19:32.2949846Z          drop(pm);
2025-11-09T23:19:32.2950302Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1451:
2025-11-09T23:19:32.2950428Z -        
2025-11-09T23:19:32.2950539Z +
2025-11-09T23:19:32.2950694Z          for addr in remaining_peers {
2025-11-09T23:19:32.2951059Z -            if let Err(e) = self.send_to_peer_by_transport(addr.clone(), message.clone()).await {
2025-11-09T23:19:32.2951198Z +            if let Err(e) = self
2025-11-09T23:19:32.2951441Z +                .send_to_peer_by_transport(addr.clone(), message.clone())
2025-11-09T23:19:32.2951571Z +                .await
2025-11-09T23:19:32.2951700Z +            {
2025-11-09T23:19:32.2961620Z                  warn!("Failed to send to peer {:?}: {}", addr, e);
2025-11-09T23:19:32.2961799Z              }
2025-11-09T23:19:32.2961922Z          }
2025-11-09T23:19:32.2962429Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1457:
2025-11-09T23:19:32.2962565Z -        
2025-11-09T23:19:32.2962687Z +
2025-11-09T23:19:32.2962809Z          Ok(())
2025-11-09T23:19:32.2962927Z      }
2025-11-09T23:19:32.2963056Z  
2025-11-09T23:19:32.2963539Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1464:
2025-11-09T23:19:32.2963740Z          let pm = self.peer_manager.lock().unwrap();
2025-11-09T23:19:32.2963926Z          let best_peers = pm.select_best_peers(1);
2025-11-09T23:19:32.2964065Z          drop(pm);
2025-11-09T23:19:32.2964181Z -        
2025-11-09T23:19:32.2964291Z +
2025-11-09T23:19:32.2964647Z          if let Some(addr) = best_peers.first() {
2025-11-09T23:19:32.2964923Z -            self.send_to_peer_by_transport(addr.clone(), message).await?;
2025-11-09T23:19:32.2965164Z +            self.send_to_peer_by_transport(addr.clone(), message)
2025-11-09T23:19:32.2965289Z +                .await?;
2025-11-09T23:19:32.2965434Z              Ok(addr.clone())
2025-11-09T23:19:32.2965565Z          } else {
2025-11-09T23:19:32.2966015Z              Err(anyhow::anyhow!("No peers available"))
2025-11-09T23:19:32.2966518Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1479:
2025-11-09T23:19:32.2968428Z          let pm = self.peer_manager.lock().unwrap();
2025-11-09T23:19:32.2968637Z          let reliable_peers = pm.select_reliable_peers();
2025-11-09T23:19:32.2968775Z          drop(pm);
2025-11-09T23:19:32.2968893Z -        
2025-11-09T23:19:32.2969009Z +
2025-11-09T23:19:32.2969168Z          if reliable_peers.is_empty() {
2025-11-09T23:19:32.2969459Z              return Err(anyhow::anyhow!("No reliable peers available"));
2025-11-09T23:19:32.2969574Z          }
2025-11-09T23:19:32.2970046Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1486:
2025-11-09T23:19:32.2970167Z -        
2025-11-09T23:19:32.2970277Z +
2025-11-09T23:19:32.2970434Z          // Select best reliable peer
2025-11-09T23:19:32.2970636Z          let pm = self.peer_manager.lock().unwrap();
2025-11-09T23:19:32.2971263Z -        let best_reliable = reliable_peers.iter()
2025-11-09T23:19:32.2971415Z -            .max_by(|a, b| {
2025-11-09T23:19:32.2971741Z -                let score_a = pm.get_peer(a).map(|p| p.quality_score()).unwrap_or(0.0);
2025-11-09T23:19:32.2972039Z -                let score_b = pm.get_peer(b).map(|p| p.quality_score()).unwrap_or(0.0);
2025-11-09T23:19:32.2972357Z -                score_a.partial_cmp(&score_b).unwrap_or(std::cmp::Ordering::Equal)
2025-11-09T23:19:32.2972474Z -            });
2025-11-09T23:19:32.2972731Z +        let best_reliable = reliable_peers.iter().max_by(|a, b| {
2025-11-09T23:19:32.2973016Z +            let score_a = pm.get_peer(a).map(|p| p.quality_score()).unwrap_or(0.0);
2025-11-09T23:19:32.2973293Z +            let score_b = pm.get_peer(b).map(|p| p.quality_score()).unwrap_or(0.0);
2025-11-09T23:19:32.2973416Z +            score_a
2025-11-09T23:19:32.2973581Z +                .partial_cmp(&score_b)
2025-11-09T23:19:32.2974016Z +                .unwrap_or(std::cmp::Ordering::Equal)
2025-11-09T23:19:32.2974142Z +        });
2025-11-09T23:19:32.2974277Z          drop(pm);
2025-11-09T23:19:32.2974545Z -        
2025-11-09T23:19:32.2974659Z +
2025-11-09T23:19:32.2974827Z          if let Some(addr) = best_reliable {
2025-11-09T23:19:32.2975102Z -            self.send_to_peer_by_transport(addr.clone(), message).await?;
2025-11-09T23:19:32.2975326Z +            self.send_to_peer_by_transport(addr.clone(), message)
2025-11-09T23:19:32.2975454Z +                .await?;
2025-11-09T23:19:32.2975597Z              Ok(addr.clone())
2025-11-09T23:19:32.2975719Z          } else {
2025-11-09T23:19:32.2975945Z              Err(anyhow::anyhow!("No reliable peers available"))
2025-11-09T23:19:32.2976409Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1509:
2025-11-09T23:19:32.2976549Z          let transport_addr = {
2025-11-09T23:19:32.2976727Z              let pm = self.peer_manager.lock().unwrap();
2025-11-09T23:19:32.2976916Z              pm.find_transport_addr_by_socket(addr)
2025-11-09T23:19:32.2977047Z -                .or_else(|| {
2025-11-09T23:19:32.2977316Z -                    self.socket_to_transport.lock().unwrap().get(&addr).cloned()
2025-11-09T23:19:32.2977426Z -                })
2025-11-09T23:19:32.2977740Z +                .or_else(|| self.socket_to_transport.lock().unwrap().get(&addr).cloned())
2025-11-09T23:19:32.2977849Z          };
2025-11-09T23:19:32.2977956Z -        
2025-11-09T23:19:32.2978063Z +
2025-11-09T23:19:32.2978266Z          if let Some(transport_addr) = transport_addr {
2025-11-09T23:19:32.2978536Z -            self.send_to_peer_by_transport(transport_addr, message).await
2025-11-09T23:19:32.2978769Z +            self.send_to_peer_by_transport(transport_addr, message)
2025-11-09T23:19:32.2978961Z +                .await
2025-11-09T23:19:32.2979075Z          } else {
2025-11-09T23:19:32.2979283Z              // Fallback: try TCP (for backward compatibility)
2025-11-09T23:19:32.2979826Z -            self.send_to_peer_by_transport(TransportAddr::Tcp(addr), message).await
2025-11-09T23:19:32.2980123Z +            self.send_to_peer_by_transport(TransportAddr::Tcp(addr), message)
2025-11-09T23:19:32.2980241Z +                .await
2025-11-09T23:19:32.2980355Z          }
2025-11-09T23:19:32.2980468Z      }
2025-11-09T23:19:32.2980584Z -    
2025-11-09T23:19:32.2980698Z +
2025-11-09T23:19:32.2981077Z      /// Send a message to a specific peer (by TransportAddr - supports all transports)
2025-11-09T23:19:32.2981541Z -    pub async fn send_to_peer_by_transport(&self, addr: TransportAddr, message: Vec<u8>) -> Result<()> {
2025-11-09T23:19:32.2981712Z +    pub async fn send_to_peer_by_transport(
2025-11-09T23:19:32.2981824Z +        &self,
2025-11-09T23:19:32.2981975Z +        addr: TransportAddr,
2025-11-09T23:19:32.2982106Z +        message: Vec<u8>,
2025-11-09T23:19:32.2982239Z +    ) -> Result<()> {
2025-11-09T23:19:32.2982410Z          let message_len = message.len();
2025-11-09T23:19:32.2982559Z          // Track bytes sent
2025-11-09T23:19:32.2982749Z          self.track_bytes_sent(message_len as u64);
2025-11-09T23:19:32.2983236Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1530:
2025-11-09T23:19:32.2983357Z -        
2025-11-09T23:19:32.2983471Z +
2025-11-09T23:19:32.2983680Z          let mut pm = self.peer_manager.lock().unwrap();
2025-11-09T23:19:32.2983872Z          if let Some(peer) = pm.get_peer_mut(&addr) {
2025-11-09T23:19:32.2984043Z              peer.send_message(message).await?;
2025-11-09T23:19:32.2984669Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1539:
2025-11-09T23:19:32.2984788Z      }
2025-11-09T23:19:32.2984894Z  
2025-11-09T23:19:32.2985072Z      /// Connect to a peer at the given address
2025-11-09T23:19:32.2985191Z -    /// 
2025-11-09T23:19:32.2985314Z +    ///
2025-11-09T23:19:32.2985663Z      /// Attempts to connect using available transports with graceful degradation:
2025-11-09T23:19:32.2986244Z      /// 1. Tries preferred transport (based on transport_preference)
2025-11-09T23:19:32.2986478Z      /// 2. Falls back to TCP if preferred transport fails
2025-11-09T23:19:32.2986941Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1547:
2025-11-09T23:19:32.2987255Z      pub async fn connect_to_peer(&self, addr: SocketAddr) -> Result<()> {
2025-11-09T23:19:32.2987444Z          use crate::network::peer::Peer;
2025-11-09T23:19:32.2987643Z          use crate::network::transport::TransportAddr;
2025-11-09T23:19:32.2987760Z -        
2025-11-09T23:19:32.2987876Z +
2025-11-09T23:19:32.2988249Z          // Check DoS protection: connection rate limiting (for outgoing connections too)
2025-11-09T23:19:32.2988393Z          let ip = addr.ip();
2025-11-09T23:19:32.2990417Z          if !self.dos_protection.check_connection(ip).await {
2025-11-09T23:19:32.2990865Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1554:
2025-11-09T23:19:32.2991299Z -            warn!("Connection rate limit exceeded for IP {}, rejecting outgoing connection", ip);
2025-11-09T23:19:32.2991420Z -            
2025-11-09T23:19:32.2991540Z +            warn!(
2025-11-09T23:19:32.2991887Z +                "Connection rate limit exceeded for IP {}, rejecting outgoing connection",
2025-11-09T23:19:32.2992001Z +                ip
2025-11-09T23:19:32.2992118Z +            );
2025-11-09T23:19:32.2992239Z +
2025-11-09T23:19:32.2992386Z              // Check if we should auto-ban
2025-11-09T23:19:32.2992607Z              if self.dos_protection.should_auto_ban(ip).await {
2025-11-09T23:19:32.2992924Z -                warn!("Auto-banning IP {} for repeated connection rate violations", ip);
2025-11-09T23:19:32.2993050Z +                warn!(
2025-11-09T23:19:32.2993321Z +                    "Auto-banning IP {} for repeated connection rate violations",
2025-11-09T23:19:32.2993443Z +                    ip
2025-11-09T23:19:32.2993582Z +                );
2025-11-09T23:19:32.2993713Z                  // Ban the IP
2025-11-09T23:19:32.2994140Z                  let unban_timestamp = std::time::SystemTime::now()
2025-11-09T23:19:32.2995038Z                      .duration_since(std::time::UNIX_EPOCH)
2025-11-09T23:19:32.2995543Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1564:
2025-11-09T23:19:32.2995689Z                      + 3600; // Ban for 1 hour
2025-11-09T23:19:32.2995913Z                  let mut ban_list = self.ban_list.lock().unwrap();
2025-11-09T23:19:32.2996097Z                  ban_list.insert(addr, unban_timestamp);
2025-11-09T23:19:32.2996469Z -                return Err(anyhow::anyhow!("IP {} is banned due to connection rate violations", ip));
2025-11-09T23:19:32.2996624Z +                return Err(anyhow::anyhow!(
2025-11-09T23:19:32.2996849Z +                    "IP {} is banned due to connection rate violations",
2025-11-09T23:19:32.2996976Z +                    ip
2025-11-09T23:19:32.2997108Z +                ));
2025-11-09T23:19:32.2997225Z              }
2025-11-09T23:19:32.2997346Z -            
2025-11-09T23:19:32.2997707Z -            return Err(anyhow::anyhow!("Connection rate limit exceeded for IP {}", ip));
2025-11-09T23:19:32.2997814Z +
2025-11-09T23:19:32.2997979Z +            return Err(anyhow::anyhow!(
2025-11-09T23:19:32.2998172Z +                "Connection rate limit exceeded for IP {}",
2025-11-09T23:19:32.2998289Z +                ip
2025-11-09T23:19:32.2998407Z +            ));
2025-11-09T23:19:32.2998520Z          }
2025-11-09T23:19:32.2998626Z -        
2025-11-09T23:19:32.2998730Z +
2025-11-09T23:19:32.2998941Z          // Eclipse attack prevention: check IP diversity
2025-11-09T23:19:32.2999123Z          if !self.check_eclipse_prevention(ip) {
2025-11-09T23:19:32.2999295Z              let prefix = self.get_ip_prefix(ip);
2025-11-09T23:19:32.2999767Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1576:
2025-11-09T23:19:32.3000528Z              warn!("Eclipse attack prevention: too many connections from IP range {:?}, rejecting connection from {}", 
2025-11-09T23:19:32.3000674Z                    prefix, ip);
2025-11-09T23:19:32.3003278Z -            return Err(anyhow::anyhow!("Eclipse attack prevention: too many connections from IP range"));
2025-11-09T23:19:32.3003446Z +            return Err(anyhow::anyhow!(
2025-11-09T23:19:32.3003744Z +                "Eclipse attack prevention: too many connections from IP range"
2025-11-09T23:19:32.3003860Z +            ));
2025-11-09T23:19:32.3003983Z          }
2025-11-09T23:19:32.3004095Z -        
2025-11-09T23:19:32.3004200Z +
2025-11-09T23:19:32.3004488Z          let mut last_error = None;
2025-11-09T23:19:32.3004602Z -        
2025-11-09T23:19:32.3004717Z +
2025-11-09T23:19:32.3004998Z          // Try transports in preference order with graceful degradation
2025-11-09T23:19:32.3005279Z          let transports_to_try = self.get_transports_for_connection();
2025-11-09T23:19:32.3005405Z -        
2025-11-09T23:19:32.3005509Z +
2025-11-09T23:19:32.3005697Z          for transport_type in transports_to_try {
2025-11-09T23:19:32.3005993Z              match self.try_connect_with_transport(&transport_type, addr).await {
2025-11-09T23:19:32.3006156Z                  Ok((peer, transport_addr)) => {
2025-11-09T23:19:32.3006610Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1591:
2025-11-09T23:19:32.3006809Z                          let mut pm = self.peer_manager.lock().unwrap();
2025-11-09T23:19:32.3007006Z                          pm.add_peer(transport_addr.clone(), peer)?;
2025-11-09T23:19:32.3007124Z                      }
2025-11-09T23:19:32.3007251Z -                    
2025-11-09T23:19:32.3007363Z +
2025-11-09T23:19:32.3007665Z                      // Note: Peer handler is managed by Peer::from_transport_connection
2025-11-09T23:19:32.3007848Z                      // No need to spawn additional handler task
2025-11-09T23:19:32.3007970Z -                    
2025-11-09T23:19:32.3008642Z -                    info!("Successfully connected to {} via {:?} (transport: {:?})", addr, transport_type, transport_addr);
2025-11-09T23:19:32.3008777Z +
2025-11-09T23:19:32.3008908Z +                    info!(
2025-11-09T23:19:32.3009170Z +                        "Successfully connected to {} via {:?} (transport: {:?})",
2025-11-09T23:19:32.3009353Z +                        addr, transport_type, transport_addr
2025-11-09T23:19:32.3009474Z +                    );
2025-11-09T23:19:32.3009610Z                      return Ok(());
2025-11-09T23:19:32.3009717Z                  }
2025-11-09T23:19:32.3009845Z                  Err(e) => {
2025-11-09T23:19:32.3010302Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1602:
2025-11-09T23:19:32.3010607Z -                    warn!("Failed to connect to {} via {:?}: {}", addr, transport_type, e);
2025-11-09T23:19:32.3010735Z +                    warn!(
2025-11-09T23:19:32.3010930Z +                        "Failed to connect to {} via {:?}: {}",
2025-11-09T23:19:32.3011096Z +                        addr, transport_type, e
2025-11-09T23:19:32.3011215Z +                    );
2025-11-09T23:19:32.3011369Z                      last_error = Some(e);
2025-11-09T23:19:32.3011528Z                      // Continue to next transport
2025-11-09T23:19:32.3011633Z                  }
2025-11-09T23:19:32.3012079Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1606:
2025-11-09T23:19:32.3012197Z              }
2025-11-09T23:19:32.3012309Z          }
2025-11-09T23:19:32.3012414Z -        
2025-11-09T23:19:32.3012527Z +
2025-11-09T23:19:32.3012673Z          // All transports failed
2025-11-09T23:19:32.3013046Z          Err(last_error.unwrap_or_else(|| anyhow::anyhow!("All transport attempts failed")))
2025-11-09T23:19:32.3013168Z      }
2025-11-09T23:19:32.3013610Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1612:
2025-11-09T23:19:32.3013935Z -    
2025-11-09T23:19:32.3014038Z +
2025-11-09T23:19:32.3014793Z      /// Helper: Get list of transports to try for a connection
2025-11-09T23:19:32.3015231Z      fn get_transports_for_connection(&self) -> Vec<crate::network::transport::TransportType> {
2025-11-09T23:19:32.3015396Z          let mut transports = Vec::new();
2025-11-09T23:19:32.3015844Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1616:
2025-11-09T23:19:32.3015958Z -        
2025-11-09T23:19:32.3016063Z +
2025-11-09T23:19:32.3016226Z          // Add transports in preference order
2025-11-09T23:19:32.3016410Z          if self.transport_preference.allows_tcp() {
2025-11-09T23:19:32.3016717Z              transports.push(crate::network::transport::TransportType::Tcp);
2025-11-09T23:19:32.3017172Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1620:
2025-11-09T23:19:32.3017293Z          }
2025-11-09T23:19:32.3017400Z -        
2025-11-09T23:19:32.3017520Z +
2025-11-09T23:19:32.3017670Z          #[cfg(feature = "quinn")]
2025-11-09T23:19:32.3017870Z          if self.transport_preference.allows_quinn() {
2025-11-09T23:19:32.3018071Z              if let Some(ref _quinn) = self.quinn_transport {
2025-11-09T23:19:32.3018494Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1625:
2025-11-09T23:19:32.3018826Z                  transports.push(crate::network::transport::TransportType::Quinn);
2025-11-09T23:19:32.3018940Z              }
2025-11-09T23:19:32.3019051Z          }
2025-11-09T23:19:32.3019171Z -        
2025-11-09T23:19:32.3019277Z +
2025-11-09T23:19:32.3019405Z          #[cfg(feature = "iroh")]
2025-11-09T23:19:32.3019601Z          if self.transport_preference.allows_iroh() {
2025-11-09T23:19:32.3019788Z              if let Some(ref _iroh) = self.iroh_transport {
2025-11-09T23:19:32.3020213Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1632:
2025-11-09T23:19:32.3020519Z                  transports.push(crate::network::transport::TransportType::Iroh);
2025-11-09T23:19:32.3020851Z              }
2025-11-09T23:19:32.3022463Z          }
2025-11-09T23:19:32.3022576Z -        
2025-11-09T23:19:32.3022694Z +
2025-11-09T23:19:32.3022908Z          // Always try TCP as fallback if not already in list
2025-11-09T23:19:32.3023301Z -        if !transports.iter().any(|t| matches!(t, crate::network::transport::TransportType::Tcp)) {
2025-11-09T23:19:32.3023432Z +        if !transports
2025-11-09T23:19:32.3023561Z +            .iter()
2025-11-09T23:19:32.3023827Z +            .any(|t| matches!(t, crate::network::transport::TransportType::Tcp))
2025-11-09T23:19:32.3023940Z +        {
2025-11-09T23:19:32.3024244Z              transports.push(crate::network::transport::TransportType::Tcp);
2025-11-09T23:19:32.3024576Z          }
2025-11-09T23:19:32.3024694Z -        
2025-11-09T23:19:32.3024804Z +
2025-11-09T23:19:32.3024923Z          transports
2025-11-09T23:19:32.3025037Z      }
2025-11-09T23:19:32.3025161Z -    
2025-11-09T23:19:32.3025277Z +
2025-11-09T23:19:32.3025493Z      /// Helper: Try connecting with a specific transport
2025-11-09T23:19:32.3026287Z -    async fn try_connect_with_transport(&self, transport_type: &crate::network::transport::TransportType, addr: SocketAddr) -> Result<(peer::Peer, TransportAddr)> {
2025-11-09T23:19:32.3026487Z -        use crate::network::transport::TransportAddr;
2025-11-09T23:19:32.3026650Z +    async fn try_connect_with_transport(
2025-11-09T23:19:32.3026765Z +        &self,
2025-11-09T23:19:32.3027020Z +        transport_type: &crate::network::transport::TransportType,
2025-11-09T23:19:32.3027160Z +        addr: SocketAddr,
2025-11-09T23:19:32.3027330Z +    ) -> Result<(peer::Peer, TransportAddr)> {
2025-11-09T23:19:32.3027481Z          use crate::network::peer::Peer;
2025-11-09T23:19:32.3027592Z -        
2025-11-09T23:19:32.3027773Z +        use crate::network::transport::TransportAddr;
2025-11-09T23:19:32.3027876Z +
2025-11-09T23:19:32.3028247Z          match transport_type {
2025-11-09T23:19:32.3028494Z              crate::network::transport::TransportType::Tcp => {
2025-11-09T23:19:32.3028693Z                  // Use TcpTransport to create connection properly
2025-11-09T23:19:32.3029134Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1684:
2025-11-09T23:19:32.3029359Z              crate::network::transport::TransportType::Iroh => {
2025-11-09T23:19:32.3029535Z                  // Iroh requires public key, not SocketAddr
2025-11-09T23:19:32.3029839Z                  // For now, return error - would need peer discovery or address resolution
2025-11-09T23:19:32.3030174Z -                Err(anyhow::anyhow!("Iroh transport requires public key, not SocketAddr"))
2025-11-09T23:19:32.3030669Z +                Err(anyhow::anyhow!(
2025-11-09T23:19:32.3030898Z +                    "Iroh transport requires public key, not SocketAddr"
2025-11-09T23:19:32.3031022Z +                ))
2025-11-09T23:19:32.3031148Z              }
2025-11-09T23:19:32.3031253Z          }
2025-11-09T23:19:32.3031361Z      }
2025-11-09T23:19:32.3031803Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1691:
2025-11-09T23:19:32.3031910Z -    
2025-11-09T23:19:32.3032019Z +
2025-11-09T23:19:32.3032195Z      /// Send ping message to all connected peers
2025-11-09T23:19:32.3032401Z      pub async fn ping_all_peers(&self) -> Result<()> {
2025-11-09T23:19:32.3032757Z -        use crate::network::protocol::{ProtocolMessage, ProtocolParser, PingMessage};
2025-11-09T23:19:32.3033103Z +        use crate::network::protocol::{PingMessage, ProtocolMessage, ProtocolParser};
2025-11-09T23:19:32.3033271Z          use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:19:32.3033383Z -        
2025-11-09T23:19:32.3033489Z +
2025-11-09T23:19:32.3033644Z          // Generate nonce for ping
2025-11-09T23:19:32.3033801Z          let nonce = SystemTime::now()
2025-11-09T23:19:32.3033946Z              .duration_since(UNIX_EPOCH)
2025-11-09T23:19:32.3034789Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1700:
2025-11-09T23:19:32.3034946Z              .unwrap()
2025-11-09T23:19:32.3035075Z              .as_nanos() as u64;
2025-11-09T23:19:32.3035183Z -        
2025-11-09T23:19:32.3035298Z +
2025-11-09T23:19:32.3035562Z          let ping_msg = ProtocolMessage::Ping(PingMessage { nonce });
2025-11-09T23:19:32.3035830Z          let wire_msg = ProtocolParser::serialize_message(&ping_msg)?;
2025-11-09T23:19:32.3035938Z -        
2025-11-09T23:19:32.3036045Z +
2025-11-09T23:19:32.3036325Z          let peer_addrs = self.peer_manager.lock().unwrap().peer_addresses();
2025-11-09T23:19:32.3036452Z          for addr in peer_addrs {
2025-11-09T23:19:32.3036831Z              // Convert TransportAddr to SocketAddr for send_to_peer, or use send_to_peer_by_transport
2025-11-09T23:19:32.3037238Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1726:
2025-11-09T23:19:32.3037350Z                  }
2025-11-09T23:19:32.3037454Z              }
2025-11-09T23:19:32.3037569Z          }
2025-11-09T23:19:32.3037668Z -        
2025-11-09T23:19:32.3037766Z +
2025-11-09T23:19:32.3037882Z          Ok(())
2025-11-09T23:19:32.3037983Z      }
2025-11-09T23:19:32.3038079Z  
2025-11-09T23:19:32.3038469Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1761:
2025-11-09T23:19:32.3038779Z          // Track message queue size manually (unbounded channel doesn't have len())
2025-11-09T23:19:32.3038925Z          let mut message_count = 0u64;
2025-11-09T23:19:32.3039169Z          let mut last_metrics_update = std::time::SystemTime::now();
2025-11-09T23:19:32.3039282Z -        
2025-11-09T23:19:32.3039397Z +
2025-11-09T23:19:32.3039621Z          while let Some(message) = self.peer_rx.recv().await {
2025-11-09T23:19:32.3039762Z              message_count += 1;
2025-11-09T23:19:32.3039884Z -            
2025-11-09T23:19:32.3039995Z +
2025-11-09T23:19:32.3040546Z              // Update metrics periodically (every 100 messages or 10 seconds)
2025-11-09T23:19:32.3040747Z              let now = std::time::SystemTime::now();
2025-11-09T23:19:32.3040930Z -            let should_update = message_count % 100 == 0 
2025-11-09T23:19:32.3041112Z +            let should_update = message_count % 100 == 0
2025-11-09T23:19:32.3041420Z                  || now.duration_since(last_metrics_update).unwrap().as_secs() >= 10;
2025-11-09T23:19:32.3041538Z -            
2025-11-09T23:19:32.3041648Z +
2025-11-09T23:19:32.3041857Z              if should_update {
2025-11-09T23:19:32.3042060Z                  let pm = self.peer_manager.lock().unwrap();
2025-11-09T23:19:32.3042250Z                  let active_connections = pm.peer_count();
2025-11-09T23:19:32.3042701Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1776:
2025-11-09T23:19:32.3042969Z                  let bytes_received = *self.bytes_received.lock().unwrap();
2025-11-09T23:19:32.3043197Z                  let bytes_sent = *self.bytes_sent.lock().unwrap();
2025-11-09T23:19:32.3043327Z -                
2025-11-09T23:19:32.3043440Z +
2025-11-09T23:19:32.3043737Z                  // Approximate queue size (messages processed since last check)
2025-11-09T23:19:32.3043921Z                  let queue_size = message_count as usize;
2025-11-09T23:19:32.3044037Z -                
2025-11-09T23:19:32.3044153Z +
2025-11-09T23:19:32.3044452Z                  // Check message queue size limit
2025-11-09T23:19:32.3044763Z -                if !self.dos_protection.check_message_queue_size(queue_size).await {
2025-11-09T23:19:32.3045217Z -                    warn!("Message queue size limit exceeded (processed {} messages), potential DoS", queue_size);
2025-11-09T23:19:32.3045346Z +                if !self
2025-11-09T23:19:32.3045484Z +                    .dos_protection
2025-11-09T23:19:32.3045659Z +                    .check_message_queue_size(queue_size)
2025-11-09T23:19:32.3045789Z +                    .await
2025-11-09T23:19:32.3045918Z +                {
2025-11-09T23:19:32.3046269Z +                    warn!(
2025-11-09T23:19:32.3046652Z +                        "Message queue size limit exceeded (processed {} messages), potential DoS",
2025-11-09T23:19:32.3046794Z +                        queue_size
2025-11-09T23:19:32.3046915Z +                    );
2025-11-09T23:19:32.3047084Z                      // Optionally detect DoS attack
2025-11-09T23:19:32.3047317Z                      if self.dos_protection.detect_dos_attack().await {
2025-11-09T23:19:32.3047673Z                          warn!("DoS attack detected - message queue and connections at high levels");
2025-11-09T23:19:32.3048131Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1790:
2025-11-09T23:19:32.3048324Z                      // Reset counter to prevent false positives
2025-11-09T23:19:32.3048468Z                      message_count = 0;
2025-11-09T23:19:32.3048582Z                  }
2025-11-09T23:19:32.3048704Z -                
2025-11-09T23:19:32.3048880Z -                self.dos_protection.update_metrics(
2025-11-09T23:19:32.3049030Z -                    active_connections,
2025-11-09T23:19:32.3049172Z -                    queue_size,
2025-11-09T23:19:32.3049314Z -                    bytes_received,
2025-11-09T23:19:32.3049442Z -                    bytes_sent,
2025-11-09T23:19:32.3049557Z -                ).await;
2025-11-09T23:19:32.3049668Z -                
2025-11-09T23:19:32.3049777Z +
2025-11-09T23:19:32.3049918Z +                self.dos_protection
2025-11-09T23:19:32.3050280Z +                    .update_metrics(active_connections, queue_size, bytes_received, bytes_sent)
2025-11-09T23:19:32.3050417Z +                    .await;
2025-11-09T23:19:32.3050529Z +
2025-11-09T23:19:32.3050686Z                  last_metrics_update = now;
2025-11-09T23:19:32.3050874Z                  message_count = 0; // Reset after update
2025-11-09T23:19:32.3050984Z              }
2025-11-09T23:19:32.3051416Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1811:
2025-11-09T23:19:32.3051862Z                      let mut pm = self.peer_manager.lock().unwrap();
2025-11-09T23:19:32.3052056Z                      // Remove peer directly using TransportAddr
2025-11-09T23:19:32.3052192Z                      pm.remove_peer(&addr);
2025-11-09T23:19:32.3052308Z -                    
2025-11-09T23:19:32.3052429Z +
2025-11-09T23:19:32.3052703Z                      // Clean up per-IP connection count (only for TCP/Quinn, not Iroh)
2025-11-09T23:19:32.3052849Z                      if let Some(ip) = match &addr {
2025-11-09T23:19:32.3053051Z                          TransportAddr::Tcp(sock) => Some(sock.ip()),
2025-11-09T23:19:32.3053467Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1828:
2025-11-09T23:19:32.3053592Z                              }
2025-11-09T23:19:32.3053707Z                          }
2025-11-09T23:19:32.3053818Z                      }
2025-11-09T23:19:32.3053932Z -                    
2025-11-09T23:19:32.3054030Z +
2025-11-09T23:19:32.3054494Z                      // Clean up rate limiter (use SocketAddr for TCP/Quinn, or a key for Iroh)
2025-11-09T23:19:32.3054619Z                      {
2025-11-09T23:19:32.3054866Z                          let mut rates = self.peer_message_rates.lock().unwrap();
2025-11-09T23:19:32.3055283Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1844:
2025-11-09T23:19:32.3055431Z                              rates.remove(&sock_addr);
2025-11-09T23:19:32.3055538Z                          }
2025-11-09T23:19:32.3055641Z                      }
2025-11-09T23:19:32.3055752Z -                    
2025-11-09T23:19:32.3055852Z +
2025-11-09T23:19:32.3056030Z                      // Clean up eclipse attack prevention tracking
2025-11-09T23:19:32.3056178Z                      if let Some(ip) = match &addr {
2025-11-09T23:19:32.3056365Z                          TransportAddr::Tcp(sock) => Some(sock.ip()),
2025-11-09T23:19:32.3058987Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1967:
2025-11-09T23:19:32.3059102Z                      {
2025-11-09T23:19:32.3059302Z                          let mut pm = self.peer_manager.lock().unwrap();
2025-11-09T23:19:32.3059540Z                          // Try to find peer by SocketAddr (TCP or Quinn, or Iroh mapping)
2025-11-09T23:19:32.3059802Z -                        let transport_addr = pm.find_transport_addr_by_socket(peer_addr)
2025-11-09T23:19:32.3059935Z -                            .or_else(|| {
2025-11-09T23:19:32.3060071Z +                        let transport_addr =
2025-11-09T23:19:32.3060301Z +                            pm.find_transport_addr_by_socket(peer_addr).or_else(|| {
2025-11-09T23:19:32.3060794Z                                  // Check Iroh mapping
2025-11-09T23:19:32.3061086Z -                                self.socket_to_transport.lock().unwrap().get(&peer_addr).cloned()
2025-11-09T23:19:32.3061252Z +                                self.socket_to_transport
2025-11-09T23:19:32.3061391Z +                                    .lock()
2025-11-09T23:19:32.3061519Z +                                    .unwrap()
2025-11-09T23:19:32.3061656Z +                                    .get(&peer_addr)
2025-11-09T23:19:32.3061777Z +                                    .cloned()
2025-11-09T23:19:32.3061896Z                              });
2025-11-09T23:19:32.3062082Z                          if let Some(transport_addr) = transport_addr {
2025-11-09T23:19:32.3062306Z                              if let Some(peer) = pm.get_peer_mut(&transport_addr) {
2025-11-09T23:19:32.3062750Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1978:
2025-11-09T23:19:32.3062877Z                              }
2025-11-09T23:19:32.3063001Z                          }
2025-11-09T23:19:32.3063141Z                      }
2025-11-09T23:19:32.3063271Z -                    
2025-11-09T23:19:32.3063597Z +
2025-11-09T23:19:32.3063788Z                      // Check rate limiting before processing
2025-11-09T23:19:32.3064054Z                      let mut rates = self.peer_message_rates.lock().unwrap();
2025-11-09T23:19:32.3064498Z                      let rate_limiter = rates.entry(peer_addr).or_insert_with(|| {
2025-11-09T23:19:32.3064960Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1985:
2025-11-09T23:19:32.3065154Z                          // Default: 100 burst, 10 messages/second
2025-11-09T23:19:32.3065342Z                          PeerRateLimiter::new(100, 10)
2025-11-09T23:19:32.3065466Z                      });
2025-11-09T23:19:32.3065587Z -                    
2025-11-09T23:19:32.3065709Z +
2025-11-09T23:19:32.3065891Z                      if !rate_limiter.check_and_consume() {
2025-11-09T23:19:32.3066208Z -                        warn!("Rate limit exceeded for peer {}, dropping message", peer_addr);
2025-11-09T23:19:32.3066345Z +                        warn!(
2025-11-09T23:19:32.3066603Z +                            "Rate limit exceeded for peer {}, dropping message",
2025-11-09T23:19:32.3066746Z +                            peer_addr
2025-11-09T23:19:32.3066874Z +                        );
2025-11-09T23:19:32.3067139Z                          // Optionally ban peer after repeated rate limit violations
2025-11-09T23:19:32.3067311Z                          // For now, just drop the message
2025-11-09T23:19:32.3067446Z                          continue;
2025-11-09T23:19:32.3067899Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1994:
2025-11-09T23:19:32.3068022Z                      }
2025-11-09T23:19:32.3068155Z                      drop(rates);
2025-11-09T23:19:32.3068280Z -                    
2025-11-09T23:19:32.3068390Z +
2025-11-09T23:19:32.3070491Z                      // Check if this is a response to a pending request (UTXOSet or FilteredBlock)
2025-11-09T23:19:32.3070815Z                      // Extract request_id from message and route to correct pending request
2025-11-09T23:19:32.3071337Z                      if let Ok(parsed) = ProtocolParser::parse_message(&data) {
2025-11-09T23:19:32.3071814Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2002:
2025-11-09T23:19:32.3072129Z                              ProtocolMessage::FilteredBlock(msg) => Some(msg.request_id),
2025-11-09T23:19:32.3072264Z                              _ => None,
2025-11-09T23:19:32.3072388Z                          };
2025-11-09T23:19:32.3072508Z -                        
2025-11-09T23:19:32.3072624Z +
2025-11-09T23:19:32.3072812Z                          if let Some(request_id) = request_id_opt {
2025-11-09T23:19:32.3072994Z                              // Route to pending request by request_id
2025-11-09T23:19:32.3073251Z                              let mut pending = self.pending_requests.lock().unwrap();
2025-11-09T23:19:32.3074210Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2015:
2025-11-09T23:19:32.3074543Z                              }
2025-11-09T23:19:32.3074682Z                          }
2025-11-09T23:19:32.3074810Z                      }
2025-11-09T23:19:32.3074935Z -                    
2025-11-09T23:19:32.3075050Z +
2025-11-09T23:19:32.3075239Z                      // Process through protocol layer
2025-11-09T23:19:32.3075530Z                      if let Err(e) = self.handle_incoming_wire_tcp(peer_addr, data).await {
2025-11-09T23:19:32.3075794Z                          warn!("Failed to process message from {}: {}", peer_addr, e);
2025-11-09T23:19:32.3076252Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2034:
2025-11-09T23:19:32.3076459Z      /// 3. Creates NodeChainAccess from storage modules
2025-11-09T23:19:32.3076724Z      /// 4. Calls bllvm_protocol::network::process_network_message()
2025-11-09T23:19:32.3077059Z      /// 5. Converts NetworkResponse back to wire format and enqueues for sending
2025-11-09T23:19:32.3077745Z -    pub async fn handle_incoming_wire_tcp(&self, peer_addr: SocketAddr, data: Vec<u8>) -> Result<()> {
2025-11-09T23:19:32.3077924Z +    pub async fn handle_incoming_wire_tcp(
2025-11-09T23:19:32.3078046Z +        &self,
2025-11-09T23:19:32.3078194Z +        peer_addr: SocketAddr,
2025-11-09T23:19:32.3078322Z +        data: Vec<u8>,
2025-11-09T23:19:32.3078451Z +    ) -> Result<()> {
2025-11-09T23:19:32.3078601Z          // Track bytes received
2025-11-09T23:19:32.3078797Z          self.track_bytes_received(data.len() as u64);
2025-11-09T23:19:32.3078917Z -        
2025-11-09T23:19:32.3079031Z +
2025-11-09T23:19:32.3079176Z          // Check if peer is banned
2025-11-09T23:19:32.3079329Z          if self.is_banned(peer_addr) {
2025-11-09T23:19:32.3079586Z              warn!("Rejecting message from banned peer: {}", peer_addr);
2025-11-09T23:19:32.3081404Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2044:
2025-11-09T23:19:32.3081637Z              return Ok(()); // Silently drop messages from banned peers
2025-11-09T23:19:32.3081763Z          }
2025-11-09T23:19:32.3081991Z          let parsed = ProtocolParser::parse_message(&data)?;
2025-11-09T23:19:32.3082109Z -        
2025-11-09T23:19:32.3082221Z +
2025-11-09T23:19:32.3082475Z          // Handle special cases that don't go through protocol layer
2025-11-09T23:19:32.3082614Z          match parsed {
2025-11-09T23:19:32.3082731Z              // BIP331
2025-11-09T23:19:32.3083164Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2097:
2025-11-09T23:19:32.3083353Z                  // Continue to protocol layer processing
2025-11-09T23:19:32.3083465Z              }
2025-11-09T23:19:32.3083577Z          }
2025-11-09T23:19:32.3083691Z -        
2025-11-09T23:19:32.3083808Z +
2025-11-09T23:19:32.3084062Z          // Process with protocol layer if dependencies are available
2025-11-09T23:19:32.3084594Z -        if let (Some(ref protocol_engine), Some(ref storage), Some(ref mempool_manager)) = 
2025-11-09T23:19:32.3085248Z -            (self.protocol_engine.as_ref(), self.storage.as_ref(), self.mempool_manager.as_ref()) {
2025-11-09T23:19:32.3085380Z -            
2025-11-09T23:19:32.3085744Z +        if let (Some(ref protocol_engine), Some(ref storage), Some(ref mempool_manager)) = (
2025-11-09T23:19:32.3085909Z +            self.protocol_engine.as_ref(),
2025-11-09T23:19:32.3086057Z +            self.storage.as_ref(),
2025-11-09T23:19:32.3086205Z +            self.mempool_manager.as_ref(),
2025-11-09T23:19:32.3086320Z +        ) {
2025-11-09T23:19:32.3086649Z              // Convert ProtocolMessage to bllvm_protocol::network::NetworkMessage
2025-11-09T23:19:32.3086881Z              use crate::network::protocol_adapter::ProtocolAdapter;
2025-11-09T23:19:32.3087240Z              let protocol_msg = ProtocolAdapter::protocol_to_consensus_message(&parsed)?;
2025-11-09T23:19:32.3087684Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2108:
2025-11-09T23:19:32.3087808Z -            
2025-11-09T23:19:32.3087918Z +
2025-11-09T23:19:32.3088078Z              // Get or create PeerState
2025-11-09T23:19:32.3088321Z              let mut peer_states = self.peer_states.lock().unwrap();
2025-11-09T23:19:32.3088519Z -            let peer_state = peer_states.entry(peer_addr)
2025-11-09T23:19:32.3088673Z +            let peer_state = peer_states
2025-11-09T23:19:32.3088822Z +                .entry(peer_addr)
2025-11-09T23:19:32.3089087Z                  .or_insert_with(|| bllvm_protocol::network::PeerState::new());
2025-11-09T23:19:32.3089203Z -            
2025-11-09T23:19:32.3089321Z +
2025-11-09T23:19:32.3089473Z              // Create NodeChainAccess
2025-11-09T23:19:32.3089694Z              use crate::network::chain_access::NodeChainAccess;
2025-11-09T23:19:32.3089880Z              let chain_access = NodeChainAccess::new(
2025-11-09T23:19:32.3090336Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2118:
2025-11-09T23:19:32.3093012Z                  storage.transactions(),
2025-11-09T23:19:32.3093208Z                  Arc::clone(mempool_manager),
2025-11-09T23:19:32.3093334Z              );
2025-11-09T23:19:32.3093448Z -            
2025-11-09T23:19:32.3093552Z +
2025-11-09T23:19:32.3093694Z              // Get UTXO set and height
2025-11-09T23:19:32.3093906Z -            let utxo_set = storage.utxos().get_all_utxos()
2025-11-09T23:19:32.3094049Z +            let utxo_set = storage
2025-11-09T23:19:32.3094179Z +                .utxos()
2025-11-09T23:19:32.3094492Z +                .get_all_utxos()
2025-11-09T23:19:32.3094771Z                  .map_err(|e| anyhow::anyhow!("Failed to get UTXO set: {}", e))?;
2025-11-09T23:19:32.3094956Z -            let height = storage.chain().get_height()
2025-11-09T23:19:32.3095090Z +            let height = storage
2025-11-09T23:19:32.3095212Z +                .chain()
2025-11-09T23:19:32.3095340Z +                .get_height()
2025-11-09T23:19:32.3095594Z                  .map_err(|e| anyhow::anyhow!("Failed to get height: {}", e))?
2025-11-09T23:19:32.3095756Z                  .unwrap_or(0);
2025-11-09T23:19:32.3095867Z -            
2025-11-09T23:19:32.3095978Z +
2025-11-09T23:19:32.3096158Z              // Process message with protocol layer
2025-11-09T23:19:32.3096496Z              use bllvm_protocol::network::{process_network_message, ChainStateAccess};
2025-11-09T23:19:32.3096647Z              match process_network_message(
2025-11-09T23:19:32.3097106Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2140:
2025-11-09T23:19:32.3097376Z                      // Convert response to wire format and send via transport layer
2025-11-09T23:19:32.3097598Z                      use crate::network::message_bridge::MessageBridge;
2025-11-09T23:19:32.3097804Z                      use crate::network::transport::TransportType;
2025-11-09T23:19:32.3098256Z -                    if let Ok(wire_messages) = MessageBridge::extract_send_messages(&response, TransportType::Tcp) {
2025-11-09T23:19:32.3098425Z +                    if let Ok(wire_messages) =
2025-11-09T23:19:32.3099049Z +                        MessageBridge::extract_send_messages(&response, TransportType::Tcp)
2025-11-09T23:19:32.3099195Z +                    {
2025-11-09T23:19:32.3099368Z                          for wire_msg in wire_messages {
2025-11-09T23:19:32.3099629Z                              if let Err(e) = self.send_to_peer(peer_addr, wire_msg).await {
2025-11-09T23:19:32.3099918Z                                  warn!("Failed to send protocol response to {}: {}", peer_addr, e);
2025-11-09T23:19:32.3100365Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2158:
2025-11-09T23:19:32.3102687Z              // Dependencies not set - fall back to old behavior
2025-11-09T23:19:32.3103062Z              debug!("Protocol layer dependencies not set, skipping protocol processing");
2025-11-09T23:19:32.3103177Z          }
2025-11-09T23:19:32.3103291Z -        
2025-11-09T23:19:32.3103484Z +
2025-11-09T23:19:32.3103608Z          Ok(())
2025-11-09T23:19:32.3103727Z      }
2025-11-09T23:19:32.3103834Z  
2025-11-09T23:19:32.3104280Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2360:
2025-11-09T23:19:32.3104669Z          // Handle the request with storage and filter service
2025-11-09T23:19:32.3104907Z          let storage = self.storage.as_ref().map(Arc::clone);
2025-11-09T23:19:32.3105040Z          let response =
2025-11-09T23:19:32.3105498Z -            handle_get_filtered_block(get_filtered_block_msg, storage, Some(&self.filter_service)).await?;
2025-11-09T23:19:32.3105886Z +            handle_get_filtered_block(get_filtered_block_msg, storage, Some(&self.filter_service))
2025-11-09T23:19:32.3106010Z +                .await?;
2025-11-09T23:19:32.3106125Z  
2025-11-09T23:19:32.3106280Z          // Serialize and send response
2025-11-09T23:19:32.3106413Z          let response_wire =
2025-11-09T23:19:32.3106861Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2466:
2025-11-09T23:19:32.3107309Z      /// Handle GetAddr request - return known addresses
2025-11-09T23:19:32.3107604Z      async fn handle_get_addr(&self, peer_addr: SocketAddr) -> Result<()> {
2025-11-09T23:19:32.3107956Z          use crate::network::protocol::{AddrMessage, ProtocolMessage, ProtocolParser};
2025-11-09T23:19:32.3108076Z -        
2025-11-09T23:19:32.3108186Z +
2025-11-09T23:19:32.3108473Z          // Get fresh addresses from database (up to 2500, Bitcoin Core limit)
2025-11-09T23:19:32.3108684Z          let ban_list = self.ban_list.lock().unwrap().clone();
2025-11-09T23:19:32.3108855Z          let connected_peers: Vec<SocketAddr> = {
2025-11-09T23:19:32.3109301Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2473:
2025-11-09T23:19:32.3109497Z              let pm = self.peer_manager.lock().unwrap();
2025-11-09T23:19:32.3109653Z              pm.peer_socket_addresses()
2025-11-09T23:19:32.3109780Z          };
2025-11-09T23:19:32.3109891Z -        
2025-11-09T23:19:32.3110006Z +
2025-11-09T23:19:32.3110144Z          let addresses = {
2025-11-09T23:19:32.3110350Z              let mut db = self.address_database.lock().unwrap();
2025-11-09T23:19:32.3110524Z              let fresh = db.get_fresh_addresses(2500);
2025-11-09T23:19:32.3110959Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2480:
2025-11-09T23:19:32.3111192Z              db.filter_addresses(fresh, &ban_list, &connected_peers)
2025-11-09T23:19:32.3111305Z          };
2025-11-09T23:19:32.3111421Z -        
2025-11-09T23:19:32.3111530Z +
2025-11-09T23:19:32.3111668Z          // Create Addr message
2025-11-09T23:19:32.3111839Z          let addr_msg = AddrMessage { addresses };
2025-11-09T23:19:32.3112044Z          let response = ProtocolMessage::Addr(addr_msg);
2025-11-09T23:19:32.3112473Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2486:
2025-11-09T23:19:32.3112757Z          let wire_msg = ProtocolParser::serialize_message(&response)?;
2025-11-09T23:19:32.3113073Z -        
2025-11-09T23:19:32.3113190Z +
2025-11-09T23:19:32.3113325Z          // Send response
2025-11-09T23:19:32.3113535Z          self.send_to_peer(peer_addr, wire_msg).await?;
2025-11-09T23:19:32.3113654Z          Ok(())
2025-11-09T23:19:32.3114080Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2493:
2025-11-09T23:19:32.3114923Z      /// Handle Addr message - store addresses and optionally relay
2025-11-09T23:19:32.3115281Z      async fn handle_addr(&self, peer_addr: SocketAddr, msg: AddrMessage) -> Result<()> {
2025-11-09T23:19:32.3115478Z          use crate::network::protocol::NetworkAddress;
2025-11-09T23:19:32.3115594Z -        
2025-11-09T23:19:32.3115699Z +
2025-11-09T23:19:32.3115856Z          // Get peer services from peer state
2025-11-09T23:19:32.3115989Z          let peer_services = {
2025-11-09T23:19:32.3116205Z              let peer_states = self.peer_states.lock().unwrap();
2025-11-09T23:19:32.3116652Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2502:
2025-11-09T23:19:32.3116801Z                  .map(|state| state.services)
2025-11-09T23:19:32.3116933Z                  .unwrap_or(0)
2025-11-09T23:19:32.3117053Z          };
2025-11-09T23:19:32.3117166Z -        
2025-11-09T23:19:32.3117278Z +
2025-11-09T23:19:32.3117430Z          // Store addresses in database
2025-11-09T23:19:32.3117536Z          {
2025-11-09T23:19:32.3117735Z              let mut db = self.address_database.lock().unwrap();
2025-11-09T23:19:32.3118169Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2510:
2025-11-09T23:19:32.3118356Z                  db.add_address(addr.clone(), peer_services);
2025-11-09T23:19:32.3118468Z              }
2025-11-09T23:19:32.3118570Z          }
2025-11-09T23:19:32.3118686Z -        
2025-11-09T23:19:32.3118787Z +
2025-11-09T23:19:32.3118997Z          // Relay addresses to other peers (with rate limiting)
2025-11-09T23:19:32.3119466Z          self.relay_addresses(peer_addr, &msg.addresses).await?;
2025-11-09T23:19:32.3119590Z -        
2025-11-09T23:19:32.3119705Z +
2025-11-09T23:19:32.3119823Z          Ok(())
2025-11-09T23:19:32.3119943Z      }
2025-11-09T23:19:32.3120054Z  
2025-11-09T23:19:32.3120505Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2525:
2025-11-09T23:19:32.3121025Z      ) -> Result<()> {
2025-11-09T23:19:32.3121402Z          use crate::network::protocol::{AddrMessage, ProtocolMessage, ProtocolParser};
2025-11-09T23:19:32.3121584Z          use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:19:32.3121705Z -        
2025-11-09T23:19:32.3121807Z +
2025-11-09T23:19:32.3122191Z          // Rate limiting: don't send addr messages too frequently (Bitcoin Core: ~every 2.4 hours)
2025-11-09T23:19:32.3122350Z          let now = SystemTime::now()
2025-11-09T23:19:32.3122514Z              .duration_since(UNIX_EPOCH)
2025-11-09T23:19:32.3122989Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2532:
2025-11-09T23:19:32.3123116Z              .unwrap()
2025-11-09T23:19:32.3123246Z              .as_secs();
2025-11-09T23:19:32.3123494Z          let min_interval = 2 * 60 * 60 + 24 * 60; // 2.4 hours in seconds
2025-11-09T23:19:32.3123608Z -        
2025-11-09T23:19:32.3123720Z +
2025-11-09T23:19:32.3123844Z          {
2025-11-09T23:19:32.3124069Z              let last_sent = *self.last_addr_sent.lock().unwrap();
2025-11-09T23:19:32.3124466Z              if now.saturating_sub(last_sent) < min_interval {
2025-11-09T23:19:32.3124942Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2540:
2025-11-09T23:19:32.3125079Z                  return Ok(());
2025-11-09T23:19:32.3125198Z              }
2025-11-09T23:19:32.3125312Z          }
2025-11-09T23:19:32.3125431Z -        
2025-11-09T23:19:32.3125539Z +
2025-11-09T23:19:32.3125808Z          // Filter addresses (exclude local, banned, already connected)
2025-11-09T23:19:32.3126328Z          let ban_list = self.ban_list.lock().unwrap().clone();
2025-11-09T23:19:32.3127079Z          let connected_peers: Vec<SocketAddr> = {
2025-11-09T23:19:32.3127551Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2547:
2025-11-09T23:19:32.3127755Z              let pm = self.peer_manager.lock().unwrap();
2025-11-09T23:19:32.3127916Z              pm.peer_socket_addresses()
2025-11-09T23:19:32.3128036Z          };
2025-11-09T23:19:32.3128150Z -        
2025-11-09T23:19:32.3128262Z +
2025-11-09T23:19:32.3128397Z          let filtered = {
2025-11-09T23:19:32.3128590Z              let db = self.address_database.lock().unwrap();
2025-11-09T23:19:32.3128898Z              db.filter_addresses(addresses.to_vec(), &ban_list, &connected_peers)
2025-11-09T23:19:32.3129349Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2554:
2025-11-09T23:19:32.3129470Z          };
2025-11-09T23:19:32.3129591Z -        
2025-11-09T23:19:32.3129705Z +
2025-11-09T23:19:32.3129865Z          if filtered.is_empty() {
2025-11-09T23:19:32.3130003Z              return Ok(());
2025-11-09T23:19:32.3130116Z          }
2025-11-09T23:19:32.3130558Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2559:
2025-11-09T23:19:32.3130679Z -        
2025-11-09T23:19:32.3130796Z +
2025-11-09T23:19:32.3131039Z          // Limit to 1000 addresses per message (Bitcoin Core limit)
2025-11-09T23:19:32.3131463Z          let addresses_to_relay: Vec<NetworkAddress> = filtered.into_iter().take(1000).collect();
2025-11-09T23:19:32.3131587Z -        
2025-11-09T23:19:32.3131702Z +
2025-11-09T23:19:32.3131841Z          // Create Addr message
2025-11-09T23:19:32.3131995Z          let addr_msg = AddrMessage {
2025-11-09T23:19:32.3132162Z              addresses: addresses_to_relay,
2025-11-09T23:19:32.3133104Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2566:
2025-11-09T23:19:32.3133517Z          };
2025-11-09T23:19:32.3133766Z          let relay_msg = ProtocolMessage::Addr(addr_msg);
2025-11-09T23:19:32.3134042Z          let wire_msg = ProtocolParser::serialize_message(&relay_msg)?;
2025-11-09T23:19:32.3134158Z -        
2025-11-09T23:19:32.3134487Z +
2025-11-09T23:19:32.3134671Z          // Send to all peers except sender
2025-11-09T23:19:32.3134837Z          let peer_addrs: Vec<SocketAddr> = {
2025-11-09T23:19:32.3135071Z              let pm = self.peer_manager.lock().unwrap();
2025-11-09T23:19:32.3135534Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2575:
2025-11-09T23:19:32.3135704Z                  .filter(|addr| *addr != sender_addr)
2025-11-09T23:19:32.3135830Z                  .collect()
2025-11-09T23:19:32.3135954Z          };
2025-11-09T23:19:32.3136068Z -        
2025-11-09T23:19:32.3136178Z +
2025-11-09T23:19:32.3136331Z          for peer_addr in peer_addrs {
2025-11-09T23:19:32.3137012Z              if let Err(e) = self.send_to_peer(peer_addr, wire_msg.clone()).await {
2025-11-09T23:19:32.3137283Z                  warn!("Failed to relay addresses to {}: {}", peer_addr, e);
2025-11-09T23:19:32.3137743Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2582:
2025-11-09T23:19:32.3137870Z              }
2025-11-09T23:19:32.3137987Z          }
2025-11-09T23:19:32.3138098Z -        
2025-11-09T23:19:32.3138203Z +
2025-11-09T23:19:32.3138348Z          // Update last sent time
2025-11-09T23:19:32.3138524Z          *self.last_addr_sent.lock().unwrap() = now;
2025-11-09T23:19:32.3138631Z -        
2025-11-09T23:19:32.3138742Z +
2025-11-09T23:19:32.3138851Z          Ok(())
2025-11-09T23:19:32.3138958Z      }
2025-11-09T23:19:32.3139062Z  
2025-11-09T23:19:32.3139504Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2593:
2025-11-09T23:19:32.3139676Z          if !self.enable_self_advertisement {
2025-11-09T23:19:32.3139873Z              return Ok(()); // Self-advertisement disabled
2025-11-09T23:19:32.3140214Z          }
2025-11-09T23:19:32.3140334Z -        
2025-11-09T23:19:32.3140815Z -        use crate::network::protocol::{AddrMessage, NetworkAddress, ProtocolMessage, ProtocolParser};
2025-11-09T23:19:32.3140937Z +
2025-11-09T23:19:32.3141099Z +        use crate::network::protocol::{
2025-11-09T23:19:32.3141395Z +            AddrMessage, NetworkAddress, ProtocolMessage, ProtocolParser,
2025-11-09T23:19:32.3141506Z +        };
2025-11-09T23:19:32.3141652Z          use std::net::IpAddr;
2025-11-09T23:19:32.3141762Z -        
2025-11-09T23:19:32.3141873Z +
2025-11-09T23:19:32.3142053Z          // Convert SocketAddr to NetworkAddress
2025-11-09T23:19:32.3142222Z          let ip_bytes = match listen_addr.ip() {
2025-11-09T23:19:32.3142369Z              IpAddr::V4(ipv4) => {
2025-11-09T23:19:32.3142821Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2607:
2025-11-09T23:19:32.3143042Z                  bytes[12..16].copy_from_slice(&ipv4.octets());
2025-11-09T23:19:32.3143169Z                  bytes
2025-11-09T23:19:32.3143283Z              }
2025-11-09T23:19:32.3143432Z -            IpAddr::V6(ipv6) => {
2025-11-09T23:19:32.3143566Z -                ipv6.octets()
2025-11-09T23:19:32.3143679Z -            }
2025-11-09T23:19:32.3143847Z +            IpAddr::V6(ipv6) => ipv6.octets(),
2025-11-09T23:19:32.3143970Z          };
2025-11-09T23:19:32.3144082Z -        
2025-11-09T23:19:32.3144193Z +
2025-11-09T23:19:32.3144545Z          let our_addr = NetworkAddress {
2025-11-09T23:19:32.3144678Z              services,
2025-11-09T23:19:32.3144807Z              ip: ip_bytes,
2025-11-09T23:19:32.3145255Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2618:
2025-11-09T23:19:32.3145419Z              port: listen_addr.port(),
2025-11-09T23:19:32.3145536Z          };
2025-11-09T23:19:32.3145660Z -        
2025-11-09T23:19:32.3145783Z +
2025-11-09T23:19:32.3146210Z          // Create Addr message with just our address
2025-11-09T23:19:32.3146372Z          let addr_msg = AddrMessage {
2025-11-09T23:19:32.3146537Z              addresses: vec![our_addr.clone()],
2025-11-09T23:19:32.3146989Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2624:
2025-11-09T23:19:32.3147107Z          };
2025-11-09T23:19:32.3147399Z          let relay_msg = ProtocolMessage::Addr(addr_msg);
2025-11-09T23:19:32.3147684Z          let wire_msg = ProtocolParser::serialize_message(&relay_msg)?;
2025-11-09T23:19:32.3147797Z -        
2025-11-09T23:19:32.3147906Z +
2025-11-09T23:19:32.3148080Z          // Send to all connected peers
2025-11-09T23:19:32.3148245Z          let peer_addrs: Vec<SocketAddr> = {
2025-11-09T23:19:32.3148441Z              let pm = self.peer_manager.lock().unwrap();
2025-11-09T23:19:32.3150561Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2631:
2025-11-09T23:19:32.3151087Z              pm.peer_socket_addresses()
2025-11-09T23:19:32.3151227Z          };
2025-11-09T23:19:32.3157226Z -        
2025-11-09T23:19:32.3157394Z +
2025-11-09T23:19:32.3157568Z          for peer_addr in peer_addrs {
2025-11-09T23:19:32.3157863Z              if let Err(e) = self.send_to_peer(peer_addr, wire_msg.clone()).await {
2025-11-09T23:19:32.3158101Z                  warn!("Failed to advertise self to {}: {}", peer_addr, e);
2025-11-09T23:19:32.3158561Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2637:
2025-11-09T23:19:32.3158682Z              }
2025-11-09T23:19:32.3158799Z          }
2025-11-09T23:19:32.3158928Z -        
2025-11-09T23:19:32.3159041Z +
2025-11-09T23:19:32.3159217Z          // Also store our own address in database
2025-11-09T23:19:32.3159332Z          {
2025-11-09T23:19:32.3159562Z              let mut db = self.address_database.lock().unwrap();
2025-11-09T23:19:32.3160020Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2643:
2025-11-09T23:19:32.3160205Z              db.add_address(our_addr, services);
2025-11-09T23:19:32.3160584Z          }
2025-11-09T23:19:32.3160777Z -        
2025-11-09T23:19:32.3160896Z +
2025-11-09T23:19:32.3161019Z          Ok(())
2025-11-09T23:19:32.3161140Z      }
2025-11-09T23:19:32.3161253Z  
2025-11-09T23:19:32.3161721Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2649:
2025-11-09T23:19:32.3161882Z      /// Get list of banned peers
2025-11-09T23:19:32.3162136Z      pub fn get_banned_peers(&self) -> Vec<(SocketAddr, u64)> {
2025-11-09T23:19:32.3162333Z          let ban_list = self.ban_list.lock().unwrap();
2025-11-09T23:19:32.3162629Z -        ban_list.iter().map(|(addr, timestamp)| (*addr, *timestamp)).collect()
2025-11-09T23:19:32.3162765Z +        ban_list
2025-11-09T23:19:32.3162886Z +            .iter()
2025-11-09T23:19:32.3163078Z +            .map(|(addr, timestamp)| (*addr, *timestamp))
2025-11-09T23:19:32.3163213Z +            .collect()
2025-11-09T23:19:32.3163336Z      }
2025-11-09T23:19:32.3163448Z  
2025-11-09T23:19:32.3163645Z      /// Get peer addresses (async version for RPC)
2025-11-09T23:19:32.3164111Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2714:
2025-11-09T23:19:32.3164253Z          peer_addr: SocketAddr,
2025-11-09T23:19:32.3164668Z          msg: crate::network::protocol::GetBanListMessage,
2025-11-09T23:19:32.3164795Z      ) -> Result<()> {
2025-11-09T23:19:32.3165121Z -        use crate::network::protocol::{BanEntry, BanListMessage, NetworkAddress};
2025-11-09T23:19:32.3165383Z          use crate::network::ban_list_merging::calculate_ban_list_hash;
2025-11-09T23:19:32.3165715Z +        use crate::network::protocol::{BanEntry, BanListMessage, NetworkAddress};
2025-11-09T23:19:32.3165901Z          use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:19:32.3166016Z  
2025-11-09T23:19:32.3168184Z -        debug!("GetBanList request from {}: full={}, min_duration={}", 
2025-11-09T23:19:32.3168657Z -               peer_addr, msg.request_full, msg.min_ban_duration);
2025-11-09T23:19:32.3168788Z +        debug!(
2025-11-09T23:19:32.3169030Z +            "GetBanList request from {}: full={}, min_duration={}",
2025-11-09T23:19:32.3169248Z +            peer_addr, msg.request_full, msg.min_ban_duration
2025-11-09T23:19:32.3169360Z +        );
2025-11-09T23:19:32.3169467Z  
2025-11-09T23:19:32.3169615Z          // Get current ban list
2025-11-09T23:19:32.3169802Z          let ban_list = self.ban_list.lock().unwrap();
2025-11-09T23:19:32.3170250Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2776:
2025-11-09T23:19:32.3170839Z          let response = BanListMessage {
2025-11-09T23:19:32.3171020Z              is_full: msg.request_full,
2025-11-09T23:19:32.3171152Z              ban_list_hash,
2025-11-09T23:19:32.3171472Z -            ban_entries: if msg.request_full { ban_entries } else { Vec::new() },
2025-11-09T23:19:32.3171649Z +            ban_entries: if msg.request_full {
2025-11-09T23:19:32.3171792Z +                ban_entries
2025-11-09T23:19:32.3171920Z +            } else {
2025-11-09T23:19:32.3172068Z +                Vec::new()
2025-11-09T23:19:32.3172187Z +            },
2025-11-09T23:19:32.3172322Z              timestamp: now,
2025-11-09T23:19:32.3172435Z          };
2025-11-09T23:19:32.3172560Z  
2025-11-09T23:19:32.3173026Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2785:
2025-11-09T23:19:32.3173357Z          let serialized = ProtocolParser::serialize_message(&response_msg)?;
2025-11-09T23:19:32.3173573Z          self.send_to_peer(peer_addr, serialized).await?;
2025-11-09T23:19:32.3173688Z  
2025-11-09T23:19:32.3173956Z -        debug!("Sent BanList response to {}: {} entries", peer_addr, 
2025-11-09T23:19:32.3174183Z -               if msg.request_full { ban_entries.len() } else { 0 });
2025-11-09T23:19:32.3174469Z +        debug!(
2025-11-09T23:19:32.3174660Z +            "Sent BanList response to {}: {} entries",
2025-11-09T23:19:32.3174805Z +            peer_addr,
2025-11-09T23:19:32.3175206Z +            if msg.request_full {
2025-11-09T23:19:32.3175359Z +                ban_entries.len()
2025-11-09T23:19:32.3175486Z +            } else {
2025-11-09T23:19:32.3175604Z +                0
2025-11-09T23:19:32.3175727Z +            }
2025-11-09T23:19:32.3175843Z +        );
2025-11-09T23:19:32.3175956Z  
2025-11-09T23:19:32.3176081Z          Ok(())
2025-11-09T23:19:32.3176197Z      }
2025-11-09T23:19:32.3176658Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2800:
2025-11-09T23:19:32.3177013Z          use crate::network::ban_list_merging::{validate_ban_entry, verify_ban_list_hash};
2025-11-09T23:19:32.3177169Z          use std::net::IpAddr;
2025-11-09T23:19:32.3177281Z  
2025-11-09T23:19:32.3177514Z -        debug!("BanList received from {}: full={}, {} entries", 
2025-11-09T23:19:32.3177728Z -               peer_addr, msg.is_full, msg.ban_entries.len());
2025-11-09T23:19:32.3179771Z +        debug!(
2025-11-09T23:19:32.3179982Z +            "BanList received from {}: full={}, {} entries",
2025-11-09T23:19:32.3180110Z +            peer_addr,
2025-11-09T23:19:32.3180232Z +            msg.is_full,
2025-11-09T23:19:32.3180375Z +            msg.ban_entries.len()
2025-11-09T23:19:32.3180494Z +        );
2025-11-09T23:19:32.3180614Z  
2025-11-09T23:19:32.3180782Z          // Verify hash if full list provided
2025-11-09T23:19:32.3180913Z          if msg.is_full {
2025-11-09T23:19:32.3181376Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2813:
2025-11-09T23:19:32.3181491Z  
2025-11-09T23:19:32.3181752Z          // If hash-only, we can't merge (would need to request full list)
2025-11-09T23:19:32.3181884Z          if !msg.is_full {
2025-11-09T23:19:32.3182215Z -            debug!("Received hash-only ban list from {}, skipping merge", peer_addr);
2025-11-09T23:19:32.3182334Z +            debug!(
2025-11-09T23:19:32.3182573Z +                "Received hash-only ban list from {}, skipping merge",
2025-11-09T23:19:32.3182950Z +                peer_addr
2025-11-09T23:19:32.3183069Z +            );
2025-11-09T23:19:32.3183198Z              return Ok(());
2025-11-09T23:19:32.3183311Z          }
2025-11-09T23:19:32.3183431Z  
2025-11-09T23:19:32.3183950Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2831:
2025-11-09T23:19:32.3184114Z                  // IPv4-mapped IPv6 address
2025-11-09T23:19:32.3184455Z                  let ipv4_bytes = &entry.addr.ip[12..16];
2025-11-09T23:19:32.3184648Z                  IpAddr::V4(std::net::Ipv4Addr::new(
2025-11-09T23:19:32.3184883Z -                    ipv4_bytes[0], ipv4_bytes[1], ipv4_bytes[2], ipv4_bytes[3]
2025-11-09T23:19:32.3185032Z +                    ipv4_bytes[0],
2025-11-09T23:19:32.3185167Z +                    ipv4_bytes[1],
2025-11-09T23:19:32.3185297Z +                    ipv4_bytes[2],
2025-11-09T23:19:32.3185428Z +                    ipv4_bytes[3],
2025-11-09T23:19:32.3185565Z                  ))
2025-11-09T23:19:32.3185685Z              } else {
2025-11-09T23:19:32.3185827Z                  // IPv6 address
2025-11-09T23:19:32.3186292Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2882:
2025-11-09T23:19:32.3186425Z              ban_list.len()
2025-11-09T23:19:32.3186532Z          };
2025-11-09T23:19:32.3186802Z          let resource_metrics = self.dos_protection.get_metrics().await;
2025-11-09T23:19:32.3186932Z -        
2025-11-09T23:19:32.3187045Z +
2025-11-09T23:19:32.3187226Z          crate::node::metrics::NetworkMetrics {
2025-11-09T23:19:32.3187401Z              peer_count: active_connections,
2025-11-09T23:19:32.3188070Z              bytes_sent: sent,
2025-11-09T23:19:32.3188547Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2889:
2025-11-09T23:19:32.3188704Z              bytes_received: received,
2025-11-09T23:19:32.3188912Z -            messages_sent: 0, // Would need to track this
2025-11-09T23:19:32.3189442Z +            messages_sent: 0,     // Would need to track this
2025-11-09T23:19:32.3189879Z              messages_received: 0, // Would need to track this
2025-11-09T23:19:32.3190047Z              active_connections,
2025-11-09T23:19:32.3190221Z              banned_peers: banned_peers_count,
2025-11-09T23:19:32.3190671Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2894:
2025-11-09T23:19:32.3190902Z              connection_attempts: 0, // Would need to track this
2025-11-09T23:19:32.3191117Z              connection_failures: 0, // Would need to track this
2025-11-09T23:19:32.3191344Z              dos_protection: crate::node::metrics::DosMetrics {
2025-11-09T23:19:32.3191616Z -                connection_rate_violations: 0, // Would need to track this
2025-11-09T23:19:32.3191791Z -                auto_bans: 0, // Would need to track this
2025-11-09T23:19:32.3192029Z -                message_queue_overflows: 0, // Would need to track this
2025-11-09T23:19:32.3192312Z +                connection_rate_violations: 0,   // Would need to track this
2025-11-09T23:19:32.3192534Z +                auto_bans: 0,                    // Would need to track this
2025-11-09T23:19:32.3192786Z +                message_queue_overflows: 0,      // Would need to track this
2025-11-09T23:19:32.3193039Z                  active_connection_limit_hits: 0, // Would need to track this
2025-11-09T23:19:32.3193295Z -                resource_exhaustion_events: 0, // Would need to track this
2025-11-09T23:19:32.3193556Z +                resource_exhaustion_events: 0,   // Would need to track this
2025-11-09T23:19:32.3193674Z              },
2025-11-09T23:19:32.3193794Z          }
2025-11-09T23:19:32.3193910Z      }
2025-11-09T23:19:32.3194519Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2913:
2025-11-09T23:19:32.3194709Z      /// Create version message with service flags
2025-11-09T23:19:32.3194834Z      ///
2025-11-09T23:19:32.3195405Z      /// Creates version message with service flags for all supported features
2025-11-09T23:19:32.3195527Z -    /// 
2025-11-09T23:19:32.3195649Z +    ///
2025-11-09T23:19:32.3195799Z      /// Sets service flags based on:
2025-11-09T23:19:32.3196122Z      /// - BIP157: NODE_COMPACT_FILTERS (always enabled if filter service exists)
2025-11-09T23:19:32.3196385Z      /// - UTXO Commitments: NODE_UTXO_COMMITMENTS (if feature enabled)
2025-11-09T23:19:32.3196842Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2937:
2025-11-09T23:19:32.3196954Z  
2025-11-09T23:19:32.3197137Z          // Add service flags for supported features
2025-11-09T23:19:32.3197321Z          let mut services_with_filters = services;
2025-11-09T23:19:32.3197431Z -        
2025-11-09T23:19:32.3197542Z +
2025-11-09T23:19:32.3197863Z          // BIP157 Compact Block Filters (always enabled if filter service exists)
2025-11-09T23:19:32.3198071Z          services_with_filters |= NODE_COMPACT_FILTERS;
2025-11-09T23:19:32.3198193Z -        
2025-11-09T23:19:32.3198299Z +
2025-11-09T23:19:32.3198480Z          // UTXO Commitments (if feature enabled)
2025-11-09T23:19:32.3198647Z          #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.3198760Z          {
2025-11-09T23:19:32.3199212Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2947:
2025-11-09T23:19:32.3199564Z              services_with_filters |= crate::network::protocol::NODE_UTXO_COMMITMENTS;
2025-11-09T23:19:32.3199670Z          }
2025-11-09T23:19:32.3199775Z -        
2025-11-09T23:19:32.3199882Z +
2025-11-09T23:19:32.3200030Z          // Ban List Sharing (if config enabled)
2025-11-09T23:19:32.3200208Z          if self.ban_list_sharing_config.is_some() {
2025-11-09T23:19:32.3200554Z              services_with_filters |= crate::network::protocol::NODE_BAN_LIST_SHARING;
2025-11-09T23:19:32.3201004Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2953:
2025-11-09T23:19:32.3201389Z          }
2025-11-09T23:19:32.3201512Z -        
2025-11-09T23:19:32.3201840Z +
2025-11-09T23:19:32.3202018Z          // Dandelion (if feature enabled)
2025-11-09T23:19:32.3202172Z          #[cfg(feature = "dandelion")]
2025-11-09T23:19:32.3202298Z          {
2025-11-09T23:19:32.3202760Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2958:
2025-11-09T23:19:32.3203078Z              services_with_filters |= crate::network::protocol::NODE_DANDELION;
2025-11-09T23:19:32.3203200Z          }
2025-11-09T23:19:32.3203316Z -        
2025-11-09T23:19:32.3203429Z +
2025-11-09T23:19:32.3203608Z          // Package Relay (BIP331) - always enabled
2025-11-09T23:19:32.3203945Z          services_with_filters |= crate::network::protocol::NODE_PACKAGE_RELAY;
2025-11-09T23:19:32.3204051Z -        
2025-11-09T23:19:32.3204149Z +
2025-11-09T23:19:32.3204299Z          // FIBRE - always enabled
2025-11-09T23:19:32.3204734Z          services_with_filters |= crate::network::protocol::NODE_FIBRE;
2025-11-09T23:19:32.3204858Z  
2025-11-09T23:19:32.3205405Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/package_relay.rs:138:
2025-11-09T23:19:32.3205735Z      pub fn new(transactions: Vec<Transaction>) -> Result<Self, PackageError> {
2025-11-09T23:19:32.3205932Z          Self::new_with_utxo_set(transactions, None)
2025-11-09T23:19:32.3206046Z      }
2025-11-09T23:19:32.3206167Z -    
2025-11-09T23:19:32.3206286Z +
2025-11-09T23:19:32.3206594Z      /// Create a new transaction package with UTXO set for fee calculation
2025-11-09T23:19:32.3206740Z      pub fn new_with_utxo_set(
2025-11-09T23:19:32.3206896Z          transactions: Vec<Transaction>,
2025-11-09T23:19:32.3207829Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/package_relay.rs:168:
2025-11-09T23:19:32.3208061Z          // Calculate combined fee from UTXO set if provided
2025-11-09T23:19:32.3208300Z          let combined_fee = if let Some(utxo_set) = utxo_set {
2025-11-09T23:19:32.3208838Z              // Calculate fee for each transaction: sum(inputs) - sum(outputs)
2025-11-09T23:19:32.3209012Z -            transactions.iter().map(|tx| {
2025-11-09T23:19:32.3209204Z -                let input_total: u64 = tx.inputs.iter()
2025-11-09T23:19:32.3209409Z -                    .filter_map(|inp| utxo_set.get(&inp.prevout))
2025-11-09T23:19:32.3209575Z -                    .map(|utxo| utxo.value as u64)
2025-11-09T23:19:32.3209712Z -                    .sum();
2025-11-09T23:19:32.3209900Z -                let output_total: u64 = tx.outputs.iter()
2025-11-09T23:19:32.3210059Z -                    .map(|out| out.value as u64)
2025-11-09T23:19:32.3210179Z -                    .sum();
2025-11-09T23:19:32.3210348Z -                if input_total > output_total {
2025-11-09T23:19:32.3210888Z -                    input_total - output_total
2025-11-09T23:19:32.3211027Z -                } else {
2025-11-09T23:19:32.3211157Z -                    0
2025-11-09T23:19:32.3211290Z -                }
2025-11-09T23:19:32.3211412Z -            }).sum()
2025-11-09T23:19:32.3211549Z +            transactions
2025-11-09T23:19:32.3211681Z +                .iter()
2025-11-09T23:19:32.3211813Z +                .map(|tx| {
2025-11-09T23:19:32.3211971Z +                    let input_total: u64 = tx
2025-11-09T23:19:32.3212112Z +                        .inputs
2025-11-09T23:19:32.3212241Z +                        .iter()
2025-11-09T23:19:32.3212452Z +                        .filter_map(|inp| utxo_set.get(&inp.prevout))
2025-11-09T23:19:32.3212619Z +                        .map(|utxo| utxo.value as u64)
2025-11-09T23:19:32.3212756Z +                        .sum();
2025-11-09T23:19:32.3213092Z +                    let output_total: u64 = tx.outputs.iter().map(|out| out.value as u64).sum();
2025-11-09T23:19:32.3213259Z +                    if input_total > output_total {
2025-11-09T23:19:32.3213432Z +                        input_total - output_total
2025-11-09T23:19:32.3213558Z +                    } else {
2025-11-09T23:19:32.3213690Z +                        0
2025-11-09T23:19:32.3214040Z +                    }
2025-11-09T23:19:32.3214171Z +                })
2025-11-09T23:19:32.3214291Z +                .sum()
2025-11-09T23:19:32.3214577Z          } else {
2025-11-09T23:19:32.3214759Z              0 // Fee calculation requires UTXO set
2025-11-09T23:19:32.3214866Z          };
2025-11-09T23:19:32.3215301Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:4:
2025-11-09T23:19:32.3215428Z  
2025-11-09T23:19:32.3215576Z  use anyhow::Result;
2025-11-09T23:19:32.3215725Z  use std::net::SocketAddr;
2025-11-09T23:19:32.3215854Z +use std::sync::Arc;
2025-11-09T23:19:32.3216038Z  use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:19:32.3216179Z  use tokio::sync::mpsc;
2025-11-09T23:19:32.3216336Z  use tracing::{debug, info, warn};
2025-11-09T23:19:32.3216792Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:10:
2025-11-09T23:19:32.3216938Z -use std::sync::Arc;
2025-11-09T23:19:32.3217051Z  
2025-11-09T23:19:32.3217340Z +use super::transport::{TransportAddr, TransportConnection};
2025-11-09T23:19:32.3217498Z  use super::NetworkMessage;
2025-11-09T23:19:32.3217765Z -use super::transport::{TransportConnection, TransportAddr};
2025-11-09T23:19:32.3217880Z  
2025-11-09T23:19:32.3218032Z  /// Peer connection state
2025-11-09T23:19:32.3218144Z -/// 
2025-11-09T23:19:32.3218255Z +///
2025-11-09T23:19:32.3218655Z  /// Supports multiple transport types (TCP, Quinn, Iroh) via TransportConnection trait
2025-11-09T23:19:32.3218797Z  pub struct Peer {
2025-11-09T23:19:32.3218927Z      addr: SocketAddr,
2025-11-09T23:19:32.3219373Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:48:
2025-11-09T23:19:32.3219496Z  
2025-11-09T23:19:32.3219624Z  impl Peer {
2025-11-09T23:19:32.3219872Z      /// Create a new peer connection from a TransportConnection
2025-11-09T23:19:32.3219996Z -    /// 
2025-11-09T23:19:32.3220311Z +    ///
2025-11-09T23:19:32.3220669Z      /// This is the preferred method as it supports all transport types (TCP, Quinn, Iroh).
2025-11-09T23:19:32.3220941Z      /// The connection is managed via channels for concurrent read/write.
2025-11-09T23:19:32.3222729Z      pub fn from_transport_connection<C: TransportConnection + 'static>(
2025-11-09T23:19:32.3223143Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:59:
2025-11-09T23:19:32.3223252Z      ) -> Self {
2025-11-09T23:19:32.3223410Z          // Create channel for sending messages
2025-11-09T23:19:32.3223640Z          let (send_tx, send_rx) = mpsc::unbounded_channel::<Vec<u8>>();
2025-11-09T23:19:32.3223746Z -        
2025-11-09T23:19:32.3223849Z +
2025-11-09T23:19:32.3224049Z          let transport_addr_clone = transport_addr.clone();
2025-11-09T23:19:32.3224205Z          let message_tx_clone = message_tx.clone();
2025-11-09T23:19:32.3224460Z -        
2025-11-09T23:19:32.3224581Z +
2025-11-09T23:19:32.3224878Z          // Wrap connection in Arc<Mutex> to share between read and write tasks
2025-11-09T23:19:32.3225016Z          use std::sync::Arc;
2025-11-09T23:19:32.3225153Z          use tokio::sync::Mutex;
2025-11-09T23:19:32.3225556Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:69:
2025-11-09T23:19:32.3225705Z          let conn = Arc::new(Mutex::new(conn));
2025-11-09T23:19:32.3225847Z          let conn_read = Arc::clone(&conn);
2025-11-09T23:19:32.3225996Z          let conn_write = Arc::clone(&conn);
2025-11-09T23:19:32.3226099Z -        
2025-11-09T23:19:32.3226198Z +
2025-11-09T23:19:32.3226421Z          // Spawn read task using TransportConnection::recv
2025-11-09T23:19:32.3226578Z          tokio::spawn(async move {
2025-11-09T23:19:32.3226699Z              loop {
2025-11-09T23:19:32.3227151Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:83:
2025-11-09T23:19:32.3227275Z                          }
2025-11-09T23:19:32.3227406Z                      }
2025-11-09T23:19:32.3227528Z                  };
2025-11-09T23:19:32.3227878Z -                
2025-11-09T23:19:32.3228010Z +
2025-11-09T23:19:32.3228157Z                  if data.is_empty() {
2025-11-09T23:19:32.3228276Z                      break;
2025-11-09T23:19:32.3228391Z                  }
2025-11-09T23:19:32.3228850Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:90:
2025-11-09T23:19:32.3228958Z -                
2025-11-09T23:19:32.3229062Z +
2025-11-09T23:19:32.3229261Z                  let peer_addr = match &transport_addr_clone {
2025-11-09T23:19:32.3229562Z                      super::transport::TransportAddr::Tcp(sock) => *sock,
2025-11-09T23:19:32.3229709Z                      #[cfg(feature = "quinn")]
2025-11-09T23:19:32.3231837Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:100:
2025-11-09T23:19:32.3232251Z                  let _ = message_tx_clone.send(NetworkMessage::RawMessageReceived(data, peer_addr));
2025-11-09T23:19:32.3232375Z              }
2025-11-09T23:19:32.3232495Z          });
2025-11-09T23:19:32.3232608Z -        
2025-11-09T23:19:32.3232732Z +
2025-11-09T23:19:32.3232971Z          // Spawn write task using TransportConnection::send
2025-11-09T23:19:32.3233127Z          tokio::spawn(async move {
2025-11-09T23:19:32.3233266Z              let mut send_rx = send_rx;
2025-11-09T23:19:32.3233706Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:107:
2025-11-09T23:19:32.3233823Z -            
2025-11-09T23:19:32.3233929Z +
2025-11-09T23:19:32.3234042Z              loop {
2025-11-09T23:19:32.3234189Z                  match send_rx.recv().await {
2025-11-09T23:19:32.3234491Z                      Some(data) => {
2025-11-09T23:19:32.3234928Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:124:
2025-11-09T23:19:32.3235039Z                      }
2025-11-09T23:19:32.3235154Z                  }
2025-11-09T23:19:32.3235465Z              }
2025-11-09T23:19:32.3235572Z -            
2025-11-09T23:19:32.3235681Z +
2025-11-09T23:19:32.3235885Z              // Gracefully close connection on write task exit
2025-11-09T23:19:32.3236104Z              // Connection will be closed when conn_guard is dropped
2025-11-09T23:19:32.3236212Z          });
2025-11-09T23:19:32.3236640Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:131:
2025-11-09T23:19:32.3236747Z -        
2025-11-09T23:19:32.3236851Z +
2025-11-09T23:19:32.3237002Z          let now = SystemTime::now()
2025-11-09T23:19:32.3237153Z              .duration_since(UNIX_EPOCH)
2025-11-09T23:19:32.3237270Z              .unwrap()
2025-11-09T23:19:32.3237708Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:135:
2025-11-09T23:19:32.3237847Z              .as_secs();
2025-11-09T23:19:32.3237959Z -        
2025-11-09T23:19:32.3238067Z +
2025-11-09T23:19:32.3238181Z          Self {
2025-11-09T23:19:32.3238299Z              addr,
2025-11-09T23:19:32.3238434Z              transport_addr,
2025-11-09T23:19:32.3238872Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:153:
2025-11-09T23:19:32.3239022Z              last_tx_received: None,
2025-11-09T23:19:32.3239129Z          }
2025-11-09T23:19:32.3241077Z      }
2025-11-09T23:19:32.3241193Z -    
2025-11-09T23:19:32.3241306Z +
2025-11-09T23:19:32.3241641Z      /// Create a new peer connection from a TCP stream (backward compatibility)
2025-11-09T23:19:32.3241763Z -    /// 
2025-11-09T23:19:32.3241890Z +    ///
2025-11-09T23:19:32.3242218Z      /// This is a convenience method that wraps a TcpStream in a TcpConnection.
2025-11-09T23:19:32.3242615Z      #[deprecated(note = "Use from_transport_connection instead for transport abstraction")]
2025-11-09T23:19:32.3242751Z      pub fn new(
2025-11-09T23:19:32.3243196Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:165:
2025-11-09T23:19:32.3243332Z      ) -> Self {
2025-11-09T23:19:32.3243790Z          use super::tcp_transport::TcpConnection;
2025-11-09T23:19:32.3243997Z          use super::transport::TransportAddr;
2025-11-09T23:19:32.3244109Z -        
2025-11-09T23:19:32.3244219Z +
2025-11-09T23:19:32.3244626Z          let peer_addr = stream.peer_addr().unwrap_or(addr);
2025-11-09T23:19:32.3244780Z          let tcp_conn = TcpConnection {
2025-11-09T23:19:32.3244898Z              stream,
2025-11-09T23:19:32.3245347Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:172:
2025-11-09T23:19:32.3245552Z              peer_addr: TransportAddr::Tcp(peer_addr),
2025-11-09T23:19:32.3245691Z              connected: true,
2025-11-09T23:19:32.3245901Z          };
2025-11-09T23:19:32.3246028Z -        
2025-11-09T23:19:32.3246142Z +
2025-11-09T23:19:32.3246614Z          Self::from_transport_connection(tcp_conn, addr, TransportAddr::Tcp(addr), message_tx)
2025-11-09T23:19:32.3246732Z      }
2025-11-09T23:19:32.3246851Z  
2025-11-09T23:19:32.3247306Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:189:
2025-11-09T23:19:32.3247478Z          self.handle_peer_communication().await?;
2025-11-09T23:19:32.3247593Z  
2025-11-09T23:19:32.3247752Z          // Send disconnection notification
2025-11-09T23:19:32.3247876Z -        let _ = self
2025-11-09T23:19:32.3248006Z -            .message_tx
2025-11-09T23:19:32.3248347Z -            .send(NetworkMessage::PeerDisconnected(self.transport_addr.clone()));
2025-11-09T23:19:32.3248619Z +        let _ = self.message_tx.send(NetworkMessage::PeerDisconnected(
2025-11-09T23:19:32.3248776Z +            self.transport_addr.clone(),
2025-11-09T23:19:32.3250781Z +        ));
2025-11-09T23:19:32.3250894Z  
2025-11-09T23:19:32.3251007Z          Ok(())
2025-11-09T23:19:32.3251125Z      }
2025-11-09T23:19:32.3251577Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:198:
2025-11-09T23:19:32.3251689Z  
2025-11-09T23:19:32.3252101Z      /// Handle peer communication loop
2025-11-09T23:19:32.3252230Z -    /// 
2025-11-09T23:19:32.3252344Z +    ///
2025-11-09T23:19:32.3252633Z      /// Note: The read loop is now handled in `new()` via stream splitting.
2025-11-09T23:19:32.3252858Z      /// This method just waits for the connection to close.
2025-11-09T23:19:32.3253120Z      async fn handle_peer_communication(&mut self) -> Result<()> {
2025-11-09T23:19:32.3253568Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:205:
2025-11-09T23:19:32.3253775Z          // We just wait here to detect when connection closes
2025-11-09T23:19:32.3254090Z          // In a real implementation, we'd monitor the read task or connection state
2025-11-09T23:19:32.3254534Z          tokio::time::sleep(tokio::time::Duration::from_secs(1)).await;
2025-11-09T23:19:32.3254655Z -        
2025-11-09T23:19:32.3254775Z +
2025-11-09T23:19:32.3255206Z          // Connection close is automatically detected by the read task in from_transport_connection
2025-11-09T23:19:32.3255637Z          // When recv() returns empty data or error, the task breaks and sends PeerDisconnected
2025-11-09T23:19:32.3255831Z          self.connected = false;
2025-11-09T23:19:32.3256280Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:248:
2025-11-09T23:19:32.3256396Z      }
2025-11-09T23:19:32.3256512Z  
2025-11-09T23:19:32.3256659Z      /// Send a message to the peer
2025-11-09T23:19:32.3256773Z -    /// 
2025-11-09T23:19:32.3256883Z +    ///
2025-11-09T23:19:32.3257145Z      /// Messages are sent via a channel to a background write task.
2025-11-09T23:19:32.3257417Z      pub async fn send_message(&self, message: Vec<u8>) -> Result<()> {
2025-11-09T23:19:32.3257568Z          let message_len = message.len();
2025-11-09T23:19:32.3258101Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol.rs:2:
2025-11-09T23:19:32.3258207Z  //!
2025-11-09T23:19:32.3258570Z  //! Implements Bitcoin P2P protocol message serialization and deserialization.
2025-11-09T23:19:32.3258907Z  
2025-11-09T23:19:32.3259138Z -use bllvm_protocol::bip157::NODE_COMPACT_FILTERS;
2025-11-09T23:19:32.3259343Z  use crate::network::transport::TransportType;
2025-11-09T23:19:32.3259476Z  use anyhow::Result;
2025-11-09T23:19:32.3259673Z +use bllvm_protocol::bip157::NODE_COMPACT_FILTERS;
2025-11-09T23:19:32.3259940Z  use bllvm_protocol::{Block, BlockHeader, Hash, Transaction};
2025-11-09T23:19:32.3260112Z  use serde::{Deserialize, Serialize};
2025-11-09T23:19:32.3260224Z  
2025-11-09T23:19:32.3260701Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol.rs:145:
2025-11-09T23:19:32.3260917Z      pub fn supports_utxo_commitments(&self) -> bool {
2025-11-09T23:19:32.3261104Z          (self.services & NODE_UTXO_COMMITMENTS) != 0
2025-11-09T23:19:32.3261216Z      }
2025-11-09T23:19:32.3261332Z -    
2025-11-09T23:19:32.3261446Z +
2025-11-09T23:19:32.3261620Z      /// Check if peer supports ban list sharing
2025-11-09T23:19:32.3261840Z      pub fn supports_ban_list_sharing(&self) -> bool {
2025-11-09T23:19:32.3262030Z          (self.services & NODE_BAN_LIST_SHARING) != 0
2025-11-09T23:19:32.3262495Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol.rs:152:
2025-11-09T23:19:32.3262606Z      }
2025-11-09T23:19:32.3262723Z -    
2025-11-09T23:19:32.3262827Z +
2025-11-09T23:19:32.3263044Z      /// Check if peer supports BIP157 compact block filters
2025-11-09T23:19:32.3263223Z      pub fn supports_compact_filters(&self) -> bool {
2025-11-09T23:19:32.3263440Z          use bllvm_protocol::bip157::NODE_COMPACT_FILTERS;
2025-11-09T23:19:32.3263899Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol.rs:157:
2025-11-09T23:19:32.3264084Z          (self.services & NODE_COMPACT_FILTERS) != 0
2025-11-09T23:19:32.3264201Z      }
2025-11-09T23:19:32.3264611Z -    
2025-11-09T23:19:32.3264738Z +
2025-11-09T23:19:32.3265211Z      /// Check if peer supports package relay (BIP331)
2025-11-09T23:19:32.3265420Z      pub fn supports_package_relay(&self) -> bool {
2025-11-09T23:19:32.3265597Z          (self.services & NODE_PACKAGE_RELAY) != 0
2025-11-09T23:19:32.3266091Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol.rs:163:
2025-11-09T23:19:32.3266223Z      }
2025-11-09T23:19:32.3266335Z -    
2025-11-09T23:19:32.3266447Z +
2025-11-09T23:19:32.3266616Z      /// Check if peer supports FIBRE
2025-11-09T23:19:32.3266783Z      pub fn supports_fibre(&self) -> bool {
2025-11-09T23:19:32.3266941Z          (self.services & NODE_FIBRE) != 0
2025-11-09T23:19:32.3267420Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol.rs:168:
2025-11-09T23:19:32.3267542Z      }
2025-11-09T23:19:32.3267653Z -    
2025-11-09T23:19:32.3267763Z +
2025-11-09T23:19:32.3267917Z      #[cfg(feature = "dandelion")]
2025-11-09T23:19:32.3268073Z      /// Check if peer supports Dandelion
2025-11-09T23:19:32.3268254Z      pub fn supports_dandelion(&self) -> bool {
2025-11-09T23:19:32.3268778Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol_extensions.rs:7:
2025-11-09T23:19:32.3269003Z  //! - FilteredBlock: Response with filtered transactions
2025-11-09T23:19:32.3269111Z  
2025-11-09T23:19:32.3269279Z  use crate::network::protocol::*;
2025-11-09T23:19:32.3269430Z -use crate::storage::Storage;
2025-11-09T23:19:32.3269602Z  use crate::network::txhash::calculate_txid;
2025-11-09T23:19:32.3269741Z +use crate::storage::Storage;
2025-11-09T23:19:32.3269872Z  use anyhow::Result;
2025-11-09T23:19:32.3270020Z  #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.3270308Z  use bllvm_protocol::utxo_commitments::merkle_tree::UtxoMerkleTree;
2025-11-09T23:19:32.3270848Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol_extensions.rs:41:
2025-11-09T23:19:32.3270994Z      // Get UTXO set from storage
2025-11-09T23:19:32.3271198Z      let utxo_set = storage.utxos().get_all_utxos()?;
2025-11-09T23:19:32.3271569Z      let utxo_count = utxo_set.len() as u64;
2025-11-09T23:19:32.3271697Z -    
2025-11-09T23:19:32.3271809Z +
2025-11-09T23:19:32.3271957Z      // Calculate total supply
2025-11-09T23:19:32.3272292Z      let total_supply: u64 = utxo_set.values().map(|utxo| utxo.value as u64).sum();
2025-11-09T23:19:32.3272412Z  
2025-11-09T23:19:32.3272965Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol_extensions.rs:49:
2025-11-09T23:19:32.3273133Z      #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.3273331Z      let mut utxo_tree = UtxoMerkleTree::new()
2025-11-09T23:19:32.3273664Z          .map_err(|e| anyhow::anyhow!("Failed to create UTXO Merkle tree: {:?}", e))?;
2025-11-09T23:19:32.3273779Z -    
2025-11-09T23:19:32.3273897Z +
2025-11-09T23:19:32.3274057Z      #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.3274212Z      for (outpoint, utxo) in &utxo_set {
2025-11-09T23:19:32.3274860Z -        utxo_tree.insert(*outpoint, utxo.clone())
2025-11-09T23:19:32.3275014Z +        utxo_tree
2025-11-09T23:19:32.3275181Z +            .insert(*outpoint, utxo.clone())
2025-11-09T23:19:32.3275504Z              .map_err(|e| anyhow::anyhow!("Failed to insert UTXO into tree: {:?}", e))?;
2025-11-09T23:19:32.3275631Z      }
2025-11-09T23:19:32.3275741Z  
2025-11-09T23:19:32.3278218Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol_extensions.rs:68:
2025-11-09T23:19:32.3278373Z      // Generate commitment
2025-11-09T23:19:32.3278535Z      #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.3278863Z      let commitment = utxo_tree.generate_commitment(block_hash, block_height);
2025-11-09T23:19:32.3278977Z -    
2025-11-09T23:19:32.3279097Z +
2025-11-09T23:19:32.3279269Z      #[cfg(not(feature = "utxo-commitments"))]
2025-11-09T23:19:32.3279536Z      let commitment = crate::network::protocol::UTXOCommitment {
2025-11-09T23:19:32.3279687Z          merkle_root: [0; 32],
2025-11-09T23:19:32.3280509Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol_extensions.rs:161:
2025-11-09T23:19:32.3280674Z      #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.3281112Z      let (filtered_txs, spam_summary_from_filter) = spam_filter.filter_block(&block.transactions);
2025-11-09T23:19:32.3281298Z      #[cfg(not(feature = "utxo-commitments"))]
2025-11-09T23:19:32.3282306Z -    let (filtered_txs, spam_summary_from_filter): (Vec<bllvm_protocol::Transaction>, crate::network::protocol::SpamSummary) = (block.transactions.clone(), crate::network::protocol::SpamSummary {
2025-11-09T23:19:32.3282452Z -        filtered_count: 0,
2025-11-09T23:19:32.3282592Z -        filtered_size: 0,
2025-11-09T23:19:32.3282809Z -        by_type: crate::network::protocol::SpamBreakdown {
2025-11-09T23:19:32.3282927Z -            ordinals: 0,
2025-11-09T23:19:32.3283068Z -            inscriptions: 0,
2025-11-09T23:19:32.3283191Z -            dust: 0,
2025-11-09T23:19:32.3283325Z -            brc20: 0,
2025-11-09T23:19:32.3283533Z +    let (filtered_txs, spam_summary_from_filter): (
2025-11-09T23:19:32.3283713Z +        Vec<bllvm_protocol::Transaction>,
2025-11-09T23:19:32.3283890Z +        crate::network::protocol::SpamSummary,
2025-11-09T23:19:32.3283998Z +    ) = (
2025-11-09T23:19:32.3284155Z +        block.transactions.clone(),
2025-11-09T23:19:32.3284498Z +        crate::network::protocol::SpamSummary {
2025-11-09T23:19:32.3284629Z +            filtered_count: 0,
2025-11-09T23:19:32.3284751Z +            filtered_size: 0,
2025-11-09T23:19:32.3284958Z +            by_type: crate::network::protocol::SpamBreakdown {
2025-11-09T23:19:32.3285073Z +                ordinals: 0,
2025-11-09T23:19:32.3285200Z +                inscriptions: 0,
2025-11-09T23:19:32.3285323Z +                dust: 0,
2025-11-09T23:19:32.3285439Z +                brc20: 0,
2025-11-09T23:19:32.3285549Z +            },
2025-11-09T23:19:32.3285659Z          },
2025-11-09T23:19:32.3285795Z -    });
2025-11-09T23:19:32.3285909Z -    
2025-11-09T23:19:32.3286024Z +    );
2025-11-09T23:19:32.3286356Z +
2025-11-09T23:19:32.3286552Z      // Convert spam summary to protocol types
2025-11-09T23:19:32.3286714Z      let spam_summary = SpamSummary {
2025-11-09T23:19:32.3286973Z          filtered_count: spam_summary_from_filter.filtered_count,
2025-11-09T23:19:32.3287547Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol_extensions.rs:186:
2025-11-09T23:19:32.3287661Z  
2025-11-09T23:19:32.3288084Z      // Generate transaction indices (positions of filtered transactions in original block)
2025-11-09T23:19:32.3288282Z      let mut transaction_indices = Vec::new();
2025-11-09T23:19:32.3288597Z -    let filtered_txids: std::collections::HashSet<_> = filtered_txs.iter()
2025-11-09T23:19:32.3288750Z -        .map(|tx| calculate_txid(tx))
2025-11-09T23:19:32.3288884Z -        .collect();
2025-11-09T23:19:32.3289092Z +    let filtered_txids: std::collections::HashSet<_> =
2025-11-09T23:19:32.3291112Z +        filtered_txs.iter().map(|tx| calculate_txid(tx)).collect();
2025-11-09T23:19:32.3291400Z      for (original_idx, tx) in block.transactions.iter().enumerate() {
2025-11-09T23:19:32.3291563Z          let txid = calculate_txid(tx);
2025-11-09T23:19:32.3291725Z          if filtered_txids.contains(&txid) {
2025-11-09T23:19:32.3292283Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol_extensions.rs:200:
2025-11-09T23:19:32.3292455Z      #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.3292630Z      let mut utxo_tree = UtxoMerkleTree::new()
2025-11-09T23:19:32.3293370Z          .map_err(|e| anyhow::anyhow!("Failed to create UTXO Merkle tree: {:?}", e))?;
2025-11-09T23:19:32.3293504Z -    
2025-11-09T23:19:32.3293618Z +
2025-11-09T23:19:32.3293781Z      #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.3293946Z      // Add outputs from filtered transactions
2025-11-09T23:19:32.3294093Z      for tx in &filtered_txs {
2025-11-09T23:19:32.3295075Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol_extensions.rs:227:
2025-11-09T23:19:32.3295243Z      // Generate commitment for filtered block
2025-11-09T23:19:32.3295400Z      #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.3295777Z      let commitment = utxo_tree.generate_commitment(message.block_hash, block_height);
2025-11-09T23:19:32.3295895Z -    
2025-11-09T23:19:32.3296011Z +
2025-11-09T23:19:32.3296181Z      #[cfg(not(feature = "utxo-commitments"))]
2025-11-09T23:19:32.3296454Z      let commitment = crate::network::protocol::UTXOCommitment {
2025-11-09T23:19:32.3296591Z          merkle_root: [0; 32],
2025-11-09T23:19:32.3297123Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/stratum_v2/pool.rs:191:
2025-11-09T23:19:32.3297238Z  
2025-11-09T23:19:32.3297376Z          // Store template
2025-11-09T23:19:32.3297565Z          self.current_template = Some(template);
2025-11-09T23:19:32.3297684Z -        
2025-11-09T23:19:32.3297812Z +
2025-11-09T23:19:32.3297948Z          (job_id, messages)
2025-11-09T23:19:32.3298071Z      }
2025-11-09T23:19:32.3298181Z  
2025-11-09T23:19:32.3298697Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/stratum_v2/pool.rs:463:
2025-11-09T23:19:32.3298945Z          if let Some(coinbase) = template.transactions.first() {
2025-11-09T23:19:32.3299099Z              // Serialize coinbase transaction
2025-11-09T23:19:32.3299353Z              let coinbase_bytes = self.serialize_transaction(coinbase);
2025-11-09T23:19:32.3299468Z -            
2025-11-09T23:19:32.3299585Z +
2025-11-09T23:19:32.3299796Z              // Extract merkle path from coinbase (index 0) to root
2025-11-09T23:19:32.3300033Z              let merkle_path = self.extract_merkle_path(template, 0);
2025-11-09T23:19:32.3300149Z -            
2025-11-09T23:19:32.3300260Z +
2025-11-09T23:19:32.3300588Z              // For Stratum V2, coinbase prefix is the full coinbase (miners can modify it)
2025-11-09T23:19:32.3300815Z              // Coinbase suffix is empty (not used in Stratum V2)
2025-11-09T23:19:32.3301461Z              (coinbase_bytes, vec![], merkle_path)
2025-11-09T23:19:32.3301994Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/stratum_v2/pool.rs:477:
2025-11-09T23:19:32.3302101Z  
2025-11-09T23:19:32.3302389Z      /// Extract merkle path from a specific transaction index to root
2025-11-09T23:19:32.3302720Z      fn extract_merkle_path(&self, block: &Block, tx_index: usize) -> Vec<Hash> {
2025-11-09T23:19:32.3302925Z -        use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:19:32.3303112Z          use crate::storage::hashing::double_sha256;
2025-11-09T23:19:32.3303299Z +        use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:19:32.3303409Z  
2025-11-09T23:19:32.3303744Z          if block.transactions.is_empty() || tx_index >= block.transactions.len() {
2025-11-09T23:19:32.3303875Z              return vec![];
2025-11-09T23:19:32.3304584Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/stratum_v2/pool.rs:485:
2025-11-09T23:19:32.3304706Z          }
2025-11-09T23:19:32.3304825Z  
2025-11-09T23:19:32.3304993Z          // Calculate all transaction hashes
2025-11-09T23:19:32.3305231Z -        let mut tx_hashes: Vec<Hash> = block.transactions.iter()
2025-11-09T23:19:32.3305397Z +        let mut tx_hashes: Vec<Hash> = block
2025-11-09T23:19:32.3305520Z +            .transactions
2025-11-09T23:19:32.3305642Z +            .iter()
2025-11-09T23:19:32.3305796Z              .map(|tx| calculate_tx_id(tx))
2025-11-09T23:19:32.3305930Z              .collect();
2025-11-09T23:19:32.3306039Z  
2025-11-09T23:19:32.3306554Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/stratum_v2/pool.rs:528:
2025-11-09T23:19:32.3306747Z                      combined.extend_from_slice(&chunk[0]);
2025-11-09T23:19:32.3306940Z                      let parent_hash = double_sha256(&combined);
2025-11-09T23:19:32.3307338Z                      next_level.push(parent_hash);
2025-11-09T23:19:32.3307474Z -                    
2025-11-09T23:19:32.3307587Z +
2025-11-09T23:19:32.3307873Z                      // If current_index is the last (odd) transaction, no sibling to add
2025-11-09T23:19:32.3308041Z                      let pair_start = pair_idx * 2;
2025-11-09T23:19:32.3308211Z                      if current_index == pair_start {
2025-11-09T23:19:32.3313370Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/stratum_v2/server.rs:214:
2025-11-09T23:19:32.3313616Z          // Get block template from MiningCoordinator
2025-11-09T23:19:32.3313762Z          let template = {
2025-11-09T23:19:32.3314042Z              let mut coordinator = self.mining_coordinator.write().await;
2025-11-09T23:19:32.3314250Z -            coordinator.generate_block_template().await
2025-11-09T23:19:32.3314943Z -                .map_err(|e| StratumV2Error::MiningJob(format!("Failed to generate block template: {}", e)))?
2025-11-09T23:19:32.3315257Z +            coordinator.generate_block_template().await.map_err(|e| {
2025-11-09T23:19:32.3315671Z +                StratumV2Error::MiningJob(format!("Failed to generate block template: {}", e))
2025-11-09T23:19:32.3315800Z +            })?
2025-11-09T23:19:32.3315913Z          };
2025-11-09T23:19:32.3316027Z  
2025-11-09T23:19:32.3316484Z -        debug!("Generated new block template with {} transactions", template.transactions.len());
2025-11-09T23:19:32.3316607Z +        debug!(
2025-11-09T23:19:32.3316841Z +            "Generated new block template with {} transactions",
2025-11-09T23:19:32.3317011Z +            template.transactions.len()
2025-11-09T23:19:32.3317133Z +        );
2025-11-09T23:19:32.3317241Z  
2025-11-09T23:19:32.3317473Z          // Set template in pool and get distribution messages
2025-11-09T23:19:32.3317630Z          let (job_id, messages) = {
2025-11-09T23:19:32.3318189Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/stratum_v2/server.rs:273:
2025-11-09T23:19:32.3318605Z          if let Some(ref mut conn) = *conn {
2025-11-09T23:19:32.3319014Z              // Use channel-specific sending - transports that support channels (QUIC/Iroh)
2025-11-09T23:19:32.3319382Z              // will route to the appropriate channel stream, others will use default send()
2025-11-09T23:19:32.3319670Z -            conn.send_on_channel(channel_id, &encoded).await.map_err(|e| {
2025-11-09T23:19:32.3320018Z -                StratumV2Error::Network(format!("Failed to send job message: {}", e))
2025-11-09T23:19:32.3320146Z -            })?;
2025-11-09T23:19:32.3320339Z +            conn.send_on_channel(channel_id, &encoded)
2025-11-09T23:19:32.3320467Z +                .await
2025-11-09T23:19:32.3320615Z +                .map_err(|e| {
2025-11-09T23:19:32.3320947Z +                    StratumV2Error::Network(format!("Failed to send job message: {}", e))
2025-11-09T23:19:32.3321059Z +                })?;
2025-11-09T23:19:32.3321181Z          } else {
2025-11-09T23:19:32.3321448Z              return Err(StratumV2Error::Connection(anyhow::anyhow!(
2025-11-09T23:19:32.3321610Z                  "Connection not available"
2025-11-09T23:19:32.3402730Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:101:
2025-11-09T23:19:32.3402912Z                  {
2025-11-09T23:19:32.3403151Z                      use crate::network::transport::TransportAddr;
2025-11-09T23:19:32.3403292Z                      use hex;
2025-11-09T23:19:32.3403412Z -                    
2025-11-09T23:19:32.3403527Z +
2025-11-09T23:19:32.3403796Z                      let node_id_hex = peer_id.strip_prefix("iroh:").ok_or_else(|| {
2025-11-09T23:19:32.3404264Z                          bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-09T23:19:32.3404642Z                              format!("Invalid Iroh peer_id format: {}", peer_id)
2025-11-09T23:19:32.3405209Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:108:
2025-11-09T23:19:32.3405623Z                          )
2025-11-09T23:19:32.3405751Z                      })?;
2025-11-09T23:19:32.3405872Z -                    
2025-11-09T23:19:32.3405994Z +
2025-11-09T23:19:32.3406268Z                      let node_id_bytes = hex::decode(node_id_hex).map_err(|e| {
2025-11-09T23:19:32.3406735Z                          bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-09T23:19:32.3406935Z                              format!("Invalid Iroh node ID hex: {}", e)
2025-11-09T23:19:32.3407526Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:114:
2025-11-09T23:19:32.3407654Z                          )
2025-11-09T23:19:32.3407772Z                      })?;
2025-11-09T23:19:32.3407899Z -                    
2025-11-09T23:19:32.3408012Z +
2025-11-09T23:19:32.3408264Z                      // Validate node ID length (Iroh uses 32-byte public keys)
2025-11-09T23:19:32.3408458Z                      if node_id_bytes.len() != 32 {
2025-11-09T23:19:32.3410742Z                          return Err(bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-09T23:19:32.3411343Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:120:
2025-11-09T23:19:32.3411736Z                              format!("Invalid Iroh node ID length: expected 32 bytes, got {}", node_id_bytes.len())
2025-11-09T23:19:32.3411863Z                          ));
2025-11-09T23:19:32.3411996Z                      }
2025-11-09T23:19:32.3412113Z -                    
2025-11-09T23:19:32.3412226Z +
2025-11-09T23:19:32.3412539Z                      // Create placeholder SocketAddr for Iroh (same approach as mod.rs)
2025-11-09T23:19:32.3412780Z                      // Use first 4 bytes of key for IP, last 2 bytes for port
2025-11-09T23:19:32.3413370Z -                    let ip_bytes = [node_id_bytes[0], node_id_bytes[1], node_id_bytes[2], node_id_bytes[3]];
2025-11-09T23:19:32.3413530Z +                    let ip_bytes = [
2025-11-09T23:19:32.3413683Z +                        node_id_bytes[0],
2025-11-09T23:19:32.3413823Z +                        node_id_bytes[1],
2025-11-09T23:19:32.3413960Z +                        node_id_bytes[2],
2025-11-09T23:19:32.3414097Z +                        node_id_bytes[3],
2025-11-09T23:19:32.3414225Z +                    ];
2025-11-09T23:19:32.3414826Z                      let port = u16::from_be_bytes([node_id_bytes[30], node_id_bytes[31]]);
2025-11-09T23:19:32.3415158Z                      let placeholder_addr = std::net::SocketAddr::from((ip_bytes, port));
2025-11-09T23:19:32.3415286Z -                    
2025-11-09T23:19:32.3415399Z +
2025-11-09T23:19:32.3415659Z                      let transport_addr = TransportAddr::Iroh(node_id_bytes);
2025-11-09T23:19:32.3415876Z                      Some((placeholder_addr, Some(transport_addr)))
2025-11-09T23:19:32.3416001Z                  }
2025-11-09T23:19:32.3416590Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:148:
2025-11-09T23:19:32.3416723Z                      ));
2025-11-09T23:19:32.3416842Z                  }
2025-11-09T23:19:32.3416959Z              };
2025-11-09T23:19:32.3417075Z -            
2025-11-09T23:19:32.3417192Z +
2025-11-09T23:19:32.3417364Z              // Store TransportAddr mapping if Iroh
2025-11-09T23:19:32.3417574Z              if let Some(transport_addr) = transport_addr_opt {
2025-11-09T23:19:32.3417770Z                  let network = network_manager.read().await;
2025-11-09T23:19:32.3420600Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:155:
2025-11-09T23:19:32.3420892Z                  // Store mapping from placeholder SocketAddr to TransportAddr
2025-11-09T23:19:32.3421280Z -                network.socket_to_transport.lock().unwrap().insert(peer_addr, transport_addr);
2025-11-09T23:19:32.3421685Z +                network
2025-11-09T23:19:32.3421844Z +                    .socket_to_transport
2025-11-09T23:19:32.3421974Z +                    .lock()
2025-11-09T23:19:32.3422109Z +                    .unwrap()
2025-11-09T23:19:32.3422298Z +                    .insert(peer_addr, transport_addr);
2025-11-09T23:19:32.3422437Z                  drop(network);
2025-11-09T23:19:32.3422551Z              }
2025-11-09T23:19:32.3422673Z  
2025-11-09T23:19:32.3423263Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:160:
2025-11-09T23:19:32.3423545Z              // Check if peer supports UTXO commitments before sending request
2025-11-09T23:19:32.3423739Z              let network = network_manager.read().await;
2025-11-09T23:19:32.3423855Z -            
2025-11-09T23:19:32.3423966Z +
2025-11-09T23:19:32.3424151Z              // Get peer version to check capabilities
2025-11-09T23:19:32.3424500Z              let peer_supports_utxo_commitments = {
2025-11-09T23:19:32.3424758Z                  let peer_states = network.peer_states.lock().unwrap();
2025-11-09T23:19:32.3425342Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:178:
2025-11-09T23:19:32.3425481Z                      false
2025-11-09T23:19:32.3425596Z                  }
2025-11-09T23:19:32.3425707Z              };
2025-11-09T23:19:32.3425829Z -            
2025-11-09T23:19:32.3425944Z +
2025-11-09T23:19:32.3426251Z              // If we know the peer doesn't support UTXO commitments, return error early
2025-11-09T23:19:32.3426423Z              if !peer_supports_utxo_commitments {
2025-11-09T23:19:32.3426560Z                  drop(network);
2025-11-09T23:19:32.3427118Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:186:
2025-11-09T23:19:32.3427612Z                      format!("Peer {} does not support UTXO commitments (missing NODE_UTXO_COMMITMENTS service flag)", peer_id)
2025-11-09T23:19:32.3427977Z                  ));
2025-11-09T23:19:32.3428106Z              }
2025-11-09T23:19:32.3428222Z -            
2025-11-09T23:19:32.3428342Z +
2025-11-09T23:19:32.3428531Z              // Register pending request before sending
2025-11-09T23:19:32.3428837Z              let (request_id, response_rx) = network.register_request(peer_addr);
2025-11-09T23:19:32.3430836Z              drop(network); // Release read lock before async wait
2025-11-09T23:19:32.3431423Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:193:
2025-11-09T23:19:32.3431541Z -            
2025-11-09T23:19:32.3431650Z +
2025-11-09T23:19:32.3431845Z              // Create GetUTXOSet message with request_id
2025-11-09T23:19:32.3432040Z -            let get_utxo_set_msg = GetUTXOSetMessage { 
2025-11-09T23:19:32.3432297Z +            let get_utxo_set_msg = GetUTXOSetMessage {
2025-11-09T23:19:32.3432458Z                  request_id,
2025-11-09T23:19:32.3432629Z -                height, 
2025-11-09T23:19:32.3432763Z -                block_hash 
2025-11-09T23:19:32.3432887Z +                height,
2025-11-09T23:19:32.3433023Z +                block_hash,
2025-11-09T23:19:32.3433138Z              };
2025-11-09T23:19:32.3433249Z  
2025-11-09T23:19:32.3433581Z              // Serialize message using protocol adapter (handles TCP vs Iroh format)
2025-11-09T23:19:32.3434172Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:203:
2025-11-09T23:19:32.3434878Z                  .map_err(|e| bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-09T23:19:32.3435096Z                      format!("Failed to serialize GetUTXOSet: {}", e)
2025-11-09T23:19:32.3435226Z                  ))?;
2025-11-09T23:19:32.3435339Z -            
2025-11-09T23:19:32.3435475Z +
2025-11-09T23:19:32.3435656Z              // Send message to peer via NetworkManager
2025-11-09T23:19:32.3436046Z              {
2025-11-09T23:19:32.3436249Z                  let network = network_manager.read().await;
2025-11-09T23:19:32.3436839Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:212:
2025-11-09T23:19:32.3437131Z                          format!("Failed to send GetUTXOSet to peer {}: {}", peer_addr, e)
2025-11-09T23:19:32.3443312Z                      ))?;
2025-11-09T23:19:32.3443462Z              }
2025-11-09T23:19:32.3443586Z -            
2025-11-09T23:19:32.3443700Z +
2025-11-09T23:19:32.3443898Z              // Await response with timeout (30 seconds)
2025-11-09T23:19:32.3444060Z              tokio::select! {
2025-11-09T23:19:32.3444224Z                  result = response_rx => {
2025-11-09T23:19:32.3445059Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:224:
2025-11-09T23:19:32.3445620Z                                  .map_err(|e| bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-09T23:19:32.3445871Z                                      format!("Failed to parse UTXOSet response: {}", e)
2025-11-09T23:19:32.3446004Z                                  ))?;
2025-11-09T23:19:32.3446140Z -                            
2025-11-09T23:19:32.3446252Z +
2025-11-09T23:19:32.3448312Z                              match parsed {
2025-11-09T23:19:32.3448525Z                                  ProtocolMessage::UTXOSet(utxo_set_msg) => {
2025-11-09T23:19:32.3448704Z                                      // Convert to UtxoCommitment
2025-11-09T23:19:32.3449298Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:291:
2025-11-09T23:19:32.3449412Z                  {
2025-11-09T23:19:32.3449640Z                      use crate::network::transport::TransportAddr;
2025-11-09T23:19:32.3449769Z                      use hex;
2025-11-09T23:19:32.3449899Z -                    
2025-11-09T23:19:32.3450019Z +
2025-11-09T23:19:32.3450508Z                      let node_id_hex = peer_id.strip_prefix("iroh:").ok_or_else(|| {
2025-11-09T23:19:32.3450996Z                          bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-09T23:19:32.3451234Z                              format!("Invalid Iroh peer_id format: {}", peer_id)
2025-11-09T23:19:32.3451799Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:298:
2025-11-09T23:19:32.3451914Z                          )
2025-11-09T23:19:32.3452036Z                      })?;
2025-11-09T23:19:32.3452148Z -                    
2025-11-09T23:19:32.3452261Z +
2025-11-09T23:19:32.3452517Z                      let node_id_bytes = hex::decode(node_id_hex).map_err(|e| {
2025-11-09T23:19:32.3452981Z                          bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-09T23:19:32.3453188Z                              format!("Invalid Iroh node ID hex: {}", e)
2025-11-09T23:19:32.3453756Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:304:
2025-11-09T23:19:32.3453891Z                          )
2025-11-09T23:19:32.3454012Z                      })?;
2025-11-09T23:19:32.3454131Z -                    
2025-11-09T23:19:32.3454254Z +
2025-11-09T23:19:32.3454691Z                      // Validate node ID length (Iroh uses 32-byte public keys)
2025-11-09T23:19:32.3454853Z                      if node_id_bytes.len() != 32 {
2025-11-09T23:19:32.3455384Z                          return Err(bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-09T23:19:32.3455975Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:310:
2025-11-09T23:19:32.3456361Z                              format!("Invalid Iroh node ID length: expected 32 bytes, got {}", node_id_bytes.len())
2025-11-09T23:19:32.3456753Z                          ));
2025-11-09T23:19:32.3456881Z                      }
2025-11-09T23:19:32.3456986Z -                    
2025-11-09T23:19:32.3457088Z +
2025-11-09T23:19:32.3457403Z                      // Create placeholder SocketAddr for Iroh (same approach as mod.rs)
2025-11-09T23:19:32.3457633Z                      // Use first 4 bytes of key for IP, last 2 bytes for port
2025-11-09T23:19:32.3457979Z -                    let ip_bytes = [node_id_bytes[0], node_id_bytes[1], node_id_bytes[2], node_id_bytes[3]];
2025-11-09T23:19:32.3459932Z +                    let ip_bytes = [
2025-11-09T23:19:32.3460087Z +                        node_id_bytes[0],
2025-11-09T23:19:32.3460230Z +                        node_id_bytes[1],
2025-11-09T23:19:32.3460366Z +                        node_id_bytes[2],
2025-11-09T23:19:32.3460515Z +                        node_id_bytes[3],
2025-11-09T23:19:32.3460640Z +                    ];
2025-11-09T23:19:32.3460970Z                      let port = u16::from_be_bytes([node_id_bytes[30], node_id_bytes[31]]);
2025-11-09T23:19:32.3461303Z                      let placeholder_addr = std::net::SocketAddr::from((ip_bytes, port));
2025-11-09T23:19:32.3461421Z -                    
2025-11-09T23:19:32.3461536Z +
2025-11-09T23:19:32.3461791Z                      let transport_addr = TransportAddr::Iroh(node_id_bytes);
2025-11-09T23:19:32.3462006Z                      Some((placeholder_addr, Some(transport_addr)))
2025-11-09T23:19:32.3462122Z                  }
2025-11-09T23:19:32.3462707Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:338:
2025-11-09T23:19:32.3462843Z                      ));
2025-11-09T23:19:32.3462960Z                  }
2025-11-09T23:19:32.3463075Z              };
2025-11-09T23:19:32.3463197Z -            
2025-11-09T23:19:32.3463308Z +
2025-11-09T23:19:32.3463491Z              // Store TransportAddr mapping if Iroh
2025-11-09T23:19:32.3463714Z              if let Some(transport_addr) = transport_addr_opt {
2025-11-09T23:19:32.3464119Z                  let network = network_manager.read().await;
2025-11-09T23:19:32.3464878Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:345:
2025-11-09T23:19:32.3465154Z                  // Store mapping from placeholder SocketAddr to TransportAddr
2025-11-09T23:19:32.3465548Z -                network.socket_to_transport.lock().unwrap().insert(peer_addr, transport_addr);
2025-11-09T23:19:32.3465674Z +                network
2025-11-09T23:19:32.3465823Z +                    .socket_to_transport
2025-11-09T23:19:32.3465956Z +                    .lock()
2025-11-09T23:19:32.3466091Z +                    .unwrap()
2025-11-09T23:19:32.3466267Z +                    .insert(peer_addr, transport_addr);
2025-11-09T23:19:32.3466396Z                  drop(network);
2025-11-09T23:19:32.3468366Z              }
2025-11-09T23:19:32.3468481Z  
2025-11-09T23:19:32.3469082Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:351:
2025-11-09T23:19:32.3469279Z              let network = network_manager.read().await;
2025-11-09T23:19:32.3469582Z              let (request_id, response_rx) = network.register_request(peer_addr);
2025-11-09T23:19:32.3469813Z              drop(network); // Release read lock before async wait
2025-11-09T23:19:32.3469932Z -            
2025-11-09T23:19:32.3470052Z +
2025-11-09T23:19:32.3470266Z              // Create GetFilteredBlock message with request_id
2025-11-09T23:19:32.3470492Z              use crate::network::protocol::FilterPreferences;
2025-11-09T23:19:32.3470739Z              let get_filtered_block_msg = GetFilteredBlockMessage {
2025-11-09T23:19:32.3471320Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:371:
2025-11-09T23:19:32.3471813Z                  .map_err(|e| bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-09T23:19:32.3472322Z                      format!("Failed to serialize GetFilteredBlock: {}", e)
2025-11-09T23:19:32.3472447Z                  ))?;
2025-11-09T23:19:32.3472561Z -            
2025-11-09T23:19:32.3472681Z +
2025-11-09T23:19:32.3472872Z              // Send message to peer via NetworkManager
2025-11-09T23:19:32.3472990Z              {
2025-11-09T23:19:32.3473181Z                  let network = network_manager.read().await;
2025-11-09T23:19:32.3473774Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:380:
2025-11-09T23:19:32.3474097Z                          format!("Failed to send GetFilteredBlock to peer {}: {}", peer_addr, e)
2025-11-09T23:19:32.3474225Z                      ))?;
2025-11-09T23:19:32.3474534Z              }
2025-11-09T23:19:32.3474653Z -            
2025-11-09T23:19:32.3474767Z +
2025-11-09T23:19:32.3474951Z              // Await response with timeout (30 seconds)
2025-11-09T23:19:32.3475127Z              tokio::select! {
2025-11-09T23:19:32.3475289Z                  result = response_rx => {
2025-11-09T23:19:32.3475870Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:392:
2025-11-09T23:19:32.3476406Z                                  .map_err(|e| bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-09T23:19:32.3476658Z                                      format!("Failed to parse FilteredBlock response: {}", e)
2025-11-09T23:19:32.3476782Z                                  ))?;
2025-11-09T23:19:32.3476913Z -                            
2025-11-09T23:19:32.3477018Z +
2025-11-09T23:19:32.3477157Z                              match parsed {
2025-11-09T23:19:32.3477420Z                                  ProtocolMessage::FilteredBlock(filtered_block_msg) => {
2025-11-09T23:19:32.3477591Z                                      // Convert to FilteredBlock
2025-11-09T23:19:32.3480007Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/health.rs:144:
2025-11-09T23:19:32.3480377Z          // Determine overall status
2025-11-09T23:19:32.3480778Z          let overall_status = if components.iter().any(|c| c.status == HealthStatus::Down) {
2025-11-09T23:19:32.3480943Z              HealthStatus::Down
2025-11-09T23:19:32.3481260Z -        } else if components.iter().any(|c| c.status == HealthStatus::Unhealthy) {
2025-11-09T23:19:32.3481398Z +        } else if components
2025-11-09T23:19:32.3481509Z +            .iter()
2025-11-09T23:19:32.3481694Z +            .any(|c| c.status == HealthStatus::Unhealthy)
2025-11-09T23:19:32.3481809Z +        {
2025-11-09T23:19:32.3481950Z              HealthStatus::Unhealthy
2025-11-09T23:19:32.3482250Z -        } else if components.iter().any(|c| c.status == HealthStatus::Degraded) {
2025-11-09T23:19:32.3482385Z +        } else if components
2025-11-09T23:19:32.3482495Z +            .iter()
2025-11-09T23:19:32.3482670Z +            .any(|c| c.status == HealthStatus::Degraded)
2025-11-09T23:19:32.3482786Z +        {
2025-11-09T23:19:32.3482944Z              HealthStatus::Degraded
2025-11-09T23:19:32.3483056Z          } else {
2025-11-09T23:19:32.3483193Z              HealthStatus::Healthy
2025-11-09T23:19:32.3483626Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/health.rs:180:
2025-11-09T23:19:32.3483748Z          Self::new()
2025-11-09T23:19:32.3483855Z      }
2025-11-09T23:19:32.3483960Z  }
2025-11-09T23:19:32.3484071Z -
2025-11-09T23:19:32.3484177Z  
2025-11-09T23:19:32.3486872Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:1:
2025-11-09T23:19:32.3488469Z  //! Mempool manager
2025-11-09T23:19:32.3488583Z -//! 
2025-11-09T23:19:32.3488694Z +//!
2025-11-09T23:19:32.3489000Z  //! Handles transaction mempool management, validation, and relay.
2025-11-09T23:19:32.3489112Z  
2025-11-09T23:19:32.3489252Z  use anyhow::Result;
2025-11-09T23:19:32.3489707Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:6:
2025-11-09T23:19:32.3490179Z -use bllvm_protocol::{Transaction, UtxoSet, Hash, OutPoint};
2025-11-09T23:19:32.3490351Z  use bllvm_protocol::mempool::Mempool;
2025-11-09T23:19:32.3490606Z +use bllvm_protocol::{Hash, OutPoint, Transaction, UtxoSet};
2025-11-09T23:19:32.3490779Z  use std::collections::{HashMap, HashSet};
2025-11-09T23:19:32.3490920Z  use tracing::{debug, info};
2025-11-09T23:19:32.3491028Z  
2025-11-09T23:19:32.3491478Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:31:
2025-11-09T23:19:32.3491651Z              spent_outputs: HashSet::new(),
2025-11-09T23:19:32.3491771Z          }
2025-11-09T23:19:32.3491889Z      }
2025-11-09T23:19:32.3492002Z -    
2025-11-09T23:19:32.3492116Z +
2025-11-09T23:19:32.3492262Z      /// Start the mempool manager
2025-11-09T23:19:32.3492466Z      pub async fn start(&mut self) -> Result<()> {
2025-11-09T23:19:32.3492628Z          info!("Starting mempool manager");
2025-11-09T23:19:32.3493091Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:38:
2025-11-09T23:19:32.3493214Z -        
2025-11-09T23:19:32.3493325Z +
2025-11-09T23:19:32.3493466Z          // Initialize mempool
2025-11-09T23:19:32.3493626Z          self.initialize_mempool().await?;
2025-11-09T23:19:32.3493745Z -        
2025-11-09T23:19:32.3493854Z +
2025-11-09T23:19:32.3494012Z          // Start mempool processing loop
2025-11-09T23:19:32.3494172Z          self.process_loop().await?;
2025-11-09T23:19:32.3494487Z -        
2025-11-09T23:19:32.3494604Z +
2025-11-09T23:19:32.3494721Z          Ok(())
2025-11-09T23:19:32.3494838Z      }
2025-11-09T23:19:32.3494947Z -    
2025-11-09T23:19:32.3495063Z +
2025-11-09T23:19:32.3495258Z      /// Run mempool processing once (for testing)
2025-11-09T23:19:32.3495481Z      pub async fn process_once(&mut self) -> Result<()> {
2025-11-09T23:19:32.3495640Z          // Process pending transactions
2025-11-09T23:19:32.3496100Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:51:
2025-11-09T23:19:32.3496526Z          self.process_pending_transactions().await?;
2025-11-09T23:19:32.3496657Z -        
2025-11-09T23:19:32.3496770Z +
2025-11-09T23:19:32.3496931Z          // Clean up old transactions
2025-11-09T23:19:32.3497101Z          self.cleanup_old_transactions().await?;
2025-11-09T23:19:32.3497214Z -        
2025-11-09T23:19:32.3497328Z +
2025-11-09T23:19:32.3497450Z          Ok(())
2025-11-09T23:19:32.3497556Z      }
2025-11-09T23:19:32.3497668Z -    
2025-11-09T23:19:32.3497789Z +
2025-11-09T23:19:32.3497929Z      /// Initialize mempool
2025-11-09T23:19:32.3498163Z      async fn initialize_mempool(&mut self) -> Result<()> {
2025-11-09T23:19:32.3498322Z          debug!("Initializing mempool");
2025-11-09T23:19:32.3498778Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:62:
2025-11-09T23:19:32.3498898Z -        
2025-11-09T23:19:32.3499009Z +
2025-11-09T23:19:32.3499231Z          // Load existing mempool from storage if available
2025-11-09T23:19:32.3499495Z          // In a real implementation, this would restore mempool state
2025-11-09T23:19:32.3499610Z -        
2025-11-09T23:19:32.3499719Z +
2025-11-09T23:19:32.3499846Z          Ok(())
2025-11-09T23:19:32.3499956Z      }
2025-11-09T23:19:32.3500068Z -    
2025-11-09T23:19:32.3500187Z +
2025-11-09T23:19:32.3500787Z      /// Main mempool processing loop
2025-11-09T23:19:32.3501220Z      async fn process_loop(&mut self) -> Result<()> {
2025-11-09T23:19:32.3501339Z          loop {
2025-11-09T23:19:32.3501790Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:72:
2025-11-09T23:19:32.3501948Z              // Process pending transactions
2025-11-09T23:19:32.3502134Z              self.process_pending_transactions().await?;
2025-11-09T23:19:32.3502250Z -            
2025-11-09T23:19:32.3502365Z +
2025-11-09T23:19:32.3502519Z              // Clean up old transactions
2025-11-09T23:19:32.3502961Z              self.cleanup_old_transactions().await?;
2025-11-09T23:19:32.3503086Z -            
2025-11-09T23:19:32.3503191Z +
2025-11-09T23:19:32.3503441Z              // Small delay to prevent busy waiting
2025-11-09T23:19:32.3503736Z              tokio::time::sleep(tokio::time::Duration::from_millis(100)).await;
2025-11-09T23:19:32.3503844Z          }
2025-11-09T23:19:32.3504277Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:81:
2025-11-09T23:19:32.3504574Z      }
2025-11-09T23:19:32.3504680Z -    
2025-11-09T23:19:32.3504802Z +
2025-11-09T23:19:32.3504963Z      /// Process pending transactions
2025-11-09T23:19:32.3505250Z      async fn process_pending_transactions(&mut self) -> Result<()> {
2025-11-09T23:19:32.3505419Z          // In a real implementation, this would:
2025-11-09T23:19:32.3505862Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:87:
2025-11-09T23:19:32.3506072Z          // 2. Validate transactions using consensus-proof
2025-11-09T23:19:32.3506245Z          // 3. Add valid transactions to mempool
2025-11-09T23:19:32.3506402Z          // 4. Relay transactions to peers
2025-11-09T23:19:32.3506516Z -        
2025-11-09T23:19:32.3506640Z +
2025-11-09T23:19:32.3506828Z          debug!("Processing pending transactions");
2025-11-09T23:19:32.3506950Z          Ok(())
2025-11-09T23:19:32.3507073Z      }
2025-11-09T23:19:32.3507509Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:94:
2025-11-09T23:19:32.3507626Z -    
2025-11-09T23:19:32.3507736Z +
2025-11-09T23:19:32.3507894Z      /// Clean up old transactions
2025-11-09T23:19:32.3508163Z      async fn cleanup_old_transactions(&mut self) -> Result<()> {
2025-11-09T23:19:32.3508338Z          // In a real implementation, this would:
2025-11-09T23:19:32.3508791Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:98:
2025-11-09T23:19:32.3508967Z          // 1. Remove transactions that are too old
2025-11-09T23:19:32.3509447Z          // 2. Remove transactions that conflict with new blocks
2025-11-09T23:19:32.3509641Z          // 3. Update transaction priorities
2025-11-09T23:19:32.3509759Z -        
2025-11-09T23:19:32.3509871Z +
2025-11-09T23:19:32.3510045Z          debug!("Cleaning up old transactions");
2025-11-09T23:19:32.3510170Z          Ok(())
2025-11-09T23:19:32.3510280Z      }
2025-11-09T23:19:32.3510727Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:105:
2025-11-09T23:19:32.3510852Z -    
2025-11-09T23:19:32.3510963Z +
2025-11-09T23:19:32.3511115Z      /// Add transaction to mempool
2025-11-09T23:19:32.3511970Z      pub async fn add_transaction(&mut self, tx: Transaction) -> Result<bool> {
2025-11-09T23:19:32.3512170Z          debug!("Adding transaction to mempool");
2025-11-09T23:19:32.3512626Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:109:
2025-11-09T23:19:32.3512746Z -        
2025-11-09T23:19:32.3512878Z +
2025-11-09T23:19:32.3513129Z          // Check for conflicts with existing mempool transactions
2025-11-09T23:19:32.3513279Z          for input in &tx.inputs {
2025-11-09T23:19:32.3513507Z              if self.spent_outputs.contains(&input.prevout) {
2025-11-09T23:19:32.3513972Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:114:
2025-11-09T23:19:32.3514115Z                  return Ok(false);
2025-11-09T23:19:32.3514232Z              }
2025-11-09T23:19:32.3514536Z          }
2025-11-09T23:19:32.3514654Z -        
2025-11-09T23:19:32.3514769Z +
2025-11-09T23:19:32.3515002Z          // Add transaction to mempool (store full transaction)
2025-11-09T23:19:32.3515229Z          use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:19:32.3515390Z          let tx_hash = calculate_tx_id(&tx);
2025-11-09T23:19:32.3515846Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:121:
2025-11-09T23:19:32.3516313Z          self.transactions.insert(tx_hash, tx.clone());
2025-11-09T23:19:32.3516485Z          self.mempool.insert(tx_hash);
2025-11-09T23:19:32.3516604Z -        
2025-11-09T23:19:32.3516723Z +
2025-11-09T23:19:32.3516864Z          // Track spent outputs
2025-11-09T23:19:32.3517010Z          for input in &tx.inputs {
2025-11-09T23:19:32.3517239Z              self.spent_outputs.insert(input.prevout.clone());
2025-11-09T23:19:32.3517685Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:127:
2025-11-09T23:19:32.3517795Z          }
2025-11-09T23:19:32.3517909Z -        
2025-11-09T23:19:32.3518037Z +
2025-11-09T23:19:32.3518157Z          Ok(true)
2025-11-09T23:19:32.3518268Z      }
2025-11-09T23:19:32.3518378Z -    
2025-11-09T23:19:32.3520414Z +
2025-11-09T23:19:32.3520550Z      /// Get mempool size
2025-11-09T23:19:32.3520701Z      pub fn size(&self) -> usize {
2025-11-09T23:19:32.3520860Z          self.transactions.len()
2025-11-09T23:19:32.3521309Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:135:
2025-11-09T23:19:32.3521444Z      }
2025-11-09T23:19:32.3521557Z -    
2025-11-09T23:19:32.3521663Z +
2025-11-09T23:19:32.3521827Z      /// Get mempool transaction hashes
2025-11-09T23:19:32.3522022Z      pub fn transaction_hashes(&self) -> Vec<Hash> {
2025-11-09T23:19:32.3522205Z          self.transactions.keys().cloned().collect()
2025-11-09T23:19:32.3522653Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:140:
2025-11-09T23:19:32.3522769Z      }
2025-11-09T23:19:32.3522879Z -    
2025-11-09T23:19:32.3522990Z +
2025-11-09T23:19:32.3523143Z      /// Get transaction by hash
2025-11-09T23:19:32.3523435Z      pub fn get_transaction(&self, hash: &Hash) -> Option<Transaction> {
2025-11-09T23:19:32.3523608Z          self.transactions.get(hash).cloned()
2025-11-09T23:19:32.3524064Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:145:
2025-11-09T23:19:32.3524191Z      }
2025-11-09T23:19:32.3524489Z -    
2025-11-09T23:19:32.3524610Z +
2025-11-09T23:19:32.3524992Z      /// Get all transactions
2025-11-09T23:19:32.3525239Z      pub fn get_transactions(&self) -> Vec<Transaction> {
2025-11-09T23:19:32.3525444Z          self.transactions.values().cloned().collect()
2025-11-09T23:19:32.3525907Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:150:
2025-11-09T23:19:32.3526022Z      }
2025-11-09T23:19:32.3526139Z -    
2025-11-09T23:19:32.3526258Z +
2025-11-09T23:19:32.3526440Z      /// Get prioritized transactions by fee rate
2025-11-09T23:19:32.3526550Z -    /// 
2025-11-09T23:19:32.3526662Z +    ///
2025-11-09T23:19:32.3527058Z      /// Returns transactions sorted by fee rate (satoshis per vbyte) in descending order.
2025-11-09T23:19:32.3527235Z      /// Requires UTXO set to calculate fee rates.
2025-11-09T23:19:32.3527685Z -    pub fn get_prioritized_transactions(&self, limit: usize, utxo_set: &UtxoSet) -> Vec<Transaction> {
2025-11-09T23:19:32.3527872Z +    pub fn get_prioritized_transactions(
2025-11-09T23:19:32.3527997Z +        &self,
2025-11-09T23:19:32.3528123Z +        limit: usize,
2025-11-09T23:19:32.3528257Z +        utxo_set: &UtxoSet,
2025-11-09T23:19:32.3528397Z +    ) -> Vec<Transaction> {
2025-11-09T23:19:32.3528643Z          let mut tx_with_fees: Vec<(Transaction, u64)> = Vec::new();
2025-11-09T23:19:32.3528756Z -        
2025-11-09T23:19:32.3528874Z +
2025-11-09T23:19:32.3529048Z          for tx in self.transactions.values() {
2025-11-09T23:19:32.3529216Z              // Calculate fee for this transaction
2025-11-09T23:19:32.3529439Z              let fee = self.calculate_transaction_fee(tx, utxo_set);
2025-11-09T23:19:32.3529883Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:162:
2025-11-09T23:19:32.3529988Z -            
2025-11-09T23:19:32.3530088Z +
2025-11-09T23:19:32.3530814Z              // Calculate transaction size (simplified - use serialized size estimate)
2025-11-09T23:19:32.3531281Z              let size = self.estimate_transaction_size(tx);
2025-11-09T23:19:32.3531408Z -            
2025-11-09T23:19:32.3533422Z +
2025-11-09T23:19:32.3533613Z              // Calculate fee rate (satoshis per vbyte)
2025-11-09T23:19:32.3533765Z              let fee_rate = if size > 0 {
2025-11-09T23:19:32.3534139Z                  fee * 1000 / size as u64 // Convert to satoshis per vbyte (multiply by 1000 for precision)
2025-11-09T23:19:32.3534785Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:169:
2025-11-09T23:19:32.3534911Z              } else {
2025-11-09T23:19:32.3535029Z                  0
2025-11-09T23:19:32.3535147Z              };
2025-11-09T23:19:32.3535258Z -            
2025-11-09T23:19:32.3535368Z +
2025-11-09T23:19:32.3535546Z              tx_with_fees.push((tx.clone(), fee_rate));
2025-11-09T23:19:32.3535661Z          }
2025-11-09T23:19:32.3535773Z -        
2025-11-09T23:19:32.3535886Z +
2025-11-09T23:19:32.3536048Z          // Sort by fee rate (descending)
2025-11-09T23:19:32.3536233Z          tx_with_fees.sort_by(|a, b| b.1.cmp(&a.1));
2025-11-09T23:19:32.3536333Z -        
2025-11-09T23:19:32.3536431Z +
2025-11-09T23:19:32.3536571Z          // Return top N transactions
2025-11-09T23:19:32.3536707Z -        tx_with_fees.into_iter()
2025-11-09T23:19:32.3536825Z +        tx_with_fees
2025-11-09T23:19:32.3536946Z +            .into_iter()
2025-11-09T23:19:32.3537055Z              .take(limit)
2025-11-09T23:19:32.3537178Z              .map(|(tx, _)| tx)
2025-11-09T23:19:32.3537300Z              .collect()
2025-11-09T23:19:32.3537726Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:184:
2025-11-09T23:19:32.3537837Z      }
2025-11-09T23:19:32.3537947Z -    
2025-11-09T23:19:32.3538062Z +
2025-11-09T23:19:32.3538216Z      /// Calculate transaction fee
2025-11-09T23:19:32.3538329Z -    /// 
2025-11-09T23:19:32.3538440Z +    ///
2025-11-09T23:19:32.3538616Z      /// Fee = sum of inputs - sum of outputs
2025-11-09T23:19:32.3539228Z      pub fn calculate_transaction_fee(&self, tx: &Transaction, utxo_set: &UtxoSet) -> u64 {
2025-11-09T23:19:32.3539393Z          let mut input_total = 0u64;
2025-11-09T23:19:32.3539848Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:191:
2025-11-09T23:19:32.3539962Z -        
2025-11-09T23:19:32.3540069Z +
2025-11-09T23:19:32.3540219Z          // Sum input values from UTXO set
2025-11-09T23:19:32.3540362Z          for input in &tx.inputs {
2025-11-09T23:19:32.3540563Z              if let Some(utxo) = utxo_set.get(&input.prevout) {
2025-11-09T23:19:32.3541000Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:195:
2025-11-09T23:19:32.3541174Z                  input_total += utxo.value as u64;
2025-11-09T23:19:32.3541291Z              }
2025-11-09T23:19:32.3541405Z          }
2025-11-09T23:19:32.3541524Z -        
2025-11-09T23:19:32.3541632Z +
2025-11-09T23:19:32.3541765Z          // Sum output values
2025-11-09T23:19:32.3542107Z          let output_total: u64 = tx.outputs.iter().map(|out| out.value as u64).sum();
2025-11-09T23:19:32.3542236Z -        
2025-11-09T23:19:32.3542345Z +
2025-11-09T23:19:32.3542516Z          // Fee is difference (inputs - outputs)
2025-11-09T23:19:32.3542676Z          if input_total > output_total {
2025-11-09T23:19:32.3542824Z              input_total - output_total
2025-11-09T23:19:32.3543265Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:206:
2025-11-09T23:19:32.3543381Z              0
2025-11-09T23:19:32.3543501Z          }
2025-11-09T23:19:32.3543610Z      }
2025-11-09T23:19:32.3543718Z -    
2025-11-09T23:19:32.3543837Z +
2025-11-09T23:19:32.3544001Z      /// Estimate transaction size in vbytes
2025-11-09T23:19:32.3544112Z -    /// 
2025-11-09T23:19:32.3544224Z +    ///
2025-11-09T23:19:32.3544754Z      /// Simplified estimation - in production, would use actual serialized size
2025-11-09T23:19:32.3545037Z      fn estimate_transaction_size(&self, tx: &Transaction) -> usize {
2025-11-09T23:19:32.3545522Z          // Base transaction size: version (4) + locktime (4) = 8 bytes
2025-11-09T23:19:32.3545957Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:215:
2025-11-09T23:19:32.3546087Z          let mut size = 8;
2025-11-09T23:19:32.3546201Z -        
2025-11-09T23:19:32.3546311Z +
2025-11-09T23:19:32.3546562Z          // Input size: prevout (36) + script_sig (var) + sequence (4)
2025-11-09T23:19:32.3546701Z          for input in &tx.inputs {
2025-11-09T23:19:32.3546835Z              size += 36; // prevout
2025-11-09T23:19:32.3547282Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:220:
2025-11-09T23:19:32.3547440Z              size += input.script_sig.len();
2025-11-09T23:19:32.3547569Z              size += 4; // sequence
2025-11-09T23:19:32.3547692Z          }
2025-11-09T23:19:32.3547808Z -        
2025-11-09T23:19:32.3547917Z +
2025-11-09T23:19:32.3548122Z          // Output size: value (8) + script_pubkey (var)
2025-11-09T23:19:32.3548291Z          for output in &tx.outputs {
2025-11-09T23:19:32.3548426Z              size += 8; // value
2025-11-09T23:19:32.3550928Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:227:
2025-11-09T23:19:32.3551124Z              size += output.script_pubkey.len();
2025-11-09T23:19:32.3551240Z          }
2025-11-09T23:19:32.3551353Z -        
2025-11-09T23:19:32.3551466Z +
2025-11-09T23:19:32.3551805Z          // Add witness discount if segwit (simplified - assume no witness for now)
2025-11-09T23:19:32.3551924Z          size
2025-11-09T23:19:32.3552031Z      }
2025-11-09T23:19:32.3552488Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:233:
2025-11-09T23:19:32.3552604Z -    
2025-11-09T23:19:32.3552713Z +
2025-11-09T23:19:32.3552875Z      /// Remove transaction from mempool
2025-11-09T23:19:32.3553133Z      pub fn remove_transaction(&mut self, hash: &Hash) -> bool {
2025-11-09T23:19:32.3553631Z          if let Some(tx) = self.transactions.remove(hash) {
2025-11-09T23:19:32.3554101Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:237:
2025-11-09T23:19:32.3554270Z              self.mempool.remove(hash);
2025-11-09T23:19:32.3554529Z -            
2025-11-09T23:19:32.3554643Z +
2025-11-09T23:19:32.3554813Z              // Remove spent outputs tracking
2025-11-09T23:19:32.3554975Z              for input in &tx.inputs {
2025-11-09T23:19:32.3555179Z                  self.spent_outputs.remove(&input.prevout);
2025-11-09T23:19:32.3555631Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:242:
2025-11-09T23:19:32.3555759Z              }
2025-11-09T23:19:32.3555871Z -            
2025-11-09T23:19:32.3555984Z +
2025-11-09T23:19:32.3556101Z              true
2025-11-09T23:19:32.3556225Z          } else {
2025-11-09T23:19:32.3556343Z              false
2025-11-09T23:19:32.3556821Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:247:
2025-11-09T23:19:32.3556952Z          }
2025-11-09T23:19:32.3557068Z      }
2025-11-09T23:19:32.3557175Z -    
2025-11-09T23:19:32.3557283Z +
2025-11-09T23:19:32.3557422Z      /// Clear mempool
2025-11-09T23:19:32.3557565Z      pub fn clear(&mut self) {
2025-11-09T23:19:32.3557721Z          self.transactions.clear();
2025-11-09T23:19:32.3558169Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:253:
2025-11-09T23:19:32.3558327Z          self.mempool.clear();
2025-11-09T23:19:32.3558481Z          self.spent_outputs.clear();
2025-11-09T23:19:32.3558595Z      }
2025-11-09T23:19:32.3560601Z -    
2025-11-09T23:19:32.3560714Z +
2025-11-09T23:19:32.3560887Z      /// Save mempool to disk for persistence
2025-11-09T23:19:32.3561249Z      pub fn save_to_disk<P: AsRef<std::path::Path>>(&self, path: P) -> Result<()> {
2025-11-09T23:19:32.3561592Z +        use bllvm_protocol::serialization::transaction::serialize_transaction;
2025-11-09T23:19:32.3562001Z          use std::fs::File;
2025-11-09T23:19:32.3562157Z          use std::io::Write;
2025-11-09T23:19:32.3562497Z -        use bllvm_protocol::serialization::transaction::serialize_transaction;
2025-11-09T23:19:32.3562613Z -        
2025-11-09T23:19:32.3562723Z +
2025-11-09T23:19:32.3562922Z          let transactions = self.get_transactions();
2025-11-09T23:19:32.3563092Z          let mut file = File::create(path)?;
2025-11-09T23:19:32.3563205Z -        
2025-11-09T23:19:32.3563318Z +
2025-11-09T23:19:32.3563464Z          // Write transaction count
2025-11-09T23:19:32.3563722Z          file.write_all(&(transactions.len() as u32).to_le_bytes())?;
2025-11-09T23:19:32.3563834Z -        
2025-11-09T23:19:32.3563953Z +
2025-11-09T23:19:32.3564095Z          // Write each transaction
2025-11-09T23:19:32.3564238Z          for tx in transactions {
2025-11-09T23:19:32.3564579Z              let serialized = serialize_transaction(&tx);
2025-11-09T23:19:32.3565054Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:272:
2025-11-09T23:19:32.3565306Z              file.write_all(&(serialized.len() as u32).to_le_bytes())?;
2025-11-09T23:19:32.3565475Z              file.write_all(&serialized)?;
2025-11-09T23:19:32.3565590Z          }
2025-11-09T23:19:32.3565705Z -        
2025-11-09T23:19:32.3565811Z +
2025-11-09T23:19:32.3565952Z          file.sync_all()?;
2025-11-09T23:19:32.3566067Z          Ok(())
2025-11-09T23:19:32.3566179Z      }
2025-11-09T23:19:32.3566630Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:279:
2025-11-09T23:19:32.3566754Z  }
2025-11-09T23:19:32.3566864Z  
2025-11-09T23:19:32.3567026Z  impl Default for MempoolManager {
2025-11-09T23:19:32.3567199Z -    fn default() -> Self { Self::new() }
2025-11-09T23:19:32.3567340Z +    fn default() -> Self {
2025-11-09T23:19:32.3567465Z +        Self::new()
2025-11-09T23:19:32.3567576Z +    }
2025-11-09T23:19:32.3567695Z  }
2025-11-09T23:19:32.3567808Z  
2025-11-09T23:19:32.3568381Z  // Implement MempoolProvider trait for integration with MiningCoordinator
2025-11-09T23:19:32.3568864Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:298:
2025-11-09T23:19:32.3568995Z          self.size()
2025-11-09T23:19:32.3569108Z      }
2025-11-09T23:19:32.3569219Z  
2025-11-09T23:19:32.3569871Z -    fn get_prioritized_transactions(&self, limit: usize, utxo_set: &bllvm_protocol::UtxoSet) -> Vec<bllvm_protocol::Transaction> {
2025-11-09T23:19:32.3570039Z +    fn get_prioritized_transactions(
2025-11-09T23:19:32.3570153Z +        &self,
2025-11-09T23:19:32.3570285Z +        limit: usize,
2025-11-09T23:19:32.3570457Z +        utxo_set: &bllvm_protocol::UtxoSet,
2025-11-09T23:19:32.3570623Z +    ) -> Vec<bllvm_protocol::Transaction> {
2025-11-09T23:19:32.3570851Z          self.get_prioritized_transactions(limit, utxo_set)
2025-11-09T23:19:32.3570967Z      }
2025-11-09T23:19:32.3571078Z  
2025-11-09T23:19:32.3571549Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:312:
2025-11-09T23:19:32.3571697Z  impl MempoolManager {
2025-11-09T23:19:32.3571838Z      /// Load mempool from disk
2025-11-09T23:19:32.3572199Z      pub fn load_from_disk<P: AsRef<std::path::Path>>(&mut self, path: P) -> Result<()> {
2025-11-09T23:19:32.3572551Z +        use bllvm_protocol::serialization::transaction::deserialize_transaction;
2025-11-09T23:19:32.3572695Z          use std::fs::File;
2025-11-09T23:19:32.3572825Z          use std::io::Read;
2025-11-09T23:19:32.3573160Z -        use bllvm_protocol::serialization::transaction::deserialize_transaction;
2025-11-09T23:19:32.3573277Z -        
2025-11-09T23:19:32.3573389Z +
2025-11-09T23:19:32.3573559Z          let mut file = File::open(path)?;
2025-11-09T23:19:32.3573715Z          let mut count_bytes = [0u8; 4];
2025-11-09T23:19:32.3573869Z          file.read_exact(&mut count_bytes)?;
2025-11-09T23:19:32.3574468Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:322:
2025-11-09T23:19:32.3574950Z          let count = u32::from_le_bytes(count_bytes) as usize;
2025-11-09T23:19:32.3575067Z -        
2025-11-09T23:19:32.3575181Z +
2025-11-09T23:19:32.3575314Z          for _ in 0..count {
2025-11-09T23:19:32.3575472Z              let mut len_bytes = [0u8; 4];
2025-11-09T23:19:32.3575633Z              file.read_exact(&mut len_bytes)?;
2025-11-09T23:19:32.3576089Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:327:
2025-11-09T23:19:32.3576306Z              let len = u32::from_le_bytes(len_bytes) as usize;
2025-11-09T23:19:32.3576602Z -            
2025-11-09T23:19:32.3576718Z +
2025-11-09T23:19:32.3576888Z              let mut tx_bytes = vec![0u8; len];
2025-11-09T23:19:32.3577045Z              file.read_exact(&mut tx_bytes)?;
2025-11-09T23:19:32.3577158Z -            
2025-11-09T23:19:32.3577264Z +
2025-11-09T23:19:32.3577469Z              let tx = deserialize_transaction(&tx_bytes)?;
2025-11-09T23:19:32.3577638Z              let _ = self.add_transaction(tx);
2025-11-09T23:19:32.3577759Z          }
2025-11-09T23:19:32.3578215Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:335:
2025-11-09T23:19:32.3578329Z -        
2025-11-09T23:19:32.3578439Z +
2025-11-09T23:19:32.3578559Z          Ok(())
2025-11-09T23:19:32.3578677Z      }
2025-11-09T23:19:32.3578788Z  }
2025-11-09T23:19:32.3579254Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/metrics.rs:2:
2025-11-09T23:19:32.3579369Z  //!
2025-11-09T23:19:32.3579788Z  //! Provides comprehensive metrics for monitoring node health, performance, and behavior.
2025-11-09T23:19:32.3579900Z  
2025-11-09T23:19:32.3580457Z +use serde::{Deserialize, Serialize};
2025-11-09T23:19:32.3580617Z  use std::sync::Arc;
2025-11-09T23:19:32.3580748Z  use std::sync::Mutex;
2025-11-09T23:19:32.3580959Z  use std::time::{Duration, SystemTime, UNIX_EPOCH};
2025-11-09T23:19:32.3581405Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/metrics.rs:8:
2025-11-09T23:19:32.3581810Z -use serde::{Deserialize, Serialize};
2025-11-09T23:19:32.3581931Z  
2025-11-09T23:19:32.3582093Z  /// Comprehensive node metrics
2025-11-09T23:19:32.3582287Z  #[derive(Debug, Clone, Serialize, Deserialize)]
2025-11-09T23:19:32.3582810Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/metrics.rs:251:
2025-11-09T23:19:32.3582952Z          Self::new()
2025-11-09T23:19:32.3583072Z      }
2025-11-09T23:19:32.3583184Z  }
2025-11-09T23:19:32.3583296Z -
2025-11-09T23:19:32.3583412Z  
2025-11-09T23:19:32.3631282Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/miner.rs:20:
2025-11-09T23:19:32.3632051Z  
2025-11-09T23:19:32.3632395Z      /// Get prioritized transactions (by fee rate)
2025-11-09T23:19:32.3632932Z      /// Requires UTXO set for accurate fee calculation
2025-11-09T23:19:32.3633851Z -    fn get_prioritized_transactions(&self, limit: usize, utxo_set: &bllvm_protocol::UtxoSet) -> Vec<Transaction>;
2025-11-09T23:19:32.3634924Z +    fn get_prioritized_transactions(
2025-11-09T23:19:32.3635361Z +        &self,
2025-11-09T23:19:32.3635676Z +        limit: usize,
2025-11-09T23:19:32.3636071Z +        utxo_set: &bllvm_protocol::UtxoSet,
2025-11-09T23:19:32.3636530Z +    ) -> Vec<Transaction>;
2025-11-09T23:19:32.3636881Z  
2025-11-09T23:19:32.3637194Z      /// Remove transaction from mempool
2025-11-09T23:19:32.3637736Z      fn remove_transaction(&mut self, hash: &[u8; 32]) -> bool;
2025-11-09T23:19:32.3640439Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/miner.rs:57:
2025-11-09T23:19:32.3641146Z  
2025-11-09T23:19:32.3641442Z      /// Select transactions for block
2025-11-09T23:19:32.3642056Z      /// Note: Requires UTXO set for fee calculation - caller must provide it
2025-11-09T23:19:32.3643172Z -    pub fn select_transactions(&self, mempool: &dyn MempoolProvider, utxo_set: &bllvm_protocol::UtxoSet) -> Vec<Transaction> {
2025-11-09T23:19:32.3644648Z +    pub fn select_transactions(
2025-11-09T23:19:32.3645064Z +        &self,
2025-11-09T23:19:32.3645414Z +        mempool: &dyn MempoolProvider,
2025-11-09T23:19:32.3645946Z +        utxo_set: &bllvm_protocol::UtxoSet,
2025-11-09T23:19:32.3646402Z +    ) -> Vec<Transaction> {
2025-11-09T23:19:32.3646801Z          let mut selected = Vec::new();
2025-11-09T23:19:32.3647242Z          let mut current_size = 0;
2025-11-09T23:19:32.3647657Z          let mut current_weight = 0;
2025-11-09T23:19:32.3648384Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/miner.rs:392:
2025-11-09T23:19:32.3650713Z  
2025-11-09T23:19:32.3651117Z          // Get chain tip from storage for prev_block_hash and difficulty
2025-11-09T23:19:32.3651877Z          let (prev_block_hash, bits, height) = if let Some(ref storage) = self.storage {
2025-11-09T23:19:32.3652622Z -            if let Some(tip_header) = storage.chain().get_tip_header()
2025-11-09T23:19:32.3653331Z -                .map_err(|e| anyhow::anyhow!("Failed to get tip header: {}", e))? {
2025-11-09T23:19:32.3654056Z -                let tip_hash = storage.chain().get_tip_hash()
2025-11-09T23:19:32.3654826Z +            if let Some(tip_header) = storage
2025-11-09T23:19:32.3655256Z +                .chain()
2025-11-09T23:19:32.3655607Z +                .get_tip_header()
2025-11-09T23:19:32.3656132Z +                .map_err(|e| anyhow::anyhow!("Failed to get tip header: {}", e))?
2025-11-09T23:19:32.3656634Z +            {
2025-11-09T23:19:32.3656932Z +                let tip_hash = storage
2025-11-09T23:19:32.3657321Z +                    .chain()
2025-11-09T23:19:32.3657657Z +                    .get_tip_hash()
2025-11-09T23:19:32.3658175Z                      .map_err(|e| anyhow::anyhow!("Failed to get tip hash: {}", e))?
2025-11-09T23:19:32.3660570Z                      .unwrap_or([0u8; 32]);
2025-11-09T23:19:32.3661046Z -                let chain_height = storage.chain().get_height()
2025-11-09T23:19:32.3661539Z +                let chain_height = storage
2025-11-09T23:19:32.3661922Z +                    .chain()
2025-11-09T23:19:32.3662483Z +                    .get_height()
2025-11-09T23:19:32.3662986Z                      .map_err(|e| anyhow::anyhow!("Failed to get chain height: {}", e))?
2025-11-09T23:19:32.3663490Z                      .unwrap_or(0);
2025-11-09T23:19:32.3663913Z                  (tip_hash, tip_header.bits, chain_height)
2025-11-09T23:19:32.3664801Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/miner.rs:412:
2025-11-09T23:19:32.3665456Z  
2025-11-09T23:19:32.3665755Z          // Get UTXO set from storage for fee calculation
2025-11-09T23:19:32.3666278Z          let utxo_set = if let Some(ref storage) = self.storage {
2025-11-09T23:19:32.3666775Z -            storage.utxos().get_all_utxos()
2025-11-09T23:19:32.3667165Z +            storage
2025-11-09T23:19:32.3667454Z +                .utxos()
2025-11-09T23:19:32.3667764Z +                .get_all_utxos()
2025-11-09T23:19:32.3668246Z                  .map_err(|e| anyhow::anyhow!("Failed to get UTXO set: {}", e))?
2025-11-09T23:19:32.3670614Z          } else {
2025-11-09T23:19:32.3671002Z              // No storage - use empty UTXO set (will result in 0 fees)
2025-11-09T23:19:32.3671749Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/miner.rs:616:
2025-11-09T23:19:32.3672436Z          self.transactions.len()
2025-11-09T23:19:32.3672802Z      }
2025-11-09T23:19:32.3673073Z  
2025-11-09T23:19:32.3673766Z -    fn get_prioritized_transactions(&self, limit: usize, _utxo_set: &bllvm_protocol::UtxoSet) -> Vec<Transaction> {
2025-11-09T23:19:32.3674801Z +    fn get_prioritized_transactions(
2025-11-09T23:19:32.3675231Z +        &self,
2025-11-09T23:19:32.3675530Z +        limit: usize,
2025-11-09T23:19:32.3675913Z +        _utxo_set: &bllvm_protocol::UtxoSet,
2025-11-09T23:19:32.3676358Z +    ) -> Vec<Transaction> {
2025-11-09T23:19:32.3676951Z          // Mock implementation ignores UTXO set and uses pre-calculated priorities
2025-11-09T23:19:32.3677880Z          self.prioritized_transactions
2025-11-09T23:19:32.3678316Z              .iter()
2025-11-09T23:19:32.3678957Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/miner.rs:786:
2025-11-09T23:19:32.3679750Z          assert_eq!(mempool.get_mempool_size(), 0);
2025-11-09T23:19:32.3680302Z          assert!(mempool.get_transactions().is_empty());
2025-11-09T23:19:32.3682548Z          let empty_utxo_set = bllvm_protocol::UtxoSet::new();
2025-11-09T23:19:32.3683354Z -        assert!(mempool.get_prioritized_transactions(10, &empty_utxo_set).is_empty());
2025-11-09T23:19:32.3684027Z +        assert!(mempool
2025-11-09T23:19:32.3684654Z +            .get_prioritized_transactions(10, &empty_utxo_set)
2025-11-09T23:19:32.3685177Z +            .is_empty());
2025-11-09T23:19:32.3685519Z      }
2025-11-09T23:19:32.3685781Z  
2025-11-09T23:19:32.3686036Z      #[test]
2025-11-09T23:19:32.3772973Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:5:
2025-11-09T23:19:32.3773785Z  
2025-11-09T23:19:32.3774112Z  pub mod block_processor;
2025-11-09T23:19:32.3774680Z  pub mod event_publisher;
2025-11-09T23:19:32.3781957Z +pub mod health;
2025-11-09T23:19:32.3782330Z  pub mod mempool;
2025-11-09T23:19:32.3782678Z -pub mod miner;
2025-11-09T23:19:32.3783019Z -pub mod sync;
2025-11-09T23:19:32.3783341Z  pub mod metrics;
2025-11-09T23:19:32.3783686Z -pub mod health;
2025-11-09T23:19:32.3784010Z +pub mod miner;
2025-11-09T23:19:32.3784604Z  pub mod performance;
2025-11-09T23:19:32.3784989Z +pub mod sync;
2025-11-09T23:19:32.3785289Z  
2025-11-09T23:19:32.3785597Z  use anyhow::Result;
2025-11-09T23:19:32.3785948Z  use std::net::SocketAddr;
2025-11-09T23:19:32.3786618Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:70:
2025-11-09T23:19:32.3787320Z  
2025-11-09T23:19:32.3787619Z          // Initialize components
2025-11-09T23:19:32.3788252Z          let protocol_version = protocol_version.unwrap_or(ProtocolVersion::Regtest);
2025-11-09T23:19:32.3790833Z -        let protocol =
2025-11-09T23:19:32.3791554Z -            BitcoinProtocolEngine::new(protocol_version)?;
2025-11-09T23:19:32.3792213Z +        let protocol = BitcoinProtocolEngine::new(protocol_version)?;
2025-11-09T23:19:32.3792845Z          let protocol_arc = Arc::new(protocol);
2025-11-09T23:19:32.3793320Z          let storage = Storage::new(data_dir)?;
2025-11-09T23:19:32.3793788Z          let storage_arc = Arc::new(storage);
2025-11-09T23:19:32.3794713Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:78:
2025-11-09T23:19:32.3795625Z          let mempool_manager_arc = Arc::new(mempool::MempoolManager::new());
2025-11-09T23:19:32.3796317Z -        let network = NetworkManager::new(network_addr)
2025-11-09T23:19:32.3797164Z -            .with_dependencies(Arc::clone(&protocol_arc), Arc::clone(&storage_arc), Arc::clone(&mempool_manager_arc));
2025-11-09T23:19:32.3798140Z +        let network = NetworkManager::new(network_addr).with_dependencies(
2025-11-09T23:19:32.3800675Z +            Arc::clone(&protocol_arc),
2025-11-09T23:19:32.3801406Z +            Arc::clone(&storage_arc),
2025-11-09T23:19:32.3801860Z +            Arc::clone(&mempool_manager_arc),
2025-11-09T23:19:32.3802288Z +        );
2025-11-09T23:19:32.3802610Z          let network_arc = Arc::new(network);
2025-11-09T23:19:32.3803153Z          let metrics_arc = Arc::new(MetricsCollector::new());
2025-11-09T23:19:32.3803789Z          let profiler_arc = Arc::new(PerformanceProfiler::new(1000));
2025-11-09T23:19:32.3804804Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:187:
2025-11-09T23:19:32.3805567Z          info!("Sync coordinator initialized");
2025-11-09T23:19:32.3806051Z          info!("Mempool manager initialized");
2025-11-09T23:19:32.3806556Z          info!("Mining coordinator initialized");
2025-11-09T23:19:32.3806996Z -        
2025-11-09T23:19:32.3807284Z +
2025-11-09T23:19:32.3807851Z          // Start network manager
2025-11-09T23:19:32.3808377Z          if let Err(e) = self.network.start(self.network_addr).await {
2025-11-09T23:19:32.3809006Z              warn!("Failed to start network manager: {}", e);
2025-11-09T23:19:32.3809774Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:194:
2025-11-09T23:19:32.3810569Z              // Continue anyway - network might be optional
2025-11-09T23:19:32.3811025Z          }
2025-11-09T23:19:32.3811294Z -        
2025-11-09T23:19:32.3811541Z +
2025-11-09T23:19:32.3811889Z          // Initialize peer connections automatically
2025-11-09T23:19:32.3812464Z          self.initialize_peer_connections().await?;
2025-11-09T23:19:32.3812905Z  
2025-11-09T23:19:32.3813446Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:203:
2025-11-09T23:19:32.3814124Z              if config.prune_on_startup {
2025-11-09T23:19:32.3814919Z                  let current_height = self.storage.chain().get_height()?.unwrap_or(0);
2025-11-09T23:19:32.3815588Z                  let is_ibd = current_height == 0;
2025-11-09T23:19:32.3816010Z -                
2025-11-09T23:19:32.3816309Z +
2025-11-09T23:19:32.3816667Z                  if !is_ibd && pruning_manager.is_enabled() {
2025-11-09T23:19:32.3817325Z                      info!("Prune on startup enabled, checking if pruning is needed...");
2025-11-09T23:19:32.3817908Z -                    
2025-11-09T23:19:32.3818233Z +
2025-11-09T23:19:32.3818592Z                      // Calculate prune height based on configuration
2025-11-09T23:19:32.3819157Z                      let prune_height = match &config.mode {
2025-11-09T23:19:32.3819696Z                          crate::config::PruningMode::Disabled => {
2025-11-09T23:19:32.3822122Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:213:
2025-11-09T23:19:32.3822842Z                              // Skip if disabled
2025-11-09T23:19:32.3823288Z                              None
2025-11-09T23:19:32.3823681Z                          }
2025-11-09T23:19:32.3824618Z -                        crate::config::PruningMode::Normal { keep_from_height, .. } => {
2025-11-09T23:19:32.3825325Z +                        crate::config::PruningMode::Normal {
2025-11-09T23:19:32.3825821Z +                            keep_from_height, ..
2025-11-09T23:19:32.3826267Z +                        } => {
2025-11-09T23:19:32.3826678Z                              // Prune up to keep_from_height
2025-11-09T23:19:32.3827189Z                              Some(*keep_from_height)
2025-11-09T23:19:32.3827616Z                          }
2025-11-09T23:19:32.3828244Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:220:
2025-11-09T23:19:32.3828979Z                          #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.3829597Z -                        crate::config::PruningMode::Aggressive { keep_from_height, .. } => {
2025-11-09T23:19:32.3831861Z +                        crate::config::PruningMode::Aggressive {
2025-11-09T23:19:32.3832376Z +                            keep_from_height, ..
2025-11-09T23:19:32.3832811Z +                        } => {
2025-11-09T23:19:32.3833229Z                              // Prune up to keep_from_height
2025-11-09T23:19:32.3833710Z                              Some(*keep_from_height)
2025-11-09T23:19:32.3834135Z                          }
2025-11-09T23:19:32.3834960Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:228:
2025-11-09T23:19:32.3835785Z                              // Fall back to no pruning if feature is disabled
2025-11-09T23:19:32.3836310Z                              None
2025-11-09T23:19:32.3836688Z                          }
2025-11-09T23:19:32.3837251Z -                        crate::config::PruningMode::Custom { keep_bodies_from_height, .. } => {
2025-11-09T23:19:32.3837938Z +                        crate::config::PruningMode::Custom {
2025-11-09T23:19:32.3838449Z +                            keep_bodies_from_height,
2025-11-09T23:19:32.3839147Z +                            ..
2025-11-09T23:19:32.3839506Z +                        } => {
2025-11-09T23:19:32.3839930Z                              // Prune up to keep_bodies_from_height
2025-11-09T23:19:32.3840448Z                              Some(*keep_bodies_from_height)
2025-11-09T23:19:32.3840891Z                          }
2025-11-09T23:19:32.3841536Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:235:
2025-11-09T23:19:32.3842233Z                      };
2025-11-09T23:19:32.3842566Z -                    
2025-11-09T23:19:32.3842889Z +
2025-11-09T23:19:32.3843238Z                      if let Some(prune_to_height) = prune_height {
2025-11-09T23:19:32.3843785Z                          if prune_to_height < current_height {
2025-11-09T23:19:32.3844707Z -                            match pruning_manager.prune_to_height(prune_to_height, current_height, is_ibd) {
2025-11-09T23:19:32.3845538Z +                            match pruning_manager.prune_to_height(
2025-11-09T23:19:32.3846073Z +                                prune_to_height,
2025-11-09T23:19:32.3846547Z +                                current_height,
2025-11-09T23:19:32.3846980Z +                                is_ibd,
2025-11-09T23:19:32.3847396Z +                            ) {
2025-11-09T23:19:32.3847794Z                                  Ok(stats) => {
2025-11-09T23:19:32.3848420Z                                      info!("Startup pruning completed: {} blocks pruned, {} blocks kept", 
2025-11-09T23:19:32.3850597Z                                            stats.blocks_pruned, stats.blocks_kept);
2025-11-09T23:19:32.3851403Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:243:
2025-11-09T23:19:32.3852217Z                                      // Flush storage to persist pruning changes
2025-11-09T23:19:32.3852782Z                                      if let Err(e) = self.storage.flush() {
2025-11-09T23:19:32.3854573Z -                                        warn!("Failed to flush storage after startup pruning: {}", e);
2025-11-09T23:19:32.3855461Z +                                        warn!(
2025-11-09T23:19:32.3856035Z +                                            "Failed to flush storage after startup pruning: {}",
2025-11-09T23:19:32.3856599Z +                                            e
2025-11-09T23:19:32.3857029Z +                                        );
2025-11-09T23:19:32.3857452Z                                      }
2025-11-09T23:19:32.3857839Z                                  }
2025-11-09T23:19:32.3858243Z                                  Err(e) => {
2025-11-09T23:19:32.3860678Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:292:
2025-11-09T23:19:32.3861385Z      }
2025-11-09T23:19:32.3861661Z  
2025-11-09T23:19:32.3861996Z      /// Initialize peer connections automatically
2025-11-09T23:19:32.3862466Z -    /// 
2025-11-09T23:19:32.3862744Z +    ///
2025-11-09T23:19:32.3863272Z      /// Determines network type from protocol version and uses config if available.
2025-11-09T23:19:32.3864024Z      async fn initialize_peer_connections(&self) -> Result<()> {
2025-11-09T23:19:32.3864804Z          // Determine network type from protocol version
2025-11-09T23:19:32.3865559Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:306:
2025-11-09T23:19:32.3866317Z                  if let Some(ref config) = self.config {
2025-11-09T23:19:32.3866892Z                      if let Some(ref persistent_peers) = config.persistent_peers {
2025-11-09T23:19:32.3867464Z                          if !persistent_peers.is_empty() {
2025-11-09T23:19:32.3868180Z -                            if let Err(e) = self.network.connect_persistent_peers(persistent_peers).await {
2025-11-09T23:19:32.3868821Z +                            if let Err(e) = self
2025-11-09T23:19:32.3869253Z +                                .network
2025-11-09T23:19:32.3869752Z +                                .connect_persistent_peers(persistent_peers)
2025-11-09T23:19:32.3870480Z +                                .await
2025-11-09T23:19:32.3870883Z +                            {
2025-11-09T23:19:32.3871474Z                                  warn!("Failed to connect to some persistent peers: {}", e);
2025-11-09T23:19:32.3872009Z                              }
2025-11-09T23:19:32.3872354Z                          }
2025-11-09T23:19:32.3873011Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:315:
2025-11-09T23:19:32.3873731Z                  return Ok(());
2025-11-09T23:19:32.3874095Z              }
2025-11-09T23:19:32.3874587Z          };
2025-11-09T23:19:32.3874877Z -        
2025-11-09T23:19:32.3875168Z +
2025-11-09T23:19:32.3875535Z          // Get port from network address
2025-11-09T23:19:32.3876023Z          let port = self.network_addr.port();
2025-11-09T23:19:32.3876460Z -        
2025-11-09T23:19:32.3876735Z +
2025-11-09T23:19:32.3877230Z          // Default target peer count (Bitcoin Core uses 8-125, we'll use 8 as default)
2025-11-09T23:19:32.3877896Z          let target_peer_count = 8;
2025-11-09T23:19:32.3878301Z -        
2025-11-09T23:19:32.3878571Z +
2025-11-09T23:19:32.3878917Z          // Use config if available, otherwise use defaults
2025-11-09T23:19:32.3879433Z          let default_config = NodeConfig {
2025-11-09T23:19:32.3879890Z              listen_addr: Some(self.network_addr),
2025-11-09T23:19:32.3881119Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:328:
2025-11-09T23:19:32.3881869Z              ..Default::default()
2025-11-09T23:19:32.3882224Z          };
2025-11-09T23:19:32.3882643Z          let config = self.config.as_ref().unwrap_or(&default_config);
2025-11-09T23:19:32.3883245Z -        
2025-11-09T23:19:32.3883566Z +
2025-11-09T23:19:32.3883849Z          // Initialize peer connections
2025-11-09T23:19:32.3884501Z -        if let Err(e) = self.network.initialize_peer_connections(
2025-11-09T23:19:32.3884980Z -            config,
2025-11-09T23:19:32.3885283Z -            network,
2025-11-09T23:19:32.3885830Z -            port,
2025-11-09T23:19:32.3886177Z -            target_peer_count,
2025-11-09T23:19:32.3886545Z -        ).await {
2025-11-09T23:19:32.3886871Z +        if let Err(e) = self
2025-11-09T23:19:32.3887229Z +            .network
2025-11-09T23:19:32.3887768Z +            .initialize_peer_connections(config, network, port, target_peer_count)
2025-11-09T23:19:32.3888381Z +            .await
2025-11-09T23:19:32.3888678Z +        {
2025-11-09T23:19:32.3889066Z              warn!("Failed to initialize peer connections: {}", e);
2025-11-09T23:19:32.3889674Z              // Don't fail startup - peer connections are best-effort
2025-11-09T23:19:32.3890153Z          }
2025-11-09T23:19:32.3890733Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:342:
2025-11-09T23:19:32.3891427Z -        
2025-11-09T23:19:32.3891684Z +
2025-11-09T23:19:32.3891925Z          Ok(())
2025-11-09T23:19:32.3892200Z      }
2025-11-09T23:19:32.3892437Z  
2025-11-09T23:19:32.3892948Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:368:
2025-11-09T23:19:32.3893582Z                  ) {
2025-11-09T23:19:32.3893867Z                      Ok(true) => {
2025-11-09T23:19:32.3894503Z                          info!("Block accepted at height {}", current_height);
2025-11-09T23:19:32.3895033Z -                        
2025-11-09T23:19:32.3895362Z +
2025-11-09T23:19:32.3895729Z                          // Persist UTXO set to storage after block validation
2025-11-09T23:19:32.3896423Z                          // This is critical for commitment generation and incremental pruning
2025-11-09T23:19:32.3897158Z                          if let Err(e) = self.storage.utxos().store_utxo_set(&utxo_set) {
2025-11-09T23:19:32.3898000Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:375:
2025-11-09T23:19:32.3898915Z -                            warn!("Failed to persist UTXO set after block {}: {}", current_height, e);
2025-11-09T23:19:32.3899872Z +                            warn!(
2025-11-09T23:19:32.3900350Z +                                "Failed to persist UTXO set after block {}: {}",
2025-11-09T23:19:32.3900882Z +                                current_height, e
2025-11-09T23:19:32.3901496Z +                            );
2025-11-09T23:19:32.3901857Z                          }
2025-11-09T23:19:32.3902199Z -                        
2025-11-09T23:19:32.3902532Z +
2025-11-09T23:19:32.3902917Z                          // Generate UTXO commitment from current state (if enabled)
2025-11-09T23:19:32.3903641Z                          // Use current_height (the block that was just validated) before incrementing
2025-11-09T23:19:32.3904494Z                          #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.3905798Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:381:
2025-11-09T23:19:32.3906540Z                          {
2025-11-09T23:19:32.3907012Z                              if let Some(pruning_manager) = self.storage.pruning() {
2025-11-09T23:19:32.3907643Z -                                if let (Some(commitment_store), Some(_utxostore)) = 
2025-11-09T23:19:32.3908338Z -                                    (pruning_manager.commitment_store(), pruning_manager.utxostore()) 
2025-11-09T23:19:32.3908953Z -                                {
2025-11-09T23:19:32.3909450Z +                                if let (Some(commitment_store), Some(_utxostore)) = (
2025-11-09T23:19:32.3910003Z +                                    pruning_manager.commitment_store(),
2025-11-09T23:19:32.3910524Z +                                    pruning_manager.utxostore(),
2025-11-09T23:19:32.3910982Z +                                ) {
2025-11-09T23:19:32.3911533Z                                      // Get block hash from storage (block was just stored at current_height)
2025-11-09T23:19:32.3912198Z                                      let blocks_arc = self.storage.blocks();
2025-11-09T23:19:32.3913132Z -                                    if let Ok(Some(block_hash)) = blocks_arc.get_hash_by_height(current_height) {
2025-11-09T23:19:32.3913808Z +                                    if let Ok(Some(block_hash)) =
2025-11-09T23:19:32.3914508Z +                                        blocks_arc.get_hash_by_height(current_height)
2025-11-09T23:19:32.3914994Z +                                    {
2025-11-09T23:19:32.3915456Z                                          // Generate commitment from current UTXO set state
2025-11-09T23:19:32.3916117Z -                                        if let Err(e) = pruning_manager.generate_commitment_from_current_state(
2025-11-09T23:19:32.3916739Z -                                            &block_hash,
2025-11-09T23:19:32.3917205Z -                                            current_height,
2025-11-09T23:19:32.3917628Z -                                            &utxo_set,
2025-11-09T23:19:32.3918041Z -                                            &commitment_store,
2025-11-09T23:19:32.3918475Z -                                        ) {
2025-11-09T23:19:32.3919047Z -                                            warn!("Failed to generate commitment for block {}: {}", current_height, e);
2025-11-09T23:19:32.3919677Z +                                        if let Err(e) = pruning_manager
2025-11-09T23:19:32.3920180Z +                                            .generate_commitment_from_current_state(
2025-11-09T23:19:32.3920647Z +                                                &block_hash,
2025-11-09T23:19:32.3921076Z +                                                current_height,
2025-11-09T23:19:32.3921498Z +                                                &utxo_set,
2025-11-09T23:19:32.3921927Z +                                                &commitment_store,
2025-11-09T23:19:32.3922334Z +                                            )
2025-11-09T23:19:32.3922714Z +                                        {
2025-11-09T23:19:32.3923362Z +                                            warn!(
2025-11-09T23:19:32.3923884Z +                                                "Failed to generate commitment for block {}: {}",
2025-11-09T23:19:32.3924632Z +                                                current_height, e
2025-11-09T23:19:32.3925044Z +                                            );
2025-11-09T23:19:32.3925428Z                                          } else {
2025-11-09T23:19:32.3925964Z -                                            debug!("Generated UTXO commitment for block {}", current_height);
2025-11-09T23:19:32.3926526Z +                                            debug!(
2025-11-09T23:19:32.3926974Z +                                                "Generated UTXO commitment for block {}",
2025-11-09T23:19:32.3927438Z +                                                current_height
2025-11-09T23:19:32.3927857Z +                                            );
2025-11-09T23:19:32.3928276Z                                          }
2025-11-09T23:19:32.3930597Z                                      } else {
2025-11-09T23:19:32.3931228Z                                          warn!("Could not find block hash for height {} to generate commitment", current_height);
2025-11-09T23:19:32.3932203Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:403:
2025-11-09T23:19:32.3932941Z                                  }
2025-11-09T23:19:32.3933328Z                              }
2025-11-09T23:19:32.3933697Z                          }
2025-11-09T23:19:32.3934041Z -                        
2025-11-09T23:19:32.3934553Z +
2025-11-09T23:19:32.3934887Z                          // Increment height after processing
2025-11-09T23:19:32.3935380Z                          current_height += 1;
2025-11-09T23:19:32.3935762Z -                        
2025-11-09T23:19:32.3936066Z +
2025-11-09T23:19:32.3936365Z                          // Check for incremental pruning during IBD
2025-11-09T23:19:32.3937033Z                          // Consider IBD if we're still syncing (height < tip or no recent blocks)
2025-11-09T23:19:32.3938133Z                          let is_ibd = current_height < 1000; // Simple heuristic: consider IBD if < 1000 blocks
2025-11-09T23:19:32.3939117Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:413:
2025-11-09T23:19:32.3940031Z                          if let Some(pruning_manager) = self.storage.pruning() {
2025-11-09T23:19:32.3942646Z -                            if let Ok(Some(prune_stats)) = pruning_manager.incremental_prune_during_ibd(current_height, is_ibd) {
2025-11-09T23:19:32.3943563Z +                            if let Ok(Some(prune_stats)) =
2025-11-09T23:19:32.3944231Z +                                pruning_manager.incremental_prune_during_ibd(current_height, is_ibd)
2025-11-09T23:19:32.3945033Z +                            {
2025-11-09T23:19:32.3945630Z                                  info!("Incremental pruning during IBD: {} blocks pruned, {} bytes freed", 
2025-11-09T23:19:32.3946409Z                                        prune_stats.blocks_pruned, prune_stats.storage_freed);
2025-11-09T23:19:32.3947024Z                                  // Flush storage to persist pruning changes
2025-11-09T23:19:32.3947786Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:418:
2025-11-09T23:19:32.3948488Z                                  if let Err(e) = self.storage.flush() {
2025-11-09T23:19:32.3951134Z -                                    warn!("Failed to flush storage after incremental pruning: {}", e);
2025-11-09T23:19:32.3951726Z +                                    warn!(
2025-11-09T23:19:32.3952261Z +                                        "Failed to flush storage after incremental pruning: {}",
2025-11-09T23:19:32.3952809Z +                                        e
2025-11-09T23:19:32.3953217Z +                                    );
2025-11-09T23:19:32.3953598Z                                  }
2025-11-09T23:19:32.3953930Z                              }
2025-11-09T23:19:32.3954676Z                          }
2025-11-09T23:19:32.3955323Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:423:
2025-11-09T23:19:32.3956040Z -                        
2025-11-09T23:19:32.3956352Z +
2025-11-09T23:19:32.3956692Z                          // Check for automatic pruning after block acceptance
2025-11-09T23:19:32.3957274Z                          if let Some(pruning_manager) = self.storage.pruning() {
2025-11-09T23:19:32.3957859Z                              let stats = pruning_manager.get_stats();
2025-11-09T23:19:32.3958563Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:427:
2025-11-09T23:19:32.3960784Z -                            let should_prune = pruning_manager.should_auto_prune(
2025-11-09T23:19:32.3961292Z -                                current_height,
2025-11-09T23:19:32.3961711Z -                                stats.last_prune_height,
2025-11-09T23:19:32.3962139Z -                            );
2025-11-09T23:19:32.3962519Z -                            
2025-11-09T23:19:32.3962902Z +                            let should_prune = pruning_manager
2025-11-09T23:19:32.3963451Z +                                .should_auto_prune(current_height, stats.last_prune_height);
2025-11-09T23:19:32.3963949Z +
2025-11-09T23:19:32.3964216Z                              if should_prune {
2025-11-09T23:19:32.3964950Z                                  info!("Automatic pruning triggered at height {}", current_height);
2025-11-09T23:19:32.3965503Z -                                
2025-11-09T23:19:32.3965825Z +
2025-11-09T23:19:32.3966149Z                                  // Calculate prune height based on configuration
2025-11-09T23:19:32.3966705Z                                  let prune_height = match &pruning_manager.config.mode {
2025-11-09T23:19:32.3967285Z                                      crate::config::PruningMode::Disabled => None,
2025-11-09T23:19:32.3968745Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:438:
2025-11-09T23:19:32.3970293Z -                                    crate::config::PruningMode::Normal { keep_from_height, .. } => {
2025-11-09T23:19:32.3970920Z +                                    crate::config::PruningMode::Normal {
2025-11-09T23:19:32.3971383Z +                                        keep_from_height, ..
2025-11-09T23:19:32.3971791Z +                                    } => {
2025-11-09T23:19:32.3972275Z                                          // Prune to keep_from_height, but ensure we keep min_blocks
2025-11-09T23:19:32.3972975Z                                          let min_keep = pruning_manager.config.min_blocks_to_keep;
2025-11-09T23:19:32.3973813Z -                                        let effective_keep = (*keep_from_height).max(current_height.saturating_sub(min_keep));
2025-11-09T23:19:32.3974765Z +                                        let effective_keep = (*keep_from_height)
2025-11-09T23:19:32.3975382Z +                                            .max(current_height.saturating_sub(min_keep));
2025-11-09T23:19:32.3975888Z                                          Some(effective_keep)
2025-11-09T23:19:32.3976329Z                                      }
2025-11-09T23:19:32.3976746Z                                      #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.3977476Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:445:
2025-11-09T23:19:32.3978467Z -                                    crate::config::PruningMode::Aggressive { keep_from_height, min_blocks, .. } => {
2025-11-09T23:19:32.3979214Z +                                    crate::config::PruningMode::Aggressive {
2025-11-09T23:19:32.3979742Z +                                        keep_from_height,
2025-11-09T23:19:32.3980198Z +                                        min_blocks,
2025-11-09T23:19:32.3980634Z +                                        ..
2025-11-09T23:19:32.3981058Z +                                    } => {
2025-11-09T23:19:32.3981854Z                                          // Prune to keep_from_height, respecting min_blocks
2025-11-09T23:19:32.3982676Z -                                        let effective_keep = (*keep_from_height).max(current_height.saturating_sub(*min_blocks));
2025-11-09T23:19:32.3983444Z +                                        let effective_keep = (*keep_from_height)
2025-11-09T23:19:32.3984025Z +                                            .max(current_height.saturating_sub(*min_blocks));
2025-11-09T23:19:32.3984713Z                                          Some(effective_keep)
2025-11-09T23:19:32.3985114Z                                      }
2025-11-09T23:19:32.3985527Z                                      #[cfg(not(feature = "utxo-commitments"))]
2025-11-09T23:19:32.3986240Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:453:
2025-11-09T23:19:32.3987049Z                                          // Fall back to no pruning if feature is disabled
2025-11-09T23:19:32.3987586Z                                          None
2025-11-09T23:19:32.3988012Z                                      }
2025-11-09T23:19:32.3988618Z -                                    crate::config::PruningMode::Custom { keep_bodies_from_height, .. } => {
2025-11-09T23:19:32.3989298Z +                                    crate::config::PruningMode::Custom {
2025-11-09T23:19:32.3989819Z +                                        keep_bodies_from_height,
2025-11-09T23:19:32.3990278Z +                                        ..
2025-11-09T23:19:32.3990677Z +                                    } => {
2025-11-09T23:19:32.3991184Z                                          // Prune to keep_bodies_from_height, respecting min_blocks
2025-11-09T23:19:32.3992418Z                                          let min_keep = pruning_manager.config.min_blocks_to_keep;
2025-11-09T23:19:32.3993333Z -                                        let effective_keep = (*keep_bodies_from_height).max(current_height.saturating_sub(min_keep));
2025-11-09T23:19:32.3994605Z +                                        let effective_keep = (*keep_bodies_from_height)
2025-11-09T23:19:32.3995234Z +                                            .max(current_height.saturating_sub(min_keep));
2025-11-09T23:19:32.3995778Z                                          Some(effective_keep)
2025-11-09T23:19:32.3996220Z                                      }
2025-11-09T23:19:32.3996596Z                                  };
2025-11-09T23:19:32.3997270Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:463:
2025-11-09T23:19:32.3997976Z -                                
2025-11-09T23:19:32.3999924Z +
2025-11-09T23:19:32.4000277Z                                  if let Some(prune_to_height) = prune_height {
2025-11-09T23:19:32.4000902Z                                      if prune_to_height < current_height {
2025-11-09T23:19:32.4001870Z -                                        match pruning_manager.prune_to_height(prune_to_height, current_height, false) {
2025-11-09T23:19:32.4002626Z +                                        match pruning_manager.prune_to_height(
2025-11-09T23:19:32.4003119Z +                                            prune_to_height,
2025-11-09T23:19:32.4003598Z +                                            current_height,
2025-11-09T23:19:32.4004033Z +                                            false,
2025-11-09T23:19:32.4004670Z +                                        ) {
2025-11-09T23:19:32.4005088Z                                              Ok(prune_stats) => {
2025-11-09T23:19:32.4005749Z                                                  info!("Automatic pruning completed: {} blocks pruned, {} blocks kept", 
2025-11-09T23:19:32.4006503Z                                                        prune_stats.blocks_pruned, prune_stats.blocks_kept);
2025-11-09T23:19:32.4008703Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:596:
2025-11-09T23:19:32.4009720Z      /// Get health report
2025-11-09T23:19:32.4010199Z      pub fn health_check(&self) -> health::HealthReport {
2025-11-09T23:19:32.4010740Z          use crate::node::health::HealthChecker;
2025-11-09T23:19:32.4011184Z -        
2025-11-09T23:19:32.4011447Z +
2025-11-09T23:19:32.4011770Z          let checker = HealthChecker::new();
2025-11-09T23:19:32.4012301Z          let network_healthy = self.network.is_network_active();
2025-11-09T23:19:32.4013024Z          let storage_healthy = self.storage.check_storage_bounds().unwrap_or(false);
2025-11-09T23:19:32.4013925Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:603:
2025-11-09T23:19:32.4014969Z          let rpc_healthy = true; // RPC is always healthy if node is running
2025-11-09T23:19:32.4015496Z -        
2025-11-09T23:19:32.4015745Z +
2025-11-09T23:19:32.4016056Z          // Get metrics if available (simplified for now)
2025-11-09T23:19:32.4016502Z          checker.check_health(
2025-11-09T23:19:32.4016856Z              network_healthy,
2025-11-09T23:19:32.4017518Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/performance.rs:2:
2025-11-09T23:19:32.4018219Z  //!
2025-11-09T23:19:32.4019236Z  //! Provides performance tracking, profiling hooks, and performance metrics collection.
2025-11-09T23:19:32.4019877Z  
2025-11-09T23:19:32.4020166Z +use serde::{Deserialize, Serialize};
2025-11-09T23:19:32.4020556Z  use std::sync::Arc;
2025-11-09T23:19:32.4020863Z  use std::sync::Mutex;
2025-11-09T23:19:32.4022621Z  use std::time::{Duration, Instant};
2025-11-09T23:19:32.4023399Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/performance.rs:8:
2025-11-09T23:19:32.4024196Z -use serde::{Deserialize, Serialize};
2025-11-09T23:19:32.4024782Z  
2025-11-09T23:19:32.4025171Z  /// Performance profiler for tracking operation timings
2025-11-09T23:19:32.4036156Z  pub struct PerformanceProfiler {
2025-11-09T23:19:32.4036958Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/performance.rs:87:
2025-11-09T23:19:32.4038029Z          let total: Duration = times.iter().sum();
2025-11-09T23:19:32.4038546Z          let count = times.len();
2025-11-09T23:19:32.4038984Z          let avg = total / count as u32;
2025-11-09T23:19:32.4039400Z -        
2025-11-09T23:19:32.4039680Z +
2025-11-09T23:19:32.4039984Z          let mut sorted = times.to_vec();
2025-11-09T23:19:32.4040442Z          sorted.sort();
2025-11-09T23:19:32.4040779Z -        
2025-11-09T23:19:32.4042744Z +
2025-11-09T23:19:32.4043052Z          let p50 = sorted[count / 2];
2025-11-09T23:19:32.4043522Z          let p95 = sorted[(count * 95) / 100];
2025-11-09T23:19:32.4043998Z          let p99 = sorted[(count * 99) / 100];
2025-11-09T23:19:32.4044997Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/performance.rs:166:
2025-11-09T23:19:32.4045837Z      /// Stop the timer and record the duration
2025-11-09T23:19:32.4046326Z      pub fn stop(self) -> Duration {
2025-11-09T23:19:32.4046813Z          let duration = self.start.elapsed();
2025-11-09T23:19:32.4047242Z -        
2025-11-09T23:19:32.4047368Z +
2025-11-09T23:19:32.4047526Z          match self.operation_type {
2025-11-09T23:19:32.4047720Z              OperationType::BlockProcessing => {
2025-11-09T23:19:32.4047947Z                  self.profiler.record_block_processing(duration);
2025-11-09T23:19:32.4048454Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/performance.rs:181:
2025-11-09T23:19:32.4048681Z                  self.profiler.record_network_operation(duration);
2025-11-09T23:19:32.4048795Z              }
2025-11-09T23:19:32.4048921Z          }
2025-11-09T23:19:32.4049037Z -        
2025-11-09T23:19:32.4049150Z +
2025-11-09T23:19:32.4049280Z          duration
2025-11-09T23:19:32.4049394Z      }
2025-11-09T23:19:32.4049505Z  }
2025-11-09T23:19:32.4049982Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/performance.rs:191:
2025-11-09T23:19:32.4050158Z          Self::new(1000) // Keep last 1000 samples
2025-11-09T23:19:32.4050493Z      }
2025-11-09T23:19:32.4051087Z  }
2025-11-09T23:19:32.4051228Z -
2025-11-09T23:19:32.4051339Z  
2025-11-09T23:19:32.4051800Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/sync.rs:188:
2025-11-09T23:19:32.4051978Z          metrics: Option<Arc<MetricsCollector>>,
2025-11-09T23:19:32.4052184Z          profiler: Option<Arc<PerformanceProfiler>>,
2025-11-09T23:19:32.4052318Z      ) -> Result<bool> {
2025-11-09T23:19:32.4052501Z -        let _timer = profiler.as_ref().map(|p| {
2025-11-09T23:19:32.4052879Z -            PerformanceTimer::start(Arc::clone(p), OperationType::BlockProcessing)
2025-11-09T23:19:32.4053000Z -        });
2025-11-09T23:19:32.4053145Z +        let _timer = profiler
2025-11-09T23:19:32.4053265Z +            .as_ref()
2025-11-09T23:19:32.4053654Z +            .map(|p| PerformanceTimer::start(Arc::clone(p), OperationType::BlockProcessing));
2025-11-09T23:19:32.4053804Z          let start_time = Instant::now();
2025-11-09T23:19:32.4053919Z  
2025-11-09T23:19:32.4054155Z          // Parse block from wire format (extracts witness data)
2025-11-09T23:19:32.4054802Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/sync.rs:231:
2025-11-09T23:19:32.4054981Z                  metrics.update_performance(|m| {
2025-11-09T23:19:32.4055218Z                      let time_ms = processing_time.as_secs_f64() * 1000.0;
2025-11-09T23:19:32.4055530Z                      // Update average block processing time (exponential moving average)
2025-11-09T23:19:32.4055706Z -                    m.avg_block_processing_time_ms = 
2025-11-09T23:19:32.4055869Z +                    m.avg_block_processing_time_ms =
2025-11-09T23:19:32.4056114Z                          (m.avg_block_processing_time_ms * 0.9) + (time_ms * 0.1);
2025-11-09T23:19:32.4056266Z                      // Update blocks per second
2025-11-09T23:19:32.4056444Z                      if processing_time.as_secs_f64() > 0.0 {
2025-11-09T23:19:32.4058938Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/sync.rs:240:
2025-11-09T23:19:32.4059068Z                  });
2025-11-09T23:19:32.4059179Z              }
2025-11-09T23:19:32.4059292Z  
2025-11-09T23:19:32.4059731Z -            info!("Block validated and stored at height {} (took {:?})", current_height, processing_time);
2025-11-09T23:19:32.4059851Z +            info!(
2025-11-09T23:19:32.4060162Z +                "Block validated and stored at height {} (took {:?})",
2025-11-09T23:19:32.4060349Z +                current_height, processing_time
2025-11-09T23:19:32.4060469Z +            );
2025-11-09T23:19:32.4060587Z              Ok(true)
2025-11-09T23:19:32.4060701Z          } else {
2025-11-09T23:19:32.4060982Z              error!("Block validation failed at height {}", current_height);
2025-11-09T23:19:32.4061416Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:85:
2025-11-09T23:19:32.4061636Z          let elapsed = now.saturating_sub(self.last_refill);
2025-11-09T23:19:32.4061793Z          if elapsed > 0 {
2025-11-09T23:19:32.4062075Z              let tokens_to_add = (elapsed as u32).saturating_mul(self.rate);
2025-11-09T23:19:32.4062438Z -            self.tokens = self.tokens.saturating_add(tokens_to_add).min(self.burst_limit);
2025-11-09T23:19:32.4062580Z +            self.tokens = self
2025-11-09T23:19:32.4062695Z +                .tokens
2025-11-09T23:19:32.4062853Z +                .saturating_add(tokens_to_add)
2025-11-09T23:19:32.4062993Z +                .min(self.burst_limit);
2025-11-09T23:19:32.4063127Z              self.last_refill = now;
2025-11-09T23:19:32.4063231Z          }
2025-11-09T23:19:32.4063331Z  
2025-11-09T23:19:32.4063839Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:134:
2025-11-09T23:19:32.4063961Z      }
2025-11-09T23:19:32.4064072Z  
2025-11-09T23:19:32.4064234Z      /// Create with custom rate limits
2025-11-09T23:19:32.4064548Z -    pub fn with_rate_limits(
2025-11-09T23:19:32.4064919Z -        auth_required: bool,
2025-11-09T23:19:32.4065077Z -        default_burst: u32,
2025-11-09T23:19:32.4065220Z -        default_rate: u32,
2025-11-09T23:19:32.4065344Z -    ) -> Self {
2025-11-09T23:19:32.4065780Z +    pub fn with_rate_limits(auth_required: bool, default_burst: u32, default_rate: u32) -> Self {
2025-11-09T23:19:32.4065900Z          Self {
2025-11-09T23:19:32.4066134Z              valid_tokens: Arc::new(Mutex::new(HashMap::new())),
2025-11-09T23:19:32.4066397Z              valid_certificates: Arc::new(Mutex::new(HashMap::new())),
2025-11-09T23:19:32.4066841Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:154:
2025-11-09T23:19:32.4067092Z          let user_id = UserId::Token(AuthToken::new(token.clone()));
2025-11-09T23:19:32.4067292Z          let mut tokens = self.valid_tokens.lock().await;
2025-11-09T23:19:32.4067462Z          tokens.insert(token, user_id.clone());
2025-11-09T23:19:32.4067591Z -        
2025-11-09T23:19:32.4067720Z +
2025-11-09T23:19:32.4067886Z          // Initialize rate limiter for this user
2025-11-09T23:19:32.4068174Z          let (burst, rate) = self.get_rate_limit_for_user(&user_id).await;
2025-11-09T23:19:32.4068389Z          let mut limiters = self.rate_limiters.lock().await;
2025-11-09T23:19:32.4068814Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:161:
2025-11-09T23:19:32.4070806Z          limiters.insert(user_id, RpcRateLimiter::new(burst, rate));
2025-11-09T23:19:32.4071425Z -        
2025-11-09T23:19:32.4071535Z +
2025-11-09T23:19:32.4071643Z          Ok(())
2025-11-09T23:19:32.4071753Z      }
2025-11-09T23:19:32.4071865Z  
2025-11-09T23:19:32.4072309Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:178:
2025-11-09T23:19:32.4072570Z          let user_id = UserId::Certificate(fingerprint.clone());
2025-11-09T23:19:32.4072800Z          let mut certs = self.valid_certificates.lock().await;
2025-11-09T23:19:32.4073003Z          certs.insert(fingerprint, user_id.clone());
2025-11-09T23:19:32.4073119Z -        
2025-11-09T23:19:32.4073472Z +
2025-11-09T23:19:32.4073664Z          // Initialize rate limiter for this user
2025-11-09T23:19:32.4073929Z          let (burst, rate) = self.get_rate_limit_for_user(&user_id).await;
2025-11-09T23:19:32.4074147Z          let mut limiters = self.rate_limiters.lock().await;
2025-11-09T23:19:32.4074774Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:185:
2025-11-09T23:19:32.4075071Z          limiters.insert(user_id, RpcRateLimiter::new(burst, rate));
2025-11-09T23:19:32.4075202Z -        
2025-11-09T23:19:32.4075320Z +
2025-11-09T23:19:32.4075437Z          Ok(())
2025-11-09T23:19:32.4075558Z      }
2025-11-09T23:19:32.4075681Z  
2025-11-09T23:19:32.4076118Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:201:
2025-11-09T23:19:32.4076466Z      pub async fn set_user_rate_limit(&self, user_id: &UserId, burst: u32, rate: u32) {
2025-11-09T23:19:32.4076713Z          let mut limits = self.user_rate_limits.lock().await;
2025-11-09T23:19:32.4076923Z          limits.insert(user_id.clone(), (burst, rate));
2025-11-09T23:19:32.4077038Z -        
2025-11-09T23:19:32.4077150Z +
2025-11-09T23:19:32.4077340Z          // Update existing rate limiter if present
2025-11-09T23:19:32.4077554Z          let mut limiters = self.rate_limiters.lock().await;
2025-11-09T23:19:32.4077760Z          if let Some(limiter) = limiters.get_mut(user_id) {
2025-11-09T23:19:32.4078212Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:212:
2025-11-09T23:19:32.4078465Z      /// Get rate limit for a user (checks per-user limits first)
2025-11-09T23:19:32.4078778Z      async fn get_rate_limit_for_user(&self, user_id: &UserId) -> (u32, u32) {
2025-11-09T23:19:32.4080904Z          let limits = self.user_rate_limits.lock().await;
2025-11-09T23:19:32.4081188Z -        limits.get(user_id).copied().unwrap_or(self.default_rate_limit)
2025-11-09T23:19:32.4081523Z +        limits
2025-11-09T23:19:32.4081662Z +            .get(user_id)
2025-11-09T23:19:32.4081788Z +            .copied()
2025-11-09T23:19:32.4081942Z +            .unwrap_or(self.default_rate_limit)
2025-11-09T23:19:32.4082044Z      }
2025-11-09T23:19:32.4082151Z  
2025-11-09T23:19:32.4082317Z      /// Authenticate a request from HTTP headers
2025-11-09T23:19:32.4082718Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:283:
2025-11-09T23:19:32.4082863Z      /// Check rate limit for a user
2025-11-09T23:19:32.4083132Z      pub async fn check_rate_limit(&self, user_id: &UserId) -> bool {
2025-11-09T23:19:32.4083345Z          let mut limiters = self.rate_limiters.lock().await;
2025-11-09T23:19:32.4083457Z -        
2025-11-09T23:19:32.4083569Z +
2025-11-09T23:19:32.4083741Z          // Get or create rate limiter for this user
2025-11-09T23:19:32.4084008Z          let limiter = limiters.entry(user_id.clone()).or_insert_with(|| {
2025-11-09T23:19:32.4084189Z              let (burst, rate) = self.default_rate_limit;
2025-11-09T23:19:32.4084888Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:290:
2025-11-09T23:19:32.4085057Z              RpcRateLimiter::new(burst, rate)
2025-11-09T23:19:32.4085168Z          });
2025-11-09T23:19:32.4085293Z -        
2025-11-09T23:19:32.4085403Z +
2025-11-09T23:19:32.4085549Z          limiter.check_and_consume()
2025-11-09T23:19:32.4085669Z      }
2025-11-09T23:19:32.4085776Z  
2025-11-09T23:19:32.4086212Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:311:
2025-11-09T23:19:32.4086470Z          auth.add_token("test-token-123".to_string()).await.unwrap();
2025-11-09T23:19:32.4086595Z  
2025-11-09T23:19:32.4086785Z          let mut headers = hyper::HeaderMap::new();
2025-11-09T23:19:32.4086914Z -        headers.insert(
2025-11-09T23:19:32.4087049Z -            "authorization",
2025-11-09T23:19:32.4087774Z -            "***".parse().unwrap(),
2025-11-09T23:19:32.4087902Z -        );
2025-11-09T23:19:32.4088591Z +        headers.insert("authorization", "***".parse().unwrap());
2025-11-09T23:19:32.4088708Z  
2025-11-09T23:19:32.4088939Z          let addr: SocketAddr = "127.0.0.1:8080".parse().unwrap();
2025-11-09T23:19:32.4089203Z          let result = auth.authenticate_request(&headers, addr).await;
2025-11-09T23:19:32.4089636Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:329:
2025-11-09T23:19:32.4089870Z          auth.add_token("valid-token".to_string()).await.unwrap();
2025-11-09T23:19:32.4089986Z  
2025-11-09T23:19:32.4090167Z          let mut headers = hyper::HeaderMap::new();
2025-11-09T23:19:32.4090296Z -        headers.insert(
2025-11-09T23:19:32.4090425Z -            "authorization",
2025-11-09T23:19:32.4090648Z -            "***".parse().unwrap(),
2025-11-09T23:19:32.4090763Z -        );
2025-11-09T23:19:32.4091136Z +        headers.insert("authorization", "***".parse().unwrap());
2025-11-09T23:19:32.4091248Z  
2025-11-09T23:19:32.4091485Z          let addr: SocketAddr = "127.0.0.1:8080".parse().unwrap();
2025-11-09T23:19:32.4091751Z          let result = auth.authenticate_request(&headers, addr).await;
2025-11-09T23:19:32.4092180Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:368:
2025-11-09T23:19:32.4092331Z          assert!(result.error.is_none());
2025-11-09T23:19:32.4092437Z      }
2025-11-09T23:19:32.4092550Z  }
2025-11-09T23:19:32.4092655Z -
2025-11-09T23:19:32.4092758Z  
2025-11-09T23:19:32.4170489Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:30:
2025-11-09T23:19:32.4170646Z  
2025-11-09T23:19:32.4170798Z      /// Create with dependencies
2025-11-09T23:19:32.4171065Z      pub fn with_dependencies(storage: Arc<Storage>) -> Self {
2025-11-09T23:19:32.4171226Z -        Self { storage: Some(storage) }
2025-11-09T23:19:32.4171339Z +        Self {
2025-11-09T23:19:32.4171495Z +            storage: Some(storage),
2025-11-09T23:19:32.4171870Z +        }
2025-11-09T23:19:32.4171986Z      }
2025-11-09T23:19:32.4172098Z  
2025-11-09T23:19:32.4172368Z      /// Calculate difficulty from bits (compact target format)
2025-11-09T23:19:32.4172848Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:39:
2025-11-09T23:19:32.4173335Z          // MAX_TARGET for Bitcoin mainnet is 0x00000000FFFF0000000000000000000000000000000000000000000000000000
2025-11-09T23:19:32.4173638Z          // But we use a simpler calculation: difficulty = 2^256 / (target + 1)
2025-11-09T23:19:32.4173926Z          // For display purposes, we normalize to genesis difficulty = 1.0
2025-11-09T23:19:32.4174557Z -        const MAX_TARGET: u128 = 0x00000000FFFF0000000000000000000000000000000000000000000000000000u128;
2025-11-09T23:19:32.4174689Z -        
2025-11-09T23:19:32.4174838Z +        const MAX_TARGET: u128 =
2025-11-09T23:19:32.4175175Z +            0x00000000FFFF0000000000000000000000000000000000000000000000000000u128;
2025-11-09T23:19:32.4175298Z +
2025-11-09T23:19:32.4175484Z          // Simplified difficulty calculation
2025-11-09T23:19:32.4175772Z          // For display purposes, use a simple approximation based on bits
2025-11-09T23:19:32.4175950Z          if let Ok(_target) = expand_target(bits) {
2025-11-09T23:19:32.4176432Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:73:
2025-11-09T23:19:32.4176638Z      fn calculate_block_subsidy(height: u64) -> u64 {
2025-11-09T23:19:32.4176912Z          const INITIAL_SUBSIDY: u64 = 50_000_000_000; // 50 BTC in satoshis
2025-11-09T23:19:32.4177082Z          const HALVING_INTERVAL: u64 = 210_000;
2025-11-09T23:19:32.4177198Z -        
2025-11-09T23:19:32.4177310Z +
2025-11-09T23:19:32.4177537Z          let halvings = height / HALVING_INTERVAL;
2025-11-09T23:19:32.4177661Z -        
2025-11-09T23:19:32.4177774Z +
2025-11-09T23:19:32.4177964Z          // Subsidy halves each halving, but can't go below 0
2025-11-09T23:19:32.4178103Z          if halvings >= 64 {
2025-11-09T23:19:32.4178531Z              // After 64 halvings, subsidy is 0 (satoshi precision limit)
2025-11-09T23:19:32.4178974Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:82:
2025-11-09T23:19:32.4179093Z              return 0;
2025-11-09T23:19:32.4179197Z          }
2025-11-09T23:19:32.4179299Z -        
2025-11-09T23:19:32.4179401Z +
2025-11-09T23:19:32.4179542Z          INITIAL_SUBSIDY >> halvings
2025-11-09T23:19:32.4179653Z      }
2025-11-09T23:19:32.4179758Z  
2025-11-09T23:19:32.4180205Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:88:
2025-11-09T23:19:32.4180451Z      /// Calculate hash_serialized_2 for UTXO set (double SHA256)
2025-11-09T23:19:32.4180556Z -    /// 
2025-11-09T23:19:32.4180666Z +    ///
2025-11-09T23:19:32.4181003Z      /// Serializes UTXO set deterministically and computes double SHA256 hash.
2025-11-09T23:19:32.4181329Z      /// Matches Bitcoin Core's gettxoutsetinfo hash_serialized_2 calculation.
2025-11-09T23:19:32.4181699Z      fn calculate_utxo_set_hash(utxo_set: &bllvm_protocol::UtxoSet) -> [u8; 32] {
2025-11-09T23:19:32.4182129Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:93:
2025-11-09T23:19:32.4182269Z -        use sha2::{Sha256, Digest};
2025-11-09T23:19:32.4182456Z          use crate::storage::hashing::double_sha256;
2025-11-09T23:19:32.4182574Z -        
2025-11-09T23:19:32.4182717Z +        use sha2::{Digest, Sha256};
2025-11-09T23:19:32.4182825Z +
2025-11-09T23:19:32.4183162Z          // Sort UTXOs for deterministic hashing (by outpoint: hash first, then index)
2025-11-09T23:19:32.4183383Z          let mut entries: Vec<_> = utxo_set.iter().collect();
2025-11-09T23:19:32.4183540Z -        entries.sort_by(|(a, _), (b, _)| {
2025-11-09T23:19:32.4183697Z -            match a.hash.cmp(&b.hash) {
2025-11-09T23:19:32.4183927Z -                std::cmp::Ordering::Equal => a.index.cmp(&b.index),
2025-11-09T23:19:32.4184572Z -                other => other,
2025-11-09T23:19:32.4184701Z -            }
2025-11-09T23:19:32.4184974Z +        entries.sort_by(|(a, _), (b, _)| match a.hash.cmp(&b.hash) {
2025-11-09T23:19:32.4185214Z +            std::cmp::Ordering::Equal => a.index.cmp(&b.index),
2025-11-09T23:19:32.4185349Z +            other => other,
2025-11-09T23:19:32.4185464Z          });
2025-11-09T23:19:32.4185593Z -        
2025-11-09T23:19:32.4185709Z +
2025-11-09T23:19:32.4185865Z          // Serialize each UTXO entry
2025-11-09T23:19:32.4186030Z          let mut serialized = Vec::new();
2025-11-09T23:19:32.4186202Z          for (outpoint, utxo) in entries {
2025-11-09T23:19:32.4186685Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:108:
2025-11-09T23:19:32.4186973Z              // Serialize outpoint (32-byte hash + 8-byte index, little-endian)
2025-11-09T23:19:32.4187207Z              serialized.extend_from_slice(&outpoint.hash);
2025-11-09T23:19:32.4187494Z              serialized.extend_from_slice(&outpoint.index.to_le_bytes());
2025-11-09T23:19:32.4187626Z -            
2025-11-09T23:19:32.4187738Z +
2025-11-09T23:19:32.4188078Z              // Serialize UTXO (8-byte value + script_pubkey + 8-byte height, little-endian)
2025-11-09T23:19:32.4188330Z              serialized.extend_from_slice(&utxo.value.to_le_bytes());
2025-11-09T23:19:32.4188563Z              serialized.extend_from_slice(&utxo.script_pubkey);
2025-11-09T23:19:32.4189035Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:115:
2025-11-09T23:19:32.4189308Z              serialized.extend_from_slice(&utxo.height.to_le_bytes());
2025-11-09T23:19:32.4189434Z          }
2025-11-09T23:19:32.4189546Z -        
2025-11-09T23:19:32.4189648Z +
2025-11-09T23:19:32.4189779Z          // Double SHA256 hash
2025-11-09T23:19:32.4189937Z          double_sha256(&serialized)
2025-11-09T23:19:32.4190046Z      }
2025-11-09T23:19:32.4190520Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:121:
2025-11-09T23:19:32.4190652Z -    
2025-11-09T23:19:32.4190994Z +
2025-11-09T23:19:32.4191179Z      /// Calculate confirmations for a block
2025-11-09T23:19:32.4191520Z      fn calculate_confirmations(block_height: u64, tip_height: u64) -> i64 {
2025-11-09T23:19:32.4191683Z          if block_height > tip_height {
2025-11-09T23:19:32.4192153Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:222:
2025-11-09T23:19:32.4192274Z              }))
2025-11-09T23:19:32.4192397Z          } else {
2025-11-09T23:19:32.4192730Z              // Graceful degradation: return default values when storage unavailable
2025-11-09T23:19:32.4193230Z -            tracing::debug!("getblockchaininfo called but storage not available, returning default values");
2025-11-09T23:19:32.4193377Z +            tracing::debug!(
2025-11-09T23:19:32.4193768Z +                "getblockchaininfo called but storage not available, returning default values"
2025-11-09T23:19:32.4193890Z +            );
2025-11-09T23:19:32.4194014Z              Ok(json!({
2025-11-09T23:19:32.4194167Z                  "chain": "main",
2025-11-09T23:19:32.4194471Z                  "blocks": 0,
2025-11-09T23:19:32.4194947Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:311:
2025-11-09T23:19:32.4195205Z          debug!("RPC: getblockheader {} verbose={}", hash, verbose);
2025-11-09T23:19:32.4195317Z  
2025-11-09T23:19:32.4195489Z          if let Some(ref storage) = self.storage {
2025-11-09T23:19:32.4195669Z -            let hash_bytes = hex::decode(hash)
2025-11-09T23:19:32.4195899Z -                .map_err(|e| anyhow::anyhow!("Invalid hash: {}", e))?;
2025-11-09T23:19:32.4196033Z +            let hash_bytes =
2025-11-09T23:19:32.4196337Z +                hex::decode(hash).map_err(|e| anyhow::anyhow!("Invalid hash: {}", e))?;
2025-11-09T23:19:32.4196490Z              if hash_bytes.len() != 32 {
2025-11-09T23:19:32.4196709Z                  return Err(anyhow::anyhow!("Invalid hash length"));
2025-11-09T23:19:32.4197745Z              }
2025-11-09T23:19:32.4198229Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:319:
2025-11-09T23:19:32.4198382Z              let mut hash_array = [0u8; 32];
2025-11-09T23:19:32.4198554Z              hash_array.copy_from_slice(&hash_bytes);
2025-11-09T23:19:32.4198672Z -            
2025-11-09T23:19:32.4198781Z +
2025-11-09T23:19:32.4199047Z              if let Ok(Some(header)) = storage.blocks().get_header(&hash_array) {
2025-11-09T23:19:32.4199179Z                  if verbose {
2025-11-09T23:19:32.4199381Z                      // Find block height by searching height index
2025-11-09T23:19:32.4199833Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:360:
2025-11-09T23:19:32.4199943Z  
2025-11-09T23:19:32.4200097Z                      // Find next block hash
2025-11-09T23:19:32.4200300Z                      let next_blockhash = block_height.and_then(|h| {
2025-11-09T23:19:32.4200449Z -                        storage.blocks()
2025-11-09T23:19:32.4200578Z +                        storage
2025-11-09T23:19:32.4200713Z +                            .blocks()
2025-11-09T23:19:32.4200862Z                              .get_hash_by_height(h + 1)
2025-11-09T23:19:32.4200990Z                              .ok()
2025-11-09T23:19:32.4201328Z                              .flatten()
2025-11-09T23:19:32.4201794Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:380:
2025-11-09T23:19:32.4201918Z                          }
2025-11-09T23:19:32.4202571Z                          Self::format_chainwork(total_work)
2025-11-09T23:19:32.4202696Z                      } else {
2025-11-09T23:19:32.4203033Z -                        "0000000000000000000000000000000000000000000000000000000000000000".to_string()
2025-11-09T23:19:32.4203305Z +                        "0000000000000000000000000000000000000000000000000000000000000000"
2025-11-09T23:19:32.4203459Z +                            .to_string()
2025-11-09T23:19:32.4203799Z                      };
2025-11-09T23:19:32.4203913Z  
2025-11-09T23:19:32.4204044Z                      Ok(json!({
2025-11-09T23:19:32.4204715Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:443:
2025-11-09T23:19:32.4204945Z              if let Ok(Some(hash)) = storage.chain().get_tip_hash() {
2025-11-09T23:19:32.4205105Z                  Ok(json!(hex::encode(hash)))
2025-11-09T23:19:32.4205211Z              } else {
2025-11-09T23:19:32.4205519Z -                Ok(json!("0000000000000000000000000000000000000000000000000000000000000000"))
2025-11-09T23:19:32.4205650Z +                Ok(json!(
2025-11-09T23:19:32.4205919Z +                    "0000000000000000000000000000000000000000000000000000000000000000"
2025-11-09T23:19:32.4206022Z +                ))
2025-11-09T23:19:32.4206126Z              }
2025-11-09T23:19:32.4206240Z          } else {
2025-11-09T23:19:32.4206533Z -            Ok(json!("0000000000000000000000000000000000000000000000000000000000000000"))
2025-11-09T23:19:32.4206649Z +            Ok(json!(
2025-11-09T23:19:32.4206902Z +                "0000000000000000000000000000000000000000000000000000000000000000"
2025-11-09T23:19:32.4207003Z +            ))
2025-11-09T23:19:32.4207103Z          }
2025-11-09T23:19:32.4207202Z      }
2025-11-09T23:19:32.4207306Z  
2025-11-09T23:19:32.4207737Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:494:
2025-11-09T23:19:32.4207918Z              let utxos = storage.utxos().get_all_utxos()?;
2025-11-09T23:19:32.4208056Z              let txouts = utxos.len();
2025-11-09T23:19:32.4208346Z              let total_amount: u64 = utxos.values().map(|utxo| utxo.value as u64).sum();
2025-11-09T23:19:32.4208447Z -            
2025-11-09T23:19:32.4208544Z +
2025-11-09T23:19:32.4208955Z              // Calculate hash_serialized_2 (double SHA256 of serialized UTXO set)
2025-11-09T23:19:32.4209464Z              let hash_serialized_2 = Self::calculate_utxo_set_hash(&utxos);
2025-11-09T23:19:32.4209583Z  
2025-11-09T23:19:32.4210072Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:540:
2025-11-09T23:19:32.4210419Z              // Use protocol engine which provides the correct validate_block signature
2025-11-09T23:19:32.4210734Z              let engine = BitcoinProtocolEngine::new(ProtocolVersion::Regtest)
2025-11-09T23:19:32.4211065Z                  .map_err(|e| anyhow::anyhow!("Failed to create protocol engine: {}", e))?;
2025-11-09T23:19:32.4211181Z -            
2025-11-09T23:19:32.4211295Z +
2025-11-09T23:19:32.4211485Z              let check_level = checklevel.unwrap_or(3);
2025-11-09T23:19:32.4211664Z              let num_blocks = numblocks.unwrap_or(288);
2025-11-09T23:19:32.4211776Z -            
2025-11-09T23:19:32.4211888Z +
2025-11-09T23:19:32.4212147Z              let tip_height = storage.chain().get_height()?.unwrap_or(0);
2025-11-09T23:19:32.4212286Z              if tip_height == 0 {
2025-11-09T23:19:32.4212490Z                  return Ok(json!(true)); // Empty chain is valid
2025-11-09T23:19:32.4212963Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:557:
2025-11-09T23:19:32.4213078Z              };
2025-11-09T23:19:32.4213185Z  
2025-11-09T23:19:32.4213345Z              let mut errors = Vec::new();
2025-11-09T23:19:32.4213564Z -            let mut utxo_set = storage.utxos().get_all_utxos()
2025-11-09T23:19:32.4213707Z +            let mut utxo_set = storage
2025-11-09T23:19:32.4213833Z +                .utxos()
2025-11-09T23:19:32.4213973Z +                .get_all_utxos()
2025-11-09T23:19:32.4214238Z                  .map_err(|e| anyhow::anyhow!("Failed to get UTXO set: {}", e))?;
2025-11-09T23:19:32.4214535Z  
2025-11-09T23:19:32.4214721Z              // Verify blocks from start_height to tip
2025-11-09T23:19:32.4215216Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:572:
2025-11-09T23:19:32.4215382Z                                  // For now, just continue
2025-11-09T23:19:32.4215750Z                              }
2025-11-09T23:19:32.4216035Z                              Ok(bllvm_protocol::ValidationResult::Invalid(reason)) => {
2025-11-09T23:19:32.4216357Z -                                errors.push(format!("Block at height {} invalid: {}", height, reason));
2025-11-09T23:19:32.4216516Z +                                errors.push(format!(
2025-11-09T23:19:32.4216708Z +                                    "Block at height {} invalid: {}",
2025-11-09T23:19:32.4216859Z +                                    height, reason
2025-11-09T23:19:32.4216982Z +                                ));
2025-11-09T23:19:32.4217135Z                                  if check_level >= 4 {
2025-11-09T23:19:32.4217315Z                                      // Level 4: Stop on first error
2025-11-09T23:19:32.4217451Z                                      break;
2025-11-09T23:19:32.4217936Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:579:
2025-11-09T23:19:32.4218084Z                                  }
2025-11-09T23:19:32.4218210Z                              }
2025-11-09T23:19:32.4218348Z                              Err(e) => {
2025-11-09T23:19:32.4220551Z -                                errors.push(format!("Block at height {} validation error: {}", height, e));
2025-11-09T23:19:32.4220705Z +                                errors.push(format!(
2025-11-09T23:19:32.4220893Z +                                    "Block at height {} validation error: {}",
2025-11-09T23:19:32.4221046Z +                                    height, e
2025-11-09T23:19:32.4221175Z +                                ));
2025-11-09T23:19:32.4221326Z                                  if check_level >= 4 {
2025-11-09T23:19:32.4221461Z                                      break;
2025-11-09T23:19:32.4221595Z                                  }
2025-11-09T23:19:32.4222068Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:588:
2025-11-09T23:19:32.4222434Z  
2025-11-09T23:19:32.4222654Z                          // Check level 3: Verify block header linkage
2025-11-09T23:19:32.4222825Z                          if check_level >= 3 && height > 0 {
2025-11-09T23:19:32.4223166Z -                            if let Ok(Some(prev_hash)) = storage.blocks().get_hash_by_height(height - 1) {
2025-11-09T23:19:32.4223328Z +                            if let Ok(Some(prev_hash)) =
2025-11-09T23:19:32.4223552Z +                                storage.blocks().get_hash_by_height(height - 1)
2025-11-09T23:19:32.4223671Z +                            {
2025-11-09T23:19:32.4223873Z                                  if block.header.prev_block_hash != prev_hash {
2025-11-09T23:19:32.4224032Z                                      errors.push(format!(
2025-11-09T23:19:32.4224485Z                                          "Block at height {} has incorrect prev_block_hash: expected {}, got {}",
2025-11-09T23:19:32.4224964Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:606:
2025-11-09T23:19:32.4225134Z                          // Check level 2: Verify merkle root
2025-11-09T23:19:32.4225277Z                          if check_level >= 2 {
2025-11-09T23:19:32.4225511Z                              use bllvm_protocol::mining::calculate_merkle_root;
2025-11-09T23:19:32.4225831Z -                            if let Ok(calculated_root) = calculate_merkle_root(&block.transactions) {
2025-11-09T23:19:32.4226143Z +                            if let Ok(calculated_root) = calculate_merkle_root(&block.transactions)
2025-11-09T23:19:32.4226264Z +                            {
2025-11-09T23:19:32.4226492Z                                  if calculated_root != block.header.merkle_root {
2025-11-09T23:19:32.4226649Z                                      errors.push(format!(
2025-11-09T23:19:32.4226855Z                                          "Block at height {} has incorrect merkle root",
2025-11-09T23:19:32.4227516Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:657:
2025-11-09T23:19:32.4227702Z          if let Some(ref storage) = self.storage {
2025-11-09T23:19:32.4227865Z              // Get all chain tips (including forks)
2025-11-09T23:19:32.4228014Z              let mut tips = Vec::new();
2025-11-09T23:19:32.4228134Z -            
2025-11-09T23:19:32.4228241Z +
2025-11-09T23:19:32.4230222Z              // Add active tip
2025-11-09T23:19:32.4230460Z              if let Ok(Some(tip_hash)) = storage.chain().get_tip_hash() {
2025-11-09T23:19:32.4230724Z                  let tip_height = storage.chain().get_height()?.unwrap_or(0);
2025-11-09T23:19:32.4231200Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:668:
2025-11-09T23:19:32.4231342Z                      "status": "active"
2025-11-09T23:19:32.4231468Z                  }));
2025-11-09T23:19:32.4231585Z              }
2025-11-09T23:19:32.4231705Z -            
2025-11-09T23:19:32.4231827Z +
2025-11-09T23:19:32.4232002Z              // Add other tracked tips (forks, etc.)
2025-11-09T23:19:32.4232240Z              if let Ok(chain_tips) = storage.chain().get_chain_tips() {
2025-11-09T23:19:32.4232449Z                  for (hash, height, branchlen, status) in chain_tips {
2025-11-09T23:19:32.4232902Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:678:
2025-11-09T23:19:32.4233031Z                              continue;
2025-11-09T23:19:32.4233149Z                          }
2025-11-09T23:19:32.4233275Z                      }
2025-11-09T23:19:32.4233391Z -                    
2025-11-09T23:19:32.4233500Z +
2025-11-09T23:19:32.4233642Z                      tips.push(json!({
2025-11-09T23:19:32.4233797Z                          "height": height,
2025-11-09T23:19:32.4233958Z                          "hash": hex::encode(hash),
2025-11-09T23:19:32.4234575Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:687:
2025-11-09T23:19:32.4235036Z                      }));
2025-11-09T23:19:32.4235155Z                  }
2025-11-09T23:19:32.4235268Z              }
2025-11-09T23:19:32.4235396Z -            
2025-11-09T23:19:32.4235508Z +
2025-11-09T23:19:32.4235644Z              Ok(json!(tips))
2025-11-09T23:19:32.4235763Z          } else {
2025-11-09T23:19:32.4235900Z              Ok(json!([]))
2025-11-09T23:19:32.4236379Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:700:
2025-11-09T23:19:32.4236707Z      pub async fn get_chain_tx_stats(&self, params: &Value) -> Result<Value> {
2025-11-09T23:19:32.4236881Z          debug!("RPC: getchaintxstats");
2025-11-09T23:19:32.4236997Z  
2025-11-09T23:19:32.4237139Z -        let nblocks = params
2025-11-09T23:19:32.4237258Z -            .get(0)
2025-11-09T23:19:32.4237414Z -            .and_then(|p| p.as_u64())
2025-11-09T23:19:32.4237669Z -            .unwrap_or(144); // Default: 1 day (144 blocks at 10 min/block)
2025-11-09T23:19:32.4238172Z +        let nblocks = params.get(0).and_then(|p| p.as_u64()).unwrap_or(144); // Default: 1 day (144 blocks at 10 min/block)
2025-11-09T23:19:32.4238292Z  
2025-11-09T23:19:32.4238492Z          if let Some(ref storage) = self.storage {
2025-11-09T23:19:32.4238784Z              let tip_height = storage.chain().get_height()?.unwrap_or(0);
2025-11-09T23:19:32.4239264Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:710:
2025-11-09T23:19:32.4239388Z -            
2025-11-09T23:19:32.4239500Z +
2025-11-09T23:19:32.4239637Z              if tip_height == 0 {
2025-11-09T23:19:32.4239778Z                  return Ok(json!({
2025-11-09T23:19:32.4239906Z                      "time": 0,
2025-11-09T23:19:32.4240374Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:729:
2025-11-09T23:19:32.4240559Z              // Get timestamps and transaction counts
2025-11-09T23:19:32.4240737Z              let mut timestamps = Vec::new();
2025-11-09T23:19:32.4241146Z              let mut tx_counts = Vec::new();
2025-11-09T23:19:32.4241285Z -            
2025-11-09T23:19:32.4241404Z +
2025-11-09T23:19:32.4241598Z              for height in start_height..=tip_height {
2025-11-09T23:19:32.4241891Z                  if let Ok(Some(hash)) = storage.blocks().get_hash_by_height(height) {
2025-11-09T23:19:32.4242141Z                      if let Ok(Some(block)) = storage.blocks().get_block(&hash) {
2025-11-09T23:19:32.4242623Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:756:
2025-11-09T23:19:32.4242953Z              let window_interval = last_timestamp.saturating_sub(first_timestamp);
2025-11-09T23:19:32.4243174Z              let window_tx_count: u64 = tx_counts.iter().sum();
2025-11-09T23:19:32.4243382Z              let window_block_count = timestamps.len() as u64;
2025-11-09T23:19:32.4243491Z -            
2025-11-09T23:19:32.4243595Z +
2025-11-09T23:19:32.4243768Z              let txrate = if window_interval > 0 {
2025-11-09T23:19:32.4243969Z                  window_tx_count as f64 / window_interval as f64
2025-11-09T23:19:32.4244083Z              } else {
2025-11-09T23:19:32.4244770Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:794:
2025-11-09T23:19:32.4245075Z      pub async fn get_block_stats(&self, params: &Value) -> Result<Value> {
2025-11-09T23:19:32.4245226Z          debug!("RPC: getblockstats");
2025-11-09T23:19:32.4245332Z  
2025-11-09T23:19:32.4245553Z -        let hash_or_height: Option<String> = params.get(0)
2025-11-09T23:19:32.4245733Z +        let hash_or_height: Option<String> = params
2025-11-09T23:19:32.4245845Z +            .get(0)
2025-11-09T23:19:32.4245990Z              .and_then(|p| p.as_str())
2025-11-09T23:19:32.4246130Z              .map(|s| s.to_string())
2025-11-09T23:19:32.4246256Z              .or_else(|| {
2025-11-09T23:19:32.4246747Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:801:
2025-11-09T23:19:32.4247138Z -                params.get(0)
2025-11-09T23:19:32.4247268Z +                params
2025-11-09T23:19:32.4247392Z +                    .get(0)
2025-11-09T23:19:32.4247563Z                      .and_then(|p| p.as_u64())
2025-11-09T23:19:32.4247712Z                      .map(|h| h.to_string())
2025-11-09T23:19:32.4247829Z              });
2025-11-09T23:19:32.4248325Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:808:
2025-11-09T23:19:32.4248545Z              let block_hash = if let Some(hoh) = hash_or_height {
2025-11-09T23:19:32.4250517Z                  // Try to parse as height first
2025-11-09T23:19:32.4250715Z                  if let Ok(height) = hoh.parse::<u64>() {
2025-11-09T23:19:32.4250918Z -                    storage.blocks().get_hash_by_height(height)?
2025-11-09T23:19:32.4251040Z +                    storage
2025-11-09T23:19:32.4251164Z +                        .blocks()
2025-11-09T23:19:32.4251337Z +                        .get_hash_by_height(height)?
2025-11-09T23:19:32.4251660Z                          .ok_or_else(|| anyhow::anyhow!("Block at height {} not found", height))?
2025-11-09T23:19:32.4251786Z                  } else {
2025-11-09T23:19:32.4251933Z                      // Parse as hash
2025-11-09T23:19:32.4252392Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:823:
2025-11-09T23:19:32.4252501Z                  }
2025-11-09T23:19:32.4252612Z              } else {
2025-11-09T23:19:32.4252746Z                  // Default to tip
2025-11-09T23:19:32.4252895Z -                storage.chain().get_tip_hash()?
2025-11-09T23:19:32.4253006Z +                storage
2025-11-09T23:19:32.4253126Z +                    .chain()
2025-11-09T23:19:32.4253248Z +                    .get_tip_hash()?
2025-11-09T23:19:32.4253481Z                      .ok_or_else(|| anyhow::anyhow!("Chain not initialized"))?
2025-11-09T23:19:32.4253603Z              };
2025-11-09T23:19:32.4253728Z  
2025-11-09T23:19:32.4254624Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:831:
2025-11-09T23:19:32.4254860Z                  let tx_count = block.transactions.len();
2025-11-09T23:19:32.4255113Z                  let block_size = bincode::serialize(&block)?.len();
2025-11-09T23:19:32.4255477Z                  let block_weight = block_size; // Simplified - would calculate weight properly
2025-11-09T23:19:32.4255590Z -                
2025-11-09T23:19:32.4255704Z +
2025-11-09T23:19:32.4255837Z                  // Get block height
2025-11-09T23:19:32.4256118Z -                let height = storage.blocks().get_height_by_hash(&block_hash)?
2025-11-09T23:19:32.4256257Z +                let height = storage
2025-11-09T23:19:32.4256390Z +                    .blocks()
2025-11-09T23:19:32.4256546Z +                    .get_height_by_hash(&block_hash)?
2025-11-09T23:19:32.4256669Z                      .unwrap_or(0);
2025-11-09T23:19:32.4256779Z -                
2025-11-09T23:19:32.4256891Z +
2025-11-09T23:19:32.4257045Z                  // Count inputs and outputs
2025-11-09T23:19:32.4257279Z -                let input_count: usize = block.transactions.iter()
2025-11-09T23:19:32.4257432Z -                    .map(|tx| tx.inputs.len())
2025-11-09T23:19:32.4257554Z -                    .sum();
2025-11-09T23:19:32.4257778Z -                let output_count: usize = block.transactions.iter()
2025-11-09T23:19:32.4257940Z -                    .map(|tx| tx.outputs.len())
2025-11-09T23:19:32.4258061Z -                    .sum();
2025-11-09T23:19:32.4258165Z -                
2025-11-09T23:19:32.4258524Z +                let input_count: usize = block.transactions.iter().map(|tx| tx.inputs.len()).sum();
2025-11-09T23:19:32.4258669Z +                let output_count: usize =
2025-11-09T23:19:32.4260790Z +                    block.transactions.iter().map(|tx| tx.outputs.len()).sum();
2025-11-09T23:19:32.4260896Z +
2025-11-09T23:19:32.4261038Z                  // Sum output values
2025-11-09T23:19:32.4261464Z -                let total_out: u64 = block.transactions.iter()
2025-11-09T23:19:32.4261596Z +                let total_out: u64 = block
2025-11-09T23:19:32.4261723Z +                    .transactions
2025-11-09T23:19:32.4261832Z +                    .iter()
2025-11-09T23:19:32.4261980Z                      .flat_map(|tx| tx.outputs.iter())
2025-11-09T23:19:32.4262122Z                      .map(|out| out.value as u64)
2025-11-09T23:19:32.4262245Z                      .sum::<u64>();
2025-11-09T23:19:32.4262717Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:852:
2025-11-09T23:19:32.4262831Z -                
2025-11-09T23:19:32.4262946Z +
2025-11-09T23:19:32.4263088Z                  // Calculate block subsidy
2025-11-09T23:19:32.4263319Z                  let subsidy = Self::calculate_block_subsidy(height);
2025-11-09T23:19:32.4263435Z -                
2025-11-09T23:19:32.4263537Z +
2025-11-09T23:19:32.4263906Z                  // Calculate total fees (simplified - would need UTXO set for accurate calculation)
2025-11-09T23:19:32.4264198Z                  // For now, estimate: total_out - (subsidy * 100_000_000) if coinbase exists
2025-11-09T23:19:32.4264588Z                  let total_fees = if !block.transactions.is_empty() {
2025-11-09T23:19:32.4265013Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:859:
2025-11-09T23:19:32.4265157Z                      // Coinbase is first transaction
2025-11-09T23:19:32.4265430Z -                    let coinbase_outputs: u64 = block.transactions[0].outputs.iter()
2025-11-09T23:19:32.4265618Z +                    let coinbase_outputs: u64 = block.transactions[0]
2025-11-09T23:19:32.4265744Z +                        .outputs
2025-11-09T23:19:32.4265871Z +                        .iter()
2025-11-09T23:19:32.4266022Z                          .map(|out| out.value as u64)
2025-11-09T23:19:32.4266143Z                          .sum();
2025-11-09T23:19:32.4266427Z                      // Fee = total outputs - (coinbase outputs which include subsidy)
2025-11-09T23:19:32.4267052Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:903:
2025-11-09T23:19:32.4267161Z              }
2025-11-09T23:19:32.4267262Z          } else {
2025-11-09T23:19:32.4267592Z              // Graceful degradation: return informative error instead of failing silently
2025-11-09T23:19:32.4268017Z -            Err(anyhow::anyhow!("Storage not available. This operation requires storage to be initialized."))
2025-11-09T23:19:32.4268145Z +            Err(anyhow::anyhow!(
2025-11-09T23:19:32.4268461Z +                "Storage not available. This operation requires storage to be initialized."
2025-11-09T23:19:32.4268561Z +            ))
2025-11-09T23:19:32.4268662Z          }
2025-11-09T23:19:32.4268759Z      }
2025-11-09T23:19:32.4268863Z  
2025-11-09T23:19:32.4269292Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:913:
2025-11-09T23:19:32.4269622Z      pub async fn prune_blockchain(&self, params: &Value) -> Result<Value> {
2025-11-09T23:19:32.4269801Z          debug!("RPC: pruneblockchain");
2025-11-09T23:19:32.4269913Z  
2025-11-09T23:19:32.4270063Z -        let height = params.get(0)
2025-11-09T23:19:32.4270208Z +        let height = params
2025-11-09T23:19:32.4270328Z +            .get(0)
2025-11-09T23:19:32.4270476Z              .and_then(|p| p.as_u64())
2025-11-09T23:19:32.4270737Z              .ok_or_else(|| anyhow::anyhow!("Height parameter required"))?;
2025-11-09T23:19:32.4270849Z  
2025-11-09T23:19:32.4271284Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:920:
2025-11-09T23:19:32.4271464Z          if let Some(ref storage) = self.storage {
2025-11-09T23:19:32.4271709Z              let tip_height = storage.chain().get_height()?.unwrap_or(0);
2025-11-09T23:19:32.4271817Z -            
2025-11-09T23:19:32.4271917Z +
2025-11-09T23:19:32.4272175Z              // Check if IBD is in progress (height == 0 indicates no blocks synced)
2025-11-09T23:19:32.4272566Z              let is_ibd = tip_height == 0;
2025-11-09T23:19:32.4272682Z -            
2025-11-09T23:19:32.4272794Z +
2025-11-09T23:19:32.4272944Z              if height >= tip_height {
2025-11-09T23:19:32.4273409Z -                return Err(anyhow::anyhow!("Cannot prune to height >= tip height ({} >= {})", height, tip_height));
2025-11-09T23:19:32.4273569Z +                return Err(anyhow::anyhow!(
2025-11-09T23:19:32.4273792Z +                    "Cannot prune to height >= tip height ({} >= {})",
2025-11-09T23:19:32.4273916Z +                    height,
2025-11-09T23:19:32.4274042Z +                    tip_height
2025-11-09T23:19:32.4274155Z +                ));
2025-11-09T23:19:32.4274280Z              }
2025-11-09T23:19:32.4274564Z  
2025-11-09T23:19:32.4274709Z              // Get pruning manager
2025-11-09T23:19:32.4275186Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:931:
2025-11-09T23:19:32.4275417Z              if let Some(pruning_manager) = storage.pruning() {
2025-11-09T23:19:32.4275559Z                  // Perform pruning
2025-11-09T23:19:32.4275881Z                  let stats = pruning_manager.prune_to_height(height, tip_height, is_ibd)?;
2025-11-09T23:19:32.4276006Z -                
2025-11-09T23:19:32.4276118Z +
2025-11-09T23:19:32.4276288Z                  // Flush storage to persist changes
2025-11-09T23:19:32.4276440Z                  storage.flush()?;
2025-11-09T23:19:32.4276558Z -                
2025-11-09T23:19:32.4276666Z +
2025-11-09T23:19:32.4276791Z                  Ok(json!({
2025-11-09T23:19:32.4276954Z                      "pruned_height": height,
2025-11-09T23:19:32.4277119Z                      "blocks_pruned": stats.blocks_pruned,
2025-11-09T23:19:32.4277579Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:943:
2025-11-09T23:19:32.4277775Z                      "storage_freed_bytes": stats.storage_freed,
2025-11-09T23:19:32.4277902Z                  }))
2025-11-09T23:19:32.4278225Z              } else {
2025-11-09T23:19:32.4278655Z -                Err(anyhow::anyhow!("Pruning is not enabled. Configure pruning in node configuration."))
2025-11-09T23:19:32.4278801Z +                Err(anyhow::anyhow!(
2025-11-09T23:19:32.4279082Z +                    "Pruning is not enabled. Configure pruning in node configuration."
2025-11-09T23:19:32.4279192Z +                ))
2025-11-09T23:19:32.4279315Z              }
2025-11-09T23:19:32.4279432Z          } else {
2025-11-09T23:19:32.4279772Z              // Graceful degradation: return informative error instead of failing silently
2025-11-09T23:19:32.4280233Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:950:
2025-11-09T23:19:32.4280703Z -            Err(anyhow::anyhow!("Storage not available. This operation requires storage to be initialized."))
2025-11-09T23:19:32.4282816Z +            Err(anyhow::anyhow!(
2025-11-09T23:19:32.4283194Z +                "Storage not available. This operation requires storage to be initialized."
2025-11-09T23:19:32.4283311Z +            ))
2025-11-09T23:19:32.4283422Z          }
2025-11-09T23:19:32.4283528Z      }
2025-11-09T23:19:32.4283644Z  
2025-11-09T23:19:32.4284093Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:960:
2025-11-09T23:19:32.4284264Z          if let Some(ref storage) = self.storage {
2025-11-09T23:19:32.4284754Z              let tip_height = storage.chain().get_height()?.unwrap_or(0);
2025-11-09T23:19:32.4284972Z              let is_pruning_enabled = storage.is_pruning_enabled();
2025-11-09T23:19:32.4285085Z -            
2025-11-09T23:19:32.4285192Z +
2025-11-09T23:19:32.4285400Z              if let Some(pruning_manager) = storage.pruning() {
2025-11-09T23:19:32.4285576Z                  let stats = pruning_manager.get_stats();
2025-11-09T23:19:32.4285744Z                  let config = &pruning_manager.config;
2025-11-09T23:19:32.4286410Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:967:
2025-11-09T23:19:32.4286515Z -                
2025-11-09T23:19:32.4286620Z +
2025-11-09T23:19:32.4286778Z                  // Determine pruning mode
2025-11-09T23:19:32.4286942Z                  let mode_str = match &config.mode {
2025-11-09T23:19:32.4287164Z                      crate::config::PruningMode::Disabled => "disabled",
2025-11-09T23:19:32.4287575Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:975:
2025-11-09T23:19:32.4287817Z                      _ => "unknown", // Fallback for Aggressive if feature not enabled
2025-11-09T23:19:32.4288029Z                      crate::config::PruningMode::Custom { .. } => "custom",
2025-11-09T23:19:32.4288134Z                  };
2025-11-09T23:19:32.4288241Z -                
2025-11-09T23:19:32.4288340Z +
2025-11-09T23:19:32.4288458Z                  Ok(json!({
2025-11-09T23:19:32.4288679Z                      "pruning_enabled": is_pruning_enabled,
2025-11-09T23:19:32.4288828Z                      "mode": mode_str,
2025-11-09T23:19:32.4289822Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1013:
2025-11-09T23:19:32.4290155Z      pub async fn invalidate_block(&self, params: &Value) -> Result<Value> {
2025-11-09T23:19:32.4290333Z          debug!("RPC: invalidateblock");
2025-11-09T23:19:32.4290447Z  
2025-11-09T23:19:32.4292453Z -        let blockhash = params.get(0)
2025-11-09T23:19:32.4292588Z +        let blockhash = params
2025-11-09T23:19:32.4292692Z +            .get(0)
2025-11-09T23:19:32.4292822Z              .and_then(|p| p.as_str())
2025-11-09T23:19:32.4293075Z              .ok_or_else(|| anyhow::anyhow!("Block hash parameter required"))?;
2025-11-09T23:19:32.4293184Z  
2025-11-09T23:19:32.4293610Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1020:
2025-11-09T23:19:32.4293768Z -        let hash_bytes = hex::decode(blockhash)
2025-11-09T23:19:32.4294232Z -            .map_err(|e| anyhow::anyhow!("Invalid block hash: {}", e))?;
2025-11-09T23:19:32.4294563Z +        let hash_bytes =
2025-11-09T23:19:32.4294913Z +            hex::decode(blockhash).map_err(|e| anyhow::anyhow!("Invalid block hash: {}", e))?;
2025-11-09T23:19:32.4295048Z          if hash_bytes.len() != 32 {
2025-11-09T23:19:32.4295282Z              return Err(anyhow::anyhow!("Block hash must be 32 bytes"));
2025-11-09T23:19:32.4295383Z          }
2025-11-09T23:19:32.4295810Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1028:
2025-11-09T23:19:32.4295974Z          if let Some(ref storage) = self.storage {
2025-11-09T23:19:32.4296102Z              // Mark block as invalid
2025-11-09T23:19:32.4296245Z              storage.chain().mark_invalid(&hash)?;
2025-11-09T23:19:32.4296352Z -            
2025-11-09T23:19:32.4296449Z +
2025-11-09T23:19:32.4296740Z              // Check if this is the current tip - if so, we'd need to trigger a reorg
2025-11-09T23:19:32.4297079Z              // For now, we just mark it as invalid and let the node handle it on next block
2025-11-09T23:19:32.4297325Z              if let Ok(Some(tip_hash)) = storage.chain().get_tip_hash() {
2025-11-09T23:19:32.4297787Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1040:
2025-11-09T23:19:32.4297921Z              Ok(json!(null))
2025-11-09T23:19:32.4298044Z          } else {
2025-11-09T23:19:32.4298395Z              // Graceful degradation: return informative error instead of failing silently
2025-11-09T23:19:32.4300504Z -            Err(anyhow::anyhow!("Storage not available. This operation requires storage to be initialized."))
2025-11-09T23:19:32.4300651Z +            Err(anyhow::anyhow!(
2025-11-09T23:19:32.4300990Z +                "Storage not available. This operation requires storage to be initialized."
2025-11-09T23:19:32.4301315Z +            ))
2025-11-09T23:19:32.4301432Z          }
2025-11-09T23:19:32.4301794Z      }
2025-11-09T23:19:32.4301905Z  
2025-11-09T23:19:32.4302381Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1050:
2025-11-09T23:19:32.4302712Z      pub async fn reconsider_block(&self, params: &Value) -> Result<Value> {
2025-11-09T23:19:32.4302896Z          debug!("RPC: reconsiderblock");
2025-11-09T23:19:32.4303016Z  
2025-11-09T23:19:32.4303181Z -        let blockhash = params.get(0)
2025-11-09T23:19:32.4303321Z +        let blockhash = params
2025-11-09T23:19:32.4303436Z +            .get(0)
2025-11-09T23:19:32.4303589Z              .and_then(|p| p.as_str())
2025-11-09T23:19:32.4303866Z              .ok_or_else(|| anyhow::anyhow!("Block hash parameter required"))?;
2025-11-09T23:19:32.4303978Z  
2025-11-09T23:19:32.4304630Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1057:
2025-11-09T23:19:32.4304818Z -        let hash_bytes = hex::decode(blockhash)
2025-11-09T23:19:32.4305061Z -            .map_err(|e| anyhow::anyhow!("Invalid block hash: {}", e))?;
2025-11-09T23:19:32.4305204Z +        let hash_bytes =
2025-11-09T23:19:32.4305568Z +            hex::decode(blockhash).map_err(|e| anyhow::anyhow!("Invalid block hash: {}", e))?;
2025-11-09T23:19:32.4305710Z          if hash_bytes.len() != 32 {
2025-11-09T23:19:32.4317257Z              return Err(anyhow::anyhow!("Block hash must be 32 bytes"));
2025-11-09T23:19:32.4317400Z          }
2025-11-09T23:19:32.4317874Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1065:
2025-11-09T23:19:32.4318050Z          if let Some(ref storage) = self.storage {
2025-11-09T23:19:32.4318196Z              // Remove from invalid blocks set
2025-11-09T23:19:32.4318378Z              storage.chain().unmark_invalid(&hash)?;
2025-11-09T23:19:32.4318504Z -            
2025-11-09T23:19:32.4318621Z +
2025-11-09T23:19:32.4318929Z              // If this block is now valid, it may be reconsidered for chain inclusion
2025-11-09T23:19:32.4319143Z              // The node will handle this on next block processing
2025-11-09T23:19:32.4319256Z  
2025-11-09T23:19:32.4319925Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1072:
2025-11-09T23:19:32.4320055Z              Ok(json!(null))
2025-11-09T23:19:32.4320170Z          } else {
2025-11-09T23:19:32.4320505Z              // Graceful degradation: return informative error instead of failing silently
2025-11-09T23:19:32.4320986Z -            Err(anyhow::anyhow!("Storage not available. This operation requires storage to be initialized."))
2025-11-09T23:19:32.4321131Z +            Err(anyhow::anyhow!(
2025-11-09T23:19:32.4321460Z +                "Storage not available. This operation requires storage to be initialized."
2025-11-09T23:19:32.4321564Z +            ))
2025-11-09T23:19:32.4321666Z          }
2025-11-09T23:19:32.4321774Z      }
2025-11-09T23:19:32.4321874Z  
2025-11-09T23:19:32.4322316Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1079:
2025-11-09T23:19:32.4322455Z      /// Wait for new block
2025-11-09T23:19:32.4322565Z      ///
2025-11-09T23:19:32.4322852Z      /// Params: ["timeout"] (optional, timeout in seconds, default: no timeout)
2025-11-09T23:19:32.4322953Z -    /// 
2025-11-09T23:19:32.4323060Z +    ///
2025-11-09T23:19:32.4323355Z      /// Note: Full implementation requires async notification infrastructure.
2025-11-09T23:19:32.4323655Z      /// Currently returns current tip immediately. Future enhancement will:
2025-11-09T23:19:32.4323833Z      /// 1. Subscribe to block notifications
2025-11-09T23:19:32.4324491Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1088:
2025-11-09T23:19:32.4324819Z      pub async fn wait_for_new_block(&self, params: &Value) -> Result<Value> {
2025-11-09T23:19:32.4324987Z          debug!("RPC: waitfornewblock");
2025-11-09T23:19:32.4325096Z  
2025-11-09T23:19:32.4325250Z -        let _timeout = params.get(0)
2025-11-09T23:19:32.4325654Z +        let _timeout = params
2025-11-09T23:19:32.4325784Z +            .get(0)
2025-11-09T23:19:32.4325944Z              .and_then(|p| p.as_u64())
2025-11-09T23:19:32.4326159Z              .map(|t| tokio::time::Duration::from_secs(t));
2025-11-09T23:19:32.4326282Z  
2025-11-09T23:19:32.4326753Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1104:
2025-11-09T23:19:32.4326872Z              }
2025-11-09T23:19:32.4326986Z          } else {
2025-11-09T23:19:32.4327355Z              // Graceful degradation: return informative error instead of failing silently
2025-11-09T23:19:32.4327830Z -            Err(anyhow::anyhow!("Storage not available. This operation requires storage to be initialized."))
2025-11-09T23:19:32.4329986Z +            Err(anyhow::anyhow!(
2025-11-09T23:19:32.4330348Z +                "Storage not available. This operation requires storage to be initialized."
2025-11-09T23:19:32.4330467Z +            ))
2025-11-09T23:19:32.4330576Z          }
2025-11-09T23:19:32.4330707Z      }
2025-11-09T23:19:32.4330818Z  
2025-11-09T23:19:32.4331301Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1111:
2025-11-09T23:19:32.4331452Z      /// Wait for specific block
2025-11-09T23:19:32.4331571Z      ///
2025-11-09T23:19:32.4331840Z      /// Params: ["blockhash", "timeout"] (block hash, optional timeout)
2025-11-09T23:19:32.4331956Z -    /// 
2025-11-09T23:19:32.4332071Z +    ///
2025-11-09T23:19:32.4332386Z      /// Note: Full implementation requires async notification infrastructure.
2025-11-09T23:19:32.4332704Z      /// Currently checks if block exists immediately. Future enhancement will:
2025-11-09T23:19:32.4332870Z      /// 1. Subscribe to block notifications
2025-11-09T23:19:32.4333342Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1120:
2025-11-09T23:19:32.4333643Z      pub async fn wait_for_block(&self, params: &Value) -> Result<Value> {
2025-11-09T23:19:32.4333799Z          debug!("RPC: waitforblock");
2025-11-09T23:19:32.4333934Z  
2025-11-09T23:19:32.4334560Z -        let blockhash = params.get(0)
2025-11-09T23:19:32.4334736Z +        let blockhash = params
2025-11-09T23:19:32.4334863Z +            .get(0)
2025-11-09T23:19:32.4335017Z              .and_then(|p| p.as_str())
2025-11-09T23:19:32.4335318Z              .ok_or_else(|| anyhow::anyhow!("Block hash parameter required"))?;
2025-11-09T23:19:32.4335430Z  
2025-11-09T23:19:32.4335929Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1127:
2025-11-09T23:19:32.4336078Z -        let _timeout = params.get(1)
2025-11-09T23:19:32.4336211Z +        let _timeout = params
2025-11-09T23:19:32.4336333Z +            .get(1)
2025-11-09T23:19:32.4336479Z              .and_then(|p| p.as_u64())
2025-11-09T23:19:32.4336684Z              .map(|t| tokio::time::Duration::from_secs(t));
2025-11-09T23:19:32.4336793Z  
2025-11-09T23:19:32.4337282Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1131:
2025-11-09T23:19:32.4337467Z -        let hash_bytes = hex::decode(blockhash)
2025-11-09T23:19:32.4337713Z -            .map_err(|e| anyhow::anyhow!("Invalid block hash: {}", e))?;
2025-11-09T23:19:32.4339726Z +        let hash_bytes =
2025-11-09T23:19:32.4340163Z +            hex::decode(blockhash).map_err(|e| anyhow::anyhow!("Invalid block hash: {}", e))?;
2025-11-09T23:19:32.4340315Z          if hash_bytes.len() != 32 {
2025-11-09T23:19:32.4340594Z              return Err(anyhow::anyhow!("Block hash must be 32 bytes"));
2025-11-09T23:19:32.4340708Z          }
2025-11-09T23:19:32.4341165Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1140:
2025-11-09T23:19:32.4341351Z          // For now, check if block exists immediately
2025-11-09T23:19:32.4341529Z          if let Some(ref storage) = self.storage {
2025-11-09T23:19:32.4341772Z              if let Ok(Some(_block)) = storage.blocks().get_block(&hash) {
2025-11-09T23:19:32.4342232Z -                let height = storage.blocks().get_height_by_hash(&hash)?
2025-11-09T23:19:32.4342379Z -                    .unwrap_or(0);
2025-11-09T23:19:32.4342671Z +                let height = storage.blocks().get_height_by_hash(&hash)?.unwrap_or(0);
2025-11-09T23:19:32.4342785Z                  Ok(json!({
2025-11-09T23:19:32.4342918Z                      "hash": blockhash,
2025-11-09T23:19:32.4343039Z                      "height": height
2025-11-09T23:19:32.4343480Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1151:
2025-11-09T23:19:32.4343585Z              }
2025-11-09T23:19:32.4343699Z          } else {
2025-11-09T23:19:32.4344031Z              // Graceful degradation: return informative error instead of failing silently
2025-11-09T23:19:32.4344669Z -            Err(anyhow::anyhow!("Storage not available. This operation requires storage to be initialized."))
2025-11-09T23:19:32.4344824Z +            Err(anyhow::anyhow!(
2025-11-09T23:19:32.4345163Z +                "Storage not available. This operation requires storage to be initialized."
2025-11-09T23:19:32.4345274Z +            ))
2025-11-09T23:19:32.4345383Z          }
2025-11-09T23:19:32.4345487Z      }
2025-11-09T23:19:32.4345587Z  
2025-11-09T23:19:32.4346024Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1158:
2025-11-09T23:19:32.4346159Z      /// Wait for block height
2025-11-09T23:19:32.4346260Z      ///
2025-11-09T23:19:32.4346505Z      /// Params: ["height", "timeout"] (block height, optional timeout)
2025-11-09T23:19:32.4346616Z -    /// 
2025-11-09T23:19:32.4346718Z +    ///
2025-11-09T23:19:32.4347056Z      /// Note: Full implementation requires async notification infrastructure.
2025-11-09T23:19:32.4347441Z      /// Currently checks if block at height exists immediately. Future enhancement will:
2025-11-09T23:19:32.4347620Z      /// 1. Subscribe to block notifications
2025-11-09T23:19:32.4348096Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1167:
2025-11-09T23:19:32.4348664Z      pub async fn wait_for_block_height(&self, params: &Value) -> Result<Value> {
2025-11-09T23:19:32.4348839Z          debug!("RPC: waitforblockheight");
2025-11-09T23:19:32.4348942Z  
2025-11-09T23:19:32.4349078Z -        let height = params.get(0)
2025-11-09T23:19:32.4349214Z +        let height = params
2025-11-09T23:19:32.4349321Z +            .get(0)
2025-11-09T23:19:32.4349453Z              .and_then(|p| p.as_u64())
2025-11-09T23:19:32.4349710Z              .ok_or_else(|| anyhow::anyhow!("Height parameter required"))?;
2025-11-09T23:19:32.4349821Z  
2025-11-09T23:19:32.4350267Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1174:
2025-11-09T23:19:32.4350407Z -        let _timeout = params.get(1)
2025-11-09T23:19:32.4350540Z +        let _timeout = params
2025-11-09T23:19:32.4350645Z +            .get(1)
2025-11-09T23:19:32.4350787Z              .and_then(|p| p.as_u64())
2025-11-09T23:19:32.4350999Z              .map(|t| tokio::time::Duration::from_secs(t));
2025-11-09T23:19:32.4351195Z          if let Some(ref storage) = self.storage {
2025-11-09T23:19:32.4351679Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1186:
2025-11-09T23:19:32.4351952Z                      Err(anyhow::anyhow!("Block at height {} not found", height))
2025-11-09T23:19:32.4352080Z                  }
2025-11-09T23:19:32.4352204Z              } else {
2025-11-09T23:19:32.4352612Z -                Err(anyhow::anyhow!("Block at height {} not yet available (tip: {})", height, tip_height))
2025-11-09T23:19:32.4352773Z +                Err(anyhow::anyhow!(
2025-11-09T23:19:32.4352991Z +                    "Block at height {} not yet available (tip: {})",
2025-11-09T23:19:32.4353123Z +                    height,
2025-11-09T23:19:32.4353269Z +                    tip_height
2025-11-09T23:19:32.4353384Z +                ))
2025-11-09T23:19:32.4353493Z              }
2025-11-09T23:19:32.4353800Z          } else {
2025-11-09T23:19:32.4354173Z              // Graceful degradation: return informative error instead of failing silently
2025-11-09T23:19:32.4354805Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1193:
2025-11-09T23:19:32.4355271Z -            Err(anyhow::anyhow!("Storage not available. This operation requires storage to be initialized."))
2025-11-09T23:19:32.4355411Z +            Err(anyhow::anyhow!(
2025-11-09T23:19:32.4355754Z +                "Storage not available. This operation requires storage to be initialized."
2025-11-09T23:19:32.4355863Z +            ))
2025-11-09T23:19:32.4355970Z          }
2025-11-09T23:19:32.4356083Z      }
2025-11-09T23:19:32.4356187Z  
2025-11-09T23:19:32.4356640Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1200:
2025-11-09T23:19:32.4356943Z      pub async fn get_block_filter(&self, params: &Value) -> Result<Value> {
2025-11-09T23:19:32.4357091Z          debug!("RPC: getblockfilter");
2025-11-09T23:19:32.4357205Z  
2025-11-09T23:19:32.4357365Z -        let blockhash = params.get(0)
2025-11-09T23:19:32.4357521Z +        let blockhash = params
2025-11-09T23:19:32.4357639Z +            .get(0)
2025-11-09T23:19:32.4357778Z              .and_then(|p| p.as_str())
2025-11-09T23:19:32.4358057Z              .ok_or_else(|| anyhow::anyhow!("Block hash parameter required"))?;
2025-11-09T23:19:32.4358163Z  
2025-11-09T23:19:32.4358651Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1207:
2025-11-09T23:19:32.4358847Z -        let filtertype = params.get(1)
2025-11-09T23:19:32.4358988Z -            .and_then(|p| p.as_u64())
2025-11-09T23:19:32.4359154Z -            .unwrap_or(0); // Default: Basic filter
2025-11-09T23:19:32.4360937Z +        let filtertype = params.get(1).and_then(|p| p.as_u64()).unwrap_or(0); // Default: Basic filter
2025-11-09T23:19:32.4361052Z  
2025-11-09T23:19:32.4361185Z          if filtertype != 0 {
2025-11-09T23:19:32.4361678Z              return Err(anyhow::anyhow!("Only filter type 0 (Basic) is supported"));
2025-11-09T23:19:32.4362153Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1213:
2025-11-09T23:19:32.4362264Z          }
2025-11-09T23:19:32.4362369Z  
2025-11-09T23:19:32.4362543Z -        let hash_bytes = hex::decode(blockhash)
2025-11-09T23:19:32.4362784Z -            .map_err(|e| anyhow::anyhow!("Invalid block hash: {}", e))?;
2025-11-09T23:19:32.4362908Z +        let hash_bytes =
2025-11-09T23:19:32.4363257Z +            hex::decode(blockhash).map_err(|e| anyhow::anyhow!("Invalid block hash: {}", e))?;
2025-11-09T23:19:32.4363401Z          if hash_bytes.len() != 32 {
2025-11-09T23:19:32.4363652Z              return Err(anyhow::anyhow!("Block hash must be 32 bytes"));
2025-11-09T23:19:32.4363761Z          }
2025-11-09T23:19:32.4364230Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1226:
2025-11-09T23:19:32.4364694Z                  // Get filter service from network manager (if available)
2025-11-09T23:19:32.4364865Z                  // For now, generate filter directly
2025-11-09T23:19:32.4365074Z                  use bllvm_protocol::bip158::build_block_filter;
2025-11-09T23:19:32.4365184Z -                
2025-11-09T23:19:32.4365287Z +
2025-11-09T23:19:32.4365473Z                  // Get previous outpoint scripts from UTXO set
2025-11-09T23:19:32.4365708Z                  // For each input, find the UTXO and get its script_pubkey
2025-11-09T23:19:32.4365877Z                  let mut previous_scripts = Vec::new();
2025-11-09T23:19:32.4366334Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1239:
2025-11-09T23:19:32.4366460Z                          }
2025-11-09T23:19:32.4366574Z                      }
2025-11-09T23:19:32.4366683Z                  }
2025-11-09T23:19:32.4366799Z -                
2025-11-09T23:19:32.4366905Z +
2025-11-09T23:19:32.4367208Z                  match build_block_filter(&block.transactions, &previous_scripts) {
2025-11-09T23:19:32.4367519Z                      Ok(filter) => {
2025-11-09T23:19:32.4367654Z                          Ok(json!({
2025-11-09T23:19:32.4368109Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1247:
2025-11-09T23:19:32.4368379Z                              "header": hex::encode([0u8; 32]), // Would calculate filter header
2025-11-09T23:19:32.4368507Z                          }))
2025-11-09T23:19:32.4368618Z                      }
2025-11-09T23:19:32.4368865Z -                    Err(e) => Err(anyhow::anyhow!("Failed to build filter: {}", e))
2025-11-09T23:19:32.4369108Z +                    Err(e) => Err(anyhow::anyhow!("Failed to build filter: {}", e)),
2025-11-09T23:19:32.4369230Z                  }
2025-11-09T23:19:32.4369345Z              } else {
2025-11-09T23:19:32.4369522Z                  Err(anyhow::anyhow!("Block not found"))
2025-11-09T23:19:32.4370003Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1254:
2025-11-09T23:19:32.4370137Z              }
2025-11-09T23:19:32.4370254Z          } else {
2025-11-09T23:19:32.4371013Z              // Graceful degradation: return informative error instead of failing silently
2025-11-09T23:19:32.4371497Z -            Err(anyhow::anyhow!("Storage not available. This operation requires storage to be initialized."))
2025-11-09T23:19:32.4371639Z +            Err(anyhow::anyhow!(
2025-11-09T23:19:32.4372005Z +                "Storage not available. This operation requires storage to be initialized."
2025-11-09T23:19:32.4372120Z +            ))
2025-11-09T23:19:32.4372231Z          }
2025-11-09T23:19:32.4372344Z      }
2025-11-09T23:19:32.4372455Z  
2025-11-09T23:19:32.4372990Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/control.rs:89:
2025-11-09T23:19:32.4373317Z      pub async fn getmemoryinfo(&self, params: &Value) -> RpcResult<Value> {
2025-11-09T23:19:32.4373486Z          debug!("RPC: getmemoryinfo");
2025-11-09T23:19:32.4373610Z  
2025-11-09T23:19:32.4373971Z -        let mode = params
2025-11-09T23:19:32.4374124Z -            .get(0)
2025-11-09T23:19:32.4374438Z -            .and_then(|p| p.as_str())
2025-11-09T23:19:32.4374579Z -            .unwrap_or("stats");
2025-11-09T23:19:32.4374878Z +        let mode = params.get(0).and_then(|p| p.as_str()).unwrap_or("stats");
2025-11-09T23:19:32.4374993Z  
2025-11-09T23:19:32.4375114Z          match mode {
2025-11-09T23:19:32.4375241Z              "stats" => {
2025-11-09T23:19:32.4375686Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/control.rs:224:
2025-11-09T23:19:32.4375806Z          } else {
2025-11-09T23:19:32.4376027Z              // No command specified, return list of all commands
2025-11-09T23:19:32.4376165Z              let commands = vec![
2025-11-09T23:19:32.4376486Z -                "getblockchaininfo", "getblock", "getblockhash", "getblockheader",
2025-11-09T23:19:32.4376838Z -                "getbestblockhash", "getblockcount", "getdifficulty", "gettxoutsetinfo",
2025-11-09T23:19:32.4377256Z -                "verifychain", "getrawtransaction", "sendrawtransaction", "testmempoolaccept",
2025-11-09T23:19:32.4377621Z -                "decoderawtransaction", "gettxout", "gettxoutproof", "verifytxoutproof",
2025-11-09T23:19:32.4377965Z -                "getmempoolinfo", "getrawmempool", "savemempool", "getnetworkinfo",
2025-11-09T23:19:32.4378325Z -                "getpeerinfo", "getconnectioncount", "ping", "addnode", "disconnectnode",
2025-11-09T23:19:32.4378649Z -                "getnettotals", "clearbanned", "setban", "listbanned", "getmininginfo",
2025-11-09T23:19:32.4378994Z -                "getblocktemplate", "submitblock", "estimatesmartfee", "stop", "uptime",
2025-11-09T23:19:32.4379213Z -                "getmemoryinfo", "getrpcinfo", "help", "logging",
2025-11-09T23:19:32.4379426Z +                "getblockchaininfo",
2025-11-09T23:19:32.4379562Z +                "getblock",
2025-11-09T23:19:32.4379946Z +                "getblockhash",
2025-11-09T23:19:32.4380099Z +                "getblockheader",
2025-11-09T23:19:32.4380714Z +                "getbestblockhash",
2025-11-09T23:19:32.4380881Z +                "getblockcount",
2025-11-09T23:19:32.4381013Z +                "getdifficulty",
2025-11-09T23:19:32.4381146Z +                "gettxoutsetinfo",
2025-11-09T23:19:32.4382804Z +                "verifychain",
2025-11-09T23:19:32.4382946Z +                "getrawtransaction",
2025-11-09T23:19:32.4383093Z +                "sendrawtransaction",
2025-11-09T23:19:32.4383254Z +                "testmempoolaccept",
2025-11-09T23:19:32.4383411Z +                "decoderawtransaction",
2025-11-09T23:19:32.4383541Z +                "gettxout",
2025-11-09T23:19:32.4383680Z +                "gettxoutproof",
2025-11-09T23:19:32.4383827Z +                "verifytxoutproof",
2025-11-09T23:19:32.4383968Z +                "getmempoolinfo",
2025-11-09T23:19:32.4384098Z +                "getrawmempool",
2025-11-09T23:19:32.4384251Z +                "savemempool",
2025-11-09T23:19:32.4384587Z +                "getnetworkinfo",
2025-11-09T23:19:32.4384729Z +                "getpeerinfo",
2025-11-09T23:19:32.4384881Z +                "getconnectioncount",
2025-11-09T23:19:32.4385013Z +                "ping",
2025-11-09T23:19:32.4385137Z +                "addnode",
2025-11-09T23:19:32.4385275Z +                "disconnectnode",
2025-11-09T23:19:32.4385419Z +                "getnettotals",
2025-11-09T23:19:32.4385547Z +                "clearbanned",
2025-11-09T23:19:32.4385667Z +                "setban",
2025-11-09T23:19:32.4385789Z +                "listbanned",
2025-11-09T23:19:32.4385921Z +                "getmininginfo",
2025-11-09T23:19:32.4386061Z +                "getblocktemplate",
2025-11-09T23:19:32.4386187Z +                "submitblock",
2025-11-09T23:19:32.4386316Z +                "estimatesmartfee",
2025-11-09T23:19:32.4386431Z +                "stop",
2025-11-09T23:19:32.4386548Z +                "uptime",
2025-11-09T23:19:32.4386697Z +                "getmemoryinfo",
2025-11-09T23:19:32.4387059Z +                "getrpcinfo",
2025-11-09T23:19:32.4387199Z +                "help",
2025-11-09T23:19:32.4387328Z +                "logging",
2025-11-09T23:19:32.4387448Z              ];
2025-11-09T23:19:32.4387558Z  
2025-11-09T23:19:32.4387719Z              Ok(json!(commands.join("\n")))
2025-11-09T23:19:32.4388166Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/control.rs:275:
2025-11-09T23:19:32.4388354Z          // 1. Store a reference to the EnvFilter layer
2025-11-09T23:19:32.4388578Z          // 2. Provide methods to update the filter dynamically
2025-11-09T23:19:32.4388764Z          // 3. Rebuild the subscriber with the new filter
2025-11-09T23:19:32.4388888Z -        
2025-11-09T23:19:32.4388998Z +
2025-11-09T23:19:32.4389171Z          // Check current filter state from environment
2025-11-09T23:19:32.4389377Z -        let current_filter = std::env::var("RUST_LOG")
2025-11-09T23:19:32.4389550Z -            .unwrap_or_else(|_| "info".to_string());
2025-11-09T23:19:32.4389663Z -        
2025-11-09T23:19:32.4390012Z +        let current_filter = std::env::var("RUST_LOG").unwrap_or_else(|_| "info".to_string());
2025-11-09T23:19:32.4390116Z +
2025-11-09T23:19:32.4390328Z          // Determine if debug logging is active based on filter
2025-11-09T23:19:32.4390540Z -        let active = current_filter.contains("debug") || 
2025-11-09T23:19:32.4390710Z -                     current_filter.contains("trace") ||
2025-11-09T23:19:32.4390887Z -                     !exclude.contains(&"all".to_string());
2025-11-09T23:19:32.4391078Z +        let active = current_filter.contains("debug")
2025-11-09T23:19:32.4391249Z +            || current_filter.contains("trace")
2025-11-09T23:19:32.4391416Z +            || !exclude.contains(&"all".to_string());
2025-11-09T23:19:32.4391529Z  
2025-11-09T23:19:32.4391656Z          Ok(json!({
2025-11-09T23:19:32.4391789Z              "active": active,
2025-11-09T23:19:32.4392536Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/control.rs:297:
2025-11-09T23:19:32.4392798Z      /// Returns comprehensive health report for all node components
2025-11-09T23:19:32.4393090Z      pub async fn gethealth(&self, _params: &Value) -> RpcResult<Value> {
2025-11-09T23:19:32.4393232Z          debug!("RPC: gethealth");
2025-11-09T23:19:32.4393347Z -        
2025-11-09T23:19:32.4393466Z +
2025-11-09T23:19:32.4393746Z          // This would need access to Node instance to get full health report
2025-11-09T23:19:32.4393914Z          // For now, return basic health status
2025-11-09T23:19:32.4394033Z          Ok(json!({
2025-11-09T23:19:32.4394683Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/control.rs:312:
2025-11-09T23:19:32.4394885Z      /// Returns comprehensive metrics for monitoring
2025-11-09T23:19:32.4395176Z      pub async fn getmetrics(&self, _params: &Value) -> RpcResult<Value> {
2025-11-09T23:19:32.4395338Z          debug!("RPC: getmetrics");
2025-11-09T23:19:32.4395453Z -        
2025-11-09T23:19:32.4395567Z +
2025-11-09T23:19:32.4395842Z          // This would need access to MetricsCollector to get full metrics
2025-11-09T23:19:32.4395992Z          // For now, return basic metrics
2025-11-09T23:19:32.4396191Z          let uptime = self.start_time.elapsed().as_secs();
2025-11-09T23:19:32.4396631Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/control.rs:328:
2025-11-09T23:19:32.4396777Z          Self::new()
2025-11-09T23:19:32.4396889Z      }
2025-11-09T23:19:32.4397004Z  }
2025-11-09T23:19:32.4397120Z -
2025-11-09T23:19:32.4397229Z  
2025-11-09T23:19:32.4397665Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:23:
2025-11-09T23:19:32.4397800Z  impl MempoolRpc {
2025-11-09T23:19:32.4397961Z      /// Create a new mempool RPC handler
2025-11-09T23:19:32.4398094Z      pub fn new() -> Self {
2025-11-09T23:19:32.4398252Z -        Self { mempool: None, storage: None }
2025-11-09T23:19:32.4398378Z +        Self {
2025-11-09T23:19:32.4398727Z +            mempool: None,
2025-11-09T23:19:32.4398862Z +            storage: None,
2025-11-09T23:19:32.4398969Z +        }
2025-11-09T23:19:32.4399089Z      }
2025-11-09T23:19:32.4399200Z  
2025-11-09T23:19:32.4399345Z      /// Create with dependencies
2025-11-09T23:19:32.4399762Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:30:
2025-11-09T23:19:32.4400139Z      pub fn with_dependencies(mempool: Arc<MempoolManager>, storage: Arc<Storage>) -> Self {
2025-11-09T23:19:32.4400366Z -        Self { mempool: Some(mempool), storage: Some(storage) }
2025-11-09T23:19:32.4400489Z +        Self {
2025-11-09T23:19:32.4400639Z +            mempool: Some(mempool),
2025-11-09T23:19:32.4400778Z +            storage: Some(storage),
2025-11-09T23:19:32.4401592Z +        }
2025-11-09T23:19:32.4401744Z      }
2025-11-09T23:19:32.4401859Z  
2025-11-09T23:19:32.4402009Z      /// Get mempool information
2025-11-09T23:19:32.4402477Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:40:
2025-11-09T23:19:32.4402671Z          if let Some(ref mempool) = self.mempool {
2025-11-09T23:19:32.4402825Z              let size = mempool.size();
2025-11-09T23:19:32.4403027Z              let transactions = mempool.get_transactions();
2025-11-09T23:19:32.4403242Z -            let bytes: usize = transactions.iter().map(|tx| {
2025-11-09T23:19:32.4403587Z -                use bllvm_protocol::serialization::transaction::serialize_transaction;
2025-11-09T23:19:32.4403757Z -                serialize_transaction(tx).len()
2025-11-09T23:19:32.4403888Z -            }).sum();
2025-11-09T23:19:32.4404048Z +            let bytes: usize = transactions
2025-11-09T23:19:32.4404170Z +                .iter()
2025-11-09T23:19:32.4404300Z +                .map(|tx| {
2025-11-09T23:19:32.4404899Z +                    use bllvm_protocol::serialization::transaction::serialize_transaction;
2025-11-09T23:19:32.4405323Z +                    serialize_transaction(tx).len()
2025-11-09T23:19:32.4405438Z +                })
2025-11-09T23:19:32.4405563Z +                .sum();
2025-11-09T23:19:32.4405667Z  
2025-11-09T23:19:32.4405780Z              Ok(json!({
2025-11-09T23:19:32.4405913Z                  "loaded": true,
2025-11-09T23:19:32.4406364Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:56:
2025-11-09T23:19:32.4406482Z              }))
2025-11-09T23:19:32.4406600Z          } else {
2025-11-09T23:19:32.4406954Z              // Graceful degradation: return empty mempool info when mempool unavailable
2025-11-09T23:19:32.4407406Z -            tracing::debug!("getmempoolinfo called but mempool not available, returning empty mempool");
2025-11-09T23:19:32.4407532Z +            tracing::debug!(
2025-11-09T23:19:32.4407887Z +                "getmempoolinfo called but mempool not available, returning empty mempool"
2025-11-09T23:19:32.4408005Z +            );
2025-11-09T23:19:32.4408137Z              Ok(json!({
2025-11-09T23:19:32.4408279Z                  "loaded": false,
2025-11-09T23:19:32.4408410Z                  "size": 0,
2025-11-09T23:19:32.4408848Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:82:
2025-11-09T23:19:32.4409046Z              let transactions = mempool.get_transactions();
2025-11-09T23:19:32.4409256Z              use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:19:32.4409582Z              use bllvm_protocol::serialization::transaction::serialize_transaction;
2025-11-09T23:19:32.4409696Z -            
2025-11-09T23:19:32.4409815Z +
2025-11-09T23:19:32.4409944Z              if verbose {
2025-11-09T23:19:32.4410125Z                  let mut result = serde_json::Map::new();
2025-11-09T23:19:32.4410277Z                  for tx in transactions {
2025-11-09T23:19:32.4410706Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:90:
2025-11-09T23:19:32.4410871Z                      let txid_hex = hex::encode(txid);
2025-11-09T23:19:32.4411241Z                      let txid_hex_clone = txid_hex.clone();
2025-11-09T23:19:32.4411459Z                      let size = serialize_transaction(&tx).len();
2025-11-09T23:19:32.4411578Z -                    
2025-11-09T23:19:32.4411690Z +
2025-11-09T23:19:32.4411859Z                      result.insert(txid_hex, json!({
2025-11-09T23:19:32.4411995Z                          "size": size,
2025-11-09T23:19:32.4412414Z                          "fee": if let (Some(ref mempool), Some(ref storage)) = (self.mempool.as_ref(), self.storage.as_ref()) {
2025-11-09T23:19:32.4412861Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:126:
2025-11-09T23:19:32.4412985Z                  }
2025-11-09T23:19:32.4413120Z                  Ok(json!(result))
2025-11-09T23:19:32.4413236Z              } else {
2025-11-09T23:19:32.4413479Z -                let txids: Vec<String> = transactions.iter().map(|tx| {
2025-11-09T23:19:32.4413654Z -                    let txid = calculate_tx_id(tx);
2025-11-09T23:19:32.4413811Z -                    hex::encode(txid)
2025-11-09T23:19:32.4413935Z -                }).collect();
2025-11-09T23:19:32.4414109Z +                let txids: Vec<String> = transactions
2025-11-09T23:19:32.4414234Z +                    .iter()
2025-11-09T23:19:32.4414540Z +                    .map(|tx| {
2025-11-09T23:19:32.4414720Z +                        let txid = calculate_tx_id(tx);
2025-11-09T23:19:32.4414868Z +                        hex::encode(txid)
2025-11-09T23:19:32.4414991Z +                    })
2025-11-09T23:19:32.4415128Z +                    .collect();
2025-11-09T23:19:32.4415261Z                  Ok(json!(txids))
2025-11-09T23:19:32.4415373Z              }
2025-11-09T23:19:32.4415489Z          } else {
2025-11-09T23:19:32.4415946Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:174:
2025-11-09T23:19:32.4416121Z          if let Some(mempool) = &self.mempool {
2025-11-09T23:19:32.4416691Z              let data_dir = std::env::var("DATA_DIR").unwrap_or_else(|_| "data".to_string());
2025-11-09T23:19:32.4417020Z              let mempool_path = std::path::Path::new(&data_dir).join("mempool.dat");
2025-11-09T23:19:32.4417136Z -            
2025-11-09T23:19:32.4417245Z +
2025-11-09T23:19:32.4417480Z              // Arc implements Deref, so we can call methods directly
2025-11-09T23:19:32.4417709Z              if let Err(e) = mempool.save_to_disk(&mempool_path) {
2025-11-09T23:19:32.4417966Z -                return Err(crate::rpc::errors::RpcError::internal_error(
2025-11-09T23:19:32.4418156Z -                    format!("Failed to save mempool: {}", e)
2025-11-09T23:19:32.4418280Z -                ));
2025-11-09T23:19:32.4418567Z +                return Err(crate::rpc::errors::RpcError::internal_error(format!(
2025-11-09T23:19:32.4418732Z +                    "Failed to save mempool: {}",
2025-11-09T23:19:32.4418860Z +                    e
2025-11-09T23:19:32.4418979Z +                )));
2025-11-09T23:19:32.4419101Z              }
2025-11-09T23:19:32.4419237Z              Ok(json!(null))
2025-11-09T23:19:32.4419356Z          } else {
2025-11-09T23:19:32.4419804Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:186:
2025-11-09T23:19:32.4420020Z              Err(crate::rpc::errors::RpcError::internal_error(
2025-11-09T23:19:32.4420203Z -                "Mempool not initialized".to_string()
2025-11-09T23:19:32.4420374Z +                "Mempool not initialized".to_string(),
2025-11-09T23:19:32.4420489Z              ))
2025-11-09T23:19:32.4420608Z          }
2025-11-09T23:19:32.4420713Z      }
2025-11-09T23:19:32.4421151Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:195:
2025-11-09T23:19:32.4421518Z      pub async fn getmempoolancestors(&self, params: &Value) -> RpcResult<Value> {
2025-11-09T23:19:32.4421699Z          debug!("RPC: getmempoolancestors");
2025-11-09T23:19:32.4421808Z  
2025-11-09T23:19:32.4421965Z -        let txid = params.get(0)
2025-11-09T23:19:32.4422366Z -            .and_then(|p| p.as_str())
2025-11-09T23:19:32.4422829Z -            .ok_or_else(|| crate::rpc::errors::RpcError::invalid_params("Transaction ID required".to_string()))?;
2025-11-09T23:19:32.4423094Z +        let txid = params.get(0).and_then(|p| p.as_str()).ok_or_else(|| {
2025-11-09T23:19:32.4423538Z +            crate::rpc::errors::RpcError::invalid_params("Transaction ID required".to_string())
2025-11-09T23:19:32.4423667Z +        })?;
2025-11-09T23:19:32.4423777Z  
2025-11-09T23:19:32.4424082Z          let verbose = params.get(1).and_then(|p| p.as_bool()).unwrap_or(false);
2025-11-09T23:19:32.4424203Z  
2025-11-09T23:19:32.4424828Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:204:
2025-11-09T23:19:32.4425001Z -        let hash_bytes = hex::decode(txid)
2025-11-09T23:19:32.4425459Z -            .map_err(|e| crate::rpc::errors::RpcError::invalid_params(format!("Invalid transaction ID: {}", e)))?;
2025-11-09T23:19:32.4425684Z +        let hash_bytes = hex::decode(txid).map_err(|e| {
2025-11-09T23:19:32.4426078Z +            crate::rpc::errors::RpcError::invalid_params(format!("Invalid transaction ID: {}", e))
2025-11-09T23:19:32.4426190Z +        })?;
2025-11-09T23:19:32.4426339Z          if hash_bytes.len() != 32 {
2025-11-09T23:19:32.4426824Z -            return Err(crate::rpc::errors::RpcError::invalid_params("Transaction ID must be 32 bytes".to_string()));
2025-11-09T23:19:32.4427074Z +            return Err(crate::rpc::errors::RpcError::invalid_params(
2025-11-09T23:19:32.4427283Z +                "Transaction ID must be 32 bytes".to_string(),
2025-11-09T23:19:32.4427397Z +            ));
2025-11-09T23:19:32.4427512Z          }
2025-11-09T23:19:32.4427662Z          let mut hash = [0u8; 32];
2025-11-09T23:19:32.4427819Z          hash.copy_from_slice(&hash_bytes);
2025-11-09T23:19:32.4428276Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:222:
2025-11-09T23:19:32.4428775Z                          let ancestor_txid_clone = ancestor_txid.clone();
2025-11-09T23:19:32.4429135Z                          use bllvm_protocol::serialization::transaction::serialize_transaction;
2025-11-09T23:19:32.4429361Z                          let size = serialize_transaction(&ancestor_tx).len();
2025-11-09T23:19:32.4429486Z -                        
2025-11-09T23:19:32.4429606Z +
2025-11-09T23:19:32.4429769Z                          result.insert(ancestor_txid, json!({
2025-11-09T23:19:32.4429898Z                              "size": size,
2025-11-09T23:19:32.4431563Z                              "fee": if let Some(ref storage) = self.storage {
2025-11-09T23:19:32.4431993Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:278:
2025-11-09T23:19:32.4432357Z      pub async fn getmempooldescendants(&self, params: &Value) -> RpcResult<Value> {
2025-11-09T23:19:32.4432532Z          debug!("RPC: getmempooldescendants");
2025-11-09T23:19:32.4432647Z  
2025-11-09T23:19:32.4432777Z -        let txid = params.get(0)
2025-11-09T23:19:32.4432921Z -            .and_then(|p| p.as_str())
2025-11-09T23:19:32.4433378Z -            .ok_or_else(|| crate::rpc::errors::RpcError::invalid_params("Transaction ID required".to_string()))?;
2025-11-09T23:19:32.4433640Z +        let txid = params.get(0).and_then(|p| p.as_str()).ok_or_else(|| {
2025-11-09T23:19:32.4434000Z +            crate::rpc::errors::RpcError::invalid_params("Transaction ID required".to_string())
2025-11-09T23:19:32.4434118Z +        })?;
2025-11-09T23:19:32.4434218Z  
2025-11-09T23:19:32.4434683Z          let verbose = params.get(1).and_then(|p| p.as_bool()).unwrap_or(false);
2025-11-09T23:19:32.4434787Z  
2025-11-09T23:19:32.4435228Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:287:
2025-11-09T23:19:32.4435386Z -        let hash_bytes = hex::decode(txid)
2025-11-09T23:19:32.4435821Z -            .map_err(|e| crate::rpc::errors::RpcError::invalid_params(format!("Invalid transaction ID: {}", e)))?;
2025-11-09T23:19:32.4436234Z +        let hash_bytes = hex::decode(txid).map_err(|e| {
2025-11-09T23:19:32.4436617Z +            crate::rpc::errors::RpcError::invalid_params(format!("Invalid transaction ID: {}", e))
2025-11-09T23:19:32.4436731Z +        })?;
2025-11-09T23:19:32.4436932Z          if hash_bytes.len() != 32 {
2025-11-09T23:19:32.4437406Z -            return Err(crate::rpc::errors::RpcError::invalid_params("Transaction ID must be 32 bytes".to_string()));
2025-11-09T23:19:32.4437634Z +            return Err(crate::rpc::errors::RpcError::invalid_params(
2025-11-09T23:19:32.4437826Z +                "Transaction ID must be 32 bytes".to_string(),
2025-11-09T23:19:32.4437932Z +            ));
2025-11-09T23:19:32.4438031Z          }
2025-11-09T23:19:32.4438155Z          let mut hash = [0u8; 32];
2025-11-09T23:19:32.4438321Z          hash.copy_from_slice(&hash_bytes);
2025-11-09T23:19:32.4438777Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:295:
2025-11-09T23:19:32.4438969Z          if let Some(ref mempool) = self.mempool {
2025-11-09T23:19:32.4439389Z              // Find descendants by checking which transactions spend outputs created by this transaction
2025-11-09T23:19:32.4439544Z              let mut descendants = Vec::new();
2025-11-09T23:19:32.4439648Z -            
2025-11-09T23:19:32.4439747Z +
2025-11-09T23:19:32.4439943Z              if let Some(tx) = mempool.get_transaction(&hash) {
2025-11-09T23:19:32.4440768Z                  // Get all output outpoints from this transaction
2025-11-09T23:19:32.4440995Z                  let mut output_outpoints = Vec::new();
2025-11-09T23:19:32.4441466Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:329:
2025-11-09T23:19:32.4441701Z                          let descendant_txid_clone = descendant_txid.clone();
2025-11-09T23:19:32.4442041Z                          use bllvm_protocol::serialization::transaction::serialize_transaction;
2025-11-09T23:19:32.4442534Z                          let size = serialize_transaction(&descendant_tx).len();
2025-11-09T23:19:32.4442664Z -                        
2025-11-09T23:19:32.4442779Z +
2025-11-09T23:19:32.4442964Z                          result.insert(descendant_txid, json!({
2025-11-09T23:19:32.4443112Z                              "size": size,
2025-11-09T23:19:32.4443317Z                              "fee": if let Some(ref storage) = self.storage {
2025-11-09T23:19:32.4443763Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:385:
2025-11-09T23:19:32.4444109Z      pub async fn getmempoolentry(&self, params: &Value) -> RpcResult<Value> {
2025-11-09T23:19:32.4444270Z          debug!("RPC: getmempoolentry");
2025-11-09T23:19:32.4444575Z  
2025-11-09T23:19:32.4444737Z -        let txid = params.get(0)
2025-11-09T23:19:32.4444894Z -            .and_then(|p| p.as_str())
2025-11-09T23:19:32.4445442Z -            .ok_or_else(|| crate::rpc::errors::RpcError::invalid_params("Transaction ID required".to_string()))?;
2025-11-09T23:19:32.4445736Z +        let txid = params.get(0).and_then(|p| p.as_str()).ok_or_else(|| {
2025-11-09T23:19:32.4446615Z +            crate::rpc::errors::RpcError::invalid_params("Transaction ID required".to_string())
2025-11-09T23:19:32.4446755Z +        })?;
2025-11-09T23:19:32.4446867Z  
2025-11-09T23:19:32.4447199Z          let verbose = params.get(1).and_then(|p| p.as_bool()).unwrap_or(false);
2025-11-09T23:19:32.4447347Z  
2025-11-09T23:19:32.4447806Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:394:
2025-11-09T23:19:32.4447975Z -        let hash_bytes = hex::decode(txid)
2025-11-09T23:19:32.4448432Z -            .map_err(|e| crate::rpc::errors::RpcError::invalid_params(format!("Invalid transaction ID: {}", e)))?;
2025-11-09T23:19:32.4448627Z +        let hash_bytes = hex::decode(txid).map_err(|e| {
2025-11-09T23:19:32.4449027Z +            crate::rpc::errors::RpcError::invalid_params(format!("Invalid transaction ID: {}", e))
2025-11-09T23:19:32.4449153Z +        })?;
2025-11-09T23:19:32.4449533Z          if hash_bytes.len() != 32 {
2025-11-09T23:19:32.4450069Z -            return Err(crate::rpc::errors::RpcError::invalid_params("Transaction ID must be 32 bytes".to_string()));
2025-11-09T23:19:32.4450320Z +            return Err(crate::rpc::errors::RpcError::invalid_params(
2025-11-09T23:19:32.4450512Z +                "Transaction ID must be 32 bytes".to_string(),
2025-11-09T23:19:32.4450636Z +            ));
2025-11-09T23:19:32.4450746Z          }
2025-11-09T23:19:32.4450880Z          let mut hash = [0u8; 32];
2025-11-09T23:19:32.4451036Z          hash.copy_from_slice(&hash_bytes);
2025-11-09T23:19:32.4451490Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:403:
2025-11-09T23:19:32.4451697Z              if let Some(tx) = mempool.get_transaction(&hash) {
2025-11-09T23:19:32.4452032Z                  use bllvm_protocol::serialization::transaction::serialize_transaction;
2025-11-09T23:19:32.4452237Z                  let size = serialize_transaction(&tx).len();
2025-11-09T23:19:32.4452360Z -                
2025-11-09T23:19:32.4452471Z +
2025-11-09T23:19:32.4452633Z                  // Get ancestors and descendants
2025-11-09T23:19:32.4452852Z                  let ancestors = self.get_ancestors(mempool, &hash);
2025-11-09T23:19:32.4453090Z                  let descendants = self.get_descendants(mempool, &hash);
2025-11-09T23:19:32.4453538Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:410:
2025-11-09T23:19:32.4453660Z -                
2025-11-09T23:19:32.4453767Z +
2025-11-09T23:19:32.4453933Z                  let ancestor_count = ancestors.len();
2025-11-09T23:19:32.4454115Z                  let descendant_count = descendants.len();
2025-11-09T23:19:32.4454488Z -                let ancestor_size: usize = ancestors.iter()
2025-11-09T23:19:32.4454664Z +                let ancestor_size: usize = ancestors
2025-11-09T23:19:32.4455007Z +                    .iter()
2025-11-09T23:19:32.4455205Z                      .filter_map(|h| mempool.get_transaction(h))
2025-11-09T23:19:32.4455391Z                      .map(|tx| serialize_transaction(&tx).len())
2025-11-09T23:19:32.4455514Z                      .sum();
2025-11-09T23:19:32.4455963Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:417:
2025-11-09T23:19:32.4456166Z -                let descendant_size: usize = descendants.iter()
2025-11-09T23:19:32.4456344Z +                let descendant_size: usize = descendants
2025-11-09T23:19:32.4458378Z +                    .iter()
2025-11-09T23:19:32.4458564Z                      .filter_map(|h| mempool.get_transaction(h))
2025-11-09T23:19:32.4458731Z                      .map(|tx| serialize_transaction(&tx).len())
2025-11-09T23:19:32.4458857Z                      .sum();
2025-11-09T23:19:32.4459274Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:454:
2025-11-09T23:19:32.4459433Z                      "bip125-replaceable": false
2025-11-09T23:19:32.4459566Z                  }))
2025-11-09T23:19:32.4459700Z              } else {
2025-11-09T23:19:32.4459921Z -                Err(crate::rpc::errors::RpcError::invalid_params(
2025-11-09T23:19:32.4460148Z -                    format!("Transaction {} not found in mempool", txid)
2025-11-09T23:19:32.4460272Z -                ))
2025-11-09T23:19:32.4460521Z +                Err(crate::rpc::errors::RpcError::invalid_params(format!(
2025-11-09T23:19:32.4460695Z +                    "Transaction {} not found in mempool",
2025-11-09T23:19:32.4460811Z +                    txid
2025-11-09T23:19:32.4460933Z +                )))
2025-11-09T23:19:32.4461048Z              }
2025-11-09T23:19:32.4461164Z          } else {
2025-11-09T23:19:32.4461382Z              Err(crate::rpc::errors::RpcError::internal_error(
2025-11-09T23:19:32.4461998Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:463:
2025-11-09T23:19:32.4462175Z -                "Mempool not initialized".to_string()
2025-11-09T23:19:32.4462565Z +                "Mempool not initialized".to_string(),
2025-11-09T23:19:32.4462690Z              ))
2025-11-09T23:19:32.4462804Z          }
2025-11-09T23:19:32.4462916Z      }
2025-11-09T23:19:32.4463382Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:468:
2025-11-09T23:19:32.4463555Z      /// Helper: Get ancestors for a transaction
2025-11-09T23:19:32.4463901Z      fn get_ancestors(&self, mempool: &MempoolManager, tx_hash: &Hash) -> Vec<Hash> {
2025-11-09T23:19:32.4464056Z          let mut ancestors = Vec::new();
2025-11-09T23:19:32.4464228Z -        
2025-11-09T23:19:32.4464503Z +
2025-11-09T23:19:32.4464726Z          if let Some(tx) = mempool.get_transaction(tx_hash) {
2025-11-09T23:19:32.4465087Z              // Find transactions that this transaction depends on (spends their outputs)
2025-11-09T23:19:32.4465293Z              use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:19:32.4465741Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:478:
2025-11-09T23:19:32.4465904Z                  for ancestor_tx in transactions {
2025-11-09T23:19:32.4466126Z                      let ancestor_hash = calculate_tx_id(&ancestor_tx);
2025-11-09T23:19:32.4466386Z                      for (idx, _output) in ancestor_tx.outputs.iter().enumerate() {
2025-11-09T23:19:32.4466754Z -                        if input.prevout.hash == ancestor_hash && input.prevout.index == idx as u64 {
2025-11-09T23:19:32.4467097Z +                        if input.prevout.hash == ancestor_hash && input.prevout.index == idx as u64
2025-11-09T23:19:32.4467218Z +                        {
2025-11-09T23:19:32.4467406Z                              if !ancestors.contains(&ancestor_hash) {
2025-11-09T23:19:32.4467582Z                                  ancestors.push(ancestor_hash);
2025-11-09T23:19:32.4467698Z                              }
2025-11-09T23:19:32.4468359Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:487:
2025-11-09T23:19:32.4468484Z                  }
2025-11-09T23:19:32.4468592Z              }
2025-11-09T23:19:32.4468695Z          }
2025-11-09T23:19:32.4470682Z -        
2025-11-09T23:19:32.4470790Z +
2025-11-09T23:19:32.4470910Z          ancestors
2025-11-09T23:19:32.4471023Z      }
2025-11-09T23:19:32.4471138Z  
2025-11-09T23:19:32.4471562Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:494:
2025-11-09T23:19:32.4471745Z      /// Helper: Get descendants for a transaction
2025-11-09T23:19:32.4472120Z      fn get_descendants(&self, mempool: &MempoolManager, tx_hash: &Hash) -> Vec<Hash> {
2025-11-09T23:19:32.4472286Z          let mut descendants = Vec::new();
2025-11-09T23:19:32.4472402Z -        
2025-11-09T23:19:32.4472515Z +
2025-11-09T23:19:32.4472736Z          if let Some(tx) = mempool.get_transaction(tx_hash) {
2025-11-09T23:19:32.4472934Z              // Get all output outpoints from this transaction
2025-11-09T23:19:32.4473125Z              let mut output_outpoints = Vec::new();
2025-11-09T23:19:32.4473577Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:520:
2025-11-09T23:19:32.4473695Z                  }
2025-11-09T23:19:32.4473811Z              }
2025-11-09T23:19:32.4473934Z          }
2025-11-09T23:19:32.4474044Z -        
2025-11-09T23:19:32.4474151Z +
2025-11-09T23:19:32.4474272Z          descendants
2025-11-09T23:19:32.4474568Z      }
2025-11-09T23:19:32.4474683Z  }
2025-11-09T23:19:32.4498926Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:1:
2025-11-09T23:19:32.4499435Z  //! Mining RPC methods
2025-11-09T23:19:32.4499757Z -//! 
2025-11-09T23:19:32.4499870Z +//!
2025-11-09T23:19:32.4500287Z  //! Implements mining-related JSON-RPC methods for block template generation and mining.
2025-11-09T23:19:32.4500549Z  //! Uses formally verified consensus-proof mining functions.
2025-11-09T23:19:32.4500677Z  
2025-11-09T23:19:32.4501554Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:6:
2025-11-09T23:19:32.4501727Z -use serde_json::{Value, json};
2025-11-09T23:19:32.4501877Z -use tracing::{debug, warn};
2025-11-09T23:19:32.4501992Z -use hex;
2025-11-09T23:19:32.4502175Z +use crate::node::mempool::MempoolManager;
2025-11-09T23:19:32.4502374Z  use crate::rpc::errors::{RpcError, RpcResult};
2025-11-09T23:19:32.4503029Z -use bllvm_protocol::{ConsensusProof, types::{BlockHeader, Transaction, UtxoSet, Natural, ByteString, Hash}, ValidationResult};
2025-11-09T23:19:32.4503278Z -use bllvm_protocol::serialization::serialize_transaction;
2025-11-09T23:19:32.4503430Z +use crate::storage::Storage;
2025-11-09T23:19:32.4503607Z  use bllvm_protocol::mining::BlockTemplate;
2025-11-09T23:19:32.4503915Z -use bllvm_protocol::serialization::deserialize_block_with_witnesses;
2025-11-09T23:19:32.4504085Z  use bllvm_protocol::pow::expand_target;
2025-11-09T23:19:32.4504222Z -use std::sync::Arc;
2025-11-09T23:19:32.4504717Z -use crate::storage::Storage;
2025-11-09T23:19:32.4504901Z -use crate::node::mempool::MempoolManager;
2025-11-09T23:19:32.4505214Z +use bllvm_protocol::serialization::deserialize_block_with_witnesses;
2025-11-09T23:19:32.4505460Z +use bllvm_protocol::serialization::serialize_transaction;
2025-11-09T23:19:32.4505602Z +use bllvm_protocol::{
2025-11-09T23:19:32.4505935Z +    types::{BlockHeader, ByteString, Hash, Natural, Transaction, UtxoSet},
2025-11-09T23:19:32.4506103Z +    ConsensusProof, ValidationResult,
2025-11-09T23:19:32.4506215Z +};
2025-11-09T23:19:32.4506331Z +use hex;
2025-11-09T23:19:32.4506480Z +use serde_json::{json, Value};
2025-11-09T23:19:32.4506621Z  use sha2::{Digest, Sha256};
2025-11-09T23:19:32.4506751Z +use std::sync::Arc;
2025-11-09T23:19:32.4506897Z +use tracing::{debug, warn};
2025-11-09T23:19:32.4507008Z  
2025-11-09T23:19:32.4507169Z  /// Mining RPC methods with dependencies
2025-11-09T23:19:32.4507302Z  pub struct MiningRpc {
2025-11-09T23:19:32.4507928Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:36:
2025-11-09T23:19:32.4508056Z              mempool: None,
2025-11-09T23:19:32.4508158Z          }
2025-11-09T23:19:32.4508278Z      }
2025-11-09T23:19:32.4508386Z -    
2025-11-09T23:19:32.4508488Z +
2025-11-09T23:19:32.4508691Z      /// Create with dependencies (storage and mempool)
2025-11-09T23:19:32.4509109Z      pub fn with_dependencies(storage: Arc<Storage>, mempool: Arc<MempoolManager>) -> Self {
2025-11-09T23:19:32.4509225Z          Self {
2025-11-09T23:19:32.4509651Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:45:
2025-11-09T23:19:32.4509814Z              mempool: Some(mempool),
2025-11-09T23:19:32.4509923Z          }
2025-11-09T23:19:32.4510034Z      }
2025-11-09T23:19:32.4510146Z -    
2025-11-09T23:19:32.4510262Z +
2025-11-09T23:19:32.4510403Z      /// Get mining information
2025-11-09T23:19:32.4510640Z      pub async fn get_mining_info(&self) -> RpcResult<Value> {
2025-11-09T23:19:32.4510808Z          debug!("RPC: getmininginfo");
2025-11-09T23:19:32.4511241Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:52:
2025-11-09T23:19:32.4511358Z -        
2025-11-09T23:19:32.4511465Z +
2025-11-09T23:19:32.4511649Z          // Get current block height from storage
2025-11-09T23:19:32.4511875Z          let blocks = if let Some(ref storage) = self.storage {
2025-11-09T23:19:32.4512034Z -            storage.chain().get_height()
2025-11-09T23:19:32.4512165Z +            storage
2025-11-09T23:19:32.4512297Z +                .chain()
2025-11-09T23:19:32.4512431Z +                .get_height()
2025-11-09T23:19:32.4512802Z                  .map_err(|e| RpcError::internal_error(format!("Failed to get height: {}", e)))?
2025-11-09T23:19:32.4512936Z                  .unwrap_or(0)
2025-11-09T23:19:32.4513056Z          } else {
2025-11-09T23:19:32.4513483Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:59:
2025-11-09T23:19:32.4513619Z              0
2025-11-09T23:19:32.4513733Z          };
2025-11-09T23:19:32.4514090Z -        
2025-11-09T23:19:32.4514226Z +
2025-11-09T23:19:32.4514611Z          // Get mempool size
2025-11-09T23:19:32.4514867Z          let pooledtx = if let Some(ref mempool) = self.mempool {
2025-11-09T23:19:32.4515004Z              mempool.size()
2025-11-09T23:19:32.4515450Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:65:
2025-11-09T23:19:32.4515565Z          } else {
2025-11-09T23:19:32.4515675Z              0
2025-11-09T23:19:32.4515794Z          };
2025-11-09T23:19:32.4515906Z -        
2025-11-09T23:19:32.4516018Z +
2025-11-09T23:19:32.4516329Z          // Get difficulty from latest block's bits field (graceful degradation)
2025-11-09T23:19:32.4516582Z          let difficulty = if let Some(ref storage) = self.storage {
2025-11-09T23:19:32.4516849Z              if let Ok(Some(tip_header)) = storage.chain().get_tip_header() {
2025-11-09T23:19:32.4517305Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:78:
2025-11-09T23:19:32.4517614Z              tracing::debug!("Storage not available, using default difficulty");
2025-11-09T23:19:32.4517780Z              1.0 // Graceful fallback if no storage
2025-11-09T23:19:32.4517895Z          };
2025-11-09T23:19:32.4518012Z -        
2025-11-09T23:19:32.4518125Z +
2025-11-09T23:19:32.4518500Z          // Calculate network hashrate from recent block timestamps (graceful degradation)
2025-11-09T23:19:32.4518774Z          let networkhashps = if let Some(ref storage) = self.storage {
2025-11-09T23:19:32.4519065Z -            self.calculate_network_hashrate(storage).unwrap_or_else(|e| {
2025-11-09T23:19:32.4519404Z -                tracing::debug!("Failed to calculate network hashrate: {}, using 0.0", e);
2025-11-09T23:19:32.4519530Z -                0.0
2025-11-09T23:19:32.4519645Z -            })
2025-11-09T23:19:32.4520696Z +            self.calculate_network_hashrate(storage)
2025-11-09T23:19:32.4521100Z +                .unwrap_or_else(|e| {
2025-11-09T23:19:32.4521454Z +                    tracing::debug!("Failed to calculate network hashrate: {}, using 0.0", e);
2025-11-09T23:19:32.4521573Z +                    0.0
2025-11-09T23:19:32.4521680Z +                })
2025-11-09T23:19:32.4521798Z          } else {
2025-11-09T23:19:32.4522108Z              tracing::debug!("Storage not available, network hashrate unavailable");
2025-11-09T23:19:32.4522221Z              0.0
2025-11-09T23:19:32.4522659Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:91:
2025-11-09T23:19:32.4522767Z          };
2025-11-09T23:19:32.4522879Z -        
2025-11-09T23:19:32.4522989Z +
2025-11-09T23:19:32.4523194Z          // Get current block template info (if available)
2025-11-09T23:19:32.4523336Z          let currentblocksize = 0;
2025-11-09T23:19:32.4523480Z          let currentblockweight = 0;
2025-11-09T23:19:32.4523899Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:96:
2025-11-09T23:19:32.4524058Z          let currentblocktx = 0;
2025-11-09T23:19:32.4524172Z -        
2025-11-09T23:19:32.4524456Z +
2025-11-09T23:19:32.4533288Z          // Determine chain name from storage chain params
2025-11-09T23:19:32.4533544Z          let chain = if let Some(ref storage) = self.storage {
2025-11-09T23:19:32.4533763Z              if let Ok(Some(info)) = storage.chain().load_chain_info() {
2025-11-09T23:19:32.4534192Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:110:
2025-11-09T23:19:32.4534500Z          } else {
2025-11-09T23:19:32.4534631Z              "main" // Default
2025-11-09T23:19:32.4534740Z          };
2025-11-09T23:19:32.4534854Z -        
2025-11-09T23:19:32.4534955Z +
2025-11-09T23:19:32.4535064Z          Ok(json!({
2025-11-09T23:19:32.4535181Z              "blocks": blocks,
2025-11-09T23:19:32.4535352Z              "currentblocksize": currentblocksize,
2025-11-09T23:19:32.4535797Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:123:
2025-11-09T23:19:32.4536170Z              "warnings": ""
2025-11-09T23:19:32.4538240Z          }))
2025-11-09T23:19:32.4538357Z      }
2025-11-09T23:19:32.4538474Z -    
2025-11-09T23:19:32.4538587Z +
2025-11-09T23:19:32.4538740Z      /// Get block template
2025-11-09T23:19:32.4538847Z -    /// 
2025-11-09T23:19:32.4538958Z +    ///
2025-11-09T23:19:32.4539141Z      /// Params: [template_request (optional)]
2025-11-09T23:19:32.4539256Z -    /// 
2025-11-09T23:19:32.4539371Z +    ///
2025-11-09T23:19:32.4539786Z      /// Uses formally verified consensus-proof::mining::create_block_template() function
2025-11-09T23:19:32.4540131Z      /// which has Kani proofs ensuring correctness per Orange Paper Section 12.4
2025-11-09T23:19:32.4540463Z      pub async fn get_block_template(&self, params: &Value) -> RpcResult<Value> {
2025-11-09T23:19:32.4540913Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:134:
2025-11-09T23:19:32.4541100Z          debug!("RPC: getblocktemplate");
2025-11-09T23:19:32.4541222Z -        
2025-11-09T23:19:32.4541327Z +
2025-11-09T23:19:32.4541473Z          // 1. Get current chainstate
2025-11-09T23:19:32.4541665Z -        let height: Natural = self.get_current_height()?
2025-11-09T23:19:32.4541797Z +        let height: Natural = self
2025-11-09T23:19:32.4541921Z +            .get_current_height()?
2025-11-09T23:19:32.4542197Z              .ok_or_else(|| RpcError::internal_error("Chain not initialized"))?;
2025-11-09T23:19:32.4542361Z -        let prev_header = self.get_tip_header()?
2025-11-09T23:19:32.4542497Z +        let prev_header = self
2025-11-09T23:19:32.4542637Z +            .get_tip_header()?
2025-11-09T23:19:32.4542872Z              .ok_or_else(|| RpcError::internal_error("No chain tip"))?;
2025-11-09T23:19:32.4543102Z          let prev_headers = self.get_headers_for_difficulty()?;
2025-11-09T23:19:32.4543232Z -        
2025-11-09T23:19:32.4543346Z +
2025-11-09T23:19:32.4543754Z          // 2. Get mempool transactions
2025-11-09T23:19:32.4544076Z          let mempool_txs: Vec<Transaction> = self.get_mempool_transactions()?;
2025-11-09T23:19:32.4544202Z -        
2025-11-09T23:19:32.4544490Z +
2025-11-09T23:19:32.4544628Z          // 3. Get UTXO set
2025-11-09T23:19:32.4544806Z          let utxo_set = self.get_utxo_set()?;
2025-11-09T23:19:32.4544919Z -        
2025-11-09T23:19:32.4545025Z +
2025-11-09T23:19:32.4545282Z          // 4. Extract coinbase parameters from request or use defaults
2025-11-09T23:19:32.4545642Z          let coinbase_script = self.extract_coinbase_script(params).unwrap_or_default();
2025-11-09T23:19:32.4545999Z          let coinbase_address = self.extract_coinbase_address(params).unwrap_or_default();
2025-11-09T23:19:32.4546482Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:152:
2025-11-09T23:19:32.4546602Z -        
2025-11-09T23:19:32.4546706Z +
2025-11-09T23:19:32.4546932Z          // 5. Use formally verified function from consensus-proof
2025-11-09T23:19:32.4547274Z          // This function has Kani proofs: kani_create_block_template_completeness
2025-11-09T23:19:32.4547536Z          let template = match self.consensus.create_block_template(
2025-11-09T23:19:32.4547961Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:164:
2025-11-09T23:19:32.4550594Z              Ok(t) => t,
2025-11-09T23:19:32.4550751Z              Err(e) => {
2025-11-09T23:19:32.4550958Z                  warn!("Failed to create block template: {}", e);
2025-11-09T23:19:32.4551346Z -                return Err(RpcError::internal_error(format!("Template creation failed: {}", e)));
2025-11-09T23:19:32.4551555Z +                return Err(RpcError::internal_error(format!(
2025-11-09T23:19:32.4551713Z +                    "Template creation failed: {}",
2025-11-09T23:19:32.4551829Z +                    e
2025-11-09T23:19:32.4551933Z +                )));
2025-11-09T23:19:32.4552049Z              }
2025-11-09T23:19:32.4552166Z          };
2025-11-09T23:19:32.4552268Z -        
2025-11-09T23:19:32.4552648Z +
2025-11-09T23:19:32.4552858Z          // 6. Convert to JSON-RPC format (BIP 22/23)
2025-11-09T23:19:32.4553126Z          self.template_to_json_rpc(&template, &prev_header, height)
2025-11-09T23:19:32.4553244Z      }
2025-11-09T23:19:32.4553700Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:174:
2025-11-09T23:19:32.4553819Z -    
2025-11-09T23:19:32.4553932Z +
2025-11-09T23:19:32.4554125Z      /// Convert BlockTemplate to JSON-RPC format
2025-11-09T23:19:32.4554266Z      fn template_to_json_rpc(
2025-11-09T23:19:32.4554581Z          &self,
2025-11-09T23:19:32.4555106Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:181:
2025-11-09T23:19:32.4555389Z      ) -> RpcResult<Value> {
2025-11-09T23:19:32.4555600Z          // Convert previous block hash to hex (big-endian)
2025-11-09T23:19:32.4555874Z          let prev_hash_hex = hex::encode(prev_header.prev_block_hash);
2025-11-09T23:19:32.4556015Z -        
2025-11-09T23:19:32.4556138Z +
2025-11-09T23:19:32.4556503Z          // Convert target to hex (64 characters, big-endian)
2025-11-09T23:19:32.4556790Z          let target_hex = format!("{:064x}", template.target);
2025-11-09T23:19:32.4556902Z -        
2025-11-09T23:19:32.4557007Z +
2025-11-09T23:19:32.4557173Z          // Convert bits to hex (8 characters)
2025-11-09T23:19:32.4557399Z          let bits_hex = format!("{:08x}", template.header.bits);
2025-11-09T23:19:32.4557507Z -        
2025-11-09T23:19:32.4557607Z +
2025-11-09T23:19:32.4557762Z          // Convert transactions to JSON array
2025-11-09T23:19:32.4557996Z -        let transactions_json: Vec<Value> = template.transactions
2025-11-09T23:19:32.4558228Z +        let transactions_json: Vec<Value> = template
2025-11-09T23:19:32.4558355Z +            .transactions
2025-11-09T23:19:32.4558542Z              .iter()
2025-11-09T23:19:32.4558704Z              .map(|tx| self.transaction_to_json(tx))
2025-11-09T23:19:32.4559102Z              .collect();
2025-11-09T23:19:32.4560187Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:196:
2025-11-09T23:19:32.4560301Z -        
2025-11-09T23:19:32.4560400Z +
2025-11-09T23:19:32.4560571Z          // Calculate coinbase value (subsidy + fees)
2025-11-09T23:19:32.4560889Z          let coinbase_value = self.calculate_coinbase_value(template, height);
2025-11-09T23:19:32.4560997Z -        
2025-11-09T23:19:32.4561098Z +
2025-11-09T23:19:32.4561259Z          // Get active rules (BIP 9 feature flags)
2025-11-09T23:19:32.4561410Z          let rules = self.get_active_rules(height);
2025-11-09T23:19:32.4561512Z -        
2025-11-09T23:19:32.4561625Z +
2025-11-09T23:19:32.4561831Z          // Get minimum time (median time + 1)
2025-11-09T23:19:32.4562003Z          let min_time = self.get_min_time(height);
2025-11-09T23:19:32.4562117Z -        
2025-11-09T23:19:32.4562231Z +
2025-11-09T23:19:32.4562356Z          Ok(json!({
2025-11-09T23:19:32.4562526Z              "capabilities": ["proposal"],
2025-11-09T23:19:32.4562718Z              "version": template.header.version as i32,
2025-11-09T23:19:32.4563204Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:228:
2025-11-09T23:19:32.4563343Z              "height": template.height
2025-11-09T23:19:32.4563445Z          }))
2025-11-09T23:19:32.4563553Z      }
2025-11-09T23:19:32.4563653Z -    
2025-11-09T23:19:32.4563762Z +
2025-11-09T23:19:32.4563951Z      // Helper methods - access chainstate and mempool
2025-11-09T23:19:32.4564061Z -    
2025-11-09T23:19:32.4564159Z +
2025-11-09T23:19:32.4564569Z      fn get_current_height(&self) -> RpcResult<Option<Natural>> {
2025-11-09T23:19:32.4564731Z          if let Some(ref storage) = self.storage {
2025-11-09T23:19:32.4564870Z -            storage.chain().get_height()
2025-11-09T23:19:32.4564978Z +            storage
2025-11-09T23:19:32.4565101Z +                .chain()
2025-11-09T23:19:32.4565230Z +                .get_height()
2025-11-09T23:19:32.4565839Z                  .map_err(|e| RpcError::internal_error(format!("Failed to get height: {}", e)))
2025-11-09T23:19:32.4565948Z          } else {
2025-11-09T23:19:32.4566061Z              Ok(None)
2025-11-09T23:19:32.4566486Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:240:
2025-11-09T23:19:32.4566593Z          }
2025-11-09T23:19:32.4566704Z      }
2025-11-09T23:19:32.4566801Z -    
2025-11-09T23:19:32.4566897Z +
2025-11-09T23:19:32.4567117Z      fn get_tip_header(&self) -> RpcResult<Option<BlockHeader>> {
2025-11-09T23:19:32.4567286Z          if let Some(ref storage) = self.storage {
2025-11-09T23:19:32.4567442Z -            storage.chain().get_tip_header()
2025-11-09T23:19:32.4567556Z +            storage
2025-11-09T23:19:32.4567671Z +                .chain()
2025-11-09T23:19:32.4567791Z +                .get_tip_header()
2025-11-09T23:19:32.4568123Z                  .map_err(|e| RpcError::internal_error(format!("Failed to get tip header: {}", e)))
2025-11-09T23:19:32.4568248Z          } else {
2025-11-09T23:19:32.4568383Z              Ok(None)
2025-11-09T23:19:32.4568774Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:249:
2025-11-09T23:19:32.4568874Z          }
2025-11-09T23:19:32.4568984Z      }
2025-11-09T23:19:32.4569084Z -    
2025-11-09T23:19:32.4569180Z +
2025-11-09T23:19:32.4569446Z      fn get_headers_for_difficulty(&self) -> RpcResult<Vec<BlockHeader>> {
2025-11-09T23:19:32.4569607Z          if let Some(ref storage) = self.storage {
2025-11-09T23:19:32.4569806Z              // Get last 2016 headers for difficulty adjustment
2025-11-09T23:19:32.4570236Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:255:
2025-11-09T23:19:32.4570549Z              // For now, return just the tip (full implementation would get last 2016)
2025-11-09T23:19:32.4570765Z -            if let Some(tip) = storage.chain().get_tip_header()
2025-11-09T23:19:32.4571127Z +            if let Some(tip) = storage
2025-11-09T23:19:32.4571258Z +                .chain()
2025-11-09T23:19:32.4571389Z +                .get_tip_header()
2025-11-09T23:19:32.4571707Z                  .map_err(|e| RpcError::internal_error(format!("Failed to get tip: {}", e)))?
2025-11-09T23:19:32.4571829Z              {
2025-11-09T23:19:32.4571965Z                  Ok(vec![tip])
2025-11-09T23:19:32.4572396Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:264:
2025-11-09T23:19:32.4572523Z              Ok(vec![])
2025-11-09T23:19:32.4572647Z          }
2025-11-09T23:19:32.4572757Z      }
2025-11-09T23:19:32.4572866Z -    
2025-11-09T23:19:32.4572986Z +
2025-11-09T23:19:32.4573285Z      fn get_mempool_transactions(&self) -> RpcResult<Vec<Transaction>> {
2025-11-09T23:19:32.4573460Z          if let Some(ref mempool) = self.mempool {
2025-11-09T23:19:32.4573616Z              // Get UTXO set for fee calculation
2025-11-09T23:19:32.4574055Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:271:
2025-11-09T23:19:32.4574235Z              let utxo_set = self.get_utxo_set()?;
2025-11-09T23:19:32.4574566Z -            
2025-11-09T23:19:32.4574688Z +
2025-11-09T23:19:32.4575068Z              // Get prioritized transactions (limit to reasonable number for block template)
2025-11-09T23:19:32.4575254Z              let limit = 1000;
2025-11-09T23:19:32.4575558Z              Ok(mempool.get_prioritized_transactions(limit, &utxo_set))
2025-11-09T23:19:32.4575998Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:277:
2025-11-09T23:19:32.4576121Z              Ok(vec![])
2025-11-09T23:19:32.4576233Z          }
2025-11-09T23:19:32.4576353Z      }
2025-11-09T23:19:32.4576462Z -    
2025-11-09T23:19:32.4576566Z +
2025-11-09T23:19:32.4576812Z      /// Calculate difficulty from bits (compact target format)
2025-11-09T23:19:32.4577084Z      /// Uses the same logic as BlockchainRpc::calculate_difficulty
2025-11-09T23:19:32.4577278Z      fn calculate_difficulty(bits: u64) -> f64 {
2025-11-09T23:19:32.4577945Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:284:
2025-11-09T23:19:32.4578134Z          // Difficulty = MAX_TARGET / target
2025-11-09T23:19:32.4578585Z          // MAX_TARGET for Bitcoin mainnet is 0x00000000FFFF0000000000000000000000000000000000000000000000000000
2025-11-09T23:19:32.4578862Z          // For display purposes, we normalize to genesis difficulty = 1.0
2025-11-09T23:19:32.4579373Z -        const MAX_TARGET: u128 = 0x00000000FFFF0000000000000000000000000000000000000000000000000000u128;
2025-11-09T23:19:32.4579489Z -        
2025-11-09T23:19:32.4579620Z +        const MAX_TARGET: u128 =
2025-11-09T23:19:32.4579921Z +            0x00000000FFFF0000000000000000000000000000000000000000000000000000u128;
2025-11-09T23:19:32.4580021Z +
2025-11-09T23:19:32.4580240Z          // Simplified difficulty calculation using bits directly
2025-11-09T23:19:32.4580531Z          // For display purposes, use a simple approximation based on bits
2025-11-09T23:19:32.4580719Z          let mantissa = (bits & 0x00ffffff) as f64;
2025-11-09T23:19:32.4581131Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:295:
2025-11-09T23:19:32.4581278Z          let max_mantissa = 0x00ffff00 as f64;
2025-11-09T23:19:32.4581425Z          (max_mantissa / mantissa).max(1.0)
2025-11-09T23:19:32.4581529Z      }
2025-11-09T23:19:32.4581630Z -    
2025-11-09T23:19:32.4581729Z +
2025-11-09T23:19:32.4581955Z      /// Calculate network hashrate from recent block timestamps
2025-11-09T23:19:32.4582208Z      /// Estimates hashrate based on the time between recent blocks
2025-11-09T23:19:32.4582611Z      fn calculate_network_hashrate(&self, storage: &Storage) -> Result<f64, anyhow::Error> {
2025-11-09T23:19:32.4583048Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:302:
2025-11-09T23:19:32.4583183Z          // Get tip height
2025-11-09T23:19:32.4583602Z -        let tip_height = storage.chain().get_height()?
2025-11-09T23:19:32.4583753Z +        let tip_height = storage
2025-11-09T23:19:32.4583870Z +            .chain()
2025-11-09T23:19:32.4583997Z +            .get_height()?
2025-11-09T23:19:32.4584233Z              .ok_or_else(|| anyhow::anyhow!("Chain not initialized"))?;
2025-11-09T23:19:32.4584527Z -        
2025-11-09T23:19:32.4584643Z +
2025-11-09T23:19:32.4584838Z          // Need at least 2 blocks to calculate hashrate
2025-11-09T23:19:32.4584982Z          if tip_height < 1 {
2025-11-09T23:19:32.4585108Z              return Ok(0.0);
2025-11-09T23:19:32.4585532Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:309:
2025-11-09T23:19:32.4585646Z          }
2025-11-09T23:19:32.4585765Z -        
2025-11-09T23:19:32.4585875Z +
2025-11-09T23:19:32.4586114Z          // Get last 144 blocks (approximately 1 day at 10 min/block)
2025-11-09T23:19:32.4586293Z          // Or use fewer blocks if chain is shorter
2025-11-09T23:19:32.4586475Z          let num_blocks = (tip_height + 1).min(144);
2025-11-09T23:19:32.4586924Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:314:
2025-11-09T23:19:32.4587205Z          let start_height = tip_height.saturating_sub(num_blocks - 1);
2025-11-09T23:19:32.4587317Z -        
2025-11-09T23:19:32.4587428Z +
2025-11-09T23:19:32.4587585Z          // Get timestamps from blocks
2025-11-09T23:19:32.4587764Z          let mut timestamps = Vec::new();
2025-11-09T23:19:32.4587941Z          for height in start_height..=tip_height {
2025-11-09T23:19:32.4588376Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:322:
2025-11-09T23:19:32.4588502Z                  }
2025-11-09T23:19:32.4588616Z              }
2025-11-09T23:19:32.4588729Z          }
2025-11-09T23:19:32.4588838Z -        
2025-11-09T23:19:32.4588954Z +
2025-11-09T23:19:32.4589102Z          if timestamps.len() < 2 {
2025-11-09T23:19:32.4589236Z              return Ok(0.0);
2025-11-09T23:19:32.4589367Z          }
2025-11-09T23:19:32.4590017Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:329:
2025-11-09T23:19:32.4590137Z -        
2025-11-09T23:19:32.4590250Z +
2025-11-09T23:19:32.4590436Z          // Calculate average time between blocks
2025-11-09T23:19:32.4590609Z          let first_timestamp = timestamps[0].1;
2025-11-09T23:19:32.4590854Z          let last_timestamp = timestamps[timestamps.len() - 1].1;
2025-11-09T23:19:32.4591263Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:333:
2025-11-09T23:19:32.4591508Z          let time_span = last_timestamp.saturating_sub(first_timestamp);
2025-11-09T23:19:32.4591669Z          let num_intervals = timestamps.len() - 1;
2025-11-09T23:19:32.4591794Z -        
2025-11-09T23:19:32.4591910Z +
2025-11-09T23:19:32.4592081Z          if time_span == 0 || num_intervals == 0 {
2025-11-09T23:19:32.4592217Z              return Ok(0.0);
2025-11-09T23:19:32.4592350Z          }
2025-11-09T23:19:32.4592789Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:339:
2025-11-09T23:19:32.4592908Z -        
2025-11-09T23:19:32.4593024Z +
2025-11-09T23:19:32.4593290Z          let avg_time_per_block = time_span as f64 / num_intervals as f64;
2025-11-09T23:19:32.4593402Z -        
2025-11-09T23:19:32.4593516Z +
2025-11-09T23:19:32.4593678Z          // Get difficulty from tip block
2025-11-09T23:19:32.4593941Z -        let tip_hash = storage.blocks().get_hash_by_height(tip_height)?
2025-11-09T23:19:32.4594079Z +        let tip_hash = storage
2025-11-09T23:19:32.4594211Z +            .blocks()
2025-11-09T23:19:32.4594548Z +            .get_hash_by_height(tip_height)?
2025-11-09T23:19:32.4594783Z              .ok_or_else(|| anyhow::anyhow!("Tip block not found"))?;
2025-11-09T23:19:32.4595008Z -        let tip_block = storage.blocks().get_block(&tip_hash)?
2025-11-09T23:19:32.4595152Z +        let tip_block = storage
2025-11-09T23:19:32.4595501Z +            .blocks()
2025-11-09T23:19:32.4595644Z +            .get_block(&tip_hash)?
2025-11-09T23:19:32.4595871Z              .ok_or_else(|| anyhow::anyhow!("Tip block not found"))?;
2025-11-09T23:19:32.4596174Z          let difficulty = Self::calculate_difficulty(tip_block.header.bits);
2025-11-09T23:19:32.4596291Z -        
2025-11-09T23:19:32.4598311Z +
2025-11-09T23:19:32.4598576Z          // Calculate hashrate: difficulty * 2^32 / avg_time_per_block
2025-11-09T23:19:32.4598823Z          // This estimates the network hashrate in hashes per second
2025-11-09T23:19:32.4599169Z          // 2^32 is the number of hashes needed on average to find a block at difficulty 1.0
2025-11-09T23:19:32.4599633Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:352:
2025-11-09T23:19:32.4599857Z          const HASHES_PER_DIFFICULTY: f64 = 4294967296.0; // 2^32
2025-11-09T23:19:32.4600184Z          let hashrate = (difficulty * HASHES_PER_DIFFICULTY) / avg_time_per_block;
2025-11-09T23:19:32.4600324Z -        
2025-11-09T23:19:32.4600431Z +
2025-11-09T23:19:32.4600563Z          Ok(hashrate)
2025-11-09T23:19:32.4600680Z      }
2025-11-09T23:19:32.4600801Z -    
2025-11-09T23:19:32.4600914Z +
2025-11-09T23:19:32.4601376Z      fn get_utxo_set(&self) -> RpcResult<UtxoSet> {
2025-11-09T23:19:32.4601565Z          if let Some(ref storage) = self.storage {
2025-11-09T23:19:32.4601718Z              // Get UTXO set from storage
2025-11-09T23:19:32.4602154Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:361:
2025-11-09T23:19:32.4602321Z -            storage.utxos().get_all_utxos()
2025-11-09T23:19:32.4602437Z +            storage
2025-11-09T23:19:32.4602565Z +                .utxos()
2025-11-09T23:19:32.4602706Z +                .get_all_utxos()
2025-11-09T23:19:32.4603060Z                  .map_err(|e| RpcError::internal_error(format!("Failed to get UTXO set: {}", e)))
2025-11-09T23:19:32.4603168Z          } else {
2025-11-09T23:19:32.4603311Z              Ok(UtxoSet::new())
2025-11-09T23:19:32.4603941Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:365:
2025-11-09T23:19:32.4604061Z          }
2025-11-09T23:19:32.4604175Z      }
2025-11-09T23:19:32.4604550Z -    
2025-11-09T23:19:32.4604676Z +
2025-11-09T23:19:32.4605033Z      fn extract_coinbase_script(&self, params: &Value) -> Option<ByteString> {
2025-11-09T23:19:32.4605257Z          // Extract coinbase script from params if provided
2025-11-09T23:19:32.4605460Z          if let Some(template_request) = params.get(0) {
2025-11-09T23:19:32.4605948Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:379:
2025-11-09T23:19:32.4606085Z          // Default: empty script
2025-11-09T23:19:32.4606210Z          Some(vec![])
2025-11-09T23:19:32.4606318Z      }
2025-11-09T23:19:32.4606422Z -    
2025-11-09T23:19:32.4606529Z +
2025-11-09T23:19:32.4606861Z      fn extract_coinbase_address(&self, params: &Value) -> Option<ByteString> {
2025-11-09T23:19:32.4607089Z          // Extract coinbase address from params if provided
2025-11-09T23:19:32.4607286Z          if let Some(template_request) = params.get(0) {
2025-11-09T23:19:32.4607700Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:393:
2025-11-09T23:19:32.4607823Z          // Default: empty
2025-11-09T23:19:32.4607941Z          Some(vec![])
2025-11-09T23:19:32.4608058Z      }
2025-11-09T23:19:32.4608160Z -    
2025-11-09T23:19:32.4608261Z +
2025-11-09T23:19:32.4610795Z      fn transaction_to_json(&self, tx: &Transaction) -> Value {
2025-11-09T23:19:32.4610966Z          // Convert transaction to JSON-RPC format
2025-11-09T23:19:32.4611129Z          let tx_bytes = serialize_transaction(tx);
2025-11-09T23:19:32.4611555Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:401:
2025-11-09T23:19:32.4611761Z          let fee = self.calculate_transaction_fee(tx);
2025-11-09T23:19:32.4611926Z          let sigops = self.count_sigops(tx);
2025-11-09T23:19:32.4612353Z          let weight = self.calculate_weight(tx);
2025-11-09T23:19:32.4612490Z -        
2025-11-09T23:19:32.4612600Z +
2025-11-09T23:19:32.4612715Z          json!({
2025-11-09T23:19:32.4612878Z              "data": hex::encode(&tx_bytes),
2025-11-09T23:19:32.4613044Z              "txid": hex::encode(tx_hash),
2025-11-09T23:19:32.4613501Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:410:
2025-11-09T23:19:32.4613640Z              "weight": weight,
2025-11-09T23:19:32.4613762Z          })
2025-11-09T23:19:32.4613873Z      }
2025-11-09T23:19:32.4613980Z -    
2025-11-09T23:19:32.4614085Z +
2025-11-09T23:19:32.4614507Z      fn calculate_tx_hash(&self, tx_bytes: &[u8]) -> [u8; 32] {
2025-11-09T23:19:32.4614808Z          // Transaction hash is double SHA256 of transaction bytes
2025-11-09T23:19:32.4614979Z          let hash1 = Sha256::digest(tx_bytes);
2025-11-09T23:19:32.4615425Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:417:
2025-11-09T23:19:32.4615608Z          let hash2 = Sha256::digest(hash1);
2025-11-09T23:19:32.4615723Z -        
2025-11-09T23:19:32.4615841Z +
2025-11-09T23:19:32.4615976Z          let mut result = [0u8; 32];
2025-11-09T23:19:32.4616127Z          result.copy_from_slice(&hash2);
2025-11-09T23:19:32.4616242Z          result
2025-11-09T23:19:32.4616678Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:422:
2025-11-09T23:19:32.4616795Z      }
2025-11-09T23:19:32.4616898Z -    
2025-11-09T23:19:32.4617020Z +
2025-11-09T23:19:32.4617296Z      fn calculate_transaction_fee(&self, tx: &Transaction) -> u64 {
2025-11-09T23:19:32.4617510Z          // Use MempoolManager's fee calculation if available
2025-11-09T23:19:32.4617681Z          if let Some(ref mempool) = self.mempool {
2025-11-09T23:19:32.4618127Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:447:
2025-11-09T23:19:32.4618242Z              0
2025-11-09T23:19:32.4618362Z          }
2025-11-09T23:19:32.4618468Z      }
2025-11-09T23:19:32.4618766Z -    
2025-11-09T23:19:32.4618881Z +
2025-11-09T23:19:32.4619093Z      fn count_sigops(&self, tx: &Transaction) -> u32 {
2025-11-09T23:19:32.4619280Z          // Use consensus layer sigop counting
2025-11-09T23:19:32.4619412Z          #[cfg(feature = "sigop")]
2025-11-09T23:19:32.4619811Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:456:
2025-11-09T23:19:32.4620075Z              // Convert protocol transaction to consensus transaction format
2025-11-09T23:19:32.4620230Z              let consensus_tx = ConsensusTx {
2025-11-09T23:19:32.4620376Z                  version: tx.version,
2025-11-09T23:19:32.4622685Z -                inputs: tx.inputs.iter().map(|inp| bllvm_protocol::TransactionInput {
2025-11-09T23:19:32.4622871Z -                    prevout: bllvm_protocol::OutPoint {
2025-11-09T23:19:32.4623036Z -                        hash: inp.prevout.hash,
2025-11-09T23:19:32.4623206Z -                        index: inp.prevout.index,
2025-11-09T23:19:32.4623349Z -                    },
2025-11-09T23:19:32.4623520Z -                    script_sig: inp.script_sig.clone(),
2025-11-09T23:19:32.4623676Z -                    sequence: inp.sequence,
2025-11-09T23:19:32.4623817Z -                }).collect(),
2025-11-09T23:19:32.4624159Z -                outputs: tx.outputs.iter().map(|out| bllvm_protocol::TransactionOutput {
2025-11-09T23:19:32.4624485Z -                    value: out.value,
2025-11-09T23:19:32.4624680Z -                    script_pubkey: out.script_pubkey.clone(),
2025-11-09T23:19:32.4624819Z -                }).collect(),
2025-11-09T23:19:32.4624949Z +                inputs: tx
2025-11-09T23:19:32.4625071Z +                    .inputs
2025-11-09T23:19:32.4625199Z +                    .iter()
2025-11-09T23:19:32.4625409Z +                    .map(|inp| bllvm_protocol::TransactionInput {
2025-11-09T23:19:32.4625591Z +                        prevout: bllvm_protocol::OutPoint {
2025-11-09T23:19:32.4626009Z +                            hash: inp.prevout.hash,
2025-11-09T23:19:32.4626181Z +                            index: inp.prevout.index,
2025-11-09T23:19:32.4626299Z +                        },
2025-11-09T23:19:32.4626477Z +                        script_sig: inp.script_sig.clone(),
2025-11-09T23:19:32.4626639Z +                        sequence: inp.sequence,
2025-11-09T23:19:32.4626758Z +                    })
2025-11-09T23:19:32.4626889Z +                    .collect(),
2025-11-09T23:19:32.4627028Z +                outputs: tx
2025-11-09T23:19:32.4627156Z +                    .outputs
2025-11-09T23:19:32.4627279Z +                    .iter()
2025-11-09T23:19:32.4627485Z +                    .map(|out| bllvm_protocol::TransactionOutput {
2025-11-09T23:19:32.4627625Z +                        value: out.value,
2025-11-09T23:19:32.4627795Z +                        script_pubkey: out.script_pubkey.clone(),
2025-11-09T23:19:32.4627898Z +                    })
2025-11-09T23:19:32.4628037Z +                    .collect(),
2025-11-09T23:19:32.4628178Z                  lock_time: tx.lock_time,
2025-11-09T23:19:32.4628281Z              };
2025-11-09T23:19:32.4628475Z              use bllvm_protocol::sigop::get_legacy_sigop_count;
2025-11-09T23:19:32.4628911Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:480:
2025-11-09T23:19:32.4629060Z              for output in &tx.outputs {
2025-11-09T23:19:32.4629233Z                  for &byte in &output.script_pubkey {
2025-11-09T23:19:32.4629377Z                      match byte {
2025-11-09T23:19:32.4629547Z -                        0xac => count += 1, // OP_CHECKSIG
2025-11-09T23:19:32.4629723Z -                        0xad => count += 1, // OP_CHECKSIGVERIFY
2025-11-09T23:19:32.4629905Z -                        0xae => count += 1, // OP_CHECKMULTISIG
2025-11-09T23:19:32.4630066Z +                        0xac => count += 1,  // OP_CHECKSIG
2025-11-09T23:19:32.4632228Z +                        0xad => count += 1,  // OP_CHECKSIGVERIFY
2025-11-09T23:19:32.4632622Z +                        0xae => count += 1,  // OP_CHECKMULTISIG
2025-11-09T23:19:32.4632833Z                          0xaf => count += 20, // OP_CHECKMULTISIGVERIFY
2025-11-09T23:19:32.4632955Z                          _ => {}
2025-11-09T23:19:32.4633071Z                      }
2025-11-09T23:19:32.4633514Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:491:
2025-11-09T23:19:32.4633632Z              count
2025-11-09T23:19:32.4633745Z          }
2025-11-09T23:19:32.4633863Z      }
2025-11-09T23:19:32.4633971Z -    
2025-11-09T23:19:32.4634080Z +
2025-11-09T23:19:32.4634488Z      fn calculate_weight(&self, tx: &Transaction) -> u64 {
2025-11-09T23:19:32.4634883Z          // Transaction weight = (base_size * 3) + total_size (for SegWit)
2025-11-09T23:19:32.4635108Z          // For now, return base size * 4 (non-SegWit transaction)
2025-11-09T23:19:32.4635544Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:498:
2025-11-09T23:19:32.4635796Z          let base_size = serialize_transaction(tx).len() as u64;
2025-11-09T23:19:32.4635917Z          base_size * 4
2025-11-09T23:19:32.4636029Z      }
2025-11-09T23:19:32.4636144Z -    
2025-11-09T23:19:32.4636246Z +
2025-11-09T23:19:32.4636646Z      fn calculate_coinbase_value(&self, template: &BlockTemplate, _height: Natural) -> u64 {
2025-11-09T23:19:32.4636901Z          // Use consensus-proof's get_block_subsidy (formally verified)
2025-11-09T23:19:32.4637219Z          let subsidy = self.consensus.get_block_subsidy(template.height) as u64;
2025-11-09T23:19:32.4637650Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:505:
2025-11-09T23:19:32.4637758Z -        
2025-11-09T23:19:32.4637868Z +
2025-11-09T23:19:32.4638030Z          // Calculate total fees from transactions
2025-11-09T23:19:32.4638189Z -        let fees: u64 = template.transactions
2025-11-09T23:19:32.4638320Z +        let fees: u64 = template
2025-11-09T23:19:32.4638654Z +            .transactions
2025-11-09T23:19:32.4638769Z              .iter()
2025-11-09T23:19:32.4638957Z              .map(|tx| self.calculate_transaction_fee(tx))
2025-11-09T23:19:32.4639073Z              .sum();
2025-11-09T23:19:32.4639489Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:511:
2025-11-09T23:19:32.4639598Z -        
2025-11-09T23:19:32.4639701Z +
2025-11-09T23:19:32.4639827Z          subsidy + fees
2025-11-09T23:19:32.4639932Z      }
2025-11-09T23:19:32.4640036Z -    
2025-11-09T23:19:32.4640146Z +
2025-11-09T23:19:32.4640382Z      fn get_active_rules(&self, height: Natural) -> Vec<String> {
2025-11-09T23:19:32.4640979Z          // Determine active BIP 9 rules based on height
2025-11-09T23:19:32.4641270Z          let mut rules = vec!["csv".to_string()]; // CSV always active after height
2025-11-09T23:19:32.4641703Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:518:
2025-11-09T23:19:32.4641824Z -        
2025-11-09T23:19:32.4642032Z -        if height >= 481824 { // SegWit activation (mainnet)
2025-11-09T23:19:32.4642144Z +
2025-11-09T23:19:32.4642269Z +        if height >= 481824 {
2025-11-09T23:19:32.4642429Z +            // SegWit activation (mainnet)
2025-11-09T23:19:32.4642614Z              rules.push("segwit".to_string());
2025-11-09T23:19:32.4642747Z          }
2025-11-09T23:19:32.4642865Z -        
2025-11-09T23:19:32.4643065Z -        if height >= 709632 { // Taproot activation (mainnet)
2025-11-09T23:19:32.4643177Z +
2025-11-09T23:19:32.4643302Z +        if height >= 709632 {
2025-11-09T23:19:32.4643452Z +            // Taproot activation (mainnet)
2025-11-09T23:19:32.4643616Z              rules.push("taproot".to_string());
2025-11-09T23:19:32.4643723Z          }
2025-11-09T23:19:32.4643828Z -        
2025-11-09T23:19:32.4643932Z +
2025-11-09T23:19:32.4644049Z          rules
2025-11-09T23:19:32.4644154Z      }
2025-11-09T23:19:32.4644258Z -    
2025-11-09T23:19:32.4644539Z +
2025-11-09T23:19:32.4644748Z      fn get_min_time(&self, _height: Natural) -> Natural {
2025-11-09T23:19:32.4645234Z          // Get minimum time (median time of last 11 blocks + 1)
2025-11-09T23:19:32.4645384Z          // For now, return current time
2025-11-09T23:19:32.4645819Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:535:
2025-11-09T23:19:32.4645934Z              .unwrap()
2025-11-09T23:19:32.4646065Z              .as_secs() as Natural
2025-11-09T23:19:32.4646176Z      }
2025-11-09T23:19:32.4646281Z -    
2025-11-09T23:19:32.4646389Z +
2025-11-09T23:19:32.4646535Z      /// Submit a block to the network
2025-11-09T23:19:32.4646657Z -    /// 
2025-11-09T23:19:32.4646769Z +    ///
2025-11-09T23:19:32.4646912Z      /// Params: ["hexdata", "dummy"]
2025-11-09T23:19:32.4647211Z      pub async fn submit_block(&self, params: &Value) -> RpcResult<Value> {
2025-11-09T23:19:32.4647348Z          debug!("RPC: submitblock");
2025-11-09T23:19:32.4647774Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:544:
2025-11-09T23:19:32.4647903Z -        
2025-11-09T23:19:32.4648055Z -        let hex_data = params.get(0)
2025-11-09T23:19:32.4648163Z +
2025-11-09T23:19:32.4648297Z +        let hex_data = params
2025-11-09T23:19:32.4648416Z +            .get(0)
2025-11-09T23:19:32.4648561Z              .and_then(|p| p.as_str())
2025-11-09T23:19:32.4648865Z              .ok_or_else(|| RpcError::invalid_params("Missing hexdata parameter"))?;
2025-11-09T23:19:32.4649027Z -        
2025-11-09T23:19:32.4649137Z +
2025-11-09T23:19:32.4649253Z          // Decode hex
2025-11-09T23:19:32.4649416Z          let block_bytes = hex::decode(hex_data)
2025-11-09T23:19:32.4649735Z              .map_err(|e| RpcError::invalid_params(format!("Invalid hex data: {}", e)))?;
2025-11-09T23:19:32.4650149Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:552:
2025-11-09T23:19:32.4650256Z -        
2025-11-09T23:19:32.4650359Z +
2025-11-09T23:19:32.4650690Z          // Deserialize block
2025-11-09T23:19:32.4650991Z          let (block, witnesses) = deserialize_block_with_witnesses(&block_bytes)
2025-11-09T23:19:32.4651363Z              .map_err(|e| RpcError::invalid_params(format!("Failed to deserialize block: {}", e)))?;
2025-11-09T23:19:32.4651786Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:556:
2025-11-09T23:19:32.4651893Z -        
2025-11-09T23:19:32.4651998Z +
2025-11-09T23:19:32.4652140Z          // Get current chain state
2025-11-09T23:19:32.4652298Z -        let height = self.get_current_height()?
2025-11-09T23:19:32.4652426Z +        let height = self
2025-11-09T23:19:32.4652613Z +            .get_current_height()?
2025-11-09T23:19:32.4652886Z              .ok_or_else(|| RpcError::internal_error("Chain not initialized"))?;
2025-11-09T23:19:32.4653037Z          let utxo_set = self.get_utxo_set()?;
2025-11-09T23:19:32.4653142Z -        
2025-11-09T23:19:32.4653259Z +
2025-11-09T23:19:32.4653427Z          // Validate block using consensus layer
2025-11-09T23:19:32.4653783Z          // Note: This validates consensus rules, but doesn't check if block extends chain
2025-11-09T23:19:32.4653945Z          // In production, would also check:
2025-11-09T23:19:32.4654520Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:572:
2025-11-09T23:19:32.4654699Z                  debug!("Block submitted successfully");
2025-11-09T23:19:32.4654827Z                  Ok(json!(null))
2025-11-09T23:19:32.4654946Z              }
2025-11-09T23:19:32.4655140Z -            Ok((ValidationResult::Invalid(reason), _)) => {
2025-11-09T23:19:32.4655435Z -                Err(RpcError::invalid_params(format!("Invalid block: {}", reason)))
2025-11-09T23:19:32.4655573Z -            }
2025-11-09T23:19:32.4655702Z -            Err(e) => {
2025-11-09T23:19:32.4656007Z -                Err(RpcError::internal_error(format!("Validation error: {}", e)))
2025-11-09T23:19:32.4656132Z -            }
2025-11-09T23:19:32.4656730Z +            Ok((ValidationResult::Invalid(reason), _)) => Err(RpcError::invalid_params(format!(
2025-11-09T23:19:32.4656880Z +                "Invalid block: {}",
2025-11-09T23:19:32.4657009Z +                reason
2025-11-09T23:19:32.4657124Z +            ))),
2025-11-09T23:19:32.4657445Z +            Err(e) => Err(RpcError::internal_error(format!("Validation error: {}", e))),
2025-11-09T23:19:32.4657566Z          }
2025-11-09T23:19:32.4657679Z      }
2025-11-09T23:19:32.4658138Z -    
2025-11-09T23:19:32.4658259Z +
2025-11-09T23:19:32.4658410Z      /// Estimate smart fee rate
2025-11-09T23:19:32.4658526Z -    /// 
2025-11-09T23:19:32.4658642Z +    ///
2025-11-09T23:19:32.4659075Z      /// Params: [conf_target (optional, default: 6), estimate_mode (optional, default: "conservative")]
2025-11-09T23:19:32.4659397Z      pub async fn estimate_smart_fee(&self, params: &Value) -> RpcResult<Value> {
2025-11-09T23:19:32.4659548Z          debug!("RPC: estimatesmartfee");
2025-11-09T23:19:32.4660002Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:589:
2025-11-09T23:19:32.4660119Z -        
2025-11-09T23:19:32.4660276Z -        let conf_target = params.get(0)
2025-11-09T23:19:32.4660734Z -            .and_then(|p| p.as_u64())
2025-11-09T23:19:32.4660884Z -            .unwrap_or(6);
2025-11-09T23:19:32.4660996Z -        
2025-11-09T23:19:32.4661158Z -        let estimate_mode = params.get(1)
2025-11-09T23:19:32.4661271Z +
2025-11-09T23:19:32.4661595Z +        let conf_target = params.get(0).and_then(|p| p.as_u64()).unwrap_or(6);
2025-11-09T23:19:32.4661709Z +
2025-11-09T23:19:32.4661860Z +        let estimate_mode = params
2025-11-09T23:19:32.4661993Z +            .get(1)
2025-11-09T23:19:32.4662146Z              .and_then(|p| p.as_str())
2025-11-09T23:19:32.4662309Z              .unwrap_or("conservative");
2025-11-09T23:19:32.4662418Z -        
2025-11-09T23:19:32.4662536Z +
2025-11-09T23:19:32.4662680Z          // Validate estimate_mode
2025-11-09T23:19:32.4663078Z          match estimate_mode {
2025-11-09T23:19:32.4663293Z              "unset" | "economical" | "conservative" => {}
2025-11-09T23:19:32.4663746Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:601:
2025-11-09T23:19:32.4664662Z -            _ => return Err(RpcError::invalid_params(format!("Invalid estimate_mode: {}. Must be 'unset', 'economical', or 'conservative'", estimate_mode)))
2025-11-09T23:19:32.4664795Z +            _ => {
2025-11-09T23:19:32.4665006Z +                return Err(RpcError::invalid_params(format!(
2025-11-09T23:19:32.4665359Z +                    "Invalid estimate_mode: {}. Must be 'unset', 'economical', or 'conservative'",
2025-11-09T23:19:32.4665496Z +                    estimate_mode
2025-11-09T23:19:32.4665619Z +                )))
2025-11-09T23:19:32.4665727Z +            }
2025-11-09T23:19:32.4665839Z          }
2025-11-09T23:19:32.4665969Z -        
2025-11-09T23:19:32.4666084Z +
2025-11-09T23:19:32.4666342Z          // Get mempool transactions and UTXO set for fee calculation
2025-11-09T23:19:32.4666622Z          let mempool_txs = if let Some(ref mempool) = self.mempool {
2025-11-09T23:19:32.4666795Z              let utxo_set = self.get_utxo_set()?;
2025-11-09T23:19:32.4667251Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:608:
2025-11-09T23:19:32.4667363Z          } else {
2025-11-09T23:19:32.4667485Z              vec![]
2025-11-09T23:19:32.4667597Z          };
2025-11-09T23:19:32.4667710Z -        
2025-11-09T23:19:32.4667819Z +
2025-11-09T23:19:32.4668007Z          // Calculate fee rate based on mempool state
2025-11-09T23:19:32.4668266Z          // Simple algorithm: use median fee rate of top transactions
2025-11-09T23:19:32.4668446Z          let fee_rate = if !mempool_txs.is_empty() {
2025-11-09T23:19:32.4668897Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:615:
2025-11-09T23:19:32.4669057Z              let utxo_set = self.get_utxo_set()?;
2025-11-09T23:19:32.4669237Z              let mut fee_rates = Vec::new();
2025-11-09T23:19:32.4669616Z -            
2025-11-09T23:19:32.4669739Z +
2025-11-09T23:19:32.4670164Z              // MempoolManager.get_prioritized_transactions() already calculates fees correctly
2025-11-09T23:19:32.4670541Z              // We can extract fee rates from the prioritized list, but for now calculate directly
2025-11-09T23:19:32.4670698Z              for tx in &mempool_txs {
2025-11-09T23:19:32.4671144Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:621:
2025-11-09T23:19:32.4671425Z                  let fee = self.calculate_transaction_fee(tx); // Now uses UTXO set
2025-11-09T23:19:32.4671622Z                  let size = self.calculate_weight(tx) as usize;
2025-11-09T23:19:32.4671735Z -                
2025-11-09T23:19:32.4671845Z +
2025-11-09T23:19:32.4671984Z                  if size > 0 {
2025-11-09T23:19:32.4672138Z                      // Fee rate in BTC per vbyte
2025-11-09T23:19:32.4672471Z                      let rate = (fee as f64) / (size as f64) / 100_000_000.0; // Convert satoshis to BTC
2025-11-09T23:19:32.4672917Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:627:
2025-11-09T23:19:32.4673080Z                      fee_rates.push(rate);
2025-11-09T23:19:32.4673196Z                  }
2025-11-09T23:19:32.4673309Z              }
2025-11-09T23:19:32.4673430Z -            
2025-11-09T23:19:32.4673541Z +
2025-11-09T23:19:32.4673759Z              // Use median fee rate, or minimum if no transactions
2025-11-09T23:19:32.4673907Z              if !fee_rates.is_empty() {
2025-11-09T23:19:32.4674266Z                  fee_rates.sort_by(|a, b| a.partial_cmp(b).unwrap_or(std::cmp::Ordering::Equal));
2025-11-09T23:19:32.4674900Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:640:
2025-11-09T23:19:32.4675108Z              // No mempool transactions - return minimum fee
2025-11-09T23:19:32.4675244Z              0.00001 // 1 sat/vB
2025-11-09T23:19:32.4675578Z          };
2025-11-09T23:19:32.4675683Z -        
2025-11-09T23:19:32.4675800Z +
2025-11-09T23:19:32.4675951Z          // Adjust based on estimate_mode
2025-11-09T23:19:32.4676116Z          let adjusted_rate = match estimate_mode {
2025-11-09T23:19:32.4676354Z -            "economical" => fee_rate * 0.8, // 20% lower for economical
2025-11-09T23:19:32.4676612Z +            "economical" => fee_rate * 0.8,   // 20% lower for economical
2025-11-09T23:19:32.4676873Z              "conservative" => fee_rate * 1.2, // 20% higher for conservative
2025-11-09T23:19:32.4676988Z              _ => fee_rate,
2025-11-09T23:19:32.4677100Z          };
2025-11-09T23:19:32.4677521Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:650:
2025-11-09T23:19:32.4677630Z -        
2025-11-09T23:19:32.4677745Z +
2025-11-09T23:19:32.4677866Z          Ok(json!({
2025-11-09T23:19:32.4678013Z              "feerate": adjusted_rate,
2025-11-09T23:19:32.4678160Z              "blocks": conf_target
2025-11-09T23:19:32.4678601Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:660:
2025-11-09T23:19:32.4678965Z      pub async fn prioritise_transaction(&self, params: &Value) -> RpcResult<Value> {
2025-11-09T23:19:32.4679142Z          debug!("RPC: prioritisetransaction");
2025-11-09T23:19:32.4679260Z  
2025-11-09T23:19:32.4679400Z -        let txid = params.get(0)
2025-11-09T23:19:32.4679536Z +        let txid = params
2025-11-09T23:19:32.4679657Z +            .get(0)
2025-11-09T23:19:32.4679809Z              .and_then(|p| p.as_str())
2025-11-09T23:19:32.4680183Z              .ok_or_else(|| RpcError::invalid_params("Transaction ID required".to_string()))?;
2025-11-09T23:19:32.4680295Z  
2025-11-09T23:19:32.4680724Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:667:
2025-11-09T23:19:32.4680879Z -        let fee_delta = params.get(1)
2025-11-09T23:19:32.4681015Z +        let fee_delta = params
2025-11-09T23:19:32.4681143Z +            .get(1)
2025-11-09T23:19:32.4681505Z              .and_then(|p| p.as_i64())
2025-11-09T23:19:32.4681865Z              .ok_or_else(|| RpcError::invalid_params("Fee delta required".to_string()))?;
2025-11-09T23:19:32.4681975Z  
2025-11-09T23:19:32.4682405Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:671:
2025-11-09T23:19:32.4682574Z          let hash_bytes = hex::decode(txid)
2025-11-09T23:19:32.4682932Z              .map_err(|e| RpcError::invalid_params(format!("Invalid transaction ID: {}", e)))?;
2025-11-09T23:19:32.4683075Z          if hash_bytes.len() != 32 {
2025-11-09T23:19:32.4683476Z -            return Err(RpcError::invalid_params("Transaction ID must be 32 bytes".to_string()));
2025-11-09T23:19:32.4683650Z +            return Err(RpcError::invalid_params(
2025-11-09T23:19:32.4683850Z +                "Transaction ID must be 32 bytes".to_string(),
2025-11-09T23:19:32.4683974Z +            ));
2025-11-09T23:19:32.4684094Z          }
2025-11-09T23:19:32.4684231Z          let mut hash = [0u8; 32];
2025-11-09T23:19:32.4684597Z          hash.copy_from_slice(&hash_bytes);
2025-11-09T23:19:32.4685047Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:681:
2025-11-09T23:19:32.4685239Z              if mempool.get_transaction(&hash).is_some() {
2025-11-09T23:19:32.4685515Z                  // Note: In production, would update transaction priority/fee delta
2025-11-09T23:19:32.4685678Z                  // For now, just return success
2025-11-09T23:19:32.4685995Z -                debug!("Transaction {} prioritized with fee delta: {}", txid, fee_delta);
2025-11-09T23:19:32.4686118Z +                debug!(
2025-11-09T23:19:32.4686335Z +                    "Transaction {} prioritized with fee delta: {}",
2025-11-09T23:19:32.4686465Z +                    txid, fee_delta
2025-11-09T23:19:32.4686581Z +                );
2025-11-09T23:19:32.4686712Z                  Ok(json!(true))
2025-11-09T23:19:32.4687063Z              } else {
2025-11-09T23:19:32.4687248Z -                Err(RpcError::invalid_params(
2025-11-09T23:19:32.4687471Z -                    format!("Transaction {} not found in mempool", txid)
2025-11-09T23:19:32.4687590Z -                ))
2025-11-09T23:19:32.4687765Z +                Err(RpcError::invalid_params(format!(
2025-11-09T23:19:32.4687940Z +                    "Transaction {} not found in mempool",
2025-11-09T23:19:32.4688067Z +                    txid
2025-11-09T23:19:32.4688193Z +                )))
2025-11-09T23:19:32.4688310Z              }
2025-11-09T23:19:32.4688425Z          } else {
2025-11-09T23:19:32.4688736Z -            Err(RpcError::internal_error("Mempool not initialized".to_string()))
2025-11-09T23:19:32.4688900Z +            Err(RpcError::internal_error(
2025-11-09T23:19:32.4689072Z +                "Mempool not initialized".to_string(),
2025-11-09T23:19:32.4689185Z +            ))
2025-11-09T23:19:32.4689302Z          }
2025-11-09T23:19:32.4689414Z      }
2025-11-09T23:19:32.4689532Z  }
2025-11-09T23:19:32.4689985Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:696:
2025-11-09T23:19:32.4690093Z  
2025-11-09T23:19:32.4690239Z  impl Default for MiningRpc {
2025-11-09T23:19:32.4690400Z -    fn default() -> Self { Self::new() }
2025-11-09T23:19:32.4690545Z +    fn default() -> Self {
2025-11-09T23:19:32.4690663Z +        Self::new()
2025-11-09T23:19:32.4690770Z +    }
2025-11-09T23:19:32.4690885Z  }
2025-11-09T23:19:32.4690990Z  
2025-11-09T23:19:32.4691396Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mod.rs:120:
2025-11-09T23:19:32.4691523Z          self.mining_rpc =
2025-11-09T23:19:32.4691911Z              mining::MiningRpc::with_dependencies(Arc::clone(&storage), Arc::clone(&mempool));
2025-11-09T23:19:32.4692343Z          self.blockchain_rpc = blockchain::BlockchainRpc::with_dependencies(Arc::clone(&storage));
2025-11-09T23:19:32.4692827Z -        let mempool_rpc = mempool::MempoolRpc::with_dependencies(Arc::clone(&mempool), Arc::clone(&storage));
2025-11-09T23:19:32.4693185Z +        let mempool_rpc =
2025-11-09T23:19:32.4693605Z +            mempool::MempoolRpc::with_dependencies(Arc::clone(&mempool), Arc::clone(&storage));
2025-11-09T23:19:32.4693822Z          let rawtx_rpc = rawtx::RawTxRpc::with_dependencies(
2025-11-09T23:19:32.4693961Z              Arc::clone(&storage),
2025-11-09T23:19:32.4694086Z              Arc::clone(&mempool),
2025-11-09T23:19:32.4694697Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mod.rs:148:
2025-11-09T23:19:32.4694822Z      }
2025-11-09T23:19:32.4694933Z  
2025-11-09T23:19:32.4695081Z      /// Set network manager dependency
2025-11-09T23:19:32.4695563Z -    pub fn with_network_manager(mut self, network_manager: Arc<crate::network::NetworkManager>) -> Self {
2025-11-09T23:19:32.4695706Z +    pub fn with_network_manager(
2025-11-09T23:19:32.4695815Z +        mut self,
2025-11-09T23:19:32.4696036Z +        network_manager: Arc<crate::network::NetworkManager>,
2025-11-09T23:19:32.4696172Z +    ) -> Self {
2025-11-09T23:19:32.4698203Z          self.network_rpc = network::NetworkRpc::with_dependencies(Arc::clone(&network_manager));
2025-11-09T23:19:32.4698381Z          self.network_manager = Some(network_manager);
2025-11-09T23:19:32.4698494Z          self
2025-11-09T23:19:32.4699323Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mod.rs:196:
2025-11-09T23:19:32.4699447Z          ));
2025-11-09T23:19:32.4699557Z  
2025-11-09T23:19:32.4699765Z          // Create server with or without authentication
2025-11-09T23:19:32.4700225Z -        let server = if let (Some(ref storage), Some(ref mempool)) = (self.storage.as_ref(), self.mempool.as_ref()) {
2025-11-09T23:19:32.4700676Z -            let blockchain = Arc::new(blockchain::BlockchainRpc::with_dependencies(Arc::clone(storage)));
2025-11-09T23:19:32.4701441Z -            let mempool_rpc = Arc::new(mempool::MempoolRpc::with_dependencies(Arc::clone(mempool), Arc::clone(&storage)));
2025-11-09T23:19:32.4702318Z -            let rawtx_rpc = Arc::new(rawtx::RawTxRpc::with_dependencies(Arc::clone(storage), Arc::clone(mempool), None, None));
2025-11-09T23:19:32.4702799Z -            let mining = Arc::new(mining::MiningRpc::with_dependencies(Arc::clone(storage), Arc::clone(mempool)));
2025-11-09T23:19:32.4703060Z +        let server = if let (Some(ref storage), Some(ref mempool)) =
2025-11-09T23:19:32.4703260Z +            (self.storage.as_ref(), self.mempool.as_ref())
2025-11-09T23:19:32.4703374Z +        {
2025-11-09T23:19:32.4703751Z +            let blockchain = Arc::new(blockchain::BlockchainRpc::with_dependencies(Arc::clone(
2025-11-09T23:19:32.4703866Z +                storage,
2025-11-09T23:19:32.4703968Z +            )));
2025-11-09T23:19:32.4704255Z +            let mempool_rpc = Arc::new(mempool::MempoolRpc::with_dependencies(
2025-11-09T23:19:32.4704586Z +                Arc::clone(mempool),
2025-11-09T23:19:32.4704736Z +                Arc::clone(&storage),
2025-11-09T23:19:32.4704861Z +            ));
2025-11-09T23:19:32.4705110Z +            let rawtx_rpc = Arc::new(rawtx::RawTxRpc::with_dependencies(
2025-11-09T23:19:32.4705251Z +                Arc::clone(storage),
2025-11-09T23:19:32.4705381Z +                Arc::clone(mempool),
2025-11-09T23:19:32.4705502Z +                None,
2025-11-09T23:19:32.4705619Z +                None,
2025-11-09T23:19:32.4705722Z +            ));
2025-11-09T23:19:32.4705956Z +            let mining = Arc::new(mining::MiningRpc::with_dependencies(
2025-11-09T23:19:32.4706082Z +                Arc::clone(storage),
2025-11-09T23:19:32.4706206Z +                Arc::clone(mempool),
2025-11-09T23:19:32.4706315Z +            ));
2025-11-09T23:19:32.4706591Z              let network = if let Some(ref network_manager) = self.network_manager {
2025-11-09T23:19:32.4706933Z -                Arc::new(network::NetworkRpc::with_dependencies(Arc::clone(network_manager)))
2025-11-09T23:19:32.4707174Z +                Arc::new(network::NetworkRpc::with_dependencies(Arc::clone(
2025-11-09T23:19:32.4707318Z +                    network_manager,
2025-11-09T23:19:32.4718695Z +                )))
2025-11-09T23:19:32.4718869Z              } else {
2025-11-09T23:19:32.4719072Z                  Arc::new(network::NetworkRpc::new())
2025-11-09T23:19:32.4719204Z              };
2025-11-09T23:19:32.4719643Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mod.rs:209:
2025-11-09T23:19:32.4719764Z -            
2025-11-09T23:19:32.4719875Z +
2025-11-09T23:19:32.4720052Z              // Use auth manager if configured
2025-11-09T23:19:32.4720264Z              if let Some(ref auth_manager) = self.auth_manager {
2025-11-09T23:19:32.4720481Z                  server::RpcServer::with_dependencies_and_auth(
2025-11-09T23:19:32.4720905Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mod.rs:233:
2025-11-09T23:19:32.4721027Z          } else {
2025-11-09T23:19:32.4721220Z              // No dependencies - use auth if configured
2025-11-09T23:19:32.4721444Z              if let Some(ref auth_manager) = self.auth_manager {
2025-11-09T23:19:32.4721619Z -                server::RpcServer::with_auth(
2025-11-09T23:19:32.4721762Z -                    self.server_addr,
2025-11-09T23:19:32.4721924Z -                    Arc::clone(auth_manager),
2025-11-09T23:19:32.4722051Z -                )
2025-11-09T23:19:32.4722377Z +                server::RpcServer::with_auth(self.server_addr, Arc::clone(auth_manager))
2025-11-09T23:19:32.4722499Z              } else {
2025-11-09T23:19:32.4722698Z                  server::RpcServer::new(self.server_addr)
2025-11-09T23:19:32.4722818Z              }
2025-11-09T23:19:32.4723336Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:18:
2025-11-09T23:19:32.4723479Z  impl NetworkRpc {
2025-11-09T23:19:32.4723636Z      /// Create a new network RPC handler
2025-11-09T23:19:32.4723772Z      pub fn new() -> Self {
2025-11-09T23:19:32.4723913Z -        Self { network_manager: None }
2025-11-09T23:19:32.4724244Z +        Self {
2025-11-09T23:19:32.4724594Z +            network_manager: None,
2025-11-09T23:19:32.4724720Z +        }
2025-11-09T23:19:32.4724845Z      }
2025-11-09T23:19:32.4724960Z  
2025-11-09T23:19:32.4725108Z      /// Create with dependencies
2025-11-09T23:19:32.4725550Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:25:
2025-11-09T23:19:32.4725902Z      pub fn with_dependencies(network_manager: Arc<NetworkManager>) -> Self {
2025-11-09T23:19:32.4726107Z -        Self { network_manager: Some(network_manager) }
2025-11-09T23:19:32.4726225Z +        Self {
2025-11-09T23:19:32.4726418Z +            network_manager: Some(network_manager),
2025-11-09T23:19:32.4726532Z +        }
2025-11-09T23:19:32.4726646Z      }
2025-11-09T23:19:32.4726748Z  
2025-11-09T23:19:32.4726887Z      /// Get network information
2025-11-09T23:19:32.4727316Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:103:
2025-11-09T23:19:32.4727521Z          if let Some(ref network) = self.network_manager {
2025-11-09T23:19:32.4727708Z              let peer_manager = network.peer_manager();
2025-11-09T23:19:32.4727936Z              let peer_addresses = peer_manager.peer_addresses();
2025-11-09T23:19:32.4728186Z -            let peers: Vec<Value> = peer_addresses.iter().map(|addr| {
2025-11-09T23:19:32.4728408Z -                if let Some(peer) = peer_manager.get_peer(addr) {
2025-11-09T23:19:32.4728540Z -                    json!({
2025-11-09T23:19:32.4730593Z -                        "id": addr.port().unwrap_or(0) as u64, // Use port as peer ID (unique per connection)
2025-11-09T23:19:32.4730759Z -                        "addr": addr.to_string(),
2025-11-09T23:19:32.4730916Z -                        "addrlocal": "",
2025-11-09T23:19:32.4731069Z -                        "services": "0000000000000001",
2025-11-09T23:19:32.4731214Z -                        "relaytxes": true,
2025-11-09T23:19:32.4731385Z -                        "lastsend": peer.last_send(),
2025-11-09T23:19:32.4731791Z -                        "lastrecv": peer.last_recv(),
2025-11-09T23:19:32.4731975Z -                        "bytessent": peer.bytes_sent(),
2025-11-09T23:19:32.4732146Z -                        "bytesrecv": peer.bytes_recv(),
2025-11-09T23:19:32.4732312Z -                        "conntime": peer.conntime(),
2025-11-09T23:19:32.4732453Z -                        "timeoffset": 0,
2025-11-09T23:19:32.4732594Z -                        "pingtime": 0.0,
2025-11-09T23:19:32.4732740Z -                        "minping": 0.0,
2025-11-09T23:19:32.4732879Z -                        "version": 70015,
2025-11-09T23:19:32.4733047Z -                        "subver": "/reference-node:0.1.0/",
2025-11-09T23:19:32.4733195Z -                        "inbound": false,
2025-11-09T23:19:32.4733333Z -                        "addnode": false,
2025-11-09T23:19:32.4733490Z -                        "startingheight": 0,
2025-11-09T23:19:32.4733653Z -                        "synced_headers": -1,
2025-11-09T23:19:32.4733808Z -                        "synced_blocks": -1,
2025-11-09T23:19:32.4733955Z -                        "inflight": [],
2025-11-09T23:19:32.4734106Z -                        "whitelisted": false,
2025-11-09T23:19:32.4734282Z -                        "minfeefilter": 0.00001000,
2025-11-09T23:19:32.4734620Z -                        "bytessent_per_msg": {},
2025-11-09T23:19:32.4734774Z -                        "bytesrecv_per_msg": {}
2025-11-09T23:19:32.4734902Z -                    })
2025-11-09T23:19:32.4735029Z -                } else {
2025-11-09T23:19:32.4735157Z -                    json!({})
2025-11-09T23:19:32.4735268Z -                }
2025-11-09T23:19:32.4735404Z -            }).collect();
2025-11-09T23:19:32.4735571Z +            let peers: Vec<Value> = peer_addresses
2025-11-09T23:19:32.4735694Z +                .iter()
2025-11-09T23:19:32.4735830Z +                .map(|addr| {
2025-11-09T23:19:32.4736047Z +                    if let Some(peer) = peer_manager.get_peer(addr) {
2025-11-09T23:19:32.4736386Z +                        json!({
2025-11-09T23:19:32.4736742Z +                            "id": addr.port().unwrap_or(0) as u64, // Use port as peer ID (unique per connection)
2025-11-09T23:19:32.4736908Z +                            "addr": addr.to_string(),
2025-11-09T23:19:32.4737056Z +                            "addrlocal": "",
2025-11-09T23:19:32.4737214Z +                            "services": "0000000000000001",
2025-11-09T23:19:32.4737367Z +                            "relaytxes": true,
2025-11-09T23:19:32.4737526Z +                            "lastsend": peer.last_send(),
2025-11-09T23:19:32.4737683Z +                            "lastrecv": peer.last_recv(),
2025-11-09T23:19:32.4737853Z +                            "bytessent": peer.bytes_sent(),
2025-11-09T23:19:32.4738014Z +                            "bytesrecv": peer.bytes_recv(),
2025-11-09T23:19:32.4738181Z +                            "conntime": peer.conntime(),
2025-11-09T23:19:32.4738326Z +                            "timeoffset": 0,
2025-11-09T23:19:32.4738496Z +                            "pingtime": 0.0,
2025-11-09T23:19:32.4740544Z +                            "minping": 0.0,
2025-11-09T23:19:32.4741125Z +                            "version": 70015,
2025-11-09T23:19:32.4741316Z +                            "subver": "/reference-node:0.1.0/",
2025-11-09T23:19:32.4741462Z +                            "inbound": false,
2025-11-09T23:19:32.4741600Z +                            "addnode": false,
2025-11-09T23:19:32.4741761Z +                            "startingheight": 0,
2025-11-09T23:19:32.4741920Z +                            "synced_headers": -1,
2025-11-09T23:19:32.4742074Z +                            "synced_blocks": -1,
2025-11-09T23:19:32.4742216Z +                            "inflight": [],
2025-11-09T23:19:32.4742379Z +                            "whitelisted": false,
2025-11-09T23:19:32.4742542Z +                            "minfeefilter": 0.00001000,
2025-11-09T23:19:32.4742705Z +                            "bytessent_per_msg": {},
2025-11-09T23:19:32.4743105Z +                            "bytesrecv_per_msg": {}
2025-11-09T23:19:32.4743244Z +                        })
2025-11-09T23:19:32.4743371Z +                    } else {
2025-11-09T23:19:32.4743496Z +                        json!({})
2025-11-09T23:19:32.4743621Z +                    }
2025-11-09T23:19:32.4743737Z +                })
2025-11-09T23:19:32.4743868Z +                .collect();
2025-11-09T23:19:32.4744010Z              Ok(json!(peers))
2025-11-09T23:19:32.4744125Z          } else {
2025-11-09T23:19:32.4744254Z              Ok(json!([]))
2025-11-09T23:19:32.4744901Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:164:
2025-11-09T23:19:32.4745122Z          if let Some(ref network) = self.network_manager {
2025-11-09T23:19:32.4745276Z              // Send ping to all peers
2025-11-09T23:19:32.4745482Z              if let Err(e) = network.ping_all_peers().await {
2025-11-09T23:19:32.4745880Z -                return Err(RpcError::internal_error(format!("Failed to ping peers: {}", e)));
2025-11-09T23:19:32.4746078Z +                return Err(RpcError::internal_error(format!(
2025-11-09T23:19:32.4746235Z +                    "Failed to ping peers: {}",
2025-11-09T23:19:32.4746361Z +                    e
2025-11-09T23:19:32.4746476Z +                )));
2025-11-09T23:19:32.4746590Z              }
2025-11-09T23:19:32.4746778Z              debug!("Sent ping to all connected peers");
2025-11-09T23:19:32.4746905Z          }
2025-11-09T23:19:32.4747318Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:205:
2025-11-09T23:19:32.4747438Z                  "onetry" => {
2025-11-09T23:19:32.4747585Z                      // Try to connect to node once
2025-11-09T23:19:32.4747783Z                      if let Err(e) = network.connect_to_peer(addr).await {
2025-11-09T23:19:32.4748153Z -                        return Err(RpcError::internal_error(format!("Failed to connect to {}: {}", addr, e)));
2025-11-09T23:19:32.4748583Z +                        return Err(RpcError::internal_error(format!(
2025-11-09T23:19:32.4748754Z +                            "Failed to connect to {}: {}",
2025-11-09T23:19:32.4748881Z +                            addr, e
2025-11-09T23:19:32.4749003Z +                        )));
2025-11-09T23:19:32.4749123Z                      }
2025-11-09T23:19:32.4749312Z                      debug!("Connected to node {} (onetry)", addr);
2025-11-09T23:19:32.4749431Z                      Ok(json!(null))
2025-11-09T23:19:32.4749849Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:310:
2025-11-09T23:19:32.4749996Z                  active_connection_limit_hits: 0,
2025-11-09T23:19:32.4750138Z                  resource_exhaustion_events: 0,
2025-11-09T23:19:32.4750248Z              };
2025-11-09T23:19:32.4750349Z -            
2025-11-09T23:19:32.4750449Z +
2025-11-09T23:19:32.4750557Z              Ok(json!({
2025-11-09T23:19:32.4750686Z                  "metrics": {
2025-11-09T23:19:32.4752749Z                      "connection_rate_violations": metrics.connection_rate_violations,
2025-11-09T23:19:32.4753188Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:365:
2025-11-09T23:19:32.4753354Z          let addr: SocketAddr = subnet
2025-11-09T23:19:32.4753480Z              .parse()
2025-11-09T23:19:32.4753876Z              .map_err(|_| RpcError::invalid_params(format!("Invalid address/subnet: {}", subnet)))?;
2025-11-09T23:19:32.4753991Z -        
2025-11-09T23:19:32.4754109Z +
2025-11-09T23:19:32.4754284Z          // Parse bantime (seconds) - 0 = permanent
2025-11-09T23:19:32.4754826Z          let bantime = params.get(2).and_then(|p| p.as_u64()).unwrap_or(86400); // Default 24 hours
2025-11-09T23:19:32.4754954Z -        
2025-11-09T23:19:32.4755066Z +
2025-11-09T23:19:32.4755372Z          // Parse absolute (whether bantime is absolute timestamp or relative)
2025-11-09T23:19:32.4755690Z          let absolute = params.get(3).and_then(|p| p.as_bool()).unwrap_or(false);
2025-11-09T23:19:32.4756019Z -        
2025-11-09T23:19:32.4756133Z +
2025-11-09T23:19:32.4756341Z          if let Some(ref network) = self.network_manager {
2025-11-09T23:19:32.4756532Z              use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:19:32.4756689Z              let now = SystemTime::now()
2025-11-09T23:19:32.4757142Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:378:
2025-11-09T23:19:32.4757311Z                  .duration_since(UNIX_EPOCH)
2025-11-09T23:19:32.4757440Z                  .unwrap()
2025-11-09T23:19:32.4757568Z                  .as_secs();
2025-11-09T23:19:32.4757679Z -            
2025-11-09T23:19:32.4757800Z +
2025-11-09T23:19:32.4757964Z              let unban_timestamp = if absolute {
2025-11-09T23:19:32.4758124Z                  bantime // Already a timestamp
2025-11-09T23:19:32.4758275Z              } else if bantime == 0 {
2025-11-09T23:19:32.4758728Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:386:
2025-11-09T23:19:32.4758869Z              } else {
2025-11-09T23:19:32.4759026Z                  now + bantime // Relative ban
2025-11-09T23:19:32.4759150Z              };
2025-11-09T23:19:32.4759265Z -            
2025-11-09T23:19:32.4759377Z +
2025-11-09T23:19:32.4759522Z              match command {
2025-11-09T23:19:32.4759650Z                  "add" => {
2025-11-09T23:19:32.4759836Z                      network.ban_peer(addr, unban_timestamp);
2025-11-09T23:19:32.4761523Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:422:
2025-11-09T23:19:32.4761645Z  
2025-11-09T23:19:32.4761843Z          if let Some(ref network) = self.network_manager {
2025-11-09T23:19:32.4762018Z              let banned = network.get_banned_peers();
2025-11-09T23:19:32.4762327Z -            let result: Vec<Value> = banned.iter().map(|(addr, unban_timestamp)| {
2025-11-09T23:19:32.4762451Z -                json!({
2025-11-09T23:19:32.4762877Z -                    "address": addr.to_string(),
2025-11-09T23:19:32.4763124Z -                    "banned_until": if *unban_timestamp == u64::MAX {
2025-11-09T23:19:32.4763316Z -                        serde_json::Value::Null // Permanent ban
2025-11-09T23:19:32.4763445Z -                    } else {
2025-11-09T23:19:32.4763675Z -                        serde_json::Value::Number((*unban_timestamp).into())
2025-11-09T23:19:32.4763802Z -                    },
2025-11-09T23:19:32.4764038Z -                    "banned_until_absolute": *unban_timestamp == u64::MAX
2025-11-09T23:19:32.4764197Z +            let result: Vec<Value> = banned
2025-11-09T23:19:32.4764570Z +                .iter()
2025-11-09T23:19:32.4764751Z +                .map(|(addr, unban_timestamp)| {
2025-11-09T23:19:32.4764880Z +                    json!({
2025-11-09T23:19:32.4765052Z +                        "address": addr.to_string(),
2025-11-09T23:19:32.4765284Z +                        "banned_until": if *unban_timestamp == u64::MAX {
2025-11-09T23:19:32.4765509Z +                            serde_json::Value::Null // Permanent ban
2025-11-09T23:19:32.4765636Z +                        } else {
2025-11-09T23:19:32.4765880Z +                            serde_json::Value::Number((*unban_timestamp).into())
2025-11-09T23:19:32.4766005Z +                        },
2025-11-09T23:19:32.4766240Z +                        "banned_until_absolute": *unban_timestamp == u64::MAX
2025-11-09T23:19:32.4766372Z +                    })
2025-11-09T23:19:32.4766480Z                  })
2025-11-09T23:19:32.4766603Z -            }).collect();
2025-11-09T23:19:32.4766733Z +                .collect();
2025-11-09T23:19:32.4766877Z              Ok(json!(result))
2025-11-09T23:19:32.4766991Z          } else {
2025-11-09T23:19:32.4767109Z              Ok(json!([]))
2025-11-09T23:19:32.4767566Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:445:
2025-11-09T23:19:32.4767903Z      pub async fn getaddednodeinfo(&self, params: &Value) -> RpcResult<Value> {
2025-11-09T23:19:32.4768280Z          debug!("RPC: getaddednodeinfo");
2025-11-09T23:19:32.4768395Z  
2025-11-09T23:19:32.4768526Z -        let node = params.get(0)
2025-11-09T23:19:32.4768651Z +        let node = params
2025-11-09T23:19:32.4768757Z +            .get(0)
2025-11-09T23:19:32.4768895Z              .and_then(|p| p.as_str())
2025-11-09T23:19:32.4769209Z              .ok_or_else(|| RpcError::invalid_params("Node address required".to_string()))?;
2025-11-09T23:19:32.4769320Z  
2025-11-09T23:19:32.4769745Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:453:
2025-11-09T23:19:32.4769847Z  
2025-11-09T23:19:32.4770033Z          if let Some(ref network) = self.network_manager {
2025-11-09T23:19:32.4770652Z              // Parse node address
2025-11-09T23:19:32.4770830Z -            let addr: SocketAddr = node.parse()
2025-11-09T23:19:32.4772621Z +            let addr: SocketAddr = node
2025-11-09T23:19:32.4772760Z +                .parse()
2025-11-09T23:19:32.4773141Z                  .map_err(|e| RpcError::invalid_params(format!("Invalid node address: {}", e)))?;
2025-11-09T23:19:32.4773257Z  
2025-11-09T23:19:32.4773439Z              // Check if node is in persistent peer list
2025-11-09T23:19:32.4773875Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:494:
2025-11-09T23:19:32.4774215Z      pub async fn getnodeaddresses(&self, params: &Value) -> RpcResult<Value> {
2025-11-09T23:19:32.4774608Z          debug!("RPC: getnodeaddresses");
2025-11-09T23:19:32.4774729Z  
2025-11-09T23:19:32.4774890Z -        let count = params.get(0)
2025-11-09T23:19:32.4775044Z -            .and_then(|p| p.as_u64())
2025-11-09T23:19:32.4775176Z -            .unwrap_or(1)
2025-11-09T23:19:32.4775344Z -            .min(100) as usize; // Limit to 100
2025-11-09T23:19:32.4775750Z +        let count = params.get(0).and_then(|p| p.as_u64()).unwrap_or(1).min(100) as usize; // Limit to 100
2025-11-09T23:19:32.4776109Z  
2025-11-09T23:19:32.4776323Z          if let Some(ref network) = self.network_manager {
2025-11-09T23:19:32.4776479Z              // Get peer addresses
2025-11-09T23:19:32.4776930Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:504:
2025-11-09T23:19:32.4777156Z              let peer_addrs = network.get_peer_addresses().await;
2025-11-09T23:19:32.4777286Z -            
2025-11-09T23:19:32.4777401Z +
2025-11-09T23:19:32.4777564Z              // Convert to node address format
2025-11-09T23:19:32.4777738Z              let mut addresses = Vec::new();
2025-11-09T23:19:32.4777939Z              for addr in peer_addrs.into_iter().take(count) {
2025-11-09T23:19:32.4778379Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:551:
2025-11-09T23:19:32.4778708Z      pub async fn setnetworkactive(&self, params: &Value) -> RpcResult<Value> {
2025-11-09T23:19:32.4778861Z          debug!("RPC: setnetworkactive");
2025-11-09T23:19:32.4778971Z  
2025-11-09T23:19:32.4779104Z -        let state = params.get(0)
2025-11-09T23:19:32.4779253Z -            .and_then(|p| p.as_bool())
2025-11-09T23:19:32.4781666Z -            .ok_or_else(|| RpcError::invalid_params("State parameter required (true/false)".to_string()))?;
2025-11-09T23:19:32.4781935Z +        let state = params.get(0).and_then(|p| p.as_bool()).ok_or_else(|| {
2025-11-09T23:19:32.4782274Z +            RpcError::invalid_params("State parameter required (true/false)".to_string())
2025-11-09T23:19:32.4782380Z +        })?;
2025-11-09T23:19:32.4782484Z  
2025-11-09T23:19:32.4782684Z          if let Some(ref network) = self.network_manager {
2025-11-09T23:19:32.4782873Z -            network.set_network_active(state).await
2025-11-09T23:19:32.4783235Z -                .map_err(|e| RpcError::internal_error(format!("Failed to set network active: {}", e)))?;
2025-11-09T23:19:32.4783444Z +            network.set_network_active(state).await.map_err(|e| {
2025-11-09T23:19:32.4783758Z +                RpcError::internal_error(format!("Failed to set network active: {}", e))
2025-11-09T23:19:32.4784068Z +            })?;
2025-11-09T23:19:32.4784194Z              Ok(json!(state))
2025-11-09T23:19:32.4784478Z          } else {
2025-11-09T23:19:32.4784828Z -            Err(RpcError::internal_error("Network manager not available".to_string()))
2025-11-09T23:19:32.4784992Z +            Err(RpcError::internal_error(
2025-11-09T23:19:32.4785186Z +                "Network manager not available".to_string(),
2025-11-09T23:19:32.4785312Z +            ))
2025-11-09T23:19:32.4785427Z          }
2025-11-09T23:19:32.4785543Z      }
2025-11-09T23:19:32.4785667Z  }
2025-11-09T23:19:32.4833937Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:68:
2025-11-09T23:19:32.4834166Z          let tx_bytes = hex::decode(hex_string)
2025-11-09T23:19:32.4834728Z              .map_err(|e| RpcError::invalid_params(format!("Invalid hex string: {}", e)))?;
2025-11-09T23:19:32.4834844Z  
2025-11-09T23:19:32.4835292Z -        if let (Some(ref storage), Some(ref mempool)) = (self.storage.as_ref(), self.mempool.as_ref()) {
2025-11-09T23:19:32.4835500Z +        if let (Some(ref storage), Some(ref mempool)) =
2025-11-09T23:19:32.4835705Z +            (self.storage.as_ref(), self.mempool.as_ref())
2025-11-09T23:19:32.4835821Z +        {
2025-11-09T23:19:32.4836183Z              use bllvm_protocol::serialization::transaction::deserialize_transaction;
2025-11-09T23:19:32.4836373Z -            let tx = deserialize_transaction(&tx_bytes)
2025-11-09T23:19:32.4836764Z -                .map_err(|e| RpcError::invalid_params(format!("Failed to parse transaction: {}", e)))?;
2025-11-09T23:19:32.4836881Z -            
2025-11-09T23:19:32.4837128Z +            let tx = deserialize_transaction(&tx_bytes).map_err(|e| {
2025-11-09T23:19:32.4837455Z +                RpcError::invalid_params(format!("Failed to parse transaction: {}", e))
2025-11-09T23:19:32.4837571Z +            })?;
2025-11-09T23:19:32.4837677Z +
2025-11-09T23:19:32.4838124Z              use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:19:32.4838290Z              let txid = calculate_tx_id(&tx);
2025-11-09T23:19:32.4838407Z -            
2025-11-09T23:19:32.4838512Z +
2025-11-09T23:19:32.4838664Z              // Check if already in mempool
2025-11-09T23:19:32.4838863Z              if mempool.get_transaction(&txid).is_some() {
2025-11-09T23:19:32.4839203Z                  return Err(RpcError::invalid_params("Transaction already in mempool"));
2025-11-09T23:19:32.4839634Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:82:
2025-11-09T23:19:32.4839762Z              }
2025-11-09T23:19:32.4842135Z -            
2025-11-09T23:19:32.4842276Z +
2025-11-09T23:19:32.4842426Z              // Check if in chain
2025-11-09T23:19:32.4842747Z -            if storage.transactions().has_transaction(&txid).unwrap_or(false) {
2025-11-09T23:19:32.4842874Z +            if storage
2025-11-09T23:19:32.4843010Z +                .transactions()
2025-11-09T23:19:32.4843176Z +                .has_transaction(&txid)
2025-11-09T23:19:32.4843322Z +                .unwrap_or(false)
2025-11-09T23:19:32.4843436Z +            {
2025-11-09T23:19:32.4843775Z                  return Err(RpcError::invalid_params("Transaction already in chain"));
2025-11-09T23:19:32.4843892Z              }
2025-11-09T23:19:32.4844003Z -            
2025-11-09T23:19:32.4844116Z +
2025-11-09T23:19:32.4844494Z              // Validate transaction using consensus layer
2025-11-09T23:19:32.4844705Z -            let _timer = self.profiler.as_ref().map(|p| {
2025-11-09T23:19:32.4845048Z -                PerformanceTimer::start(Arc::clone(p), OperationType::TxValidation)
2025-11-09T23:19:32.4845173Z -            });
2025-11-09T23:19:32.4845311Z +            let _timer = self
2025-11-09T23:19:32.4845440Z +                .profiler
2025-11-09T23:19:32.4845562Z +                .as_ref()
2025-11-09T23:19:32.4845955Z +                .map(|p| PerformanceTimer::start(Arc::clone(p), OperationType::TxValidation));
2025-11-09T23:19:32.4846361Z              let validation_start = Instant::now();
2025-11-09T23:19:32.4846539Z              use bllvm_protocol::ConsensusProof;
2025-11-09T23:19:32.4846719Z              let consensus = ConsensusProof::new();
2025-11-09T23:19:32.4847169Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:97:
2025-11-09T23:19:32.4847392Z                  Ok(bllvm_protocol::ValidationResult::Valid) => {
2025-11-09T23:19:32.4847621Z                      let validation_time = validation_start.elapsed();
2025-11-09T23:19:32.4847796Z                      // Timer will record duration when dropped
2025-11-09T23:19:32.4847907Z -                    
2025-11-09T23:19:32.4848022Z +
2025-11-09T23:19:32.4848158Z                      // Update metrics
2025-11-09T23:19:32.4848333Z                      if let Some(ref metrics) = self.metrics {
2025-11-09T23:19:32.4848500Z                          metrics.update_performance(|m| {
2025-11-09T23:19:32.4848943Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:104:
2025-11-09T23:19:32.4849172Z                              let time_ms = validation_time.as_secs_f64() * 1000.0;
2025-11-09T23:19:32.4849527Z                              // Update average transaction validation time (exponential moving average)
2025-11-09T23:19:32.4849691Z -                            m.avg_tx_validation_time_ms = 
2025-11-09T23:19:32.4849844Z +                            m.avg_tx_validation_time_ms =
2025-11-09T23:19:32.4850050Z                                  (m.avg_tx_validation_time_ms * 0.9) + (time_ms * 0.1);
2025-11-09T23:19:32.4850217Z                              // Update transactions per second
2025-11-09T23:19:32.4850384Z                              if validation_time.as_secs_f64() > 0.0 {
2025-11-09T23:19:32.4850789Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:111:
2025-11-09T23:19:32.4850901Z                              }
2025-11-09T23:19:32.4851220Z                          });
2025-11-09T23:19:32.4851326Z                      }
2025-11-09T23:19:32.4851436Z -                    
2025-11-09T23:19:32.4851543Z +
2025-11-09T23:19:32.4852224Z                      // Transaction structure is valid, now check inputs against UTXO set
2025-11-09T23:19:32.4852421Z -                    let utxo_set = storage.utxos().get_all_utxos()
2025-11-09T23:19:32.4852784Z -                        .map_err(|e| RpcError::internal_error(format!("Failed to get UTXO set: {}", e)))?;
2025-11-09T23:19:32.4852890Z -                    
2025-11-09T23:19:32.4853126Z +                    let utxo_set = storage.utxos().get_all_utxos().map_err(|e| {
2025-11-09T23:19:32.4853408Z +                        RpcError::internal_error(format!("Failed to get UTXO set: {}", e))
2025-11-09T23:19:32.4853524Z +                    })?;
2025-11-09T23:19:32.4853628Z +
2025-11-09T23:19:32.4853786Z                      // Check if all inputs exist in UTXO set
2025-11-09T23:19:32.4853941Z                      for input in &tx.inputs {
2025-11-09T23:19:32.4854152Z                          if !utxo_set.contains_key(&input.prevout) {
2025-11-09T23:19:32.4854779Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:126:
2025-11-09T23:19:32.4854923Z                              )));
2025-11-09T23:19:32.4855046Z                          }
2025-11-09T23:19:32.4855167Z                      }
2025-11-09T23:19:32.4855284Z -                    
2025-11-09T23:19:32.4855404Z +
2025-11-09T23:19:32.4855547Z                      // Add to mempool
2025-11-09T23:19:32.4855903Z                      // Note: add_transaction requires &mut self, but we have Arc<MempoolManager>
2025-11-09T23:19:32.4856245Z                      // In production, this would need to use interior mutability (Mutex/RwLock)
2025-11-09T23:19:32.4856656Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:133:
2025-11-09T23:19:32.4856919Z                      // For now, we'll skip adding to mempool as it requires mutable access
2025-11-09T23:19:32.4857988Z -                    debug!("Transaction validated but not added to mempool (requires mutable access)");
2025-11-09T23:19:32.4858152Z +                    debug!(
2025-11-09T23:19:32.4858511Z +                        "Transaction validated but not added to mempool (requires mutable access)"
2025-11-09T23:19:32.4858634Z +                    );
2025-11-09T23:19:32.4860611Z                  }
2025-11-09T23:19:32.4860896Z                  Ok(bllvm_protocol::ValidationResult::Invalid(reason)) => {
2025-11-09T23:19:32.4861344Z -                    return Err(RpcError::invalid_params(format!("Transaction validation failed: {}", reason)));
2025-11-09T23:19:32.4861552Z +                    return Err(RpcError::invalid_params(format!(
2025-11-09T23:19:32.4861732Z +                        "Transaction validation failed: {}",
2025-11-09T23:19:32.4861859Z +                        reason
2025-11-09T23:19:32.4861986Z +                    )));
2025-11-09T23:19:32.4862103Z                  }
2025-11-09T23:19:32.4862226Z                  Err(e) => {
2025-11-09T23:19:32.4862627Z -                    return Err(RpcError::internal_error(format!("Transaction validation error: {}", e)));
2025-11-09T23:19:32.4862848Z +                    return Err(RpcError::internal_error(format!(
2025-11-09T23:19:32.4863031Z +                        "Transaction validation error: {}",
2025-11-09T23:19:32.4863161Z +                        e
2025-11-09T23:19:32.4863288Z +                    )));
2025-11-09T23:19:32.4863403Z                  }
2025-11-09T23:19:32.4863520Z              }
2025-11-09T23:19:32.4863635Z -            
2025-11-09T23:19:32.4863754Z +
2025-11-09T23:19:32.4863912Z              Ok(json!(hex::encode(txid)))
2025-11-09T23:19:32.4864028Z          } else {
2025-11-09T23:19:32.4864557Z -            Err(RpcError::invalid_params("RPC not initialized with dependencies"))
2025-11-09T23:19:32.4864729Z +            Err(RpcError::invalid_params(
2025-11-09T23:19:32.4865163Z +                "RPC not initialized with dependencies",
2025-11-09T23:19:32.4865287Z +            ))
2025-11-09T23:19:32.4865410Z          }
2025-11-09T23:19:32.4865839Z      }
2025-11-09T23:19:32.4865959Z  
2025-11-09T23:19:32.4866425Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:175:
2025-11-09T23:19:32.4866616Z          let consensus = ConsensusProof::new();
2025-11-09T23:19:32.4866904Z          let validation_result = consensus.validate_transaction(&tx);
2025-11-09T23:19:32.4867018Z  
2025-11-09T23:19:32.4867447Z -        let allowed = matches!(validation_result, Ok(bllvm_protocol::ValidationResult::Valid));
2025-11-09T23:19:32.4867605Z +        let allowed = matches!(
2025-11-09T23:19:32.4867742Z +            validation_result,
2025-11-09T23:19:32.4867932Z +            Ok(bllvm_protocol::ValidationResult::Valid)
2025-11-09T23:19:32.4868060Z +        );
2025-11-09T23:19:32.4868220Z          let reject_reason = if !allowed {
2025-11-09T23:19:32.4868384Z              match validation_result {
2025-11-09T23:19:32.4868726Z                  Ok(bllvm_protocol::ValidationResult::Invalid(reason)) => Some(reason),
2025-11-09T23:19:32.4869186Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:232:
2025-11-09T23:19:32.4869539Z          use bllvm_protocol::serialization::transaction::deserialize_transaction;
2025-11-09T23:19:32.4869720Z          let tx = deserialize_transaction(&tx_bytes)
2025-11-09T23:19:32.4870133Z              .map_err(|e| RpcError::invalid_params(format!("Failed to parse transaction: {}", e)))?;
2025-11-09T23:19:32.4870251Z -        
2025-11-09T23:19:32.4870363Z +
2025-11-09T23:19:32.4870569Z          use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:19:32.4870719Z          let txid = calculate_tx_id(&tx);
2025-11-09T23:19:32.4871261Z          let txid_hex = hex::encode(txid);
2025-11-09T23:19:32.4873499Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:239:
2025-11-09T23:19:32.4873664Z          let size = tx_bytes.len();
2025-11-09T23:19:32.4873783Z -        
2025-11-09T23:19:32.4874128Z +
2025-11-09T23:19:32.4874271Z          Ok(json!({
2025-11-09T23:19:32.4874601Z              "txid": txid_hex.clone(),
2025-11-09T23:19:32.4874735Z              "hash": txid_hex,
2025-11-09T23:19:32.4875189Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:295:
2025-11-09T23:19:32.4875515Z              if let Ok(Some(tx)) = storage.transactions().get_transaction(&txid_array) {
2025-11-09T23:19:32.4875859Z                  use bllvm_protocol::serialization::transaction::serialize_transaction;
2025-11-09T23:19:32.4876095Z                  let tx_hex = hex::encode(serialize_transaction(&tx));
2025-11-09T23:19:32.4876220Z -                
2025-11-09T23:19:32.4876332Z +
2025-11-09T23:19:32.4876465Z                  if verbose {
2025-11-09T23:19:32.4876688Z                      use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:19:32.4876893Z                      let calculated_txid = calculate_tx_id(&tx);
2025-11-09T23:19:32.4877352Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:417:
2025-11-09T23:19:32.4877605Z              if let Ok(Some(utxo)) = storage.utxos().get_utxo(&outpoint) {
2025-11-09T23:19:32.4877908Z                  let best_hash = storage.chain().get_tip_hash()?.unwrap_or([0u8; 32]);
2025-11-09T23:19:32.4878170Z                  let tip_height = storage.chain().get_height()?.unwrap_or(0);
2025-11-09T23:19:32.4878285Z -                
2025-11-09T23:19:32.4878398Z +
2025-11-09T23:19:32.4878605Z                  // Find block height containing this transaction
2025-11-09T23:19:32.4878779Z                  let mut tx_height: Option<u64> = None;
2025-11-09T23:19:32.4878939Z                  for h in 0..=tip_height {
2025-11-09T23:19:32.4879379Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:437:
2025-11-09T23:19:32.4879505Z                          }
2025-11-09T23:19:32.4879848Z                      }
2025-11-09T23:19:32.4879960Z                  }
2025-11-09T23:19:32.4880083Z -                
2025-11-09T23:19:32.4880191Z +
2025-11-09T23:19:32.4880371Z                  let confirmations = tx_height
2025-11-09T23:19:32.4880502Z                      .map(|h| {
2025-11-09T23:19:32.4880649Z                          if h > tip_height {
2025-11-09T23:19:32.4881106Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:447:
2025-11-09T23:19:32.4881227Z                          }
2025-11-09T23:19:32.4881343Z                      })
2025-11-09T23:19:32.4881485Z                      .unwrap_or(0);
2025-11-09T23:19:32.4881607Z -                
2025-11-09T23:19:32.4881714Z +
2025-11-09T23:19:32.4881840Z                  Ok(json!({
2025-11-09T23:19:32.4882030Z                      "bestblock": hex::encode(best_hash),
2025-11-09T23:19:32.4882197Z                      "confirmations": confirmations,
2025-11-09T23:19:32.4882638Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:470:
2025-11-09T23:19:32.4882767Z      }
2025-11-09T23:19:32.4882882Z  
2025-11-09T23:19:32.4883088Z      /// Build merkle proof for transactions in a block
2025-11-09T23:19:32.4883731Z -    fn build_merkle_proof(transactions: &[bllvm_protocol::Transaction], tx_indices: &[usize]) -> Result<Vec<[u8; 32]>, RpcError> {
2025-11-09T23:19:32.4883945Z -        use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:19:32.4884087Z +    fn build_merkle_proof(
2025-11-09T23:19:32.4884438Z +        transactions: &[bllvm_protocol::Transaction],
2025-11-09T23:19:32.4884590Z +        tx_indices: &[usize],
2025-11-09T23:19:32.4884750Z +    ) -> Result<Vec<[u8; 32]>, RpcError> {
2025-11-09T23:19:32.4884935Z          use crate::storage::hashing::double_sha256;
2025-11-09T23:19:32.4885127Z +        use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:19:32.4885251Z  
2025-11-09T23:19:32.4885408Z          if transactions.is_empty() {
2025-11-09T23:19:32.4886008Z -            return Err(RpcError::internal_error("Block has no transactions".to_string()));
2025-11-09T23:19:32.4886207Z +            return Err(RpcError::internal_error(
2025-11-09T23:19:32.4886388Z +                "Block has no transactions".to_string(),
2025-11-09T23:19:32.4886502Z +            ));
2025-11-09T23:19:32.4886616Z          }
2025-11-09T23:19:32.4886733Z  
2025-11-09T23:19:32.4886894Z          // Calculate all transaction hashes
2025-11-09T23:19:32.4887337Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:482:
2025-11-09T23:19:32.4887572Z -        let mut tx_hashes: Vec<[u8; 32]> = transactions.iter()
2025-11-09T23:19:32.4887727Z -            .map(|tx| calculate_tx_id(tx))
2025-11-09T23:19:32.4887849Z -            .collect();
2025-11-09T23:19:32.4890047Z +        let mut tx_hashes: Vec<[u8; 32]> =
2025-11-09T23:19:32.4890333Z +            transactions.iter().map(|tx| calculate_tx_id(tx)).collect();
2025-11-09T23:19:32.4890443Z  
2025-11-09T23:19:32.4890610Z          let mut proof = Vec::new();
2025-11-09T23:19:32.4890807Z          let mut current_level = tx_hashes.clone();
2025-11-09T23:19:32.4891258Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:501:
2025-11-09T23:19:32.4891438Z                      combined.extend_from_slice(&chunk[1]);
2025-11-09T23:19:32.4891639Z                      let parent_hash = double_sha256(&combined);
2025-11-09T23:19:32.4891806Z                      next_level.push(parent_hash);
2025-11-09T23:19:32.4891925Z -                    
2025-11-09T23:19:32.4892032Z +
2025-11-09T23:19:32.4892222Z                      // Check if we need to add sibling to proof
2025-11-09T23:19:32.4892367Z                      if !proof_added {
2025-11-09T23:19:32.4892520Z                          for &idx in tx_indices {
2025-11-09T23:19:32.4892966Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:581:
2025-11-09T23:19:32.4893133Z                              for tx in &b.transactions {
2025-11-09T23:19:32.4893519Z                                  let txid = calculate_tx_id(tx);
2025-11-09T23:19:32.4893710Z                                  let txid_hex = hex::encode(txid);
2025-11-09T23:19:32.4894010Z -                                if txids.iter().any(|tid| tid.as_str() == Some(txid_hex.as_str())) {
2025-11-09T23:19:32.4894147Z +                                if txids
2025-11-09T23:19:32.4894462Z +                                    .iter()
2025-11-09T23:19:32.4894696Z +                                    .any(|tid| tid.as_str() == Some(txid_hex.as_str()))
2025-11-09T23:19:32.4894826Z +                                {
2025-11-09T23:19:32.4894977Z                                      block = Some(b);
2025-11-09T23:19:32.4895121Z                                      break;
2025-11-09T23:19:32.4895244Z                                  }
2025-11-09T23:19:32.4895694Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:601:
2025-11-09T23:19:32.4895955Z                  for (idx, tx) in block.transactions.iter().enumerate() {
2025-11-09T23:19:32.4896120Z                      let txid = calculate_tx_id(tx);
2025-11-09T23:19:32.4896291Z                      let txid_hex = hex::encode(txid);
2025-11-09T23:19:32.4896588Z -                    if txids.iter().any(|tid| tid.as_str() == Some(txid_hex.as_str())) {
2025-11-09T23:19:32.4896716Z +                    if txids
2025-11-09T23:19:32.4896840Z +                        .iter()
2025-11-09T23:19:32.4897052Z +                        .any(|tid| tid.as_str() == Some(txid_hex.as_str()))
2025-11-09T23:19:32.4897178Z +                    {
2025-11-09T23:19:32.4897335Z                          tx_indices.push(idx);
2025-11-09T23:19:32.4897449Z                      }
2025-11-09T23:19:32.4897563Z                  }
2025-11-09T23:19:32.4899729Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:608:
2025-11-09T23:19:32.4899839Z  
2025-11-09T23:19:32.4899994Z                  if tx_indices.is_empty() {
2025-11-09T23:19:32.4900683Z -                    return Err(RpcError::invalid_params("None of the specified transactions found in block"));
2025-11-09T23:19:32.4900882Z +                    return Err(RpcError::invalid_params(
2025-11-09T23:19:32.4901330Z +                        "None of the specified transactions found in block",
2025-11-09T23:19:32.4901459Z +                    ));
2025-11-09T23:19:32.4901571Z                  }
2025-11-09T23:19:32.4901680Z  
2025-11-09T23:19:32.4901826Z                  // Build merkle proof
2025-11-09T23:19:32.4902275Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:614:
2025-11-09T23:19:32.4902642Z                  let proof_hashes = Self::build_merkle_proof(&block.transactions, &tx_indices)
2025-11-09T23:19:32.4903053Z -                    .map_err(|e| RpcError::internal_error(format!("Failed to build merkle proof: {}", e)))?;
2025-11-09T23:19:32.4903193Z +                    .map_err(|e| {
2025-11-09T23:19:32.4903562Z +                        RpcError::internal_error(format!("Failed to build merkle proof: {}", e))
2025-11-09T23:19:32.4903682Z +                    })?;
2025-11-09T23:19:32.4903799Z  
2025-11-09T23:19:32.4904141Z                  // Serialize proof (simplified - Bitcoin Core uses a more complex format)
2025-11-09T23:19:32.4904481Z                  let mut proof_bytes = Vec::new();
2025-11-09T23:19:32.4904950Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:626:
2025-11-09T23:19:32.4905170Z                  Err(RpcError::invalid_params("Block not found"))
2025-11-09T23:19:32.4905286Z              }
2025-11-09T23:19:32.4905400Z          } else {
2025-11-09T23:19:32.4905746Z -            Err(RpcError::invalid_params("RPC not initialized with dependencies"))
2025-11-09T23:19:32.4905913Z +            Err(RpcError::invalid_params(
2025-11-09T23:19:32.4906102Z +                "RPC not initialized with dependencies",
2025-11-09T23:19:32.4906224Z +            ))
2025-11-09T23:19:32.4906561Z          }
2025-11-09T23:19:32.4906676Z      }
2025-11-09T23:19:32.4906796Z  
2025-11-09T23:19:32.4907261Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:650:
2025-11-09T23:19:32.4907397Z              // Decode proof
2025-11-09T23:19:32.4907584Z              let proof_bytes = hex::decode(proof_hex)
2025-11-09T23:19:32.4907941Z                  .map_err(|e| RpcError::invalid_params(format!("Invalid proof hex: {}", e)))?;
2025-11-09T23:19:32.4908057Z -            
2025-11-09T23:19:32.4908166Z +
2025-11-09T23:19:32.4908327Z              if proof_bytes.is_empty() {
2025-11-09T23:19:32.4908567Z                  return Err(RpcError::invalid_params("Empty proof"));
2025-11-09T23:19:32.4908684Z              }
2025-11-09T23:19:32.4909122Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:681:
2025-11-09T23:19:32.4909430Z              if let Ok(Some(block)) = storage.blocks().get_block(&blockhash_array) {
2025-11-09T23:19:32.4909609Z                  // Calculate merkle root from block
2025-11-09T23:19:32.4909844Z                  use bllvm_protocol::mining::calculate_merkle_root;
2025-11-09T23:19:32.4910149Z -                let calculated_root = calculate_merkle_root(&block.transactions)
2025-11-09T23:19:32.4910970Z -                    .map_err(|e| RpcError::internal_error(format!("Failed to calculate merkle root: {}", e)))?;
2025-11-09T23:19:32.4911367Z +                let calculated_root = calculate_merkle_root(&block.transactions).map_err(|e| {
2025-11-09T23:19:32.4911739Z +                    RpcError::internal_error(format!("Failed to calculate merkle root: {}", e))
2025-11-09T23:19:32.4911854Z +                })?;
2025-11-09T23:19:32.4911967Z  
2025-11-09T23:19:32.4912372Z                  // Verify proof by reconstructing root (simplified - would need txids from proof)
2025-11-09T23:19:32.4912644Z                  // For now, just verify the block's merkle root matches the header
2025-11-09T23:19:32.4913107Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:690:
2025-11-09T23:19:32.4913462Z  
2025-11-09T23:19:32.4913926Z                  // Extract transaction IDs from proof (simplified - full implementation would decode txids)
2025-11-09T23:19:32.4914121Z                  use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:19:32.4914503Z -                let txids: Vec<String> = block.transactions.iter()
2025-11-09T23:19:32.4914657Z +                let txids: Vec<String> = block
2025-11-09T23:19:32.4914778Z +                    .transactions
2025-11-09T23:19:32.4914889Z +                    .iter()
2025-11-09T23:19:32.4915067Z                      .map(|tx| hex::encode(calculate_tx_id(tx)))
2025-11-09T23:19:32.4915179Z                      .collect();
2025-11-09T23:19:32.4915276Z  
2025-11-09T23:19:32.4915681Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:703:
2025-11-09T23:19:32.4915877Z                  Err(RpcError::invalid_params("Block not found"))
2025-11-09T23:19:32.4915988Z              }
2025-11-09T23:19:32.4916098Z          } else {
2025-11-09T23:19:32.4916409Z -            Err(RpcError::invalid_params("RPC not initialized with dependencies"))
2025-11-09T23:19:32.4916552Z +            Err(RpcError::invalid_params(
2025-11-09T23:19:32.4916717Z +                "RPC not initialized with dependencies",
2025-11-09T23:19:32.4916825Z +            ))
2025-11-09T23:19:32.4916929Z          }
2025-11-09T23:19:32.4917030Z      }
2025-11-09T23:19:32.4917128Z  }
2025-11-09T23:19:32.4974220Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:54:
2025-11-09T23:19:32.4974523Z      }
2025-11-09T23:19:32.4974646Z  
2025-11-09T23:19:32.4974851Z      /// Create a new RPC server with authentication
2025-11-09T23:19:32.4974986Z -    pub fn with_auth(
2025-11-09T23:19:32.4975122Z -        addr: SocketAddr,
2025-11-09T23:19:32.4975330Z -        auth_manager: Arc<auth::RpcAuthManager>,
2025-11-09T23:19:32.4975686Z -    ) -> Self {
2025-11-09T23:19:32.4976095Z +    pub fn with_auth(addr: SocketAddr, auth_manager: Arc<auth::RpcAuthManager>) -> Self {
2025-11-09T23:19:32.4976216Z          Self {
2025-11-09T23:19:32.4976331Z              addr,
2025-11-09T23:19:32.4976584Z              blockchain: Arc::new(blockchain::BlockchainRpc::new()),
2025-11-09T23:19:32.4977042Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:134:
2025-11-09T23:19:32.4977213Z              control: Arc::clone(&self.control),
2025-11-09T23:19:32.4977390Z              auth_manager: self.auth_manager.clone(),
2025-11-09T23:19:32.4977504Z          });
2025-11-09T23:19:32.4977623Z -        
2025-11-09T23:19:32.4977734Z +
2025-11-09T23:19:32.4977851Z          loop {
2025-11-09T23:19:32.4978020Z              match listener.accept().await {
2025-11-09T23:19:32.4978166Z                  Ok((stream, addr)) => {
2025-11-09T23:19:32.4978614Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:141:
2025-11-09T23:19:32.4978816Z                      debug!("New RPC connection from {}", addr);
2025-11-09T23:19:32.4978976Z                      let peer_addr = addr;
2025-11-09T23:19:32.4979140Z                      let server = Arc::clone(&server);
2025-11-09T23:19:32.4979256Z -                    
2025-11-09T23:19:32.4979373Z +
2025-11-09T23:19:32.4979538Z                      // Spawn task to handle connection
2025-11-09T23:19:32.4979696Z                      tokio::spawn(async move {
2025-11-09T23:19:32.4980016Z                          // Use hyper for HTTP - it will handle protocol detection and parsing
2025-11-09T23:19:32.4980453Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:148:
2025-11-09T23:19:32.4980614Z                          let io = TokioIo::new(stream);
2025-11-09T23:19:32.4980780Z                          let service = service_fn(move |req| {
2025-11-09T23:19:32.4981500Z -                            Self::handle_http_request_with_server(Arc::clone(&server), req, peer_addr)
2025-11-09T23:19:32.4981891Z +                            Self::handle_http_request_with_server(
2025-11-09T23:19:32.4982049Z +                                Arc::clone(&server),
2025-11-09T23:19:32.4982182Z +                                req,
2025-11-09T23:19:32.4982317Z +                                peer_addr,
2025-11-09T23:19:32.4982431Z +                            )
2025-11-09T23:19:32.4982551Z                          });
2025-11-09T23:19:32.4982668Z -                        
2025-11-09T23:19:32.4982773Z +
2025-11-09T23:19:32.4982922Z                          // Try to serve as HTTP
2025-11-09T23:19:32.4983111Z -                        if let Err(e) = http1::Builder::new()
2025-11-09T23:19:32.4983270Z -                            .serve_connection(io, service)
2025-11-09T23:19:32.4983389Z -                            .await
2025-11-09T23:19:32.4983519Z -                        {
2025-11-09T23:19:32.4984490Z +                        if let Err(e) = http1::Builder::new().serve_connection(io, service).await {
2025-11-09T23:19:32.4984722Z                              // If hyper fails, it might be raw TCP
2025-11-09T23:19:32.4985016Z                              // But we can't recover here since hyper consumed the connection
2025-11-09T23:19:32.4985335Z                              // For now, log and continue - raw TCP support would need separate port
2025-11-09T23:19:32.4985798Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:161:
2025-11-09T23:19:32.4986175Z -                            debug!("HTTP connection failed from {} (might be raw TCP): {}", peer_addr, e);
2025-11-09T23:19:32.4986307Z +                            debug!(
2025-11-09T23:19:32.4986556Z +                                "HTTP connection failed from {} (might be raw TCP): {}",
2025-11-09T23:19:32.4986702Z +                                peer_addr, e
2025-11-09T23:19:32.4986834Z +                            );
2025-11-09T23:19:32.4986954Z                          }
2025-11-09T23:19:32.4987308Z                      });
2025-11-09T23:19:32.4987436Z                  }
2025-11-09T23:19:32.4987888Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:185:
2025-11-09T23:19:32.4988001Z  
2025-11-09T23:19:32.4988201Z          // Extract headers before consuming request body
2025-11-09T23:19:32.4988377Z          let headers = req.headers().clone();
2025-11-09T23:19:32.4988491Z -        
2025-11-09T23:19:32.4988600Z +
2025-11-09T23:19:32.4988750Z          // Check Content-Type
2025-11-09T23:19:32.4989000Z          if let Some(content_type) = headers.get("content-type") {
2025-11-09T23:19:32.4989182Z              if content_type != "application/json" {
2025-11-09T23:19:32.4989638Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:196:
2025-11-09T23:19:32.4989808Z          // Read request body with size limit
2025-11-09T23:19:32.4989957Z          let body = req.collect().await?;
2025-11-09T23:19:32.4990127Z          let body_bytes = body.to_bytes();
2025-11-09T23:19:32.4990250Z -        
2025-11-09T23:19:32.4990368Z +
2025-11-09T23:19:32.4990520Z          // Enforce maximum request size
2025-11-09T23:19:32.4990694Z          if body_bytes.len() > MAX_REQUEST_SIZE {
2025-11-09T23:19:32.4990875Z              return Ok(Self::http_error_response(
2025-11-09T23:19:32.4991753Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:203:
2025-11-09T23:19:32.4991948Z                  StatusCode::PAYLOAD_TOO_LARGE,
2025-11-09T23:19:32.4992525Z -                &format!("Request body too large: {} bytes (max: {} bytes)", body_bytes.len(), MAX_REQUEST_SIZE),
2025-11-09T23:19:32.4992654Z +                &format!(
2025-11-09T23:19:32.4992874Z +                    "Request body too large: {} bytes (max: {} bytes)",
2025-11-09T23:19:32.4993028Z +                    body_bytes.len(),
2025-11-09T23:19:32.4993166Z +                    MAX_REQUEST_SIZE
2025-11-09T23:19:32.4993285Z +                ),
2025-11-09T23:19:32.4993413Z              ));
2025-11-09T23:19:32.4993528Z          }
2025-11-09T23:19:32.4993861Z  
2025-11-09T23:19:32.4994515Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:221:
2025-11-09T23:19:32.4994768Z          // Authenticate request if authentication is enabled
2025-11-09T23:19:32.4994981Z          if let Some(ref auth_manager) = server.auth_manager {
2025-11-09T23:19:32.4995318Z              let auth_result = auth_manager.authenticate_request(&headers, addr).await;
2025-11-09T23:19:32.4995446Z -            
2025-11-09T23:19:32.4995561Z +
2025-11-09T23:19:32.4995729Z              // Check if authentication failed
2025-11-09T23:19:32.4995907Z              if let Some(error) = auth_result.error {
2025-11-09T23:19:32.4996099Z -                return Ok(Self::http_error_response(
2025-11-09T23:19:32.4996266Z -                    StatusCode::UNAUTHORIZED,
2025-11-09T23:19:32.4996392Z -                    &error,
2025-11-09T23:19:32.4996522Z -                ));
2025-11-09T23:19:32.4996867Z +                return Ok(Self::http_error_response(StatusCode::UNAUTHORIZED, &error));
2025-11-09T23:19:32.4996986Z              }
2025-11-09T23:19:32.4997102Z  
2025-11-09T23:19:32.4997242Z              // Check rate limiting
2025-11-09T23:19:32.4997690Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:243:
2025-11-09T23:19:32.4997800Z  
2025-11-09T23:19:32.4998114Z          // Process JSON-RPC request (reuse server instance with cached handlers)
2025-11-09T23:19:32.4998435Z          let response = Self::process_request_with_server(server, &json_body).await;
2025-11-09T23:19:32.4998572Z -        let response_json =
2025-11-09T23:19:32.4998885Z -            serde_json::to_string(&response).unwrap_or_else(|_| "{}".to_string());
2025-11-09T23:19:32.4999300Z +        let response_json = serde_json::to_string(&response).unwrap_or_else(|_| "{}".to_string());
2025-11-09T23:19:32.4999413Z  
2025-11-09T23:19:32.4999562Z          // Build HTTP response
2025-11-09T23:19:32.4999968Z          Ok(Response::builder()
2025-11-09T23:19:32.5000426Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:255:
2025-11-09T23:19:32.5000556Z              .unwrap())
2025-11-09T23:19:32.5000678Z      }
2025-11-09T23:19:32.5000784Z  
2025-11-09T23:19:32.5000893Z -
2025-11-09T23:19:32.5001259Z      /// Create HTTP error response
2025-11-09T23:19:32.5001648Z      fn http_error_response(status: StatusCode, message: &str) -> Response<Full<Bytes>> {
2025-11-09T23:19:32.5001780Z          let body = json!({
2025-11-09T23:19:32.5002220Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:321:
2025-11-09T23:19:32.5002647Z      async fn call_method(&self, method: &str, params: Value) -> Result<Value, errors::RpcError> {
2025-11-09T23:19:32.5002771Z          match method {
2025-11-09T23:19:32.5002935Z              // Blockchain methods
2025-11-09T23:19:32.5003089Z -            "getblockchaininfo" => {
2025-11-09T23:19:32.5003229Z -                self.blockchain
2025-11-09T23:19:32.5003381Z -                    .get_blockchain_info()
2025-11-09T23:19:32.5003500Z -                    .await
2025-11-09T23:19:32.5003745Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:19:32.5003859Z -            }
2025-11-09T23:19:32.5004015Z +            "getblockchaininfo" => self
2025-11-09T23:19:32.5004142Z +                .blockchain
2025-11-09T23:19:32.5004465Z +                .get_blockchain_info()
2025-11-09T23:19:32.5004600Z +                .await
2025-11-09T23:19:32.5004878Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:19:32.5005009Z              "getblock" => {
2025-11-09T23:19:32.5005282Z                  let hash = params.get(0).and_then(|p| p.as_str()).unwrap_or("");
2025-11-09T23:19:32.5005430Z                  self.blockchain
2025-11-09T23:19:32.5005878Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:349:
2025-11-09T23:19:32.5006012Z                      .await
2025-11-09T23:19:32.5006498Z                      .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:19:32.5006624Z              }
2025-11-09T23:19:32.5006769Z -            "getbestblockhash" => {
2025-11-09T23:19:32.5006901Z -                self.blockchain
2025-11-09T23:19:32.5007047Z -                    .get_best_block_hash()
2025-11-09T23:19:32.5018623Z -                    .await
2025-11-09T23:19:32.5018970Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:19:32.5019094Z -            }
2025-11-09T23:19:32.5019243Z -            "getblockcount" => {
2025-11-09T23:19:32.5019391Z -                self.blockchain
2025-11-09T23:19:32.5019536Z -                    .get_block_count()
2025-11-09T23:19:32.5019663Z -                    .await
2025-11-09T23:19:32.5019944Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:19:32.5020077Z -            }
2025-11-09T23:19:32.5020231Z -            "getdifficulty" => {
2025-11-09T23:19:32.5020371Z -                self.blockchain
2025-11-09T23:19:32.5020521Z -                    .get_difficulty()
2025-11-09T23:19:32.5020640Z -                    .await
2025-11-09T23:19:32.5020895Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:19:32.5021013Z -            }
2025-11-09T23:19:32.5021151Z -            "gettxoutsetinfo" => {
2025-11-09T23:19:32.5021281Z -                self.blockchain
2025-11-09T23:19:32.5021420Z -                    .get_txoutset_info()
2025-11-09T23:19:32.5021543Z -                    .await
2025-11-09T23:19:32.5021785Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:19:32.5021893Z -            }
2025-11-09T23:19:32.5022050Z +            "getbestblockhash" => self
2025-11-09T23:19:32.5022172Z +                .blockchain
2025-11-09T23:19:32.5022574Z +                .get_best_block_hash()
2025-11-09T23:19:32.5022697Z +                .await
2025-11-09T23:19:32.5022964Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:19:32.5023109Z +            "getblockcount" => self
2025-11-09T23:19:32.5023236Z +                .blockchain
2025-11-09T23:19:32.5023371Z +                .get_block_count()
2025-11-09T23:19:32.5023484Z +                .await
2025-11-09T23:19:32.5023736Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:19:32.5023882Z +            "getdifficulty" => self
2025-11-09T23:19:32.5024005Z +                .blockchain
2025-11-09T23:19:32.5024135Z +                .get_difficulty()
2025-11-09T23:19:32.5024246Z +                .await
2025-11-09T23:19:32.5024672Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:19:32.5024818Z +            "gettxoutsetinfo" => self
2025-11-09T23:19:32.5024941Z +                .blockchain
2025-11-09T23:19:32.5025100Z +                .get_txoutset_info()
2025-11-09T23:19:32.5025227Z +                .await
2025-11-09T23:19:32.5025497Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:19:32.5025638Z              "verifychain" => {
2025-11-09T23:19:32.5025898Z                  let checklevel = params.get(0).and_then(|p| p.as_u64());
2025-11-09T23:19:32.5026137Z                  let numblocks = params.get(1).and_then(|p| p.as_u64());
2025-11-09T23:19:32.5026609Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:381:
2025-11-09T23:19:32.5026751Z                      .await
2025-11-09T23:19:32.5027027Z                      .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:19:32.5027143Z              }
2025-11-09T23:19:32.5027295Z -            "getchaintips" => {
2025-11-09T23:19:32.5027430Z -                self.blockchain
2025-11-09T23:19:32.5027572Z -                    .get_chain_tips()
2025-11-09T23:19:32.5027705Z -                    .await
2025-11-09T23:19:32.5028225Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:19:32.5028355Z -            }
2025-11-09T23:19:32.5028509Z -            "getchaintxstats" => {
2025-11-09T23:19:32.5030507Z -                self.blockchain
2025-11-09T23:19:32.5030674Z -                    .get_chain_tx_stats(&params)
2025-11-09T23:19:32.5031324Z -                    .await
2025-11-09T23:19:32.5031652Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:19:32.5031773Z -            }
2025-11-09T23:19:32.5032009Z -            "getblockstats" => {
2025-11-09T23:19:32.5032151Z -                self.blockchain
2025-11-09T23:19:32.5032321Z -                    .get_block_stats(&params)
2025-11-09T23:19:32.5032444Z -                    .await
2025-11-09T23:19:32.5032715Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:19:32.5032856Z -            }
2025-11-09T23:19:32.5033008Z -            "pruneblockchain" => {
2025-11-09T23:19:32.5033152Z -                self.blockchain
2025-11-09T23:19:32.5033312Z -                    .prune_blockchain(&params)
2025-11-09T23:19:32.5033446Z -                    .await
2025-11-09T23:19:32.5033709Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:19:32.5033829Z -            }
2025-11-09T23:19:32.5033985Z -            "getpruneinfo" => {
2025-11-09T23:19:32.5034119Z -                self.blockchain
2025-11-09T23:19:32.5034276Z -                    .get_prune_info(&params)
2025-11-09T23:19:32.5034560Z -                    .await
2025-11-09T23:19:32.5034836Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:19:32.5034954Z -            }
2025-11-09T23:19:32.5035102Z -            "invalidateblock" => {
2025-11-09T23:19:32.5035244Z -                self.blockchain
2025-11-09T23:19:32.5035407Z -                    .invalidate_block(&params)
2025-11-09T23:19:32.5035769Z -                    .await
2025-11-09T23:19:32.5036041Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:19:32.5036166Z -            }
2025-11-09T23:19:32.5036310Z -            "reconsiderblock" => {
2025-11-09T23:19:32.5036445Z -                self.blockchain
2025-11-09T23:19:32.5036613Z -                    .reconsider_block(&params)
2025-11-09T23:19:32.5036736Z -                    .await
2025-11-09T23:19:32.5036996Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:19:32.5037121Z -            }
2025-11-09T23:19:32.5037267Z -            "waitfornewblock" => {
2025-11-09T23:19:32.5037399Z -                self.blockchain
2025-11-09T23:19:32.5037559Z -                    .wait_for_new_block(&params)
2025-11-09T23:19:32.5037693Z -                    .await
2025-11-09T23:19:32.5037953Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:19:32.5038084Z -            }
2025-11-09T23:19:32.5038240Z -            "waitforblock" => {
2025-11-09T23:19:32.5038372Z -                self.blockchain
2025-11-09T23:19:32.5038530Z -                    .wait_for_block(&params)
2025-11-09T23:19:32.5038654Z -                    .await
2025-11-09T23:19:32.5040801Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:19:32.5040918Z -            }
2025-11-09T23:19:32.5041081Z -            "waitforblockheight" => {
2025-11-09T23:19:32.5041227Z -                self.blockchain
2025-11-09T23:19:32.5041403Z -                    .wait_for_block_height(&params)
2025-11-09T23:19:32.5041525Z -                    .await
2025-11-09T23:19:32.5041788Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:19:32.5041915Z -            }
2025-11-09T23:19:32.5042060Z +            "getchaintips" => self
2025-11-09T23:19:32.5042188Z +                .blockchain
2025-11-09T23:19:32.5042344Z +                .get_chain_tips()
2025-11-09T23:19:32.5042667Z +                .await
2025-11-09T23:19:32.5042949Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:19:32.5043117Z +            "getchaintxstats" => self
2025-11-09T23:19:32.5043249Z +                .blockchain
2025-11-09T23:19:32.5043410Z +                .get_chain_tx_stats(&params)
2025-11-09T23:19:32.5043529Z +                .await
2025-11-09T23:19:32.5043803Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:19:32.5043946Z +            "getblockstats" => self
2025-11-09T23:19:32.5044073Z +                .blockchain
2025-11-09T23:19:32.5044234Z +                .get_block_stats(&params)
2025-11-09T23:19:32.5044504Z +                .await
2025-11-09T23:19:32.5044779Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:19:32.5044935Z +            "pruneblockchain" => self
2025-11-09T23:19:32.5045083Z +                .blockchain
2025-11-09T23:19:32.5045247Z +                .prune_blockchain(&params)
2025-11-09T23:19:32.5045369Z +                .await
2025-11-09T23:19:32.5045634Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:19:32.5045778Z +            "getpruneinfo" => self
2025-11-09T23:19:32.5045904Z +                .blockchain
2025-11-09T23:19:32.5046052Z +                .get_prune_info(&params)
2025-11-09T23:19:32.5046187Z +                .await
2025-11-09T23:19:32.5046442Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:19:32.5046599Z +            "invalidateblock" => self
2025-11-09T23:19:32.5046735Z +                .blockchain
2025-11-09T23:19:32.5046888Z +                .invalidate_block(&params)
2025-11-09T23:19:32.5047005Z +                .await
2025-11-09T23:19:32.5047264Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:19:32.5047633Z +            "reconsiderblock" => self
2025-11-09T23:19:32.5047763Z +                .blockchain
2025-11-09T23:19:32.5047923Z +                .reconsider_block(&params)
2025-11-09T23:19:32.5048053Z +                .await
2025-11-09T23:19:32.5048317Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:19:32.5048466Z +            "waitfornewblock" => self
2025-11-09T23:19:32.5048597Z +                .blockchain
2025-11-09T23:19:32.5048755Z +                .wait_for_new_block(&params)
2025-11-09T23:19:32.5048875Z +                .await
2025-11-09T23:19:32.5049124Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:19:32.5049274Z +            "waitforblock" => self
2025-11-09T23:19:32.5049402Z +                .blockchain
2025-11-09T23:19:32.5049546Z +                .wait_for_block(&params)
2025-11-09T23:19:32.5049663Z +                .await
2025-11-09T23:19:32.5049903Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:19:32.5050059Z +            "waitforblockheight" => self
2025-11-09T23:19:32.5050183Z +                .blockchain
2025-11-09T23:19:32.5050702Z +                .wait_for_block_height(&params)
2025-11-09T23:19:32.5050825Z +                .await
2025-11-09T23:19:32.5051077Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:19:32.5051191Z  
2025-11-09T23:19:32.5051339Z              // Raw Transaction methods
2025-11-09T23:19:32.5051491Z -            "getrawtransaction" => {
2025-11-09T23:19:32.5051705Z -                self.rawtx.getrawtransaction(&params).await
2025-11-09T23:19:32.5051815Z -            }
2025-11-09T23:19:32.5051963Z -            "sendrawtransaction" => {
2025-11-09T23:19:32.5052171Z -                self.rawtx.sendrawtransaction(&params).await
2025-11-09T23:19:32.5052295Z -            }
2025-11-09T23:19:32.5052449Z -            "testmempoolaccept" => {
2025-11-09T23:19:32.5052658Z -                self.rawtx.testmempoolaccept(&params).await
2025-11-09T23:19:32.5052791Z -            }
2025-11-09T23:19:32.5053152Z -            "decoderawtransaction" => {
2025-11-09T23:19:32.5053385Z -                self.rawtx.decoderawtransaction(&params).await
2025-11-09T23:19:32.5053495Z -            }
2025-11-09T23:19:32.5053631Z -            "gettxout" => {
2025-11-09T23:19:32.5053799Z -                self.rawtx.gettxout(&params).await
2025-11-09T23:19:32.5053911Z -            }
2025-11-09T23:19:32.5054064Z -            "gettxoutproof" => {
2025-11-09T23:19:32.5054260Z -                self.rawtx.gettxoutproof(&params).await
2025-11-09T23:19:32.5054532Z -            }
2025-11-09T23:19:32.5054687Z -            "verifytxoutproof" => {
2025-11-09T23:19:32.5054901Z -                self.rawtx.verifytxoutproof(&params).await
2025-11-09T23:19:32.5055016Z -            }
2025-11-09T23:19:32.5055359Z +            "getrawtransaction" => self.rawtx.getrawtransaction(&params).await,
2025-11-09T23:19:32.5055719Z +            "sendrawtransaction" => self.rawtx.sendrawtransaction(&params).await,
2025-11-09T23:19:32.5056074Z +            "testmempoolaccept" => self.rawtx.testmempoolaccept(&params).await,
2025-11-09T23:19:32.5056454Z +            "decoderawtransaction" => self.rawtx.decoderawtransaction(&params).await,
2025-11-09T23:19:32.5056675Z +            "gettxout" => self.rawtx.gettxout(&params).await,
2025-11-09T23:19:32.5056947Z +            "gettxoutproof" => self.rawtx.gettxoutproof(&params).await,
2025-11-09T23:19:32.5057265Z +            "verifytxoutproof" => self.rawtx.verifytxoutproof(&params).await,
2025-11-09T23:19:32.5057380Z  
2025-11-09T23:19:32.5057529Z              // Mempool methods
2025-11-09T23:19:32.5057672Z -            "getmempoolinfo" => {
2025-11-09T23:19:32.5057870Z -                self.mempool.getmempoolinfo(&params).await
2025-11-09T23:19:32.5057997Z -            }
2025-11-09T23:19:32.5058137Z -            "getrawmempool" => {
2025-11-09T23:19:32.5058338Z -                self.mempool.getrawmempool(&params).await
2025-11-09T23:19:32.5058722Z -            }
2025-11-09T23:19:32.5060642Z -            "savemempool" => {
2025-11-09T23:19:32.5060844Z -                self.mempool.savemempool(&params).await
2025-11-09T23:19:32.5060961Z -            }
2025-11-09T23:19:32.5061131Z -            "getmempoolancestors" => {
2025-11-09T23:19:32.5061368Z -                self.mempool.getmempoolancestors(&params).await
2025-11-09T23:19:32.5061487Z -            }
2025-11-09T23:19:32.5061666Z -            "getmempooldescendants" => {
2025-11-09T23:19:32.5061915Z -                self.mempool.getmempooldescendants(&params).await
2025-11-09T23:19:32.5062033Z -            }
2025-11-09T23:19:32.5062178Z -            "getmempoolentry" => {
2025-11-09T23:19:32.5062408Z -                self.mempool.getmempoolentry(&params).await
2025-11-09T23:19:32.5062522Z -            }
2025-11-09T23:19:32.5062826Z +            "getmempoolinfo" => self.mempool.getmempoolinfo(&params).await,
2025-11-09T23:19:32.5063125Z +            "getrawmempool" => self.mempool.getrawmempool(&params).await,
2025-11-09T23:19:32.5063406Z +            "savemempool" => self.mempool.savemempool(&params).await,
2025-11-09T23:19:32.5063780Z +            "getmempoolancestors" => self.mempool.getmempoolancestors(&params).await,
2025-11-09T23:19:32.5064192Z +            "getmempooldescendants" => self.mempool.getmempooldescendants(&params).await,
2025-11-09T23:19:32.5064653Z +            "getmempoolentry" => self.mempool.getmempoolentry(&params).await,
2025-11-09T23:19:32.5064773Z  
2025-11-09T23:19:32.5064913Z              // Network methods
2025-11-09T23:19:32.5065072Z -            "getnetworkinfo" => {
2025-11-09T23:19:32.5065245Z -                self.network.get_network_info().await
2025-11-09T23:19:32.5065361Z -            }
2025-11-09T23:19:32.5065508Z -            "getpeerinfo" => {
2025-11-09T23:19:32.5065666Z -                self.network.get_peer_info().await
2025-11-09T23:19:32.5065785Z -            }
2025-11-09T23:19:32.5065942Z -            "getconnectioncount" => {
2025-11-09T23:19:32.5066188Z -                self.network.get_connection_count(&params).await
2025-11-09T23:19:32.5066525Z -            }
2025-11-09T23:19:32.5066666Z -            "ping" => {
2025-11-09T23:19:32.5066857Z -                self.network.ping(&params).await
2025-11-09T23:19:32.5066974Z -            }
2025-11-09T23:19:32.5067106Z -            "addnode" => {
2025-11-09T23:19:32.5067279Z -                self.network.add_node(&params).await
2025-11-09T23:19:32.5067407Z -            }
2025-11-09T23:19:32.5067553Z -            "disconnectnode" => {
2025-11-09T23:19:32.5067762Z -                self.network.disconnect_node(&params).await
2025-11-09T23:19:32.5067886Z -            }
2025-11-09T23:19:32.5068025Z -            "getnettotals" => {
2025-11-09T23:19:32.5068223Z -                self.network.get_net_totals(&params).await
2025-11-09T23:19:32.5068337Z -            }
2025-11-09T23:19:32.5068480Z -            "clearbanned" => {
2025-11-09T23:19:32.5070558Z -                self.network.clear_banned(&params).await
2025-11-09T23:19:32.5070682Z -            }
2025-11-09T23:19:32.5070827Z -            "setban" => {
2025-11-09T23:19:32.5071004Z -                self.network.set_ban(&params).await
2025-11-09T23:19:32.5071122Z -            }
2025-11-09T23:19:32.5071259Z -            "listbanned" => {
2025-11-09T23:19:32.5071449Z -                self.network.list_banned(&params).await
2025-11-09T23:19:32.5071569Z -            }
2025-11-09T23:19:32.5071717Z -            "getaddednodeinfo" => {
2025-11-09T23:19:32.5071941Z -                self.network.getaddednodeinfo(&params).await
2025-11-09T23:19:32.5072050Z -            }
2025-11-09T23:19:32.5072193Z -            "getnodeaddresses" => {
2025-11-09T23:19:32.5072415Z -                self.network.getnodeaddresses(&params).await
2025-11-09T23:19:32.5072530Z -            }
2025-11-09T23:19:32.5072672Z -            "setnetworkactive" => {
2025-11-09T23:19:32.5072880Z -                self.network.setnetworkactive(&params).await
2025-11-09T23:19:32.5073004Z -            }
2025-11-09T23:19:32.5073552Z +            "getnetworkinfo" => self.network.get_network_info().await,
2025-11-09T23:19:32.5073790Z +            "getpeerinfo" => self.network.get_peer_info().await,
2025-11-09T23:19:32.5074158Z +            "getconnectioncount" => self.network.get_connection_count(&params).await,
2025-11-09T23:19:32.5074569Z +            "ping" => self.network.ping(&params).await,
2025-11-09T23:19:32.5074791Z +            "addnode" => self.network.add_node(&params).await,
2025-11-09T23:19:32.5075101Z +            "disconnectnode" => self.network.disconnect_node(&params).await,
2025-11-09T23:19:32.5075392Z +            "getnettotals" => self.network.get_net_totals(&params).await,
2025-11-09T23:19:32.5075653Z +            "clearbanned" => self.network.clear_banned(&params).await,
2025-11-09T23:19:32.5075859Z +            "setban" => self.network.set_ban(&params).await,
2025-11-09T23:19:32.5076109Z +            "listbanned" => self.network.list_banned(&params).await,
2025-11-09T23:19:32.5076453Z +            "getaddednodeinfo" => self.network.getaddednodeinfo(&params).await,
2025-11-09T23:19:32.5076788Z +            "getnodeaddresses" => self.network.getnodeaddresses(&params).await,
2025-11-09T23:19:32.5077112Z +            "setnetworkactive" => self.network.setnetworkactive(&params).await,
2025-11-09T23:19:32.5077224Z  
2025-11-09T23:19:32.5077354Z              // Mining methods
2025-11-09T23:19:32.5077490Z -            "getmininginfo" => {
2025-11-09T23:19:32.5077663Z -                self.mining.get_mining_info().await
2025-11-09T23:19:32.5077772Z -            }
2025-11-09T23:19:32.5077911Z -            "getblocktemplate" => {
2025-11-09T23:19:32.5078118Z -                self.mining.get_block_template(&params).await
2025-11-09T23:19:32.5078225Z -            }
2025-11-09T23:19:32.5078355Z -            "submitblock" => {
2025-11-09T23:19:32.5078538Z -                self.mining.submit_block(&params).await
2025-11-09T23:19:32.5078646Z -            }
2025-11-09T23:19:32.5078793Z -            "estimatesmartfee" => {
2025-11-09T23:19:32.5079205Z -                self.mining.estimate_smart_fee(&params).await
2025-11-09T23:19:32.5079328Z -            }
2025-11-09T23:19:32.5079492Z -            "prioritisetransaction" => {
2025-11-09T23:19:32.5079714Z -                self.mining.prioritise_transaction(&params).await
2025-11-09T23:19:32.5079830Z -            }
2025-11-09T23:19:32.5079967Z -            "getblockfilter" => {
2025-11-09T23:19:32.5080097Z -                self.blockchain
2025-11-09T23:19:32.5080248Z -                    .get_block_filter(&params)
2025-11-09T23:19:32.5080371Z -                    .await
2025-11-09T23:19:32.5083034Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:19:32.5083149Z -            }
2025-11-09T23:19:32.5083286Z -            "getindexinfo" => {
2025-11-09T23:19:32.5083413Z -                self.blockchain
2025-11-09T23:19:32.5083559Z -                    .get_index_info(&params)
2025-11-09T23:19:32.5083676Z -                    .await
2025-11-09T23:19:32.5083956Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:19:32.5084068Z -            }
2025-11-09T23:19:32.5084456Z +            "getmininginfo" => self.mining.get_mining_info().await,
2025-11-09T23:19:32.5084801Z +            "getblocktemplate" => self.mining.get_block_template(&params).await,
2025-11-09T23:19:32.5085051Z +            "submitblock" => self.mining.submit_block(&params).await,
2025-11-09T23:19:32.5085363Z +            "estimatesmartfee" => self.mining.estimate_smart_fee(&params).await,
2025-11-09T23:19:32.5085742Z +            "prioritisetransaction" => self.mining.prioritise_transaction(&params).await,
2025-11-09T23:19:32.5085885Z +            "getblockfilter" => self
2025-11-09T23:19:32.5086013Z +                .blockchain
2025-11-09T23:19:32.5086166Z +                .get_block_filter(&params)
2025-11-09T23:19:32.5086287Z +                .await
2025-11-09T23:19:32.5086552Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:19:32.5086962Z +            "getindexinfo" => self
2025-11-09T23:19:32.5087098Z +                .blockchain
2025-11-09T23:19:32.5087254Z +                .get_index_info(&params)
2025-11-09T23:19:32.5087374Z +                .await
2025-11-09T23:19:32.5087656Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:19:32.5087773Z  
2025-11-09T23:19:32.5087909Z              // Control methods
2025-11-09T23:19:32.5088048Z -            "stop" => {
2025-11-09T23:19:32.5088227Z -                self.control.stop(&params).await
2025-11-09T23:19:32.5088343Z -            }
2025-11-09T23:19:32.5088476Z -            "uptime" => {
2025-11-09T23:19:32.5088663Z -                self.control.uptime(&params).await
2025-11-09T23:19:32.5088779Z -            }
2025-11-09T23:19:32.5088921Z -            "getmemoryinfo" => {
2025-11-09T23:19:32.5089129Z -                self.control.getmemoryinfo(&params).await
2025-11-09T23:19:32.5089257Z -            }
2025-11-09T23:19:32.5089392Z -            "getrpcinfo" => {
2025-11-09T23:19:32.5089594Z -                self.control.getrpcinfo(&params).await
2025-11-09T23:19:32.5089705Z -            }
2025-11-09T23:19:32.5089830Z -            "help" => {
2025-11-09T23:19:32.5089996Z -                self.control.help(&params).await
2025-11-09T23:19:32.5090121Z -            }
2025-11-09T23:19:32.5090252Z -            "logging" => {
2025-11-09T23:19:32.5090426Z -                self.control.logging(&params).await
2025-11-09T23:19:32.5092537Z -            }
2025-11-09T23:19:32.5092668Z -            "gethealth" => {
2025-11-09T23:19:32.5092849Z -                self.control.gethealth(&params).await
2025-11-09T23:19:32.5092963Z -            }
2025-11-09T23:19:32.5093106Z -            "getmetrics" => {
2025-11-09T23:19:32.5093288Z -                self.control.getmetrics(&params).await
2025-11-09T23:19:32.5093405Z -            }
2025-11-09T23:19:32.5093607Z +            "stop" => self.control.stop(&params).await,
2025-11-09T23:19:32.5093826Z +            "uptime" => self.control.uptime(&params).await,
2025-11-09T23:19:32.5094550Z +            "getmemoryinfo" => self.control.getmemoryinfo(&params).await,
2025-11-09T23:19:32.5094838Z +            "getrpcinfo" => self.control.getrpcinfo(&params).await,
2025-11-09T23:19:32.5095041Z +            "help" => self.control.help(&params).await,
2025-11-09T23:19:32.5095255Z +            "logging" => self.control.logging(&params).await,
2025-11-09T23:19:32.5095487Z +            "gethealth" => self.control.gethealth(&params).await,
2025-11-09T23:19:32.5095735Z +            "getmetrics" => self.control.getmetrics(&params).await,
2025-11-09T23:19:32.5095848Z  
2025-11-09T23:19:32.5096074Z              _ => Err(errors::RpcError::method_not_found(method)),
2025-11-09T23:19:32.5096198Z          }
2025-11-09T23:19:32.5096648Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:605:
2025-11-09T23:19:32.5096804Z          // Start server on random port
2025-11-09T23:19:32.5097145Z          let listener = tokio::net::TcpListener::bind("127.0.0.1:0").await.unwrap();
2025-11-09T23:19:32.5097346Z          let server_addr = listener.local_addr().unwrap();
2025-11-09T23:19:32.5097453Z -        
2025-11-09T23:19:32.5097559Z +
2025-11-09T23:19:32.5097726Z          // Spawn server task using hyper
2025-11-09T23:19:32.5097916Z          let server_handle = tokio::spawn(async move {
2025-11-09T23:19:32.5098038Z              loop {
2025-11-09T23:19:32.5098468Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:617:
2025-11-09T23:19:32.5098638Z                              let service = service_fn(move |req| {
2025-11-09T23:19:32.5098859Z                                  RpcServer::handle_http_request(req, peer_addr)
2025-11-09T23:19:32.5098988Z                              });
2025-11-09T23:19:32.5099167Z -                            let _ = http1::Builder::new()
2025-11-09T23:19:32.5099340Z -                                .serve_connection(io, service)
2025-11-09T23:19:32.5099688Z -                                .await;
2025-11-09T23:19:32.5099985Z +                            let _ = http1::Builder::new().serve_connection(io, service).await;
2025-11-09T23:19:32.5100114Z                          });
2025-11-09T23:19:32.5100231Z                      }
2025-11-09T23:19:32.5100376Z                      Err(_) => break,
2025-11-09T23:19:32.5100804Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:632:
2025-11-09T23:19:32.5100913Z  
2025-11-09T23:19:32.5102733Z          // Connect to server
2025-11-09T23:19:32.5103062Z          let mut client = TokioTcpStream::connect(server_addr).await.unwrap();
2025-11-09T23:19:32.5103178Z -        
2025-11-09T23:19:32.5103290Z +
2025-11-09T23:19:32.5103444Z          // Send HTTP POST request
2025-11-09T23:19:32.5103726Z          let json_body = r#"{"jsonrpc":"2.0","method":"ping","params":[],"id":1}"#;
2025-11-09T23:19:32.5103870Z          let http_request = format!(
2025-11-09T23:19:32.5104463Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:645:
2025-11-09T23:19:32.5104610Z              json_body.len(),
2025-11-09T23:19:32.5104728Z              json_body
2025-11-09T23:19:32.5104843Z          );
2025-11-09T23:19:32.5104962Z -        
2025-11-09T23:19:32.5105069Z +
2025-11-09T23:19:32.5105312Z          client.write_all(http_request.as_bytes()).await.unwrap();
2025-11-09T23:19:32.5105416Z -        
2025-11-09T23:19:32.5105520Z +
2025-11-09T23:19:32.5105637Z          // Read response
2025-11-09T23:19:32.5105779Z          let mut response = vec![0u8; 4096];
2025-11-09T23:19:32.5105942Z          let n = tokio::time::timeout(
2025-11-09T23:19:32.5106915Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:654:
2025-11-09T23:19:32.5107102Z              tokio::time::Duration::from_secs(2),
2025-11-09T23:19:32.5107266Z -            client.read(&mut response)
2025-11-09T23:19:32.5107414Z -        ).await.unwrap().unwrap();
2025-11-09T23:19:32.5107539Z -        
2025-11-09T23:19:32.5107941Z +            client.read(&mut response),
2025-11-09T23:19:32.5108083Z +        )
2025-11-09T23:19:32.5108205Z +        .await
2025-11-09T23:19:32.5108322Z +        .unwrap()
2025-11-09T23:19:32.5108445Z +        .unwrap();
2025-11-09T23:19:32.5108557Z +
2025-11-09T23:19:32.5108833Z          let response_str = String::from_utf8_lossy(&response[..n]);
2025-11-09T23:19:32.5108944Z -        
2025-11-09T23:19:32.5109065Z +
2025-11-09T23:19:32.5109286Z          // Verify HTTP response (hyper uses lowercase headers)
2025-11-09T23:19:32.5111871Z -        assert!(response_str.contains("HTTP/1.1 200 OK") || response_str.contains("200 OK"), "Response: {}", response_str);
2025-11-09T23:19:32.5112537Z -        assert!(response_str.contains("content-type: application/json") || response_str.contains("Content-Type: application/json"));
2025-11-09T23:19:32.5112661Z +        assert!(
2025-11-09T23:19:32.5113012Z +            response_str.contains("HTTP/1.1 200 OK") || response_str.contains("200 OK"),
2025-11-09T23:19:32.5113181Z +            "Response: {}",
2025-11-09T23:19:32.5113309Z +            response_str
2025-11-09T23:19:32.5113424Z +        );
2025-11-09T23:19:32.5113541Z +        assert!(
2025-11-09T23:19:32.5113809Z +            response_str.contains("content-type: application/json")
2025-11-09T23:19:32.5114063Z +                || response_str.contains("Content-Type: application/json")
2025-11-09T23:19:32.5114177Z +        );
2025-11-09T23:19:32.5114553Z          assert!(response_str.contains("jsonrpc"));
2025-11-09T23:19:32.5114755Z          assert!(response_str.contains("\"result\""));
2025-11-09T23:19:32.5114868Z -        
2025-11-09T23:19:32.5114980Z +
2025-11-09T23:19:32.5115131Z          server_handle.abort();
2025-11-09T23:19:32.5115243Z      }
2025-11-09T23:19:32.5115354Z  
2025-11-09T23:19:32.5115808Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:669:
2025-11-09T23:19:32.5116167Z -
2025-11-09T23:19:32.5116310Z      #[tokio::test]
2025-11-09T23:19:32.5116503Z      async fn test_process_request_valid_json() {
2025-11-09T23:19:32.5116857Z          let request = r#"{"jsonrpc":"2.0","method":"getblockchaininfo","params":[],"id":1}"#;
2025-11-09T23:19:32.5117300Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:684:
2025-11-09T23:19:32.5117409Z  
2025-11-09T23:19:32.5117586Z          assert_eq!(response["jsonrpc"], "2.0");
2025-11-09T23:19:32.5117786Z          assert_eq!(response["error"]["code"], -32700);
2025-11-09T23:19:32.5118131Z -        assert!(response["error"]["message"].as_str().unwrap().contains("Parse error") || 
2025-11-09T23:19:32.5118457Z -                response["error"]["message"].as_str().unwrap().contains("Invalid JSON"));
2025-11-09T23:19:32.5118577Z +        assert!(
2025-11-09T23:19:32.5118728Z +            response["error"]["message"]
2025-11-09T23:19:32.5118855Z +                .as_str()
2025-11-09T23:19:32.5118986Z +                .unwrap()
2025-11-09T23:19:32.5119143Z +                .contains("Parse error")
2025-11-09T23:19:32.5119308Z +                || response["error"]["message"]
2025-11-09T23:19:32.5119443Z +                    .as_str()
2025-11-09T23:19:32.5119565Z +                    .unwrap()
2025-11-09T23:19:32.5119721Z +                    .contains("Invalid JSON")
2025-11-09T23:19:32.5119834Z +        );
2025-11-09T23:19:32.5119953Z      }
2025-11-09T23:19:32.5120063Z  
2025-11-09T23:19:32.5120197Z      #[tokio::test]
2025-11-09T23:19:32.5120660Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:695:
2025-11-09T23:19:32.5120771Z  
2025-11-09T23:19:32.5120933Z          assert_eq!(response["jsonrpc"], "2.0");
2025-11-09T23:19:32.5121122Z          assert_eq!(response["error"]["code"], -32601);
2025-11-09T23:19:32.5121491Z -        assert!(response["error"]["message"].as_str().unwrap().contains("Method not found"));
2025-11-09T23:19:32.5121651Z +        assert!(response["error"]["message"]
2025-11-09T23:19:32.5121777Z +            .as_str()
2025-11-09T23:19:32.5122146Z +            .unwrap()
2025-11-09T23:19:32.5122306Z +            .contains("Method not found"));
2025-11-09T23:19:32.5122453Z          assert_eq!(response["id"], 1);
2025-11-09T23:19:32.5122563Z      }
2025-11-09T23:19:32.5122677Z  
2025-11-09T23:19:32.5123113Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:822:
2025-11-09T23:19:32.5123228Z  
2025-11-09T23:19:32.5123402Z          assert_eq!(response["jsonrpc"], "2.0");
2025-11-09T23:19:32.5123597Z          assert_eq!(response["error"]["code"], -32700);
2025-11-09T23:19:32.5123948Z -        assert!(response["error"]["message"].as_str().unwrap().contains("Parse error") ||
2025-11-09T23:19:32.5124261Z -                response["error"]["message"].as_str().unwrap().contains("Invalid JSON"));
2025-11-09T23:19:32.5124557Z +        assert!(
2025-11-09T23:19:32.5124714Z +            response["error"]["message"]
2025-11-09T23:19:32.5124847Z +                .as_str()
2025-11-09T23:19:32.5124978Z +                .unwrap()
2025-11-09T23:19:32.5125133Z +                .contains("Parse error")
2025-11-09T23:19:32.5125289Z +                || response["error"]["message"]
2025-11-09T23:19:32.5125419Z +                    .as_str()
2025-11-09T23:19:32.5125544Z +                    .unwrap()
2025-11-09T23:19:32.5125697Z +                    .contains("Invalid JSON")
2025-11-09T23:19:32.5125812Z +        );
2025-11-09T23:19:32.5125939Z      }
2025-11-09T23:19:32.5126047Z  
2025-11-09T23:19:32.5126181Z      #[tokio::test]
2025-11-09T23:19:32.5126623Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:833:
2025-11-09T23:19:32.5126735Z  
2025-11-09T23:19:32.5126895Z          assert_eq!(response["jsonrpc"], "2.0");
2025-11-09T23:19:32.5127084Z          assert_eq!(response["error"]["code"], -32601);
2025-11-09T23:19:32.5127448Z -        assert!(response["error"]["message"].as_str().unwrap().contains("Method not found"));
2025-11-09T23:19:32.5127850Z +        assert!(response["error"]["message"]
2025-11-09T23:19:32.5127978Z +            .as_str()
2025-11-09T23:19:32.5128103Z +            .unwrap()
2025-11-09T23:19:32.5128259Z +            .contains("Method not found"));
2025-11-09T23:19:32.5128596Z          assert!(response["error"]["data"].is_string() || response["error"]["data"].is_null());
2025-11-09T23:19:32.5128748Z          assert_eq!(response["id"], 42);
2025-11-09T23:19:32.5128861Z      }
2025-11-09T23:19:32.5129283Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:855:
2025-11-09T23:19:32.5129389Z  
2025-11-09T23:19:32.5129558Z          assert_eq!(response["jsonrpc"], "2.0");
2025-11-09T23:19:32.5129739Z          assert_eq!(response["error"]["code"], -32601);
2025-11-09T23:19:32.5130093Z -        assert!(response["error"]["message"].as_str().unwrap().contains("Method not found"));
2025-11-09T23:19:32.5130266Z +        assert!(response["error"]["message"]
2025-11-09T23:19:32.5130400Z +            .as_str()
2025-11-09T23:19:32.5130525Z +            .unwrap()
2025-11-09T23:19:32.5130691Z +            .contains("Method not found"));
2025-11-09T23:19:32.5130851Z          assert_eq!(response["id"], 1);
2025-11-09T23:19:32.5132498Z      }
2025-11-09T23:19:32.5132603Z  
2025-11-09T23:19:32.5133136Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/blockstore.rs:2:
2025-11-09T23:19:32.5133250Z  //!
2025-11-09T23:19:32.5133500Z  //! Stores blocks by hash and maintains block index by height.
2025-11-09T23:19:32.5133622Z  
2025-11-09T23:19:32.5133828Z +use crate::storage::database::{Database, Tree};
2025-11-09T23:19:32.5133962Z  use anyhow::Result;
2025-11-09T23:19:32.5134137Z  use bllvm_protocol::segwit::Witness;
2025-11-09T23:19:32.5134500Z  use bllvm_protocol::{Block, BlockHeader, Hash};
2025-11-09T23:19:32.5134986Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/blockstore.rs:8:
2025-11-09T23:19:32.5135195Z -use crate::storage::database::{Database, Tree};
2025-11-09T23:19:32.5135341Z  use std::sync::Arc;
2025-11-09T23:19:32.5135673Z  
2025-11-09T23:19:32.5135828Z  /// Block storage manager
2025-11-09T23:19:32.5136323Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/blockstore.rs:45:
2025-11-09T23:19:32.5136439Z  
2025-11-09T23:19:32.5136685Z          self.blocks.insert(block_hash.as_slice(), &block_data)?;
2025-11-09T23:19:32.5136933Z          let header_data = bincode::serialize(&block.header)?;
2025-11-09T23:19:32.5137063Z -        self.headers
2025-11-09T23:19:32.5137263Z -            .insert(block_hash.as_slice(), &header_data)?;
2025-11-09T23:19:32.5137529Z +        self.headers.insert(block_hash.as_slice(), &header_data)?;
2025-11-09T23:19:32.5137648Z  
2025-11-09T23:19:32.5137848Z          // Store header for median time-past calculation
2025-11-09T23:19:32.5138182Z          // We'll need height passed separately, so this will be called after store_height
2025-11-09T23:19:32.5138662Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/blockstore.rs:81:
2025-11-09T23:19:32.5138823Z      /// Store witness data for a block
2025-11-09T23:19:32.5139155Z      pub fn store_witness(&self, block_hash: &Hash, witness: &[Witness]) -> Result<()> {
2025-11-09T23:19:32.5139362Z          let witness_data = bincode::serialize(witness)?;
2025-11-09T23:19:32.5139646Z -        self.witnesses.insert(block_hash.as_slice(), &witness_data)?;
2025-11-09T23:19:32.5139778Z +        self.witnesses
2025-11-09T23:19:32.5139976Z +            .insert(block_hash.as_slice(), &witness_data)?;
2025-11-09T23:19:32.5140086Z          Ok(())
2025-11-09T23:19:32.5140191Z      }
2025-11-09T23:19:32.5140688Z  
2025-11-09T23:19:32.5141176Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/chainstate.rs:2:
2025-11-09T23:19:32.5141282Z  //!
2025-11-09T23:19:32.5141579Z  //! Stores chain metadata including tip, height, and chain parameters.
2025-11-09T23:19:32.5141696Z  
2025-11-09T23:19:32.5142150Z +use crate::storage::database::{Database, Tree};
2025-11-09T23:19:32.5142294Z  use anyhow::Result;
2025-11-09T23:19:32.5142469Z  use bllvm_protocol::{BlockHeader, Hash};
2025-11-09T23:19:32.5142641Z  use serde::{Deserialize, Serialize};
2025-11-09T23:19:32.5143116Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/chainstate.rs:8:
2025-11-09T23:19:32.5143313Z -use crate::storage::database::{Database, Tree};
2025-11-09T23:19:32.5143450Z  use std::sync::Arc;
2025-11-09T23:19:32.5143561Z  
2025-11-09T23:19:32.5143701Z  /// Chain state information
2025-11-09T23:19:32.5144187Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/chainstate.rs:223:
2025-11-09T23:19:32.5144481Z      }
2025-11-09T23:19:32.5144594Z  
2025-11-09T23:19:32.5144761Z      /// Add a chain tip (for fork tracking)
2025-11-09T23:19:32.5145189Z -    pub fn add_chain_tip(&self, hash: &Hash, height: u64, branchlen: u64, status: &str) -> Result<()> {
2025-11-09T23:19:32.5145345Z +    pub fn add_chain_tip(
2025-11-09T23:19:32.5145462Z +        &self,
2025-11-09T23:19:32.5145595Z +        hash: &Hash,
2025-11-09T23:19:32.5145719Z +        height: u64,
2025-11-09T23:19:32.5145851Z +        branchlen: u64,
2025-11-09T23:19:32.5145978Z +        status: &str,
2025-11-09T23:19:32.5146115Z +    ) -> Result<()> {
2025-11-09T23:19:32.5146276Z          #[derive(Serialize, Deserialize)]
2025-11-09T23:19:32.5146411Z          struct TipInfo {
2025-11-09T23:19:32.5146542Z              height: u64,
2025-11-09T23:19:32.5148465Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/chainstate.rs:230:
2025-11-09T23:19:32.5148593Z              branchlen: u64,
2025-11-09T23:19:32.5148720Z              status: String,
2025-11-09T23:19:32.5148843Z          }
2025-11-09T23:19:32.5148954Z -        
2025-11-09T23:19:32.5149059Z +
2025-11-09T23:19:32.5149201Z          let tip_info = TipInfo {
2025-11-09T23:19:32.5149314Z              height,
2025-11-09T23:19:32.5149428Z              branchlen,
2025-11-09T23:19:32.5150093Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/chainstate.rs:255:
2025-11-09T23:19:32.5150230Z              branchlen: u64,
2025-11-09T23:19:32.5150352Z              status: String,
2025-11-09T23:19:32.5150458Z          }
2025-11-09T23:19:32.5150571Z -        
2025-11-09T23:19:32.5150675Z +
2025-11-09T23:19:32.5150819Z          let mut tips = Vec::new();
2025-11-09T23:19:32.5150981Z          for result in self.chain_tips.iter() {
2025-11-09T23:19:32.5151128Z              let (key, data) = result?;
2025-11-09T23:19:32.5151625Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/commitment_store.rs:4:
2025-11-09T23:19:32.5151786Z  //! without requiring full block history.
2025-11-09T23:19:32.5151900Z  
2025-11-09T23:19:32.5152070Z  #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.5152293Z +use crate::storage::database::{Database, Tree};
2025-11-09T23:19:32.5152454Z +#[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.5152597Z  use anyhow::Result;
2025-11-09T23:19:32.5152750Z  #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.5153058Z  use bllvm_protocol::utxo_commitments::data_structures::UtxoCommitment;
2025-11-09T23:19:32.5153571Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/commitment_store.rs:10:
2025-11-09T23:19:32.5153718Z  #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.5153856Z  use bllvm_protocol::Hash;
2025-11-09T23:19:32.5154005Z  #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.5154183Z -use crate::storage::database::{Database, Tree};
2025-11-09T23:19:32.5154488Z -#[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.5154615Z  use std::sync::Arc;
2025-11-09T23:19:32.5154727Z  
2025-11-09T23:19:32.5154872Z  /// UTXO Commitment storage manager
2025-11-09T23:19:32.5155372Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/commitment_store.rs:48:
2025-11-09T23:19:32.5155607Z          let commitment_data = bincode::serialize(commitment)?;
2025-11-09T23:19:32.5155891Z  
2025-11-09T23:19:32.5156027Z          // Store by block hash
2025-11-09T23:19:32.5156324Z -        self.commitments.insert(block_hash.as_slice(), commitment_data)?;
2025-11-09T23:19:32.5156456Z +        self.commitments
2025-11-09T23:19:32.5156654Z +            .insert(block_hash.as_slice(), commitment_data)?;
2025-11-09T23:19:32.5157413Z  
2025-11-09T23:19:32.5157589Z          // Store height index for quick lookup
2025-11-09T23:19:32.5157752Z          let height_bytes = height.to_be_bytes();
2025-11-09T23:19:32.5158239Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/commitment_store.rs:55:
2025-11-09T23:19:32.5158521Z -        self.height_index.insert(height_bytes, block_hash.as_slice())?;
2025-11-09T23:19:32.5158652Z +        self.height_index
2025-11-09T23:19:32.5158846Z +            .insert(height_bytes, block_hash.as_slice())?;
2025-11-09T23:19:32.5158954Z  
2025-11-09T23:19:32.5159081Z          Ok(())
2025-11-09T23:19:32.5159204Z      }
2025-11-09T23:19:32.5159737Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/commitment_store.rs:128:
2025-11-09T23:19:32.5160013Z          Err(anyhow::anyhow!("UTXO commitments feature not enabled"))
2025-11-09T23:19:32.5160125Z      }
2025-11-09T23:19:32.5160236Z  }
2025-11-09T23:19:32.5160346Z -
2025-11-09T23:19:32.5160461Z  
2025-11-09T23:19:32.5162905Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:7:
2025-11-09T23:19:32.5163285Z  use std::path::Path;
2025-11-09T23:19:32.5163499Z  
2025-11-09T23:19:32.5163704Z  /// Database abstraction trait
2025-11-09T23:19:32.5163829Z -/// 
2025-11-09T23:19:32.5163945Z +///
2025-11-09T23:19:32.5164263Z  /// Provides a unified interface for key-value storage operations
2025-11-09T23:19:32.5164694Z  /// that can be implemented by different backends (sled, redb).
2025-11-09T23:19:32.5164865Z  pub trait Database: Send + Sync {
2025-11-09T23:19:32.5165335Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:14:
2025-11-09T23:19:32.5165675Z      /// Open a named tree/table
2025-11-09T23:19:32.5165884Z      fn open_tree(&self, name: &str) -> Result<Box<dyn Tree>>;
2025-11-09T23:19:32.5165979Z -    
2025-11-09T23:19:32.5166073Z +
2025-11-09T23:19:32.5166195Z      /// Flush all pending writes
2025-11-09T23:19:32.5166325Z      fn flush(&self) -> Result<()>;
2025-11-09T23:19:32.5166417Z  }
2025-11-09T23:19:32.5166816Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:20:
2025-11-09T23:19:32.5166915Z  
2025-11-09T23:19:32.5167038Z  /// Tree/Table abstraction trait
2025-11-09T23:19:32.5167130Z -/// 
2025-11-09T23:19:32.5167220Z +///
2025-11-09T23:19:32.5167497Z  /// Represents a named collection of key-value pairs within a database.
2025-11-09T23:19:32.5167617Z  pub trait Tree: Send + Sync {
2025-11-09T23:19:32.5167737Z      /// Insert a key-value pair
2025-11-09T23:19:32.5168134Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:26:
2025-11-09T23:19:32.5168329Z      fn insert(&self, key: &[u8], value: &[u8]) -> Result<()>;
2025-11-09T23:19:32.5168421Z -    
2025-11-09T23:19:32.5170022Z +
2025-11-09T23:19:32.5170132Z      /// Get a value by key
2025-11-09T23:19:32.5170302Z      fn get(&self, key: &[u8]) -> Result<Option<Vec<u8>>>;
2025-11-09T23:19:32.5170393Z -    
2025-11-09T23:19:32.5170489Z +
2025-11-09T23:19:32.5170604Z      /// Remove a key-value pair
2025-11-09T23:19:32.5170743Z      fn remove(&self, key: &[u8]) -> Result<()>;
2025-11-09T23:19:32.5170838Z -    
2025-11-09T23:19:32.5170928Z +
2025-11-09T23:19:32.5171041Z      /// Check if a key exists
2025-11-09T23:19:32.5171210Z      fn contains_key(&self, key: &[u8]) -> Result<bool>;
2025-11-09T23:19:32.5171307Z -    
2025-11-09T23:19:32.5171398Z +
2025-11-09T23:19:32.5171505Z      /// Clear all entries
2025-11-09T23:19:32.5171630Z      fn clear(&self) -> Result<()>;
2025-11-09T23:19:32.5171881Z -    
2025-11-09T23:19:32.5171974Z +
2025-11-09T23:19:32.5172094Z      /// Get number of entries
2025-11-09T23:19:32.5172221Z      fn len(&self) -> Result<usize>;
2025-11-09T23:19:32.5172314Z -    
2025-11-09T23:19:32.5172406Z +
2025-11-09T23:19:32.5172525Z      /// Check if tree is empty
2025-11-09T23:19:32.5172657Z      fn is_empty(&self) -> Result<bool> {
2025-11-09T23:19:32.5172768Z          Ok(self.len()? == 0)
2025-11-09T23:19:32.5173176Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:46:
2025-11-09T23:19:32.5173270Z      }
2025-11-09T23:19:32.5173361Z -    
2025-11-09T23:19:32.5173452Z +
2025-11-09T23:19:32.5173592Z      /// Iterate over all key-value pairs
2025-11-09T23:19:32.5173850Z      fn iter(&self) -> Box<dyn Iterator<Item = Result<(Vec<u8>, Vec<u8>)>> + '_>;
2025-11-09T23:19:32.5173942Z  }
2025-11-09T23:19:32.5174575Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:63:
2025-11-09T23:19:32.5174742Z  ) -> Result<Box<dyn Database>> {
2025-11-09T23:19:32.5174851Z      match backend {
2025-11-09T23:19:32.5174970Z          #[cfg(feature = "sled")]
2025-11-09T23:19:32.5175108Z -        DatabaseBackend::Sled => {
2025-11-09T23:19:32.5175304Z -            Ok(Box::new(sled_impl::SledDatabase::new(data_dir)?))
2025-11-09T23:19:32.5175400Z -        }
2025-11-09T23:19:32.5175657Z +        DatabaseBackend::Sled => Ok(Box::new(sled_impl::SledDatabase::new(data_dir)?)),
2025-11-09T23:19:32.5175755Z          #[cfg(not(feature = "sled"))]
2025-11-09T23:19:32.5175857Z -        DatabaseBackend::Sled => {
2025-11-09T23:19:32.5176077Z -            Err(anyhow::anyhow!("Sled backend not available (feature not enabled)"))
2025-11-09T23:19:32.5176151Z -        }
2025-11-09T23:19:32.5176281Z +        DatabaseBackend::Sled => Err(anyhow::anyhow!(
2025-11-09T23:19:32.5176420Z +            "Sled backend not available (feature not enabled)"
2025-11-09T23:19:32.5176501Z +        )),
2025-11-09T23:19:32.5176588Z          #[cfg(feature = "redb")]
2025-11-09T23:19:32.5176687Z -        DatabaseBackend::Redb => {
2025-11-09T23:19:32.5176980Z -            Ok(Box::new(redb_impl::RedbDatabase::new(data_dir)?))
2025-11-09T23:19:32.5177060Z -        }
2025-11-09T23:19:32.5177290Z +        DatabaseBackend::Redb => Ok(Box::new(redb_impl::RedbDatabase::new(data_dir)?)),
2025-11-09T23:19:32.5177387Z          #[cfg(not(feature = "redb"))]
2025-11-09T23:19:32.5177490Z -        DatabaseBackend::Redb => {
2025-11-09T23:19:32.5177693Z -            Err(anyhow::anyhow!("Redb backend not available (feature not enabled)"))
2025-11-09T23:19:32.5177767Z -        }
2025-11-09T23:19:32.5177898Z +        DatabaseBackend::Redb => Err(anyhow::anyhow!(
2025-11-09T23:19:32.5178034Z +            "Redb backend not available (feature not enabled)"
2025-11-09T23:19:32.5178112Z +        )),
2025-11-09T23:19:32.5178191Z      }
2025-11-09T23:19:32.5178264Z  }
2025-11-09T23:19:32.5178339Z  
2025-11-09T23:19:32.5178654Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:84:
2025-11-09T23:19:32.5178768Z  /// Get default database backend
2025-11-09T23:19:32.5178840Z -/// 
2025-11-09T23:19:32.5178912Z +///
2025-11-09T23:19:32.5179112Z  /// Returns the preferred backend (redb if available, otherwise sled).
2025-11-09T23:19:32.5179367Z  /// This function will not panic - it returns a backend if at least one is available.
2025-11-09T23:19:32.5179497Z  pub fn default_backend() -> DatabaseBackend {
2025-11-09T23:19:32.5179820Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:104:
2025-11-09T23:19:32.5179899Z  }
2025-11-09T23:19:32.5179973Z  
2025-11-09T23:19:32.5180069Z  /// Get fallback database backend
2025-11-09T23:19:32.5180148Z -/// 
2025-11-09T23:19:32.5180222Z +///
2025-11-09T23:19:32.5180372Z  /// Returns an alternative backend if the primary fails.
2025-11-09T23:19:32.5180484Z  /// Returns None if no fallback is available.
2025-11-09T23:19:32.5180729Z  pub fn fallback_backend(primary: DatabaseBackend) -> Option<DatabaseBackend> {
2025-11-09T23:19:32.5181165Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:148:
2025-11-09T23:19:32.5181258Z      impl SledDatabase {
2025-11-09T23:19:32.5181419Z          pub fn new<P: AsRef<Path>>(data_dir: P) -> Result<Self> {
2025-11-09T23:19:32.5181524Z              let db = sled::open(data_dir)?;
2025-11-09T23:19:32.5181603Z -            Ok(Self {
2025-11-09T23:19:32.5181698Z -                db: Arc::new(db),
2025-11-09T23:19:32.5181773Z -            })
2025-11-09T23:19:32.5181871Z +            Ok(Self { db: Arc::new(db) })
2025-11-09T23:19:32.5181944Z          }
2025-11-09T23:19:32.5182023Z      }
2025-11-09T23:19:32.5182097Z  
2025-11-09T23:19:32.5182410Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:224:
2025-11-09T23:19:32.5182679Z      static HEADERS_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("headers");
2025-11-09T23:19:32.5182972Z      static HEIGHT_INDEX_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("height_index");
2025-11-09T23:19:32.5183257Z      static WITNESSES_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("witnesses");
2025-11-09T23:19:32.5183570Z -    static RECENT_HEADERS_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("recent_headers");
2025-11-09T23:19:32.5183740Z +    static RECENT_HEADERS_TABLE: TableDefinition<&[u8], &[u8]> =
2025-11-09T23:19:32.5183853Z +        TableDefinition::new("recent_headers");
2025-11-09T23:19:32.5184098Z      static UTXOS_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("utxos");
2025-11-09T23:19:32.5184826Z -    static SPENT_OUTPUTS_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("spent_outputs");
2025-11-09T23:19:32.5184998Z +    static SPENT_OUTPUTS_TABLE: TableDefinition<&[u8], &[u8]> =
2025-11-09T23:19:32.5185118Z +        TableDefinition::new("spent_outputs");
2025-11-09T23:19:32.5185398Z      static CHAIN_INFO_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("chain_info");
2025-11-09T23:19:32.5185795Z      static WORK_CACHE_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("work_cache");
2025-11-09T23:19:32.5186033Z      static TX_BY_HASH_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("tx_by_hash");
2025-11-09T23:19:32.5186311Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:233:
2025-11-09T23:19:32.5188475Z      static TX_BY_BLOCK_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("tx_by_block");
2025-11-09T23:19:32.5188710Z      static TX_METADATA_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("tx_metadata");
2025-11-09T23:19:32.5188980Z -    static INVALID_BLOCKS_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("invalid_blocks");
2025-11-09T23:19:32.5189131Z +    static INVALID_BLOCKS_TABLE: TableDefinition<&[u8], &[u8]> =
2025-11-09T23:19:32.5189254Z +        TableDefinition::new("invalid_blocks");
2025-11-09T23:19:32.5189489Z      static CHAIN_TIPS_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("chain_tips");
2025-11-09T23:19:32.5189565Z  
2025-11-09T23:19:32.5189663Z      pub struct RedbDatabase {
2025-11-09T23:19:32.5189931Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:243:
2025-11-09T23:19:32.5190079Z          pub fn new<P: AsRef<Path>>(data_dir: P) -> Result<Self> {
2025-11-09T23:19:32.5190198Z              let db_path = data_dir.as_ref().join("redb.db");
2025-11-09T23:19:32.5190305Z              let db = RedbDb::create(&db_path)?;
2025-11-09T23:19:32.5190373Z -            
2025-11-09T23:19:32.5190439Z +
2025-11-09T23:19:32.5190566Z              // Initialize all tables in a write transaction
2025-11-09T23:19:32.5190662Z              let write_txn = db.begin_write()?;
2025-11-09T23:19:32.5190731Z              {
2025-11-09T23:19:32.5191002Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:264:
2025-11-09T23:19:32.5191121Z                  let _ = write_txn.open_table(CHAIN_TIPS_TABLE)?;
2025-11-09T23:19:32.5191310Z              }
2025-11-09T23:19:32.5191398Z              write_txn.commit()?;
2025-11-09T23:19:32.5191470Z -            
2025-11-09T23:19:32.5191543Z -            Ok(Self {
2025-11-09T23:19:32.5191626Z -                db: Arc::new(db),
2025-11-09T23:19:32.5191698Z -            })
2025-11-09T23:19:32.5191793Z +
2025-11-09T23:19:32.5208880Z +            Ok(Self { db: Arc::new(db) })
2025-11-09T23:19:32.5209052Z          }
2025-11-09T23:19:32.5209173Z -        
2025-11-09T23:19:32.5209602Z -        fn get_table_def(&self, name: &str) -> Option<TableDefinition<&'static [u8], &'static [u8]>> {
2025-11-09T23:19:32.5209707Z +
2025-11-09T23:19:32.5209840Z +        fn get_table_def(
2025-11-09T23:19:32.5209961Z +            &self,
2025-11-09T23:19:32.5210491Z +            name: &str,
2025-11-09T23:19:32.5210763Z +        ) -> Option<TableDefinition<&'static [u8], &'static [u8]>> {
2025-11-09T23:19:32.5211167Z              match name {
2025-11-09T23:19:32.5211354Z                  "blocks" => Some(BLOCKS_TABLE),
2025-11-09T23:19:32.5211507Z                  "headers" => Some(HEADERS_TABLE),
2025-11-09T23:19:32.5211986Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:293:
2025-11-09T23:19:32.5212088Z  
2025-11-09T23:19:32.5212244Z      impl Database for RedbDatabase {
2025-11-09T23:19:32.5212464Z          fn open_tree(&self, name: &str) -> Result<Box<dyn Tree>> {
2025-11-09T23:19:32.5212629Z -            let table_def = self.get_table_def(name)
2025-11-09T23:19:32.5213060Z -                .ok_or_else(|| anyhow::anyhow!("Unknown table name: {}. Redb requires pre-defined tables.", name))?;
2025-11-09T23:19:32.5213178Z -            
2025-11-09T23:19:32.5213396Z +            let table_def = self.get_table_def(name).ok_or_else(|| {
2025-11-09T23:19:32.5213530Z +                anyhow::anyhow!(
2025-11-09T23:19:32.5213781Z +                    "Unknown table name: {}. Redb requires pre-defined tables.",
2025-11-09T23:19:32.5213905Z +                    name
2025-11-09T23:19:32.5214253Z +                )
2025-11-09T23:19:32.5214591Z +            })?;
2025-11-09T23:19:32.5214694Z +
2025-11-09T23:19:32.5214831Z              Ok(Box::new(RedbTree {
2025-11-09T23:19:32.5214980Z                  db: Arc::clone(&self.db),
2025-11-09T23:19:32.5215099Z                  table_def,
2025-11-09T23:19:32.5215558Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:374:
2025-11-09T23:19:32.5215753Z              let read_txn = match self.db.begin_read() {
2025-11-09T23:19:32.5215883Z                  Ok(txn) => txn,
2025-11-09T23:19:32.5216008Z                  Err(e) => {
2025-11-09T23:19:32.5216446Z -                    return Box::new(std::iter::once(Err(anyhow::anyhow!("Failed to begin read transaction: {}", e))));
2025-11-09T23:19:32.5216694Z +                    return Box::new(std::iter::once(Err(anyhow::anyhow!(
2025-11-09T23:19:32.5216884Z +                        "Failed to begin read transaction: {}",
2025-11-09T23:19:32.5217019Z +                        e
2025-11-09T23:19:32.5217158Z +                    ))));
2025-11-09T23:19:32.5217275Z                  }
2025-11-09T23:19:32.5217391Z              };
2025-11-09T23:19:32.5217507Z -            
2025-11-09T23:19:32.5217635Z +
2025-11-09T23:19:32.5217871Z              let table = match read_txn.open_table(self.table_def) {
2025-11-09T23:19:32.5218006Z                  Ok(tbl) => tbl,
2025-11-09T23:19:32.5218142Z                  Err(e) => {
2025-11-09T23:19:32.5218633Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:384:
2025-11-09T23:19:32.5219008Z -                    return Box::new(std::iter::once(Err(anyhow::anyhow!("Failed to open table: {}", e))));
2025-11-09T23:19:32.5219241Z +                    return Box::new(std::iter::once(Err(anyhow::anyhow!(
2025-11-09T23:19:32.5219407Z +                        "Failed to open table: {}",
2025-11-09T23:19:32.5219533Z +                        e
2025-11-09T23:19:32.5219880Z +                    ))));
2025-11-09T23:19:32.5220014Z                  }
2025-11-09T23:19:32.5220134Z              };
2025-11-09T23:19:32.5220249Z -            
2025-11-09T23:19:32.5220369Z +
2025-11-09T23:19:32.5220580Z              let items: Vec<Result<(Vec<u8>, Vec<u8>)>> = table
2025-11-09T23:19:32.5220703Z                  .iter()
2025-11-09T23:19:32.5220835Z                  .map(|item| {
2025-11-09T23:19:32.5223128Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:392:
2025-11-09T23:19:32.5223395Z                          .map_err(|e| anyhow::anyhow!("Redb iteration error: {}", e))
2025-11-09T23:19:32.5223515Z                  })
2025-11-09T23:19:32.5223655Z                  .collect();
2025-11-09T23:19:32.5223770Z -            
2025-11-09T23:19:32.5223878Z +
2025-11-09T23:19:32.5224035Z              Box::new(items.into_iter())
2025-11-09T23:19:32.5224159Z          }
2025-11-09T23:19:32.5224269Z      }
2025-11-09T23:19:32.5229987Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:399:
2025-11-09T23:19:32.5230123Z  }
2025-11-09T23:19:32.5230234Z -
2025-11-09T23:19:32.5232225Z  
2025-11-09T23:19:32.5239238Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:4:
2025-11-09T23:19:32.5239586Z  //! Supports multiple database backends via feature flags (sled, redb).
2025-11-09T23:19:32.5239758Z  
2025-11-09T23:19:32.5239895Z  pub mod blockstore;
2025-11-09T23:19:32.5240028Z +pub mod chainstate;
2025-11-09T23:19:32.5240198Z  #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.5240356Z  pub mod commitment_store;
2025-11-09T23:19:32.5240490Z -pub mod chainstate;
2025-11-09T23:19:32.5242952Z  pub mod database;
2025-11-09T23:19:32.5243111Z  pub mod hashing;
2025-11-09T23:19:32.5243242Z  pub mod pruning;
2025-11-09T23:19:32.5243696Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:13:
2025-11-09T23:19:32.5243845Z  pub mod txindex;
2025-11-09T23:19:32.5243983Z  pub mod utxostore;
2025-11-09T23:19:32.5244095Z  
2025-11-09T23:19:32.5244675Z +use crate::config::PruningConfig;
2025-11-09T23:19:32.5244850Z  use anyhow::Result;
2025-11-09T23:19:32.5245313Z  use database::{create_database, default_backend, fallback_backend, Database, DatabaseBackend};
2025-11-09T23:19:32.5245448Z  use std::path::Path;
2025-11-09T23:19:32.5245893Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:19:
2025-11-09T23:19:32.5246019Z  use std::sync::Arc;
2025-11-09T23:19:32.5246159Z -use tracing::{warn, info};
2025-11-09T23:19:32.5246318Z -use crate::config::PruningConfig;
2025-11-09T23:19:32.5246456Z +use tracing::{info, warn};
2025-11-09T23:19:32.5246570Z  
2025-11-09T23:19:32.5246807Z  /// Storage manager that coordinates all storage operations
2025-11-09T23:19:32.5246953Z  pub struct Storage {
2025-11-09T23:19:32.5247390Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:32:
2025-11-09T23:19:32.5247517Z  
2025-11-09T23:19:32.5247645Z  impl Storage {
2025-11-09T23:19:32.5247883Z      /// Create a new storage instance with default backend
2025-11-09T23:19:32.5247999Z -    /// 
2025-11-09T23:19:32.5248119Z +    ///
2025-11-09T23:19:32.5248439Z      /// Attempts to use the default backend (redb), and gracefully falls back
2025-11-09T23:19:32.5248623Z      /// to sled if redb fails and sled is available.
2025-11-09T23:19:32.5248850Z      pub fn new<P: AsRef<Path>>(data_dir: P) -> Result<Self> {
2025-11-09T23:19:32.5249293Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:39:
2025-11-09T23:19:32.5249453Z          let default = default_backend();
2025-11-09T23:19:32.5249568Z -        
2025-11-09T23:19:32.5249677Z +
2025-11-09T23:19:32.5249841Z          // Try default backend first
2025-11-09T23:19:32.5251971Z          match Self::with_backend(data_dir.as_ref(), default) {
2025-11-09T23:19:32.5252121Z              Ok(storage) => Ok(storage),
2025-11-09T23:19:32.5252806Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:44:
2025-11-09T23:19:32.5252939Z              Err(e) => {
2025-11-09T23:19:32.5253113Z                  // If default backend fails, try fallback
2025-11-09T23:19:32.5253363Z                  if let Some(fallback_backend) = fallback_backend(default) {
2025-11-09T23:19:32.5253786Z -                    warn!("Failed to initialize {:?} backend: {}. Falling back to {:?}.", default, e, fallback_backend);
2025-11-09T23:19:32.5254173Z -                    info!("Attempting to initialize storage with fallback backend: {:?}", fallback_backend);
2025-11-09T23:19:32.5254300Z +                    warn!(
2025-11-09T23:19:32.5254755Z +                        "Failed to initialize {:?} backend: {}. Falling back to {:?}.",
2025-11-09T23:19:32.5254921Z +                        default, e, fallback_backend
2025-11-09T23:19:32.5255041Z +                    );
2025-11-09T23:19:32.5255174Z +                    info!(
2025-11-09T23:19:32.5255485Z +                        "Attempting to initialize storage with fallback backend: {:?}",
2025-11-09T23:19:32.5255628Z +                        fallback_backend
2025-11-09T23:19:32.5255749Z +                    );
2025-11-09T23:19:32.5255975Z                      Self::with_backend(data_dir, fallback_backend)
2025-11-09T23:19:32.5256101Z                  } else {
2025-11-09T23:19:32.5256253Z                      Err(anyhow::anyhow!(
2025-11-09T23:19:32.5256699Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:52:
2025-11-09T23:19:32.5257011Z                          "Failed to initialize {:?} backend: {}. No fallback backend available.",
2025-11-09T23:19:32.5257146Z -                        default, e
2025-11-09T23:19:32.5257277Z +                        default,
2025-11-09T23:19:32.5257404Z +                        e
2025-11-09T23:19:32.5257521Z                      ))
2025-11-09T23:19:32.5257636Z                  }
2025-11-09T23:19:32.5257767Z              }
2025-11-09T23:19:32.5258430Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:145:
2025-11-09T23:19:32.5258605Z      pub fn flush(&self) -> Result<()> {
2025-11-09T23:19:32.5258734Z          self.db.flush()
2025-11-09T23:19:32.5258842Z      }
2025-11-09T23:19:32.5258944Z -    
2025-11-09T23:19:32.5259042Z +
2025-11-09T23:19:32.5259259Z      /// Get approximate disk size used by storage (in bytes)
2025-11-09T23:19:32.5259359Z -    /// 
2025-11-09T23:19:32.5259459Z +    ///
2025-11-09T23:19:32.5259751Z      /// Returns an estimate based on tree sizes. If any operation fails,
2025-11-09T23:19:32.5259935Z      /// returns 0 gracefully rather than erroring.
2025-11-09T23:19:32.5260128Z      /// Includes bounds checking to prevent overflow.
2025-11-09T23:19:32.5260582Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:154:
2025-11-09T23:19:32.5260755Z      pub fn disk_size(&self) -> Result<u64> {
2025-11-09T23:19:32.5261034Z          // Estimate based on tree sizes (graceful degradation if counts fail)
2025-11-09T23:19:32.5261172Z          let mut size = 0u64;
2025-11-09T23:19:32.5261290Z -        
2025-11-09T23:19:32.5261398Z +
2025-11-09T23:19:32.5261690Z          // Block size estimate (gracefully handle errors, with bounds checking)
2025-11-09T23:19:32.5261895Z          if let Ok(count) = self.blockstore.block_count() {
2025-11-09T23:19:32.5262140Z              const MAX_BLOCKS: u64 = 10_000_000; // 10M blocks max (safety limit)
2025-11-09T23:19:32.5262580Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:162:
2025-11-09T23:19:32.5262813Z              const BYTES_PER_BLOCK: u64 = 1_024_000; // ~1MB per block
2025-11-09T23:19:32.5263120Z              size = size.saturating_add(safe_count.saturating_mul(BYTES_PER_BLOCK));
2025-11-09T23:19:32.5263231Z          }
2025-11-09T23:19:32.5263338Z -        
2025-11-09T23:19:32.5263444Z +
2025-11-09T23:19:32.5263719Z          // UTXO size estimate (gracefully handle errors, with bounds checking)
2025-11-09T23:19:32.5264104Z          if let Ok(count) = self.utxostore.utxo_count() {
2025-11-09T23:19:32.5264504Z              const MAX_UTXOS: u64 = 1_000_000_000; // 1B UTXOs max (safety limit)
2025-11-09T23:19:32.5264935Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:170:
2025-11-09T23:19:32.5265132Z              const BYTES_PER_UTXO: u64 = 100; // ~100 bytes per UTXO
2025-11-09T23:19:32.5265408Z              size = size.saturating_add(safe_count.saturating_mul(BYTES_PER_UTXO));
2025-11-09T23:19:32.5265529Z          }
2025-11-09T23:19:32.5265643Z -        
2025-11-09T23:19:32.5265755Z +
2025-11-09T23:19:32.5266110Z          // Transaction size estimate (gracefully handle errors, with bounds checking)
2025-11-09T23:19:32.5266334Z          if let Ok(count) = self.txindex.transaction_count() {
2025-11-09T23:19:32.5266607Z              const MAX_TXS: u64 = 1_000_000_000; // 1B transactions max (safety limit)
2025-11-09T23:19:32.5268427Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:178:
2025-11-09T23:19:32.5268678Z              const BYTES_PER_TX: u64 = 500; // ~500 bytes per transaction
2025-11-09T23:19:32.5268980Z              size = size.saturating_add(safe_count.saturating_mul(BYTES_PER_TX));
2025-11-09T23:19:32.5269092Z          }
2025-11-09T23:19:32.5269215Z -        
2025-11-09T23:19:32.5269328Z +
2025-11-09T23:19:32.5269574Z          // Final bounds check: prevent returning unrealistic values
2025-11-09T23:19:32.5269850Z          const MAX_DISK_SIZE: u64 = 10_000_000_000_000; // 10TB max (safety limit)
2025-11-09T23:19:32.5269999Z          Ok(size.min(MAX_DISK_SIZE))
2025-11-09T23:19:32.5270437Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:185:
2025-11-09T23:19:32.5270945Z      }
2025-11-09T23:19:32.5271069Z -    
2025-11-09T23:19:32.5271182Z +
2025-11-09T23:19:32.5271361Z      /// Check storage bounds before operations
2025-11-09T23:19:32.5271980Z      /// Returns true if storage is within safe bounds, false if approaching limits
2025-11-09T23:19:32.5272222Z      pub fn check_storage_bounds(&self) -> Result<bool> {
2025-11-09T23:19:32.5272663Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:190:
2025-11-09T23:19:32.5272868Z          const MAX_BLOCKS: usize = 10_000_000; // 10M blocks
2025-11-09T23:19:32.5273056Z          const MAX_UTXOS: usize = 1_000_000_000; // 1B UTXOs
2025-11-09T23:19:32.5273269Z          const MAX_TXS: usize = 1_000_000_000; // 1B transactions
2025-11-09T23:19:32.5273387Z -        
2025-11-09T23:19:32.5273510Z +
2025-11-09T23:19:32.5273777Z          let block_count = self.blockstore.block_count().unwrap_or(0);
2025-11-09T23:19:32.5274019Z          let utxo_count = self.utxostore.utxo_count().unwrap_or(0);
2025-11-09T23:19:32.5274283Z          let tx_count = self.txindex.transaction_count().unwrap_or(0);
2025-11-09T23:19:32.5274842Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:197:
2025-11-09T23:19:32.5274960Z -        
2025-11-09T23:19:32.5275077Z +
2025-11-09T23:19:32.5275265Z          // Check if we're approaching limits (80% threshold)
2025-11-09T23:19:32.5275458Z          let blocks_ok = block_count < (MAX_BLOCKS * 8 / 10);
2025-11-09T23:19:32.5275653Z          let utxos_ok = utxo_count < (MAX_UTXOS * 8 / 10);
2025-11-09T23:19:32.5276096Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:201:
2025-11-09T23:19:32.5276270Z          let txs_ok = tx_count < (MAX_TXS * 8 / 10);
2025-11-09T23:19:32.5276387Z -        
2025-11-09T23:19:32.5276509Z +
2025-11-09T23:19:32.5276641Z          if !blocks_ok {
2025-11-09T23:19:32.5277038Z -            warn!("Storage bounds: block count ({}) approaching limit ({})", block_count, MAX_BLOCKS);
2025-11-09T23:19:32.5277158Z +            warn!(
2025-11-09T23:19:32.5277407Z +                "Storage bounds: block count ({}) approaching limit ({})",
2025-11-09T23:19:32.5277756Z +                block_count, MAX_BLOCKS
2025-11-09T23:19:32.5277870Z +            );
2025-11-09T23:19:32.5277991Z          }
2025-11-09T23:19:32.5278108Z          if !utxos_ok {
2025-11-09T23:19:32.5278453Z -            warn!("Storage bounds: UTXO count ({}) approaching limit ({})", utxo_count, MAX_UTXOS);
2025-11-09T23:19:32.5278568Z +            warn!(
2025-11-09T23:19:32.5278792Z +                "Storage bounds: UTXO count ({}) approaching limit ({})",
2025-11-09T23:19:32.5278921Z +                utxo_count, MAX_UTXOS
2025-11-09T23:19:32.5279024Z +            );
2025-11-09T23:19:32.5279132Z          }
2025-11-09T23:19:32.5279245Z          if !txs_ok {
2025-11-09T23:19:32.5279615Z -            warn!("Storage bounds: transaction count ({}) approaching limit ({})", tx_count, MAX_TXS);
2025-11-09T23:19:32.5279745Z +            warn!(
2025-11-09T23:19:32.5280032Z +                "Storage bounds: transaction count ({}) approaching limit ({})",
2025-11-09T23:19:32.5280167Z +                tx_count, MAX_TXS
2025-11-09T23:19:32.5280295Z +            );
2025-11-09T23:19:32.5280422Z          }
2025-11-09T23:19:32.5280537Z -        
2025-11-09T23:19:32.5280649Z +
2025-11-09T23:19:32.5280814Z          Ok(blocks_ok && utxos_ok && txs_ok)
2025-11-09T23:19:32.5280927Z      }
2025-11-09T23:19:32.5281039Z -    
2025-11-09T23:19:32.5281149Z +
2025-11-09T23:19:32.5281316Z      /// Get transaction count from txindex
2025-11-09T23:19:32.5281522Z      pub fn transaction_count(&self) -> Result<usize> {
2025-11-09T23:19:32.5281690Z          self.txindex.transaction_count()
2025-11-09T23:19:32.5336911Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:7:
2025-11-09T23:19:32.5337238Z  //! - Custom: Fine-grained control over what to keep
2025-11-09T23:19:32.5337358Z  
2025-11-09T23:19:32.5337588Z  use crate::config::{PruningConfig, PruningMode};
2025-11-09T23:19:32.5337731Z +#[cfg(feature = "bip158")]
2025-11-09T23:19:32.5337978Z +use crate::network::filter_service::BlockFilterService;
2025-11-09T23:19:32.5338181Z  use crate::storage::blockstore::BlockStore;
2025-11-09T23:19:32.5338605Z  #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.5338861Z  use crate::storage::commitment_store::CommitmentStore;
2025-11-09T23:19:32.5341798Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:13:
2025-11-09T23:19:32.5341989Z  #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.5342176Z  use crate::storage::utxostore::UtxoStore;
2025-11-09T23:19:32.5342320Z -#[cfg(feature = "bip158")]
2025-11-09T23:19:32.5342574Z -use crate::network::filter_service::BlockFilterService;
2025-11-09T23:19:32.5342729Z  use anyhow::{anyhow, Result};
2025-11-09T23:19:32.5342888Z  #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.5343037Z  use bllvm_protocol::Hash;
2025-11-09T23:19:32.5343540Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:89:
2025-11-09T23:19:32.5343682Z      pub fn with_features(
2025-11-09T23:19:32.5343842Z          config: PruningConfig,
2025-11-09T23:19:32.5344014Z          blockstore: Arc<BlockStore>,
2025-11-09T23:19:32.5344186Z -        #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.5344616Z -        commitment_store: Option<Arc<CommitmentStore>>,
2025-11-09T23:19:32.5344799Z -        #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.5344960Z -        utxostore: Option<Arc<UtxoStore>>,
2025-11-09T23:19:32.5345103Z -        #[cfg(feature = "bip158")]
2025-11-09T23:19:32.5345320Z -        filter_service: Option<Arc<BlockFilterService>>,
2025-11-09T23:19:32.5345728Z +        #[cfg(feature = "utxo-commitments")] commitment_store: Option<Arc<CommitmentStore>>,
2025-11-09T23:19:32.5346038Z +        #[cfg(feature = "utxo-commitments")] utxostore: Option<Arc<UtxoStore>>,
2025-11-09T23:19:32.5346363Z +        #[cfg(feature = "bip158")] filter_service: Option<Arc<BlockFilterService>>,
2025-11-09T23:19:32.5346498Z      ) -> Self {
2025-11-09T23:19:32.5346615Z          Self {
2025-11-09T23:19:32.5347073Z              config,
2025-11-09T23:19:32.5347575Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:153:
2025-11-09T23:19:32.5347705Z          {
2025-11-09T23:19:32.5347888Z              // Check if UTXO commitments are available
2025-11-09T23:19:32.5348281Z              let has_commitments = self.commitment_store.is_some() && self.utxostore.is_some();
2025-11-09T23:19:32.5348403Z -            
2025-11-09T23:19:32.5348518Z +
2025-11-09T23:19:32.5348717Z              // Check if mode supports incremental pruning
2025-11-09T23:19:32.5348884Z              let mode_supports = matches!(
2025-11-09T23:19:32.5349027Z                  &self.config.mode,
2025-11-09T23:19:32.5349501Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:160:
2025-11-09T23:19:32.5349901Z -                PruningMode::Aggressive { .. } | PruningMode::Custom { keep_commitments: true, .. }
2025-11-09T23:19:32.5350085Z +                PruningMode::Aggressive { .. }
2025-11-09T23:19:32.5350253Z +                    | PruningMode::Custom {
2025-11-09T23:19:32.5350420Z +                        keep_commitments: true,
2025-11-09T23:19:32.5350550Z +                        ..
2025-11-09T23:19:32.5350668Z +                    }
2025-11-09T23:19:32.5351149Z              );
2025-11-09T23:19:32.5351291Z -            
2025-11-09T23:19:32.5351403Z +
2025-11-09T23:19:32.5351578Z              has_commitments && mode_supports
2025-11-09T23:19:32.5351698Z          }
2025-11-09T23:19:32.5351875Z          #[cfg(not(feature = "utxo-commitments"))]
2025-11-09T23:19:32.5352368Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:169:
2025-11-09T23:19:32.5352482Z      }
2025-11-09T23:19:32.5352603Z  
2025-11-09T23:19:32.5352760Z      /// Incremental prune during IBD
2025-11-09T23:19:32.5352877Z -    /// 
2025-11-09T23:19:32.5353003Z +    ///
2025-11-09T23:19:32.5353380Z      /// This method prunes old blocks while keeping a sliding window of recent blocks.
2025-11-09T23:19:32.5354101Z      /// It's designed to be called periodically during IBD to prevent storage from growing
2025-11-09T23:19:32.5354749Z      /// unbounded. Only works when incremental_prune_during_ibd is enabled and UTXO
2025-11-09T23:19:32.5355252Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:203:
2025-11-09T23:19:32.5355367Z  
2025-11-09T23:19:32.5355690Z          // Calculate prune height: keep only the last prune_window_size blocks
2025-11-09T23:19:32.5356100Z          let prune_to_height = current_height.saturating_sub(self.config.prune_window_size);
2025-11-09T23:19:32.5356216Z -        
2025-11-09T23:19:32.5356326Z +
2025-11-09T23:19:32.5356581Z          // Don't prune if window size is larger than current height
2025-11-09T23:19:32.5356832Z          if prune_to_height == 0 || prune_to_height >= current_height {
2025-11-09T23:19:32.5356963Z              return Ok(None);
2025-11-09T23:19:32.5357432Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:245:
2025-11-09T23:19:32.5357648Z              // 1. Incremental pruning is explicitly enabled
2025-11-09T23:19:32.5357894Z              // 2. UTXO commitments are available (for state verification)
2025-11-09T23:19:32.5358113Z              // 3. Aggressive or Custom mode with commitments enabled
2025-11-09T23:19:32.5358438Z -            let can_incremental_prune = self.config.incremental_prune_during_ibd
2025-11-09T23:19:32.5358623Z -                && self.can_incremental_prune_during_ibd();
2025-11-09T23:19:32.5358734Z -            
2025-11-09T23:19:32.5358884Z +            let can_incremental_prune =
2025-11-09T23:19:32.5359300Z +                self.config.incremental_prune_during_ibd && self.can_incremental_prune_during_ibd();
2025-11-09T23:19:32.5359416Z +
2025-11-09T23:19:32.5364690Z              if !can_incremental_prune {
2025-11-09T23:19:32.5364855Z                  return Err(anyhow!(
2025-11-09T23:19:32.5365568Z                      "Cannot prune during initial block download. Wait for IBD to complete, or enable incremental_prune_during_ibd with UTXO commitments."
2025-11-09T23:19:32.5366330Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:254:
2025-11-09T23:19:32.5366461Z                  ));
2025-11-09T23:19:32.5366581Z              }
2025-11-09T23:19:32.5366698Z -            
2025-11-09T23:19:32.5366813Z +
2025-11-09T23:19:32.5367126Z              // For incremental pruning during IBD, ensure we have enough blocks
2025-11-09T23:19:32.5367437Z              if current_height < self.config.min_blocks_for_incremental_prune {
2025-11-09T23:19:32.5367578Z                  return Err(anyhow!(
2025-11-09T23:19:32.5368070Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:295:
2025-11-09T23:19:32.5368234Z              PruningMode::Normal {
2025-11-09T23:19:32.5368368Z                  keep_from_height,
2025-11-09T23:19:32.5368514Z                  min_recent_blocks,
2025-11-09T23:19:32.5368985Z -            } => self.prune_normal(prune_to_height, current_height, *keep_from_height, *min_recent_blocks)?,
2025-11-09T23:19:32.5369129Z +            } => self.prune_normal(
2025-11-09T23:19:32.5369281Z +                prune_to_height,
2025-11-09T23:19:32.5369414Z +                current_height,
2025-11-09T23:19:32.5369554Z +                *keep_from_height,
2025-11-09T23:19:32.5369691Z +                *min_recent_blocks,
2025-11-09T23:19:32.5369819Z +            )?,
2025-11-09T23:19:32.5369980Z              PruningMode::Aggressive {
2025-11-09T23:19:32.5370118Z                  keep_from_height,
2025-11-09T23:19:32.5370265Z                  keep_commitments,
2025-11-09T23:19:32.5372583Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:370:
2025-11-09T23:19:32.5372769Z          let mut stats = PruningStats::default();
2025-11-09T23:19:32.5372881Z  
2025-11-09T23:19:32.5373246Z          // Calculate actual keep height (max of keep_from_height and min_recent_blocks)
2025-11-09T23:19:32.5373760Z -        let effective_keep_height = keep_from_height.max(
2025-11-09T23:19:32.5373980Z -            current_height.saturating_sub(min_recent_blocks)
2025-11-09T23:19:32.5374100Z -        );
2025-11-09T23:19:32.5374249Z +        let effective_keep_height =
2025-11-09T23:19:32.5374759Z +            keep_from_height.max(current_height.saturating_sub(min_recent_blocks));
2025-11-09T23:19:32.5374886Z  
2025-11-09T23:19:32.5379005Z          // Ensure we don't prune below effective keep height
2025-11-09T23:19:32.5379372Z          let actual_prune_height = prune_to_height.min(effective_keep_height);
2025-11-09T23:19:32.5379879Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:415:
2025-11-09T23:19:32.5380093Z          let mut stats = PruningStats::default();
2025-11-09T23:19:32.5380210Z  
2025-11-09T23:19:32.5380801Z          // Calculate effective keep height
2025-11-09T23:19:32.5381060Z -        let effective_keep_height = keep_from_height.max(
2025-11-09T23:19:32.5381265Z -            current_height.saturating_sub(min_blocks)
2025-11-09T23:19:32.5381385Z -        );
2025-11-09T23:19:32.5381853Z +        let effective_keep_height = keep_from_height.max(current_height.saturating_sub(min_blocks));
2025-11-09T23:19:32.5381965Z  
2025-11-09T23:19:32.5382265Z          let actual_prune_height = prune_to_height.min(effective_keep_height);
2025-11-09T23:19:32.5382373Z  
2025-11-09T23:19:32.5382842Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:428:
2025-11-09T23:19:32.5382947Z  
2025-11-09T23:19:32.5383171Z          // Generate UTXO commitments before pruning if enabled
2025-11-09T23:19:32.5383317Z          if keep_commitments {
2025-11-09T23:19:32.5383575Z -            if let (Some(ref commitment_store), Some(ref utxostore)) = 
2025-11-09T23:19:32.5383841Z -                (self.commitment_store.as_ref(), self.utxostore.as_ref()) 
2025-11-09T23:19:32.5384506Z +            if let (Some(ref commitment_store), Some(ref utxostore)) =
2025-11-09T23:19:32.5384778Z +                (self.commitment_store.as_ref(), self.utxostore.as_ref())
2025-11-09T23:19:32.5384905Z              {
2025-11-09T23:19:32.5385199Z                  info!("Generating UTXO commitments for blocks to be pruned...");
2025-11-09T23:19:32.5385389Z                  self.generate_commitments_before_prune(
2025-11-09T23:19:32.5385868Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:439:
2025-11-09T23:19:32.5385992Z                      utxostore,
2025-11-09T23:19:32.5386097Z                  )?;
2025-11-09T23:19:32.5386209Z              } else {
2025-11-09T23:19:32.5386608Z -                warn!("UTXO commitments requested but commitment store or UTXO store not available");
2025-11-09T23:19:32.5386717Z +                warn!(
2025-11-09T23:19:32.5387074Z +                    "UTXO commitments requested but commitment store or UTXO store not available"
2025-11-09T23:19:32.5387194Z +                );
2025-11-09T23:19:32.5387297Z              }
2025-11-09T23:19:32.5387420Z          }
2025-11-09T23:19:32.5387542Z  
2025-11-09T23:19:32.5388024Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:464:
2025-11-09T23:19:32.5388241Z                      // Remove filter from cache but keep filter header
2025-11-09T23:19:32.5388421Z                      if filter_service.has_filter(&hash) {
2025-11-09T23:19:32.5388671Z                          filter_service.remove_filter_for_pruned_block(&hash)?;
2025-11-09T23:19:32.5389063Z -                        debug!("Removed BIP158 filter for pruned block at height {} (header kept)", height);
2025-11-09T23:19:32.5389194Z +                        debug!(
2025-11-09T23:19:32.5389520Z +                            "Removed BIP158 filter for pruned block at height {} (header kept)",
2025-11-09T23:19:32.5389649Z +                            height
2025-11-09T23:19:32.5389770Z +                        );
2025-11-09T23:19:32.5389904Z                      }
2025-11-09T23:19:32.5390270Z                  }
2025-11-09T23:19:32.5390393Z              }
2025-11-09T23:19:32.5390867Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:524:
2025-11-09T23:19:32.5391019Z                  if keep_commitments {
2025-11-09T23:19:32.5391195Z                      #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.5391301Z                      {
2025-11-09T23:19:32.5391537Z -                        if let (Some(ref commitment_store), Some(ref utxostore)) = 
2025-11-09T23:19:32.5391792Z -                            (self.commitment_store.as_ref(), self.utxostore.as_ref()) 
2025-11-09T23:19:32.5392030Z +                        if let (Some(ref commitment_store), Some(ref utxostore)) =
2025-11-09T23:19:32.5392294Z +                            (self.commitment_store.as_ref(), self.utxostore.as_ref())
2025-11-09T23:19:32.5392420Z                          {
2025-11-09T23:19:32.5392612Z                              // Generate commitment if not exists
2025-11-09T23:19:32.5392832Z                              if !commitment_store.has_commitment(&hash)? {
2025-11-09T23:19:32.5393304Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:547:
2025-11-09T23:19:32.5393556Z                          // Filter headers are always kept for chain verification
2025-11-09T23:19:32.5393739Z                          if filter_service.has_filter(&hash) {
2025-11-09T23:19:32.5394000Z                              filter_service.remove_filter_for_pruned_block(&hash)?;
2025-11-09T23:19:32.5394559Z -                            debug!("Removed BIP158 filter for pruned block at height {} (header kept)", height);
2025-11-09T23:19:32.5394685Z +                            debug!(
2025-11-09T23:19:32.5394995Z +                                "Removed BIP158 filter for pruned block at height {} (header kept)",
2025-11-09T23:19:32.5395120Z +                                height
2025-11-09T23:19:32.5395450Z +                            );
2025-11-09T23:19:32.5395587Z                          }
2025-11-09T23:19:32.5395706Z                      }
2025-11-09T23:19:32.5395817Z                  }
2025-11-09T23:19:32.5396270Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:569:
2025-11-09T23:19:32.5396450Z          commitment_store: &CommitmentStore,
2025-11-09T23:19:32.5396590Z          utxostore: &UtxoStore,
2025-11-09T23:19:32.5396718Z      ) -> Result<()> {
2025-11-09T23:19:32.5397048Z -        info!("Generating UTXO commitments for heights 0..{}", prune_to_height);
2025-11-09T23:19:32.5397157Z +        info!(
2025-11-09T23:19:32.5397357Z +            "Generating UTXO commitments for heights 0..{}",
2025-11-09T23:19:32.5397476Z +            prune_to_height
2025-11-09T23:19:32.5397583Z +        );
2025-11-09T23:19:32.5397679Z  
2025-11-09T23:19:32.5397881Z          // For each block to be pruned, generate a commitment
2025-11-09T23:19:32.5398188Z          // We'll generate commitments at checkpoint intervals to save computation
2025-11-09T23:19:32.5398625Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:601:
2025-11-09T23:19:32.5398778Z          commitment_store: &CommitmentStore,
2025-11-09T23:19:32.5398910Z          utxostore: &UtxoStore,
2025-11-09T23:19:32.5399030Z      ) -> Result<()> {
2025-11-09T23:19:32.5399189Z -        #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.5399490Z -        use bllvm_protocol::utxo_commitments::merkle_tree::UtxoMerkleTree;
2025-11-09T23:19:32.5399672Z          use bllvm_protocol::block::connect_block;
2025-11-09T23:19:32.5399826Z          use bllvm_protocol::segwit::Witness;
2025-11-09T23:19:32.5399979Z +        #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.5400255Z +        use bllvm_protocol::utxo_commitments::merkle_tree::UtxoMerkleTree;
2025-11-09T23:19:32.5400366Z  
2025-11-09T23:19:32.5400640Z          // Reconstruct UTXO set at historical height by replaying blocks
2025-11-09T23:19:32.5403380Z          let utxo_set = self.reconstruct_utxo_set_at_height(height, utxostore)?;
2025-11-09T23:19:32.5403868Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:614:
2025-11-09T23:19:32.5404172Z              .map_err(|e| anyhow::anyhow!("Failed to create UTXO Merkle tree: {:?}", e))?;
2025-11-09T23:19:32.5404279Z  
2025-11-09T23:19:32.5404636Z          for (outpoint, utxo) in &utxo_set {
2025-11-09T23:19:32.5404811Z -            utxo_tree.insert(*outpoint, utxo.clone())
2025-11-09T23:19:32.5404927Z +            utxo_tree
2025-11-09T23:19:32.5405089Z +                .insert(*outpoint, utxo.clone())
2025-11-09T23:19:32.5405349Z                  .map_err(|e| anyhow::anyhow!("Failed to insert UTXO: {:?}", e))?;
2025-11-09T23:19:32.5405463Z          }
2025-11-09T23:19:32.5405571Z  
2025-11-09T23:19:32.5406011Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:624:
2025-11-09T23:19:32.5406158Z          // Store commitment
2025-11-09T23:19:32.5406481Z          commitment_store.store_commitment(block_hash, height, &commitment)?;
2025-11-09T23:19:32.5406599Z  
2025-11-09T23:19:32.5406891Z -        debug!("Generated and stored commitment for height {} (hash: {})", 
2025-11-09T23:19:32.5407060Z -               height, hex::encode(block_hash));
2025-11-09T23:19:32.5407182Z +        debug!(
2025-11-09T23:19:32.5407439Z +            "Generated and stored commitment for height {} (hash: {})",
2025-11-09T23:19:32.5407546Z +            height,
2025-11-09T23:19:32.5407687Z +            hex::encode(block_hash)
2025-11-09T23:19:32.5407805Z +        );
2025-11-09T23:19:32.5407913Z  
2025-11-09T23:19:32.5408030Z          Ok(())
2025-11-09T23:19:32.5408151Z      }
2025-11-09T23:19:32.5408631Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:632:
2025-11-09T23:19:32.5408752Z  
2025-11-09T23:19:32.5408990Z      /// Generate UTXO commitment from current UTXO set state
2025-11-09T23:19:32.5411324Z -    /// 
2025-11-09T23:19:32.5411443Z +    ///
2025-11-09T23:19:32.5411888Z      /// This method generates a commitment from the current UTXO set without replaying blocks.
2025-11-09T23:19:32.5412588Z      /// Used during incremental sync when the UTXO set is maintained incrementally.
2025-11-09T23:19:32.5412717Z -    /// 
2025-11-09T23:19:32.5412829Z +    ///
2025-11-09T23:19:32.5412953Z      /// # Arguments
2025-11-09T23:19:32.5413175Z      /// * `block_hash` - Hash of the block at this height
2025-11-09T23:19:32.5413320Z      /// * `height` - Block height
2025-11-09T23:19:32.5413787Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:641:
2025-11-09T23:19:32.5414033Z      /// * `utxo_set` - Current UTXO set (from incremental updates)
2025-11-09T23:19:32.5414543Z      /// * `commitment_store` - Commitment store to save the commitment
2025-11-09T23:19:32.5414671Z -    /// 
2025-11-09T23:19:32.5414795Z +    ///
2025-11-09T23:19:32.5414931Z      /// # Returns
2025-11-09T23:19:32.5415113Z      /// Result indicating success or failure
2025-11-09T23:19:32.5415667Z      #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.5416173Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:658:
2025-11-09T23:19:32.5416512Z              .map_err(|e| anyhow::anyhow!("Failed to create UTXO Merkle tree: {:?}", e))?;
2025-11-09T23:19:32.5416626Z  
2025-11-09T23:19:32.5416799Z          for (outpoint, utxo) in utxo_set {
2025-11-09T23:19:32.5416987Z -            utxo_tree.insert(*outpoint, utxo.clone())
2025-11-09T23:19:32.5417112Z +            utxo_tree
2025-11-09T23:19:32.5417283Z +                .insert(*outpoint, utxo.clone())
2025-11-09T23:19:32.5417554Z                  .map_err(|e| anyhow::anyhow!("Failed to insert UTXO: {:?}", e))?;
2025-11-09T23:19:32.5417672Z          }
2025-11-09T23:19:32.5417784Z  
2025-11-09T23:19:32.5418261Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:668:
2025-11-09T23:19:32.5418411Z          // Store commitment
2025-11-09T23:19:32.5418968Z          commitment_store.store_commitment(block_hash, height, &commitment)?;
2025-11-09T23:19:32.5419099Z  
2025-11-09T23:19:32.5419454Z -        debug!("Generated commitment from current state for height {} (hash: {})", 
2025-11-09T23:19:32.5419629Z -               height, hex::encode(block_hash));
2025-11-09T23:19:32.5419746Z +        debug!(
2025-11-09T23:19:32.5420070Z +            "Generated commitment from current state for height {} (hash: {})",
2025-11-09T23:19:32.5420190Z +            height,
2025-11-09T23:19:32.5420341Z +            hex::encode(block_hash)
2025-11-09T23:19:32.5420464Z +        );
2025-11-09T23:19:32.5420577Z  
2025-11-09T23:19:32.5420693Z          Ok(())
2025-11-09T23:19:32.5420805Z      }
2025-11-09T23:19:32.5421394Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:676:
2025-11-09T23:19:32.5421507Z  
2025-11-09T23:19:32.5421757Z      /// Reconstruct UTXO set at a specific historical height
2025-11-09T23:19:32.5421891Z -    /// 
2025-11-09T23:19:32.5422005Z +    ///
2025-11-09T23:19:32.5422289Z      /// This function replays blocks from genesis to the target height
2025-11-09T23:19:32.5422563Z      /// to reconstruct the exact UTXO set at that point in history.
2025-11-09T23:19:32.5422727Z      #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.5423195Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:703:
2025-11-09T23:19:32.5423326Z                  // Get block
2025-11-09T23:19:32.5423598Z                  if let Some(block) = self.blockstore.get_block(&block_hash)? {
2025-11-09T23:19:32.5423763Z                      // Get witnesses for this block
2025-11-09T23:19:32.5424020Z -                    let witnesses = self.blockstore.get_witness(&block_hash)?
2025-11-09T23:19:32.5424178Z -                        .unwrap_or_else(|| {
2025-11-09T23:19:32.5433111Z -                            // If no witnesses stored, create empty witnesses
2025-11-09T23:19:32.5433705Z -                            block.transactions.iter().map(|_| Vec::new()).collect()
2025-11-09T23:19:32.5433839Z -                        });
2025-11-09T23:19:32.5433979Z +                    let witnesses =
2025-11-09T23:19:32.5434123Z +                        self.blockstore
2025-11-09T23:19:32.5434469Z +                            .get_witness(&block_hash)?
2025-11-09T23:19:32.5434648Z +                            .unwrap_or_else(|| {
2025-11-09T23:19:32.5434868Z +                                // If no witnesses stored, create empty witnesses
2025-11-09T23:19:32.5435151Z +                                block.transactions.iter().map(|_| Vec::new()).collect()
2025-11-09T23:19:32.5435293Z +                            });
2025-11-09T23:19:32.5435413Z  
2025-11-09T23:19:32.5435620Z                      // Apply block to UTXO set using connect_block
2025-11-09T23:19:32.5435995Z                      // This properly handles coinbase transactions and input/output processing
2025-11-09T23:19:32.5436515Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:714:
2025-11-09T23:19:32.5436761Z                      let (validation_result, new_utxo_set) = connect_block(
2025-11-09T23:19:32.5436892Z -                        &block,
2025-11-09T23:19:32.5437034Z -                        &witnesses,
2025-11-09T23:19:32.5437165Z -                        utxo_set,
2025-11-09T23:19:32.5437294Z -                        height,
2025-11-09T23:19:32.5437481Z +                        &block, &witnesses, utxo_set, height,
2025-11-09T23:19:32.5437720Z                          None, // No recent headers needed for historical replay
2025-11-09T23:19:32.5437841Z                      )?;
2025-11-09T23:19:32.5437953Z  
2025-11-09T23:19:32.5438451Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:722:
2025-11-09T23:19:32.5438612Z                      // Check validation result
2025-11-09T23:19:32.5439217Z                      if !matches!(validation_result, bllvm_protocol::ValidationResult::Valid) {
2025-11-09T23:19:32.5441163Z -                        warn!("Block at height {} failed validation during UTXO reconstruction", height);
2025-11-09T23:19:32.5441294Z +                        warn!(
2025-11-09T23:19:32.5441592Z +                            "Block at height {} failed validation during UTXO reconstruction",
2025-11-09T23:19:32.5441731Z +                            height
2025-11-09T23:19:32.5441855Z +                        );
2025-11-09T23:19:32.5442149Z                          // Continue anyway - this might be expected for some edge cases
2025-11-09T23:19:32.5442276Z                      }
2025-11-09T23:19:32.5442384Z  
2025-11-09T23:19:32.5442872Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:740:
2025-11-09T23:19:32.5442993Z              }
2025-11-09T23:19:32.5443114Z          }
2025-11-09T23:19:32.5443226Z  
2025-11-09T23:19:32.5443664Z -        debug!("Reconstructed UTXO set at height {} with {} UTXOs", target_height, utxo_set.len());
2025-11-09T23:19:32.5443793Z +        debug!(
2025-11-09T23:19:32.5444654Z +            "Reconstructed UTXO set at height {} with {} UTXOs",
2025-11-09T23:19:32.5444804Z +            target_height,
2025-11-09T23:19:32.5444929Z +            utxo_set.len()
2025-11-09T23:19:32.5445048Z +        );
2025-11-09T23:19:32.5445180Z          Ok(utxo_set)
2025-11-09T23:19:32.5445294Z      }
2025-11-09T23:19:32.5445408Z  }
2025-11-09T23:19:32.5445888Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:747:
2025-11-09T23:19:32.5446001Z -
2025-11-09T23:19:32.5446110Z  
2025-11-09T23:19:32.5446403Z error[internal]: left behind trailing whitespace
2025-11-09T23:19:32.5452245Z   --> /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:91:91:1
2025-11-09T23:19:32.5452383Z    |
2025-11-09T23:19:32.5452512Z 91 |                 
2025-11-09T23:19:32.5452921Z    | ^^^^^^^^^^^^^^^^
2025-11-09T23:19:32.5453033Z    |
2025-11-09T23:19:32.5453042Z 
2025-11-09T23:19:32.5453351Z warning: rustfmt has failed to format. See previous 1 errors.
2025-11-09T23:19:32.5453359Z 
2025-11-09T23:19:32.5453828Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/txindex.rs:2:
2025-11-09T23:19:32.5453942Z  //!
2025-11-09T23:19:32.5454551Z  //! Provides fast lookup of transactions by hash and maintains transaction metadata.
2025-11-09T23:19:32.5454679Z  
2025-11-09T23:19:32.5454887Z +use crate::storage::database::{Database, Tree};
2025-11-09T23:19:32.5455021Z  use anyhow::Result;
2025-11-09T23:19:32.5455206Z  use bllvm_protocol::{Hash, Transaction};
2025-11-09T23:19:32.5455367Z  use serde::{Deserialize, Serialize};
2025-11-09T23:19:32.5455830Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/txindex.rs:8:
2025-11-09T23:19:32.5456027Z -use crate::storage::database::{Database, Tree};
2025-11-09T23:19:32.5456158Z  use std::sync::Arc;
2025-11-09T23:19:32.5456266Z  
2025-11-09T23:19:32.5456400Z  /// Transaction metadata
2025-11-09T23:19:32.5456881Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/txindex.rs:68:
2025-11-09T23:19:32.5456996Z          };
2025-11-09T23:19:32.5457104Z  
2025-11-09T23:19:32.5457342Z          let metadata_data = bincode::serialize(&metadata)?;
2025-11-09T23:19:32.5457605Z -        self.tx_metadata.insert(tx_hash.as_slice(), &metadata_data)?;
2025-11-09T23:19:32.5457731Z +        self.tx_metadata
2025-11-09T23:19:32.5457905Z +            .insert(tx_hash.as_slice(), &metadata_data)?;
2025-11-09T23:19:32.5458021Z  
2025-11-09T23:19:32.5458152Z          // Index by block
2025-11-09T23:19:32.5458382Z          let block_key = self.block_tx_key(block_hash, tx_index);
2025-11-09T23:19:32.5458855Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/utxostore.rs:2:
2025-11-09T23:19:32.5458960Z  //!
2025-11-09T23:19:32.5459253Z  //! Stores and manages the UTXO set for efficient transaction validation.
2025-11-09T23:19:32.5459375Z  
2025-11-09T23:19:32.5459780Z +use crate::storage::database::{Database, Tree};
2025-11-09T23:19:32.5459931Z  use anyhow::Result;
2025-11-09T23:19:32.5460130Z  use bllvm_protocol::{OutPoint, UtxoSet, UTXO};
2025-11-09T23:19:32.5460333Z -use crate::storage::database::{Database, Tree};
2025-11-09T23:19:32.5460482Z  use std::collections::HashMap;
2025-11-09T23:19:32.5460614Z  use std::sync::Arc;
2025-11-09T23:19:32.5460737Z  
2025-11-09T23:19:32.5461212Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/validation/mod.rs:51:
2025-11-09T23:19:32.5461382Z          context: &BlockValidationContext,
2025-11-09T23:19:32.5461553Z      ) -> Result<(ValidationResult, UtxoSet)> {
2025-11-09T23:19:32.5461750Z          // Create empty witnesses for each transaction
2025-11-09T23:19:32.5462215Z -        let witnesses: Vec<Witness> = context.block.transactions.iter().map(|_| Vec::new()).collect();
2025-11-09T23:19:32.5462386Z +        let witnesses: Vec<Witness> = context
2025-11-09T23:19:32.5462519Z +            .block
2025-11-09T23:19:32.5462645Z +            .transactions
2025-11-09T23:19:32.5462755Z +            .iter()
2025-11-09T23:19:32.5462898Z +            .map(|_| Vec::new())
2025-11-09T23:19:32.5463021Z +            .collect();
2025-11-09T23:19:32.5463146Z          connect_block(
2025-11-09T23:19:32.5463278Z              &context.block,
2025-11-09T23:19:32.5463405Z              &witnesses,
2025-11-09T23:19:32.5463869Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/validation/mod.rs:87:
2025-11-09T23:19:32.5463999Z              .par_iter()
2025-11-09T23:19:32.5464139Z              .map(|context| {
2025-11-09T23:19:32.5464513Z                  // Create empty witnesses for each transaction
2025-11-09T23:19:32.5464999Z -                let witnesses: Vec<Witness> = context.block.transactions.iter().map(|_| Vec::new()).collect();
2025-11-09T23:19:32.5465167Z +                let witnesses: Vec<Witness> = context
2025-11-09T23:19:32.5465516Z +                    .block
2025-11-09T23:19:32.5465647Z +                    .transactions
2025-11-09T23:19:32.5465771Z +                    .iter()
2025-11-09T23:19:32.5465929Z +                    .map(|_| Vec::new())
2025-11-09T23:19:32.5466051Z +                    .collect();
2025-11-09T23:19:32.5466181Z                  connect_block(
2025-11-09T23:19:32.5466313Z                      &context.block,
2025-11-09T23:19:32.5466438Z                      &witnesses,
2025-11-09T23:19:32.5466904Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/validation/mod.rs:116:
2025-11-09T23:19:32.5467018Z  
2025-11-09T23:19:32.5467168Z          for context in contexts {
2025-11-09T23:19:32.5467355Z              // Create empty witnesses for each transaction
2025-11-09T23:19:32.5467813Z -            let witnesses: Vec<Witness> = context.block.transactions.iter().map(|_| Vec::new()).collect();
2025-11-09T23:19:32.5467991Z +            let witnesses: Vec<Witness> = context
2025-11-09T23:19:32.5468121Z +                .block
2025-11-09T23:19:32.5468259Z +                .transactions
2025-11-09T23:19:32.5468372Z +                .iter()
2025-11-09T23:19:32.5469994Z +                .map(|_| Vec::new())
2025-11-09T23:19:32.5470125Z +                .collect();
2025-11-09T23:19:32.5470668Z              let result = connect_block(
2025-11-09T23:19:32.5470810Z                  &context.block,
2025-11-09T23:19:32.5470935Z                  &witnesses,
2025-11-09T23:19:32.5476023Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:9:
2025-11-09T23:19:32.5476215Z  async fn test_request_id_matching() {
2025-11-09T23:19:32.5478266Z      // Test that requests are matched by request_id, not FIFO
2025-11-09T23:19:32.5478580Z      let manager = NetworkManager::new(TransportPreference::TcpOnly);
2025-11-09T23:19:32.5478697Z -    
2025-11-09T23:19:32.5478817Z +
2025-11-09T23:19:32.5479081Z      let peer_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:19:32.5479207Z -    
2025-11-09T23:19:32.5479553Z +
2025-11-09T23:19:32.5479719Z      // Register multiple requests
2025-11-09T23:19:32.5479943Z      let (id1, rx1) = manager.register_request(peer_addr);
2025-11-09T23:19:32.5480150Z      let (id2, rx2) = manager.register_request(peer_addr);
2025-11-09T23:19:32.5480695Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:18:
2025-11-09T23:19:32.5480910Z      let (id3, rx3) = manager.register_request(peer_addr);
2025-11-09T23:19:32.5481019Z -    
2025-11-09T23:19:32.5481130Z +
2025-11-09T23:19:32.5481281Z      // Complete requests out of order
2025-11-09T23:19:32.5481423Z      let response2 = vec![2, 2, 2];
2025-11-09T23:19:32.5481566Z      let response1 = vec![1, 1, 1];
2025-11-09T23:19:32.5482091Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:23:
2025-11-09T23:19:32.5482236Z      let response3 = vec![3, 3, 3];
2025-11-09T23:19:32.5482359Z -    
2025-11-09T23:19:32.5482476Z +
2025-11-09T23:19:32.5482745Z      assert!(manager.complete_request(id2, response2.clone()));
2025-11-09T23:19:32.5482996Z      assert!(manager.complete_request(id1, response1.clone()));
2025-11-09T23:19:32.5483239Z      assert!(manager.complete_request(id3, response3.clone()));
2025-11-09T23:19:32.5483729Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:28:
2025-11-09T23:19:32.5483837Z -    
2025-11-09T23:19:32.5483947Z +
2025-11-09T23:19:32.5484153Z      // Verify each receiver got the correct response
2025-11-09T23:19:32.5484291Z      tokio::select! {
2025-11-09T23:19:32.5484582Z          result = rx1 => {
2025-11-09T23:19:32.5485111Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:35:
2025-11-09T23:19:32.5485268Z              panic!("Request 1 timeout");
2025-11-09T23:19:32.5485389Z          }
2025-11-09T23:19:32.5485499Z      }
2025-11-09T23:19:32.5485817Z -    
2025-11-09T23:19:32.5485928Z +
2025-11-09T23:19:32.5486076Z      tokio::select! {
2025-11-09T23:19:32.5486214Z          result = rx2 => {
2025-11-09T23:19:32.5486398Z              assert_eq!(result.unwrap(), response2);
2025-11-09T23:19:32.5486910Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:44:
2025-11-09T23:19:32.5487066Z              panic!("Request 2 timeout");
2025-11-09T23:19:32.5487190Z          }
2025-11-09T23:19:32.5487303Z      }
2025-11-09T23:19:32.5487414Z -    
2025-11-09T23:19:32.5487535Z +
2025-11-09T23:19:32.5487678Z      tokio::select! {
2025-11-09T23:19:32.5487814Z          result = rx3 => {
2025-11-09T23:19:32.5489778Z              assert_eq!(result.unwrap(), response3);
2025-11-09T23:19:32.5490305Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:59:
2025-11-09T23:19:32.5490465Z  async fn test_request_cancellation() {
2025-11-09T23:19:32.5490766Z      let manager = NetworkManager::new(TransportPreference::TcpOnly);
2025-11-09T23:19:32.5491054Z      let peer_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:19:32.5491165Z -    
2025-11-09T23:19:32.5491276Z +
2025-11-09T23:19:32.5491533Z      let (request_id, rx) = manager.register_request(peer_addr);
2025-11-09T23:19:32.5491649Z -    
2025-11-09T23:19:32.5491762Z +
2025-11-09T23:19:32.5491900Z      // Cancel the request
2025-11-09T23:19:32.5492104Z      assert!(manager.cancel_request(request_id));
2025-11-09T23:19:32.5492219Z -    
2025-11-09T23:19:32.5492334Z +
2025-11-09T23:19:32.5492493Z      // Try to complete it (should fail)
2025-11-09T23:19:32.5492779Z      assert!(!manager.complete_request(request_id, vec![1, 2, 3]));
2025-11-09T23:19:32.5492898Z -    
2025-11-09T23:19:32.5493013Z +
2025-11-09T23:19:32.5493171Z      // Receiver should be closed
2025-11-09T23:19:32.5493316Z      assert!(rx.await.is_err());
2025-11-09T23:19:32.5493437Z  }
2025-11-09T23:19:32.5493966Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:76:
2025-11-09T23:19:32.5494534Z  async fn test_timestamp_cleanup() {
2025-11-09T23:19:32.5494885Z      let manager = NetworkManager::new(TransportPreference::TcpOnly);
2025-11-09T23:19:32.5495163Z      let peer_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:19:32.5495268Z -    
2025-11-09T23:19:32.5495379Z +
2025-11-09T23:19:32.5495519Z      // Register a request
2025-11-09T23:19:32.5495768Z      let (request_id, _rx) = manager.register_request(peer_addr);
2025-11-09T23:19:32.5495867Z -    
2025-11-09T23:19:32.5495976Z +
2025-11-09T23:19:32.5496236Z      // Cleanup requests older than 0 seconds (should remove all)
2025-11-09T23:19:32.5496455Z      let cleaned = manager.cleanup_expired_requests(0);
2025-11-09T23:19:32.5496597Z      assert_eq!(cleaned, 1);
2025-11-09T23:19:32.5497118Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:86:
2025-11-09T23:19:32.5497242Z -    
2025-11-09T23:19:32.5497367Z +
2025-11-09T23:19:32.5497512Z      // Request should be gone
2025-11-09T23:19:32.5497802Z      assert!(!manager.complete_request(request_id, vec![1, 2, 3]));
2025-11-09T23:19:32.5497916Z  }
2025-11-09T23:19:32.5498435Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:92:
2025-11-09T23:19:32.5498677Z  async fn test_multiple_concurrent_requests_per_peer() {
2025-11-09T23:19:32.5498992Z      let manager = NetworkManager::new(TransportPreference::TcpOnly);
2025-11-09T23:19:32.5499247Z      let peer_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:19:32.5511310Z -    
2025-11-09T23:19:32.5511470Z +
2025-11-09T23:19:32.5511684Z      // Register multiple requests from same peer
2025-11-09T23:19:32.5511908Z      let (id1, rx1) = manager.register_request(peer_addr);
2025-11-09T23:19:32.5512136Z      let (id2, rx2) = manager.register_request(peer_addr);
2025-11-09T23:19:32.5512660Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:99:
2025-11-09T23:19:32.5513145Z      let (id3, rx3) = manager.register_request(peer_addr);
2025-11-09T23:19:32.5513262Z -    
2025-11-09T23:19:32.5513385Z +
2025-11-09T23:19:32.5513532Z      // All should be registered
2025-11-09T23:19:32.5513820Z      let pending = manager.get_pending_requests_for_peer(peer_addr);
2025-11-09T23:19:32.5513986Z      assert_eq!(pending.len(), 3);
2025-11-09T23:19:32.5514743Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:104:
2025-11-09T23:19:32.5514917Z      assert!(pending.contains(&id1));
2025-11-09T23:19:32.5515078Z      assert!(pending.contains(&id2));
2025-11-09T23:19:32.5515242Z      assert!(pending.contains(&id3));
2025-11-09T23:19:32.5515356Z -    
2025-11-09T23:19:32.5515471Z +
2025-11-09T23:19:32.5515615Z      // Complete all
2025-11-09T23:19:32.5515790Z      manager.complete_request(id1, vec![1]);
2025-11-09T23:19:32.5515958Z      manager.complete_request(id2, vec![2]);
2025-11-09T23:19:32.5516500Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:111:
2025-11-09T23:19:32.5516682Z      manager.complete_request(id3, vec![3]);
2025-11-09T23:19:32.5516798Z -    
2025-11-09T23:19:32.5516911Z +
2025-11-09T23:19:32.5517078Z      // All should receive responses
2025-11-09T23:19:32.5517251Z      assert_eq!(rx1.await.unwrap(), vec![1]);
2025-11-09T23:19:32.5517415Z      assert_eq!(rx2.await.unwrap(), vec![2]);
2025-11-09T23:19:32.5517925Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:120:
2025-11-09T23:19:32.5518085Z  async fn test_request_metrics() {
2025-11-09T23:19:32.5518399Z      let manager = NetworkManager::new(TransportPreference::TcpOnly);
2025-11-09T23:19:32.5518658Z      let peer_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:19:32.5518784Z -    
2025-11-09T23:19:32.5518896Z +
2025-11-09T23:19:32.5519051Z      // Register and complete a request
2025-11-09T23:19:32.5519288Z      let (id1, _rx1) = manager.register_request(peer_addr);
2025-11-09T23:19:32.5520527Z      manager.complete_request(id1, vec![1, 2, 3]);
2025-11-09T23:19:32.5523402Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:127:
2025-11-09T23:19:32.5523541Z -    
2025-11-09T23:19:32.5523655Z +
2025-11-09T23:19:32.5523783Z      // Check metrics
2025-11-09T23:19:32.5524017Z      let metrics = manager.get_request_metrics(peer_addr);
2025-11-09T23:19:32.5524175Z      assert!(metrics.is_some());
2025-11-09T23:19:32.5524844Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:132:
2025-11-09T23:19:32.5525010Z      assert_eq!(m.total_requests, 1);
2025-11-09T23:19:32.5525191Z      assert_eq!(m.successful_responses, 1);
2025-11-09T23:19:32.5525350Z      assert_eq!(m.failed_requests, 0);
2025-11-09T23:19:32.5525466Z -    
2025-11-09T23:19:32.5525580Z +
2025-11-09T23:19:32.5525725Z      // Record a failure
2025-11-09T23:19:32.5525959Z      let (id2, _rx2) = manager.register_request(peer_addr);
2025-11-09T23:19:32.5526133Z      manager.record_failed_request(id2);
2025-11-09T23:19:32.5526651Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:139:
2025-11-09T23:19:32.5526766Z -    
2025-11-09T23:19:32.5526880Z +
2025-11-09T23:19:32.5527108Z      let metrics = manager.get_request_metrics(peer_addr);
2025-11-09T23:19:32.5527265Z      let m = metrics.unwrap();
2025-11-09T23:19:32.5527418Z      assert_eq!(m.total_requests, 2);
2025-11-09T23:19:32.5527923Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:148:
2025-11-09T23:19:32.5528089Z  async fn test_request_priority() {
2025-11-09T23:19:32.5528395Z      let manager = NetworkManager::new(TransportPreference::TcpOnly);
2025-11-09T23:19:32.5528651Z      let peer_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:19:32.5528774Z -    
2025-11-09T23:19:32.5529154Z +
2025-11-09T23:19:32.5529352Z      // Register requests with different priorities
2025-11-09T23:19:32.5529651Z      let (_id1, _rx1) = manager.register_request_with_priority(peer_addr, 0);
2025-11-09T23:19:32.5529926Z      let (_id2, _rx2) = manager.register_request_with_priority(peer_addr, 5);
2025-11-09T23:19:32.5532839Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:155:
2025-11-09T23:19:32.5533148Z      let (_id3, _rx3) = manager.register_request_with_priority(peer_addr, 10);
2025-11-09T23:19:32.5533274Z -    
2025-11-09T23:19:32.5533386Z +
2025-11-09T23:19:32.5533533Z      // All should be registered
2025-11-09T23:19:32.5533804Z      let pending = manager.get_pending_requests_for_peer(peer_addr);
2025-11-09T23:19:32.5533961Z      assert_eq!(pending.len(), 3);
2025-11-09T23:19:32.5534613Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:160:
2025-11-09T23:19:32.5534730Z  }
2025-11-09T23:19:32.5534869Z -
2025-11-09T23:19:32.5534979Z -
2025-11-09T23:19:32.5535097Z -
2025-11-09T23:19:32.5535204Z  
2025-11-09T23:19:32.5535773Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:8:
2025-11-09T23:19:32.5535937Z  async fn test_ban_list_operations() {
2025-11-09T23:19:32.5536156Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:19:32.5536358Z      let manager = NetworkManager::new(addr);
2025-11-09T23:19:32.5536471Z -    
2025-11-09T23:19:32.5536580Z +
2025-11-09T23:19:32.5536835Z      let test_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:19:32.5536946Z -    
2025-11-09T23:19:32.5537056Z +
2025-11-09T23:19:32.5537178Z      // Test ban
2025-11-09T23:19:32.5537341Z      let now = SystemTime::now()
2025-11-09T23:19:32.5537493Z          .duration_since(UNIX_EPOCH)
2025-11-09T23:19:32.5538058Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:18:
2025-11-09T23:19:32.5538209Z          .as_secs();
2025-11-09T23:19:32.5538666Z      let future_timestamp = now + 3600; // 1 hour from now
2025-11-09T23:19:32.5538879Z      manager.ban_peer(test_addr, future_timestamp);
2025-11-09T23:19:32.5538990Z -    
2025-11-09T23:19:32.5539105Z +
2025-11-09T23:19:32.5539271Z      assert!(manager.is_banned(test_addr));
2025-11-09T23:19:32.5539381Z -    
2025-11-09T23:19:32.5539497Z +
2025-11-09T23:19:32.5540339Z      // Test unban
2025-11-09T23:19:32.5540516Z      manager.unban_peer(test_addr);
2025-11-09T23:19:32.5540686Z      assert!(!manager.is_banned(test_addr));
2025-11-09T23:19:32.5541358Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:30:
2025-11-09T23:19:32.5541528Z  async fn test_ban_list_expiration() {
2025-11-09T23:19:32.5541746Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:19:32.5541949Z      let manager = NetworkManager::new(addr);
2025-11-09T23:19:32.5542068Z -    
2025-11-09T23:19:32.5542191Z +
2025-11-09T23:19:32.5542466Z      let test_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:19:32.5542579Z -    
2025-11-09T23:19:32.5542696Z +
2025-11-09T23:19:32.5542862Z      // Ban with expiration in the past
2025-11-09T23:19:32.5543032Z      let now = SystemTime::now()
2025-11-09T23:19:32.5543186Z          .duration_since(UNIX_EPOCH)
2025-11-09T23:19:32.5543762Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:40:
2025-11-09T23:19:32.5543901Z          .as_secs();
2025-11-09T23:19:32.5544091Z      let past_timestamp = now - 3600; // 1 hour ago
2025-11-09T23:19:32.5544284Z      manager.ban_peer(test_addr, past_timestamp);
2025-11-09T23:19:32.5544596Z -    
2025-11-09T23:19:32.5544726Z +
2025-11-09T23:19:32.5544937Z      // is_banned should automatically check expiration
2025-11-09T23:19:32.5545106Z      assert!(!manager.is_banned(test_addr));
2025-11-09T23:19:32.5545230Z  }
2025-11-09T23:19:32.5545782Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:49:
2025-11-09T23:19:32.5546200Z  async fn test_ban_list_permanent() {
2025-11-09T23:19:32.5546416Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:19:32.5546615Z      let manager = NetworkManager::new(addr);
2025-11-09T23:19:32.5546732Z -    
2025-11-09T23:19:32.5547437Z +
2025-11-09T23:19:32.5547806Z      let test_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:19:32.5547924Z -    
2025-11-09T23:19:32.5548036Z +
2025-11-09T23:19:32.5548180Z      // Permanent ban (timestamp = 0)
2025-11-09T23:19:32.5548343Z      manager.ban_peer(test_addr, 0);
2025-11-09T23:19:32.5548510Z      assert!(manager.is_banned(test_addr));
2025-11-09T23:19:32.5549056Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:58:
2025-11-09T23:19:32.5549174Z -    
2025-11-09T23:19:32.5549283Z +
2025-11-09T23:19:32.5549410Z      // Clear all bans
2025-11-09T23:19:32.5549564Z      manager.clear_bans();
2025-11-09T23:19:32.5549735Z      assert!(!manager.is_banned(test_addr));
2025-11-09T23:19:32.5550277Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:66:
2025-11-09T23:19:32.5550448Z  async fn test_ban_list_multiple_peers() {
2025-11-09T23:19:32.5550679Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:19:32.5550868Z      let manager = NetworkManager::new(addr);
2025-11-09T23:19:32.5551450Z -    
2025-11-09T23:19:32.5551582Z +
2025-11-09T23:19:32.5551825Z      let addr1: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:19:32.5552049Z      let addr2: SocketAddr = "127.0.0.1:8334".parse().unwrap();
2025-11-09T23:19:32.5552276Z      let addr3: SocketAddr = "127.0.0.1:8335".parse().unwrap();
2025-11-09T23:19:32.5552843Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:73:
2025-11-09T23:19:32.5552962Z -    
2025-11-09T23:19:32.5553090Z +
2025-11-09T23:19:32.5553262Z      let now = SystemTime::now()
2025-11-09T23:19:32.5553661Z          .duration_since(UNIX_EPOCH)
2025-11-09T23:19:32.5553805Z          .unwrap()
2025-11-09T23:19:32.5554553Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:77:
2025-11-09T23:19:32.5554693Z          .as_secs();
2025-11-09T23:19:32.5554807Z -    
2025-11-09T23:19:32.5554920Z +
2025-11-09T23:19:32.5555091Z      manager.ban_peer(addr1, now + 3600);
2025-11-09T23:19:32.5555260Z      manager.ban_peer(addr2, 0); // Permanent
2025-11-09T23:19:32.5555506Z      manager.ban_peer(addr3, now + 7200);
2025-11-09T23:19:32.5556070Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:82:
2025-11-09T23:19:32.5556187Z -    
2025-11-09T23:19:32.5556299Z +
2025-11-09T23:19:32.5556505Z      assert_eq!(manager.get_banned_peers().len(), 3);
2025-11-09T23:19:32.5556669Z      assert!(manager.is_banned(addr1));
2025-11-09T23:19:32.5556835Z      assert!(manager.is_banned(addr2));
2025-11-09T23:19:32.5557386Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:86:
2025-11-09T23:19:32.5557550Z      assert!(manager.is_banned(addr3));
2025-11-09T23:19:32.5557662Z -    
2025-11-09T23:19:32.5557774Z +
2025-11-09T23:19:32.5557895Z      // Unban one
2025-11-09T23:19:32.5558053Z      manager.unban_peer(addr2);
2025-11-09T23:19:32.5558258Z      assert_eq!(manager.get_banned_peers().len(), 2);
2025-11-09T23:19:32.5558812Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:91:
2025-11-09T23:19:32.5558986Z      assert!(!manager.is_banned(addr2));
2025-11-09T23:19:32.5559097Z  }
2025-11-09T23:19:32.5559208Z -
2025-11-09T23:19:32.5559320Z  
2025-11-09T23:19:32.5559803Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_tests.rs:22:
2025-11-09T23:19:32.5559954Z          .duration_since(UNIX_EPOCH)
2025-11-09T23:19:32.5560331Z          .unwrap()
2025-11-09T23:19:32.5560462Z          .as_secs();
2025-11-09T23:19:32.5560584Z -    
2025-11-09T23:19:32.5560698Z +
2025-11-09T23:19:32.5560898Z      // Create two ban lists with overlapping entries
2025-11-09T23:19:32.5561060Z      let list1 = BanListMessage {
2025-11-09T23:19:32.5561192Z          is_full: true,
2025-11-09T23:19:32.5561660Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_tests.rs:29:
2025-11-09T23:19:32.5561808Z          ban_list_hash: [0; 32],
2025-11-09T23:19:32.5561947Z          ban_entries: vec![
2025-11-09T23:19:32.5562267Z -            create_test_ban_entry([127, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 8333, now + 3600),
2025-11-09T23:19:32.5562596Z -            create_test_ban_entry([192, 168, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 8333, now + 7200),
2025-11-09T23:19:32.5562743Z +            create_test_ban_entry(
2025-11-09T23:19:32.5562915Z +                [127, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
2025-11-09T23:19:32.5563049Z +                8333,
2025-11-09T23:19:32.5563199Z +                now + 3600,
2025-11-09T23:19:32.5563318Z +            ),
2025-11-09T23:19:32.5563461Z +            create_test_ban_entry(
2025-11-09T23:19:32.5563652Z +                [192, 168, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
2025-11-09T23:19:32.5563770Z +                8333,
2025-11-09T23:19:32.5563901Z +                now + 7200,
2025-11-09T23:19:32.5564018Z +            ),
2025-11-09T23:19:32.5564144Z          ],
2025-11-09T23:19:32.5564280Z          timestamp: now,
2025-11-09T23:19:32.5564571Z      };
2025-11-09T23:19:32.5565059Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_tests.rs:36:
2025-11-09T23:19:32.5565177Z -    
2025-11-09T23:19:32.5565290Z +
2025-11-09T23:19:32.5565441Z      let list2 = BanListMessage {
2025-11-09T23:19:32.5565580Z          is_full: true,
2025-11-09T23:19:32.5565717Z          ban_list_hash: [0; 32],
2025-11-09T23:19:32.5566176Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_tests.rs:40:
2025-11-09T23:19:32.5566548Z          ban_entries: vec![
2025-11-09T23:19:32.5566716Z              // Same address, longer ban
2025-11-09T23:19:32.5567033Z -            create_test_ban_entry([127, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 8333, now + 7200),
2025-11-09T23:19:32.5567184Z +            create_test_ban_entry(
2025-11-09T23:19:32.5567355Z +                [127, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
2025-11-09T23:19:32.5567474Z +                8333,
2025-11-09T23:19:32.5567603Z +                now + 7200,
2025-11-09T23:19:32.5567727Z +            ),
2025-11-09T23:19:32.5567853Z              // New address
2025-11-09T23:19:32.5568152Z -            create_test_ban_entry([10, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 8333, now + 1800),
2025-11-09T23:19:32.5569780Z +            create_test_ban_entry(
2025-11-09T23:19:32.5569943Z +                [10, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
2025-11-09T23:19:32.5570078Z +                8333,
2025-11-09T23:19:32.5570213Z +                now + 1800,
2025-11-09T23:19:32.5570339Z +            ),
2025-11-09T23:19:32.5570458Z          ],
2025-11-09T23:19:32.5570593Z          timestamp: now,
2025-11-09T23:19:32.5570722Z      };
2025-11-09T23:19:32.5571174Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_tests.rs:48:
2025-11-09T23:19:32.5571281Z -    
2025-11-09T23:19:32.5571389Z +
2025-11-09T23:19:32.5571593Z      let merged = merge_ban_lists(vec![&list1, &list2]);
2025-11-09T23:19:32.5571698Z -    
2025-11-09T23:19:32.5571802Z +
2025-11-09T23:19:32.5571952Z      // Should have 3 unique addresses
2025-11-09T23:19:32.5572095Z      assert_eq!(merged.len(), 3);
2025-11-09T23:19:32.5572215Z -    
2025-11-09T23:19:32.5572328Z +
2025-11-09T23:19:32.5572491Z      // 127.0.0.1 should have longer ban (7200)
2025-11-09T23:19:32.5572634Z -    let entry_127 = merged.iter()
2025-11-09T23:19:32.5572778Z -        .find(|e| e.addr.ip[0] == 127)
2025-11-09T23:19:32.5573140Z -        .unwrap();
2025-11-09T23:19:32.5573427Z +    let entry_127 = merged.iter().find(|e| e.addr.ip[0] == 127).unwrap();
2025-11-09T23:19:32.5573630Z      assert_eq!(entry_127.unban_timestamp, now + 7200);
2025-11-09T23:19:32.5573743Z  }
2025-11-09T23:19:32.5573864Z  
2025-11-09T23:19:32.5574525Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_tests.rs:64:
2025-11-09T23:19:32.5574687Z          .duration_since(UNIX_EPOCH)
2025-11-09T23:19:32.5574818Z          .unwrap()
2025-11-09T23:19:32.5574941Z          .as_secs();
2025-11-09T23:19:32.5575058Z -    
2025-11-09T23:19:32.5575165Z +
2025-11-09T23:19:32.5575312Z      // Valid future ban
2025-11-09T23:19:32.5575711Z -    let future_ban = create_test_ban_entry([127, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 8333, now + 3600);
2025-11-09T23:19:32.5575885Z +    let future_ban = create_test_ban_entry(
2025-11-09T23:19:32.5576067Z +        [127, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
2025-11-09T23:19:32.5576201Z +        8333,
2025-11-09T23:19:32.5576334Z +        now + 3600,
2025-11-09T23:19:32.5576452Z +    );
2025-11-09T23:19:32.5576639Z      assert!(validate_ban_entry(&future_ban));
2025-11-09T23:19:32.5576754Z -    
2025-11-09T23:19:32.5576866Z +
2025-11-09T23:19:32.5577019Z      // Valid permanent ban
2025-11-09T23:19:32.5577467Z -    let permanent_ban = create_test_ban_entry([192, 168, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 8333, u64::MAX);
2025-11-09T23:19:32.5577646Z +    let permanent_ban = create_test_ban_entry(
2025-11-09T23:19:32.5577826Z +        [192, 168, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
2025-11-09T23:19:32.5577941Z +        8333,
2025-11-09T23:19:32.5578067Z +        u64::MAX,
2025-11-09T23:19:32.5578181Z +    );
2025-11-09T23:19:32.5578380Z      assert!(validate_ban_entry(&permanent_ban));
2025-11-09T23:19:32.5578495Z -    
2025-11-09T23:19:32.5578605Z +
2025-11-09T23:19:32.5578762Z      // Expired ban (should be invalid)
2025-11-09T23:19:32.5579487Z -    let expired_ban = create_test_ban_entry([10, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 8333, now.saturating_sub(3600));
2025-11-09T23:19:32.5579677Z +    let expired_ban = create_test_ban_entry(
2025-11-09T23:19:32.5579840Z +        [10, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
2025-11-09T23:19:32.5579965Z +        8333,
2025-11-09T23:19:32.5580117Z +        now.saturating_sub(3600),
2025-11-09T23:19:32.5580230Z +    );
2025-11-09T23:19:32.5580416Z      assert!(!validate_ban_entry(&expired_ban));
2025-11-09T23:19:32.5580522Z  }
2025-11-09T23:19:32.5580628Z  
2025-11-09T23:19:32.5581103Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_tests.rs:84:
2025-11-09T23:19:32.5581267Z          .duration_since(UNIX_EPOCH)
2025-11-09T23:19:32.5581386Z          .unwrap()
2025-11-09T23:19:32.5581506Z          .as_secs();
2025-11-09T23:19:32.5581632Z -    
2025-11-09T23:19:32.5581744Z +
2025-11-09T23:19:32.5581882Z      let entries = vec![
2025-11-09T23:19:32.5582215Z -        create_test_ban_entry([127, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 8333, now + 3600),
2025-11-09T23:19:32.5582547Z -        create_test_ban_entry([192, 168, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 8333, now + 7200),
2025-11-09T23:19:32.5582681Z +        create_test_ban_entry(
2025-11-09T23:19:32.5582851Z +            [127, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
2025-11-09T23:19:32.5582977Z +            8333,
2025-11-09T23:19:32.5583098Z +            now + 3600,
2025-11-09T23:19:32.5583215Z +        ),
2025-11-09T23:19:32.5583355Z +        create_test_ban_entry(
2025-11-09T23:19:32.5583528Z +            [192, 168, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
2025-11-09T23:19:32.5583647Z +            8333,
2025-11-09T23:19:32.5583782Z +            now + 7200,
2025-11-09T23:19:32.5583898Z +        ),
2025-11-09T23:19:32.5584012Z      ];
2025-11-09T23:19:32.5584127Z -    
2025-11-09T23:19:32.5584248Z +
2025-11-09T23:19:32.5584631Z      let hash1 = calculate_ban_list_hash(&entries);
2025-11-09T23:19:32.5585081Z      let hash2 = calculate_ban_list_hash(&entries);
2025-11-09T23:19:32.5585210Z -    
2025-11-09T23:19:32.5585322Z +
2025-11-09T23:19:32.5585489Z      // Same entries should produce same hash
2025-11-09T23:19:32.5585628Z      assert_eq!(hash1, hash2);
2025-11-09T23:19:32.5585743Z -    
2025-11-09T23:19:32.5585853Z +
2025-11-09T23:19:32.5585979Z      // Verify hash
2025-11-09T23:19:32.5586187Z      assert!(verify_ban_list_hash(&entries, &hash1));
2025-11-09T23:19:32.5586299Z  }
2025-11-09T23:19:32.5588516Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_tests.rs:102:
2025-11-09T23:19:32.5588627Z -
2025-11-09T23:19:32.5588742Z -
2025-11-09T23:19:32.5589553Z -
2025-11-09T23:19:32.5589763Z  
2025-11-09T23:19:32.5590371Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip158_implementation_tests.rs:1:
2025-11-09T23:19:32.5590536Z  //! Tests for BIP158 implementation
2025-11-09T23:19:32.5590647Z  
2025-11-09T23:19:32.5591017Z  use bllvm_node::bip158::{build_block_filter, match_filter, CompactBlockFilter};
2025-11-09T23:19:32.5591452Z -use bllvm_protocol::{Transaction, TransactionInput, TransactionOutput, OutPoint};
2025-11-09T23:19:32.5591891Z +use bllvm_protocol::{OutPoint, Transaction, TransactionInput, TransactionOutput};
2025-11-09T23:19:32.5592002Z  
2025-11-09T23:19:32.5592123Z  #[test]
2025-11-09T23:19:32.5592309Z  fn test_build_block_filter_with_transactions() {
2025-11-09T23:19:32.5592877Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip158_implementation_tests.rs:15:
2025-11-09T23:19:32.5593004Z          }],
2025-11-09T23:19:32.5593132Z          lock_time: 0,
2025-11-09T23:19:32.5593246Z      };
2025-11-09T23:19:32.5593357Z -    
2025-11-09T23:19:32.5593478Z +
2025-11-09T23:19:32.5593618Z      let tx2 = Transaction {
2025-11-09T23:19:32.5593744Z          version: 1,
2025-11-09T23:19:32.5593912Z          inputs: vec![],
2025-11-09T23:19:32.5594632Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip158_implementation_tests.rs:25:
2025-11-09T23:19:32.5594975Z          }],
2025-11-09T23:19:32.5595126Z          lock_time: 0,
2025-11-09T23:19:32.5595243Z      };
2025-11-09T23:19:32.5595357Z -    
2025-11-09T23:19:32.5595465Z +
2025-11-09T23:19:32.5595712Z      let filter = build_block_filter(&[tx1, tx2], &[]).unwrap();
2025-11-09T23:19:32.5595871Z      assert_eq!(filter.num_elements, 2);
2025-11-09T23:19:32.5596066Z      assert!(!filter.filter_data.is_empty());
2025-11-09T23:19:32.5596618Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip158_implementation_tests.rs:42:
2025-11-09T23:19:32.5596732Z          }],
2025-11-09T23:19:32.5596863Z          lock_time: 0,
2025-11-09T23:19:32.5596980Z      };
2025-11-09T23:19:32.5597094Z -    
2025-11-09T23:19:32.5597204Z +
2025-11-09T23:19:32.5597559Z      let filter = build_block_filter(&[tx.clone()], &[]).unwrap();
2025-11-09T23:19:32.5597667Z -    
2025-11-09T23:19:32.5597779Z +
2025-11-09T23:19:32.5599810Z      // Script that's in the filter should match
2025-11-09T23:19:32.5600077Z      assert!(match_filter(&filter, &tx.outputs[0].script_pubkey));
2025-11-09T23:19:32.5600190Z  }
2025-11-09T23:19:32.5600772Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip158_implementation_tests.rs:67:
2025-11-09T23:19:32.5600894Z          }],
2025-11-09T23:19:32.5601252Z          lock_time: 0,
2025-11-09T23:19:32.5601362Z      };
2025-11-09T23:19:32.5601480Z -    
2025-11-09T23:19:32.5601593Z +
2025-11-09T23:19:32.5601786Z      // Previous output script (UTXO being spent)
2025-11-09T23:19:32.5601985Z      let prev_script = vec![0x54, 0x55]; // OP_4 OP_5
2025-11-09T23:19:32.5602099Z -    
2025-11-09T23:19:32.5602208Z +
2025-11-09T23:19:32.5602522Z      let filter = build_block_filter(&[tx], &[prev_script.clone()]).unwrap();
2025-11-09T23:19:32.5602643Z -    
2025-11-09T23:19:32.5602756Z +
2025-11-09T23:19:32.5602983Z      // Both output script and previous script should match
2025-11-09T23:19:32.5603412Z      assert!(filter.num_elements >= 1);
2025-11-09T23:19:32.5603530Z  }
2025-11-09T23:19:32.5604121Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip158_implementation_tests.rs:79:
2025-11-09T23:19:32.5604248Z -
2025-11-09T23:19:32.5604547Z  
2025-11-09T23:19:32.5605016Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:1:
2025-11-09T23:19:32.5605230Z  //! Tests for BIP70 payment verification and signing
2025-11-09T23:19:32.5605347Z  
2025-11-09T23:19:32.5605795Z -use bllvm_node::bip70::{PaymentRequest, Payment, PaymentOutput, PaymentProtocolServer};
2025-11-09T23:19:32.5606017Z -use bllvm_node::network::protocol::PaymentMessage;
2025-11-09T23:19:32.5606420Z -use bllvm_protocol::{Transaction, TransactionInput, TransactionOutput, OutPoint};
2025-11-09T23:19:32.5606748Z  use bllvm_consensus::serialization::transaction::serialize_transaction;
2025-11-09T23:19:32.5607160Z +use bllvm_node::bip70::{Payment, PaymentOutput, PaymentProtocolServer, PaymentRequest};
2025-11-09T23:19:32.5607406Z +use bllvm_node::network::protocol::PaymentMessage;
2025-11-09T23:19:32.5607794Z +use bllvm_protocol::{OutPoint, Transaction, TransactionInput, TransactionOutput};
2025-11-09T23:19:32.5607944Z  use secp256k1::{Secp256k1, SecretKey};
2025-11-09T23:19:32.5608056Z  
2025-11-09T23:19:32.5608179Z  #[test]
2025-11-09T23:19:32.5608629Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:13:
2025-11-09T23:19:32.5610590Z          script: vec![0x51], // OP_1
2025-11-09T23:19:32.5610736Z          amount: Some(1000),
2025-11-09T23:19:32.5610850Z      };
2025-11-09T23:19:32.5610967Z -    
2025-11-09T23:19:32.5611168Z -    let payment_request = PaymentRequest::new(
2025-11-09T23:19:32.5611314Z -        "main".to_string(),
2025-11-09T23:19:32.5611453Z -        vec![output.clone()],
2025-11-09T23:19:32.5611569Z -        1234567890,
2025-11-09T23:19:32.5611693Z -    );
2025-11-09T23:19:32.5611808Z -    
2025-11-09T23:19:32.5611912Z +
2025-11-09T23:19:32.5612604Z +    let payment_request = PaymentRequest::new("main".to_string(), vec![output.clone()], 1234567890);
2025-11-09T23:19:32.5612731Z +
2025-11-09T23:19:32.5612885Z      // Create a payment transaction
2025-11-09T23:19:32.5613022Z      let tx = Transaction {
2025-11-09T23:19:32.5613153Z          version: 1,
2025-11-09T23:19:32.5613620Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:37:
2025-11-09T23:19:32.5613740Z          }],
2025-11-09T23:19:32.5613871Z          lock_time: 0,
2025-11-09T23:19:32.5613998Z      };
2025-11-09T23:19:32.5614113Z -    
2025-11-09T23:19:32.5614227Z +
2025-11-09T23:19:32.5614618Z      let tx_bytes = serialize_transaction(&tx);
2025-11-09T23:19:32.5614734Z -    
2025-11-09T23:19:32.5614848Z +
2025-11-09T23:19:32.5615041Z      let payment = Payment::new(vec![tx_bytes]);
2025-11-09T23:19:32.5615159Z -    
2025-11-09T23:19:32.5615272Z +
2025-11-09T23:19:32.5615417Z      // Create payment message
2025-11-09T23:19:32.5615597Z      let payment_msg = PaymentMessage {
2025-11-09T23:19:32.5615718Z          payment,
2025-11-09T23:19:32.5616168Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:48:
2025-11-09T23:19:32.5616314Z          payment_id: vec![1, 2, 3, 4],
2025-11-09T23:19:32.5616429Z      };
2025-11-09T23:19:32.5616533Z -    
2025-11-09T23:19:32.5616640Z +
2025-11-09T23:19:32.5616856Z      // Process payment (without merchant key for now)
2025-11-09T23:19:32.5617104Z      let result = PaymentProtocolServer::process_payment(
2025-11-09T23:19:32.5617236Z          &payment_msg,
2025-11-09T23:19:32.5617693Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:54:
2025-11-09T23:19:32.5617846Z          &payment_request,
2025-11-09T23:19:32.5617992Z          None, // No merchant key
2025-11-09T23:19:32.5618105Z      );
2025-11-09T23:19:32.5618229Z -    
2025-11-09T23:19:32.5618340Z +
2025-11-09T23:19:32.5618508Z      // Should succeed (validation passes)
2025-11-09T23:19:32.5618894Z      assert!(result.is_ok());
2025-11-09T23:19:32.5619016Z  }
2025-11-09T23:19:32.5619486Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:63:
2025-11-09T23:19:32.5619637Z  fn test_payment_ack_signing() {
2025-11-09T23:19:32.5619799Z      let secp = Secp256k1::new();
2025-11-09T23:19:32.5620044Z      let merchant_key = SecretKey::from_slice(&[1; 32]).unwrap();
2025-11-09T23:19:32.5620156Z -    
2025-11-09T23:19:32.5620265Z +
2025-11-09T23:19:32.5620454Z      // Create payment request with merchant pubkey
2025-11-09T23:19:32.5620605Z      let output = PaymentOutput {
2025-11-09T23:19:32.5620737Z          script: vec![0x51],
2025-11-09T23:19:32.5623187Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:70:
2025-11-09T23:19:32.5623317Z          amount: Some(1000),
2025-11-09T23:19:32.5623425Z      };
2025-11-09T23:19:32.5623537Z -    
2025-11-09T23:19:32.5623731Z -    let mut payment_request = PaymentRequest::new(
2025-11-09T23:19:32.5623870Z -        "main".to_string(),
2025-11-09T23:19:32.5624002Z -        vec![output],
2025-11-09T23:19:32.5624126Z -        1234567890,
2025-11-09T23:19:32.5624233Z -    );
2025-11-09T23:19:32.5624538Z -    
2025-11-09T23:19:32.5624651Z +
2025-11-09T23:19:32.5625108Z +    let mut payment_request = PaymentRequest::new("main".to_string(), vec![output], 1234567890);
2025-11-09T23:19:32.5625221Z +
2025-11-09T23:19:32.5625364Z      // Set merchant pubkey
2025-11-09T23:19:32.5625760Z      let merchant_pubkey = secp256k1::PublicKey::from_secret_key(&secp, &merchant_key);
2025-11-09T23:19:32.5626135Z      payment_request.merchant_pubkey = Some(merchant_pubkey.serialize().to_vec());
2025-11-09T23:19:32.5626590Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:82:
2025-11-09T23:19:32.5626712Z -    
2025-11-09T23:19:32.5626821Z +
2025-11-09T23:19:32.5626948Z      // Create payment
2025-11-09T23:19:32.5627089Z      let tx = Transaction {
2025-11-09T23:19:32.5627228Z          version: 1,
2025-11-09T23:19:32.5627863Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:97:
2025-11-09T23:19:32.5627981Z          }],
2025-11-09T23:19:32.5628111Z          lock_time: 0,
2025-11-09T23:19:32.5628227Z      };
2025-11-09T23:19:32.5628339Z -    
2025-11-09T23:19:32.5628450Z +
2025-11-09T23:19:32.5628641Z      let tx_bytes = serialize_transaction(&tx);
2025-11-09T23:19:32.5628831Z      let payment = Payment::new(vec![tx_bytes]);
2025-11-09T23:19:32.5628943Z -    
2025-11-09T23:19:32.5629055Z +
2025-11-09T23:19:32.5629208Z      let payment_msg = PaymentMessage {
2025-11-09T23:19:32.5629321Z          payment,
2025-11-09T23:19:32.5629458Z          payment_id: vec![1, 2, 3, 4],
2025-11-09T23:19:32.5631321Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:107:
2025-11-09T23:19:32.5631434Z      };
2025-11-09T23:19:32.5631548Z -    
2025-11-09T23:19:32.5631662Z +
2025-11-09T23:19:32.5631826Z      // Process payment with merchant key
2025-11-09T23:19:32.5632061Z -    let result = PaymentProtocolServer::process_payment(
2025-11-09T23:19:32.5632184Z -        &payment_msg,
2025-11-09T23:19:32.5632324Z -        &payment_request,
2025-11-09T23:19:32.5632462Z -        Some(&merchant_key),
2025-11-09T23:19:32.5632578Z -    );
2025-11-09T23:19:32.5632700Z -    
2025-11-09T23:19:32.5632821Z +    let result =
2025-11-09T23:19:32.5633303Z +        PaymentProtocolServer::process_payment(&payment_msg, &payment_request, Some(&merchant_key));
2025-11-09T23:19:32.5633413Z +
2025-11-09T23:19:32.5633560Z      assert!(result.is_ok());
2025-11-09T23:19:32.5635201Z      let ack_msg = result.unwrap();
2025-11-09T23:19:32.5635346Z -    
2025-11-09T23:19:32.5635465Z +
2025-11-09T23:19:32.5635678Z      // Verify signature is present when key provided
2025-11-09T23:19:32.5635886Z      assert!(!ack_msg.merchant_signature.is_empty());
2025-11-09T23:19:32.5635999Z  }
2025-11-09T23:19:32.5636441Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:122:
2025-11-09T23:19:32.5636791Z -
2025-11-09T23:19:32.5636908Z  
2025-11-09T23:19:32.5637333Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:1:
2025-11-09T23:19:32.5637513Z -use bllvm_protocol::ProtocolVersion;
2025-11-09T23:19:32.5637713Z  use bllvm_node::storage::blockstore::BlockStore;
2025-11-09T23:19:32.5637911Z  use bllvm_node::storage::chainstate::ChainState;
2025-11-09T23:19:32.5638081Z  use bllvm_node::storage::txindex::TxIndex;
2025-11-09T23:19:32.5638490Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:9:
2025-11-09T23:19:32.5638635Z  use bllvm_node::OutPoint;
2025-11-09T23:19:32.5638787Z  use bllvm_node::Transaction;
2025-11-09T23:19:32.5639081Z  use bllvm_node::{ByteString, TransactionInput, TransactionOutput};
2025-11-09T23:19:32.5639250Z +use bllvm_protocol::ProtocolVersion;
2025-11-09T23:19:32.5639402Z  use std::collections::HashMap;
2025-11-09T23:19:32.5639547Z  use tempfile::TempDir;
2025-11-09T23:19:32.5639655Z  
2025-11-09T23:19:32.5640261Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:1:
2025-11-09T23:19:32.5640437Z  //! Tests for fee calculation functionality
2025-11-09T23:19:32.5640547Z  
2025-11-09T23:19:32.5640731Z  use bllvm_node::node::mempool::MempoolManager;
2025-11-09T23:19:32.5640987Z -use bllvm_protocol::{Transaction, UtxoSet, OutPoint, UTXO};
2025-11-09T23:19:32.5641231Z +use bllvm_protocol::{OutPoint, Transaction, UtxoSet, UTXO};
2025-11-09T23:19:32.5641339Z  
2025-11-09T23:19:32.5641463Z  #[test]
2025-11-09T23:19:32.5641623Z  fn test_calculate_transaction_fee() {
2025-11-09T23:19:32.5642137Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:8:
2025-11-09T23:19:32.5642311Z      let mempool = MempoolManager::new();
2025-11-09T23:19:32.5642421Z -    
2025-11-09T23:19:32.5642530Z +
2025-11-09T23:19:32.5642680Z      // Create a simple transaction
2025-11-09T23:19:32.5642847Z      let mut utxo_set = UtxoSet::new();
2025-11-09T23:19:32.5643192Z -    
2025-11-09T23:19:32.5643319Z +
2025-11-09T23:19:32.5643455Z      // Add a UTXO
2025-11-09T23:19:32.5643607Z      let outpoint = OutPoint {
2025-11-09T23:19:32.5643739Z          hash: [0u8; 32],
2025-11-09T23:19:32.5644273Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:16:
2025-11-09T23:19:32.5644651Z          index: 0,
2025-11-09T23:19:32.5644771Z      };
2025-11-09T23:19:32.5644903Z      let utxo = UTXO {
2025-11-09T23:19:32.5645049Z -        value: 100_000_000, // 1 BTC
2025-11-09T23:19:32.5645224Z +        value: 100_000_000,                    // 1 BTC
2025-11-09T23:19:32.5645442Z          script_pubkey: vec![0x76, 0xa9, 0x14], // P2PKH script
2025-11-09T23:19:32.5645551Z      };
2025-11-09T23:19:32.5645710Z      utxo_set.insert(outpoint, utxo);
2025-11-09T23:19:32.5646219Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:23:
2025-11-09T23:19:32.5646342Z -    
2025-11-09T23:19:32.5648302Z +
2025-11-09T23:19:32.5648511Z      // Create transaction with 1 input and 1 output
2025-11-09T23:19:32.5648653Z      let tx = Transaction {
2025-11-09T23:19:32.5648778Z          version: 1,
2025-11-09T23:19:32.5649305Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:36:
2025-11-09T23:19:32.5649426Z          }],
2025-11-09T23:19:32.5649555Z          lock_time: 0,
2025-11-09T23:19:32.5649682Z      };
2025-11-09T23:19:32.5649795Z -    
2025-11-09T23:19:32.5649906Z +
2025-11-09T23:19:32.5650161Z      let fee = mempool.calculate_transaction_fee(&tx, &utxo_set);
2025-11-09T23:19:32.5650280Z -    
2025-11-09T23:19:32.5650393Z +
2025-11-09T23:19:32.5650647Z      // Fee should be 1 BTC - 0.99 BTC = 0.01 BTC = 1,000,000 satoshis
2025-11-09T23:19:32.5650798Z      assert_eq!(fee, 1_000_000);
2025-11-09T23:19:32.5650912Z  }
2025-11-09T23:19:32.5651435Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:46:
2025-11-09T23:19:32.5651817Z  #[test]
2025-11-09T23:19:32.5652019Z  fn test_calculate_transaction_fee_zero_fee() {
2025-11-09T23:19:32.5652203Z      let mempool = MempoolManager::new();
2025-11-09T23:19:32.5652315Z -    
2025-11-09T23:19:32.5652435Z +
2025-11-09T23:19:32.5652587Z      let mut utxo_set = UtxoSet::new();
2025-11-09T23:19:32.5652729Z      let outpoint = OutPoint {
2025-11-09T23:19:32.5652857Z          hash: [0u8; 32],
2025-11-09T23:19:32.5653376Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:57:
2025-11-09T23:19:32.5653516Z          script_pubkey: vec![],
2025-11-09T23:19:32.5653631Z      };
2025-11-09T23:19:32.5653797Z      utxo_set.insert(outpoint, utxo);
2025-11-09T23:19:32.5653911Z -    
2025-11-09T23:19:32.5654022Z +
2025-11-09T23:19:32.5654222Z      // Transaction with same input and output (no fee)
2025-11-09T23:19:32.5654625Z      let tx = Transaction {
2025-11-09T23:19:32.5654771Z          version: 1,
2025-11-09T23:19:32.5655290Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:73:
2025-11-09T23:19:32.5655406Z          }],
2025-11-09T23:19:32.5655531Z          lock_time: 0,
2025-11-09T23:19:32.5655635Z      };
2025-11-09T23:19:32.5655745Z -    
2025-11-09T23:19:32.5655856Z +
2025-11-09T23:19:32.5656109Z      let fee = mempool.calculate_transaction_fee(&tx, &utxo_set);
2025-11-09T23:19:32.5656247Z      assert_eq!(fee, 0);
2025-11-09T23:19:32.5656365Z  }
2025-11-09T23:19:32.5656844Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:81:
2025-11-09T23:19:32.5656954Z  #[test]
2025-11-09T23:19:32.5657163Z  fn test_calculate_transaction_fee_missing_utxo() {
2025-11-09T23:19:32.5657350Z      let mempool = MempoolManager::new();
2025-11-09T23:19:32.5657462Z -    
2025-11-09T23:19:32.5657572Z +
2025-11-09T23:19:32.5657781Z      let utxo_set = UtxoSet::new(); // Empty UTXO set
2025-11-09T23:19:32.5657904Z -    
2025-11-09T23:19:32.5658012Z +
2025-11-09T23:19:32.5660691Z      let outpoint = OutPoint {
2025-11-09T23:19:32.5660859Z          hash: [0u8; 32],
2025-11-09T23:19:32.5660987Z          index: 0,
2025-11-09T23:19:32.5661529Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:90:
2025-11-09T23:19:32.5661654Z      };
2025-11-09T23:19:32.5661770Z -    
2025-11-09T23:19:32.5661884Z +
2025-11-09T23:19:32.5662034Z      let tx = Transaction {
2025-11-09T23:19:32.5662161Z          version: 1,
2025-11-09T23:19:32.5662341Z          inputs: vec![bllvm_protocol::TxIn {
2025-11-09T23:19:32.5662875Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:103:
2025-11-09T23:19:32.5662998Z          }],
2025-11-09T23:19:32.5663120Z          lock_time: 0,
2025-11-09T23:19:32.5663234Z      };
2025-11-09T23:19:32.5663351Z -    
2025-11-09T23:19:32.5663463Z +
2025-11-09T23:19:32.5663721Z      let fee = mempool.calculate_transaction_fee(&tx, &utxo_set);
2025-11-09T23:19:32.5664119Z      // If UTXO is missing, input_total will be 0, so fee will be 0 (or negative, but we return 0)
2025-11-09T23:19:32.5664263Z      assert_eq!(fee, 0);
2025-11-09T23:19:32.5665038Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:110:
2025-11-09T23:19:32.5665150Z  }
2025-11-09T23:19:32.5665262Z -
2025-11-09T23:19:32.5665373Z  
2025-11-09T23:19:32.5665900Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/iroh_peer_tracking_tests.rs:1:
2025-11-09T23:19:32.5666101Z  //! Tests for Iroh peer tracking with TransportAddr
2025-11-09T23:19:32.5666216Z  
2025-11-09T23:19:32.5666461Z -use bllvm_node::network::{NetworkManager, PeerManager};
2025-11-09T23:19:32.5666664Z  use bllvm_node::network::transport::TransportAddr;
2025-11-09T23:19:32.5666898Z +use bllvm_node::network::{NetworkManager, PeerManager};
2025-11-09T23:19:32.5667033Z  use std::net::SocketAddr;
2025-11-09T23:19:32.5667350Z  
2025-11-09T23:19:32.5667470Z  #[test]
2025-11-09T23:19:32.5668018Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/iroh_peer_tracking_tests.rs:8:
2025-11-09T23:19:32.5668185Z  fn test_peer_manager_transport_addr() {
2025-11-09T23:19:32.5668364Z      let mut manager = PeerManager::new(10);
2025-11-09T23:19:32.5668484Z -    
2025-11-09T23:19:32.5668594Z +
2025-11-09T23:19:32.5668840Z      let addr1: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:19:32.5669065Z      let addr2: SocketAddr = "127.0.0.1:8334".parse().unwrap();
2025-11-09T23:19:32.5669172Z -    
2025-11-09T23:19:32.5669286Z +
2025-11-09T23:19:32.5669418Z      // Test TCP peer
2025-11-09T23:19:32.5669612Z      let tcp_addr1 = TransportAddr::Tcp(addr1);
2025-11-09T23:19:32.5669785Z      let tcp_addr2 = TransportAddr::Tcp(addr2);
2025-11-09T23:19:32.5670323Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/iroh_peer_tracking_tests.rs:17:
2025-11-09T23:19:32.5670455Z -    
2025-11-09T23:19:32.5670562Z +
2025-11-09T23:19:32.5670852Z      // Create mock peers (would need actual Peer instances in real test)
2025-11-09T23:19:32.5672973Z      // For now, just test that TransportAddr works as HashMap key
2025-11-09T23:19:32.5673129Z      assert_ne!(tcp_addr1, tcp_addr2);
2025-11-09T23:19:32.5673651Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/iroh_peer_tracking_tests.rs:21:
2025-11-09T23:19:32.5673770Z -    
2025-11-09T23:19:32.5673877Z +
2025-11-09T23:19:32.5674060Z      // Test Iroh peer (different transport type)
2025-11-09T23:19:32.5674197Z      #[cfg(feature = "iroh")]
2025-11-09T23:19:32.5674542Z      {
2025-11-09T23:19:32.5675069Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/iroh_peer_tracking_tests.rs:31:
2025-11-09T23:19:32.5675188Z  #[test]
2025-11-09T23:19:32.5675352Z  fn test_find_transport_addr_by_socket() {
2025-11-09T23:19:32.5675524Z      let mut manager = PeerManager::new(10);
2025-11-09T23:19:32.5675650Z -    
2025-11-09T23:19:32.5675756Z +
2025-11-09T23:19:32.5676222Z      let addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:19:32.5676424Z      let tcp_addr = TransportAddr::Tcp(addr);
2025-11-09T23:19:32.5676536Z -    
2025-11-09T23:19:32.5676645Z +
2025-11-09T23:19:32.5676811Z      // Should not find peer that doesn't exist
2025-11-09T23:19:32.5677085Z      assert!(manager.find_transport_addr_by_socket(addr).is_none());
2025-11-09T23:19:32.5677190Z -    
2025-11-09T23:19:32.5677295Z +
2025-11-09T23:19:32.5677443Z      // After adding, should find it
2025-11-09T23:19:32.5677646Z      // Note: Would need actual Peer instance to test fully
2025-11-09T23:19:32.5677802Z      // This test validates the lookup logic
2025-11-09T23:19:32.5678316Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/iroh_peer_tracking_tests.rs:46:
2025-11-09T23:19:32.5678434Z  #[test]
2025-11-09T23:19:32.5678580Z  fn test_peer_socket_addresses() {
2025-11-09T23:19:32.5678745Z      let mut manager = PeerManager::new(10);
2025-11-09T23:19:32.5678864Z -    
2025-11-09T23:19:32.5678977Z +
2025-11-09T23:19:32.5679213Z      let addr1: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:19:32.5679431Z      let addr2: SocketAddr = "127.0.0.1:8334".parse().unwrap();
2025-11-09T23:19:32.5679544Z -    
2025-11-09T23:19:32.5679649Z +
2025-11-09T23:19:32.5679775Z      // Add TCP peers
2025-11-09T23:19:32.5679971Z      let tcp_addr1 = TransportAddr::Tcp(addr1);
2025-11-09T23:19:32.5680146Z      let tcp_addr2 = TransportAddr::Tcp(addr2);
2025-11-09T23:19:32.5682495Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/iroh_peer_tracking_tests.rs:56:
2025-11-09T23:19:32.5682616Z -    
2025-11-09T23:19:32.5682729Z +
2025-11-09T23:19:32.5682983Z      // Test that peer_socket_addresses returns TCP/Quinn addresses
2025-11-09T23:19:32.5683135Z      // and skips Iroh addresses
2025-11-09T23:19:32.5683359Z      let socket_addrs = manager.peer_socket_addresses();
2025-11-09T23:19:32.5684138Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/iroh_peer_tracking_tests.rs:60:
2025-11-09T23:19:32.5684603Z      // Should be empty since no peers added, but validates method exists
2025-11-09T23:19:32.5684771Z      assert_eq!(socket_addrs.len(), 0);
2025-11-09T23:19:32.5684885Z  }
2025-11-09T23:19:32.5684993Z -
2025-11-09T23:19:32.5685101Z  
2025-11-09T23:19:32.5685583Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:1:
2025-11-09T23:19:32.5685757Z  //! Tests for MempoolManager refactoring
2025-11-09T23:19:32.5685869Z  
2025-11-09T23:19:32.5686088Z  use bllvm_node::node::mempool::MempoolManager;
2025-11-09T23:19:32.5686594Z -use bllvm_protocol::{Transaction, TransactionInput, TransactionOutput, OutPoint, UtxoSet, UTXO};
2025-11-09T23:19:32.5687074Z +use bllvm_protocol::{OutPoint, Transaction, TransactionInput, TransactionOutput, UtxoSet, UTXO};
2025-11-09T23:19:32.5687240Z  use std::collections::HashMap;
2025-11-09T23:19:32.5687364Z  
2025-11-09T23:19:32.5687496Z  #[tokio::test]
2025-11-09T23:19:32.5687971Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:8:
2025-11-09T23:19:32.5688195Z  async fn test_mempool_stores_full_transactions() {
2025-11-09T23:19:32.5688379Z      let mut mempool = MempoolManager::new();
2025-11-09T23:19:32.5688497Z -    
2025-11-09T23:19:32.5688609Z +
2025-11-09T23:19:32.5688755Z      // Create a test transaction
2025-11-09T23:19:32.5688891Z      let tx = Transaction {
2025-11-09T23:19:32.5689015Z          version: 1,
2025-11-09T23:19:32.5689496Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:25:
2025-11-09T23:19:32.5689613Z          }],
2025-11-09T23:19:32.5689742Z          lock_time: 0,
2025-11-09T23:19:32.5689868Z      };
2025-11-09T23:19:32.5689980Z -    
2025-11-09T23:19:32.5690092Z +
2025-11-09T23:19:32.5690220Z      // Add transaction
2025-11-09T23:19:32.5690505Z      let added = mempool.add_transaction(tx.clone()).await.unwrap();
2025-11-09T23:19:32.5690644Z      assert!(added);
2025-11-09T23:19:32.5691361Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:32:
2025-11-09T23:19:32.5691504Z -    
2025-11-09T23:19:32.5691620Z +
2025-11-09T23:19:32.5691774Z      // Verify we can retrieve it
2025-11-09T23:19:32.5691984Z      use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:19:32.5692150Z      let tx_hash = calculate_tx_id(&tx);
2025-11-09T23:19:32.5692626Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:42:
2025-11-09T23:19:32.5692858Z  async fn test_mempool_get_prioritized_transactions() {
2025-11-09T23:19:32.5693036Z      let mut mempool = MempoolManager::new();
2025-11-09T23:19:32.5693206Z      let mut utxo_set: UtxoSet = HashMap::new();
2025-11-09T23:19:32.5693319Z -    
2025-11-09T23:19:32.5693444Z +
2025-11-09T23:19:32.5693585Z      // Create UTXO for input
2025-11-09T23:19:32.5693722Z      let outpoint = OutPoint {
2025-11-09T23:19:32.5693854Z          hash: [0u8; 32],
2025-11-09T23:19:32.5694482Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:49:
2025-11-09T23:19:32.5694622Z          index: 0,
2025-11-09T23:19:32.5694737Z      };
2025-11-09T23:19:32.5694920Z -    utxo_set.insert(outpoint.clone(), UTXO {
2025-11-09T23:19:32.5695036Z -        value: 10000,
2025-11-09T23:19:32.5695181Z -        script_pubkey: vec![0x51],
2025-11-09T23:19:32.5695295Z -    });
2025-11-09T23:19:32.5695411Z -    
2025-11-09T23:19:32.5695532Z +    utxo_set.insert(
2025-11-09T23:19:32.5695666Z +        outpoint.clone(),
2025-11-09T23:19:32.5695792Z +        UTXO {
2025-11-09T23:19:32.5695919Z +            value: 10000,
2025-11-09T23:19:32.5696067Z +            script_pubkey: vec![0x51],
2025-11-09T23:19:32.5696181Z +        },
2025-11-09T23:19:32.5696305Z +    );
2025-11-09T23:19:32.5696421Z +
2025-11-09T23:19:32.5696636Z      // Create two transactions with different fee rates
2025-11-09T23:19:32.5697049Z      // High fee transaction
2025-11-09T23:19:32.5697211Z      let high_fee_tx = Transaction {
2025-11-09T23:19:32.5697654Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:68:
2025-11-09T23:19:32.5697772Z          }],
2025-11-09T23:19:32.5712343Z          lock_time: 0,
2025-11-09T23:19:32.5712501Z      };
2025-11-09T23:19:32.5712618Z -    
2025-11-09T23:19:32.5712733Z +
2025-11-09T23:19:32.5712896Z      // Low fee transaction
2025-11-09T23:19:32.5713049Z      let low_fee_tx = Transaction {
2025-11-09T23:19:32.5713175Z          version: 1,
2025-11-09T23:19:32.5713673Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:86:
2025-11-09T23:19:32.5713797Z          }],
2025-11-09T23:19:32.5713930Z          lock_time: 0,
2025-11-09T23:19:32.5714049Z      };
2025-11-09T23:19:32.5714172Z -    
2025-11-09T23:19:32.5714283Z +
2025-11-09T23:19:32.5714615Z      // Add both transactions
2025-11-09T23:19:32.5714905Z      mempool.add_transaction(low_fee_tx.clone()).await.unwrap();
2025-11-09T23:19:32.5715209Z      mempool.add_transaction(high_fee_tx.clone()).await.unwrap();
2025-11-09T23:19:32.5715688Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:93:
2025-11-09T23:19:32.5715804Z -    
2025-11-09T23:19:32.5715921Z +
2025-11-09T23:19:32.5716125Z      // Get prioritized (should return high fee first)
2025-11-09T23:19:32.5716447Z      let prioritized = mempool.get_prioritized_transactions(10, &utxo_set);
2025-11-09T23:19:32.5716714Z      assert_eq!(prioritized.len(), 1); // Only one has valid UTXO
2025-11-09T23:19:32.5717173Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:97:
2025-11-09T23:19:32.5717287Z -    
2025-11-09T23:19:32.5717399Z +
2025-11-09T23:19:32.5717575Z      // Verify high fee transaction is first
2025-11-09T23:19:32.5717782Z      use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:19:32.5717986Z      let high_fee_hash = calculate_tx_id(&high_fee_tx);
2025-11-09T23:19:32.5718731Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:104:
2025-11-09T23:19:32.5718876Z  #[tokio::test]
2025-11-09T23:19:32.5719057Z  async fn test_mempool_remove_transaction() {
2025-11-09T23:19:32.5719237Z      let mut mempool = MempoolManager::new();
2025-11-09T23:19:32.5719347Z -    
2025-11-09T23:19:32.5719454Z +
2025-11-09T23:19:32.5719585Z      let tx = Transaction {
2025-11-09T23:19:32.5719717Z          version: 1,
2025-11-09T23:19:32.5719880Z          inputs: vec![TransactionInput {
2025-11-09T23:19:32.5720349Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:121:
2025-11-09T23:19:32.5720475Z          }],
2025-11-09T23:19:32.5720601Z          lock_time: 0,
2025-11-09T23:19:32.5720715Z      };
2025-11-09T23:19:32.5720829Z -    
2025-11-09T23:19:32.5720948Z +
2025-11-09T23:19:32.5721172Z      mempool.add_transaction(tx.clone()).await.unwrap();
2025-11-09T23:19:32.5721335Z      assert_eq!(mempool.size(), 1);
2025-11-09T23:19:32.5721454Z -    
2025-11-09T23:19:32.5721572Z +
2025-11-09T23:19:32.5721771Z      use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:19:32.5721928Z      let tx_hash = calculate_tx_id(&tx);
2025-11-09T23:19:32.5722157Z      let removed = mempool.remove_transaction(&tx_hash);
2025-11-09T23:19:32.5722630Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:131:
2025-11-09T23:19:32.5722763Z      assert!(removed);
2025-11-09T23:19:32.5722923Z      assert_eq!(mempool.size(), 0);
2025-11-09T23:19:32.5723035Z  }
2025-11-09T23:19:32.5723148Z -
2025-11-09T23:19:32.5723257Z  
2025-11-09T23:19:32.5723721Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:1:
2025-11-09T23:19:32.5723901Z -use bllvm_protocol::ProtocolVersion;
2025-11-09T23:19:32.5724110Z  use bllvm_node::storage::blockstore::BlockStore;
2025-11-09T23:19:32.5724495Z  use bllvm_node::storage::chainstate::ChainState;
2025-11-09T23:19:32.5724925Z  use bllvm_node::storage::txindex::TxIndex;
2025-11-09T23:19:32.5725361Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:9:
2025-11-09T23:19:32.5725513Z  use bllvm_node::OutPoint;
2025-11-09T23:19:32.5725658Z  use bllvm_node::Transaction;
2025-11-09T23:19:32.5725950Z  use bllvm_node::{ByteString, TransactionInput, TransactionOutput};
2025-11-09T23:19:32.5726132Z +use bllvm_protocol::ProtocolVersion;
2025-11-09T23:19:32.5726283Z  use std::collections::HashMap;
2025-11-09T23:19:32.5726414Z  use tempfile::TempDir;
2025-11-09T23:19:32.5726524Z  
2025-11-09T23:19:32.5727026Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_property_tests.rs:2:
2025-11-09T23:19:32.5727131Z  //!
2025-11-09T23:19:32.5727503Z  //! Uses proptest to verify invariants and properties that should hold for all inputs.
2025-11-09T23:19:32.5727608Z  
2025-11-09T23:19:32.5727730Z -use hex;
2025-11-09T23:19:32.5727881Z -use proptest::prelude::*;
2025-11-09T23:19:32.5728084Z +use bllvm_node::node::mempool::MempoolManager;
2025-11-09T23:19:32.5728247Z +use bllvm_node::rpc::mining::MiningRpc;
2025-11-09T23:19:32.5728406Z +use bllvm_node::storage::Storage;
2025-11-09T23:19:32.5728668Z  use bllvm_protocol::serialization::serialize_transaction;
2025-11-09T23:19:32.5728815Z  use bllvm_protocol::types::{
2025-11-09T23:19:32.5729382Z      BlockHeader, OutPoint, Transaction, TransactionInput, TransactionOutput,
2025-11-09T23:19:32.5729934Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_property_tests.rs:10:
2025-11-09T23:19:32.5730065Z  };
2025-11-09T23:19:32.5730273Z -use bllvm_node::node::mempool::MempoolManager;
2025-11-09T23:19:32.5730442Z -use bllvm_node::rpc::mining::MiningRpc;
2025-11-09T23:19:32.5730605Z -use bllvm_node::storage::Storage;
2025-11-09T23:19:32.5730723Z +use hex;
2025-11-09T23:19:32.5730876Z +use proptest::prelude::*;
2025-11-09T23:19:32.5731024Z  use sha2::{Digest, Sha256};
2025-11-09T23:19:32.5731166Z  use std::sync::Arc;
2025-11-09T23:19:32.5731320Z  use tempfile::TempDir;
2025-11-09T23:19:32.5732148Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_rpc_implementation_tests.rs:1:
2025-11-09T23:19:32.5732334Z  //! Tests for mining RPC implementation
2025-11-09T23:19:32.5732445Z  
2025-11-09T23:19:32.5732651Z +use bllvm_node::node::mempool::MempoolManager;
2025-11-09T23:19:32.5732821Z  use bllvm_node::rpc::mining::MiningRpc;
2025-11-09T23:19:32.5732977Z  use bllvm_node::storage::Storage;
2025-11-09T23:19:32.5733170Z -use bllvm_node::node::mempool::MempoolManager;
2025-11-09T23:19:32.5733306Z +use serde_json::json;
2025-11-09T23:19:32.5733445Z  use std::sync::Arc;
2025-11-09T23:19:32.5733584Z  use tempfile::TempDir;
2025-11-09T23:19:32.5733722Z -use serde_json::json;
2025-11-09T23:19:32.5733841Z  
2025-11-09T23:19:32.5733970Z  #[tokio::test]
2025-11-09T23:19:32.5734118Z  async fn test_get_mining_info() {
2025-11-09T23:19:32.5734968Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_rpc_implementation_tests.rs:12:
2025-11-09T23:19:32.5735186Z      let temp_dir = TempDir::new().unwrap();
2025-11-09T23:19:32.5735422Z      let storage = Storage::new(temp_dir.path()).unwrap();
2025-11-09T23:19:32.5735592Z      let mempool = MempoolManager::new();
2025-11-09T23:19:32.5735715Z -    
2025-11-09T23:19:32.5735833Z +
2025-11-09T23:19:32.5736221Z      let mining_rpc = MiningRpc::with_dependencies(Arc::new(storage), Arc::new(mempool));
2025-11-09T23:19:32.5736348Z -    
2025-11-09T23:19:32.5736459Z +
2025-11-09T23:19:32.5736680Z      let info = mining_rpc.get_mining_info().await.unwrap();
2025-11-09T23:19:32.5736786Z -    
2025-11-09T23:19:32.5736904Z +
2025-11-09T23:19:32.5737052Z      // Verify response structure
2025-11-09T23:19:32.5737213Z      assert!(info.get("blocks").is_some());
2025-11-09T23:19:32.5737395Z      assert!(info.get("pooledtx").is_some());
2025-11-09T23:19:32.5737997Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_rpc_implementation_tests.rs:29:
2025-11-09T23:19:32.5738401Z      let temp_dir = TempDir::new().unwrap();
2025-11-09T23:19:32.5738635Z      let storage = Storage::new(temp_dir.path()).unwrap();
2025-11-09T23:19:32.5738806Z      let mempool = MempoolManager::new();
2025-11-09T23:19:32.5738919Z -    
2025-11-09T23:19:32.5739034Z +
2025-11-09T23:19:32.5739414Z      let mining_rpc = MiningRpc::with_dependencies(Arc::new(storage), Arc::new(mempool));
2025-11-09T23:19:32.5739526Z -    
2025-11-09T23:19:32.5739640Z +
2025-11-09T23:19:32.5739792Z      let params = json!([]);
2025-11-09T23:19:32.5740063Z      let template = mining_rpc.get_block_template(&params).await;
2025-11-09T23:19:32.5740175Z -    
2025-11-09T23:19:32.5740286Z +
2025-11-09T23:19:32.5740473Z      // Should either succeed or fail gracefully
2025-11-09T23:19:32.5740695Z      // (may fail if chain not initialized, which is expected)
2025-11-09T23:19:32.5740888Z      assert!(template.is_ok() || template.is_err());
2025-11-09T23:19:32.5741501Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_rpc_implementation_tests.rs:45:
2025-11-09T23:19:32.5741687Z      let temp_dir = TempDir::new().unwrap();
2025-11-09T23:19:32.5741912Z      let storage = Storage::new(temp_dir.path()).unwrap();
2025-11-09T23:19:32.5742083Z      let mempool = MempoolManager::new();
2025-11-09T23:19:32.5742198Z -    
2025-11-09T23:19:32.5742310Z +
2025-11-09T23:19:32.5742690Z      let mining_rpc = MiningRpc::with_dependencies(Arc::new(storage), Arc::new(mempool));
2025-11-09T23:19:32.5742810Z -    
2025-11-09T23:19:32.5742920Z +
2025-11-09T23:19:32.5743264Z      // Create a minimal invalid block hex (will fail validation, which is expected)
2025-11-09T23:19:32.5743646Z      let invalid_block_hex = "0000000000000000000000000000000000000000000000000000000000000000";
2025-11-09T23:19:32.5743830Z      let params = json!([invalid_block_hex, ""]);
2025-11-09T23:19:32.5744597Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_rpc_implementation_tests.rs:54:
2025-11-09T23:19:32.5744735Z -    
2025-11-09T23:19:32.5744846Z +
2025-11-09T23:19:32.5745284Z      let result = mining_rpc.submit_block(&params).await;
2025-11-09T23:19:32.5745412Z -    
2025-11-09T23:19:32.5745532Z +
2025-11-09T23:19:32.5745757Z      // Should fail validation (expected for invalid block)
2025-11-09T23:19:32.5745899Z      assert!(result.is_err());
2025-11-09T23:19:32.5746007Z  }
2025-11-09T23:19:32.5746611Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_rpc_implementation_tests.rs:63:
2025-11-09T23:19:32.5746788Z      let temp_dir = TempDir::new().unwrap();
2025-11-09T23:19:32.5747008Z      let storage = Storage::new(temp_dir.path()).unwrap();
2025-11-09T23:19:32.5747178Z      let mempool = MempoolManager::new();
2025-11-09T23:19:32.5747286Z -    
2025-11-09T23:19:32.5747395Z +
2025-11-09T23:19:32.5747777Z      let mining_rpc = MiningRpc::with_dependencies(Arc::new(storage), Arc::new(mempool));
2025-11-09T23:19:32.5747898Z -    
2025-11-09T23:19:32.5748010Z +
2025-11-09T23:19:32.5748183Z      let params = json!([6, "conservative"]);
2025-11-09T23:19:32.5750331Z      let fee_estimate = mining_rpc.estimate_smart_fee(&params).await.unwrap();
2025-11-09T23:19:32.5750441Z -    
2025-11-09T23:19:32.5750548Z +
2025-11-09T23:19:32.5750705Z      // Verify response structure
2025-11-09T23:19:32.5750902Z      assert!(fee_estimate.get("feerate").is_some());
2025-11-09T23:19:32.5751086Z      assert!(fee_estimate.get("blocks").is_some());
2025-11-09T23:19:32.5751665Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_rpc_implementation_tests.rs:75:
2025-11-09T23:19:32.5751937Z      assert_eq!(fee_estimate.get("blocks").unwrap().as_u64().unwrap(), 6);
2025-11-09T23:19:32.5752035Z  }
2025-11-09T23:19:32.5752134Z -
2025-11-09T23:19:32.5752243Z  
2025-11-09T23:19:32.5752640Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:1:
2025-11-09T23:19:32.5752799Z -use bllvm_protocol::ProtocolVersion;
2025-11-09T23:19:32.5753191Z  use bllvm_node::storage::blockstore::BlockStore;
2025-11-09T23:19:32.5753394Z  use bllvm_node::storage::chainstate::ChainState;
2025-11-09T23:19:32.5753574Z  use bllvm_node::storage::txindex::TxIndex;
2025-11-09T23:19:32.5753994Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:9:
2025-11-09T23:19:32.5754146Z  use bllvm_node::OutPoint;
2025-11-09T23:19:32.5754456Z  use bllvm_node::Transaction;
2025-11-09T23:19:32.5754753Z  use bllvm_node::{ByteString, TransactionInput, TransactionOutput};
2025-11-09T23:19:32.5754935Z +use bllvm_protocol::ProtocolVersion;
2025-11-09T23:19:32.5755088Z  use std::collections::HashMap;
2025-11-09T23:19:32.5755230Z  use tempfile::TempDir;
2025-11-09T23:19:32.5755350Z  
2025-11-09T23:19:32.5766530Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_rpc_tests.rs:1:
2025-11-09T23:19:32.5766717Z  //! Unit tests for Mining RPC methods
2025-11-09T23:19:32.5766838Z  
2025-11-09T23:19:32.5767123Z -use bllvm_protocol::serialization::serialize_transaction;
2025-11-09T23:19:32.5767530Z -use bllvm_protocol::{BlockHeader, Natural, OutPoint, Transaction, UtxoSet, UTXO};
2025-11-09T23:19:32.5767747Z  use bllvm_node::node::mempool::MempoolManager;
2025-11-09T23:19:32.5767916Z  use bllvm_node::rpc::mining::MiningRpc;
2025-11-09T23:19:32.5768069Z  use bllvm_node::storage::Storage;
2025-11-09T23:19:32.5768560Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_rpc_tests.rs:8:
2025-11-09T23:19:32.5768832Z +use bllvm_protocol::serialization::serialize_transaction;
2025-11-09T23:19:32.5769221Z +use bllvm_protocol::{BlockHeader, Natural, OutPoint, Transaction, UtxoSet, UTXO};
2025-11-09T23:19:32.5769360Z  use std::sync::Arc;
2025-11-09T23:19:32.5769518Z  use tempfile::TempDir;
2025-11-09T23:19:32.5769679Z  // Sha256 not needed directly in tests
2025-11-09T23:19:32.5773076Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/module_process_sharing_tests.rs:3:
2025-11-09T23:19:32.5773656Z  use bllvm_node::module::process::monitor::ModuleProcessMonitor;
2025-11-09T23:19:32.5774066Z  use bllvm_node::module::process::spawner::{ModuleProcess, ModuleProcessSpawner};
2025-11-09T23:19:32.5774205Z  use std::sync::{Arc, Mutex};
2025-11-09T23:19:32.5774597Z -use tokio::sync::mpsc;
2025-11-09T23:19:32.5774724Z  use tempfile::TempDir;
2025-11-09T23:19:32.5774839Z +use tokio::sync::mpsc;
2025-11-09T23:19:32.5774953Z  
2025-11-09T23:19:32.5775073Z  #[tokio::test]
2025-11-09T23:19:32.5775243Z  async fn test_monitor_module_shared() {
2025-11-09T23:19:32.5775808Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/module_process_sharing_tests.rs:11:
2025-11-09T23:19:32.5775993Z      let temp_dir = TempDir::new().unwrap();
2025-11-09T23:19:32.5776216Z      let (crash_tx, _crash_rx) = mpsc::unbounded_channel();
2025-11-09T23:19:32.5776432Z      let monitor = ModuleProcessMonitor::new(crash_tx);
2025-11-09T23:19:32.5776555Z -    
2025-11-09T23:19:32.5776674Z +
2025-11-09T23:19:32.5776978Z      // Create a dummy process (using true command which exits immediately)
2025-11-09T23:19:32.5777198Z -    let process = tokio::process::Command::new("true")
2025-11-09T23:19:32.5777317Z -        .spawn()
2025-11-09T23:19:32.5777434Z -        .unwrap();
2025-11-09T23:19:32.5777545Z -    
2025-11-09T23:19:32.5777841Z +    let process = tokio::process::Command::new("true").spawn().unwrap();
2025-11-09T23:19:32.5777950Z +
2025-11-09T23:19:32.5778114Z      let module_process = ModuleProcess {
2025-11-09T23:19:32.5778271Z          module_name: "test".to_string(),
2025-11-09T23:19:32.5778392Z          process,
2025-11-09T23:19:32.5778963Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/module_process_sharing_tests.rs:23:
2025-11-09T23:19:32.5779150Z          socket_path: std::path::PathBuf::new(),
2025-11-09T23:19:32.5779276Z          client: None,
2025-11-09T23:19:32.5779388Z      };
2025-11-09T23:19:32.5779500Z -    
2025-11-09T23:19:32.5779861Z +
2025-11-09T23:19:32.5780112Z      let shared_process = Arc::new(Mutex::new(module_process));
2025-11-09T23:19:32.5780228Z -    
2025-11-09T23:19:32.5780347Z +
2025-11-09T23:19:32.5780537Z      // Test that monitor_module_shared can be called
2025-11-09T23:19:32.5780749Z      // (will exit quickly since process exits immediately)
2025-11-09T23:19:32.5781138Z -    let result = monitor.monitor_module_shared("test".to_string(), shared_process).await;
2025-11-09T23:19:32.5781255Z -    
2025-11-09T23:19:32.5781384Z +    let result = monitor
2025-11-09T23:19:32.5781635Z +        .monitor_module_shared("test".to_string(), shared_process)
2025-11-09T23:19:32.5781756Z +        .await;
2025-11-09T23:19:32.5781863Z +
2025-11-09T23:19:32.5782034Z      // Should succeed (process exits normally)
2025-11-09T23:19:32.5782174Z      assert!(result.is_ok());
2025-11-09T23:19:32.5782289Z  }
2025-11-09T23:19:32.5782857Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/module_process_sharing_tests.rs:36:
2025-11-09T23:19:32.5782978Z -
2025-11-09T23:19:32.5783097Z  
2025-11-09T23:19:32.5803347Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:1:
2025-11-09T23:19:32.5803571Z -use bllvm_protocol::ProtocolVersion;
2025-11-09T23:19:32.5803797Z  use bllvm_node::storage::blockstore::BlockStore;
2025-11-09T23:19:32.5803998Z  use bllvm_node::storage::chainstate::ChainState;
2025-11-09T23:19:32.5804175Z  use bllvm_node::storage::txindex::TxIndex;
2025-11-09T23:19:32.5804820Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:9:
2025-11-09T23:19:32.5804987Z  use bllvm_node::OutPoint;
2025-11-09T23:19:32.5805138Z  use bllvm_node::Transaction;
2025-11-09T23:19:32.5805450Z  use bllvm_node::{ByteString, TransactionInput, TransactionOutput};
2025-11-09T23:19:32.5805636Z +use bllvm_protocol::ProtocolVersion;
2025-11-09T23:19:32.5805788Z  use std::collections::HashMap;
2025-11-09T23:19:32.5805929Z  use tempfile::TempDir;
2025-11-09T23:19:32.5806050Z  
2025-11-09T23:19:32.5888544Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:8:
2025-11-09T23:19:32.5888779Z  use std::net::SocketAddr;
2025-11-09T23:19:32.5888918Z  use tokio::sync::mpsc;
2025-11-09T23:19:32.5889033Z  mod common;
2025-11-09T23:19:32.5889157Z -use common::*;
2025-11-09T23:19:32.5889494Z  use bllvm_node::network::inventory::{InventoryRequest, MSG_BLOCK, MSG_TX};
2025-11-09T23:19:32.5889826Z  use bllvm_node::network::protocol::InventoryItem as NetworkInventoryItem;
2025-11-09T23:19:32.5889956Z +use common::*;
2025-11-09T23:19:32.5890083Z  
2025-11-09T23:19:32.5890210Z  #[tokio::test]
2025-11-09T23:19:32.5890388Z  async fn test_network_manager_creation() {
2025-11-09T23:19:32.5890858Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:878:
2025-11-09T23:19:32.5891036Z  async fn test_persistent_peers() {
2025-11-09T23:19:32.5891253Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:19:32.5891447Z      let manager = NetworkManager::new(addr);
2025-11-09T23:19:32.5891572Z -    
2025-11-09T23:19:32.5891695Z +
2025-11-09T23:19:32.5891931Z      let peer1: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:19:32.5892137Z      let peer2: SocketAddr = "127.0.0.1:8334".parse().unwrap();
2025-11-09T23:19:32.5892232Z -    
2025-11-09T23:19:32.5892326Z +
2025-11-09T23:19:32.5892475Z      // Test adding persistent peers
2025-11-09T23:19:32.5892651Z      manager.add_persistent_peer(peer1);
2025-11-09T23:19:32.5892811Z      manager.add_persistent_peer(peer2);
2025-11-09T23:19:32.5893286Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:888:
2025-11-09T23:19:32.5893405Z -    
2025-11-09T23:19:32.5893514Z +
2025-11-09T23:19:32.5893721Z      let persistent = manager.get_persistent_peers();
2025-11-09T23:19:32.5893877Z      assert_eq!(persistent.len(), 2);
2025-11-09T23:19:32.5894056Z      assert!(persistent.contains(&peer1));
2025-11-09T23:19:32.5894716Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:892:
2025-11-09T23:19:32.5895140Z      assert!(persistent.contains(&peer2));
2025-11-09T23:19:32.5895255Z -    
2025-11-09T23:19:32.5895371Z +
2025-11-09T23:19:32.5895527Z      // Test removing persistent peer
2025-11-09T23:19:32.5895710Z      manager.remove_persistent_peer(peer1);
2025-11-09T23:19:32.5895914Z      let persistent = manager.get_persistent_peers();
2025-11-09T23:19:32.5896376Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:903:
2025-11-09T23:19:32.5896529Z  async fn test_ban_list() {
2025-11-09T23:19:32.5896740Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:19:32.5896926Z      let manager = NetworkManager::new(addr);
2025-11-09T23:19:32.5897035Z -    
2025-11-09T23:19:32.5897149Z +
2025-11-09T23:19:32.5897418Z      let banned_peer: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:19:32.5897532Z -    
2025-11-09T23:19:32.5897663Z +
2025-11-09T23:19:32.5897834Z      // Test banning a peer (permanent ban)
2025-11-09T23:19:32.5898004Z      manager.ban_peer(banned_peer, 0);
2025-11-09T23:19:32.5898179Z      assert!(manager.is_banned(banned_peer));
2025-11-09T23:19:32.5898663Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:912:
2025-11-09T23:19:32.5898775Z -    
2025-11-09T23:19:32.5898886Z +
2025-11-09T23:19:32.5899041Z      // Test getting banned peers
2025-11-09T23:19:32.5899211Z      let banned = manager.get_banned_peers();
2025-11-09T23:19:32.5899357Z      assert_eq!(banned.len(), 1);
2025-11-09T23:19:32.5899827Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:916:
2025-11-09T23:19:32.5899986Z      assert_eq!(banned[0].0, banned_peer);
2025-11-09T23:19:32.5900100Z -    
2025-11-09T23:19:32.5900210Z +
2025-11-09T23:19:32.5900344Z      // Test unbanning
2025-11-09T23:19:32.5900499Z      manager.unban_peer(banned_peer);
2025-11-09T23:19:32.5900682Z      assert!(!manager.is_banned(banned_peer));
2025-11-09T23:19:32.5901645Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:921:
2025-11-09T23:19:32.5901763Z -    
2025-11-09T23:19:32.5901872Z +
2025-11-09T23:19:32.5902008Z      // Test temporary ban
2025-11-09T23:19:32.5902187Z      use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:19:32.5902331Z      let now = SystemTime::now()
2025-11-09T23:19:32.5902789Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:928:
2025-11-09T23:19:32.5902982Z      let unban_time = now + 3600; // 1 hour from now
2025-11-09T23:19:32.5903161Z      manager.ban_peer(banned_peer, unban_time);
2025-11-09T23:19:32.5903325Z      assert!(manager.is_banned(banned_peer));
2025-11-09T23:19:32.5903434Z -    
2025-11-09T23:19:32.5903557Z +
2025-11-09T23:19:32.5903699Z      // Test clearing all bans
2025-11-09T23:19:32.5903839Z      manager.clear_bans();
2025-11-09T23:19:32.5904024Z      assert!(!manager.is_banned(banned_peer));
2025-11-09T23:19:32.5904691Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:939:
2025-11-09T23:19:32.5904850Z  async fn test_network_stats() {
2025-11-09T23:19:32.5905084Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:19:32.5905264Z      let manager = NetworkManager::new(addr);
2025-11-09T23:19:32.5905376Z -    
2025-11-09T23:19:32.5905491Z +
2025-11-09T23:19:32.5905652Z      // Initially stats should be zero
2025-11-09T23:19:32.5905855Z      let (sent, received) = manager.get_network_stats();
2025-11-09T23:19:32.5905984Z      assert_eq!(sent, 0);
2025-11-09T23:19:32.5906449Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:946:
2025-11-09T23:19:32.5906590Z      assert_eq!(received, 0);
2025-11-09T23:19:32.5906699Z -    
2025-11-09T23:19:32.5906809Z +
2025-11-09T23:19:32.5906950Z      // Track some bytes
2025-11-09T23:19:32.5907099Z      manager.track_bytes_sent(100);
2025-11-09T23:19:32.5907474Z      manager.track_bytes_received(200);
2025-11-09T23:19:32.5907966Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:951:
2025-11-09T23:19:32.5908085Z -    
2025-11-09T23:19:32.5908195Z +
2025-11-09T23:19:32.5908402Z      let (sent, received) = manager.get_network_stats();
2025-11-09T23:19:32.5908549Z      assert_eq!(sent, 100);
2025-11-09T23:19:32.5908691Z      assert_eq!(received, 200);
2025-11-09T23:19:32.5909155Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:955:
2025-11-09T23:19:32.5909276Z -    
2025-11-09T23:19:32.5909389Z +
2025-11-09T23:19:32.5909556Z      // Track more bytes (should accumulate)
2025-11-09T23:19:32.5909702Z      manager.track_bytes_sent(50);
2025-11-09T23:19:32.5909863Z      manager.track_bytes_received(75);
2025-11-09T23:19:32.5910798Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:959:
2025-11-09T23:19:32.5910917Z -    
2025-11-09T23:19:32.5911050Z +
2025-11-09T23:19:32.5911266Z      let (sent, received) = manager.get_network_stats();
2025-11-09T23:19:32.5911405Z      assert_eq!(sent, 150);
2025-11-09T23:19:32.5911551Z      assert_eq!(received, 275);
2025-11-09T23:19:32.5912025Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:966:
2025-11-09T23:19:32.5912179Z  async fn test_ping_all_peers() {
2025-11-09T23:19:32.5912389Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:19:32.5912585Z      let manager = NetworkManager::new(addr);
2025-11-09T23:19:32.5912700Z -    
2025-11-09T23:19:32.5912811Z +
2025-11-09T23:19:32.5913002Z      // Test ping with no peers (should not error)
2025-11-09T23:19:32.5913190Z      let result = manager.ping_all_peers().await;
2025-11-09T23:19:32.5913335Z      assert!(result.is_ok());
2025-11-09T23:19:32.5913809Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:973:
2025-11-09T23:19:32.5913940Z -    
2025-11-09T23:19:32.5914051Z +
2025-11-09T23:19:32.5914776Z      // Note: Testing with actual peers would require setting up connections,
2025-11-09T23:19:32.5915095Z      // which is more complex. This test verifies the method doesn't panic.
2025-11-09T23:19:32.5915200Z  }
2025-11-09T23:19:32.5922912Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:1:
2025-11-09T23:19:32.5923136Z -use bllvm_protocol::ProtocolVersion;
2025-11-09T23:19:32.5923345Z  use bllvm_node::storage::blockstore::BlockStore;
2025-11-09T23:19:32.5923544Z  use bllvm_node::storage::chainstate::ChainState;
2025-11-09T23:19:32.5923724Z  use bllvm_node::storage::txindex::TxIndex;
2025-11-09T23:19:32.5924139Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:9:
2025-11-09T23:19:32.5924292Z  use bllvm_node::OutPoint;
2025-11-09T23:19:32.5924581Z  use bllvm_node::Transaction;
2025-11-09T23:19:32.5924898Z  use bllvm_node::{ByteString, TransactionInput, TransactionOutput};
2025-11-09T23:19:32.5925086Z +use bllvm_protocol::ProtocolVersion;
2025-11-09T23:19:32.5925247Z  use std::collections::HashMap;
2025-11-09T23:19:32.5925395Z  use tempfile::TempDir;
2025-11-09T23:19:32.5925510Z  
2025-11-09T23:19:32.5958555Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/node_tests.rs:5:
2025-11-09T23:19:32.5958752Z  use std::net::SocketAddr;
2025-11-09T23:19:32.5958898Z  use tempfile::TempDir;
2025-11-09T23:19:32.5959023Z  mod common;
2025-11-09T23:19:32.5959144Z -use common::*;
2025-11-09T23:19:32.5959324Z  use bllvm_protocol::ProtocolVersion;
2025-11-09T23:19:32.5959449Z +use common::*;
2025-11-09T23:19:32.5959563Z  
2025-11-09T23:19:32.5959699Z  #[tokio::test]
2025-11-09T23:19:32.5959854Z  async fn test_node_creation() {
2025-11-09T23:19:32.5967369Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/peer_stats_tests.rs:3:
2025-11-09T23:19:32.5967575Z  use bllvm_node::network::peer::Peer;
2025-11-09T23:19:32.5967739Z  use bllvm_node::network::NetworkMessage;
2025-11-09T23:19:32.5968097Z  use std::net::SocketAddr;
2025-11-09T23:19:32.5968218Z -use tokio::sync::mpsc;
2025-11-09T23:19:32.5968343Z  use tokio::net::TcpStream;
2025-11-09T23:19:32.5968453Z +use tokio::sync::mpsc;
2025-11-09T23:19:32.5968550Z  
2025-11-09T23:19:32.5968657Z  #[tokio::test]
2025-11-09T23:19:32.5968819Z  async fn test_peer_stats_initialization() {
2025-11-09T23:19:32.5969250Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/peer_stats_tests.rs:11:
2025-11-09T23:19:32.5969454Z      let addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:19:32.5969608Z      let (tx, _rx) = mpsc::unbounded_channel();
2025-11-09T23:19:32.5969703Z -    
2025-11-09T23:19:32.5969795Z +
2025-11-09T23:19:32.5969908Z      // Create a mock stream
2025-11-09T23:19:32.5970186Z      let listener = tokio::net::TcpListener::bind("127.0.0.1:0").await.unwrap();
2025-11-09T23:19:32.5970355Z      let local_addr = listener.local_addr().unwrap();
2025-11-09T23:19:32.5970775Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/peer_stats_tests.rs:17:
2025-11-09T23:19:32.5971032Z      let stream = tokio::net::TcpStream::connect(local_addr).await.unwrap();
2025-11-09T23:19:32.5971128Z -    
2025-11-09T23:19:32.5971219Z +
2025-11-09T23:19:32.5971365Z      let peer = Peer::new(stream, addr, tx);
2025-11-09T23:19:32.5971458Z -    
2025-11-09T23:19:32.5971550Z +
2025-11-09T23:19:32.5971665Z      // Check initial stats
2025-11-09T23:19:32.5971800Z      assert!(peer.conntime() > 0);
2025-11-09T23:19:32.5971961Z      assert_eq!(peer.conntime(), peer.last_send());
2025-11-09T23:19:32.5972374Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/peer_stats_tests.rs:30:
2025-11-09T23:19:32.5972579Z  async fn test_peer_record_send() {
2025-11-09T23:19:32.5972843Z      let addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:19:32.5972989Z      let (tx, _rx) = mpsc::unbounded_channel();
2025-11-09T23:19:32.5973092Z -    
2025-11-09T23:19:32.5973203Z +
2025-11-09T23:19:32.5973802Z      let listener = tokio::net::TcpListener::bind("127.0.0.1:0").await.unwrap();
2025-11-09T23:19:32.5974075Z      let local_addr = listener.local_addr().unwrap();
2025-11-09T23:19:32.5974642Z      let stream = tokio::net::TcpStream::connect(local_addr).await.unwrap();
2025-11-09T23:19:32.5975115Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/peer_stats_tests.rs:37:
2025-11-09T23:19:32.5975214Z -    
2025-11-09T23:19:32.5975316Z +
2025-11-09T23:19:32.5975473Z      let mut peer = Peer::new(stream, addr, tx);
2025-11-09T23:19:32.5975571Z -    
2025-11-09T23:19:32.5975671Z +
2025-11-09T23:19:32.5975805Z      let initial_send = peer.last_send();
2025-11-09T23:19:32.5975939Z      let initial_bytes = peer.bytes_sent();
2025-11-09T23:19:32.5976035Z -    
2025-11-09T23:19:32.5976131Z +
2025-11-09T23:19:32.5976236Z      // Record a send
2025-11-09T23:19:32.5976354Z      peer.record_send(100);
2025-11-09T23:19:32.5976449Z -    
2025-11-09T23:19:32.5976559Z +
2025-11-09T23:19:32.5976708Z      assert!(peer.last_send() >= initial_send);
2025-11-09T23:19:32.5976882Z      assert_eq!(peer.bytes_sent(), initial_bytes + 100);
2025-11-09T23:19:32.5976982Z  }
2025-11-09T23:19:32.5977382Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/peer_stats_tests.rs:51:
2025-11-09T23:19:32.5977518Z  async fn test_peer_record_receive() {
2025-11-09T23:19:32.5977716Z      let addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:19:32.5977858Z      let (tx, _rx) = mpsc::unbounded_channel();
2025-11-09T23:19:32.5977950Z -    
2025-11-09T23:19:32.5978042Z +
2025-11-09T23:19:32.5978305Z      let listener = tokio::net::TcpListener::bind("127.0.0.1:0").await.unwrap();
2025-11-09T23:19:32.5978468Z      let local_addr = listener.local_addr().unwrap();
2025-11-09T23:19:32.5980597Z      let stream = tokio::net::TcpStream::connect(local_addr).await.unwrap();
2025-11-09T23:19:32.5980995Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/peer_stats_tests.rs:58:
2025-11-09T23:19:32.5981243Z -    
2025-11-09T23:19:32.5981339Z +
2025-11-09T23:19:32.5981489Z      let mut peer = Peer::new(stream, addr, tx);
2025-11-09T23:19:32.5981583Z -    
2025-11-09T23:19:32.5981676Z +
2025-11-09T23:19:32.5981804Z      let initial_recv = peer.last_recv();
2025-11-09T23:19:32.5981941Z      let initial_bytes = peer.bytes_recv();
2025-11-09T23:19:32.5982033Z -    
2025-11-09T23:19:32.5982125Z +
2025-11-09T23:19:32.5982847Z      // Record a receive
2025-11-09T23:19:32.5982982Z      peer.record_receive(200);
2025-11-09T23:19:32.5983077Z -    
2025-11-09T23:19:32.5983170Z +
2025-11-09T23:19:32.5983322Z      assert!(peer.last_recv() >= initial_recv);
2025-11-09T23:19:32.5983495Z      assert_eq!(peer.bytes_recv(), initial_bytes + 200);
2025-11-09T23:19:32.5983588Z  }
2025-11-09T23:19:32.5983983Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/peer_stats_tests.rs:70:
2025-11-09T23:19:32.5984082Z -
2025-11-09T23:19:32.5984178Z  
2025-11-09T23:19:32.5984946Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/protocol_message_processing_tests.rs:1:
2025-11-09T23:19:32.5985130Z  //! Tests for protocol message processing integration
2025-11-09T23:19:32.5985225Z  
2025-11-09T23:19:32.5985345Z  use bllvm_node::network;
2025-11-09T23:19:32.5985478Z -use bllvm_node::storage::Storage;
2025-11-09T23:19:32.5985600Z  use bllvm_node::node::mempool::MempoolManager;
2025-11-09T23:19:32.5985694Z +use bllvm_node::storage::Storage;
2025-11-09T23:19:32.5985866Z  use bllvm_protocol::{BitcoinProtocolEngine, ProtocolVersion};
2025-11-09T23:19:32.5985947Z -use std::sync::Arc;
2025-11-09T23:19:32.5986031Z  use std::net::SocketAddr;
2025-11-09T23:19:32.5986107Z +use std::sync::Arc;
2025-11-09T23:19:32.5986194Z  use tempfile::TempDir;
2025-11-09T23:19:32.5986261Z  
2025-11-09T23:19:32.5986339Z  #[tokio::test]
2025-11-09T23:19:32.5986695Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/protocol_message_processing_tests.rs:14:
2025-11-09T23:19:32.5987013Z      let storage = Arc::new(Storage::new(temp_dir.path()).unwrap());
2025-11-09T23:19:32.5987136Z      let mempool = Arc::new(MempoolManager::new());
2025-11-09T23:19:32.5987421Z      let protocol_engine = Arc::new(BitcoinProtocolEngine::new(ProtocolVersion::Regtest).unwrap());
2025-11-09T23:19:32.5987490Z -    
2025-11-09T23:19:32.5987558Z +
2025-11-09T23:19:32.5987711Z      let network_addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:19:32.5987885Z -    let network_manager = network::NetworkManager::new(network_addr)
2025-11-09T23:19:32.5988029Z -        .with_dependencies(protocol_engine, storage, mempool);
2025-11-09T23:19:32.5988095Z -    
2025-11-09T23:19:32.5988333Z +    let network_manager = network::NetworkManager::new(network_addr).with_dependencies(
2025-11-09T23:19:32.5988416Z +        protocol_engine,
2025-11-09T23:19:32.5988489Z +        storage,
2025-11-09T23:19:32.5988567Z +        mempool,
2025-11-09T23:19:32.5988640Z +    );
2025-11-09T23:19:32.5988708Z +
2025-11-09T23:19:32.5988804Z      // Verify dependencies are set
2025-11-09T23:19:32.5989018Z      // (NetworkManager doesn't expose these, but we can verify it was created)
2025-11-09T23:19:32.5989135Z      assert!(true); // If we got here, setup worked
2025-11-09T23:19:32.5989505Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/protocol_message_processing_tests.rs:29:
2025-11-09T23:19:32.5989612Z      let temp_dir = TempDir::new().unwrap();
2025-11-09T23:19:32.5989747Z      let storage = Storage::new(temp_dir.path()).unwrap();
2025-11-09T23:19:32.5989859Z      let mempool = Arc::new(MempoolManager::new());
2025-11-09T23:19:32.5989937Z -    
2025-11-09T23:19:32.5990004Z +
2025-11-09T23:19:32.5990142Z      // Verify we can create NodeChainAccess with Storage Arcs
2025-11-09T23:19:32.5990280Z      use bllvm_node::network::chain_access::NodeChainAccess;
2025-11-09T23:19:32.5990392Z -    let chain_access = NodeChainAccess::new(
2025-11-09T23:19:32.5990593Z -        storage.blocks(),
2025-11-09T23:19:32.5990682Z -        storage.transactions(),
2025-11-09T23:19:32.5990763Z -        mempool,
2025-11-09T23:19:32.5990833Z -    );
2025-11-09T23:19:32.5990902Z -    
2025-11-09T23:19:32.5991163Z +    let chain_access = NodeChainAccess::new(storage.blocks(), storage.transactions(), mempool);
2025-11-09T23:19:32.5991236Z +
2025-11-09T23:19:32.5991316Z      // Test that it works
2025-11-09T23:19:32.5991393Z      let hash = [0u8; 32];
2025-11-09T23:19:32.5991541Z      assert!(!chain_access.has_object(&hash)); // Empty storage
2025-11-09T23:19:32.5991892Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/protocol_message_processing_tests.rs:44:
2025-11-09T23:19:32.5991960Z  }
2025-11-09T23:19:32.5992027Z -
2025-11-09T23:19:32.5992100Z  
2025-11-09T23:19:32.6009826Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:1:
2025-11-09T23:19:32.6010026Z -use bllvm_protocol::ProtocolVersion;
2025-11-09T23:19:32.6010259Z  use bllvm_node::storage::blockstore::BlockStore;
2025-11-09T23:19:32.6010414Z  use bllvm_node::storage::chainstate::ChainState;
2025-11-09T23:19:32.6010521Z  use bllvm_node::storage::txindex::TxIndex;
2025-11-09T23:19:32.6010784Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:9:
2025-11-09T23:19:32.6010875Z  use bllvm_node::OutPoint;
2025-11-09T23:19:32.6010963Z  use bllvm_node::Transaction;
2025-11-09T23:19:32.6011151Z  use bllvm_node::{ByteString, TransactionInput, TransactionOutput};
2025-11-09T23:19:32.6011255Z +use bllvm_protocol::ProtocolVersion;
2025-11-09T23:19:32.6011345Z  use std::collections::HashMap;
2025-11-09T23:19:32.6011426Z  use tempfile::TempDir;
2025-11-09T23:19:32.6013399Z  
2025-11-09T23:19:32.6053502Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:10:
2025-11-09T23:19:32.6053720Z  #[tokio::test]
2025-11-09T23:19:32.6053941Z  async fn test_message_size_validation() {
2025-11-09T23:19:32.6054488Z      use bllvm_node::network::protocol::MAX_PROTOCOL_MESSAGE_LENGTH;
2025-11-09T23:19:32.6054930Z -    
2025-11-09T23:19:32.6055090Z +
2025-11-09T23:19:32.6055328Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:19:32.6055453Z      let manager = NetworkManager::new(addr);
2025-11-09T23:19:32.6055533Z -    
2025-11-09T23:19:32.6055606Z +
2025-11-09T23:19:32.6055724Z      // Test that oversized messages are rejected
2025-11-09T23:19:32.6055918Z      // This is tested at the TransportConnection level, but we can verify
2025-11-09T23:19:32.6056032Z      // the protocol parser also validates size
2025-11-09T23:19:32.6056337Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:20:
2025-11-09T23:19:32.6056485Z      use bllvm_node::network::protocol::ProtocolParser;
2025-11-09T23:19:32.6056560Z -    
2025-11-09T23:19:32.6056630Z +
2025-11-09T23:19:32.6056733Z      // Create a message that's too large
2025-11-09T23:19:32.6056912Z      let oversized_data = vec![0u8; MAX_PROTOCOL_MESSAGE_LENGTH + 1];
2025-11-09T23:19:32.6057090Z      let result = ProtocolParser::parse_message(&oversized_data);
2025-11-09T23:19:32.6057383Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:29:
2025-11-09T23:19:32.6057487Z  async fn test_rate_limiting() {
2025-11-09T23:19:32.6057628Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:19:32.6057742Z      let manager = NetworkManager::new(addr);
2025-11-09T23:19:32.6057819Z -    
2025-11-09T23:19:32.6057893Z +
2025-11-09T23:19:32.6058072Z      // Rate limiting is tested implicitly through message processing
2025-11-09T23:19:32.6058272Z      // The rate limiter is checked in process_messages for RawMessageReceived
2025-11-09T23:19:32.6058448Z      // This test verifies the rate limiter structure exists and works
2025-11-09T23:19:32.6058739Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:36:
2025-11-09T23:19:32.6058948Z -    
2025-11-09T23:19:32.6059024Z +
2025-11-09T23:19:32.6059137Z      // Add a peer address to test rate limiting
2025-11-09T23:19:32.6059301Z      let test_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:19:32.6059373Z -    
2025-11-09T23:19:32.6059450Z +
2025-11-09T23:19:32.6059607Z      // Rate limiter should be created when first message arrives
2025-11-09T23:19:32.6059795Z      // We can't easily test this without a real connection, but the structure
2025-11-09T23:19:32.6059938Z      // is in place and will be tested in integration tests
2025-11-09T23:19:32.6060235Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:47:
2025-11-09T23:19:32.6060347Z  async fn test_per_ip_connection_limit() {
2025-11-09T23:19:32.6060486Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:19:32.6060600Z      let manager = NetworkManager::new(addr);
2025-11-09T23:19:32.6060672Z -    
2025-11-09T23:19:32.6060742Z +
2025-11-09T23:19:32.6060857Z      // Test that per-IP limits are enforced
2025-11-09T23:19:32.6061030Z      // This is tested in connect_to_peer, but we need a mock transport
2025-11-09T23:19:32.6061131Z      // For now, verify the structure exists
2025-11-09T23:19:32.6061427Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:54:
2025-11-09T23:19:32.6061532Z      let test_ip = "127.0.0.1".parse().unwrap();
2025-11-09T23:19:32.6061605Z -    
2025-11-09T23:19:32.6061676Z +
2025-11-09T23:19:32.6061817Z      // Connection limits are enforced in connect_to_peer
2025-11-09T23:19:32.6061940Z      // Integration test needed for full verification
2025-11-09T23:19:32.6062128Z      assert!(true); // Placeholder - per-IP limits tested in integration
2025-11-09T23:19:32.6062434Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:62:
2025-11-09T23:19:32.6062534Z  async fn test_ban_list_cleanup() {
2025-11-09T23:19:32.6062668Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:19:32.6062789Z      let manager = NetworkManager::new(addr);
2025-11-09T23:19:32.6062978Z -    
2025-11-09T23:19:32.6063050Z +
2025-11-09T23:19:32.6063154Z      // Test that expired bans are cleaned up
2025-11-09T23:19:32.6063267Z      use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:19:32.6063362Z      let now = SystemTime::now()
2025-11-09T23:19:32.6063658Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:69:
2025-11-09T23:19:32.6063758Z          .duration_since(UNIX_EPOCH)
2025-11-09T23:19:32.6063837Z          .unwrap()
2025-11-09T23:19:32.6063913Z          .as_secs();
2025-11-09T23:19:32.6063985Z -    
2025-11-09T23:19:32.6064061Z +
2025-11-09T23:19:32.6064217Z      let test_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:19:32.6064291Z -    
2025-11-09T23:19:32.6064649Z +
2025-11-09T23:19:32.6064778Z      // Ban with expiration in the past
2025-11-09T23:19:32.6064897Z      let past_timestamp = now - 3600; // 1 hour ago
2025-11-09T23:19:32.6065025Z      manager.ban_peer(test_addr, past_timestamp);
2025-11-09T23:19:32.6065326Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:78:
2025-11-09T23:19:32.6065399Z -    
2025-11-09T23:19:32.6065470Z +
2025-11-09T23:19:32.6065611Z      // is_banned should automatically clean up expired bans
2025-11-09T23:19:32.6065715Z      let was_banned = manager.is_banned(test_addr);
2025-11-09T23:19:32.6065881Z      assert!(!was_banned, "Expired ban should be automatically removed");
2025-11-09T23:19:32.6066153Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:82:
2025-11-09T23:19:32.6066218Z -    
2025-11-09T23:19:32.6066285Z +
2025-11-09T23:19:32.6066366Z      // Verify ban was removed
2025-11-09T23:19:32.6066471Z      let banned = manager.get_banned_peers();
2025-11-09T23:19:32.6066612Z -    assert!(!banned.iter().any(|(addr, _)| *addr == test_addr), 
2025-11-09T23:19:32.6066716Z -            "Expired ban should not be in ban list");
2025-11-09T23:19:32.6066943Z +    assert!(
2025-11-09T23:19:32.6067067Z +        !banned.iter().any(|(addr, _)| *addr == test_addr),
2025-11-09T23:19:32.6067168Z +        "Expired ban should not be in ban list"
2025-11-09T23:19:32.6067321Z +    );
2025-11-09T23:19:32.6067394Z  }
2025-11-09T23:19:32.6067457Z  
2025-11-09T23:19:32.6067534Z  #[tokio::test]
2025-11-09T23:19:32.6067800Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:90:
2025-11-09T23:19:32.6067959Z  async fn test_ban_list_permanent() {
2025-11-09T23:19:32.6068084Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:19:32.6068187Z      let manager = NetworkManager::new(addr);
2025-11-09T23:19:32.6068250Z -    
2025-11-09T23:19:32.6068318Z +
2025-11-09T23:19:32.6068460Z      let test_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:19:32.6068523Z -    
2025-11-09T23:19:32.6068590Z +
2025-11-09T23:19:32.6068685Z      // Test permanent ban (timestamp = 0)
2025-11-09T23:19:32.6068779Z      manager.ban_peer(test_addr, 0);
2025-11-09T23:19:32.6068962Z -    assert!(manager.is_banned(test_addr), "Permanent ban should be active");
2025-11-09T23:19:32.6069032Z -    
2025-11-09T23:19:32.6069099Z +    assert!(
2025-11-09T23:19:32.6069252Z +        manager.is_banned(test_addr),
2025-11-09T23:19:32.6069413Z +        "Permanent ban should be active"
2025-11-09T23:19:32.6069531Z +    );
2025-11-09T23:19:32.6069644Z +
2025-11-09T23:19:32.6069760Z      // Clean up
2025-11-09T23:19:32.6069915Z      manager.unban_peer(test_addr);
2025-11-09T23:19:32.6070246Z -    assert!(!manager.is_banned(test_addr), "Unbanned peer should not be banned");
2025-11-09T23:19:32.6070367Z +    assert!(
2025-11-09T23:19:32.6070522Z +        !manager.is_banned(test_addr),
2025-11-09T23:19:32.6070727Z +        "Unbanned peer should not be banned"
2025-11-09T23:19:32.6070849Z +    );
2025-11-09T23:19:32.6070959Z  }
2025-11-09T23:19:32.6071067Z  
2025-11-09T23:19:32.6071215Z  #[tokio::test]
2025-11-09T23:19:32.6071877Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:106:
2025-11-09T23:19:32.6072044Z  async fn test_ban_list_temporary() {
2025-11-09T23:19:32.6072248Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:19:32.6072431Z      let manager = NetworkManager::new(addr);
2025-11-09T23:19:32.6072540Z -    
2025-11-09T23:19:32.6072646Z +
2025-11-09T23:19:32.6072811Z      use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:19:32.6072956Z      let now = SystemTime::now()
2025-11-09T23:19:32.6073102Z          .duration_since(UNIX_EPOCH)
2025-11-09T23:19:32.6073404Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:113:
2025-11-09T23:19:32.6073483Z          .unwrap()
2025-11-09T23:19:32.6073553Z          .as_secs();
2025-11-09T23:19:32.6073618Z -    
2025-11-09T23:19:32.6073687Z +
2025-11-09T23:19:32.6073833Z      let test_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:19:32.6073902Z -    
2025-11-09T23:19:32.6073965Z +
2025-11-09T23:19:32.6074066Z      // Test temporary ban (1 hour from now)
2025-11-09T23:19:32.6074154Z      let future_timestamp = now + 3600;
2025-11-09T23:19:32.6074268Z      manager.ban_peer(test_addr, future_timestamp);
2025-11-09T23:19:32.6074660Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:121:
2025-11-09T23:19:32.6074859Z -    assert!(manager.is_banned(test_addr), "Active temporary ban should be active");
2025-11-09T23:19:32.6074923Z -    
2025-11-09T23:19:32.6075000Z +    assert!(
2025-11-09T23:19:32.6075091Z +        manager.is_banned(test_addr),
2025-11-09T23:19:32.6075189Z +        "Active temporary ban should be active"
2025-11-09T23:19:32.6075252Z +    );
2025-11-09T23:19:32.6075322Z +
2025-11-09T23:19:32.6075389Z      // Clean up
2025-11-09T23:19:32.6075477Z      manager.unban_peer(test_addr);
2025-11-09T23:19:32.6075545Z  }
2025-11-09T23:19:32.6075798Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:128:
2025-11-09T23:19:32.6076045Z  async fn test_clear_bans() {
2025-11-09T23:19:32.6076171Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:19:32.6076316Z      let manager = NetworkManager::new(addr);
2025-11-09T23:19:32.6076379Z -    
2025-11-09T23:19:32.6076444Z +
2025-11-09T23:19:32.6076594Z      let test_addr1: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:19:32.6076734Z      let test_addr2: SocketAddr = "127.0.0.1:8334".parse().unwrap();
2025-11-09T23:19:32.6076797Z -    
2025-11-09T23:19:32.6076859Z +
2025-11-09T23:19:32.6076943Z      // Add multiple bans
2025-11-09T23:19:32.6077032Z      manager.ban_peer(test_addr1, 0);
2025-11-09T23:19:32.6077118Z      manager.ban_peer(test_addr2, 0);
2025-11-09T23:19:32.6077379Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:138:
2025-11-09T23:19:32.6077442Z -    
2025-11-09T23:19:32.6077504Z +
2025-11-09T23:19:32.6077624Z      assert_eq!(manager.get_banned_peers().len(), 2);
2025-11-09T23:19:32.6077748Z -    
2025-11-09T23:19:32.6077859Z +
2025-11-09T23:19:32.6077987Z      // Clear all bans
2025-11-09T23:19:32.6078131Z      manager.clear_bans();
2025-11-09T23:19:32.6078240Z -    
2025-11-09T23:19:32.6078350Z +
2025-11-09T23:19:32.6078548Z      assert_eq!(manager.get_banned_peers().len(), 0);
2025-11-09T23:19:32.6078715Z      assert!(!manager.is_banned(test_addr1));
2025-11-09T23:19:32.6078813Z      assert!(!manager.is_banned(test_addr2));
2025-11-09T23:19:32.6079087Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:147:
2025-11-09T23:19:32.6079150Z  }
2025-11-09T23:19:32.6079215Z -
2025-11-09T23:19:32.6079277Z  
2025-11-09T23:19:32.6079555Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:2:
2025-11-09T23:19:32.6079619Z  
2025-11-09T23:19:32.6079690Z  #[cfg(test)]
2025-11-09T23:19:32.6079763Z  mod tests {
2025-11-09T23:19:32.6079899Z +    use bllvm_node::network::protocol::NetworkAddress;
2025-11-09T23:19:32.6080173Z      use bllvm_node::network::protocol::VersionMessage;
2025-11-09T23:19:32.6080491Z -    use bllvm_node::network::protocol::{NODE_UTXO_COMMITMENTS, NODE_BAN_LIST_SHARING, NODE_PACKAGE_RELAY, NODE_FIBRE};
2025-11-09T23:19:32.6080595Z +    use bllvm_node::network::protocol::{
2025-11-09T23:19:32.6080792Z +        NODE_BAN_LIST_SHARING, NODE_FIBRE, NODE_PACKAGE_RELAY, NODE_UTXO_COMMITMENTS,
2025-11-09T23:19:32.6080857Z +    };
2025-11-09T23:19:32.6080981Z      use bllvm_protocol::bip157::NODE_COMPACT_FILTERS;
2025-11-09T23:19:32.6081103Z -    use bllvm_node::network::protocol::NetworkAddress;
2025-11-09T23:19:32.6081166Z  
2025-11-09T23:19:32.6081322Z      fn create_version_message(services: u64) -> VersionMessage {
2025-11-09T23:19:32.6081402Z          VersionMessage {
2025-11-09T23:19:32.6081684Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:36:
2025-11-09T23:19:32.6081787Z              // Peer with UTXO commitments support
2025-11-09T23:19:32.6081890Z              let services = NODE_UTXO_COMMITMENTS;
2025-11-09T23:19:32.6088953Z              let version = create_version_message(services);
2025-11-09T23:19:32.6089368Z -            assert!(version.supports_utxo_commitments(), "Should support UTXO commitments");
2025-11-09T23:19:32.6089458Z +            assert!(
2025-11-09T23:19:32.6089577Z +                version.supports_utxo_commitments(),
2025-11-09T23:19:32.6089681Z +                "Should support UTXO commitments"
2025-11-09T23:19:32.6089750Z +            );
2025-11-09T23:19:32.6089825Z  
2025-11-09T23:19:32.6089934Z              // Peer without UTXO commitments support
2025-11-09T23:19:32.6090017Z              let services = 0;
2025-11-09T23:19:32.6090330Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:43:
2025-11-09T23:19:32.6090451Z              let version = create_version_message(services);
2025-11-09T23:19:32.6090888Z -            assert!(!version.supports_utxo_commitments(), "Should not support UTXO commitments");
2025-11-09T23:19:32.6090962Z +            assert!(
2025-11-09T23:19:32.6091075Z +                !version.supports_utxo_commitments(),
2025-11-09T23:19:32.6091172Z +                "Should not support UTXO commitments"
2025-11-09T23:19:32.6091240Z +            );
2025-11-09T23:19:32.6091311Z  
2025-11-09T23:19:32.6091449Z              // Peer with multiple flags including UTXO commitments
2025-11-09T23:19:32.6091658Z              let services = NODE_UTXO_COMMITMENTS | NODE_COMPACT_FILTERS | NODE_PACKAGE_RELAY;
2025-11-09T23:19:32.6091946Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:48:
2025-11-09T23:19:32.6092061Z              let version = create_version_message(services);
2025-11-09T23:19:32.6092329Z -            assert!(version.supports_utxo_commitments(), "Should support UTXO commitments with other flags");
2025-11-09T23:19:32.6092568Z -            assert!(version.supports_compact_filters(), "Should also support compact filters");
2025-11-09T23:19:32.6092777Z -            assert!(version.supports_package_relay(), "Should also support package relay");
2025-11-09T23:19:32.6092848Z +            assert!(
2025-11-09T23:19:32.6092950Z +                version.supports_utxo_commitments(),
2025-11-09T23:19:32.6093081Z +                "Should support UTXO commitments with other flags"
2025-11-09T23:19:32.6093149Z +            );
2025-11-09T23:19:32.6093217Z +            assert!(
2025-11-09T23:19:32.6093325Z +                version.supports_compact_filters(),
2025-11-09T23:19:32.6093423Z +                "Should also support compact filters"
2025-11-09T23:19:32.6093489Z +            );
2025-11-09T23:19:32.6093560Z +            assert!(
2025-11-09T23:19:32.6093666Z +                version.supports_package_relay(),
2025-11-09T23:19:32.6093764Z +                "Should also support package relay"
2025-11-09T23:19:32.6093831Z +            );
2025-11-09T23:19:32.6093907Z          }
2025-11-09T23:19:32.6093973Z      }
2025-11-09T23:19:32.6094222Z  
2025-11-09T23:19:32.6094844Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:57:
2025-11-09T23:19:32.6094961Z          // Peer with ban list sharing support
2025-11-09T23:19:32.6095058Z          let services = NODE_BAN_LIST_SHARING;
2025-11-09T23:19:32.6095181Z          let version = create_version_message(services);
2025-11-09T23:19:32.6095405Z -        assert!(version.supports_ban_list_sharing(), "Should support ban list sharing");
2025-11-09T23:19:32.6095477Z +        assert!(
2025-11-09T23:19:32.6095581Z +            version.supports_ban_list_sharing(),
2025-11-09T23:19:32.6095681Z +            "Should support ban list sharing"
2025-11-09T23:19:32.6095750Z +        );
2025-11-09T23:19:32.6095815Z  
2025-11-09T23:19:32.6095912Z          // Peer without ban list sharing support
2025-11-09T23:19:32.6095999Z          let services = 0;
2025-11-09T23:19:32.6096304Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:64:
2025-11-09T23:19:32.6096463Z          let version = create_version_message(services);
2025-11-09T23:19:32.6096852Z -        assert!(!version.supports_ban_list_sharing(), "Should not support ban list sharing");
2025-11-09T23:19:32.6097965Z +        assert!(
2025-11-09T23:19:32.6098363Z +            !version.supports_ban_list_sharing(),
2025-11-09T23:19:32.6098843Z +            "Should not support ban list sharing"
2025-11-09T23:19:32.6099109Z +        );
2025-11-09T23:19:32.6099275Z  
2025-11-09T23:19:32.6099505Z          // Peer with multiple flags including ban list sharing
2025-11-09T23:19:32.6099910Z          let services = NODE_BAN_LIST_SHARING | NODE_COMPACT_FILTERS | NODE_FIBRE;
2025-11-09T23:19:32.6101328Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:69:
2025-11-09T23:19:32.6101838Z          let version = create_version_message(services);
2025-11-09T23:19:32.6102513Z -        assert!(version.supports_ban_list_sharing(), "Should support ban list sharing with other flags");
2025-11-09T23:19:32.6103090Z -        assert!(version.supports_compact_filters(), "Should also support compact filters");
2025-11-09T23:19:32.6103465Z +        assert!(
2025-11-09T23:19:32.6103681Z +            version.supports_ban_list_sharing(),
2025-11-09T23:19:32.6103990Z +            "Should support ban list sharing with other flags"
2025-11-09T23:19:32.6104269Z +        );
2025-11-09T23:19:32.6104593Z +        assert!(
2025-11-09T23:19:32.6104806Z +            version.supports_compact_filters(),
2025-11-09T23:19:32.6105097Z +            "Should also support compact filters"
2025-11-09T23:19:32.6105355Z +        );
2025-11-09T23:19:32.6105617Z          assert!(version.supports_fibre(), "Should also support FIBRE");
2025-11-09T23:19:32.6105934Z      }
2025-11-09T23:19:32.6106100Z  
2025-11-09T23:19:32.6106498Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:77:
2025-11-09T23:19:32.6107342Z          // Peer with compact filters support
2025-11-09T23:19:32.6107803Z          let services = NODE_COMPACT_FILTERS;
2025-11-09T23:19:32.6108289Z          let version = create_version_message(services);
2025-11-09T23:19:32.6108975Z -        assert!(version.supports_compact_filters(), "Should support compact filters");
2025-11-09T23:19:32.6109617Z +        assert!(
2025-11-09T23:19:32.6109961Z +            version.supports_compact_filters(),
2025-11-09T23:19:32.6110422Z +            "Should support compact filters"
2025-11-09T23:19:32.6110752Z +        );
2025-11-09T23:19:32.6110917Z  
2025-11-09T23:19:32.6111109Z          // Peer without compact filters support
2025-11-09T23:19:32.6111369Z          let services = 0;
2025-11-09T23:19:32.6111790Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:84:
2025-11-09T23:19:32.6112274Z          let version = create_version_message(services);
2025-11-09T23:19:32.6112853Z -        assert!(!version.supports_compact_filters(), "Should not support compact filters");
2025-11-09T23:19:32.6113249Z +        assert!(
2025-11-09T23:19:32.6113452Z +            !version.supports_compact_filters(),
2025-11-09T23:19:32.6113735Z +            "Should not support compact filters"
2025-11-09T23:19:32.6114023Z +        );
2025-11-09T23:19:32.6114203Z      }
2025-11-09T23:19:32.6114511Z  
2025-11-09T23:19:32.6114673Z      #[test]
2025-11-09T23:19:32.6115210Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:90:
2025-11-09T23:19:32.6115742Z          // Peer with package relay support
2025-11-09T23:19:32.6116049Z          let services = NODE_PACKAGE_RELAY;
2025-11-09T23:19:32.6116328Z          let version = create_version_message(services);
2025-11-09T23:19:32.6116730Z -        assert!(version.supports_package_relay(), "Should support package relay");
2025-11-09T23:19:32.6117098Z +        assert!(
2025-11-09T23:19:32.6117307Z +            version.supports_package_relay(),
2025-11-09T23:19:32.6117580Z +            "Should support package relay"
2025-11-09T23:19:32.6117816Z +        );
2025-11-09T23:19:32.6117968Z  
2025-11-09T23:19:32.6118143Z          // Peer without package relay support
2025-11-09T23:19:32.6118397Z          let services = 0;
2025-11-09T23:19:32.6118820Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:97:
2025-11-09T23:19:32.6119307Z          let version = create_version_message(services);
2025-11-09T23:19:32.6119702Z -        assert!(!version.supports_package_relay(), "Should not support package relay");
2025-11-09T23:19:32.6120447Z +        assert!(
2025-11-09T23:19:32.6120647Z +            !version.supports_package_relay(),
2025-11-09T23:19:32.6120929Z +            "Should not support package relay"
2025-11-09T23:19:32.6121176Z +        );
2025-11-09T23:19:32.6121332Z      }
2025-11-09T23:19:32.6121488Z  
2025-11-09T23:19:32.6121635Z      #[test]
2025-11-09T23:19:32.6122211Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:115:
2025-11-09T23:19:32.6122661Z      fn test_multiple_flags() {
2025-11-09T23:19:32.6122896Z          // Peer with all flags
2025-11-09T23:19:32.6123128Z          #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.6123525Z -        let services = NODE_UTXO_COMMITMENTS | NODE_BAN_LIST_SHARING | NODE_COMPACT_FILTERS | 
2025-11-09T23:19:32.6123936Z -                      NODE_PACKAGE_RELAY | NODE_FIBRE;
2025-11-09T23:19:32.6124202Z +        let services = NODE_UTXO_COMMITMENTS
2025-11-09T23:19:32.6124727Z +            | NODE_BAN_LIST_SHARING
2025-11-09T23:19:32.6124967Z +            | NODE_COMPACT_FILTERS
2025-11-09T23:19:32.6125202Z +            | NODE_PACKAGE_RELAY
2025-11-09T23:19:32.6125430Z +            | NODE_FIBRE;
2025-11-09T23:19:32.6125665Z          #[cfg(not(feature = "utxo-commitments"))]
2025-11-09T23:19:32.6126004Z -        let services = NODE_BAN_LIST_SHARING | NODE_COMPACT_FILTERS | 
2025-11-09T23:19:32.6126354Z -                      NODE_PACKAGE_RELAY | NODE_FIBRE;
2025-11-09T23:19:32.6126620Z +        let services =
2025-11-09T23:19:32.6126939Z +            NODE_BAN_LIST_SHARING | NODE_COMPACT_FILTERS | NODE_PACKAGE_RELAY | NODE_FIBRE;
2025-11-09T23:19:32.6127347Z          let version = create_version_message(services);
2025-11-09T23:19:32.6127606Z -        
2025-11-09T23:19:32.6127767Z +
2025-11-09T23:19:32.6127946Z          #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.6128348Z -        assert!(version.supports_utxo_commitments(), "Should support UTXO commitments");
2025-11-09T23:19:32.6128856Z -        assert!(version.supports_ban_list_sharing(), "Should support ban list sharing");
2025-11-09T23:19:32.6129356Z -        assert!(version.supports_compact_filters(), "Should support compact filters");
2025-11-09T23:19:32.6129849Z -        assert!(version.supports_package_relay(), "Should support package relay");
2025-11-09T23:19:32.6130202Z +        assert!(
2025-11-09T23:19:32.6130416Z +            version.supports_utxo_commitments(),
2025-11-09T23:19:32.6130833Z +            "Should support UTXO commitments"
2025-11-09T23:19:32.6131088Z +        );
2025-11-09T23:19:32.6131250Z +        assert!(
2025-11-09T23:19:32.6131456Z +            version.supports_ban_list_sharing(),
2025-11-09T23:19:32.6131729Z +            "Should support ban list sharing"
2025-11-09T23:19:32.6131967Z +        );
2025-11-09T23:19:32.6132126Z +        assert!(
2025-11-09T23:19:32.6132320Z +            version.supports_compact_filters(),
2025-11-09T23:19:32.6132594Z +            "Should support compact filters"
2025-11-09T23:19:32.6132829Z +        );
2025-11-09T23:19:32.6132986Z +        assert!(
2025-11-09T23:19:32.6133177Z +            version.supports_package_relay(),
2025-11-09T23:19:32.6133440Z +            "Should support package relay"
2025-11-09T23:19:32.6133676Z +        );
2025-11-09T23:19:32.6133915Z          assert!(version.supports_fibre(), "Should support FIBRE");
2025-11-09T23:19:32.6134211Z      }
2025-11-09T23:19:32.6134584Z  
2025-11-09T23:19:32.6135028Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:137:
2025-11-09T23:19:32.6135464Z          {
2025-11-09T23:19:32.6135659Z              let services = NODE_UTXO_COMMITMENTS;
2025-11-09T23:19:32.6135953Z              let version = create_version_message(services);
2025-11-09T23:19:32.6136215Z -            
2025-11-09T23:19:32.6136533Z -            assert!(version.supports_utxo_commitments(), "Should support UTXO commitments");
2025-11-09T23:19:32.6137062Z -            assert!(!version.supports_ban_list_sharing(), "Should not support ban list sharing");
2025-11-09T23:19:32.6137588Z -            assert!(!version.supports_compact_filters(), "Should not support compact filters");
2025-11-09T23:19:32.6137953Z +
2025-11-09T23:19:32.6138107Z +            assert!(
2025-11-09T23:19:32.6138322Z +                version.supports_utxo_commitments(),
2025-11-09T23:19:32.6140498Z +                "Should support UTXO commitments"
2025-11-09T23:19:32.6140895Z +            );
2025-11-09T23:19:32.6141072Z +            assert!(
2025-11-09T23:19:32.6141285Z +                !version.supports_ban_list_sharing(),
2025-11-09T23:19:32.6141564Z +                "Should not support ban list sharing"
2025-11-09T23:19:32.6141807Z +            );
2025-11-09T23:19:32.6141969Z +            assert!(
2025-11-09T23:19:32.6142177Z +                !version.supports_compact_filters(),
2025-11-09T23:19:32.6142451Z +                "Should not support compact filters"
2025-11-09T23:19:32.6142697Z +            );
2025-11-09T23:19:32.6142861Z          }
2025-11-09T23:19:32.6143019Z      }
2025-11-09T23:19:32.6143168Z  
2025-11-09T23:19:32.6143544Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:149:
2025-11-09T23:19:32.6144010Z          // Verify bit positions don't overlap
2025-11-09T23:19:32.6144528Z          #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.6144846Z          {
2025-11-09T23:19:32.6145158Z -            assert_eq!(NODE_UTXO_COMMITMENTS, 1 << 27, "UTXO commitments should be bit 27");
2025-11-09T23:19:32.6145527Z +            assert_eq!(
2025-11-09T23:19:32.6145735Z +                NODE_UTXO_COMMITMENTS,
2025-11-09T23:19:32.6145972Z +                1 << 27,
2025-11-09T23:19:32.6146191Z +                "UTXO commitments should be bit 27"
2025-11-09T23:19:32.6146437Z +            );
2025-11-09T23:19:32.6146597Z          }
2025-11-09T23:19:32.6146881Z -        assert_eq!(NODE_BAN_LIST_SHARING, 1 << 28, "Ban list sharing should be bit 28");
2025-11-09T23:19:32.6147335Z -        assert_eq!(NODE_PACKAGE_RELAY, 1 << 25, "Package relay should be bit 25");
2025-11-09T23:19:32.6147667Z +        assert_eq!(
2025-11-09T23:19:32.6147866Z +            NODE_BAN_LIST_SHARING,
2025-11-09T23:19:32.6148092Z +            1 << 28,
2025-11-09T23:19:32.6148302Z +            "Ban list sharing should be bit 28"
2025-11-09T23:19:32.6150341Z +        );
2025-11-09T23:19:32.6150504Z +        assert_eq!(
2025-11-09T23:19:32.6150699Z +            NODE_PACKAGE_RELAY,
2025-11-09T23:19:32.6151076Z +            1 << 25,
2025-11-09T23:19:32.6151286Z +            "Package relay should be bit 25"
2025-11-09T23:19:32.6151530Z +        );
2025-11-09T23:19:32.6151758Z          assert_eq!(NODE_FIBRE, 1 << 26, "FIBRE should be bit 26");
2025-11-09T23:19:32.6152039Z -        
2025-11-09T23:19:32.6152196Z +
2025-11-09T23:19:32.6152356Z          // Verify no overlap
2025-11-09T23:19:32.6152593Z          #[cfg(feature = "utxo-commitments")]
2025-11-09T23:19:32.6152824Z          {
2025-11-09T23:19:32.6153199Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:161:
2025-11-09T23:19:32.6153789Z -            assert_eq!(NODE_UTXO_COMMITMENTS & NODE_BAN_LIST_SHARING, 0, "Flags should not overlap");
2025-11-09T23:19:32.6154445Z -            assert_eq!(NODE_UTXO_COMMITMENTS & NODE_PACKAGE_RELAY, 0, "Flags should not overlap");
2025-11-09T23:19:32.6154949Z -            assert_eq!(NODE_UTXO_COMMITMENTS & NODE_FIBRE, 0, "Flags should not overlap");
2025-11-09T23:19:32.6155569Z +            assert_eq!(
2025-11-09T23:19:32.6155998Z +                NODE_UTXO_COMMITMENTS & NODE_BAN_LIST_SHARING,
2025-11-09T23:19:32.6156454Z +                0,
2025-11-09T23:19:32.6156778Z +                "Flags should not overlap"
2025-11-09T23:19:32.6157156Z +            );
2025-11-09T23:19:32.6157342Z +            assert_eq!(
2025-11-09T23:19:32.6157578Z +                NODE_UTXO_COMMITMENTS & NODE_PACKAGE_RELAY,
2025-11-09T23:19:32.6157841Z +                0,
2025-11-09T23:19:32.6158039Z +                "Flags should not overlap"
2025-11-09T23:19:32.6158270Z +            );
2025-11-09T23:19:32.6158447Z +            assert_eq!(
2025-11-09T23:19:32.6158661Z +                NODE_UTXO_COMMITMENTS & NODE_FIBRE,
2025-11-09T23:19:32.6158912Z +                0,
2025-11-09T23:19:32.6159102Z +                "Flags should not overlap"
2025-11-09T23:19:32.6159334Z +            );
2025-11-09T23:19:32.6159677Z          }
2025-11-09T23:19:32.6159995Z -        assert_eq!(NODE_BAN_LIST_SHARING & NODE_PACKAGE_RELAY, 0, "Flags should not overlap");
2025-11-09T23:19:32.6162455Z -        assert_eq!(NODE_BAN_LIST_SHARING & NODE_FIBRE, 0, "Flags should not overlap");
2025-11-09T23:19:32.6162911Z -        assert_eq!(NODE_PACKAGE_RELAY & NODE_FIBRE, 0, "Flags should not overlap");
2025-11-09T23:19:32.6163253Z +        assert_eq!(
2025-11-09T23:19:32.6163476Z +            NODE_BAN_LIST_SHARING & NODE_PACKAGE_RELAY,
2025-11-09T23:19:32.6163732Z +            0,
2025-11-09T23:19:32.6163916Z +            "Flags should not overlap"
2025-11-09T23:19:32.6164147Z +        );
2025-11-09T23:19:32.6164431Z +        assert_eq!(
2025-11-09T23:19:32.6164644Z +            NODE_BAN_LIST_SHARING & NODE_FIBRE,
2025-11-09T23:19:32.6164886Z +            0,
2025-11-09T23:19:32.6165073Z +            "Flags should not overlap"
2025-11-09T23:19:32.6165294Z +        );
2025-11-09T23:19:32.6165449Z +        assert_eq!(
2025-11-09T23:19:32.6165660Z +            NODE_PACKAGE_RELAY & NODE_FIBRE,
2025-11-09T23:19:32.6165892Z +            0,
2025-11-09T23:19:32.6166080Z +            "Flags should not overlap"
2025-11-09T23:19:32.6166297Z +        );
2025-11-09T23:19:32.6166459Z      }
2025-11-09T23:19:32.6166610Z  }
2025-11-09T23:19:32.6166760Z -
2025-11-09T23:19:32.6166910Z  
2025-11-09T23:19:32.6167273Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/storage_arcs_tests.rs:1:
2025-11-09T23:19:32.6167723Z  //! Tests for Storage Arc refactoring
2025-11-09T23:19:32.6167954Z  
2025-11-09T23:19:32.6168135Z -use bllvm_node::storage::Storage;
2025-11-09T23:19:32.6168423Z  use bllvm_node::network::chain_access::NodeChainAccess;
2025-11-09T23:19:32.6168742Z  use bllvm_node::node::mempool::MempoolManager;
2025-11-09T23:19:32.6169010Z +use bllvm_node::storage::Storage;
2025-11-09T23:19:32.6169240Z  use std::sync::Arc;
2025-11-09T23:19:32.6169428Z  use tempfile::TempDir;
2025-11-09T23:19:32.6169618Z  
2025-11-09T23:19:32.6169975Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/storage_arcs_tests.rs:10:
2025-11-09T23:19:32.6172147Z  fn test_storage_returns_arcs() {
2025-11-09T23:19:32.6172409Z      let temp_dir = TempDir::new().unwrap();
2025-11-09T23:19:32.6172710Z      let storage = Storage::new(temp_dir.path()).unwrap();
2025-11-09T23:19:32.6172987Z -    
2025-11-09T23:19:32.6173132Z +
2025-11-09T23:19:32.6173297Z      // Verify blocks() returns Arc
2025-11-09T23:19:32.6173540Z      let blocks_arc = storage.blocks();
2025-11-09T23:19:32.6173794Z      let blocks_arc2 = storage.blocks();
2025-11-09T23:19:32.6174229Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/storage_arcs_tests.rs:17:
2025-11-09T23:19:32.6174778Z -    
2025-11-09T23:19:32.6174924Z +
2025-11-09T23:19:32.6175097Z      // Both should be valid Arcs (can clone)
2025-11-09T23:19:32.6175504Z      assert!(Arc::ptr_eq(&blocks_arc, &blocks_arc2) || blocks_arc.block_count().is_ok());
2025-11-09T23:19:32.6176002Z -    
2025-11-09T23:19:32.6176285Z +
2025-11-09T23:19:32.6176577Z      // Verify transactions() returns Arc
2025-11-09T23:19:32.6177027Z      let tx_arc = storage.transactions();
2025-11-09T23:19:32.6177414Z      let tx_arc2 = storage.transactions();
2025-11-09T23:19:32.6177871Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/storage_arcs_tests.rs:24:
2025-11-09T23:19:32.6178388Z -    
2025-11-09T23:19:32.6178541Z +
2025-11-09T23:19:32.6178818Z      assert!(Arc::ptr_eq(&tx_arc, &tx_arc2) || tx_arc.has_transaction(&[0u8; 32]).is_ok());
2025-11-09T23:19:32.6179154Z  }
2025-11-09T23:19:32.6179304Z  
2025-11-09T23:19:32.6179663Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/storage_arcs_tests.rs:30:
2025-11-09T23:19:32.6180236Z      let temp_dir = TempDir::new().unwrap();
2025-11-09T23:19:32.6180757Z      let storage = Storage::new(temp_dir.path()).unwrap();
2025-11-09T23:19:32.6181294Z      let mempool = Arc::new(MempoolManager::new());
2025-11-09T23:19:32.6181630Z -    
2025-11-09T23:19:32.6181950Z +
2025-11-09T23:19:32.6182197Z      // Should be able to create NodeChainAccess with Arcs from Storage
2025-11-09T23:19:32.6182540Z -    let chain_access = NodeChainAccess::new(
2025-11-09T23:19:32.6182807Z -        storage.blocks(),
2025-11-09T23:19:32.6183022Z -        storage.transactions(),
2025-11-09T23:19:32.6183239Z -        mempool,
2025-11-09T23:19:32.6183408Z -    );
2025-11-09T23:19:32.6183562Z -    
2025-11-09T23:19:32.6183891Z +    let chain_access = NodeChainAccess::new(storage.blocks(), storage.transactions(), mempool);
2025-11-09T23:19:32.6184410Z +
2025-11-09T23:19:32.6184643Z      // Verify it works
2025-11-09T23:19:32.6184912Z      let hash = [0u8; 32];
2025-11-09T23:19:32.6185157Z      let has_object = chain_access.has_object(&hash);
2025-11-09T23:19:32.6185622Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/storage_arcs_tests.rs:44:
2025-11-09T23:19:32.6186117Z      assert!(!has_object); // Empty storage, so should be false
2025-11-09T23:19:32.6186399Z  }
2025-11-09T23:19:32.6186547Z -
2025-11-09T23:19:32.6186689Z  
2025-11-09T23:19:32.6187003Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:1:
2025-11-09T23:19:32.6187417Z -use bllvm_protocol::ProtocolVersion;
2025-11-09T23:19:32.6187705Z  use bllvm_node::storage::blockstore::BlockStore;
2025-11-09T23:19:32.6188010Z  use bllvm_node::storage::chainstate::ChainState;
2025-11-09T23:19:32.6188291Z  use bllvm_node::storage::txindex::TxIndex;
2025-11-09T23:19:32.6190622Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:9:
2025-11-09T23:19:32.6191018Z  use bllvm_node::OutPoint;
2025-11-09T23:19:32.6191241Z  use bllvm_node::Transaction;
2025-11-09T23:19:32.6191552Z  use bllvm_node::{ByteString, TransactionInput, TransactionOutput};
2025-11-09T23:19:32.6191893Z +use bllvm_protocol::ProtocolVersion;
2025-11-09T23:19:32.6192143Z  use std::collections::HashMap;
2025-11-09T23:19:32.6192365Z  use tempfile::TempDir;
2025-11-09T23:19:32.6192559Z  
2025-11-09T23:19:32.6193050Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/storage_tests.rs:4:
2025-11-09T23:19:32.6193488Z  use bllvm_node::storage::*;
2025-11-09T23:19:32.6193715Z  use tempfile::TempDir;
2025-11-09T23:19:32.6193905Z  mod common;
2025-11-09T23:19:32.6194076Z -use common::*;
2025-11-09T23:19:32.6194425Z  use bllvm_node::storage::blockstore::BlockStore;
2025-11-09T23:19:32.6194737Z  use bllvm_node::storage::chainstate::ChainState;
2025-11-09T23:19:32.6195023Z  use bllvm_node::storage::txindex::TxIndex;
2025-11-09T23:19:32.6195468Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/storage_tests.rs:11:
2025-11-09T23:19:32.6195916Z  use bllvm_node::storage::utxostore::UtxoStore;
2025-11-09T23:19:32.6196180Z +use common::*;
2025-11-09T23:19:32.6196346Z  
2025-11-09T23:19:32.6196493Z  #[test]
2025-11-09T23:19:32.6196670Z  fn test_storage_creation() {
2025-11-09T23:19:32.6197044Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:1:
2025-11-09T23:19:32.6197464Z -use bllvm_protocol::ProtocolVersion;
2025-11-09T23:19:32.6197749Z  use bllvm_node::storage::blockstore::BlockStore;
2025-11-09T23:19:32.6198051Z  use bllvm_node::storage::chainstate::ChainState;
2025-11-09T23:19:32.6198328Z  use bllvm_node::storage::txindex::TxIndex;
2025-11-09T23:19:32.6200566Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:9:
2025-11-09T23:19:32.6200962Z  use bllvm_node::OutPoint;
2025-11-09T23:19:32.6201373Z  use bllvm_node::Transaction;
2025-11-09T23:19:32.6201684Z  use bllvm_node::{ByteString, TransactionInput, TransactionOutput};
2025-11-09T23:19:32.6202025Z +use bllvm_protocol::ProtocolVersion;
2025-11-09T23:19:32.6202278Z  use std::collections::HashMap;
2025-11-09T23:19:32.6202503Z  use tempfile::TempDir;
2025-11-09T23:19:32.6202693Z  
2025-11-09T23:19:32.6203227Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/stratum_v2_mining_tests.rs:1:
2025-11-09T23:19:32.6203908Z  //! Unit tests for Stratum V2 mining and share validation
2025-11-09T23:19:32.6204177Z  
2025-11-09T23:19:32.6204574Z -use bllvm_protocol::types::{Block, BlockHeader, Hash, Natural};
2025-11-09T23:19:32.6204947Z  use bllvm_node::network::stratum_v2::messages::ShareData;
2025-11-09T23:19:32.6205324Z  use bllvm_node::network::stratum_v2::pool::{JobInfo, StratumV2Pool};
2025-11-09T23:19:32.6205713Z +use bllvm_protocol::types::{Block, BlockHeader, Hash, Natural};
2025-11-09T23:19:32.6206026Z  use tempfile::TempDir;
2025-11-09T23:19:32.6206220Z  mod common;
2025-11-09T23:19:32.6206385Z  use common::*;
2025-11-09T23:19:32.6248370Z ##[error]Process completed with exit code 1.
2025-11-09T23:19:32.6350604Z Post job cleanup.
2025-11-09T23:19:32.7637618Z Post job cleanup.
2025-11-09T23:19:32.8868543Z [command]/usr/bin/git version
2025-11-09T23:19:32.8923642Z git version 2.43.0
2025-11-09T23:19:32.8966328Z Copying '/home/jswift/.gitconfig' to '/home/jswift/actions-runner-org2/_work/_temp/49648e49-63e5-4272-8b59-0c73e19e4f0f/.gitconfig'
2025-11-09T23:19:32.8978953Z Temporarily overriding HOME='/home/jswift/actions-runner-org2/_work/_temp/49648e49-63e5-4272-8b59-0c73e19e4f0f' before making global git config changes
2025-11-09T23:19:32.8981787Z Adding repository directory to the temporary git global config as a safe directory
2025-11-09T23:19:32.8985059Z [command]/usr/bin/git config --global --add safe.directory /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node
2025-11-09T23:19:32.9046321Z [command]/usr/bin/git config --local --name-only --get-regexp core\.sshCommand
2025-11-09T23:19:32.9101480Z [command]/usr/bin/git submodule foreach --recursive sh -c "git config --local --name-only --get-regexp 'core\.sshCommand' && git config --local --unset-all 'core.sshCommand' || :"
2025-11-09T23:19:32.9421705Z [command]/usr/bin/git config --local --name-only --get-regexp http\.https\:\/\/github\.com\/\.extraheader
2025-11-09T23:19:32.9457312Z http.https://github.com/.extraheader
2025-11-09T23:19:32.9474670Z [command]/usr/bin/git config --local --unset-all http.https://github.com/.extraheader
2025-11-09T23:19:32.9526714Z [command]/usr/bin/git submodule foreach --recursive sh -c "git config --local --name-only --get-regexp 'http\.https\:\/\/github\.com\/\.extraheader' && git config --local --unset-all 'http.https://github.com/.extraheader' || :"
2025-11-09T23:19:32.9986460Z A job completed hook has been configured by the self-hosted runner administrator
2025-11-09T23:19:33.0032602Z ##[group]Run '/home/jswift/actions-runner-org2/cleanup-hooks/job-completed.sh'
2025-11-09T23:19:33.0059295Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2025-11-09T23:19:33.0059665Z ##[endgroup]
2025-11-09T23:19:33.0121393Z Job completed: Sun Nov  9 11:19:33 PM UTC 2025
2025-11-09T23:19:33.0162632Z Available disk space: 12G
2025-11-09T23:19:33.0163365Z Cleaning up after job completion...
2025-11-09T23:19:33.0876126Z Cleanup completed. Available disk space: 12G
2025-11-09T23:19:33.0934003Z Cleaning up orphan processes
