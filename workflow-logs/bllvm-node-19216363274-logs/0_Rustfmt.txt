2025-11-10T00:08:40.9567152Z Current runner version: '2.329.0'
2025-11-10T00:08:40.9574103Z Runner name: 'linode-runner-02'
2025-11-10T00:08:40.9575351Z Runner group name: 'default'
2025-11-10T00:08:40.9576363Z Machine name: 'localhost'
2025-11-10T00:08:40.9579406Z ##[group]GITHUB_TOKEN Permissions
2025-11-10T00:08:40.9581849Z Contents: read
2025-11-10T00:08:40.9582501Z Metadata: read
2025-11-10T00:08:40.9583023Z Packages: read
2025-11-10T00:08:40.9583754Z ##[endgroup]
2025-11-10T00:08:40.9586310Z Secret source: Actions
2025-11-10T00:08:40.9587028Z Prepare workflow directory
2025-11-10T00:08:41.0286322Z Prepare all required actions
2025-11-10T00:08:41.0347592Z Getting action download info
2025-11-10T00:08:41.3397430Z Download action repository 'actions/checkout@v4' (SHA:08eba0b27e820071cde6df949e0beb9ba4906955)
2025-11-10T00:08:41.7653772Z Download action repository 'dtolnay/rust-toolchain@master' (SHA:6d653acede28d24f02e3cd41383119e8b1b35921)
2025-11-10T00:08:42.1435892Z Complete job name: Rustfmt
2025-11-10T00:08:42.2057506Z A job started hook has been configured by the self-hosted runner administrator
2025-11-10T00:08:42.2219047Z ##[group]Run '/home/jswift/actions-runner-org2/cleanup-hooks/job-started.sh'
2025-11-10T00:08:42.2250154Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2025-11-10T00:08:42.2251112Z ##[endgroup]
2025-11-10T00:08:42.2435927Z Job started: Mon Nov 10 12:08:42 AM UTC 2025
2025-11-10T00:08:42.2459734Z Available disk space: 8.8G
2025-11-10T00:08:42.2498274Z WARNING: Disk usage is 82% - performing user-level cleanup
2025-11-10T00:08:42.2499130Z Cleaning old work directories (user-level cleanup)...
2025-11-10T00:08:42.3595034Z User-level cleanup completed. Disk usage: 82%
2025-11-10T00:08:42.3905870Z ##[group]Run actions/checkout@v4
2025-11-10T00:08:42.3906507Z with:
2025-11-10T00:08:42.3906950Z   repository: BTCDecoded/bllvm-node
2025-11-10T00:08:42.3907710Z   token: ***
2025-11-10T00:08:42.3908142Z   ssh-strict: true
2025-11-10T00:08:42.3908582Z   ssh-user: git
2025-11-10T00:08:42.3909037Z   persist-credentials: true
2025-11-10T00:08:42.3909565Z   clean: true
2025-11-10T00:08:42.3910007Z   sparse-checkout-cone-mode: true
2025-11-10T00:08:42.3910552Z   fetch-depth: 1
2025-11-10T00:08:42.3910982Z   fetch-tags: false
2025-11-10T00:08:42.3911492Z   show-progress: true
2025-11-10T00:08:42.3911955Z   lfs: false
2025-11-10T00:08:42.3912365Z   submodules: false
2025-11-10T00:08:42.3912834Z   set-safe-directory: true
2025-11-10T00:08:42.3913306Z env:
2025-11-10T00:08:42.3913714Z   CARGO_TERM_COLOR: always
2025-11-10T00:08:42.3914189Z ##[endgroup]
2025-11-10T00:08:42.5260585Z Syncing repository: BTCDecoded/bllvm-node
2025-11-10T00:08:42.5263718Z ##[group]Getting Git version info
2025-11-10T00:08:42.5265730Z Working directory is '/home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node'
2025-11-10T00:08:42.5268060Z [command]/usr/bin/git version
2025-11-10T00:08:42.5276785Z git version 2.43.0
2025-11-10T00:08:42.5308860Z ##[endgroup]
2025-11-10T00:08:42.5322625Z Copying '/home/jswift/.gitconfig' to '/home/jswift/actions-runner-org2/_work/_temp/a1200383-dbb2-46e0-b069-12eaafeb46ac/.gitconfig'
2025-11-10T00:08:42.5337499Z Temporarily overriding HOME='/home/jswift/actions-runner-org2/_work/_temp/a1200383-dbb2-46e0-b069-12eaafeb46ac' before making global git config changes
2025-11-10T00:08:42.5339541Z Adding repository directory to the temporary git global config as a safe directory
2025-11-10T00:08:42.5353664Z [command]/usr/bin/git config --global --add safe.directory /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node
2025-11-10T00:08:42.5403713Z [command]/usr/bin/git config --local --get remote.origin.url
2025-11-10T00:08:42.5429191Z https://github.com/BTCDecoded/bllvm-node
2025-11-10T00:08:42.5451135Z ##[group]Removing previously created refs, to avoid conflicts
2025-11-10T00:08:42.5457615Z [command]/usr/bin/git rev-parse --symbolic-full-name --verify --quiet HEAD
2025-11-10T00:08:42.5486342Z refs/heads/main
2025-11-10T00:08:42.5498954Z [command]/usr/bin/git checkout --detach
2025-11-10T00:08:42.5581232Z HEAD is now at 573270a fix: Add bllvm-consensus checkout to all jobs that need it
2025-11-10T00:08:42.5637961Z [command]/usr/bin/git branch --delete --force main
2025-11-10T00:08:42.5674122Z Deleted branch main (was 573270a).
2025-11-10T00:08:42.5721129Z ##[endgroup]
2025-11-10T00:08:42.5725011Z [command]/usr/bin/git submodule status
2025-11-10T00:08:42.6004119Z ##[group]Cleaning the repository
2025-11-10T00:08:42.6008959Z [command]/usr/bin/git clean -ffdx
2025-11-10T00:08:42.7385255Z Removing Cargo.lock
2025-11-10T00:08:42.7386383Z Removing target/
2025-11-10T00:08:42.7400172Z [command]/usr/bin/git reset --hard HEAD
2025-11-10T00:08:42.7509730Z HEAD is now at 573270a fix: Add bllvm-consensus checkout to all jobs that need it
2025-11-10T00:08:42.7520434Z ##[endgroup]
2025-11-10T00:08:42.7522044Z ##[group]Disabling automatic garbage collection
2025-11-10T00:08:42.7528917Z [command]/usr/bin/git config --local gc.auto 0
2025-11-10T00:08:42.7568163Z ##[endgroup]
2025-11-10T00:08:42.7569603Z ##[group]Setting up auth
2025-11-10T00:08:42.7575694Z [command]/usr/bin/git config --local --name-only --get-regexp core\.sshCommand
2025-11-10T00:08:42.7662880Z [command]/usr/bin/git submodule foreach --recursive sh -c "git config --local --name-only --get-regexp 'core\.sshCommand' && git config --local --unset-all 'core.sshCommand' || :"
2025-11-10T00:08:42.7921984Z [command]/usr/bin/git config --local --name-only --get-regexp http\.https\:\/\/github\.com\/\.extraheader
2025-11-10T00:08:42.7960377Z [command]/usr/bin/git submodule foreach --recursive sh -c "git config --local --name-only --get-regexp 'http\.https\:\/\/github\.com\/\.extraheader' && git config --local --unset-all 'http.https://github.com/.extraheader' || :"
2025-11-10T00:08:42.8265440Z [command]/usr/bin/git config --local http.https://github.com/.extraheader AUTHORIZATION: basic ***
2025-11-10T00:08:42.8320746Z ##[endgroup]
2025-11-10T00:08:42.8332983Z ##[group]Fetching the repository
2025-11-10T00:08:42.8339529Z [command]/usr/bin/git -c protocol.version=2 fetch --no-tags --prune --no-recurse-submodules --depth=1 origin +573270a72e827bb13de8d1ac7d31924eadd9aed8:refs/remotes/origin/main
2025-11-10T00:08:43.0667489Z ##[endgroup]
2025-11-10T00:08:43.0669592Z ##[group]Determining the checkout info
2025-11-10T00:08:43.0671107Z ##[endgroup]
2025-11-10T00:08:43.0677547Z [command]/usr/bin/git sparse-checkout disable
2025-11-10T00:08:43.0746479Z [command]/usr/bin/git config --local --unset-all extensions.worktreeConfig
2025-11-10T00:08:43.0785511Z ##[group]Checking out the ref
2025-11-10T00:08:43.0789465Z [command]/usr/bin/git checkout --progress --force -B main refs/remotes/origin/main
2025-11-10T00:08:43.0874661Z Switched to a new branch 'main'
2025-11-10T00:08:43.0876031Z branch 'main' set up to track 'origin/main'.
2025-11-10T00:08:43.0884190Z ##[endgroup]
2025-11-10T00:08:43.0937980Z [command]/usr/bin/git log -1 --format=%H
2025-11-10T00:08:43.0969673Z 573270a72e827bb13de8d1ac7d31924eadd9aed8
2025-11-10T00:08:43.1266696Z ##[group]Run actions/checkout@v4
2025-11-10T00:08:43.1267633Z with:
2025-11-10T00:08:43.1268340Z   repository: BTCDecoded/bllvm-protocol
2025-11-10T00:08:43.1269348Z   path: _temp-protocol-engine
2025-11-10T00:08:43.1272186Z   token: ***
2025-11-10T00:08:43.1272864Z   ssh-strict: true
2025-11-10T00:08:43.1273832Z   ssh-user: git
2025-11-10T00:08:43.1274986Z   persist-credentials: true
2025-11-10T00:08:43.1275874Z   clean: true
2025-11-10T00:08:43.1276604Z   sparse-checkout-cone-mode: true
2025-11-10T00:08:43.1277550Z   fetch-depth: 1
2025-11-10T00:08:43.1278938Z   fetch-tags: false
2025-11-10T00:08:43.1279655Z   show-progress: true
2025-11-10T00:08:43.1280406Z   lfs: false
2025-11-10T00:08:43.1281033Z   submodules: false
2025-11-10T00:08:43.1281781Z   set-safe-directory: true
2025-11-10T00:08:43.1282532Z env:
2025-11-10T00:08:43.1283180Z   CARGO_TERM_COLOR: always
2025-11-10T00:08:43.1283925Z ##[endgroup]
2025-11-10T00:08:43.2579542Z Syncing repository: BTCDecoded/bllvm-protocol
2025-11-10T00:08:43.2589718Z ##[group]Getting Git version info
2025-11-10T00:08:43.2591966Z Working directory is '/home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/_temp-protocol-engine'
2025-11-10T00:08:43.2639944Z [command]/usr/bin/git version
2025-11-10T00:08:43.2693884Z git version 2.43.0
2025-11-10T00:08:43.2726713Z ##[endgroup]
2025-11-10T00:08:43.2739883Z Copying '/home/jswift/.gitconfig' to '/home/jswift/actions-runner-org2/_work/_temp/d611dd52-dfc4-4434-ac42-02dbd465763c/.gitconfig'
2025-11-10T00:08:43.2755237Z Temporarily overriding HOME='/home/jswift/actions-runner-org2/_work/_temp/d611dd52-dfc4-4434-ac42-02dbd465763c' before making global git config changes
2025-11-10T00:08:43.2759587Z Adding repository directory to the temporary git global config as a safe directory
2025-11-10T00:08:43.2764736Z [command]/usr/bin/git config --global --add safe.directory /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/_temp-protocol-engine
2025-11-10T00:08:43.2818553Z ##[group]Initializing the repository
2025-11-10T00:08:43.2824944Z [command]/usr/bin/git init /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/_temp-protocol-engine
2025-11-10T00:08:43.2875386Z Initialized empty Git repository in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/_temp-protocol-engine/.git/
2025-11-10T00:08:43.2887008Z [command]/usr/bin/git remote add origin https://github.com/BTCDecoded/bllvm-protocol
2025-11-10T00:08:43.2925443Z ##[endgroup]
2025-11-10T00:08:43.2927625Z ##[group]Disabling automatic garbage collection
2025-11-10T00:08:43.2929694Z [command]/usr/bin/git config --local gc.auto 0
2025-11-10T00:08:43.2966915Z ##[endgroup]
2025-11-10T00:08:43.2968876Z ##[group]Setting up auth
2025-11-10T00:08:43.2974629Z [command]/usr/bin/git config --local --name-only --get-regexp core\.sshCommand
2025-11-10T00:08:43.3011081Z [command]/usr/bin/git submodule foreach --recursive sh -c "git config --local --name-only --get-regexp 'core\.sshCommand' && git config --local --unset-all 'core.sshCommand' || :"
2025-11-10T00:08:43.3284041Z [command]/usr/bin/git config --local --name-only --get-regexp http\.https\:\/\/github\.com\/\.extraheader
2025-11-10T00:08:43.3325709Z [command]/usr/bin/git submodule foreach --recursive sh -c "git config --local --name-only --get-regexp 'http\.https\:\/\/github\.com\/\.extraheader' && git config --local --unset-all 'http.https://github.com/.extraheader' || :"
2025-11-10T00:08:43.3618347Z [command]/usr/bin/git config --local http.https://github.com/.extraheader AUTHORIZATION: basic ***
2025-11-10T00:08:43.3667012Z ##[endgroup]
2025-11-10T00:08:43.3669205Z ##[group]Determining the default branch
2025-11-10T00:08:43.3670779Z Retrieving the default branch name
2025-11-10T00:08:43.6549353Z Default branch 'main'
2025-11-10T00:08:43.6554003Z ##[endgroup]
2025-11-10T00:08:43.6556277Z ##[group]Fetching the repository
2025-11-10T00:08:43.6563637Z [command]/usr/bin/git -c protocol.version=2 fetch --no-tags --prune --no-recurse-submodules --depth=1 origin +refs/heads/main:refs/remotes/origin/main
2025-11-10T00:08:45.8666217Z From https://github.com/BTCDecoded/bllvm-protocol
2025-11-10T00:08:45.8667260Z  * [new branch]      main       -> origin/main
2025-11-10T00:08:45.8692463Z ##[endgroup]
2025-11-10T00:08:45.8693270Z ##[group]Determining the checkout info
2025-11-10T00:08:45.8697655Z ##[endgroup]
2025-11-10T00:08:45.8703272Z [command]/usr/bin/git sparse-checkout disable
2025-11-10T00:08:45.8759757Z [command]/usr/bin/git config --local --unset-all extensions.worktreeConfig
2025-11-10T00:08:45.8797825Z ##[group]Checking out the ref
2025-11-10T00:08:45.8805018Z [command]/usr/bin/git checkout --progress --force -B main refs/remotes/origin/main
2025-11-10T00:08:46.5528862Z Reset branch 'main'
2025-11-10T00:08:46.5529513Z branch 'main' set up to track 'origin/main'.
2025-11-10T00:08:46.5591680Z ##[endgroup]
2025-11-10T00:08:46.5648155Z [command]/usr/bin/git log -1 --format=%H
2025-11-10T00:08:46.5679746Z f5f0b046e78292228238657d2073c8b6558f8ab4
2025-11-10T00:08:46.5927008Z ##[group]Run actions/checkout@v4
2025-11-10T00:08:46.5927298Z with:
2025-11-10T00:08:46.5927514Z   repository: BTCDecoded/bllvm-consensus
2025-11-10T00:08:46.5928004Z   path: _temp-consensus-proof
2025-11-10T00:08:46.5928373Z   token: ***
2025-11-10T00:08:46.5928556Z   ssh-strict: true
2025-11-10T00:08:46.5928741Z   ssh-user: git
2025-11-10T00:08:46.5928932Z   persist-credentials: true
2025-11-10T00:08:46.5929151Z   clean: true
2025-11-10T00:08:46.5929348Z   sparse-checkout-cone-mode: true
2025-11-10T00:08:46.5929588Z   fetch-depth: 1
2025-11-10T00:08:46.5929780Z   fetch-tags: false
2025-11-10T00:08:46.5929968Z   show-progress: true
2025-11-10T00:08:46.5930171Z   lfs: false
2025-11-10T00:08:46.5930341Z   submodules: false
2025-11-10T00:08:46.5930568Z   set-safe-directory: true
2025-11-10T00:08:46.5930801Z env:
2025-11-10T00:08:46.5930982Z   CARGO_TERM_COLOR: always
2025-11-10T00:08:46.5931186Z ##[endgroup]
2025-11-10T00:08:46.7120216Z Syncing repository: BTCDecoded/bllvm-consensus
2025-11-10T00:08:46.7128435Z ##[group]Getting Git version info
2025-11-10T00:08:46.7129407Z Working directory is '/home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/_temp-consensus-proof'
2025-11-10T00:08:46.7186105Z [command]/usr/bin/git version
2025-11-10T00:08:46.7235932Z git version 2.43.0
2025-11-10T00:08:46.7266230Z ##[endgroup]
2025-11-10T00:08:46.7279651Z Copying '/home/jswift/.gitconfig' to '/home/jswift/actions-runner-org2/_work/_temp/15e84b4a-cac1-4243-b4d0-f9fe0466f9b4/.gitconfig'
2025-11-10T00:08:46.7292162Z Temporarily overriding HOME='/home/jswift/actions-runner-org2/_work/_temp/15e84b4a-cac1-4243-b4d0-f9fe0466f9b4' before making global git config changes
2025-11-10T00:08:46.7295378Z Adding repository directory to the temporary git global config as a safe directory
2025-11-10T00:08:46.7311942Z [command]/usr/bin/git config --global --add safe.directory /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/_temp-consensus-proof
2025-11-10T00:08:46.7351705Z ##[group]Initializing the repository
2025-11-10T00:08:46.7359166Z [command]/usr/bin/git init /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/_temp-consensus-proof
2025-11-10T00:08:46.7402130Z Initialized empty Git repository in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/_temp-consensus-proof/.git/
2025-11-10T00:08:46.7415410Z [command]/usr/bin/git remote add origin https://github.com/BTCDecoded/bllvm-consensus
2025-11-10T00:08:46.7459766Z ##[endgroup]
2025-11-10T00:08:46.7460357Z ##[group]Disabling automatic garbage collection
2025-11-10T00:08:46.7464293Z [command]/usr/bin/git config --local gc.auto 0
2025-11-10T00:08:46.7505410Z ##[endgroup]
2025-11-10T00:08:46.7506210Z ##[group]Setting up auth
2025-11-10T00:08:46.7512256Z [command]/usr/bin/git config --local --name-only --get-regexp core\.sshCommand
2025-11-10T00:08:46.7553967Z [command]/usr/bin/git submodule foreach --recursive sh -c "git config --local --name-only --get-regexp 'core\.sshCommand' && git config --local --unset-all 'core.sshCommand' || :"
2025-11-10T00:08:46.7842125Z [command]/usr/bin/git config --local --name-only --get-regexp http\.https\:\/\/github\.com\/\.extraheader
2025-11-10T00:08:46.7885335Z [command]/usr/bin/git submodule foreach --recursive sh -c "git config --local --name-only --get-regexp 'http\.https\:\/\/github\.com\/\.extraheader' && git config --local --unset-all 'http.https://github.com/.extraheader' || :"
2025-11-10T00:08:46.8169144Z [command]/usr/bin/git config --local http.https://github.com/.extraheader AUTHORIZATION: basic ***
2025-11-10T00:08:46.8224118Z ##[endgroup]
2025-11-10T00:08:46.8224923Z ##[group]Determining the default branch
2025-11-10T00:08:46.8229156Z Retrieving the default branch name
2025-11-10T00:08:47.0805886Z Default branch 'main'
2025-11-10T00:08:47.0807382Z ##[endgroup]
2025-11-10T00:08:47.0808555Z ##[group]Fetching the repository
2025-11-10T00:08:47.0818725Z [command]/usr/bin/git -c protocol.version=2 fetch --no-tags --prune --no-recurse-submodules --depth=1 origin +refs/heads/main:refs/remotes/origin/main
2025-11-10T00:08:51.9920691Z From https://github.com/BTCDecoded/bllvm-consensus
2025-11-10T00:08:51.9936199Z  * [new branch]      main       -> origin/main
2025-11-10T00:08:51.9943951Z ##[endgroup]
2025-11-10T00:08:51.9944686Z ##[group]Determining the checkout info
2025-11-10T00:08:51.9946352Z ##[endgroup]
2025-11-10T00:08:51.9950973Z [command]/usr/bin/git sparse-checkout disable
2025-11-10T00:08:52.0008476Z [command]/usr/bin/git config --local --unset-all extensions.worktreeConfig
2025-11-10T00:08:52.0045401Z ##[group]Checking out the ref
2025-11-10T00:08:52.0049831Z [command]/usr/bin/git checkout --progress --force -B main refs/remotes/origin/main
2025-11-10T00:08:53.0674591Z Updating files:  67% (793/1180)
2025-11-10T00:08:53.1017597Z Updating files:  68% (803/1180)
2025-11-10T00:08:53.2291874Z Updating files:  69% (815/1180)
2025-11-10T00:08:53.6129162Z Updating files:  70% (826/1180)
2025-11-10T00:08:53.7232387Z Updating files:  71% (838/1180)
2025-11-10T00:08:53.8031703Z Updating files:  72% (850/1180)
2025-11-10T00:08:54.0302080Z Updating files:  73% (862/1180)
2025-11-10T00:08:54.0523805Z Updating files:  73% (871/1180)
2025-11-10T00:08:54.3669275Z Updating files:  74% (874/1180)
2025-11-10T00:08:54.3674887Z Updating files:  75% (885/1180)
2025-11-10T00:08:54.3689606Z Updating files:  76% (897/1180)
2025-11-10T00:08:54.3711050Z Updating files:  77% (909/1180)
2025-11-10T00:08:54.3727090Z Updating files:  78% (921/1180)
2025-11-10T00:08:54.3738630Z Updating files:  79% (933/1180)
2025-11-10T00:08:54.3745891Z Updating files:  80% (944/1180)
2025-11-10T00:08:54.3751191Z Updating files:  81% (956/1180)
2025-11-10T00:08:54.3756782Z Updating files:  82% (968/1180)
2025-11-10T00:08:54.3762093Z Updating files:  83% (980/1180)
2025-11-10T00:08:54.3767098Z Updating files:  84% (992/1180)
2025-11-10T00:08:54.4085860Z Updating files:  85% (1003/1180)
2025-11-10T00:08:54.4370770Z Updating files:  86% (1015/1180)
2025-11-10T00:08:54.4595857Z Updating files:  87% (1027/1180)
2025-11-10T00:08:54.5008745Z Updating files:  88% (1039/1180)
2025-11-10T00:08:54.5194187Z Updating files:  89% (1051/1180)
2025-11-10T00:08:54.5201423Z Updating files:  90% (1062/1180)
2025-11-10T00:08:54.5210447Z Updating files:  91% (1074/1180)
2025-11-10T00:08:54.5218647Z Updating files:  92% (1086/1180)
2025-11-10T00:08:54.5246912Z Updating files:  93% (1098/1180)
2025-11-10T00:08:54.5248059Z Updating files:  94% (1110/1180)
2025-11-10T00:08:54.5268622Z Updating files:  95% (1121/1180)
2025-11-10T00:08:54.5269004Z Updating files:  96% (1133/1180)
2025-11-10T00:08:54.5276964Z Updating files:  97% (1145/1180)
2025-11-10T00:08:54.5284262Z Updating files:  98% (1157/1180)
2025-11-10T00:08:54.5294963Z Updating files:  99% (1169/1180)
2025-11-10T00:08:54.5295451Z Updating files: 100% (1180/1180)
2025-11-10T00:08:54.5295977Z Updating files: 100% (1180/1180), done.
2025-11-10T00:08:54.5320851Z Reset branch 'main'
2025-11-10T00:08:54.5321317Z branch 'main' set up to track 'origin/main'.
2025-11-10T00:08:54.5482034Z ##[endgroup]
2025-11-10T00:08:54.5536859Z [command]/usr/bin/git log -1 --format=%H
2025-11-10T00:08:54.5568065Z f1ff38664dd5deaaa46fc9d342df1d4aa6559aca
2025-11-10T00:08:54.5726060Z ##[group]Run if [ -d "../bllvm-protocol" ]; then rm -rf ../bllvm-protocol; fi
2025-11-10T00:08:54.5726638Z [36;1mif [ -d "../bllvm-protocol" ]; then rm -rf ../bllvm-protocol; fi[0m
2025-11-10T00:08:54.5727127Z [36;1mif [ -d "../bllvm-consensus" ]; then rm -rf ../bllvm-consensus; fi[0m
2025-11-10T00:08:54.5727535Z [36;1mmv _temp-protocol-engine ../bllvm-protocol[0m
2025-11-10T00:08:54.5727896Z [36;1mmv _temp-consensus-proof ../bllvm-consensus[0m
2025-11-10T00:08:54.5762107Z shell: /usr/bin/bash -e {0}
2025-11-10T00:08:54.5762492Z env:
2025-11-10T00:08:54.5762792Z   CARGO_TERM_COLOR: always
2025-11-10T00:08:54.5765108Z ##[endgroup]
2025-11-10T00:08:54.9193542Z ##[group]Run dtolnay/rust-toolchain@master
2025-11-10T00:08:54.9193837Z with:
2025-11-10T00:08:54.9194009Z   toolchain: 1.88.0
2025-11-10T00:08:54.9194199Z   components: rustfmt
2025-11-10T00:08:54.9194750Z env:
2025-11-10T00:08:54.9194930Z   CARGO_TERM_COLOR: always
2025-11-10T00:08:54.9195130Z ##[endgroup]
2025-11-10T00:08:54.9313538Z ##[group]Run : parse toolchain version
2025-11-10T00:08:54.9313865Z [36;1m: parse toolchain version[0m
2025-11-10T00:08:54.9314127Z [36;1mif [[ -z $toolchain ]]; then[0m
2025-11-10T00:08:54.9314801Z [36;1m  # GitHub does not enforce `required: true` inputs itself. https://github.com/actions/runner/issues/1070[0m
2025-11-10T00:08:54.9315336Z [36;1m  echo "'toolchain' is a required input" >&2[0m
2025-11-10T00:08:54.9315626Z [36;1m  exit 1[0m
2025-11-10T00:08:54.9315936Z [36;1melif [[ $toolchain =~ ^stable' '[0-9]+' '(year|month|week|day)s?' 'ago$ ]]; then[0m
2025-11-10T00:08:54.9316395Z [36;1m  if [[ Linux == macOS ]]; then[0m
2025-11-10T00:08:54.9316917Z [36;1m    echo "toolchain=1.$((($(date -v-$(sed 's/stable \([0-9]*\) \(.\).*/\1\2/' <<< $toolchain) +%s)/60/60/24-16569)/7/6))" >> $GITHUB_OUTPUT[0m
2025-11-10T00:08:54.9317478Z [36;1m  else[0m
2025-11-10T00:08:54.9317956Z [36;1m    echo "toolchain=1.$((($(date --date "${toolchain#stable }" +%s)/60/60/24-16569)/7/6))" >> $GITHUB_OUTPUT[0m
2025-11-10T00:08:54.9318453Z [36;1m  fi[0m
2025-11-10T00:08:54.9318782Z [36;1melif [[ $toolchain =~ ^stable' 'minus' '[0-9]+' 'releases?$ ]]; then[0m
2025-11-10T00:08:54.9319346Z [36;1m  echo "toolchain=1.$((($(date +%s)/60/60/24-16569)/7/6-${toolchain//[^0-9]/}))" >> $GITHUB_OUTPUT[0m
2025-11-10T00:08:54.9319837Z [36;1melif [[ $toolchain =~ ^1\.[0-9]+$ ]]; then[0m
2025-11-10T00:08:54.9320320Z [36;1m  echo "toolchain=1.$((i=${toolchain#1.}, c=($(date +%s)/60/60/24-16569)/7/6, i+9*i*(10*i<=c)+90*i*(100*i<=c)))" >> $GITHUB_OUTPUT[0m
2025-11-10T00:08:54.9320784Z [36;1melse[0m
2025-11-10T00:08:54.9321011Z [36;1m  echo "toolchain=$toolchain" >> $GITHUB_OUTPUT[0m
2025-11-10T00:08:54.9321275Z [36;1mfi[0m
2025-11-10T00:08:54.9348496Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2025-11-10T00:08:54.9348820Z env:
2025-11-10T00:08:54.9349000Z   CARGO_TERM_COLOR: always
2025-11-10T00:08:54.9349214Z   toolchain: 1.88.0
2025-11-10T00:08:54.9349399Z ##[endgroup]
2025-11-10T00:08:54.9480974Z ##[group]Run : construct rustup command line
2025-11-10T00:08:54.9481304Z [36;1m: construct rustup command line[0m
2025-11-10T00:08:54.9481805Z [36;1mecho "targets=$(for t in ${targets//,/ }; do echo -n ' --target' $t; done)" >> $GITHUB_OUTPUT[0m
2025-11-10T00:08:54.9482427Z [36;1mecho "components=$(for c in ${components//,/ }; do echo -n ' --component' $c; done)" >> $GITHUB_OUTPUT[0m
2025-11-10T00:08:54.9482875Z [36;1mecho "downgrade=" >> $GITHUB_OUTPUT[0m
2025-11-10T00:08:54.9509365Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2025-11-10T00:08:54.9509685Z env:
2025-11-10T00:08:54.9509866Z   CARGO_TERM_COLOR: always
2025-11-10T00:08:54.9510088Z   targets: 
2025-11-10T00:08:54.9510273Z   components: rustfmt
2025-11-10T00:08:54.9510478Z ##[endgroup]
2025-11-10T00:08:54.9597419Z ##[group]Run : set $CARGO_HOME
2025-11-10T00:08:54.9597665Z [36;1m: set $CARGO_HOME[0m
2025-11-10T00:08:54.9597967Z [36;1mecho CARGO_HOME=${CARGO_HOME:-"$HOME/.cargo"} >> $GITHUB_ENV[0m
2025-11-10T00:08:54.9625058Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2025-11-10T00:08:54.9625387Z env:
2025-11-10T00:08:54.9625589Z   CARGO_TERM_COLOR: always
2025-11-10T00:08:54.9625816Z ##[endgroup]
2025-11-10T00:08:54.9769013Z ##[group]Run : install rustup if needed
2025-11-10T00:08:54.9769320Z [36;1m: install rustup if needed[0m
2025-11-10T00:08:54.9769590Z [36;1mif ! command -v rustup &>/dev/null; then[0m
2025-11-10T00:08:54.9770320Z [36;1m  curl --proto '=https' --tlsv1.2 --retry 10 --retry-connrefused --location --silent --show-error --fail https://sh.rustup.rs | sh -s -- --default-toolchain none -y[0m
2025-11-10T00:08:54.9771248Z [36;1m  echo "$CARGO_HOME/bin" >> $GITHUB_PATH[0m
2025-11-10T00:08:54.9771529Z [36;1mfi[0m
2025-11-10T00:08:54.9797009Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2025-11-10T00:08:54.9797329Z env:
2025-11-10T00:08:54.9797500Z   CARGO_TERM_COLOR: always
2025-11-10T00:08:54.9797731Z   CARGO_HOME: /home/jswift/.cargo
2025-11-10T00:08:54.9797956Z ##[endgroup]
2025-11-10T00:08:55.0375800Z info: downloading installer
2025-11-10T00:08:55.4917948Z warn: It looks like you have an existing rustup settings file at:
2025-11-10T00:08:55.4918792Z warn: /home/jswift/.rustup/settings.toml
2025-11-10T00:08:55.4919682Z warn: Rustup will install the default toolchain as specified in the settings file,
2025-11-10T00:08:55.4920719Z warn: instead of the one inferred from the default host triple.
2025-11-10T00:08:55.5235734Z info: profile set to 'default'
2025-11-10T00:08:55.5236311Z info: default host triple is x86_64-unknown-linux-gnu
2025-11-10T00:08:55.5236892Z info: skipping toolchain installation
2025-11-10T00:08:55.5237156Z 
2025-11-10T00:08:55.5237175Z 
2025-11-10T00:08:55.5237310Z Rust is installed now. Great!
2025-11-10T00:08:55.5237540Z 
2025-11-10T00:08:55.5237804Z To get started you may need to restart your current shell.
2025-11-10T00:08:55.5238722Z This would reload your PATH environment variable to include
2025-11-10T00:08:55.5239419Z Cargo's bin directory ($HOME/.cargo/bin).
2025-11-10T00:08:55.5239848Z 
2025-11-10T00:08:55.5240113Z To configure your current shell, you need to source
2025-11-10T00:08:55.5240838Z the corresponding env file under $HOME/.cargo.
2025-11-10T00:08:55.5241298Z 
2025-11-10T00:08:55.5241756Z This is usually done by running one of the following (note the leading DOT):
2025-11-10T00:08:55.5242697Z . "$HOME/.cargo/env"            # For sh/bash/zsh/ash/dash/pdksh
2025-11-10T00:08:55.5243463Z source "$HOME/.cargo/env.fish"  # For fish
2025-11-10T00:08:55.5244145Z source $"($nu.home-path)/.cargo/env.nu"  # For nushell
2025-11-10T00:08:55.5381956Z ##[group]Run rustup toolchain install 1.88.0 --component rustfmt --profile minimal --no-self-update
2025-11-10T00:08:55.5382653Z [36;1mrustup toolchain install 1.88.0 --component rustfmt --profile minimal --no-self-update[0m
2025-11-10T00:08:55.5419424Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2025-11-10T00:08:55.5419776Z env:
2025-11-10T00:08:55.5419971Z   CARGO_TERM_COLOR: always
2025-11-10T00:08:55.5420233Z   CARGO_HOME: /home/jswift/.cargo
2025-11-10T00:08:55.5420487Z ##[endgroup]
2025-11-10T00:08:55.6340716Z info: syncing channel updates for '1.88.0-x86_64-unknown-linux-gnu'
2025-11-10T00:08:55.6989382Z info: latest update on 2025-06-26, rust version 1.88.0 (6b00bc388 2025-06-23)
2025-11-10T00:08:55.7322461Z info: component 'rustfmt' for target 'x86_64-unknown-linux-gnu' is up to date
2025-11-10T00:08:55.7348525Z 
2025-11-10T00:08:55.7478939Z   1.88.0-x86_64-unknown-linux-gnu unchanged - rustc 1.88.0 (6b00bc388 2025-06-23)
2025-11-10T00:08:55.7479576Z 
2025-11-10T00:08:55.7537947Z ##[group]Run rustup default 1.88.0
2025-11-10T00:08:55.7538254Z [36;1mrustup default 1.88.0[0m
2025-11-10T00:08:55.7573082Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2025-11-10T00:08:55.7573495Z env:
2025-11-10T00:08:55.7573690Z   CARGO_TERM_COLOR: always
2025-11-10T00:08:55.7573938Z   CARGO_HOME: /home/jswift/.cargo
2025-11-10T00:08:55.7574195Z ##[endgroup]
2025-11-10T00:08:55.7705930Z info: using existing install for '1.88.0-x86_64-unknown-linux-gnu'
2025-11-10T00:08:55.8101351Z info: default toolchain set to '1.88.0-x86_64-unknown-linux-gnu'
2025-11-10T00:08:55.8101805Z 
2025-11-10T00:08:55.8219696Z   1.88.0-x86_64-unknown-linux-gnu unchanged - rustc 1.88.0 (6b00bc388 2025-06-23)
2025-11-10T00:08:55.8221056Z info: note that the toolchain '1.88.0-x86_64-unknown-linux-gnu' is currently in use (overridden by '/home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/rust-toolchain.toml')
2025-11-10T00:08:55.8223062Z 
2025-11-10T00:08:55.8286721Z ##[group]Run : create cachekey
2025-11-10T00:08:55.8287078Z [36;1m: create cachekey[0m
2025-11-10T00:08:55.8287813Z [36;1mDATE=$(rustc +1.88.0 --version --verbose | sed -ne 's/^commit-date: \(20[0-9][0-9]\)-\([01][0-9]\)-\([0-3][0-9]\)$/\1\2\3/p')[0m
2025-11-10T00:08:55.8288501Z [36;1mHASH=$(rustc +1.88.0 --version --verbose | sed -ne 's/^commit-hash: //p')[0m
2025-11-10T00:08:55.8289043Z [36;1mecho "cachekey=$(echo $DATE$HASH | head -c12)" >> $GITHUB_OUTPUT[0m
2025-11-10T00:08:55.8320925Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2025-11-10T00:08:55.8321278Z env:
2025-11-10T00:08:55.8321473Z   CARGO_TERM_COLOR: always
2025-11-10T00:08:55.8321717Z   CARGO_HOME: /home/jswift/.cargo
2025-11-10T00:08:55.8321971Z ##[endgroup]
2025-11-10T00:08:55.8844646Z ##[group]Run : disable incremental compilation
2025-11-10T00:08:55.8845060Z [36;1m: disable incremental compilation[0m
2025-11-10T00:08:55.8845415Z [36;1mif [ -z "${CARGO_INCREMENTAL+set}" ]; then[0m
2025-11-10T00:08:55.8845778Z [36;1m  echo CARGO_INCREMENTAL=0 >> $GITHUB_ENV[0m
2025-11-10T00:08:55.8846083Z [36;1mfi[0m
2025-11-10T00:08:55.8875222Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2025-11-10T00:08:55.8875602Z env:
2025-11-10T00:08:55.8875809Z   CARGO_TERM_COLOR: always
2025-11-10T00:08:55.8876065Z   CARGO_HOME: /home/jswift/.cargo
2025-11-10T00:08:55.8876335Z ##[endgroup]
2025-11-10T00:08:55.8977887Z ##[group]Run : enable colors in Cargo output
2025-11-10T00:08:55.8978237Z [36;1m: enable colors in Cargo output[0m
2025-11-10T00:08:55.8978554Z [36;1mif [ -z "${CARGO_TERM_COLOR+set}" ]; then[0m
2025-11-10T00:08:55.8978906Z [36;1m  echo CARGO_TERM_COLOR=always >> $GITHUB_ENV[0m
2025-11-10T00:08:55.8979207Z [36;1mfi[0m
2025-11-10T00:08:55.9009111Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2025-11-10T00:08:55.9009453Z env:
2025-11-10T00:08:55.9009645Z   CARGO_TERM_COLOR: always
2025-11-10T00:08:55.9009888Z   CARGO_HOME: /home/jswift/.cargo
2025-11-10T00:08:55.9010145Z   CARGO_INCREMENTAL: 0
2025-11-10T00:08:55.9010354Z ##[endgroup]
2025-11-10T00:08:55.9082275Z ##[group]Run : enable Cargo sparse registry
2025-11-10T00:08:55.9082630Z [36;1m: enable Cargo sparse registry[0m
2025-11-10T00:08:55.9084990Z [36;1m# implemented in 1.66, stabilized in 1.68, made default in 1.70[0m
2025-11-10T00:08:55.9085836Z [36;1mif [ -z "${CARGO_REGISTRIES_CRATES_IO_PROTOCOL+set}" -o -f "/home/jswift/actions-runner-org2/_work/_temp"/.implicit_cargo_registries_crates_io_protocol ]; then[0m
2025-11-10T00:08:55.9086689Z [36;1m  if rustc +1.88.0 --version --verbose | grep -q '^release: 1\.6[89]\.'; then[0m
2025-11-10T00:08:55.9087354Z [36;1m    touch "/home/jswift/actions-runner-org2/_work/_temp"/.implicit_cargo_registries_crates_io_protocol || true[0m
2025-11-10T00:08:55.9088013Z [36;1m    echo CARGO_REGISTRIES_CRATES_IO_PROTOCOL=sparse >> $GITHUB_ENV[0m
2025-11-10T00:08:55.9088520Z [36;1m  elif rustc +1.88.0 --version --verbose | grep -q '^release: 1\.6[67]\.'; then[0m
2025-11-10T00:08:55.9089184Z [36;1m    touch "/home/jswift/actions-runner-org2/_work/_temp"/.implicit_cargo_registries_crates_io_protocol || true[0m
2025-11-10T00:08:55.9089816Z [36;1m    echo CARGO_REGISTRIES_CRATES_IO_PROTOCOL=git >> $GITHUB_ENV[0m
2025-11-10T00:08:55.9090167Z [36;1m  fi[0m
2025-11-10T00:08:55.9090347Z [36;1mfi[0m
2025-11-10T00:08:55.9117831Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2025-11-10T00:08:55.9118144Z env:
2025-11-10T00:08:55.9118323Z   CARGO_TERM_COLOR: always
2025-11-10T00:08:55.9118559Z   CARGO_HOME: /home/jswift/.cargo
2025-11-10T00:08:55.9118785Z   CARGO_INCREMENTAL: 0
2025-11-10T00:08:55.9118978Z ##[endgroup]
2025-11-10T00:08:55.9605338Z ##[group]Run : work around spurious network errors in curl 8.0
2025-11-10T00:08:55.9605796Z [36;1m: work around spurious network errors in curl 8.0[0m
2025-11-10T00:08:55.9606385Z [36;1m# https://rust-lang.zulipchat.com/#narrow/stream/246057-t-cargo/topic/timeout.20investigation[0m
2025-11-10T00:08:55.9607422Z [36;1mif rustc +1.88.0 --version --verbose | grep -q '^release: 1\.7[01]\.'; then[0m
2025-11-10T00:08:55.9608214Z [36;1m  echo CARGO_HTTP_MULTIPLEXING=false >> $GITHUB_ENV[0m
2025-11-10T00:08:55.9608546Z [36;1mfi[0m
2025-11-10T00:08:55.9639720Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2025-11-10T00:08:55.9640077Z env:
2025-11-10T00:08:55.9640273Z   CARGO_TERM_COLOR: always
2025-11-10T00:08:55.9640516Z   CARGO_HOME: /home/jswift/.cargo
2025-11-10T00:08:55.9640773Z   CARGO_INCREMENTAL: 0
2025-11-10T00:08:55.9641175Z ##[endgroup]
2025-11-10T00:08:55.9939630Z ##[group]Run rustc +1.88.0 --version --verbose
2025-11-10T00:08:55.9940039Z [36;1mrustc +1.88.0 --version --verbose[0m
2025-11-10T00:08:55.9968796Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2025-11-10T00:08:55.9969137Z env:
2025-11-10T00:08:55.9969328Z   CARGO_TERM_COLOR: always
2025-11-10T00:08:55.9969575Z   CARGO_HOME: /home/jswift/.cargo
2025-11-10T00:08:55.9969837Z   CARGO_INCREMENTAL: 0
2025-11-10T00:08:55.9970046Z ##[endgroup]
2025-11-10T00:08:56.0282136Z rustc 1.88.0 (6b00bc388 2025-06-23)
2025-11-10T00:08:56.0282517Z binary: rustc
2025-11-10T00:08:56.0282875Z commit-hash: 6b00bc3880198600130e1cf62b8f8a93494488cc
2025-11-10T00:08:56.0283291Z commit-date: 2025-06-23
2025-11-10T00:08:56.0283658Z host: x86_64-unknown-linux-gnu
2025-11-10T00:08:56.0284143Z release: 1.88.0
2025-11-10T00:08:56.0287215Z LLVM version: 20.1.5
2025-11-10T00:08:56.0379492Z ##[group]Run cargo fmt -- --check
2025-11-10T00:08:56.0379806Z [36;1mcargo fmt -- --check[0m
2025-11-10T00:08:56.0413026Z shell: /usr/bin/bash -e {0}
2025-11-10T00:08:56.0413268Z env:
2025-11-10T00:08:56.0413451Z   CARGO_TERM_COLOR: always
2025-11-10T00:08:56.0413690Z   CARGO_HOME: /home/jswift/.cargo
2025-11-10T00:08:56.0413930Z   CARGO_INCREMENTAL: 0
2025-11-10T00:08:56.0414142Z ##[endgroup]
2025-11-10T00:08:56.3176966Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:332:
2025-11-10T00:08:56.3179815Z  pub enum PruningMode {
2025-11-10T00:08:56.3180234Z      /// No pruning (keep all blocks)
2025-11-10T00:08:56.3180661Z      Disabled,
2025-11-10T00:08:56.3180953Z -    
2025-11-10T00:08:56.3181239Z +
2025-11-10T00:08:56.3181635Z      /// Normal pruning (keep recent blocks for verification)
2025-11-10T00:08:56.3182169Z      Normal {
2025-11-10T00:08:56.3182515Z          /// Keep blocks from this height onwards
2025-11-10T00:08:56.3185469Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:342:
2025-11-10T00:08:56.3186312Z          #[serde(default = "default_min_recent_blocks")]
2025-11-10T00:08:56.3186820Z          min_recent_blocks: u64,
2025-11-10T00:08:56.3187201Z      },
2025-11-10T00:08:56.3187478Z -    
2025-11-10T00:08:56.3187740Z +
2025-11-10T00:08:56.3188067Z      /// Aggressive pruning with UTXO commitments
2025-11-10T00:08:56.3188582Z      /// Requires: utxo-commitments feature enabled
2025-11-10T00:08:56.3189072Z      Aggressive {
2025-11-10T00:08:56.3189696Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:359:
2025-11-10T00:08:56.3190471Z          #[serde(default = "default_min_blocks")]
2025-11-10T00:08:56.3190924Z          min_blocks: u64,
2025-11-10T00:08:56.3191255Z      },
2025-11-10T00:08:56.3191528Z -    
2025-11-10T00:08:56.3191791Z +
2025-11-10T00:08:56.3192090Z      /// Custom pruning configuration
2025-11-10T00:08:56.3192511Z      Custom {
2025-11-10T00:08:56.3192967Z          /// Keep block headers (always required for PoW verification)
2025-11-10T00:08:56.3193862Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:408:
2025-11-10T00:08:56.3194800Z      /// Pruning mode
2025-11-10T00:08:56.3195205Z      #[serde(default = "default_pruning_mode")]
2025-11-10T00:08:56.3197640Z      pub mode: PruningMode,
2025-11-10T00:08:56.3198006Z -    
2025-11-10T00:08:56.3198267Z +
2025-11-10T00:08:56.3198660Z      /// Automatic pruning (prune periodically as chain grows)
2025-11-10T00:08:56.3199232Z      #[serde(default = "default_false")]
2025-11-10T00:08:56.3199682Z      pub auto_prune: bool,
2025-11-10T00:08:56.3200371Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:415:
2025-11-10T00:08:56.3201166Z -    
2025-11-10T00:08:56.3201430Z +
2025-11-10T00:08:56.3201746Z      /// Automatic pruning interval (blocks)
2025-11-10T00:08:56.3202260Z      /// Prune every N blocks if auto_prune is enabled
2025-11-10T00:08:56.3202815Z      #[serde(default = "default_auto_prune_interval")]
2025-11-10T00:08:56.3204081Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:419:
2025-11-10T00:08:56.3205037Z      pub auto_prune_interval: u64,
2025-11-10T00:08:56.3207303Z -    
2025-11-10T00:08:56.3207560Z +
2025-11-10T00:08:56.3207866Z      /// Minimum blocks to keep (safety margin)
2025-11-10T00:08:56.3208468Z      /// Even with aggressive pruning, keep at least this many blocks
2025-11-10T00:08:56.3209119Z      #[serde(default = "default_min_blocks_to_keep")]
2025-11-10T00:08:56.3209942Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:424:
2025-11-10T00:08:56.3210713Z      pub min_blocks_to_keep: u64,
2025-11-10T00:08:56.3211109Z -    
2025-11-10T00:08:56.3211368Z +
2025-11-10T00:08:56.3211746Z      /// Prune on startup (prune old blocks when node starts)
2025-11-10T00:08:56.3212253Z      #[serde(default = "default_false")]
2025-11-10T00:08:56.3213045Z      pub prune_on_startup: bool,
2025-11-10T00:08:56.3215828Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:429:
2025-11-10T00:08:56.3216576Z -    
2025-11-10T00:08:56.3216826Z +
2025-11-10T00:08:56.3217363Z      /// Allow incremental pruning during IBD (requires UTXO commitments + aggressive mode)
2025-11-10T00:08:56.3218336Z      /// When enabled, old blocks are pruned incrementally during sync, keeping only a window
2025-11-10T00:08:56.3219277Z      /// of recent blocks. This prevents the need to download the full blockchain before pruning.
2025-11-10T00:08:56.3220259Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:433:
2025-11-10T00:08:56.3221053Z      #[serde(default = "default_false")]
2025-11-10T00:08:56.3221526Z      pub incremental_prune_during_ibd: bool,
2025-11-10T00:08:56.3221958Z -    
2025-11-10T00:08:56.3222208Z +
2025-11-10T00:08:56.3222677Z      /// Block window size for incremental pruning (number of recent blocks to keep)
2025-11-10T00:08:56.3223373Z      /// Only used when incremental_prune_during_ibd is true
2025-11-10T00:08:56.3240188Z      #[serde(default = "default_prune_window_size")]
2025-11-10T00:08:56.3241086Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:439:
2025-11-10T00:08:56.3241869Z      pub prune_window_size: u64,
2025-11-10T00:08:56.3242264Z -    
2025-11-10T00:08:56.3242527Z +
2025-11-10T00:08:56.3242971Z      /// Minimum blocks before starting incremental pruning during IBD
2025-11-10T00:08:56.3243639Z      /// Prevents pruning too early in the sync process
2025-11-10T00:08:56.3244260Z      #[serde(default = "default_min_blocks_for_incremental_prune")]
2025-11-10T00:08:56.3245325Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:444:
2025-11-10T00:08:56.3246122Z      pub min_blocks_for_incremental_prune: u64,
2025-11-10T00:08:56.3246572Z -    
2025-11-10T00:08:56.3246833Z +
2025-11-10T00:08:56.3247135Z      /// UTXO commitments integration
2025-11-10T00:08:56.3247580Z      #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.3248181Z      pub utxo_commitments: Option<UtxoCommitmentsPruningConfig>,
2025-11-10T00:08:56.3249075Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:449:
2025-11-10T00:08:56.3249802Z -    
2025-11-10T00:08:56.3250068Z +
2025-11-10T00:08:56.3250361Z      /// BIP158 filter integration
2025-11-10T00:08:56.3250780Z      #[cfg(feature = "bip158")]
2025-11-10T00:08:56.3251248Z      pub bip158_filters: Option<Bip158PruningConfig>,
2025-11-10T00:08:56.3252049Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:486:
2025-11-10T00:08:56.3252807Z                  keep_filtered_blocks: false,
2025-11-10T00:08:56.3253296Z                  min_blocks: 144, // ~1 day at 10 min/block
2025-11-10T00:08:56.3253729Z              },
2025-11-10T00:08:56.3254103Z -            auto_prune: true, // Enable automatic pruning
2025-11-10T00:08:56.3254887Z +            auto_prune: true,         // Enable automatic pruning
2025-11-10T00:08:56.3255878Z              auto_prune_interval: 144, // Prune every ~1 day
2025-11-10T00:08:56.3256387Z              min_blocks_to_keep: 144,
2025-11-10T00:08:56.3256892Z -            prune_on_startup: false, // Still false for safety
2025-11-10T00:08:56.3257631Z -            incremental_prune_during_ibd: true, // Enable incremental pruning during IBD
2025-11-10T00:08:56.3258462Z -            prune_window_size: 144, // Keep sliding window of 144 blocks during IBD
2025-11-10T00:08:56.3259255Z +            prune_on_startup: false,               // Still false for safety
2025-11-10T00:08:56.3260046Z +            incremental_prune_during_ibd: true,    // Enable incremental pruning during IBD
2025-11-10T00:08:56.3260902Z +            prune_window_size: 144,                // Keep sliding window of 144 blocks during IBD
2025-11-10T00:08:56.3262032Z              min_blocks_for_incremental_prune: 288, // Start pruning after 288 blocks (~2 days)
2025-11-10T00:08:56.3262778Z              #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.3263263Z              utxo_commitments: None,
2025-11-10T00:08:56.3263980Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:508:
2025-11-10T00:08:56.3264937Z      /// Keep UTXO commitments for pruned blocks
2025-11-10T00:08:56.3265411Z      #[serde(default = "default_true")]
2025-11-10T00:08:56.3265865Z      pub keep_commitments: bool,
2025-11-10T00:08:56.3266243Z -    
2025-11-10T00:08:56.3266504Z +
2025-11-10T00:08:56.3266895Z      /// Keep filtered blocks (spam-filtered) for pruned range
2025-11-10T00:08:56.3267439Z      #[serde(default = "default_false")]
2025-11-10T00:08:56.3267891Z      pub keep_filtered_blocks: bool,
2025-11-10T00:08:56.3268626Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:515:
2025-11-10T00:08:56.3269342Z -    
2025-11-10T00:08:56.3269599Z +
2025-11-10T00:08:56.3270042Z      /// Generate commitments before pruning (if not already generated)
2025-11-10T00:08:56.3270646Z      #[serde(default = "default_true")]
2025-11-10T00:08:56.3271094Z      pub generate_before_prune: bool,
2025-11-10T00:08:56.3271837Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:519:
2025-11-10T00:08:56.3272557Z -    
2025-11-10T00:08:56.3273064Z +
2025-11-10T00:08:56.3273429Z      /// Maximum age for commitments (days, 0 = keep forever)
2025-11-10T00:08:56.3274020Z      #[serde(default = "default_commitment_max_age")]
2025-11-10T00:08:56.3274724Z      pub max_commitment_age_days: u32,
2025-11-10T00:08:56.3275465Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:546:
2025-11-10T00:08:56.3276293Z      /// Keep BIP158 filters for pruned blocks
2025-11-10T00:08:56.3276779Z      #[serde(default = "default_true")]
2025-11-10T00:08:56.3277215Z      pub keep_filters: bool,
2025-11-10T00:08:56.3277586Z -    
2025-11-10T00:08:56.3277846Z +
2025-11-10T00:08:56.3278276Z      /// Keep filter header chain (always required for verification)
2025-11-10T00:08:56.3278862Z      #[serde(default = "default_true")]
2025-11-10T00:08:56.3279284Z      pub keep_filter_headers: bool,
2025-11-10T00:08:56.3279973Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:553:
2025-11-10T00:08:56.3280676Z -    
2025-11-10T00:08:56.3280928Z +
2025-11-10T00:08:56.3281273Z      /// Maximum age for filters (days, 0 = keep forever)
2025-11-10T00:08:56.3281819Z      #[serde(default = "default_filter_max_age")]
2025-11-10T00:08:56.3282298Z      pub max_filter_age_days: u32,
2025-11-10T00:08:56.3283031Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:578:
2025-11-10T00:08:56.3283788Z      /// Database backend selection
2025-11-10T00:08:56.3284262Z      #[serde(default = "default_database_backend")]
2025-11-10T00:08:56.3285037Z      pub database_backend: DatabaseBackendConfig,
2025-11-10T00:08:56.3285494Z -    
2025-11-10T00:08:56.3285765Z +
2025-11-10T00:08:56.3286042Z      /// Storage path
2025-11-10T00:08:56.3286718Z      #[serde(default = "default_storage_path")]
2025-11-10T00:08:56.3287189Z      pub data_dir: String,
2025-11-10T00:08:56.3287878Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:585:
2025-11-10T00:08:56.3288603Z -    
2025-11-10T00:08:56.3288876Z +
2025-11-10T00:08:56.3289161Z      /// Pruning configuration
2025-11-10T00:08:56.3289586Z      pub pruning: Option<PruningConfig>,
2025-11-10T00:08:56.3290002Z -    
2025-11-10T00:08:56.3290264Z +
2025-11-10T00:08:56.3290519Z      /// Cache sizes
2025-11-10T00:08:56.3290894Z      pub cache: Option<StorageCacheConfig>,
2025-11-10T00:08:56.3291315Z  }
2025-11-10T00:08:56.3291911Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:616:
2025-11-10T00:08:56.3292662Z      /// Block cache size (MB)
2025-11-10T00:08:56.3293088Z      #[serde(default = "default_block_cache_mb")]
2025-11-10T00:08:56.3293790Z      pub block_cache_mb: usize,
2025-11-10T00:08:56.3294173Z -    
2025-11-10T00:08:56.3294626Z +
2025-11-10T00:08:56.3294887Z      /// UTXO cache size (MB)
2025-11-10T00:08:56.3295284Z      #[serde(default = "default_utxo_cache_mb")]
2025-11-10T00:08:56.3295754Z      pub utxo_cache_mb: usize,
2025-11-10T00:08:56.3297998Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:623:
2025-11-10T00:08:56.3298720Z -    
2025-11-10T00:08:56.3298979Z +
2025-11-10T00:08:56.3299249Z      /// Header cache size (MB)
2025-11-10T00:08:56.3299655Z      #[serde(default = "default_header_cache_mb")]
2025-11-10T00:08:56.3300138Z      pub header_cache_mb: usize,
2025-11-10T00:08:56.3300840Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:668:
2025-11-10T00:08:56.3301678Z                  pruning.validate()?;
2025-11-10T00:08:56.3302089Z              }
2025-11-10T00:08:56.3302392Z          }
2025-11-10T00:08:56.3302657Z -        
2025-11-10T00:08:56.3302943Z +
2025-11-10T00:08:56.3303205Z          Ok(())
2025-11-10T00:08:56.3303499Z      }
2025-11-10T00:08:56.3303760Z  }
2025-11-10T00:08:56.3304531Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:686:
2025-11-10T00:08:56.3305274Z                  ));
2025-11-10T00:08:56.3305577Z              }
2025-11-10T00:08:56.3305860Z          }
2025-11-10T00:08:56.3306127Z -        
2025-11-10T00:08:56.3306390Z +
2025-11-10T00:08:56.3306710Z          // Validate min_blocks_to_keep is reasonable
2025-11-10T00:08:56.3307197Z          if self.min_blocks_to_keep == 0 {
2025-11-10T00:08:56.3314063Z              return Err(anyhow::anyhow!(
2025-11-10T00:08:56.3315060Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:693:
2025-11-10T00:08:56.3315911Z                  "min_blocks_to_keep must be greater than 0 for safety"
2025-11-10T00:08:56.3316431Z              ));
2025-11-10T00:08:56.3316725Z          }
2025-11-10T00:08:56.3317022Z -        
2025-11-10T00:08:56.3317291Z +
2025-11-10T00:08:56.3317602Z          // Validate auto_prune_interval
2025-11-10T00:08:56.3318141Z          if self.auto_prune && self.auto_prune_interval == 0 {
2025-11-10T00:08:56.3318697Z              return Err(anyhow::anyhow!(
2025-11-10T00:08:56.3319431Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:700:
2025-11-10T00:08:56.3320380Z                  "auto_prune_interval must be greater than 0 when auto_prune is enabled"
2025-11-10T00:08:56.3320982Z              ));
2025-11-10T00:08:56.3321267Z          }
2025-11-10T00:08:56.3321534Z -        
2025-11-10T00:08:56.3321792Z +
2025-11-10T00:08:56.3322104Z          // Validate mode-specific settings
2025-11-10T00:08:56.3322549Z          match &self.mode {
2025-11-10T00:08:56.3323025Z -            PruningMode::Normal { min_recent_blocks, .. } => {
2025-11-10T00:08:56.3323562Z +            PruningMode::Normal {
2025-11-10T00:08:56.3323986Z +                min_recent_blocks, ..
2025-11-10T00:08:56.3324600Z +            } => {
2025-11-10T00:08:56.3324960Z                  if *min_recent_blocks == 0 {
2025-11-10T00:08:56.3325721Z                      return Err(anyhow::anyhow!(
2025-11-10T00:08:56.3326340Z                          "min_recent_blocks must be greater than 0 in Normal pruning mode"
2025-11-10T00:08:56.3327262Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:728:
2025-11-10T00:08:56.3328018Z                  // No validation needed
2025-11-10T00:08:56.3328430Z              }
2025-11-10T00:08:56.3328710Z          }
2025-11-10T00:08:56.3328980Z -        
2025-11-10T00:08:56.3329245Z +
2025-11-10T00:08:56.3329505Z          Ok(())
2025-11-10T00:08:56.3329781Z      }
2025-11-10T00:08:56.3330030Z  }
2025-11-10T00:08:56.3330626Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/lib.rs:25:
2025-11-10T00:08:56.3331324Z  #[global_allocator]
2025-11-10T00:08:56.3331782Z  static GLOBAL: mimalloc::MiMalloc = mimalloc::MiMalloc;
2025-11-10T00:08:56.3333008Z  
2025-11-10T00:08:56.3333305Z -pub mod storage;
2025-11-10T00:08:56.3333655Z +pub mod bip21;
2025-11-10T00:08:56.3333948Z +pub mod config;
2025-11-10T00:08:56.3334246Z +pub mod module;
2025-11-10T00:08:56.3334724Z  pub mod network;
2025-11-10T00:08:56.3335043Z -pub mod rpc;
2025-11-10T00:08:56.3335327Z  pub mod node;
2025-11-10T00:08:56.3335634Z -pub mod config;
2025-11-10T00:08:56.3335916Z +pub mod rpc;
2025-11-10T00:08:56.3336176Z +pub mod storage;
2025-11-10T00:08:56.3338357Z  #[cfg(feature = "production")]
2025-11-10T00:08:56.3338700Z  pub mod validation;
2025-11-10T00:08:56.3338996Z -pub mod module;
2025-11-10T00:08:56.3339266Z -pub mod bip21;
2025-11-10T00:08:56.3339528Z  
2025-11-10T00:08:56.3339797Z  // Re-export config module
2025-11-10T00:08:56.3340160Z  pub use config::*;
2025-11-10T00:08:56.3340702Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/lib.rs:40:
2025-11-10T00:08:56.3341316Z  
2025-11-10T00:08:56.3341652Z  // Re-export commonly used types from protocol-engine
2025-11-10T00:08:56.3342406Z  // This allows depending only on protocol-engine (which transitively provides consensus-proof)
2025-11-10T00:08:56.3343178Z +pub use bllvm_protocol::mempool::Mempool;
2025-11-10T00:08:56.3343629Z  pub use bllvm_protocol::{
2025-11-10T00:08:56.3346260Z -    Block, BlockHeader, Transaction, TransactionInput, TransactionOutput,
2025-11-10T00:08:56.3347154Z -    OutPoint, UTXO, UtxoSet, ValidationResult, Hash, ByteString, Natural, Integer,
2025-11-10T00:08:56.3347938Z -    ConsensusError, Result,
2025-11-10T00:08:56.3348627Z +    Block, BlockHeader, ByteString, ConsensusError, Hash, Integer, Natural, OutPoint, Result,
2025-11-10T00:08:56.3349665Z +    Transaction, TransactionInput, TransactionOutput, UtxoSet, ValidationResult, UTXO,
2025-11-10T00:08:56.3350350Z  };
2025-11-10T00:08:56.3350661Z -pub use bllvm_protocol::mempool::Mempool;
2025-11-10T00:08:56.3351103Z  
2025-11-10T00:08:56.3351397Z  // Re-export protocol-engine types
2025-11-10T00:08:56.3352006Z  pub use bllvm_protocol::{BitcoinProtocolEngine, ProtocolVersion};
2025-11-10T00:08:56.3353243Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/lib.rs:81:
2025-11-10T00:08:56.3354076Z          // Test that protocol-engine works in reference-node context
2025-11-10T00:08:56.3357257Z          let node = ReferenceNode::new(Some(ProtocolVersion::Regtest)).unwrap();
2025-11-10T00:08:56.3357849Z          let protocol = node.protocol();
2025-11-10T00:08:56.3358235Z -        
2025-11-10T00:08:56.3358468Z +
2025-11-10T00:08:56.3358731Z          // Verify protocol version
2025-11-10T00:08:56.3359290Z          assert_eq!(protocol.get_protocol_version(), ProtocolVersion::Regtest);
2025-11-10T00:08:56.3359874Z -        
2025-11-10T00:08:56.3360116Z +
2025-11-10T00:08:56.3360367Z          // Test feature support
2025-11-10T00:08:56.3360792Z          assert!(protocol.supports_feature("fast_mining"));
2025-11-10T00:08:56.3361236Z      }
2025-11-10T00:08:56.3361745Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/lib.rs:94:
2025-11-10T00:08:56.3362552Z          // Test consensus validation through protocol-engine
2025-11-10T00:08:56.3363498Z          let node = ReferenceNode::new(None).unwrap(); // Uses default Regtest
2025-11-10T00:08:56.3364077Z          let protocol = node.protocol();
2025-11-10T00:08:56.3364602Z -        
2025-11-10T00:08:56.3364838Z +
2025-11-10T00:08:56.3365112Z          // Create a simple transaction
2025-11-10T00:08:56.3367171Z          let tx = Transaction {
2025-11-10T00:08:56.3367511Z              version: 1,
2025-11-10T00:08:56.3368080Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/lib.rs:105:
2025-11-10T00:08:56.3368761Z              }],
2025-11-10T00:08:56.3369079Z              lock_time: 0,
2025-11-10T00:08:56.3369417Z          };
2025-11-10T00:08:56.3369692Z -        
2025-11-10T00:08:56.3369949Z +
2025-11-10T00:08:56.3370247Z          // Test transaction validation
2025-11-10T00:08:56.3370978Z          let result = protocol.validate_transaction(&tx);
2025-11-10T00:08:56.3371525Z          assert!(result.is_ok());
2025-11-10T00:08:56.3372206Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/lib.rs:115:
2025-11-10T00:08:56.3373132Z      fn test_reference_node_creation() {
2025-11-10T00:08:56.3373554Z          // Test default (Regtest) creation
2025-11-10T00:08:56.3374007Z          let node = ReferenceNode::new(None).unwrap();
2025-11-10T00:08:56.3374842Z -        assert_eq!(node.protocol().get_protocol_version(), ProtocolVersion::Regtest);
2025-11-10T00:08:56.3375434Z -        
2025-11-10T00:08:56.3375692Z +        assert_eq!(
2025-11-10T00:08:56.3376029Z +            node.protocol().get_protocol_version(),
2025-11-10T00:08:56.3376469Z +            ProtocolVersion::Regtest
2025-11-10T00:08:56.3376859Z +        );
2025-11-10T00:08:56.3377133Z +
2025-11-10T00:08:56.3377408Z          // Test mainnet creation
2025-11-10T00:08:56.3378032Z          let mainnet_node = ReferenceNode::new(Some(ProtocolVersion::BitcoinV1)).unwrap();
2025-11-10T00:08:56.3378938Z -        assert_eq!(mainnet_node.protocol().get_protocol_version(), ProtocolVersion::BitcoinV1);
2025-11-10T00:08:56.3379598Z +        assert_eq!(
2025-11-10T00:08:56.3379996Z +            mainnet_node.protocol().get_protocol_version(),
2025-11-10T00:08:56.3380500Z +            ProtocolVersion::BitcoinV1
2025-11-10T00:08:56.3380911Z +        );
2025-11-10T00:08:56.3381168Z      }
2025-11-10T00:08:56.3381439Z  }
2025-11-10T00:08:56.3381702Z +
2025-11-10T00:08:56.3382328Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/api/hub.rs:81:
2025-11-10T00:08:56.3385152Z              .validate_request(module_id, &request.payload)?;
2025-11-10T00:08:56.3385646Z  
2025-11-10T00:08:56.3386130Z          // Handle handshake specially (no validation needed, just acknowledge)
2025-11-10T00:08:56.3387153Z -        if let RequestPayload::Handshake { module_id: handshake_id, module_name, version } = &request.payload {
2025-11-10T00:08:56.3388013Z +        if let RequestPayload::Handshake {
2025-11-10T00:08:56.3388484Z +            module_id: handshake_id,
2025-11-10T00:08:56.3388901Z +            module_name,
2025-11-10T00:08:56.3389258Z +            version,
2025-11-10T00:08:56.3389591Z +        } = &request.payload
2025-11-10T00:08:56.3389963Z +        {
2025-11-10T00:08:56.3390267Z              // Verify module_id matches
2025-11-10T00:08:56.3390726Z              if handshake_id != module_id {
2025-11-10T00:08:56.3391200Z -                return Err(ModuleError::OperationError(
2025-11-10T00:08:56.3391980Z -                    format!("Handshake module_id mismatch: expected {}, got {}", module_id, handshake_id)
2025-11-10T00:08:56.3392679Z -                ));
2025-11-10T00:08:56.3393095Z +                return Err(ModuleError::OperationError(format!(
2025-11-10T00:08:56.3395702Z +                    "Handshake module_id mismatch: expected {}, got {}",
2025-11-10T00:08:56.3396259Z +                    module_id, handshake_id
2025-11-10T00:08:56.3396676Z +                )));
2025-11-10T00:08:56.3396981Z              }
2025-11-10T00:08:56.3397545Z -            
2025-11-10T00:08:56.3398123Z -            info!("Handshake from module {} (name={}, version={})", module_id, module_name, version);
2025-11-10T00:08:56.3398790Z +
2025-11-10T00:08:56.3399029Z +            info!(
2025-11-10T00:08:56.3399428Z +                "Handshake from module {} (name={}, version={})",
2025-11-10T00:08:56.3399968Z +                module_id, module_name, version
2025-11-10T00:08:56.3400392Z +            );
2025-11-10T00:08:56.3400754Z              return Ok(ResponseMessage::success(
2025-11-10T00:08:56.3401221Z                  request.correlation_id,
2025-11-10T00:08:56.3401696Z                  ResponsePayload::HandshakeAck {
2025-11-10T00:08:56.3402472Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/api/hub.rs:96:
2025-11-10T00:08:56.3403329Z                      node_version: env!("CARGO_PKG_VERSION").to_string(),
2025-11-10T00:08:56.3406290Z -                }
2025-11-10T00:08:56.3406612Z +                },
2025-11-10T00:08:56.3406900Z              ));
2025-11-10T00:08:56.3407165Z          }
2025-11-10T00:08:56.3407418Z  
2025-11-10T00:08:56.3407997Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/api/hub.rs:108:
2025-11-10T00:08:56.3408767Z              RequestPayload::Handshake { .. } => {
2025-11-10T00:08:56.3409282Z                  // Handshake is handled at connection level, not here
2025-11-10T00:08:56.3409907Z                  return Err(crate::module::traits::ModuleError::IpcError(
2025-11-10T00:08:56.3410565Z -                    "Handshake should be handled at connection level".to_string()
2025-11-10T00:08:56.3411265Z +                    "Handshake should be handled at connection level".to_string(),
2025-11-10T00:08:56.3411810Z                  ));
2025-11-10T00:08:56.3412102Z              }
2025-11-10T00:08:56.3412436Z              RequestPayload::GetBlock { hash } => {
2025-11-10T00:08:56.3413238Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/ipc/protocol.rs:76:
2025-11-10T00:08:56.3416081Z  #[derive(Debug, Clone, Serialize, Deserialize)]
2025-11-10T00:08:56.3416544Z  pub enum RequestPayload {
2025-11-10T00:08:56.3417011Z      /// Handshake: Module identifies itself (first message)
2025-11-10T00:08:56.3417711Z -    Handshake { module_id: String, module_name: String, version: String },
2025-11-10T00:08:56.3418305Z -    GetBlock { hash: Hash },
2025-11-10T00:08:56.3418694Z -    GetBlockHeader { hash: Hash },
2025-11-10T00:08:56.3419107Z -    GetTransaction { hash: Hash },
2025-11-10T00:08:56.3419542Z -    HasTransaction { hash: Hash },
2025-11-10T00:08:56.3419936Z +    Handshake {
2025-11-10T00:08:56.3420264Z +        module_id: String,
2025-11-10T00:08:56.3420631Z +        module_name: String,
2025-11-10T00:08:56.3421009Z +        version: String,
2025-11-10T00:08:56.3421341Z +    },
2025-11-10T00:08:56.3421616Z +    GetBlock {
2025-11-10T00:08:56.3422108Z +        hash: Hash,
2025-11-10T00:08:56.3422411Z +    },
2025-11-10T00:08:56.3422695Z +    GetBlockHeader {
2025-11-10T00:08:56.3423027Z +        hash: Hash,
2025-11-10T00:08:56.3423338Z +    },
2025-11-10T00:08:56.3423600Z +    GetTransaction {
2025-11-10T00:08:56.3425971Z +        hash: Hash,
2025-11-10T00:08:56.3426270Z +    },
2025-11-10T00:08:56.3426549Z +    HasTransaction {
2025-11-10T00:08:56.3426874Z +        hash: Hash,
2025-11-10T00:08:56.3427168Z +    },
2025-11-10T00:08:56.3427433Z      GetChainTip,
2025-11-10T00:08:56.3427751Z      GetBlockHeight,
2025-11-10T00:08:56.3428113Z -    GetUtxo { outpoint: OutPoint },
2025-11-10T00:08:56.3428617Z -    SubscribeEvents { event_types: Vec<EventType> },
2025-11-10T00:08:56.3429113Z +    GetUtxo {
2025-11-10T00:08:56.3429423Z +        outpoint: OutPoint,
2025-11-10T00:08:56.3429778Z +    },
2025-11-10T00:08:56.3430048Z +    SubscribeEvents {
2025-11-10T00:08:56.3430416Z +        event_types: Vec<EventType>,
2025-11-10T00:08:56.3430819Z +    },
2025-11-10T00:08:56.3431091Z  }
2025-11-10T00:08:56.3431338Z  
2025-11-10T00:08:56.3431628Z  /// Response message from node to module
2025-11-10T00:08:56.3433162Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/ipc/protocol.rs:100:
2025-11-10T00:08:56.3434029Z  #[derive(Debug, Clone, Serialize, Deserialize)]
2025-11-10T00:08:56.3434690Z  pub enum ResponsePayload {
2025-11-10T00:08:56.3435130Z      /// Handshake acknowledgment with node version
2025-11-10T00:08:56.3435636Z -    HandshakeAck { node_version: String },
2025-11-10T00:08:56.3436071Z +    HandshakeAck {
2025-11-10T00:08:56.3436399Z +        node_version: String,
2025-11-10T00:08:56.3436758Z +    },
2025-11-10T00:08:56.3437024Z      Block(Option<Block>),
2025-11-10T00:08:56.3437432Z      BlockHeader(Option<BlockHeader>),
2025-11-10T00:08:56.3437893Z      Transaction(Option<Transaction>),
2025-11-10T00:08:56.3438741Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/ipc/server.rs:124:
2025-11-10T00:08:56.3439798Z              Some(Ok(bytes)) => {
2025-11-10T00:08:56.3440412Z                  let message: ModuleMessage = bincode::deserialize(bytes.as_ref())
2025-11-10T00:08:56.3441180Z                      .map_err(|e| ModuleError::SerializationError(e.to_string()))?;
2025-11-10T00:08:56.3441733Z -                
2025-11-10T00:08:56.3442036Z +
2025-11-10T00:08:56.3442293Z                  match message {
2025-11-10T00:08:56.3442741Z                      ModuleMessage::Request(request) => {
2025-11-10T00:08:56.3443523Z -                        if let RequestPayload::Handshake { module_id, module_name, version } = request.payload {
2025-11-10T00:08:56.3444891Z +                        if let RequestPayload::Handshake {
2025-11-10T00:08:56.3445382Z +                            module_id,
2025-11-10T00:08:56.3445791Z +                            module_name,
2025-11-10T00:08:56.3446218Z +                            version,
2025-11-10T00:08:56.3446609Z +                        } = request.payload
2025-11-10T00:08:56.3447011Z +                        {
2025-11-10T00:08:56.3447339Z                              info!(
2025-11-10T00:08:56.3447816Z                                  "Module handshake: id={}, name={}, version={}",
2025-11-10T00:08:56.3448368Z                                  module_id, module_name, version
2025-11-10T00:08:56.3449185Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/ipc/server.rs:134:
2025-11-10T00:08:56.3449978Z                              );
2025-11-10T00:08:56.3450330Z -                            
2025-11-10T00:08:56.3450681Z +
2025-11-10T00:08:56.3450993Z                              // Send handshake acknowledgment
2025-11-10T00:08:56.3451510Z                              let ack = ResponseMessage {
2025-11-10T00:08:56.3452027Z                                  correlation_id: request.correlation_id,
2025-11-10T00:08:56.3452870Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/ipc/server.rs:142:
2025-11-10T00:08:56.3453662Z                                  }),
2025-11-10T00:08:56.3454069Z                                  error: None,
2025-11-10T00:08:56.3454680Z                              };
2025-11-10T00:08:56.3455043Z -                            
2025-11-10T00:08:56.3455395Z +
2025-11-10T00:08:56.3455850Z                              let ack_bytes = bincode::serialize(&ModuleMessage::Response(ack))
2025-11-10T00:08:56.3456626Z                                  .map_err(|e| ModuleError::SerializationError(e.to_string()))?;
2025-11-10T00:08:56.3457311Z -                            writer.send(bytes::Bytes::from(ack_bytes)).await
2025-11-10T00:08:56.3458102Z -                                .map_err(|e| ModuleError::IpcError(format!("Failed to send handshake ack: {}", e)))?;
2025-11-10T00:08:56.3458798Z -                            
2025-11-10T00:08:56.3459159Z +                            writer
2025-11-10T00:08:56.3459602Z +                                .send(bytes::Bytes::from(ack_bytes))
2025-11-10T00:08:56.3460075Z +                                .await
2025-11-10T00:08:56.3460501Z +                                .map_err(|e| {
2025-11-10T00:08:56.3461295Z +                                    ModuleError::IpcError(format!(
2025-11-10T00:08:56.3461821Z +                                        "Failed to send handshake ack: {}",
2025-11-10T00:08:56.3462295Z +                                        e
2025-11-10T00:08:56.3462690Z +                                    ))
2025-11-10T00:08:56.3463067Z +                                })?;
2025-11-10T00:08:56.3463447Z +
2025-11-10T00:08:56.3463724Z                              module_id
2025-11-10T00:08:56.3464112Z                          } else {
2025-11-10T00:08:56.3464875Z                              // No handshake - use fallback ID (backward compatibility)
2025-11-10T00:08:56.3465809Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/ipc/server.rs:162:
2025-11-10T00:08:56.3466601Z                      }
2025-11-10T00:08:56.3467153Z                      _ => {
2025-11-10T00:08:56.3478395Z                          return Err(ModuleError::IpcError(
2025-11-10T00:08:56.3479033Z -                            "First message must be a handshake request".to_string()
2025-11-10T00:08:56.3479712Z +                            "First message must be a handshake request".to_string(),
2025-11-10T00:08:56.3480235Z                          ));
2025-11-10T00:08:56.3480594Z                      }
2025-11-10T00:08:56.3480912Z                  }
2025-11-10T00:08:56.3481577Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/ipc/server.rs:169:
2025-11-10T00:08:56.3482349Z              }
2025-11-10T00:08:56.3482656Z              Some(Err(e)) => {
2025-11-10T00:08:56.3483316Z -                return Err(ModuleError::IpcError(format!("Failed to read handshake: {}", e)));
2025-11-10T00:08:56.3484066Z +                return Err(ModuleError::IpcError(format!(
2025-11-10T00:08:56.3484791Z +                    "Failed to read handshake: {}",
2025-11-10T00:08:56.3485256Z +                    e
2025-11-10T00:08:56.3485584Z +                )));
2025-11-10T00:08:56.3485901Z              }
2025-11-10T00:08:56.3486185Z              None => {
2025-11-10T00:08:56.3486822Z -                return Err(ModuleError::IpcError("Connection closed before handshake".to_string()));
2025-11-10T00:08:56.3487569Z +                return Err(ModuleError::IpcError(
2025-11-10T00:08:56.3488128Z +                    "Connection closed before handshake".to_string(),
2025-11-10T00:08:56.3488622Z +                ));
2025-11-10T00:08:56.3488922Z              }
2025-11-10T00:08:56.3489201Z          };
2025-11-10T00:08:56.3489468Z  
2025-11-10T00:08:56.3490093Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/ipc/server.rs:372:
2025-11-10T00:08:56.3490946Z                  // Handshake is handled at connection level
2025-11-10T00:08:56.3491426Z                  Ok(ResponseMessage::success(
2025-11-10T00:08:56.3491856Z                      request.correlation_id,
2025-11-10T00:08:56.3492554Z -                    ResponsePayload::HandshakeAck { node_version: env!("CARGO_PKG_VERSION").to_string() },
2025-11-10T00:08:56.3493278Z +                    ResponsePayload::HandshakeAck {
2025-11-10T00:08:56.3493781Z +                        node_version: env!("CARGO_PKG_VERSION").to_string(),
2025-11-10T00:08:56.3494249Z +                    },
2025-11-10T00:08:56.3494754Z                  ))
2025-11-10T00:08:56.3495056Z              }
2025-11-10T00:08:56.3495406Z              RequestPayload::GetBlock { hash } => {
2025-11-10T00:08:56.3496226Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/manager.rs:159:
2025-11-10T00:08:56.3497125Z          // This allows both to access the process for different purposes
2025-11-10T00:08:56.3497705Z          use std::sync::Arc;
2025-11-10T00:08:56.3498231Z          let shared_process = Arc::new(tokio::sync::Mutex::new(process));
2025-11-10T00:08:56.3498783Z -        
2025-11-10T00:08:56.3499057Z +
2025-11-10T00:08:56.3499378Z          // Create monitor with shared process
2025-11-10T00:08:56.3500212Z          let monitor = ModuleProcessMonitor::new(self.crash_tx.clone());
2025-11-10T00:08:56.3500861Z          let module_name_clone = module_name.to_string();
2025-11-10T00:08:56.3516979Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:87:
2025-11-10T00:08:56.3517824Z  
2025-11-10T00:08:56.3518116Z              // Check heartbeat via IPC
2025-11-10T00:08:56.3518602Z              if let Some(client) = process.client_mut() {
2025-11-10T00:08:56.3519182Z +                use crate::module::ipc::protocol::MessageType;
2025-11-10T00:08:56.3519784Z                  use crate::module::ipc::protocol::RequestMessage;
2025-11-10T00:08:56.3520381Z                  use crate::module::ipc::protocol::RequestPayload;
2025-11-10T00:08:56.3520964Z -                use crate::module::ipc::protocol::MessageType;
2025-11-10T00:08:56.3521470Z -                
2025-11-10T00:08:56.3522018Z +
2025-11-10T00:08:56.3522418Z                  // Use GetChainTip as a lightweight heartbeat check
2025-11-10T00:08:56.3522997Z                  let heartbeat_request = RequestMessage {
2025-11-10T00:08:56.3525775Z                      correlation_id: 0, // Use 0 for heartbeat (won't match any real request)
2025-11-10T00:08:56.3526815Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:97:
2025-11-10T00:08:56.3527716Z                      request_type: MessageType::GetChainTip,
2025-11-10T00:08:56.3528261Z                      payload: RequestPayload::GetChainTip,
2025-11-10T00:08:56.3528717Z                  };
2025-11-10T00:08:56.3529028Z -                
2025-11-10T00:08:56.3529333Z +
2025-11-10T00:08:56.3529630Z                  // Send heartbeat with timeout
2025-11-10T00:08:56.3530147Z -                let heartbeat_result = tokio::time::timeout(
2025-11-10T00:08:56.3530648Z -                    Duration::from_secs(2),
2025-11-10T00:08:56.3531125Z -                    client.request(heartbeat_request)
2025-11-10T00:08:56.3531582Z -                ).await;
2025-11-10T00:08:56.3531908Z -                
2025-11-10T00:08:56.3532239Z +                let heartbeat_result =
2025-11-10T00:08:56.3532920Z +                    tokio::time::timeout(Duration::from_secs(2), client.request(heartbeat_request))
2025-11-10T00:08:56.3533600Z +                        .await;
2025-11-10T00:08:56.3533959Z +
2025-11-10T00:08:56.3534265Z                  match heartbeat_result {
2025-11-10T00:08:56.3534878Z                      Ok(Ok(_)) => {
2025-11-10T00:08:56.3535346Z                          // Heartbeat successful - module is responsive
2025-11-10T00:08:56.3536234Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:120:
2025-11-10T00:08:56.3537040Z                  }
2025-11-10T00:08:56.3537334Z              } else {
2025-11-10T00:08:56.3537741Z                  // No IPC client available - can't check heartbeat
2025-11-10T00:08:56.3538416Z -                debug!("Module {} has no IPC client for heartbeat check", module_name);
2025-11-10T00:08:56.3539025Z +                debug!(
2025-11-10T00:08:56.3539469Z +                    "Module {} has no IPC client for heartbeat check",
2025-11-10T00:08:56.3539980Z +                    module_name
2025-11-10T00:08:56.3540359Z +                );
2025-11-10T00:08:56.3540657Z              }
2025-11-10T00:08:56.3540950Z -            
2025-11-10T00:08:56.3541228Z +
2025-11-10T00:08:56.3541546Z              // Loop continues to next iteration
2025-11-10T00:08:56.3541990Z          }
2025-11-10T00:08:56.3542272Z      }
2025-11-10T00:08:56.3544886Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:145:
2025-11-10T00:08:56.3545793Z                  let mut process_guard = shared_process.lock().await;
2025-11-10T00:08:56.3546309Z                  process_guard.is_running()
2025-11-10T00:08:56.3546716Z              };
2025-11-10T00:08:56.3547010Z -            
2025-11-10T00:08:56.3547275Z +
2025-11-10T00:08:56.3547543Z              if !is_running {
2025-11-10T00:08:56.3548225Z                  // Process exited, check exit status
2025-11-10T00:08:56.3548714Z                  let exit_status = {
2025-11-10T00:08:56.3550126Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:152:
2025-11-10T00:08:56.3551101Z                      let mut process_guard = shared_process.lock().await;
2025-11-10T00:08:56.3553263Z                      process_guard.wait().await?
2025-11-10T00:08:56.3553685Z                  };
2025-11-10T00:08:56.3553988Z -                
2025-11-10T00:08:56.3554460Z +
2025-11-10T00:08:56.3554757Z                  match exit_status {
2025-11-10T00:08:56.3555172Z                      Some(status) => {
2025-11-10T00:08:56.3555602Z                          if status.success() {
2025-11-10T00:08:56.3556667Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:182:
2025-11-10T00:08:56.3557496Z              {
2025-11-10T00:08:56.3557930Z                  let mut process_guard = shared_process.lock().await;
2025-11-10T00:08:56.3558538Z                  if let Some(client) = process_guard.client_mut() {
2025-11-10T00:08:56.3559142Z +                    use crate::module::ipc::protocol::MessageType;
2025-11-10T00:08:56.3559735Z                      use crate::module::ipc::protocol::RequestMessage;
2025-11-10T00:08:56.3560453Z                      use crate::module::ipc::protocol::RequestPayload;
2025-11-10T00:08:56.3561053Z -                    use crate::module::ipc::protocol::MessageType;
2025-11-10T00:08:56.3561542Z -                    
2025-11-10T00:08:56.3561848Z +
2025-11-10T00:08:56.3562191Z                      // Use GetChainTip as a lightweight heartbeat check
2025-11-10T00:08:56.3562755Z                      let heartbeat_request = RequestMessage {
2025-11-10T00:08:56.3565604Z                          correlation_id: 0, // Use 0 for heartbeat (won't match any real request)
2025-11-10T00:08:56.3566636Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:192:
2025-11-10T00:08:56.3567566Z                          request_type: MessageType::GetChainTip,
2025-11-10T00:08:56.3568111Z                          payload: RequestPayload::GetChainTip,
2025-11-10T00:08:56.3568578Z                      };
2025-11-10T00:08:56.3568890Z -                    
2025-11-10T00:08:56.3569193Z +
2025-11-10T00:08:56.3569493Z                      // Send heartbeat with timeout
2025-11-10T00:08:56.3570005Z                      let heartbeat_result = tokio::time::timeout(
2025-11-10T00:08:56.3570517Z                          Duration::from_secs(2),
2025-11-10T00:08:56.3571341Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:199:
2025-11-10T00:08:56.3574605Z -                        client.request(heartbeat_request)
2025-11-10T00:08:56.3575076Z -                    ).await;
2025-11-10T00:08:56.3575533Z -                    
2025-11-10T00:08:56.3575909Z +                        client.request(heartbeat_request),
2025-11-10T00:08:56.3576359Z +                    )
2025-11-10T00:08:56.3576681Z +                    .await;
2025-11-10T00:08:56.3577017Z +
2025-11-10T00:08:56.3577316Z                      match heartbeat_result {
2025-11-10T00:08:56.3578207Z                          Ok(Ok(_)) => {
2025-11-10T00:08:56.3579102Z                              // Heartbeat successful - module is responsive
2025-11-10T00:08:56.3580351Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:215:
2025-11-10T00:08:56.3581177Z                      }
2025-11-10T00:08:56.3581501Z                  } else {
2025-11-10T00:08:56.3581920Z                      // No IPC client available - can't check heartbeat
2025-11-10T00:08:56.3582606Z -                    debug!("Module {} has no IPC client for heartbeat check", module_name);
2025-11-10T00:08:56.3585089Z +                    debug!(
2025-11-10T00:08:56.3585959Z +                        "Module {} has no IPC client for heartbeat check",
2025-11-10T00:08:56.3586747Z +                        module_name
2025-11-10T00:08:56.3587142Z +                    );
2025-11-10T00:08:56.3587449Z                  }
2025-11-10T00:08:56.3587749Z              }
2025-11-10T00:08:56.3588040Z -            
2025-11-10T00:08:56.3588319Z +
2025-11-10T00:08:56.3588633Z              // Loop continues to next iteration
2025-11-10T00:08:56.3589058Z          }
2025-11-10T00:08:56.3589330Z      }
2025-11-10T00:08:56.3590017Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:229:
2025-11-10T00:08:56.3591426Z              ModuleHealth::Crashed("Process exited".to_string())
2025-11-10T00:08:56.3592030Z          } else if let Some(client) = process.client_mut() {
2025-11-10T00:08:56.3592557Z              // Check heartbeat via IPC with short timeout
2025-11-10T00:08:56.3593473Z -            use crate::module::ipc::protocol::{RequestMessage, RequestPayload, MessageType};
2025-11-10T00:08:56.3594574Z +            use crate::module::ipc::protocol::{MessageType, RequestMessage, RequestPayload};
2025-11-10T00:08:56.3595277Z              use tokio::time::timeout;
2025-11-10T00:08:56.3595676Z -            
2025-11-10T00:08:56.3595972Z +
2025-11-10T00:08:56.3596304Z              let heartbeat_request = RequestMessage {
2025-11-10T00:08:56.3596795Z                  correlation_id: 0,
2025-11-10T00:08:56.3597250Z                  request_type: MessageType::GetChainTip,
2025-11-10T00:08:56.3598121Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:238:
2025-11-10T00:08:56.3598995Z                  payload: RequestPayload::GetChainTip,
2025-11-10T00:08:56.3599425Z              };
2025-11-10T00:08:56.3599713Z -            
2025-11-10T00:08:56.3599975Z +
2025-11-10T00:08:56.3600382Z              // Use tokio::runtime::Handle to run async code in sync context
2025-11-10T00:08:56.3601156Z              // This is a simplified check - in production would use proper async context
2025-11-10T00:08:56.3601861Z              match tokio::runtime::Handle::try_current() {
2025-11-10T00:08:56.3602734Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:244:
2025-11-10T00:08:56.3603534Z                  Ok(handle) => {
2025-11-10T00:08:56.3603950Z                      let result = handle.block_on(timeout(
2025-11-10T00:08:56.3604614Z                          Duration::from_secs(1),
2025-11-10T00:08:56.3605103Z -                        client.request(heartbeat_request)
2025-11-10T00:08:56.3605616Z +                        client.request(heartbeat_request),
2025-11-10T00:08:56.3607442Z                      ));
2025-11-10T00:08:56.3607769Z -                    
2025-11-10T00:08:56.3608060Z +
2025-11-10T00:08:56.3608330Z                      match result {
2025-11-10T00:08:56.3608770Z                          Ok(Ok(_)) => ModuleHealth::Healthy,
2025-11-10T00:08:56.3609293Z                          _ => ModuleHealth::Unresponsive,
2025-11-10T00:08:56.3654028Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/sandbox/process.rs:99:
2025-11-10T00:08:56.3655184Z                  if let Some(max_memory) = limits.max_memory_bytes {
2025-11-10T00:08:56.3655750Z                      let soft_limit = max_memory as u64;
2025-11-10T00:08:56.3656249Z                      let hard_limit = max_memory as u64;
2025-11-10T00:08:56.3656847Z -                    setrlimit(Resource::RLIMIT_AS, soft_limit, hard_limit)
2025-11-10T00:08:56.3657408Z -                        .map_err(|e| {
2025-11-10T00:08:56.3657904Z -                            ModuleError::OperationError(format!(
2025-11-10T00:08:56.3658433Z -                                "Failed to set memory limit: {}",
2025-11-10T00:08:56.3658910Z -                                e
2025-11-10T00:08:56.3659299Z -                            ))
2025-11-10T00:08:56.3659671Z -                        })?;
2025-11-10T00:08:56.3660254Z +                    setrlimit(Resource::RLIMIT_AS, soft_limit, hard_limit).map_err(|e| {
2025-11-10T00:08:56.3661453Z +                        ModuleError::OperationError(format!("Failed to set memory limit: {}", e))
2025-11-10T00:08:56.3662113Z +                    })?;
2025-11-10T00:08:56.3662534Z                      debug!("Set memory limit: {} bytes", max_memory);
2025-11-10T00:08:56.3662998Z                  }
2025-11-10T00:08:56.3663280Z  
2025-11-10T00:08:56.3666132Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/sandbox/process.rs:116:
2025-11-10T00:08:56.3666970Z                      #[cfg(feature = "nix")]
2025-11-10T00:08:56.3667359Z                      {
2025-11-10T00:08:56.3667750Z                          use nix::sys::resource::{setrlimit, Resource};
2025-11-10T00:08:56.3668378Z -                        setrlimit(Resource::RLIMIT_NOFILE, soft_limit, hard_limit)
2025-11-10T00:08:56.3669181Z -                            .map_err(|e| {
2025-11-10T00:08:56.3669827Z +                        setrlimit(Resource::RLIMIT_NOFILE, soft_limit, hard_limit).map_err(
2025-11-10T00:08:56.3670480Z +                            |e| {
2025-11-10T00:08:56.3670946Z                                  ModuleError::OperationError(format!(
2025-11-10T00:08:56.3671954Z                                      "Failed to set file descriptor limit: {}",
2025-11-10T00:08:56.3672477Z                                      e
2025-11-10T00:08:56.3675425Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/sandbox/process.rs:124:
2025-11-10T00:08:56.3676277Z                                  ))
2025-11-10T00:08:56.3676662Z -                            })?;
2025-11-10T00:08:56.3677040Z +                            },
2025-11-10T00:08:56.3677407Z +                        )?;
2025-11-10T00:08:56.3677752Z                      }
2025-11-10T00:08:56.3678110Z                      #[cfg(not(feature = "nix"))]
2025-11-10T00:08:56.3678544Z                      {
2025-11-10T00:08:56.3679266Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/sandbox/process.rs:139:
2025-11-10T00:08:56.3680105Z                      #[cfg(feature = "nix")]
2025-11-10T00:08:56.3680568Z                      let hard_limit = max_children as u64;
2025-11-10T00:08:56.3681035Z                      #[cfg(feature = "nix")]
2025-11-10T00:08:56.3681601Z -                    setrlimit(Resource::RLIMIT_NPROC, soft_limit, hard_limit)
2025-11-10T00:08:56.3682172Z -                        .map_err(|e| {
2025-11-10T00:08:56.3682652Z -                            ModuleError::OperationError(format!(
2025-11-10T00:08:56.3683167Z -                                "Failed to set process limit: {}",
2025-11-10T00:08:56.3685524Z -                                e
2025-11-10T00:08:56.3685906Z -                            ))
2025-11-10T00:08:56.3686262Z -                        })?;
2025-11-10T00:08:56.3686857Z +                    setrlimit(Resource::RLIMIT_NPROC, soft_limit, hard_limit).map_err(|e| {
2025-11-10T00:08:56.3687771Z +                        ModuleError::OperationError(format!("Failed to set process limit: {}", e))
2025-11-10T00:08:56.3688444Z +                    })?;
2025-11-10T00:08:56.3688868Z                      debug!("Set process limit: {}", max_children);
2025-11-10T00:08:56.3689329Z                  }
2025-11-10T00:08:56.3689631Z  
2025-11-10T00:08:56.3690303Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/sandbox/process.rs:191:
2025-11-10T00:08:56.3691211Z                          // Field 23 (index 22): rss - Resident Set Size (pages)
2025-11-10T00:08:56.3691911Z                          let utime: u64 = fields.get(13).and_then(|s| s.parse().ok()).unwrap_or(0);
2025-11-10T00:08:56.3692800Z                          let stime: u64 = fields.get(14).and_then(|s| s.parse().ok()).unwrap_or(0);
2025-11-10T00:08:56.3693611Z -                        let rss_pages: u64 = fields.get(22).and_then(|s| s.parse().ok()).unwrap_or(0);
2025-11-10T00:08:56.3696047Z +                        let rss_pages: u64 =
2025-11-10T00:08:56.3696845Z +                            fields.get(22).and_then(|s| s.parse().ok()).unwrap_or(0);
2025-11-10T00:08:56.3697373Z  
2025-11-10T00:08:56.3697734Z                          // Get page size (typically 4096 bytes on Linux)
2025-11-10T00:08:56.3698261Z                          #[cfg(feature = "libc")]
2025-11-10T00:08:56.3699158Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/security/validator.rs:155:
2025-11-10T00:08:56.3700113Z          let mut limiters = self.rate_limiters.lock().unwrap();
2025-11-10T00:08:56.3700609Z  
2025-11-10T00:08:56.3700942Z          // Get or create rate limiter for this module
2025-11-10T00:08:56.3701416Z -        let limiter = limiters
2025-11-10T00:08:56.3701830Z -            .entry(module_id.to_string())
2025-11-10T00:08:56.3702272Z -            .or_insert_with(|| {
2025-11-10T00:08:56.3703144Z -                RateLimiter::new(self.max_requests_per_second, self.time_window_seconds)
2025-11-10T00:08:56.3705847Z -            });
2025-11-10T00:08:56.3706379Z +        let limiter = limiters.entry(module_id.to_string()).or_insert_with(|| {
2025-11-10T00:08:56.3707224Z +            RateLimiter::new(self.max_requests_per_second, self.time_window_seconds)
2025-11-10T00:08:56.3707845Z +        });
2025-11-10T00:08:56.3708136Z  
2025-11-10T00:08:56.3708407Z          // Check rate limit
2025-11-10T00:08:56.3709076Z          if !limiter.check_rate_limit(self.max_requests_per_second, self.time_window_seconds) {
2025-11-10T00:08:56.3782938Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:104:
2025-11-10T00:08:56.3783968Z      pub fn add_address(&mut self, addr: NetworkAddress, services: u64) {
2025-11-10T00:08:56.3784792Z          // Convert NetworkAddress to SocketAddr for key
2025-11-10T00:08:56.3785370Z          let socket_addr = self.network_addr_to_socket(&addr);
2025-11-10T00:08:56.3785864Z -        
2025-11-10T00:08:56.3786156Z +
2025-11-10T00:08:56.3786476Z          match self.addresses.get_mut(&socket_addr) {
2025-11-10T00:08:56.3786982Z              Some(entry) => {
2025-11-10T00:08:56.3787410Z                  // Update existing entry
2025-11-10T00:08:56.3788211Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:116:
2025-11-10T00:08:56.3789100Z                  if self.addresses.len() >= self.max_addresses {
2025-11-10T00:08:56.3789614Z                      self.evict_oldest();
2025-11-10T00:08:56.3790032Z                  }
2025-11-10T00:08:56.3790582Z -                self.addresses.insert(socket_addr, AddressEntry::new(addr, services));
2025-11-10T00:08:56.3791223Z +                self.addresses
2025-11-10T00:08:56.3791701Z +                    .insert(socket_addr, AddressEntry::new(addr, services));
2025-11-10T00:08:56.3792217Z              }
2025-11-10T00:08:56.3792493Z          }
2025-11-10T00:08:56.3792732Z      }
2025-11-10T00:08:56.3793344Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:136:
2025-11-10T00:08:56.3794203Z              .filter(|entry| entry.is_fresh(self.expiration_seconds))
2025-11-10T00:08:56.3794945Z              .map(|entry| entry.addr.clone())
2025-11-10T00:08:56.3795377Z              .collect();
2025-11-10T00:08:56.3795718Z -        
2025-11-10T00:08:56.3796083Z +
2025-11-10T00:08:56.3796403Z          // Sort by last_seen (most recent first)
2025-11-10T00:08:56.3796862Z          fresh.sort_by_key(|addr| {
2025-11-10T00:08:56.3797339Z              let socket = self.network_addr_to_socket(addr);
2025-11-10T00:08:56.3798202Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:146:
2025-11-10T00:08:56.3798990Z                  .unwrap_or(0)
2025-11-10T00:08:56.3799345Z          });
2025-11-10T00:08:56.3799637Z          fresh.reverse();
2025-11-10T00:08:56.3799965Z -        
2025-11-10T00:08:56.3800232Z +
2025-11-10T00:08:56.3800560Z          fresh.into_iter().take(count).collect()
2025-11-10T00:08:56.3800997Z      }
2025-11-10T00:08:56.3801529Z  
2025-11-10T00:08:56.3802186Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:158:
2025-11-10T00:08:56.3802998Z      /// Remove expired addresses
2025-11-10T00:08:56.3803460Z      pub fn remove_expired(&mut self) -> usize {
2025-11-10T00:08:56.3803966Z          let before = self.addresses.len();
2025-11-10T00:08:56.3804813Z -        self.addresses.retain(|_, entry| entry.is_fresh(self.expiration_seconds));
2025-11-10T00:08:56.3805472Z +        self.addresses
2025-11-10T00:08:56.3805948Z +            .retain(|_, entry| entry.is_fresh(self.expiration_seconds));
2025-11-10T00:08:56.3806530Z          before - self.addresses.len()
2025-11-10T00:08:56.3806915Z      }
2025-11-10T00:08:56.3807169Z  
2025-11-10T00:08:56.3807788Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:196:
2025-11-10T00:08:56.3808831Z                      || ipv4.is_link_local()
2025-11-10T00:08:56.3809291Z                      || ipv4.is_broadcast()
2025-11-10T00:08:56.3809688Z              }
2025-11-10T00:08:56.3810016Z -            IpAddr::V6(ipv6) => {
2025-11-10T00:08:56.3810491Z -                ipv6.is_loopback() || ipv6.is_unspecified()
2025-11-10T00:08:56.3810970Z -            }
2025-11-10T00:08:56.3811422Z +            IpAddr::V6(ipv6) => ipv6.is_loopback() || ipv6.is_unspecified(),
2025-11-10T00:08:56.3811977Z          }
2025-11-10T00:08:56.3812242Z      }
2025-11-10T00:08:56.3812507Z  
2025-11-10T00:08:56.3813152Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:238:
2025-11-10T00:08:56.3816040Z                      ip: [0; 16],
2025-11-10T00:08:56.3816438Z                      port: 0,
2025-11-10T00:08:56.3816796Z                  };
2025-11-10T00:08:56.3817420Z -                self.iroh_addresses.insert(node_id, AddressEntry::new(placeholder_addr, services));
2025-11-10T00:08:56.3818138Z +                self.iroh_addresses
2025-11-10T00:08:56.3818700Z +                    .insert(node_id, AddressEntry::new(placeholder_addr, services));
2025-11-10T00:08:56.3819278Z              }
2025-11-10T00:08:56.3819563Z          }
2025-11-10T00:08:56.3819835Z      }
2025-11-10T00:08:56.3820470Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:252:
2025-11-10T00:08:56.3821393Z              .filter(|(_, entry)| entry.is_fresh(self.expiration_seconds))
2025-11-10T00:08:56.3821964Z              .map(|(node_id, _)| *node_id)
2025-11-10T00:08:56.3822391Z              .collect();
2025-11-10T00:08:56.3823203Z -        
2025-11-10T00:08:56.3823486Z +
2025-11-10T00:08:56.3823796Z          // Sort by last_seen (most recent first)
2025-11-10T00:08:56.3824281Z          fresh.sort_by_key(|node_id| {
2025-11-10T00:08:56.3824915Z              self.iroh_addresses
2025-11-10T00:08:56.3825688Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:261:
2025-11-10T00:08:56.3826486Z                  .unwrap_or(0)
2025-11-10T00:08:56.3826851Z          });
2025-11-10T00:08:56.3827159Z          fresh.reverse();
2025-11-10T00:08:56.3827497Z -        
2025-11-10T00:08:56.3827771Z +
2025-11-10T00:08:56.3828062Z          fresh.into_iter().take(count).collect()
2025-11-10T00:08:56.3828484Z      }
2025-11-10T00:08:56.3828737Z  
2025-11-10T00:08:56.3829390Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:319:
2025-11-10T00:08:56.3830114Z      }
2025-11-10T00:08:56.3830359Z  
2025-11-10T00:08:56.3830646Z      /// Convert NetworkAddress to SocketAddr
2025-11-10T00:08:56.3831039Z -    /// 
2025-11-10T00:08:56.3831295Z +    ///
2025-11-10T00:08:56.3831741Z      /// Note: This is public for use in NetworkManager when connecting to peers.
2025-11-10T00:08:56.3832542Z      pub fn network_addr_to_socket(&self, addr: &NetworkAddress) -> SocketAddr {
2025-11-10T00:08:56.3833161Z          // Convert IPv6 address bytes to SocketAddr
2025-11-10T00:08:56.3833932Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:327:
2025-11-10T00:08:56.3835277Z          let ip = if addr.ip[0..12] == [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0xff, 0xff] {
2025-11-10T00:08:56.3835790Z              // IPv4-mapped IPv6 address
2025-11-10T00:08:56.3836227Z              IpAddr::V4(std::net::Ipv4Addr::new(
2025-11-10T00:08:56.3836699Z -                addr.ip[12], addr.ip[13], addr.ip[14], addr.ip[15],
2025-11-10T00:08:56.3837156Z +                addr.ip[12],
2025-11-10T00:08:56.3837485Z +                addr.ip[13],
2025-11-10T00:08:56.3837844Z +                addr.ip[14],
2025-11-10T00:08:56.3838167Z +                addr.ip[15],
2025-11-10T00:08:56.3838482Z              ))
2025-11-10T00:08:56.3838738Z          } else {
2025-11-10T00:08:56.3839024Z              // Native IPv6
2025-11-10T00:08:56.3840081Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:342:
2025-11-10T00:08:56.3841230Z                  u16::from_be_bytes([addr.ip[14], addr.ip[15]]),
2025-11-10T00:08:56.3841740Z              ];
2025-11-10T00:08:56.3842108Z              IpAddr::V6(std::net::Ipv6Addr::new(
2025-11-10T00:08:56.3842642Z -                segments[0], segments[1], segments[2], segments[3],
2025-11-10T00:08:56.3843219Z -                segments[4], segments[5], segments[6], segments[7],
2025-11-10T00:08:56.3843704Z +                segments[0],
2025-11-10T00:08:56.3844062Z +                segments[1],
2025-11-10T00:08:56.3844612Z +                segments[2],
2025-11-10T00:08:56.3844977Z +                segments[3],
2025-11-10T00:08:56.3845350Z +                segments[4],
2025-11-10T00:08:56.3845717Z +                segments[5],
2025-11-10T00:08:56.3846085Z +                segments[6],
2025-11-10T00:08:56.3846443Z +                segments[7],
2025-11-10T00:08:56.3846796Z              ))
2025-11-10T00:08:56.3847092Z          };
2025-11-10T00:08:56.3847415Z          SocketAddr::new(ip, addr.port)
2025-11-10T00:08:56.3860822Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:406:
2025-11-10T00:08:56.3862201Z          let addr2 = create_test_address("192.168.1.2", 8333);
2025-11-10T00:08:56.3862717Z          db.add_address(addr1.clone(), 1);
2025-11-10T00:08:56.3865189Z          db.add_address(addr2.clone(), 1);
2025-11-10T00:08:56.3865608Z -        
2025-11-10T00:08:56.3865877Z +
2025-11-10T00:08:56.3866192Z          let fresh = db.get_fresh_addresses(10);
2025-11-10T00:08:56.3866644Z          assert_eq!(fresh.len(), 2);
2025-11-10T00:08:56.3867039Z      }
2025-11-10T00:08:56.3867696Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:417:
2025-11-10T00:08:56.3869526Z          let addr = create_test_address("192.168.1.1", 8333);
2025-11-10T00:08:56.3870072Z          db.add_address(addr.clone(), 1);
2025-11-10T00:08:56.3870529Z          assert_eq!(db.len(), 1);
2025-11-10T00:08:56.3870886Z -        
2025-11-10T00:08:56.3871161Z +
2025-11-10T00:08:56.3873574Z          // Wait for expiration
2025-11-10T00:08:56.3874071Z          std::thread::sleep(std::time::Duration::from_secs(2));
2025-11-10T00:08:56.3874770Z -        
2025-11-10T00:08:56.3875042Z +
2025-11-10T00:08:56.3875360Z          let fresh = db.get_fresh_addresses(10);
2025-11-10T00:08:56.3875862Z          assert_eq!(fresh.len(), 0); // Should be expired
2025-11-10T00:08:56.3876304Z      }
2025-11-10T00:08:56.3876925Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:433:
2025-11-10T00:08:56.3877717Z          db.add_address(addr1.clone(), 1);
2025-11-10T00:08:56.3878170Z          db.add_address(addr2.clone(), 1);
2025-11-10T00:08:56.3878599Z          assert_eq!(db.len(), 2);
2025-11-10T00:08:56.3878972Z -        
2025-11-10T00:08:56.3879223Z +
2025-11-10T00:08:56.3879497Z          // Wait for expiration
2025-11-10T00:08:56.3879984Z          std::thread::sleep(std::time::Duration::from_secs(2));
2025-11-10T00:08:56.3880494Z -        
2025-11-10T00:08:56.3880763Z +
2025-11-10T00:08:56.3881073Z          let removed = db.remove_expired();
2025-11-10T00:08:56.3881792Z          assert_eq!(removed, 2);
2025-11-10T00:08:56.3882620Z          assert_eq!(db.len(), 0);
2025-11-10T00:08:56.3885286Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:448:
2025-11-10T00:08:56.3886188Z          let localhost = create_test_address("127.0.0.1", 8333);
2025-11-10T00:08:56.3886799Z          let private = create_test_address("192.168.1.1", 8333);
2025-11-10T00:08:56.3887356Z          let public = create_test_address("8.8.8.8", 8333);
2025-11-10T00:08:56.3887837Z -        
2025-11-10T00:08:56.3888224Z +
2025-11-10T00:08:56.3888528Z          assert!(db.is_local(&localhost));
2025-11-10T00:08:56.3888982Z          assert!(db.is_local(&private));
2025-11-10T00:08:56.3889446Z          assert!(!db.is_local(&public));
2025-11-10T00:08:56.3890490Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:460:
2025-11-10T00:08:56.3891471Z          let addr = create_test_address("192.168.1.1", 8333);
2025-11-10T00:08:56.3892139Z          let socket = SocketAddr::new("192.168.1.1".parse().unwrap(), 8333);
2025-11-10T00:08:56.3892744Z          let mut ban_list = HashMap::new();
2025-11-10T00:08:56.3893182Z -        
2025-11-10T00:08:56.3893450Z +
2025-11-10T00:08:56.3895662Z          // Not banned
2025-11-10T00:08:56.3896044Z          assert!(!db.is_banned(&addr, &ban_list));
2025-11-10T00:08:56.3896497Z -        
2025-11-10T00:08:56.3896774Z +
2025-11-10T00:08:56.3897055Z          // Banned (permanent)
2025-11-10T00:08:56.3897484Z          ban_list.insert(socket, u64::MAX);
2025-11-10T00:08:56.3897955Z          assert!(db.is_banned(&addr, &ban_list));
2025-11-10T00:08:56.3898785Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:470:
2025-11-10T00:08:56.3900059Z -        
2025-11-10T00:08:56.3900348Z +
2025-11-10T00:08:56.3900660Z          // Banned (temporary, not expired)
2025-11-10T00:08:56.3901116Z          ban_list.clear();
2025-11-10T00:08:56.3901559Z          let future_time = std::time::SystemTime::now()
2025-11-10T00:08:56.3902388Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:474:
2025-11-10T00:08:56.3905394Z              .duration_since(std::time::UNIX_EPOCH)
2025-11-10T00:08:56.3905844Z              .unwrap()
2025-11-10T00:08:56.3906166Z -            .as_secs() + 3600;
2025-11-10T00:08:56.3906530Z +            .as_secs()
2025-11-10T00:08:56.3906855Z +            + 3600;
2025-11-10T00:08:56.3907216Z          ban_list.insert(socket, future_time);
2025-11-10T00:08:56.3907712Z          assert!(db.is_banned(&addr, &ban_list));
2025-11-10T00:08:56.3908152Z -        
2025-11-10T00:08:56.3908417Z +
2025-11-10T00:08:56.3908695Z          // Banned (expired)
2025-11-10T00:08:56.3909067Z          ban_list.clear();
2025-11-10T00:08:56.3909494Z          let past_time = std::time::SystemTime::now()
2025-11-10T00:08:56.3910340Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:483:
2025-11-10T00:08:56.3911148Z              .duration_since(std::time::UNIX_EPOCH)
2025-11-10T00:08:56.3911567Z              .unwrap()
2025-11-10T00:08:56.3911882Z -            .as_secs() - 3600;
2025-11-10T00:08:56.3912226Z +            .as_secs()
2025-11-10T00:08:56.3912523Z +            - 3600;
2025-11-10T00:08:56.3912868Z          ban_list.insert(socket, past_time);
2025-11-10T00:08:56.3913343Z          assert!(!db.is_banned(&addr, &ban_list));
2025-11-10T00:08:56.3913765Z      }
2025-11-10T00:08:56.3914566Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:493:
2025-11-10T00:08:56.3915406Z          let local = create_test_address("127.0.0.1", 8333);
2025-11-10T00:08:56.3915968Z          let banned = create_test_address("192.168.1.1", 8333);
2025-11-10T00:08:56.3916537Z          let public = create_test_address("8.8.8.8", 8333);
2025-11-10T00:08:56.3917009Z -        
2025-11-10T00:08:56.3917277Z +
2025-11-10T00:08:56.3918025Z          let socket_banned = SocketAddr::new("192.168.1.1".parse().unwrap(), 8333);
2025-11-10T00:08:56.3918835Z          let socket_connected = SocketAddr::new("8.8.8.8".parse().unwrap(), 8333);
2025-11-10T00:08:56.3919490Z          let mut ban_list = HashMap::new();
2025-11-10T00:08:56.3920292Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:500:
2025-11-10T00:08:56.3921151Z          ban_list.insert(socket_banned, u64::MAX);
2025-11-10T00:08:56.3921683Z          let connected_peers = vec![socket_connected];
2025-11-10T00:08:56.3922144Z -        
2025-11-10T00:08:56.3922430Z +
2025-11-10T00:08:56.3922764Z          let addresses = vec![local, banned, public];
2025-11-10T00:08:56.3923458Z          let filtered = db.filter_addresses(addresses, &ban_list, &connected_peers);
2025-11-10T00:08:56.3924086Z -        
2025-11-10T00:08:56.3924548Z +
2025-11-10T00:08:56.3925141Z          // Should filter out local, banned, and connected
2025-11-10T00:08:56.3925702Z          assert_eq!(filtered.len(), 0);
2025-11-10T00:08:56.3926115Z      }
2025-11-10T00:08:56.3926789Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:513:
2025-11-10T00:08:56.3927642Z          let addr1 = create_test_address("192.168.1.1", 8333);
2025-11-10T00:08:56.3928206Z          let addr2 = create_test_address("192.168.1.2", 8333);
2025-11-10T00:08:56.3928767Z          let addr3 = create_test_address("192.168.1.3", 8333);
2025-11-10T00:08:56.3929222Z -        
2025-11-10T00:08:56.3929499Z +
2025-11-10T00:08:56.3929801Z          db.add_address(addr1.clone(), 1);
2025-11-10T00:08:56.3930268Z          db.add_address(addr2.clone(), 1);
2025-11-10T00:08:56.3930706Z          assert_eq!(db.len(), 2);
2025-11-10T00:08:56.3931482Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:520:
2025-11-10T00:08:56.3932269Z -        
2025-11-10T00:08:56.3932550Z +
2025-11-10T00:08:56.3932858Z          // Adding third should evict oldest
2025-11-10T00:08:56.3933336Z          db.add_address(addr3.clone(), 1);
2025-11-10T00:08:56.3933816Z          assert_eq!(db.len(), 2); // Should still be 2
2025-11-10T00:08:56.3934841Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:528:
2025-11-10T00:08:56.3935665Z      fn test_add_iroh_address() {
2025-11-10T00:08:56.3936100Z          use iroh_net::NodeId;
2025-11-10T00:08:56.3936529Z          let mut db = AddressDatabase::new(100);
2025-11-10T00:08:56.3936965Z -        
2025-11-10T00:08:56.3937230Z +
2025-11-10T00:08:56.3937528Z          // Create a test NodeId (32 bytes)
2025-11-10T00:08:56.3937973Z          let node_id_bytes = [0u8; 32];
2025-11-10T00:08:56.3938503Z          let node_id = NodeId::from_bytes(&node_id_bytes).unwrap();
2025-11-10T00:08:56.3939388Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:535:
2025-11-10T00:08:56.3940168Z -        
2025-11-10T00:08:56.3940440Z +
2025-11-10T00:08:56.3940726Z          db.add_iroh_address(node_id, 1);
2025-11-10T00:08:56.3941185Z          assert_eq!(db.total_count(), 1);
2025-11-10T00:08:56.3941589Z -        
2025-11-10T00:08:56.3941861Z +
2025-11-10T00:08:56.3942238Z          // Add same address again (should update, not duplicate)
2025-11-10T00:08:56.3942780Z          db.add_iroh_address(node_id, 2);
2025-11-10T00:08:56.3943232Z          assert_eq!(db.total_count(), 1);
2025-11-10T00:08:56.3944029Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:546:
2025-11-10T00:08:56.3945039Z      fn test_get_fresh_iroh_addresses() {
2025-11-10T00:08:56.3947397Z          use iroh_net::NodeId;
2025-11-10T00:08:56.3947838Z          let mut db = AddressDatabase::new(100);
2025-11-10T00:08:56.3948281Z -        
2025-11-10T00:08:56.3948554Z +
2025-11-10T00:08:56.3948849Z          let node_id1_bytes = [1u8; 32];
2025-11-10T00:08:56.3949299Z          let node_id2_bytes = [2u8; 32];
2025-11-10T00:08:56.3949846Z          let node_id1 = NodeId::from_bytes(&node_id1_bytes).unwrap();
2025-11-10T00:08:56.3951014Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:553:
2025-11-10T00:08:56.3951935Z          let node_id2 = NodeId::from_bytes(&node_id2_bytes).unwrap();
2025-11-10T00:08:56.3952872Z -        
2025-11-10T00:08:56.3953181Z +
2025-11-10T00:08:56.3953479Z          db.add_iroh_address(node_id1, 1);
2025-11-10T00:08:56.3953943Z          db.add_iroh_address(node_id2, 1);
2025-11-10T00:08:56.3954548Z -        
2025-11-10T00:08:56.3954821Z +
2025-11-10T00:08:56.3955153Z          let fresh = db.get_fresh_iroh_addresses(10);
2025-11-10T00:08:56.3955637Z          assert_eq!(fresh.len(), 2);
2025-11-10T00:08:56.3957967Z      }
2025-11-10T00:08:56.3958610Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:564:
2025-11-10T00:08:56.3959675Z      fn test_total_count_includes_iroh() {
2025-11-10T00:08:56.3960152Z          use iroh_net::NodeId;
2025-11-10T00:08:56.3960590Z          let mut db = AddressDatabase::new(100);
2025-11-10T00:08:56.3961025Z -        
2025-11-10T00:08:56.3961287Z +
2025-11-10T00:08:56.3961572Z          // Add SocketAddr address
2025-11-10T00:08:56.3962037Z          let addr = create_test_address("192.168.1.1", 8333);
2025-11-10T00:08:56.3962177Z          db.add_address(addr, 1);
2025-11-10T00:08:56.3962684Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:571:
2025-11-10T00:08:56.3962839Z          assert_eq!(db.total_count(), 1);
2025-11-10T00:08:56.3962950Z -        
2025-11-10T00:08:56.3963065Z +
2025-11-10T00:08:56.3963195Z          // Add Iroh address
2025-11-10T00:08:56.3963340Z          let node_id_bytes = [0u8; 32];
2025-11-10T00:08:56.3963578Z          let node_id = NodeId::from_bytes(&node_id_bytes).unwrap();
2025-11-10T00:08:56.3965988Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:15:
2025-11-10T00:08:56.3966151Z  /// - Combine reasons from all sources
2025-11-10T00:08:56.3966466Z  pub fn merge_ban_lists(ban_lists: Vec<&BanListMessage>) -> Vec<BanEntry> {
2025-11-10T00:08:56.3966768Z      let mut merged: HashMap<NetworkAddress, BanEntry> = HashMap::new();
2025-11-10T00:08:56.3966871Z -    
2025-11-10T00:08:56.3966971Z +
2025-11-10T00:08:56.3967111Z      for ban_list in ban_lists {
2025-11-10T00:08:56.3967238Z          if !ban_list.is_full {
2025-11-10T00:08:56.3967403Z              continue; // Skip hash-only responses
2025-11-10T00:08:56.3967928Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:22:
2025-11-10T00:08:56.3968052Z          }
2025-11-10T00:08:56.3968156Z -        
2025-11-10T00:08:56.3968256Z +
2025-11-10T00:08:56.3968420Z          for entry in &ban_list.ban_entries {
2025-11-10T00:08:56.3968568Z              let addr = entry.addr.clone();
2025-11-10T00:08:56.3968673Z -            
2025-11-10T00:08:56.3968782Z +
2025-11-10T00:08:56.3968935Z              match merged.get_mut(&addr) {
2025-11-10T00:08:56.3969075Z                  Some(existing) => {
2025-11-10T00:08:56.3969245Z                      // Conflict resolution: use longest ban
2025-11-10T00:08:56.3969757Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:36:
2025-11-10T00:08:56.3969970Z                              existing.unban_timestamp = entry.unban_timestamp;
2025-11-10T00:08:56.3970080Z                          }
2025-11-10T00:08:56.3970194Z                      }
2025-11-10T00:08:56.3970302Z -                    
2025-11-10T00:08:56.3970403Z +
2025-11-10T00:08:56.3970531Z                      // Merge reasons
2025-11-10T00:08:56.3970718Z                      if let Some(ref reason) = entry.reason {
2025-11-10T00:08:56.3970967Z -                        existing.reason = existing.reason.as_ref().map(|r| {
2025-11-10T00:08:56.3971132Z -                            format!("{}; {}", r, reason)
2025-11-10T00:08:56.3971304Z -                        }).or_else(|| Some(reason.clone()));
2025-11-10T00:08:56.3971690Z +                        existing.reason = existing
2025-11-10T00:08:56.3971808Z +                            .reason
2025-11-10T00:08:56.3971926Z +                            .as_ref()
2025-11-10T00:08:56.3972103Z +                            .map(|r| format!("{}; {}", r, reason))
2025-11-10T00:08:56.3972266Z +                            .or_else(|| Some(reason.clone()));
2025-11-10T00:08:56.3972372Z                      }
2025-11-10T00:08:56.3972492Z                  }
2025-11-10T00:08:56.3972891Z                  None => {
2025-11-10T00:08:56.3973441Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:50:
2025-11-10T00:08:56.3973565Z              }
2025-11-10T00:08:56.3973676Z          }
2025-11-10T00:08:56.3975877Z      }
2025-11-10T00:08:56.3975992Z -    
2025-11-10T00:08:56.3976109Z +
2025-11-10T00:08:56.3976526Z      // Convert to sorted vector
2025-11-10T00:08:56.3976820Z      let mut result: Vec<BanEntry> = merged.into_values().collect();
2025-11-10T00:08:56.3976968Z      result.sort_by(|a, b| {
2025-11-10T00:08:56.3977518Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:57:
2025-11-10T00:08:56.3977701Z          // Sort by address for deterministic output
2025-11-10T00:08:56.3977845Z -        a.addr.ip.cmp(&b.addr.ip)
2025-11-10T00:08:56.3977968Z +        a.addr
2025-11-10T00:08:56.3978082Z +            .ip
2025-11-10T00:08:56.3978210Z +            .cmp(&b.addr.ip)
2025-11-10T00:08:56.3978415Z              .then_with(|| a.addr.port.cmp(&b.addr.port))
2025-11-10T00:08:56.3978523Z      });
2025-11-10T00:08:56.3978628Z -    
2025-11-10T00:08:56.3978734Z +
2025-11-10T00:08:56.3978853Z      result
2025-11-10T00:08:56.3978959Z  }
2025-11-10T00:08:56.3979065Z  
2025-11-10T00:08:56.3979606Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:72:
2025-11-10T00:08:56.3979771Z              .duration_since(UNIX_EPOCH)
2025-11-10T00:08:56.3979900Z              .unwrap()
2025-11-10T00:08:56.3980020Z              .as_secs();
2025-11-10T00:08:56.3980137Z -        
2025-11-10T00:08:56.3980245Z +
2025-11-10T00:08:56.3980407Z          if now >= entry.unban_timestamp {
2025-11-10T00:08:56.3980580Z              return false; // Ban already expired
2025-11-10T00:08:56.3980692Z          }
2025-11-10T00:08:56.3981226Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:79:
2025-11-10T00:08:56.3981336Z      }
2025-11-10T00:08:56.3981450Z -    
2025-11-10T00:08:56.3981551Z +
2025-11-10T00:08:56.3981716Z      // Additional validation could include:
2025-11-10T00:08:56.3981873Z      // - IP address format validation
2025-11-10T00:08:56.3982003Z      // - Reason length limits
2025-11-10T00:08:56.3982531Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:84:
2025-11-10T00:08:56.3982658Z      // - etc.
2025-11-10T00:08:56.3982773Z -    
2025-11-10T00:08:56.3982887Z +
2025-11-10T00:08:56.3982999Z      true
2025-11-10T00:08:56.3983111Z  }
2025-11-10T00:08:56.3983217Z  
2025-11-10T00:08:56.3983743Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:89:
2025-11-10T00:08:56.3983926Z  /// Calculate hash of ban list (for verification)
2025-11-10T00:08:56.3984208Z  pub fn calculate_ban_list_hash(entries: &[BanEntry]) -> [u8; 32] {
2025-11-10T00:08:56.3986373Z -    use sha2::{Sha256, Digest};
2025-11-10T00:08:56.3986492Z -    
2025-11-10T00:08:56.3986641Z +    use sha2::{Digest, Sha256};
2025-11-10T00:08:56.3986748Z +
2025-11-10T00:08:56.3986910Z      // Sort entries for deterministic hashing
2025-11-10T00:08:56.3987052Z      let mut sorted = entries.to_vec();
2025-11-10T00:08:56.3987195Z      sorted.sort_by(|a, b| {
2025-11-10T00:08:56.3987734Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:96:
2025-11-10T00:08:56.3987882Z -        a.addr.ip.cmp(&b.addr.ip)
2025-11-10T00:08:56.3988221Z +        a.addr
2025-11-10T00:08:56.3988329Z +            .ip
2025-11-10T00:08:56.3988451Z +            .cmp(&b.addr.ip)
2025-11-10T00:08:56.3988638Z              .then_with(|| a.addr.port.cmp(&b.addr.port))
2025-11-10T00:08:56.3988755Z      });
2025-11-10T00:08:56.3988858Z -    
2025-11-10T00:08:56.3988962Z +
2025-11-10T00:08:56.3989103Z      // Serialize and hash
2025-11-10T00:08:56.3989408Z      let serialized = bincode::serialize(&sorted).unwrap_or_default();
2025-11-10T00:08:56.3989576Z      let hash = Sha256::digest(&serialized);
2025-11-10T00:08:56.3990137Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:103:
2025-11-10T00:08:56.3990246Z -    
2025-11-10T00:08:56.3990352Z +
2025-11-10T00:08:56.3990487Z      let mut result = [0u8; 32];
2025-11-10T00:08:56.3990647Z      result.copy_from_slice(&hash);
2025-11-10T00:08:56.3990981Z      result
2025-11-10T00:08:56.3991548Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:111:
2025-11-10T00:08:56.3991782Z      let calculated = calculate_ban_list_hash(entries);
2025-11-10T00:08:56.3991927Z      calculated == *expected_hash
2025-11-10T00:08:56.3992037Z  }
2025-11-10T00:08:56.3992142Z -
2025-11-10T00:08:56.3992253Z -
2025-11-10T00:08:56.3992353Z -
2025-11-10T00:08:56.3992448Z  
2025-11-10T00:08:56.3992993Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_signing.rs:2:
2025-11-10T00:08:56.3993112Z  //!
2025-11-10T00:08:56.3993416Z  //! Provides functions to sign and verify ban lists for authenticity.
2025-11-10T00:08:56.3993521Z  
2025-11-10T00:08:56.3993782Z -use crate::network::protocol::{BanListMessage, BanEntry};
2025-11-10T00:08:56.3994132Z -use secp256k1::{Secp256k1, Message, ecdsa::Signature, SecretKey, PublicKey};
2025-11-10T00:08:56.3994548Z +use crate::network::protocol::{BanEntry, BanListMessage};
2025-11-10T00:08:56.3994924Z +use secp256k1::{ecdsa::Signature, Message, PublicKey, Secp256k1, SecretKey};
2025-11-10T00:08:56.3995038Z  
2025-11-10T00:08:56.3995197Z  /// Sign a ban list with a private key
2025-11-10T00:08:56.3995303Z  ///
2025-11-10T00:08:56.3995849Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_signing.rs:13:
2025-11-10T00:08:56.3995996Z      private_key: &SecretKey,
2025-11-10T00:08:56.3996160Z  ) -> Result<Vec<u8>, secp256k1::Error> {
2025-11-10T00:08:56.3996313Z      let secp = Secp256k1::new();
2025-11-10T00:08:56.3996423Z -    
2025-11-10T00:08:56.3996533Z +
2025-11-10T00:08:56.3996684Z      // Serialize ban list for signing
2025-11-10T00:08:56.3996890Z -    let serialized = bincode::serialize(ban_list)
2025-11-10T00:08:56.3997089Z -        .map_err(|_| secp256k1::Error::InvalidMessage)?;
2025-11-10T00:08:56.3997199Z -    
2025-11-10T00:08:56.3998095Z +    let serialized = bincode::serialize(ban_list).map_err(|_| secp256k1::Error::InvalidMessage)?;
2025-11-10T00:08:56.3998218Z +
2025-11-10T00:08:56.3998367Z      // Hash the serialized data
2025-11-10T00:08:56.3998519Z -    use sha2::{Sha256, Digest};
2025-11-10T00:08:56.3998657Z +    use sha2::{Digest, Sha256};
2025-11-10T00:08:56.3998822Z      let hash = Sha256::digest(&serialized);
2025-11-10T00:08:56.3998927Z -    
2025-11-10T00:08:56.3999037Z +
2025-11-10T00:08:56.3999173Z      // Create message from hash
2025-11-10T00:08:56.3999346Z -    let message = Message::from_slice(&hash)
2025-11-10T00:08:56.3999554Z -        .map_err(|_| secp256k1::Error::InvalidMessage)?;
2025-11-10T00:08:56.3999663Z -    
2025-11-10T00:08:56.4000061Z +    let message = Message::from_slice(&hash).map_err(|_| secp256k1::Error::InvalidMessage)?;
2025-11-10T00:08:56.4000169Z +
2025-11-10T00:08:56.4000284Z      // Sign
2025-11-10T00:08:56.4000521Z      let signature = secp.sign_ecdsa(&message, private_key);
2025-11-10T00:08:56.4000628Z -    
2025-11-10T00:08:56.4000735Z +
2025-11-10T00:08:56.4000878Z      // Serialize signature
2025-11-10T00:08:56.4001061Z      Ok(signature.serialize_compact().to_vec())
2025-11-10T00:08:56.4001431Z  }
2025-11-10T00:08:56.4001988Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_signing.rs:44:
2025-11-10T00:08:56.4002133Z      if signature.len() != 64 {
2025-11-10T00:08:56.4002261Z          return Ok(false);
2025-11-10T00:08:56.4002375Z      }
2025-11-10T00:08:56.4002473Z -    
2025-11-10T00:08:56.4002568Z +
2025-11-10T00:08:56.4002718Z      let secp = Secp256k1::new();
2025-11-10T00:08:56.4002835Z -    
2025-11-10T00:08:56.4002941Z +
2025-11-10T00:08:56.4003060Z      // Serialize ban list
2025-11-10T00:08:56.4004843Z -    let serialized = bincode::serialize(ban_list)
2025-11-10T00:08:56.4005033Z -        .map_err(|_| secp256k1::Error::InvalidMessage)?;
2025-11-10T00:08:56.4005129Z -    
2025-11-10T00:08:56.4005575Z +    let serialized = bincode::serialize(ban_list).map_err(|_| secp256k1::Error::InvalidMessage)?;
2025-11-10T00:08:56.4005694Z +
2025-11-10T00:08:56.4006054Z      // Hash the serialized data
2025-11-10T00:08:56.4006211Z -    use sha2::{Sha256, Digest};
2025-11-10T00:08:56.4006357Z +    use sha2::{Digest, Sha256};
2025-11-10T00:08:56.4006523Z      let hash = Sha256::digest(&serialized);
2025-11-10T00:08:56.4006630Z -    
2025-11-10T00:08:56.4006741Z +
2025-11-10T00:08:56.4006887Z      // Create message from hash
2025-11-10T00:08:56.4007048Z -    let message = Message::from_slice(&hash)
2025-11-10T00:08:56.4007233Z -        .map_err(|_| secp256k1::Error::InvalidMessage)?;
2025-11-10T00:08:56.4007349Z -    
2025-11-10T00:08:56.4007737Z +    let message = Message::from_slice(&hash).map_err(|_| secp256k1::Error::InvalidMessage)?;
2025-11-10T00:08:56.4007840Z +
2025-11-10T00:08:56.4007973Z      // Parse signature
2025-11-10T00:08:56.4008170Z -    let sig = Signature::from_compact(signature)
2025-11-10T00:08:56.4008376Z -        .map_err(|_| secp256k1::Error::InvalidSignature)?;
2025-11-10T00:08:56.4008482Z -    
2025-11-10T00:08:56.4008937Z +    let sig = Signature::from_compact(signature).map_err(|_| secp256k1::Error::InvalidSignature)?;
2025-11-10T00:08:56.4009052Z +
2025-11-10T00:08:56.4009165Z      // Verify
2025-11-10T00:08:56.4009401Z      Ok(secp.verify_ecdsa(&message, &sig, public_key).is_ok())
2025-11-10T00:08:56.4009519Z  }
2025-11-10T00:08:56.4010061Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_signing.rs:86:
2025-11-10T00:08:56.4010231Z      ) -> Result<Self, secp256k1::Error> {
2025-11-10T00:08:56.4010391Z          let secp = Secp256k1::new();
2025-11-10T00:08:56.4010679Z          let public_key = PublicKey::from_secret_key(&secp, private_key);
2025-11-10T00:08:56.4010791Z -        
2025-11-10T00:08:56.4010905Z +
2025-11-10T00:08:56.4011139Z          let signature = sign_ban_list(&ban_list, private_key)?;
2025-11-10T00:08:56.4011251Z -        
2025-11-10T00:08:56.4011361Z +
2025-11-10T00:08:56.4011488Z          Ok(Self {
2025-11-10T00:08:56.4011607Z              ban_list,
2025-11-10T00:08:56.4011738Z              signature,
2025-11-10T00:08:56.4012289Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_signing.rs:95:
2025-11-10T00:08:56.4012429Z              public_key,
2025-11-10T00:08:56.4012540Z          })
2025-11-10T00:08:56.4012651Z      }
2025-11-10T00:08:56.4012770Z -    
2025-11-10T00:08:56.4012878Z +
2025-11-10T00:08:56.4013016Z      /// Verify the signature
2025-11-10T00:08:56.4013271Z      pub fn verify(&self) -> Result<bool, secp256k1::Error> {
2025-11-10T00:08:56.4013636Z          verify_ban_list_signature(&self.ban_list, &self.signature, &self.public_key)
2025-11-10T00:08:56.4014171Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_signing.rs:102:
2025-11-10T00:08:56.4014293Z      }
2025-11-10T00:08:56.4014549Z  }
2025-11-10T00:08:56.4014659Z -
2025-11-10T00:08:56.4014769Z -
2025-11-10T00:08:56.4014883Z  
2025-11-10T00:08:56.4015409Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:4:
2025-11-10T00:08:56.4015564Z  //! using the BlockFilterService.
2025-11-10T00:08:56.4015932Z  
2025-11-10T00:08:56.4016197Z  use crate::network::filter_service::BlockFilterService;
2025-11-10T00:08:56.4016342Z -use crate::storage::Storage;
2025-11-10T00:08:56.4016483Z  use crate::network::protocol::{
2025-11-10T00:08:56.4016956Z      CfcheckptMessage, CfheadersMessage, CfilterMessage, FilterHeaderData, GetCfcheckptMessage,
2025-11-10T00:08:56.4017223Z      GetCfheadersMessage, GetCfiltersMessage, ProtocolMessage,
2025-11-10T00:08:56.4017730Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:11:
2025-11-10T00:08:56.4017842Z  };
2025-11-10T00:08:56.4017974Z +use crate::storage::Storage;
2025-11-10T00:08:56.4018108Z  use anyhow::{anyhow, Result};
2025-11-10T00:08:56.4018238Z  use bllvm_protocol::Hash;
2025-11-10T00:08:56.4018361Z  use std::sync::Arc;
2025-11-10T00:08:56.4019054Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:30:
2025-11-10T00:08:56.4019251Z          // Get current height to determine stop height
2025-11-10T00:08:56.4019570Z          let current_height = storage.chain().get_height()?.unwrap_or(0) as u32;
2025-11-10T00:08:56.4019738Z          let start_height = request.start_height;
2025-11-10T00:08:56.4019860Z -        
2025-11-10T00:08:56.4019976Z +
2025-11-10T00:08:56.4020253Z          // Find stop height by iterating from start until we find stop_hash
2025-11-10T00:08:56.4020407Z          let mut stop_height = start_height;
2025-11-10T00:08:56.4020545Z          let mut found_stop = false;
2025-11-10T00:08:56.4021043Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:37:
2025-11-10T00:08:56.4021145Z -        
2025-11-10T00:08:56.4021244Z +
2025-11-10T00:08:56.4021415Z          // Iterate through blocks from start_height
2025-11-10T00:08:56.4021711Z          for height in start_height..=current_height.min(start_height + 2000) {
2025-11-10T00:08:56.4021878Z              // Get block hash by height, then get block
2025-11-10T00:08:56.4022380Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:41:
2025-11-10T00:08:56.4022708Z              if let Ok(Some(block_hash)) = storage.blocks().get_hash_by_height(height as u64) {
2025-11-10T00:08:56.4022958Z                  if let Ok(Some(block)) = storage.blocks().get_block(&block_hash) {
2025-11-10T00:08:56.4023073Z -                
2025-11-10T00:08:56.4023232Z                      // Calculate block hash properly
2025-11-10T00:08:56.4023417Z                      use crate::storage::hashing::double_sha256;
2025-11-10T00:08:56.4023578Z                      let mut header_data = Vec::new();
2025-11-10T00:08:56.4024065Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:51:
2025-11-10T00:08:56.4024497Z                      header_data.extend_from_slice(&block.header.bits.to_le_bytes());
2025-11-10T00:08:56.4024813Z                      header_data.extend_from_slice(&block.header.nonce.to_le_bytes());
2025-11-10T00:08:56.4025029Z                      let calculated_hash = double_sha256(&header_data);
2025-11-10T00:08:56.4025137Z -                    
2025-11-10T00:08:56.4025239Z +
2025-11-10T00:08:56.4025401Z                      // Check if this is the stop hash
2025-11-10T00:08:56.4025583Z                      if calculated_hash == request.stop_hash {
2025-11-10T00:08:56.4025722Z                          found_stop = true;
2025-11-10T00:08:56.4026225Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:58:
2025-11-10T00:08:56.4026368Z                          stop_height = height;
2025-11-10T00:08:56.4026478Z                      }
2025-11-10T00:08:56.4026584Z -                    
2025-11-10T00:08:56.4026693Z +
2025-11-10T00:08:56.4026838Z                      // Try to get cached filter
2025-11-10T00:08:56.4027181Z                      let filter = if let Some(cached) = filter_service.get_filter(&calculated_hash) {
2025-11-10T00:08:56.4027540Z                          cached
2025-11-10T00:08:56.4029538Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:72:
2025-11-10T00:08:56.4029653Z                                  }
2025-11-10T00:08:56.4029767Z                              }
2025-11-10T00:08:56.4029873Z                          }
2025-11-10T00:08:56.4029976Z -                        
2025-11-10T00:08:56.4030072Z +
2025-11-10T00:08:56.4030415Z                          filter_service.generate_and_cache_filter(&block, &prev_scripts, height)?
2025-11-10T00:08:56.4030523Z                      };
2025-11-10T00:08:56.4030631Z -                    
2025-11-10T00:08:56.4030743Z +
2025-11-10T00:08:56.4031027Z                      responses.push(ProtocolMessage::Cfilter(CfilterMessage {
2025-11-10T00:08:56.4031170Z                          filter_type: 0,
2025-11-10T00:08:56.4031539Z                          block_hash: calculated_hash,
2025-11-10T00:08:56.4032077Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:82:
2025-11-10T00:08:56.4032255Z                          filter_data: filter.filter_data,
2025-11-10T00:08:56.4032427Z                          num_elements: filter.num_elements,
2025-11-10T00:08:56.4032553Z                      }));
2025-11-10T00:08:56.4032663Z -                    
2025-11-10T00:08:56.4032770Z +
2025-11-10T00:08:56.4032916Z                      if found_stop {
2025-11-10T00:08:56.4033037Z                          break;
2025-11-10T00:08:56.4033148Z                      }
2025-11-10T00:08:56.4033795Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:89:
2025-11-10T00:08:56.4033921Z                  }
2025-11-10T00:08:56.4034026Z              }
2025-11-10T00:08:56.4034133Z          }
2025-11-10T00:08:56.4034247Z -        
2025-11-10T00:08:56.4034565Z +
2025-11-10T00:08:56.4034868Z          if !found_stop && stop_height < current_height {
2025-11-10T00:08:56.4035145Z              // Stop hash not found in reasonable range, return what we have
2025-11-10T00:08:56.4035272Z          }
2025-11-10T00:08:56.4035783Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip70_handler.rs:3:
2025-11-10T00:08:56.4036029Z  //! Handles incoming BIP70 messages from the P2P network.
2025-11-10T00:08:56.4036202Z  //! Similar to bip157_handler.rs pattern.
2025-11-10T00:08:56.4036309Z  
2025-11-10T00:08:56.4036887Z -use bllvm_protocol::payment::{Bip70Error, PaymentProtocolClient, PaymentProtocolServer, PaymentRequest};
2025-11-10T00:08:56.4037052Z  use crate::network::protocol::{
2025-11-10T00:08:56.4037516Z      GetPaymentRequestMessage, PaymentACKMessage, PaymentMessage, PaymentRequestMessage,
2025-11-10T00:08:56.4037735Z      ProtocolMessage,
2025-11-10T00:08:56.4038249Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip70_handler.rs:10:
2025-11-10T00:08:56.4038372Z  };
2025-11-10T00:08:56.4038506Z  use anyhow::Result;
2025-11-10T00:08:56.4038664Z +use bllvm_protocol::payment::{
2025-11-10T00:08:56.4039056Z +    Bip70Error, PaymentProtocolClient, PaymentProtocolServer, PaymentRequest,
2025-11-10T00:08:56.4039163Z +};
2025-11-10T00:08:56.4039277Z +use hex;
2025-11-10T00:08:56.4039425Z  use std::collections::HashMap;
2025-11-10T00:08:56.4039570Z  use std::sync::{Arc, Mutex};
2025-11-10T00:08:56.4039680Z -use hex;
2025-11-10T00:08:56.4039789Z  
2025-11-10T00:08:56.4040246Z  /// In-memory payment request store (simplified - would use persistent storage in production)
2025-11-10T00:08:56.4040596Z  type PaymentRequestStore = Arc<Mutex<HashMap<String, PaymentRequest>>>;
2025-11-10T00:08:56.4041105Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip70_handler.rs:25:
2025-11-10T00:08:56.4041269Z  ) -> Result<PaymentRequestMessage> {
2025-11-10T00:08:56.4041425Z      if let Some(store) = payment_store {
2025-11-10T00:08:56.4041592Z          let store = store.lock().unwrap();
2025-11-10T00:08:56.4042031Z -        let key = format!("{}_{}", hex::encode(&request.payment_id), hex::encode(&request.merchant_pubkey));
2025-11-10T00:08:56.4042412Z +        let key = format!(
2025-11-10T00:08:56.4042527Z +            "{}_{}",
2025-11-10T00:08:56.4042701Z +            hex::encode(&request.payment_id),
2025-11-10T00:08:56.4042879Z +            hex::encode(&request.merchant_pubkey)
2025-11-10T00:08:56.4042992Z +        );
2025-11-10T00:08:56.4043196Z          if let Some(payment_request) = store.get(&key) {
2025-11-10T00:08:56.4043356Z              // Convert to P2P message format
2025-11-10T00:08:56.4043782Z              // Note: In production, merchant_signature would be generated by signing payment_request
2025-11-10T00:08:56.4044467Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip70_handler.rs:37:
2025-11-10T00:08:56.4044591Z              });
2025-11-10T00:08:56.4044708Z          }
2025-11-10T00:08:56.4045029Z      }
2025-11-10T00:08:56.4045151Z -    
2025-11-10T00:08:56.4047152Z +
2025-11-10T00:08:56.4047392Z      Err(anyhow::anyhow!("Payment request not found"))
2025-11-10T00:08:56.4047501Z  }
2025-11-10T00:08:56.4047606Z  
2025-11-10T00:08:56.4048143Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip70_handler.rs:58:
2025-11-10T00:08:56.4048260Z      } else {
2025-11-10T00:08:56.4048373Z          None
2025-11-10T00:08:56.4048489Z      };
2025-11-10T00:08:56.4048591Z -    
2025-11-10T00:08:56.4048697Z +
2025-11-10T00:08:56.4048994Z      if let Some(request) = original_request {
2025-11-10T00:08:56.4049183Z          // Use existing process_payment function
2025-11-10T00:08:56.4049428Z          use bllvm_protocol::payment::PaymentProtocolServer;
2025-11-10T00:08:56.4049943Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip70_handler.rs:65:
2025-11-10T00:08:56.4050551Z -        let payment_ack = PaymentProtocolServer::process_payment(&payment_msg.payment, &request, merchant_private_key)
2025-11-10T00:08:56.4050843Z -            .map_err(|e| anyhow::anyhow!("Payment processing failed: {:?}", e))?;
2025-11-10T00:08:56.4050953Z -        
2025-11-10T00:08:56.4051213Z +        let payment_ack = PaymentProtocolServer::process_payment(
2025-11-10T00:08:56.4051349Z +            &payment_msg.payment,
2025-11-10T00:08:56.4051464Z +            &request,
2025-11-10T00:08:56.4051593Z +            merchant_private_key,
2025-11-10T00:08:56.4051706Z +        )
2025-11-10T00:08:56.4051990Z +        .map_err(|e| anyhow::anyhow!("Payment processing failed: {:?}", e))?;
2025-11-10T00:08:56.4052097Z +
2025-11-10T00:08:56.4052255Z          // Convert to P2P message format
2025-11-10T00:08:56.4052393Z          Ok(PaymentACKMessage {
2025-11-10T00:08:56.4052510Z              payment_ack,
2025-11-10T00:08:56.4052994Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip70_handler.rs:79:
2025-11-10T00:08:56.4053224Z  /// Validate PaymentRequest message from P2P network
2025-11-10T00:08:56.4053697Z  pub fn validate_payment_request_message(msg: &PaymentRequestMessage) -> Result<(), Bip70Error> {
2025-11-10T00:08:56.4053940Z      use bllvm_protocol::payment::PaymentProtocolClient;
2025-11-10T00:08:56.4054648Z -    PaymentProtocolClient::validate_payment_request(&msg.payment_request, Some(&msg.merchant_pubkey))
2025-11-10T00:08:56.4054877Z +    PaymentProtocolClient::validate_payment_request(
2025-11-10T00:08:56.4055019Z +        &msg.payment_request,
2025-11-10T00:08:56.4055174Z +        Some(&msg.merchant_pubkey),
2025-11-10T00:08:56.4055284Z +    )
2025-11-10T00:08:56.4055389Z  }
2025-11-10T00:08:56.4055496Z  
2025-11-10T00:08:56.4057629Z  /// Validate PaymentACK message from merchant
2025-11-10T00:08:56.4058138Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip70_handler.rs:88:
2025-11-10T00:08:56.4058285Z      merchant_pubkey: &[u8],
2025-11-10T00:08:56.4058432Z  ) -> Result<(), Bip70Error> {
2025-11-10T00:08:56.4058679Z      use bllvm_protocol::payment::PaymentProtocolClient;
2025-11-10T00:08:56.4059510Z -    PaymentProtocolClient::validate_payment_ack(&ack.payment_ack, &ack.merchant_signature, merchant_pubkey)
2025-11-10T00:08:56.4059713Z +    PaymentProtocolClient::validate_payment_ack(
2025-11-10T00:08:56.4059861Z +        &ack.payment_ack,
2025-11-10T00:08:56.4060004Z +        &ack.merchant_signature,
2025-11-10T00:08:56.4060133Z +        merchant_pubkey,
2025-11-10T00:08:56.4060248Z +    )
2025-11-10T00:08:56.4060356Z  }
2025-11-10T00:08:56.4060460Z  
2025-11-10T00:08:56.4060962Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/chain_access.rs:3:
2025-11-10T00:08:56.4061280Z  //! Implements ChainStateAccess trait to bridge node storage modules
2025-11-10T00:08:56.4061676Z  //! (BlockStore, TxIndex, MempoolManager) with protocol layer network processing.
2025-11-10T00:08:56.4061784Z  
2025-11-10T00:08:56.4061956Z +use crate::node::mempool::MempoolManager;
2025-11-10T00:08:56.4062423Z +use crate::storage::{blockstore::BlockStore, txindex::TxIndex};
2025-11-10T00:08:56.4062570Z  use anyhow::Result;
2025-11-10T00:08:56.4062845Z  use bllvm_protocol::network::{ChainObject, ChainStateAccess};
2025-11-10T00:08:56.4063111Z  use bllvm_protocol::{Block, BlockHeader, Hash, Transaction};
2025-11-10T00:08:56.4063617Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/chain_access.rs:9:
2025-11-10T00:08:56.4063796Z -use crate::node::mempool::MempoolManager;
2025-11-10T00:08:56.4064068Z -use crate::storage::{blockstore::BlockStore, txindex::TxIndex};
2025-11-10T00:08:56.4064205Z  use std::sync::Arc;
2025-11-10T00:08:56.4064482Z  
2025-11-10T00:08:56.4064870Z  /// Chain state access implementation that bridges node storage to protocol layer
2025-11-10T00:08:56.4065400Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/chain_access.rs:68:
2025-11-10T00:08:56.4065633Z      /// This implements the Bitcoin block locator algorithm
2025-11-10T00:08:56.4066030Z      fn get_headers_for_locator(&self, locator: &[Hash], stop: &Hash) -> Vec<BlockHeader> {
2025-11-10T00:08:56.4066204Z          let mut headers = Vec::new();
2025-11-10T00:08:56.4066316Z -        
2025-11-10T00:08:56.4066419Z +
2025-11-10T00:08:56.4066582Z          // Bitcoin block locator algorithm:
2025-11-10T00:08:56.4066759Z          // 1. Start with the most recent block hash
2025-11-10T00:08:56.4067082Z          // 2. Go back exponentially (1, 2, 4, 8, 16, ...) until we find a common ancestor
2025-11-10T00:08:56.4067596Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/chain_access.rs:75:
2025-11-10T00:08:56.4067838Z          // 3. Stop when we reach the stop hash or run out of hashes
2025-11-10T00:08:56.4068044Z -        
2025-11-10T00:08:56.4068153Z +
2025-11-10T00:08:56.4068299Z          for hash in locator {
2025-11-10T00:08:56.4068468Z              // If we've reached the stop hash, stop
2025-11-10T00:08:56.4068600Z              if hash == stop {
2025-11-10T00:08:56.4069109Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/chain_access.rs:80:
2025-11-10T00:08:56.4069242Z                  break;
2025-11-10T00:08:56.4069351Z              }
2025-11-10T00:08:56.4069573Z -            
2025-11-10T00:08:56.4069855Z +
2025-11-10T00:08:56.4070076Z              // Try to get the header
2025-11-10T00:08:56.4070396Z              if let Ok(Some(header)) = self.blockstore.get_header(hash) {
2025-11-10T00:08:56.4070615Z                  headers.push(header);
2025-11-10T00:08:56.4071420Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/chain_access.rs:89:
2025-11-10T00:08:56.4086676Z                  continue;
2025-11-10T00:08:56.4086841Z              }
2025-11-10T00:08:56.4086953Z          }
2025-11-10T00:08:56.4087066Z -        
2025-11-10T00:08:56.4087169Z +
2025-11-10T00:08:56.4087287Z          headers
2025-11-10T00:08:56.4087395Z      }
2025-11-10T00:08:56.4087513Z  
2025-11-10T00:08:56.4088058Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/chain_access.rs:130:
2025-11-10T00:08:56.4088478Z      height: Option<u64>,
2025-11-10T00:08:56.4088740Z  ) -> Result<bllvm_protocol::network::NetworkResponse> {
2025-11-10T00:08:56.4089080Z      use bllvm_protocol::network::{process_network_message, ChainStateAccess};
2025-11-10T00:08:56.4089185Z -    
2025-11-10T00:08:56.4089299Z +
2025-11-10T00:08:56.4089450Z      process_network_message(
2025-11-10T00:08:56.4089565Z          engine,
2025-11-10T00:08:56.4089686Z          message,
2025-11-10T00:08:56.4090215Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/chain_access.rs:138:
2025-11-10T00:08:56.4090414Z          Some(chain_access as &dyn ChainStateAccess),
2025-11-10T00:08:56.4090533Z          utxo_set,
2025-11-10T00:08:56.4090652Z          height,
2025-11-10T00:08:56.4090955Z -    ).map_err(|e| anyhow::anyhow!("Network message processing error: {}", e))
2025-11-10T00:08:56.4091064Z +    )
2025-11-10T00:08:56.4091620Z +    .map_err(|e| anyhow::anyhow!("Network message processing error: {}", e))
2025-11-10T00:08:56.4091768Z  }
2025-11-10T00:08:56.4091880Z -
2025-11-10T00:08:56.4091987Z  
2025-11-10T00:08:56.4092554Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dns_seeds.rs:38:
2025-11-10T00:08:56.4092686Z      max_addresses: usize,
2025-11-10T00:08:56.4092828Z  ) -> Vec<NetworkAddress> {
2025-11-10T00:08:56.4093477Z      let mut addresses = Vec::new();
2025-11-10T00:08:56.4095682Z -    
2025-11-10T00:08:56.4095803Z +
2025-11-10T00:08:56.4095928Z      for seed in seeds {
2025-11-10T00:08:56.4096111Z          match resolve_dns_seed(*seed, port).await {
2025-11-10T00:08:56.4096239Z              Ok(mut addrs) => {
2025-11-10T00:08:56.4096720Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dns_seeds.rs:53:
2025-11-10T00:08:56.4096840Z              }
2025-11-10T00:08:56.4096952Z          }
2025-11-10T00:08:56.4097072Z      }
2025-11-10T00:08:56.4097193Z -    
2025-11-10T00:08:56.4097299Z +
2025-11-10T00:08:56.4097453Z      // Limit to max_addresses
2025-11-10T00:08:56.4097628Z      addresses.truncate(max_addresses);
2025-11-10T00:08:56.4097749Z      addresses
2025-11-10T00:08:56.4098233Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dns_seeds.rs:63:
2025-11-10T00:08:56.4099062Z  async fn resolve_dns_seed(seed: &str, port: u16) -> Result<Vec<NetworkAddress>, String> {
2025-11-10T00:08:56.4099266Z      // Create hostname:port string for DNS lookup
2025-11-10T00:08:56.4099445Z      let hostname = format!("{}:{}", seed, port);
2025-11-10T00:08:56.4099554Z -    
2025-11-10T00:08:56.4100070Z +
2025-11-10T00:08:56.4100251Z      // Perform DNS lookup with timeout
2025-11-10T00:08:56.4100432Z      let timeout = Duration::from_secs(5);
2025-11-10T00:08:56.4100870Z      let lookup_result = tokio::time::timeout(timeout, lookup_host(&hostname))
2025-11-10T00:08:56.4101369Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dns_seeds.rs:70:
2025-11-10T00:08:56.4101489Z          .await
2025-11-10T00:08:56.4101741Z          .map_err(|_| format!("DNS lookup timeout for {}", seed))?;
2025-11-10T00:08:56.4101848Z -    
2025-11-10T00:08:56.4102003Z -    let socket_addrs = lookup_result
2025-11-10T00:08:56.4102256Z -        .map_err(|e| format!("DNS lookup failed for {}: {}", seed, e))?;
2025-11-10T00:08:56.4102378Z -    
2025-11-10T00:08:56.4102487Z +
2025-11-10T00:08:56.4102620Z +    let socket_addrs =
2025-11-10T00:08:56.4102968Z +        lookup_result.map_err(|e| format!("DNS lookup failed for {}: {}", seed, e))?;
2025-11-10T00:08:56.4103076Z +
2025-11-10T00:08:56.4103248Z      // Convert SocketAddr to NetworkAddress
2025-11-10T00:08:56.4103406Z      let mut addresses = Vec::new();
2025-11-10T00:08:56.4103565Z      for socket_addr in socket_addrs {
2025-11-10T00:08:56.4106606Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dns_seeds.rs:79:
2025-11-10T00:08:56.4106939Z          addresses.push(socket_addr_to_network_address(socket_addr));
2025-11-10T00:08:56.4107299Z      }
2025-11-10T00:08:56.4107401Z -    
2025-11-10T00:08:56.4107498Z +
2025-11-10T00:08:56.4107624Z      Ok(addresses)
2025-11-10T00:08:56.4107741Z  }
2025-11-10T00:08:56.4107846Z  
2025-11-10T00:08:56.4108330Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dns_seeds.rs:85:
2025-11-10T00:08:56.4108508Z  /// Convert SocketAddr to NetworkAddress
2025-11-10T00:08:56.4108854Z  fn socket_addr_to_network_address(socket_addr: SocketAddr) -> NetworkAddress {
2025-11-10T00:08:56.4108988Z      use std::net::IpAddr;
2025-11-10T00:08:56.4109108Z -    
2025-11-10T00:08:56.4109215Z +
2025-11-10T00:08:56.4109376Z      let ip_bytes = match socket_addr.ip() {
2025-11-10T00:08:56.4109509Z          IpAddr::V4(ipv4) => {
2025-11-10T00:08:56.4109654Z              // IPv4-mapped IPv6 format
2025-11-10T00:08:56.4110442Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dns_seeds.rs:95:
2025-11-10T00:08:56.4110662Z              bytes[12..16].copy_from_slice(&ipv4.octets());
2025-11-10T00:08:56.4110794Z              bytes
2025-11-10T00:08:56.4110905Z          }
2025-11-10T00:08:56.4111050Z -        IpAddr::V6(ipv6) => {
2025-11-10T00:08:56.4111173Z -            ipv6.octets()
2025-11-10T00:08:56.4111295Z -        }
2025-11-10T00:08:56.4111458Z +        IpAddr::V6(ipv6) => ipv6.octets(),
2025-11-10T00:08:56.4111568Z      };
2025-11-10T00:08:56.4111686Z -    
2025-11-10T00:08:56.4111796Z +
2025-11-10T00:08:56.4111927Z      NetworkAddress {
2025-11-10T00:08:56.4112133Z          services: 0, // Will be updated when we connect
2025-11-10T00:08:56.4112270Z          ip: ip_bytes,
2025-11-10T00:08:56.4112772Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dns_seeds.rs:125:
2025-11-10T00:08:56.4112915Z          assert_eq!(addr.ip[15], 1);
2025-11-10T00:08:56.4113031Z      }
2025-11-10T00:08:56.4113138Z  }
2025-11-10T00:08:56.4113242Z -
2025-11-10T00:08:56.4113356Z  
2025-11-10T00:08:56.4113880Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:9:
2025-11-10T00:08:56.4114023Z  use std::sync::Arc;
2025-11-10T00:08:56.4114195Z  use std::time::{SystemTime, UNIX_EPOCH};
2025-11-10T00:08:56.4114585Z  use tokio::sync::Mutex;
2025-11-10T00:08:56.4114749Z -use tracing::{debug, warn, error};
2025-11-10T00:08:56.4114902Z +use tracing::{debug, error, warn};
2025-11-10T00:08:56.4115014Z  
2025-11-10T00:08:56.4115360Z  /// Connection rate limiter (tracks connection attempts per time window)
2025-11-10T00:08:56.4115531Z  pub struct ConnectionRateLimiter {
2025-11-10T00:08:56.4117608Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:40:
2025-11-10T00:08:56.4117729Z  
2025-11-10T00:08:56.4117929Z          // Clean up old entries outside the time window
2025-11-10T00:08:56.4118162Z          let cutoff = now.saturating_sub(self.window_seconds);
2025-11-10T00:08:56.4118289Z -        
2025-11-10T00:08:56.4118407Z +
2025-11-10T00:08:56.4118772Z          let attempts = self.connection_attempts.entry(ip).or_insert_with(Vec::new);
2025-11-10T00:08:56.4118997Z          attempts.retain(|&timestamp| timestamp > cutoff);
2025-11-10T00:08:56.4119116Z  
2025-11-10T00:08:56.4119640Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:47:
2025-11-10T00:08:56.4119800Z          // Check if we're within the limit
2025-11-10T00:08:56.4120502Z          if attempts.len() >= self.max_connections_per_window {
2025-11-10T00:08:56.4120883Z -            warn!("Connection rate limit exceeded for IP {}: {} attempts in {} seconds", 
2025-11-10T00:08:56.4121079Z -                  ip, attempts.len(), self.window_seconds);
2025-11-10T00:08:56.4121197Z +            warn!(
2025-11-10T00:08:56.4121530Z +                "Connection rate limit exceeded for IP {}: {} attempts in {} seconds",
2025-11-10T00:08:56.4121651Z +                ip,
2025-11-10T00:08:56.4121803Z +                attempts.len(),
2025-11-10T00:08:56.4121950Z +                self.window_seconds
2025-11-10T00:08:56.4122322Z +            );
2025-11-10T00:08:56.4122443Z              false
2025-11-10T00:08:56.4122563Z          } else {
2025-11-10T00:08:56.4122739Z              // Record this connection attempt
2025-11-10T00:08:56.4123269Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:72:
2025-11-10T00:08:56.4123378Z  
2025-11-10T00:08:56.4123578Z      /// Get current connection attempt count for an IP
2025-11-10T00:08:56.4123790Z      pub fn get_attempt_count(&self, ip: IpAddr) -> usize {
2025-11-10T00:08:56.4124072Z -        self.connection_attempts.get(&ip).map(|v| v.len()).unwrap_or(0)
2025-11-10T00:08:56.4124215Z +        self.connection_attempts
2025-11-10T00:08:56.4124548Z +            .get(&ip)
2025-11-10T00:08:56.4124680Z +            .map(|v| v.len())
2025-11-10T00:08:56.4124799Z +            .unwrap_or(0)
2025-11-10T00:08:56.4124909Z      }
2025-11-10T00:08:56.4127088Z  }
2025-11-10T00:08:56.4127207Z  
2025-11-10T00:08:56.4127742Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:171:
2025-11-10T00:08:56.4127884Z      /// Create with default settings
2025-11-10T00:08:56.4128019Z      pub fn default() -> Self {
2025-11-10T00:08:56.4128500Z          Self::new(
2025-11-10T00:08:56.4128712Z -            10,   // Max 10 connections per IP per window
2025-11-10T00:08:56.4128849Z -            60,   // 60 second window
2025-11-10T00:08:56.4129032Z +            10,    // Max 10 connections per IP per window
2025-11-10T00:08:56.4129178Z +            60,    // 60 second window
2025-11-10T00:08:56.4129336Z              10000, // Max 10k messages in queue
2025-11-10T00:08:56.4129489Z -            200,  // Max 200 active connections
2025-11-10T00:08:56.4129651Z +            200,   // Max 200 active connections
2025-11-10T00:08:56.4129761Z          )
2025-11-10T00:08:56.4129870Z      }
2025-11-10T00:08:56.4129986Z  
2025-11-10T00:08:56.4130530Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:194:
2025-11-10T00:08:56.4130729Z              metrics.connection_rate_violations += 1;
2025-11-10T00:08:56.4130838Z  
2025-11-10T00:08:56.4131472Z              if *count >= self.auto_ban_connection_violations {
2025-11-10T00:08:56.4131881Z -                warn!("Auto-banning IP {} for repeated connection rate violations ({} violations)", 
2025-11-10T00:08:56.4132013Z -                      ip, *count);
2025-11-10T00:08:56.4132467Z +                warn!(
2025-11-10T00:08:56.4132817Z +                    "Auto-banning IP {} for repeated connection rate violations ({} violations)",
2025-11-10T00:08:56.4132945Z +                    ip, *count
2025-11-10T00:08:56.4133062Z +                );
2025-11-10T00:08:56.4133235Z                  metrics.auto_bans_applied += 1;
2025-11-10T00:08:56.4133425Z                  // Return false to reject, caller should ban
2025-11-10T00:08:56.4133569Z                  return false;
2025-11-10T00:08:56.4134076Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:212:
2025-11-10T00:08:56.4134262Z      /// Check if message queue is within limits
2025-11-10T00:08:56.4134785Z      pub async fn check_message_queue_size(&self, current_size: usize) -> bool {
2025-11-10T00:08:56.4134984Z          if current_size > self.max_message_queue_size {
2025-11-10T00:08:56.4135371Z -            warn!("Message queue size exceeded: {} > {}", current_size, self.max_message_queue_size);
2025-11-10T00:08:56.4135486Z +            warn!(
2025-11-10T00:08:56.4135657Z +                "Message queue size exceeded: {} > {}",
2025-11-10T00:08:56.4135844Z +                current_size, self.max_message_queue_size
2025-11-10T00:08:56.4135954Z +            );
2025-11-10T00:08:56.4136143Z              let mut metrics = self.metrics.lock().await;
2025-11-10T00:08:56.4136317Z              metrics.message_queue_overflows += 1;
2025-11-10T00:08:56.4136452Z              false
2025-11-10T00:08:56.4136994Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:224:
2025-11-10T00:08:56.4137428Z      /// Check if we can accept more connections
2025-11-10T00:08:56.4137788Z      pub async fn check_active_connections(&self, current_count: usize) -> bool {
2025-11-10T00:08:56.4137991Z          if current_count >= self.max_active_connections {
2025-11-10T00:08:56.4138480Z -            warn!("Active connection limit exceeded: {} >= {}", current_count, self.max_active_connections);
2025-11-10T00:08:56.4138617Z +            warn!(
2025-11-10T00:08:56.4138815Z +                "Active connection limit exceeded: {} >= {}",
2025-11-10T00:08:56.4139003Z +                current_count, self.max_active_connections
2025-11-10T00:08:56.4139131Z +            );
2025-11-10T00:08:56.4139322Z              let mut metrics = self.metrics.lock().await;
2025-11-10T00:08:56.4139731Z              metrics.active_connection_limit_hits += 1;
2025-11-10T00:08:56.4139860Z              false
2025-11-10T00:08:56.4140412Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:262:
2025-11-10T00:08:56.4140600Z      /// Check if we're under DoS attack (heuristic)
2025-11-10T00:08:56.4140790Z      pub async fn detect_dos_attack(&self) -> bool {
2025-11-10T00:08:56.4141010Z          let metrics = self.resource_metrics.lock().await;
2025-11-10T00:08:56.4141227Z -        
2025-11-10T00:08:56.4141338Z +
2025-11-10T00:08:56.4141656Z          // Heuristic: If message queue is > 80% full and connections are > 80% of max
2025-11-10T00:08:56.4141987Z          let queue_threshold = (self.max_message_queue_size as f64 * 0.8) as usize;
2025-11-10T00:08:56.4142295Z          let conn_threshold = (self.max_active_connections as f64 * 0.8) as usize;
2025-11-10T00:08:56.4142836Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:269:
2025-11-10T00:08:56.4142955Z  
2025-11-10T00:08:56.4143159Z -        metrics.message_queue_size > queue_threshold 
2025-11-10T00:08:56.4143359Z -            && metrics.active_connections > conn_threshold
2025-11-10T00:08:56.4144509Z +        metrics.message_queue_size > queue_threshold && metrics.active_connections > conn_threshold
2025-11-10T00:08:56.4144632Z      }
2025-11-10T00:08:56.4144743Z  
2025-11-10T00:08:56.4144932Z      /// Cleanup old connection rate limiter entries
2025-11-10T00:08:56.4145798Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:368:
2025-11-10T00:08:56.4145988Z          assert!(dos.should_auto_ban(ip).await);
2025-11-10T00:08:56.4146100Z      }
2025-11-10T00:08:56.4146221Z  }
2025-11-10T00:08:56.4146330Z -
2025-11-10T00:08:56.4146438Z  
2025-11-10T00:08:56.4146947Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/filter_service.rs:3:
2025-11-10T00:08:56.4147335Z  //! Generates, caches, and serves compact block filters for light client support.
2025-11-10T00:08:56.4147853Z  //! Maintains filter header chain for efficient verification.
2025-11-10T00:08:56.4147981Z  
2025-11-10T00:08:56.4148145Z +use anyhow::{anyhow, Result};
2025-11-10T00:08:56.4148286Z  use bllvm_protocol::bip157;
2025-11-10T00:08:56.4148604Z  use bllvm_protocol::bip158::{build_block_filter, CompactBlockFilter};
2025-11-10T00:08:56.4148749Z -use anyhow::{anyhow, Result};
2025-11-10T00:08:56.4149012Z  use bllvm_protocol::{Block, BlockHeader, Hash, Transaction};
2025-11-10T00:08:56.4149161Z  use std::collections::HashMap;
2025-11-10T00:08:56.4149293Z  use std::sync::{Arc, RwLock};
2025-11-10T00:08:56.4149829Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/filter_service.rs:211:
2025-11-10T00:08:56.4150189Z      pub fn remove_filter_for_pruned_block(&self, block_hash: &Hash) -> Result<()> {
2025-11-10T00:08:56.4150328Z          // Remove filter from cache
2025-11-10T00:08:56.4150541Z          self.filters.write().unwrap().remove(block_hash);
2025-11-10T00:08:56.4150655Z -        
2025-11-10T00:08:56.4150756Z +
2025-11-10T00:08:56.4152182Z          // Note: We do NOT remove the filter header - it's required for verification
2025-11-10T00:08:56.4152456Z          // The filter header chain must remain intact even after pruning
2025-11-10T00:08:56.4152573Z -        
2025-11-10T00:08:56.4152689Z +
2025-11-10T00:08:56.4152811Z          Ok(())
2025-11-10T00:08:56.4152919Z      }
2025-11-10T00:08:56.4153028Z  
2025-11-10T00:08:56.4153580Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/message_bridge.rs:80:
2025-11-10T00:08:56.4154013Z      /// 3. Convert the `NetworkResponse` to wire format messages using `extract_send_messages()`
2025-11-10T00:08:56.4154130Z      ///
2025-11-10T00:08:56.4154621Z      /// For now, this method only handles message conversion, not processing.
2025-11-10T00:08:56.4154790Z -    pub fn process_incoming_message(
2025-11-10T00:08:56.4154914Z -        data: &[u8],
2025-11-10T00:08:56.4155341Z -        transport: TransportType,
2025-11-10T00:08:56.4155498Z -    ) -> Result<Vec<Vec<u8>>> {
2025-11-10T00:08:56.4155942Z +    pub fn process_incoming_message(data: &[u8], transport: TransportType) -> Result<Vec<Vec<u8>>> {
2025-11-10T00:08:56.4156103Z          // Convert to protocol message
2025-11-10T00:08:56.4156408Z          let protocol_msg = Self::from_transport_message(data, transport)?;
2025-11-10T00:08:56.4156518Z  
2025-11-10T00:08:56.4977897Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:4:
2025-11-10T00:08:56.4978899Z  //! message handling for communication with other Bitcoin nodes.
2025-11-10T00:08:56.4979473Z  
2025-11-10T00:08:56.4979756Z  pub mod address_db;
2025-11-10T00:08:56.4980125Z +pub mod ban_list_merging;
2025-11-10T00:08:56.4980517Z +pub mod ban_list_signing;
2025-11-10T00:08:56.4980887Z  pub mod chain_access;
2025-11-10T00:08:56.4981240Z  pub mod dns_seeds;
2025-11-10T00:08:56.4981582Z +pub mod dos_protection;
2025-11-10T00:08:56.4983393Z  pub mod inventory;
2025-11-10T00:08:56.4983730Z  pub mod message_bridge;
2025-11-10T00:08:56.4984103Z  pub mod peer;
2025-11-10T00:08:56.4984963Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:12:
2025-11-10T00:08:56.4985725Z  pub mod protocol;
2025-11-10T00:08:56.4986064Z  pub mod protocol_adapter;
2025-11-10T00:08:56.4986469Z  pub mod protocol_extensions;
2025-11-10T00:08:56.4986873Z -pub mod ban_list_merging;
2025-11-10T00:08:56.4987725Z -pub mod ban_list_signing;
2025-11-10T00:08:56.4988467Z -pub mod dos_protection;
2025-11-10T00:08:56.4988837Z  pub mod relay;
2025-11-10T00:08:56.4989171Z  pub mod tcp_transport;
2025-11-10T00:08:56.4989523Z  pub mod transport;
2025-11-10T00:08:56.4990191Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:40:
2025-11-10T00:08:56.4990963Z  // Payment Protocol (BIP70) - P2P handlers
2025-11-10T00:08:56.4991416Z  pub mod bip70_handler;
2025-11-10T00:08:56.4991742Z  
2025-11-10T00:08:56.4991988Z -
2025-11-10T00:08:56.4992630Z  // Privacy and Performance Enhancements
2025-11-10T00:08:56.4993101Z  #[cfg(feature = "dandelion")]
2025-11-10T00:08:56.4993693Z  pub mod dandelion; // Dandelion++ privacy-preserving transaction relay
2025-11-10T00:08:56.4994779Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:50:
2025-11-10T00:08:56.4995707Z  pub mod txhash; // Non-consensus hashing helpers for relay
2025-11-10T00:08:56.4996192Z  
2025-11-10T00:08:56.4996652Z  use crate::network::protocol::{ProtocolMessage, ProtocolParser};
2025-11-10T00:08:56.4997260Z +use crate::node::mempool::MempoolManager;
2025-11-10T00:08:56.4997715Z +use crate::storage::Storage;
2025-11-10T00:08:56.4998096Z  use anyhow::Result;
2025-11-10T00:08:56.4998452Z  use bllvm_protocol::mempool::Mempool;
2025-11-10T00:08:56.4999072Z  use bllvm_protocol::{BitcoinProtocolEngine, ConsensusProof, UtxoSet};
2025-11-10T00:08:56.4999995Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:58:
2025-11-10T00:08:56.5000740Z  use std::sync::{Arc, Mutex};
2025-11-10T00:08:56.5001461Z  use tokio::sync::mpsc;
2025-11-10T00:08:56.5001831Z  use tracing::{error, info, warn};
2025-11-10T00:08:56.5002252Z -use crate::storage::Storage;
2025-11-10T00:08:56.5002678Z -use crate::node::mempool::MempoolManager;
2025-11-10T00:08:56.5003107Z  
2025-11-10T00:08:56.5003442Z  use crate::network::tcp_transport::TcpTransport;
2025-11-10T00:08:56.5003934Z  use crate::network::transport::{
2025-11-10T00:08:56.5004801Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:86:
2025-11-10T00:08:56.5005877Z  }
2025-11-10T00:08:56.5006121Z  
2025-11-10T00:08:56.5006418Z  /// Peer manager for tracking connected peers
2025-11-10T00:08:56.5006827Z -/// 
2025-11-10T00:08:56.5007064Z +///
2025-11-10T00:08:56.5007517Z  /// Uses TransportAddr as key to support all transport types (TCP, Quinn, Iroh).
2025-11-10T00:08:56.5008567Z  /// This allows proper peer identification for Iroh (NodeId) while maintaining
2025-11-10T00:08:56.5009236Z  /// compatibility with TCP/Quinn (SocketAddr).
2025-11-10T00:08:56.5009974Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:130:
2025-11-10T00:08:56.5010762Z      pub fn peer_addresses(&self) -> Vec<TransportAddr> {
2025-11-10T00:08:56.5011244Z          self.peers.keys().cloned().collect()
2025-11-10T00:08:56.5011633Z      }
2025-11-10T00:08:56.5011880Z -    
2025-11-10T00:08:56.5012110Z +
2025-11-10T00:08:56.5012508Z      /// Get peer addresses as SocketAddr (for backward compatibility)
2025-11-10T00:08:56.5013181Z      /// Only returns SocketAddr for TCP/Quinn peers, skips Iroh peers
2025-11-10T00:08:56.5014162Z      pub fn peer_socket_addresses(&self) -> Vec<SocketAddr> {
2025-11-10T00:08:56.5017296Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:137:
2025-11-10T00:08:56.5017993Z -        self.peers.keys()
2025-11-10T00:08:56.5018308Z +        self.peers
2025-11-10T00:08:56.5018601Z +            .keys()
2025-11-10T00:08:56.5018896Z              .filter_map(|addr| {
2025-11-10T00:08:56.5019243Z                  match addr {
2025-11-10T00:08:56.5019625Z                      TransportAddr::Tcp(sock) => Some(*sock),
2025-11-10T00:08:56.5020324Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:150:
2025-11-10T00:08:56.5021058Z      pub fn can_accept_peer(&self) -> bool {
2025-11-10T00:08:56.5021918Z          self.peers.len() < self.max_peers
2025-11-10T00:08:56.5022315Z      }
2025-11-10T00:08:56.5022538Z -    
2025-11-10T00:08:56.5022765Z +
2025-11-10T00:08:56.5023054Z      /// Select best peers based on quality score
2025-11-10T00:08:56.5023449Z -    /// 
2025-11-10T00:08:56.5023706Z +    ///
2025-11-10T00:08:56.5024070Z      /// Returns peers sorted by quality score (highest first)
2025-11-10T00:08:56.5024945Z      pub fn select_best_peers(&self, count: usize) -> Vec<TransportAddr> {
2025-11-10T00:08:56.5027967Z -        let mut peers: Vec<_> = self.peers.iter()
2025-11-10T00:08:56.5028481Z +        let mut peers: Vec<_> = self
2025-11-10T00:08:56.5028886Z +            .peers
2025-11-10T00:08:56.5029203Z +            .iter()
2025-11-10T00:08:56.5029626Z              .map(|(addr, peer)| (addr.clone(), peer.quality_score()))
2025-11-10T00:08:56.5030154Z              .collect();
2025-11-10T00:08:56.5030488Z -        
2025-11-10T00:08:56.5030759Z +
2025-11-10T00:08:56.5031073Z          // Sort by quality score (descending)
2025-11-10T00:08:56.5031750Z          peers.sort_by(|a, b| b.1.partial_cmp(&a.1).unwrap_or(std::cmp::Ordering::Equal));
2025-11-10T00:08:56.5032379Z -        
2025-11-10T00:08:56.5032649Z +
2025-11-10T00:08:56.5032938Z          // Return top N addresses
2025-11-10T00:08:56.5033346Z -        peers.into_iter()
2025-11-10T00:08:56.5033710Z +        peers
2025-11-10T00:08:56.5033995Z +            .into_iter()
2025-11-10T00:08:56.5034506Z              .take(count)
2025-11-10T00:08:56.5034881Z              .map(|(addr, _)| addr)
2025-11-10T00:08:56.5035280Z              .collect()
2025-11-10T00:08:56.5035955Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:170:
2025-11-10T00:08:56.5036980Z      }
2025-11-10T00:08:56.5037230Z -    
2025-11-10T00:08:56.5037471Z +
2025-11-10T00:08:56.5037736Z      /// Select reliable peers only
2025-11-10T00:08:56.5038112Z -    /// 
2025-11-10T00:08:56.5038371Z +    ///
2025-11-10T00:08:56.5038718Z      /// Returns peers that meet reliability criteria
2025-11-10T00:08:56.5039341Z      pub fn select_reliable_peers(&self) -> Vec<TransportAddr> {
2025-11-10T00:08:56.5039894Z -        self.peers.iter()
2025-11-10T00:08:56.5040246Z +        self.peers
2025-11-10T00:08:56.5040560Z +            .iter()
2025-11-10T00:08:56.5041122Z              .filter(|(_, peer)| peer.quality_score() > 0.5) // Use quality_score as reliability indicator
2025-11-10T00:08:56.5045809Z              .map(|(addr, _)| addr.clone())
2025-11-10T00:08:56.5046247Z              .collect()
2025-11-10T00:08:56.5047178Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:180:
2025-11-10T00:08:56.5047947Z      }
2025-11-10T00:08:56.5048223Z -    
2025-11-10T00:08:56.5048484Z +
2025-11-10T00:08:56.5048785Z      /// Get peer quality statistics
2025-11-10T00:08:56.5049331Z      pub fn get_quality_stats(&self) -> (usize, usize, f64) {
2025-11-10T00:08:56.5049876Z          let total = self.peers.len();
2025-11-10T00:08:56.5050641Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:185:
2025-11-10T00:08:56.5051429Z -        let reliable = self.peers.values()
2025-11-10T00:08:56.5051896Z +        let reliable = self
2025-11-10T00:08:56.5052264Z +            .peers
2025-11-10T00:08:56.5052574Z +            .values()
2025-11-10T00:08:56.5053164Z              .filter(|peer| peer.quality_score() > 0.5) // Use quality_score as reliability indicator
2025-11-10T00:08:56.5053828Z              .count();
2025-11-10T00:08:56.5054170Z          let avg_quality = if total > 0 {
2025-11-10T00:08:56.5055150Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:189:
2025-11-10T00:08:56.5057185Z -            self.peers.values()
2025-11-10T00:08:56.5057582Z +            self.peers
2025-11-10T00:08:56.5057928Z +                .values()
2025-11-10T00:08:56.5058327Z                  .map(|peer| peer.quality_score())
2025-11-10T00:08:56.5058811Z -                .sum::<f64>() / total as f64
2025-11-10T00:08:56.5059242Z +                .sum::<f64>()
2025-11-10T00:08:56.5059607Z +                / total as f64
2025-11-10T00:08:56.5059972Z          } else {
2025-11-10T00:08:56.5060258Z              0.0
2025-11-10T00:08:56.5060554Z          };
2025-11-10T00:08:56.5061161Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:195:
2025-11-10T00:08:56.5061870Z -        
2025-11-10T00:08:56.5062122Z +
2025-11-10T00:08:56.5062402Z          (total, reliable, avg_quality)
2025-11-10T00:08:56.5062782Z      }
2025-11-10T00:08:56.5063037Z -    
2025-11-10T00:08:56.5063285Z +
2025-11-10T00:08:56.5065756Z      /// Find peer by SocketAddr (tries TCP and Quinn variants)
2025-11-10T00:08:56.5066291Z      /// Returns the TransportAddr if found
2025-11-10T00:08:56.5067068Z      pub fn find_transport_addr_by_socket(&self, addr: SocketAddr) -> Option<TransportAddr> {
2025-11-10T00:08:56.5068166Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:204:
2025-11-10T00:08:56.5068925Z          if self.peers.contains_key(&tcp_addr) {
2025-11-10T00:08:56.5069408Z              return Some(tcp_addr);
2025-11-10T00:08:56.5069798Z          }
2025-11-10T00:08:56.5070077Z -        
2025-11-10T00:08:56.5070345Z +
2025-11-10T00:08:56.5070597Z          // Try Quinn
2025-11-10T00:08:56.5070934Z          #[cfg(feature = "quinn")]
2025-11-10T00:08:56.5071394Z          {
2025-11-10T00:08:56.5071987Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:213:
2025-11-10T00:08:56.5075067Z                  return Some(quinn_addr);
2025-11-10T00:08:56.5075470Z              }
2025-11-10T00:08:56.5076129Z          }
2025-11-10T00:08:56.5076398Z -        
2025-11-10T00:08:56.5076646Z +
2025-11-10T00:08:56.5076879Z          None
2025-11-10T00:08:56.5077129Z      }
2025-11-10T00:08:56.5077387Z  }
2025-11-10T00:08:56.5077985Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:245:
2025-11-10T00:08:56.5078746Z              last_refill: now,
2025-11-10T00:08:56.5079110Z          }
2025-11-10T00:08:56.5079369Z      }
2025-11-10T00:08:56.5079632Z -    
2025-11-10T00:08:56.5079887Z +
2025-11-10T00:08:56.5080271Z      /// Check if a message can be consumed and consume a token
2025-11-10T00:08:56.5080852Z      pub fn check_and_consume(&mut self) -> bool {
2025-11-10T00:08:56.5081326Z          self.refill();
2025-11-10T00:08:56.5082480Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:256:
2025-11-10T00:08:56.5083197Z              false
2025-11-10T00:08:56.5083726Z          }
2025-11-10T00:08:56.5083980Z      }
2025-11-10T00:08:56.5084240Z -    
2025-11-10T00:08:56.5084762Z +
2025-11-10T00:08:56.5085079Z      /// Refill tokens based on elapsed time
2025-11-10T00:08:56.5085524Z      fn refill(&mut self) {
2025-11-10T00:08:56.5085954Z          use std::time::{SystemTime, UNIX_EPOCH};
2025-11-10T00:08:56.5086741Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:264:
2025-11-10T00:08:56.5087511Z              .duration_since(UNIX_EPOCH)
2025-11-10T00:08:56.5087912Z              .unwrap()
2025-11-10T00:08:56.5088228Z              .as_secs();
2025-11-10T00:08:56.5088559Z -        
2025-11-10T00:08:56.5088804Z +
2025-11-10T00:08:56.5089084Z          if now > self.last_refill {
2025-11-10T00:08:56.5089528Z              let elapsed = now - self.last_refill;
2025-11-10T00:08:56.5090057Z              let tokens_to_add = (elapsed as u32) * self.rate;
2025-11-10T00:08:56.5090870Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:271:
2025-11-10T00:08:56.5091817Z -            self.tokens = self.tokens.saturating_add(tokens_to_add).min(self.burst_limit);
2025-11-10T00:08:56.5092501Z +            self.tokens = self
2025-11-10T00:08:56.5092872Z +                .tokens
2025-11-10T00:08:56.5093212Z +                .saturating_add(tokens_to_add)
2025-11-10T00:08:56.5093663Z +                .min(self.burst_limit);
2025-11-10T00:08:56.5094094Z              self.last_refill = now;
2025-11-10T00:08:56.5095122Z          }
2025-11-10T00:08:56.5095396Z      }
2025-11-10T00:08:56.5095947Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:452:
2025-11-10T00:08:56.5096810Z              enable_self_advertisement: true, // Default: advertise ourselves
2025-11-10T00:08:56.5097331Z          }
2025-11-10T00:08:56.5097571Z      }
2025-11-10T00:08:56.5097808Z -    
2025-11-10T00:08:56.5098075Z +
2025-11-10T00:08:56.5098443Z      /// Set dependencies for protocol message processing
2025-11-10T00:08:56.5098978Z      pub fn with_dependencies(
2025-11-10T00:08:56.5099342Z          mut self,
2025-11-10T00:08:56.5099944Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:525:
2025-11-10T00:08:56.5100813Z      /// Discover peers from DNS seeds and add to address database
2025-11-10T00:08:56.5101618Z      pub async fn discover_peers_from_dns(&self, network: &str, port: u16) -> Result<()> {
2025-11-10T00:08:56.5102330Z          use crate::network::dns_seeds;
2025-11-10T00:08:56.5102733Z -        
2025-11-10T00:08:56.5103004Z +
2025-11-10T00:08:56.5103282Z          let seeds = match network {
2025-11-10T00:08:56.5103751Z              "mainnet" => dns_seeds::MAINNET_DNS_SEEDS,
2025-11-10T00:08:56.5104253Z              "testnet" => dns_seeds::TESTNET_DNS_SEEDS,
2025-11-10T00:08:56.5105667Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:534:
2025-11-10T00:08:56.5106431Z                  return Ok(());
2025-11-10T00:08:56.5106801Z              }
2025-11-10T00:08:56.5107340Z          };
2025-11-10T00:08:56.5107991Z -        
2025-11-10T00:08:56.5108373Z +
2025-11-10T00:08:56.5109217Z          info!("Discovering peers from DNS seeds for {}", network);
2025-11-10T00:08:56.5129339Z          let addresses = dns_seeds::resolve_dns_seeds(seeds, port, 100).await;
2025-11-10T00:08:56.5129973Z -        
2025-11-10T00:08:56.5130249Z +
2025-11-10T00:08:56.5130581Z          // Add discovered addresses to database
2025-11-10T00:08:56.5131022Z          {
2025-11-10T00:08:56.5131833Z              let mut db = self.address_database.lock().unwrap();
2025-11-10T00:08:56.5132666Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:545:
2025-11-10T00:08:56.5133587Z                  db.add_address(addr, 0); // Services will be updated on connection
2025-11-10T00:08:56.5136145Z              }
2025-11-10T00:08:56.5136447Z          }
2025-11-10T00:08:56.5136725Z -        
2025-11-10T00:08:56.5136987Z +
2025-11-10T00:08:56.5137686Z          info!("Discovered {} addresses from DNS seeds", addresses.len());
2025-11-10T00:08:56.5138268Z          Ok(())
2025-11-10T00:08:56.5138563Z      }
2025-11-10T00:08:56.5139165Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:555:
2025-11-10T00:08:56.5139955Z          for peer_addr in persistent_peers {
2025-11-10T00:08:56.5140433Z              // Add to persistent peer set
2025-11-10T00:08:56.5140907Z              self.add_persistent_peer(*peer_addr);
2025-11-10T00:08:56.5141355Z -            
2025-11-10T00:08:56.5141631Z +
2025-11-10T00:08:56.5141912Z              // Try to connect
2025-11-10T00:08:56.5142386Z              info!("Connecting to persistent peer: {}", peer_addr);
2025-11-10T00:08:56.5143015Z              if let Err(e) = self.connect_to_peer(*peer_addr).await {
2025-11-10T00:08:56.5143844Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:566:
2025-11-10T00:08:56.5144743Z      }
2025-11-10T00:08:56.5145023Z  
2025-11-10T00:08:56.5145389Z      /// Discover Iroh peers and add to address database
2025-11-10T00:08:56.5145888Z -    /// 
2025-11-10T00:08:56.5146161Z +    ///
2025-11-10T00:08:56.5146482Z      /// Iroh peers are discovered through:
2025-11-10T00:08:56.5147000Z      /// 1. Incoming connections (automatically stored)
2025-11-10T00:08:56.5147513Z      /// 2. DERP servers (if configured)
2025-11-10T00:08:56.5148266Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:573:
2025-11-10T00:08:56.5149042Z      /// 3. Gossip discovery (if available)
2025-11-10T00:08:56.5149449Z -    /// 
2025-11-10T00:08:56.5149720Z +    ///
2025-11-10T00:08:56.5150229Z      /// This method can be extended to use Iroh's gossip discovery APIs when available.
2025-11-10T00:08:56.5150872Z      #[cfg(feature = "iroh")]
2025-11-10T00:08:56.5151366Z      pub async fn discover_iroh_peers(&self) -> Result<usize> {
2025-11-10T00:08:56.5152213Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:579:
2025-11-10T00:08:56.5155274Z          // 1. Incoming connections (handled automatically in accept loop)
2025-11-10T00:08:56.5155904Z          // 2. DERP servers (configured in IrohTransport)
2025-11-10T00:08:56.5156540Z          // 3. Gossip discovery (would require iroh-gossip-discovery crate)
2025-11-10T00:08:56.5157087Z -        
2025-11-10T00:08:56.5157363Z +
2025-11-10T00:08:56.5157640Z          // For now, we rely on:
2025-11-10T00:08:56.5158064Z          // - Persistent Iroh peers from config
2025-11-10T00:08:56.5158601Z          // - Incoming connections (stored automatically)
2025-11-10T00:08:56.5159407Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:586:
2025-11-10T00:08:56.5160232Z          // - DERP servers (handled by Iroh's MagicEndpoint)
2025-11-10T00:08:56.5160701Z -        
2025-11-10T00:08:56.5160974Z +
2025-11-10T00:08:56.5161399Z          // Future: Integrate with iroh-gossip-discovery when available
2025-11-10T00:08:56.5162203Z          info!("Iroh peer discovery: relying on DERP servers and incoming connections");
2025-11-10T00:08:56.5165252Z          Ok(0) // Return 0 for now - discovery happens through Iroh's native mechanisms
2025-11-10T00:08:56.5166193Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:593:
2025-11-10T00:08:56.5167002Z      /// Connect to Iroh peers from address database
2025-11-10T00:08:56.5167479Z      #[cfg(feature = "iroh")]
2025-11-10T00:08:56.5168170Z      pub async fn connect_iroh_peers_from_database(&self, target_count: usize) -> Result<usize> {
2025-11-10T00:08:56.5168978Z -        use crate::network::transport::TransportAddr;
2025-11-10T00:08:56.5169498Z          use crate::network::peer::Peer;
2025-11-10T00:08:56.5169921Z -        
2025-11-10T00:08:56.5170275Z +        use crate::network::transport::TransportAddr;
2025-11-10T00:08:56.5170739Z +
2025-11-10T00:08:56.5171025Z          // Count current Iroh peers
2025-11-10T00:08:56.5171649Z          let current_iroh_count = {
2025-11-10T00:08:56.5172080Z              let pm = self.peer_manager.lock().unwrap();
2025-11-10T00:08:56.5173661Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:604:
2025-11-10T00:08:56.5174725Z                  .filter(|addr| matches!(addr, TransportAddr::Iroh(_)))
2025-11-10T00:08:56.5175263Z                  .count()
2025-11-10T00:08:56.5175599Z          };
2025-11-10T00:08:56.5175874Z -        
2025-11-10T00:08:56.5176157Z +
2025-11-10T00:08:56.5176474Z          if current_iroh_count >= target_count {
2025-11-10T00:08:56.5177331Z              return Ok(0);
2025-11-10T00:08:56.5177675Z          }
2025-11-10T00:08:56.5178280Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:611:
2025-11-10T00:08:56.5178974Z -        
2025-11-10T00:08:56.5179233Z +
2025-11-10T00:08:56.5179552Z          let needed = target_count - current_iroh_count;
2025-11-10T00:08:56.5180301Z -        info!("Need {} more Iroh peers (current: {}, target: {})", needed, current_iroh_count, target_count);
2025-11-10T00:08:56.5180977Z -        
2025-11-10T00:08:56.5181229Z +        info!(
2025-11-10T00:08:56.5181598Z +            "Need {} more Iroh peers (current: {}, target: {})",
2025-11-10T00:08:56.5182107Z +            needed, current_iroh_count, target_count
2025-11-10T00:08:56.5182528Z +        );
2025-11-10T00:08:56.5182774Z +
2025-11-10T00:08:56.5183073Z          // Get fresh Iroh NodeIds from database
2025-11-10T00:08:56.5183503Z          let node_ids = {
2025-11-10T00:08:56.5183913Z              let db = self.address_database.lock().unwrap();
2025-11-10T00:08:56.5184868Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:618:
2025-11-10T00:08:56.5185748Z              db.get_fresh_iroh_addresses(needed * 2) // Get 2x needed for retries
2025-11-10T00:08:56.5186314Z          };
2025-11-10T00:08:56.5186582Z -        
2025-11-10T00:08:56.5186827Z +
2025-11-10T00:08:56.5187084Z          if node_ids.is_empty() {
2025-11-10T00:08:56.5187564Z              warn!("No fresh Iroh addresses available in database");
2025-11-10T00:08:56.5188080Z              return Ok(0);
2025-11-10T00:08:56.5188723Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:624:
2025-11-10T00:08:56.5189462Z          }
2025-11-10T00:08:56.5189736Z -        
2025-11-10T00:08:56.5190014Z +
2025-11-10T00:08:56.5190289Z          // Get Iroh transport
2025-11-10T00:08:56.5190763Z          let iroh_transport = match &self.iroh_transport {
2025-11-10T00:08:56.5191293Z              Some(transport) => transport,
2025-11-10T00:08:56.5192058Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:631:
2025-11-10T00:08:56.5193238Z                  return Ok(0);
2025-11-10T00:08:56.5193613Z              }
2025-11-10T00:08:56.5193899Z          };
2025-11-10T00:08:56.5194183Z -        
2025-11-10T00:08:56.5194642Z +
2025-11-10T00:08:56.5194957Z          // Try to connect to Iroh peers
2025-11-10T00:08:56.5195418Z          let mut connected = 0;
2025-11-10T00:08:56.5196208Z          for node_id in node_ids.into_iter().take(needed * 2) {
2025-11-10T00:08:56.5197057Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:638:
2025-11-10T00:08:56.5197875Z              let node_id_bytes = node_id.as_bytes().to_vec();
2025-11-10T00:08:56.5198553Z              let transport_addr = TransportAddr::Iroh(node_id_bytes.clone());
2025-11-10T00:08:56.5199122Z -            
2025-11-10T00:08:56.5199409Z +
2025-11-10T00:08:56.5199732Z              // Connect directly using Iroh transport
2025-11-10T00:08:56.5200324Z              match iroh_transport.connect(transport_addr.clone()).await {
2025-11-10T00:08:56.5200910Z                  Ok(conn) => {
2025-11-10T00:08:56.5201603Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:650:
2025-11-10T00:08:56.5202346Z                          transport_addr.clone(),
2025-11-10T00:08:56.5203050Z                          self.peer_tx.clone(),
2025-11-10T00:08:56.5203482Z                      );
2025-11-10T00:08:56.5203798Z -                    
2025-11-10T00:08:56.5204086Z +
2025-11-10T00:08:56.5204552Z                      // Add peer to manager
2025-11-10T00:08:56.5204966Z                      {
2025-11-10T00:08:56.5205374Z                          let mut pm = self.peer_manager.lock().unwrap();
2025-11-10T00:08:56.5206202Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:659:
2025-11-10T00:08:56.5206927Z                              continue;
2025-11-10T00:08:56.5207289Z                          }
2025-11-10T00:08:56.5207610Z                      }
2025-11-10T00:08:56.5207922Z -                    
2025-11-10T00:08:56.5208219Z +
2025-11-10T00:08:56.5208526Z                      // Store mapping for Iroh (if needed)
2025-11-10T00:08:56.5208955Z                      {
2025-11-10T00:08:56.5209487Z                          let mut socket_to_transport = self.socket_to_transport.lock().unwrap();
2025-11-10T00:08:56.5210430Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:666:
2025-11-10T00:08:56.5211377Z                          socket_to_transport.insert(placeholder_socket, transport_addr.clone());
2025-11-10T00:08:56.5211968Z                      }
2025-11-10T00:08:56.5212262Z -                    
2025-11-10T00:08:56.5212553Z +
2025-11-10T00:08:56.5212925Z                      info!("Successfully connected to Iroh peer: {}", node_id);
2025-11-10T00:08:56.5213466Z                      connected += 1;
2025-11-10T00:08:56.5213855Z                      if connected >= needed {
2025-11-10T00:08:56.5216393Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:677:
2025-11-10T00:08:56.5217140Z                  }
2025-11-10T00:08:56.5217432Z              }
2025-11-10T00:08:56.5217717Z          }
2025-11-10T00:08:56.5217962Z -        
2025-11-10T00:08:56.5218443Z -        info!("Connected to {} new Iroh peers from address database", connected);
2025-11-10T00:08:56.5219059Z +
2025-11-10T00:08:56.5219325Z +        info!(
2025-11-10T00:08:56.5219743Z +            "Connected to {} new Iroh peers from address database",
2025-11-10T00:08:56.5220269Z +            connected
2025-11-10T00:08:56.5220578Z +        );
2025-11-10T00:08:56.5220860Z          Ok(connected)
2025-11-10T00:08:56.5221172Z      }
2025-11-10T00:08:56.5221428Z  
2025-11-10T00:08:56.5222031Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:685:
2025-11-10T00:08:56.5222913Z      /// Connect to peers from address database when below target count
2025-11-10T00:08:56.5223475Z -    /// 
2025-11-10T00:08:56.5223741Z +    ///
2025-11-10T00:08:56.5224239Z      /// Works with both SocketAddr-based addresses (TCP/Quinn) and Iroh NodeIds.
2025-11-10T00:08:56.5225328Z      pub async fn connect_peers_from_database(&self, target_count: usize) -> Result<usize> {
2025-11-10T00:08:56.5226087Z          let current_count = self.peer_count();
2025-11-10T00:08:56.5226865Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:692:
2025-11-10T00:08:56.5227868Z          }
2025-11-10T00:08:56.5228142Z  
2025-11-10T00:08:56.5228462Z          let needed = target_count - current_count;
2025-11-10T00:08:56.5229190Z -        info!("Need {} more peers (current: {}, target: {})", needed, current_count, target_count);
2025-11-10T00:08:56.5229840Z +        info!(
2025-11-10T00:08:56.5230211Z +            "Need {} more peers (current: {}, target: {})",
2025-11-10T00:08:56.5230695Z +            needed, current_count, target_count
2025-11-10T00:08:56.5231093Z +        );
2025-11-10T00:08:56.5233228Z  
2025-11-10T00:08:56.5233497Z          // Get fresh addresses from database
2025-11-10T00:08:56.5234018Z          let ban_list = self.ban_list.lock().unwrap().clone();
2025-11-10T00:08:56.5235027Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:715:
2025-11-10T00:08:56.5236019Z          // Convert addresses to SocketAddrs first
2025-11-10T00:08:56.5237473Z          let sockets: Vec<SocketAddr> = {
2025-11-10T00:08:56.5238282Z              let db = self.address_database.lock().unwrap();
2025-11-10T00:08:56.5238772Z -            addresses.iter()
2025-11-10T00:08:56.5239145Z +            addresses
2025-11-10T00:08:56.5239470Z +                .iter()
2025-11-10T00:08:56.5239813Z                  .take(needed * 2)
2025-11-10T00:08:56.5240255Z                  .map(|addr| db.network_addr_to_socket(addr))
2025-11-10T00:08:56.5240717Z                  .collect()
2025-11-10T00:08:56.5241821Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:724:
2025-11-10T00:08:56.5242600Z          // Try to connect to addresses
2025-11-10T00:08:56.5245176Z          let mut connected = 0;
2025-11-10T00:08:56.5245575Z          for socket in sockets {
2025-11-10T00:08:56.5245943Z -
2025-11-10T00:08:56.5246306Z              if let Err(e) = self.connect_to_peer(socket).await {
2025-11-10T00:08:56.5246913Z                  debug!("Failed to connect to {}: {}", socket, e);
2025-11-10T00:08:56.5247460Z                  // Continue trying other addresses
2025-11-10T00:08:56.5248238Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:737:
2025-11-10T00:08:56.5249496Z          }
2025-11-10T00:08:56.5249771Z  
2025-11-10T00:08:56.5250222Z          info!("Connected to {} new peers from address database", connected);
2025-11-10T00:08:56.5250779Z -        
2025-11-10T00:08:56.5251040Z +
2025-11-10T00:08:56.5253283Z          // Also try to connect Iroh peers if Iroh is enabled
2025-11-10T00:08:56.5253777Z          #[cfg(feature = "iroh")]
2025-11-10T00:08:56.5254236Z          if self.transport_preference.allows_iroh() {
2025-11-10T00:08:56.5255305Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:744:
2025-11-10T00:08:56.5256321Z              let iroh_connected = self.connect_iroh_peers_from_database(target_count).await?;
2025-11-10T00:08:56.5256984Z              connected += iroh_connected;
2025-11-10T00:08:56.5257384Z          }
2025-11-10T00:08:56.5257634Z -        
2025-11-10T00:08:56.5257888Z +
2025-11-10T00:08:56.5258129Z          Ok(connected)
2025-11-10T00:08:56.5258441Z      }
2025-11-10T00:08:56.5258704Z  
2025-11-10T00:08:56.5259260Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:751:
2025-11-10T00:08:56.5260038Z      /// Initialize peer connections after startup
2025-11-10T00:08:56.5260460Z -    /// 
2025-11-10T00:08:56.5260713Z +    ///
2025-11-10T00:08:56.5261043Z      /// This is automatically called by `start()` to:
2025-11-10T00:08:56.5261657Z      /// 1. Discover peers from DNS seeds (for TCP/Quinn transports)
2025-11-10T00:08:56.5262247Z      /// 2. Connect to persistent peers from config
2025-11-10T00:08:56.5262997Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:756:
2025-11-10T00:08:56.5265500Z      /// 3. Discover Iroh peers (if Iroh is enabled) - uses Iroh's DERP servers and gossip
2025-11-10T00:08:56.5266531Z      /// 4. Connect to peers from address database to reach target count
2025-11-10T00:08:56.5267504Z -    /// 
2025-11-10T00:08:56.5267778Z +    ///
2025-11-10T00:08:56.5268338Z      /// Note: The address database now supports both SocketAddr-based addresses (TCP/Quinn)
2025-11-10T00:08:56.5269137Z      /// and Iroh NodeIds. Iroh peers are discovered through:
2025-11-10T00:08:56.5269733Z      /// - DERP servers (handled by Iroh's MagicEndpoint)
2025-11-10T00:08:56.5270554Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:770:
2025-11-10T00:08:56.5271305Z          target_peer_count: usize,
2025-11-10T00:08:56.5271704Z      ) -> Result<()> {
2025-11-10T00:08:56.5272198Z          // 1. Discover peers from DNS seeds (only for TCP/Quinn, not Iroh)
2025-11-10T00:08:56.5273199Z -        let should_discover_dns = self.transport_preference.allows_tcp() || 
2025-11-10T00:08:56.5274234Z +        let should_discover_dns = self.transport_preference.allows_tcp() || {
2025-11-10T00:08:56.5277036Z +            #[cfg(feature = "quinn")]
2025-11-10T00:08:56.5277448Z              {
2025-11-10T00:08:56.5277784Z -                #[cfg(feature = "quinn")]
2025-11-10T00:08:56.5278207Z -                {
2025-11-10T00:08:56.5278590Z -                    self.transport_preference.allows_quinn()
2025-11-10T00:08:56.5279067Z -                }
2025-11-10T00:08:56.5279411Z -                #[cfg(not(feature = "quinn"))]
2025-11-10T00:08:56.5279849Z -                {
2025-11-10T00:08:56.5280160Z -                    false
2025-11-10T00:08:56.5280506Z -                }
2025-11-10T00:08:56.5280797Z -            };
2025-11-10T00:08:56.5281181Z +                self.transport_preference.allows_quinn()
2025-11-10T00:08:56.5281620Z +            }
2025-11-10T00:08:56.5281954Z +            #[cfg(not(feature = "quinn"))]
2025-11-10T00:08:56.5282381Z +            {
2025-11-10T00:08:56.5282675Z +                false
2025-11-10T00:08:56.5282992Z +            }
2025-11-10T00:08:56.5283279Z +        };
2025-11-10T00:08:56.5283586Z          if should_discover_dns {
2025-11-10T00:08:56.5284136Z              if let Err(e) = self.discover_peers_from_dns(network, port).await {
2025-11-10T00:08:56.5286872Z                  warn!("DNS seed discovery failed: {}", e);
2025-11-10T00:08:56.5287678Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:807:
2025-11-10T00:08:56.5288552Z          // 4. Connect to peers from address database to reach target count
2025-11-10T00:08:56.5289180Z          // Wait a bit for persistent peers to connect first
2025-11-10T00:08:56.5289797Z          tokio::time::sleep(tokio::time::Duration::from_secs(2)).await;
2025-11-10T00:08:56.5290301Z -        
2025-11-10T00:08:56.5290557Z +
2025-11-10T00:08:56.5291025Z          if let Err(e) = self.connect_peers_from_database(target_peer_count).await {
2025-11-10T00:08:56.5291748Z              warn!("Failed to connect peers from database: {}", e);
2025-11-10T00:08:56.5292248Z          }
2025-11-10T00:08:56.5292705Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:821:
2025-11-10T00:08:56.5292991Z              "Starting network manager with transport preference: {:?}",
2025-11-10T00:08:56.5293155Z              self.transport_preference
2025-11-10T00:08:56.5293267Z          );
2025-11-10T00:08:56.5293378Z -        
2025-11-10T00:08:56.5293494Z +
2025-11-10T00:08:56.5293636Z          // Start listening first
2025-11-10T00:08:56.5293743Z  
2025-11-10T00:08:56.5293924Z          // Initialize Quinn transport if enabled
2025-11-10T00:08:56.5296126Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:886:
2025-11-10T00:08:56.5296476Z                              let ip = socket_addr.ip();
2025-11-10T00:08:56.5296697Z                              if !dos_protection.check_connection(ip).await {
2025-11-10T00:08:56.5297086Z                                  warn!("Connection rate limit exceeded for IP {}, rejecting connection", ip);
2025-11-10T00:08:56.5297493Z -                                
2025-11-10T00:08:56.5297602Z +
2025-11-10T00:08:56.5297796Z                                  // Check if we should auto-ban
2025-11-10T00:08:56.5298008Z                                  if dos_protection.should_auto_ban(ip).await {
2025-11-10T00:08:56.5298786Z                                      warn!("Auto-banning IP {} for repeated connection rate violations", ip);
2025-11-10T00:08:56.5299271Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:899:
2025-11-10T00:08:56.5299502Z                                      let mut ban_list_guard = ban_list.lock().unwrap();
2025-11-10T00:08:56.5299743Z                                      ban_list_guard.insert(socket_addr, unban_timestamp);
2025-11-10T00:08:56.5300264Z                                  }
2025-11-10T00:08:56.5300411Z -                                
2025-11-10T00:08:56.5300758Z +
2025-11-10T00:08:56.5300959Z                                  // Close connection immediately
2025-11-10T00:08:56.5301128Z                                  drop(conn);
2025-11-10T00:08:56.5301270Z                                  continue;
2025-11-10T00:08:56.5301737Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:910:
2025-11-10T00:08:56.5301957Z                                  let pm = peer_manager_clone.lock().unwrap();
2025-11-10T00:08:56.5302107Z                                  pm.peer_count()
2025-11-10T00:08:56.5302230Z                              };
2025-11-10T00:08:56.5302585Z -                            if !dos_protection.check_active_connections(current_connections).await {
2025-11-10T00:08:56.5302743Z +                            if !dos_protection
2025-11-10T00:08:56.5302957Z +                                .check_active_connections(current_connections)
2025-11-10T00:08:56.5303086Z +                                .await
2025-11-10T00:08:56.5303226Z +                            {
2025-11-10T00:08:56.5303642Z                                  warn!("Active connection limit exceeded, rejecting connection from {}", socket_addr);
2025-11-10T00:08:56.5305750Z                                  drop(conn);
2025-11-10T00:08:56.5305899Z                                  continue;
2025-11-10T00:08:56.5306355Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:918:
2025-11-10T00:08:56.5306465Z  
2025-11-10T00:08:56.5306642Z                              // Send connection notification
2025-11-10T00:08:56.5306913Z                              let transport_addr = TransportAddr::Tcp(socket_addr);
2025-11-10T00:08:56.5307287Z -                            let _ = peer_tx.send(NetworkMessage::PeerConnected(transport_addr.clone()));
2025-11-10T00:08:56.5307417Z +                            let _ =
2025-11-10T00:08:56.5307771Z +                                peer_tx.send(NetworkMessage::PeerConnected(transport_addr.clone()));
2025-11-10T00:08:56.5307890Z  
2025-11-10T00:08:56.5308174Z                              // Handle connection in background with graceful error handling
2025-11-10T00:08:56.5308371Z                              let peer_tx_clone = peer_tx.clone();
2025-11-10T00:08:56.5308828Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:927:
2025-11-10T00:08:56.5309023Z                                  // Create peer from transport connection
2025-11-10T00:08:56.5309219Z                                  use crate::network::peer::Peer;
2025-11-10T00:08:56.5309436Z                                  use crate::network::transport::TransportAddr;
2025-11-10T00:08:56.5309653Z -                                
2025-11-10T00:08:56.5309765Z +
2025-11-10T00:08:56.5309995Z                                  let peer = peer::Peer::from_transport_connection(
2025-11-10T00:08:56.5310126Z                                      conn,
2025-11-10T00:08:56.5310282Z                                      socket_addr,
2025-11-10T00:08:56.5310752Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:934:
2025-11-10T00:08:56.5311260Z                                      TransportAddr::Tcp(socket_addr),
2025-11-10T00:08:56.5311429Z                                      peer_tx_clone.clone(),
2025-11-10T00:08:56.5311555Z                                  );
2025-11-10T00:08:56.5311671Z -                                
2025-11-10T00:08:56.5311860Z +
2025-11-10T00:08:56.5312102Z                                  // Add peer to manager (with graceful error handling)
2025-11-10T00:08:56.5312300Z                                  match peer_manager_for_peer.lock() {
2025-11-10T00:08:56.5312454Z                                      Ok(mut pm) => {
2025-11-10T00:08:56.5312904Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:941:
2025-11-10T00:08:56.5313178Z                                          if let Err(e) = pm.add_peer(transport_addr.clone(), peer) {
2025-11-10T00:08:56.5315255Z                                              warn!("Failed to add peer {}: {}", socket_addr, e);
2025-11-10T00:08:56.5315823Z -                                            let _ = peer_tx_clone.send(NetworkMessage::PeerDisconnected(transport_addr.clone()));
2025-11-10T00:08:56.5316018Z +                                            let _ = peer_tx_clone.send(
2025-11-10T00:08:56.5316304Z +                                                NetworkMessage::PeerDisconnected(
2025-11-10T00:08:56.5316481Z +                                                    transport_addr.clone(),
2025-11-10T00:08:56.5316631Z +                                                ),
2025-11-10T00:08:56.5316846Z +                                            );
2025-11-10T00:08:56.5316989Z                                              return;
2025-11-10T00:08:56.5317186Z                                          }
2025-11-10T00:08:56.5317989Z -                                        info!("Successfully added peer {} (transport: {:?})", socket_addr, transport_addr);
2025-11-10T00:08:56.5318133Z +                                        info!(
2025-11-10T00:08:56.5318372Z +                                            "Successfully added peer {} (transport: {:?})",
2025-11-10T00:08:56.5318554Z +                                            socket_addr, transport_addr
2025-11-10T00:08:56.5318675Z +                                        );
2025-11-10T00:08:56.5318795Z                                      }
2025-11-10T00:08:56.5318947Z                                      Err(e) => {
2025-11-10T00:08:56.5319240Z -                                        warn!("Failed to lock peer manager for {}: {}", socket_addr, e);
2025-11-10T00:08:56.5319668Z -                                        let _ = peer_tx_clone.send(NetworkMessage::PeerDisconnected(transport_addr.clone()));
2025-11-10T00:08:56.5319809Z +                                        warn!(
2025-11-10T00:08:56.5320017Z +                                            "Failed to lock peer manager for {}: {}",
2025-11-10T00:08:56.5320173Z +                                            socket_addr, e
2025-11-10T00:08:56.5320303Z +                                        );
2025-11-10T00:08:56.5320444Z +                                        let _ =
2025-11-10T00:08:56.5320708Z +                                            peer_tx_clone.send(NetworkMessage::PeerDisconnected(
2025-11-10T00:08:56.5320869Z +                                                transport_addr.clone(),
2025-11-10T00:08:56.5321001Z +                                            ));
2025-11-10T00:08:56.5321131Z                                          return;
2025-11-10T00:08:56.5321254Z                                      }
2025-11-10T00:08:56.5321387Z                                  }
2025-11-10T00:08:56.5321849Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:954:
2025-11-10T00:08:56.5321972Z -                                
2025-11-10T00:08:56.5322082Z +
2025-11-10T00:08:56.5322442Z                                  // Connection will be cleaned up automatically when read/write tasks exit
2025-11-10T00:08:56.5323103Z                                  // Peer removal happens in process_messages when PeerDisconnected is received
2025-11-10T00:08:56.5323231Z                              });
2025-11-10T00:08:56.5323767Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:974:
2025-11-10T00:08:56.5323988Z                      let peer_manager = Arc::clone(&self.peer_manager);
2025-11-10T00:08:56.5324711Z                      let dos_protection = Arc::clone(&self.dos_protection);
2025-11-10T00:08:56.5324906Z                      let ban_list = Arc::clone(&self.ban_list);
2025-11-10T00:08:56.5325017Z -                    
2025-11-10T00:08:56.5325118Z +
2025-11-10T00:08:56.5325273Z                      tokio::spawn(async move {
2025-11-10T00:08:56.5325388Z                          loop {
2025-11-10T00:08:56.5325759Z                              match quinn_listener.accept().await {
2025-11-10T00:08:56.5326198Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:993:
2025-11-10T00:08:56.5326377Z                                      let ip = socket_addr.ip();
2025-11-10T00:08:56.5326583Z                                      if !dos_protection.check_connection(ip).await {
2025-11-10T00:08:56.5326961Z                                          warn!("Connection rate limit exceeded for IP {}, rejecting Quinn connection", ip);
2025-11-10T00:08:56.5327094Z -                                        
2025-11-10T00:08:56.5327193Z +
2025-11-10T00:08:56.5327392Z                                          if dos_protection.should_auto_ban(ip).await {
2025-11-10T00:08:56.5327713Z                                              warn!("Auto-banning IP {} for repeated connection rate violations", ip);
2025-11-10T00:08:56.5327946Z                                              let unban_timestamp = std::time::SystemTime::now()
2025-11-10T00:08:56.5328397Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1013:
2025-11-10T00:08:56.5328608Z                                          let pm = peer_manager.lock().unwrap();
2025-11-10T00:08:56.5328768Z                                          pm.peer_count()
2025-11-10T00:08:56.5328892Z                                      };
2025-11-10T00:08:56.5329318Z -                                    if !dos_protection.check_active_connections(current_connections).await {
2025-11-10T00:08:56.5329487Z +                                    if !dos_protection
2025-11-10T00:08:56.5329709Z +                                        .check_active_connections(current_connections)
2025-11-10T00:08:56.5329841Z +                                        .await
2025-11-10T00:08:56.5329974Z +                                    {
2025-11-10T00:08:56.5330434Z                                          warn!("Active connection limit exceeded, rejecting Quinn connection from {}", socket_addr);
2025-11-10T00:08:56.5330593Z                                          drop(conn);
2025-11-10T00:08:56.5330754Z                                          continue;
2025-11-10T00:08:56.5331223Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1021:
2025-11-10T00:08:56.5331403Z  
2025-11-10T00:08:56.5331594Z                                      // Send connection notification
2025-11-10T00:08:56.5331911Z                                      let quinn_transport_addr = TransportAddr::Quinn(socket_addr);
2025-11-10T00:08:56.5332323Z -                                    let _ = peer_tx.send(NetworkMessage::PeerConnected(quinn_transport_addr.clone()));
2025-11-10T00:08:56.5332559Z +                                    let _ = peer_tx.send(NetworkMessage::PeerConnected(
2025-11-10T00:08:56.5332745Z +                                        quinn_transport_addr.clone(),
2025-11-10T00:08:56.5332919Z +                                    ));
2025-11-10T00:08:56.5333016Z  
2025-11-10T00:08:56.5333317Z                                      // Handle connection in background with graceful error handling
2025-11-10T00:08:56.5333751Z                                      let peer_tx_clone = peer_tx.clone();
2025-11-10T00:08:56.5334209Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1029:
2025-11-10T00:08:56.5334581Z                                      tokio::spawn(async move {
2025-11-10T00:08:56.5334776Z                                          use crate::network::peer::Peer;
2025-11-10T00:08:56.5335000Z                                          use crate::network::transport::TransportAddr;
2025-11-10T00:08:56.5335141Z -                                        
2025-11-10T00:08:56.5335250Z +
2025-11-10T00:08:56.5335491Z                                          let quinn_addr = TransportAddr::Quinn(socket_addr);
2025-11-10T00:08:56.5335724Z                                          let peer = peer::Peer::from_transport_connection(
2025-11-10T00:08:56.5336091Z                                              conn,
2025-11-10T00:08:56.5336559Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1037:
2025-11-10T00:08:56.5336716Z                                              quinn_addr,
2025-11-10T00:08:56.5336894Z                                              peer_tx_clone.clone(),
2025-11-10T00:08:56.5337020Z                                          );
2025-11-10T00:08:56.5337139Z -                                        
2025-11-10T00:08:56.5337252Z +
2025-11-10T00:08:56.5337474Z                                          // Add peer to manager (with graceful error handling)
2025-11-10T00:08:56.5337652Z                                          match peer_manager_clone.lock() {
2025-11-10T00:08:56.5337796Z                                              Ok(mut pm) => {
2025-11-10T00:08:56.5338249Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1044:
2025-11-10T00:08:56.5338504Z -                                                if let Err(e) = pm.add_peer(quinn_addr.clone(), peer) {
2025-11-10T00:08:56.5338774Z -                                                    warn!("Failed to add Quinn peer {}: {}", socket_addr, e);
2025-11-10T00:08:56.5339172Z -                                                    let _ = peer_tx_clone.send(NetworkMessage::PeerDisconnected(quinn_addr.clone()));
2025-11-10T00:08:56.5339328Z +                                                if let Err(e) =
2025-11-10T00:08:56.5339519Z +                                                    pm.add_peer(quinn_addr.clone(), peer)
2025-11-10T00:08:56.5339656Z +                                                {
2025-11-10T00:08:56.5339801Z +                                                    warn!(
2025-11-10T00:08:56.5339977Z +                                                        "Failed to add Quinn peer {}: {}",
2025-11-10T00:08:56.5340142Z +                                                        socket_addr, e
2025-11-10T00:08:56.5340288Z +                                                    );
2025-11-10T00:08:56.5340465Z +                                                    let _ = peer_tx_clone.send(
2025-11-10T00:08:56.5340680Z +                                                        NetworkMessage::PeerDisconnected(
2025-11-10T00:08:56.5340851Z +                                                            quinn_addr.clone(),
2025-11-10T00:08:56.5340985Z +                                                        ),
2025-11-10T00:08:56.5341114Z +                                                    );
2025-11-10T00:08:56.5343152Z                                                      return;
2025-11-10T00:08:56.5343285Z                                                  }
2025-11-10T00:08:56.5343549Z -                                                info!("Successfully added Quinn peer {}", socket_addr);
2025-11-10T00:08:56.5343696Z +                                                info!(
2025-11-10T00:08:56.5343896Z +                                                    "Successfully added Quinn peer {}",
2025-11-10T00:08:56.5344042Z +                                                    socket_addr
2025-11-10T00:08:56.5344584Z +                                                );
2025-11-10T00:08:56.5344722Z                                              }
2025-11-10T00:08:56.5344870Z                                              Err(e) => {
2025-11-10T00:08:56.5345217Z                                                  warn!("Failed to lock peer manager for Quinn peer {}: {}", socket_addr, e);
2025-11-10T00:08:56.5345658Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1053:
2025-11-10T00:08:56.5346070Z -                                                let _ = peer_tx_clone.send(NetworkMessage::PeerDisconnected(quinn_addr.clone()));
2025-11-10T00:08:56.5346237Z +                                                let _ = peer_tx_clone.send(
2025-11-10T00:08:56.5346694Z +                                                    NetworkMessage::PeerDisconnected(
2025-11-10T00:08:56.5346866Z +                                                        quinn_addr.clone(),
2025-11-10T00:08:56.5347008Z +                                                    ),
2025-11-10T00:08:56.5347151Z +                                                );
2025-11-10T00:08:56.5347288Z                                                  return;
2025-11-10T00:08:56.5347411Z                                              }
2025-11-10T00:08:56.5347542Z                                          }
2025-11-10T00:08:56.5347982Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1065:
2025-11-10T00:08:56.5348102Z                      });
2025-11-10T00:08:56.5348214Z                  }
2025-11-10T00:08:56.5348353Z                  Err(e) => {
2025-11-10T00:08:56.5348666Z -                    warn!("Failed to start Quinn listener (graceful degradation): {}", e);
2025-11-10T00:08:56.5348788Z +                    warn!(
2025-11-10T00:08:56.5349050Z +                        "Failed to start Quinn listener (graceful degradation): {}",
2025-11-10T00:08:56.5349168Z +                        e
2025-11-10T00:08:56.5349280Z +                    );
2025-11-10T00:08:56.5349561Z                      // Continue with other transports - don't fail entire startup
2025-11-10T00:08:56.5349675Z                  }
2025-11-10T00:08:56.5349783Z              }
2025-11-10T00:08:56.5350226Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1107:
2025-11-10T00:08:56.5350427Z                                          let pm = peer_manager.lock().unwrap();
2025-11-10T00:08:56.5350581Z                                          pm.peer_count()
2025-11-10T00:08:56.5350706Z                                      };
2025-11-10T00:08:56.5351066Z -                                    if !dos_protection.check_active_connections(current_connections).await {
2025-11-10T00:08:56.5351216Z +                                    if !dos_protection
2025-11-10T00:08:56.5351443Z +                                        .check_active_connections(current_connections)
2025-11-10T00:08:56.5353217Z +                                        .await
2025-11-10T00:08:56.5353340Z +                                    {
2025-11-10T00:08:56.5353664Z                                          warn!("Active connection limit exceeded, rejecting Iroh connection");
2025-11-10T00:08:56.5353804Z                                          drop(conn);
2025-11-10T00:08:56.5353947Z                                          continue;
2025-11-10T00:08:56.5354569Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1114:
2025-11-10T00:08:56.5354692Z                                      }
2025-11-10T00:08:56.5354810Z  
2025-11-10T00:08:56.5355085Z                                      // Send connection notification using TransportAddr directly
2025-11-10T00:08:56.5355431Z -                                    let _ = peer_tx.send(NetworkMessage::PeerConnected(iroh_addr.clone()));
2025-11-10T00:08:56.5355605Z +                                    let _ = peer_tx
2025-11-10T00:08:56.5356104Z +                                        .send(NetworkMessage::PeerConnected(iroh_addr.clone()));
2025-11-10T00:08:56.5356208Z  
2025-11-10T00:08:56.5356509Z                                      // Handle connection in background with graceful error handling
2025-11-10T00:08:56.5356698Z                                      let peer_tx_clone = peer_tx.clone();
2025-11-10T00:08:56.5357150Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1121:
2025-11-10T00:08:56.5357383Z                                      let peer_manager_clone = Arc::clone(&peer_manager);
2025-11-10T00:08:56.5357575Z                                      let iroh_addr_clone = iroh_addr.clone();
2025-11-10T00:08:56.5357884Z -                                    let socket_to_transport_clone = Arc::clone(&socket_to_transport);
2025-11-10T00:08:56.5358228Z +                                    let socket_to_transport_clone =
2025-11-10T00:08:56.5358425Z +                                        Arc::clone(&socket_to_transport);
2025-11-10T00:08:56.5358714Z                                      let address_database_clone = Arc::clone(&address_database);
2025-11-10T00:08:56.5358887Z                                      tokio::spawn(async move {
2025-11-10T00:08:56.5359081Z                                          use crate::network::peer::Peer;
2025-11-10T00:08:56.5359538Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1127:
2025-11-10T00:08:56.5359675Z -                                        
2025-11-10T00:08:56.5359790Z +
2025-11-10T00:08:56.5360087Z                                          // For Iroh, we need a SocketAddr for Peer::from_transport_connection
2025-11-10T00:08:56.5360373Z                                          // Generate a unique placeholder based on key hash for lookups
2025-11-10T00:08:56.5360797Z -                                        let placeholder_socket = if let TransportAddr::Iroh(ref key) = iroh_addr_clone {
2025-11-10T00:08:56.5361186Z -                                            // Use first 4 bytes of key for IP, last 2 bytes for port to create unique placeholder
2025-11-10T00:08:56.5372843Z -                                            let ip_bytes = if key.len() >= 4 {
2025-11-10T00:08:56.5373128Z -                                                [key[0], key[1], key[2], key[3]]
2025-11-10T00:08:56.5373312Z +                                        let placeholder_socket =
2025-11-10T00:08:56.5373583Z +                                            if let TransportAddr::Iroh(ref key) = iroh_addr_clone {
2025-11-10T00:08:56.5373966Z +                                                // Use first 4 bytes of key for IP, last 2 bytes for port to create unique placeholder
2025-11-10T00:08:56.5374149Z +                                                let ip_bytes = if key.len() >= 4 {
2025-11-10T00:08:56.5374499Z +                                                    [key[0], key[1], key[2], key[3]]
2025-11-10T00:08:56.5374648Z +                                                } else {
2025-11-10T00:08:56.5374805Z +                                                    [0, 0, 0, 0]
2025-11-10T00:08:56.5374942Z +                                                };
2025-11-10T00:08:56.5375122Z +                                                let port = if key.len() >= 6 {
2025-11-10T00:08:56.5375283Z +                                                    u16::from_be_bytes([
2025-11-10T00:08:56.5375451Z +                                                        key[key.len() - 2],
2025-11-10T00:08:56.5375617Z +                                                        key[key.len() - 1],
2025-11-10T00:08:56.5375758Z +                                                    ])
2025-11-10T00:08:56.5375872Z +                                                } else {
2025-11-10T00:08:56.5377676Z +                                                    0
2025-11-10T00:08:56.5377811Z +                                                };
2025-11-10T00:08:56.5378035Z +                                                std::net::SocketAddr::from((ip_bytes, port))
2025-11-10T00:08:56.5378433Z                                              } else {
2025-11-10T00:08:56.5378577Z -                                                [0, 0, 0, 0]
2025-11-10T00:08:56.5378776Z +                                                std::net::SocketAddr::from(([0, 0, 0, 0], 0))
2025-11-10T00:08:56.5378915Z                                              };
2025-11-10T00:08:56.5379075Z -                                            let port = if key.len() >= 6 {
2025-11-10T00:08:56.5379307Z -                                                u16::from_be_bytes([key[key.len()-2], key[key.len()-1]])
2025-11-10T00:08:56.5379451Z -                                            } else {
2025-11-10T00:08:56.5379590Z -                                                0
2025-11-10T00:08:56.5379722Z -                                            };
2025-11-10T00:08:56.5380120Z -                                            std::net::SocketAddr::from((ip_bytes, port))
2025-11-10T00:08:56.5380273Z -                                        } else {
2025-11-10T00:08:56.5380478Z -                                            std::net::SocketAddr::from(([0, 0, 0, 0], 0))
2025-11-10T00:08:56.5380612Z -                                        };
2025-11-10T00:08:56.5380744Z -                                        
2025-11-10T00:08:56.5380852Z +
2025-11-10T00:08:56.5381074Z                                          let peer = peer::Peer::from_transport_connection(
2025-11-10T00:08:56.5381311Z                                              conn,
2025-11-10T00:08:56.5381476Z                                              placeholder_socket,
2025-11-10T00:08:56.5381933Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1150:
2025-11-10T00:08:56.5382105Z                                              iroh_addr_clone.clone(),
2025-11-10T00:08:56.5382277Z                                              peer_tx_clone.clone(),
2025-11-10T00:08:56.5382403Z                                          );
2025-11-10T00:08:56.5382527Z -                                        
2025-11-10T00:08:56.5382640Z +
2025-11-10T00:08:56.5382861Z                                          // Add peer to manager (with graceful error handling)
2025-11-10T00:08:56.5383037Z                                          match peer_manager_clone.lock() {
2025-11-10T00:08:56.5383189Z                                              Ok(mut pm) => {
2025-11-10T00:08:56.5383616Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1157:
2025-11-10T00:08:56.5383884Z -                                                if let Err(e) = pm.add_peer(iroh_addr_clone.clone(), peer) {
2025-11-10T00:08:56.5384045Z +                                                if let Err(e) =
2025-11-10T00:08:56.5384262Z +                                                    pm.add_peer(iroh_addr_clone.clone(), peer)
2025-11-10T00:08:56.5384586Z +                                                {
2025-11-10T00:08:56.5384791Z                                                      warn!("Failed to add Iroh peer: {}", e);
2025-11-10T00:08:56.5385223Z -                                                    let _ = peer_tx_clone.send(NetworkMessage::PeerDisconnected(iroh_addr_clone.clone()));
2025-11-10T00:08:56.5385404Z +                                                    let _ = peer_tx_clone.send(
2025-11-10T00:08:56.5385604Z +                                                        NetworkMessage::PeerDisconnected(
2025-11-10T00:08:56.5385787Z +                                                            iroh_addr_clone.clone(),
2025-11-10T00:08:56.5385925Z +                                                        ),
2025-11-10T00:08:56.5386066Z +                                                    );
2025-11-10T00:08:56.5386211Z                                                      return;
2025-11-10T00:08:56.5386341Z                                                  }
2025-11-10T00:08:56.5387536Z                                                  // Store mapping from placeholder SocketAddr to TransportAddr for Iroh lookups
2025-11-10T00:08:56.5387988Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1163:
2025-11-10T00:08:56.5388430Z -                                                socket_to_transport_clone.lock().unwrap().insert(placeholder_socket, iroh_addr_clone.clone());
2025-11-10T00:08:56.5388552Z -                                                
2025-11-10T00:08:56.5388773Z +                                                socket_to_transport_clone.lock().unwrap().insert(
2025-11-10T00:08:56.5388929Z +                                                    placeholder_socket,
2025-11-10T00:08:56.5389086Z +                                                    iroh_addr_clone.clone(),
2025-11-10T00:08:56.5389206Z +                                                );
2025-11-10T00:08:56.5389520Z +
2025-11-10T00:08:56.5389701Z                                                  // Store Iroh NodeId in address database
2025-11-10T00:08:56.5390003Z -                                                if let TransportAddr::Iroh(ref node_id_bytes) = iroh_addr_clone {
2025-11-10T00:08:56.5390212Z +                                                if let TransportAddr::Iroh(ref node_id_bytes) =
2025-11-10T00:08:56.5390368Z +                                                    iroh_addr_clone
2025-11-10T00:08:56.5390497Z +                                                {
2025-11-10T00:08:56.5390674Z                                                      if node_id_bytes.len() == 32 {
2025-11-10T00:08:56.5390840Z                                                          use iroh_net::NodeId;
2025-11-10T00:08:56.5391091Z -                                                        if let Ok(node_id) = NodeId::from_bytes(node_id_bytes) {
2025-11-10T00:08:56.5391377Z -                                                            let address_db_clone = address_database_clone.clone();
2025-11-10T00:08:56.5391553Z +                                                        if let Ok(node_id) =
2025-11-10T00:08:56.5391754Z +                                                            NodeId::from_bytes(node_id_bytes)
2025-11-10T00:08:56.5391901Z +                                                        {
2025-11-10T00:08:56.5392084Z +                                                            let address_db_clone =
2025-11-10T00:08:56.5392280Z +                                                                address_database_clone.clone();
2025-11-10T00:08:56.5392467Z                                                              tokio::spawn(async move {
2025-11-10T00:08:56.5392700Z -                                                                let mut db = address_db_clone.lock().unwrap();
2025-11-10T00:08:56.5393091Z -                                                                db.add_iroh_address(node_id, 0); // Services will be updated on version exchange
2025-11-10T00:08:56.5393279Z +                                                                let mut db = address_db_clone
2025-11-10T00:08:56.5393457Z +                                                                    .lock()
2025-11-10T00:08:56.5393618Z +                                                                    .unwrap();
2025-11-10T00:08:56.5395855Z +                                                                db.add_iroh_address(node_id, 0);
2025-11-10T00:08:56.5396104Z +                                                                // Services will be updated on version exchange
2025-11-10T00:08:56.5396255Z                                                              });
2025-11-10T00:08:56.5396398Z                                                          }
2025-11-10T00:08:56.5396545Z                                                      }
2025-11-10T00:08:56.5397017Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1177:
2025-11-10T00:08:56.5397159Z                                                  }
2025-11-10T00:08:56.5397547Z -                                                
2025-11-10T00:08:56.5397663Z +
2025-11-10T00:08:56.5398019Z                                                  info!("Successfully added Iroh peer (transport: {:?})", iroh_addr_clone);
2025-11-10T00:08:56.5398151Z                                              }
2025-11-10T00:08:56.5398382Z                                              Err(e) => {
2025-11-10T00:08:56.5398841Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1182:
2025-11-10T00:08:56.5399115Z -                                                warn!("Failed to lock peer manager for Iroh peer: {}", e);
2025-11-10T00:08:56.5399576Z -                                                let _ = peer_tx_clone.send(NetworkMessage::PeerDisconnected(iroh_addr_clone.clone()));
2025-11-10T00:08:56.5399973Z +                                                warn!(
2025-11-10T00:08:56.5400234Z +                                                    "Failed to lock peer manager for Iroh peer: {}",
2025-11-10T00:08:56.5400399Z +                                                    e
2025-11-10T00:08:56.5400536Z +                                                );
2025-11-10T00:08:56.5400714Z +                                                let _ = peer_tx_clone.send(
2025-11-10T00:08:56.5400937Z +                                                    NetworkMessage::PeerDisconnected(
2025-11-10T00:08:56.5401116Z +                                                        iroh_addr_clone.clone(),
2025-11-10T00:08:56.5401255Z +                                                    ),
2025-11-10T00:08:56.5401392Z +                                                );
2025-11-10T00:08:56.5401556Z                                                  return;
2025-11-10T00:08:56.5401685Z                                              }
2025-11-10T00:08:56.5401889Z                                          }
2025-11-10T00:08:56.5402405Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1195:
2025-11-10T00:08:56.5402530Z                      });
2025-11-10T00:08:56.5402647Z                  }
2025-11-10T00:08:56.5402777Z                  Err(e) => {
2025-11-10T00:08:56.5403094Z -                    warn!("Failed to start Iroh listener (graceful degradation): {}", e);
2025-11-10T00:08:56.5403210Z +                    warn!(
2025-11-10T00:08:56.5403467Z +                        "Failed to start Iroh listener (graceful degradation): {}",
2025-11-10T00:08:56.5403598Z +                        e
2025-11-10T00:08:56.5403720Z +                    );
2025-11-10T00:08:56.5404001Z                      // Continue with other transports - don't fail entire startup
2025-11-10T00:08:56.5406070Z                  }
2025-11-10T00:08:56.5406186Z              }
2025-11-10T00:08:56.5406647Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1203:
2025-11-10T00:08:56.5406763Z  
2025-11-10T00:08:56.5406922Z          // Start periodic ban cleanup task
2025-11-10T00:08:56.5407071Z          self.start_ban_cleanup_task();
2025-11-10T00:08:56.5407180Z -        
2025-11-10T00:08:56.5407294Z +
2025-11-10T00:08:56.5407448Z          // Start pending request cleanup task
2025-11-10T00:08:56.5407587Z          self.start_request_cleanup_task();
2025-11-10T00:08:56.5407686Z -        
2025-11-10T00:08:56.5407787Z +
2025-11-10T00:08:56.5407931Z          // Start DoS protection cleanup task
2025-11-10T00:08:56.5408097Z          self.start_dos_protection_cleanup_task();
2025-11-10T00:08:56.5408215Z -        
2025-11-10T00:08:56.5408320Z +
2025-11-10T00:08:56.5408697Z          // Note: Peer connection initialization (DNS seeds, persistent peers, etc.)
2025-11-10T00:08:56.5409032Z          // should be called separately via initialize_peer_connections() after start()
2025-11-10T00:08:56.5409396Z          // This allows the caller to provide config, network type, and target peer count
2025-11-10T00:08:56.5409820Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1216:
2025-11-10T00:08:56.5410135Z -        
2025-11-10T00:08:56.5410239Z +
2025-11-10T00:08:56.5410338Z          Ok(())
2025-11-10T00:08:56.5410434Z      }
2025-11-10T00:08:56.5410530Z -    
2025-11-10T00:08:56.5410631Z +
2025-11-10T00:08:56.5410891Z      /// Generate a new request ID for async request-response patterns
2025-11-10T00:08:56.5411059Z      pub fn generate_request_id(&self) -> u64 {
2025-11-10T00:08:56.5411288Z          let mut counter = self.request_id_counter.lock().unwrap();
2025-11-10T00:08:56.5411703Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1224:
2025-11-10T00:08:56.5411855Z          *counter = counter.wrapping_add(1);
2025-11-10T00:08:56.5411968Z          id
2025-11-10T00:08:56.5412065Z      }
2025-11-10T00:08:56.5412160Z -    
2025-11-10T00:08:56.5412252Z +
2025-11-10T00:08:56.5413150Z      /// Register a pending request and return the response receiver
2025-11-10T00:08:56.5413334Z      /// Returns (request_id, response_receiver)
2025-11-10T00:08:56.5413816Z -    pub fn register_request(&self, peer_addr: SocketAddr) -> (u64, tokio::sync::oneshot::Receiver<Vec<u8>>) {
2025-11-10T00:08:56.5413953Z +    pub fn register_request(
2025-11-10T00:08:56.5414054Z +        &self,
2025-11-10T00:08:56.5414178Z +        peer_addr: SocketAddr,
2025-11-10T00:08:56.5414560Z +    ) -> (u64, tokio::sync::oneshot::Receiver<Vec<u8>>) {
2025-11-10T00:08:56.5414765Z          self.register_request_with_priority(peer_addr, 0)
2025-11-10T00:08:56.5414862Z      }
2025-11-10T00:08:56.5414965Z -    
2025-11-10T00:08:56.5415074Z +
2025-11-10T00:08:56.5415413Z      /// Register a pending request with priority and return the response receiver
2025-11-10T00:08:56.5415580Z      /// Returns (request_id, response_receiver)
2025-11-10T00:08:56.5415781Z      /// Priority: 0 = normal, higher = more important
2025-11-10T00:08:56.5416262Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1237:
2025-11-10T00:08:56.5416936Z -    pub fn register_request_with_priority(&self, peer_addr: SocketAddr, priority: u8) -> (u64, tokio::sync::oneshot::Receiver<Vec<u8>>) {
2025-11-10T00:08:56.5417109Z +    pub fn register_request_with_priority(
2025-11-10T00:08:56.5417231Z +        &self,
2025-11-10T00:08:56.5417370Z +        peer_addr: SocketAddr,
2025-11-10T00:08:56.5417496Z +        priority: u8,
2025-11-10T00:08:56.5417708Z +    ) -> (u64, tokio::sync::oneshot::Receiver<Vec<u8>>) {
2025-11-10T00:08:56.5417900Z          let request_id = self.generate_request_id();
2025-11-10T00:08:56.5418090Z          let (tx, rx) = tokio::sync::oneshot::channel();
2025-11-10T00:08:56.5418203Z -        
2025-11-10T00:08:56.5418321Z +
2025-11-10T00:08:56.5418497Z          use std::time::{SystemTime, UNIX_EPOCH};
2025-11-10T00:08:56.5418661Z          let timestamp = SystemTime::now()
2025-11-10T00:08:56.5418819Z              .duration_since(UNIX_EPOCH)
2025-11-10T00:08:56.5419295Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1244:
2025-11-10T00:08:56.5419426Z              .unwrap()
2025-11-10T00:08:56.5419555Z              .as_secs();
2025-11-10T00:08:56.5419670Z -        
2025-11-10T00:08:56.5419776Z +
2025-11-10T00:08:56.5419943Z          let pending_req = PendingRequest {
2025-11-10T00:08:56.5420073Z              sender: tx,
2025-11-10T00:08:56.5420192Z              peer_addr,
2025-11-10T00:08:56.5420650Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1251:
2025-11-10T00:08:56.5420783Z              priority,
2025-11-10T00:08:56.5420912Z              retry_count: 0,
2025-11-10T00:08:56.5421130Z          };
2025-11-10T00:08:56.5423121Z -        
2025-11-10T00:08:56.5423482Z -        self.pending_requests.lock().unwrap().insert(request_id, pending_req);
2025-11-10T00:08:56.5423592Z +
2025-11-10T00:08:56.5423735Z +        self.pending_requests
2025-11-10T00:08:56.5423869Z +            .lock()
2025-11-10T00:08:56.5423990Z +            .unwrap()
2025-11-10T00:08:56.5424664Z +            .insert(request_id, pending_req);
2025-11-10T00:08:56.5424799Z          (request_id, rx)
2025-11-10T00:08:56.5424921Z      }
2025-11-10T00:08:56.5425031Z -    
2025-11-10T00:08:56.5425140Z +
2025-11-10T00:08:56.5425386Z      /// Complete a pending request by sending the response
2025-11-10T00:08:56.5425833Z      pub fn complete_request(&self, request_id: u64, response: Vec<u8>) -> bool {
2025-11-10T00:08:56.5426086Z          let mut pending = self.pending_requests.lock().unwrap();
2025-11-10T00:08:56.5426547Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1266:
2025-11-10T00:08:56.5426676Z              false
2025-11-10T00:08:56.5426790Z          }
2025-11-10T00:08:56.5426900Z      }
2025-11-10T00:08:56.5427019Z -    
2025-11-10T00:08:56.5427131Z +
2025-11-10T00:08:56.5427277Z      /// Cancel a pending request
2025-11-10T00:08:56.5427734Z      pub fn cancel_request(&self, request_id: u64) -> bool {
2025-11-10T00:08:56.5428012Z          let mut pending = self.pending_requests.lock().unwrap();
2025-11-10T00:08:56.5428487Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1273:
2025-11-10T00:08:56.5428657Z          pending.remove(&request_id).is_some()
2025-11-10T00:08:56.5428775Z      }
2025-11-10T00:08:56.5428884Z -    
2025-11-10T00:08:56.5428994Z +
2025-11-10T00:08:56.5429174Z      /// Get pending requests for a specific peer
2025-11-10T00:08:56.5429550Z      pub fn get_pending_requests_for_peer(&self, peer_addr: SocketAddr) -> Vec<u64> {
2025-11-10T00:08:56.5429779Z          let pending = self.pending_requests.lock().unwrap();
2025-11-10T00:08:56.5430239Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1279:
2025-11-10T00:08:56.5430382Z -        pending.iter()
2025-11-10T00:08:56.5430564Z +        pending
2025-11-10T00:08:56.5430676Z +            .iter()
2025-11-10T00:08:56.5430885Z              .filter(|(_, req)| req.peer_addr == peer_addr)
2025-11-10T00:08:56.5431022Z              .map(|(id, _)| *id)
2025-11-10T00:08:56.5431149Z              .collect()
2025-11-10T00:08:56.5431602Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1283:
2025-11-10T00:08:56.5431726Z      }
2025-11-10T00:08:56.5431835Z -    
2025-11-10T00:08:56.5431939Z +
2025-11-10T00:08:56.5432184Z      /// Clean up expired requests (older than max_age_seconds)
2025-11-10T00:08:56.5432507Z      pub fn cleanup_expired_requests(&self, max_age_seconds: u64) -> usize {
2025-11-10T00:08:56.5432706Z          use std::time::{SystemTime, UNIX_EPOCH};
2025-11-10T00:08:56.5434974Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1289:
2025-11-10T00:08:56.5435132Z              .duration_since(UNIX_EPOCH)
2025-11-10T00:08:56.5435252Z              .unwrap()
2025-11-10T00:08:56.5435379Z              .as_secs();
2025-11-10T00:08:56.5435488Z -        
2025-11-10T00:08:56.5435600Z +
2025-11-10T00:08:56.5435844Z          let mut pending = self.pending_requests.lock().unwrap();
2025-11-10T00:08:56.5436023Z -        let expired: Vec<u64> = pending.iter()
2025-11-10T00:08:56.5436171Z +        let expired: Vec<u64> = pending
2025-11-10T00:08:56.5436286Z +            .iter()
2025-11-10T00:08:56.5436584Z              .filter(|(_, req)| now.saturating_sub(req.timestamp) > max_age_seconds)
2025-11-10T00:08:56.5436717Z              .map(|(id, _)| *id)
2025-11-10T00:08:56.5436836Z              .collect();
2025-11-10T00:08:56.5437290Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1298:
2025-11-10T00:08:56.5437404Z -        
2025-11-10T00:08:56.5437510Z +
2025-11-10T00:08:56.5437647Z          for id in &expired {
2025-11-10T00:08:56.5437798Z              pending.remove(id);
2025-11-10T00:08:56.5437903Z          }
2025-11-10T00:08:56.5438349Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1302:
2025-11-10T00:08:56.5438472Z -        
2025-11-10T00:08:56.5438574Z +
2025-11-10T00:08:56.5438936Z          expired.len()
2025-11-10T00:08:56.5439043Z      }
2025-11-10T00:08:56.5439160Z -    
2025-11-10T00:08:56.5439266Z +
2025-11-10T00:08:56.5439532Z      /// Start periodic task to clean up expired pending requests
2025-11-10T00:08:56.5439699Z      fn start_request_cleanup_task(&self) {
2025-11-10T00:08:56.5439959Z          let pending_requests = Arc::clone(&self.pending_requests);
2025-11-10T00:08:56.5440408Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1309:
2025-11-10T00:08:56.5440527Z -        
2025-11-10T00:08:56.5440629Z +
2025-11-10T00:08:56.5440773Z          tokio::spawn(async move {
2025-11-10T00:08:56.5441117Z              let mut interval = tokio::time::interval(tokio::time::Duration::from_secs(60));
2025-11-10T00:08:56.5441235Z              loop {
2025-11-10T00:08:56.5441878Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1313:
2025-11-10T00:08:56.5442042Z                  interval.tick().await;
2025-11-10T00:08:56.5442170Z -                
2025-11-10T00:08:56.5442276Z +
2025-11-10T00:08:56.5442506Z                  // Clean up old pending requests (older than 5 minutes)
2025-11-10T00:08:56.5442689Z                  use std::time::{SystemTime, UNIX_EPOCH};
2025-11-10T00:08:56.5442858Z                  let now = SystemTime::now()
2025-11-10T00:08:56.5443307Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1319:
2025-11-10T00:08:56.5443434Z                      .unwrap()
2025-11-10T00:08:56.5443565Z                      .as_secs();
2025-11-10T00:08:56.5443731Z                  let timeout_seconds = 300; // 5 minutes
2025-11-10T00:08:56.5443838Z -                
2025-11-10T00:08:56.5443939Z +
2025-11-10T00:08:56.5444158Z                  let mut pending = pending_requests.lock().unwrap();
2025-11-10T00:08:56.5444493Z                  let initial_count = pending.len();
2025-11-10T00:08:56.5444666Z -                pending.retain(|_, req| {
2025-11-10T00:08:56.5444903Z -                    now.saturating_sub(req.timestamp) < timeout_seconds
2025-11-10T00:08:56.5445021Z -                });
2025-11-10T00:08:56.5445375Z +                pending.retain(|_, req| now.saturating_sub(req.timestamp) < timeout_seconds);
2025-11-10T00:08:56.5445570Z                  let removed = initial_count - pending.len();
2025-11-10T00:08:56.5445699Z                  if removed > 0 {
2025-11-10T00:08:56.5446119Z -                    debug!("Cleaned up {} stale pending requests (older than {}s)", removed, timeout_seconds);
2025-11-10T00:08:56.5446310Z +                    debug!(
2025-11-10T00:08:56.5446556Z +                        "Cleaned up {} stale pending requests (older than {}s)",
2025-11-10T00:08:56.5446705Z +                        removed, timeout_seconds
2025-11-10T00:08:56.5446814Z +                    );
2025-11-10T00:08:56.5446934Z                  }
2025-11-10T00:08:56.5447087Z                  if !pending.is_empty() {
2025-11-10T00:08:56.5447291Z                      debug!("Pending requests: {}", pending.len());
2025-11-10T00:08:56.5447759Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1335:
2025-11-10T00:08:56.5447871Z              }
2025-11-10T00:08:56.5447977Z          });
2025-11-10T00:08:56.5448086Z      }
2025-11-10T00:08:56.5448196Z -    
2025-11-10T00:08:56.5448293Z +
2025-11-10T00:08:56.5448513Z      /// Start periodic task to clean up DoS protection data
2025-11-10T00:08:56.5448703Z      fn start_dos_protection_cleanup_task(&self) {
2025-11-10T00:08:56.5448929Z          let dos_protection = Arc::clone(&self.dos_protection);
2025-11-10T00:08:56.5449378Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1342:
2025-11-10T00:08:56.5449554Z          let ban_list = Arc::clone(&self.ban_list);
2025-11-10T00:08:56.5449660Z -        
2025-11-10T00:08:56.5449758Z +
2025-11-10T00:08:56.5449909Z          tokio::spawn(async move {
2025-11-10T00:08:56.5450372Z              let mut interval = tokio::time::interval(tokio::time::Duration::from_secs(300)); // Every 5 minutes
2025-11-10T00:08:56.5450759Z              loop {
2025-11-10T00:08:56.5451218Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1347:
2025-11-10T00:08:56.5451375Z                  interval.tick().await;
2025-11-10T00:08:56.5451484Z -                
2025-11-10T00:08:56.5451578Z +
2025-11-10T00:08:56.5451771Z                  // Cleanup old connection rate limiter entries
2025-11-10T00:08:56.5451945Z                  dos_protection.cleanup().await;
2025-11-10T00:08:56.5452058Z -                
2025-11-10T00:08:56.5452157Z +
2025-11-10T00:08:56.5452332Z                  // Auto-ban IPs that should be banned
2025-11-10T00:08:56.5452750Z                  // Note: This is a simplified version - in production, you'd want more sophisticated logic
2025-11-10T00:08:56.5452938Z                  let dos_clone = Arc::clone(&dos_protection);
2025-11-10T00:08:56.5453576Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1361:
2025-11-10T00:08:56.5453700Z              }
2025-11-10T00:08:56.5453810Z          });
2025-11-10T00:08:56.5453915Z      }
2025-11-10T00:08:56.5454030Z -    
2025-11-10T00:08:56.5454138Z +
2025-11-10T00:08:56.5454491Z      /// Start periodic task to clean up expired bans
2025-11-10T00:08:56.5454656Z      fn start_ban_cleanup_task(&self) {
2025-11-10T00:08:56.5454835Z          let ban_list = Arc::clone(&self.ban_list);
2025-11-10T00:08:56.5455289Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1369:
2025-11-10T00:08:56.5455750Z              let mut interval = tokio::time::interval(tokio::time::Duration::from_secs(300)); // Every 5 minutes
2025-11-10T00:08:56.5455865Z              loop {
2025-11-10T00:08:56.5457527Z                  interval.tick().await;
2025-11-10T00:08:56.5457637Z -                
2025-11-10T00:08:56.5457744Z +
2025-11-10T00:08:56.5457937Z                  use std::time::{SystemTime, UNIX_EPOCH};
2025-11-10T00:08:56.5458091Z                  let now = SystemTime::now()
2025-11-10T00:08:56.5458251Z                      .duration_since(UNIX_EPOCH)
2025-11-10T00:08:56.5458695Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1376:
2025-11-10T00:08:56.5458822Z                      .unwrap()
2025-11-10T00:08:56.5458942Z                      .as_secs();
2025-11-10T00:08:56.5459055Z -                
2025-11-10T00:08:56.5459155Z +
2025-11-10T00:08:56.5459358Z                  let mut ban_list_guard = ban_list.lock().unwrap();
2025-11-10T00:08:56.5459548Z                  let expired: Vec<SocketAddr> = ban_list_guard
2025-11-10T00:08:56.5459661Z                      .iter()
2025-11-10T00:08:56.5460099Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1384:
2025-11-10T00:08:56.5460214Z                      })
2025-11-10T00:08:56.5460354Z                      .map(|(addr, _)| *addr)
2025-11-10T00:08:56.5460472Z                      .collect();
2025-11-10T00:08:56.5460588Z -                
2025-11-10T00:08:56.5460700Z +
2025-11-10T00:08:56.5460844Z                  for addr in expired {
2025-11-10T00:08:56.5461002Z                      ban_list_guard.remove(&addr);
2025-11-10T00:08:56.5461205Z                      debug!("Cleaned up expired ban for {}", addr);
2025-11-10T00:08:56.5461647Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1391:
2025-11-10T00:08:56.5461760Z                  }
2025-11-10T00:08:56.5461869Z -                
2025-11-10T00:08:56.5461974Z +
2025-11-10T00:08:56.5462121Z                  if !expired.is_empty() {
2025-11-10T00:08:56.5462343Z                      info!("Cleaned up {} expired ban(s)", expired.len());
2025-11-10T00:08:56.5462461Z                  }
2025-11-10T00:08:56.5462899Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1406:
2025-11-10T00:08:56.5463105Z      pub fn peer_addresses(&self) -> Vec<SocketAddr> {
2025-11-10T00:08:56.5463598Z          self.peer_manager.lock().unwrap().peer_socket_addresses()
2025-11-10T00:08:56.5463701Z      }
2025-11-10T00:08:56.5463808Z -    
2025-11-10T00:08:56.5463912Z +
2025-11-10T00:08:56.5464093Z      /// Get all peer addresses (as TransportAddr)
2025-11-10T00:08:56.5466293Z      pub fn peer_transport_addresses(&self) -> Vec<TransportAddr> {
2025-11-10T00:08:56.5466612Z          self.peer_manager.lock().unwrap().peer_addresses()
2025-11-10T00:08:56.5467059Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1429:
2025-11-10T00:08:56.5467372Z      /// Uses peer quality to prioritize reliable peers for critical messages
2025-11-10T00:08:56.5467755Z      pub async fn broadcast_with_quality_priority(&self, message: Vec<u8>) -> Result<()> {
2025-11-10T00:08:56.5467929Z          let pm = self.peer_manager.lock().unwrap();
2025-11-10T00:08:56.5468038Z -        
2025-11-10T00:08:56.5468136Z +
2025-11-10T00:08:56.5468459Z          // Get reliable peers first
2025-11-10T00:08:56.5468678Z          let reliable_peers = pm.select_reliable_peers();
2025-11-10T00:08:56.5468792Z          drop(pm);
2025-11-10T00:08:56.5469293Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1436:
2025-11-10T00:08:56.5469398Z -        
2025-11-10T00:08:56.5469503Z +
2025-11-10T00:08:56.5469647Z          // Send to reliable peers first
2025-11-10T00:08:56.5469786Z          for addr in &reliable_peers {
2025-11-10T00:08:56.5470135Z -            if let Err(e) = self.send_to_peer_by_transport(addr.clone(), message.clone()).await {
2025-11-10T00:08:56.5470259Z +            if let Err(e) = self
2025-11-10T00:08:56.5470487Z +                .send_to_peer_by_transport(addr.clone(), message.clone())
2025-11-10T00:08:56.5470608Z +                .await
2025-11-10T00:08:56.5470719Z +            {
2025-11-10T00:08:56.5470958Z                  warn!("Failed to send to reliable peer {:?}: {}", addr, e);
2025-11-10T00:08:56.5471064Z              }
2025-11-10T00:08:56.5471174Z          }
2025-11-10T00:08:56.5471616Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1443:
2025-11-10T00:08:56.5471719Z -        
2025-11-10T00:08:56.5471827Z +
2025-11-10T00:08:56.5471968Z          // Then send to remaining peers
2025-11-10T00:08:56.5472139Z          let pm = self.peer_manager.lock().unwrap();
2025-11-10T00:08:56.5472288Z          let all_peers = pm.peer_addresses();
2025-11-10T00:08:56.5472914Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1447:
2025-11-10T00:08:56.5473102Z -        let remaining_peers: Vec<_> = all_peers.iter()
2025-11-10T00:08:56.5473255Z +        let remaining_peers: Vec<_> = all_peers
2025-11-10T00:08:56.5473379Z +            .iter()
2025-11-10T00:08:56.5473582Z              .filter(|addr| !reliable_peers.contains(addr))
2025-11-10T00:08:56.5473704Z              .collect();
2025-11-10T00:08:56.5473840Z          drop(pm);
2025-11-10T00:08:56.5474452Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1451:
2025-11-10T00:08:56.5474576Z -        
2025-11-10T00:08:56.5474685Z +
2025-11-10T00:08:56.5474846Z          for addr in remaining_peers {
2025-11-10T00:08:56.5475201Z -            if let Err(e) = self.send_to_peer_by_transport(addr.clone(), message.clone()).await {
2025-11-10T00:08:56.5475336Z +            if let Err(e) = self
2025-11-10T00:08:56.5475581Z +                .send_to_peer_by_transport(addr.clone(), message.clone())
2025-11-10T00:08:56.5475698Z +                .await
2025-11-10T00:08:56.5475803Z +            {
2025-11-10T00:08:56.5475992Z                  warn!("Failed to send to peer {:?}: {}", addr, e);
2025-11-10T00:08:56.5476104Z              }
2025-11-10T00:08:56.5476216Z          }
2025-11-10T00:08:56.5476675Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1457:
2025-11-10T00:08:56.5476795Z -        
2025-11-10T00:08:56.5476910Z +
2025-11-10T00:08:56.5477026Z          Ok(())
2025-11-10T00:08:56.5477373Z      }
2025-11-10T00:08:56.5477483Z  
2025-11-10T00:08:56.5477934Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1464:
2025-11-10T00:08:56.5478124Z          let pm = self.peer_manager.lock().unwrap();
2025-11-10T00:08:56.5478308Z          let best_peers = pm.select_best_peers(1);
2025-11-10T00:08:56.5478429Z          drop(pm);
2025-11-10T00:08:56.5478538Z -        
2025-11-10T00:08:56.5478645Z +
2025-11-10T00:08:56.5478825Z          if let Some(addr) = best_peers.first() {
2025-11-10T00:08:56.5479093Z -            self.send_to_peer_by_transport(addr.clone(), message).await?;
2025-11-10T00:08:56.5479325Z +            self.send_to_peer_by_transport(addr.clone(), message)
2025-11-10T00:08:56.5479450Z +                .await?;
2025-11-10T00:08:56.5479581Z              Ok(addr.clone())
2025-11-10T00:08:56.5479694Z          } else {
2025-11-10T00:08:56.5480104Z              Err(anyhow::anyhow!("No peers available"))
2025-11-10T00:08:56.5480565Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1479:
2025-11-10T00:08:56.5480764Z          let pm = self.peer_manager.lock().unwrap();
2025-11-10T00:08:56.5480969Z          let reliable_peers = pm.select_reliable_peers();
2025-11-10T00:08:56.5481098Z          drop(pm);
2025-11-10T00:08:56.5481206Z -        
2025-11-10T00:08:56.5481309Z +
2025-11-10T00:08:56.5481465Z          if reliable_peers.is_empty() {
2025-11-10T00:08:56.5481739Z              return Err(anyhow::anyhow!("No reliable peers available"));
2025-11-10T00:08:56.5481851Z          }
2025-11-10T00:08:56.5482308Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1486:
2025-11-10T00:08:56.5482419Z -        
2025-11-10T00:08:56.5482518Z +
2025-11-10T00:08:56.5482662Z          // Select best reliable peer
2025-11-10T00:08:56.5482854Z          let pm = self.peer_manager.lock().unwrap();
2025-11-10T00:08:56.5483041Z -        let best_reliable = reliable_peers.iter()
2025-11-10T00:08:56.5483169Z -            .max_by(|a, b| {
2025-11-10T00:08:56.5483488Z -                let score_a = pm.get_peer(a).map(|p| p.quality_score()).unwrap_or(0.0);
2025-11-10T00:08:56.5483792Z -                let score_b = pm.get_peer(b).map(|p| p.quality_score()).unwrap_or(0.0);
2025-11-10T00:08:56.5484101Z -                score_a.partial_cmp(&score_b).unwrap_or(std::cmp::Ordering::Equal)
2025-11-10T00:08:56.5484214Z -            });
2025-11-10T00:08:56.5484666Z +        let best_reliable = reliable_peers.iter().max_by(|a, b| {
2025-11-10T00:08:56.5484965Z +            let score_a = pm.get_peer(a).map(|p| p.quality_score()).unwrap_or(0.0);
2025-11-10T00:08:56.5485245Z +            let score_b = pm.get_peer(b).map(|p| p.quality_score()).unwrap_or(0.0);
2025-11-10T00:08:56.5485371Z +            score_a
2025-11-10T00:08:56.5485517Z +                .partial_cmp(&score_b)
2025-11-10T00:08:56.5485706Z +                .unwrap_or(std::cmp::Ordering::Equal)
2025-11-10T00:08:56.5485815Z +        });
2025-11-10T00:08:56.5485940Z          drop(pm);
2025-11-10T00:08:56.5486055Z -        
2025-11-10T00:08:56.5486163Z +
2025-11-10T00:08:56.5486331Z          if let Some(addr) = best_reliable {
2025-11-10T00:08:56.5486602Z -            self.send_to_peer_by_transport(addr.clone(), message).await?;
2025-11-10T00:08:56.5486835Z +            self.send_to_peer_by_transport(addr.clone(), message)
2025-11-10T00:08:56.5486965Z +                .await?;
2025-11-10T00:08:56.5487096Z              Ok(addr.clone())
2025-11-10T00:08:56.5487204Z          } else {
2025-11-10T00:08:56.5487434Z              Err(anyhow::anyhow!("No reliable peers available"))
2025-11-10T00:08:56.5487908Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1509:
2025-11-10T00:08:56.5488050Z          let transport_addr = {
2025-11-10T00:08:56.5488235Z              let pm = self.peer_manager.lock().unwrap();
2025-11-10T00:08:56.5488422Z              pm.find_transport_addr_by_socket(addr)
2025-11-10T00:08:56.5488550Z -                .or_else(|| {
2025-11-10T00:08:56.5489075Z -                    self.socket_to_transport.lock().unwrap().get(&addr).cloned()
2025-11-10T00:08:56.5489195Z -                })
2025-11-10T00:08:56.5489524Z +                .or_else(|| self.socket_to_transport.lock().unwrap().get(&addr).cloned())
2025-11-10T00:08:56.5489637Z          };
2025-11-10T00:08:56.5489745Z -        
2025-11-10T00:08:56.5489860Z +
2025-11-10T00:08:56.5490055Z          if let Some(transport_addr) = transport_addr {
2025-11-10T00:08:56.5490329Z -            self.send_to_peer_by_transport(transport_addr, message).await
2025-11-10T00:08:56.5490823Z +            self.send_to_peer_by_transport(transport_addr, message)
2025-11-10T00:08:56.5490954Z +                .await
2025-11-10T00:08:56.5491064Z          } else {
2025-11-10T00:08:56.5491273Z              // Fallback: try TCP (for backward compatibility)
2025-11-10T00:08:56.5491832Z -            self.send_to_peer_by_transport(TransportAddr::Tcp(addr), message).await
2025-11-10T00:08:56.5492186Z +            self.send_to_peer_by_transport(TransportAddr::Tcp(addr), message)
2025-11-10T00:08:56.5492304Z +                .await
2025-11-10T00:08:56.5492414Z          }
2025-11-10T00:08:56.5492515Z      }
2025-11-10T00:08:56.5492615Z -    
2025-11-10T00:08:56.5492714Z +
2025-11-10T00:08:56.5493070Z      /// Send a message to a specific peer (by TransportAddr - supports all transports)
2025-11-10T00:08:56.5493526Z -    pub async fn send_to_peer_by_transport(&self, addr: TransportAddr, message: Vec<u8>) -> Result<()> {
2025-11-10T00:08:56.5493690Z +    pub async fn send_to_peer_by_transport(
2025-11-10T00:08:56.5493803Z +        &self,
2025-11-10T00:08:56.5493935Z +        addr: TransportAddr,
2025-11-10T00:08:56.5494053Z +        message: Vec<u8>,
2025-11-10T00:08:56.5494168Z +    ) -> Result<()> {
2025-11-10T00:08:56.5494554Z          let message_len = message.len();
2025-11-10T00:08:56.5494693Z          // Track bytes sent
2025-11-10T00:08:56.5494881Z          self.track_bytes_sent(message_len as u64);
2025-11-10T00:08:56.5495350Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1530:
2025-11-10T00:08:56.5497486Z -        
2025-11-10T00:08:56.5497589Z +
2025-11-10T00:08:56.5497783Z          let mut pm = self.peer_manager.lock().unwrap();
2025-11-10T00:08:56.5497974Z          if let Some(peer) = pm.get_peer_mut(&addr) {
2025-11-10T00:08:56.5498141Z              peer.send_message(message).await?;
2025-11-10T00:08:56.5498591Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1539:
2025-11-10T00:08:56.5498708Z      }
2025-11-10T00:08:56.5498812Z  
2025-11-10T00:08:56.5498978Z      /// Connect to a peer at the given address
2025-11-10T00:08:56.5499094Z -    /// 
2025-11-10T00:08:56.5499205Z +    ///
2025-11-10T00:08:56.5499552Z      /// Attempts to connect using available transports with graceful degradation:
2025-11-10T00:08:56.5500284Z      /// 1. Tries preferred transport (based on transport_preference)
2025-11-10T00:08:56.5500519Z      /// 2. Falls back to TCP if preferred transport fails
2025-11-10T00:08:56.5500996Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1547:
2025-11-10T00:08:56.5501300Z      pub async fn connect_to_peer(&self, addr: SocketAddr) -> Result<()> {
2025-11-10T00:08:56.5501478Z          use crate::network::peer::Peer;
2025-11-10T00:08:56.5501682Z          use crate::network::transport::TransportAddr;
2025-11-10T00:08:56.5501791Z -        
2025-11-10T00:08:56.5501906Z +
2025-11-10T00:08:56.5502280Z          // Check DoS protection: connection rate limiting (for outgoing connections too)
2025-11-10T00:08:56.5502420Z          let ip = addr.ip();
2025-11-10T00:08:56.5502639Z          if !self.dos_protection.check_connection(ip).await {
2025-11-10T00:08:56.5503085Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1554:
2025-11-10T00:08:56.5503497Z -            warn!("Connection rate limit exceeded for IP {}, rejecting outgoing connection", ip);
2025-11-10T00:08:56.5503913Z -            
2025-11-10T00:08:56.5504047Z +            warn!(
2025-11-10T00:08:56.5504596Z +                "Connection rate limit exceeded for IP {}, rejecting outgoing connection",
2025-11-10T00:08:56.5504713Z +                ip
2025-11-10T00:08:56.5504825Z +            );
2025-11-10T00:08:56.5504945Z +
2025-11-10T00:08:56.5506985Z              // Check if we should auto-ban
2025-11-10T00:08:56.5507207Z              if self.dos_protection.should_auto_ban(ip).await {
2025-11-10T00:08:56.5507539Z -                warn!("Auto-banning IP {} for repeated connection rate violations", ip);
2025-11-10T00:08:56.5507654Z +                warn!(
2025-11-10T00:08:56.5507921Z +                    "Auto-banning IP {} for repeated connection rate violations",
2025-11-10T00:08:56.5508040Z +                    ip
2025-11-10T00:08:56.5508149Z +                );
2025-11-10T00:08:56.5508274Z                  // Ban the IP
2025-11-10T00:08:56.5508715Z                  let unban_timestamp = std::time::SystemTime::now()
2025-11-10T00:08:56.5508930Z                      .duration_since(std::time::UNIX_EPOCH)
2025-11-10T00:08:56.5509387Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1564:
2025-11-10T00:08:56.5509533Z                      + 3600; // Ban for 1 hour
2025-11-10T00:08:56.5509742Z                  let mut ban_list = self.ban_list.lock().unwrap();
2025-11-10T00:08:56.5509916Z                  ban_list.insert(addr, unban_timestamp);
2025-11-10T00:08:56.5510288Z -                return Err(anyhow::anyhow!("IP {} is banned due to connection rate violations", ip));
2025-11-10T00:08:56.5510451Z +                return Err(anyhow::anyhow!(
2025-11-10T00:08:56.5510654Z +                    "IP {} is banned due to connection rate violations",
2025-11-10T00:08:56.5510768Z +                    ip
2025-11-10T00:08:56.5510879Z +                ));
2025-11-10T00:08:56.5511001Z              }
2025-11-10T00:08:56.5511118Z -            
2025-11-10T00:08:56.5511473Z -            return Err(anyhow::anyhow!("Connection rate limit exceeded for IP {}", ip));
2025-11-10T00:08:56.5511593Z +
2025-11-10T00:08:56.5511743Z +            return Err(anyhow::anyhow!(
2025-11-10T00:08:56.5511928Z +                "Connection rate limit exceeded for IP {}",
2025-11-10T00:08:56.5512046Z +                ip
2025-11-10T00:08:56.5512166Z +            ));
2025-11-10T00:08:56.5512273Z          }
2025-11-10T00:08:56.5512379Z -        
2025-11-10T00:08:56.5512485Z +
2025-11-10T00:08:56.5512676Z          // Eclipse attack prevention: check IP diversity
2025-11-10T00:08:56.5512841Z          if !self.check_eclipse_prevention(ip) {
2025-11-10T00:08:56.5512998Z              let prefix = self.get_ip_prefix(ip);
2025-11-10T00:08:56.5513450Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1576:
2025-11-10T00:08:56.5513962Z              warn!("Eclipse attack prevention: too many connections from IP range {:?}, rejecting connection from {}", 
2025-11-10T00:08:56.5514094Z                    prefix, ip);
2025-11-10T00:08:56.5516918Z -            return Err(anyhow::anyhow!("Eclipse attack prevention: too many connections from IP range"));
2025-11-10T00:08:56.5517089Z +            return Err(anyhow::anyhow!(
2025-11-10T00:08:56.5517384Z +                "Eclipse attack prevention: too many connections from IP range"
2025-11-10T00:08:56.5517506Z +            ));
2025-11-10T00:08:56.5517618Z          }
2025-11-10T00:08:56.5517725Z -        
2025-11-10T00:08:56.5517926Z +
2025-11-10T00:08:56.5518083Z          let mut last_error = None;
2025-11-10T00:08:56.5518191Z -        
2025-11-10T00:08:56.5518298Z +
2025-11-10T00:08:56.5518585Z          // Try transports in preference order with graceful degradation
2025-11-10T00:08:56.5518860Z          let transports_to_try = self.get_transports_for_connection();
2025-11-10T00:08:56.5518971Z -        
2025-11-10T00:08:56.5519079Z +
2025-11-10T00:08:56.5519278Z          for transport_type in transports_to_try {
2025-11-10T00:08:56.5519589Z              match self.try_connect_with_transport(&transport_type, addr).await {
2025-11-10T00:08:56.5520018Z                  Ok((peer, transport_addr)) => {
2025-11-10T00:08:56.5520498Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1591:
2025-11-10T00:08:56.5520719Z                          let mut pm = self.peer_manager.lock().unwrap();
2025-11-10T00:08:56.5520923Z                          pm.add_peer(transport_addr.clone(), peer)?;
2025-11-10T00:08:56.5521053Z                      }
2025-11-10T00:08:56.5521167Z -                    
2025-11-10T00:08:56.5521351Z +
2025-11-10T00:08:56.5521669Z                      // Note: Peer handler is managed by Peer::from_transport_connection
2025-11-10T00:08:56.5521874Z                      // No need to spawn additional handler task
2025-11-10T00:08:56.5521986Z -                    
2025-11-10T00:08:56.5522665Z -                    info!("Successfully connected to {} via {:?} (transport: {:?})", addr, transport_type, transport_addr);
2025-11-10T00:08:56.5522798Z +
2025-11-10T00:08:56.5522919Z +                    info!(
2025-11-10T00:08:56.5523173Z +                        "Successfully connected to {} via {:?} (transport: {:?})",
2025-11-10T00:08:56.5523348Z +                        addr, transport_type, transport_addr
2025-11-10T00:08:56.5523457Z +                    );
2025-11-10T00:08:56.5523586Z                      return Ok(());
2025-11-10T00:08:56.5523700Z                  }
2025-11-10T00:08:56.5523837Z                  Err(e) => {
2025-11-10T00:08:56.5524442Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1602:
2025-11-10T00:08:56.5524746Z -                    warn!("Failed to connect to {} via {:?}: {}", addr, transport_type, e);
2025-11-10T00:08:56.5524876Z +                    warn!(
2025-11-10T00:08:56.5525050Z +                        "Failed to connect to {} via {:?}: {}",
2025-11-10T00:08:56.5525215Z +                        addr, transport_type, e
2025-11-10T00:08:56.5525341Z +                    );
2025-11-10T00:08:56.5525480Z                      last_error = Some(e);
2025-11-10T00:08:56.5525631Z                      // Continue to next transport
2025-11-10T00:08:56.5525742Z                  }
2025-11-10T00:08:56.5528047Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1606:
2025-11-10T00:08:56.5528152Z              }
2025-11-10T00:08:56.5528255Z          }
2025-11-10T00:08:56.5528372Z -        
2025-11-10T00:08:56.5528476Z +
2025-11-10T00:08:56.5528607Z          // All transports failed
2025-11-10T00:08:56.5528989Z          Err(last_error.unwrap_or_else(|| anyhow::anyhow!("All transport attempts failed")))
2025-11-10T00:08:56.5529095Z      }
2025-11-10T00:08:56.5529548Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1612:
2025-11-10T00:08:56.5529655Z -    
2025-11-10T00:08:56.5529770Z +
2025-11-10T00:08:56.5530010Z      /// Helper: Get list of transports to try for a connection
2025-11-10T00:08:56.5530446Z      fn get_transports_for_connection(&self) -> Vec<crate::network::transport::TransportType> {
2025-11-10T00:08:56.5530614Z          let mut transports = Vec::new();
2025-11-10T00:08:56.5531058Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1616:
2025-11-10T00:08:56.5531167Z -        
2025-11-10T00:08:56.5531271Z +
2025-11-10T00:08:56.5531446Z          // Add transports in preference order
2025-11-10T00:08:56.5531638Z          if self.transport_preference.allows_tcp() {
2025-11-10T00:08:56.5531958Z              transports.push(crate::network::transport::TransportType::Tcp);
2025-11-10T00:08:56.5532412Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1620:
2025-11-10T00:08:56.5532522Z          }
2025-11-10T00:08:56.5532630Z -        
2025-11-10T00:08:56.5532747Z +
2025-11-10T00:08:56.5533416Z          #[cfg(feature = "quinn")]
2025-11-10T00:08:56.5533652Z          if self.transport_preference.allows_quinn() {
2025-11-10T00:08:56.5534169Z              if let Some(ref _quinn) = self.quinn_transport {
2025-11-10T00:08:56.5534807Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1625:
2025-11-10T00:08:56.5535144Z                  transports.push(crate::network::transport::TransportType::Quinn);
2025-11-10T00:08:56.5535255Z              }
2025-11-10T00:08:56.5535370Z          }
2025-11-10T00:08:56.5535478Z -        
2025-11-10T00:08:56.5535577Z +
2025-11-10T00:08:56.5537378Z          #[cfg(feature = "iroh")]
2025-11-10T00:08:56.5537584Z          if self.transport_preference.allows_iroh() {
2025-11-10T00:08:56.5537783Z              if let Some(ref _iroh) = self.iroh_transport {
2025-11-10T00:08:56.5538628Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1632:
2025-11-10T00:08:56.5538963Z                  transports.push(crate::network::transport::TransportType::Iroh);
2025-11-10T00:08:56.5539401Z              }
2025-11-10T00:08:56.5539522Z          }
2025-11-10T00:08:56.5539648Z -        
2025-11-10T00:08:56.5539751Z +
2025-11-10T00:08:56.5539972Z          // Always try TCP as fallback if not already in list
2025-11-10T00:08:56.5540551Z -        if !transports.iter().any(|t| matches!(t, crate::network::transport::TransportType::Tcp)) {
2025-11-10T00:08:56.5540693Z +        if !transports
2025-11-10T00:08:56.5540809Z +            .iter()
2025-11-10T00:08:56.5541091Z +            .any(|t| matches!(t, crate::network::transport::TransportType::Tcp))
2025-11-10T00:08:56.5541207Z +        {
2025-11-10T00:08:56.5541517Z              transports.push(crate::network::transport::TransportType::Tcp);
2025-11-10T00:08:56.5541628Z          }
2025-11-10T00:08:56.5541746Z -        
2025-11-10T00:08:56.5541853Z +
2025-11-10T00:08:56.5541972Z          transports
2025-11-10T00:08:56.5542080Z      }
2025-11-10T00:08:56.5542191Z -    
2025-11-10T00:08:56.5542295Z +
2025-11-10T00:08:56.5542526Z      /// Helper: Try connecting with a specific transport
2025-11-10T00:08:56.5543404Z -    async fn try_connect_with_transport(&self, transport_type: &crate::network::transport::TransportType, addr: SocketAddr) -> Result<(peer::Peer, TransportAddr)> {
2025-11-10T00:08:56.5543623Z -        use crate::network::transport::TransportAddr;
2025-11-10T00:08:56.5543785Z +    async fn try_connect_with_transport(
2025-11-10T00:08:56.5543899Z +        &self,
2025-11-10T00:08:56.5544177Z +        transport_type: &crate::network::transport::TransportType,
2025-11-10T00:08:56.5544496Z +        addr: SocketAddr,
2025-11-10T00:08:56.5544689Z +    ) -> Result<(peer::Peer, TransportAddr)> {
2025-11-10T00:08:56.5544854Z          use crate::network::peer::Peer;
2025-11-10T00:08:56.5544962Z -        
2025-11-10T00:08:56.5545161Z +        use crate::network::transport::TransportAddr;
2025-11-10T00:08:56.5545266Z +
2025-11-10T00:08:56.5545406Z          match transport_type {
2025-11-10T00:08:56.5545634Z              crate::network::transport::TransportType::Tcp => {
2025-11-10T00:08:56.5545942Z                  // Use TcpTransport to create connection properly
2025-11-10T00:08:56.5546428Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1684:
2025-11-10T00:08:56.5546655Z              crate::network::transport::TransportType::Iroh => {
2025-11-10T00:08:56.5546836Z                  // Iroh requires public key, not SocketAddr
2025-11-10T00:08:56.5547174Z                  // For now, return error - would need peer discovery or address resolution
2025-11-10T00:08:56.5547515Z -                Err(anyhow::anyhow!("Iroh transport requires public key, not SocketAddr"))
2025-11-10T00:08:56.5547666Z +                Err(anyhow::anyhow!(
2025-11-10T00:08:56.5547911Z +                    "Iroh transport requires public key, not SocketAddr"
2025-11-10T00:08:56.5548023Z +                ))
2025-11-10T00:08:56.5548134Z              }
2025-11-10T00:08:56.5548240Z          }
2025-11-10T00:08:56.5548356Z      }
2025-11-10T00:08:56.5548822Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1691:
2025-11-10T00:08:56.5549172Z -    
2025-11-10T00:08:56.5549272Z +
2025-11-10T00:08:56.5549468Z      /// Send ping message to all connected peers
2025-11-10T00:08:56.5549681Z      pub async fn ping_all_peers(&self) -> Result<()> {
2025-11-10T00:08:56.5550070Z -        use crate::network::protocol::{ProtocolMessage, ProtocolParser, PingMessage};
2025-11-10T00:08:56.5550445Z +        use crate::network::protocol::{PingMessage, ProtocolMessage, ProtocolParser};
2025-11-10T00:08:56.5550622Z          use std::time::{SystemTime, UNIX_EPOCH};
2025-11-10T00:08:56.5550731Z -        
2025-11-10T00:08:56.5550847Z +
2025-11-10T00:08:56.5550990Z          // Generate nonce for ping
2025-11-10T00:08:56.5551144Z          let nonce = SystemTime::now()
2025-11-10T00:08:56.5551294Z              .duration_since(UNIX_EPOCH)
2025-11-10T00:08:56.5551991Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1700:
2025-11-10T00:08:56.5552126Z              .unwrap()
2025-11-10T00:08:56.5552266Z              .as_nanos() as u64;
2025-11-10T00:08:56.5552379Z -        
2025-11-10T00:08:56.5552485Z +
2025-11-10T00:08:56.5552768Z          let ping_msg = ProtocolMessage::Ping(PingMessage { nonce });
2025-11-10T00:08:56.5553051Z          let wire_msg = ProtocolParser::serialize_message(&ping_msg)?;
2025-11-10T00:08:56.5553162Z -        
2025-11-10T00:08:56.5553264Z +
2025-11-10T00:08:56.5553673Z          let peer_addrs = self.peer_manager.lock().unwrap().peer_addresses();
2025-11-10T00:08:56.5553820Z          for addr in peer_addrs {
2025-11-10T00:08:56.5555904Z              // Convert TransportAddr to SocketAddr for send_to_peer, or use send_to_peer_by_transport
2025-11-10T00:08:56.5556369Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1726:
2025-11-10T00:08:56.5556483Z                  }
2025-11-10T00:08:56.5556593Z              }
2025-11-10T00:08:56.5556711Z          }
2025-11-10T00:08:56.5556820Z -        
2025-11-10T00:08:56.5556939Z +
2025-11-10T00:08:56.5557050Z          Ok(())
2025-11-10T00:08:56.5557157Z      }
2025-11-10T00:08:56.5557270Z  
2025-11-10T00:08:56.5557723Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1761:
2025-11-10T00:08:56.5558055Z          // Track message queue size manually (unbounded channel doesn't have len())
2025-11-10T00:08:56.5558204Z          let mut message_count = 0u64;
2025-11-10T00:08:56.5558466Z          let mut last_metrics_update = std::time::SystemTime::now();
2025-11-10T00:08:56.5558573Z -        
2025-11-10T00:08:56.5558676Z +
2025-11-10T00:08:56.5558910Z          while let Some(message) = self.peer_rx.recv().await {
2025-11-10T00:08:56.5559048Z              message_count += 1;
2025-11-10T00:08:56.5559151Z -            
2025-11-10T00:08:56.5559256Z +
2025-11-10T00:08:56.5559618Z              // Update metrics periodically (every 100 messages or 10 seconds)
2025-11-10T00:08:56.5559791Z              let now = std::time::SystemTime::now();
2025-11-10T00:08:56.5559971Z -            let should_update = message_count % 100 == 0 
2025-11-10T00:08:56.5560153Z +            let should_update = message_count % 100 == 0
2025-11-10T00:08:56.5560448Z                  || now.duration_since(last_metrics_update).unwrap().as_secs() >= 10;
2025-11-10T00:08:56.5560562Z -            
2025-11-10T00:08:56.5560678Z +
2025-11-10T00:08:56.5560811Z              if should_update {
2025-11-10T00:08:56.5561103Z                  let pm = self.peer_manager.lock().unwrap();
2025-11-10T00:08:56.5561289Z                  let active_connections = pm.peer_count();
2025-11-10T00:08:56.5561756Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1776:
2025-11-10T00:08:56.5562016Z                  let bytes_received = *self.bytes_received.lock().unwrap();
2025-11-10T00:08:56.5562233Z                  let bytes_sent = *self.bytes_sent.lock().unwrap();
2025-11-10T00:08:56.5562365Z -                
2025-11-10T00:08:56.5562472Z +
2025-11-10T00:08:56.5562762Z                  // Approximate queue size (messages processed since last check)
2025-11-10T00:08:56.5563201Z                  let queue_size = message_count as usize;
2025-11-10T00:08:56.5563317Z -                
2025-11-10T00:08:56.5563514Z +
2025-11-10T00:08:56.5563754Z                  // Check message queue size limit
2025-11-10T00:08:56.5565932Z -                if !self.dos_protection.check_message_queue_size(queue_size).await {
2025-11-10T00:08:56.5566400Z -                    warn!("Message queue size limit exceeded (processed {} messages), potential DoS", queue_size);
2025-11-10T00:08:56.5566528Z +                if !self
2025-11-10T00:08:56.5566664Z +                    .dos_protection
2025-11-10T00:08:56.5566841Z +                    .check_message_queue_size(queue_size)
2025-11-10T00:08:56.5573553Z +                    .await
2025-11-10T00:08:56.5573691Z +                {
2025-11-10T00:08:56.5574103Z +                    warn!(
2025-11-10T00:08:56.5576643Z +                        "Message queue size limit exceeded (processed {} messages), potential DoS",
2025-11-10T00:08:56.5576794Z +                        queue_size
2025-11-10T00:08:56.5576912Z +                    );
2025-11-10T00:08:56.5577084Z                      // Optionally detect DoS attack
2025-11-10T00:08:56.5577321Z                      if self.dos_protection.detect_dos_attack().await {
2025-11-10T00:08:56.5577688Z                          warn!("DoS attack detected - message queue and connections at high levels");
2025-11-10T00:08:56.5578162Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1790:
2025-11-10T00:08:56.5578370Z                      // Reset counter to prevent false positives
2025-11-10T00:08:56.5578515Z                      message_count = 0;
2025-11-10T00:08:56.5578630Z                  }
2025-11-10T00:08:56.5578755Z -                
2025-11-10T00:08:56.5578947Z -                self.dos_protection.update_metrics(
2025-11-10T00:08:56.5579093Z -                    active_connections,
2025-11-10T00:08:56.5579234Z -                    queue_size,
2025-11-10T00:08:56.5579370Z -                    bytes_received,
2025-11-10T00:08:56.5579497Z -                    bytes_sent,
2025-11-10T00:08:56.5579618Z -                ).await;
2025-11-10T00:08:56.5579740Z -                
2025-11-10T00:08:56.5579850Z +
2025-11-10T00:08:56.5579989Z +                self.dos_protection
2025-11-10T00:08:56.5580346Z +                    .update_metrics(active_connections, queue_size, bytes_received, bytes_sent)
2025-11-10T00:08:56.5580470Z +                    .await;
2025-11-10T00:08:56.5580575Z +
2025-11-10T00:08:56.5580730Z                  last_metrics_update = now;
2025-11-10T00:08:56.5580919Z                  message_count = 0; // Reset after update
2025-11-10T00:08:56.5581032Z              }
2025-11-10T00:08:56.5581492Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1811:
2025-11-10T00:08:56.5581713Z                      let mut pm = self.peer_manager.lock().unwrap();
2025-11-10T00:08:56.5581921Z                      // Remove peer directly using TransportAddr
2025-11-10T00:08:56.5582069Z                      pm.remove_peer(&addr);
2025-11-10T00:08:56.5582187Z -                    
2025-11-10T00:08:56.5582301Z +
2025-11-10T00:08:56.5582594Z                      // Clean up per-IP connection count (only for TCP/Quinn, not Iroh)
2025-11-10T00:08:56.5582756Z                      if let Some(ip) = match &addr {
2025-11-10T00:08:56.5582988Z                          TransportAddr::Tcp(sock) => Some(sock.ip()),
2025-11-10T00:08:56.5583450Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1828:
2025-11-10T00:08:56.5583570Z                              }
2025-11-10T00:08:56.5583684Z                          }
2025-11-10T00:08:56.5583806Z                      }
2025-11-10T00:08:56.5583919Z -                    
2025-11-10T00:08:56.5584024Z +
2025-11-10T00:08:56.5584546Z                      // Clean up rate limiter (use SocketAddr for TCP/Quinn, or a key for Iroh)
2025-11-10T00:08:56.5584908Z                      {
2025-11-10T00:08:56.5585164Z                          let mut rates = self.peer_message_rates.lock().unwrap();
2025-11-10T00:08:56.5585630Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1844:
2025-11-10T00:08:56.5585784Z                              rates.remove(&sock_addr);
2025-11-10T00:08:56.5585892Z                          }
2025-11-10T00:08:56.5587934Z                      }
2025-11-10T00:08:56.5588043Z -                    
2025-11-10T00:08:56.5588138Z +
2025-11-10T00:08:56.5588319Z                      // Clean up eclipse attack prevention tracking
2025-11-10T00:08:56.5588473Z                      if let Some(ip) = match &addr {
2025-11-10T00:08:56.5588669Z                          TransportAddr::Tcp(sock) => Some(sock.ip()),
2025-11-10T00:08:56.5589263Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1967:
2025-11-10T00:08:56.5589373Z                      {
2025-11-10T00:08:56.5589580Z                          let mut pm = self.peer_manager.lock().unwrap();
2025-11-10T00:08:56.5589830Z                          // Try to find peer by SocketAddr (TCP or Quinn, or Iroh mapping)
2025-11-10T00:08:56.5590115Z -                        let transport_addr = pm.find_transport_addr_by_socket(peer_addr)
2025-11-10T00:08:56.5590248Z -                            .or_else(|| {
2025-11-10T00:08:56.5590386Z +                        let transport_addr =
2025-11-10T00:08:56.5590619Z +                            pm.find_transport_addr_by_socket(peer_addr).or_else(|| {
2025-11-10T00:08:56.5590765Z                                  // Check Iroh mapping
2025-11-10T00:08:56.5591053Z -                                self.socket_to_transport.lock().unwrap().get(&peer_addr).cloned()
2025-11-10T00:08:56.5591201Z +                                self.socket_to_transport
2025-11-10T00:08:56.5591340Z +                                    .lock()
2025-11-10T00:08:56.5591480Z +                                    .unwrap()
2025-11-10T00:08:56.5591636Z +                                    .get(&peer_addr)
2025-11-10T00:08:56.5591770Z +                                    .cloned()
2025-11-10T00:08:56.5591910Z                              });
2025-11-10T00:08:56.5592119Z                          if let Some(transport_addr) = transport_addr {
2025-11-10T00:08:56.5592359Z                              if let Some(peer) = pm.get_peer_mut(&transport_addr) {
2025-11-10T00:08:56.5592834Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1978:
2025-11-10T00:08:56.5592962Z                              }
2025-11-10T00:08:56.5593079Z                          }
2025-11-10T00:08:56.5593193Z                      }
2025-11-10T00:08:56.5593301Z -                    
2025-11-10T00:08:56.5593402Z +
2025-11-10T00:08:56.5593574Z                      // Check rate limiting before processing
2025-11-10T00:08:56.5593826Z                      let mut rates = self.peer_message_rates.lock().unwrap();
2025-11-10T00:08:56.5594083Z                      let rate_limiter = rates.entry(peer_addr).or_insert_with(|| {
2025-11-10T00:08:56.5595230Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1985:
2025-11-10T00:08:56.5597302Z                          // Default: 100 burst, 10 messages/second
2025-11-10T00:08:56.5597469Z                          PeerRateLimiter::new(100, 10)
2025-11-10T00:08:56.5597578Z                      });
2025-11-10T00:08:56.5597684Z -                    
2025-11-10T00:08:56.5597791Z +
2025-11-10T00:08:56.5597955Z                      if !rate_limiter.check_and_consume() {
2025-11-10T00:08:56.5598263Z -                        warn!("Rate limit exceeded for peer {}, dropping message", peer_addr);
2025-11-10T00:08:56.5598402Z +                        warn!(
2025-11-10T00:08:56.5598635Z +                            "Rate limit exceeded for peer {}, dropping message",
2025-11-10T00:08:56.5598764Z +                            peer_addr
2025-11-10T00:08:56.5599102Z +                        );
2025-11-10T00:08:56.5599388Z                          // Optionally ban peer after repeated rate limit violations
2025-11-10T00:08:56.5599560Z                          // For now, just drop the message
2025-11-10T00:08:56.5599687Z                          continue;
2025-11-10T00:08:56.5600133Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1994:
2025-11-10T00:08:56.5600241Z                      }
2025-11-10T00:08:56.5600363Z                      drop(rates);
2025-11-10T00:08:56.5600480Z -                    
2025-11-10T00:08:56.5600583Z +
2025-11-10T00:08:56.5600910Z                      // Check if this is a response to a pending request (UTXOSet or FilteredBlock)
2025-11-10T00:08:56.5601220Z                      // Extract request_id from message and route to correct pending request
2025-11-10T00:08:56.5601636Z                      if let Ok(parsed) = ProtocolParser::parse_message(&data) {
2025-11-10T00:08:56.5602078Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2002:
2025-11-10T00:08:56.5602363Z                              ProtocolMessage::FilteredBlock(msg) => Some(msg.request_id),
2025-11-10T00:08:56.5602496Z                              _ => None,
2025-11-10T00:08:56.5602608Z                          };
2025-11-10T00:08:56.5602720Z -                        
2025-11-10T00:08:56.5602829Z +
2025-11-10T00:08:56.5603073Z                          if let Some(request_id) = request_id_opt {
2025-11-10T00:08:56.5603250Z                              // Route to pending request by request_id
2025-11-10T00:08:56.5603494Z                              let mut pending = self.pending_requests.lock().unwrap();
2025-11-10T00:08:56.5603908Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2015:
2025-11-10T00:08:56.5604019Z                              }
2025-11-10T00:08:56.5604133Z                          }
2025-11-10T00:08:56.5605868Z                      }
2025-11-10T00:08:56.5605992Z -                    
2025-11-10T00:08:56.5606100Z +
2025-11-10T00:08:56.5606281Z                      // Process through protocol layer
2025-11-10T00:08:56.5606572Z                      if let Err(e) = self.handle_incoming_wire_tcp(peer_addr, data).await {
2025-11-10T00:08:56.5606821Z                          warn!("Failed to process message from {}: {}", peer_addr, e);
2025-11-10T00:08:56.5607260Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2034:
2025-11-10T00:08:56.5607456Z      /// 3. Creates NodeChainAccess from storage modules
2025-11-10T00:08:56.5607709Z      /// 4. Calls bllvm_protocol::network::process_network_message()
2025-11-10T00:08:56.5608048Z      /// 5. Converts NetworkResponse back to wire format and enqueues for sending
2025-11-10T00:08:56.5608537Z -    pub async fn handle_incoming_wire_tcp(&self, peer_addr: SocketAddr, data: Vec<u8>) -> Result<()> {
2025-11-10T00:08:56.5608718Z +    pub async fn handle_incoming_wire_tcp(
2025-11-10T00:08:56.5608838Z +        &self,
2025-11-10T00:08:56.5608988Z +        peer_addr: SocketAddr,
2025-11-10T00:08:56.5609120Z +        data: Vec<u8>,
2025-11-10T00:08:56.5609245Z +    ) -> Result<()> {
2025-11-10T00:08:56.5609389Z          // Track bytes received
2025-11-10T00:08:56.5609590Z          self.track_bytes_received(data.len() as u64);
2025-11-10T00:08:56.5609708Z -        
2025-11-10T00:08:56.5609817Z +
2025-11-10T00:08:56.5609969Z          // Check if peer is banned
2025-11-10T00:08:56.5610118Z          if self.is_banned(peer_addr) {
2025-11-10T00:08:56.5610380Z              warn!("Rejecting message from banned peer: {}", peer_addr);
2025-11-10T00:08:56.5610846Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2044:
2025-11-10T00:08:56.5611087Z              return Ok(()); // Silently drop messages from banned peers
2025-11-10T00:08:56.5611204Z          }
2025-11-10T00:08:56.5611437Z          let parsed = ProtocolParser::parse_message(&data)?;
2025-11-10T00:08:56.5611810Z -        
2025-11-10T00:08:56.5611918Z +
2025-11-10T00:08:56.5612183Z          // Handle special cases that don't go through protocol layer
2025-11-10T00:08:56.5612329Z          match parsed {
2025-11-10T00:08:56.5612447Z              // BIP331
2025-11-10T00:08:56.5612913Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2097:
2025-11-10T00:08:56.5613109Z                  // Continue to protocol layer processing
2025-11-10T00:08:56.5613219Z              }
2025-11-10T00:08:56.5613326Z          }
2025-11-10T00:08:56.5613432Z -        
2025-11-10T00:08:56.5613543Z +
2025-11-10T00:08:56.5613804Z          // Process with protocol layer if dependencies are available
2025-11-10T00:08:56.5614171Z -        if let (Some(ref protocol_engine), Some(ref storage), Some(ref mempool_manager)) = 
2025-11-10T00:08:56.5615034Z -            (self.protocol_engine.as_ref(), self.storage.as_ref(), self.mempool_manager.as_ref()) {
2025-11-10T00:08:56.5615171Z -            
2025-11-10T00:08:56.5615552Z +        if let (Some(ref protocol_engine), Some(ref storage), Some(ref mempool_manager)) = (
2025-11-10T00:08:56.5615719Z +            self.protocol_engine.as_ref(),
2025-11-10T00:08:56.5615871Z +            self.storage.as_ref(),
2025-11-10T00:08:56.5616023Z +            self.mempool_manager.as_ref(),
2025-11-10T00:08:56.5616138Z +        ) {
2025-11-10T00:08:56.5616488Z              // Convert ProtocolMessage to bllvm_protocol::network::NetworkMessage
2025-11-10T00:08:56.5616736Z              use crate::network::protocol_adapter::ProtocolAdapter;
2025-11-10T00:08:56.5617113Z              let protocol_msg = ProtocolAdapter::protocol_to_consensus_message(&parsed)?;
2025-11-10T00:08:56.5617590Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2108:
2025-11-10T00:08:56.5617703Z -            
2025-11-10T00:08:56.5617809Z +
2025-11-10T00:08:56.5617964Z              // Get or create PeerState
2025-11-10T00:08:56.5618210Z              let mut peer_states = self.peer_states.lock().unwrap();
2025-11-10T00:08:56.5618417Z -            let peer_state = peer_states.entry(peer_addr)
2025-11-10T00:08:56.5618565Z +            let peer_state = peer_states
2025-11-10T00:08:56.5618707Z +                .entry(peer_addr)
2025-11-10T00:08:56.5618978Z                  .or_insert_with(|| bllvm_protocol::network::PeerState::new());
2025-11-10T00:08:56.5619086Z -            
2025-11-10T00:08:56.5619205Z +
2025-11-10T00:08:56.5619354Z              // Create NodeChainAccess
2025-11-10T00:08:56.5619577Z              use crate::network::chain_access::NodeChainAccess;
2025-11-10T00:08:56.5619758Z              let chain_access = NodeChainAccess::new(
2025-11-10T00:08:56.5620232Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2118:
2025-11-10T00:08:56.5620386Z                  storage.transactions(),
2025-11-10T00:08:56.5620550Z                  Arc::clone(mempool_manager),
2025-11-10T00:08:56.5620674Z              );
2025-11-10T00:08:56.5620790Z -            
2025-11-10T00:08:56.5620897Z +
2025-11-10T00:08:56.5621036Z              // Get UTXO set and height
2025-11-10T00:08:56.5621240Z -            let utxo_set = storage.utxos().get_all_utxos()
2025-11-10T00:08:56.5621375Z +            let utxo_set = storage
2025-11-10T00:08:56.5621495Z +                .utxos()
2025-11-10T00:08:56.5621632Z +                .get_all_utxos()
2025-11-10T00:08:56.5621894Z                  .map_err(|e| anyhow::anyhow!("Failed to get UTXO set: {}", e))?;
2025-11-10T00:08:56.5622075Z -            let height = storage.chain().get_height()
2025-11-10T00:08:56.5622206Z +            let height = storage
2025-11-10T00:08:56.5622326Z +                .chain()
2025-11-10T00:08:56.5622448Z +                .get_height()
2025-11-10T00:08:56.5622700Z                  .map_err(|e| anyhow::anyhow!("Failed to get height: {}", e))?
2025-11-10T00:08:56.5622839Z                  .unwrap_or(0);
2025-11-10T00:08:56.5622952Z -            
2025-11-10T00:08:56.5625137Z +
2025-11-10T00:08:56.5625330Z              // Process message with protocol layer
2025-11-10T00:08:56.5625689Z              use bllvm_protocol::network::{process_network_message, ChainStateAccess};
2025-11-10T00:08:56.5625851Z              match process_network_message(
2025-11-10T00:08:56.5626321Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2140:
2025-11-10T00:08:56.5626610Z                      // Convert response to wire format and send via transport layer
2025-11-10T00:08:56.5626843Z                      use crate::network::message_bridge::MessageBridge;
2025-11-10T00:08:56.5627057Z                      use crate::network::transport::TransportType;
2025-11-10T00:08:56.5627544Z -                    if let Ok(wire_messages) = MessageBridge::extract_send_messages(&response, TransportType::Tcp) {
2025-11-10T00:08:56.5627705Z +                    if let Ok(wire_messages) =
2025-11-10T00:08:56.5628257Z +                        MessageBridge::extract_send_messages(&response, TransportType::Tcp)
2025-11-10T00:08:56.5628405Z +                    {
2025-11-10T00:08:56.5628574Z                          for wire_msg in wire_messages {
2025-11-10T00:08:56.5628835Z                              if let Err(e) = self.send_to_peer(peer_addr, wire_msg).await {
2025-11-10T00:08:56.5629145Z                                  warn!("Failed to send protocol response to {}: {}", peer_addr, e);
2025-11-10T00:08:56.5629601Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2158:
2025-11-10T00:08:56.5629813Z              // Dependencies not set - fall back to old behavior
2025-11-10T00:08:56.5630189Z              debug!("Protocol layer dependencies not set, skipping protocol processing");
2025-11-10T00:08:56.5630302Z          }
2025-11-10T00:08:56.5630407Z -        
2025-11-10T00:08:56.5630514Z +
2025-11-10T00:08:56.5630639Z          Ok(())
2025-11-10T00:08:56.5630752Z      }
2025-11-10T00:08:56.5630858Z  
2025-11-10T00:08:56.5631319Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2360:
2025-11-10T00:08:56.5631540Z          // Handle the request with storage and filter service
2025-11-10T00:08:56.5633248Z          let storage = self.storage.as_ref().map(Arc::clone);
2025-11-10T00:08:56.5633382Z          let response =
2025-11-10T00:08:56.5633938Z -            handle_get_filtered_block(get_filtered_block_msg, storage, Some(&self.filter_service)).await?;
2025-11-10T00:08:56.5634521Z +            handle_get_filtered_block(get_filtered_block_msg, storage, Some(&self.filter_service))
2025-11-10T00:08:56.5634652Z +                .await?;
2025-11-10T00:08:56.5634771Z  
2025-11-10T00:08:56.5634926Z          // Serialize and send response
2025-11-10T00:08:56.5635064Z          let response_wire =
2025-11-10T00:08:56.5635535Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2466:
2025-11-10T00:08:56.5635760Z      /// Handle GetAddr request - return known addresses
2025-11-10T00:08:56.5636062Z      async fn handle_get_addr(&self, peer_addr: SocketAddr) -> Result<()> {
2025-11-10T00:08:56.5636423Z          use crate::network::protocol::{AddrMessage, ProtocolMessage, ProtocolParser};
2025-11-10T00:08:56.5636539Z -        
2025-11-10T00:08:56.5636637Z +
2025-11-10T00:08:56.5636929Z          // Get fresh addresses from database (up to 2500, Bitcoin Core limit)
2025-11-10T00:08:56.5637151Z          let ban_list = self.ban_list.lock().unwrap().clone();
2025-11-10T00:08:56.5637321Z          let connected_peers: Vec<SocketAddr> = {
2025-11-10T00:08:56.5637761Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2473:
2025-11-10T00:08:56.5637941Z              let pm = self.peer_manager.lock().unwrap();
2025-11-10T00:08:56.5638086Z              pm.peer_socket_addresses()
2025-11-10T00:08:56.5638196Z          };
2025-11-10T00:08:56.5638302Z -        
2025-11-10T00:08:56.5638406Z +
2025-11-10T00:08:56.5638540Z          let addresses = {
2025-11-10T00:08:56.5638994Z              let mut db = self.address_database.lock().unwrap();
2025-11-10T00:08:56.5639173Z              let fresh = db.get_fresh_addresses(2500);
2025-11-10T00:08:56.5639626Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2480:
2025-11-10T00:08:56.5639878Z              db.filter_addresses(fresh, &ban_list, &connected_peers)
2025-11-10T00:08:56.5639985Z          };
2025-11-10T00:08:56.5640089Z -        
2025-11-10T00:08:56.5640191Z +
2025-11-10T00:08:56.5640331Z          // Create Addr message
2025-11-10T00:08:56.5640497Z          let addr_msg = AddrMessage { addresses };
2025-11-10T00:08:56.5640713Z          let response = ProtocolMessage::Addr(addr_msg);
2025-11-10T00:08:56.5641169Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2486:
2025-11-10T00:08:56.5641447Z          let wire_msg = ProtocolParser::serialize_message(&response)?;
2025-11-10T00:08:56.5641765Z -        
2025-11-10T00:08:56.5641888Z +
2025-11-10T00:08:56.5642026Z          // Send response
2025-11-10T00:08:56.5642226Z          self.send_to_peer(peer_addr, wire_msg).await?;
2025-11-10T00:08:56.5642341Z          Ok(())
2025-11-10T00:08:56.5642803Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2493:
2025-11-10T00:08:56.5643073Z      /// Handle Addr message - store addresses and optionally relay
2025-11-10T00:08:56.5643444Z      async fn handle_addr(&self, peer_addr: SocketAddr, msg: AddrMessage) -> Result<()> {
2025-11-10T00:08:56.5643653Z          use crate::network::protocol::NetworkAddress;
2025-11-10T00:08:56.5643763Z -        
2025-11-10T00:08:56.5643869Z +
2025-11-10T00:08:56.5644032Z          // Get peer services from peer state
2025-11-10T00:08:56.5644174Z          let peer_services = {
2025-11-10T00:08:56.5644586Z              let peer_states = self.peer_states.lock().unwrap();
2025-11-10T00:08:56.5645066Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2502:
2025-11-10T00:08:56.5645237Z                  .map(|state| state.services)
2025-11-10T00:08:56.5645368Z                  .unwrap_or(0)
2025-11-10T00:08:56.5645476Z          };
2025-11-10T00:08:56.5645596Z -        
2025-11-10T00:08:56.5645705Z +
2025-11-10T00:08:56.5645855Z          // Store addresses in database
2025-11-10T00:08:56.5645966Z          {
2025-11-10T00:08:56.5646185Z              let mut db = self.address_database.lock().unwrap();
2025-11-10T00:08:56.5646639Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2510:
2025-11-10T00:08:56.5646835Z                  db.add_address(addr.clone(), peer_services);
2025-11-10T00:08:56.5646958Z              }
2025-11-10T00:08:56.5647066Z          }
2025-11-10T00:08:56.5647174Z -        
2025-11-10T00:08:56.5647279Z +
2025-11-10T00:08:56.5647491Z          // Relay addresses to other peers (with rate limiting)
2025-11-10T00:08:56.5647727Z          self.relay_addresses(peer_addr, &msg.addresses).await?;
2025-11-10T00:08:56.5647832Z -        
2025-11-10T00:08:56.5647948Z +
2025-11-10T00:08:56.5648060Z          Ok(())
2025-11-10T00:08:56.5648169Z      }
2025-11-10T00:08:56.5648275Z  
2025-11-10T00:08:56.5648735Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2525:
2025-11-10T00:08:56.5648855Z      ) -> Result<()> {
2025-11-10T00:08:56.5649234Z          use crate::network::protocol::{AddrMessage, ProtocolMessage, ProtocolParser};
2025-11-10T00:08:56.5649420Z          use std::time::{SystemTime, UNIX_EPOCH};
2025-11-10T00:08:56.5649530Z -        
2025-11-10T00:08:56.5649637Z +
2025-11-10T00:08:56.5650025Z          // Rate limiting: don't send addr messages too frequently (Bitcoin Core: ~every 2.4 hours)
2025-11-10T00:08:56.5650179Z          let now = SystemTime::now()
2025-11-10T00:08:56.5650317Z              .duration_since(UNIX_EPOCH)
2025-11-10T00:08:56.5650735Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2532:
2025-11-10T00:08:56.5650854Z              .unwrap()
2025-11-10T00:08:56.5651181Z              .as_secs();
2025-11-10T00:08:56.5651417Z          let min_interval = 2 * 60 * 60 + 24 * 60; // 2.4 hours in seconds
2025-11-10T00:08:56.5651537Z -        
2025-11-10T00:08:56.5651642Z +
2025-11-10T00:08:56.5651750Z          {
2025-11-10T00:08:56.5651969Z              let last_sent = *self.last_addr_sent.lock().unwrap();
2025-11-10T00:08:56.5652181Z              if now.saturating_sub(last_sent) < min_interval {
2025-11-10T00:08:56.5652638Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2540:
2025-11-10T00:08:56.5652773Z                  return Ok(());
2025-11-10T00:08:56.5652892Z              }
2025-11-10T00:08:56.5653001Z          }
2025-11-10T00:08:56.5653107Z -        
2025-11-10T00:08:56.5653212Z +
2025-11-10T00:08:56.5653495Z          // Filter addresses (exclude local, banned, already connected)
2025-11-10T00:08:56.5653955Z          let ban_list = self.ban_list.lock().unwrap().clone();
2025-11-10T00:08:56.5654148Z          let connected_peers: Vec<SocketAddr> = {
2025-11-10T00:08:56.5654894Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2547:
2025-11-10T00:08:56.5655093Z              let pm = self.peer_manager.lock().unwrap();
2025-11-10T00:08:56.5655243Z              pm.peer_socket_addresses()
2025-11-10T00:08:56.5655356Z          };
2025-11-10T00:08:56.5655474Z -        
2025-11-10T00:08:56.5655580Z +
2025-11-10T00:08:56.5655715Z          let filtered = {
2025-11-10T00:08:56.5655913Z              let db = self.address_database.lock().unwrap();
2025-11-10T00:08:56.5656290Z              db.filter_addresses(addresses.to_vec(), &ban_list, &connected_peers)
2025-11-10T00:08:56.5656782Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2554:
2025-11-10T00:08:56.5656898Z          };
2025-11-10T00:08:56.5657003Z -        
2025-11-10T00:08:56.5657098Z +
2025-11-10T00:08:56.5657245Z          if filtered.is_empty() {
2025-11-10T00:08:56.5657382Z              return Ok(());
2025-11-10T00:08:56.5657496Z          }
2025-11-10T00:08:56.5657939Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2559:
2025-11-10T00:08:56.5658056Z -        
2025-11-10T00:08:56.5658153Z +
2025-11-10T00:08:56.5658390Z          // Limit to 1000 addresses per message (Bitcoin Core limit)
2025-11-10T00:08:56.5658823Z          let addresses_to_relay: Vec<NetworkAddress> = filtered.into_iter().take(1000).collect();
2025-11-10T00:08:56.5658932Z -        
2025-11-10T00:08:56.5659031Z +
2025-11-10T00:08:56.5659153Z          // Create Addr message
2025-11-10T00:08:56.5659303Z          let addr_msg = AddrMessage {
2025-11-10T00:08:56.5659460Z              addresses: addresses_to_relay,
2025-11-10T00:08:56.5659918Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2566:
2025-11-10T00:08:56.5660027Z          };
2025-11-10T00:08:56.5660257Z          let relay_msg = ProtocolMessage::Addr(addr_msg);
2025-11-10T00:08:56.5660531Z          let wire_msg = ProtocolParser::serialize_message(&relay_msg)?;
2025-11-10T00:08:56.5660645Z -        
2025-11-10T00:08:56.5660758Z +
2025-11-10T00:08:56.5660916Z          // Send to all peers except sender
2025-11-10T00:08:56.5661074Z          let peer_addrs: Vec<SocketAddr> = {
2025-11-10T00:08:56.5663142Z              let pm = self.peer_manager.lock().unwrap();
2025-11-10T00:08:56.5663608Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2575:
2025-11-10T00:08:56.5663772Z                  .filter(|addr| *addr != sender_addr)
2025-11-10T00:08:56.5663897Z                  .collect()
2025-11-10T00:08:56.5664016Z          };
2025-11-10T00:08:56.5664116Z -        
2025-11-10T00:08:56.5664222Z +
2025-11-10T00:08:56.5664557Z          for peer_addr in peer_addrs {
2025-11-10T00:08:56.5664848Z              if let Err(e) = self.send_to_peer(peer_addr, wire_msg.clone()).await {
2025-11-10T00:08:56.5665100Z                  warn!("Failed to relay addresses to {}: {}", peer_addr, e);
2025-11-10T00:08:56.5665848Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2582:
2025-11-10T00:08:56.5665968Z              }
2025-11-10T00:08:56.5666075Z          }
2025-11-10T00:08:56.5666185Z -        
2025-11-10T00:08:56.5666299Z +
2025-11-10T00:08:56.5666433Z          // Update last sent time
2025-11-10T00:08:56.5666618Z          *self.last_addr_sent.lock().unwrap() = now;
2025-11-10T00:08:56.5666723Z -        
2025-11-10T00:08:56.5666839Z +
2025-11-10T00:08:56.5666950Z          Ok(())
2025-11-10T00:08:56.5667052Z      }
2025-11-10T00:08:56.5667165Z  
2025-11-10T00:08:56.5667626Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2593:
2025-11-10T00:08:56.5667788Z          if !self.enable_self_advertisement {
2025-11-10T00:08:56.5667986Z              return Ok(()); // Self-advertisement disabled
2025-11-10T00:08:56.5668301Z          }
2025-11-10T00:08:56.5668421Z -        
2025-11-10T00:08:56.5668912Z -        use crate::network::protocol::{AddrMessage, NetworkAddress, ProtocolMessage, ProtocolParser};
2025-11-10T00:08:56.5669037Z +
2025-11-10T00:08:56.5669192Z +        use crate::network::protocol::{
2025-11-10T00:08:56.5669497Z +            AddrMessage, NetworkAddress, ProtocolMessage, ProtocolParser,
2025-11-10T00:08:56.5669609Z +        };
2025-11-10T00:08:56.5669750Z          use std::net::IpAddr;
2025-11-10T00:08:56.5669853Z -        
2025-11-10T00:08:56.5669955Z +
2025-11-10T00:08:56.5670135Z          // Convert SocketAddr to NetworkAddress
2025-11-10T00:08:56.5670302Z          let ip_bytes = match listen_addr.ip() {
2025-11-10T00:08:56.5670443Z              IpAddr::V4(ipv4) => {
2025-11-10T00:08:56.5670973Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2607:
2025-11-10T00:08:56.5671224Z                  bytes[12..16].copy_from_slice(&ipv4.octets());
2025-11-10T00:08:56.5671351Z                  bytes
2025-11-10T00:08:56.5671462Z              }
2025-11-10T00:08:56.5671608Z -            IpAddr::V6(ipv6) => {
2025-11-10T00:08:56.5671728Z -                ipv6.octets()
2025-11-10T00:08:56.5671837Z -            }
2025-11-10T00:08:56.5672010Z +            IpAddr::V6(ipv6) => ipv6.octets(),
2025-11-10T00:08:56.5672119Z          };
2025-11-10T00:08:56.5672226Z -        
2025-11-10T00:08:56.5672329Z +
2025-11-10T00:08:56.5672497Z          let our_addr = NetworkAddress {
2025-11-10T00:08:56.5672816Z              services,
2025-11-10T00:08:56.5672944Z              ip: ip_bytes,
2025-11-10T00:08:56.5673407Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2618:
2025-11-10T00:08:56.5673555Z              port: listen_addr.port(),
2025-11-10T00:08:56.5673716Z          };
2025-11-10T00:08:56.5673821Z -        
2025-11-10T00:08:56.5673929Z +
2025-11-10T00:08:56.5674101Z          // Create Addr message with just our address
2025-11-10T00:08:56.5674253Z          let addr_msg = AddrMessage {
2025-11-10T00:08:56.5674573Z              addresses: vec![our_addr.clone()],
2025-11-10T00:08:56.5675066Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2624:
2025-11-10T00:08:56.5675184Z          };
2025-11-10T00:08:56.5675405Z          let relay_msg = ProtocolMessage::Addr(addr_msg);
2025-11-10T00:08:56.5675690Z          let wire_msg = ProtocolParser::serialize_message(&relay_msg)?;
2025-11-10T00:08:56.5675798Z -        
2025-11-10T00:08:56.5675898Z +
2025-11-10T00:08:56.5676051Z          // Send to all connected peers
2025-11-10T00:08:56.5676205Z          let peer_addrs: Vec<SocketAddr> = {
2025-11-10T00:08:56.5676383Z              let pm = self.peer_manager.lock().unwrap();
2025-11-10T00:08:56.5676819Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2631:
2025-11-10T00:08:56.5676960Z              pm.peer_socket_addresses()
2025-11-10T00:08:56.5677119Z          };
2025-11-10T00:08:56.5677221Z -        
2025-11-10T00:08:56.5677333Z +
2025-11-10T00:08:56.5677474Z          for peer_addr in peer_addrs {
2025-11-10T00:08:56.5677986Z              if let Err(e) = self.send_to_peer(peer_addr, wire_msg.clone()).await {
2025-11-10T00:08:56.5678238Z                  warn!("Failed to advertise self to {}: {}", peer_addr, e);
2025-11-10T00:08:56.5678685Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2637:
2025-11-10T00:08:56.5678791Z              }
2025-11-10T00:08:56.5678900Z          }
2025-11-10T00:08:56.5679015Z -        
2025-11-10T00:08:56.5679120Z +
2025-11-10T00:08:56.5679288Z          // Also store our own address in database
2025-11-10T00:08:56.5679397Z          {
2025-11-10T00:08:56.5679602Z              let mut db = self.address_database.lock().unwrap();
2025-11-10T00:08:56.5680034Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2643:
2025-11-10T00:08:56.5680187Z              db.add_address(our_addr, services);
2025-11-10T00:08:56.5680501Z          }
2025-11-10T00:08:56.5680620Z -        
2025-11-10T00:08:56.5680734Z +
2025-11-10T00:08:56.5680856Z          Ok(())
2025-11-10T00:08:56.5680964Z      }
2025-11-10T00:08:56.5681068Z  
2025-11-10T00:08:56.5681591Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2649:
2025-11-10T00:08:56.5681743Z      /// Get list of banned peers
2025-11-10T00:08:56.5681991Z      pub fn get_banned_peers(&self) -> Vec<(SocketAddr, u64)> {
2025-11-10T00:08:56.5682177Z          let ban_list = self.ban_list.lock().unwrap();
2025-11-10T00:08:56.5682488Z -        ban_list.iter().map(|(addr, timestamp)| (*addr, *timestamp)).collect()
2025-11-10T00:08:56.5682608Z +        ban_list
2025-11-10T00:08:56.5682724Z +            .iter()
2025-11-10T00:08:56.5682925Z +            .map(|(addr, timestamp)| (*addr, *timestamp))
2025-11-10T00:08:56.5683048Z +            .collect()
2025-11-10T00:08:56.5683151Z      }
2025-11-10T00:08:56.5683256Z  
2025-11-10T00:08:56.5683459Z      /// Get peer addresses (async version for RPC)
2025-11-10T00:08:56.5683920Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2714:
2025-11-10T00:08:56.5684070Z          peer_addr: SocketAddr,
2025-11-10T00:08:56.5684524Z          msg: crate::network::protocol::GetBanListMessage,
2025-11-10T00:08:56.5684666Z      ) -> Result<()> {
2025-11-10T00:08:56.5686858Z -        use crate::network::protocol::{BanEntry, BanListMessage, NetworkAddress};
2025-11-10T00:08:56.5687134Z          use crate::network::ban_list_merging::calculate_ban_list_hash;
2025-11-10T00:08:56.5687474Z +        use crate::network::protocol::{BanEntry, BanListMessage, NetworkAddress};
2025-11-10T00:08:56.5687660Z          use std::time::{SystemTime, UNIX_EPOCH};
2025-11-10T00:08:56.5687765Z  
2025-11-10T00:08:56.5688044Z -        debug!("GetBanList request from {}: full={}, min_duration={}", 
2025-11-10T00:08:56.5688271Z -               peer_addr, msg.request_full, msg.min_ban_duration);
2025-11-10T00:08:56.5688405Z +        debug!(
2025-11-10T00:08:56.5688652Z +            "GetBanList request from {}: full={}, min_duration={}",
2025-11-10T00:08:56.5688870Z +            peer_addr, msg.request_full, msg.min_ban_duration
2025-11-10T00:08:56.5688979Z +        );
2025-11-10T00:08:56.5689087Z  
2025-11-10T00:08:56.5689236Z          // Get current ban list
2025-11-10T00:08:56.5689424Z          let ban_list = self.ban_list.lock().unwrap();
2025-11-10T00:08:56.5690333Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2776:
2025-11-10T00:08:56.5690511Z          let response = BanListMessage {
2025-11-10T00:08:56.5690752Z              is_full: msg.request_full,
2025-11-10T00:08:56.5690873Z              ban_list_hash,
2025-11-10T00:08:56.5691175Z -            ban_entries: if msg.request_full { ban_entries } else { Vec::new() },
2025-11-10T00:08:56.5691349Z +            ban_entries: if msg.request_full {
2025-11-10T00:08:56.5691477Z +                ban_entries
2025-11-10T00:08:56.5691605Z +            } else {
2025-11-10T00:08:56.5691741Z +                Vec::new()
2025-11-10T00:08:56.5692121Z +            },
2025-11-10T00:08:56.5692257Z              timestamp: now,
2025-11-10T00:08:56.5692363Z          };
2025-11-10T00:08:56.5692481Z  
2025-11-10T00:08:56.5692945Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2785:
2025-11-10T00:08:56.5693281Z          let serialized = ProtocolParser::serialize_message(&response_msg)?;
2025-11-10T00:08:56.5693504Z          self.send_to_peer(peer_addr, serialized).await?;
2025-11-10T00:08:56.5695697Z  
2025-11-10T00:08:56.5695966Z -        debug!("Sent BanList response to {}: {} entries", peer_addr, 
2025-11-10T00:08:56.5696205Z -               if msg.request_full { ban_entries.len() } else { 0 });
2025-11-10T00:08:56.5696320Z +        debug!(
2025-11-10T00:08:56.5696497Z +            "Sent BanList response to {}: {} entries",
2025-11-10T00:08:56.5696624Z +            peer_addr,
2025-11-10T00:08:56.5697004Z +            if msg.request_full {
2025-11-10T00:08:56.5697161Z +                ban_entries.len()
2025-11-10T00:08:56.5697284Z +            } else {
2025-11-10T00:08:56.5697408Z +                0
2025-11-10T00:08:56.5697515Z +            }
2025-11-10T00:08:56.5697617Z +        );
2025-11-10T00:08:56.5697718Z  
2025-11-10T00:08:56.5697830Z          Ok(())
2025-11-10T00:08:56.5697931Z      }
2025-11-10T00:08:56.5698373Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2800:
2025-11-10T00:08:56.5698734Z          use crate::network::ban_list_merging::{validate_ban_entry, verify_ban_list_hash};
2025-11-10T00:08:56.5698872Z          use std::net::IpAddr;
2025-11-10T00:08:56.5698975Z  
2025-11-10T00:08:56.5699204Z -        debug!("BanList received from {}: full={}, {} entries", 
2025-11-10T00:08:56.5699404Z -               peer_addr, msg.is_full, msg.ban_entries.len());
2025-11-10T00:08:56.5699510Z +        debug!(
2025-11-10T00:08:56.5699707Z +            "BanList received from {}: full={}, {} entries",
2025-11-10T00:08:56.5699831Z +            peer_addr,
2025-11-10T00:08:56.5699952Z +            msg.is_full,
2025-11-10T00:08:56.5700091Z +            msg.ban_entries.len()
2025-11-10T00:08:56.5700210Z +        );
2025-11-10T00:08:56.5700317Z  
2025-11-10T00:08:56.5700479Z          // Verify hash if full list provided
2025-11-10T00:08:56.5700605Z          if msg.is_full {
2025-11-10T00:08:56.5701189Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2813:
2025-11-10T00:08:56.5701297Z  
2025-11-10T00:08:56.5701565Z          // If hash-only, we can't merge (would need to request full list)
2025-11-10T00:08:56.5701710Z          if !msg.is_full {
2025-11-10T00:08:56.5702050Z -            debug!("Received hash-only ban list from {}, skipping merge", peer_addr);
2025-11-10T00:08:56.5702171Z +            debug!(
2025-11-10T00:08:56.5702411Z +                "Received hash-only ban list from {}, skipping merge",
2025-11-10T00:08:56.5702556Z +                peer_addr
2025-11-10T00:08:56.5702669Z +            );
2025-11-10T00:08:56.5702792Z              return Ok(());
2025-11-10T00:08:56.5702915Z          }
2025-11-10T00:08:56.5703020Z  
2025-11-10T00:08:56.5705637Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2831:
2025-11-10T00:08:56.5705805Z                  // IPv4-mapped IPv6 address
2025-11-10T00:08:56.5706003Z                  let ipv4_bytes = &entry.addr.ip[12..16];
2025-11-10T00:08:56.5706179Z                  IpAddr::V4(std::net::Ipv4Addr::new(
2025-11-10T00:08:56.5706427Z -                    ipv4_bytes[0], ipv4_bytes[1], ipv4_bytes[2], ipv4_bytes[3]
2025-11-10T00:08:56.5706571Z +                    ipv4_bytes[0],
2025-11-10T00:08:56.5706698Z +                    ipv4_bytes[1],
2025-11-10T00:08:56.5706824Z +                    ipv4_bytes[2],
2025-11-10T00:08:56.5706957Z +                    ipv4_bytes[3],
2025-11-10T00:08:56.5707069Z                  ))
2025-11-10T00:08:56.5707184Z              } else {
2025-11-10T00:08:56.5707326Z                  // IPv6 address
2025-11-10T00:08:56.5707794Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2882:
2025-11-10T00:08:56.5708187Z              ban_list.len()
2025-11-10T00:08:56.5708292Z          };
2025-11-10T00:08:56.5708584Z          let resource_metrics = self.dos_protection.get_metrics().await;
2025-11-10T00:08:56.5708692Z -        
2025-11-10T00:08:56.5708796Z +
2025-11-10T00:08:56.5708978Z          crate::node::metrics::NetworkMetrics {
2025-11-10T00:08:56.5709154Z              peer_count: active_connections,
2025-11-10T00:08:56.5709291Z              bytes_sent: sent,
2025-11-10T00:08:56.5709850Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2889:
2025-11-10T00:08:56.5710013Z              bytes_received: received,
2025-11-10T00:08:56.5710204Z -            messages_sent: 0, // Would need to track this
2025-11-10T00:08:56.5710405Z +            messages_sent: 0,     // Would need to track this
2025-11-10T00:08:56.5710827Z              messages_received: 0, // Would need to track this
2025-11-10T00:08:56.5710977Z              active_connections,
2025-11-10T00:08:56.5711134Z              banned_peers: banned_peers_count,
2025-11-10T00:08:56.5711567Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2894:
2025-11-10T00:08:56.5711783Z              connection_attempts: 0, // Would need to track this
2025-11-10T00:08:56.5711980Z              connection_failures: 0, // Would need to track this
2025-11-10T00:08:56.5712190Z              dos_protection: crate::node::metrics::DosMetrics {
2025-11-10T00:08:56.5712457Z -                connection_rate_violations: 0, // Would need to track this
2025-11-10T00:08:56.5712629Z -                auto_bans: 0, // Would need to track this
2025-11-10T00:08:56.5714981Z -                message_queue_overflows: 0, // Would need to track this
2025-11-10T00:08:56.5715265Z +                connection_rate_violations: 0,   // Would need to track this
2025-11-10T00:08:56.5715469Z +                auto_bans: 0,                    // Would need to track this
2025-11-10T00:08:56.5715720Z +                message_queue_overflows: 0,      // Would need to track this
2025-11-10T00:08:56.5715990Z                  active_connection_limit_hits: 0, // Would need to track this
2025-11-10T00:08:56.5716259Z -                resource_exhaustion_events: 0, // Would need to track this
2025-11-10T00:08:56.5716529Z +                resource_exhaustion_events: 0,   // Would need to track this
2025-11-10T00:08:56.5716644Z              },
2025-11-10T00:08:56.5716765Z          }
2025-11-10T00:08:56.5716871Z      }
2025-11-10T00:08:56.5717332Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2913:
2025-11-10T00:08:56.5717517Z      /// Create version message with service flags
2025-11-10T00:08:56.5717629Z      ///
2025-11-10T00:08:56.5717959Z      /// Creates version message with service flags for all supported features
2025-11-10T00:08:56.5718071Z -    /// 
2025-11-10T00:08:56.5718182Z +    ///
2025-11-10T00:08:56.5718336Z      /// Sets service flags based on:
2025-11-10T00:08:56.5718650Z      /// - BIP157: NODE_COMPACT_FILTERS (always enabled if filter service exists)
2025-11-10T00:08:56.5718937Z      /// - UTXO Commitments: NODE_UTXO_COMMITMENTS (if feature enabled)
2025-11-10T00:08:56.5719469Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2937:
2025-11-10T00:08:56.5719578Z  
2025-11-10T00:08:56.5719761Z          // Add service flags for supported features
2025-11-10T00:08:56.5719931Z          let mut services_with_filters = services;
2025-11-10T00:08:56.5720041Z -        
2025-11-10T00:08:56.5720144Z +
2025-11-10T00:08:56.5720487Z          // BIP157 Compact Block Filters (always enabled if filter service exists)
2025-11-10T00:08:56.5720685Z          services_with_filters |= NODE_COMPACT_FILTERS;
2025-11-10T00:08:56.5720794Z -        
2025-11-10T00:08:56.5720910Z +
2025-11-10T00:08:56.5721089Z          // UTXO Commitments (if feature enabled)
2025-11-10T00:08:56.5721553Z          #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.5721671Z          {
2025-11-10T00:08:56.5723608Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2947:
2025-11-10T00:08:56.5723970Z              services_with_filters |= crate::network::protocol::NODE_UTXO_COMMITMENTS;
2025-11-10T00:08:56.5724079Z          }
2025-11-10T00:08:56.5724198Z -        
2025-11-10T00:08:56.5724490Z +
2025-11-10T00:08:56.5724666Z          // Ban List Sharing (if config enabled)
2025-11-10T00:08:56.5724851Z          if self.ban_list_sharing_config.is_some() {
2025-11-10T00:08:56.5725203Z              services_with_filters |= crate::network::protocol::NODE_BAN_LIST_SHARING;
2025-11-10T00:08:56.5725666Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2953:
2025-11-10T00:08:56.5725780Z          }
2025-11-10T00:08:56.5725903Z -        
2025-11-10T00:08:56.5726247Z +
2025-11-10T00:08:56.5726430Z          // Dandelion (if feature enabled)
2025-11-10T00:08:56.5726602Z          #[cfg(feature = "dandelion")]
2025-11-10T00:08:56.5726711Z          {
2025-11-10T00:08:56.5727170Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2958:
2025-11-10T00:08:56.5727477Z              services_with_filters |= crate::network::protocol::NODE_DANDELION;
2025-11-10T00:08:56.5727592Z          }
2025-11-10T00:08:56.5727703Z -        
2025-11-10T00:08:56.5727807Z +
2025-11-10T00:08:56.5727990Z          // Package Relay (BIP331) - always enabled
2025-11-10T00:08:56.5728308Z          services_with_filters |= crate::network::protocol::NODE_PACKAGE_RELAY;
2025-11-10T00:08:56.5728411Z -        
2025-11-10T00:08:56.5728516Z +
2025-11-10T00:08:56.5728671Z          // FIBRE - always enabled
2025-11-10T00:08:56.5728950Z          services_with_filters |= crate::network::protocol::NODE_FIBRE;
2025-11-10T00:08:56.5729055Z  
2025-11-10T00:08:56.5729589Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/package_relay.rs:138:
2025-11-10T00:08:56.5729925Z      pub fn new(transactions: Vec<Transaction>) -> Result<Self, PackageError> {
2025-11-10T00:08:56.5730117Z          Self::new_with_utxo_set(transactions, None)
2025-11-10T00:08:56.5730229Z      }
2025-11-10T00:08:56.5730328Z -    
2025-11-10T00:08:56.5730424Z +
2025-11-10T00:08:56.5730710Z      /// Create a new transaction package with UTXO set for fee calculation
2025-11-10T00:08:56.5730846Z      pub fn new_with_utxo_set(
2025-11-10T00:08:56.5730990Z          transactions: Vec<Transaction>,
2025-11-10T00:08:56.5731471Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/package_relay.rs:168:
2025-11-10T00:08:56.5731691Z          // Calculate combined fee from UTXO set if provided
2025-11-10T00:08:56.5731907Z          let combined_fee = if let Some(utxo_set) = utxo_set {
2025-11-10T00:08:56.5732180Z              // Calculate fee for each transaction: sum(inputs) - sum(outputs)
2025-11-10T00:08:56.5732335Z -            transactions.iter().map(|tx| {
2025-11-10T00:08:56.5732505Z -                let input_total: u64 = tx.inputs.iter()
2025-11-10T00:08:56.5732691Z -                    .filter_map(|inp| utxo_set.get(&inp.prevout))
2025-11-10T00:08:56.5734893Z -                    .map(|utxo| utxo.value as u64)
2025-11-10T00:08:56.5735020Z -                    .sum();
2025-11-10T00:08:56.5735206Z -                let output_total: u64 = tx.outputs.iter()
2025-11-10T00:08:56.5735364Z -                    .map(|out| out.value as u64)
2025-11-10T00:08:56.5735497Z -                    .sum();
2025-11-10T00:08:56.5735649Z -                if input_total > output_total {
2025-11-10T00:08:56.5735808Z -                    input_total - output_total
2025-11-10T00:08:56.5735935Z -                } else {
2025-11-10T00:08:56.5736048Z -                    0
2025-11-10T00:08:56.5736160Z -                }
2025-11-10T00:08:56.5736271Z -            }).sum()
2025-11-10T00:08:56.5736402Z +            transactions
2025-11-10T00:08:56.5736514Z +                .iter()
2025-11-10T00:08:56.5736878Z +                .map(|tx| {
2025-11-10T00:08:56.5737035Z +                    let input_total: u64 = tx
2025-11-10T00:08:56.5737154Z +                        .inputs
2025-11-10T00:08:56.5737265Z +                        .iter()
2025-11-10T00:08:56.5737471Z +                        .filter_map(|inp| utxo_set.get(&inp.prevout))
2025-11-10T00:08:56.5737640Z +                        .map(|utxo| utxo.value as u64)
2025-11-10T00:08:56.5737759Z +                        .sum();
2025-11-10T00:08:56.5738096Z +                    let output_total: u64 = tx.outputs.iter().map(|out| out.value as u64).sum();
2025-11-10T00:08:56.5738263Z +                    if input_total > output_total {
2025-11-10T00:08:56.5738417Z +                        input_total - output_total
2025-11-10T00:08:56.5738530Z +                    } else {
2025-11-10T00:08:56.5738652Z +                        0
2025-11-10T00:08:56.5738944Z +                    }
2025-11-10T00:08:56.5739056Z +                })
2025-11-10T00:08:56.5739178Z +                .sum()
2025-11-10T00:08:56.5739293Z          } else {
2025-11-10T00:08:56.5739453Z              0 // Fee calculation requires UTXO set
2025-11-10T00:08:56.5739558Z          };
2025-11-10T00:08:56.5740114Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:4:
2025-11-10T00:08:56.5740226Z  
2025-11-10T00:08:56.5740363Z  use anyhow::Result;
2025-11-10T00:08:56.5740493Z  use std::net::SocketAddr;
2025-11-10T00:08:56.5740612Z +use std::sync::Arc;
2025-11-10T00:08:56.5741226Z  use std::time::{SystemTime, UNIX_EPOCH};
2025-11-10T00:08:56.5741353Z  use tokio::sync::mpsc;
2025-11-10T00:08:56.5741490Z  use tracing::{debug, info, warn};
2025-11-10T00:08:56.5741911Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:10:
2025-11-10T00:08:56.5742033Z -use std::sync::Arc;
2025-11-10T00:08:56.5742142Z  
2025-11-10T00:08:56.5742407Z +use super::transport::{TransportAddr, TransportConnection};
2025-11-10T00:08:56.5742546Z  use super::NetworkMessage;
2025-11-10T00:08:56.5742785Z -use super::transport::{TransportConnection, TransportAddr};
2025-11-10T00:08:56.5742884Z  
2025-11-10T00:08:56.5743006Z  /// Peer connection state
2025-11-10T00:08:56.5743102Z -/// 
2025-11-10T00:08:56.5743202Z +///
2025-11-10T00:08:56.5743596Z  /// Supports multiple transport types (TCP, Quinn, Iroh) via TransportConnection trait
2025-11-10T00:08:56.5743718Z  pub struct Peer {
2025-11-10T00:08:56.5743836Z      addr: SocketAddr,
2025-11-10T00:08:56.5744260Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:48:
2025-11-10T00:08:56.5744541Z  
2025-11-10T00:08:56.5744652Z  impl Peer {
2025-11-10T00:08:56.5744881Z      /// Create a new peer connection from a TransportConnection
2025-11-10T00:08:56.5744989Z -    /// 
2025-11-10T00:08:56.5745096Z +    ///
2025-11-10T00:08:56.5745482Z      /// This is the preferred method as it supports all transport types (TCP, Quinn, Iroh).
2025-11-10T00:08:56.5747294Z      /// The connection is managed via channels for concurrent read/write.
2025-11-10T00:08:56.5747606Z      pub fn from_transport_connection<C: TransportConnection + 'static>(
2025-11-10T00:08:56.5748055Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:59:
2025-11-10T00:08:56.5748172Z      ) -> Self {
2025-11-10T00:08:56.5748322Z          // Create channel for sending messages
2025-11-10T00:08:56.5748574Z          let (send_tx, send_rx) = mpsc::unbounded_channel::<Vec<u8>>();
2025-11-10T00:08:56.5748689Z -        
2025-11-10T00:08:56.5748794Z +
2025-11-10T00:08:56.5749070Z          let transport_addr_clone = transport_addr.clone();
2025-11-10T00:08:56.5749292Z          let message_tx_clone = message_tx.clone();
2025-11-10T00:08:56.5749411Z -        
2025-11-10T00:08:56.5749515Z +
2025-11-10T00:08:56.5749824Z          // Wrap connection in Arc<Mutex> to share between read and write tasks
2025-11-10T00:08:56.5749981Z          use std::sync::Arc;
2025-11-10T00:08:56.5750123Z          use tokio::sync::Mutex;
2025-11-10T00:08:56.5750816Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:69:
2025-11-10T00:08:56.5750970Z          let conn = Arc::new(Mutex::new(conn));
2025-11-10T00:08:56.5751119Z          let conn_read = Arc::clone(&conn);
2025-11-10T00:08:56.5751263Z          let conn_write = Arc::clone(&conn);
2025-11-10T00:08:56.5751362Z -        
2025-11-10T00:08:56.5751464Z +
2025-11-10T00:08:56.5751671Z          // Spawn read task using TransportConnection::recv
2025-11-10T00:08:56.5751813Z          tokio::spawn(async move {
2025-11-10T00:08:56.5751938Z              loop {
2025-11-10T00:08:56.5752386Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:83:
2025-11-10T00:08:56.5752505Z                          }
2025-11-10T00:08:56.5752611Z                      }
2025-11-10T00:08:56.5752730Z                  };
2025-11-10T00:08:56.5753040Z -                
2025-11-10T00:08:56.5753154Z +
2025-11-10T00:08:56.5753313Z                  if data.is_empty() {
2025-11-10T00:08:56.5753434Z                      break;
2025-11-10T00:08:56.5753541Z                  }
2025-11-10T00:08:56.5753984Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:90:
2025-11-10T00:08:56.5754101Z -                
2025-11-10T00:08:56.5754212Z +
2025-11-10T00:08:56.5754594Z                  let peer_addr = match &transport_addr_clone {
2025-11-10T00:08:56.5754840Z                      super::transport::TransportAddr::Tcp(sock) => *sock,
2025-11-10T00:08:56.5754990Z                      #[cfg(feature = "quinn")]
2025-11-10T00:08:56.5755437Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:100:
2025-11-10T00:08:56.5755831Z                  let _ = message_tx_clone.send(NetworkMessage::RawMessageReceived(data, peer_addr));
2025-11-10T00:08:56.5755939Z              }
2025-11-10T00:08:56.5756052Z          });
2025-11-10T00:08:56.5756159Z -        
2025-11-10T00:08:56.5756273Z +
2025-11-10T00:08:56.5756486Z          // Spawn write task using TransportConnection::send
2025-11-10T00:08:56.5756621Z          tokio::spawn(async move {
2025-11-10T00:08:56.5756776Z              let mut send_rx = send_rx;
2025-11-10T00:08:56.5757206Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:107:
2025-11-10T00:08:56.5757303Z -            
2025-11-10T00:08:56.5757399Z +
2025-11-10T00:08:56.5757509Z              loop {
2025-11-10T00:08:56.5757646Z                  match send_rx.recv().await {
2025-11-10T00:08:56.5757765Z                      Some(data) => {
2025-11-10T00:08:56.5758208Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:124:
2025-11-10T00:08:56.5758310Z                      }
2025-11-10T00:08:56.5758409Z                  }
2025-11-10T00:08:56.5758507Z              }
2025-11-10T00:08:56.5758613Z -            
2025-11-10T00:08:56.5758715Z +
2025-11-10T00:08:56.5758898Z              // Gracefully close connection on write task exit
2025-11-10T00:08:56.5759125Z              // Connection will be closed when conn_guard is dropped
2025-11-10T00:08:56.5759222Z          });
2025-11-10T00:08:56.5759638Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:131:
2025-11-10T00:08:56.5759742Z -        
2025-11-10T00:08:56.5759844Z +
2025-11-10T00:08:56.5759981Z          let now = SystemTime::now()
2025-11-10T00:08:56.5760116Z              .duration_since(UNIX_EPOCH)
2025-11-10T00:08:56.5760225Z              .unwrap()
2025-11-10T00:08:56.5760650Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:135:
2025-11-10T00:08:56.5760778Z              .as_secs();
2025-11-10T00:08:56.5760875Z -        
2025-11-10T00:08:56.5760970Z +
2025-11-10T00:08:56.5761079Z          Self {
2025-11-10T00:08:56.5761180Z              addr,
2025-11-10T00:08:56.5761299Z              transport_addr,
2025-11-10T00:08:56.5770815Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:153:
2025-11-10T00:08:56.5771279Z              last_tx_received: None,
2025-11-10T00:08:56.5771394Z          }
2025-11-10T00:08:56.5771503Z      }
2025-11-10T00:08:56.5771623Z -    
2025-11-10T00:08:56.5771726Z +
2025-11-10T00:08:56.5772065Z      /// Create a new peer connection from a TCP stream (backward compatibility)
2025-11-10T00:08:56.5772179Z -    /// 
2025-11-10T00:08:56.5772301Z +    ///
2025-11-10T00:08:56.5772820Z      /// This is a convenience method that wraps a TcpStream in a TcpConnection.
2025-11-10T00:08:56.5773668Z      #[deprecated(note = "Use from_transport_connection instead for transport abstraction")]
2025-11-10T00:08:56.5773796Z      pub fn new(
2025-11-10T00:08:56.5776134Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:165:
2025-11-10T00:08:56.5776254Z      ) -> Self {
2025-11-10T00:08:56.5776692Z          use super::tcp_transport::TcpConnection;
2025-11-10T00:08:56.5776859Z          use super::transport::TransportAddr;
2025-11-10T00:08:56.5776973Z -        
2025-11-10T00:08:56.5777082Z +
2025-11-10T00:08:56.5777305Z          let peer_addr = stream.peer_addr().unwrap_or(addr);
2025-11-10T00:08:56.5777443Z          let tcp_conn = TcpConnection {
2025-11-10T00:08:56.5777547Z              stream,
2025-11-10T00:08:56.5777980Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:172:
2025-11-10T00:08:56.5778168Z              peer_addr: TransportAddr::Tcp(peer_addr),
2025-11-10T00:08:56.5778303Z              connected: true,
2025-11-10T00:08:56.5778412Z          };
2025-11-10T00:08:56.5778533Z -        
2025-11-10T00:08:56.5778642Z +
2025-11-10T00:08:56.5779052Z          Self::from_transport_connection(tcp_conn, addr, TransportAddr::Tcp(addr), message_tx)
2025-11-10T00:08:56.5779170Z      }
2025-11-10T00:08:56.5779280Z  
2025-11-10T00:08:56.5779742Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:189:
2025-11-10T00:08:56.5779915Z          self.handle_peer_communication().await?;
2025-11-10T00:08:56.5780035Z  
2025-11-10T00:08:56.5780191Z          // Send disconnection notification
2025-11-10T00:08:56.5780305Z -        let _ = self
2025-11-10T00:08:56.5780430Z -            .message_tx
2025-11-10T00:08:56.5780779Z -            .send(NetworkMessage::PeerDisconnected(self.transport_addr.clone()));
2025-11-10T00:08:56.5781060Z +        let _ = self.message_tx.send(NetworkMessage::PeerDisconnected(
2025-11-10T00:08:56.5781218Z +            self.transport_addr.clone(),
2025-11-10T00:08:56.5781329Z +        ));
2025-11-10T00:08:56.5781433Z  
2025-11-10T00:08:56.5781538Z          Ok(())
2025-11-10T00:08:56.5781651Z      }
2025-11-10T00:08:56.5782093Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:198:
2025-11-10T00:08:56.5782190Z  
2025-11-10T00:08:56.5782348Z      /// Handle peer communication loop
2025-11-10T00:08:56.5782464Z -    /// 
2025-11-10T00:08:56.5782571Z +    ///
2025-11-10T00:08:56.5782846Z      /// Note: The read loop is now handled in `new()` via stream splitting.
2025-11-10T00:08:56.5783081Z      /// This method just waits for the connection to close.
2025-11-10T00:08:56.5783335Z      async fn handle_peer_communication(&mut self) -> Result<()> {
2025-11-10T00:08:56.5783757Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:205:
2025-11-10T00:08:56.5783956Z          // We just wait here to detect when connection closes
2025-11-10T00:08:56.5784501Z          // In a real implementation, we'd monitor the read task or connection state
2025-11-10T00:08:56.5784752Z          tokio::time::sleep(tokio::time::Duration::from_secs(1)).await;
2025-11-10T00:08:56.5784868Z -        
2025-11-10T00:08:56.5784969Z +
2025-11-10T00:08:56.5785391Z          // Connection close is automatically detected by the read task in from_transport_connection
2025-11-10T00:08:56.5785744Z          // When recv() returns empty data or error, the task breaks and sends PeerDisconnected
2025-11-10T00:08:56.5787987Z          self.connected = false;
2025-11-10T00:08:56.5788432Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:248:
2025-11-10T00:08:56.5788534Z      }
2025-11-10T00:08:56.5788638Z  
2025-11-10T00:08:56.5788769Z      /// Send a message to the peer
2025-11-10T00:08:56.5788866Z -    /// 
2025-11-10T00:08:56.5788964Z +    ///
2025-11-10T00:08:56.5789213Z      /// Messages are sent via a channel to a background write task.
2025-11-10T00:08:56.5789474Z      pub async fn send_message(&self, message: Vec<u8>) -> Result<()> {
2025-11-10T00:08:56.5789631Z          let message_len = message.len();
2025-11-10T00:08:56.5790111Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol.rs:2:
2025-11-10T00:08:56.5790214Z  //!
2025-11-10T00:08:56.5790564Z  //! Implements Bitcoin P2P protocol message serialization and deserialization.
2025-11-10T00:08:56.5790877Z  
2025-11-10T00:08:56.5791099Z -use bllvm_protocol::bip157::NODE_COMPACT_FILTERS;
2025-11-10T00:08:56.5791295Z  use crate::network::transport::TransportType;
2025-11-10T00:08:56.5791416Z  use anyhow::Result;
2025-11-10T00:08:56.5791628Z +use bllvm_protocol::bip157::NODE_COMPACT_FILTERS;
2025-11-10T00:08:56.5791896Z  use bllvm_protocol::{Block, BlockHeader, Hash, Transaction};
2025-11-10T00:08:56.5792058Z  use serde::{Deserialize, Serialize};
2025-11-10T00:08:56.5792173Z  
2025-11-10T00:08:56.5792660Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol.rs:145:
2025-11-10T00:08:56.5792857Z      pub fn supports_utxo_commitments(&self) -> bool {
2025-11-10T00:08:56.5793046Z          (self.services & NODE_UTXO_COMMITMENTS) != 0
2025-11-10T00:08:56.5793158Z      }
2025-11-10T00:08:56.5793269Z -    
2025-11-10T00:08:56.5793376Z +
2025-11-10T00:08:56.5793557Z      /// Check if peer supports ban list sharing
2025-11-10T00:08:56.5793765Z      pub fn supports_ban_list_sharing(&self) -> bool {
2025-11-10T00:08:56.5793946Z          (self.services & NODE_BAN_LIST_SHARING) != 0
2025-11-10T00:08:56.5794622Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol.rs:152:
2025-11-10T00:08:56.5794739Z      }
2025-11-10T00:08:56.5794842Z -    
2025-11-10T00:08:56.5794950Z +
2025-11-10T00:08:56.5795180Z      /// Check if peer supports BIP157 compact block filters
2025-11-10T00:08:56.5797104Z      pub fn supports_compact_filters(&self) -> bool {
2025-11-10T00:08:56.5797317Z          use bllvm_protocol::bip157::NODE_COMPACT_FILTERS;
2025-11-10T00:08:56.5797799Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol.rs:157:
2025-11-10T00:08:56.5797978Z          (self.services & NODE_COMPACT_FILTERS) != 0
2025-11-10T00:08:56.5798082Z      }
2025-11-10T00:08:56.5798184Z -    
2025-11-10T00:08:56.5798292Z +
2025-11-10T00:08:56.5798483Z      /// Check if peer supports package relay (BIP331)
2025-11-10T00:08:56.5798676Z      pub fn supports_package_relay(&self) -> bool {
2025-11-10T00:08:56.5798852Z          (self.services & NODE_PACKAGE_RELAY) != 0
2025-11-10T00:08:56.5799324Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol.rs:163:
2025-11-10T00:08:56.5799428Z      }
2025-11-10T00:08:56.5799525Z -    
2025-11-10T00:08:56.5799629Z +
2025-11-10T00:08:56.5799766Z      /// Check if peer supports FIBRE
2025-11-10T00:08:56.5799912Z      pub fn supports_fibre(&self) -> bool {
2025-11-10T00:08:56.5800059Z          (self.services & NODE_FIBRE) != 0
2025-11-10T00:08:56.5800493Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol.rs:168:
2025-11-10T00:08:56.5800591Z      }
2025-11-10T00:08:56.5800697Z -    
2025-11-10T00:08:56.5800792Z +
2025-11-10T00:08:56.5800920Z      #[cfg(feature = "dandelion")]
2025-11-10T00:08:56.5801061Z      /// Check if peer supports Dandelion
2025-11-10T00:08:56.5801230Z      pub fn supports_dandelion(&self) -> bool {
2025-11-10T00:08:56.5801732Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol_extensions.rs:7:
2025-11-10T00:08:56.5802150Z  //! - FilteredBlock: Response with filtered transactions
2025-11-10T00:08:56.5802254Z  
2025-11-10T00:08:56.5802399Z  use crate::network::protocol::*;
2025-11-10T00:08:56.5802531Z -use crate::storage::Storage;
2025-11-10T00:08:56.5802685Z  use crate::network::txhash::calculate_txid;
2025-11-10T00:08:56.5802812Z +use crate::storage::Storage;
2025-11-10T00:08:56.5802926Z  use anyhow::Result;
2025-11-10T00:08:56.5803064Z  #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.5803344Z  use bllvm_protocol::utxo_commitments::merkle_tree::UtxoMerkleTree;
2025-11-10T00:08:56.5805865Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol_extensions.rs:41:
2025-11-10T00:08:56.5805995Z      // Get UTXO set from storage
2025-11-10T00:08:56.5806182Z      let utxo_set = storage.utxos().get_all_utxos()?;
2025-11-10T00:08:56.5806544Z      let utxo_count = utxo_set.len() as u64;
2025-11-10T00:08:56.5806649Z -    
2025-11-10T00:08:56.5806752Z +
2025-11-10T00:08:56.5806888Z      // Calculate total supply
2025-11-10T00:08:56.5807191Z      let total_supply: u64 = utxo_set.values().map(|utxo| utxo.value as u64).sum();
2025-11-10T00:08:56.5807287Z  
2025-11-10T00:08:56.5807805Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol_extensions.rs:49:
2025-11-10T00:08:56.5807947Z      #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.5808111Z      let mut utxo_tree = UtxoMerkleTree::new()
2025-11-10T00:08:56.5808412Z          .map_err(|e| anyhow::anyhow!("Failed to create UTXO Merkle tree: {:?}", e))?;
2025-11-10T00:08:56.5808509Z -    
2025-11-10T00:08:56.5808602Z +
2025-11-10T00:08:56.5808736Z      #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.5808877Z      for (outpoint, utxo) in &utxo_set {
2025-11-10T00:08:56.5809036Z -        utxo_tree.insert(*outpoint, utxo.clone())
2025-11-10T00:08:56.5809143Z +        utxo_tree
2025-11-10T00:08:56.5809318Z +            .insert(*outpoint, utxo.clone())
2025-11-10T00:08:56.5809639Z              .map_err(|e| anyhow::anyhow!("Failed to insert UTXO into tree: {:?}", e))?;
2025-11-10T00:08:56.5809744Z      }
2025-11-10T00:08:56.5809844Z  
2025-11-10T00:08:56.5810374Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol_extensions.rs:68:
2025-11-10T00:08:56.5810500Z      // Generate commitment
2025-11-10T00:08:56.5810644Z      #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.5810964Z      let commitment = utxo_tree.generate_commitment(block_hash, block_height);
2025-11-10T00:08:56.5811067Z -    
2025-11-10T00:08:56.5811166Z +
2025-11-10T00:08:56.5811324Z      #[cfg(not(feature = "utxo-commitments"))]
2025-11-10T00:08:56.5811581Z      let commitment = crate::network::protocol::UTXOCommitment {
2025-11-10T00:08:56.5811705Z          merkle_root: [0; 32],
2025-11-10T00:08:56.5812239Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol_extensions.rs:161:
2025-11-10T00:08:56.5812397Z      #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.5812809Z      let (filtered_txs, spam_summary_from_filter) = spam_filter.filter_block(&block.transactions);
2025-11-10T00:08:56.5812965Z      #[cfg(not(feature = "utxo-commitments"))]
2025-11-10T00:08:56.5815968Z -    let (filtered_txs, spam_summary_from_filter): (Vec<bllvm_protocol::Transaction>, crate::network::protocol::SpamSummary) = (block.transactions.clone(), crate::network::protocol::SpamSummary {
2025-11-10T00:08:56.5816104Z -        filtered_count: 0,
2025-11-10T00:08:56.5816228Z -        filtered_size: 0,
2025-11-10T00:08:56.5816458Z -        by_type: crate::network::protocol::SpamBreakdown {
2025-11-10T00:08:56.5816585Z -            ordinals: 0,
2025-11-10T00:08:56.5816714Z -            inscriptions: 0,
2025-11-10T00:08:56.5816823Z -            dust: 0,
2025-11-10T00:08:56.5816940Z -            brc20: 0,
2025-11-10T00:08:56.5817134Z +    let (filtered_txs, spam_summary_from_filter): (
2025-11-10T00:08:56.5817292Z +        Vec<bllvm_protocol::Transaction>,
2025-11-10T00:08:56.5817730Z +        crate::network::protocol::SpamSummary,
2025-11-10T00:08:56.5817837Z +    ) = (
2025-11-10T00:08:56.5817983Z +        block.transactions.clone(),
2025-11-10T00:08:56.5818149Z +        crate::network::protocol::SpamSummary {
2025-11-10T00:08:56.5818285Z +            filtered_count: 0,
2025-11-10T00:08:56.5818408Z +            filtered_size: 0,
2025-11-10T00:08:56.5818616Z +            by_type: crate::network::protocol::SpamBreakdown {
2025-11-10T00:08:56.5818744Z +                ordinals: 0,
2025-11-10T00:08:56.5818872Z +                inscriptions: 0,
2025-11-10T00:08:56.5818983Z +                dust: 0,
2025-11-10T00:08:56.5819096Z +                brc20: 0,
2025-11-10T00:08:56.5819205Z +            },
2025-11-10T00:08:56.5819307Z          },
2025-11-10T00:08:56.5819409Z -    });
2025-11-10T00:08:56.5819517Z -    
2025-11-10T00:08:56.5819619Z +    );
2025-11-10T00:08:56.5819947Z +
2025-11-10T00:08:56.5820125Z      // Convert spam summary to protocol types
2025-11-10T00:08:56.5820289Z      let spam_summary = SpamSummary {
2025-11-10T00:08:56.5820536Z          filtered_count: spam_summary_from_filter.filtered_count,
2025-11-10T00:08:56.5821120Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol_extensions.rs:186:
2025-11-10T00:08:56.5821237Z  
2025-11-10T00:08:56.5823258Z      // Generate transaction indices (positions of filtered transactions in original block)
2025-11-10T00:08:56.5823437Z      let mut transaction_indices = Vec::new();
2025-11-10T00:08:56.5823767Z -    let filtered_txids: std::collections::HashSet<_> = filtered_txs.iter()
2025-11-10T00:08:56.5823918Z -        .map(|tx| calculate_txid(tx))
2025-11-10T00:08:56.5824040Z -        .collect();
2025-11-10T00:08:56.5824250Z +    let filtered_txids: std::collections::HashSet<_> =
2025-11-10T00:08:56.5824696Z +        filtered_txs.iter().map(|tx| calculate_txid(tx)).collect();
2025-11-10T00:08:56.5824989Z      for (original_idx, tx) in block.transactions.iter().enumerate() {
2025-11-10T00:08:56.5825144Z          let txid = calculate_txid(tx);
2025-11-10T00:08:56.5825317Z          if filtered_txids.contains(&txid) {
2025-11-10T00:08:56.5825853Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol_extensions.rs:200:
2025-11-10T00:08:56.5826008Z      #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.5826189Z      let mut utxo_tree = UtxoMerkleTree::new()
2025-11-10T00:08:56.5826493Z          .map_err(|e| anyhow::anyhow!("Failed to create UTXO Merkle tree: {:?}", e))?;
2025-11-10T00:08:56.5826596Z -    
2025-11-10T00:08:56.5826703Z +
2025-11-10T00:08:56.5826867Z      #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.5827037Z      // Add outputs from filtered transactions
2025-11-10T00:08:56.5827180Z      for tx in &filtered_txs {
2025-11-10T00:08:56.5827769Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol_extensions.rs:227:
2025-11-10T00:08:56.5827945Z      // Generate commitment for filtered block
2025-11-10T00:08:56.5828112Z      #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.5828504Z      let commitment = utxo_tree.generate_commitment(message.block_hash, block_height);
2025-11-10T00:08:56.5828616Z -    
2025-11-10T00:08:56.5828724Z +
2025-11-10T00:08:56.5828895Z      #[cfg(not(feature = "utxo-commitments"))]
2025-11-10T00:08:56.5829180Z      let commitment = crate::network::protocol::UTXOCommitment {
2025-11-10T00:08:56.5829321Z          merkle_root: [0; 32],
2025-11-10T00:08:56.5829875Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/stratum_v2/pool.rs:191:
2025-11-10T00:08:56.5829993Z  
2025-11-10T00:08:56.5830128Z          // Store template
2025-11-10T00:08:56.5830306Z          self.current_template = Some(template);
2025-11-10T00:08:56.5830414Z -        
2025-11-10T00:08:56.5830532Z +
2025-11-10T00:08:56.5830663Z          (job_id, messages)
2025-11-10T00:08:56.5830780Z      }
2025-11-10T00:08:56.5830895Z  
2025-11-10T00:08:56.5831697Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/stratum_v2/pool.rs:463:
2025-11-10T00:08:56.5831947Z          if let Some(coinbase) = template.transactions.first() {
2025-11-10T00:08:56.5832116Z              // Serialize coinbase transaction
2025-11-10T00:08:56.5832388Z              let coinbase_bytes = self.serialize_transaction(coinbase);
2025-11-10T00:08:56.5832501Z -            
2025-11-10T00:08:56.5832613Z +
2025-11-10T00:08:56.5834838Z              // Extract merkle path from coinbase (index 0) to root
2025-11-10T00:08:56.5835100Z              let merkle_path = self.extract_merkle_path(template, 0);
2025-11-10T00:08:56.5835224Z -            
2025-11-10T00:08:56.5835329Z +
2025-11-10T00:08:56.5835676Z              // For Stratum V2, coinbase prefix is the full coinbase (miners can modify it)
2025-11-10T00:08:56.5835894Z              // Coinbase suffix is empty (not used in Stratum V2)
2025-11-10T00:08:56.5836778Z              (coinbase_bytes, vec![], merkle_path)
2025-11-10T00:08:56.5837747Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/stratum_v2/pool.rs:477:
2025-11-10T00:08:56.5837859Z  
2025-11-10T00:08:56.5838156Z      /// Extract merkle path from a specific transaction index to root
2025-11-10T00:08:56.5838504Z      fn extract_merkle_path(&self, block: &Block, tx_index: usize) -> Vec<Hash> {
2025-11-10T00:08:56.5838706Z -        use bllvm_protocol::mempool::calculate_tx_id;
2025-11-10T00:08:56.5838888Z          use crate::storage::hashing::double_sha256;
2025-11-10T00:08:56.5839071Z +        use bllvm_protocol::mempool::calculate_tx_id;
2025-11-10T00:08:56.5839186Z  
2025-11-10T00:08:56.5839531Z          if block.transactions.is_empty() || tx_index >= block.transactions.len() {
2025-11-10T00:08:56.5839660Z              return vec![];
2025-11-10T00:08:56.5840192Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/stratum_v2/pool.rs:485:
2025-11-10T00:08:56.5840302Z          }
2025-11-10T00:08:56.5840414Z  
2025-11-10T00:08:56.5840566Z          // Calculate all transaction hashes
2025-11-10T00:08:56.5840809Z -        let mut tx_hashes: Vec<Hash> = block.transactions.iter()
2025-11-10T00:08:56.5840971Z +        let mut tx_hashes: Vec<Hash> = block
2025-11-10T00:08:56.5841101Z +            .transactions
2025-11-10T00:08:56.5841219Z +            .iter()
2025-11-10T00:08:56.5841372Z              .map(|tx| calculate_tx_id(tx))
2025-11-10T00:08:56.5841502Z              .collect();
2025-11-10T00:08:56.5841606Z  
2025-11-10T00:08:56.5842139Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/stratum_v2/pool.rs:528:
2025-11-10T00:08:56.5842333Z                      combined.extend_from_slice(&chunk[0]);
2025-11-10T00:08:56.5842518Z                      let parent_hash = double_sha256(&combined);
2025-11-10T00:08:56.5842681Z                      next_level.push(parent_hash);
2025-11-10T00:08:56.5842806Z -                    
2025-11-10T00:08:56.5842922Z +
2025-11-10T00:08:56.5843224Z                      // If current_index is the last (odd) transaction, no sibling to add
2025-11-10T00:08:56.5843382Z                      let pair_start = pair_idx * 2;
2025-11-10T00:08:56.5843545Z                      if current_index == pair_start {
2025-11-10T00:08:56.5844090Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/stratum_v2/server.rs:214:
2025-11-10T00:08:56.5844476Z          // Get block template from MiningCoordinator
2025-11-10T00:08:56.5844625Z          let template = {
2025-11-10T00:08:56.5844885Z              let mut coordinator = self.mining_coordinator.write().await;
2025-11-10T00:08:56.5845082Z -            coordinator.generate_block_template().await
2025-11-10T00:08:56.5847707Z -                .map_err(|e| StratumV2Error::MiningJob(format!("Failed to generate block template: {}", e)))?
2025-11-10T00:08:56.5848002Z +            coordinator.generate_block_template().await.map_err(|e| {
2025-11-10T00:08:56.5848379Z +                StratumV2Error::MiningJob(format!("Failed to generate block template: {}", e))
2025-11-10T00:08:56.5848739Z +            })?
2025-11-10T00:08:56.5848849Z          };
2025-11-10T00:08:56.5848947Z  
2025-11-10T00:08:56.5849375Z -        debug!("Generated new block template with {} transactions", template.transactions.len());
2025-11-10T00:08:56.5849499Z +        debug!(
2025-11-10T00:08:56.5849727Z +            "Generated new block template with {} transactions",
2025-11-10T00:08:56.5849895Z +            template.transactions.len()
2025-11-10T00:08:56.5850008Z +        );
2025-11-10T00:08:56.5850119Z  
2025-11-10T00:08:56.5850338Z          // Set template in pool and get distribution messages
2025-11-10T00:08:56.5850477Z          let (job_id, messages) = {
2025-11-10T00:08:56.5851026Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/stratum_v2/server.rs:273:
2025-11-10T00:08:56.5851513Z          if let Some(ref mut conn) = *conn {
2025-11-10T00:08:56.5851908Z              // Use channel-specific sending - transports that support channels (QUIC/Iroh)
2025-11-10T00:08:56.5852340Z              // will route to the appropriate channel stream, others will use default send()
2025-11-10T00:08:56.5852625Z -            conn.send_on_channel(channel_id, &encoded).await.map_err(|e| {
2025-11-10T00:08:56.5852972Z -                StratumV2Error::Network(format!("Failed to send job message: {}", e))
2025-11-10T00:08:56.5853085Z -            })?;
2025-11-10T00:08:56.5853282Z +            conn.send_on_channel(channel_id, &encoded)
2025-11-10T00:08:56.5853402Z +                .await
2025-11-10T00:08:56.5853528Z +                .map_err(|e| {
2025-11-10T00:08:56.5853870Z +                    StratumV2Error::Network(format!("Failed to send job message: {}", e))
2025-11-10T00:08:56.5853985Z +                })?;
2025-11-10T00:08:56.5854100Z          } else {
2025-11-10T00:08:56.5856243Z              return Err(StratumV2Error::Connection(anyhow::anyhow!(
2025-11-10T00:08:56.5856416Z                  "Connection not available"
2025-11-10T00:08:56.5857504Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:101:
2025-11-10T00:08:56.5857625Z                  {
2025-11-10T00:08:56.5857844Z                      use crate::network::transport::TransportAddr;
2025-11-10T00:08:56.5857976Z                      use hex;
2025-11-10T00:08:56.5858086Z -                    
2025-11-10T00:08:56.5858194Z +
2025-11-10T00:08:56.5858461Z                      let node_id_hex = peer_id.strip_prefix("iroh:").ok_or_else(|| {
2025-11-10T00:08:56.5858941Z                          bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-10T00:08:56.5859159Z                              format!("Invalid Iroh peer_id format: {}", peer_id)
2025-11-10T00:08:56.5859744Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:108:
2025-11-10T00:08:56.5859875Z                          )
2025-11-10T00:08:56.5859989Z                      })?;
2025-11-10T00:08:56.5860100Z -                    
2025-11-10T00:08:56.5860207Z +
2025-11-10T00:08:56.5860482Z                      let node_id_bytes = hex::decode(node_id_hex).map_err(|e| {
2025-11-10T00:08:56.5860927Z                          bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-10T00:08:56.5861118Z                              format!("Invalid Iroh node ID hex: {}", e)
2025-11-10T00:08:56.5861673Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:114:
2025-11-10T00:08:56.5861783Z                          )
2025-11-10T00:08:56.5861899Z                      })?;
2025-11-10T00:08:56.5862016Z -                    
2025-11-10T00:08:56.5862124Z +
2025-11-10T00:08:56.5862372Z                      // Validate node ID length (Iroh uses 32-byte public keys)
2025-11-10T00:08:56.5862547Z                      if node_id_bytes.len() != 32 {
2025-11-10T00:08:56.5863081Z                          return Err(bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-10T00:08:56.5863925Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:120:
2025-11-10T00:08:56.5864474Z                              format!("Invalid Iroh node ID length: expected 32 bytes, got {}", node_id_bytes.len())
2025-11-10T00:08:56.5864603Z                          ));
2025-11-10T00:08:56.5864719Z                      }
2025-11-10T00:08:56.5864829Z -                    
2025-11-10T00:08:56.5864943Z +
2025-11-10T00:08:56.5865257Z                      // Create placeholder SocketAddr for Iroh (same approach as mod.rs)
2025-11-10T00:08:56.5865495Z                      // Use first 4 bytes of key for IP, last 2 bytes for port
2025-11-10T00:08:56.5866071Z -                    let ip_bytes = [node_id_bytes[0], node_id_bytes[1], node_id_bytes[2], node_id_bytes[3]];
2025-11-10T00:08:56.5866221Z +                    let ip_bytes = [
2025-11-10T00:08:56.5866370Z +                        node_id_bytes[0],
2025-11-10T00:08:56.5866512Z +                        node_id_bytes[1],
2025-11-10T00:08:56.5866655Z +                        node_id_bytes[2],
2025-11-10T00:08:56.5866796Z +                        node_id_bytes[3],
2025-11-10T00:08:56.5866908Z +                    ];
2025-11-10T00:08:56.5867214Z                      let port = u16::from_be_bytes([node_id_bytes[30], node_id_bytes[31]]);
2025-11-10T00:08:56.5867538Z                      let placeholder_addr = std::net::SocketAddr::from((ip_bytes, port));
2025-11-10T00:08:56.5867652Z -                    
2025-11-10T00:08:56.5867766Z +
2025-11-10T00:08:56.5868022Z                      let transport_addr = TransportAddr::Iroh(node_id_bytes);
2025-11-10T00:08:56.5868228Z                      Some((placeholder_addr, Some(transport_addr)))
2025-11-10T00:08:56.5868349Z                  }
2025-11-10T00:08:56.5868935Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:148:
2025-11-10T00:08:56.5869061Z                      ));
2025-11-10T00:08:56.5869172Z                  }
2025-11-10T00:08:56.5869292Z              };
2025-11-10T00:08:56.5869403Z -            
2025-11-10T00:08:56.5869509Z +
2025-11-10T00:08:56.5869693Z              // Store TransportAddr mapping if Iroh
2025-11-10T00:08:56.5869902Z              if let Some(transport_addr) = transport_addr_opt {
2025-11-10T00:08:56.5870095Z                  let network = network_manager.read().await;
2025-11-10T00:08:56.5870665Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:155:
2025-11-10T00:08:56.5870927Z                  // Store mapping from placeholder SocketAddr to TransportAddr
2025-11-10T00:08:56.5871313Z -                network.socket_to_transport.lock().unwrap().insert(peer_addr, transport_addr);
2025-11-10T00:08:56.5871445Z +                network
2025-11-10T00:08:56.5871594Z +                    .socket_to_transport
2025-11-10T00:08:56.5871716Z +                    .lock()
2025-11-10T00:08:56.5871830Z +                    .unwrap()
2025-11-10T00:08:56.5871999Z +                    .insert(peer_addr, transport_addr);
2025-11-10T00:08:56.5872119Z                  drop(network);
2025-11-10T00:08:56.5872220Z              }
2025-11-10T00:08:56.5872319Z  
2025-11-10T00:08:56.5873154Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:160:
2025-11-10T00:08:56.5873432Z              // Check if peer supports UTXO commitments before sending request
2025-11-10T00:08:56.5873615Z              let network = network_manager.read().await;
2025-11-10T00:08:56.5873732Z -            
2025-11-10T00:08:56.5873834Z +
2025-11-10T00:08:56.5873998Z              // Get peer version to check capabilities
2025-11-10T00:08:56.5874163Z              let peer_supports_utxo_commitments = {
2025-11-10T00:08:56.5874550Z                  let peer_states = network.peer_states.lock().unwrap();
2025-11-10T00:08:56.5875397Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:178:
2025-11-10T00:08:56.5875523Z                      false
2025-11-10T00:08:56.5875642Z                  }
2025-11-10T00:08:56.5875752Z              };
2025-11-10T00:08:56.5875863Z -            
2025-11-10T00:08:56.5875971Z +
2025-11-10T00:08:56.5876304Z              // If we know the peer doesn't support UTXO commitments, return error early
2025-11-10T00:08:56.5876478Z              if !peer_supports_utxo_commitments {
2025-11-10T00:08:56.5876607Z                  drop(network);
2025-11-10T00:08:56.5877214Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:186:
2025-11-10T00:08:56.5877723Z                      format!("Peer {} does not support UTXO commitments (missing NODE_UTXO_COMMITMENTS service flag)", peer_id)
2025-11-10T00:08:56.5878051Z                  ));
2025-11-10T00:08:56.5878180Z              }
2025-11-10T00:08:56.5878296Z -            
2025-11-10T00:08:56.5878402Z +
2025-11-10T00:08:56.5878586Z              // Register pending request before sending
2025-11-10T00:08:56.5878903Z              let (request_id, response_rx) = network.register_request(peer_addr);
2025-11-10T00:08:56.5879131Z              drop(network); // Release read lock before async wait
2025-11-10T00:08:56.5879734Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:193:
2025-11-10T00:08:56.5879853Z -            
2025-11-10T00:08:56.5879959Z +
2025-11-10T00:08:56.5880150Z              // Create GetUTXOSet message with request_id
2025-11-10T00:08:56.5880348Z -            let get_utxo_set_msg = GetUTXOSetMessage { 
2025-11-10T00:08:56.5880536Z +            let get_utxo_set_msg = GetUTXOSetMessage {
2025-11-10T00:08:56.5880664Z                  request_id,
2025-11-10T00:08:56.5880787Z -                height, 
2025-11-10T00:08:56.5880926Z -                block_hash 
2025-11-10T00:08:56.5881047Z +                height,
2025-11-10T00:08:56.5881166Z +                block_hash,
2025-11-10T00:08:56.5881286Z              };
2025-11-10T00:08:56.5881392Z  
2025-11-10T00:08:56.5881729Z              // Serialize message using protocol adapter (handles TCP vs Iroh format)
2025-11-10T00:08:56.5882321Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:203:
2025-11-10T00:08:56.5882931Z                  .map_err(|e| bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-10T00:08:56.5883134Z                      format!("Failed to serialize GetUTXOSet: {}", e)
2025-11-10T00:08:56.5883239Z                  ))?;
2025-11-10T00:08:56.5883344Z -            
2025-11-10T00:08:56.5883446Z +
2025-11-10T00:08:56.5883627Z              // Send message to peer via NetworkManager
2025-11-10T00:08:56.5883747Z              {
2025-11-10T00:08:56.5883943Z                  let network = network_manager.read().await;
2025-11-10T00:08:56.5884772Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:212:
2025-11-10T00:08:56.5885067Z                          format!("Failed to send GetUTXOSet to peer {}: {}", peer_addr, e)
2025-11-10T00:08:56.5885201Z                      ))?;
2025-11-10T00:08:56.5885313Z              }
2025-11-10T00:08:56.5885423Z -            
2025-11-10T00:08:56.5885539Z +
2025-11-10T00:08:56.5885718Z              // Await response with timeout (30 seconds)
2025-11-10T00:08:56.5885858Z              tokio::select! {
2025-11-10T00:08:56.5886011Z                  result = response_rx => {
2025-11-10T00:08:56.5886602Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:224:
2025-11-10T00:08:56.5887149Z                                  .map_err(|e| bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-10T00:08:56.5887384Z                                      format!("Failed to parse UTXOSet response: {}", e)
2025-11-10T00:08:56.5887927Z                                  ))?;
2025-11-10T00:08:56.5888051Z -                            
2025-11-10T00:08:56.5888154Z +
2025-11-10T00:08:56.5888295Z                              match parsed {
2025-11-10T00:08:56.5888506Z                                  ProtocolMessage::UTXOSet(utxo_set_msg) => {
2025-11-10T00:08:56.5888679Z                                      // Convert to UtxoCommitment
2025-11-10T00:08:56.5889283Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:291:
2025-11-10T00:08:56.5889400Z                  {
2025-11-10T00:08:56.5889614Z                      use crate::network::transport::TransportAddr;
2025-11-10T00:08:56.5889738Z                      use hex;
2025-11-10T00:08:56.5889859Z -                    
2025-11-10T00:08:56.5889964Z +
2025-11-10T00:08:56.5890446Z                      let node_id_hex = peer_id.strip_prefix("iroh:").ok_or_else(|| {
2025-11-10T00:08:56.5890949Z                          bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-10T00:08:56.5891173Z                              format!("Invalid Iroh peer_id format: {}", peer_id)
2025-11-10T00:08:56.5891762Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:298:
2025-11-10T00:08:56.5891889Z                          )
2025-11-10T00:08:56.5892005Z                      })?;
2025-11-10T00:08:56.5892117Z -                    
2025-11-10T00:08:56.5892223Z +
2025-11-10T00:08:56.5892489Z                      let node_id_bytes = hex::decode(node_id_hex).map_err(|e| {
2025-11-10T00:08:56.5892957Z                          bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-10T00:08:56.5893135Z                              format!("Invalid Iroh node ID hex: {}", e)
2025-11-10T00:08:56.5893713Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:304:
2025-11-10T00:08:56.5893829Z                          )
2025-11-10T00:08:56.5893935Z                      })?;
2025-11-10T00:08:56.5894048Z -                    
2025-11-10T00:08:56.5894148Z +
2025-11-10T00:08:56.5894607Z                      // Validate node ID length (Iroh uses 32-byte public keys)
2025-11-10T00:08:56.5894763Z                      if node_id_bytes.len() != 32 {
2025-11-10T00:08:56.5895287Z                          return Err(bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-10T00:08:56.5895851Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:310:
2025-11-10T00:08:56.5896226Z                              format!("Invalid Iroh node ID length: expected 32 bytes, got {}", node_id_bytes.len())
2025-11-10T00:08:56.5896363Z                          ));
2025-11-10T00:08:56.5896469Z                      }
2025-11-10T00:08:56.5896579Z -                    
2025-11-10T00:08:56.5896684Z +
2025-11-10T00:08:56.5896982Z                      // Create placeholder SocketAddr for Iroh (same approach as mod.rs)
2025-11-10T00:08:56.5897198Z                      // Use first 4 bytes of key for IP, last 2 bytes for port
2025-11-10T00:08:56.5897546Z -                    let ip_bytes = [node_id_bytes[0], node_id_bytes[1], node_id_bytes[2], node_id_bytes[3]];
2025-11-10T00:08:56.5897675Z +                    let ip_bytes = [
2025-11-10T00:08:56.5897807Z +                        node_id_bytes[0],
2025-11-10T00:08:56.5897934Z +                        node_id_bytes[1],
2025-11-10T00:08:56.5898068Z +                        node_id_bytes[2],
2025-11-10T00:08:56.5898201Z +                        node_id_bytes[3],
2025-11-10T00:08:56.5898315Z +                    ];
2025-11-10T00:08:56.5898616Z                      let port = u16::from_be_bytes([node_id_bytes[30], node_id_bytes[31]]);
2025-11-10T00:08:56.5898917Z                      let placeholder_addr = std::net::SocketAddr::from((ip_bytes, port));
2025-11-10T00:08:56.5899246Z -                    
2025-11-10T00:08:56.5899353Z +
2025-11-10T00:08:56.5899592Z                      let transport_addr = TransportAddr::Iroh(node_id_bytes);
2025-11-10T00:08:56.5899782Z                      Some((placeholder_addr, Some(transport_addr)))
2025-11-10T00:08:56.5899887Z                  }
2025-11-10T00:08:56.5900454Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:338:
2025-11-10T00:08:56.5900566Z                      ));
2025-11-10T00:08:56.5900671Z                  }
2025-11-10T00:08:56.5900791Z              };
2025-11-10T00:08:56.5900900Z -            
2025-11-10T00:08:56.5901001Z +
2025-11-10T00:08:56.5901172Z              // Store TransportAddr mapping if Iroh
2025-11-10T00:08:56.5901390Z              if let Some(transport_addr) = transport_addr_opt {
2025-11-10T00:08:56.5901747Z                  let network = network_manager.read().await;
2025-11-10T00:08:56.5902331Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:345:
2025-11-10T00:08:56.5902607Z                  // Store mapping from placeholder SocketAddr to TransportAddr
2025-11-10T00:08:56.5902989Z -                network.socket_to_transport.lock().unwrap().insert(peer_addr, transport_addr);
2025-11-10T00:08:56.5903108Z +                network
2025-11-10T00:08:56.5903256Z +                    .socket_to_transport
2025-11-10T00:08:56.5903377Z +                    .lock()
2025-11-10T00:08:56.5903500Z +                    .unwrap()
2025-11-10T00:08:56.5903677Z +                    .insert(peer_addr, transport_addr);
2025-11-10T00:08:56.5903806Z                  drop(network);
2025-11-10T00:08:56.5903916Z              }
2025-11-10T00:08:56.5904022Z  
2025-11-10T00:08:56.5904781Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:351:
2025-11-10T00:08:56.5904962Z              let network = network_manager.read().await;
2025-11-10T00:08:56.5905265Z              let (request_id, response_rx) = network.register_request(peer_addr);
2025-11-10T00:08:56.5905494Z              drop(network); // Release read lock before async wait
2025-11-10T00:08:56.5905603Z -            
2025-11-10T00:08:56.5905707Z +
2025-11-10T00:08:56.5905912Z              // Create GetFilteredBlock message with request_id
2025-11-10T00:08:56.5906137Z              use crate::network::protocol::FilterPreferences;
2025-11-10T00:08:56.5906371Z              let get_filtered_block_msg = GetFilteredBlockMessage {
2025-11-10T00:08:56.5906924Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:371:
2025-11-10T00:08:56.5907421Z                  .map_err(|e| bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-10T00:08:56.5907670Z                      format!("Failed to serialize GetFilteredBlock: {}", e)
2025-11-10T00:08:56.5907787Z                  ))?;
2025-11-10T00:08:56.5907915Z -            
2025-11-10T00:08:56.5908025Z +
2025-11-10T00:08:56.5908206Z              // Send message to peer via NetworkManager
2025-11-10T00:08:56.5908316Z              {
2025-11-10T00:08:56.5908517Z                  let network = network_manager.read().await;
2025-11-10T00:08:56.5909106Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:380:
2025-11-10T00:08:56.5909430Z                          format!("Failed to send GetFilteredBlock to peer {}: {}", peer_addr, e)
2025-11-10T00:08:56.5909559Z                      ))?;
2025-11-10T00:08:56.5909669Z              }
2025-11-10T00:08:56.5909777Z -            
2025-11-10T00:08:56.5909898Z +
2025-11-10T00:08:56.5910073Z              // Await response with timeout (30 seconds)
2025-11-10T00:08:56.5910208Z              tokio::select! {
2025-11-10T00:08:56.5910362Z                  result = response_rx => {
2025-11-10T00:08:56.5910943Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:392:
2025-11-10T00:08:56.5911716Z                                  .map_err(|e| bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-10T00:08:56.5911987Z                                      format!("Failed to parse FilteredBlock response: {}", e)
2025-11-10T00:08:56.5912118Z                                  ))?;
2025-11-10T00:08:56.5912235Z -                            
2025-11-10T00:08:56.5912339Z +
2025-11-10T00:08:56.5912496Z                              match parsed {
2025-11-10T00:08:56.5912778Z                                  ProtocolMessage::FilteredBlock(filtered_block_msg) => {
2025-11-10T00:08:56.5912942Z                                      // Convert to FilteredBlock
2025-11-10T00:08:56.5913501Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/health.rs:144:
2025-11-10T00:08:56.5913850Z          // Determine overall status
2025-11-10T00:08:56.5914255Z          let overall_status = if components.iter().any(|c| c.status == HealthStatus::Down) {
2025-11-10T00:08:56.5914669Z              HealthStatus::Down
2025-11-10T00:08:56.5915011Z -        } else if components.iter().any(|c| c.status == HealthStatus::Unhealthy) {
2025-11-10T00:08:56.5915147Z +        } else if components
2025-11-10T00:08:56.5915263Z +            .iter()
2025-11-10T00:08:56.5915466Z +            .any(|c| c.status == HealthStatus::Unhealthy)
2025-11-10T00:08:56.5915578Z +        {
2025-11-10T00:08:56.5915724Z              HealthStatus::Unhealthy
2025-11-10T00:08:56.5916053Z -        } else if components.iter().any(|c| c.status == HealthStatus::Degraded) {
2025-11-10T00:08:56.5916186Z +        } else if components
2025-11-10T00:08:56.5916303Z +            .iter()
2025-11-10T00:08:56.5916491Z +            .any(|c| c.status == HealthStatus::Degraded)
2025-11-10T00:08:56.5916608Z +        {
2025-11-10T00:08:56.5916763Z              HealthStatus::Degraded
2025-11-10T00:08:56.5916877Z          } else {
2025-11-10T00:08:56.5917025Z              HealthStatus::Healthy
2025-11-10T00:08:56.5917456Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/health.rs:180:
2025-11-10T00:08:56.5917571Z          Self::new()
2025-11-10T00:08:56.5917671Z      }
2025-11-10T00:08:56.5917781Z  }
2025-11-10T00:08:56.5917880Z -
2025-11-10T00:08:56.5917978Z  
2025-11-10T00:08:56.5918414Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:1:
2025-11-10T00:08:56.5918533Z  //! Mempool manager
2025-11-10T00:08:56.5918636Z -//! 
2025-11-10T00:08:56.5918737Z +//!
2025-11-10T00:08:56.5919029Z  //! Handles transaction mempool management, validation, and relay.
2025-11-10T00:08:56.5919129Z  
2025-11-10T00:08:56.5919249Z  use anyhow::Result;
2025-11-10T00:08:56.5919668Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:6:
2025-11-10T00:08:56.5919917Z -use bllvm_protocol::{Transaction, UtxoSet, Hash, OutPoint};
2025-11-10T00:08:56.5920076Z  use bllvm_protocol::mempool::Mempool;
2025-11-10T00:08:56.5920320Z +use bllvm_protocol::{Hash, OutPoint, Transaction, UtxoSet};
2025-11-10T00:08:56.5920478Z  use std::collections::{HashMap, HashSet};
2025-11-10T00:08:56.5920610Z  use tracing::{debug, info};
2025-11-10T00:08:56.5920709Z  
2025-11-10T00:08:56.5921144Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:31:
2025-11-10T00:08:56.5921308Z              spent_outputs: HashSet::new(),
2025-11-10T00:08:56.5921418Z          }
2025-11-10T00:08:56.5921531Z      }
2025-11-10T00:08:56.5921631Z -    
2025-11-10T00:08:56.5921729Z +
2025-11-10T00:08:56.5921863Z      /// Start the mempool manager
2025-11-10T00:08:56.5922510Z      pub async fn start(&mut self) -> Result<()> {
2025-11-10T00:08:56.5922678Z          info!("Starting mempool manager");
2025-11-10T00:08:56.5923136Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:38:
2025-11-10T00:08:56.5923260Z -        
2025-11-10T00:08:56.5923625Z +
2025-11-10T00:08:56.5923767Z          // Initialize mempool
2025-11-10T00:08:56.5923921Z          self.initialize_mempool().await?;
2025-11-10T00:08:56.5924037Z -        
2025-11-10T00:08:56.5924145Z +
2025-11-10T00:08:56.5924485Z          // Start mempool processing loop
2025-11-10T00:08:56.5924650Z          self.process_loop().await?;
2025-11-10T00:08:56.5924759Z -        
2025-11-10T00:08:56.5924865Z +
2025-11-10T00:08:56.5924979Z          Ok(())
2025-11-10T00:08:56.5925093Z      }
2025-11-10T00:08:56.5925198Z -    
2025-11-10T00:08:56.5927249Z +
2025-11-10T00:08:56.5927441Z      /// Run mempool processing once (for testing)
2025-11-10T00:08:56.5927664Z      pub async fn process_once(&mut self) -> Result<()> {
2025-11-10T00:08:56.5927818Z          // Process pending transactions
2025-11-10T00:08:56.5928275Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:51:
2025-11-10T00:08:56.5928702Z          self.process_pending_transactions().await?;
2025-11-10T00:08:56.5928833Z -        
2025-11-10T00:08:56.5928942Z +
2025-11-10T00:08:56.5929100Z          // Clean up old transactions
2025-11-10T00:08:56.5929269Z          self.cleanup_old_transactions().await?;
2025-11-10T00:08:56.5929384Z -        
2025-11-10T00:08:56.5929492Z +
2025-11-10T00:08:56.5929607Z          Ok(())
2025-11-10T00:08:56.5929718Z      }
2025-11-10T00:08:56.5929828Z -    
2025-11-10T00:08:56.5929933Z +
2025-11-10T00:08:56.5930073Z      /// Initialize mempool
2025-11-10T00:08:56.5930304Z      async fn initialize_mempool(&mut self) -> Result<()> {
2025-11-10T00:08:56.5930458Z          debug!("Initializing mempool");
2025-11-10T00:08:56.5930919Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:62:
2025-11-10T00:08:56.5931033Z -        
2025-11-10T00:08:56.5931140Z +
2025-11-10T00:08:56.5931347Z          // Load existing mempool from storage if available
2025-11-10T00:08:56.5931615Z          // In a real implementation, this would restore mempool state
2025-11-10T00:08:56.5931727Z -        
2025-11-10T00:08:56.5931834Z +
2025-11-10T00:08:56.5931961Z          Ok(())
2025-11-10T00:08:56.5932071Z      }
2025-11-10T00:08:56.5932177Z -    
2025-11-10T00:08:56.5932283Z +
2025-11-10T00:08:56.5932442Z      /// Main mempool processing loop
2025-11-10T00:08:56.5932642Z      async fn process_loop(&mut self) -> Result<()> {
2025-11-10T00:08:56.5932760Z          loop {
2025-11-10T00:08:56.5933689Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:72:
2025-11-10T00:08:56.5933867Z              // Process pending transactions
2025-11-10T00:08:56.5934067Z              self.process_pending_transactions().await?;
2025-11-10T00:08:56.5934188Z -            
2025-11-10T00:08:56.5934465Z +
2025-11-10T00:08:56.5934622Z              // Clean up old transactions
2025-11-10T00:08:56.5934796Z              self.cleanup_old_transactions().await?;
2025-11-10T00:08:56.5934928Z -            
2025-11-10T00:08:56.5935038Z +
2025-11-10T00:08:56.5935213Z              // Small delay to prevent busy waiting
2025-11-10T00:08:56.5935519Z              tokio::time::sleep(tokio::time::Duration::from_millis(100)).await;
2025-11-10T00:08:56.5935630Z          }
2025-11-10T00:08:56.5936094Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:81:
2025-11-10T00:08:56.5936203Z      }
2025-11-10T00:08:56.5936323Z -    
2025-11-10T00:08:56.5936432Z +
2025-11-10T00:08:56.5936593Z      /// Process pending transactions
2025-11-10T00:08:56.5936890Z      async fn process_pending_transactions(&mut self) -> Result<()> {
2025-11-10T00:08:56.5937062Z          // In a real implementation, this would:
2025-11-10T00:08:56.5939041Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:87:
2025-11-10T00:08:56.5939240Z          // 2. Validate transactions using consensus-proof
2025-11-10T00:08:56.5939421Z          // 3. Add valid transactions to mempool
2025-11-10T00:08:56.5939577Z          // 4. Relay transactions to peers
2025-11-10T00:08:56.5939985Z -        
2025-11-10T00:08:56.5940102Z +
2025-11-10T00:08:56.5940291Z          debug!("Processing pending transactions");
2025-11-10T00:08:56.5940403Z          Ok(())
2025-11-10T00:08:56.5940511Z      }
2025-11-10T00:08:56.5941086Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:94:
2025-11-10T00:08:56.5941200Z -    
2025-11-10T00:08:56.5941309Z +
2025-11-10T00:08:56.5941461Z      /// Clean up old transactions
2025-11-10T00:08:56.5941721Z      async fn cleanup_old_transactions(&mut self) -> Result<()> {
2025-11-10T00:08:56.5941890Z          // In a real implementation, this would:
2025-11-10T00:08:56.5942341Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:98:
2025-11-10T00:08:56.5942518Z          // 1. Remove transactions that are too old
2025-11-10T00:08:56.5942960Z          // 2. Remove transactions that conflict with new blocks
2025-11-10T00:08:56.5943134Z          // 3. Update transaction priorities
2025-11-10T00:08:56.5943254Z -        
2025-11-10T00:08:56.5943358Z +
2025-11-10T00:08:56.5943526Z          debug!("Cleaning up old transactions");
2025-11-10T00:08:56.5943644Z          Ok(())
2025-11-10T00:08:56.5943749Z      }
2025-11-10T00:08:56.5944207Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:105:
2025-11-10T00:08:56.5944483Z -    
2025-11-10T00:08:56.5944602Z +
2025-11-10T00:08:56.5946702Z      /// Add transaction to mempool
2025-11-10T00:08:56.5947035Z      pub async fn add_transaction(&mut self, tx: Transaction) -> Result<bool> {
2025-11-10T00:08:56.5947210Z          debug!("Adding transaction to mempool");
2025-11-10T00:08:56.5947666Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:109:
2025-11-10T00:08:56.5947772Z -        
2025-11-10T00:08:56.5947874Z +
2025-11-10T00:08:56.5948129Z          // Check for conflicts with existing mempool transactions
2025-11-10T00:08:56.5948267Z          for input in &tx.inputs {
2025-11-10T00:08:56.5948490Z              if self.spent_outputs.contains(&input.prevout) {
2025-11-10T00:08:56.5948929Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:114:
2025-11-10T00:08:56.5949049Z                  return Ok(false);
2025-11-10T00:08:56.5949153Z              }
2025-11-10T00:08:56.5949269Z          }
2025-11-10T00:08:56.5949370Z -        
2025-11-10T00:08:56.5949464Z +
2025-11-10T00:08:56.5949672Z          // Add transaction to mempool (store full transaction)
2025-11-10T00:08:56.5949884Z          use bllvm_protocol::mempool::calculate_tx_id;
2025-11-10T00:08:56.5950041Z          let tx_hash = calculate_tx_id(&tx);
2025-11-10T00:08:56.5950485Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:121:
2025-11-10T00:08:56.5950693Z          self.transactions.insert(tx_hash, tx.clone());
2025-11-10T00:08:56.5950853Z          self.mempool.insert(tx_hash);
2025-11-10T00:08:56.5950960Z -        
2025-11-10T00:08:56.5951072Z +
2025-11-10T00:08:56.5951212Z          // Track spent outputs
2025-11-10T00:08:56.5951345Z          for input in &tx.inputs {
2025-11-10T00:08:56.5951569Z              self.spent_outputs.insert(input.prevout.clone());
2025-11-10T00:08:56.5952024Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:127:
2025-11-10T00:08:56.5952135Z          }
2025-11-10T00:08:56.5952236Z -        
2025-11-10T00:08:56.5952337Z +
2025-11-10T00:08:56.5952459Z          Ok(true)
2025-11-10T00:08:56.5952569Z      }
2025-11-10T00:08:56.5952676Z -    
2025-11-10T00:08:56.5952785Z +
2025-11-10T00:08:56.5952913Z      /// Get mempool size
2025-11-10T00:08:56.5953058Z      pub fn size(&self) -> usize {
2025-11-10T00:08:56.5953200Z          self.transactions.len()
2025-11-10T00:08:56.5953654Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:135:
2025-11-10T00:08:56.5953769Z      }
2025-11-10T00:08:56.5953870Z -    
2025-11-10T00:08:56.5953982Z +
2025-11-10T00:08:56.5954560Z      /// Get mempool transaction hashes
2025-11-10T00:08:56.5954765Z      pub fn transaction_hashes(&self) -> Vec<Hash> {
2025-11-10T00:08:56.5954951Z          self.transactions.keys().cloned().collect()
2025-11-10T00:08:56.5955375Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:140:
2025-11-10T00:08:56.5955471Z      }
2025-11-10T00:08:56.5955576Z -    
2025-11-10T00:08:56.5955688Z +
2025-11-10T00:08:56.5957463Z      /// Get transaction by hash
2025-11-10T00:08:56.5957754Z      pub fn get_transaction(&self, hash: &Hash) -> Option<Transaction> {
2025-11-10T00:08:56.5957908Z          self.transactions.get(hash).cloned()
2025-11-10T00:08:56.5958346Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:145:
2025-11-10T00:08:56.5958445Z      }
2025-11-10T00:08:56.5958540Z -    
2025-11-10T00:08:56.5958641Z +
2025-11-10T00:08:56.5959004Z      /// Get all transactions
2025-11-10T00:08:56.5959241Z      pub fn get_transactions(&self) -> Vec<Transaction> {
2025-11-10T00:08:56.5959875Z          self.transactions.values().cloned().collect()
2025-11-10T00:08:56.5960338Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:150:
2025-11-10T00:08:56.5960451Z      }
2025-11-10T00:08:56.5960555Z -    
2025-11-10T00:08:56.5960670Z +
2025-11-10T00:08:56.5960854Z      /// Get prioritized transactions by fee rate
2025-11-10T00:08:56.5960964Z -    /// 
2025-11-10T00:08:56.5961080Z +    ///
2025-11-10T00:08:56.5961461Z      /// Returns transactions sorted by fee rate (satoshis per vbyte) in descending order.
2025-11-10T00:08:56.5961627Z      /// Requires UTXO set to calculate fee rates.
2025-11-10T00:08:56.5962096Z -    pub fn get_prioritized_transactions(&self, limit: usize, utxo_set: &UtxoSet) -> Vec<Transaction> {
2025-11-10T00:08:56.5962276Z +    pub fn get_prioritized_transactions(
2025-11-10T00:08:56.5962403Z +        &self,
2025-11-10T00:08:56.5962528Z +        limit: usize,
2025-11-10T00:08:56.5962671Z +        utxo_set: &UtxoSet,
2025-11-10T00:08:56.5962803Z +    ) -> Vec<Transaction> {
2025-11-10T00:08:56.5963054Z          let mut tx_with_fees: Vec<(Transaction, u64)> = Vec::new();
2025-11-10T00:08:56.5963168Z -        
2025-11-10T00:08:56.5963285Z +
2025-11-10T00:08:56.5963463Z          for tx in self.transactions.values() {
2025-11-10T00:08:56.5963627Z              // Calculate fee for this transaction
2025-11-10T00:08:56.5963869Z              let fee = self.calculate_transaction_fee(tx, utxo_set);
2025-11-10T00:08:56.5964594Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:162:
2025-11-10T00:08:56.5964734Z -            
2025-11-10T00:08:56.5964840Z +
2025-11-10T00:08:56.5965197Z              // Calculate transaction size (simplified - use serialized size estimate)
2025-11-10T00:08:56.5965406Z              let size = self.estimate_transaction_size(tx);
2025-11-10T00:08:56.5965525Z -            
2025-11-10T00:08:56.5965632Z +
2025-11-10T00:08:56.5965827Z              // Calculate fee rate (satoshis per vbyte)
2025-11-10T00:08:56.5973233Z              let fee_rate = if size > 0 {
2025-11-10T00:08:56.5973683Z                  fee * 1000 / size as u64 // Convert to satoshis per vbyte (multiply by 1000 for precision)
2025-11-10T00:08:56.5974173Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:169:
2025-11-10T00:08:56.5974546Z              } else {
2025-11-10T00:08:56.5974671Z                  0
2025-11-10T00:08:56.5974788Z              };
2025-11-10T00:08:56.5974912Z -            
2025-11-10T00:08:56.5975015Z +
2025-11-10T00:08:56.5975212Z              tx_with_fees.push((tx.clone(), fee_rate));
2025-11-10T00:08:56.5975330Z          }
2025-11-10T00:08:56.5975442Z -        
2025-11-10T00:08:56.5975548Z +
2025-11-10T00:08:56.5975703Z          // Sort by fee rate (descending)
2025-11-10T00:08:56.5975910Z          tx_with_fees.sort_by(|a, b| b.1.cmp(&a.1));
2025-11-10T00:08:56.5976025Z -        
2025-11-10T00:08:56.5976390Z +
2025-11-10T00:08:56.5976557Z          // Return top N transactions
2025-11-10T00:08:56.5976703Z -        tx_with_fees.into_iter()
2025-11-10T00:08:56.5976827Z +        tx_with_fees
2025-11-10T00:08:56.5976955Z +            .into_iter()
2025-11-10T00:08:56.5977084Z              .take(limit)
2025-11-10T00:08:56.5977219Z              .map(|(tx, _)| tx)
2025-11-10T00:08:56.5977343Z              .collect()
2025-11-10T00:08:56.5977840Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:184:
2025-11-10T00:08:56.5977957Z      }
2025-11-10T00:08:56.5978066Z -    
2025-11-10T00:08:56.5978174Z +
2025-11-10T00:08:56.5978333Z      /// Calculate transaction fee
2025-11-10T00:08:56.5978445Z -    /// 
2025-11-10T00:08:56.5978557Z +    ///
2025-11-10T00:08:56.5978737Z      /// Fee = sum of inputs - sum of outputs
2025-11-10T00:08:56.5979368Z      pub fn calculate_transaction_fee(&self, tx: &Transaction, utxo_set: &UtxoSet) -> u64 {
2025-11-10T00:08:56.5979532Z          let mut input_total = 0u64;
2025-11-10T00:08:56.5980010Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:191:
2025-11-10T00:08:56.5980132Z -        
2025-11-10T00:08:56.5980242Z +
2025-11-10T00:08:56.5980397Z          // Sum input values from UTXO set
2025-11-10T00:08:56.5980549Z          for input in &tx.inputs {
2025-11-10T00:08:56.5980764Z              if let Some(utxo) = utxo_set.get(&input.prevout) {
2025-11-10T00:08:56.5981225Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:195:
2025-11-10T00:08:56.5983222Z                  input_total += utxo.value as u64;
2025-11-10T00:08:56.5983348Z              }
2025-11-10T00:08:56.5983455Z          }
2025-11-10T00:08:56.5983562Z -        
2025-11-10T00:08:56.5983678Z +
2025-11-10T00:08:56.5983813Z          // Sum output values
2025-11-10T00:08:56.5984157Z          let output_total: u64 = tx.outputs.iter().map(|out| out.value as u64).sum();
2025-11-10T00:08:56.5984271Z -        
2025-11-10T00:08:56.5984577Z +
2025-11-10T00:08:56.5984759Z          // Fee is difference (inputs - outputs)
2025-11-10T00:08:56.5984916Z          if input_total > output_total {
2025-11-10T00:08:56.5985078Z              input_total - output_total
2025-11-10T00:08:56.5985541Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:206:
2025-11-10T00:08:56.5985654Z              0
2025-11-10T00:08:56.5985774Z          }
2025-11-10T00:08:56.5985886Z      }
2025-11-10T00:08:56.5985993Z -    
2025-11-10T00:08:56.5986102Z +
2025-11-10T00:08:56.5986279Z      /// Estimate transaction size in vbytes
2025-11-10T00:08:56.5986391Z -    /// 
2025-11-10T00:08:56.5986500Z +    ///
2025-11-10T00:08:56.5986854Z      /// Simplified estimation - in production, would use actual serialized size
2025-11-10T00:08:56.5987157Z      fn estimate_transaction_size(&self, tx: &Transaction) -> usize {
2025-11-10T00:08:56.5987429Z          // Base transaction size: version (4) + locktime (4) = 8 bytes
2025-11-10T00:08:56.5987903Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:215:
2025-11-10T00:08:56.5988045Z          let mut size = 8;
2025-11-10T00:08:56.5988156Z -        
2025-11-10T00:08:56.5988262Z +
2025-11-10T00:08:56.5988523Z          // Input size: prevout (36) + script_sig (var) + sequence (4)
2025-11-10T00:08:56.5988670Z          for input in &tx.inputs {
2025-11-10T00:08:56.5988805Z              size += 36; // prevout
2025-11-10T00:08:56.5989257Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:220:
2025-11-10T00:08:56.5989428Z              size += input.script_sig.len();
2025-11-10T00:08:56.5989556Z              size += 4; // sequence
2025-11-10T00:08:56.5989664Z          }
2025-11-10T00:08:56.5989780Z -        
2025-11-10T00:08:56.5989886Z +
2025-11-10T00:08:56.5990076Z          // Output size: value (8) + script_pubkey (var)
2025-11-10T00:08:56.5990231Z          for output in &tx.outputs {
2025-11-10T00:08:56.5990371Z              size += 8; // value
2025-11-10T00:08:56.5991102Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:227:
2025-11-10T00:08:56.5991277Z              size += output.script_pubkey.len();
2025-11-10T00:08:56.5991397Z          }
2025-11-10T00:08:56.5991504Z -        
2025-11-10T00:08:56.5991610Z +
2025-11-10T00:08:56.5991943Z          // Add witness discount if segwit (simplified - assume no witness for now)
2025-11-10T00:08:56.5992071Z          size
2025-11-10T00:08:56.5992180Z      }
2025-11-10T00:08:56.5992644Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:233:
2025-11-10T00:08:56.5992758Z -    
2025-11-10T00:08:56.5992864Z +
2025-11-10T00:08:56.5993019Z      /// Remove transaction from mempool
2025-11-10T00:08:56.5993274Z      pub fn remove_transaction(&mut self, hash: &Hash) -> bool {
2025-11-10T00:08:56.5993744Z          if let Some(tx) = self.transactions.remove(hash) {
2025-11-10T00:08:56.5994881Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:237:
2025-11-10T00:08:56.5995065Z              self.mempool.remove(hash);
2025-11-10T00:08:56.5995187Z -            
2025-11-10T00:08:56.5995295Z +
2025-11-10T00:08:56.5995458Z              // Remove spent outputs tracking
2025-11-10T00:08:56.5995614Z              for input in &tx.inputs {
2025-11-10T00:08:56.5995812Z                  self.spent_outputs.remove(&input.prevout);
2025-11-10T00:08:56.5996280Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:242:
2025-11-10T00:08:56.5996393Z              }
2025-11-10T00:08:56.5996513Z -            
2025-11-10T00:08:56.5996621Z +
2025-11-10T00:08:56.5996740Z              true
2025-11-10T00:08:56.5996866Z          } else {
2025-11-10T00:08:56.5996983Z              false
2025-11-10T00:08:56.5997438Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:247:
2025-11-10T00:08:56.5997557Z          }
2025-11-10T00:08:56.5997675Z      }
2025-11-10T00:08:56.5997786Z -    
2025-11-10T00:08:56.5997893Z +
2025-11-10T00:08:56.5998033Z      /// Clear mempool
2025-11-10T00:08:56.5998174Z      pub fn clear(&mut self) {
2025-11-10T00:08:56.5998323Z          self.transactions.clear();
2025-11-10T00:08:56.5998768Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:253:
2025-11-10T00:08:56.5998923Z          self.mempool.clear();
2025-11-10T00:08:56.5999072Z          self.spent_outputs.clear();
2025-11-10T00:08:56.5999180Z      }
2025-11-10T00:08:56.5999295Z -    
2025-11-10T00:08:56.5999402Z +
2025-11-10T00:08:56.5999571Z      /// Save mempool to disk for persistence
2025-11-10T00:08:56.5999926Z      pub fn save_to_disk<P: AsRef<std::path::Path>>(&self, path: P) -> Result<()> {
2025-11-10T00:08:56.6000278Z +        use bllvm_protocol::serialization::transaction::serialize_transaction;
2025-11-10T00:08:56.6000415Z          use std::fs::File;
2025-11-10T00:08:56.6000556Z          use std::io::Write;
2025-11-10T00:08:56.6000902Z -        use bllvm_protocol::serialization::transaction::serialize_transaction;
2025-11-10T00:08:56.6001013Z -        
2025-11-10T00:08:56.6001122Z +
2025-11-10T00:08:56.6001323Z          let transactions = self.get_transactions();
2025-11-10T00:08:56.6001491Z          let mut file = File::create(path)?;
2025-11-10T00:08:56.6001599Z -        
2025-11-10T00:08:56.6001705Z +
2025-11-10T00:08:56.6001861Z          // Write transaction count
2025-11-10T00:08:56.6002123Z          file.write_all(&(transactions.len() as u32).to_le_bytes())?;
2025-11-10T00:08:56.6002233Z -        
2025-11-10T00:08:56.6002350Z +
2025-11-10T00:08:56.6002490Z          // Write each transaction
2025-11-10T00:08:56.6002631Z          for tx in transactions {
2025-11-10T00:08:56.6002827Z              let serialized = serialize_transaction(&tx);
2025-11-10T00:08:56.6003312Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:272:
2025-11-10T00:08:56.6003563Z              file.write_all(&(serialized.len() as u32).to_le_bytes())?;
2025-11-10T00:08:56.6003965Z              file.write_all(&serialized)?;
2025-11-10T00:08:56.6004086Z          }
2025-11-10T00:08:56.6004197Z -        
2025-11-10T00:08:56.6004472Z +
2025-11-10T00:08:56.6004699Z          file.sync_all()?;
2025-11-10T00:08:56.6004824Z          Ok(())
2025-11-10T00:08:56.6004932Z      }
2025-11-10T00:08:56.6005398Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:279:
2025-11-10T00:08:56.6005515Z  }
2025-11-10T00:08:56.6005624Z  
2025-11-10T00:08:56.6005786Z  impl Default for MempoolManager {
2025-11-10T00:08:56.6005953Z -    fn default() -> Self { Self::new() }
2025-11-10T00:08:56.6006100Z +    fn default() -> Self {
2025-11-10T00:08:56.6006224Z +        Self::new()
2025-11-10T00:08:56.6006335Z +    }
2025-11-10T00:08:56.6006452Z  }
2025-11-10T00:08:56.6006559Z  
2025-11-10T00:08:56.6007149Z  // Implement MempoolProvider trait for integration with MiningCoordinator
2025-11-10T00:08:56.6007634Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:298:
2025-11-10T00:08:56.6007778Z          self.size()
2025-11-10T00:08:56.6007879Z      }
2025-11-10T00:08:56.6007984Z  
2025-11-10T00:08:56.6008630Z -    fn get_prioritized_transactions(&self, limit: usize, utxo_set: &bllvm_protocol::UtxoSet) -> Vec<bllvm_protocol::Transaction> {
2025-11-10T00:08:56.6008787Z +    fn get_prioritized_transactions(
2025-11-10T00:08:56.6008900Z +        &self,
2025-11-10T00:08:56.6009020Z +        limit: usize,
2025-11-10T00:08:56.6009193Z +        utxo_set: &bllvm_protocol::UtxoSet,
2025-11-10T00:08:56.6009353Z +    ) -> Vec<bllvm_protocol::Transaction> {
2025-11-10T00:08:56.6009567Z          self.get_prioritized_transactions(limit, utxo_set)
2025-11-10T00:08:56.6009679Z      }
2025-11-10T00:08:56.6009782Z  
2025-11-10T00:08:56.6010246Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:312:
2025-11-10T00:08:56.6010379Z  impl MempoolManager {
2025-11-10T00:08:56.6010523Z      /// Load mempool from disk
2025-11-10T00:08:56.6010872Z      pub fn load_from_disk<P: AsRef<std::path::Path>>(&mut self, path: P) -> Result<()> {
2025-11-10T00:08:56.6011201Z +        use bllvm_protocol::serialization::transaction::deserialize_transaction;
2025-11-10T00:08:56.6011332Z          use std::fs::File;
2025-11-10T00:08:56.6011452Z          use std::io::Read;
2025-11-10T00:08:56.6011772Z -        use bllvm_protocol::serialization::transaction::deserialize_transaction;
2025-11-10T00:08:56.6011883Z -        
2025-11-10T00:08:56.6011984Z +
2025-11-10T00:08:56.6012150Z          let mut file = File::open(path)?;
2025-11-10T00:08:56.6012293Z          let mut count_bytes = [0u8; 4];
2025-11-10T00:08:56.6012451Z          file.read_exact(&mut count_bytes)?;
2025-11-10T00:08:56.6013211Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:322:
2025-11-10T00:08:56.6013431Z          let count = u32::from_le_bytes(count_bytes) as usize;
2025-11-10T00:08:56.6013545Z -        
2025-11-10T00:08:56.6013652Z +
2025-11-10T00:08:56.6013773Z          for _ in 0..count {
2025-11-10T00:08:56.6013919Z              let mut len_bytes = [0u8; 4];
2025-11-10T00:08:56.6014066Z              file.read_exact(&mut len_bytes)?;
2025-11-10T00:08:56.6014673Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:327:
2025-11-10T00:08:56.6014868Z              let len = u32::from_le_bytes(len_bytes) as usize;
2025-11-10T00:08:56.6014980Z -            
2025-11-10T00:08:56.6015082Z +
2025-11-10T00:08:56.6015227Z              let mut tx_bytes = vec![0u8; len];
2025-11-10T00:08:56.6015376Z              file.read_exact(&mut tx_bytes)?;
2025-11-10T00:08:56.6015479Z -            
2025-11-10T00:08:56.6015579Z +
2025-11-10T00:08:56.6015758Z              let tx = deserialize_transaction(&tx_bytes)?;
2025-11-10T00:08:56.6015910Z              let _ = self.add_transaction(tx);
2025-11-10T00:08:56.6016020Z          }
2025-11-10T00:08:56.6016453Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:335:
2025-11-10T00:08:56.6016786Z -        
2025-11-10T00:08:56.6016890Z +
2025-11-10T00:08:56.6017007Z          Ok(())
2025-11-10T00:08:56.6017117Z      }
2025-11-10T00:08:56.6017230Z  }
2025-11-10T00:08:56.6017688Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/metrics.rs:2:
2025-11-10T00:08:56.6017795Z  //!
2025-11-10T00:08:56.6018215Z  //! Provides comprehensive metrics for monitoring node health, performance, and behavior.
2025-11-10T00:08:56.6018319Z  
2025-11-10T00:08:56.6018474Z +use serde::{Deserialize, Serialize};
2025-11-10T00:08:56.6018614Z  use std::sync::Arc;
2025-11-10T00:08:56.6018738Z  use std::sync::Mutex;
2025-11-10T00:08:56.6018935Z  use std::time::{Duration, SystemTime, UNIX_EPOCH};
2025-11-10T00:08:56.6019364Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/metrics.rs:8:
2025-11-10T00:08:56.6019707Z -use serde::{Deserialize, Serialize};
2025-11-10T00:08:56.6019819Z  
2025-11-10T00:08:56.6019966Z  /// Comprehensive node metrics
2025-11-10T00:08:56.6020155Z  #[derive(Debug, Clone, Serialize, Deserialize)]
2025-11-10T00:08:56.6020597Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/metrics.rs:251:
2025-11-10T00:08:56.6020717Z          Self::new()
2025-11-10T00:08:56.6020832Z      }
2025-11-10T00:08:56.6020936Z  }
2025-11-10T00:08:56.6021039Z -
2025-11-10T00:08:56.6021141Z  
2025-11-10T00:08:56.6051982Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/miner.rs:20:
2025-11-10T00:08:56.6052094Z  
2025-11-10T00:08:56.6052276Z      /// Get prioritized transactions (by fee rate)
2025-11-10T00:08:56.6052464Z      /// Requires UTXO set for accurate fee calculation
2025-11-10T00:08:56.6052968Z -    fn get_prioritized_transactions(&self, limit: usize, utxo_set: &bllvm_protocol::UtxoSet) -> Vec<Transaction>;
2025-11-10T00:08:56.6053127Z +    fn get_prioritized_transactions(
2025-11-10T00:08:56.6053240Z +        &self,
2025-11-10T00:08:56.6053357Z +        limit: usize,
2025-11-10T00:08:56.6053517Z +        utxo_set: &bllvm_protocol::UtxoSet,
2025-11-10T00:08:56.6053642Z +    ) -> Vec<Transaction>;
2025-11-10T00:08:56.6053751Z  
2025-11-10T00:08:56.6053896Z      /// Remove transaction from mempool
2025-11-10T00:08:56.6054128Z      fn remove_transaction(&mut self, hash: &[u8; 32]) -> bool;
2025-11-10T00:08:56.6054818Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/miner.rs:57:
2025-11-10T00:08:56.6055015Z  
2025-11-10T00:08:56.6055184Z      /// Select transactions for block
2025-11-10T00:08:56.6055497Z      /// Note: Requires UTXO set for fee calculation - caller must provide it
2025-11-10T00:08:56.6056148Z -    pub fn select_transactions(&self, mempool: &dyn MempoolProvider, utxo_set: &bllvm_protocol::UtxoSet) -> Vec<Transaction> {
2025-11-10T00:08:56.6056309Z +    pub fn select_transactions(
2025-11-10T00:08:56.6056434Z +        &self,
2025-11-10T00:08:56.6056595Z +        mempool: &dyn MempoolProvider,
2025-11-10T00:08:56.6056772Z +        utxo_set: &bllvm_protocol::UtxoSet,
2025-11-10T00:08:56.6056996Z +    ) -> Vec<Transaction> {
2025-11-10T00:08:56.6057143Z          let mut selected = Vec::new();
2025-11-10T00:08:56.6057284Z          let mut current_size = 0;
2025-11-10T00:08:56.6057434Z          let mut current_weight = 0;
2025-11-10T00:08:56.6057887Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/miner.rs:392:
2025-11-10T00:08:56.6057996Z  
2025-11-10T00:08:56.6058269Z          // Get chain tip from storage for prev_block_hash and difficulty
2025-11-10T00:08:56.6058609Z          let (prev_block_hash, bits, height) = if let Some(ref storage) = self.storage {
2025-11-10T00:08:56.6058850Z -            if let Some(tip_header) = storage.chain().get_tip_header()
2025-11-10T00:08:56.6059564Z -                .map_err(|e| anyhow::anyhow!("Failed to get tip header: {}", e))? {
2025-11-10T00:08:56.6059777Z -                let tip_hash = storage.chain().get_tip_hash()
2025-11-10T00:08:56.6060207Z +            if let Some(tip_header) = storage
2025-11-10T00:08:56.6060327Z +                .chain()
2025-11-10T00:08:56.6060467Z +                .get_tip_header()
2025-11-10T00:08:56.6060746Z +                .map_err(|e| anyhow::anyhow!("Failed to get tip header: {}", e))?
2025-11-10T00:08:56.6060852Z +            {
2025-11-10T00:08:56.6060997Z +                let tip_hash = storage
2025-11-10T00:08:56.6061122Z +                    .chain()
2025-11-10T00:08:56.6061253Z +                    .get_tip_hash()
2025-11-10T00:08:56.6061520Z                      .map_err(|e| anyhow::anyhow!("Failed to get tip hash: {}", e))?
2025-11-10T00:08:56.6061668Z                      .unwrap_or([0u8; 32]);
2025-11-10T00:08:56.6061875Z -                let chain_height = storage.chain().get_height()
2025-11-10T00:08:56.6062025Z +                let chain_height = storage
2025-11-10T00:08:56.6062154Z +                    .chain()
2025-11-10T00:08:56.6062572Z +                    .get_height()
2025-11-10T00:08:56.6062887Z                      .map_err(|e| anyhow::anyhow!("Failed to get chain height: {}", e))?
2025-11-10T00:08:56.6063026Z                      .unwrap_or(0);
2025-11-10T00:08:56.6063205Z                  (tip_hash, tip_header.bits, chain_height)
2025-11-10T00:08:56.6063664Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/miner.rs:412:
2025-11-10T00:08:56.6063784Z  
2025-11-10T00:08:56.6063989Z          // Get UTXO set from storage for fee calculation
2025-11-10T00:08:56.6064225Z          let utxo_set = if let Some(ref storage) = self.storage {
2025-11-10T00:08:56.6064580Z -            storage.utxos().get_all_utxos()
2025-11-10T00:08:56.6064705Z +            storage
2025-11-10T00:08:56.6064824Z +                .utxos()
2025-11-10T00:08:56.6064952Z +                .get_all_utxos()
2025-11-10T00:08:56.6065233Z                  .map_err(|e| anyhow::anyhow!("Failed to get UTXO set: {}", e))?
2025-11-10T00:08:56.6065360Z          } else {
2025-11-10T00:08:56.6065602Z              // No storage - use empty UTXO set (will result in 0 fees)
2025-11-10T00:08:56.6066071Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/miner.rs:616:
2025-11-10T00:08:56.6066234Z          self.transactions.len()
2025-11-10T00:08:56.6066345Z      }
2025-11-10T00:08:56.6066452Z  
2025-11-10T00:08:56.6067017Z -    fn get_prioritized_transactions(&self, limit: usize, _utxo_set: &bllvm_protocol::UtxoSet) -> Vec<Transaction> {
2025-11-10T00:08:56.6067179Z +    fn get_prioritized_transactions(
2025-11-10T00:08:56.6067296Z +        &self,
2025-11-10T00:08:56.6067432Z +        limit: usize,
2025-11-10T00:08:56.6067600Z +        _utxo_set: &bllvm_protocol::UtxoSet,
2025-11-10T00:08:56.6067742Z +    ) -> Vec<Transaction> {
2025-11-10T00:08:56.6068100Z          // Mock implementation ignores UTXO set and uses pre-calculated priorities
2025-11-10T00:08:56.6068264Z          self.prioritized_transactions
2025-11-10T00:08:56.6068384Z              .iter()
2025-11-10T00:08:56.6068834Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/miner.rs:786:
2025-11-10T00:08:56.6069037Z          assert_eq!(mempool.get_mempool_size(), 0);
2025-11-10T00:08:56.6069242Z          assert!(mempool.get_transactions().is_empty());
2025-11-10T00:08:56.6069466Z          let empty_utxo_set = bllvm_protocol::UtxoSet::new();
2025-11-10T00:08:56.6069847Z -        assert!(mempool.get_prioritized_transactions(10, &empty_utxo_set).is_empty());
2025-11-10T00:08:56.6069981Z +        assert!(mempool
2025-11-10T00:08:56.6070193Z +            .get_prioritized_transactions(10, &empty_utxo_set)
2025-11-10T00:08:56.6070322Z +            .is_empty());
2025-11-10T00:08:56.6070440Z      }
2025-11-10T00:08:56.6070547Z  
2025-11-10T00:08:56.6070663Z      #[test]
2025-11-10T00:08:56.6181350Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:5:
2025-11-10T00:08:56.6181509Z  
2025-11-10T00:08:56.6181674Z  pub mod block_processor;
2025-11-10T00:08:56.6181821Z  pub mod event_publisher;
2025-11-10T00:08:56.6182184Z +pub mod health;
2025-11-10T00:08:56.6182310Z  pub mod mempool;
2025-11-10T00:08:56.6182439Z -pub mod miner;
2025-11-10T00:08:56.6182556Z -pub mod sync;
2025-11-10T00:08:56.6182679Z  pub mod metrics;
2025-11-10T00:08:56.6184860Z -pub mod health;
2025-11-10T00:08:56.6184994Z +pub mod miner;
2025-11-10T00:08:56.6185128Z  pub mod performance;
2025-11-10T00:08:56.6185247Z +pub mod sync;
2025-11-10T00:08:56.6185360Z  
2025-11-10T00:08:56.6185496Z  use anyhow::Result;
2025-11-10T00:08:56.6185634Z  use std::net::SocketAddr;
2025-11-10T00:08:56.6186073Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:70:
2025-11-10T00:08:56.6186186Z  
2025-11-10T00:08:56.6186330Z          // Initialize components
2025-11-10T00:08:56.6186703Z          let protocol_version = protocol_version.unwrap_or(ProtocolVersion::Regtest);
2025-11-10T00:08:56.6186830Z -        let protocol =
2025-11-10T00:08:56.6187275Z -            BitcoinProtocolEngine::new(protocol_version)?;
2025-11-10T00:08:56.6187560Z +        let protocol = BitcoinProtocolEngine::new(protocol_version)?;
2025-11-10T00:08:56.6187735Z          let protocol_arc = Arc::new(protocol);
2025-11-10T00:08:56.6187896Z          let storage = Storage::new(data_dir)?;
2025-11-10T00:08:56.6188043Z          let storage_arc = Arc::new(storage);
2025-11-10T00:08:56.6188491Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:78:
2025-11-10T00:08:56.6188801Z          let mempool_manager_arc = Arc::new(mempool::MempoolManager::new());
2025-11-10T00:08:56.6189014Z -        let network = NetworkManager::new(network_addr)
2025-11-10T00:08:56.6189540Z -            .with_dependencies(Arc::clone(&protocol_arc), Arc::clone(&storage_arc), Arc::clone(&mempool_manager_arc));
2025-11-10T00:08:56.6189860Z +        let network = NetworkManager::new(network_addr).with_dependencies(
2025-11-10T00:08:56.6190027Z +            Arc::clone(&protocol_arc),
2025-11-10T00:08:56.6190178Z +            Arc::clone(&storage_arc),
2025-11-10T00:08:56.6190356Z +            Arc::clone(&mempool_manager_arc),
2025-11-10T00:08:56.6190467Z +        );
2025-11-10T00:08:56.6190634Z          let network_arc = Arc::new(network);
2025-11-10T00:08:56.6190867Z          let metrics_arc = Arc::new(MetricsCollector::new());
2025-11-10T00:08:56.6191156Z          let profiler_arc = Arc::new(PerformanceProfiler::new(1000));
2025-11-10T00:08:56.6191599Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:187:
2025-11-10T00:08:56.6191775Z          info!("Sync coordinator initialized");
2025-11-10T00:08:56.6191947Z          info!("Mempool manager initialized");
2025-11-10T00:08:56.6192121Z          info!("Mining coordinator initialized");
2025-11-10T00:08:56.6192238Z -        
2025-11-10T00:08:56.6192357Z +
2025-11-10T00:08:56.6192498Z          // Start network manager
2025-11-10T00:08:56.6192765Z          if let Err(e) = self.network.start(self.network_addr).await {
2025-11-10T00:08:56.6192972Z              warn!("Failed to start network manager: {}", e);
2025-11-10T00:08:56.6193422Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:194:
2025-11-10T00:08:56.6193629Z              // Continue anyway - network might be optional
2025-11-10T00:08:56.6193747Z          }
2025-11-10T00:08:56.6193870Z -        
2025-11-10T00:08:56.6193982Z +
2025-11-10T00:08:56.6194174Z          // Initialize peer connections automatically
2025-11-10T00:08:56.6194576Z          self.initialize_peer_connections().await?;
2025-11-10T00:08:56.6194703Z  
2025-11-10T00:08:56.6195160Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:203:
2025-11-10T00:08:56.6195319Z              if config.prune_on_startup {
2025-11-10T00:08:56.6195660Z                  let current_height = self.storage.chain().get_height()?.unwrap_or(0);
2025-11-10T00:08:56.6195829Z                  let is_ibd = current_height == 0;
2025-11-10T00:08:56.6195952Z -                
2025-11-10T00:08:56.6196070Z +
2025-11-10T00:08:56.6196512Z                  if !is_ibd && pruning_manager.is_enabled() {
2025-11-10T00:08:56.6196828Z                      info!("Prune on startup enabled, checking if pruning is needed...");
2025-11-10T00:08:56.6196950Z -                    
2025-11-10T00:08:56.6197064Z +
2025-11-10T00:08:56.6197274Z                      // Calculate prune height based on configuration
2025-11-10T00:08:56.6197459Z                      let prune_height = match &config.mode {
2025-11-10T00:08:56.6197671Z                          crate::config::PruningMode::Disabled => {
2025-11-10T00:08:56.6198107Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:213:
2025-11-10T00:08:56.6198257Z                              // Skip if disabled
2025-11-10T00:08:56.6198392Z                              None
2025-11-10T00:08:56.6198515Z                          }
2025-11-10T00:08:56.6199055Z -                        crate::config::PruningMode::Normal { keep_from_height, .. } => {
2025-11-10T00:08:56.6199275Z +                        crate::config::PruningMode::Normal {
2025-11-10T00:08:56.6199442Z +                            keep_from_height, ..
2025-11-10T00:08:56.6199567Z +                        } => {
2025-11-10T00:08:56.6199744Z                              // Prune up to keep_from_height
2025-11-10T00:08:56.6199912Z                              Some(*keep_from_height)
2025-11-10T00:08:56.6200037Z                          }
2025-11-10T00:08:56.6200469Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:220:
2025-11-10T00:08:56.6200643Z                          #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.6200954Z -                        crate::config::PruningMode::Aggressive { keep_from_height, .. } => {
2025-11-10T00:08:56.6201133Z +                        crate::config::PruningMode::Aggressive {
2025-11-10T00:08:56.6201281Z +                            keep_from_height, ..
2025-11-10T00:08:56.6201403Z +                        } => {
2025-11-10T00:08:56.6201572Z                              // Prune up to keep_from_height
2025-11-10T00:08:56.6201731Z                              Some(*keep_from_height)
2025-11-10T00:08:56.6201857Z                          }
2025-11-10T00:08:56.6202261Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:228:
2025-11-10T00:08:56.6202463Z                              // Fall back to no pruning if feature is disabled
2025-11-10T00:08:56.6202587Z                              None
2025-11-10T00:08:56.6202697Z                          }
2025-11-10T00:08:56.6203015Z -                        crate::config::PruningMode::Custom { keep_bodies_from_height, .. } => {
2025-11-10T00:08:56.6203182Z +                        crate::config::PruningMode::Custom {
2025-11-10T00:08:56.6203336Z +                            keep_bodies_from_height,
2025-11-10T00:08:56.6203453Z +                            ..
2025-11-10T00:08:56.6203579Z +                        } => {
2025-11-10T00:08:56.6203772Z                              // Prune up to keep_bodies_from_height
2025-11-10T00:08:56.6203947Z                              Some(*keep_bodies_from_height)
2025-11-10T00:08:56.6204061Z                          }
2025-11-10T00:08:56.6204660Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:235:
2025-11-10T00:08:56.6204786Z                      };
2025-11-10T00:08:56.6204892Z -                    
2025-11-10T00:08:56.6204991Z +
2025-11-10T00:08:56.6205194Z                      if let Some(prune_to_height) = prune_height {
2025-11-10T00:08:56.6205359Z                          if prune_to_height < current_height {
2025-11-10T00:08:56.6205759Z -                            match pruning_manager.prune_to_height(prune_to_height, current_height, is_ibd) {
2025-11-10T00:08:56.6205959Z +                            match pruning_manager.prune_to_height(
2025-11-10T00:08:56.6206117Z +                                prune_to_height,
2025-11-10T00:08:56.6206263Z +                                current_height,
2025-11-10T00:08:56.6206653Z +                                is_ibd,
2025-11-10T00:08:56.6206789Z +                            ) {
2025-11-10T00:08:56.6206935Z                                  Ok(stats) => {
2025-11-10T00:08:56.6207268Z                                      info!("Startup pruning completed: {} blocks pruned, {} blocks kept", 
2025-11-10T00:08:56.6207485Z                                            stats.blocks_pruned, stats.blocks_kept);
2025-11-10T00:08:56.6207929Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:243:
2025-11-10T00:08:56.6208131Z                                      // Flush storage to persist pruning changes
2025-11-10T00:08:56.6208325Z                                      if let Err(e) = self.storage.flush() {
2025-11-10T00:08:56.6208620Z -                                        warn!("Failed to flush storage after startup pruning: {}", e);
2025-11-10T00:08:56.6208975Z +                                        warn!(
2025-11-10T00:08:56.6209257Z +                                            "Failed to flush storage after startup pruning: {}",
2025-11-10T00:08:56.6209483Z +                                            e
2025-11-10T00:08:56.6209619Z +                                        );
2025-11-10T00:08:56.6209745Z                                      }
2025-11-10T00:08:56.6209872Z                                  }
2025-11-10T00:08:56.6210008Z                                  Err(e) => {
2025-11-10T00:08:56.6210453Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:292:
2025-11-10T00:08:56.6210582Z      }
2025-11-10T00:08:56.6210692Z  
2025-11-10T00:08:56.6210883Z      /// Initialize peer connections automatically
2025-11-10T00:08:56.6211006Z -    /// 
2025-11-10T00:08:56.6211121Z +    ///
2025-11-10T00:08:56.6211489Z      /// Determines network type from protocol version and uses config if available.
2025-11-10T00:08:56.6211763Z      async fn initialize_peer_connections(&self) -> Result<()> {
2025-11-10T00:08:56.6211979Z          // Determine network type from protocol version
2025-11-10T00:08:56.6212411Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:306:
2025-11-10T00:08:56.6212586Z                  if let Some(ref config) = self.config {
2025-11-10T00:08:56.6212863Z                      if let Some(ref persistent_peers) = config.persistent_peers {
2025-11-10T00:08:56.6213037Z                          if !persistent_peers.is_empty() {
2025-11-10T00:08:56.6213395Z -                            if let Err(e) = self.network.connect_persistent_peers(persistent_peers).await {
2025-11-10T00:08:56.6213548Z +                            if let Err(e) = self
2025-11-10T00:08:56.6213680Z +                                .network
2025-11-10T00:08:56.6213886Z +                                .connect_persistent_peers(persistent_peers)
2025-11-10T00:08:56.6214017Z +                                .await
2025-11-10T00:08:56.6214142Z +                            {
2025-11-10T00:08:56.6214627Z                                  warn!("Failed to connect to some persistent peers: {}", e);
2025-11-10T00:08:56.6214754Z                              }
2025-11-10T00:08:56.6214876Z                          }
2025-11-10T00:08:56.6215307Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:315:
2025-11-10T00:08:56.6215436Z                  return Ok(());
2025-11-10T00:08:56.6215551Z              }
2025-11-10T00:08:56.6215661Z          };
2025-11-10T00:08:56.6215773Z -        
2025-11-10T00:08:56.6215882Z +
2025-11-10T00:08:56.6216050Z          // Get port from network address
2025-11-10T00:08:56.6216217Z          let port = self.network_addr.port();
2025-11-10T00:08:56.6216326Z -        
2025-11-10T00:08:56.6216430Z +
2025-11-10T00:08:56.6216780Z          // Default target peer count (Bitcoin Core uses 8-125, we'll use 8 as default)
2025-11-10T00:08:56.6216934Z          let target_peer_count = 8;
2025-11-10T00:08:56.6217046Z -        
2025-11-10T00:08:56.6217412Z +
2025-11-10T00:08:56.6217629Z          // Use config if available, otherwise use defaults
2025-11-10T00:08:56.6217796Z          let default_config = NodeConfig {
2025-11-10T00:08:56.6217977Z              listen_addr: Some(self.network_addr),
2025-11-10T00:08:56.6218414Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:328:
2025-11-10T00:08:56.6218563Z              ..Default::default()
2025-11-10T00:08:56.6218676Z          };
2025-11-10T00:08:56.6218953Z          let config = self.config.as_ref().unwrap_or(&default_config);
2025-11-10T00:08:56.6219063Z -        
2025-11-10T00:08:56.6219169Z +
2025-11-10T00:08:56.6219325Z          // Initialize peer connections
2025-11-10T00:08:56.6219568Z -        if let Err(e) = self.network.initialize_peer_connections(
2025-11-10T00:08:56.6219685Z -            config,
2025-11-10T00:08:56.6219804Z -            network,
2025-11-10T00:08:56.6220110Z -            port,
2025-11-10T00:08:56.6220245Z -            target_peer_count,
2025-11-10T00:08:56.6220370Z -        ).await {
2025-11-10T00:08:56.6220511Z +        if let Err(e) = self
2025-11-10T00:08:56.6220625Z +            .network
2025-11-10T00:08:56.6220965Z +            .initialize_peer_connections(config, network, port, target_peer_count)
2025-11-10T00:08:56.6221079Z +            .await
2025-11-10T00:08:56.6223030Z +        {
2025-11-10T00:08:56.6223269Z              warn!("Failed to initialize peer connections: {}", e);
2025-11-10T00:08:56.6223492Z              // Don't fail startup - peer connections are best-effort
2025-11-10T00:08:56.6223599Z          }
2025-11-10T00:08:56.6224018Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:342:
2025-11-10T00:08:56.6224124Z -        
2025-11-10T00:08:56.6224221Z +
2025-11-10T00:08:56.6224469Z          Ok(())
2025-11-10T00:08:56.6224570Z      }
2025-11-10T00:08:56.6224667Z  
2025-11-10T00:08:56.6225086Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:368:
2025-11-10T00:08:56.6225207Z                  ) {
2025-11-10T00:08:56.6225342Z                      Ok(true) => {
2025-11-10T00:08:56.6225574Z                          info!("Block accepted at height {}", current_height);
2025-11-10T00:08:56.6225691Z -                        
2025-11-10T00:08:56.6225786Z +
2025-11-10T00:08:56.6225993Z                          // Persist UTXO set to storage after block validation
2025-11-10T00:08:56.6226287Z                          // This is critical for commitment generation and incremental pruning
2025-11-10T00:08:56.6226544Z                          if let Err(e) = self.storage.utxos().store_utxo_set(&utxo_set) {
2025-11-10T00:08:56.6226973Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:375:
2025-11-10T00:08:56.6227330Z -                            warn!("Failed to persist UTXO set after block {}: {}", current_height, e);
2025-11-10T00:08:56.6227465Z +                            warn!(
2025-11-10T00:08:56.6227686Z +                                "Failed to persist UTXO set after block {}: {}",
2025-11-10T00:08:56.6227858Z +                                current_height, e
2025-11-10T00:08:56.6227985Z +                            );
2025-11-10T00:08:56.6228106Z                          }
2025-11-10T00:08:56.6228227Z -                        
2025-11-10T00:08:56.6228345Z +
2025-11-10T00:08:56.6228611Z                          // Generate UTXO commitment from current state (if enabled)
2025-11-10T00:08:56.6228965Z                          // Use current_height (the block that was just validated) before incrementing
2025-11-10T00:08:56.6229152Z                          #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.6229581Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:381:
2025-11-10T00:08:56.6229702Z                          {
2025-11-10T00:08:56.6229963Z                              if let Some(pruning_manager) = self.storage.pruning() {
2025-11-10T00:08:56.6230202Z -                                if let (Some(commitment_store), Some(_utxostore)) = 
2025-11-10T00:08:56.6230846Z -                                    (pruning_manager.commitment_store(), pruning_manager.utxostore()) 
2025-11-10T00:08:56.6230975Z -                                {
2025-11-10T00:08:56.6231216Z +                                if let (Some(commitment_store), Some(_utxostore)) = (
2025-11-10T00:08:56.6231411Z +                                    pruning_manager.commitment_store(),
2025-11-10T00:08:56.6231593Z +                                    pruning_manager.utxostore(),
2025-11-10T00:08:56.6231729Z +                                ) {
2025-11-10T00:08:56.6232061Z                                      // Get block hash from storage (block was just stored at current_height)
2025-11-10T00:08:56.6232257Z                                      let blocks_arc = self.storage.blocks();
2025-11-10T00:08:56.6232808Z -                                    if let Ok(Some(block_hash)) = blocks_arc.get_hash_by_height(current_height) {
2025-11-10T00:08:56.6232998Z +                                    if let Ok(Some(block_hash)) =
2025-11-10T00:08:56.6233212Z +                                        blocks_arc.get_hash_by_height(current_height)
2025-11-10T00:08:56.6233351Z +                                    {
2025-11-10T00:08:56.6233577Z                                          // Generate commitment from current UTXO set state
2025-11-10T00:08:56.6233901Z -                                        if let Err(e) = pruning_manager.generate_commitment_from_current_state(
2025-11-10T00:08:56.6234056Z -                                            &block_hash,
2025-11-10T00:08:56.6234228Z -                                            current_height,
2025-11-10T00:08:56.6235102Z -                                            &utxo_set,
2025-11-10T00:08:56.6235293Z -                                            &commitment_store,
2025-11-10T00:08:56.6235450Z -                                        ) {
2025-11-10T00:08:56.6235813Z -                                            warn!("Failed to generate commitment for block {}: {}", current_height, e);
2025-11-10T00:08:56.6236002Z +                                        if let Err(e) = pruning_manager
2025-11-10T00:08:56.6236216Z +                                            .generate_commitment_from_current_state(
2025-11-10T00:08:56.6236363Z +                                                &block_hash,
2025-11-10T00:08:56.6236513Z +                                                current_height,
2025-11-10T00:08:56.6236651Z +                                                &utxo_set,
2025-11-10T00:08:56.6236814Z +                                                &commitment_store,
2025-11-10T00:08:56.6236940Z +                                            )
2025-11-10T00:08:56.6237060Z +                                        {
2025-11-10T00:08:56.6237197Z +                                            warn!(
2025-11-10T00:08:56.6237424Z +                                                "Failed to generate commitment for block {}: {}",
2025-11-10T00:08:56.6237584Z +                                                current_height, e
2025-11-10T00:08:56.6237715Z +                                            );
2025-11-10T00:08:56.6237846Z                                          } else {
2025-11-10T00:08:56.6238145Z -                                            debug!("Generated UTXO commitment for block {}", current_height);
2025-11-10T00:08:56.6238286Z +                                            debug!(
2025-11-10T00:08:56.6238485Z +                                                "Generated UTXO commitment for block {}",
2025-11-10T00:08:56.6238643Z +                                                current_height
2025-11-10T00:08:56.6238773Z +                                            );
2025-11-10T00:08:56.6238902Z                                          }
2025-11-10T00:08:56.6239031Z                                      } else {
2025-11-10T00:08:56.6239425Z                                          warn!("Could not find block hash for height {} to generate commitment", current_height);
2025-11-10T00:08:56.6240115Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:403:
2025-11-10T00:08:56.6240232Z                                  }
2025-11-10T00:08:56.6240346Z                              }
2025-11-10T00:08:56.6240465Z                          }
2025-11-10T00:08:56.6240576Z -                        
2025-11-10T00:08:56.6240673Z +
2025-11-10T00:08:56.6240843Z                          // Increment height after processing
2025-11-10T00:08:56.6241090Z                          current_height += 1;
2025-11-10T00:08:56.6241276Z -                        
2025-11-10T00:08:56.6241377Z +
2025-11-10T00:08:56.6241577Z                          // Check for incremental pruning during IBD
2025-11-10T00:08:56.6241895Z                          // Consider IBD if we're still syncing (height < tip or no recent blocks)
2025-11-10T00:08:56.6242492Z                          let is_ibd = current_height < 1000; // Simple heuristic: consider IBD if < 1000 blocks
2025-11-10T00:08:56.6242970Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:413:
2025-11-10T00:08:56.6243216Z                          if let Some(pruning_manager) = self.storage.pruning() {
2025-11-10T00:08:56.6245458Z -                            if let Ok(Some(prune_stats)) = pruning_manager.incremental_prune_during_ibd(current_height, is_ibd) {
2025-11-10T00:08:56.6245641Z +                            if let Ok(Some(prune_stats)) =
2025-11-10T00:08:56.6246008Z +                                pruning_manager.incremental_prune_during_ibd(current_height, is_ibd)
2025-11-10T00:08:56.6246130Z +                            {
2025-11-10T00:08:56.6246488Z                                  info!("Incremental pruning during IBD: {} blocks pruned, {} bytes freed", 
2025-11-10T00:08:56.6246767Z                                        prune_stats.blocks_pruned, prune_stats.storage_freed);
2025-11-10T00:08:56.6246971Z                                  // Flush storage to persist pruning changes
2025-11-10T00:08:56.6247415Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:418:
2025-11-10T00:08:56.6247614Z                                  if let Err(e) = self.storage.flush() {
2025-11-10T00:08:56.6247920Z -                                    warn!("Failed to flush storage after incremental pruning: {}", e);
2025-11-10T00:08:56.6248050Z +                                    warn!(
2025-11-10T00:08:56.6248306Z +                                        "Failed to flush storage after incremental pruning: {}",
2025-11-10T00:08:56.6248436Z +                                        e
2025-11-10T00:08:56.6248563Z +                                    );
2025-11-10T00:08:56.6248685Z                                  }
2025-11-10T00:08:56.6248818Z                              }
2025-11-10T00:08:56.6248934Z                          }
2025-11-10T00:08:56.6249375Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:423:
2025-11-10T00:08:56.6249506Z -                        
2025-11-10T00:08:56.6249614Z +
2025-11-10T00:08:56.6249843Z                          // Check for automatic pruning after block acceptance
2025-11-10T00:08:56.6250092Z                          if let Some(pruning_manager) = self.storage.pruning() {
2025-11-10T00:08:56.6250282Z                              let stats = pruning_manager.get_stats();
2025-11-10T00:08:56.6250716Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:427:
2025-11-10T00:08:56.6250960Z -                            let should_prune = pruning_manager.should_auto_prune(
2025-11-10T00:08:56.6251118Z -                                current_height,
2025-11-10T00:08:56.6251811Z -                                stats.last_prune_height,
2025-11-10T00:08:56.6251942Z -                            );
2025-11-10T00:08:56.6252071Z -                            
2025-11-10T00:08:56.6252265Z +                            let should_prune = pruning_manager
2025-11-10T00:08:56.6252823Z +                                .should_auto_prune(current_height, stats.last_prune_height);
2025-11-10T00:08:56.6252941Z +
2025-11-10T00:08:56.6253097Z                              if should_prune {
2025-11-10T00:08:56.6255291Z                                  info!("Automatic pruning triggered at height {}", current_height);
2025-11-10T00:08:56.6255430Z -                                
2025-11-10T00:08:56.6255537Z +
2025-11-10T00:08:56.6255762Z                                  // Calculate prune height based on configuration
2025-11-10T00:08:56.6256030Z                                  let prune_height = match &pruning_manager.config.mode {
2025-11-10T00:08:56.6256258Z                                      crate::config::PruningMode::Disabled => None,
2025-11-10T00:08:56.6256691Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:438:
2025-11-10T00:08:56.6257232Z -                                    crate::config::PruningMode::Normal { keep_from_height, .. } => {
2025-11-10T00:08:56.6257454Z +                                    crate::config::PruningMode::Normal {
2025-11-10T00:08:56.6257623Z +                                        keep_from_height, ..
2025-11-10T00:08:56.6257754Z +                                    } => {
2025-11-10T00:08:56.6258030Z                                          // Prune to keep_from_height, but ensure we keep min_blocks
2025-11-10T00:08:56.6258294Z                                          let min_keep = pruning_manager.config.min_blocks_to_keep;
2025-11-10T00:08:56.6258712Z -                                        let effective_keep = (*keep_from_height).max(current_height.saturating_sub(min_keep));
2025-11-10T00:08:56.6258916Z +                                        let effective_keep = (*keep_from_height)
2025-11-10T00:08:56.6259136Z +                                            .max(current_height.saturating_sub(min_keep));
2025-11-10T00:08:56.6259307Z                                          Some(effective_keep)
2025-11-10T00:08:56.6259450Z                                      }
2025-11-10T00:08:56.6259630Z                                      #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.6260061Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:445:
2025-11-10T00:08:56.6260475Z -                                    crate::config::PruningMode::Aggressive { keep_from_height, min_blocks, .. } => {
2025-11-10T00:08:56.6260679Z +                                    crate::config::PruningMode::Aggressive {
2025-11-10T00:08:56.6260839Z +                                        keep_from_height,
2025-11-10T00:08:56.6260982Z +                                        min_blocks,
2025-11-10T00:08:56.6261125Z +                                        ..
2025-11-10T00:08:56.6261252Z +                                    } => {
2025-11-10T00:08:56.6261495Z                                          // Prune to keep_from_height, respecting min_blocks
2025-11-10T00:08:56.6261940Z -                                        let effective_keep = (*keep_from_height).max(current_height.saturating_sub(*min_blocks));
2025-11-10T00:08:56.6262141Z +                                        let effective_keep = (*keep_from_height)
2025-11-10T00:08:56.6262375Z +                                            .max(current_height.saturating_sub(*min_blocks));
2025-11-10T00:08:56.6262548Z                                          Some(effective_keep)
2025-11-10T00:08:56.6262677Z                                      }
2025-11-10T00:08:56.6262871Z                                      #[cfg(not(feature = "utxo-commitments"))]
2025-11-10T00:08:56.6263316Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:453:
2025-11-10T00:08:56.6263534Z                                          // Fall back to no pruning if feature is disabled
2025-11-10T00:08:56.6263674Z                                          None
2025-11-10T00:08:56.6265787Z                                      }
2025-11-10T00:08:56.6266395Z -                                    crate::config::PruningMode::Custom { keep_bodies_from_height, .. } => {
2025-11-10T00:08:56.6266587Z +                                    crate::config::PruningMode::Custom {
2025-11-10T00:08:56.6266754Z +                                        keep_bodies_from_height,
2025-11-10T00:08:56.6266886Z +                                        ..
2025-11-10T00:08:56.6267010Z +                                    } => {
2025-11-10T00:08:56.6267272Z                                          // Prune to keep_bodies_from_height, respecting min_blocks
2025-11-10T00:08:56.6267544Z                                          let min_keep = pruning_manager.config.min_blocks_to_keep;
2025-11-10T00:08:56.6268008Z -                                        let effective_keep = (*keep_bodies_from_height).max(current_height.saturating_sub(min_keep));
2025-11-10T00:08:56.6268438Z +                                        let effective_keep = (*keep_bodies_from_height)
2025-11-10T00:08:56.6268683Z +                                            .max(current_height.saturating_sub(min_keep));
2025-11-10T00:08:56.6268847Z                                          Some(effective_keep)
2025-11-10T00:08:56.6268973Z                                      }
2025-11-10T00:08:56.6269096Z                                  };
2025-11-10T00:08:56.6269537Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:463:
2025-11-10T00:08:56.6269663Z -                                
2025-11-10T00:08:56.6269772Z +
2025-11-10T00:08:56.6269993Z                                  if let Some(prune_to_height) = prune_height {
2025-11-10T00:08:56.6270175Z                                      if prune_to_height < current_height {
2025-11-10T00:08:56.6270582Z -                                        match pruning_manager.prune_to_height(prune_to_height, current_height, false) {
2025-11-10T00:08:56.6270796Z +                                        match pruning_manager.prune_to_height(
2025-11-10T00:08:56.6270966Z +                                            prune_to_height,
2025-11-10T00:08:56.6271128Z +                                            current_height,
2025-11-10T00:08:56.6271277Z +                                            false,
2025-11-10T00:08:56.6271412Z +                                        ) {
2025-11-10T00:08:56.6271575Z                                              Ok(prune_stats) => {
2025-11-10T00:08:56.6271927Z                                                  info!("Automatic pruning completed: {} blocks pruned, {} blocks kept", 
2025-11-10T00:08:56.6272198Z                                                        prune_stats.blocks_pruned, prune_stats.blocks_kept);
2025-11-10T00:08:56.6272865Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:596:
2025-11-10T00:08:56.6273002Z      /// Get health report
2025-11-10T00:08:56.6273237Z      pub fn health_check(&self) -> health::HealthReport {
2025-11-10T00:08:56.6273400Z          use crate::node::health::HealthChecker;
2025-11-10T00:08:56.6273509Z -        
2025-11-10T00:08:56.6273618Z +
2025-11-10T00:08:56.6273771Z          let checker = HealthChecker::new();
2025-11-10T00:08:56.6273990Z          let network_healthy = self.network.is_network_active();
2025-11-10T00:08:56.6274474Z          let storage_healthy = self.storage.check_storage_bounds().unwrap_or(false);
2025-11-10T00:08:56.6274901Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:603:
2025-11-10T00:08:56.6275175Z          let rpc_healthy = true; // RPC is always healthy if node is running
2025-11-10T00:08:56.6275294Z -        
2025-11-10T00:08:56.6275403Z +
2025-11-10T00:08:56.6275591Z          // Get metrics if available (simplified for now)
2025-11-10T00:08:56.6275728Z          checker.check_health(
2025-11-10T00:08:56.6275859Z              network_healthy,
2025-11-10T00:08:56.6276333Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/performance.rs:2:
2025-11-10T00:08:56.6276437Z  //!
2025-11-10T00:08:56.6277097Z  //! Provides performance tracking, profiling hooks, and performance metrics collection.
2025-11-10T00:08:56.6277203Z  
2025-11-10T00:08:56.6277357Z +use serde::{Deserialize, Serialize};
2025-11-10T00:08:56.6277476Z  use std::sync::Arc;
2025-11-10T00:08:56.6277603Z  use std::sync::Mutex;
2025-11-10T00:08:56.6277743Z  use std::time::{Duration, Instant};
2025-11-10T00:08:56.6278189Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/performance.rs:8:
2025-11-10T00:08:56.6278336Z -use serde::{Deserialize, Serialize};
2025-11-10T00:08:56.6278443Z  
2025-11-10T00:08:56.6278660Z  /// Performance profiler for tracking operation timings
2025-11-10T00:08:56.6278814Z  pub struct PerformanceProfiler {
2025-11-10T00:08:56.6279291Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/performance.rs:87:
2025-11-10T00:08:56.6279639Z          let total: Duration = times.iter().sum();
2025-11-10T00:08:56.6279785Z          let count = times.len();
2025-11-10T00:08:56.6279949Z          let avg = total / count as u32;
2025-11-10T00:08:56.6280063Z -        
2025-11-10T00:08:56.6280169Z +
2025-11-10T00:08:56.6280317Z          let mut sorted = times.to_vec();
2025-11-10T00:08:56.6280448Z          sorted.sort();
2025-11-10T00:08:56.6280559Z -        
2025-11-10T00:08:56.6280660Z +
2025-11-10T00:08:56.6280802Z          let p50 = sorted[count / 2];
2025-11-10T00:08:56.6280950Z          let p95 = sorted[(count * 95) / 100];
2025-11-10T00:08:56.6281088Z          let p99 = sorted[(count * 99) / 100];
2025-11-10T00:08:56.6281552Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/performance.rs:166:
2025-11-10T00:08:56.6281723Z      /// Stop the timer and record the duration
2025-11-10T00:08:56.6281863Z      pub fn stop(self) -> Duration {
2025-11-10T00:08:56.6282027Z          let duration = self.start.elapsed();
2025-11-10T00:08:56.6282147Z -        
2025-11-10T00:08:56.6282259Z +
2025-11-10T00:08:56.6282411Z          match self.operation_type {
2025-11-10T00:08:56.6282607Z              OperationType::BlockProcessing => {
2025-11-10T00:08:56.6282841Z                  self.profiler.record_block_processing(duration);
2025-11-10T00:08:56.6283320Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/performance.rs:181:
2025-11-10T00:08:56.6283544Z                  self.profiler.record_network_operation(duration);
2025-11-10T00:08:56.6283669Z              }
2025-11-10T00:08:56.6283778Z          }
2025-11-10T00:08:56.6283885Z -        
2025-11-10T00:08:56.6283994Z +
2025-11-10T00:08:56.6284118Z          duration
2025-11-10T00:08:56.6284231Z      }
2025-11-10T00:08:56.6284525Z  }
2025-11-10T00:08:56.6285045Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/performance.rs:191:
2025-11-10T00:08:56.6285225Z          Self::new(1000) // Keep last 1000 samples
2025-11-10T00:08:56.6285333Z      }
2025-11-10T00:08:56.6285450Z  }
2025-11-10T00:08:56.6285562Z -
2025-11-10T00:08:56.6285668Z  
2025-11-10T00:08:56.6286174Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/sync.rs:188:
2025-11-10T00:08:56.6286355Z          metrics: Option<Arc<MetricsCollector>>,
2025-11-10T00:08:56.6286556Z          profiler: Option<Arc<PerformanceProfiler>>,
2025-11-10T00:08:56.6286701Z      ) -> Result<bool> {
2025-11-10T00:08:56.6286883Z -        let _timer = profiler.as_ref().map(|p| {
2025-11-10T00:08:56.6287253Z -            PerformanceTimer::start(Arc::clone(p), OperationType::BlockProcessing)
2025-11-10T00:08:56.6287377Z -        });
2025-11-10T00:08:56.6287510Z +        let _timer = profiler
2025-11-10T00:08:56.6287625Z +            .as_ref()
2025-11-10T00:08:56.6288032Z +            .map(|p| PerformanceTimer::start(Arc::clone(p), OperationType::BlockProcessing));
2025-11-10T00:08:56.6288645Z          let start_time = Instant::now();
2025-11-10T00:08:56.6288761Z  
2025-11-10T00:08:56.6289006Z          // Parse block from wire format (extracts witness data)
2025-11-10T00:08:56.6289456Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/sync.rs:231:
2025-11-10T00:08:56.6289901Z                  metrics.update_performance(|m| {
2025-11-10T00:08:56.6290128Z                      let time_ms = processing_time.as_secs_f64() * 1000.0;
2025-11-10T00:08:56.6290448Z                      // Update average block processing time (exponential moving average)
2025-11-10T00:08:56.6290633Z -                    m.avg_block_processing_time_ms = 
2025-11-10T00:08:56.6290798Z +                    m.avg_block_processing_time_ms =
2025-11-10T00:08:56.6291037Z                          (m.avg_block_processing_time_ms * 0.9) + (time_ms * 0.1);
2025-11-10T00:08:56.6291198Z                      // Update blocks per second
2025-11-10T00:08:56.6298791Z                      if processing_time.as_secs_f64() > 0.0 {
2025-11-10T00:08:56.6299563Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/sync.rs:240:
2025-11-10T00:08:56.6299690Z                  });
2025-11-10T00:08:56.6299806Z              }
2025-11-10T00:08:56.6299916Z  
2025-11-10T00:08:56.6300353Z -            info!("Block validated and stored at height {} (took {:?})", current_height, processing_time);
2025-11-10T00:08:56.6300466Z +            info!(
2025-11-10T00:08:56.6300721Z +                "Block validated and stored at height {} (took {:?})",
2025-11-10T00:08:56.6300893Z +                current_height, processing_time
2025-11-10T00:08:56.6301004Z +            );
2025-11-10T00:08:56.6301117Z              Ok(true)
2025-11-10T00:08:56.6303156Z          } else {
2025-11-10T00:08:56.6303437Z              error!("Block validation failed at height {}", current_height);
2025-11-10T00:08:56.6303869Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:85:
2025-11-10T00:08:56.6304083Z          let elapsed = now.saturating_sub(self.last_refill);
2025-11-10T00:08:56.6304207Z          if elapsed > 0 {
2025-11-10T00:08:56.6304651Z              let tokens_to_add = (elapsed as u32).saturating_mul(self.rate);
2025-11-10T00:08:56.6305011Z -            self.tokens = self.tokens.saturating_add(tokens_to_add).min(self.burst_limit);
2025-11-10T00:08:56.6305136Z +            self.tokens = self
2025-11-10T00:08:56.6305244Z +                .tokens
2025-11-10T00:08:56.6305390Z +                .saturating_add(tokens_to_add)
2025-11-10T00:08:56.6305532Z +                .min(self.burst_limit);
2025-11-10T00:08:56.6305663Z              self.last_refill = now;
2025-11-10T00:08:56.6305763Z          }
2025-11-10T00:08:56.6305871Z  
2025-11-10T00:08:56.6306271Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:134:
2025-11-10T00:08:56.6306369Z      }
2025-11-10T00:08:56.6306465Z  
2025-11-10T00:08:56.6306609Z      /// Create with custom rate limits
2025-11-10T00:08:56.6306738Z -    pub fn with_rate_limits(
2025-11-10T00:08:56.6306869Z -        auth_required: bool,
2025-11-10T00:08:56.6307022Z -        default_burst: u32,
2025-11-10T00:08:56.6307154Z -        default_rate: u32,
2025-11-10T00:08:56.6307281Z -    ) -> Self {
2025-11-10T00:08:56.6307713Z +    pub fn with_rate_limits(auth_required: bool, default_burst: u32, default_rate: u32) -> Self {
2025-11-10T00:08:56.6307840Z          Self {
2025-11-10T00:08:56.6308070Z              valid_tokens: Arc::new(Mutex::new(HashMap::new())),
2025-11-10T00:08:56.6308332Z              valid_certificates: Arc::new(Mutex::new(HashMap::new())),
2025-11-10T00:08:56.6308768Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:154:
2025-11-10T00:08:56.6309019Z          let user_id = UserId::Token(AuthToken::new(token.clone()));
2025-11-10T00:08:56.6309218Z          let mut tokens = self.valid_tokens.lock().await;
2025-11-10T00:08:56.6309401Z          tokens.insert(token, user_id.clone());
2025-11-10T00:08:56.6309511Z -        
2025-11-10T00:08:56.6309622Z +
2025-11-10T00:08:56.6309793Z          // Initialize rate limiter for this user
2025-11-10T00:08:56.6310084Z          let (burst, rate) = self.get_rate_limit_for_user(&user_id).await;
2025-11-10T00:08:56.6310569Z          let mut limiters = self.rate_limiters.lock().await;
2025-11-10T00:08:56.6311010Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:161:
2025-11-10T00:08:56.6311303Z          limiters.insert(user_id, RpcRateLimiter::new(burst, rate));
2025-11-10T00:08:56.6311424Z -        
2025-11-10T00:08:56.6311533Z +
2025-11-10T00:08:56.6311661Z          Ok(())
2025-11-10T00:08:56.6311769Z      }
2025-11-10T00:08:56.6311875Z  
2025-11-10T00:08:56.6312307Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:178:
2025-11-10T00:08:56.6312560Z          let user_id = UserId::Certificate(fingerprint.clone());
2025-11-10T00:08:56.6314797Z          let mut certs = self.valid_certificates.lock().await;
2025-11-10T00:08:56.6314998Z          certs.insert(fingerprint, user_id.clone());
2025-11-10T00:08:56.6315123Z -        
2025-11-10T00:08:56.6315446Z +
2025-11-10T00:08:56.6315620Z          // Initialize rate limiter for this user
2025-11-10T00:08:56.6315899Z          let (burst, rate) = self.get_rate_limit_for_user(&user_id).await;
2025-11-10T00:08:56.6316109Z          let mut limiters = self.rate_limiters.lock().await;
2025-11-10T00:08:56.6316543Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:185:
2025-11-10T00:08:56.6316827Z          limiters.insert(user_id, RpcRateLimiter::new(burst, rate));
2025-11-10T00:08:56.6316947Z -        
2025-11-10T00:08:56.6317054Z +
2025-11-10T00:08:56.6317159Z          Ok(())
2025-11-10T00:08:56.6317270Z      }
2025-11-10T00:08:56.6317377Z  
2025-11-10T00:08:56.6317788Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:201:
2025-11-10T00:08:56.6318121Z      pub async fn set_user_rate_limit(&self, user_id: &UserId, burst: u32, rate: u32) {
2025-11-10T00:08:56.6318348Z          let mut limits = self.user_rate_limits.lock().await;
2025-11-10T00:08:56.6318554Z          limits.insert(user_id.clone(), (burst, rate));
2025-11-10T00:08:56.6318668Z -        
2025-11-10T00:08:56.6318782Z +
2025-11-10T00:08:56.6318961Z          // Update existing rate limiter if present
2025-11-10T00:08:56.6319170Z          let mut limiters = self.rate_limiters.lock().await;
2025-11-10T00:08:56.6319371Z          if let Some(limiter) = limiters.get_mut(user_id) {
2025-11-10T00:08:56.6319809Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:212:
2025-11-10T00:08:56.6320059Z      /// Get rate limit for a user (checks per-user limits first)
2025-11-10T00:08:56.6320360Z      async fn get_rate_limit_for_user(&self, user_id: &UserId) -> (u32, u32) {
2025-11-10T00:08:56.6320565Z          let limits = self.user_rate_limits.lock().await;
2025-11-10T00:08:56.6320845Z -        limits.get(user_id).copied().unwrap_or(self.default_rate_limit)
2025-11-10T00:08:56.6320959Z +        limits
2025-11-10T00:08:56.6321106Z +            .get(user_id)
2025-11-10T00:08:56.6321227Z +            .copied()
2025-11-10T00:08:56.6321387Z +            .unwrap_or(self.default_rate_limit)
2025-11-10T00:08:56.6321486Z      }
2025-11-10T00:08:56.6321601Z  
2025-11-10T00:08:56.6321775Z      /// Authenticate a request from HTTP headers
2025-11-10T00:08:56.6322203Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:283:
2025-11-10T00:08:56.6322358Z      /// Check rate limit for a user
2025-11-10T00:08:56.6322626Z      pub async fn check_rate_limit(&self, user_id: &UserId) -> bool {
2025-11-10T00:08:56.6322816Z          let mut limiters = self.rate_limiters.lock().await;
2025-11-10T00:08:56.6322919Z -        
2025-11-10T00:08:56.6323028Z +
2025-11-10T00:08:56.6323193Z          // Get or create rate limiter for this user
2025-11-10T00:08:56.6323476Z          let limiter = limiters.entry(user_id.clone()).or_insert_with(|| {
2025-11-10T00:08:56.6323665Z              let (burst, rate) = self.default_rate_limit;
2025-11-10T00:08:56.6324091Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:290:
2025-11-10T00:08:56.6324702Z              RpcRateLimiter::new(burst, rate)
2025-11-10T00:08:56.6324828Z          });
2025-11-10T00:08:56.6324939Z -        
2025-11-10T00:08:56.6325043Z +
2025-11-10T00:08:56.6325193Z          limiter.check_and_consume()
2025-11-10T00:08:56.6325302Z      }
2025-11-10T00:08:56.6325402Z  
2025-11-10T00:08:56.6325830Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:311:
2025-11-10T00:08:56.6326100Z          auth.add_token("test-token-123".to_string()).await.unwrap();
2025-11-10T00:08:56.6326204Z  
2025-11-10T00:08:56.6326383Z          let mut headers = hyper::HeaderMap::new();
2025-11-10T00:08:56.6326518Z -        headers.insert(
2025-11-10T00:08:56.6326660Z -            "authorization",
2025-11-10T00:08:56.6327518Z -            "***".parse().unwrap(),
2025-11-10T00:08:56.6327647Z -        );
2025-11-10T00:08:56.6328356Z +        headers.insert("authorization", "***".parse().unwrap());
2025-11-10T00:08:56.6328484Z  
2025-11-10T00:08:56.6328750Z          let addr: SocketAddr = "127.0.0.1:8080".parse().unwrap();
2025-11-10T00:08:56.6329005Z          let result = auth.authenticate_request(&headers, addr).await;
2025-11-10T00:08:56.6329436Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:329:
2025-11-10T00:08:56.6329681Z          auth.add_token("valid-token".to_string()).await.unwrap();
2025-11-10T00:08:56.6329798Z  
2025-11-10T00:08:56.6329991Z          let mut headers = hyper::HeaderMap::new();
2025-11-10T00:08:56.6330128Z -        headers.insert(
2025-11-10T00:08:56.6330275Z -            "authorization",
2025-11-10T00:08:56.6330517Z -            "***".parse().unwrap(),
2025-11-10T00:08:56.6330622Z -        );
2025-11-10T00:08:56.6330978Z +        headers.insert("authorization", "***".parse().unwrap());
2025-11-10T00:08:56.6331087Z  
2025-11-10T00:08:56.6333068Z          let addr: SocketAddr = "127.0.0.1:8080".parse().unwrap();
2025-11-10T00:08:56.6333327Z          let result = auth.authenticate_request(&headers, addr).await;
2025-11-10T00:08:56.6333750Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:368:
2025-11-10T00:08:56.6333899Z          assert!(result.error.is_none());
2025-11-10T00:08:56.6334018Z      }
2025-11-10T00:08:56.6334123Z  }
2025-11-10T00:08:56.6334227Z -
2025-11-10T00:08:56.6334511Z  
2025-11-10T00:08:56.6535682Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:30:
2025-11-10T00:08:56.6535863Z  
2025-11-10T00:08:56.6536021Z      /// Create with dependencies
2025-11-10T00:08:56.6536277Z      pub fn with_dependencies(storage: Arc<Storage>) -> Self {
2025-11-10T00:08:56.6536439Z -        Self { storage: Some(storage) }
2025-11-10T00:08:56.6536567Z +        Self {
2025-11-10T00:08:56.6536713Z +            storage: Some(storage),
2025-11-10T00:08:56.6536830Z +        }
2025-11-10T00:08:56.6536954Z      }
2025-11-10T00:08:56.6537063Z  
2025-11-10T00:08:56.6537328Z      /// Calculate difficulty from bits (compact target format)
2025-11-10T00:08:56.6538210Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:39:
2025-11-10T00:08:56.6538701Z          // MAX_TARGET for Bitcoin mainnet is 0x00000000FFFF0000000000000000000000000000000000000000000000000000
2025-11-10T00:08:56.6538992Z          // But we use a simpler calculation: difficulty = 2^256 / (target + 1)
2025-11-10T00:08:56.6539278Z          // For display purposes, we normalize to genesis difficulty = 1.0
2025-11-10T00:08:56.6539733Z -        const MAX_TARGET: u128 = 0x00000000FFFF0000000000000000000000000000000000000000000000000000u128;
2025-11-10T00:08:56.6539849Z -        
2025-11-10T00:08:56.6539994Z +        const MAX_TARGET: u128 =
2025-11-10T00:08:56.6540330Z +            0x00000000FFFF0000000000000000000000000000000000000000000000000000u128;
2025-11-10T00:08:56.6540441Z +
2025-11-10T00:08:56.6540615Z          // Simplified difficulty calculation
2025-11-10T00:08:56.6540900Z          // For display purposes, use a simple approximation based on bits
2025-11-10T00:08:56.6541347Z          if let Ok(_target) = expand_target(bits) {
2025-11-10T00:08:56.6541815Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:73:
2025-11-10T00:08:56.6542018Z      fn calculate_block_subsidy(height: u64) -> u64 {
2025-11-10T00:08:56.6542297Z          const INITIAL_SUBSIDY: u64 = 50_000_000_000; // 50 BTC in satoshis
2025-11-10T00:08:56.6542458Z          const HALVING_INTERVAL: u64 = 210_000;
2025-11-10T00:08:56.6542570Z -        
2025-11-10T00:08:56.6542690Z +
2025-11-10T00:08:56.6542863Z          let halvings = height / HALVING_INTERVAL;
2025-11-10T00:08:56.6542963Z -        
2025-11-10T00:08:56.6543068Z +
2025-11-10T00:08:56.6545288Z          // Subsidy halves each halving, but can't go below 0
2025-11-10T00:08:56.6545423Z          if halvings >= 64 {
2025-11-10T00:08:56.6545853Z              // After 64 halvings, subsidy is 0 (satoshi precision limit)
2025-11-10T00:08:56.6546342Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:82:
2025-11-10T00:08:56.6546465Z              return 0;
2025-11-10T00:08:56.6546572Z          }
2025-11-10T00:08:56.6546679Z -        
2025-11-10T00:08:56.6546789Z +
2025-11-10T00:08:56.6546927Z          INITIAL_SUBSIDY >> halvings
2025-11-10T00:08:56.6547024Z      }
2025-11-10T00:08:56.6547130Z  
2025-11-10T00:08:56.6547605Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:88:
2025-11-10T00:08:56.6547869Z      /// Calculate hash_serialized_2 for UTXO set (double SHA256)
2025-11-10T00:08:56.6547994Z -    /// 
2025-11-10T00:08:56.6548108Z +    ///
2025-11-10T00:08:56.6548447Z      /// Serializes UTXO set deterministically and computes double SHA256 hash.
2025-11-10T00:08:56.6548832Z      /// Matches Bitcoin Core's gettxoutsetinfo hash_serialized_2 calculation.
2025-11-10T00:08:56.6549217Z      fn calculate_utxo_set_hash(utxo_set: &bllvm_protocol::UtxoSet) -> [u8; 32] {
2025-11-10T00:08:56.6549695Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:93:
2025-11-10T00:08:56.6549858Z -        use sha2::{Sha256, Digest};
2025-11-10T00:08:56.6550059Z          use crate::storage::hashing::double_sha256;
2025-11-10T00:08:56.6550176Z -        
2025-11-10T00:08:56.6550321Z +        use sha2::{Digest, Sha256};
2025-11-10T00:08:56.6550430Z +
2025-11-10T00:08:56.6550797Z          // Sort UTXOs for deterministic hashing (by outpoint: hash first, then index)
2025-11-10T00:08:56.6551117Z          let mut entries: Vec<_> = utxo_set.iter().collect();
2025-11-10T00:08:56.6551278Z -        entries.sort_by(|(a, _), (b, _)| {
2025-11-10T00:08:56.6551442Z -            match a.hash.cmp(&b.hash) {
2025-11-10T00:08:56.6551670Z -                std::cmp::Ordering::Equal => a.index.cmp(&b.index),
2025-11-10T00:08:56.6551802Z -                other => other,
2025-11-10T00:08:56.6551926Z -            }
2025-11-10T00:08:56.6552189Z +        entries.sort_by(|(a, _), (b, _)| match a.hash.cmp(&b.hash) {
2025-11-10T00:08:56.6552415Z +            std::cmp::Ordering::Equal => a.index.cmp(&b.index),
2025-11-10T00:08:56.6552545Z +            other => other,
2025-11-10T00:08:56.6552666Z          });
2025-11-10T00:08:56.6552776Z -        
2025-11-10T00:08:56.6552883Z +
2025-11-10T00:08:56.6553038Z          // Serialize each UTXO entry
2025-11-10T00:08:56.6553191Z          let mut serialized = Vec::new();
2025-11-10T00:08:56.6553351Z          for (outpoint, utxo) in entries {
2025-11-10T00:08:56.6553833Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:108:
2025-11-10T00:08:56.6554147Z              // Serialize outpoint (32-byte hash + 8-byte index, little-endian)
2025-11-10T00:08:56.6554550Z              serialized.extend_from_slice(&outpoint.hash);
2025-11-10T00:08:56.6554846Z              serialized.extend_from_slice(&outpoint.index.to_le_bytes());
2025-11-10T00:08:56.6554968Z -            
2025-11-10T00:08:56.6555087Z +
2025-11-10T00:08:56.6555440Z              // Serialize UTXO (8-byte value + script_pubkey + 8-byte height, little-endian)
2025-11-10T00:08:56.6555963Z              serialized.extend_from_slice(&utxo.value.to_le_bytes());
2025-11-10T00:08:56.6556202Z              serialized.extend_from_slice(&utxo.script_pubkey);
2025-11-10T00:08:56.6556680Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:115:
2025-11-10T00:08:56.6556937Z              serialized.extend_from_slice(&utxo.height.to_le_bytes());
2025-11-10T00:08:56.6557064Z          }
2025-11-10T00:08:56.6557176Z -        
2025-11-10T00:08:56.6557286Z +
2025-11-10T00:08:56.6557434Z          // Double SHA256 hash
2025-11-10T00:08:56.6557583Z          double_sha256(&serialized)
2025-11-10T00:08:56.6557692Z      }
2025-11-10T00:08:56.6558161Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:121:
2025-11-10T00:08:56.6558279Z -    
2025-11-10T00:08:56.6558602Z +
2025-11-10T00:08:56.6558796Z      /// Calculate confirmations for a block
2025-11-10T00:08:56.6559139Z      fn calculate_confirmations(block_height: u64, tip_height: u64) -> i64 {
2025-11-10T00:08:56.6559291Z          if block_height > tip_height {
2025-11-10T00:08:56.6559765Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:222:
2025-11-10T00:08:56.6559878Z              }))
2025-11-10T00:08:56.6559990Z          } else {
2025-11-10T00:08:56.6560324Z              // Graceful degradation: return default values when storage unavailable
2025-11-10T00:08:56.6560829Z -            tracing::debug!("getblockchaininfo called but storage not available, returning default values");
2025-11-10T00:08:56.6560968Z +            tracing::debug!(
2025-11-10T00:08:56.6561358Z +                "getblockchaininfo called but storage not available, returning default values"
2025-11-10T00:08:56.6561478Z +            );
2025-11-10T00:08:56.6561599Z              Ok(json!({
2025-11-10T00:08:56.6561738Z                  "chain": "main",
2025-11-10T00:08:56.6561870Z                  "blocks": 0,
2025-11-10T00:08:56.6562333Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:311:
2025-11-10T00:08:56.6562577Z          debug!("RPC: getblockheader {} verbose={}", hash, verbose);
2025-11-10T00:08:56.6562686Z  
2025-11-10T00:08:56.6562871Z          if let Some(ref storage) = self.storage {
2025-11-10T00:08:56.6563043Z -            let hash_bytes = hex::decode(hash)
2025-11-10T00:08:56.6563268Z -                .map_err(|e| anyhow::anyhow!("Invalid hash: {}", e))?;
2025-11-10T00:08:56.6563406Z +            let hash_bytes =
2025-11-10T00:08:56.6563697Z +                hex::decode(hash).map_err(|e| anyhow::anyhow!("Invalid hash: {}", e))?;
2025-11-10T00:08:56.6563835Z              if hash_bytes.len() != 32 {
2025-11-10T00:08:56.6564054Z                  return Err(anyhow::anyhow!("Invalid hash length"));
2025-11-10T00:08:56.6564161Z              }
2025-11-10T00:08:56.6564815Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:319:
2025-11-10T00:08:56.6564977Z              let mut hash_array = [0u8; 32];
2025-11-10T00:08:56.6565161Z              hash_array.copy_from_slice(&hash_bytes);
2025-11-10T00:08:56.6565267Z -            
2025-11-10T00:08:56.6565370Z +
2025-11-10T00:08:56.6565641Z              if let Ok(Some(header)) = storage.blocks().get_header(&hash_array) {
2025-11-10T00:08:56.6565766Z                  if verbose {
2025-11-10T00:08:56.6567956Z                      // Find block height by searching height index
2025-11-10T00:08:56.6568415Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:360:
2025-11-10T00:08:56.6568516Z  
2025-11-10T00:08:56.6568657Z                      // Find next block hash
2025-11-10T00:08:56.6568860Z                      let next_blockhash = block_height.and_then(|h| {
2025-11-10T00:08:56.6569008Z -                        storage.blocks()
2025-11-10T00:08:56.6569135Z +                        storage
2025-11-10T00:08:56.6569412Z +                            .blocks()
2025-11-10T00:08:56.6569815Z                              .get_hash_by_height(h + 1)
2025-11-10T00:08:56.6569940Z                              .ok()
2025-11-10T00:08:56.6570068Z                              .flatten()
2025-11-10T00:08:56.6570538Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:380:
2025-11-10T00:08:56.6570652Z                          }
2025-11-10T00:08:56.6570819Z                          Self::format_chainwork(total_work)
2025-11-10T00:08:56.6570929Z                      } else {
2025-11-10T00:08:56.6571290Z -                        "0000000000000000000000000000000000000000000000000000000000000000".to_string()
2025-11-10T00:08:56.6571567Z +                        "0000000000000000000000000000000000000000000000000000000000000000"
2025-11-10T00:08:56.6571702Z +                            .to_string()
2025-11-10T00:08:56.6571999Z                      };
2025-11-10T00:08:56.6572111Z  
2025-11-10T00:08:56.6572223Z                      Ok(json!({
2025-11-10T00:08:56.6572907Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:443:
2025-11-10T00:08:56.6573133Z              if let Ok(Some(hash)) = storage.chain().get_tip_hash() {
2025-11-10T00:08:56.6573276Z                  Ok(json!(hex::encode(hash)))
2025-11-10T00:08:56.6573377Z              } else {
2025-11-10T00:08:56.6573695Z -                Ok(json!("0000000000000000000000000000000000000000000000000000000000000000"))
2025-11-10T00:08:56.6573817Z +                Ok(json!(
2025-11-10T00:08:56.6574066Z +                    "0000000000000000000000000000000000000000000000000000000000000000"
2025-11-10T00:08:56.6574175Z +                ))
2025-11-10T00:08:56.6574441Z              }
2025-11-10T00:08:56.6574546Z          } else {
2025-11-10T00:08:56.6574837Z -            Ok(json!("0000000000000000000000000000000000000000000000000000000000000000"))
2025-11-10T00:08:56.6574958Z +            Ok(json!(
2025-11-10T00:08:56.6575209Z +                "0000000000000000000000000000000000000000000000000000000000000000"
2025-11-10T00:08:56.6577189Z +            ))
2025-11-10T00:08:56.6577294Z          }
2025-11-10T00:08:56.6577389Z      }
2025-11-10T00:08:56.6577483Z  
2025-11-10T00:08:56.6577914Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:494:
2025-11-10T00:08:56.6578093Z              let utxos = storage.utxos().get_all_utxos()?;
2025-11-10T00:08:56.6578224Z              let txouts = utxos.len();
2025-11-10T00:08:56.6578526Z              let total_amount: u64 = utxos.values().map(|utxo| utxo.value as u64).sum();
2025-11-10T00:08:56.6578648Z -            
2025-11-10T00:08:56.6578752Z +
2025-11-10T00:08:56.6579059Z              // Calculate hash_serialized_2 (double SHA256 of serialized UTXO set)
2025-11-10T00:08:56.6579344Z              let hash_serialized_2 = Self::calculate_utxo_set_hash(&utxos);
2025-11-10T00:08:56.6579460Z  
2025-11-10T00:08:56.6579928Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:540:
2025-11-10T00:08:56.6580278Z              // Use protocol engine which provides the correct validate_block signature
2025-11-10T00:08:56.6580599Z              let engine = BitcoinProtocolEngine::new(ProtocolVersion::Regtest)
2025-11-10T00:08:56.6580918Z                  .map_err(|e| anyhow::anyhow!("Failed to create protocol engine: {}", e))?;
2025-11-10T00:08:56.6581030Z -            
2025-11-10T00:08:56.6581146Z +
2025-11-10T00:08:56.6581329Z              let check_level = checklevel.unwrap_or(3);
2025-11-10T00:08:56.6581507Z              let num_blocks = numblocks.unwrap_or(288);
2025-11-10T00:08:56.6581625Z -            
2025-11-10T00:08:56.6581733Z +
2025-11-10T00:08:56.6581976Z              let tip_height = storage.chain().get_height()?.unwrap_or(0);
2025-11-10T00:08:56.6582111Z              if tip_height == 0 {
2025-11-10T00:08:56.6582314Z                  return Ok(json!(true)); // Empty chain is valid
2025-11-10T00:08:56.6582779Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:557:
2025-11-10T00:08:56.6583126Z              };
2025-11-10T00:08:56.6583241Z  
2025-11-10T00:08:56.6583394Z              let mut errors = Vec::new();
2025-11-10T00:08:56.6583606Z -            let mut utxo_set = storage.utxos().get_all_utxos()
2025-11-10T00:08:56.6583756Z +            let mut utxo_set = storage
2025-11-10T00:08:56.6583877Z +                .utxos()
2025-11-10T00:08:56.6584003Z +                .get_all_utxos()
2025-11-10T00:08:56.6584262Z                  .map_err(|e| anyhow::anyhow!("Failed to get UTXO set: {}", e))?;
2025-11-10T00:08:56.6584585Z  
2025-11-10T00:08:56.6586731Z              // Verify blocks from start_height to tip
2025-11-10T00:08:56.6587206Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:572:
2025-11-10T00:08:56.6587376Z                                  // For now, just continue
2025-11-10T00:08:56.6587739Z                              }
2025-11-10T00:08:56.6588025Z                              Ok(bllvm_protocol::ValidationResult::Invalid(reason)) => {
2025-11-10T00:08:56.6588365Z -                                errors.push(format!("Block at height {} invalid: {}", height, reason));
2025-11-10T00:08:56.6588531Z +                                errors.push(format!(
2025-11-10T00:08:56.6588708Z +                                    "Block at height {} invalid: {}",
2025-11-10T00:08:56.6588852Z +                                    height, reason
2025-11-10T00:08:56.6588985Z +                                ));
2025-11-10T00:08:56.6589144Z                                  if check_level >= 4 {
2025-11-10T00:08:56.6589321Z                                      // Level 4: Stop on first error
2025-11-10T00:08:56.6589467Z                                      break;
2025-11-10T00:08:56.6590376Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:579:
2025-11-10T00:08:56.6590519Z                                  }
2025-11-10T00:08:56.6590654Z                              }
2025-11-10T00:08:56.6590788Z                              Err(e) => {
2025-11-10T00:08:56.6591148Z -                                errors.push(format!("Block at height {} validation error: {}", height, e));
2025-11-10T00:08:56.6591315Z +                                errors.push(format!(
2025-11-10T00:08:56.6591518Z +                                    "Block at height {} validation error: {}",
2025-11-10T00:08:56.6591659Z +                                    height, e
2025-11-10T00:08:56.6591781Z +                                ));
2025-11-10T00:08:56.6591942Z                                  if check_level >= 4 {
2025-11-10T00:08:56.6592072Z                                      break;
2025-11-10T00:08:56.6592195Z                                  }
2025-11-10T00:08:56.6592663Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:588:
2025-11-10T00:08:56.6592778Z  
2025-11-10T00:08:56.6592960Z                          // Check level 3: Verify block header linkage
2025-11-10T00:08:56.6593121Z                          if check_level >= 3 && height > 0 {
2025-11-10T00:08:56.6593464Z -                            if let Ok(Some(prev_hash)) = storage.blocks().get_hash_by_height(height - 1) {
2025-11-10T00:08:56.6593618Z +                            if let Ok(Some(prev_hash)) =
2025-11-10T00:08:56.6593826Z +                                storage.blocks().get_hash_by_height(height - 1)
2025-11-10T00:08:56.6593946Z +                            {
2025-11-10T00:08:56.6594144Z                                  if block.header.prev_block_hash != prev_hash {
2025-11-10T00:08:56.6594291Z                                      errors.push(format!(
2025-11-10T00:08:56.6594793Z                                          "Block at height {} has incorrect prev_block_hash: expected {}, got {}",
2025-11-10T00:08:56.6595251Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:606:
2025-11-10T00:08:56.6595427Z                          // Check level 2: Verify merkle root
2025-11-10T00:08:56.6595794Z                          if check_level >= 2 {
2025-11-10T00:08:56.6596028Z                              use bllvm_protocol::mining::calculate_merkle_root;
2025-11-10T00:08:56.6596349Z -                            if let Ok(calculated_root) = calculate_merkle_root(&block.transactions) {
2025-11-10T00:08:56.6596649Z +                            if let Ok(calculated_root) = calculate_merkle_root(&block.transactions)
2025-11-10T00:08:56.6596773Z +                            {
2025-11-10T00:08:56.6596982Z                                  if calculated_root != block.header.merkle_root {
2025-11-10T00:08:56.6597141Z                                      errors.push(format!(
2025-11-10T00:08:56.6597355Z                                          "Block at height {} has incorrect merkle root",
2025-11-10T00:08:56.6597992Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:657:
2025-11-10T00:08:56.6598164Z          if let Some(ref storage) = self.storage {
2025-11-10T00:08:56.6598336Z              // Get all chain tips (including forks)
2025-11-10T00:08:56.6598477Z              let mut tips = Vec::new();
2025-11-10T00:08:56.6598582Z -            
2025-11-10T00:08:56.6598685Z +
2025-11-10T00:08:56.6598817Z              // Add active tip
2025-11-10T00:08:56.6599061Z              if let Ok(Some(tip_hash)) = storage.chain().get_tip_hash() {
2025-11-10T00:08:56.6599323Z                  let tip_height = storage.chain().get_height()?.unwrap_or(0);
2025-11-10T00:08:56.6599790Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:668:
2025-11-10T00:08:56.6599926Z                      "status": "active"
2025-11-10T00:08:56.6600041Z                  }));
2025-11-10T00:08:56.6600160Z              }
2025-11-10T00:08:56.6600270Z -            
2025-11-10T00:08:56.6600368Z +
2025-11-10T00:08:56.6600529Z              // Add other tracked tips (forks, etc.)
2025-11-10T00:08:56.6600756Z              if let Ok(chain_tips) = storage.chain().get_chain_tips() {
2025-11-10T00:08:56.6600971Z                  for (hash, height, branchlen, status) in chain_tips {
2025-11-10T00:08:56.6601419Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:678:
2025-11-10T00:08:56.6601567Z                              continue;
2025-11-10T00:08:56.6601690Z                          }
2025-11-10T00:08:56.6601805Z                      }
2025-11-10T00:08:56.6601918Z -                    
2025-11-10T00:08:56.6602036Z +
2025-11-10T00:08:56.6602177Z                      tips.push(json!({
2025-11-10T00:08:56.6602316Z                          "height": height,
2025-11-10T00:08:56.6602489Z                          "hash": hex::encode(hash),
2025-11-10T00:08:56.6602956Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:687:
2025-11-10T00:08:56.6603082Z                      }));
2025-11-10T00:08:56.6603200Z                  }
2025-11-10T00:08:56.6603324Z              }
2025-11-10T00:08:56.6603432Z -            
2025-11-10T00:08:56.6603537Z +
2025-11-10T00:08:56.6605690Z              Ok(json!(tips))
2025-11-10T00:08:56.6605811Z          } else {
2025-11-10T00:08:56.6605938Z              Ok(json!([]))
2025-11-10T00:08:56.6606407Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:700:
2025-11-10T00:08:56.6606734Z      pub async fn get_chain_tx_stats(&self, params: &Value) -> Result<Value> {
2025-11-10T00:08:56.6606892Z          debug!("RPC: getchaintxstats");
2025-11-10T00:08:56.6606998Z  
2025-11-10T00:08:56.6607147Z -        let nblocks = params
2025-11-10T00:08:56.6607267Z -            .get(0)
2025-11-10T00:08:56.6607416Z -            .and_then(|p| p.as_u64())
2025-11-10T00:08:56.6607673Z -            .unwrap_or(144); // Default: 1 day (144 blocks at 10 min/block)
2025-11-10T00:08:56.6608170Z +        let nblocks = params.get(0).and_then(|p| p.as_u64()).unwrap_or(144); // Default: 1 day (144 blocks at 10 min/block)
2025-11-10T00:08:56.6608534Z  
2025-11-10T00:08:56.6608715Z          if let Some(ref storage) = self.storage {
2025-11-10T00:08:56.6608981Z              let tip_height = storage.chain().get_height()?.unwrap_or(0);
2025-11-10T00:08:56.6609453Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:710:
2025-11-10T00:08:56.6609567Z -            
2025-11-10T00:08:56.6609684Z +
2025-11-10T00:08:56.6609819Z              if tip_height == 0 {
2025-11-10T00:08:56.6609951Z                  return Ok(json!({
2025-11-10T00:08:56.6610079Z                      "time": 0,
2025-11-10T00:08:56.6610549Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:729:
2025-11-10T00:08:56.6610727Z              // Get timestamps and transaction counts
2025-11-10T00:08:56.6610902Z              let mut timestamps = Vec::new();
2025-11-10T00:08:56.6611288Z              let mut tx_counts = Vec::new();
2025-11-10T00:08:56.6611419Z -            
2025-11-10T00:08:56.6611538Z +
2025-11-10T00:08:56.6611733Z              for height in start_height..=tip_height {
2025-11-10T00:08:56.6612024Z                  if let Ok(Some(hash)) = storage.blocks().get_hash_by_height(height) {
2025-11-10T00:08:56.6612271Z                      if let Ok(Some(block)) = storage.blocks().get_block(&hash) {
2025-11-10T00:08:56.6612742Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:756:
2025-11-10T00:08:56.6613077Z              let window_interval = last_timestamp.saturating_sub(first_timestamp);
2025-11-10T00:08:56.6613288Z              let window_tx_count: u64 = tx_counts.iter().sum();
2025-11-10T00:08:56.6613492Z              let window_block_count = timestamps.len() as u64;
2025-11-10T00:08:56.6613602Z -            
2025-11-10T00:08:56.6613701Z +
2025-11-10T00:08:56.6613854Z              let txrate = if window_interval > 0 {
2025-11-10T00:08:56.6614057Z                  window_tx_count as f64 / window_interval as f64
2025-11-10T00:08:56.6614167Z              } else {
2025-11-10T00:08:56.6614803Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:794:
2025-11-10T00:08:56.6615098Z      pub async fn get_block_stats(&self, params: &Value) -> Result<Value> {
2025-11-10T00:08:56.6615254Z          debug!("RPC: getblockstats");
2025-11-10T00:08:56.6615355Z  
2025-11-10T00:08:56.6615562Z -        let hash_or_height: Option<String> = params.get(0)
2025-11-10T00:08:56.6615749Z +        let hash_or_height: Option<String> = params
2025-11-10T00:08:56.6615857Z +            .get(0)
2025-11-10T00:08:56.6615993Z              .and_then(|p| p.as_str())
2025-11-10T00:08:56.6616121Z              .map(|s| s.to_string())
2025-11-10T00:08:56.6616247Z              .or_else(|| {
2025-11-10T00:08:56.6616735Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:801:
2025-11-10T00:08:56.6616876Z -                params.get(0)
2025-11-10T00:08:56.6617019Z +                params
2025-11-10T00:08:56.6617147Z +                    .get(0)
2025-11-10T00:08:56.6617301Z                      .and_then(|p| p.as_u64())
2025-11-10T00:08:56.6617449Z                      .map(|h| h.to_string())
2025-11-10T00:08:56.6617564Z              });
2025-11-10T00:08:56.6618036Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:808:
2025-11-10T00:08:56.6618263Z              let block_hash = if let Some(hoh) = hash_or_height {
2025-11-10T00:08:56.6618847Z                  // Try to parse as height first
2025-11-10T00:08:56.6619058Z                  if let Ok(height) = hoh.parse::<u64>() {
2025-11-10T00:08:56.6619247Z -                    storage.blocks().get_hash_by_height(height)?
2025-11-10T00:08:56.6619368Z +                    storage
2025-11-10T00:08:56.6619489Z +                        .blocks()
2025-11-10T00:08:56.6619643Z +                        .get_hash_by_height(height)?
2025-11-10T00:08:56.6619968Z                          .ok_or_else(|| anyhow::anyhow!("Block at height {} not found", height))?
2025-11-10T00:08:56.6620348Z                  } else {
2025-11-10T00:08:56.6620486Z                      // Parse as hash
2025-11-10T00:08:56.6620932Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:823:
2025-11-10T00:08:56.6621042Z                  }
2025-11-10T00:08:56.6621144Z              } else {
2025-11-10T00:08:56.6621265Z                  // Default to tip
2025-11-10T00:08:56.6621418Z -                storage.chain().get_tip_hash()?
2025-11-10T00:08:56.6621523Z +                storage
2025-11-10T00:08:56.6621637Z +                    .chain()
2025-11-10T00:08:56.6621771Z +                    .get_tip_hash()?
2025-11-10T00:08:56.6622020Z                      .ok_or_else(|| anyhow::anyhow!("Chain not initialized"))?
2025-11-10T00:08:56.6622136Z              };
2025-11-10T00:08:56.6622245Z  
2025-11-10T00:08:56.6622950Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:831:
2025-11-10T00:08:56.6623154Z                  let tx_count = block.transactions.len();
2025-11-10T00:08:56.6623382Z                  let block_size = bincode::serialize(&block)?.len();
2025-11-10T00:08:56.6623734Z                  let block_weight = block_size; // Simplified - would calculate weight properly
2025-11-10T00:08:56.6623845Z -                
2025-11-10T00:08:56.6623948Z +
2025-11-10T00:08:56.6624075Z                  // Get block height
2025-11-10T00:08:56.6624590Z -                let height = storage.blocks().get_height_by_hash(&block_hash)?
2025-11-10T00:08:56.6624719Z +                let height = storage
2025-11-10T00:08:56.6624829Z +                    .blocks()
2025-11-10T00:08:56.6624992Z +                    .get_height_by_hash(&block_hash)?
2025-11-10T00:08:56.6625122Z                      .unwrap_or(0);
2025-11-10T00:08:56.6625226Z -                
2025-11-10T00:08:56.6625329Z +
2025-11-10T00:08:56.6625493Z                  // Count inputs and outputs
2025-11-10T00:08:56.6625722Z -                let input_count: usize = block.transactions.iter()
2025-11-10T00:08:56.6625878Z -                    .map(|tx| tx.inputs.len())
2025-11-10T00:08:56.6625998Z -                    .sum();
2025-11-10T00:08:56.6626203Z -                let output_count: usize = block.transactions.iter()
2025-11-10T00:08:56.6626340Z -                    .map(|tx| tx.outputs.len())
2025-11-10T00:08:56.6626450Z -                    .sum();
2025-11-10T00:08:56.6626556Z -                
2025-11-10T00:08:56.6626944Z +                let input_count: usize = block.transactions.iter().map(|tx| tx.inputs.len()).sum();
2025-11-10T00:08:56.6627080Z +                let output_count: usize =
2025-11-10T00:08:56.6627340Z +                    block.transactions.iter().map(|tx| tx.outputs.len()).sum();
2025-11-10T00:08:56.6627436Z +
2025-11-10T00:08:56.6627560Z                  // Sum output values
2025-11-10T00:08:56.6627754Z -                let total_out: u64 = block.transactions.iter()
2025-11-10T00:08:56.6627886Z +                let total_out: u64 = block
2025-11-10T00:08:56.6628008Z +                    .transactions
2025-11-10T00:08:56.6628112Z +                    .iter()
2025-11-10T00:08:56.6628282Z                      .flat_map(|tx| tx.outputs.iter())
2025-11-10T00:08:56.6628435Z                      .map(|out| out.value as u64)
2025-11-10T00:08:56.6628573Z                      .sum::<u64>();
2025-11-10T00:08:56.6629047Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:852:
2025-11-10T00:08:56.6629159Z -                
2025-11-10T00:08:56.6629259Z +
2025-11-10T00:08:56.6629407Z                  // Calculate block subsidy
2025-11-10T00:08:56.6629630Z                  let subsidy = Self::calculate_block_subsidy(height);
2025-11-10T00:08:56.6629735Z -                
2025-11-10T00:08:56.6629833Z +
2025-11-10T00:08:56.6630199Z                  // Calculate total fees (simplified - would need UTXO set for accurate calculation)
2025-11-10T00:08:56.6630484Z                  // For now, estimate: total_out - (subsidy * 100_000_000) if coinbase exists
2025-11-10T00:08:56.6630938Z                  let total_fees = if !block.transactions.is_empty() {
2025-11-10T00:08:56.6631374Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:859:
2025-11-10T00:08:56.6631533Z                      // Coinbase is first transaction
2025-11-10T00:08:56.6631817Z -                    let coinbase_outputs: u64 = block.transactions[0].outputs.iter()
2025-11-10T00:08:56.6632032Z +                    let coinbase_outputs: u64 = block.transactions[0]
2025-11-10T00:08:56.6632156Z +                        .outputs
2025-11-10T00:08:56.6632282Z +                        .iter()
2025-11-10T00:08:56.6632426Z                          .map(|out| out.value as u64)
2025-11-10T00:08:56.6632539Z                          .sum();
2025-11-10T00:08:56.6632781Z                      // Fee = total outputs - (coinbase outputs which include subsidy)
2025-11-10T00:08:56.6633394Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:903:
2025-11-10T00:08:56.6633511Z              }
2025-11-10T00:08:56.6633612Z          } else {
2025-11-10T00:08:56.6633941Z              // Graceful degradation: return informative error instead of failing silently
2025-11-10T00:08:56.6634552Z -            Err(anyhow::anyhow!("Storage not available. This operation requires storage to be initialized."))
2025-11-10T00:08:56.6634681Z +            Err(anyhow::anyhow!(
2025-11-10T00:08:56.6635019Z +                "Storage not available. This operation requires storage to be initialized."
2025-11-10T00:08:56.6635130Z +            ))
2025-11-10T00:08:56.6635253Z          }
2025-11-10T00:08:56.6635364Z      }
2025-11-10T00:08:56.6635473Z  
2025-11-10T00:08:56.6635960Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:913:
2025-11-10T00:08:56.6636291Z      pub async fn prune_blockchain(&self, params: &Value) -> Result<Value> {
2025-11-10T00:08:56.6636451Z          debug!("RPC: pruneblockchain");
2025-11-10T00:08:56.6636558Z  
2025-11-10T00:08:56.6636701Z -        let height = params.get(0)
2025-11-10T00:08:56.6636826Z +        let height = params
2025-11-10T00:08:56.6636939Z +            .get(0)
2025-11-10T00:08:56.6637096Z              .and_then(|p| p.as_u64())
2025-11-10T00:08:56.6637354Z              .ok_or_else(|| anyhow::anyhow!("Height parameter required"))?;
2025-11-10T00:08:56.6637451Z  
2025-11-10T00:08:56.6637898Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:920:
2025-11-10T00:08:56.6638071Z          if let Some(ref storage) = self.storage {
2025-11-10T00:08:56.6638328Z              let tip_height = storage.chain().get_height()?.unwrap_or(0);
2025-11-10T00:08:56.6638443Z -            
2025-11-10T00:08:56.6638562Z +
2025-11-10T00:08:56.6638852Z              // Check if IBD is in progress (height == 0 indicates no blocks synced)
2025-11-10T00:08:56.6639008Z              let is_ibd = tip_height == 0;
2025-11-10T00:08:56.6639124Z -            
2025-11-10T00:08:56.6639235Z +
2025-11-10T00:08:56.6639374Z              if height >= tip_height {
2025-11-10T00:08:56.6639835Z -                return Err(anyhow::anyhow!("Cannot prune to height >= tip height ({} >= {})", height, tip_height));
2025-11-10T00:08:56.6640002Z +                return Err(anyhow::anyhow!(
2025-11-10T00:08:56.6640219Z +                    "Cannot prune to height >= tip height ({} >= {})",
2025-11-10T00:08:56.6640338Z +                    height,
2025-11-10T00:08:56.6640474Z +                    tip_height
2025-11-10T00:08:56.6640580Z +                ));
2025-11-10T00:08:56.6640686Z              }
2025-11-10T00:08:56.6640793Z  
2025-11-10T00:08:56.6640940Z              // Get pruning manager
2025-11-10T00:08:56.6641399Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:931:
2025-11-10T00:08:56.6641630Z              if let Some(pruning_manager) = storage.pruning() {
2025-11-10T00:08:56.6641768Z                  // Perform pruning
2025-11-10T00:08:56.6642351Z                  let stats = pruning_manager.prune_to_height(height, tip_height, is_ibd)?;
2025-11-10T00:08:56.6642465Z -                
2025-11-10T00:08:56.6642579Z +
2025-11-10T00:08:56.6642749Z                  // Flush storage to persist changes
2025-11-10T00:08:56.6642887Z                  storage.flush()?;
2025-11-10T00:08:56.6642998Z -                
2025-11-10T00:08:56.6643105Z +
2025-11-10T00:08:56.6643220Z                  Ok(json!({
2025-11-10T00:08:56.6643381Z                      "pruned_height": height,
2025-11-10T00:08:56.6643563Z                      "blocks_pruned": stats.blocks_pruned,
2025-11-10T00:08:56.6644033Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:943:
2025-11-10T00:08:56.6644224Z                      "storage_freed_bytes": stats.storage_freed,
2025-11-10T00:08:56.6644509Z                  }))
2025-11-10T00:08:56.6644849Z              } else {
2025-11-10T00:08:56.6645282Z -                Err(anyhow::anyhow!("Pruning is not enabled. Configure pruning in node configuration."))
2025-11-10T00:08:56.6645429Z +                Err(anyhow::anyhow!(
2025-11-10T00:08:56.6645745Z +                    "Pruning is not enabled. Configure pruning in node configuration."
2025-11-10T00:08:56.6645852Z +                ))
2025-11-10T00:08:56.6645953Z              }
2025-11-10T00:08:56.6646063Z          } else {
2025-11-10T00:08:56.6646422Z              // Graceful degradation: return informative error instead of failing silently
2025-11-10T00:08:56.6646893Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:950:
2025-11-10T00:08:56.6647373Z -            Err(anyhow::anyhow!("Storage not available. This operation requires storage to be initialized."))
2025-11-10T00:08:56.6647525Z +            Err(anyhow::anyhow!(
2025-11-10T00:08:56.6647880Z +                "Storage not available. This operation requires storage to be initialized."
2025-11-10T00:08:56.6647992Z +            ))
2025-11-10T00:08:56.6648115Z          }
2025-11-10T00:08:56.6648216Z      }
2025-11-10T00:08:56.6648318Z  
2025-11-10T00:08:56.6648762Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:960:
2025-11-10T00:08:56.6648929Z          if let Some(ref storage) = self.storage {
2025-11-10T00:08:56.6649173Z              let tip_height = storage.chain().get_height()?.unwrap_or(0);
2025-11-10T00:08:56.6649392Z              let is_pruning_enabled = storage.is_pruning_enabled();
2025-11-10T00:08:56.6649504Z -            
2025-11-10T00:08:56.6649604Z +
2025-11-10T00:08:56.6649812Z              if let Some(pruning_manager) = storage.pruning() {
2025-11-10T00:08:56.6649992Z                  let stats = pruning_manager.get_stats();
2025-11-10T00:08:56.6650152Z                  let config = &pruning_manager.config;
2025-11-10T00:08:56.6650578Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:967:
2025-11-10T00:08:56.6650687Z -                
2025-11-10T00:08:56.6650802Z +
2025-11-10T00:08:56.6650945Z                  // Determine pruning mode
2025-11-10T00:08:56.6651101Z                  let mode_str = match &config.mode {
2025-11-10T00:08:56.6651317Z                      crate::config::PruningMode::Disabled => "disabled",
2025-11-10T00:08:56.6651736Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:975:
2025-11-10T00:08:56.6651972Z                      _ => "unknown", // Fallback for Aggressive if feature not enabled
2025-11-10T00:08:56.6652188Z                      crate::config::PruningMode::Custom { .. } => "custom",
2025-11-10T00:08:56.6652286Z                  };
2025-11-10T00:08:56.6652385Z -                
2025-11-10T00:08:56.6652485Z +
2025-11-10T00:08:56.6652603Z                  Ok(json!({
2025-11-10T00:08:56.6652759Z                      "pruning_enabled": is_pruning_enabled,
2025-11-10T00:08:56.6652885Z                      "mode": mode_str,
2025-11-10T00:08:56.6653316Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1013:
2025-11-10T00:08:56.6653817Z      pub async fn invalidate_block(&self, params: &Value) -> Result<Value> {
2025-11-10T00:08:56.6653975Z          debug!("RPC: invalidateblock");
2025-11-10T00:08:56.6654096Z  
2025-11-10T00:08:56.6654251Z -        let blockhash = params.get(0)
2025-11-10T00:08:56.6654569Z +        let blockhash = params
2025-11-10T00:08:56.6654681Z +            .get(0)
2025-11-10T00:08:56.6654814Z              .and_then(|p| p.as_str())
2025-11-10T00:08:56.6655066Z              .ok_or_else(|| anyhow::anyhow!("Block hash parameter required"))?;
2025-11-10T00:08:56.6655161Z  
2025-11-10T00:08:56.6655598Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1020:
2025-11-10T00:08:56.6655752Z -        let hash_bytes = hex::decode(blockhash)
2025-11-10T00:08:56.6656159Z -            .map_err(|e| anyhow::anyhow!("Invalid block hash: {}", e))?;
2025-11-10T00:08:56.6656287Z +        let hash_bytes =
2025-11-10T00:08:56.6656659Z +            hex::decode(blockhash).map_err(|e| anyhow::anyhow!("Invalid block hash: {}", e))?;
2025-11-10T00:08:56.6656789Z          if hash_bytes.len() != 32 {
2025-11-10T00:08:56.6657019Z              return Err(anyhow::anyhow!("Block hash must be 32 bytes"));
2025-11-10T00:08:56.6657125Z          }
2025-11-10T00:08:56.6657550Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1028:
2025-11-10T00:08:56.6657709Z          if let Some(ref storage) = self.storage {
2025-11-10T00:08:56.6657838Z              // Mark block as invalid
2025-11-10T00:08:56.6657980Z              storage.chain().mark_invalid(&hash)?;
2025-11-10T00:08:56.6658079Z -            
2025-11-10T00:08:56.6658176Z +
2025-11-10T00:08:56.6658452Z              // Check if this is the current tip - if so, we'd need to trigger a reorg
2025-11-10T00:08:56.6658768Z              // For now, we just mark it as invalid and let the node handle it on next block
2025-11-10T00:08:56.6659017Z              if let Ok(Some(tip_hash)) = storage.chain().get_tip_hash() {
2025-11-10T00:08:56.6659513Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1040:
2025-11-10T00:08:56.6659646Z              Ok(json!(null))
2025-11-10T00:08:56.6659755Z          } else {
2025-11-10T00:08:56.6660123Z              // Graceful degradation: return informative error instead of failing silently
2025-11-10T00:08:56.6660600Z -            Err(anyhow::anyhow!("Storage not available. This operation requires storage to be initialized."))
2025-11-10T00:08:56.6660743Z +            Err(anyhow::anyhow!(
2025-11-10T00:08:56.6661093Z +                "Storage not available. This operation requires storage to be initialized."
2025-11-10T00:08:56.6661213Z +            ))
2025-11-10T00:08:56.6661316Z          }
2025-11-10T00:08:56.6661421Z      }
2025-11-10T00:08:56.6661533Z  
2025-11-10T00:08:56.6662007Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1050:
2025-11-10T00:08:56.6662337Z      pub async fn reconsider_block(&self, params: &Value) -> Result<Value> {
2025-11-10T00:08:56.6662503Z          debug!("RPC: reconsiderblock");
2025-11-10T00:08:56.6662611Z  
2025-11-10T00:08:56.6662763Z -        let blockhash = params.get(0)
2025-11-10T00:08:56.6662901Z +        let blockhash = params
2025-11-10T00:08:56.6663019Z +            .get(0)
2025-11-10T00:08:56.6663154Z              .and_then(|p| p.as_str())
2025-11-10T00:08:56.6663425Z              .ok_or_else(|| anyhow::anyhow!("Block hash parameter required"))?;
2025-11-10T00:08:56.6663534Z  
2025-11-10T00:08:56.6666176Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1057:
2025-11-10T00:08:56.6666355Z -        let hash_bytes = hex::decode(blockhash)
2025-11-10T00:08:56.6666601Z -            .map_err(|e| anyhow::anyhow!("Invalid block hash: {}", e))?;
2025-11-10T00:08:56.6666736Z +        let hash_bytes =
2025-11-10T00:08:56.6667095Z +            hex::decode(blockhash).map_err(|e| anyhow::anyhow!("Invalid block hash: {}", e))?;
2025-11-10T00:08:56.6667488Z          if hash_bytes.len() != 32 {
2025-11-10T00:08:56.6667744Z              return Err(anyhow::anyhow!("Block hash must be 32 bytes"));
2025-11-10T00:08:56.6667852Z          }
2025-11-10T00:08:56.6668325Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1065:
2025-11-10T00:08:56.6668512Z          if let Some(ref storage) = self.storage {
2025-11-10T00:08:56.6668673Z              // Remove from invalid blocks set
2025-11-10T00:08:56.6668847Z              storage.chain().unmark_invalid(&hash)?;
2025-11-10T00:08:56.6668958Z -            
2025-11-10T00:08:56.6669071Z +
2025-11-10T00:08:56.6669375Z              // If this block is now valid, it may be reconsidered for chain inclusion
2025-11-10T00:08:56.6669591Z              // The node will handle this on next block processing
2025-11-10T00:08:56.6669707Z  
2025-11-10T00:08:56.6670394Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1072:
2025-11-10T00:08:56.6670548Z              Ok(json!(null))
2025-11-10T00:08:56.6670660Z          } else {
2025-11-10T00:08:56.6671033Z              // Graceful degradation: return informative error instead of failing silently
2025-11-10T00:08:56.6671504Z -            Err(anyhow::anyhow!("Storage not available. This operation requires storage to be initialized."))
2025-11-10T00:08:56.6671643Z +            Err(anyhow::anyhow!(
2025-11-10T00:08:56.6672006Z +                "Storage not available. This operation requires storage to be initialized."
2025-11-10T00:08:56.6672112Z +            ))
2025-11-10T00:08:56.6672210Z          }
2025-11-10T00:08:56.6672311Z      }
2025-11-10T00:08:56.6672407Z  
2025-11-10T00:08:56.6673068Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1079:
2025-11-10T00:08:56.6673195Z      /// Wait for new block
2025-11-10T00:08:56.6673318Z      ///
2025-11-10T00:08:56.6673633Z      /// Params: ["timeout"] (optional, timeout in seconds, default: no timeout)
2025-11-10T00:08:56.6673747Z -    /// 
2025-11-10T00:08:56.6673858Z +    ///
2025-11-10T00:08:56.6674155Z      /// Note: Full implementation requires async notification infrastructure.
2025-11-10T00:08:56.6676487Z      /// Currently returns current tip immediately. Future enhancement will:
2025-11-10T00:08:56.6676648Z      /// 1. Subscribe to block notifications
2025-11-10T00:08:56.6677108Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1088:
2025-11-10T00:08:56.6677387Z      pub async fn wait_for_new_block(&self, params: &Value) -> Result<Value> {
2025-11-10T00:08:56.6677524Z          debug!("RPC: waitfornewblock");
2025-11-10T00:08:56.6677631Z  
2025-11-10T00:08:56.6677766Z -        let _timeout = params.get(0)
2025-11-10T00:08:56.6677888Z +        let _timeout = params
2025-11-10T00:08:56.6677997Z +            .get(0)
2025-11-10T00:08:56.6678135Z              .and_then(|p| p.as_u64())
2025-11-10T00:08:56.6678319Z              .map(|t| tokio::time::Duration::from_secs(t));
2025-11-10T00:08:56.6678420Z  
2025-11-10T00:08:56.6678852Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1104:
2025-11-10T00:08:56.6678953Z              }
2025-11-10T00:08:56.6679053Z          } else {
2025-11-10T00:08:56.6679387Z              // Graceful degradation: return informative error instead of failing silently
2025-11-10T00:08:56.6679833Z -            Err(anyhow::anyhow!("Storage not available. This operation requires storage to be initialized."))
2025-11-10T00:08:56.6679974Z +            Err(anyhow::anyhow!(
2025-11-10T00:08:56.6680334Z +                "Storage not available. This operation requires storage to be initialized."
2025-11-10T00:08:56.6680436Z +            ))
2025-11-10T00:08:56.6680532Z          }
2025-11-10T00:08:56.6680626Z      }
2025-11-10T00:08:56.6680730Z  
2025-11-10T00:08:56.6681164Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1111:
2025-11-10T00:08:56.6681541Z      /// Wait for specific block
2025-11-10T00:08:56.6681642Z      ///
2025-11-10T00:08:56.6681884Z      /// Params: ["blockhash", "timeout"] (block hash, optional timeout)
2025-11-10T00:08:56.6681989Z -    /// 
2025-11-10T00:08:56.6682098Z +    ///
2025-11-10T00:08:56.6682424Z      /// Note: Full implementation requires async notification infrastructure.
2025-11-10T00:08:56.6682718Z      /// Currently checks if block exists immediately. Future enhancement will:
2025-11-10T00:08:56.6682859Z      /// 1. Subscribe to block notifications
2025-11-10T00:08:56.6683283Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1120:
2025-11-10T00:08:56.6683544Z      pub async fn wait_for_block(&self, params: &Value) -> Result<Value> {
2025-11-10T00:08:56.6683683Z          debug!("RPC: waitforblock");
2025-11-10T00:08:56.6683777Z  
2025-11-10T00:08:56.6684083Z -        let blockhash = params.get(0)
2025-11-10T00:08:56.6684213Z +        let blockhash = params
2025-11-10T00:08:56.6684512Z +            .get(0)
2025-11-10T00:08:56.6684649Z              .and_then(|p| p.as_str())
2025-11-10T00:08:56.6684899Z              .ok_or_else(|| anyhow::anyhow!("Block hash parameter required"))?;
2025-11-10T00:08:56.6684993Z  
2025-11-10T00:08:56.6685469Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1127:
2025-11-10T00:08:56.6685622Z -        let _timeout = params.get(1)
2025-11-10T00:08:56.6685791Z +        let _timeout = params
2025-11-10T00:08:56.6685904Z +            .get(1)
2025-11-10T00:08:56.6686049Z              .and_then(|p| p.as_u64())
2025-11-10T00:08:56.6686257Z              .map(|t| tokio::time::Duration::from_secs(t));
2025-11-10T00:08:56.6694264Z  
2025-11-10T00:08:56.6694986Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1131:
2025-11-10T00:08:56.6695215Z -        let hash_bytes = hex::decode(blockhash)
2025-11-10T00:08:56.6695477Z -            .map_err(|e| anyhow::anyhow!("Invalid block hash: {}", e))?;
2025-11-10T00:08:56.6695609Z +        let hash_bytes =
2025-11-10T00:08:56.6695974Z +            hex::decode(blockhash).map_err(|e| anyhow::anyhow!("Invalid block hash: {}", e))?;
2025-11-10T00:08:56.6696133Z          if hash_bytes.len() != 32 {
2025-11-10T00:08:56.6696388Z              return Err(anyhow::anyhow!("Block hash must be 32 bytes"));
2025-11-10T00:08:56.6696503Z          }
2025-11-10T00:08:56.6696986Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1140:
2025-11-10T00:08:56.6697176Z          // For now, check if block exists immediately
2025-11-10T00:08:56.6697341Z          if let Some(ref storage) = self.storage {
2025-11-10T00:08:56.6697589Z              if let Ok(Some(_block)) = storage.blocks().get_block(&hash) {
2025-11-10T00:08:56.6697827Z -                let height = storage.blocks().get_height_by_hash(&hash)?
2025-11-10T00:08:56.6697975Z -                    .unwrap_or(0);
2025-11-10T00:08:56.6698295Z +                let height = storage.blocks().get_height_by_hash(&hash)?.unwrap_or(0);
2025-11-10T00:08:56.6698437Z                  Ok(json!({
2025-11-10T00:08:56.6698575Z                      "hash": blockhash,
2025-11-10T00:08:56.6698714Z                      "height": height
2025-11-10T00:08:56.6699192Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1151:
2025-11-10T00:08:56.6699300Z              }
2025-11-10T00:08:56.6699413Z          } else {
2025-11-10T00:08:56.6699779Z              // Graceful degradation: return informative error instead of failing silently
2025-11-10T00:08:56.6700250Z -            Err(anyhow::anyhow!("Storage not available. This operation requires storage to be initialized."))
2025-11-10T00:08:56.6700385Z +            Err(anyhow::anyhow!(
2025-11-10T00:08:56.6700713Z +                "Storage not available. This operation requires storage to be initialized."
2025-11-10T00:08:56.6700830Z +            ))
2025-11-10T00:08:56.6700929Z          }
2025-11-10T00:08:56.6701268Z      }
2025-11-10T00:08:56.6701374Z  
2025-11-10T00:08:56.6701814Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1158:
2025-11-10T00:08:56.6701938Z      /// Wait for block height
2025-11-10T00:08:56.6702035Z      ///
2025-11-10T00:08:56.6702294Z      /// Params: ["height", "timeout"] (block height, optional timeout)
2025-11-10T00:08:56.6702406Z -    /// 
2025-11-10T00:08:56.6702511Z +    ///
2025-11-10T00:08:56.6702829Z      /// Note: Full implementation requires async notification infrastructure.
2025-11-10T00:08:56.6703170Z      /// Currently checks if block at height exists immediately. Future enhancement will:
2025-11-10T00:08:56.6703312Z      /// 1. Subscribe to block notifications
2025-11-10T00:08:56.6703748Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1167:
2025-11-10T00:08:56.6704218Z      pub async fn wait_for_block_height(&self, params: &Value) -> Result<Value> {
2025-11-10T00:08:56.6704623Z          debug!("RPC: waitforblockheight");
2025-11-10T00:08:56.6704724Z  
2025-11-10T00:08:56.6704877Z -        let height = params.get(0)
2025-11-10T00:08:56.6705016Z +        let height = params
2025-11-10T00:08:56.6705136Z +            .get(0)
2025-11-10T00:08:56.6705291Z              .and_then(|p| p.as_u64())
2025-11-10T00:08:56.6705576Z              .ok_or_else(|| anyhow::anyhow!("Height parameter required"))?;
2025-11-10T00:08:56.6705687Z  
2025-11-10T00:08:56.6706174Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1174:
2025-11-10T00:08:56.6706334Z -        let _timeout = params.get(1)
2025-11-10T00:08:56.6706471Z +        let _timeout = params
2025-11-10T00:08:56.6706586Z +            .get(1)
2025-11-10T00:08:56.6706739Z              .and_then(|p| p.as_u64())
2025-11-10T00:08:56.6706923Z              .map(|t| tokio::time::Duration::from_secs(t));
2025-11-10T00:08:56.6707092Z          if let Some(ref storage) = self.storage {
2025-11-10T00:08:56.6707541Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1186:
2025-11-10T00:08:56.6707785Z                      Err(anyhow::anyhow!("Block at height {} not found", height))
2025-11-10T00:08:56.6707886Z                  }
2025-11-10T00:08:56.6707990Z              } else {
2025-11-10T00:08:56.6708372Z -                Err(anyhow::anyhow!("Block at height {} not yet available (tip: {})", height, tip_height))
2025-11-10T00:08:56.6708502Z +                Err(anyhow::anyhow!(
2025-11-10T00:08:56.6708694Z +                    "Block at height {} not yet available (tip: {})",
2025-11-10T00:08:56.6708820Z +                    height,
2025-11-10T00:08:56.6708948Z +                    tip_height
2025-11-10T00:08:56.6709061Z +                ))
2025-11-10T00:08:56.6709178Z              }
2025-11-10T00:08:56.6709293Z          } else {
2025-11-10T00:08:56.6709669Z              // Graceful degradation: return informative error instead of failing silently
2025-11-10T00:08:56.6710150Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1193:
2025-11-10T00:08:56.6710640Z -            Err(anyhow::anyhow!("Storage not available. This operation requires storage to be initialized."))
2025-11-10T00:08:56.6710782Z +            Err(anyhow::anyhow!(
2025-11-10T00:08:56.6711139Z +                "Storage not available. This operation requires storage to be initialized."
2025-11-10T00:08:56.6711267Z +            ))
2025-11-10T00:08:56.6711377Z          }
2025-11-10T00:08:56.6711479Z      }
2025-11-10T00:08:56.6711579Z  
2025-11-10T00:08:56.6712036Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1200:
2025-11-10T00:08:56.6712327Z      pub async fn get_block_filter(&self, params: &Value) -> Result<Value> {
2025-11-10T00:08:56.6712468Z          debug!("RPC: getblockfilter");
2025-11-10T00:08:56.6712575Z  
2025-11-10T00:08:56.6712725Z -        let blockhash = params.get(0)
2025-11-10T00:08:56.6712855Z +        let blockhash = params
2025-11-10T00:08:56.6713184Z +            .get(0)
2025-11-10T00:08:56.6713318Z              .and_then(|p| p.as_str())
2025-11-10T00:08:56.6713983Z              .ok_or_else(|| anyhow::anyhow!("Block hash parameter required"))?;
2025-11-10T00:08:56.6714090Z  
2025-11-10T00:08:56.6714721Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1207:
2025-11-10T00:08:56.6714867Z -        let filtertype = params.get(1)
2025-11-10T00:08:56.6714997Z -            .and_then(|p| p.as_u64())
2025-11-10T00:08:56.6715167Z -            .unwrap_or(0); // Default: Basic filter
2025-11-10T00:08:56.6715564Z +        let filtertype = params.get(1).and_then(|p| p.as_u64()).unwrap_or(0); // Default: Basic filter
2025-11-10T00:08:56.6715670Z  
2025-11-10T00:08:56.6715807Z          if filtertype != 0 {
2025-11-10T00:08:56.6716313Z              return Err(anyhow::anyhow!("Only filter type 0 (Basic) is supported"));
2025-11-10T00:08:56.6716811Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1213:
2025-11-10T00:08:56.6716937Z          }
2025-11-10T00:08:56.6717052Z  
2025-11-10T00:08:56.6717222Z -        let hash_bytes = hex::decode(blockhash)
2025-11-10T00:08:56.6717461Z -            .map_err(|e| anyhow::anyhow!("Invalid block hash: {}", e))?;
2025-11-10T00:08:56.6717589Z +        let hash_bytes =
2025-11-10T00:08:56.6717936Z +            hex::decode(blockhash).map_err(|e| anyhow::anyhow!("Invalid block hash: {}", e))?;
2025-11-10T00:08:56.6718072Z          if hash_bytes.len() != 32 {
2025-11-10T00:08:56.6718325Z              return Err(anyhow::anyhow!("Block hash must be 32 bytes"));
2025-11-10T00:08:56.6718430Z          }
2025-11-10T00:08:56.6718884Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1226:
2025-11-10T00:08:56.6719111Z                  // Get filter service from network manager (if available)
2025-11-10T00:08:56.6719285Z                  // For now, generate filter directly
2025-11-10T00:08:56.6719488Z                  use bllvm_protocol::bip158::build_block_filter;
2025-11-10T00:08:56.6719593Z -                
2025-11-10T00:08:56.6719701Z +
2025-11-10T00:08:56.6719886Z                  // Get previous outpoint scripts from UTXO set
2025-11-10T00:08:56.6720110Z                  // For each input, find the UTXO and get its script_pubkey
2025-11-10T00:08:56.6720288Z                  let mut previous_scripts = Vec::new();
2025-11-10T00:08:56.6720736Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1239:
2025-11-10T00:08:56.6720850Z                          }
2025-11-10T00:08:56.6720960Z                      }
2025-11-10T00:08:56.6721075Z                  }
2025-11-10T00:08:56.6721179Z -                
2025-11-10T00:08:56.6721280Z +
2025-11-10T00:08:56.6721583Z                  match build_block_filter(&block.transactions, &previous_scripts) {
2025-11-10T00:08:56.6721717Z                      Ok(filter) => {
2025-11-10T00:08:56.6721839Z                          Ok(json!({
2025-11-10T00:08:56.6722288Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1247:
2025-11-10T00:08:56.6722558Z                              "header": hex::encode([0u8; 32]), // Would calculate filter header
2025-11-10T00:08:56.6722670Z                          }))
2025-11-10T00:08:56.6722777Z                      }
2025-11-10T00:08:56.6723028Z -                    Err(e) => Err(anyhow::anyhow!("Failed to build filter: {}", e))
2025-11-10T00:08:56.6723265Z +                    Err(e) => Err(anyhow::anyhow!("Failed to build filter: {}", e)),
2025-11-10T00:08:56.6723372Z                  }
2025-11-10T00:08:56.6723487Z              } else {
2025-11-10T00:08:56.6723655Z                  Err(anyhow::anyhow!("Block not found"))
2025-11-10T00:08:56.6724098Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1254:
2025-11-10T00:08:56.6724208Z              }
2025-11-10T00:08:56.6724481Z          } else {
2025-11-10T00:08:56.6725029Z              // Graceful degradation: return informative error instead of failing silently
2025-11-10T00:08:56.6725482Z -            Err(anyhow::anyhow!("Storage not available. This operation requires storage to be initialized."))
2025-11-10T00:08:56.6725619Z +            Err(anyhow::anyhow!(
2025-11-10T00:08:56.6725956Z +                "Storage not available. This operation requires storage to be initialized."
2025-11-10T00:08:56.6726061Z +            ))
2025-11-10T00:08:56.6726169Z          }
2025-11-10T00:08:56.6726267Z      }
2025-11-10T00:08:56.6726369Z  
2025-11-10T00:08:56.6726857Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/control.rs:89:
2025-11-10T00:08:56.6727187Z      pub async fn getmemoryinfo(&self, params: &Value) -> RpcResult<Value> {
2025-11-10T00:08:56.6727337Z          debug!("RPC: getmemoryinfo");
2025-11-10T00:08:56.6727448Z  
2025-11-10T00:08:56.6727800Z -        let mode = params
2025-11-10T00:08:56.6727921Z -            .get(0)
2025-11-10T00:08:56.6728071Z -            .and_then(|p| p.as_str())
2025-11-10T00:08:56.6728208Z -            .unwrap_or("stats");
2025-11-10T00:08:56.6728494Z +        let mode = params.get(0).and_then(|p| p.as_str()).unwrap_or("stats");
2025-11-10T00:08:56.6728604Z  
2025-11-10T00:08:56.6728727Z          match mode {
2025-11-10T00:08:56.6728849Z              "stats" => {
2025-11-10T00:08:56.6729292Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/control.rs:224:
2025-11-10T00:08:56.6729403Z          } else {
2025-11-10T00:08:56.6729621Z              // No command specified, return list of all commands
2025-11-10T00:08:56.6729752Z              let commands = vec![
2025-11-10T00:08:56.6730069Z -                "getblockchaininfo", "getblock", "getblockhash", "getblockheader",
2025-11-10T00:08:56.6730414Z -                "getbestblockhash", "getblockcount", "getdifficulty", "gettxoutsetinfo",
2025-11-10T00:08:56.6730801Z -                "verifychain", "getrawtransaction", "sendrawtransaction", "testmempoolaccept",
2025-11-10T00:08:56.6731136Z -                "decoderawtransaction", "gettxout", "gettxoutproof", "verifytxoutproof",
2025-11-10T00:08:56.6731438Z -                "getmempoolinfo", "getrawmempool", "savemempool", "getnetworkinfo",
2025-11-10T00:08:56.6731770Z -                "getpeerinfo", "getconnectioncount", "ping", "addnode", "disconnectnode",
2025-11-10T00:08:56.6732082Z -                "getnettotals", "clearbanned", "setban", "listbanned", "getmininginfo",
2025-11-10T00:08:56.6732403Z -                "getblocktemplate", "submitblock", "estimatesmartfee", "stop", "uptime",
2025-11-10T00:08:56.6732616Z -                "getmemoryinfo", "getrpcinfo", "help", "logging",
2025-11-10T00:08:56.6732755Z +                "getblockchaininfo",
2025-11-10T00:08:56.6732878Z +                "getblock",
2025-11-10T00:08:56.6733019Z +                "getblockhash",
2025-11-10T00:08:56.6733159Z +                "getblockheader",
2025-11-10T00:08:56.6733295Z +                "getbestblockhash",
2025-11-10T00:08:56.6733441Z +                "getblockcount",
2025-11-10T00:08:56.6733571Z +                "getdifficulty",
2025-11-10T00:08:56.6733707Z +                "gettxoutsetinfo",
2025-11-10T00:08:56.6733833Z +                "verifychain",
2025-11-10T00:08:56.6733992Z +                "getrawtransaction",
2025-11-10T00:08:56.6734140Z +                "sendrawtransaction",
2025-11-10T00:08:56.6734458Z +                "testmempoolaccept",
2025-11-10T00:08:56.6734627Z +                "decoderawtransaction",
2025-11-10T00:08:56.6734755Z +                "gettxout",
2025-11-10T00:08:56.6734894Z +                "gettxoutproof",
2025-11-10T00:08:56.6735043Z +                "verifytxoutproof",
2025-11-10T00:08:56.6735183Z +                "getmempoolinfo",
2025-11-10T00:08:56.6735317Z +                "getrawmempool",
2025-11-10T00:08:56.6735448Z +                "savemempool",
2025-11-10T00:08:56.6735600Z +                "getnetworkinfo",
2025-11-10T00:08:56.6735722Z +                "getpeerinfo",
2025-11-10T00:08:56.6736110Z +                "getconnectioncount",
2025-11-10T00:08:56.6736242Z +                "ping",
2025-11-10T00:08:56.6736364Z +                "addnode",
2025-11-10T00:08:56.6736489Z +                "disconnectnode",
2025-11-10T00:08:56.6736619Z +                "getnettotals",
2025-11-10T00:08:56.6736752Z +                "clearbanned",
2025-11-10T00:08:56.6736873Z +                "setban",
2025-11-10T00:08:56.6737001Z +                "listbanned",
2025-11-10T00:08:56.6737138Z +                "getmininginfo",
2025-11-10T00:08:56.6737282Z +                "getblocktemplate",
2025-11-10T00:08:56.6737407Z +                "submitblock",
2025-11-10T00:08:56.6737537Z +                "estimatesmartfee",
2025-11-10T00:08:56.6737663Z +                "stop",
2025-11-10T00:08:56.6737783Z +                "uptime",
2025-11-10T00:08:56.6737915Z +                "getmemoryinfo",
2025-11-10T00:08:56.6738249Z +                "getrpcinfo",
2025-11-10T00:08:56.6738371Z +                "help",
2025-11-10T00:08:56.6738492Z +                "logging",
2025-11-10T00:08:56.6738598Z              ];
2025-11-10T00:08:56.6738713Z  
2025-11-10T00:08:56.6738873Z              Ok(json!(commands.join("\n")))
2025-11-10T00:08:56.6739341Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/control.rs:275:
2025-11-10T00:08:56.6739538Z          // 1. Store a reference to the EnvFilter layer
2025-11-10T00:08:56.6739759Z          // 2. Provide methods to update the filter dynamically
2025-11-10T00:08:56.6739945Z          // 3. Rebuild the subscriber with the new filter
2025-11-10T00:08:56.6740058Z -        
2025-11-10T00:08:56.6740175Z +
2025-11-10T00:08:56.6740360Z          // Check current filter state from environment
2025-11-10T00:08:56.6740558Z -        let current_filter = std::env::var("RUST_LOG")
2025-11-10T00:08:56.6740742Z -            .unwrap_or_else(|_| "info".to_string());
2025-11-10T00:08:56.6740859Z -        
2025-11-10T00:08:56.6741211Z +        let current_filter = std::env::var("RUST_LOG").unwrap_or_else(|_| "info".to_string());
2025-11-10T00:08:56.6741321Z +
2025-11-10T00:08:56.6741553Z          // Determine if debug logging is active based on filter
2025-11-10T00:08:56.6742292Z -        let active = current_filter.contains("debug") || 
2025-11-10T00:08:56.6742483Z -                     current_filter.contains("trace") ||
2025-11-10T00:08:56.6742678Z -                     !exclude.contains(&"all".to_string());
2025-11-10T00:08:56.6742869Z +        let active = current_filter.contains("debug")
2025-11-10T00:08:56.6743030Z +            || current_filter.contains("trace")
2025-11-10T00:08:56.6743196Z +            || !exclude.contains(&"all".to_string());
2025-11-10T00:08:56.6743298Z  
2025-11-10T00:08:56.6745443Z          Ok(json!({
2025-11-10T00:08:56.6745580Z              "active": active,
2025-11-10T00:08:56.6746052Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/control.rs:297:
2025-11-10T00:08:56.6746334Z      /// Returns comprehensive health report for all node components
2025-11-10T00:08:56.6746637Z      pub async fn gethealth(&self, _params: &Value) -> RpcResult<Value> {
2025-11-10T00:08:56.6746786Z          debug!("RPC: gethealth");
2025-11-10T00:08:56.6746900Z -        
2025-11-10T00:08:56.6747004Z +
2025-11-10T00:08:56.6747287Z          // This would need access to Node instance to get full health report
2025-11-10T00:08:56.6747447Z          // For now, return basic health status
2025-11-10T00:08:56.6747553Z          Ok(json!({
2025-11-10T00:08:56.6747992Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/control.rs:312:
2025-11-10T00:08:56.6748185Z      /// Returns comprehensive metrics for monitoring
2025-11-10T00:08:56.6748487Z      pub async fn getmetrics(&self, _params: &Value) -> RpcResult<Value> {
2025-11-10T00:08:56.6748637Z          debug!("RPC: getmetrics");
2025-11-10T00:08:56.6748747Z -        
2025-11-10T00:08:56.6748864Z +
2025-11-10T00:08:56.6749145Z          // This would need access to MetricsCollector to get full metrics
2025-11-10T00:08:56.6749546Z          // For now, return basic metrics
2025-11-10T00:08:56.6749738Z          let uptime = self.start_time.elapsed().as_secs();
2025-11-10T00:08:56.6750165Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/control.rs:328:
2025-11-10T00:08:56.6750293Z          Self::new()
2025-11-10T00:08:56.6750396Z      }
2025-11-10T00:08:56.6750499Z  }
2025-11-10T00:08:56.6750610Z -
2025-11-10T00:08:56.6750714Z  
2025-11-10T00:08:56.6751237Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:23:
2025-11-10T00:08:56.6751375Z  impl MempoolRpc {
2025-11-10T00:08:56.6751538Z      /// Create a new mempool RPC handler
2025-11-10T00:08:56.6751678Z      pub fn new() -> Self {
2025-11-10T00:08:56.6751841Z -        Self { mempool: None, storage: None }
2025-11-10T00:08:56.6751963Z +        Self {
2025-11-10T00:08:56.6752322Z +            mempool: None,
2025-11-10T00:08:56.6752455Z +            storage: None,
2025-11-10T00:08:56.6752571Z +        }
2025-11-10T00:08:56.6752686Z      }
2025-11-10T00:08:56.6752792Z  
2025-11-10T00:08:56.6752938Z      /// Create with dependencies
2025-11-10T00:08:56.6753801Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:30:
2025-11-10T00:08:56.6754229Z      pub fn with_dependencies(mempool: Arc<MempoolManager>, storage: Arc<Storage>) -> Self {
2025-11-10T00:08:56.6754615Z -        Self { mempool: Some(mempool), storage: Some(storage) }
2025-11-10T00:08:56.6754741Z +        Self {
2025-11-10T00:08:56.6754883Z +            mempool: Some(mempool),
2025-11-10T00:08:56.6755019Z +            storage: Some(storage),
2025-11-10T00:08:56.6755128Z +        }
2025-11-10T00:08:56.6755246Z      }
2025-11-10T00:08:56.6755351Z  
2025-11-10T00:08:56.6755488Z      /// Get mempool information
2025-11-10T00:08:56.6755921Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:40:
2025-11-10T00:08:56.6756109Z          if let Some(ref mempool) = self.mempool {
2025-11-10T00:08:56.6756263Z              let size = mempool.size();
2025-11-10T00:08:56.6756457Z              let transactions = mempool.get_transactions();
2025-11-10T00:08:56.6756679Z -            let bytes: usize = transactions.iter().map(|tx| {
2025-11-10T00:08:56.6757010Z -                use bllvm_protocol::serialization::transaction::serialize_transaction;
2025-11-10T00:08:56.6757167Z -                serialize_transaction(tx).len()
2025-11-10T00:08:56.6757284Z -            }).sum();
2025-11-10T00:08:56.6757432Z +            let bytes: usize = transactions
2025-11-10T00:08:56.6757537Z +                .iter()
2025-11-10T00:08:56.6757656Z +                .map(|tx| {
2025-11-10T00:08:56.6758006Z +                    use bllvm_protocol::serialization::transaction::serialize_transaction;
2025-11-10T00:08:56.6758175Z +                    serialize_transaction(tx).len()
2025-11-10T00:08:56.6758297Z +                })
2025-11-10T00:08:56.6758424Z +                .sum();
2025-11-10T00:08:56.6758539Z  
2025-11-10T00:08:56.6758659Z              Ok(json!({
2025-11-10T00:08:56.6758792Z                  "loaded": true,
2025-11-10T00:08:56.6759249Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:56:
2025-11-10T00:08:56.6759364Z              }))
2025-11-10T00:08:56.6759471Z          } else {
2025-11-10T00:08:56.6759829Z              // Graceful degradation: return empty mempool info when mempool unavailable
2025-11-10T00:08:56.6760296Z -            tracing::debug!("getmempoolinfo called but mempool not available, returning empty mempool");
2025-11-10T00:08:56.6760430Z +            tracing::debug!(
2025-11-10T00:08:56.6760793Z +                "getmempoolinfo called but mempool not available, returning empty mempool"
2025-11-10T00:08:56.6760911Z +            );
2025-11-10T00:08:56.6761029Z              Ok(json!({
2025-11-10T00:08:56.6761169Z                  "loaded": false,
2025-11-10T00:08:56.6761302Z                  "size": 0,
2025-11-10T00:08:56.6763145Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:82:
2025-11-10T00:08:56.6765318Z              let transactions = mempool.get_transactions();
2025-11-10T00:08:56.6765552Z              use bllvm_protocol::mempool::calculate_tx_id;
2025-11-10T00:08:56.6765896Z              use bllvm_protocol::serialization::transaction::serialize_transaction;
2025-11-10T00:08:56.6766004Z -            
2025-11-10T00:08:56.6766115Z +
2025-11-10T00:08:56.6766235Z              if verbose {
2025-11-10T00:08:56.6766410Z                  let mut result = serde_json::Map::new();
2025-11-10T00:08:56.6766560Z                  for tx in transactions {
2025-11-10T00:08:56.6767022Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:90:
2025-11-10T00:08:56.6767200Z                      let txid_hex = hex::encode(txid);
2025-11-10T00:08:56.6767611Z                      let txid_hex_clone = txid_hex.clone();
2025-11-10T00:08:56.6767828Z                      let size = serialize_transaction(&tx).len();
2025-11-10T00:08:56.6767956Z -                    
2025-11-10T00:08:56.6768063Z +
2025-11-10T00:08:56.6768236Z                      result.insert(txid_hex, json!({
2025-11-10T00:08:56.6768373Z                          "size": size,
2025-11-10T00:08:56.6768826Z                          "fee": if let (Some(ref mempool), Some(ref storage)) = (self.mempool.as_ref(), self.storage.as_ref()) {
2025-11-10T00:08:56.6769274Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:126:
2025-11-10T00:08:56.6769386Z                  }
2025-11-10T00:08:56.6769517Z                  Ok(json!(result))
2025-11-10T00:08:56.6769631Z              } else {
2025-11-10T00:08:56.6769859Z -                let txids: Vec<String> = transactions.iter().map(|tx| {
2025-11-10T00:08:56.6770013Z -                    let txid = calculate_tx_id(tx);
2025-11-10T00:08:56.6770165Z -                    hex::encode(txid)
2025-11-10T00:08:56.6770298Z -                }).collect();
2025-11-10T00:08:56.6770484Z +                let txids: Vec<String> = transactions
2025-11-10T00:08:56.6770608Z +                    .iter()
2025-11-10T00:08:56.6771197Z +                    .map(|tx| {
2025-11-10T00:08:56.6771394Z +                        let txid = calculate_tx_id(tx);
2025-11-10T00:08:56.6771546Z +                        hex::encode(txid)
2025-11-10T00:08:56.6771662Z +                    })
2025-11-10T00:08:56.6771799Z +                    .collect();
2025-11-10T00:08:56.6771930Z                  Ok(json!(txids))
2025-11-10T00:08:56.6772041Z              }
2025-11-10T00:08:56.6772152Z          } else {
2025-11-10T00:08:56.6772877Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:174:
2025-11-10T00:08:56.6773054Z          if let Some(mempool) = &self.mempool {
2025-11-10T00:08:56.6775263Z              let data_dir = std::env::var("DATA_DIR").unwrap_or_else(|_| "data".to_string());
2025-11-10T00:08:56.6775598Z              let mempool_path = std::path::Path::new(&data_dir).join("mempool.dat");
2025-11-10T00:08:56.6775714Z -            
2025-11-10T00:08:56.6775822Z +
2025-11-10T00:08:56.6776080Z              // Arc implements Deref, so we can call methods directly
2025-11-10T00:08:56.6776300Z              if let Err(e) = mempool.save_to_disk(&mempool_path) {
2025-11-10T00:08:56.6776561Z -                return Err(crate::rpc::errors::RpcError::internal_error(
2025-11-10T00:08:56.6776751Z -                    format!("Failed to save mempool: {}", e)
2025-11-10T00:08:56.6776871Z -                ));
2025-11-10T00:08:56.6777157Z +                return Err(crate::rpc::errors::RpcError::internal_error(format!(
2025-11-10T00:08:56.6777319Z +                    "Failed to save mempool: {}",
2025-11-10T00:08:56.6777446Z +                    e
2025-11-10T00:08:56.6777559Z +                )));
2025-11-10T00:08:56.6777669Z              }
2025-11-10T00:08:56.6777806Z              Ok(json!(null))
2025-11-10T00:08:56.6777928Z          } else {
2025-11-10T00:08:56.6778641Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:186:
2025-11-10T00:08:56.6778866Z              Err(crate::rpc::errors::RpcError::internal_error(
2025-11-10T00:08:56.6779051Z -                "Mempool not initialized".to_string()
2025-11-10T00:08:56.6779226Z +                "Mempool not initialized".to_string(),
2025-11-10T00:08:56.6779337Z              ))
2025-11-10T00:08:56.6779452Z          }
2025-11-10T00:08:56.6779562Z      }
2025-11-10T00:08:56.6780022Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:195:
2025-11-10T00:08:56.6780387Z      pub async fn getmempoolancestors(&self, params: &Value) -> RpcResult<Value> {
2025-11-10T00:08:56.6780564Z          debug!("RPC: getmempoolancestors");
2025-11-10T00:08:56.6780673Z  
2025-11-10T00:08:56.6780822Z -        let txid = params.get(0)
2025-11-10T00:08:56.6781209Z -            .and_then(|p| p.as_str())
2025-11-10T00:08:56.6781689Z -            .ok_or_else(|| crate::rpc::errors::RpcError::invalid_params("Transaction ID required".to_string()))?;
2025-11-10T00:08:56.6781977Z +        let txid = params.get(0).and_then(|p| p.as_str()).ok_or_else(|| {
2025-11-10T00:08:56.6782385Z +            crate::rpc::errors::RpcError::invalid_params("Transaction ID required".to_string())
2025-11-10T00:08:56.6782501Z +        })?;
2025-11-10T00:08:56.6782608Z  
2025-11-10T00:08:56.6782915Z          let verbose = params.get(1).and_then(|p| p.as_bool()).unwrap_or(false);
2025-11-10T00:08:56.6783042Z  
2025-11-10T00:08:56.6785346Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:204:
2025-11-10T00:08:56.6785529Z -        let hash_bytes = hex::decode(txid)
2025-11-10T00:08:56.6786006Z -            .map_err(|e| crate::rpc::errors::RpcError::invalid_params(format!("Invalid transaction ID: {}", e)))?;
2025-11-10T00:08:56.6786211Z +        let hash_bytes = hex::decode(txid).map_err(|e| {
2025-11-10T00:08:56.6786598Z +            crate::rpc::errors::RpcError::invalid_params(format!("Invalid transaction ID: {}", e))
2025-11-10T00:08:56.6786720Z +        })?;
2025-11-10T00:08:56.6786871Z          if hash_bytes.len() != 32 {
2025-11-10T00:08:56.6787752Z -            return Err(crate::rpc::errors::RpcError::invalid_params("Transaction ID must be 32 bytes".to_string()));
2025-11-10T00:08:56.6788010Z +            return Err(crate::rpc::errors::RpcError::invalid_params(
2025-11-10T00:08:56.6788218Z +                "Transaction ID must be 32 bytes".to_string(),
2025-11-10T00:08:56.6788331Z +            ));
2025-11-10T00:08:56.6788439Z          }
2025-11-10T00:08:56.6788586Z          let mut hash = [0u8; 32];
2025-11-10T00:08:56.6788744Z          hash.copy_from_slice(&hash_bytes);
2025-11-10T00:08:56.6789205Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:222:
2025-11-10T00:08:56.6789433Z                          let ancestor_txid_clone = ancestor_txid.clone();
2025-11-10T00:08:56.6789783Z                          use bllvm_protocol::serialization::transaction::serialize_transaction;
2025-11-10T00:08:56.6790017Z                          let size = serialize_transaction(&ancestor_tx).len();
2025-11-10T00:08:56.6790139Z -                        
2025-11-10T00:08:56.6790252Z +
2025-11-10T00:08:56.6790427Z                          result.insert(ancestor_txid, json!({
2025-11-10T00:08:56.6790570Z                              "size": size,
2025-11-10T00:08:56.6790783Z                              "fee": if let Some(ref storage) = self.storage {
2025-11-10T00:08:56.6791239Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:278:
2025-11-10T00:08:56.6791630Z      pub async fn getmempooldescendants(&self, params: &Value) -> RpcResult<Value> {
2025-11-10T00:08:56.6791813Z          debug!("RPC: getmempooldescendants");
2025-11-10T00:08:56.6791920Z  
2025-11-10T00:08:56.6792065Z -        let txid = params.get(0)
2025-11-10T00:08:56.6792224Z -            .and_then(|p| p.as_str())
2025-11-10T00:08:56.6792694Z -            .ok_or_else(|| crate::rpc::errors::RpcError::invalid_params("Transaction ID required".to_string()))?;
2025-11-10T00:08:56.6793201Z +        let txid = params.get(0).and_then(|p| p.as_str()).ok_or_else(|| {
2025-11-10T00:08:56.6793575Z +            crate::rpc::errors::RpcError::invalid_params("Transaction ID required".to_string())
2025-11-10T00:08:56.6793696Z +        })?;
2025-11-10T00:08:56.6793804Z  
2025-11-10T00:08:56.6794095Z          let verbose = params.get(1).and_then(|p| p.as_bool()).unwrap_or(false);
2025-11-10T00:08:56.6794195Z  
2025-11-10T00:08:56.6794792Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:287:
2025-11-10T00:08:56.6794948Z -        let hash_bytes = hex::decode(txid)
2025-11-10T00:08:56.6795413Z -            .map_err(|e| crate::rpc::errors::RpcError::invalid_params(format!("Invalid transaction ID: {}", e)))?;
2025-11-10T00:08:56.6795801Z +        let hash_bytes = hex::decode(txid).map_err(|e| {
2025-11-10T00:08:56.6796193Z +            crate::rpc::errors::RpcError::invalid_params(format!("Invalid transaction ID: {}", e))
2025-11-10T00:08:56.6796313Z +        })?;
2025-11-10T00:08:56.6796465Z          if hash_bytes.len() != 32 {
2025-11-10T00:08:56.6796944Z -            return Err(crate::rpc::errors::RpcError::invalid_params("Transaction ID must be 32 bytes".to_string()));
2025-11-10T00:08:56.6797178Z +            return Err(crate::rpc::errors::RpcError::invalid_params(
2025-11-10T00:08:56.6797360Z +                "Transaction ID must be 32 bytes".to_string(),
2025-11-10T00:08:56.6797467Z +            ));
2025-11-10T00:08:56.6797571Z          }
2025-11-10T00:08:56.6797693Z          let mut hash = [0u8; 32];
2025-11-10T00:08:56.6797839Z          hash.copy_from_slice(&hash_bytes);
2025-11-10T00:08:56.6798277Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:295:
2025-11-10T00:08:56.6798445Z          if let Some(ref mempool) = self.mempool {
2025-11-10T00:08:56.6798872Z              // Find descendants by checking which transactions spend outputs created by this transaction
2025-11-10T00:08:56.6799034Z              let mut descendants = Vec::new();
2025-11-10T00:08:56.6799145Z -            
2025-11-10T00:08:56.6799255Z +
2025-11-10T00:08:56.6799463Z              if let Some(tx) = mempool.get_transaction(&hash) {
2025-11-10T00:08:56.6799666Z                  // Get all output outpoints from this transaction
2025-11-10T00:08:56.6799831Z                  let mut output_outpoints = Vec::new();
2025-11-10T00:08:56.6800255Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:329:
2025-11-10T00:08:56.6800466Z                          let descendant_txid_clone = descendant_txid.clone();
2025-11-10T00:08:56.6800786Z                          use bllvm_protocol::serialization::transaction::serialize_transaction;
2025-11-10T00:08:56.6801019Z                          let size = serialize_transaction(&descendant_tx).len();
2025-11-10T00:08:56.6801137Z -                        
2025-11-10T00:08:56.6801248Z +
2025-11-10T00:08:56.6801430Z                          result.insert(descendant_txid, json!({
2025-11-10T00:08:56.6801574Z                              "size": size,
2025-11-10T00:08:56.6801776Z                              "fee": if let Some(ref storage) = self.storage {
2025-11-10T00:08:56.6802227Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:385:
2025-11-10T00:08:56.6802568Z      pub async fn getmempoolentry(&self, params: &Value) -> RpcResult<Value> {
2025-11-10T00:08:56.6802720Z          debug!("RPC: getmempoolentry");
2025-11-10T00:08:56.6802820Z  
2025-11-10T00:08:56.6802970Z -        let txid = params.get(0)
2025-11-10T00:08:56.6803120Z -            .and_then(|p| p.as_str())
2025-11-10T00:08:56.6803588Z -            .ok_or_else(|| crate::rpc::errors::RpcError::invalid_params("Transaction ID required".to_string()))?;
2025-11-10T00:08:56.6803871Z +        let txid = params.get(0).and_then(|p| p.as_str()).ok_or_else(|| {
2025-11-10T00:08:56.6804623Z +            crate::rpc::errors::RpcError::invalid_params("Transaction ID required".to_string())
2025-11-10T00:08:56.6804742Z +        })?;
2025-11-10T00:08:56.6804846Z  
2025-11-10T00:08:56.6805160Z          let verbose = params.get(1).and_then(|p| p.as_bool()).unwrap_or(false);
2025-11-10T00:08:56.6805271Z  
2025-11-10T00:08:56.6805729Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:394:
2025-11-10T00:08:56.6805898Z -        let hash_bytes = hex::decode(txid)
2025-11-10T00:08:56.6806359Z -            .map_err(|e| crate::rpc::errors::RpcError::invalid_params(format!("Invalid transaction ID: {}", e)))?;
2025-11-10T00:08:56.6806559Z +        let hash_bytes = hex::decode(txid).map_err(|e| {
2025-11-10T00:08:56.6806958Z +            crate::rpc::errors::RpcError::invalid_params(format!("Invalid transaction ID: {}", e))
2025-11-10T00:08:56.6807068Z +        })?;
2025-11-10T00:08:56.6807429Z          if hash_bytes.len() != 32 {
2025-11-10T00:08:56.6807956Z -            return Err(crate::rpc::errors::RpcError::invalid_params("Transaction ID must be 32 bytes".to_string()));
2025-11-10T00:08:56.6808229Z +            return Err(crate::rpc::errors::RpcError::invalid_params(
2025-11-10T00:08:56.6808425Z +                "Transaction ID must be 32 bytes".to_string(),
2025-11-10T00:08:56.6808538Z +            ));
2025-11-10T00:08:56.6808654Z          }
2025-11-10T00:08:56.6808792Z          let mut hash = [0u8; 32];
2025-11-10T00:08:56.6808950Z          hash.copy_from_slice(&hash_bytes);
2025-11-10T00:08:56.6809405Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:403:
2025-11-10T00:08:56.6809622Z              if let Some(tx) = mempool.get_transaction(&hash) {
2025-11-10T00:08:56.6809965Z                  use bllvm_protocol::serialization::transaction::serialize_transaction;
2025-11-10T00:08:56.6810153Z                  let size = serialize_transaction(&tx).len();
2025-11-10T00:08:56.6810280Z -                
2025-11-10T00:08:56.6810386Z +
2025-11-10T00:08:56.6810558Z                  // Get ancestors and descendants
2025-11-10T00:08:56.6810784Z                  let ancestors = self.get_ancestors(mempool, &hash);
2025-11-10T00:08:56.6811022Z                  let descendants = self.get_descendants(mempool, &hash);
2025-11-10T00:08:56.6811469Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:410:
2025-11-10T00:08:56.6811584Z -                
2025-11-10T00:08:56.6811696Z +
2025-11-10T00:08:56.6811866Z                  let ancestor_count = ancestors.len();
2025-11-10T00:08:56.6812048Z                  let descendant_count = descendants.len();
2025-11-10T00:08:56.6812243Z -                let ancestor_size: usize = ancestors.iter()
2025-11-10T00:08:56.6812410Z +                let ancestor_size: usize = ancestors
2025-11-10T00:08:56.6812535Z +                    .iter()
2025-11-10T00:08:56.6812742Z                      .filter_map(|h| mempool.get_transaction(h))
2025-11-10T00:08:56.6812924Z                      .map(|tx| serialize_transaction(&tx).len())
2025-11-10T00:08:56.6813051Z                      .sum();
2025-11-10T00:08:56.6813493Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:417:
2025-11-10T00:08:56.6813701Z -                let descendant_size: usize = descendants.iter()
2025-11-10T00:08:56.6813880Z +                let descendant_size: usize = descendants
2025-11-10T00:08:56.6813999Z +                    .iter()
2025-11-10T00:08:56.6814187Z                      .filter_map(|h| mempool.get_transaction(h))
2025-11-10T00:08:56.6814546Z                      .map(|tx| serialize_transaction(&tx).len())
2025-11-10T00:08:56.6814672Z                      .sum();
2025-11-10T00:08:56.6815119Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:454:
2025-11-10T00:08:56.6815277Z                      "bip125-replaceable": false
2025-11-10T00:08:56.6815401Z                  }))
2025-11-10T00:08:56.6815513Z              } else {
2025-11-10T00:08:56.6815981Z -                Err(crate::rpc::errors::RpcError::invalid_params(
2025-11-10T00:08:56.6816190Z -                    format!("Transaction {} not found in mempool", txid)
2025-11-10T00:08:56.6816291Z -                ))
2025-11-10T00:08:56.6816539Z +                Err(crate::rpc::errors::RpcError::invalid_params(format!(
2025-11-10T00:08:56.6816717Z +                    "Transaction {} not found in mempool",
2025-11-10T00:08:56.6816838Z +                    txid
2025-11-10T00:08:56.6816957Z +                )))
2025-11-10T00:08:56.6817077Z              }
2025-11-10T00:08:56.6817186Z          } else {
2025-11-10T00:08:56.6817400Z              Err(crate::rpc::errors::RpcError::internal_error(
2025-11-10T00:08:56.6817859Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:463:
2025-11-10T00:08:56.6818027Z -                "Mempool not initialized".to_string()
2025-11-10T00:08:56.6818399Z +                "Mempool not initialized".to_string(),
2025-11-10T00:08:56.6818527Z              ))
2025-11-10T00:08:56.6818632Z          }
2025-11-10T00:08:56.6818737Z      }
2025-11-10T00:08:56.6819156Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:468:
2025-11-10T00:08:56.6819334Z      /// Helper: Get ancestors for a transaction
2025-11-10T00:08:56.6819694Z      fn get_ancestors(&self, mempool: &MempoolManager, tx_hash: &Hash) -> Vec<Hash> {
2025-11-10T00:08:56.6819859Z          let mut ancestors = Vec::new();
2025-11-10T00:08:56.6819978Z -        
2025-11-10T00:08:56.6820086Z +
2025-11-10T00:08:56.6820300Z          if let Some(tx) = mempool.get_transaction(tx_hash) {
2025-11-10T00:08:56.6820645Z              // Find transactions that this transaction depends on (spends their outputs)
2025-11-10T00:08:56.6820858Z              use bllvm_protocol::mempool::calculate_tx_id;
2025-11-10T00:08:56.6821314Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:478:
2025-11-10T00:08:56.6821484Z                  for ancestor_tx in transactions {
2025-11-10T00:08:56.6821717Z                      let ancestor_hash = calculate_tx_id(&ancestor_tx);
2025-11-10T00:08:56.6821960Z                      for (idx, _output) in ancestor_tx.outputs.iter().enumerate() {
2025-11-10T00:08:56.6822326Z -                        if input.prevout.hash == ancestor_hash && input.prevout.index == idx as u64 {
2025-11-10T00:08:56.6822684Z +                        if input.prevout.hash == ancestor_hash && input.prevout.index == idx as u64
2025-11-10T00:08:56.6822804Z +                        {
2025-11-10T00:08:56.6822998Z                              if !ancestors.contains(&ancestor_hash) {
2025-11-10T00:08:56.6823183Z                                  ancestors.push(ancestor_hash);
2025-11-10T00:08:56.6823304Z                              }
2025-11-10T00:08:56.6823732Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:487:
2025-11-10T00:08:56.6823846Z                  }
2025-11-10T00:08:56.6823967Z              }
2025-11-10T00:08:56.6824085Z          }
2025-11-10T00:08:56.6824194Z -        
2025-11-10T00:08:56.6824501Z +
2025-11-10T00:08:56.6824627Z          ancestors
2025-11-10T00:08:56.6824735Z      }
2025-11-10T00:08:56.6824841Z  
2025-11-10T00:08:56.6825293Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:494:
2025-11-10T00:08:56.6825459Z      /// Helper: Get descendants for a transaction
2025-11-10T00:08:56.6825820Z      fn get_descendants(&self, mempool: &MempoolManager, tx_hash: &Hash) -> Vec<Hash> {
2025-11-10T00:08:56.6825995Z          let mut descendants = Vec::new();
2025-11-10T00:08:56.6827696Z -        
2025-11-10T00:08:56.6827805Z +
2025-11-10T00:08:56.6828018Z          if let Some(tx) = mempool.get_transaction(tx_hash) {
2025-11-10T00:08:56.6828230Z              // Get all output outpoints from this transaction
2025-11-10T00:08:56.6828402Z              let mut output_outpoints = Vec::new();
2025-11-10T00:08:56.6828830Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:520:
2025-11-10T00:08:56.6829199Z                  }
2025-11-10T00:08:56.6829310Z              }
2025-11-10T00:08:56.6829411Z          }
2025-11-10T00:08:56.6829522Z -        
2025-11-10T00:08:56.6829618Z +
2025-11-10T00:08:56.6829727Z          descendants
2025-11-10T00:08:56.6829825Z      }
2025-11-10T00:08:56.6829937Z  }
2025-11-10T00:08:56.6862576Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:1:
2025-11-10T00:08:56.6862758Z  //! Mining RPC methods
2025-11-10T00:08:56.6862871Z -//! 
2025-11-10T00:08:56.6862980Z +//!
2025-11-10T00:08:56.6863403Z  //! Implements mining-related JSON-RPC methods for block template generation and mining.
2025-11-10T00:08:56.6863668Z  //! Uses formally verified consensus-proof mining functions.
2025-11-10T00:08:56.6863778Z  
2025-11-10T00:08:56.6864624Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:6:
2025-11-10T00:08:56.6864809Z -use serde_json::{Value, json};
2025-11-10T00:08:56.6864963Z -use tracing::{debug, warn};
2025-11-10T00:08:56.6865077Z -use hex;
2025-11-10T00:08:56.6865256Z +use crate::node::mempool::MempoolManager;
2025-11-10T00:08:56.6865461Z  use crate::rpc::errors::{RpcError, RpcResult};
2025-11-10T00:08:56.6867639Z -use bllvm_protocol::{ConsensusProof, types::{BlockHeader, Transaction, UtxoSet, Natural, ByteString, Hash}, ValidationResult};
2025-11-10T00:08:56.6867893Z -use bllvm_protocol::serialization::serialize_transaction;
2025-11-10T00:08:56.6868046Z +use crate::storage::Storage;
2025-11-10T00:08:56.6868222Z  use bllvm_protocol::mining::BlockTemplate;
2025-11-10T00:08:56.6868532Z -use bllvm_protocol::serialization::deserialize_block_with_witnesses;
2025-11-10T00:08:56.6869076Z  use bllvm_protocol::pow::expand_target;
2025-11-10T00:08:56.6869215Z -use std::sync::Arc;
2025-11-10T00:08:56.6869356Z -use crate::storage::Storage;
2025-11-10T00:08:56.6869540Z -use crate::node::mempool::MempoolManager;
2025-11-10T00:08:56.6869940Z +use bllvm_protocol::serialization::deserialize_block_with_witnesses;
2025-11-10T00:08:56.6870193Z +use bllvm_protocol::serialization::serialize_transaction;
2025-11-10T00:08:56.6870328Z +use bllvm_protocol::{
2025-11-10T00:08:56.6870657Z +    types::{BlockHeader, ByteString, Hash, Natural, Transaction, UtxoSet},
2025-11-10T00:08:56.6870824Z +    ConsensusProof, ValidationResult,
2025-11-10T00:08:56.6870935Z +};
2025-11-10T00:08:56.6871055Z +use hex;
2025-11-10T00:08:56.6871200Z +use serde_json::{json, Value};
2025-11-10T00:08:56.6871339Z  use sha2::{Digest, Sha256};
2025-11-10T00:08:56.6871467Z +use std::sync::Arc;
2025-11-10T00:08:56.6871612Z +use tracing::{debug, warn};
2025-11-10T00:08:56.6871717Z  
2025-11-10T00:08:56.6871880Z  /// Mining RPC methods with dependencies
2025-11-10T00:08:56.6872027Z  pub struct MiningRpc {
2025-11-10T00:08:56.6872535Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:36:
2025-11-10T00:08:56.6872948Z              mempool: None,
2025-11-10T00:08:56.6873059Z          }
2025-11-10T00:08:56.6873153Z      }
2025-11-10T00:08:56.6873256Z -    
2025-11-10T00:08:56.6873352Z +
2025-11-10T00:08:56.6873542Z      /// Create with dependencies (storage and mempool)
2025-11-10T00:08:56.6873947Z      pub fn with_dependencies(storage: Arc<Storage>, mempool: Arc<MempoolManager>) -> Self {
2025-11-10T00:08:56.6874066Z          Self {
2025-11-10T00:08:56.6874733Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:45:
2025-11-10T00:08:56.6874874Z              mempool: Some(mempool),
2025-11-10T00:08:56.6874989Z          }
2025-11-10T00:08:56.6875100Z      }
2025-11-10T00:08:56.6875206Z -    
2025-11-10T00:08:56.6875317Z +
2025-11-10T00:08:56.6875459Z      /// Get mining information
2025-11-10T00:08:56.6875702Z      pub async fn get_mining_info(&self) -> RpcResult<Value> {
2025-11-10T00:08:56.6875856Z          debug!("RPC: getmininginfo");
2025-11-10T00:08:56.6876307Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:52:
2025-11-10T00:08:56.6876672Z -        
2025-11-10T00:08:56.6876782Z +
2025-11-10T00:08:56.6876965Z          // Get current block height from storage
2025-11-10T00:08:56.6877653Z          let blocks = if let Some(ref storage) = self.storage {
2025-11-10T00:08:56.6877830Z -            storage.chain().get_height()
2025-11-10T00:08:56.6877946Z +            storage
2025-11-10T00:08:56.6878077Z +                .chain()
2025-11-10T00:08:56.6878206Z +                .get_height()
2025-11-10T00:08:56.6878580Z                  .map_err(|e| RpcError::internal_error(format!("Failed to get height: {}", e)))?
2025-11-10T00:08:56.6878720Z                  .unwrap_or(0)
2025-11-10T00:08:56.6878832Z          } else {
2025-11-10T00:08:56.6879278Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:59:
2025-11-10T00:08:56.6879394Z              0
2025-11-10T00:08:56.6879512Z          };
2025-11-10T00:08:56.6879854Z -        
2025-11-10T00:08:56.6879977Z +
2025-11-10T00:08:56.6880132Z          // Get mempool size
2025-11-10T00:08:56.6880379Z          let pooledtx = if let Some(ref mempool) = self.mempool {
2025-11-10T00:08:56.6880510Z              mempool.size()
2025-11-10T00:08:56.6880953Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:65:
2025-11-10T00:08:56.6881074Z          } else {
2025-11-10T00:08:56.6881176Z              0
2025-11-10T00:08:56.6883219Z          };
2025-11-10T00:08:56.6883335Z -        
2025-11-10T00:08:56.6883441Z +
2025-11-10T00:08:56.6883760Z          // Get difficulty from latest block's bits field (graceful degradation)
2025-11-10T00:08:56.6884013Z          let difficulty = if let Some(ref storage) = self.storage {
2025-11-10T00:08:56.6884280Z              if let Ok(Some(tip_header)) = storage.chain().get_tip_header() {
2025-11-10T00:08:56.6884919Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:78:
2025-11-10T00:08:56.6885227Z              tracing::debug!("Storage not available, using default difficulty");
2025-11-10T00:08:56.6885406Z              1.0 // Graceful fallback if no storage
2025-11-10T00:08:56.6885517Z          };
2025-11-10T00:08:56.6885627Z -        
2025-11-10T00:08:56.6885741Z +
2025-11-10T00:08:56.6886524Z          // Calculate network hashrate from recent block timestamps (graceful degradation)
2025-11-10T00:08:56.6886822Z          let networkhashps = if let Some(ref storage) = self.storage {
2025-11-10T00:08:56.6887116Z -            self.calculate_network_hashrate(storage).unwrap_or_else(|e| {
2025-11-10T00:08:56.6887465Z -                tracing::debug!("Failed to calculate network hashrate: {}, using 0.0", e);
2025-11-10T00:08:56.6887582Z -                0.0
2025-11-10T00:08:56.6887695Z -            })
2025-11-10T00:08:56.6887886Z +            self.calculate_network_hashrate(storage)
2025-11-10T00:08:56.6888031Z +                .unwrap_or_else(|e| {
2025-11-10T00:08:56.6888372Z +                    tracing::debug!("Failed to calculate network hashrate: {}, using 0.0", e);
2025-11-10T00:08:56.6888498Z +                    0.0
2025-11-10T00:08:56.6888605Z +                })
2025-11-10T00:08:56.6888712Z          } else {
2025-11-10T00:08:56.6889028Z              tracing::debug!("Storage not available, network hashrate unavailable");
2025-11-10T00:08:56.6889145Z              0.0
2025-11-10T00:08:56.6889575Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:91:
2025-11-10T00:08:56.6889680Z          };
2025-11-10T00:08:56.6889790Z -        
2025-11-10T00:08:56.6889894Z +
2025-11-10T00:08:56.6890097Z          // Get current block template info (if available)
2025-11-10T00:08:56.6890241Z          let currentblocksize = 0;
2025-11-10T00:08:56.6890394Z          let currentblockweight = 0;
2025-11-10T00:08:56.6890829Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:96:
2025-11-10T00:08:56.6890975Z          let currentblocktx = 0;
2025-11-10T00:08:56.6891089Z -        
2025-11-10T00:08:56.6891432Z +
2025-11-10T00:08:56.6891645Z          // Determine chain name from storage chain params
2025-11-10T00:08:56.6891870Z          let chain = if let Some(ref storage) = self.storage {
2025-11-10T00:08:56.6892111Z              if let Ok(Some(info)) = storage.chain().load_chain_info() {
2025-11-10T00:08:56.6892557Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:110:
2025-11-10T00:08:56.6892665Z          } else {
2025-11-10T00:08:56.6892796Z              "main" // Default
2025-11-10T00:08:56.6892897Z          };
2025-11-10T00:08:56.6893133Z -        
2025-11-10T00:08:56.6893236Z +
2025-11-10T00:08:56.6893342Z          Ok(json!({
2025-11-10T00:08:56.6893456Z              "blocks": blocks,
2025-11-10T00:08:56.6893622Z              "currentblocksize": currentblocksize,
2025-11-10T00:08:56.6894073Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:123:
2025-11-10T00:08:56.6894577Z              "warnings": ""
2025-11-10T00:08:56.6894708Z          }))
2025-11-10T00:08:56.6894828Z      }
2025-11-10T00:08:56.6894931Z -    
2025-11-10T00:08:56.6895035Z +
2025-11-10T00:08:56.6895166Z      /// Get block template
2025-11-10T00:08:56.6895278Z -    /// 
2025-11-10T00:08:56.6895382Z +    ///
2025-11-10T00:08:56.6895554Z      /// Params: [template_request (optional)]
2025-11-10T00:08:56.6895668Z -    /// 
2025-11-10T00:08:56.6895773Z +    ///
2025-11-10T00:08:56.6896174Z      /// Uses formally verified consensus-proof::mining::create_block_template() function
2025-11-10T00:08:56.6896510Z      /// which has Kani proofs ensuring correctness per Orange Paper Section 12.4
2025-11-10T00:08:56.6896851Z      pub async fn get_block_template(&self, params: &Value) -> RpcResult<Value> {
2025-11-10T00:08:56.6897295Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:134:
2025-11-10T00:08:56.6897452Z          debug!("RPC: getblocktemplate");
2025-11-10T00:08:56.6897569Z -        
2025-11-10T00:08:56.6897674Z +
2025-11-10T00:08:56.6897816Z          // 1. Get current chainstate
2025-11-10T00:08:56.6898025Z -        let height: Natural = self.get_current_height()?
2025-11-10T00:08:56.6898171Z +        let height: Natural = self
2025-11-10T00:08:56.6898305Z +            .get_current_height()?
2025-11-10T00:08:56.6898680Z              .ok_or_else(|| RpcError::internal_error("Chain not initialized"))?;
2025-11-10T00:08:56.6898862Z -        let prev_header = self.get_tip_header()?
2025-11-10T00:08:56.6898989Z +        let prev_header = self
2025-11-10T00:08:56.6899107Z +            .get_tip_header()?
2025-11-10T00:08:56.6899329Z              .ok_or_else(|| RpcError::internal_error("No chain tip"))?;
2025-11-10T00:08:56.6899534Z          let prev_headers = self.get_headers_for_difficulty()?;
2025-11-10T00:08:56.6899631Z -        
2025-11-10T00:08:56.6899744Z +
2025-11-10T00:08:56.6899890Z          // 2. Get mempool transactions
2025-11-10T00:08:56.6900204Z          let mempool_txs: Vec<Transaction> = self.get_mempool_transactions()?;
2025-11-10T00:08:56.6900314Z -        
2025-11-10T00:08:56.6900418Z +
2025-11-10T00:08:56.6900537Z          // 3. Get UTXO set
2025-11-10T00:08:56.6900682Z          let utxo_set = self.get_utxo_set()?;
2025-11-10T00:08:56.6900789Z -        
2025-11-10T00:08:56.6900884Z +
2025-11-10T00:08:56.6901120Z          // 4. Extract coinbase parameters from request or use defaults
2025-11-10T00:08:56.6901466Z          let coinbase_script = self.extract_coinbase_script(params).unwrap_or_default();
2025-11-10T00:08:56.6901838Z          let coinbase_address = self.extract_coinbase_address(params).unwrap_or_default();
2025-11-10T00:08:56.6902253Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:152:
2025-11-10T00:08:56.6902353Z -        
2025-11-10T00:08:56.6902456Z +
2025-11-10T00:08:56.6904743Z          // 5. Use formally verified function from consensus-proof
2025-11-10T00:08:56.6905088Z          // This function has Kani proofs: kani_create_block_template_completeness
2025-11-10T00:08:56.6905606Z          let template = match self.consensus.create_block_template(
2025-11-10T00:08:56.6906060Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:164:
2025-11-10T00:08:56.6906187Z              Ok(t) => t,
2025-11-10T00:08:56.6906297Z              Err(e) => {
2025-11-10T00:08:56.6906510Z                  warn!("Failed to create block template: {}", e);
2025-11-10T00:08:56.6906910Z -                return Err(RpcError::internal_error(format!("Template creation failed: {}", e)));
2025-11-10T00:08:56.6907114Z +                return Err(RpcError::internal_error(format!(
2025-11-10T00:08:56.6907286Z +                    "Template creation failed: {}",
2025-11-10T00:08:56.6907470Z +                    e
2025-11-10T00:08:56.6907628Z +                )));
2025-11-10T00:08:56.6907747Z              }
2025-11-10T00:08:56.6907873Z          };
2025-11-10T00:08:56.6907991Z -        
2025-11-10T00:08:56.6908335Z +
2025-11-10T00:08:56.6908530Z          // 6. Convert to JSON-RPC format (BIP 22/23)
2025-11-10T00:08:56.6908787Z          self.template_to_json_rpc(&template, &prev_header, height)
2025-11-10T00:08:56.6908887Z      }
2025-11-10T00:08:56.6909308Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:174:
2025-11-10T00:08:56.6909405Z -    
2025-11-10T00:08:56.6909508Z +
2025-11-10T00:08:56.6909679Z      /// Convert BlockTemplate to JSON-RPC format
2025-11-10T00:08:56.6909814Z      fn template_to_json_rpc(
2025-11-10T00:08:56.6909933Z          &self,
2025-11-10T00:08:56.6918065Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:181:
2025-11-10T00:08:56.6918261Z      ) -> RpcResult<Value> {
2025-11-10T00:08:56.6918499Z          // Convert previous block hash to hex (big-endian)
2025-11-10T00:08:56.6918785Z          let prev_hash_hex = hex::encode(prev_header.prev_block_hash);
2025-11-10T00:08:56.6918897Z -        
2025-11-10T00:08:56.6919030Z +
2025-11-10T00:08:56.6919258Z          // Convert target to hex (64 characters, big-endian)
2025-11-10T00:08:56.6919490Z          let target_hex = format!("{:064x}", template.target);
2025-11-10T00:08:56.6919611Z -        
2025-11-10T00:08:56.6919732Z +
2025-11-10T00:08:56.6919887Z          // Convert bits to hex (8 characters)
2025-11-10T00:08:56.6920108Z          let bits_hex = format!("{:08x}", template.header.bits);
2025-11-10T00:08:56.6920226Z -        
2025-11-10T00:08:56.6920330Z +
2025-11-10T00:08:56.6920488Z          // Convert transactions to JSON array
2025-11-10T00:08:56.6920753Z -        let transactions_json: Vec<Value> = template.transactions
2025-11-10T00:08:56.6920936Z +        let transactions_json: Vec<Value> = template
2025-11-10T00:08:56.6921062Z +            .transactions
2025-11-10T00:08:56.6921172Z              .iter()
2025-11-10T00:08:56.6921356Z              .map(|tx| self.transaction_to_json(tx))
2025-11-10T00:08:56.6921482Z              .collect();
2025-11-10T00:08:56.6921952Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:196:
2025-11-10T00:08:56.6922076Z -        
2025-11-10T00:08:56.6922185Z +
2025-11-10T00:08:56.6922369Z          // Calculate coinbase value (subsidy + fees)
2025-11-10T00:08:56.6922680Z          let coinbase_value = self.calculate_coinbase_value(template, height);
2025-11-10T00:08:56.6922801Z -        
2025-11-10T00:08:56.6922904Z +
2025-11-10T00:08:56.6923066Z          // Get active rules (BIP 9 feature flags)
2025-11-10T00:08:56.6923233Z          let rules = self.get_active_rules(height);
2025-11-10T00:08:56.6923329Z -        
2025-11-10T00:08:56.6923423Z +
2025-11-10T00:08:56.6923565Z          // Get minimum time (median time + 1)
2025-11-10T00:08:56.6923727Z          let min_time = self.get_min_time(height);
2025-11-10T00:08:56.6923823Z -        
2025-11-10T00:08:56.6923916Z +
2025-11-10T00:08:56.6924032Z          Ok(json!({
2025-11-10T00:08:56.6924188Z              "capabilities": ["proposal"],
2025-11-10T00:08:56.6924574Z              "version": template.header.version as i32,
2025-11-10T00:08:56.6925289Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:228:
2025-11-10T00:08:56.6925439Z              "height": template.height
2025-11-10T00:08:56.6925537Z          }))
2025-11-10T00:08:56.6925632Z      }
2025-11-10T00:08:56.6925734Z -    
2025-11-10T00:08:56.6925829Z +
2025-11-10T00:08:56.6926018Z      // Helper methods - access chainstate and mempool
2025-11-10T00:08:56.6926113Z -    
2025-11-10T00:08:56.6926213Z +
2025-11-10T00:08:56.6926456Z      fn get_current_height(&self) -> RpcResult<Option<Natural>> {
2025-11-10T00:08:56.6926624Z          if let Some(ref storage) = self.storage {
2025-11-10T00:08:56.6926783Z -            storage.chain().get_height()
2025-11-10T00:08:56.6926890Z +            storage
2025-11-10T00:08:56.6926997Z +                .chain()
2025-11-10T00:08:56.6927110Z +                .get_height()
2025-11-10T00:08:56.6927640Z                  .map_err(|e| RpcError::internal_error(format!("Failed to get height: {}", e)))
2025-11-10T00:08:56.6927777Z          } else {
2025-11-10T00:08:56.6927893Z              Ok(None)
2025-11-10T00:08:56.6928355Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:240:
2025-11-10T00:08:56.6928467Z          }
2025-11-10T00:08:56.6928566Z      }
2025-11-10T00:08:56.6928667Z -    
2025-11-10T00:08:56.6928763Z +
2025-11-10T00:08:56.6928994Z      fn get_tip_header(&self) -> RpcResult<Option<BlockHeader>> {
2025-11-10T00:08:56.6929152Z          if let Some(ref storage) = self.storage {
2025-11-10T00:08:56.6929307Z -            storage.chain().get_tip_header()
2025-11-10T00:08:56.6929409Z +            storage
2025-11-10T00:08:56.6929527Z +                .chain()
2025-11-10T00:08:56.6929661Z +                .get_tip_header()
2025-11-10T00:08:56.6930007Z                  .map_err(|e| RpcError::internal_error(format!("Failed to get tip header: {}", e)))
2025-11-10T00:08:56.6930108Z          } else {
2025-11-10T00:08:56.6930218Z              Ok(None)
2025-11-10T00:08:56.6930635Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:249:
2025-11-10T00:08:56.6930741Z          }
2025-11-10T00:08:56.6930834Z      }
2025-11-10T00:08:56.6930935Z -    
2025-11-10T00:08:56.6931033Z +
2025-11-10T00:08:56.6931311Z      fn get_headers_for_difficulty(&self) -> RpcResult<Vec<BlockHeader>> {
2025-11-10T00:08:56.6931467Z          if let Some(ref storage) = self.storage {
2025-11-10T00:08:56.6931658Z              // Get last 2016 headers for difficulty adjustment
2025-11-10T00:08:56.6932089Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:255:
2025-11-10T00:08:56.6932389Z              // For now, return just the tip (full implementation would get last 2016)
2025-11-10T00:08:56.6932596Z -            if let Some(tip) = storage.chain().get_tip_header()
2025-11-10T00:08:56.6932735Z +            if let Some(tip) = storage
2025-11-10T00:08:56.6932853Z +                .chain()
2025-11-10T00:08:56.6932979Z +                .get_tip_header()
2025-11-10T00:08:56.6933297Z                  .map_err(|e| RpcError::internal_error(format!("Failed to get tip: {}", e)))?
2025-11-10T00:08:56.6933404Z              {
2025-11-10T00:08:56.6933525Z                  Ok(vec![tip])
2025-11-10T00:08:56.6934011Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:264:
2025-11-10T00:08:56.6934118Z              Ok(vec![])
2025-11-10T00:08:56.6934221Z          }
2025-11-10T00:08:56.6934505Z      }
2025-11-10T00:08:56.6934618Z -    
2025-11-10T00:08:56.6934719Z +
2025-11-10T00:08:56.6935001Z      fn get_mempool_transactions(&self) -> RpcResult<Vec<Transaction>> {
2025-11-10T00:08:56.6935166Z          if let Some(ref mempool) = self.mempool {
2025-11-10T00:08:56.6935312Z              // Get UTXO set for fee calculation
2025-11-10T00:08:56.6935710Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:271:
2025-11-10T00:08:56.6935872Z              let utxo_set = self.get_utxo_set()?;
2025-11-10T00:08:56.6936226Z -            
2025-11-10T00:08:56.6936340Z +
2025-11-10T00:08:56.6936735Z              // Get prioritized transactions (limit to reasonable number for block template)
2025-11-10T00:08:56.6936871Z              let limit = 1000;
2025-11-10T00:08:56.6937131Z              Ok(mempool.get_prioritized_transactions(limit, &utxo_set))
2025-11-10T00:08:56.6937560Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:277:
2025-11-10T00:08:56.6937686Z              Ok(vec![])
2025-11-10T00:08:56.6937798Z          }
2025-11-10T00:08:56.6937899Z      }
2025-11-10T00:08:56.6938142Z -    
2025-11-10T00:08:56.6938250Z +
2025-11-10T00:08:56.6938494Z      /// Calculate difficulty from bits (compact target format)
2025-11-10T00:08:56.6938762Z      /// Uses the same logic as BlockchainRpc::calculate_difficulty
2025-11-10T00:08:56.6938954Z      fn calculate_difficulty(bits: u64) -> f64 {
2025-11-10T00:08:56.6939618Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:284:
2025-11-10T00:08:56.6939801Z          // Difficulty = MAX_TARGET / target
2025-11-10T00:08:56.6940292Z          // MAX_TARGET for Bitcoin mainnet is 0x00000000FFFF0000000000000000000000000000000000000000000000000000
2025-11-10T00:08:56.6940585Z          // For display purposes, we normalize to genesis difficulty = 1.0
2025-11-10T00:08:56.6941137Z -        const MAX_TARGET: u128 = 0x00000000FFFF0000000000000000000000000000000000000000000000000000u128;
2025-11-10T00:08:56.6941263Z -        
2025-11-10T00:08:56.6941406Z +        const MAX_TARGET: u128 =
2025-11-10T00:08:56.6941735Z +            0x00000000FFFF0000000000000000000000000000000000000000000000000000u128;
2025-11-10T00:08:56.6941853Z +
2025-11-10T00:08:56.6942099Z          // Simplified difficulty calculation using bits directly
2025-11-10T00:08:56.6942386Z          // For display purposes, use a simple approximation based on bits
2025-11-10T00:08:56.6942564Z          let mantissa = (bits & 0x00ffffff) as f64;
2025-11-10T00:08:56.6943024Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:295:
2025-11-10T00:08:56.6943186Z          let max_mantissa = 0x00ffff00 as f64;
2025-11-10T00:08:56.6943342Z          (max_mantissa / mantissa).max(1.0)
2025-11-10T00:08:56.6943461Z      }
2025-11-10T00:08:56.6943645Z -    
2025-11-10T00:08:56.6943754Z +
2025-11-10T00:08:56.6944004Z      /// Calculate network hashrate from recent block timestamps
2025-11-10T00:08:56.6944447Z      /// Estimates hashrate based on the time between recent blocks
2025-11-10T00:08:56.6944854Z      fn calculate_network_hashrate(&self, storage: &Storage) -> Result<f64, anyhow::Error> {
2025-11-10T00:08:56.6945285Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:302:
2025-11-10T00:08:56.6945433Z          // Get tip height
2025-11-10T00:08:56.6945623Z -        let tip_height = storage.chain().get_height()?
2025-11-10T00:08:56.6945773Z +        let tip_height = storage
2025-11-10T00:08:56.6945898Z +            .chain()
2025-11-10T00:08:56.6946025Z +            .get_height()?
2025-11-10T00:08:56.6946249Z              .ok_or_else(|| anyhow::anyhow!("Chain not initialized"))?;
2025-11-10T00:08:56.6946353Z -        
2025-11-10T00:08:56.6946454Z +
2025-11-10T00:08:56.6946625Z          // Need at least 2 blocks to calculate hashrate
2025-11-10T00:08:56.6946746Z          if tip_height < 1 {
2025-11-10T00:08:56.6946863Z              return Ok(0.0);
2025-11-10T00:08:56.6947274Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:309:
2025-11-10T00:08:56.6947382Z          }
2025-11-10T00:08:56.6947488Z -        
2025-11-10T00:08:56.6947596Z +
2025-11-10T00:08:56.6947824Z          // Get last 144 blocks (approximately 1 day at 10 min/block)
2025-11-10T00:08:56.6947980Z          // Or use fewer blocks if chain is shorter
2025-11-10T00:08:56.6948149Z          let num_blocks = (tip_height + 1).min(144);
2025-11-10T00:08:56.6948558Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:314:
2025-11-10T00:08:56.6949050Z          let start_height = tip_height.saturating_sub(num_blocks - 1);
2025-11-10T00:08:56.6949170Z -        
2025-11-10T00:08:56.6949278Z +
2025-11-10T00:08:56.6949432Z          // Get timestamps from blocks
2025-11-10T00:08:56.6949597Z          let mut timestamps = Vec::new();
2025-11-10T00:08:56.6949778Z          for height in start_height..=tip_height {
2025-11-10T00:08:56.6950217Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:322:
2025-11-10T00:08:56.6950330Z                  }
2025-11-10T00:08:56.6950445Z              }
2025-11-10T00:08:56.6950550Z          }
2025-11-10T00:08:56.6950654Z -        
2025-11-10T00:08:56.6950756Z +
2025-11-10T00:08:56.6950909Z          if timestamps.len() < 2 {
2025-11-10T00:08:56.6951038Z              return Ok(0.0);
2025-11-10T00:08:56.6953047Z          }
2025-11-10T00:08:56.6953712Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:329:
2025-11-10T00:08:56.6953838Z -        
2025-11-10T00:08:56.6953945Z +
2025-11-10T00:08:56.6954111Z          // Calculate average time between blocks
2025-11-10T00:08:56.6954511Z          let first_timestamp = timestamps[0].1;
2025-11-10T00:08:56.6954775Z          let last_timestamp = timestamps[timestamps.len() - 1].1;
2025-11-10T00:08:56.6955215Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:333:
2025-11-10T00:08:56.6955502Z          let time_span = last_timestamp.saturating_sub(first_timestamp);
2025-11-10T00:08:56.6955689Z          let num_intervals = timestamps.len() - 1;
2025-11-10T00:08:56.6955806Z -        
2025-11-10T00:08:56.6955916Z +
2025-11-10T00:08:56.6956090Z          if time_span == 0 || num_intervals == 0 {
2025-11-10T00:08:56.6956221Z              return Ok(0.0);
2025-11-10T00:08:56.6956330Z          }
2025-11-10T00:08:56.6956774Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:339:
2025-11-10T00:08:56.6956894Z -        
2025-11-10T00:08:56.6957002Z +
2025-11-10T00:08:56.6957282Z          let avg_time_per_block = time_span as f64 / num_intervals as f64;
2025-11-10T00:08:56.6957393Z -        
2025-11-10T00:08:56.6957500Z +
2025-11-10T00:08:56.6957648Z          // Get difficulty from tip block
2025-11-10T00:08:56.6957921Z -        let tip_hash = storage.blocks().get_hash_by_height(tip_height)?
2025-11-10T00:08:56.6958051Z +        let tip_hash = storage
2025-11-10T00:08:56.6958168Z +            .blocks()
2025-11-10T00:08:56.6958330Z +            .get_hash_by_height(tip_height)?
2025-11-10T00:08:56.6958556Z              .ok_or_else(|| anyhow::anyhow!("Tip block not found"))?;
2025-11-10T00:08:56.6958776Z -        let tip_block = storage.blocks().get_block(&tip_hash)?
2025-11-10T00:08:56.6958899Z +        let tip_block = storage
2025-11-10T00:08:56.6959016Z +            .blocks()
2025-11-10T00:08:56.6959150Z +            .get_block(&tip_hash)?
2025-11-10T00:08:56.6959353Z              .ok_or_else(|| anyhow::anyhow!("Tip block not found"))?;
2025-11-10T00:08:56.6959662Z          let difficulty = Self::calculate_difficulty(tip_block.header.bits);
2025-11-10T00:08:56.6959772Z -        
2025-11-10T00:08:56.6959881Z +
2025-11-10T00:08:56.6960159Z          // Calculate hashrate: difficulty * 2^32 / avg_time_per_block
2025-11-10T00:08:56.6960409Z          // This estimates the network hashrate in hashes per second
2025-11-10T00:08:56.6960767Z          // 2^32 is the number of hashes needed on average to find a block at difficulty 1.0
2025-11-10T00:08:56.6961225Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:352:
2025-11-10T00:08:56.6961464Z          const HASHES_PER_DIFFICULTY: f64 = 4294967296.0; // 2^32
2025-11-10T00:08:56.6961793Z          let hashrate = (difficulty * HASHES_PER_DIFFICULTY) / avg_time_per_block;
2025-11-10T00:08:56.6961902Z -        
2025-11-10T00:08:56.6962022Z +
2025-11-10T00:08:56.6962157Z          Ok(hashrate)
2025-11-10T00:08:56.6962267Z      }
2025-11-10T00:08:56.6962617Z -    
2025-11-10T00:08:56.6964765Z +
2025-11-10T00:08:56.6964967Z      fn get_utxo_set(&self) -> RpcResult<UtxoSet> {
2025-11-10T00:08:56.6965144Z          if let Some(ref storage) = self.storage {
2025-11-10T00:08:56.6965303Z              // Get UTXO set from storage
2025-11-10T00:08:56.6965758Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:361:
2025-11-10T00:08:56.6965918Z -            storage.utxos().get_all_utxos()
2025-11-10T00:08:56.6966043Z +            storage
2025-11-10T00:08:56.6966164Z +                .utxos()
2025-11-10T00:08:56.6966298Z +                .get_all_utxos()
2025-11-10T00:08:56.6966669Z                  .map_err(|e| RpcError::internal_error(format!("Failed to get UTXO set: {}", e)))
2025-11-10T00:08:56.6966797Z          } else {
2025-11-10T00:08:56.6966936Z              Ok(UtxoSet::new())
2025-11-10T00:08:56.6967700Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:365:
2025-11-10T00:08:56.6967855Z          }
2025-11-10T00:08:56.6967963Z      }
2025-11-10T00:08:56.6968068Z -    
2025-11-10T00:08:56.6968173Z +
2025-11-10T00:08:56.6968534Z      fn extract_coinbase_script(&self, params: &Value) -> Option<ByteString> {
2025-11-10T00:08:56.6968749Z          // Extract coinbase script from params if provided
2025-11-10T00:08:56.6968947Z          if let Some(template_request) = params.get(0) {
2025-11-10T00:08:56.6969406Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:379:
2025-11-10T00:08:56.6969550Z          // Default: empty script
2025-11-10T00:08:56.6969671Z          Some(vec![])
2025-11-10T00:08:56.6969782Z      }
2025-11-10T00:08:56.6969905Z -    
2025-11-10T00:08:56.6970010Z +
2025-11-10T00:08:56.6970344Z      fn extract_coinbase_address(&self, params: &Value) -> Option<ByteString> {
2025-11-10T00:08:56.6970567Z          // Extract coinbase address from params if provided
2025-11-10T00:08:56.6970769Z          if let Some(template_request) = params.get(0) {
2025-11-10T00:08:56.6971211Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:393:
2025-11-10T00:08:56.6971331Z          // Default: empty
2025-11-10T00:08:56.6971437Z          Some(vec![])
2025-11-10T00:08:56.6971535Z      }
2025-11-10T00:08:56.6971637Z -    
2025-11-10T00:08:56.6971731Z +
2025-11-10T00:08:56.6971952Z      fn transaction_to_json(&self, tx: &Transaction) -> Value {
2025-11-10T00:08:56.6972134Z          // Convert transaction to JSON-RPC format
2025-11-10T00:08:56.6972305Z          let tx_bytes = serialize_transaction(tx);
2025-11-10T00:08:56.6972969Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:401:
2025-11-10T00:08:56.6973170Z          let fee = self.calculate_transaction_fee(tx);
2025-11-10T00:08:56.6973330Z          let sigops = self.count_sigops(tx);
2025-11-10T00:08:56.6973489Z          let weight = self.calculate_weight(tx);
2025-11-10T00:08:56.6973598Z -        
2025-11-10T00:08:56.6973704Z +
2025-11-10T00:08:56.6973812Z          json!({
2025-11-10T00:08:56.6973957Z              "data": hex::encode(&tx_bytes),
2025-11-10T00:08:56.6974102Z              "txid": hex::encode(tx_hash),
2025-11-10T00:08:56.6974685Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:410:
2025-11-10T00:08:56.6974822Z              "weight": weight,
2025-11-10T00:08:56.6974929Z          })
2025-11-10T00:08:56.6975046Z      }
2025-11-10T00:08:56.6975704Z -    
2025-11-10T00:08:56.6975804Z +
2025-11-10T00:08:56.6976047Z      fn calculate_tx_hash(&self, tx_bytes: &[u8]) -> [u8; 32] {
2025-11-10T00:08:56.6976285Z          // Transaction hash is double SHA256 of transaction bytes
2025-11-10T00:08:56.6976440Z          let hash1 = Sha256::digest(tx_bytes);
2025-11-10T00:08:56.6976872Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:417:
2025-11-10T00:08:56.6977048Z          let hash2 = Sha256::digest(hash1);
2025-11-10T00:08:56.6977148Z -        
2025-11-10T00:08:56.6977488Z +
2025-11-10T00:08:56.6977636Z          let mut result = [0u8; 32];
2025-11-10T00:08:56.6977778Z          result.copy_from_slice(&hash2);
2025-11-10T00:08:56.6977882Z          result
2025-11-10T00:08:56.6978314Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:422:
2025-11-10T00:08:56.6978429Z      }
2025-11-10T00:08:56.6978537Z -    
2025-11-10T00:08:56.6978641Z +
2025-11-10T00:08:56.6978941Z      fn calculate_transaction_fee(&self, tx: &Transaction) -> u64 {
2025-11-10T00:08:56.6979164Z          // Use MempoolManager's fee calculation if available
2025-11-10T00:08:56.6979343Z          if let Some(ref mempool) = self.mempool {
2025-11-10T00:08:56.6979801Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:447:
2025-11-10T00:08:56.6979910Z              0
2025-11-10T00:08:56.6980023Z          }
2025-11-10T00:08:56.6980132Z      }
2025-11-10T00:08:56.6980472Z -    
2025-11-10T00:08:56.6980593Z +
2025-11-10T00:08:56.6980804Z      fn count_sigops(&self, tx: &Transaction) -> u32 {
2025-11-10T00:08:56.6980986Z          // Use consensus layer sigop counting
2025-11-10T00:08:56.6981126Z          #[cfg(feature = "sigop")]
2025-11-10T00:08:56.6981569Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:456:
2025-11-10T00:08:56.6981862Z              // Convert protocol transaction to consensus transaction format
2025-11-10T00:08:56.6982033Z              let consensus_tx = ConsensusTx {
2025-11-10T00:08:56.6982174Z                  version: tx.version,
2025-11-10T00:08:56.6982506Z -                inputs: tx.inputs.iter().map(|inp| bllvm_protocol::TransactionInput {
2025-11-10T00:08:56.6982700Z -                    prevout: bllvm_protocol::OutPoint {
2025-11-10T00:08:56.6982858Z -                        hash: inp.prevout.hash,
2025-11-10T00:08:56.6983017Z -                        index: inp.prevout.index,
2025-11-10T00:08:56.6983147Z -                    },
2025-11-10T00:08:56.6983321Z -                    script_sig: inp.script_sig.clone(),
2025-11-10T00:08:56.6983478Z -                    sequence: inp.sequence,
2025-11-10T00:08:56.6983605Z -                }).collect(),
2025-11-10T00:08:56.6984581Z -                outputs: tx.outputs.iter().map(|out| bllvm_protocol::TransactionOutput {
2025-11-10T00:08:56.6984741Z -                    value: out.value,
2025-11-10T00:08:56.6984944Z -                    script_pubkey: out.script_pubkey.clone(),
2025-11-10T00:08:56.6985080Z -                }).collect(),
2025-11-10T00:08:56.6985208Z +                inputs: tx
2025-11-10T00:08:56.6985335Z +                    .inputs
2025-11-10T00:08:56.6985450Z +                    .iter()
2025-11-10T00:08:56.6985668Z +                    .map(|inp| bllvm_protocol::TransactionInput {
2025-11-10T00:08:56.6985834Z +                        prevout: bllvm_protocol::OutPoint {
2025-11-10T00:08:56.6985996Z +                            hash: inp.prevout.hash,
2025-11-10T00:08:56.6986179Z +                            index: inp.prevout.index,
2025-11-10T00:08:56.6986306Z +                        },
2025-11-10T00:08:56.6986484Z +                        script_sig: inp.script_sig.clone(),
2025-11-10T00:08:56.6986632Z +                        sequence: inp.sequence,
2025-11-10T00:08:56.6986736Z +                    })
2025-11-10T00:08:56.6986848Z +                    .collect(),
2025-11-10T00:08:56.6986962Z +                outputs: tx
2025-11-10T00:08:56.6987081Z +                    .outputs
2025-11-10T00:08:56.6987183Z +                    .iter()
2025-11-10T00:08:56.6987388Z +                    .map(|out| bllvm_protocol::TransactionOutput {
2025-11-10T00:08:56.6987539Z +                        value: out.value,
2025-11-10T00:08:56.6987736Z +                        script_pubkey: out.script_pubkey.clone(),
2025-11-10T00:08:56.6987854Z +                    })
2025-11-10T00:08:56.6987978Z +                    .collect(),
2025-11-10T00:08:56.6988136Z                  lock_time: tx.lock_time,
2025-11-10T00:08:56.6988249Z              };
2025-11-10T00:08:56.6988771Z              use bllvm_protocol::sigop::get_legacy_sigop_count;
2025-11-10T00:08:56.6989241Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:480:
2025-11-10T00:08:56.6989397Z              for output in &tx.outputs {
2025-11-10T00:08:56.6989571Z                  for &byte in &output.script_pubkey {
2025-11-10T00:08:56.6989711Z                      match byte {
2025-11-10T00:08:56.6989938Z -                        0xac => count += 1, // OP_CHECKSIG
2025-11-10T00:08:56.6990116Z -                        0xad => count += 1, // OP_CHECKSIGVERIFY
2025-11-10T00:08:56.6990279Z -                        0xae => count += 1, // OP_CHECKMULTISIG
2025-11-10T00:08:56.6990444Z +                        0xac => count += 1,  // OP_CHECKSIG
2025-11-10T00:08:56.6990617Z +                        0xad => count += 1,  // OP_CHECKSIGVERIFY
2025-11-10T00:08:56.6990993Z +                        0xae => count += 1,  // OP_CHECKMULTISIG
2025-11-10T00:08:56.6991202Z                          0xaf => count += 20, // OP_CHECKMULTISIGVERIFY
2025-11-10T00:08:56.6991328Z                          _ => {}
2025-11-10T00:08:56.6991441Z                      }
2025-11-10T00:08:56.6991891Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:491:
2025-11-10T00:08:56.6992009Z              count
2025-11-10T00:08:56.6992122Z          }
2025-11-10T00:08:56.6992224Z      }
2025-11-10T00:08:56.6992326Z -    
2025-11-10T00:08:56.6992421Z +
2025-11-10T00:08:56.6992629Z      fn calculate_weight(&self, tx: &Transaction) -> u64 {
2025-11-10T00:08:56.6992884Z          // Transaction weight = (base_size * 3) + total_size (for SegWit)
2025-11-10T00:08:56.6993093Z          // For now, return base size * 4 (non-SegWit transaction)
2025-11-10T00:08:56.6993507Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:498:
2025-11-10T00:08:56.6993738Z          let base_size = serialize_transaction(tx).len() as u64;
2025-11-10T00:08:56.6993867Z          base_size * 4
2025-11-10T00:08:56.6993982Z      }
2025-11-10T00:08:56.6994093Z -    
2025-11-10T00:08:56.6994207Z +
2025-11-10T00:08:56.6994772Z      fn calculate_coinbase_value(&self, template: &BlockTemplate, _height: Natural) -> u64 {
2025-11-10T00:08:56.6995048Z          // Use consensus-proof's get_block_subsidy (formally verified)
2025-11-10T00:08:56.6995373Z          let subsidy = self.consensus.get_block_subsidy(template.height) as u64;
2025-11-10T00:08:56.6995824Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:505:
2025-11-10T00:08:56.6995935Z -        
2025-11-10T00:08:56.6996040Z +
2025-11-10T00:08:56.6996218Z          // Calculate total fees from transactions
2025-11-10T00:08:56.6996384Z -        let fees: u64 = template.transactions
2025-11-10T00:08:56.6996520Z +        let fees: u64 = template
2025-11-10T00:08:56.6996655Z +            .transactions
2025-11-10T00:08:56.6996774Z              .iter()
2025-11-10T00:08:56.6996972Z              .map(|tx| self.calculate_transaction_fee(tx))
2025-11-10T00:08:56.6997086Z              .sum();
2025-11-10T00:08:56.6997530Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:511:
2025-11-10T00:08:56.6997644Z -        
2025-11-10T00:08:56.6997748Z +
2025-11-10T00:08:56.6997874Z          subsidy + fees
2025-11-10T00:08:56.6997983Z      }
2025-11-10T00:08:56.6998088Z -    
2025-11-10T00:08:56.6998195Z +
2025-11-10T00:08:56.7000307Z      fn get_active_rules(&self, height: Natural) -> Vec<String> {
2025-11-10T00:08:56.7000502Z          // Determine active BIP 9 rules based on height
2025-11-10T00:08:56.7000791Z          let mut rules = vec!["csv".to_string()]; // CSV always active after height
2025-11-10T00:08:56.7001230Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:518:
2025-11-10T00:08:56.7001330Z -        
2025-11-10T00:08:56.7001540Z -        if height >= 481824 { // SegWit activation (mainnet)
2025-11-10T00:08:56.7001650Z +
2025-11-10T00:08:56.7002004Z +        if height >= 481824 {
2025-11-10T00:08:56.7002149Z +            // SegWit activation (mainnet)
2025-11-10T00:08:56.7002301Z              rules.push("segwit".to_string());
2025-11-10T00:08:56.7002410Z          }
2025-11-10T00:08:56.7002509Z -        
2025-11-10T00:08:56.7002703Z -        if height >= 709632 { // Taproot activation (mainnet)
2025-11-10T00:08:56.7002803Z +
2025-11-10T00:08:56.7002928Z +        if height >= 709632 {
2025-11-10T00:08:56.7003071Z +            // Taproot activation (mainnet)
2025-11-10T00:08:56.7003223Z              rules.push("taproot".to_string());
2025-11-10T00:08:56.7003330Z          }
2025-11-10T00:08:56.7003430Z -        
2025-11-10T00:08:56.7003529Z +
2025-11-10T00:08:56.7003633Z          rules
2025-11-10T00:08:56.7003741Z      }
2025-11-10T00:08:56.7003841Z -    
2025-11-10T00:08:56.7003938Z +
2025-11-10T00:08:56.7004140Z      fn get_min_time(&self, _height: Natural) -> Natural {
2025-11-10T00:08:56.7004660Z          // Get minimum time (median time of last 11 blocks + 1)
2025-11-10T00:08:56.7004815Z          // For now, return current time
2025-11-10T00:08:56.7005236Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:535:
2025-11-10T00:08:56.7005350Z              .unwrap()
2025-11-10T00:08:56.7005473Z              .as_secs() as Natural
2025-11-10T00:08:56.7005585Z      }
2025-11-10T00:08:56.7005700Z -    
2025-11-10T00:08:56.7005806Z +
2025-11-10T00:08:56.7005946Z      /// Submit a block to the network
2025-11-10T00:08:56.7006050Z -    /// 
2025-11-10T00:08:56.7006161Z +    ///
2025-11-10T00:08:56.7006300Z      /// Params: ["hexdata", "dummy"]
2025-11-10T00:08:56.7006596Z      pub async fn submit_block(&self, params: &Value) -> RpcResult<Value> {
2025-11-10T00:08:56.7008394Z          debug!("RPC: submitblock");
2025-11-10T00:08:56.7008852Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:544:
2025-11-10T00:08:56.7008963Z -        
2025-11-10T00:08:56.7009101Z -        let hex_data = params.get(0)
2025-11-10T00:08:56.7009214Z +
2025-11-10T00:08:56.7009338Z +        let hex_data = params
2025-11-10T00:08:56.7009443Z +            .get(0)
2025-11-10T00:08:56.7009580Z              .and_then(|p| p.as_str())
2025-11-10T00:08:56.7009886Z              .ok_or_else(|| RpcError::invalid_params("Missing hexdata parameter"))?;
2025-11-10T00:08:56.7009988Z -        
2025-11-10T00:08:56.7010087Z +
2025-11-10T00:08:56.7010206Z          // Decode hex
2025-11-10T00:08:56.7010364Z          let block_bytes = hex::decode(hex_data)
2025-11-10T00:08:56.7010680Z              .map_err(|e| RpcError::invalid_params(format!("Invalid hex data: {}", e)))?;
2025-11-10T00:08:56.7011107Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:552:
2025-11-10T00:08:56.7011213Z -        
2025-11-10T00:08:56.7011311Z +
2025-11-10T00:08:56.7011441Z          // Deserialize block
2025-11-10T00:08:56.7011744Z          let (block, witnesses) = deserialize_block_with_witnesses(&block_bytes)
2025-11-10T00:08:56.7012125Z              .map_err(|e| RpcError::invalid_params(format!("Failed to deserialize block: {}", e)))?;
2025-11-10T00:08:56.7012550Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:556:
2025-11-10T00:08:56.7012651Z -        
2025-11-10T00:08:56.7012750Z +
2025-11-10T00:08:56.7012881Z          // Get current chain state
2025-11-10T00:08:56.7013045Z -        let height = self.get_current_height()?
2025-11-10T00:08:56.7013165Z +        let height = self
2025-11-10T00:08:56.7013289Z +            .get_current_height()?
2025-11-10T00:08:56.7013558Z              .ok_or_else(|| RpcError::internal_error("Chain not initialized"))?;
2025-11-10T00:08:56.7013707Z          let utxo_set = self.get_utxo_set()?;
2025-11-10T00:08:56.7013807Z -        
2025-11-10T00:08:56.7013907Z +
2025-11-10T00:08:56.7014613Z          // Validate block using consensus layer
2025-11-10T00:08:56.7014978Z          // Note: This validates consensus rules, but doesn't check if block extends chain
2025-11-10T00:08:56.7015329Z          // In production, would also check:
2025-11-10T00:08:56.7015758Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:572:
2025-11-10T00:08:56.7015930Z                  debug!("Block submitted successfully");
2025-11-10T00:08:56.7016051Z                  Ok(json!(null))
2025-11-10T00:08:56.7016153Z              }
2025-11-10T00:08:56.7016349Z -            Ok((ValidationResult::Invalid(reason), _)) => {
2025-11-10T00:08:56.7016639Z -                Err(RpcError::invalid_params(format!("Invalid block: {}", reason)))
2025-11-10T00:08:56.7016740Z -            }
2025-11-10T00:08:56.7016861Z -            Err(e) => {
2025-11-10T00:08:56.7017141Z -                Err(RpcError::internal_error(format!("Validation error: {}", e)))
2025-11-10T00:08:56.7017244Z -            }
2025-11-10T00:08:56.7018145Z +            Ok((ValidationResult::Invalid(reason), _)) => Err(RpcError::invalid_params(format!(
2025-11-10T00:08:56.7018301Z +                "Invalid block: {}",
2025-11-10T00:08:56.7018417Z +                reason
2025-11-10T00:08:56.7018519Z +            ))),
2025-11-10T00:08:56.7018833Z +            Err(e) => Err(RpcError::internal_error(format!("Validation error: {}", e))),
2025-11-10T00:08:56.7018939Z          }
2025-11-10T00:08:56.7019041Z      }
2025-11-10T00:08:56.7019153Z -    
2025-11-10T00:08:56.7019253Z +
2025-11-10T00:08:56.7019382Z      /// Estimate smart fee rate
2025-11-10T00:08:56.7019484Z -    /// 
2025-11-10T00:08:56.7019591Z +    ///
2025-11-10T00:08:56.7020020Z      /// Params: [conf_target (optional, default: 6), estimate_mode (optional, default: "conservative")]
2025-11-10T00:08:56.7020360Z      pub async fn estimate_smart_fee(&self, params: &Value) -> RpcResult<Value> {
2025-11-10T00:08:56.7020524Z          debug!("RPC: estimatesmartfee");
2025-11-10T00:08:56.7020978Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:589:
2025-11-10T00:08:56.7021086Z -        
2025-11-10T00:08:56.7021237Z -        let conf_target = params.get(0)
2025-11-10T00:08:56.7021390Z -            .and_then(|p| p.as_u64())
2025-11-10T00:08:56.7021523Z -            .unwrap_or(6);
2025-11-10T00:08:56.7021631Z -        
2025-11-10T00:08:56.7021793Z -        let estimate_mode = params.get(1)
2025-11-10T00:08:56.7021900Z +
2025-11-10T00:08:56.7022198Z +        let conf_target = params.get(0).and_then(|p| p.as_u64()).unwrap_or(6);
2025-11-10T00:08:56.7022311Z +
2025-11-10T00:08:56.7022452Z +        let estimate_mode = params
2025-11-10T00:08:56.7022565Z +            .get(1)
2025-11-10T00:08:56.7022703Z              .and_then(|p| p.as_str())
2025-11-10T00:08:56.7022854Z              .unwrap_or("conservative");
2025-11-10T00:08:56.7022963Z -        
2025-11-10T00:08:56.7023069Z +
2025-11-10T00:08:56.7023207Z          // Validate estimate_mode
2025-11-10T00:08:56.7023691Z          match estimate_mode {
2025-11-10T00:08:56.7023881Z              "unset" | "economical" | "conservative" => {}
2025-11-10T00:08:56.7024472Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:601:
2025-11-10T00:08:56.7025169Z -            _ => return Err(RpcError::invalid_params(format!("Invalid estimate_mode: {}. Must be 'unset', 'economical', or 'conservative'", estimate_mode)))
2025-11-10T00:08:56.7025284Z +            _ => {
2025-11-10T00:08:56.7025490Z +                return Err(RpcError::invalid_params(format!(
2025-11-10T00:08:56.7025855Z +                    "Invalid estimate_mode: {}. Must be 'unset', 'economical', or 'conservative'",
2025-11-10T00:08:56.7025988Z +                    estimate_mode
2025-11-10T00:08:56.7026098Z +                )))
2025-11-10T00:08:56.7026218Z +            }
2025-11-10T00:08:56.7026329Z          }
2025-11-10T00:08:56.7026439Z -        
2025-11-10T00:08:56.7026550Z +
2025-11-10T00:08:56.7026820Z          // Get mempool transactions and UTXO set for fee calculation
2025-11-10T00:08:56.7027089Z          let mempool_txs = if let Some(ref mempool) = self.mempool {
2025-11-10T00:08:56.7027253Z              let utxo_set = self.get_utxo_set()?;
2025-11-10T00:08:56.7027984Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:608:
2025-11-10T00:08:56.7028105Z          } else {
2025-11-10T00:08:56.7028216Z              vec![]
2025-11-10T00:08:56.7028326Z          };
2025-11-10T00:08:56.7028439Z -        
2025-11-10T00:08:56.7028545Z +
2025-11-10T00:08:56.7028731Z          // Calculate fee rate based on mempool state
2025-11-10T00:08:56.7029094Z          // Simple algorithm: use median fee rate of top transactions
2025-11-10T00:08:56.7029274Z          let fee_rate = if !mempool_txs.is_empty() {
2025-11-10T00:08:56.7029717Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:615:
2025-11-10T00:08:56.7029884Z              let utxo_set = self.get_utxo_set()?;
2025-11-10T00:08:56.7030055Z              let mut fee_rates = Vec::new();
2025-11-10T00:08:56.7030386Z -            
2025-11-10T00:08:56.7030508Z +
2025-11-10T00:08:56.7030936Z              // MempoolManager.get_prioritized_transactions() already calculates fees correctly
2025-11-10T00:08:56.7033079Z              // We can extract fee rates from the prioritized list, but for now calculate directly
2025-11-10T00:08:56.7033230Z              for tx in &mempool_txs {
2025-11-10T00:08:56.7033679Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:621:
2025-11-10T00:08:56.7033971Z                  let fee = self.calculate_transaction_fee(tx); // Now uses UTXO set
2025-11-10T00:08:56.7034169Z                  let size = self.calculate_weight(tx) as usize;
2025-11-10T00:08:56.7034282Z -                
2025-11-10T00:08:56.7034592Z +
2025-11-10T00:08:56.7034729Z                  if size > 0 {
2025-11-10T00:08:56.7034885Z                      // Fee rate in BTC per vbyte
2025-11-10T00:08:56.7035216Z                      let rate = (fee as f64) / (size as f64) / 100_000_000.0; // Convert satoshis to BTC
2025-11-10T00:08:56.7035668Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:627:
2025-11-10T00:08:56.7035827Z                      fee_rates.push(rate);
2025-11-10T00:08:56.7035947Z                  }
2025-11-10T00:08:56.7036059Z              }
2025-11-10T00:08:56.7036167Z -            
2025-11-10T00:08:56.7036273Z +
2025-11-10T00:08:56.7036503Z              // Use median fee rate, or minimum if no transactions
2025-11-10T00:08:56.7036654Z              if !fee_rates.is_empty() {
2025-11-10T00:08:56.7037006Z                  fee_rates.sort_by(|a, b| a.partial_cmp(b).unwrap_or(std::cmp::Ordering::Equal));
2025-11-10T00:08:56.7037439Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:640:
2025-11-10T00:08:56.7037635Z              // No mempool transactions - return minimum fee
2025-11-10T00:08:56.7037758Z              0.00001 // 1 sat/vB
2025-11-10T00:08:56.7037867Z          };
2025-11-10T00:08:56.7037985Z -        
2025-11-10T00:08:56.7038099Z +
2025-11-10T00:08:56.7038252Z          // Adjust based on estimate_mode
2025-11-10T00:08:56.7038442Z          let adjusted_rate = match estimate_mode {
2025-11-10T00:08:56.7038689Z -            "economical" => fee_rate * 0.8, // 20% lower for economical
2025-11-10T00:08:56.7038945Z +            "economical" => fee_rate * 0.8,   // 20% lower for economical
2025-11-10T00:08:56.7039228Z              "conservative" => fee_rate * 1.2, // 20% higher for conservative
2025-11-10T00:08:56.7039351Z              _ => fee_rate,
2025-11-10T00:08:56.7039464Z          };
2025-11-10T00:08:56.7039894Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:650:
2025-11-10T00:08:56.7040015Z -        
2025-11-10T00:08:56.7040124Z +
2025-11-10T00:08:56.7040241Z          Ok(json!({
2025-11-10T00:08:56.7040391Z              "feerate": adjusted_rate,
2025-11-10T00:08:56.7040533Z              "blocks": conf_target
2025-11-10T00:08:56.7041099Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:660:
2025-11-10T00:08:56.7041727Z      pub async fn prioritise_transaction(&self, params: &Value) -> RpcResult<Value> {
2025-11-10T00:08:56.7041900Z          debug!("RPC: prioritisetransaction");
2025-11-10T00:08:56.7042004Z  
2025-11-10T00:08:56.7042138Z -        let txid = params.get(0)
2025-11-10T00:08:56.7042269Z +        let txid = params
2025-11-10T00:08:56.7042380Z +            .get(0)
2025-11-10T00:08:56.7042526Z              .and_then(|p| p.as_str())
2025-11-10T00:08:56.7042884Z              .ok_or_else(|| RpcError::invalid_params("Transaction ID required".to_string()))?;
2025-11-10T00:08:56.7042996Z  
2025-11-10T00:08:56.7043410Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:667:
2025-11-10T00:08:56.7043555Z -        let fee_delta = params.get(1)
2025-11-10T00:08:56.7045793Z +        let fee_delta = params
2025-11-10T00:08:56.7045908Z +            .get(1)
2025-11-10T00:08:56.7046377Z              .and_then(|p| p.as_i64())
2025-11-10T00:08:56.7046739Z              .ok_or_else(|| RpcError::invalid_params("Fee delta required".to_string()))?;
2025-11-10T00:08:56.7046855Z  
2025-11-10T00:08:56.7047297Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:671:
2025-11-10T00:08:56.7047457Z          let hash_bytes = hex::decode(txid)
2025-11-10T00:08:56.7047836Z              .map_err(|e| RpcError::invalid_params(format!("Invalid transaction ID: {}", e)))?;
2025-11-10T00:08:56.7047986Z          if hash_bytes.len() != 32 {
2025-11-10T00:08:56.7048395Z -            return Err(RpcError::invalid_params("Transaction ID must be 32 bytes".to_string()));
2025-11-10T00:08:56.7048577Z +            return Err(RpcError::invalid_params(
2025-11-10T00:08:56.7048774Z +                "Transaction ID must be 32 bytes".to_string(),
2025-11-10T00:08:56.7048884Z +            ));
2025-11-10T00:08:56.7049102Z          }
2025-11-10T00:08:56.7049235Z          let mut hash = [0u8; 32];
2025-11-10T00:08:56.7049396Z          hash.copy_from_slice(&hash_bytes);
2025-11-10T00:08:56.7049848Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:681:
2025-11-10T00:08:56.7050050Z              if mempool.get_transaction(&hash).is_some() {
2025-11-10T00:08:56.7050340Z                  // Note: In production, would update transaction priority/fee delta
2025-11-10T00:08:56.7050494Z                  // For now, just return success
2025-11-10T00:08:56.7050829Z -                debug!("Transaction {} prioritized with fee delta: {}", txid, fee_delta);
2025-11-10T00:08:56.7050950Z +                debug!(
2025-11-10T00:08:56.7051168Z +                    "Transaction {} prioritized with fee delta: {}",
2025-11-10T00:08:56.7051305Z +                    txid, fee_delta
2025-11-10T00:08:56.7051415Z +                );
2025-11-10T00:08:56.7051539Z                  Ok(json!(true))
2025-11-10T00:08:56.7051655Z              } else {
2025-11-10T00:08:56.7051832Z -                Err(RpcError::invalid_params(
2025-11-10T00:08:56.7052056Z -                    format!("Transaction {} not found in mempool", txid)
2025-11-10T00:08:56.7052171Z -                ))
2025-11-10T00:08:56.7052359Z +                Err(RpcError::invalid_params(format!(
2025-11-10T00:08:56.7052533Z +                    "Transaction {} not found in mempool",
2025-11-10T00:08:56.7052650Z +                    txid
2025-11-10T00:08:56.7052763Z +                )))
2025-11-10T00:08:56.7052880Z              }
2025-11-10T00:08:56.7052990Z          } else {
2025-11-10T00:08:56.7053308Z -            Err(RpcError::internal_error("Mempool not initialized".to_string()))
2025-11-10T00:08:56.7053474Z +            Err(RpcError::internal_error(
2025-11-10T00:08:56.7053646Z +                "Mempool not initialized".to_string(),
2025-11-10T00:08:56.7053758Z +            ))
2025-11-10T00:08:56.7053876Z          }
2025-11-10T00:08:56.7053986Z      }
2025-11-10T00:08:56.7054088Z  }
2025-11-10T00:08:56.7054726Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:696:
2025-11-10T00:08:56.7054929Z  
2025-11-10T00:08:56.7055333Z  impl Default for MiningRpc {
2025-11-10T00:08:56.7055500Z -    fn default() -> Self { Self::new() }
2025-11-10T00:08:56.7055639Z +    fn default() -> Self {
2025-11-10T00:08:56.7055757Z +        Self::new()
2025-11-10T00:08:56.7055872Z +    }
2025-11-10T00:08:56.7055977Z  }
2025-11-10T00:08:56.7056080Z  
2025-11-10T00:08:56.7056612Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mod.rs:120:
2025-11-10T00:08:56.7056748Z          self.mining_rpc =
2025-11-10T00:08:56.7057142Z              mining::MiningRpc::with_dependencies(Arc::clone(&storage), Arc::clone(&mempool));
2025-11-10T00:08:56.7057584Z          self.blockchain_rpc = blockchain::BlockchainRpc::with_dependencies(Arc::clone(&storage));
2025-11-10T00:08:56.7058080Z -        let mempool_rpc = mempool::MempoolRpc::with_dependencies(Arc::clone(&mempool), Arc::clone(&storage));
2025-11-10T00:08:56.7058428Z +        let mempool_rpc =
2025-11-10T00:08:56.7058849Z +            mempool::MempoolRpc::with_dependencies(Arc::clone(&mempool), Arc::clone(&storage));
2025-11-10T00:08:56.7059076Z          let rawtx_rpc = rawtx::RawTxRpc::with_dependencies(
2025-11-10T00:08:56.7059215Z              Arc::clone(&storage),
2025-11-10T00:08:56.7059354Z              Arc::clone(&mempool),
2025-11-10T00:08:56.7059780Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mod.rs:148:
2025-11-10T00:08:56.7059889Z      }
2025-11-10T00:08:56.7059991Z  
2025-11-10T00:08:56.7060150Z      /// Set network manager dependency
2025-11-10T00:08:56.7060623Z -    pub fn with_network_manager(mut self, network_manager: Arc<crate::network::NetworkManager>) -> Self {
2025-11-10T00:08:56.7060770Z +    pub fn with_network_manager(
2025-11-10T00:08:56.7060887Z +        mut self,
2025-11-10T00:08:56.7061133Z +        network_manager: Arc<crate::network::NetworkManager>,
2025-11-10T00:08:56.7061253Z +    ) -> Self {
2025-11-10T00:08:56.7061681Z          self.network_rpc = network::NetworkRpc::with_dependencies(Arc::clone(&network_manager));
2025-11-10T00:08:56.7061891Z          self.network_manager = Some(network_manager);
2025-11-10T00:08:56.7062005Z          self
2025-11-10T00:08:56.7062420Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mod.rs:196:
2025-11-10T00:08:56.7062540Z          ));
2025-11-10T00:08:56.7062646Z  
2025-11-10T00:08:56.7062831Z          // Create server with or without authentication
2025-11-10T00:08:56.7063284Z -        let server = if let (Some(ref storage), Some(ref mempool)) = (self.storage.as_ref(), self.mempool.as_ref()) {
2025-11-10T00:08:56.7063748Z -            let blockchain = Arc::new(blockchain::BlockchainRpc::with_dependencies(Arc::clone(storage)));
2025-11-10T00:08:56.7064274Z -            let mempool_rpc = Arc::new(mempool::MempoolRpc::with_dependencies(Arc::clone(mempool), Arc::clone(&storage)));
2025-11-10T00:08:56.7064981Z -            let rawtx_rpc = Arc::new(rawtx::RawTxRpc::with_dependencies(Arc::clone(storage), Arc::clone(mempool), None, None));
2025-11-10T00:08:56.7065444Z -            let mining = Arc::new(mining::MiningRpc::with_dependencies(Arc::clone(storage), Arc::clone(mempool)));
2025-11-10T00:08:56.7065673Z +        let server = if let (Some(ref storage), Some(ref mempool)) =
2025-11-10T00:08:56.7065851Z +            (self.storage.as_ref(), self.mempool.as_ref())
2025-11-10T00:08:56.7065957Z +        {
2025-11-10T00:08:56.7066318Z +            let blockchain = Arc::new(blockchain::BlockchainRpc::with_dependencies(Arc::clone(
2025-11-10T00:08:56.7066446Z +                storage,
2025-11-10T00:08:56.7066565Z +            )));
2025-11-10T00:08:56.7066856Z +            let mempool_rpc = Arc::new(mempool::MempoolRpc::with_dependencies(
2025-11-10T00:08:56.7067004Z +                Arc::clone(mempool),
2025-11-10T00:08:56.7067148Z +                Arc::clone(&storage),
2025-11-10T00:08:56.7067260Z +            ));
2025-11-10T00:08:56.7067521Z +            let rawtx_rpc = Arc::new(rawtx::RawTxRpc::with_dependencies(
2025-11-10T00:08:56.7067658Z +                Arc::clone(storage),
2025-11-10T00:08:56.7068091Z +                Arc::clone(mempool),
2025-11-10T00:08:56.7068209Z +                None,
2025-11-10T00:08:56.7068329Z +                None,
2025-11-10T00:08:56.7068438Z +            ));
2025-11-10T00:08:56.7068701Z +            let mining = Arc::new(mining::MiningRpc::with_dependencies(
2025-11-10T00:08:56.7068835Z +                Arc::clone(storage),
2025-11-10T00:08:56.7068972Z +                Arc::clone(mempool),
2025-11-10T00:08:56.7069088Z +            ));
2025-11-10T00:08:56.7069380Z              let network = if let Some(ref network_manager) = self.network_manager {
2025-11-10T00:08:56.7069747Z -                Arc::new(network::NetworkRpc::with_dependencies(Arc::clone(network_manager)))
2025-11-10T00:08:56.7070005Z +                Arc::new(network::NetworkRpc::with_dependencies(Arc::clone(
2025-11-10T00:08:56.7070143Z +                    network_manager,
2025-11-10T00:08:56.7070450Z +                )))
2025-11-10T00:08:56.7070575Z              } else {
2025-11-10T00:08:56.7070757Z                  Arc::new(network::NetworkRpc::new())
2025-11-10T00:08:56.7070855Z              };
2025-11-10T00:08:56.7071249Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mod.rs:209:
2025-11-10T00:08:56.7071354Z -            
2025-11-10T00:08:56.7071459Z +
2025-11-10T00:08:56.7071616Z              // Use auth manager if configured
2025-11-10T00:08:56.7071822Z              if let Some(ref auth_manager) = self.auth_manager {
2025-11-10T00:08:56.7072029Z                  server::RpcServer::with_dependencies_and_auth(
2025-11-10T00:08:56.7072436Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mod.rs:233:
2025-11-10T00:08:56.7072547Z          } else {
2025-11-10T00:08:56.7072899Z              // No dependencies - use auth if configured
2025-11-10T00:08:56.7073083Z              if let Some(ref auth_manager) = self.auth_manager {
2025-11-10T00:08:56.7073236Z -                server::RpcServer::with_auth(
2025-11-10T00:08:56.7073375Z -                    self.server_addr,
2025-11-10T00:08:56.7073510Z -                    Arc::clone(auth_manager),
2025-11-10T00:08:56.7073610Z -                )
2025-11-10T00:08:56.7073917Z +                server::RpcServer::with_auth(self.server_addr, Arc::clone(auth_manager))
2025-11-10T00:08:56.7074028Z              } else {
2025-11-10T00:08:56.7074194Z                  server::RpcServer::new(self.server_addr)
2025-11-10T00:08:56.7074449Z              }
2025-11-10T00:08:56.7074980Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:18:
2025-11-10T00:08:56.7075107Z  impl NetworkRpc {
2025-11-10T00:08:56.7075255Z      /// Create a new network RPC handler
2025-11-10T00:08:56.7075386Z      pub fn new() -> Self {
2025-11-10T00:08:56.7075523Z -        Self { network_manager: None }
2025-11-10T00:08:56.7075624Z +        Self {
2025-11-10T00:08:56.7075755Z +            network_manager: None,
2025-11-10T00:08:56.7075859Z +        }
2025-11-10T00:08:56.7075960Z      }
2025-11-10T00:08:56.7076057Z  
2025-11-10T00:08:56.7076190Z      /// Create with dependencies
2025-11-10T00:08:56.7077020Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:25:
2025-11-10T00:08:56.7077334Z      pub fn with_dependencies(network_manager: Arc<NetworkManager>) -> Self {
2025-11-10T00:08:56.7077512Z -        Self { network_manager: Some(network_manager) }
2025-11-10T00:08:56.7077617Z +        Self {
2025-11-10T00:08:56.7077775Z +            network_manager: Some(network_manager),
2025-11-10T00:08:56.7077873Z +        }
2025-11-10T00:08:56.7077973Z      }
2025-11-10T00:08:56.7078074Z  
2025-11-10T00:08:56.7078219Z      /// Get network information
2025-11-10T00:08:56.7078678Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:103:
2025-11-10T00:08:56.7078888Z          if let Some(ref network) = self.network_manager {
2025-11-10T00:08:56.7079080Z              let peer_manager = network.peer_manager();
2025-11-10T00:08:56.7079574Z              let peer_addresses = peer_manager.peer_addresses();
2025-11-10T00:08:56.7079835Z -            let peers: Vec<Value> = peer_addresses.iter().map(|addr| {
2025-11-10T00:08:56.7080042Z -                if let Some(peer) = peer_manager.get_peer(addr) {
2025-11-10T00:08:56.7080169Z -                    json!({
2025-11-10T00:08:56.7080531Z -                        "id": addr.port().unwrap_or(0) as u64, // Use port as peer ID (unique per connection)
2025-11-10T00:08:56.7080692Z -                        "addr": addr.to_string(),
2025-11-10T00:08:56.7080836Z -                        "addrlocal": "",
2025-11-10T00:08:56.7080985Z -                        "services": "0000000000000001",
2025-11-10T00:08:56.7081139Z -                        "relaytxes": true,
2025-11-10T00:08:56.7081301Z -                        "lastsend": peer.last_send(),
2025-11-10T00:08:56.7081656Z -                        "lastrecv": peer.last_recv(),
2025-11-10T00:08:56.7081843Z -                        "bytessent": peer.bytes_sent(),
2025-11-10T00:08:56.7082011Z -                        "bytesrecv": peer.bytes_recv(),
2025-11-10T00:08:56.7082177Z -                        "conntime": peer.conntime(),
2025-11-10T00:08:56.7082325Z -                        "timeoffset": 0,
2025-11-10T00:08:56.7082459Z -                        "pingtime": 0.0,
2025-11-10T00:08:56.7082600Z -                        "minping": 0.0,
2025-11-10T00:08:56.7082740Z -                        "version": 70015,
2025-11-10T00:08:56.7082920Z -                        "subver": "/reference-node:0.1.0/",
2025-11-10T00:08:56.7083059Z -                        "inbound": false,
2025-11-10T00:08:56.7083193Z -                        "addnode": false,
2025-11-10T00:08:56.7083358Z -                        "startingheight": 0,
2025-11-10T00:08:56.7083510Z -                        "synced_headers": -1,
2025-11-10T00:08:56.7083655Z -                        "synced_blocks": -1,
2025-11-10T00:08:56.7083794Z -                        "inflight": [],
2025-11-10T00:08:56.7083954Z -                        "whitelisted": false,
2025-11-10T00:08:56.7084105Z -                        "minfeefilter": 0.00001000,
2025-11-10T00:08:56.7084260Z -                        "bytessent_per_msg": {},
2025-11-10T00:08:56.7084608Z -                        "bytesrecv_per_msg": {}
2025-11-10T00:08:56.7084726Z -                    })
2025-11-10T00:08:56.7084844Z -                } else {
2025-11-10T00:08:56.7084963Z -                    json!({})
2025-11-10T00:08:56.7085082Z -                }
2025-11-10T00:08:56.7085205Z -            }).collect();
2025-11-10T00:08:56.7085375Z +            let peers: Vec<Value> = peer_addresses
2025-11-10T00:08:56.7085499Z +                .iter()
2025-11-10T00:08:56.7085620Z +                .map(|addr| {
2025-11-10T00:08:56.7085837Z +                    if let Some(peer) = peer_manager.get_peer(addr) {
2025-11-10T00:08:56.7085971Z +                        json!({
2025-11-10T00:08:56.7086331Z +                            "id": addr.port().unwrap_or(0) as u64, // Use port as peer ID (unique per connection)
2025-11-10T00:08:56.7086488Z +                            "addr": addr.to_string(),
2025-11-10T00:08:56.7086627Z +                            "addrlocal": "",
2025-11-10T00:08:56.7086784Z +                            "services": "0000000000000001",
2025-11-10T00:08:56.7086951Z +                            "relaytxes": true,
2025-11-10T00:08:56.7087107Z +                            "lastsend": peer.last_send(),
2025-11-10T00:08:56.7087262Z +                            "lastrecv": peer.last_recv(),
2025-11-10T00:08:56.7087434Z +                            "bytessent": peer.bytes_sent(),
2025-11-10T00:08:56.7087600Z +                            "bytesrecv": peer.bytes_recv(),
2025-11-10T00:08:56.7087765Z +                            "conntime": peer.conntime(),
2025-11-10T00:08:56.7087906Z +                            "timeoffset": 0,
2025-11-10T00:08:56.7088060Z +                            "pingtime": 0.0,
2025-11-10T00:08:56.7088191Z +                            "minping": 0.0,
2025-11-10T00:08:56.7088570Z +                            "version": 70015,
2025-11-10T00:08:56.7097564Z +                            "subver": "/reference-node:0.1.0/",
2025-11-10T00:08:56.7097773Z +                            "inbound": false,
2025-11-10T00:08:56.7097935Z +                            "addnode": false,
2025-11-10T00:08:56.7098092Z +                            "startingheight": 0,
2025-11-10T00:08:56.7098248Z +                            "synced_headers": -1,
2025-11-10T00:08:56.7098403Z +                            "synced_blocks": -1,
2025-11-10T00:08:56.7098560Z +                            "inflight": [],
2025-11-10T00:08:56.7098710Z +                            "whitelisted": false,
2025-11-10T00:08:56.7098960Z +                            "minfeefilter": 0.00001000,
2025-11-10T00:08:56.7099133Z +                            "bytessent_per_msg": {},
2025-11-10T00:08:56.7099623Z +                            "bytesrecv_per_msg": {}
2025-11-10T00:08:56.7099767Z +                        })
2025-11-10T00:08:56.7099914Z +                    } else {
2025-11-10T00:08:56.7100047Z +                        json!({})
2025-11-10T00:08:56.7100165Z +                    }
2025-11-10T00:08:56.7100276Z +                })
2025-11-10T00:08:56.7100409Z +                .collect();
2025-11-10T00:08:56.7100538Z              Ok(json!(peers))
2025-11-10T00:08:56.7100651Z          } else {
2025-11-10T00:08:56.7100784Z              Ok(json!([]))
2025-11-10T00:08:56.7101252Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:164:
2025-11-10T00:08:56.7101991Z          if let Some(ref network) = self.network_manager {
2025-11-10T00:08:56.7102164Z              // Send ping to all peers
2025-11-10T00:08:56.7102384Z              if let Err(e) = network.ping_all_peers().await {
2025-11-10T00:08:56.7102774Z -                return Err(RpcError::internal_error(format!("Failed to ping peers: {}", e)));
2025-11-10T00:08:56.7102976Z +                return Err(RpcError::internal_error(format!(
2025-11-10T00:08:56.7103159Z +                    "Failed to ping peers: {}",
2025-11-10T00:08:56.7103283Z +                    e
2025-11-10T00:08:56.7103390Z +                )));
2025-11-10T00:08:56.7105529Z              }
2025-11-10T00:08:56.7105739Z              debug!("Sent ping to all connected peers");
2025-11-10T00:08:56.7105854Z          }
2025-11-10T00:08:56.7106318Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:205:
2025-11-10T00:08:56.7106467Z                  "onetry" => {
2025-11-10T00:08:56.7106623Z                      // Try to connect to node once
2025-11-10T00:08:56.7106843Z                      if let Err(e) = network.connect_to_peer(addr).await {
2025-11-10T00:08:56.7107273Z -                        return Err(RpcError::internal_error(format!("Failed to connect to {}: {}", addr, e)));
2025-11-10T00:08:56.7107489Z +                        return Err(RpcError::internal_error(format!(
2025-11-10T00:08:56.7107659Z +                            "Failed to connect to {}: {}",
2025-11-10T00:08:56.7107794Z +                            addr, e
2025-11-10T00:08:56.7107920Z +                        )));
2025-11-10T00:08:56.7108030Z                      }
2025-11-10T00:08:56.7108224Z                      debug!("Connected to node {} (onetry)", addr);
2025-11-10T00:08:56.7108363Z                      Ok(json!(null))
2025-11-10T00:08:56.7108806Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:310:
2025-11-10T00:08:56.7108973Z                  active_connection_limit_hits: 0,
2025-11-10T00:08:56.7109142Z                  resource_exhaustion_events: 0,
2025-11-10T00:08:56.7109253Z              };
2025-11-10T00:08:56.7109362Z -            
2025-11-10T00:08:56.7109473Z +
2025-11-10T00:08:56.7109602Z              Ok(json!({
2025-11-10T00:08:56.7109726Z                  "metrics": {
2025-11-10T00:08:56.7110033Z                      "connection_rate_violations": metrics.connection_rate_violations,
2025-11-10T00:08:56.7110764Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:365:
2025-11-10T00:08:56.7110923Z          let addr: SocketAddr = subnet
2025-11-10T00:08:56.7111047Z              .parse()
2025-11-10T00:08:56.7113140Z              .map_err(|_| RpcError::invalid_params(format!("Invalid address/subnet: {}", subnet)))?;
2025-11-10T00:08:56.7113264Z -        
2025-11-10T00:08:56.7113374Z +
2025-11-10T00:08:56.7113550Z          // Parse bantime (seconds) - 0 = permanent
2025-11-10T00:08:56.7113997Z          let bantime = params.get(2).and_then(|p| p.as_u64()).unwrap_or(86400); // Default 24 hours
2025-11-10T00:08:56.7114107Z -        
2025-11-10T00:08:56.7114211Z +
2025-11-10T00:08:56.7114702Z          // Parse absolute (whether bantime is absolute timestamp or relative)
2025-11-10T00:08:56.7115021Z          let absolute = params.get(3).and_then(|p| p.as_bool()).unwrap_or(false);
2025-11-10T00:08:56.7115365Z -        
2025-11-10T00:08:56.7115486Z +
2025-11-10T00:08:56.7115703Z          if let Some(ref network) = self.network_manager {
2025-11-10T00:08:56.7115889Z              use std::time::{SystemTime, UNIX_EPOCH};
2025-11-10T00:08:56.7116026Z              let now = SystemTime::now()
2025-11-10T00:08:56.7116456Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:378:
2025-11-10T00:08:56.7116595Z                  .duration_since(UNIX_EPOCH)
2025-11-10T00:08:56.7117035Z                  .unwrap()
2025-11-10T00:08:56.7117158Z                  .as_secs();
2025-11-10T00:08:56.7117282Z -            
2025-11-10T00:08:56.7117385Z +
2025-11-10T00:08:56.7117546Z              let unban_timestamp = if absolute {
2025-11-10T00:08:56.7117712Z                  bantime // Already a timestamp
2025-11-10T00:08:56.7117852Z              } else if bantime == 0 {
2025-11-10T00:08:56.7118615Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:386:
2025-11-10T00:08:56.7118738Z              } else {
2025-11-10T00:08:56.7118878Z                  now + bantime // Relative ban
2025-11-10T00:08:56.7118980Z              };
2025-11-10T00:08:56.7119080Z -            
2025-11-10T00:08:56.7119185Z +
2025-11-10T00:08:56.7119301Z              match command {
2025-11-10T00:08:56.7119406Z                  "add" => {
2025-11-10T00:08:56.7119577Z                      network.ban_peer(addr, unban_timestamp);
2025-11-10T00:08:56.7119987Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:422:
2025-11-10T00:08:56.7120091Z  
2025-11-10T00:08:56.7120291Z          if let Some(ref network) = self.network_manager {
2025-11-10T00:08:56.7120474Z              let banned = network.get_banned_peers();
2025-11-10T00:08:56.7120790Z -            let result: Vec<Value> = banned.iter().map(|(addr, unban_timestamp)| {
2025-11-10T00:08:56.7120912Z -                json!({
2025-11-10T00:08:56.7121075Z -                    "address": addr.to_string(),
2025-11-10T00:08:56.7121315Z -                    "banned_until": if *unban_timestamp == u64::MAX {
2025-11-10T00:08:56.7121519Z -                        serde_json::Value::Null // Permanent ban
2025-11-10T00:08:56.7121642Z -                    } else {
2025-11-10T00:08:56.7121885Z -                        serde_json::Value::Number((*unban_timestamp).into())
2025-11-10T00:08:56.7121999Z -                    },
2025-11-10T00:08:56.7122239Z -                    "banned_until_absolute": *unban_timestamp == u64::MAX
2025-11-10T00:08:56.7122402Z +            let result: Vec<Value> = banned
2025-11-10T00:08:56.7122521Z +                .iter()
2025-11-10T00:08:56.7122682Z +                .map(|(addr, unban_timestamp)| {
2025-11-10T00:08:56.7122817Z +                    json!({
2025-11-10T00:08:56.7122978Z +                        "address": addr.to_string(),
2025-11-10T00:08:56.7123197Z +                        "banned_until": if *unban_timestamp == u64::MAX {
2025-11-10T00:08:56.7123391Z +                            serde_json::Value::Null // Permanent ban
2025-11-10T00:08:56.7123533Z +                        } else {
2025-11-10T00:08:56.7124056Z +                            serde_json::Value::Number((*unban_timestamp).into())
2025-11-10T00:08:56.7124182Z +                        },
2025-11-10T00:08:56.7124611Z +                        "banned_until_absolute": *unban_timestamp == u64::MAX
2025-11-10T00:08:56.7124731Z +                    })
2025-11-10T00:08:56.7124849Z                  })
2025-11-10T00:08:56.7124987Z -            }).collect();
2025-11-10T00:08:56.7125113Z +                .collect();
2025-11-10T00:08:56.7125246Z              Ok(json!(result))
2025-11-10T00:08:56.7125361Z          } else {
2025-11-10T00:08:56.7125496Z              Ok(json!([]))
2025-11-10T00:08:56.7125961Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:445:
2025-11-10T00:08:56.7126317Z      pub async fn getaddednodeinfo(&self, params: &Value) -> RpcResult<Value> {
2025-11-10T00:08:56.7126721Z          debug!("RPC: getaddednodeinfo");
2025-11-10T00:08:56.7126845Z  
2025-11-10T00:08:56.7127003Z -        let node = params.get(0)
2025-11-10T00:08:56.7127134Z +        let node = params
2025-11-10T00:08:56.7127258Z +            .get(0)
2025-11-10T00:08:56.7127403Z              .and_then(|p| p.as_str())
2025-11-10T00:08:56.7127768Z              .ok_or_else(|| RpcError::invalid_params("Node address required".to_string()))?;
2025-11-10T00:08:56.7127884Z  
2025-11-10T00:08:56.7128338Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:453:
2025-11-10T00:08:56.7128442Z  
2025-11-10T00:08:56.7128647Z          if let Some(ref network) = self.network_manager {
2025-11-10T00:08:56.7128804Z              // Parse node address
2025-11-10T00:08:56.7128973Z -            let addr: SocketAddr = node.parse()
2025-11-10T00:08:56.7129117Z +            let addr: SocketAddr = node
2025-11-10T00:08:56.7129255Z +                .parse()
2025-11-10T00:08:56.7129635Z                  .map_err(|e| RpcError::invalid_params(format!("Invalid node address: {}", e)))?;
2025-11-10T00:08:56.7129751Z  
2025-11-10T00:08:56.7129940Z              // Check if node is in persistent peer list
2025-11-10T00:08:56.7130394Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:494:
2025-11-10T00:08:56.7130736Z      pub async fn getnodeaddresses(&self, params: &Value) -> RpcResult<Value> {
2025-11-10T00:08:56.7130898Z          debug!("RPC: getnodeaddresses");
2025-11-10T00:08:56.7131010Z  
2025-11-10T00:08:56.7131153Z -        let count = params.get(0)
2025-11-10T00:08:56.7131301Z -            .and_then(|p| p.as_u64())
2025-11-10T00:08:56.7131439Z -            .unwrap_or(1)
2025-11-10T00:08:56.7131597Z -            .min(100) as usize; // Limit to 100
2025-11-10T00:08:56.7132002Z +        let count = params.get(0).and_then(|p| p.as_u64()).unwrap_or(1).min(100) as usize; // Limit to 100
2025-11-10T00:08:56.7132124Z  
2025-11-10T00:08:56.7132336Z          if let Some(ref network) = self.network_manager {
2025-11-10T00:08:56.7132474Z              // Get peer addresses
2025-11-10T00:08:56.7134903Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:504:
2025-11-10T00:08:56.7135144Z              let peer_addrs = network.get_peer_addresses().await;
2025-11-10T00:08:56.7135255Z -            
2025-11-10T00:08:56.7135360Z +
2025-11-10T00:08:56.7135525Z              // Convert to node address format
2025-11-10T00:08:56.7135688Z              let mut addresses = Vec::new();
2025-11-10T00:08:56.7135882Z              for addr in peer_addrs.into_iter().take(count) {
2025-11-10T00:08:56.7136333Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:551:
2025-11-10T00:08:56.7136679Z      pub async fn setnetworkactive(&self, params: &Value) -> RpcResult<Value> {
2025-11-10T00:08:56.7136837Z          debug!("RPC: setnetworkactive");
2025-11-10T00:08:56.7136941Z  
2025-11-10T00:08:56.7137090Z -        let state = params.get(0)
2025-11-10T00:08:56.7137239Z -            .and_then(|p| p.as_bool())
2025-11-10T00:08:56.7137646Z -            .ok_or_else(|| RpcError::invalid_params("State parameter required (true/false)".to_string()))?;
2025-11-10T00:08:56.7138148Z +        let state = params.get(0).and_then(|p| p.as_bool()).ok_or_else(|| {
2025-11-10T00:08:56.7138479Z +            RpcError::invalid_params("State parameter required (true/false)".to_string())
2025-11-10T00:08:56.7138585Z +        })?;
2025-11-10T00:08:56.7138692Z  
2025-11-10T00:08:56.7138888Z          if let Some(ref network) = self.network_manager {
2025-11-10T00:08:56.7139049Z -            network.set_network_active(state).await
2025-11-10T00:08:56.7139415Z -                .map_err(|e| RpcError::internal_error(format!("Failed to set network active: {}", e)))?;
2025-11-10T00:08:56.7139631Z +            network.set_network_active(state).await.map_err(|e| {
2025-11-10T00:08:56.7139946Z +                RpcError::internal_error(format!("Failed to set network active: {}", e))
2025-11-10T00:08:56.7140209Z +            })?;
2025-11-10T00:08:56.7140342Z              Ok(json!(state))
2025-11-10T00:08:56.7140448Z          } else {
2025-11-10T00:08:56.7140764Z -            Err(RpcError::internal_error("Network manager not available".to_string()))
2025-11-10T00:08:56.7140903Z +            Err(RpcError::internal_error(
2025-11-10T00:08:56.7141095Z +                "Network manager not available".to_string(),
2025-11-10T00:08:56.7141207Z +            ))
2025-11-10T00:08:56.7141317Z          }
2025-11-10T00:08:56.7141438Z      }
2025-11-10T00:08:56.7141546Z  }
2025-11-10T00:08:56.7191668Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:68:
2025-11-10T00:08:56.7191910Z          let tx_bytes = hex::decode(hex_string)
2025-11-10T00:08:56.7192274Z              .map_err(|e| RpcError::invalid_params(format!("Invalid hex string: {}", e)))?;
2025-11-10T00:08:56.7192389Z  
2025-11-10T00:08:56.7192827Z -        if let (Some(ref storage), Some(ref mempool)) = (self.storage.as_ref(), self.mempool.as_ref()) {
2025-11-10T00:08:56.7193021Z +        if let (Some(ref storage), Some(ref mempool)) =
2025-11-10T00:08:56.7193236Z +            (self.storage.as_ref(), self.mempool.as_ref())
2025-11-10T00:08:56.7193350Z +        {
2025-11-10T00:08:56.7193697Z              use bllvm_protocol::serialization::transaction::deserialize_transaction;
2025-11-10T00:08:56.7193894Z -            let tx = deserialize_transaction(&tx_bytes)
2025-11-10T00:08:56.7194446Z -                .map_err(|e| RpcError::invalid_params(format!("Failed to parse transaction: {}", e)))?;
2025-11-10T00:08:56.7194557Z -            
2025-11-10T00:08:56.7194803Z +            let tx = deserialize_transaction(&tx_bytes).map_err(|e| {
2025-11-10T00:08:56.7195132Z +                RpcError::invalid_params(format!("Failed to parse transaction: {}", e))
2025-11-10T00:08:56.7195245Z +            })?;
2025-11-10T00:08:56.7195356Z +
2025-11-10T00:08:56.7195568Z              use bllvm_protocol::mempool::calculate_tx_id;
2025-11-10T00:08:56.7195729Z              let txid = calculate_tx_id(&tx);
2025-11-10T00:08:56.7195843Z -            
2025-11-10T00:08:56.7195960Z +
2025-11-10T00:08:56.7196108Z              // Check if already in mempool
2025-11-10T00:08:56.7196286Z              if mempool.get_transaction(&txid).is_some() {
2025-11-10T00:08:56.7196614Z                  return Err(RpcError::invalid_params("Transaction already in mempool"));
2025-11-10T00:08:56.7197042Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:82:
2025-11-10T00:08:56.7197150Z              }
2025-11-10T00:08:56.7197258Z -            
2025-11-10T00:08:56.7197376Z +
2025-11-10T00:08:56.7197507Z              // Check if in chain
2025-11-10T00:08:56.7197826Z -            if storage.transactions().has_transaction(&txid).unwrap_or(false) {
2025-11-10T00:08:56.7197955Z +            if storage
2025-11-10T00:08:56.7198090Z +                .transactions()
2025-11-10T00:08:56.7198236Z +                .has_transaction(&txid)
2025-11-10T00:08:56.7198376Z +                .unwrap_or(false)
2025-11-10T00:08:56.7198498Z +            {
2025-11-10T00:08:56.7199103Z                  return Err(RpcError::invalid_params("Transaction already in chain"));
2025-11-10T00:08:56.7199226Z              }
2025-11-10T00:08:56.7199348Z -            
2025-11-10T00:08:56.7199454Z +
2025-11-10T00:08:56.7199644Z              // Validate transaction using consensus layer
2025-11-10T00:08:56.7199838Z -            let _timer = self.profiler.as_ref().map(|p| {
2025-11-10T00:08:56.7200186Z -                PerformanceTimer::start(Arc::clone(p), OperationType::TxValidation)
2025-11-10T00:08:56.7200295Z -            });
2025-11-10T00:08:56.7200426Z +            let _timer = self
2025-11-10T00:08:56.7200559Z +                .profiler
2025-11-10T00:08:56.7200678Z +                .as_ref()
2025-11-10T00:08:56.7201056Z +                .map(|p| PerformanceTimer::start(Arc::clone(p), OperationType::TxValidation));
2025-11-10T00:08:56.7203318Z              let validation_start = Instant::now();
2025-11-10T00:08:56.7203515Z              use bllvm_protocol::ConsensusProof;
2025-11-10T00:08:56.7203704Z              let consensus = ConsensusProof::new();
2025-11-10T00:08:56.7204146Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:97:
2025-11-10T00:08:56.7204677Z                  Ok(bllvm_protocol::ValidationResult::Valid) => {
2025-11-10T00:08:56.7204917Z                      let validation_time = validation_start.elapsed();
2025-11-10T00:08:56.7205107Z                      // Timer will record duration when dropped
2025-11-10T00:08:56.7205232Z -                    
2025-11-10T00:08:56.7205349Z +
2025-11-10T00:08:56.7205494Z                      // Update metrics
2025-11-10T00:08:56.7205663Z                      if let Some(ref metrics) = self.metrics {
2025-11-10T00:08:56.7205825Z                          metrics.update_performance(|m| {
2025-11-10T00:08:56.7206261Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:104:
2025-11-10T00:08:56.7206913Z                              let time_ms = validation_time.as_secs_f64() * 1000.0;
2025-11-10T00:08:56.7207296Z                              // Update average transaction validation time (exponential moving average)
2025-11-10T00:08:56.7207467Z -                            m.avg_tx_validation_time_ms = 
2025-11-10T00:08:56.7207640Z +                            m.avg_tx_validation_time_ms =
2025-11-10T00:08:56.7207851Z                                  (m.avg_tx_validation_time_ms * 0.9) + (time_ms * 0.1);
2025-11-10T00:08:56.7208016Z                              // Update transactions per second
2025-11-10T00:08:56.7208197Z                              if validation_time.as_secs_f64() > 0.0 {
2025-11-10T00:08:56.7208638Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:111:
2025-11-10T00:08:56.7208759Z                              }
2025-11-10T00:08:56.7208878Z                          });
2025-11-10T00:08:56.7208982Z                      }
2025-11-10T00:08:56.7209094Z -                    
2025-11-10T00:08:56.7209197Z +
2025-11-10T00:08:56.7209508Z                      // Transaction structure is valid, now check inputs against UTXO set
2025-11-10T00:08:56.7209692Z -                    let utxo_set = storage.utxos().get_all_utxos()
2025-11-10T00:08:56.7210048Z -                        .map_err(|e| RpcError::internal_error(format!("Failed to get UTXO set: {}", e)))?;
2025-11-10T00:08:56.7210160Z -                    
2025-11-10T00:08:56.7210395Z +                    let utxo_set = storage.utxos().get_all_utxos().map_err(|e| {
2025-11-10T00:08:56.7210688Z +                        RpcError::internal_error(format!("Failed to get UTXO set: {}", e))
2025-11-10T00:08:56.7210802Z +                    })?;
2025-11-10T00:08:56.7210901Z +
2025-11-10T00:08:56.7211076Z                      // Check if all inputs exist in UTXO set
2025-11-10T00:08:56.7211226Z                      for input in &tx.inputs {
2025-11-10T00:08:56.7211423Z                          if !utxo_set.contains_key(&input.prevout) {
2025-11-10T00:08:56.7211830Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:126:
2025-11-10T00:08:56.7212165Z                              )));
2025-11-10T00:08:56.7212279Z                          }
2025-11-10T00:08:56.7212381Z                      }
2025-11-10T00:08:56.7212481Z -                    
2025-11-10T00:08:56.7212576Z +
2025-11-10T00:08:56.7214763Z                      // Add to mempool
2025-11-10T00:08:56.7215098Z                      // Note: add_transaction requires &mut self, but we have Arc<MempoolManager>
2025-11-10T00:08:56.7215409Z                      // In production, this would need to use interior mutability (Mutex/RwLock)
2025-11-10T00:08:56.7215846Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:133:
2025-11-10T00:08:56.7216133Z                      // For now, we'll skip adding to mempool as it requires mutable access
2025-11-10T00:08:56.7216803Z -                    debug!("Transaction validated but not added to mempool (requires mutable access)");
2025-11-10T00:08:56.7216958Z +                    debug!(
2025-11-10T00:08:56.7217329Z +                        "Transaction validated but not added to mempool (requires mutable access)"
2025-11-10T00:08:56.7217446Z +                    );
2025-11-10T00:08:56.7217551Z                  }
2025-11-10T00:08:56.7217815Z                  Ok(bllvm_protocol::ValidationResult::Invalid(reason)) => {
2025-11-10T00:08:56.7218247Z -                    return Err(RpcError::invalid_params(format!("Transaction validation failed: {}", reason)));
2025-11-10T00:08:56.7218453Z +                    return Err(RpcError::invalid_params(format!(
2025-11-10T00:08:56.7218641Z +                        "Transaction validation failed: {}",
2025-11-10T00:08:56.7218765Z +                        reason
2025-11-10T00:08:56.7218887Z +                    )));
2025-11-10T00:08:56.7219006Z                  }
2025-11-10T00:08:56.7219133Z                  Err(e) => {
2025-11-10T00:08:56.7219648Z -                    return Err(RpcError::internal_error(format!("Transaction validation error: {}", e)));
2025-11-10T00:08:56.7219856Z +                    return Err(RpcError::internal_error(format!(
2025-11-10T00:08:56.7220026Z +                        "Transaction validation error: {}",
2025-11-10T00:08:56.7220143Z +                        e
2025-11-10T00:08:56.7220259Z +                    )));
2025-11-10T00:08:56.7220379Z                  }
2025-11-10T00:08:56.7220487Z              }
2025-11-10T00:08:56.7220598Z -            
2025-11-10T00:08:56.7220716Z +
2025-11-10T00:08:56.7220874Z              Ok(json!(hex::encode(txid)))
2025-11-10T00:08:56.7220984Z          } else {
2025-11-10T00:08:56.7221299Z -            Err(RpcError::invalid_params("RPC not initialized with dependencies"))
2025-11-10T00:08:56.7221466Z +            Err(RpcError::invalid_params(
2025-11-10T00:08:56.7221649Z +                "RPC not initialized with dependencies",
2025-11-10T00:08:56.7221767Z +            ))
2025-11-10T00:08:56.7221878Z          }
2025-11-10T00:08:56.7221981Z      }
2025-11-10T00:08:56.7222076Z  
2025-11-10T00:08:56.7222500Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:175:
2025-11-10T00:08:56.7222689Z          let consensus = ConsensusProof::new();
2025-11-10T00:08:56.7222970Z          let validation_result = consensus.validate_transaction(&tx);
2025-11-10T00:08:56.7223075Z  
2025-11-10T00:08:56.7223503Z -        let allowed = matches!(validation_result, Ok(bllvm_protocol::ValidationResult::Valid));
2025-11-10T00:08:56.7223644Z +        let allowed = matches!(
2025-11-10T00:08:56.7223843Z +            validation_result,
2025-11-10T00:08:56.7224043Z +            Ok(bllvm_protocol::ValidationResult::Valid)
2025-11-10T00:08:56.7224156Z +        );
2025-11-10T00:08:56.7224579Z          let reject_reason = if !allowed {
2025-11-10T00:08:56.7224735Z              match validation_result {
2025-11-10T00:08:56.7225095Z                  Ok(bllvm_protocol::ValidationResult::Invalid(reason)) => Some(reason),
2025-11-10T00:08:56.7225789Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:232:
2025-11-10T00:08:56.7226144Z          use bllvm_protocol::serialization::transaction::deserialize_transaction;
2025-11-10T00:08:56.7226334Z          let tx = deserialize_transaction(&tx_bytes)
2025-11-10T00:08:56.7226904Z              .map_err(|e| RpcError::invalid_params(format!("Failed to parse transaction: {}", e)))?;
2025-11-10T00:08:56.7227033Z -        
2025-11-10T00:08:56.7227143Z +
2025-11-10T00:08:56.7227346Z          use bllvm_protocol::mempool::calculate_tx_id;
2025-11-10T00:08:56.7227504Z          let txid = calculate_tx_id(&tx);
2025-11-10T00:08:56.7227652Z          let txid_hex = hex::encode(txid);
2025-11-10T00:08:56.7228092Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:239:
2025-11-10T00:08:56.7228245Z          let size = tx_bytes.len();
2025-11-10T00:08:56.7228356Z -        
2025-11-10T00:08:56.7228679Z +
2025-11-10T00:08:56.7228806Z          Ok(json!({
2025-11-10T00:08:56.7228970Z              "txid": txid_hex.clone(),
2025-11-10T00:08:56.7229103Z              "hash": txid_hex,
2025-11-10T00:08:56.7229538Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:295:
2025-11-10T00:08:56.7229863Z              if let Ok(Some(tx)) = storage.transactions().get_transaction(&txid_array) {
2025-11-10T00:08:56.7230213Z                  use bllvm_protocol::serialization::transaction::serialize_transaction;
2025-11-10T00:08:56.7230437Z                  let tx_hex = hex::encode(serialize_transaction(&tx));
2025-11-10T00:08:56.7230559Z -                
2025-11-10T00:08:56.7230667Z +
2025-11-10T00:08:56.7230796Z                  if verbose {
2025-11-10T00:08:56.7231009Z                      use bllvm_protocol::mempool::calculate_tx_id;
2025-11-10T00:08:56.7231201Z                      let calculated_txid = calculate_tx_id(&tx);
2025-11-10T00:08:56.7231651Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:417:
2025-11-10T00:08:56.7231903Z              if let Ok(Some(utxo)) = storage.utxos().get_utxo(&outpoint) {
2025-11-10T00:08:56.7232211Z                  let best_hash = storage.chain().get_tip_hash()?.unwrap_or([0u8; 32]);
2025-11-10T00:08:56.7232467Z                  let tip_height = storage.chain().get_height()?.unwrap_or(0);
2025-11-10T00:08:56.7232580Z -                
2025-11-10T00:08:56.7232691Z +
2025-11-10T00:08:56.7232897Z                  // Find block height containing this transaction
2025-11-10T00:08:56.7233070Z                  let mut tx_height: Option<u64> = None;
2025-11-10T00:08:56.7233220Z                  for h in 0..=tip_height {
2025-11-10T00:08:56.7233662Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:437:
2025-11-10T00:08:56.7233784Z                          }
2025-11-10T00:08:56.7233898Z                      }
2025-11-10T00:08:56.7234016Z                  }
2025-11-10T00:08:56.7234133Z -                
2025-11-10T00:08:56.7234242Z +
2025-11-10T00:08:56.7234611Z                  let confirmations = tx_height
2025-11-10T00:08:56.7234750Z                      .map(|h| {
2025-11-10T00:08:56.7234897Z                          if h > tip_height {
2025-11-10T00:08:56.7235322Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:447:
2025-11-10T00:08:56.7235451Z                          }
2025-11-10T00:08:56.7237914Z                      })
2025-11-10T00:08:56.7238065Z                      .unwrap_or(0);
2025-11-10T00:08:56.7238170Z -                
2025-11-10T00:08:56.7238287Z +
2025-11-10T00:08:56.7238410Z                  Ok(json!({
2025-11-10T00:08:56.7238595Z                      "bestblock": hex::encode(best_hash),
2025-11-10T00:08:56.7238770Z                      "confirmations": confirmations,
2025-11-10T00:08:56.7239198Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:470:
2025-11-10T00:08:56.7239320Z      }
2025-11-10T00:08:56.7239436Z  
2025-11-10T00:08:56.7239640Z      /// Build merkle proof for transactions in a block
2025-11-10T00:08:56.7240526Z -    fn build_merkle_proof(transactions: &[bllvm_protocol::Transaction], tx_indices: &[usize]) -> Result<Vec<[u8; 32]>, RpcError> {
2025-11-10T00:08:56.7240732Z -        use bllvm_protocol::mempool::calculate_tx_id;
2025-11-10T00:08:56.7240885Z +    fn build_merkle_proof(
2025-11-10T00:08:56.7241085Z +        transactions: &[bllvm_protocol::Transaction],
2025-11-10T00:08:56.7241217Z +        tx_indices: &[usize],
2025-11-10T00:08:56.7241382Z +    ) -> Result<Vec<[u8; 32]>, RpcError> {
2025-11-10T00:08:56.7241565Z          use crate::storage::hashing::double_sha256;
2025-11-10T00:08:56.7241756Z +        use bllvm_protocol::mempool::calculate_tx_id;
2025-11-10T00:08:56.7241863Z  
2025-11-10T00:08:56.7242023Z          if transactions.is_empty() {
2025-11-10T00:08:56.7242595Z -            return Err(RpcError::internal_error("Block has no transactions".to_string()));
2025-11-10T00:08:56.7242781Z +            return Err(RpcError::internal_error(
2025-11-10T00:08:56.7242980Z +                "Block has no transactions".to_string(),
2025-11-10T00:08:56.7243088Z +            ));
2025-11-10T00:08:56.7243195Z          }
2025-11-10T00:08:56.7243307Z  
2025-11-10T00:08:56.7243464Z          // Calculate all transaction hashes
2025-11-10T00:08:56.7243898Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:482:
2025-11-10T00:08:56.7244123Z -        let mut tx_hashes: Vec<[u8; 32]> = transactions.iter()
2025-11-10T00:08:56.7244457Z -            .map(|tx| calculate_tx_id(tx))
2025-11-10T00:08:56.7244587Z -            .collect();
2025-11-10T00:08:56.7244737Z +        let mut tx_hashes: Vec<[u8; 32]> =
2025-11-10T00:08:56.7246883Z +            transactions.iter().map(|tx| calculate_tx_id(tx)).collect();
2025-11-10T00:08:56.7246990Z  
2025-11-10T00:08:56.7247143Z          let mut proof = Vec::new();
2025-11-10T00:08:56.7247328Z          let mut current_level = tx_hashes.clone();
2025-11-10T00:08:56.7248163Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:501:
2025-11-10T00:08:56.7248368Z                      combined.extend_from_slice(&chunk[1]);
2025-11-10T00:08:56.7248560Z                      let parent_hash = double_sha256(&combined);
2025-11-10T00:08:56.7248739Z                      next_level.push(parent_hash);
2025-11-10T00:08:56.7248856Z -                    
2025-11-10T00:08:56.7248953Z +
2025-11-10T00:08:56.7249143Z                      // Check if we need to add sibling to proof
2025-11-10T00:08:56.7249281Z                      if !proof_added {
2025-11-10T00:08:56.7249431Z                          for &idx in tx_indices {
2025-11-10T00:08:56.7249864Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:581:
2025-11-10T00:08:56.7250040Z                              for tx in &b.transactions {
2025-11-10T00:08:56.7250211Z                                  let txid = calculate_tx_id(tx);
2025-11-10T00:08:56.7250394Z                                  let txid_hex = hex::encode(txid);
2025-11-10T00:08:56.7250698Z -                                if txids.iter().any(|tid| tid.as_str() == Some(txid_hex.as_str())) {
2025-11-10T00:08:56.7250833Z +                                if txids
2025-11-10T00:08:56.7250969Z +                                    .iter()
2025-11-10T00:08:56.7251192Z +                                    .any(|tid| tid.as_str() == Some(txid_hex.as_str()))
2025-11-10T00:08:56.7251311Z +                                {
2025-11-10T00:08:56.7251460Z                                      block = Some(b);
2025-11-10T00:08:56.7251588Z                                      break;
2025-11-10T00:08:56.7251716Z                                  }
2025-11-10T00:08:56.7252143Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:601:
2025-11-10T00:08:56.7252378Z                  for (idx, tx) in block.transactions.iter().enumerate() {
2025-11-10T00:08:56.7252554Z                      let txid = calculate_tx_id(tx);
2025-11-10T00:08:56.7253055Z                      let txid_hex = hex::encode(txid);
2025-11-10T00:08:56.7253341Z -                    if txids.iter().any(|tid| tid.as_str() == Some(txid_hex.as_str())) {
2025-11-10T00:08:56.7253475Z +                    if txids
2025-11-10T00:08:56.7253593Z +                        .iter()
2025-11-10T00:08:56.7253801Z +                        .any(|tid| tid.as_str() == Some(txid_hex.as_str()))
2025-11-10T00:08:56.7253916Z +                    {
2025-11-10T00:08:56.7256143Z                          tx_indices.push(idx);
2025-11-10T00:08:56.7256257Z                      }
2025-11-10T00:08:56.7256365Z                  }
2025-11-10T00:08:56.7256895Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:608:
2025-11-10T00:08:56.7257005Z  
2025-11-10T00:08:56.7257152Z                  if tx_indices.is_empty() {
2025-11-10T00:08:56.7257829Z -                    return Err(RpcError::invalid_params("None of the specified transactions found in block"));
2025-11-10T00:08:56.7258027Z +                    return Err(RpcError::invalid_params(
2025-11-10T00:08:56.7258251Z +                        "None of the specified transactions found in block",
2025-11-10T00:08:56.7258370Z +                    ));
2025-11-10T00:08:56.7258489Z                  }
2025-11-10T00:08:56.7258595Z  
2025-11-10T00:08:56.7258732Z                  // Build merkle proof
2025-11-10T00:08:56.7259178Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:614:
2025-11-10T00:08:56.7259534Z                  let proof_hashes = Self::build_merkle_proof(&block.transactions, &tx_indices)
2025-11-10T00:08:56.7259946Z -                    .map_err(|e| RpcError::internal_error(format!("Failed to build merkle proof: {}", e)))?;
2025-11-10T00:08:56.7260089Z +                    .map_err(|e| {
2025-11-10T00:08:56.7260950Z +                        RpcError::internal_error(format!("Failed to build merkle proof: {}", e))
2025-11-10T00:08:56.7261077Z +                    })?;
2025-11-10T00:08:56.7261190Z  
2025-11-10T00:08:56.7261902Z                  // Serialize proof (simplified - Bitcoin Core uses a more complex format)
2025-11-10T00:08:56.7262087Z                  let mut proof_bytes = Vec::new();
2025-11-10T00:08:56.7262531Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:626:
2025-11-10T00:08:56.7262760Z                  Err(RpcError::invalid_params("Block not found"))
2025-11-10T00:08:56.7262876Z              }
2025-11-10T00:08:56.7262992Z          } else {
2025-11-10T00:08:56.7265725Z -            Err(RpcError::invalid_params("RPC not initialized with dependencies"))
2025-11-10T00:08:56.7265900Z +            Err(RpcError::invalid_params(
2025-11-10T00:08:56.7266083Z +                "RPC not initialized with dependencies",
2025-11-10T00:08:56.7266196Z +            ))
2025-11-10T00:08:56.7266313Z          }
2025-11-10T00:08:56.7266419Z      }
2025-11-10T00:08:56.7266540Z  
2025-11-10T00:08:56.7267326Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:650:
2025-11-10T00:08:56.7267469Z              // Decode proof
2025-11-10T00:08:56.7267656Z              let proof_bytes = hex::decode(proof_hex)
2025-11-10T00:08:56.7267999Z                  .map_err(|e| RpcError::invalid_params(format!("Invalid proof hex: {}", e)))?;
2025-11-10T00:08:56.7268119Z -            
2025-11-10T00:08:56.7268227Z +
2025-11-10T00:08:56.7268380Z              if proof_bytes.is_empty() {
2025-11-10T00:08:56.7268627Z                  return Err(RpcError::invalid_params("Empty proof"));
2025-11-10T00:08:56.7268735Z              }
2025-11-10T00:08:56.7269171Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:681:
2025-11-10T00:08:56.7269471Z              if let Ok(Some(block)) = storage.blocks().get_block(&blockhash_array) {
2025-11-10T00:08:56.7269635Z                  // Calculate merkle root from block
2025-11-10T00:08:56.7269866Z                  use bllvm_protocol::mining::calculate_merkle_root;
2025-11-10T00:08:56.7270400Z -                let calculated_root = calculate_merkle_root(&block.transactions)
2025-11-10T00:08:56.7270828Z -                    .map_err(|e| RpcError::internal_error(format!("Failed to calculate merkle root: {}", e)))?;
2025-11-10T00:08:56.7271198Z +                let calculated_root = calculate_merkle_root(&block.transactions).map_err(|e| {
2025-11-10T00:08:56.7271553Z +                    RpcError::internal_error(format!("Failed to calculate merkle root: {}", e))
2025-11-10T00:08:56.7271673Z +                })?;
2025-11-10T00:08:56.7271777Z  
2025-11-10T00:08:56.7272163Z                  // Verify proof by reconstructing root (simplified - would need txids from proof)
2025-11-10T00:08:56.7272447Z                  // For now, just verify the block's merkle root matches the header
2025-11-10T00:08:56.7273137Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:690:
2025-11-10T00:08:56.7273495Z  
2025-11-10T00:08:56.7273977Z                  // Extract transaction IDs from proof (simplified - full implementation would decode txids)
2025-11-10T00:08:56.7274195Z                  use bllvm_protocol::mempool::calculate_tx_id;
2025-11-10T00:08:56.7274662Z -                let txids: Vec<String> = block.transactions.iter()
2025-11-10T00:08:56.7274829Z +                let txids: Vec<String> = block
2025-11-10T00:08:56.7274972Z +                    .transactions
2025-11-10T00:08:56.7275093Z +                    .iter()
2025-11-10T00:08:56.7275279Z                      .map(|tx| hex::encode(calculate_tx_id(tx)))
2025-11-10T00:08:56.7275416Z                      .collect();
2025-11-10T00:08:56.7275525Z  
2025-11-10T00:08:56.7275975Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:703:
2025-11-10T00:08:56.7276198Z                  Err(RpcError::invalid_params("Block not found"))
2025-11-10T00:08:56.7276310Z              }
2025-11-10T00:08:56.7276431Z          } else {
2025-11-10T00:08:56.7276767Z -            Err(RpcError::invalid_params("RPC not initialized with dependencies"))
2025-11-10T00:08:56.7276940Z +            Err(RpcError::invalid_params(
2025-11-10T00:08:56.7277124Z +                "RPC not initialized with dependencies",
2025-11-10T00:08:56.7277649Z +            ))
2025-11-10T00:08:56.7277767Z          }
2025-11-10T00:08:56.7277865Z      }
2025-11-10T00:08:56.7277961Z  }
2025-11-10T00:08:56.7334172Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:54:
2025-11-10T00:08:56.7334306Z      }
2025-11-10T00:08:56.7340541Z  
2025-11-10T00:08:56.7341009Z      /// Create a new RPC server with authentication
2025-11-10T00:08:56.7341229Z -    pub fn with_auth(
2025-11-10T00:08:56.7341436Z -        addr: SocketAddr,
2025-11-10T00:08:56.7341740Z -        auth_manager: Arc<auth::RpcAuthManager>,
2025-11-10T00:08:56.7341924Z -    ) -> Self {
2025-11-10T00:08:56.7342558Z +    pub fn with_auth(addr: SocketAddr, auth_manager: Arc<auth::RpcAuthManager>) -> Self {
2025-11-10T00:08:56.7342740Z          Self {
2025-11-10T00:08:56.7342908Z              addr,
2025-11-10T00:08:56.7343162Z              blockchain: Arc::new(blockchain::BlockchainRpc::new()),
2025-11-10T00:08:56.7343544Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:134:
2025-11-10T00:08:56.7343694Z              control: Arc::clone(&self.control),
2025-11-10T00:08:56.7343847Z              auth_manager: self.auth_manager.clone(),
2025-11-10T00:08:56.7343941Z          });
2025-11-10T00:08:56.7344040Z -        
2025-11-10T00:08:56.7344132Z +
2025-11-10T00:08:56.7344587Z          loop {
2025-11-10T00:08:56.7344834Z              match listener.accept().await {
2025-11-10T00:08:56.7344969Z                  Ok((stream, addr)) => {
2025-11-10T00:08:56.7345346Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:141:
2025-11-10T00:08:56.7345510Z                      debug!("New RPC connection from {}", addr);
2025-11-10T00:08:56.7345634Z                      let peer_addr = addr;
2025-11-10T00:08:56.7345994Z                      let server = Arc::clone(&server);
2025-11-10T00:08:56.7346087Z -                    
2025-11-10T00:08:56.7346179Z +
2025-11-10T00:08:56.7346315Z                      // Spawn task to handle connection
2025-11-10T00:08:56.7346442Z                      tokio::spawn(async move {
2025-11-10T00:08:56.7346722Z                          // Use hyper for HTTP - it will handle protocol detection and parsing
2025-11-10T00:08:56.7347080Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:148:
2025-11-10T00:08:56.7347212Z                          let io = TokioIo::new(stream);
2025-11-10T00:08:56.7347351Z                          let service = service_fn(move |req| {
2025-11-10T00:08:56.7347646Z -                            Self::handle_http_request_with_server(Arc::clone(&server), req, peer_addr)
2025-11-10T00:08:56.7347913Z +                            Self::handle_http_request_with_server(
2025-11-10T00:08:56.7348037Z +                                Arc::clone(&server),
2025-11-10T00:08:56.7348156Z +                                req,
2025-11-10T00:08:56.7348270Z +                                peer_addr,
2025-11-10T00:08:56.7348372Z +                            )
2025-11-10T00:08:56.7348472Z                          });
2025-11-10T00:08:56.7348568Z -                        
2025-11-10T00:08:56.7348656Z +
2025-11-10T00:08:56.7348777Z                          // Try to serve as HTTP
2025-11-10T00:08:56.7348925Z -                        if let Err(e) = http1::Builder::new()
2025-11-10T00:08:56.7349064Z -                            .serve_connection(io, service)
2025-11-10T00:08:56.7349167Z -                            .await
2025-11-10T00:08:56.7349268Z -                        {
2025-11-10T00:08:56.7349523Z +                        if let Err(e) = http1::Builder::new().serve_connection(io, service).await {
2025-11-10T00:08:56.7349676Z                              // If hyper fails, it might be raw TCP
2025-11-10T00:08:56.7349915Z                              // But we can't recover here since hyper consumed the connection
2025-11-10T00:08:56.7350172Z                              // For now, log and continue - raw TCP support would need separate port
2025-11-10T00:08:56.7350471Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:161:
2025-11-10T00:08:56.7350678Z -                            debug!("HTTP connection failed from {} (might be raw TCP): {}", peer_addr, e);
2025-11-10T00:08:56.7350759Z +                            debug!(
2025-11-10T00:08:56.7350902Z +                                "HTTP connection failed from {} (might be raw TCP): {}",
2025-11-10T00:08:56.7350987Z +                                peer_addr, e
2025-11-10T00:08:56.7351061Z +                            );
2025-11-10T00:08:56.7351127Z                          }
2025-11-10T00:08:56.7351191Z                      });
2025-11-10T00:08:56.7351263Z                  }
2025-11-10T00:08:56.7351517Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:185:
2025-11-10T00:08:56.7351581Z  
2025-11-10T00:08:56.7351698Z          // Extract headers before consuming request body
2025-11-10T00:08:56.7351795Z          let headers = req.headers().clone();
2025-11-10T00:08:56.7351859Z -        
2025-11-10T00:08:56.7351919Z +
2025-11-10T00:08:56.7352003Z          // Check Content-Type
2025-11-10T00:08:56.7352140Z          if let Some(content_type) = headers.get("content-type") {
2025-11-10T00:08:56.7352241Z              if content_type != "application/json" {
2025-11-10T00:08:56.7352485Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:196:
2025-11-10T00:08:56.7352578Z          // Read request body with size limit
2025-11-10T00:08:56.7352663Z          let body = req.collect().await?;
2025-11-10T00:08:56.7352751Z          let body_bytes = body.to_bytes();
2025-11-10T00:08:56.7352821Z -        
2025-11-10T00:08:56.7352883Z +
2025-11-10T00:08:56.7352967Z          // Enforce maximum request size
2025-11-10T00:08:56.7353162Z          if body_bytes.len() > MAX_REQUEST_SIZE {
2025-11-10T00:08:56.7353264Z              return Ok(Self::http_error_response(
2025-11-10T00:08:56.7353498Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:203:
2025-11-10T00:08:56.7353596Z                  StatusCode::PAYLOAD_TOO_LARGE,
2025-11-10T00:08:56.7353833Z -                &format!("Request body too large: {} bytes (max: {} bytes)", body_bytes.len(), MAX_REQUEST_SIZE),
2025-11-10T00:08:56.7353903Z +                &format!(
2025-11-10T00:08:56.7354025Z +                    "Request body too large: {} bytes (max: {} bytes)",
2025-11-10T00:08:56.7354109Z +                    body_bytes.len(),
2025-11-10T00:08:56.7354186Z +                    MAX_REQUEST_SIZE
2025-11-10T00:08:56.7354249Z +                ),
2025-11-10T00:08:56.7354492Z              ));
2025-11-10T00:08:56.7354592Z          }
2025-11-10T00:08:56.7354790Z  
2025-11-10T00:08:56.7355059Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:221:
2025-11-10T00:08:56.7355201Z          // Authenticate request if authentication is enabled
2025-11-10T00:08:56.7355323Z          if let Some(ref auth_manager) = server.auth_manager {
2025-11-10T00:08:56.7355511Z              let auth_result = auth_manager.authenticate_request(&headers, addr).await;
2025-11-10T00:08:56.7355578Z -            
2025-11-10T00:08:56.7355638Z +
2025-11-10T00:08:56.7355730Z              // Check if authentication failed
2025-11-10T00:08:56.7355831Z              if let Some(error) = auth_result.error {
2025-11-10T00:08:56.7355940Z -                return Ok(Self::http_error_response(
2025-11-10T00:08:56.7356030Z -                    StatusCode::UNAUTHORIZED,
2025-11-10T00:08:56.7356102Z -                    &error,
2025-11-10T00:08:56.7356172Z -                ));
2025-11-10T00:08:56.7356356Z +                return Ok(Self::http_error_response(StatusCode::UNAUTHORIZED, &error));
2025-11-10T00:08:56.7356419Z              }
2025-11-10T00:08:56.7356481Z  
2025-11-10T00:08:56.7356565Z              // Check rate limiting
2025-11-10T00:08:56.7356808Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:243:
2025-11-10T00:08:56.7356866Z  
2025-11-10T00:08:56.7357055Z          // Process JSON-RPC request (reuse server instance with cached handlers)
2025-11-10T00:08:56.7357245Z          let response = Self::process_request_with_server(server, &json_body).await;
2025-11-10T00:08:56.7357320Z -        let response_json =
2025-11-10T00:08:56.7357498Z -            serde_json::to_string(&response).unwrap_or_else(|_| "{}".to_string());
2025-11-10T00:08:56.7357718Z +        let response_json = serde_json::to_string(&response).unwrap_or_else(|_| "{}".to_string());
2025-11-10T00:08:56.7357776Z  
2025-11-10T00:08:56.7357880Z          // Build HTTP response
2025-11-10T00:08:56.7357986Z          Ok(Response::builder()
2025-11-10T00:08:56.7358240Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:255:
2025-11-10T00:08:56.7358314Z              .unwrap())
2025-11-10T00:08:56.7358382Z      }
2025-11-10T00:08:56.7358441Z  
2025-11-10T00:08:56.7358499Z -
2025-11-10T00:08:56.7358580Z      /// Create HTTP error response
2025-11-10T00:08:56.7358799Z      fn http_error_response(status: StatusCode, message: &str) -> Response<Full<Bytes>> {
2025-11-10T00:08:56.7358872Z          let body = json!({
2025-11-10T00:08:56.7359107Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:321:
2025-11-10T00:08:56.7359342Z      async fn call_method(&self, method: &str, params: Value) -> Result<Value, errors::RpcError> {
2025-11-10T00:08:56.7359414Z          match method {
2025-11-10T00:08:56.7359493Z              // Blockchain methods
2025-11-10T00:08:56.7359585Z -            "getblockchaininfo" => {
2025-11-10T00:08:56.7359663Z -                self.blockchain
2025-11-10T00:08:56.7359753Z -                    .get_blockchain_info()
2025-11-10T00:08:56.7359821Z -                    .await
2025-11-10T00:08:56.7360218Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-10T00:08:56.7360329Z -            }
2025-11-10T00:08:56.7360488Z +            "getblockchaininfo" => self
2025-11-10T00:08:56.7360601Z +                .blockchain
2025-11-10T00:08:56.7360690Z +                .get_blockchain_info()
2025-11-10T00:08:56.7360756Z +                .await
2025-11-10T00:08:56.7360994Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-10T00:08:56.7361414Z              "getblock" => {
2025-11-10T00:08:56.7361715Z                  let hash = params.get(0).and_then(|p| p.as_str()).unwrap_or("");
2025-11-10T00:08:56.7362035Z                  self.blockchain
2025-11-10T00:08:56.7362442Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:349:
2025-11-10T00:08:56.7362855Z                      .await
2025-11-10T00:08:56.7363266Z                      .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-10T00:08:56.7363574Z              }
2025-11-10T00:08:56.7363764Z -            "getbestblockhash" => {
2025-11-10T00:08:56.7364010Z -                self.blockchain
2025-11-10T00:08:56.7364238Z -                    .get_best_block_hash()
2025-11-10T00:08:56.7364790Z -                    .await
2025-11-10T00:08:56.7365135Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-10T00:08:56.7365436Z -            }
2025-11-10T00:08:56.7365614Z -            "getblockcount" => {
2025-11-10T00:08:56.7365839Z -                self.blockchain
2025-11-10T00:08:56.7366052Z -                    .get_block_count()
2025-11-10T00:08:56.7366425Z -                    .await
2025-11-10T00:08:56.7367014Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-10T00:08:56.7367553Z -            }
2025-11-10T00:08:56.7367883Z -            "getdifficulty" => {
2025-11-10T00:08:56.7368292Z -                self.blockchain
2025-11-10T00:08:56.7368708Z -                    .get_difficulty()
2025-11-10T00:08:56.7369132Z -                    .await
2025-11-10T00:08:56.7369647Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-10T00:08:56.7370195Z -            }
2025-11-10T00:08:56.7370524Z -            "gettxoutsetinfo" => {
2025-11-10T00:08:56.7370949Z -                self.blockchain
2025-11-10T00:08:56.7371369Z -                    .get_txoutset_info()
2025-11-10T00:08:56.7371824Z -                    .await
2025-11-10T00:08:56.7372345Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-10T00:08:56.7373155Z -            }
2025-11-10T00:08:56.7373493Z +            "getbestblockhash" => self
2025-11-10T00:08:56.7373968Z +                .blockchain
2025-11-10T00:08:56.7374615Z +                .get_best_block_hash()
2025-11-10T00:08:56.7375046Z +                .await
2025-11-10T00:08:56.7375560Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-10T00:08:56.7376180Z +            "getblockcount" => self
2025-11-10T00:08:56.7376607Z +                .blockchain
2025-11-10T00:08:56.7376988Z +                .get_block_count()
2025-11-10T00:08:56.7377211Z +                .await
2025-11-10T00:08:56.7377485Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-10T00:08:56.7377808Z +            "getdifficulty" => self
2025-11-10T00:08:56.7378052Z +                .blockchain
2025-11-10T00:08:56.7378264Z +                .get_difficulty()
2025-11-10T00:08:56.7378475Z +                .await
2025-11-10T00:08:56.7378742Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-10T00:08:56.7385810Z +            "gettxoutsetinfo" => self
2025-11-10T00:08:56.7386147Z +                .blockchain
2025-11-10T00:08:56.7386392Z +                .get_txoutset_info()
2025-11-10T00:08:56.7386630Z +                .await
2025-11-10T00:08:56.7386927Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-10T00:08:56.7387722Z              "verifychain" => {
2025-11-10T00:08:56.7388027Z                  let checklevel = params.get(0).and_then(|p| p.as_u64());
2025-11-10T00:08:56.7388401Z                  let numblocks = params.get(1).and_then(|p| p.as_u64());
2025-11-10T00:08:56.7388903Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:381:
2025-11-10T00:08:56.7389320Z                      .await
2025-11-10T00:08:56.7389606Z                      .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-10T00:08:56.7389917Z              }
2025-11-10T00:08:56.7390105Z -            "getchaintips" => {
2025-11-10T00:08:56.7390338Z -                self.blockchain
2025-11-10T00:08:56.7390563Z -                    .get_chain_tips()
2025-11-10T00:08:56.7390799Z -                    .await
2025-11-10T00:08:56.7391435Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-10T00:08:56.7392017Z -            }
2025-11-10T00:08:56.7392347Z -            "getchaintxstats" => {
2025-11-10T00:08:56.7392779Z -                self.blockchain
2025-11-10T00:08:56.7393217Z -                    .get_chain_tx_stats(&params)
2025-11-10T00:08:56.7393666Z -                    .await
2025-11-10T00:08:56.7394194Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-10T00:08:56.7394881Z -            }
2025-11-10T00:08:56.7395083Z -            "getblockstats" => {
2025-11-10T00:08:56.7395324Z -                self.blockchain
2025-11-10T00:08:56.7395573Z -                    .get_block_stats(&params)
2025-11-10T00:08:56.7395826Z -                    .await
2025-11-10T00:08:56.7396121Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-10T00:08:56.7396809Z -            }
2025-11-10T00:08:56.7396995Z -            "pruneblockchain" => {
2025-11-10T00:08:56.7397253Z -                self.blockchain
2025-11-10T00:08:56.7397497Z -                    .prune_blockchain(&params)
2025-11-10T00:08:56.7397755Z -                    .await
2025-11-10T00:08:56.7398030Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-10T00:08:56.7398327Z -            }
2025-11-10T00:08:56.7398501Z -            "getpruneinfo" => {
2025-11-10T00:08:56.7398722Z -                self.blockchain
2025-11-10T00:08:56.7398954Z -                    .get_prune_info(&params)
2025-11-10T00:08:56.7399189Z -                    .await
2025-11-10T00:08:56.7399457Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-10T00:08:56.7399746Z -            }
2025-11-10T00:08:56.7399936Z -            "invalidateblock" => {
2025-11-10T00:08:56.7400165Z -                self.blockchain
2025-11-10T00:08:56.7400401Z -                    .invalidate_block(&params)
2025-11-10T00:08:56.7400638Z -                    .await
2025-11-10T00:08:56.7400907Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-10T00:08:56.7401206Z -            }
2025-11-10T00:08:56.7401385Z -            "reconsiderblock" => {
2025-11-10T00:08:56.7401621Z -                self.blockchain
2025-11-10T00:08:56.7401845Z -                    .reconsider_block(&params)
2025-11-10T00:08:56.7402087Z -                    .await
2025-11-10T00:08:56.7402349Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-10T00:08:56.7402652Z -            }
2025-11-10T00:08:56.7402826Z -            "waitfornewblock" => {
2025-11-10T00:08:56.7403056Z -                self.blockchain
2025-11-10T00:08:56.7403291Z -                    .wait_for_new_block(&params)
2025-11-10T00:08:56.7403695Z -                    .await
2025-11-10T00:08:56.7403979Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-10T00:08:56.7404277Z -            }
2025-11-10T00:08:56.7404683Z -            "waitforblock" => {
2025-11-10T00:08:56.7404905Z -                self.blockchain
2025-11-10T00:08:56.7405363Z -                    .wait_for_block(&params)
2025-11-10T00:08:56.7405599Z -                    .await
2025-11-10T00:08:56.7405879Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-10T00:08:56.7406168Z -            }
2025-11-10T00:08:56.7406361Z -            "waitforblockheight" => {
2025-11-10T00:08:56.7406609Z -                self.blockchain
2025-11-10T00:08:56.7406847Z -                    .wait_for_block_height(&params)
2025-11-10T00:08:56.7407098Z -                    .await
2025-11-10T00:08:56.7407427Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-10T00:08:56.7407959Z -            }
2025-11-10T00:08:56.7408222Z +            "getchaintips" => self
2025-11-10T00:08:56.7408458Z +                .blockchain
2025-11-10T00:08:56.7408667Z +                .get_chain_tips()
2025-11-10T00:08:56.7409029Z +                .await
2025-11-10T00:08:56.7409302Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-10T00:08:56.7409634Z +            "getchaintxstats" => self
2025-11-10T00:08:56.7409871Z +                .blockchain
2025-11-10T00:08:56.7410090Z +                .get_chain_tx_stats(&params)
2025-11-10T00:08:56.7410330Z +                .await
2025-11-10T00:08:56.7410584Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-10T00:08:56.7410908Z +            "getblockstats" => self
2025-11-10T00:08:56.7411137Z +                .blockchain
2025-11-10T00:08:56.7413212Z +                .get_block_stats(&params)
2025-11-10T00:08:56.7413446Z +                .await
2025-11-10T00:08:56.7413705Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-10T00:08:56.7414027Z +            "pruneblockchain" => self
2025-11-10T00:08:56.7414262Z +                .blockchain
2025-11-10T00:08:56.7415751Z +                .prune_blockchain(&params)
2025-11-10T00:08:56.7416009Z +                .await
2025-11-10T00:08:56.7416300Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-10T00:08:56.7416616Z +            "getpruneinfo" => self
2025-11-10T00:08:56.7416868Z +                .blockchain
2025-11-10T00:08:56.7417248Z +                .get_prune_info(&params)
2025-11-10T00:08:56.7417567Z +                .await
2025-11-10T00:08:56.7417835Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-10T00:08:56.7418151Z +            "invalidateblock" => self
2025-11-10T00:08:56.7418393Z +                .blockchain
2025-11-10T00:08:56.7418609Z +                .invalidate_block(&params)
2025-11-10T00:08:56.7418845Z +                .await
2025-11-10T00:08:56.7419099Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-10T00:08:56.7419419Z +            "reconsiderblock" => self
2025-11-10T00:08:56.7419648Z +                .blockchain
2025-11-10T00:08:56.7419877Z +                .reconsider_block(&params)
2025-11-10T00:08:56.7420122Z +                .await
2025-11-10T00:08:56.7420373Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-10T00:08:56.7420690Z +            "waitfornewblock" => self
2025-11-10T00:08:56.7420918Z +                .blockchain
2025-11-10T00:08:56.7421146Z +                .wait_for_new_block(&params)
2025-11-10T00:08:56.7421380Z +                .await
2025-11-10T00:08:56.7421639Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-10T00:08:56.7421946Z +            "waitforblock" => self
2025-11-10T00:08:56.7422175Z +                .blockchain
2025-11-10T00:08:56.7422391Z +                .wait_for_block(&params)
2025-11-10T00:08:56.7422620Z +                .await
2025-11-10T00:08:56.7422877Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-10T00:08:56.7423195Z +            "waitforblockheight" => self
2025-11-10T00:08:56.7423445Z +                .blockchain
2025-11-10T00:08:56.7423847Z +                .wait_for_block_height(&params)
2025-11-10T00:08:56.7424104Z +                .await
2025-11-10T00:08:56.7424609Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-10T00:08:56.7424949Z  
2025-11-10T00:08:56.7425132Z              // Raw Transaction methods
2025-11-10T00:08:56.7425387Z -            "getrawtransaction" => {
2025-11-10T00:08:56.7425677Z -                self.rawtx.getrawtransaction(&params).await
2025-11-10T00:08:56.7425954Z -            }
2025-11-10T00:08:56.7426140Z -            "sendrawtransaction" => {
2025-11-10T00:08:56.7426430Z -                self.rawtx.sendrawtransaction(&params).await
2025-11-10T00:08:56.7426699Z -            }
2025-11-10T00:08:56.7426888Z -            "testmempoolaccept" => {
2025-11-10T00:08:56.7427160Z -                self.rawtx.testmempoolaccept(&params).await
2025-11-10T00:08:56.7427428Z -            }
2025-11-10T00:08:56.7427757Z -            "decoderawtransaction" => {
2025-11-10T00:08:56.7428068Z -                self.rawtx.decoderawtransaction(&params).await
2025-11-10T00:08:56.7428345Z -            }
2025-11-10T00:08:56.7428518Z -            "gettxout" => {
2025-11-10T00:08:56.7428751Z -                self.rawtx.gettxout(&params).await
2025-11-10T00:08:56.7428999Z -            }
2025-11-10T00:08:56.7429180Z -            "gettxoutproof" => {
2025-11-10T00:08:56.7429439Z -                self.rawtx.gettxoutproof(&params).await
2025-11-10T00:08:56.7429699Z -            }
2025-11-10T00:08:56.7429878Z -            "verifytxoutproof" => {
2025-11-10T00:08:56.7430159Z -                self.rawtx.verifytxoutproof(&params).await
2025-11-10T00:08:56.7430419Z -            }
2025-11-10T00:08:56.7430705Z +            "getrawtransaction" => self.rawtx.getrawtransaction(&params).await,
2025-11-10T00:08:56.7431179Z +            "sendrawtransaction" => self.rawtx.sendrawtransaction(&params).await,
2025-11-10T00:08:56.7431637Z +            "testmempoolaccept" => self.rawtx.testmempoolaccept(&params).await,
2025-11-10T00:08:56.7432109Z +            "decoderawtransaction" => self.rawtx.decoderawtransaction(&params).await,
2025-11-10T00:08:56.7432520Z +            "gettxout" => self.rawtx.gettxout(&params).await,
2025-11-10T00:08:56.7432879Z +            "gettxoutproof" => self.rawtx.gettxoutproof(&params).await,
2025-11-10T00:08:56.7433285Z +            "verifytxoutproof" => self.rawtx.verifytxoutproof(&params).await,
2025-11-10T00:08:56.7433612Z  
2025-11-10T00:08:56.7433776Z              // Mempool methods
2025-11-10T00:08:56.7433995Z -            "getmempoolinfo" => {
2025-11-10T00:08:56.7434284Z -                self.mempool.getmempoolinfo(&params).await
2025-11-10T00:08:56.7434931Z -            }
2025-11-10T00:08:56.7435130Z -            "getrawmempool" => {
2025-11-10T00:08:56.7435402Z -                self.mempool.getrawmempool(&params).await
2025-11-10T00:08:56.7435668Z -            }
2025-11-10T00:08:56.7435855Z -            "savemempool" => {
2025-11-10T00:08:56.7436119Z -                self.mempool.savemempool(&params).await
2025-11-10T00:08:56.7436379Z -            }
2025-11-10T00:08:56.7436571Z -            "getmempoolancestors" => {
2025-11-10T00:08:56.7436880Z -                self.mempool.getmempoolancestors(&params).await
2025-11-10T00:08:56.7437159Z -            }
2025-11-10T00:08:56.7437355Z -            "getmempooldescendants" => {
2025-11-10T00:08:56.7437664Z -                self.mempool.getmempooldescendants(&params).await
2025-11-10T00:08:56.7437958Z -            }
2025-11-10T00:08:56.7438138Z -            "getmempoolentry" => {
2025-11-10T00:08:56.7438422Z -                self.mempool.getmempoolentry(&params).await
2025-11-10T00:08:56.7438685Z -            }
2025-11-10T00:08:56.7438956Z +            "getmempoolinfo" => self.mempool.getmempoolinfo(&params).await,
2025-11-10T00:08:56.7439377Z +            "getrawmempool" => self.mempool.getrawmempool(&params).await,
2025-11-10T00:08:56.7439771Z +            "savemempool" => self.mempool.savemempool(&params).await,
2025-11-10T00:08:56.7440210Z +            "getmempoolancestors" => self.mempool.getmempoolancestors(&params).await,
2025-11-10T00:08:56.7440868Z +            "getmempooldescendants" => self.mempool.getmempooldescendants(&params).await,
2025-11-10T00:08:56.7441350Z +            "getmempoolentry" => self.mempool.getmempoolentry(&params).await,
2025-11-10T00:08:56.7441672Z  
2025-11-10T00:08:56.7441835Z              // Network methods
2025-11-10T00:08:56.7442060Z -            "getnetworkinfo" => {
2025-11-10T00:08:56.7442310Z -                self.network.get_network_info().await
2025-11-10T00:08:56.7442564Z -            }
2025-11-10T00:08:56.7444801Z -            "getpeerinfo" => {
2025-11-10T00:08:56.7445046Z -                self.network.get_peer_info().await
2025-11-10T00:08:56.7445289Z -            }
2025-11-10T00:08:56.7445477Z -            "getconnectioncount" => {
2025-11-10T00:08:56.7445766Z -                self.network.get_connection_count(&params).await
2025-11-10T00:08:56.7446192Z -            }
2025-11-10T00:08:56.7446366Z -            "ping" => {
2025-11-10T00:08:56.7446603Z -                self.network.ping(&params).await
2025-11-10T00:08:56.7446855Z -            }
2025-11-10T00:08:56.7447023Z -            "addnode" => {
2025-11-10T00:08:56.7447263Z -                self.network.add_node(&params).await
2025-11-10T00:08:56.7447510Z -            }
2025-11-10T00:08:56.7447689Z -            "disconnectnode" => {
2025-11-10T00:08:56.7447959Z -                self.network.disconnect_node(&params).await
2025-11-10T00:08:56.7448227Z -            }
2025-11-10T00:08:56.7448398Z -            "getnettotals" => {
2025-11-10T00:08:56.7448654Z -                self.network.get_net_totals(&params).await
2025-11-10T00:08:56.7448908Z -            }
2025-11-10T00:08:56.7449080Z -            "clearbanned" => {
2025-11-10T00:08:56.7449328Z -                self.network.clear_banned(&params).await
2025-11-10T00:08:56.7449584Z -            }
2025-11-10T00:08:56.7449758Z -            "setban" => {
2025-11-10T00:08:56.7449987Z -                self.network.set_ban(&params).await
2025-11-10T00:08:56.7450251Z -            }
2025-11-10T00:08:56.7450436Z -            "listbanned" => {
2025-11-10T00:08:56.7450691Z -                self.network.list_banned(&params).await
2025-11-10T00:08:56.7450947Z -            }
2025-11-10T00:08:56.7451135Z -            "getaddednodeinfo" => {
2025-11-10T00:08:56.7451418Z -                self.network.getaddednodeinfo(&params).await
2025-11-10T00:08:56.7451695Z -            }
2025-11-10T00:08:56.7451878Z -            "getnodeaddresses" => {
2025-11-10T00:08:56.7452149Z -                self.network.getnodeaddresses(&params).await
2025-11-10T00:08:56.7452417Z -            }
2025-11-10T00:08:56.7452590Z -            "setnetworkactive" => {
2025-11-10T00:08:56.7454923Z -                self.network.setnetworkactive(&params).await
2025-11-10T00:08:56.7455189Z -            }
2025-11-10T00:08:56.7455464Z +            "getnetworkinfo" => self.network.get_network_info().await,
2025-11-10T00:08:56.7456104Z +            "getpeerinfo" => self.network.get_peer_info().await,
2025-11-10T00:08:56.7456829Z +            "getconnectioncount" => self.network.get_connection_count(&params).await,
2025-11-10T00:08:56.7457531Z +            "ping" => self.network.ping(&params).await,
2025-11-10T00:08:56.7458064Z +            "addnode" => self.network.add_node(&params).await,
2025-11-10T00:08:56.7458712Z +            "disconnectnode" => self.network.disconnect_node(&params).await,
2025-11-10T00:08:56.7459166Z +            "getnettotals" => self.network.get_net_totals(&params).await,
2025-11-10T00:08:56.7459550Z +            "clearbanned" => self.network.clear_banned(&params).await,
2025-11-10T00:08:56.7459897Z +            "setban" => self.network.set_ban(&params).await,
2025-11-10T00:08:56.7460229Z +            "listbanned" => self.network.list_banned(&params).await,
2025-11-10T00:08:56.7460631Z +            "getaddednodeinfo" => self.network.getaddednodeinfo(&params).await,
2025-11-10T00:08:56.7461076Z +            "getnodeaddresses" => self.network.getnodeaddresses(&params).await,
2025-11-10T00:08:56.7462042Z +            "setnetworkactive" => self.network.setnetworkactive(&params).await,
2025-11-10T00:08:56.7462627Z  
2025-11-10T00:08:56.7464951Z              // Mining methods
2025-11-10T00:08:56.7465172Z -            "getmininginfo" => {
2025-11-10T00:08:56.7465437Z -                self.mining.get_mining_info().await
2025-11-10T00:08:56.7465688Z -            }
2025-11-10T00:08:56.7465873Z -            "getblocktemplate" => {
2025-11-10T00:08:56.7466157Z -                self.mining.get_block_template(&params).await
2025-11-10T00:08:56.7466422Z -            }
2025-11-10T00:08:56.7466602Z -            "submitblock" => {
2025-11-10T00:08:56.7466847Z -                self.mining.submit_block(&params).await
2025-11-10T00:08:56.7467102Z -            }
2025-11-10T00:08:56.7467278Z -            "estimatesmartfee" => {
2025-11-10T00:08:56.7467705Z -                self.mining.estimate_smart_fee(&params).await
2025-11-10T00:08:56.7467975Z -            }
2025-11-10T00:08:56.7468172Z -            "prioritisetransaction" => {
2025-11-10T00:08:56.7468478Z -                self.mining.prioritise_transaction(&params).await
2025-11-10T00:08:56.7468751Z -            }
2025-11-10T00:08:56.7468932Z -            "getblockfilter" => {
2025-11-10T00:08:56.7469158Z -                self.blockchain
2025-11-10T00:08:56.7469401Z -                    .get_block_filter(&params)
2025-11-10T00:08:56.7469643Z -                    .await
2025-11-10T00:08:56.7469936Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-10T00:08:56.7470235Z -            }
2025-11-10T00:08:56.7470417Z -            "getindexinfo" => {
2025-11-10T00:08:56.7470642Z -                self.blockchain
2025-11-10T00:08:56.7470869Z -                    .get_index_info(&params)
2025-11-10T00:08:56.7471110Z -                    .await
2025-11-10T00:08:56.7471378Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-10T00:08:56.7471671Z -            }
2025-11-10T00:08:56.7471904Z +            "getmininginfo" => self.mining.get_mining_info().await,
2025-11-10T00:08:56.7472305Z +            "getblocktemplate" => self.mining.get_block_template(&params).await,
2025-11-10T00:08:56.7472841Z +            "submitblock" => self.mining.submit_block(&params).await,
2025-11-10T00:08:56.7473240Z +            "estimatesmartfee" => self.mining.estimate_smart_fee(&params).await,
2025-11-10T00:08:56.7473721Z +            "prioritisetransaction" => self.mining.prioritise_transaction(&params).await,
2025-11-10T00:08:56.7474107Z +            "getblockfilter" => self
2025-11-10T00:08:56.7474449Z +                .blockchain
2025-11-10T00:08:56.7474673Z +                .get_block_filter(&params)
2025-11-10T00:08:56.7474913Z +                .await
2025-11-10T00:08:56.7475178Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-10T00:08:56.7475501Z +            "getindexinfo" => self
2025-11-10T00:08:56.7475730Z +                .blockchain
2025-11-10T00:08:56.7475948Z +                .get_index_info(&params)
2025-11-10T00:08:56.7476180Z +                .await
2025-11-10T00:08:56.7476434Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-10T00:08:56.7477178Z  
2025-11-10T00:08:56.7477337Z              // Control methods
2025-11-10T00:08:56.7477554Z -            "stop" => {
2025-11-10T00:08:56.7477784Z -                self.control.stop(&params).await
2025-11-10T00:08:56.7478031Z -            }
2025-11-10T00:08:56.7478202Z -            "uptime" => {
2025-11-10T00:08:56.7478438Z -                self.control.uptime(&params).await
2025-11-10T00:08:56.7478693Z -            }
2025-11-10T00:08:56.7478870Z -            "getmemoryinfo" => {
2025-11-10T00:08:56.7479139Z -                self.control.getmemoryinfo(&params).await
2025-11-10T00:08:56.7479399Z -            }
2025-11-10T00:08:56.7479575Z -            "getrpcinfo" => {
2025-11-10T00:08:56.7479824Z -                self.control.getrpcinfo(&params).await
2025-11-10T00:08:56.7480543Z -            }
2025-11-10T00:08:56.7480711Z -            "help" => {
2025-11-10T00:08:56.7480934Z -                self.control.help(&params).await
2025-11-10T00:08:56.7481176Z -            }
2025-11-10T00:08:56.7481349Z -            "logging" => {
2025-11-10T00:08:56.7481583Z -                self.control.logging(&params).await
2025-11-10T00:08:56.7481829Z -            }
2025-11-10T00:08:56.7482004Z -            "gethealth" => {
2025-11-10T00:08:56.7482251Z -                self.control.gethealth(&params).await
2025-11-10T00:08:56.7482503Z -            }
2025-11-10T00:08:56.7482672Z -            "getmetrics" => {
2025-11-10T00:08:56.7482912Z -                self.control.getmetrics(&params).await
2025-11-10T00:08:56.7483158Z -            }
2025-11-10T00:08:56.7483364Z +            "stop" => self.control.stop(&params).await,
2025-11-10T00:08:56.7483664Z +            "uptime" => self.control.uptime(&params).await,
2025-11-10T00:08:56.7484163Z +            "getmemoryinfo" => self.control.getmemoryinfo(&params).await,
2025-11-10T00:08:56.7484706Z +            "getrpcinfo" => self.control.getrpcinfo(&params).await,
2025-11-10T00:08:56.7485028Z +            "help" => self.control.help(&params).await,
2025-11-10T00:08:56.7485336Z +            "logging" => self.control.logging(&params).await,
2025-11-10T00:08:56.7485664Z +            "gethealth" => self.control.gethealth(&params).await,
2025-11-10T00:08:56.7486012Z +            "getmetrics" => self.control.getmetrics(&params).await,
2025-11-10T00:08:56.7486293Z  
2025-11-10T00:08:56.7486503Z              _ => Err(errors::RpcError::method_not_found(method)),
2025-11-10T00:08:56.7486774Z          }
2025-11-10T00:08:56.7487122Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:605:
2025-11-10T00:08:56.7487557Z          // Start server on random port
2025-11-10T00:08:56.7487913Z          let listener = tokio::net::TcpListener::bind("127.0.0.1:0").await.unwrap();
2025-11-10T00:08:56.7488314Z          let server_addr = listener.local_addr().unwrap();
2025-11-10T00:08:56.7488584Z -        
2025-11-10T00:08:56.7488739Z +
2025-11-10T00:08:56.7488907Z          // Spawn server task using hyper
2025-11-10T00:08:56.7489196Z          let server_handle = tokio::spawn(async move {
2025-11-10T00:08:56.7489463Z              loop {
2025-11-10T00:08:56.7489824Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:617:
2025-11-10T00:08:56.7490274Z                              let service = service_fn(move |req| {
2025-11-10T00:08:56.7490590Z                                  RpcServer::handle_http_request(req, peer_addr)
2025-11-10T00:08:56.7490883Z                              });
2025-11-10T00:08:56.7491121Z -                            let _ = http1::Builder::new()
2025-11-10T00:08:56.7491411Z -                                .serve_connection(io, service)
2025-11-10T00:08:56.7491679Z -                                .await;
2025-11-10T00:08:56.7492000Z +                            let _ = http1::Builder::new().serve_connection(io, service).await;
2025-11-10T00:08:56.7492328Z                          });
2025-11-10T00:08:56.7492530Z                      }
2025-11-10T00:08:56.7492722Z                      Err(_) => break,
2025-11-10T00:08:56.7493121Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:632:
2025-11-10T00:08:56.7493523Z  
2025-11-10T00:08:56.7493680Z          // Connect to server
2025-11-10T00:08:56.7494000Z          let mut client = TokioTcpStream::connect(server_addr).await.unwrap();
2025-11-10T00:08:56.7494434Z -        
2025-11-10T00:08:56.7494585Z +
2025-11-10T00:08:56.7494745Z          // Send HTTP POST request
2025-11-10T00:08:56.7495062Z          let json_body = r#"{"jsonrpc":"2.0","method":"ping","params":[],"id":1}"#;
2025-11-10T00:08:56.7495397Z          let http_request = format!(
2025-11-10T00:08:56.7495799Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:645:
2025-11-10T00:08:56.7496208Z              json_body.len(),
2025-11-10T00:08:56.7496542Z              json_body
2025-11-10T00:08:56.7496728Z          );
2025-11-10T00:08:56.7496889Z -        
2025-11-10T00:08:56.7497035Z +
2025-11-10T00:08:56.7497263Z          client.write_all(http_request.as_bytes()).await.unwrap();
2025-11-10T00:08:56.7497551Z -        
2025-11-10T00:08:56.7497701Z +
2025-11-10T00:08:56.7497854Z          // Read response
2025-11-10T00:08:56.7498075Z          let mut response = vec![0u8; 4096];
2025-11-10T00:08:56.7498331Z          let n = tokio::time::timeout(
2025-11-10T00:08:56.7498740Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:654:
2025-11-10T00:08:56.7499171Z              tokio::time::Duration::from_secs(2),
2025-11-10T00:08:56.7499438Z -            client.read(&mut response)
2025-11-10T00:08:56.7499693Z -        ).await.unwrap().unwrap();
2025-11-10T00:08:56.7499911Z -        
2025-11-10T00:08:56.7500210Z +            client.read(&mut response),
2025-11-10T00:08:56.7500441Z +        )
2025-11-10T00:08:56.7500602Z +        .await
2025-11-10T00:08:56.7500767Z +        .unwrap()
2025-11-10T00:08:56.7500941Z +        .unwrap();
2025-11-10T00:08:56.7501109Z +
2025-11-10T00:08:56.7501340Z          let response_str = String::from_utf8_lossy(&response[..n]);
2025-11-10T00:08:56.7501625Z -        
2025-11-10T00:08:56.7501779Z +
2025-11-10T00:08:56.7501995Z          // Verify HTTP response (hyper uses lowercase headers)
2025-11-10T00:08:56.7502513Z -        assert!(response_str.contains("HTTP/1.1 200 OK") || response_str.contains("200 OK"), "Response: {}", response_str);
2025-11-10T00:08:56.7503253Z -        assert!(response_str.contains("content-type: application/json") || response_str.contains("Content-Type: application/json"));
2025-11-10T00:08:56.7503753Z +        assert!(
2025-11-10T00:08:56.7504056Z +            response_str.contains("HTTP/1.1 200 OK") || response_str.contains("200 OK"),
2025-11-10T00:08:56.7504526Z +            "Response: {}",
2025-11-10T00:08:56.7504739Z +            response_str
2025-11-10T00:08:56.7504932Z +        );
2025-11-10T00:08:56.7505086Z +        assert!(
2025-11-10T00:08:56.7505334Z +            response_str.contains("content-type: application/json")
2025-11-10T00:08:56.7505702Z +                || response_str.contains("Content-Type: application/json")
2025-11-10T00:08:56.7505998Z +        );
2025-11-10T00:08:56.7506193Z          assert!(response_str.contains("jsonrpc"));
2025-11-10T00:08:56.7506498Z          assert!(response_str.contains("\"result\""));
2025-11-10T00:08:56.7506750Z -        
2025-11-10T00:08:56.7506904Z +
2025-11-10T00:08:56.7507059Z          server_handle.abort();
2025-11-10T00:08:56.7507265Z      }
2025-11-10T00:08:56.7507419Z  
2025-11-10T00:08:56.7507743Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:669:
2025-11-10T00:08:56.7508147Z -
2025-11-10T00:08:56.7508307Z      #[tokio::test]
2025-11-10T00:08:56.7508527Z      async fn test_process_request_valid_json() {
2025-11-10T00:08:56.7508918Z          let request = r#"{"jsonrpc":"2.0","method":"getblockchaininfo","params":[],"id":1}"#;
2025-11-10T00:08:56.7509569Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:684:
2025-11-10T00:08:56.7510269Z  
2025-11-10T00:08:56.7510576Z          assert_eq!(response["jsonrpc"], "2.0");
2025-11-10T00:08:56.7518212Z          assert_eq!(response["error"]["code"], -32700);
2025-11-10T00:08:56.7518753Z -        assert!(response["error"]["message"].as_str().unwrap().contains("Parse error") || 
2025-11-10T00:08:56.7519268Z -                response["error"]["message"].as_str().unwrap().contains("Invalid JSON"));
2025-11-10T00:08:56.7519619Z +        assert!(
2025-11-10T00:08:56.7519823Z +            response["error"]["message"]
2025-11-10T00:08:56.7520078Z +                .as_str()
2025-11-10T00:08:56.7520288Z +                .unwrap()
2025-11-10T00:08:56.7520506Z +                .contains("Parse error")
2025-11-10T00:08:56.7520785Z +                || response["error"]["message"]
2025-11-10T00:08:56.7521269Z +                    .as_str()
2025-11-10T00:08:56.7521481Z +                    .unwrap()
2025-11-10T00:08:56.7521713Z +                    .contains("Invalid JSON")
2025-11-10T00:08:56.7521959Z +        );
2025-11-10T00:08:56.7522113Z      }
2025-11-10T00:08:56.7522263Z  
2025-11-10T00:08:56.7522427Z      #[tokio::test]
2025-11-10T00:08:56.7522805Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:695:
2025-11-10T00:08:56.7523212Z  
2025-11-10T00:08:56.7523388Z          assert_eq!(response["jsonrpc"], "2.0");
2025-11-10T00:08:56.7523689Z          assert_eq!(response["error"]["code"], -32601);
2025-11-10T00:08:56.7524102Z -        assert!(response["error"]["message"].as_str().unwrap().contains("Method not found"));
2025-11-10T00:08:56.7524666Z +        assert!(response["error"]["message"]
2025-11-10T00:08:56.7524904Z +            .as_str()
2025-11-10T00:08:56.7525230Z +            .unwrap()
2025-11-10T00:08:56.7525435Z +            .contains("Method not found"));
2025-11-10T00:08:56.7525701Z          assert_eq!(response["id"], 1);
2025-11-10T00:08:56.7525927Z      }
2025-11-10T00:08:56.7526071Z  
2025-11-10T00:08:56.7526415Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:822:
2025-11-10T00:08:56.7526818Z  
2025-11-10T00:08:56.7526997Z          assert_eq!(response["jsonrpc"], "2.0");
2025-11-10T00:08:56.7527285Z          assert_eq!(response["error"]["code"], -32700);
2025-11-10T00:08:56.7527683Z -        assert!(response["error"]["message"].as_str().unwrap().contains("Parse error") ||
2025-11-10T00:08:56.7528147Z -                response["error"]["message"].as_str().unwrap().contains("Invalid JSON"));
2025-11-10T00:08:56.7528479Z +        assert!(
2025-11-10T00:08:56.7528678Z +            response["error"]["message"]
2025-11-10T00:08:56.7528920Z +                .as_str()
2025-11-10T00:08:56.7529121Z +                .unwrap()
2025-11-10T00:08:56.7529327Z +                .contains("Parse error")
2025-11-10T00:08:56.7529581Z +                || response["error"]["message"]
2025-11-10T00:08:56.7529823Z +                    .as_str()
2025-11-10T00:08:56.7530030Z +                    .unwrap()
2025-11-10T00:08:56.7530255Z +                    .contains("Invalid JSON")
2025-11-10T00:08:56.7530500Z +        );
2025-11-10T00:08:56.7530658Z      }
2025-11-10T00:08:56.7530812Z  
2025-11-10T00:08:56.7530967Z      #[tokio::test]
2025-11-10T00:08:56.7533144Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:833:
2025-11-10T00:08:56.7533549Z  
2025-11-10T00:08:56.7533727Z          assert_eq!(response["jsonrpc"], "2.0");
2025-11-10T00:08:56.7534020Z          assert_eq!(response["error"]["code"], -32601);
2025-11-10T00:08:56.7534541Z -        assert!(response["error"]["message"].as_str().unwrap().contains("Method not found"));
2025-11-10T00:08:56.7534944Z +        assert!(response["error"]["message"]
2025-11-10T00:08:56.7535189Z +            .as_str()
2025-11-10T00:08:56.7535381Z +            .unwrap()
2025-11-10T00:08:56.7535590Z +            .contains("Method not found"));
2025-11-10T00:08:56.7535964Z          assert!(response["error"]["data"].is_string() || response["error"]["data"].is_null());
2025-11-10T00:08:56.7536349Z          assert_eq!(response["id"], 42);
2025-11-10T00:08:56.7536571Z      }
2025-11-10T00:08:56.7536907Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:855:
2025-11-10T00:08:56.7536970Z  
2025-11-10T00:08:56.7537063Z          assert_eq!(response["jsonrpc"], "2.0");
2025-11-10T00:08:56.7537594Z          assert_eq!(response["error"]["code"], -32601);
2025-11-10T00:08:56.7537805Z -        assert!(response["error"]["message"].as_str().unwrap().contains("Method not found"));
2025-11-10T00:08:56.7537900Z +        assert!(response["error"]["message"]
2025-11-10T00:08:56.7537973Z +            .as_str()
2025-11-10T00:08:56.7538040Z +            .unwrap()
2025-11-10T00:08:56.7538134Z +            .contains("Method not found"));
2025-11-10T00:08:56.7538377Z          assert_eq!(response["id"], 1);
2025-11-10T00:08:56.7538448Z      }
2025-11-10T00:08:56.7538512Z  
2025-11-10T00:08:56.7538873Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/blockstore.rs:2:
2025-11-10T00:08:56.7538941Z  //!
2025-11-10T00:08:56.7539088Z  //! Stores blocks by hash and maintains block index by height.
2025-11-10T00:08:56.7539149Z  
2025-11-10T00:08:56.7539258Z +use crate::storage::database::{Database, Tree};
2025-11-10T00:08:56.7539343Z  use anyhow::Result;
2025-11-10T00:08:56.7539434Z  use bllvm_protocol::segwit::Witness;
2025-11-10T00:08:56.7539542Z  use bllvm_protocol::{Block, BlockHeader, Hash};
2025-11-10T00:08:56.7539809Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/blockstore.rs:8:
2025-11-10T00:08:56.7539916Z -use crate::storage::database::{Database, Tree};
2025-11-10T00:08:56.7539989Z  use std::sync::Arc;
2025-11-10T00:08:56.7540173Z  
2025-11-10T00:08:56.7540258Z  /// Block storage manager
2025-11-10T00:08:56.7540551Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/blockstore.rs:45:
2025-11-10T00:08:56.7540614Z  
2025-11-10T00:08:56.7540767Z          self.blocks.insert(block_hash.as_slice(), &block_data)?;
2025-11-10T00:08:56.7540902Z          let header_data = bincode::serialize(&block.header)?;
2025-11-10T00:08:56.7540973Z -        self.headers
2025-11-10T00:08:56.7541093Z -            .insert(block_hash.as_slice(), &header_data)?;
2025-11-10T00:08:56.7541244Z +        self.headers.insert(block_hash.as_slice(), &header_data)?;
2025-11-10T00:08:56.7541308Z  
2025-11-10T00:08:56.7541435Z          // Store header for median time-past calculation
2025-11-10T00:08:56.7541639Z          // We'll need height passed separately, so this will be called after store_height
2025-11-10T00:08:56.7541908Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/blockstore.rs:81:
2025-11-10T00:08:56.7541997Z      /// Store witness data for a block
2025-11-10T00:08:56.7542209Z      pub fn store_witness(&self, block_hash: &Hash, witness: &[Witness]) -> Result<()> {
2025-11-10T00:08:56.7542328Z          let witness_data = bincode::serialize(witness)?;
2025-11-10T00:08:56.7542493Z -        self.witnesses.insert(block_hash.as_slice(), &witness_data)?;
2025-11-10T00:08:56.7542574Z +        self.witnesses
2025-11-10T00:08:56.7544688Z +            .insert(block_hash.as_slice(), &witness_data)?;
2025-11-10T00:08:56.7544756Z          Ok(())
2025-11-10T00:08:56.7544823Z      }
2025-11-10T00:08:56.7544883Z  
2025-11-10T00:08:56.7545157Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/chainstate.rs:2:
2025-11-10T00:08:56.7545218Z  //!
2025-11-10T00:08:56.7545403Z  //! Stores chain metadata including tip, height, and chain parameters.
2025-11-10T00:08:56.7545462Z  
2025-11-10T00:08:56.7545570Z +use crate::storage::database::{Database, Tree};
2025-11-10T00:08:56.7545653Z  use anyhow::Result;
2025-11-10T00:08:56.7545751Z  use bllvm_protocol::{BlockHeader, Hash};
2025-11-10T00:08:56.7545845Z  use serde::{Deserialize, Serialize};
2025-11-10T00:08:56.7546113Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/chainstate.rs:8:
2025-11-10T00:08:56.7546231Z -use crate::storage::database::{Database, Tree};
2025-11-10T00:08:56.7546304Z  use std::sync::Arc;
2025-11-10T00:08:56.7546363Z  
2025-11-10T00:08:56.7546447Z  /// Chain state information
2025-11-10T00:08:56.7546727Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/chainstate.rs:223:
2025-11-10T00:08:56.7546790Z      }
2025-11-10T00:08:56.7546849Z  
2025-11-10T00:08:56.7546954Z      /// Add a chain tip (for fork tracking)
2025-11-10T00:08:56.7547211Z -    pub fn add_chain_tip(&self, hash: &Hash, height: u64, branchlen: u64, status: &str) -> Result<()> {
2025-11-10T00:08:56.7547291Z +    pub fn add_chain_tip(
2025-11-10T00:08:56.7547362Z +        &self,
2025-11-10T00:08:56.7547435Z +        hash: &Hash,
2025-11-10T00:08:56.7547501Z +        height: u64,
2025-11-10T00:08:56.7547720Z +        branchlen: u64,
2025-11-10T00:08:56.7547793Z +        status: &str,
2025-11-10T00:08:56.7547864Z +    ) -> Result<()> {
2025-11-10T00:08:56.7547961Z          #[derive(Serialize, Deserialize)]
2025-11-10T00:08:56.7548043Z          struct TipInfo {
2025-11-10T00:08:56.7548114Z              height: u64,
2025-11-10T00:08:56.7548403Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/chainstate.rs:230:
2025-11-10T00:08:56.7548482Z              branchlen: u64,
2025-11-10T00:08:56.7548553Z              status: String,
2025-11-10T00:08:56.7548615Z          }
2025-11-10T00:08:56.7548678Z -        
2025-11-10T00:08:56.7548741Z +
2025-11-10T00:08:56.7548823Z          let tip_info = TipInfo {
2025-11-10T00:08:56.7548888Z              height,
2025-11-10T00:08:56.7548962Z              branchlen,
2025-11-10T00:08:56.7549347Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/chainstate.rs:255:
2025-11-10T00:08:56.7549424Z              branchlen: u64,
2025-11-10T00:08:56.7549500Z              status: String,
2025-11-10T00:08:56.7549570Z          }
2025-11-10T00:08:56.7549629Z -        
2025-11-10T00:08:56.7549689Z +
2025-11-10T00:08:56.7549778Z          let mut tips = Vec::new();
2025-11-10T00:08:56.7549878Z          for result in self.chain_tips.iter() {
2025-11-10T00:08:56.7549960Z              let (key, data) = result?;
2025-11-10T00:08:56.7550251Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/commitment_store.rs:4:
2025-11-10T00:08:56.7550349Z  //! without requiring full block history.
2025-11-10T00:08:56.7550410Z  
2025-11-10T00:08:56.7550500Z  #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.7550612Z +use crate::storage::database::{Database, Tree};
2025-11-10T00:08:56.7550701Z +#[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.7550772Z  use anyhow::Result;
2025-11-10T00:08:56.7550857Z  #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.7551045Z  use bllvm_protocol::utxo_commitments::data_structures::UtxoCommitment;
2025-11-10T00:08:56.7553032Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/commitment_store.rs:10:
2025-11-10T00:08:56.7553119Z  #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.7553207Z  use bllvm_protocol::Hash;
2025-11-10T00:08:56.7553291Z  #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.7553398Z -use crate::storage::database::{Database, Tree};
2025-11-10T00:08:56.7553489Z -#[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.7553560Z  use std::sync::Arc;
2025-11-10T00:08:56.7553621Z  
2025-11-10T00:08:56.7553705Z  /// UTXO Commitment storage manager
2025-11-10T00:08:56.7553996Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/commitment_store.rs:48:
2025-11-10T00:08:56.7554136Z          let commitment_data = bincode::serialize(commitment)?;
2025-11-10T00:08:56.7554196Z  
2025-11-10T00:08:56.7554395Z          // Store by block hash
2025-11-10T00:08:56.7554578Z -        self.commitments.insert(block_hash.as_slice(), commitment_data)?;
2025-11-10T00:08:56.7554656Z +        self.commitments
2025-11-10T00:08:56.7554779Z +            .insert(block_hash.as_slice(), commitment_data)?;
2025-11-10T00:08:56.7554847Z  
2025-11-10T00:08:56.7554942Z          // Store height index for quick lookup
2025-11-10T00:08:56.7555040Z          let height_bytes = height.to_be_bytes();
2025-11-10T00:08:56.7555330Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/commitment_store.rs:55:
2025-11-10T00:08:56.7555492Z -        self.height_index.insert(height_bytes, block_hash.as_slice())?;
2025-11-10T00:08:56.7555566Z +        self.height_index
2025-11-10T00:08:56.7555682Z +            .insert(height_bytes, block_hash.as_slice())?;
2025-11-10T00:08:56.7555741Z  
2025-11-10T00:08:56.7555806Z          Ok(())
2025-11-10T00:08:56.7555870Z      }
2025-11-10T00:08:56.7556168Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/commitment_store.rs:128:
2025-11-10T00:08:56.7556453Z          Err(anyhow::anyhow!("UTXO commitments feature not enabled"))
2025-11-10T00:08:56.7556519Z      }
2025-11-10T00:08:56.7556578Z  }
2025-11-10T00:08:56.7556637Z -
2025-11-10T00:08:56.7556698Z  
2025-11-10T00:08:56.7556965Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:7:
2025-11-10T00:08:56.7557044Z  use std::path::Path;
2025-11-10T00:08:56.7557102Z  
2025-11-10T00:08:56.7557191Z  /// Database abstraction trait
2025-11-10T00:08:56.7557251Z -/// 
2025-11-10T00:08:56.7557311Z +///
2025-11-10T00:08:56.7557483Z  /// Provides a unified interface for key-value storage operations
2025-11-10T00:08:56.7557633Z  /// that can be implemented by different backends (sled, redb).
2025-11-10T00:08:56.7557722Z  pub trait Database: Send + Sync {
2025-11-10T00:08:56.7557987Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:14:
2025-11-10T00:08:56.7558194Z      /// Open a named tree/table
2025-11-10T00:08:56.7558331Z      fn open_tree(&self, name: &str) -> Result<Box<dyn Tree>>;
2025-11-10T00:08:56.7558393Z -    
2025-11-10T00:08:56.7558460Z +
2025-11-10T00:08:56.7558541Z      /// Flush all pending writes
2025-11-10T00:08:56.7558626Z      fn flush(&self) -> Result<()>;
2025-11-10T00:08:56.7558686Z  }
2025-11-10T00:08:56.7558947Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:20:
2025-11-10T00:08:56.7559009Z  
2025-11-10T00:08:56.7559089Z  /// Tree/Table abstraction trait
2025-11-10T00:08:56.7559152Z -/// 
2025-11-10T00:08:56.7559211Z +///
2025-11-10T00:08:56.7559396Z  /// Represents a named collection of key-value pairs within a database.
2025-11-10T00:08:56.7559480Z  pub trait Tree: Send + Sync {
2025-11-10T00:08:56.7559567Z      /// Insert a key-value pair
2025-11-10T00:08:56.7559818Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:26:
2025-11-10T00:08:56.7559948Z      fn insert(&self, key: &[u8], value: &[u8]) -> Result<()>;
2025-11-10T00:08:56.7560015Z -    
2025-11-10T00:08:56.7560074Z +
2025-11-10T00:08:56.7560148Z      /// Get a value by key
2025-11-10T00:08:56.7560265Z      fn get(&self, key: &[u8]) -> Result<Option<Vec<u8>>>;
2025-11-10T00:08:56.7560329Z -    
2025-11-10T00:08:56.7560388Z +
2025-11-10T00:08:56.7560466Z      /// Remove a key-value pair
2025-11-10T00:08:56.7560565Z      fn remove(&self, key: &[u8]) -> Result<()>;
2025-11-10T00:08:56.7560626Z -    
2025-11-10T00:08:56.7560683Z +
2025-11-10T00:08:56.7560758Z      /// Check if a key exists
2025-11-10T00:08:56.7560878Z      fn contains_key(&self, key: &[u8]) -> Result<bool>;
2025-11-10T00:08:56.7560940Z -    
2025-11-10T00:08:56.7560998Z +
2025-11-10T00:08:56.7561073Z      /// Clear all entries
2025-11-10T00:08:56.7561152Z      fn clear(&self) -> Result<()>;
2025-11-10T00:08:56.7561210Z -    
2025-11-10T00:08:56.7561269Z +
2025-11-10T00:08:56.7561353Z      /// Get number of entries
2025-11-10T00:08:56.7561434Z      fn len(&self) -> Result<usize>;
2025-11-10T00:08:56.7561497Z -    
2025-11-10T00:08:56.7561562Z +
2025-11-10T00:08:56.7561641Z      /// Check if tree is empty
2025-11-10T00:08:56.7561729Z      fn is_empty(&self) -> Result<bool> {
2025-11-10T00:08:56.7561804Z          Ok(self.len()? == 0)
2025-11-10T00:08:56.7562061Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:46:
2025-11-10T00:08:56.7562121Z      }
2025-11-10T00:08:56.7562179Z -    
2025-11-10T00:08:56.7562240Z +
2025-11-10T00:08:56.7562329Z      /// Iterate over all key-value pairs
2025-11-10T00:08:56.7562504Z      fn iter(&self) -> Box<dyn Iterator<Item = Result<(Vec<u8>, Vec<u8>)>> + '_>;
2025-11-10T00:08:56.7562563Z  }
2025-11-10T00:08:56.7564709Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:63:
2025-11-10T00:08:56.7564793Z  ) -> Result<Box<dyn Database>> {
2025-11-10T00:08:56.7564864Z      match backend {
2025-11-10T00:08:56.7564947Z          #[cfg(feature = "sled")]
2025-11-10T00:08:56.7565030Z -        DatabaseBackend::Sled => {
2025-11-10T00:08:56.7565326Z -            Ok(Box::new(sled_impl::SledDatabase::new(data_dir)?))
2025-11-10T00:08:56.7565390Z -        }
2025-11-10T00:08:56.7565593Z +        DatabaseBackend::Sled => Ok(Box::new(sled_impl::SledDatabase::new(data_dir)?)),
2025-11-10T00:08:56.7565679Z          #[cfg(not(feature = "sled"))]
2025-11-10T00:08:56.7565760Z -        DatabaseBackend::Sled => {
2025-11-10T00:08:56.7565946Z -            Err(anyhow::anyhow!("Sled backend not available (feature not enabled)"))
2025-11-10T00:08:56.7566007Z -        }
2025-11-10T00:08:56.7566166Z +        DatabaseBackend::Sled => Err(anyhow::anyhow!(
2025-11-10T00:08:56.7566293Z +            "Sled backend not available (feature not enabled)"
2025-11-10T00:08:56.7566354Z +        )),
2025-11-10T00:08:56.7566429Z          #[cfg(feature = "redb")]
2025-11-10T00:08:56.7566509Z -        DatabaseBackend::Redb => {
2025-11-10T00:08:56.7566755Z -            Ok(Box::new(redb_impl::RedbDatabase::new(data_dir)?))
2025-11-10T00:08:56.7566823Z -        }
2025-11-10T00:08:56.7567014Z +        DatabaseBackend::Redb => Ok(Box::new(redb_impl::RedbDatabase::new(data_dir)?)),
2025-11-10T00:08:56.7567100Z          #[cfg(not(feature = "redb"))]
2025-11-10T00:08:56.7567181Z -        DatabaseBackend::Redb => {
2025-11-10T00:08:56.7567352Z -            Err(anyhow::anyhow!("Redb backend not available (feature not enabled)"))
2025-11-10T00:08:56.7567416Z -        }
2025-11-10T00:08:56.7567522Z +        DatabaseBackend::Redb => Err(anyhow::anyhow!(
2025-11-10T00:08:56.7567635Z +            "Redb backend not available (feature not enabled)"
2025-11-10T00:08:56.7567696Z +        )),
2025-11-10T00:08:56.7567761Z      }
2025-11-10T00:08:56.7567820Z  }
2025-11-10T00:08:56.7567882Z  
2025-11-10T00:08:56.7568143Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:84:
2025-11-10T00:08:56.7568226Z  /// Get default database backend
2025-11-10T00:08:56.7568285Z -/// 
2025-11-10T00:08:56.7568344Z +///
2025-11-10T00:08:56.7568526Z  /// Returns the preferred backend (redb if available, otherwise sled).
2025-11-10T00:08:56.7568731Z  /// This function will not panic - it returns a backend if at least one is available.
2025-11-10T00:08:56.7568842Z  pub fn default_backend() -> DatabaseBackend {
2025-11-10T00:08:56.7569113Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:104:
2025-11-10T00:08:56.7569173Z  }
2025-11-10T00:08:56.7569231Z  
2025-11-10T00:08:56.7569313Z  /// Get fallback database backend
2025-11-10T00:08:56.7569379Z -/// 
2025-11-10T00:08:56.7569437Z +///
2025-11-10T00:08:56.7569564Z  /// Returns an alternative backend if the primary fails.
2025-11-10T00:08:56.7569665Z  /// Returns None if no fallback is available.
2025-11-10T00:08:56.7569874Z  pub fn fallback_backend(primary: DatabaseBackend) -> Option<DatabaseBackend> {
2025-11-10T00:08:56.7570142Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:148:
2025-11-10T00:08:56.7570225Z      impl SledDatabase {
2025-11-10T00:08:56.7570363Z          pub fn new<P: AsRef<Path>>(data_dir: P) -> Result<Self> {
2025-11-10T00:08:56.7570452Z              let db = sled::open(data_dir)?;
2025-11-10T00:08:56.7570521Z -            Ok(Self {
2025-11-10T00:08:56.7570603Z -                db: Arc::new(db),
2025-11-10T00:08:56.7570666Z -            })
2025-11-10T00:08:56.7570754Z +            Ok(Self { db: Arc::new(db) })
2025-11-10T00:08:56.7570822Z          }
2025-11-10T00:08:56.7570881Z      }
2025-11-10T00:08:56.7570939Z  
2025-11-10T00:08:56.7571198Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:224:
2025-11-10T00:08:56.7571435Z      static HEADERS_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("headers");
2025-11-10T00:08:56.7571689Z      static HEIGHT_INDEX_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("height_index");
2025-11-10T00:08:56.7571927Z      static WITNESSES_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("witnesses");
2025-11-10T00:08:56.7572291Z -    static RECENT_HEADERS_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("recent_headers");
2025-11-10T00:08:56.7572440Z +    static RECENT_HEADERS_TABLE: TableDefinition<&[u8], &[u8]> =
2025-11-10T00:08:56.7572538Z +        TableDefinition::new("recent_headers");
2025-11-10T00:08:56.7572956Z      static UTXOS_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("utxos");
2025-11-10T00:08:56.7573215Z -    static SPENT_OUTPUTS_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("spent_outputs");
2025-11-10T00:08:56.7573688Z +    static SPENT_OUTPUTS_TABLE: TableDefinition<&[u8], &[u8]> =
2025-11-10T00:08:56.7573809Z +        TableDefinition::new("spent_outputs");
2025-11-10T00:08:56.7574052Z      static CHAIN_INFO_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("chain_info");
2025-11-10T00:08:56.7574574Z      static WORK_CACHE_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("work_cache");
2025-11-10T00:08:56.7574837Z      static TX_BY_HASH_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("tx_by_hash");
2025-11-10T00:08:56.7575107Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:233:
2025-11-10T00:08:56.7575341Z      static TX_BY_BLOCK_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("tx_by_block");
2025-11-10T00:08:56.7575576Z      static TX_METADATA_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("tx_metadata");
2025-11-10T00:08:56.7575836Z -    static INVALID_BLOCKS_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("invalid_blocks");
2025-11-10T00:08:56.7575988Z +    static INVALID_BLOCKS_TABLE: TableDefinition<&[u8], &[u8]> =
2025-11-10T00:08:56.7576092Z +        TableDefinition::new("invalid_blocks");
2025-11-10T00:08:56.7576319Z      static CHAIN_TIPS_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("chain_tips");
2025-11-10T00:08:56.7576383Z  
2025-11-10T00:08:56.7576469Z      pub struct RedbDatabase {
2025-11-10T00:08:56.7576736Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:243:
2025-11-10T00:08:56.7576873Z          pub fn new<P: AsRef<Path>>(data_dir: P) -> Result<Self> {
2025-11-10T00:08:56.7576992Z              let db_path = data_dir.as_ref().join("redb.db");
2025-11-10T00:08:56.7577089Z              let db = RedbDb::create(&db_path)?;
2025-11-10T00:08:56.7577152Z -            
2025-11-10T00:08:56.7577210Z +
2025-11-10T00:08:56.7577330Z              // Initialize all tables in a write transaction
2025-11-10T00:08:56.7577420Z              let write_txn = db.begin_write()?;
2025-11-10T00:08:56.7577482Z              {
2025-11-10T00:08:56.7577742Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:264:
2025-11-10T00:08:56.7577860Z                  let _ = write_txn.open_table(CHAIN_TIPS_TABLE)?;
2025-11-10T00:08:56.7577924Z              }
2025-11-10T00:08:56.7578007Z              write_txn.commit()?;
2025-11-10T00:08:56.7578076Z -            
2025-11-10T00:08:56.7578142Z -            Ok(Self {
2025-11-10T00:08:56.7578218Z -                db: Arc::new(db),
2025-11-10T00:08:56.7578279Z -            })
2025-11-10T00:08:56.7578344Z +
2025-11-10T00:08:56.7578429Z +            Ok(Self { db: Arc::new(db) })
2025-11-10T00:08:56.7578490Z          }
2025-11-10T00:08:56.7578554Z -        
2025-11-10T00:08:56.7578778Z -        fn get_table_def(&self, name: &str) -> Option<TableDefinition<&'static [u8], &'static [u8]>> {
2025-11-10T00:08:56.7578836Z +
2025-11-10T00:08:56.7578910Z +        fn get_table_def(
2025-11-10T00:08:56.7578978Z +            &self,
2025-11-10T00:08:56.7579047Z +            name: &str,
2025-11-10T00:08:56.7579187Z +        ) -> Option<TableDefinition<&'static [u8], &'static [u8]>> {
2025-11-10T00:08:56.7579264Z              match name {
2025-11-10T00:08:56.7579352Z                  "blocks" => Some(BLOCKS_TABLE),
2025-11-10T00:08:56.7579445Z                  "headers" => Some(HEADERS_TABLE),
2025-11-10T00:08:56.7579827Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:293:
2025-11-10T00:08:56.7579891Z  
2025-11-10T00:08:56.7579980Z      impl Database for RedbDatabase {
2025-11-10T00:08:56.7580111Z          fn open_tree(&self, name: &str) -> Result<Box<dyn Tree>> {
2025-11-10T00:08:56.7580218Z -            let table_def = self.get_table_def(name)
2025-11-10T00:08:56.7580471Z -                .ok_or_else(|| anyhow::anyhow!("Unknown table name: {}. Redb requires pre-defined tables.", name))?;
2025-11-10T00:08:56.7580532Z -            
2025-11-10T00:08:56.7580665Z +            let table_def = self.get_table_def(name).ok_or_else(|| {
2025-11-10T00:08:56.7580739Z +                anyhow::anyhow!(
2025-11-10T00:08:56.7580891Z +                    "Unknown table name: {}. Redb requires pre-defined tables.",
2025-11-10T00:08:56.7580965Z +                    name
2025-11-10T00:08:56.7581129Z +                )
2025-11-10T00:08:56.7581268Z +            })?;
2025-11-10T00:08:56.7581336Z +
2025-11-10T00:08:56.7581426Z              Ok(Box::new(RedbTree {
2025-11-10T00:08:56.7581516Z                  db: Arc::clone(&self.db),
2025-11-10T00:08:56.7581589Z                  table_def,
2025-11-10T00:08:56.7581868Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:374:
2025-11-10T00:08:56.7581981Z              let read_txn = match self.db.begin_read() {
2025-11-10T00:08:56.7582058Z                  Ok(txn) => txn,
2025-11-10T00:08:56.7582131Z                  Err(e) => {
2025-11-10T00:08:56.7582384Z -                    return Box::new(std::iter::once(Err(anyhow::anyhow!("Failed to begin read transaction: {}", e))));
2025-11-10T00:08:56.7582514Z +                    return Box::new(std::iter::once(Err(anyhow::anyhow!(
2025-11-10T00:08:56.7582620Z +                        "Failed to begin read transaction: {}",
2025-11-10T00:08:56.7582696Z +                        e
2025-11-10T00:08:56.7582765Z +                    ))));
2025-11-10T00:08:56.7582828Z                  }
2025-11-10T00:08:56.7582893Z              };
2025-11-10T00:08:56.7582960Z -            
2025-11-10T00:08:56.7583020Z +
2025-11-10T00:08:56.7583156Z              let table = match read_txn.open_table(self.table_def) {
2025-11-10T00:08:56.7583237Z                  Ok(tbl) => tbl,
2025-11-10T00:08:56.7583307Z                  Err(e) => {
2025-11-10T00:08:56.7583579Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:384:
2025-11-10T00:08:56.7583857Z -                    return Box::new(std::iter::once(Err(anyhow::anyhow!("Failed to open table: {}", e))));
2025-11-10T00:08:56.7583982Z +                    return Box::new(std::iter::once(Err(anyhow::anyhow!(
2025-11-10T00:08:56.7584079Z +                        "Failed to open table: {}",
2025-11-10T00:08:56.7584148Z +                        e
2025-11-10T00:08:56.7584219Z +                    ))));
2025-11-10T00:08:56.7584472Z                  }
2025-11-10T00:08:56.7584540Z              };
2025-11-10T00:08:56.7584608Z -            
2025-11-10T00:08:56.7584669Z +
2025-11-10T00:08:56.7584794Z              let items: Vec<Result<(Vec<u8>, Vec<u8>)>> = table
2025-11-10T00:08:56.7584863Z                  .iter()
2025-11-10T00:08:56.7584942Z                  .map(|item| {
2025-11-10T00:08:56.7585207Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:392:
2025-11-10T00:08:56.7585359Z                          .map_err(|e| anyhow::anyhow!("Redb iteration error: {}", e))
2025-11-10T00:08:56.7585428Z                  })
2025-11-10T00:08:56.7585500Z                  .collect();
2025-11-10T00:08:56.7585561Z -            
2025-11-10T00:08:56.7585619Z +
2025-11-10T00:08:56.7585713Z              Box::new(items.into_iter())
2025-11-10T00:08:56.7585774Z          }
2025-11-10T00:08:56.7585833Z      }
2025-11-10T00:08:56.7586100Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:399:
2025-11-10T00:08:56.7586160Z  }
2025-11-10T00:08:56.7586218Z -
2025-11-10T00:08:56.7586414Z  
2025-11-10T00:08:56.7586669Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:4:
2025-11-10T00:08:56.7586869Z  //! Supports multiple database backends via feature flags (sled, redb).
2025-11-10T00:08:56.7586977Z  
2025-11-10T00:08:56.7587116Z  pub mod blockstore;
2025-11-10T00:08:56.7587244Z +pub mod chainstate;
2025-11-10T00:08:56.7587399Z  #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.7587534Z  pub mod commitment_store;
2025-11-10T00:08:56.7588068Z -pub mod chainstate;
2025-11-10T00:08:56.7588196Z  pub mod database;
2025-11-10T00:08:56.7588319Z  pub mod hashing;
2025-11-10T00:08:56.7588447Z  pub mod pruning;
2025-11-10T00:08:56.7588889Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:13:
2025-11-10T00:08:56.7589010Z  pub mod txindex;
2025-11-10T00:08:56.7589130Z  pub mod utxostore;
2025-11-10T00:08:56.7589241Z  
2025-11-10T00:08:56.7589637Z +use crate::config::PruningConfig;
2025-11-10T00:08:56.7589775Z  use anyhow::Result;
2025-11-10T00:08:56.7590335Z  use database::{create_database, default_backend, fallback_backend, Database, DatabaseBackend};
2025-11-10T00:08:56.7590469Z  use std::path::Path;
2025-11-10T00:08:56.7590904Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:19:
2025-11-10T00:08:56.7591036Z  use std::sync::Arc;
2025-11-10T00:08:56.7591176Z -use tracing::{warn, info};
2025-11-10T00:08:56.7591325Z -use crate::config::PruningConfig;
2025-11-10T00:08:56.7591405Z +use tracing::{info, warn};
2025-11-10T00:08:56.7591468Z  
2025-11-10T00:08:56.7591613Z  /// Storage manager that coordinates all storage operations
2025-11-10T00:08:56.7591692Z  pub struct Storage {
2025-11-10T00:08:56.7591945Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:32:
2025-11-10T00:08:56.7592005Z  
2025-11-10T00:08:56.7592075Z  impl Storage {
2025-11-10T00:08:56.7592209Z      /// Create a new storage instance with default backend
2025-11-10T00:08:56.7592284Z -    /// 
2025-11-10T00:08:56.7592345Z +    ///
2025-11-10T00:08:56.7592530Z      /// Attempts to use the default backend (redb), and gracefully falls back
2025-11-10T00:08:56.7592643Z      /// to sled if redb fails and sled is available.
2025-11-10T00:08:56.7592781Z      pub fn new<P: AsRef<Path>>(data_dir: P) -> Result<Self> {
2025-11-10T00:08:56.7593028Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:39:
2025-11-10T00:08:56.7593121Z          let default = default_backend();
2025-11-10T00:08:56.7593183Z -        
2025-11-10T00:08:56.7593241Z +
2025-11-10T00:08:56.7593326Z          // Try default backend first
2025-11-10T00:08:56.7593463Z          match Self::with_backend(data_dir.as_ref(), default) {
2025-11-10T00:08:56.7593547Z              Ok(storage) => Ok(storage),
2025-11-10T00:08:56.7593789Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:44:
2025-11-10T00:08:56.7593865Z              Err(e) => {
2025-11-10T00:08:56.7593973Z                  // If default backend fails, try fallback
2025-11-10T00:08:56.7594122Z                  if let Some(fallback_backend) = fallback_backend(default) {
2025-11-10T00:08:56.7594525Z -                    warn!("Failed to initialize {:?} backend: {}. Falling back to {:?}.", default, e, fallback_backend);
2025-11-10T00:08:56.7594760Z -                    info!("Attempting to initialize storage with fallback backend: {:?}", fallback_backend);
2025-11-10T00:08:56.7594831Z +                    warn!(
2025-11-10T00:08:56.7594984Z +                        "Failed to initialize {:?} backend: {}. Falling back to {:?}.",
2025-11-10T00:08:56.7595085Z +                        default, e, fallback_backend
2025-11-10T00:08:56.7595151Z +                    );
2025-11-10T00:08:56.7595217Z +                    info!(
2025-11-10T00:08:56.7595386Z +                        "Attempting to initialize storage with fallback backend: {:?}",
2025-11-10T00:08:56.7595466Z +                        fallback_backend
2025-11-10T00:08:56.7595683Z +                    );
2025-11-10T00:08:56.7595809Z                      Self::with_backend(data_dir, fallback_backend)
2025-11-10T00:08:56.7595879Z                  } else {
2025-11-10T00:08:56.7595961Z                      Err(anyhow::anyhow!(
2025-11-10T00:08:56.7596206Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:52:
2025-11-10T00:08:56.7596392Z                          "Failed to initialize {:?} backend: {}. No fallback backend available.",
2025-11-10T00:08:56.7596469Z -                        default, e
2025-11-10T00:08:56.7596542Z +                        default,
2025-11-10T00:08:56.7596618Z +                        e
2025-11-10T00:08:56.7596681Z                      ))
2025-11-10T00:08:56.7596748Z                  }
2025-11-10T00:08:56.7596812Z              }
2025-11-10T00:08:56.7597184Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:145:
2025-11-10T00:08:56.7597279Z      pub fn flush(&self) -> Result<()> {
2025-11-10T00:08:56.7597358Z          self.db.flush()
2025-11-10T00:08:56.7597427Z      }
2025-11-10T00:08:56.7597489Z -    
2025-11-10T00:08:56.7597547Z +
2025-11-10T00:08:56.7597687Z      /// Get approximate disk size used by storage (in bytes)
2025-11-10T00:08:56.7597755Z -    /// 
2025-11-10T00:08:56.7597819Z +    ///
2025-11-10T00:08:56.7597983Z      /// Returns an estimate based on tree sizes. If any operation fails,
2025-11-10T00:08:56.7598093Z      /// returns 0 gracefully rather than erroring.
2025-11-10T00:08:56.7598206Z      /// Includes bounds checking to prevent overflow.
2025-11-10T00:08:56.7598452Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:154:
2025-11-10T00:08:56.7598557Z      pub fn disk_size(&self) -> Result<u64> {
2025-11-10T00:08:56.7598724Z          // Estimate based on tree sizes (graceful degradation if counts fail)
2025-11-10T00:08:56.7598806Z          let mut size = 0u64;
2025-11-10T00:08:56.7598867Z -        
2025-11-10T00:08:56.7598937Z +
2025-11-10T00:08:56.7599112Z          // Block size estimate (gracefully handle errors, with bounds checking)
2025-11-10T00:08:56.7599233Z          if let Ok(count) = self.blockstore.block_count() {
2025-11-10T00:08:56.7599395Z              const MAX_BLOCKS: u64 = 10_000_000; // 10M blocks max (safety limit)
2025-11-10T00:08:56.7599635Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:162:
2025-11-10T00:08:56.7599771Z              const BYTES_PER_BLOCK: u64 = 1_024_000; // ~1MB per block
2025-11-10T00:08:56.7599957Z              size = size.saturating_add(safe_count.saturating_mul(BYTES_PER_BLOCK));
2025-11-10T00:08:56.7600019Z          }
2025-11-10T00:08:56.7600078Z -        
2025-11-10T00:08:56.7600137Z +
2025-11-10T00:08:56.7600318Z          // UTXO size estimate (gracefully handle errors, with bounds checking)
2025-11-10T00:08:56.7600433Z          if let Ok(count) = self.utxostore.utxo_count() {
2025-11-10T00:08:56.7600583Z              const MAX_UTXOS: u64 = 1_000_000_000; // 1B UTXOs max (safety limit)
2025-11-10T00:08:56.7600830Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:170:
2025-11-10T00:08:56.7600959Z              const BYTES_PER_UTXO: u64 = 100; // ~100 bytes per UTXO
2025-11-10T00:08:56.7601136Z              size = size.saturating_add(safe_count.saturating_mul(BYTES_PER_UTXO));
2025-11-10T00:08:56.7601200Z          }
2025-11-10T00:08:56.7601260Z -        
2025-11-10T00:08:56.7601318Z +
2025-11-10T00:08:56.7601513Z          // Transaction size estimate (gracefully handle errors, with bounds checking)
2025-11-10T00:08:56.7601642Z          if let Ok(count) = self.txindex.transaction_count() {
2025-11-10T00:08:56.7601794Z              const MAX_TXS: u64 = 1_000_000_000; // 1B transactions max (safety limit)
2025-11-10T00:08:56.7602042Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:178:
2025-11-10T00:08:56.7602185Z              const BYTES_PER_TX: u64 = 500; // ~500 bytes per transaction
2025-11-10T00:08:56.7602457Z              size = size.saturating_add(safe_count.saturating_mul(BYTES_PER_TX));
2025-11-10T00:08:56.7602520Z          }
2025-11-10T00:08:56.7602579Z -        
2025-11-10T00:08:56.7602643Z +
2025-11-10T00:08:56.7602780Z          // Final bounds check: prevent returning unrealistic values
2025-11-10T00:08:56.7602937Z          const MAX_DISK_SIZE: u64 = 10_000_000_000_000; // 10TB max (safety limit)
2025-11-10T00:08:56.7603028Z          Ok(size.min(MAX_DISK_SIZE))
2025-11-10T00:08:56.7603275Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:185:
2025-11-10T00:08:56.7603335Z      }
2025-11-10T00:08:56.7603399Z -    
2025-11-10T00:08:56.7603460Z +
2025-11-10T00:08:56.7603560Z      /// Check storage bounds before operations
2025-11-10T00:08:56.7603836Z      /// Returns true if storage is within safe bounds, false if approaching limits
2025-11-10T00:08:56.7603967Z      pub fn check_storage_bounds(&self) -> Result<bool> {
2025-11-10T00:08:56.7604207Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:190:
2025-11-10T00:08:56.7604437Z          const MAX_BLOCKS: usize = 10_000_000; // 10M blocks
2025-11-10T00:08:56.7604549Z          const MAX_UTXOS: usize = 1_000_000_000; // 1B UTXOs
2025-11-10T00:08:56.7604672Z          const MAX_TXS: usize = 1_000_000_000; // 1B transactions
2025-11-10T00:08:56.7604733Z -        
2025-11-10T00:08:56.7604791Z +
2025-11-10T00:08:56.7604944Z          let block_count = self.blockstore.block_count().unwrap_or(0);
2025-11-10T00:08:56.7605082Z          let utxo_count = self.utxostore.utxo_count().unwrap_or(0);
2025-11-10T00:08:56.7605227Z          let tx_count = self.txindex.transaction_count().unwrap_or(0);
2025-11-10T00:08:56.7605472Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:197:
2025-11-10T00:08:56.7605536Z -        
2025-11-10T00:08:56.7605604Z +
2025-11-10T00:08:56.7605725Z          // Check if we're approaching limits (80% threshold)
2025-11-10T00:08:56.7605843Z          let blocks_ok = block_count < (MAX_BLOCKS * 8 / 10);
2025-11-10T00:08:56.7605958Z          let utxos_ok = utxo_count < (MAX_UTXOS * 8 / 10);
2025-11-10T00:08:56.7606196Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:201:
2025-11-10T00:08:56.7606296Z          let txs_ok = tx_count < (MAX_TXS * 8 / 10);
2025-11-10T00:08:56.7606358Z -        
2025-11-10T00:08:56.7606422Z +
2025-11-10T00:08:56.7606494Z          if !blocks_ok {
2025-11-10T00:08:56.7606724Z -            warn!("Storage bounds: block count ({}) approaching limit ({})", block_count, MAX_BLOCKS);
2025-11-10T00:08:56.7606794Z +            warn!(
2025-11-10T00:08:56.7606939Z +                "Storage bounds: block count ({}) approaching limit ({})",
2025-11-10T00:08:56.7607032Z +                block_count, MAX_BLOCKS
2025-11-10T00:08:56.7607146Z +            );
2025-11-10T00:08:56.7607272Z          }
2025-11-10T00:08:56.7607399Z          if !utxos_ok {
2025-11-10T00:08:56.7607742Z -            warn!("Storage bounds: UTXO count ({}) approaching limit ({})", utxo_count, MAX_UTXOS);
2025-11-10T00:08:56.7607817Z +            warn!(
2025-11-10T00:08:56.7607963Z +                "Storage bounds: UTXO count ({}) approaching limit ({})",
2025-11-10T00:08:56.7608045Z +                utxo_count, MAX_UTXOS
2025-11-10T00:08:56.7608107Z +            );
2025-11-10T00:08:56.7608177Z          }
2025-11-10T00:08:56.7608245Z          if !txs_ok {
2025-11-10T00:08:56.7608489Z -            warn!("Storage bounds: transaction count ({}) approaching limit ({})", tx_count, MAX_TXS);
2025-11-10T00:08:56.7608559Z +            warn!(
2025-11-10T00:08:56.7608725Z +                "Storage bounds: transaction count ({}) approaching limit ({})",
2025-11-10T00:08:56.7608803Z +                tx_count, MAX_TXS
2025-11-10T00:08:56.7608872Z +            );
2025-11-10T00:08:56.7608937Z          }
2025-11-10T00:08:56.7608997Z -        
2025-11-10T00:08:56.7609058Z +
2025-11-10T00:08:56.7609315Z          Ok(blocks_ok && utxos_ok && txs_ok)
2025-11-10T00:08:56.7609377Z      }
2025-11-10T00:08:56.7609437Z -    
2025-11-10T00:08:56.7609497Z +
2025-11-10T00:08:56.7609593Z      /// Get transaction count from txindex
2025-11-10T00:08:56.7609722Z      pub fn transaction_count(&self) -> Result<usize> {
2025-11-10T00:08:56.7609817Z          self.txindex.transaction_count()
2025-11-10T00:08:56.7610152Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:7:
2025-11-10T00:08:56.7610272Z  //! - Custom: Fine-grained control over what to keep
2025-11-10T00:08:56.7610332Z  
2025-11-10T00:08:56.7610466Z  use crate::config::{PruningConfig, PruningMode};
2025-11-10T00:08:56.7610546Z +#[cfg(feature = "bip158")]
2025-11-10T00:08:56.7610692Z +use crate::network::filter_service::BlockFilterService;
2025-11-10T00:08:56.7610794Z  use crate::storage::blockstore::BlockStore;
2025-11-10T00:08:56.7611007Z  #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.7611142Z  use crate::storage::commitment_store::CommitmentStore;
2025-11-10T00:08:56.7611413Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:13:
2025-11-10T00:08:56.7611508Z  #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.7611605Z  use crate::storage::utxostore::UtxoStore;
2025-11-10T00:08:56.7611685Z -#[cfg(feature = "bip158")]
2025-11-10T00:08:56.7611822Z -use crate::network::filter_service::BlockFilterService;
2025-11-10T00:08:56.7611906Z  use anyhow::{anyhow, Result};
2025-11-10T00:08:56.7611991Z  #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.7612074Z  use bllvm_protocol::Hash;
2025-11-10T00:08:56.7612341Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:89:
2025-11-10T00:08:56.7612421Z      pub fn with_features(
2025-11-10T00:08:56.7612504Z          config: PruningConfig,
2025-11-10T00:08:56.7612599Z          blockstore: Arc<BlockStore>,
2025-11-10T00:08:56.7612699Z -        #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.7612823Z -        commitment_store: Option<Arc<CommitmentStore>>,
2025-11-10T00:08:56.7612919Z -        #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.7614795Z -        utxostore: Option<Arc<UtxoStore>>,
2025-11-10T00:08:56.7614881Z -        #[cfg(feature = "bip158")]
2025-11-10T00:08:56.7615005Z -        filter_service: Option<Arc<BlockFilterService>>,
2025-11-10T00:08:56.7615233Z +        #[cfg(feature = "utxo-commitments")] commitment_store: Option<Arc<CommitmentStore>>,
2025-11-10T00:08:56.7615407Z +        #[cfg(feature = "utxo-commitments")] utxostore: Option<Arc<UtxoStore>>,
2025-11-10T00:08:56.7615588Z +        #[cfg(feature = "bip158")] filter_service: Option<Arc<BlockFilterService>>,
2025-11-10T00:08:56.7615661Z      ) -> Self {
2025-11-10T00:08:56.7615724Z          Self {
2025-11-10T00:08:56.7615789Z              config,
2025-11-10T00:08:56.7616071Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:153:
2025-11-10T00:08:56.7616138Z          {
2025-11-10T00:08:56.7616247Z              // Check if UTXO commitments are available
2025-11-10T00:08:56.7616467Z              let has_commitments = self.commitment_store.is_some() && self.utxostore.is_some();
2025-11-10T00:08:56.7616533Z -            
2025-11-10T00:08:56.7616592Z +
2025-11-10T00:08:56.7616708Z              // Check if mode supports incremental pruning
2025-11-10T00:08:56.7616805Z              let mode_supports = matches!(
2025-11-10T00:08:56.7616886Z                  &self.config.mode,
2025-11-10T00:08:56.7617274Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:160:
2025-11-10T00:08:56.7617876Z -                PruningMode::Aggressive { .. } | PruningMode::Custom { keep_commitments: true, .. }
2025-11-10T00:08:56.7618201Z +                PruningMode::Aggressive { .. }
2025-11-10T00:08:56.7618355Z +                    | PruningMode::Custom {
2025-11-10T00:08:56.7618513Z +                        keep_commitments: true,
2025-11-10T00:08:56.7618830Z +                        ..
2025-11-10T00:08:56.7618941Z +                    }
2025-11-10T00:08:56.7619053Z              );
2025-11-10T00:08:56.7619159Z -            
2025-11-10T00:08:56.7619229Z +
2025-11-10T00:08:56.7619330Z              has_commitments && mode_supports
2025-11-10T00:08:56.7619391Z          }
2025-11-10T00:08:56.7619499Z          #[cfg(not(feature = "utxo-commitments"))]
2025-11-10T00:08:56.7619774Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:169:
2025-11-10T00:08:56.7619836Z      }
2025-11-10T00:08:56.7619902Z  
2025-11-10T00:08:56.7619992Z      /// Incremental prune during IBD
2025-11-10T00:08:56.7620053Z -    /// 
2025-11-10T00:08:56.7620113Z +    ///
2025-11-10T00:08:56.7620325Z      /// This method prunes old blocks while keeping a sliding window of recent blocks.
2025-11-10T00:08:56.7620700Z      /// It's designed to be called periodically during IBD to prevent storage from growing
2025-11-10T00:08:56.7620903Z      /// unbounded. Only works when incremental_prune_during_ibd is enabled and UTXO
2025-11-10T00:08:56.7621175Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:203:
2025-11-10T00:08:56.7621235Z  
2025-11-10T00:08:56.7621412Z          // Calculate prune height: keep only the last prune_window_size blocks
2025-11-10T00:08:56.7621637Z          let prune_to_height = current_height.saturating_sub(self.config.prune_window_size);
2025-11-10T00:08:56.7621704Z -        
2025-11-10T00:08:56.7621763Z +
2025-11-10T00:08:56.7621899Z          // Don't prune if window size is larger than current height
2025-11-10T00:08:56.7622049Z          if prune_to_height == 0 || prune_to_height >= current_height {
2025-11-10T00:08:56.7622126Z              return Ok(None);
2025-11-10T00:08:56.7622379Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:245:
2025-11-10T00:08:56.7622508Z              // 1. Incremental pruning is explicitly enabled
2025-11-10T00:08:56.7622663Z              // 2. UTXO commitments are available (for state verification)
2025-11-10T00:08:56.7622797Z              // 3. Aggressive or Custom mode with commitments enabled
2025-11-10T00:08:56.7622983Z -            let can_incremental_prune = self.config.incremental_prune_during_ibd
2025-11-10T00:08:56.7623097Z -                && self.can_incremental_prune_during_ibd();
2025-11-10T00:08:56.7623160Z -            
2025-11-10T00:08:56.7623247Z +            let can_incremental_prune =
2025-11-10T00:08:56.7623487Z +                self.config.incremental_prune_during_ibd && self.can_incremental_prune_during_ibd();
2025-11-10T00:08:56.7623547Z +
2025-11-10T00:08:56.7623634Z              if !can_incremental_prune {
2025-11-10T00:08:56.7623718Z                  return Err(anyhow!(
2025-11-10T00:08:56.7624110Z                      "Cannot prune during initial block download. Wait for IBD to complete, or enable incremental_prune_during_ibd with UTXO commitments."
2025-11-10T00:08:56.7624517Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:254:
2025-11-10T00:08:56.7624588Z                  ));
2025-11-10T00:08:56.7624657Z              }
2025-11-10T00:08:56.7624719Z -            
2025-11-10T00:08:56.7624778Z +
2025-11-10T00:08:56.7624957Z              // For incremental pruning during IBD, ensure we have enough blocks
2025-11-10T00:08:56.7625131Z              if current_height < self.config.min_blocks_for_incremental_prune {
2025-11-10T00:08:56.7625209Z                  return Err(anyhow!(
2025-11-10T00:08:56.7625474Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:295:
2025-11-10T00:08:56.7625562Z              PruningMode::Normal {
2025-11-10T00:08:56.7625636Z                  keep_from_height,
2025-11-10T00:08:56.7625711Z                  min_recent_blocks,
2025-11-10T00:08:56.7625980Z -            } => self.prune_normal(prune_to_height, current_height, *keep_from_height, *min_recent_blocks)?,
2025-11-10T00:08:56.7626186Z +            } => self.prune_normal(
2025-11-10T00:08:56.7626263Z +                prune_to_height,
2025-11-10T00:08:56.7626342Z +                current_height,
2025-11-10T00:08:56.7626416Z +                *keep_from_height,
2025-11-10T00:08:56.7626489Z +                *min_recent_blocks,
2025-11-10T00:08:56.7626553Z +            )?,
2025-11-10T00:08:56.7626648Z              PruningMode::Aggressive {
2025-11-10T00:08:56.7626729Z                  keep_from_height,
2025-11-10T00:08:56.7626807Z                  keep_commitments,
2025-11-10T00:08:56.7627093Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:370:
2025-11-10T00:08:56.7627211Z          let mut stats = PruningStats::default();
2025-11-10T00:08:56.7627272Z  
2025-11-10T00:08:56.7627475Z          // Calculate actual keep height (max of keep_from_height and min_recent_blocks)
2025-11-10T00:08:56.7627720Z -        let effective_keep_height = keep_from_height.max(
2025-11-10T00:08:56.7627865Z -            current_height.saturating_sub(min_recent_blocks)
2025-11-10T00:08:56.7627934Z -        );
2025-11-10T00:08:56.7628022Z +        let effective_keep_height =
2025-11-10T00:08:56.7628214Z +            keep_from_height.max(current_height.saturating_sub(min_recent_blocks));
2025-11-10T00:08:56.7628274Z  
2025-11-10T00:08:56.7628403Z          // Ensure we don't prune below effective keep height
2025-11-10T00:08:56.7628590Z          let actual_prune_height = prune_to_height.min(effective_keep_height);
2025-11-10T00:08:56.7628853Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:415:
2025-11-10T00:08:56.7628962Z          let mut stats = PruningStats::default();
2025-11-10T00:08:56.7629024Z  
2025-11-10T00:08:56.7629128Z          // Calculate effective keep height
2025-11-10T00:08:56.7629254Z -        let effective_keep_height = keep_from_height.max(
2025-11-10T00:08:56.7629371Z -            current_height.saturating_sub(min_blocks)
2025-11-10T00:08:56.7629440Z -        );
2025-11-10T00:08:56.7629693Z +        let effective_keep_height = keep_from_height.max(current_height.saturating_sub(min_blocks));
2025-11-10T00:08:56.7629754Z  
2025-11-10T00:08:56.7638285Z          let actual_prune_height = prune_to_height.min(effective_keep_height);
2025-11-10T00:08:56.7638422Z  
2025-11-10T00:08:56.7638899Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:428:
2025-11-10T00:08:56.7638998Z  
2025-11-10T00:08:56.7639225Z          // Generate UTXO commitments before pruning if enabled
2025-11-10T00:08:56.7639384Z          if keep_commitments {
2025-11-10T00:08:56.7639635Z -            if let (Some(ref commitment_store), Some(ref utxostore)) = 
2025-11-10T00:08:56.7639912Z -                (self.commitment_store.as_ref(), self.utxostore.as_ref()) 
2025-11-10T00:08:56.7640143Z +            if let (Some(ref commitment_store), Some(ref utxostore)) =
2025-11-10T00:08:56.7640387Z +                (self.commitment_store.as_ref(), self.utxostore.as_ref())
2025-11-10T00:08:56.7640508Z              {
2025-11-10T00:08:56.7640775Z                  info!("Generating UTXO commitments for blocks to be pruned...");
2025-11-10T00:08:56.7640964Z                  self.generate_commitments_before_prune(
2025-11-10T00:08:56.7643058Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:439:
2025-11-10T00:08:56.7643180Z                      utxostore,
2025-11-10T00:08:56.7643295Z                  )?;
2025-11-10T00:08:56.7643404Z              } else {
2025-11-10T00:08:56.7643780Z -                warn!("UTXO commitments requested but commitment store or UTXO store not available");
2025-11-10T00:08:56.7643907Z +                warn!(
2025-11-10T00:08:56.7644272Z +                    "UTXO commitments requested but commitment store or UTXO store not available"
2025-11-10T00:08:56.7644591Z +                );
2025-11-10T00:08:56.7644705Z              }
2025-11-10T00:08:56.7644839Z          }
2025-11-10T00:08:56.7644947Z  
2025-11-10T00:08:56.7645675Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:464:
2025-11-10T00:08:56.7645907Z                      // Remove filter from cache but keep filter header
2025-11-10T00:08:56.7646085Z                      if filter_service.has_filter(&hash) {
2025-11-10T00:08:56.7646345Z                          filter_service.remove_filter_for_pruned_block(&hash)?;
2025-11-10T00:08:56.7646750Z -                        debug!("Removed BIP158 filter for pruned block at height {} (header kept)", height);
2025-11-10T00:08:56.7646884Z +                        debug!(
2025-11-10T00:08:56.7647210Z +                            "Removed BIP158 filter for pruned block at height {} (header kept)",
2025-11-10T00:08:56.7647342Z +                            height
2025-11-10T00:08:56.7647474Z +                        );
2025-11-10T00:08:56.7647588Z                      }
2025-11-10T00:08:56.7647939Z                  }
2025-11-10T00:08:56.7648083Z              }
2025-11-10T00:08:56.7648582Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:524:
2025-11-10T00:08:56.7648739Z                  if keep_commitments {
2025-11-10T00:08:56.7648921Z                      #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.7649047Z                      {
2025-11-10T00:08:56.7649305Z -                        if let (Some(ref commitment_store), Some(ref utxostore)) = 
2025-11-10T00:08:56.7649576Z -                            (self.commitment_store.as_ref(), self.utxostore.as_ref()) 
2025-11-10T00:08:56.7649814Z +                        if let (Some(ref commitment_store), Some(ref utxostore)) =
2025-11-10T00:08:56.7650063Z +                            (self.commitment_store.as_ref(), self.utxostore.as_ref())
2025-11-10T00:08:56.7650184Z                          {
2025-11-10T00:08:56.7650374Z                              // Generate commitment if not exists
2025-11-10T00:08:56.7650589Z                              if !commitment_store.has_commitment(&hash)? {
2025-11-10T00:08:56.7651069Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:547:
2025-11-10T00:08:56.7651323Z                          // Filter headers are always kept for chain verification
2025-11-10T00:08:56.7651497Z                          if filter_service.has_filter(&hash) {
2025-11-10T00:08:56.7651740Z                              filter_service.remove_filter_for_pruned_block(&hash)?;
2025-11-10T00:08:56.7652118Z -                            debug!("Removed BIP158 filter for pruned block at height {} (header kept)", height);
2025-11-10T00:08:56.7652254Z +                            debug!(
2025-11-10T00:08:56.7652554Z +                                "Removed BIP158 filter for pruned block at height {} (header kept)",
2025-11-10T00:08:56.7652682Z +                                height
2025-11-10T00:08:56.7654891Z +                            );
2025-11-10T00:08:56.7655022Z                          }
2025-11-10T00:08:56.7655137Z                      }
2025-11-10T00:08:56.7655264Z                  }
2025-11-10T00:08:56.7655742Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:569:
2025-11-10T00:08:56.7655905Z          commitment_store: &CommitmentStore,
2025-11-10T00:08:56.7656034Z          utxostore: &UtxoStore,
2025-11-10T00:08:56.7656160Z      ) -> Result<()> {
2025-11-10T00:08:56.7656484Z -        info!("Generating UTXO commitments for heights 0..{}", prune_to_height);
2025-11-10T00:08:56.7656590Z +        info!(
2025-11-10T00:08:56.7656811Z +            "Generating UTXO commitments for heights 0..{}",
2025-11-10T00:08:56.7656937Z +            prune_to_height
2025-11-10T00:08:56.7657041Z +        );
2025-11-10T00:08:56.7657148Z  
2025-11-10T00:08:56.7657371Z          // For each block to be pruned, generate a commitment
2025-11-10T00:08:56.7657686Z          // We'll generate commitments at checkpoint intervals to save computation
2025-11-10T00:08:56.7658158Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:601:
2025-11-10T00:08:56.7658617Z          commitment_store: &CommitmentStore,
2025-11-10T00:08:56.7658755Z          utxostore: &UtxoStore,
2025-11-10T00:08:56.7658879Z      ) -> Result<()> {
2025-11-10T00:08:56.7659052Z -        #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.7659364Z -        use bllvm_protocol::utxo_commitments::merkle_tree::UtxoMerkleTree;
2025-11-10T00:08:56.7659543Z          use bllvm_protocol::block::connect_block;
2025-11-10T00:08:56.7659697Z          use bllvm_protocol::segwit::Witness;
2025-11-10T00:08:56.7659856Z +        #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.7660143Z +        use bllvm_protocol::utxo_commitments::merkle_tree::UtxoMerkleTree;
2025-11-10T00:08:56.7660247Z  
2025-11-10T00:08:56.7660544Z          // Reconstruct UTXO set at historical height by replaying blocks
2025-11-10T00:08:56.7661056Z          let utxo_set = self.reconstruct_utxo_set_at_height(height, utxostore)?;
2025-11-10T00:08:56.7661553Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:614:
2025-11-10T00:08:56.7661902Z              .map_err(|e| anyhow::anyhow!("Failed to create UTXO Merkle tree: {:?}", e))?;
2025-11-10T00:08:56.7662010Z  
2025-11-10T00:08:56.7662168Z          for (outpoint, utxo) in &utxo_set {
2025-11-10T00:08:56.7662360Z -            utxo_tree.insert(*outpoint, utxo.clone())
2025-11-10T00:08:56.7662482Z +            utxo_tree
2025-11-10T00:08:56.7663105Z +                .insert(*outpoint, utxo.clone())
2025-11-10T00:08:56.7663399Z                  .map_err(|e| anyhow::anyhow!("Failed to insert UTXO: {:?}", e))?;
2025-11-10T00:08:56.7663519Z          }
2025-11-10T00:08:56.7663622Z  
2025-11-10T00:08:56.7664076Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:624:
2025-11-10T00:08:56.7664219Z          // Store commitment
2025-11-10T00:08:56.7664772Z          commitment_store.store_commitment(block_hash, height, &commitment)?;
2025-11-10T00:08:56.7664887Z  
2025-11-10T00:08:56.7665188Z -        debug!("Generated and stored commitment for height {} (hash: {})", 
2025-11-10T00:08:56.7665367Z -               height, hex::encode(block_hash));
2025-11-10T00:08:56.7665476Z +        debug!(
2025-11-10T00:08:56.7665735Z +            "Generated and stored commitment for height {} (hash: {})",
2025-11-10T00:08:56.7665853Z +            height,
2025-11-10T00:08:56.7665995Z +            hex::encode(block_hash)
2025-11-10T00:08:56.7666100Z +        );
2025-11-10T00:08:56.7666205Z  
2025-11-10T00:08:56.7666320Z          Ok(())
2025-11-10T00:08:56.7666424Z      }
2025-11-10T00:08:56.7666868Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:632:
2025-11-10T00:08:56.7666983Z  
2025-11-10T00:08:56.7667211Z      /// Generate UTXO commitment from current UTXO set state
2025-11-10T00:08:56.7667315Z -    /// 
2025-11-10T00:08:56.7667416Z +    ///
2025-11-10T00:08:56.7667840Z      /// This method generates a commitment from the current UTXO set without replaying blocks.
2025-11-10T00:08:56.7668184Z      /// Used during incremental sync when the UTXO set is maintained incrementally.
2025-11-10T00:08:56.7668286Z -    /// 
2025-11-10T00:08:56.7668388Z +    ///
2025-11-10T00:08:56.7668498Z      /// # Arguments
2025-11-10T00:08:56.7668729Z      /// * `block_hash` - Hash of the block at this height
2025-11-10T00:08:56.7668883Z      /// * `height` - Block height
2025-11-10T00:08:56.7669378Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:641:
2025-11-10T00:08:56.7669535Z      /// * `utxo_set` - Current UTXO set (from incremental updates)
2025-11-10T00:08:56.7669692Z      /// * `commitment_store` - Commitment store to save the commitment
2025-11-10T00:08:56.7669764Z -    /// 
2025-11-10T00:08:56.7669827Z +    ///
2025-11-10T00:08:56.7669896Z      /// # Returns
2025-11-10T00:08:56.7670009Z      /// Result indicating success or failure
2025-11-10T00:08:56.7670104Z      #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.7670610Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:658:
2025-11-10T00:08:56.7670806Z              .map_err(|e| anyhow::anyhow!("Failed to create UTXO Merkle tree: {:?}", e))?;
2025-11-10T00:08:56.7670875Z  
2025-11-10T00:08:56.7670967Z          for (outpoint, utxo) in utxo_set {
2025-11-10T00:08:56.7671081Z -            utxo_tree.insert(*outpoint, utxo.clone())
2025-11-10T00:08:56.7671156Z +            utxo_tree
2025-11-10T00:08:56.7671251Z +                .insert(*outpoint, utxo.clone())
2025-11-10T00:08:56.7671403Z                  .map_err(|e| anyhow::anyhow!("Failed to insert UTXO: {:?}", e))?;
2025-11-10T00:08:56.7671473Z          }
2025-11-10T00:08:56.7671534Z  
2025-11-10T00:08:56.7671795Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:668:
2025-11-10T00:08:56.7671874Z          // Store commitment
2025-11-10T00:08:56.7672182Z          commitment_store.store_commitment(block_hash, height, &commitment)?;
2025-11-10T00:08:56.7672250Z  
2025-11-10T00:08:56.7672442Z -        debug!("Generated commitment from current state for height {} (hash: {})", 
2025-11-10T00:08:56.7672544Z -               height, hex::encode(block_hash));
2025-11-10T00:08:56.7672826Z +        debug!(
2025-11-10T00:08:56.7673002Z +            "Generated commitment from current state for height {} (hash: {})",
2025-11-10T00:08:56.7673069Z +            height,
2025-11-10T00:08:56.7673161Z +            hex::encode(block_hash)
2025-11-10T00:08:56.7673225Z +        );
2025-11-10T00:08:56.7673286Z  
2025-11-10T00:08:56.7673353Z          Ok(())
2025-11-10T00:08:56.7673414Z      }
2025-11-10T00:08:56.7673669Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:676:
2025-11-10T00:08:56.7673731Z  
2025-11-10T00:08:56.7673881Z      /// Reconstruct UTXO set at a specific historical height
2025-11-10T00:08:56.7673950Z -    /// 
2025-11-10T00:08:56.7674013Z +    ///
2025-11-10T00:08:56.7674180Z      /// This function replays blocks from genesis to the target height
2025-11-10T00:08:56.7674530Z      /// to reconstruct the exact UTXO set at that point in history.
2025-11-10T00:08:56.7674626Z      #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.7674908Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:703:
2025-11-10T00:08:56.7674983Z                  // Get block
2025-11-10T00:08:56.7675135Z                  if let Some(block) = self.blockstore.get_block(&block_hash)? {
2025-11-10T00:08:56.7675231Z                      // Get witnesses for this block
2025-11-10T00:08:56.7677142Z -                    let witnesses = self.blockstore.get_witness(&block_hash)?
2025-11-10T00:08:56.7677277Z -                        .unwrap_or_else(|| {
2025-11-10T00:08:56.7677485Z -                            // If no witnesses stored, create empty witnesses
2025-11-10T00:08:56.7677765Z -                            block.transactions.iter().map(|_| Vec::new()).collect()
2025-11-10T00:08:56.7677889Z -                        });
2025-11-10T00:08:56.7678017Z +                    let witnesses =
2025-11-10T00:08:56.7678161Z +                        self.blockstore
2025-11-10T00:08:56.7678318Z +                            .get_witness(&block_hash)?
2025-11-10T00:08:56.7678468Z +                            .unwrap_or_else(|| {
2025-11-10T00:08:56.7678622Z +                                // If no witnesses stored, create empty witnesses
2025-11-10T00:08:56.7678788Z +                                block.transactions.iter().map(|_| Vec::new()).collect()
2025-11-10T00:08:56.7678863Z +                            });
2025-11-10T00:08:56.7678927Z  
2025-11-10T00:08:56.7679047Z                      // Apply block to UTXO set using connect_block
2025-11-10T00:08:56.7679257Z                      // This properly handles coinbase transactions and input/output processing
2025-11-10T00:08:56.7679532Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:714:
2025-11-10T00:08:56.7679845Z                      let (validation_result, new_utxo_set) = connect_block(
2025-11-10T00:08:56.7679917Z -                        &block,
2025-11-10T00:08:56.7679992Z -                        &witnesses,
2025-11-10T00:08:56.7680068Z -                        utxo_set,
2025-11-10T00:08:56.7680145Z -                        height,
2025-11-10T00:08:56.7680251Z +                        &block, &witnesses, utxo_set, height,
2025-11-10T00:08:56.7680389Z                          None, // No recent headers needed for historical replay
2025-11-10T00:08:56.7680462Z                      )?;
2025-11-10T00:08:56.7680523Z  
2025-11-10T00:08:56.7680785Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:722:
2025-11-10T00:08:56.7680879Z                      // Check validation result
2025-11-10T00:08:56.7681196Z                      if !matches!(validation_result, bllvm_protocol::ValidationResult::Valid) {
2025-11-10T00:08:56.7681416Z -                        warn!("Block at height {} failed validation during UTXO reconstruction", height);
2025-11-10T00:08:56.7681491Z +                        warn!(
2025-11-10T00:08:56.7681664Z +                            "Block at height {} failed validation during UTXO reconstruction",
2025-11-10T00:08:56.7681737Z +                            height
2025-11-10T00:08:56.7681807Z +                        );
2025-11-10T00:08:56.7681977Z                          // Continue anyway - this might be expected for some edge cases
2025-11-10T00:08:56.7682043Z                      }
2025-11-10T00:08:56.7682103Z  
2025-11-10T00:08:56.7682359Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:740:
2025-11-10T00:08:56.7682430Z              }
2025-11-10T00:08:56.7682493Z          }
2025-11-10T00:08:56.7682553Z  
2025-11-10T00:08:56.7682794Z -        debug!("Reconstructed UTXO set at height {} with {} UTXOs", target_height, utxo_set.len());
2025-11-10T00:08:56.7682858Z +        debug!(
2025-11-10T00:08:56.7682991Z +            "Reconstructed UTXO set at height {} with {} UTXOs",
2025-11-10T00:08:56.7683071Z +            target_height,
2025-11-10T00:08:56.7683142Z +            utxo_set.len()
2025-11-10T00:08:56.7683204Z +        );
2025-11-10T00:08:56.7683272Z          Ok(utxo_set)
2025-11-10T00:08:56.7683341Z      }
2025-11-10T00:08:56.7683402Z  }
2025-11-10T00:08:56.7683653Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:747:
2025-11-10T00:08:56.7683721Z -
2025-11-10T00:08:56.7683781Z  
2025-11-10T00:08:56.7686659Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/txindex.rs:2:
2025-11-10T00:08:56.7686739Z  //!
2025-11-10T00:08:56.7686981Z  //! Provides fast lookup of transactions by hash and maintains transaction metadata.
2025-11-10T00:08:56.7687044Z  
2025-11-10T00:08:56.7687165Z +use crate::storage::database::{Database, Tree};
2025-11-10T00:08:56.7687255Z  use anyhow::Result;
2025-11-10T00:08:56.7687358Z  use bllvm_protocol::{Hash, Transaction};
2025-11-10T00:08:56.7687460Z  use serde::{Deserialize, Serialize};
2025-11-10T00:08:56.7688028Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/txindex.rs:8:
2025-11-10T00:08:56.7688156Z -use crate::storage::database::{Database, Tree};
2025-11-10T00:08:56.7688231Z  use std::sync::Arc;
2025-11-10T00:08:56.7688292Z  
2025-11-10T00:08:56.7688378Z  /// Transaction metadata
2025-11-10T00:08:56.7688636Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/txindex.rs:68:
2025-11-10T00:08:56.7688699Z          };
2025-11-10T00:08:56.7688761Z  
2025-11-10T00:08:56.7688899Z          let metadata_data = bincode::serialize(&metadata)?;
2025-11-10T00:08:56.7689059Z -        self.tx_metadata.insert(tx_hash.as_slice(), &metadata_data)?;
2025-11-10T00:08:56.7689134Z +        self.tx_metadata
2025-11-10T00:08:56.7689255Z +            .insert(tx_hash.as_slice(), &metadata_data)?;
2025-11-10T00:08:56.7689317Z  
2025-11-10T00:08:56.7689394Z          // Index by block
2025-11-10T00:08:56.7689702Z          let block_key = self.block_tx_key(block_hash, tx_index);
2025-11-10T00:08:56.7689877Z error[internal]: left behind trailing whitespace
2025-11-10T00:08:56.7690129Z   --> /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:91:91:1
2025-11-10T00:08:56.7690190Z    |
2025-11-10T00:08:56.7690256Z 91 |                 
2025-11-10T00:08:56.7690320Z    | ^^^^^^^^^^^^^^^^
2025-11-10T00:08:56.7690387Z    |
2025-11-10T00:08:56.7690392Z 
2025-11-10T00:08:56.7690550Z warning: rustfmt has failed to format. See previous 1 errors.
2025-11-10T00:08:56.7690555Z 
2025-11-10T00:08:56.7690816Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/utxostore.rs:2:
2025-11-10T00:08:56.7690882Z  //!
2025-11-10T00:08:56.7691059Z  //! Stores and manages the UTXO set for efficient transaction validation.
2025-11-10T00:08:56.7691120Z  
2025-11-10T00:08:56.7691352Z +use crate::storage::database::{Database, Tree};
2025-11-10T00:08:56.7691435Z  use anyhow::Result;
2025-11-10T00:08:56.7691549Z  use bllvm_protocol::{OutPoint, UtxoSet, UTXO};
2025-11-10T00:08:56.7691655Z -use crate::storage::database::{Database, Tree};
2025-11-10T00:08:56.7691751Z  use std::collections::HashMap;
2025-11-10T00:08:56.7691825Z  use std::sync::Arc;
2025-11-10T00:08:56.7691886Z  
2025-11-10T00:08:56.7692146Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/validation/mod.rs:51:
2025-11-10T00:08:56.7692245Z          context: &BlockValidationContext,
2025-11-10T00:08:56.7692347Z      ) -> Result<(ValidationResult, UtxoSet)> {
2025-11-10T00:08:56.7692466Z          // Create empty witnesses for each transaction
2025-11-10T00:08:56.7692732Z -        let witnesses: Vec<Witness> = context.block.transactions.iter().map(|_| Vec::new()).collect();
2025-11-10T00:08:56.7692830Z +        let witnesses: Vec<Witness> = context
2025-11-10T00:08:56.7692902Z +            .block
2025-11-10T00:08:56.7692981Z +            .transactions
2025-11-10T00:08:56.7693050Z +            .iter()
2025-11-10T00:08:56.7693132Z +            .map(|_| Vec::new())
2025-11-10T00:08:56.7693209Z +            .collect();
2025-11-10T00:08:56.7693281Z          connect_block(
2025-11-10T00:08:56.7693357Z              &context.block,
2025-11-10T00:08:56.7693426Z              &witnesses,
2025-11-10T00:08:56.7695587Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/validation/mod.rs:87:
2025-11-10T00:08:56.7695662Z              .par_iter()
2025-11-10T00:08:56.7695740Z              .map(|context| {
2025-11-10T00:08:56.7695866Z                  // Create empty witnesses for each transaction
2025-11-10T00:08:56.7696130Z -                let witnesses: Vec<Witness> = context.block.transactions.iter().map(|_| Vec::new()).collect();
2025-11-10T00:08:56.7696231Z +                let witnesses: Vec<Witness> = context
2025-11-10T00:08:56.7696304Z +                    .block
2025-11-10T00:08:56.7696384Z +                    .transactions
2025-11-10T00:08:56.7696451Z +                    .iter()
2025-11-10T00:08:56.7696539Z +                    .map(|_| Vec::new())
2025-11-10T00:08:56.7696619Z +                    .collect();
2025-11-10T00:08:56.7696693Z                  connect_block(
2025-11-10T00:08:56.7696771Z                      &context.block,
2025-11-10T00:08:56.7696847Z                      &witnesses,
2025-11-10T00:08:56.7697110Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/validation/mod.rs:116:
2025-11-10T00:08:56.7697171Z  
2025-11-10T00:08:56.7697251Z          for context in contexts {
2025-11-10T00:08:56.7697369Z              // Create empty witnesses for each transaction
2025-11-10T00:08:56.7697632Z -            let witnesses: Vec<Witness> = context.block.transactions.iter().map(|_| Vec::new()).collect();
2025-11-10T00:08:56.7697734Z +            let witnesses: Vec<Witness> = context
2025-11-10T00:08:56.7697855Z +                .block
2025-11-10T00:08:56.7697992Z +                .transactions
2025-11-10T00:08:56.7698110Z +                .iter()
2025-11-10T00:08:56.7698642Z +                .map(|_| Vec::new())
2025-11-10T00:08:56.7698777Z +                .collect();
2025-11-10T00:08:56.7698924Z              let result = connect_block(
2025-11-10T00:08:56.7699050Z                  &context.block,
2025-11-10T00:08:56.7699173Z                  &witnesses,
2025-11-10T00:08:56.7699625Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:9:
2025-11-10T00:08:56.7699721Z  async fn test_request_id_matching() {
2025-11-10T00:08:56.7699861Z      // Test that requests are matched by request_id, not FIFO
2025-11-10T00:08:56.7700042Z      let manager = NetworkManager::new(TransportPreference::TcpOnly);
2025-11-10T00:08:56.7700104Z -    
2025-11-10T00:08:56.7700164Z +
2025-11-10T00:08:56.7700324Z      let peer_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-10T00:08:56.7700386Z -    
2025-11-10T00:08:56.7700589Z +
2025-11-10T00:08:56.7700685Z      // Register multiple requests
2025-11-10T00:08:56.7700815Z      let (id1, rx1) = manager.register_request(peer_addr);
2025-11-10T00:08:56.7700932Z      let (id2, rx2) = manager.register_request(peer_addr);
2025-11-10T00:08:56.7701229Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:18:
2025-11-10T00:08:56.7701354Z      let (id3, rx3) = manager.register_request(peer_addr);
2025-11-10T00:08:56.7701415Z -    
2025-11-10T00:08:56.7701474Z +
2025-11-10T00:08:56.7701568Z      // Complete requests out of order
2025-11-10T00:08:56.7701652Z      let response2 = vec![2, 2, 2];
2025-11-10T00:08:56.7701728Z      let response1 = vec![1, 1, 1];
2025-11-10T00:08:56.7702011Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:23:
2025-11-10T00:08:56.7702089Z      let response3 = vec![3, 3, 3];
2025-11-10T00:08:56.7702149Z -    
2025-11-10T00:08:56.7702209Z +
2025-11-10T00:08:56.7702369Z      assert!(manager.complete_request(id2, response2.clone()));
2025-11-10T00:08:56.7702514Z      assert!(manager.complete_request(id1, response1.clone()));
2025-11-10T00:08:56.7702652Z      assert!(manager.complete_request(id3, response3.clone()));
2025-11-10T00:08:56.7702934Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:28:
2025-11-10T00:08:56.7702996Z -    
2025-11-10T00:08:56.7703056Z +
2025-11-10T00:08:56.7703170Z      // Verify each receiver got the correct response
2025-11-10T00:08:56.7703248Z      tokio::select! {
2025-11-10T00:08:56.7703323Z          result = rx1 => {
2025-11-10T00:08:56.7703593Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:35:
2025-11-10T00:08:56.7703686Z              panic!("Request 1 timeout");
2025-11-10T00:08:56.7703751Z          }
2025-11-10T00:08:56.7703812Z      }
2025-11-10T00:08:56.7703876Z -    
2025-11-10T00:08:56.7703940Z +
2025-11-10T00:08:56.7704018Z      tokio::select! {
2025-11-10T00:08:56.7704093Z          result = rx2 => {
2025-11-10T00:08:56.7704213Z              assert_eq!(result.unwrap(), response2);
2025-11-10T00:08:56.7704668Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:44:
2025-11-10T00:08:56.7704755Z              panic!("Request 2 timeout");
2025-11-10T00:08:56.7704819Z          }
2025-11-10T00:08:56.7704885Z      }
2025-11-10T00:08:56.7704949Z -    
2025-11-10T00:08:56.7705007Z +
2025-11-10T00:08:56.7705083Z      tokio::select! {
2025-11-10T00:08:56.7705152Z          result = rx3 => {
2025-11-10T00:08:56.7705253Z              assert_eq!(result.unwrap(), response3);
2025-11-10T00:08:56.7705528Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:59:
2025-11-10T00:08:56.7705627Z  async fn test_request_cancellation() {
2025-11-10T00:08:56.7705799Z      let manager = NetworkManager::new(TransportPreference::TcpOnly);
2025-11-10T00:08:56.7705947Z      let peer_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-10T00:08:56.7706016Z -    
2025-11-10T00:08:56.7706254Z +
2025-11-10T00:08:56.7706402Z      let (request_id, rx) = manager.register_request(peer_addr);
2025-11-10T00:08:56.7706469Z -    
2025-11-10T00:08:56.7706530Z +
2025-11-10T00:08:56.7706603Z      // Cancel the request
2025-11-10T00:08:56.7706711Z      assert!(manager.cancel_request(request_id));
2025-11-10T00:08:56.7706777Z -    
2025-11-10T00:08:56.7706838Z +
2025-11-10T00:08:56.7706927Z      // Try to complete it (should fail)
2025-11-10T00:08:56.7707081Z      assert!(!manager.complete_request(request_id, vec![1, 2, 3]));
2025-11-10T00:08:56.7707141Z -    
2025-11-10T00:08:56.7707200Z +
2025-11-10T00:08:56.7707283Z      // Receiver should be closed
2025-11-10T00:08:56.7707370Z      assert!(rx.await.is_err());
2025-11-10T00:08:56.7707430Z  }
2025-11-10T00:08:56.7707873Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:76:
2025-11-10T00:08:56.7708130Z  async fn test_timestamp_cleanup() {
2025-11-10T00:08:56.7708307Z      let manager = NetworkManager::new(TransportPreference::TcpOnly);
2025-11-10T00:08:56.7708457Z      let peer_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-10T00:08:56.7708518Z -    
2025-11-10T00:08:56.7708587Z +
2025-11-10T00:08:56.7708693Z      // Register a request
2025-11-10T00:08:56.7708930Z      let (request_id, _rx) = manager.register_request(peer_addr);
2025-11-10T00:08:56.7709000Z -    
2025-11-10T00:08:56.7709060Z +
2025-11-10T00:08:56.7709204Z      // Cleanup requests older than 0 seconds (should remove all)
2025-11-10T00:08:56.7709328Z      let cleaned = manager.cleanup_expired_requests(0);
2025-11-10T00:08:56.7709412Z      assert_eq!(cleaned, 1);
2025-11-10T00:08:56.7709690Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:86:
2025-11-10T00:08:56.7709751Z -    
2025-11-10T00:08:56.7709818Z +
2025-11-10T00:08:56.7709905Z      // Request should be gone
2025-11-10T00:08:56.7710158Z      assert!(!manager.complete_request(request_id, vec![1, 2, 3]));
2025-11-10T00:08:56.7710278Z  }
2025-11-10T00:08:56.7710785Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:92:
2025-11-10T00:08:56.7710938Z  async fn test_multiple_concurrent_requests_per_peer() {
2025-11-10T00:08:56.7711109Z      let manager = NetworkManager::new(TransportPreference::TcpOnly);
2025-11-10T00:08:56.7711255Z      let peer_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-10T00:08:56.7711315Z -    
2025-11-10T00:08:56.7711376Z +
2025-11-10T00:08:56.7711487Z      // Register multiple requests from same peer
2025-11-10T00:08:56.7711610Z      let (id1, rx1) = manager.register_request(peer_addr);
2025-11-10T00:08:56.7711727Z      let (id2, rx2) = manager.register_request(peer_addr);
2025-11-10T00:08:56.7712011Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:99:
2025-11-10T00:08:56.7712128Z      let (id3, rx3) = manager.register_request(peer_addr);
2025-11-10T00:08:56.7712189Z -    
2025-11-10T00:08:56.7712252Z +
2025-11-10T00:08:56.7712339Z      // All should be registered
2025-11-10T00:08:56.7712498Z      let pending = manager.get_pending_requests_for_peer(peer_addr);
2025-11-10T00:08:56.7712587Z      assert_eq!(pending.len(), 3);
2025-11-10T00:08:56.7712872Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:104:
2025-11-10T00:08:56.7712963Z      assert!(pending.contains(&id1));
2025-11-10T00:08:56.7713050Z      assert!(pending.contains(&id2));
2025-11-10T00:08:56.7714779Z      assert!(pending.contains(&id3));
2025-11-10T00:08:56.7714848Z -    
2025-11-10T00:08:56.7714909Z +
2025-11-10T00:08:56.7714981Z      // Complete all
2025-11-10T00:08:56.7715089Z      manager.complete_request(id1, vec![1]);
2025-11-10T00:08:56.7715184Z      manager.complete_request(id2, vec![2]);
2025-11-10T00:08:56.7715468Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:111:
2025-11-10T00:08:56.7715564Z      manager.complete_request(id3, vec![3]);
2025-11-10T00:08:56.7715803Z -    
2025-11-10T00:08:56.7715864Z +
2025-11-10T00:08:56.7715949Z      // All should receive responses
2025-11-10T00:08:56.7716050Z      assert_eq!(rx1.await.unwrap(), vec![1]);
2025-11-10T00:08:56.7716143Z      assert_eq!(rx2.await.unwrap(), vec![2]);
2025-11-10T00:08:56.7716418Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:120:
2025-11-10T00:08:56.7716509Z  async fn test_request_metrics() {
2025-11-10T00:08:56.7716679Z      let manager = NetworkManager::new(TransportPreference::TcpOnly);
2025-11-10T00:08:56.7716820Z      let peer_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-10T00:08:56.7716881Z -    
2025-11-10T00:08:56.7716945Z +
2025-11-10T00:08:56.7717031Z      // Register and complete a request
2025-11-10T00:08:56.7717156Z      let (id1, _rx1) = manager.register_request(peer_addr);
2025-11-10T00:08:56.7717382Z      manager.complete_request(id1, vec![1, 2, 3]);
2025-11-10T00:08:56.7717664Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:127:
2025-11-10T00:08:56.7717724Z -    
2025-11-10T00:08:56.7717784Z +
2025-11-10T00:08:56.7717858Z      // Check metrics
2025-11-10T00:08:56.7717982Z      let metrics = manager.get_request_metrics(peer_addr);
2025-11-10T00:08:56.7718063Z      assert!(metrics.is_some());
2025-11-10T00:08:56.7718340Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:132:
2025-11-10T00:08:56.7718424Z      assert_eq!(m.total_requests, 1);
2025-11-10T00:08:56.7718519Z      assert_eq!(m.successful_responses, 1);
2025-11-10T00:08:56.7718613Z      assert_eq!(m.failed_requests, 0);
2025-11-10T00:08:56.7718674Z -    
2025-11-10T00:08:56.7718733Z +
2025-11-10T00:08:56.7718806Z      // Record a failure
2025-11-10T00:08:56.7718929Z      let (id2, _rx2) = manager.register_request(peer_addr);
2025-11-10T00:08:56.7719024Z      manager.record_failed_request(id2);
2025-11-10T00:08:56.7719303Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:139:
2025-11-10T00:08:56.7719367Z -    
2025-11-10T00:08:56.7719427Z +
2025-11-10T00:08:56.7719546Z      let metrics = manager.get_request_metrics(peer_addr);
2025-11-10T00:08:56.7719631Z      let m = metrics.unwrap();
2025-11-10T00:08:56.7719720Z      assert_eq!(m.total_requests, 2);
2025-11-10T00:08:56.7719994Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:148:
2025-11-10T00:08:56.7720084Z  async fn test_request_priority() {
2025-11-10T00:08:56.7720254Z      let manager = NetworkManager::new(TransportPreference::TcpOnly);
2025-11-10T00:08:56.7720397Z      let peer_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-10T00:08:56.7720461Z -    
2025-11-10T00:08:56.7720521Z +
2025-11-10T00:08:56.7720636Z      // Register requests with different priorities
2025-11-10T00:08:56.7720810Z      let (_id1, _rx1) = manager.register_request_with_priority(peer_addr, 0);
2025-11-10T00:08:56.7720969Z      let (_id2, _rx2) = manager.register_request_with_priority(peer_addr, 5);
2025-11-10T00:08:56.7721258Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:155:
2025-11-10T00:08:56.7721423Z      let (_id3, _rx3) = manager.register_request_with_priority(peer_addr, 10);
2025-11-10T00:08:56.7721484Z -    
2025-11-10T00:08:56.7721551Z +
2025-11-10T00:08:56.7721629Z      // All should be registered
2025-11-10T00:08:56.7721792Z      let pending = manager.get_pending_requests_for_peer(peer_addr);
2025-11-10T00:08:56.7721879Z      assert_eq!(pending.len(), 3);
2025-11-10T00:08:56.7722157Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:160:
2025-11-10T00:08:56.7722218Z  }
2025-11-10T00:08:56.7722277Z -
2025-11-10T00:08:56.7722339Z -
2025-11-10T00:08:56.7722399Z -
2025-11-10T00:08:56.7722457Z  
2025-11-10T00:08:56.7722762Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:8:
2025-11-10T00:08:56.7722957Z  async fn test_ban_list_operations() {
2025-11-10T00:08:56.7723075Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-10T00:08:56.7723175Z      let manager = NetworkManager::new(addr);
2025-11-10T00:08:56.7723239Z -    
2025-11-10T00:08:56.7723298Z +
2025-11-10T00:08:56.7723435Z      let test_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-10T00:08:56.7723494Z -    
2025-11-10T00:08:56.7723556Z +
2025-11-10T00:08:56.7723620Z      // Test ban
2025-11-10T00:08:56.7723701Z      let now = SystemTime::now()
2025-11-10T00:08:56.7723787Z          .duration_since(UNIX_EPOCH)
2025-11-10T00:08:56.7724291Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:18:
2025-11-10T00:08:56.7724530Z          .as_secs();
2025-11-10T00:08:56.7725404Z      let future_timestamp = now + 3600; // 1 hour from now
2025-11-10T00:08:56.7725613Z      manager.ban_peer(test_addr, future_timestamp);
2025-11-10T00:08:56.7725728Z -    
2025-11-10T00:08:56.7725826Z +
2025-11-10T00:08:56.7725933Z      assert!(manager.is_banned(test_addr));
2025-11-10T00:08:56.7725995Z -    
2025-11-10T00:08:56.7726053Z +
2025-11-10T00:08:56.7726128Z      // Test unban
2025-11-10T00:08:56.7726217Z      manager.unban_peer(test_addr);
2025-11-10T00:08:56.7726310Z      assert!(!manager.is_banned(test_addr));
2025-11-10T00:08:56.7726626Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:30:
2025-11-10T00:08:56.7726721Z  async fn test_ban_list_expiration() {
2025-11-10T00:08:56.7726843Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-10T00:08:56.7726948Z      let manager = NetworkManager::new(addr);
2025-11-10T00:08:56.7727013Z -    
2025-11-10T00:08:56.7727071Z +
2025-11-10T00:08:56.7727218Z      let test_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-10T00:08:56.7727279Z -    
2025-11-10T00:08:56.7727343Z +
2025-11-10T00:08:56.7727437Z      // Ban with expiration in the past
2025-11-10T00:08:56.7727522Z      let now = SystemTime::now()
2025-11-10T00:08:56.7727609Z          .duration_since(UNIX_EPOCH)
2025-11-10T00:08:56.7727922Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:40:
2025-11-10T00:08:56.7727990Z          .as_secs();
2025-11-10T00:08:56.7728098Z      let past_timestamp = now - 3600; // 1 hour ago
2025-11-10T00:08:56.7728211Z      manager.ban_peer(test_addr, past_timestamp);
2025-11-10T00:08:56.7728275Z -    
2025-11-10T00:08:56.7728333Z +
2025-11-10T00:08:56.7728455Z      // is_banned should automatically check expiration
2025-11-10T00:08:56.7728550Z      assert!(!manager.is_banned(test_addr));
2025-11-10T00:08:56.7728610Z  }
2025-11-10T00:08:56.7728917Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:49:
2025-11-10T00:08:56.7729010Z  async fn test_ban_list_permanent() {
2025-11-10T00:08:56.7729129Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-10T00:08:56.7729233Z      let manager = NetworkManager::new(addr);
2025-11-10T00:08:56.7729302Z -    
2025-11-10T00:08:56.7729362Z +
2025-11-10T00:08:56.7729502Z      let test_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-10T00:08:56.7729566Z -    
2025-11-10T00:08:56.7729624Z +
2025-11-10T00:08:56.7729715Z      // Permanent ban (timestamp = 0)
2025-11-10T00:08:56.7729800Z      manager.ban_peer(test_addr, 0);
2025-11-10T00:08:56.7729899Z      assert!(manager.is_banned(test_addr));
2025-11-10T00:08:56.7730198Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:58:
2025-11-10T00:08:56.7730258Z -    
2025-11-10T00:08:56.7730323Z +
2025-11-10T00:08:56.7730394Z      // Clear all bans
2025-11-10T00:08:56.7730472Z      manager.clear_bans();
2025-11-10T00:08:56.7730567Z      assert!(!manager.is_banned(test_addr));
2025-11-10T00:08:56.7730867Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:66:
2025-11-10T00:08:56.7731124Z  async fn test_ban_list_multiple_peers() {
2025-11-10T00:08:56.7731238Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-10T00:08:56.7731347Z      let manager = NetworkManager::new(addr);
2025-11-10T00:08:56.7731408Z -    
2025-11-10T00:08:56.7731467Z +
2025-11-10T00:08:56.7731600Z      let addr1: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-10T00:08:56.7731732Z      let addr2: SocketAddr = "127.0.0.1:8334".parse().unwrap();
2025-11-10T00:08:56.7731851Z      let addr3: SocketAddr = "127.0.0.1:8335".parse().unwrap();
2025-11-10T00:08:56.7732150Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:73:
2025-11-10T00:08:56.7732216Z -    
2025-11-10T00:08:56.7732275Z +
2025-11-10T00:08:56.7732358Z      let now = SystemTime::now()
2025-11-10T00:08:56.7732567Z          .duration_since(UNIX_EPOCH)
2025-11-10T00:08:56.7732636Z          .unwrap()
2025-11-10T00:08:56.7732937Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:77:
2025-11-10T00:08:56.7733004Z          .as_secs();
2025-11-10T00:08:56.7733071Z -    
2025-11-10T00:08:56.7733131Z +
2025-11-10T00:08:56.7733222Z      manager.ban_peer(addr1, now + 3600);
2025-11-10T00:08:56.7733317Z      manager.ban_peer(addr2, 0); // Permanent
2025-11-10T00:08:56.7733401Z      manager.ban_peer(addr3, now + 7200);
2025-11-10T00:08:56.7733696Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:82:
2025-11-10T00:08:56.7733756Z -    
2025-11-10T00:08:56.7733823Z +
2025-11-10T00:08:56.7733941Z      assert_eq!(manager.get_banned_peers().len(), 3);
2025-11-10T00:08:56.7734029Z      assert!(manager.is_banned(addr1));
2025-11-10T00:08:56.7734119Z      assert!(manager.is_banned(addr2));
2025-11-10T00:08:56.7734615Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:86:
2025-11-10T00:08:56.7734707Z      assert!(manager.is_banned(addr3));
2025-11-10T00:08:56.7734772Z -    
2025-11-10T00:08:56.7734830Z +
2025-11-10T00:08:56.7734896Z      // Unban one
2025-11-10T00:08:56.7734979Z      manager.unban_peer(addr2);
2025-11-10T00:08:56.7735096Z      assert_eq!(manager.get_banned_peers().len(), 2);
2025-11-10T00:08:56.7735391Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:91:
2025-11-10T00:08:56.7735478Z      assert!(!manager.is_banned(addr2));
2025-11-10T00:08:56.7735543Z  }
2025-11-10T00:08:56.7735601Z -
2025-11-10T00:08:56.7735660Z  
2025-11-10T00:08:56.7735976Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_tests.rs:22:
2025-11-10T00:08:56.7736063Z          .duration_since(UNIX_EPOCH)
2025-11-10T00:08:56.7736126Z          .unwrap()
2025-11-10T00:08:56.7736194Z          .as_secs();
2025-11-10T00:08:56.7736262Z -    
2025-11-10T00:08:56.7736322Z +
2025-11-10T00:08:56.7736433Z      // Create two ban lists with overlapping entries
2025-11-10T00:08:56.7736521Z      let list1 = BanListMessage {
2025-11-10T00:08:56.7736598Z          is_full: true,
2025-11-10T00:08:56.7736853Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_tests.rs:29:
2025-11-10T00:08:56.7736930Z          ban_list_hash: [0; 32],
2025-11-10T00:08:56.7737013Z          ban_entries: vec![
2025-11-10T00:08:56.7737195Z -            create_test_ban_entry([127, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 8333, now + 3600),
2025-11-10T00:08:56.7737374Z -            create_test_ban_entry([192, 168, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 8333, now + 7200),
2025-11-10T00:08:56.7737458Z +            create_test_ban_entry(
2025-11-10T00:08:56.7737558Z +                [127, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
2025-11-10T00:08:56.7737624Z +                8333,
2025-11-10T00:08:56.7737699Z +                now + 3600,
2025-11-10T00:08:56.7737766Z +            ),
2025-11-10T00:08:56.7737984Z +            create_test_ban_entry(
2025-11-10T00:08:56.7738089Z +                [192, 168, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
2025-11-10T00:08:56.7738159Z +                8333,
2025-11-10T00:08:56.7738229Z +                now + 7200,
2025-11-10T00:08:56.7738291Z +            ),
2025-11-10T00:08:56.7738352Z          ],
2025-11-10T00:08:56.7738437Z          timestamp: now,
2025-11-10T00:08:56.7738500Z      };
2025-11-10T00:08:56.7738756Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_tests.rs:36:
2025-11-10T00:08:56.7738821Z -    
2025-11-10T00:08:56.7738881Z +
2025-11-10T00:08:56.7738967Z      let list2 = BanListMessage {
2025-11-10T00:08:56.7739038Z          is_full: true,
2025-11-10T00:08:56.7739118Z          ban_list_hash: [0; 32],
2025-11-10T00:08:56.7739375Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_tests.rs:40:
2025-11-10T00:08:56.7739580Z          ban_entries: vec![
2025-11-10T00:08:56.7739671Z              // Same address, longer ban
2025-11-10T00:08:56.7739852Z -            create_test_ban_entry([127, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 8333, now + 7200),
2025-11-10T00:08:56.7739936Z +            create_test_ban_entry(
2025-11-10T00:08:56.7740033Z +                [127, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
2025-11-10T00:08:56.7740099Z +                8333,
2025-11-10T00:08:56.7740167Z +                now + 7200,
2025-11-10T00:08:56.7740235Z +            ),
2025-11-10T00:08:56.7740303Z              // New address
2025-11-10T00:08:56.7740469Z -            create_test_ban_entry([10, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 8333, now + 1800),
2025-11-10T00:08:56.7740555Z +            create_test_ban_entry(
2025-11-10T00:08:56.7740646Z +                [10, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
2025-11-10T00:08:56.7740711Z +                8333,
2025-11-10T00:08:56.7740789Z +                now + 1800,
2025-11-10T00:08:56.7740852Z +            ),
2025-11-10T00:08:56.7740916Z          ],
2025-11-10T00:08:56.7740990Z          timestamp: now,
2025-11-10T00:08:56.7741058Z      };
2025-11-10T00:08:56.7741314Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_tests.rs:48:
2025-11-10T00:08:56.7741377Z -    
2025-11-10T00:08:56.7741443Z +
2025-11-10T00:08:56.7741565Z      let merged = merge_ban_lists(vec![&list1, &list2]);
2025-11-10T00:08:56.7741626Z -    
2025-11-10T00:08:56.7741686Z +
2025-11-10T00:08:56.7741778Z      // Should have 3 unique addresses
2025-11-10T00:08:56.7741861Z      assert_eq!(merged.len(), 3);
2025-11-10T00:08:56.7741922Z -    
2025-11-10T00:08:56.7741983Z +
2025-11-10T00:08:56.7742084Z      // 127.0.0.1 should have longer ban (7200)
2025-11-10T00:08:56.7742170Z -    let entry_127 = merged.iter()
2025-11-10T00:08:56.7742255Z -        .find(|e| e.addr.ip[0] == 127)
2025-11-10T00:08:56.7742328Z -        .unwrap();
2025-11-10T00:08:56.7742499Z +    let entry_127 = merged.iter().find(|e| e.addr.ip[0] == 127).unwrap();
2025-11-10T00:08:56.7742621Z      assert_eq!(entry_127.unban_timestamp, now + 7200);
2025-11-10T00:08:56.7742688Z  }
2025-11-10T00:08:56.7742748Z  
2025-11-10T00:08:56.7743007Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_tests.rs:64:
2025-11-10T00:08:56.7743094Z          .duration_since(UNIX_EPOCH)
2025-11-10T00:08:56.7743164Z          .unwrap()
2025-11-10T00:08:56.7743232Z          .as_secs();
2025-11-10T00:08:56.7743292Z -    
2025-11-10T00:08:56.7743354Z +
2025-11-10T00:08:56.7743426Z      // Valid future ban
2025-11-10T00:08:56.7743644Z -    let future_ban = create_test_ban_entry([127, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 8333, now + 3600);
2025-11-10T00:08:56.7743743Z +    let future_ban = create_test_ban_entry(
2025-11-10T00:08:56.7743844Z +        [127, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
2025-11-10T00:08:56.7743906Z +        8333,
2025-11-10T00:08:56.7743975Z +        now + 3600,
2025-11-10T00:08:56.7744039Z +    );
2025-11-10T00:08:56.7744137Z      assert!(validate_ban_entry(&future_ban));
2025-11-10T00:08:56.7744296Z -    
2025-11-10T00:08:56.7744514Z +
2025-11-10T00:08:56.7744602Z      // Valid permanent ban
2025-11-10T00:08:56.7745007Z -    let permanent_ban = create_test_ban_entry([192, 168, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 8333, u64::MAX);
2025-11-10T00:08:56.7745182Z +    let permanent_ban = create_test_ban_entry(
2025-11-10T00:08:56.7745535Z +        [192, 168, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
2025-11-10T00:08:56.7745609Z +        8333,
2025-11-10T00:08:56.7745680Z +        u64::MAX,
2025-11-10T00:08:56.7745744Z +    );
2025-11-10T00:08:56.7745867Z      assert!(validate_ban_entry(&permanent_ban));
2025-11-10T00:08:56.7745928Z -    
2025-11-10T00:08:56.7745991Z +
2025-11-10T00:08:56.7746085Z      // Expired ban (should be invalid)
2025-11-10T00:08:56.7746505Z -    let expired_ban = create_test_ban_entry([10, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 8333, now.saturating_sub(3600));
2025-11-10T00:08:56.7746608Z +    let expired_ban = create_test_ban_entry(
2025-11-10T00:08:56.7746699Z +        [10, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
2025-11-10T00:08:56.7746767Z +        8333,
2025-11-10T00:08:56.7746850Z +        now.saturating_sub(3600),
2025-11-10T00:08:56.7746911Z +    );
2025-11-10T00:08:56.7747019Z      assert!(!validate_ban_entry(&expired_ban));
2025-11-10T00:08:56.7747081Z  }
2025-11-10T00:08:56.7747140Z  
2025-11-10T00:08:56.7747407Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_tests.rs:84:
2025-11-10T00:08:56.7747494Z          .duration_since(UNIX_EPOCH)
2025-11-10T00:08:56.7747560Z          .unwrap()
2025-11-10T00:08:56.7747624Z          .as_secs();
2025-11-10T00:08:56.7747690Z -    
2025-11-10T00:08:56.7747751Z +
2025-11-10T00:08:56.7747823Z      let entries = vec![
2025-11-10T00:08:56.7748004Z -        create_test_ban_entry([127, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 8333, now + 3600),
2025-11-10T00:08:56.7748192Z -        create_test_ban_entry([192, 168, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 8333, now + 7200),
2025-11-10T00:08:56.7748274Z +        create_test_ban_entry(
2025-11-10T00:08:56.7748370Z +            [127, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
2025-11-10T00:08:56.7748436Z +            8333,
2025-11-10T00:08:56.7748503Z +            now + 3600,
2025-11-10T00:08:56.7748564Z +        ),
2025-11-10T00:08:56.7748644Z +        create_test_ban_entry(
2025-11-10T00:08:56.7748745Z +            [192, 168, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
2025-11-10T00:08:56.7748808Z +            8333,
2025-11-10T00:08:56.7748875Z +            now + 7200,
2025-11-10T00:08:56.7748945Z +        ),
2025-11-10T00:08:56.7749005Z      ];
2025-11-10T00:08:56.7749064Z -    
2025-11-10T00:08:56.7749128Z +
2025-11-10T00:08:56.7749237Z      let hash1 = calculate_ban_list_hash(&entries);
2025-11-10T00:08:56.7749337Z      let hash2 = calculate_ban_list_hash(&entries);
2025-11-10T00:08:56.7749401Z -    
2025-11-10T00:08:56.7749465Z +
2025-11-10T00:08:56.7749560Z      // Same entries should produce same hash
2025-11-10T00:08:56.7749643Z      assert_eq!(hash1, hash2);
2025-11-10T00:08:56.7749708Z -    
2025-11-10T00:08:56.7749767Z +
2025-11-10T00:08:56.7749832Z      // Verify hash
2025-11-10T00:08:56.7749943Z      assert!(verify_ban_list_hash(&entries, &hash1));
2025-11-10T00:08:56.7750009Z  }
2025-11-10T00:08:56.7750284Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_tests.rs:102:
2025-11-10T00:08:56.7750343Z -
2025-11-10T00:08:56.7750408Z -
2025-11-10T00:08:56.7750467Z -
2025-11-10T00:08:56.7750527Z  
2025-11-10T00:08:56.7750839Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip158_implementation_tests.rs:1:
2025-11-10T00:08:56.7750930Z  //! Tests for BIP158 implementation
2025-11-10T00:08:56.7750991Z  
2025-11-10T00:08:56.7753099Z  use bllvm_node::bip158::{build_block_filter, match_filter, CompactBlockFilter};
2025-11-10T00:08:56.7753333Z -use bllvm_protocol::{Transaction, TransactionInput, TransactionOutput, OutPoint};
2025-11-10T00:08:56.7753675Z +use bllvm_protocol::{OutPoint, Transaction, TransactionInput, TransactionOutput};
2025-11-10T00:08:56.7753736Z  
2025-11-10T00:08:56.7753800Z  #[test]
2025-11-10T00:08:56.7753920Z  fn test_build_block_filter_with_transactions() {
2025-11-10T00:08:56.7754233Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip158_implementation_tests.rs:15:
2025-11-10T00:08:56.7754296Z          }],
2025-11-10T00:08:56.7754535Z          lock_time: 0,
2025-11-10T00:08:56.7754597Z      };
2025-11-10T00:08:56.7754659Z -    
2025-11-10T00:08:56.7754718Z +
2025-11-10T00:08:56.7754802Z      let tx2 = Transaction {
2025-11-10T00:08:56.7754871Z          version: 1,
2025-11-10T00:08:56.7754947Z          inputs: vec![],
2025-11-10T00:08:56.7755253Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip158_implementation_tests.rs:25:
2025-11-10T00:08:56.7755441Z          }],
2025-11-10T00:08:56.7755514Z          lock_time: 0,
2025-11-10T00:08:56.7755581Z      };
2025-11-10T00:08:56.7755649Z -    
2025-11-10T00:08:56.7755709Z +
2025-11-10T00:08:56.7755849Z      let filter = build_block_filter(&[tx1, tx2], &[]).unwrap();
2025-11-10T00:08:56.7755947Z      assert_eq!(filter.num_elements, 2);
2025-11-10T00:08:56.7756045Z      assert!(!filter.filter_data.is_empty());
2025-11-10T00:08:56.7756354Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip158_implementation_tests.rs:42:
2025-11-10T00:08:56.7756414Z          }],
2025-11-10T00:08:56.7756489Z          lock_time: 0,
2025-11-10T00:08:56.7756551Z      };
2025-11-10T00:08:56.7756610Z -    
2025-11-10T00:08:56.7756677Z +
2025-11-10T00:08:56.7756818Z      let filter = build_block_filter(&[tx.clone()], &[]).unwrap();
2025-11-10T00:08:56.7756878Z -    
2025-11-10T00:08:56.7756936Z +
2025-11-10T00:08:56.7757042Z      // Script that's in the filter should match
2025-11-10T00:08:56.7757191Z      assert!(match_filter(&filter, &tx.outputs[0].script_pubkey));
2025-11-10T00:08:56.7757263Z  }
2025-11-10T00:08:56.7757572Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip158_implementation_tests.rs:67:
2025-11-10T00:08:56.7757641Z          }],
2025-11-10T00:08:56.7757710Z          lock_time: 0,
2025-11-10T00:08:56.7757771Z      };
2025-11-10T00:08:56.7757833Z -    
2025-11-10T00:08:56.7757900Z +
2025-11-10T00:08:56.7758002Z      // Previous output script (UTXO being spent)
2025-11-10T00:08:56.7758111Z      let prev_script = vec![0x54, 0x55]; // OP_4 OP_5
2025-11-10T00:08:56.7758179Z -    
2025-11-10T00:08:56.7758239Z +
2025-11-10T00:08:56.7758416Z      let filter = build_block_filter(&[tx], &[prev_script.clone()]).unwrap();
2025-11-10T00:08:56.7758478Z -    
2025-11-10T00:08:56.7758544Z +
2025-11-10T00:08:56.7758673Z      // Both output script and previous script should match
2025-11-10T00:08:56.7758766Z      assert!(filter.num_elements >= 1);
2025-11-10T00:08:56.7758838Z  }
2025-11-10T00:08:56.7759147Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip158_implementation_tests.rs:79:
2025-11-10T00:08:56.7759214Z -
2025-11-10T00:08:56.7766938Z  
2025-11-10T00:08:56.7767271Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:1:
2025-11-10T00:08:56.7767417Z  //! Tests for BIP70 payment verification and signing
2025-11-10T00:08:56.7767483Z  
2025-11-10T00:08:56.7767748Z -use bllvm_node::bip70::{PaymentRequest, Payment, PaymentOutput, PaymentProtocolServer};
2025-11-10T00:08:56.7767888Z -use bllvm_node::network::protocol::PaymentMessage;
2025-11-10T00:08:56.7768117Z -use bllvm_protocol::{Transaction, TransactionInput, TransactionOutput, OutPoint};
2025-11-10T00:08:56.7768308Z  use bllvm_consensus::serialization::transaction::serialize_transaction;
2025-11-10T00:08:56.7768541Z +use bllvm_node::bip70::{Payment, PaymentOutput, PaymentProtocolServer, PaymentRequest};
2025-11-10T00:08:56.7768677Z +use bllvm_node::network::protocol::PaymentMessage;
2025-11-10T00:08:56.7768891Z +use bllvm_protocol::{OutPoint, Transaction, TransactionInput, TransactionOutput};
2025-11-10T00:08:56.7769173Z  use secp256k1::{Secp256k1, SecretKey};
2025-11-10T00:08:56.7769243Z  
2025-11-10T00:08:56.7769308Z  #[test]
2025-11-10T00:08:56.7769575Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:13:
2025-11-10T00:08:56.7769665Z          script: vec![0x51], // OP_1
2025-11-10T00:08:56.7769745Z          amount: Some(1000),
2025-11-10T00:08:56.7769808Z      };
2025-11-10T00:08:56.7769869Z -    
2025-11-10T00:08:56.7769989Z -    let payment_request = PaymentRequest::new(
2025-11-10T00:08:56.7770066Z -        "main".to_string(),
2025-11-10T00:08:56.7770146Z -        vec![output.clone()],
2025-11-10T00:08:56.7770217Z -        1234567890,
2025-11-10T00:08:56.7770279Z -    );
2025-11-10T00:08:56.7770339Z -    
2025-11-10T00:08:56.7770398Z +
2025-11-10T00:08:56.7770804Z +    let payment_request = PaymentRequest::new("main".to_string(), vec![output.clone()], 1234567890);
2025-11-10T00:08:56.7770868Z +
2025-11-10T00:08:56.7770958Z      // Create a payment transaction
2025-11-10T00:08:56.7771039Z      let tx = Transaction {
2025-11-10T00:08:56.7771106Z          version: 1,
2025-11-10T00:08:56.7771357Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:37:
2025-11-10T00:08:56.7771421Z          }],
2025-11-10T00:08:56.7771500Z          lock_time: 0,
2025-11-10T00:08:56.7771562Z      };
2025-11-10T00:08:56.7771623Z -    
2025-11-10T00:08:56.7771691Z +
2025-11-10T00:08:56.7771791Z      let tx_bytes = serialize_transaction(&tx);
2025-11-10T00:08:56.7771851Z -    
2025-11-10T00:08:56.7771913Z +
2025-11-10T00:08:56.7772022Z      let payment = Payment::new(vec![tx_bytes]);
2025-11-10T00:08:56.7772080Z -    
2025-11-10T00:08:56.7772138Z +
2025-11-10T00:08:56.7772218Z      // Create payment message
2025-11-10T00:08:56.7772313Z      let payment_msg = PaymentMessage {
2025-11-10T00:08:56.7772379Z          payment,
2025-11-10T00:08:56.7772840Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:48:
2025-11-10T00:08:56.7772937Z          payment_id: vec![1, 2, 3, 4],
2025-11-10T00:08:56.7772998Z      };
2025-11-10T00:08:56.7773058Z -    
2025-11-10T00:08:56.7773118Z +
2025-11-10T00:08:56.7773245Z      // Process payment (without merchant key for now)
2025-11-10T00:08:56.7773386Z      let result = PaymentProtocolServer::process_payment(
2025-11-10T00:08:56.7773459Z          &payment_msg,
2025-11-10T00:08:56.7773711Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:54:
2025-11-10T00:08:56.7773789Z          &payment_request,
2025-11-10T00:08:56.7773872Z          None, // No merchant key
2025-11-10T00:08:56.7773939Z      );
2025-11-10T00:08:56.7774002Z -    
2025-11-10T00:08:56.7774062Z +
2025-11-10T00:08:56.7774160Z      // Should succeed (validation passes)
2025-11-10T00:08:56.7774246Z      assert!(result.is_ok());
2025-11-10T00:08:56.7774307Z  }
2025-11-10T00:08:56.7774696Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:63:
2025-11-10T00:08:56.7774791Z  fn test_payment_ack_signing() {
2025-11-10T00:08:56.7774873Z      let secp = Secp256k1::new();
2025-11-10T00:08:56.7775018Z      let merchant_key = SecretKey::from_slice(&[1; 32]).unwrap();
2025-11-10T00:08:56.7775079Z -    
2025-11-10T00:08:56.7775143Z +
2025-11-10T00:08:56.7775251Z      // Create payment request with merchant pubkey
2025-11-10T00:08:56.7775336Z      let output = PaymentOutput {
2025-11-10T00:08:56.7775418Z          script: vec![0x51],
2025-11-10T00:08:56.7775658Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:70:
2025-11-10T00:08:56.7775733Z          amount: Some(1000),
2025-11-10T00:08:56.7775794Z      };
2025-11-10T00:08:56.7775860Z -    
2025-11-10T00:08:56.7775973Z -    let mut payment_request = PaymentRequest::new(
2025-11-10T00:08:56.7776047Z -        "main".to_string(),
2025-11-10T00:08:56.7776124Z -        vec![output],
2025-11-10T00:08:56.7776189Z -        1234567890,
2025-11-10T00:08:56.7776391Z -    );
2025-11-10T00:08:56.7776451Z -    
2025-11-10T00:08:56.7776516Z +
2025-11-10T00:08:56.7776768Z +    let mut payment_request = PaymentRequest::new("main".to_string(), vec![output], 1234567890);
2025-11-10T00:08:56.7776829Z +
2025-11-10T00:08:56.7776915Z      // Set merchant pubkey
2025-11-10T00:08:56.7777134Z      let merchant_pubkey = secp256k1::PublicKey::from_secret_key(&secp, &merchant_key);
2025-11-10T00:08:56.7777339Z      payment_request.merchant_pubkey = Some(merchant_pubkey.serialize().to_vec());
2025-11-10T00:08:56.7777600Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:82:
2025-11-10T00:08:56.7777660Z -    
2025-11-10T00:08:56.7777720Z +
2025-11-10T00:08:56.7777790Z      // Create payment
2025-11-10T00:08:56.7777871Z      let tx = Transaction {
2025-11-10T00:08:56.7777939Z          version: 1,
2025-11-10T00:08:56.7778292Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:97:
2025-11-10T00:08:56.7778366Z          }],
2025-11-10T00:08:56.7778435Z          lock_time: 0,
2025-11-10T00:08:56.7778498Z      };
2025-11-10T00:08:56.7778557Z -    
2025-11-10T00:08:56.7778624Z +
2025-11-10T00:08:56.7778724Z      let tx_bytes = serialize_transaction(&tx);
2025-11-10T00:08:56.7778826Z      let payment = Payment::new(vec![tx_bytes]);
2025-11-10T00:08:56.7778891Z -    
2025-11-10T00:08:56.7778951Z +
2025-11-10T00:08:56.7779045Z      let payment_msg = PaymentMessage {
2025-11-10T00:08:56.7779113Z          payment,
2025-11-10T00:08:56.7779203Z          payment_id: vec![1, 2, 3, 4],
2025-11-10T00:08:56.7779910Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:107:
2025-11-10T00:08:56.7779974Z      };
2025-11-10T00:08:56.7780041Z -    
2025-11-10T00:08:56.7780103Z +
2025-11-10T00:08:56.7780197Z      // Process payment with merchant key
2025-11-10T00:08:56.7780339Z -    let result = PaymentProtocolServer::process_payment(
2025-11-10T00:08:56.7780418Z -        &payment_msg,
2025-11-10T00:08:56.7780496Z -        &payment_request,
2025-11-10T00:08:56.7780573Z -        Some(&merchant_key),
2025-11-10T00:08:56.7780642Z -    );
2025-11-10T00:08:56.7780702Z -    
2025-11-10T00:08:56.7780768Z +    let result =
2025-11-10T00:08:56.7781036Z +        PaymentProtocolServer::process_payment(&payment_msg, &payment_request, Some(&merchant_key));
2025-11-10T00:08:56.7781104Z +
2025-11-10T00:08:56.7781182Z      assert!(result.is_ok());
2025-11-10T00:08:56.7781267Z      let ack_msg = result.unwrap();
2025-11-10T00:08:56.7781330Z -    
2025-11-10T00:08:56.7781386Z +
2025-11-10T00:08:56.7781500Z      // Verify signature is present when key provided
2025-11-10T00:08:56.7781614Z      assert!(!ack_msg.merchant_signature.is_empty());
2025-11-10T00:08:56.7781680Z  }
2025-11-10T00:08:56.7781929Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:122:
2025-11-10T00:08:56.7781989Z -
2025-11-10T00:08:56.7782057Z  
2025-11-10T00:08:56.7782303Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:1:
2025-11-10T00:08:56.7782407Z -use bllvm_protocol::ProtocolVersion;
2025-11-10T00:08:56.7782525Z  use bllvm_node::storage::blockstore::BlockStore;
2025-11-10T00:08:56.7782630Z  use bllvm_node::storage::chainstate::ChainState;
2025-11-10T00:08:56.7782728Z  use bllvm_node::storage::txindex::TxIndex;
2025-11-10T00:08:56.7782950Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:9:
2025-11-10T00:08:56.7783037Z  use bllvm_node::OutPoint;
2025-11-10T00:08:56.7783117Z  use bllvm_node::Transaction;
2025-11-10T00:08:56.7783286Z  use bllvm_node::{ByteString, TransactionInput, TransactionOutput};
2025-11-10T00:08:56.7783384Z +use bllvm_protocol::ProtocolVersion;
2025-11-10T00:08:56.7783468Z  use std::collections::HashMap;
2025-11-10T00:08:56.7783546Z  use tempfile::TempDir;
2025-11-10T00:08:56.7783611Z  
2025-11-10T00:08:56.7801513Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:1:
2025-11-10T00:08:56.7801884Z  //! Tests for fee calculation functionality
2025-11-10T00:08:56.7801971Z  
2025-11-10T00:08:56.7802132Z  use bllvm_node::node::mempool::MempoolManager;
2025-11-10T00:08:56.7802329Z -use bllvm_protocol::{Transaction, UtxoSet, OutPoint, UTXO};
2025-11-10T00:08:56.7802524Z +use bllvm_protocol::{OutPoint, Transaction, UtxoSet, UTXO};
2025-11-10T00:08:56.7802602Z  
2025-11-10T00:08:56.7802683Z  #[test]
2025-11-10T00:08:56.7802803Z  fn test_calculate_transaction_fee() {
2025-11-10T00:08:56.7803212Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:8:
2025-11-10T00:08:56.7803422Z      let mempool = MempoolManager::new();
2025-11-10T00:08:56.7803551Z -    
2025-11-10T00:08:56.7803658Z +
2025-11-10T00:08:56.7803770Z      // Create a simple transaction
2025-11-10T00:08:56.7803882Z      let mut utxo_set = UtxoSet::new();
2025-11-10T00:08:56.7806304Z -    
2025-11-10T00:08:56.7806392Z +
2025-11-10T00:08:56.7806480Z      // Add a UTXO
2025-11-10T00:08:56.7806601Z      let outpoint = OutPoint {
2025-11-10T00:08:56.7806702Z          hash: [0u8; 32],
2025-11-10T00:08:56.7807091Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:16:
2025-11-10T00:08:56.7807173Z          index: 0,
2025-11-10T00:08:56.7807258Z      };
2025-11-10T00:08:56.7807347Z      let utxo = UTXO {
2025-11-10T00:08:56.7807447Z -        value: 100_000_000, // 1 BTC
2025-11-10T00:08:56.7807579Z +        value: 100_000_000,                    // 1 BTC
2025-11-10T00:08:56.7807758Z          script_pubkey: vec![0x76, 0xa9, 0x14], // P2PKH script
2025-11-10T00:08:56.7807835Z      };
2025-11-10T00:08:56.7807947Z      utxo_set.insert(outpoint, utxo);
2025-11-10T00:08:56.7808324Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:23:
2025-11-10T00:08:56.7808399Z -    
2025-11-10T00:08:56.7808473Z +
2025-11-10T00:08:56.7808619Z      // Create transaction with 1 input and 1 output
2025-11-10T00:08:56.7808733Z      let tx = Transaction {
2025-11-10T00:08:56.7808820Z          version: 1,
2025-11-10T00:08:56.7809174Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:36:
2025-11-10T00:08:56.7809260Z          }],
2025-11-10T00:08:56.7809345Z          lock_time: 0,
2025-11-10T00:08:56.7809420Z      };
2025-11-10T00:08:56.7809496Z -    
2025-11-10T00:08:56.7809577Z +
2025-11-10T00:08:56.7809762Z      let fee = mempool.calculate_transaction_fee(&tx, &utxo_set);
2025-11-10T00:08:56.7809838Z -    
2025-11-10T00:08:56.7809953Z +
2025-11-10T00:08:56.7810288Z      // Fee should be 1 BTC - 0.99 BTC = 0.01 BTC = 1,000,000 satoshis
2025-11-10T00:08:56.7810466Z      assert_eq!(fee, 1_000_000);
2025-11-10T00:08:56.7810584Z  }
2025-11-10T00:08:56.7810979Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:46:
2025-11-10T00:08:56.7811051Z  #[test]
2025-11-10T00:08:56.7811168Z  fn test_calculate_transaction_fee_zero_fee() {
2025-11-10T00:08:56.7811277Z      let mempool = MempoolManager::new();
2025-11-10T00:08:56.7811339Z -    
2025-11-10T00:08:56.7811401Z +
2025-11-10T00:08:56.7811492Z      let mut utxo_set = UtxoSet::new();
2025-11-10T00:08:56.7811586Z      let outpoint = OutPoint {
2025-11-10T00:08:56.7811661Z          hash: [0u8; 32],
2025-11-10T00:08:56.7811959Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:57:
2025-11-10T00:08:56.7812049Z          script_pubkey: vec![],
2025-11-10T00:08:56.7812114Z      };
2025-11-10T00:08:56.7812203Z      utxo_set.insert(outpoint, utxo);
2025-11-10T00:08:56.7812264Z -    
2025-11-10T00:08:56.7812333Z +
2025-11-10T00:08:56.7812460Z      // Transaction with same input and output (no fee)
2025-11-10T00:08:56.7812542Z      let tx = Transaction {
2025-11-10T00:08:56.7812620Z          version: 1,
2025-11-10T00:08:56.7812922Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:73:
2025-11-10T00:08:56.7813141Z          }],
2025-11-10T00:08:56.7813218Z          lock_time: 0,
2025-11-10T00:08:56.7813281Z      };
2025-11-10T00:08:56.7813341Z -    
2025-11-10T00:08:56.7813401Z +
2025-11-10T00:08:56.7813563Z      let fee = mempool.calculate_transaction_fee(&tx, &utxo_set);
2025-11-10T00:08:56.7813638Z      assert_eq!(fee, 0);
2025-11-10T00:08:56.7813702Z  }
2025-11-10T00:08:56.7813988Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:81:
2025-11-10T00:08:56.7814061Z  #[test]
2025-11-10T00:08:56.7816274Z  fn test_calculate_transaction_fee_missing_utxo() {
2025-11-10T00:08:56.7816376Z      let mempool = MempoolManager::new();
2025-11-10T00:08:56.7816445Z -    
2025-11-10T00:08:56.7816506Z +
2025-11-10T00:08:56.7816623Z      let utxo_set = UtxoSet::new(); // Empty UTXO set
2025-11-10T00:08:56.7816693Z -    
2025-11-10T00:08:56.7816753Z +
2025-11-10T00:08:56.7816962Z      let outpoint = OutPoint {
2025-11-10T00:08:56.7817040Z          hash: [0u8; 32],
2025-11-10T00:08:56.7817140Z          index: 0,
2025-11-10T00:08:56.7817618Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:90:
2025-11-10T00:08:56.7817684Z      };
2025-11-10T00:08:56.7817751Z -    
2025-11-10T00:08:56.7817812Z +
2025-11-10T00:08:56.7817890Z      let tx = Transaction {
2025-11-10T00:08:56.7817958Z          version: 1,
2025-11-10T00:08:56.7818065Z          inputs: vec![bllvm_protocol::TxIn {
2025-11-10T00:08:56.7818361Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:103:
2025-11-10T00:08:56.7818423Z          }],
2025-11-10T00:08:56.7818495Z          lock_time: 0,
2025-11-10T00:08:56.7818556Z      };
2025-11-10T00:08:56.7818615Z -    
2025-11-10T00:08:56.7818686Z +
2025-11-10T00:08:56.7818830Z      let fee = mempool.calculate_transaction_fee(&tx, &utxo_set);
2025-11-10T00:08:56.7819056Z      // If UTXO is missing, input_total will be 0, so fee will be 0 (or negative, but we return 0)
2025-11-10T00:08:56.7819163Z      assert_eq!(fee, 0);
2025-11-10T00:08:56.7819448Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:110:
2025-11-10T00:08:56.7819512Z  }
2025-11-10T00:08:56.7819572Z -
2025-11-10T00:08:56.7819632Z  
2025-11-10T00:08:56.7819922Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/iroh_peer_tracking_tests.rs:1:
2025-11-10T00:08:56.7820049Z  //! Tests for Iroh peer tracking with TransportAddr
2025-11-10T00:08:56.7820108Z  
2025-11-10T00:08:56.7820254Z -use bllvm_node::network::{NetworkManager, PeerManager};
2025-11-10T00:08:56.7820380Z  use bllvm_node::network::transport::TransportAddr;
2025-11-10T00:08:56.7820510Z +use bllvm_node::network::{NetworkManager, PeerManager};
2025-11-10T00:08:56.7820591Z  use std::net::SocketAddr;
2025-11-10T00:08:56.7820649Z  
2025-11-10T00:08:56.7820718Z  #[test]
2025-11-10T00:08:56.7821012Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/iroh_peer_tracking_tests.rs:8:
2025-11-10T00:08:56.7821112Z  fn test_peer_manager_transport_addr() {
2025-11-10T00:08:56.7821213Z      let mut manager = PeerManager::new(10);
2025-11-10T00:08:56.7821273Z -    
2025-11-10T00:08:56.7821331Z +
2025-11-10T00:08:56.7821466Z      let addr1: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-10T00:08:56.7821597Z      let addr2: SocketAddr = "127.0.0.1:8334".parse().unwrap();
2025-11-10T00:08:56.7821657Z -    
2025-11-10T00:08:56.7821716Z +
2025-11-10T00:08:56.7821794Z      // Test TCP peer
2025-11-10T00:08:56.7821899Z      let tcp_addr1 = TransportAddr::Tcp(addr1);
2025-11-10T00:08:56.7821994Z      let tcp_addr2 = TransportAddr::Tcp(addr2);
2025-11-10T00:08:56.7822298Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/iroh_peer_tracking_tests.rs:17:
2025-11-10T00:08:56.7822360Z -    
2025-11-10T00:08:56.7822423Z +
2025-11-10T00:08:56.7822594Z      // Create mock peers (would need actual Peer instances in real test)
2025-11-10T00:08:56.7822743Z      // For now, just test that TransportAddr works as HashMap key
2025-11-10T00:08:56.7823005Z      assert_ne!(tcp_addr1, tcp_addr2);
2025-11-10T00:08:56.7823300Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/iroh_peer_tracking_tests.rs:21:
2025-11-10T00:08:56.7823366Z -    
2025-11-10T00:08:56.7823424Z +
2025-11-10T00:08:56.7823526Z      // Test Iroh peer (different transport type)
2025-11-10T00:08:56.7823605Z      #[cfg(feature = "iroh")]
2025-11-10T00:08:56.7823671Z      {
2025-11-10T00:08:56.7823967Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/iroh_peer_tracking_tests.rs:31:
2025-11-10T00:08:56.7824030Z  #[test]
2025-11-10T00:08:56.7824133Z  fn test_find_transport_addr_by_socket() {
2025-11-10T00:08:56.7824230Z      let mut manager = PeerManager::new(10);
2025-11-10T00:08:56.7824415Z -    
2025-11-10T00:08:56.7824478Z +
2025-11-10T00:08:56.7824763Z      let addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-10T00:08:56.7824875Z      let tcp_addr = TransportAddr::Tcp(addr);
2025-11-10T00:08:56.7824942Z -    
2025-11-10T00:08:56.7825009Z +
2025-11-10T00:08:56.7825106Z      // Should not find peer that doesn't exist
2025-11-10T00:08:56.7825269Z      assert!(manager.find_transport_addr_by_socket(addr).is_none());
2025-11-10T00:08:56.7825334Z -    
2025-11-10T00:08:56.7825393Z +
2025-11-10T00:08:56.7825479Z      // After adding, should find it
2025-11-10T00:08:56.7825604Z      // Note: Would need actual Peer instance to test fully
2025-11-10T00:08:56.7825700Z      // This test validates the lookup logic
2025-11-10T00:08:56.7825991Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/iroh_peer_tracking_tests.rs:46:
2025-11-10T00:08:56.7826054Z  #[test]
2025-11-10T00:08:56.7826144Z  fn test_peer_socket_addresses() {
2025-11-10T00:08:56.7826239Z      let mut manager = PeerManager::new(10);
2025-11-10T00:08:56.7826297Z -    
2025-11-10T00:08:56.7826357Z +
2025-11-10T00:08:56.7826494Z      let addr1: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-10T00:08:56.7826617Z      let addr2: SocketAddr = "127.0.0.1:8334".parse().unwrap();
2025-11-10T00:08:56.7826677Z -    
2025-11-10T00:08:56.7826742Z +
2025-11-10T00:08:56.7826812Z      // Add TCP peers
2025-11-10T00:08:56.7826911Z      let tcp_addr1 = TransportAddr::Tcp(addr1);
2025-11-10T00:08:56.7827004Z      let tcp_addr2 = TransportAddr::Tcp(addr2);
2025-11-10T00:08:56.7827304Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/iroh_peer_tracking_tests.rs:56:
2025-11-10T00:08:56.7827366Z -    
2025-11-10T00:08:56.7827424Z +
2025-11-10T00:08:56.7827577Z      // Test that peer_socket_addresses returns TCP/Quinn addresses
2025-11-10T00:08:56.7827657Z      // and skips Iroh addresses
2025-11-10T00:08:56.7827780Z      let socket_addrs = manager.peer_socket_addresses();
2025-11-10T00:08:56.7828082Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/iroh_peer_tracking_tests.rs:60:
2025-11-10T00:08:56.7828247Z      // Should be empty since no peers added, but validates method exists
2025-11-10T00:08:56.7828339Z      assert_eq!(socket_addrs.len(), 0);
2025-11-10T00:08:56.7828400Z  }
2025-11-10T00:08:56.7828464Z -
2025-11-10T00:08:56.7828524Z  
2025-11-10T00:08:56.7829756Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:1:
2025-11-10T00:08:56.7829931Z  //! Tests for MempoolManager refactoring
2025-11-10T00:08:56.7830034Z  
2025-11-10T00:08:56.7830227Z  use bllvm_node::node::mempool::MempoolManager;
2025-11-10T00:08:56.7830528Z -use bllvm_protocol::{Transaction, TransactionInput, TransactionOutput, OutPoint, UtxoSet, UTXO};
2025-11-10T00:08:56.7830799Z +use bllvm_protocol::{OutPoint, Transaction, TransactionInput, TransactionOutput, UtxoSet, UTXO};
2025-11-10T00:08:56.7830887Z  use std::collections::HashMap;
2025-11-10T00:08:56.7830947Z  
2025-11-10T00:08:56.7831023Z  #[tokio::test]
2025-11-10T00:08:56.7831294Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:8:
2025-11-10T00:08:56.7831571Z  async fn test_mempool_stores_full_transactions() {
2025-11-10T00:08:56.7831681Z      let mut mempool = MempoolManager::new();
2025-11-10T00:08:56.7831742Z -    
2025-11-10T00:08:56.7831801Z +
2025-11-10T00:08:56.7831891Z      // Create a test transaction
2025-11-10T00:08:56.7831969Z      let tx = Transaction {
2025-11-10T00:08:56.7832039Z          version: 1,
2025-11-10T00:08:56.7832305Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:25:
2025-11-10T00:08:56.7832373Z          }],
2025-11-10T00:08:56.7832443Z          lock_time: 0,
2025-11-10T00:08:56.7832532Z      };
2025-11-10T00:08:56.7832592Z -    
2025-11-10T00:08:56.7832652Z +
2025-11-10T00:08:56.7832724Z      // Add transaction
2025-11-10T00:08:56.7835024Z      let added = mempool.add_transaction(tx.clone()).await.unwrap();
2025-11-10T00:08:56.7835096Z      assert!(added);
2025-11-10T00:08:56.7835497Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:32:
2025-11-10T00:08:56.7835568Z -    
2025-11-10T00:08:56.7835628Z +
2025-11-10T00:08:56.7835710Z      // Verify we can retrieve it
2025-11-10T00:08:56.7835824Z      use bllvm_protocol::mempool::calculate_tx_id;
2025-11-10T00:08:56.7835920Z      let tx_hash = calculate_tx_id(&tx);
2025-11-10T00:08:56.7836171Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:42:
2025-11-10T00:08:56.7836305Z  async fn test_mempool_get_prioritized_transactions() {
2025-11-10T00:08:56.7836414Z      let mut mempool = MempoolManager::new();
2025-11-10T00:08:56.7836516Z      let mut utxo_set: UtxoSet = HashMap::new();
2025-11-10T00:08:56.7836578Z -    
2025-11-10T00:08:56.7836647Z +
2025-11-10T00:08:56.7836725Z      // Create UTXO for input
2025-11-10T00:08:56.7836808Z      let outpoint = OutPoint {
2025-11-10T00:08:56.7836879Z          hash: [0u8; 32],
2025-11-10T00:08:56.7837140Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:49:
2025-11-10T00:08:56.7837210Z          index: 0,
2025-11-10T00:08:56.7837271Z      };
2025-11-10T00:08:56.7837378Z -    utxo_set.insert(outpoint.clone(), UTXO {
2025-11-10T00:08:56.7837449Z -        value: 10000,
2025-11-10T00:08:56.7837534Z -        script_pubkey: vec![0x51],
2025-11-10T00:08:56.7837599Z -    });
2025-11-10T00:08:56.7837666Z -    
2025-11-10T00:08:56.7837737Z +    utxo_set.insert(
2025-11-10T00:08:56.7837815Z +        outpoint.clone(),
2025-11-10T00:08:56.7837880Z +        UTXO {
2025-11-10T00:08:56.7837957Z +            value: 10000,
2025-11-10T00:08:56.7838043Z +            script_pubkey: vec![0x51],
2025-11-10T00:08:56.7838105Z +        },
2025-11-10T00:08:56.7838174Z +    );
2025-11-10T00:08:56.7838233Z +
2025-11-10T00:08:56.7838360Z      // Create two transactions with different fee rates
2025-11-10T00:08:56.7838440Z      // High fee transaction
2025-11-10T00:08:56.7838536Z      let high_fee_tx = Transaction {
2025-11-10T00:08:56.7838801Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:68:
2025-11-10T00:08:56.7838867Z          }],
2025-11-10T00:08:56.7838944Z          lock_time: 0,
2025-11-10T00:08:56.7839005Z      };
2025-11-10T00:08:56.7839067Z -    
2025-11-10T00:08:56.7839126Z +
2025-11-10T00:08:56.7839209Z      // Low fee transaction
2025-11-10T00:08:56.7839290Z      let low_fee_tx = Transaction {
2025-11-10T00:08:56.7839359Z          version: 1,
2025-11-10T00:08:56.7839612Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:86:
2025-11-10T00:08:56.7839675Z          }],
2025-11-10T00:08:56.7839743Z          lock_time: 0,
2025-11-10T00:08:56.7839804Z      };
2025-11-10T00:08:56.7839872Z -    
2025-11-10T00:08:56.7839933Z +
2025-11-10T00:08:56.7840014Z      // Add both transactions
2025-11-10T00:08:56.7840173Z      mempool.add_transaction(low_fee_tx.clone()).await.unwrap();
2025-11-10T00:08:56.7840332Z      mempool.add_transaction(high_fee_tx.clone()).await.unwrap();
2025-11-10T00:08:56.7840590Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:93:
2025-11-10T00:08:56.7840783Z -    
2025-11-10T00:08:56.7840843Z +
2025-11-10T00:08:56.7840968Z      // Get prioritized (should return high fee first)
2025-11-10T00:08:56.7841153Z      let prioritized = mempool.get_prioritized_transactions(10, &utxo_set);
2025-11-10T00:08:56.7841302Z      assert_eq!(prioritized.len(), 1); // Only one has valid UTXO
2025-11-10T00:08:56.7841567Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:97:
2025-11-10T00:08:56.7841629Z -    
2025-11-10T00:08:56.7841693Z +
2025-11-10T00:08:56.7841788Z      // Verify high fee transaction is first
2025-11-10T00:08:56.7841896Z      use bllvm_protocol::mempool::calculate_tx_id;
2025-11-10T00:08:56.7842013Z      let high_fee_hash = calculate_tx_id(&high_fee_tx);
2025-11-10T00:08:56.7842371Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:104:
2025-11-10T00:08:56.7842444Z  #[tokio::test]
2025-11-10T00:08:56.7842556Z  async fn test_mempool_remove_transaction() {
2025-11-10T00:08:56.7842658Z      let mut mempool = MempoolManager::new();
2025-11-10T00:08:56.7842718Z -    
2025-11-10T00:08:56.7842779Z +
2025-11-10T00:08:56.7842863Z      let tx = Transaction {
2025-11-10T00:08:56.7842931Z          version: 1,
2025-11-10T00:08:56.7843023Z          inputs: vec![TransactionInput {
2025-11-10T00:08:56.7843280Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:121:
2025-11-10T00:08:56.7843348Z          }],
2025-11-10T00:08:56.7843416Z          lock_time: 0,
2025-11-10T00:08:56.7843478Z      };
2025-11-10T00:08:56.7843542Z -    
2025-11-10T00:08:56.7843602Z +
2025-11-10T00:08:56.7843729Z      mempool.add_transaction(tx.clone()).await.unwrap();
2025-11-10T00:08:56.7843813Z      assert_eq!(mempool.size(), 1);
2025-11-10T00:08:56.7843878Z -    
2025-11-10T00:08:56.7843941Z +
2025-11-10T00:08:56.7844050Z      use bllvm_protocol::mempool::calculate_tx_id;
2025-11-10T00:08:56.7844147Z      let tx_hash = calculate_tx_id(&tx);
2025-11-10T00:08:56.7844269Z      let removed = mempool.remove_transaction(&tx_hash);
2025-11-10T00:08:56.7844645Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:131:
2025-11-10T00:08:56.7844718Z      assert!(removed);
2025-11-10T00:08:56.7844805Z      assert_eq!(mempool.size(), 0);
2025-11-10T00:08:56.7844865Z  }
2025-11-10T00:08:56.7844925Z -
2025-11-10T00:08:56.7844989Z  
2025-11-10T00:08:56.7856480Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:1:
2025-11-10T00:08:56.7856597Z -use bllvm_protocol::ProtocolVersion;
2025-11-10T00:08:56.7856714Z  use bllvm_node::storage::blockstore::BlockStore;
2025-11-10T00:08:56.7856826Z  use bllvm_node::storage::chainstate::ChainState;
2025-11-10T00:08:56.7856926Z  use bllvm_node::storage::txindex::TxIndex;
2025-11-10T00:08:56.7857167Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:9:
2025-11-10T00:08:56.7857258Z  use bllvm_node::OutPoint;
2025-11-10T00:08:56.7857339Z  use bllvm_node::Transaction;
2025-11-10T00:08:56.7857511Z  use bllvm_node::{ByteString, TransactionInput, TransactionOutput};
2025-11-10T00:08:56.7857611Z +use bllvm_protocol::ProtocolVersion;
2025-11-10T00:08:56.7857693Z  use std::collections::HashMap;
2025-11-10T00:08:56.7857772Z  use tempfile::TempDir;
2025-11-10T00:08:56.7857836Z  
2025-11-10T00:08:56.7863093Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_property_tests.rs:2:
2025-11-10T00:08:56.7863174Z  //!
2025-11-10T00:08:56.7863413Z  //! Uses proptest to verify invariants and properties that should hold for all inputs.
2025-11-10T00:08:56.7863479Z  
2025-11-10T00:08:56.7863545Z -use hex;
2025-11-10T00:08:56.7863637Z -use proptest::prelude::*;
2025-11-10T00:08:56.7863759Z +use bllvm_node::node::mempool::MempoolManager;
2025-11-10T00:08:56.7863860Z +use bllvm_node::rpc::mining::MiningRpc;
2025-11-10T00:08:56.7863948Z +use bllvm_node::storage::Storage;
2025-11-10T00:08:56.7864268Z  use bllvm_protocol::serialization::serialize_transaction;
2025-11-10T00:08:56.7864561Z  use bllvm_protocol::types::{
2025-11-10T00:08:56.7864916Z      BlockHeader, OutPoint, Transaction, TransactionInput, TransactionOutput,
2025-11-10T00:08:56.7865244Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_property_tests.rs:10:
2025-11-10T00:08:56.7865314Z  };
2025-11-10T00:08:56.7865506Z -use bllvm_node::node::mempool::MempoolManager;
2025-11-10T00:08:56.7865667Z -use bllvm_node::rpc::mining::MiningRpc;
2025-11-10T00:08:56.7865804Z -use bllvm_node::storage::Storage;
2025-11-10T00:08:56.7865871Z +use hex;
2025-11-10T00:08:56.7865956Z +use proptest::prelude::*;
2025-11-10T00:08:56.7866043Z  use sha2::{Digest, Sha256};
2025-11-10T00:08:56.7866114Z  use std::sync::Arc;
2025-11-10T00:08:56.7866192Z  use tempfile::TempDir;
2025-11-10T00:08:56.7873018Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_rpc_implementation_tests.rs:1:
2025-11-10T00:08:56.7873168Z  //! Tests for mining RPC implementation
2025-11-10T00:08:56.7873234Z  
2025-11-10T00:08:56.7873364Z +use bllvm_node::node::mempool::MempoolManager;
2025-11-10T00:08:56.7873462Z  use bllvm_node::rpc::mining::MiningRpc;
2025-11-10T00:08:56.7873552Z  use bllvm_node::storage::Storage;
2025-11-10T00:08:56.7875776Z -use bllvm_node::node::mempool::MempoolManager;
2025-11-10T00:08:56.7875864Z +use serde_json::json;
2025-11-10T00:08:56.7875936Z  use std::sync::Arc;
2025-11-10T00:08:56.7876016Z  use tempfile::TempDir;
2025-11-10T00:08:56.7876096Z -use serde_json::json;
2025-11-10T00:08:56.7876157Z  
2025-11-10T00:08:56.7876227Z  #[tokio::test]
2025-11-10T00:08:56.7876314Z  async fn test_get_mining_info() {
2025-11-10T00:08:56.7876666Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_rpc_implementation_tests.rs:12:
2025-11-10T00:08:56.7876772Z      let temp_dir = TempDir::new().unwrap();
2025-11-10T00:08:56.7876912Z      let storage = Storage::new(temp_dir.path()).unwrap();
2025-11-10T00:08:56.7877020Z      let mempool = MempoolManager::new();
2025-11-10T00:08:56.7877082Z -    
2025-11-10T00:08:56.7877142Z +
2025-11-10T00:08:56.7877368Z      let mining_rpc = MiningRpc::with_dependencies(Arc::new(storage), Arc::new(mempool));
2025-11-10T00:08:56.7877431Z -    
2025-11-10T00:08:56.7877492Z +
2025-11-10T00:08:56.7877624Z      let info = mining_rpc.get_mining_info().await.unwrap();
2025-11-10T00:08:56.7877691Z -    
2025-11-10T00:08:56.7877750Z +
2025-11-10T00:08:56.7877836Z      // Verify response structure
2025-11-10T00:08:56.7877934Z      assert!(info.get("blocks").is_some());
2025-11-10T00:08:56.7878035Z      assert!(info.get("pooledtx").is_some());
2025-11-10T00:08:56.7878378Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_rpc_implementation_tests.rs:29:
2025-11-10T00:08:56.7878482Z      let temp_dir = TempDir::new().unwrap();
2025-11-10T00:08:56.7878612Z      let storage = Storage::new(temp_dir.path()).unwrap();
2025-11-10T00:08:56.7878710Z      let mempool = MempoolManager::new();
2025-11-10T00:08:56.7878772Z -    
2025-11-10T00:08:56.7878839Z +
2025-11-10T00:08:56.7879050Z      let mining_rpc = MiningRpc::with_dependencies(Arc::new(storage), Arc::new(mempool));
2025-11-10T00:08:56.7879111Z -    
2025-11-10T00:08:56.7879180Z +
2025-11-10T00:08:56.7879261Z      let params = json!([]);
2025-11-10T00:08:56.7879412Z      let template = mining_rpc.get_block_template(&params).await;
2025-11-10T00:08:56.7879473Z -    
2025-11-10T00:08:56.7879538Z +
2025-11-10T00:08:56.7879638Z      // Should either succeed or fail gracefully
2025-11-10T00:08:56.7879770Z      // (may fail if chain not initialized, which is expected)
2025-11-10T00:08:56.7879892Z      assert!(template.is_ok() || template.is_err());
2025-11-10T00:08:56.7880233Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_rpc_implementation_tests.rs:45:
2025-11-10T00:08:56.7880328Z      let temp_dir = TempDir::new().unwrap();
2025-11-10T00:08:56.7880626Z      let storage = Storage::new(temp_dir.path()).unwrap();
2025-11-10T00:08:56.7880718Z      let mempool = MempoolManager::new();
2025-11-10T00:08:56.7880781Z -    
2025-11-10T00:08:56.7880841Z +
2025-11-10T00:08:56.7881061Z      let mining_rpc = MiningRpc::with_dependencies(Arc::new(storage), Arc::new(mempool));
2025-11-10T00:08:56.7881123Z -    
2025-11-10T00:08:56.7881183Z +
2025-11-10T00:08:56.7881389Z      // Create a minimal invalid block hex (will fail validation, which is expected)
2025-11-10T00:08:56.7881607Z      let invalid_block_hex = "0000000000000000000000000000000000000000000000000000000000000000";
2025-11-10T00:08:56.7881713Z      let params = json!([invalid_block_hex, ""]);
2025-11-10T00:08:56.7882045Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_rpc_implementation_tests.rs:54:
2025-11-10T00:08:56.7882107Z -    
2025-11-10T00:08:56.7882166Z +
2025-11-10T00:08:56.7882413Z      let result = mining_rpc.submit_block(&params).await;
2025-11-10T00:08:56.7882487Z -    
2025-11-10T00:08:56.7882547Z +
2025-11-10T00:08:56.7882674Z      // Should fail validation (expected for invalid block)
2025-11-10T00:08:56.7882761Z      assert!(result.is_err());
2025-11-10T00:08:56.7882822Z  }
2025-11-10T00:08:56.7883149Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_rpc_implementation_tests.rs:63:
2025-11-10T00:08:56.7883247Z      let temp_dir = TempDir::new().unwrap();
2025-11-10T00:08:56.7883385Z      let storage = Storage::new(temp_dir.path()).unwrap();
2025-11-10T00:08:56.7883478Z      let mempool = MempoolManager::new();
2025-11-10T00:08:56.7883540Z -    
2025-11-10T00:08:56.7883607Z +
2025-11-10T00:08:56.7883823Z      let mining_rpc = MiningRpc::with_dependencies(Arc::new(storage), Arc::new(mempool));
2025-11-10T00:08:56.7885945Z -    
2025-11-10T00:08:56.7886014Z +
2025-11-10T00:08:56.7886117Z      let params = json!([6, "conservative"]);
2025-11-10T00:08:56.7886303Z      let fee_estimate = mining_rpc.estimate_smart_fee(&params).await.unwrap();
2025-11-10T00:08:56.7886368Z -    
2025-11-10T00:08:56.7886433Z +
2025-11-10T00:08:56.7886517Z      // Verify response structure
2025-11-10T00:08:56.7886633Z      assert!(fee_estimate.get("feerate").is_some());
2025-11-10T00:08:56.7886746Z      assert!(fee_estimate.get("blocks").is_some());
2025-11-10T00:08:56.7887084Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_rpc_implementation_tests.rs:75:
2025-11-10T00:08:56.7887252Z      assert_eq!(fee_estimate.get("blocks").unwrap().as_u64().unwrap(), 6);
2025-11-10T00:08:56.7887313Z  }
2025-11-10T00:08:56.7887380Z -
2025-11-10T00:08:56.7887439Z  
2025-11-10T00:08:56.7905328Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:1:
2025-11-10T00:08:56.7905458Z -use bllvm_protocol::ProtocolVersion;
2025-11-10T00:08:56.7905580Z  use bllvm_node::storage::blockstore::BlockStore;
2025-11-10T00:08:56.7905704Z  use bllvm_node::storage::chainstate::ChainState;
2025-11-10T00:08:56.7905823Z  use bllvm_node::storage::txindex::TxIndex;
2025-11-10T00:08:56.7906069Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:9:
2025-11-10T00:08:56.7906156Z  use bllvm_node::OutPoint;
2025-11-10T00:08:56.7906247Z  use bllvm_node::Transaction;
2025-11-10T00:08:56.7906425Z  use bllvm_node::{ByteString, TransactionInput, TransactionOutput};
2025-11-10T00:08:56.7906525Z +use bllvm_protocol::ProtocolVersion;
2025-11-10T00:08:56.7906613Z  use std::collections::HashMap;
2025-11-10T00:08:56.7906697Z  use tempfile::TempDir;
2025-11-10T00:08:56.7906760Z  
2025-11-10T00:08:56.7933072Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_rpc_tests.rs:1:
2025-11-10T00:08:56.7933192Z  //! Unit tests for Mining RPC methods
2025-11-10T00:08:56.7933259Z  
2025-11-10T00:08:56.7933420Z -use bllvm_protocol::serialization::serialize_transaction;
2025-11-10T00:08:56.7933669Z -use bllvm_protocol::{BlockHeader, Natural, OutPoint, Transaction, UtxoSet, UTXO};
2025-11-10T00:08:56.7933975Z  use bllvm_node::node::mempool::MempoolManager;
2025-11-10T00:08:56.7934073Z  use bllvm_node::rpc::mining::MiningRpc;
2025-11-10T00:08:56.7934169Z  use bllvm_node::storage::Storage;
2025-11-10T00:08:56.7934658Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_rpc_tests.rs:8:
2025-11-10T00:08:56.7934807Z +use bllvm_protocol::serialization::serialize_transaction;
2025-11-10T00:08:56.7935029Z +use bllvm_protocol::{BlockHeader, Natural, OutPoint, Transaction, UtxoSet, UTXO};
2025-11-10T00:08:56.7935115Z  use std::sync::Arc;
2025-11-10T00:08:56.7935196Z  use tempfile::TempDir;
2025-11-10T00:08:56.7935286Z  // Sha256 not needed directly in tests
2025-11-10T00:08:56.7940577Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/module_process_sharing_tests.rs:3:
2025-11-10T00:08:56.7940951Z  use bllvm_node::module::process::monitor::ModuleProcessMonitor;
2025-11-10T00:08:56.7941196Z  use bllvm_node::module::process::spawner::{ModuleProcess, ModuleProcessSpawner};
2025-11-10T00:08:56.7941287Z  use std::sync::{Arc, Mutex};
2025-11-10T00:08:56.7941368Z -use tokio::sync::mpsc;
2025-11-10T00:08:56.7941449Z  use tempfile::TempDir;
2025-11-10T00:08:56.7941533Z +use tokio::sync::mpsc;
2025-11-10T00:08:56.7941598Z  
2025-11-10T00:08:56.7941669Z  #[tokio::test]
2025-11-10T00:08:56.7941780Z  async fn test_monitor_module_shared() {
2025-11-10T00:08:56.7942136Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/module_process_sharing_tests.rs:11:
2025-11-10T00:08:56.7942241Z      let temp_dir = TempDir::new().unwrap();
2025-11-10T00:08:56.7942376Z      let (crash_tx, _crash_rx) = mpsc::unbounded_channel();
2025-11-10T00:08:56.7942511Z      let monitor = ModuleProcessMonitor::new(crash_tx);
2025-11-10T00:08:56.7942581Z -    
2025-11-10T00:08:56.7942645Z +
2025-11-10T00:08:56.7942835Z      // Create a dummy process (using true command which exits immediately)
2025-11-10T00:08:56.7942958Z -    let process = tokio::process::Command::new("true")
2025-11-10T00:08:56.7943031Z -        .spawn()
2025-11-10T00:08:56.7943106Z -        .unwrap();
2025-11-10T00:08:56.7943170Z -    
2025-11-10T00:08:56.7943353Z +    let process = tokio::process::Command::new("true").spawn().unwrap();
2025-11-10T00:08:56.7943421Z +
2025-11-10T00:08:56.7943516Z      let module_process = ModuleProcess {
2025-11-10T00:08:56.7943610Z          module_name: "test".to_string(),
2025-11-10T00:08:56.7943680Z          process,
2025-11-10T00:08:56.7944029Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/module_process_sharing_tests.rs:23:
2025-11-10T00:08:56.7944141Z          socket_path: std::path::PathBuf::new(),
2025-11-10T00:08:56.7944214Z          client: None,
2025-11-10T00:08:56.7944280Z      };
2025-11-10T00:08:56.7944574Z -    
2025-11-10T00:08:56.7944643Z +
2025-11-10T00:08:56.7944797Z      let shared_process = Arc::new(Mutex::new(module_process));
2025-11-10T00:08:56.7944866Z -    
2025-11-10T00:08:56.7944936Z +
2025-11-10T00:08:56.7945054Z      // Test that monitor_module_shared can be called
2025-11-10T00:08:56.7945183Z      // (will exit quickly since process exits immediately)
2025-11-10T00:08:56.7945420Z -    let result = monitor.monitor_module_shared("test".to_string(), shared_process).await;
2025-11-10T00:08:56.7945490Z -    
2025-11-10T00:08:56.7945568Z +    let result = monitor
2025-11-10T00:08:56.7945718Z +        .monitor_module_shared("test".to_string(), shared_process)
2025-11-10T00:08:56.7945792Z +        .await;
2025-11-10T00:08:56.7945855Z +
2025-11-10T00:08:56.7945957Z      // Should succeed (process exits normally)
2025-11-10T00:08:56.7946039Z      assert!(result.is_ok());
2025-11-10T00:08:56.7946109Z  }
2025-11-10T00:08:56.7946449Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/module_process_sharing_tests.rs:36:
2025-11-10T00:08:56.7946512Z -
2025-11-10T00:08:56.7946581Z  
2025-11-10T00:08:56.7970714Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:1:
2025-11-10T00:08:56.7971014Z -use bllvm_protocol::ProtocolVersion;
2025-11-10T00:08:56.7971153Z  use bllvm_node::storage::blockstore::BlockStore;
2025-11-10T00:08:56.7971276Z  use bllvm_node::storage::chainstate::ChainState;
2025-11-10T00:08:56.7971386Z  use bllvm_node::storage::txindex::TxIndex;
2025-11-10T00:08:56.7971659Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:9:
2025-11-10T00:08:56.7971752Z  use bllvm_node::OutPoint;
2025-11-10T00:08:56.7971847Z  use bllvm_node::Transaction;
2025-11-10T00:08:56.7972036Z  use bllvm_node::{ByteString, TransactionInput, TransactionOutput};
2025-11-10T00:08:56.7972146Z +use bllvm_protocol::ProtocolVersion;
2025-11-10T00:08:56.7972238Z  use std::collections::HashMap;
2025-11-10T00:08:56.7972326Z  use tempfile::TempDir;
2025-11-10T00:08:56.7972401Z  
2025-11-10T00:08:56.8061829Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:8:
2025-11-10T00:08:56.8062010Z  use std::net::SocketAddr;
2025-11-10T00:08:56.8062129Z  use tokio::sync::mpsc;
2025-11-10T00:08:56.8062227Z  mod common;
2025-11-10T00:08:56.8062336Z -use common::*;
2025-11-10T00:08:56.8062626Z  use bllvm_node::network::inventory::{InventoryRequest, MSG_BLOCK, MSG_TX};
2025-11-10T00:08:56.8062912Z  use bllvm_node::network::protocol::InventoryItem as NetworkInventoryItem;
2025-11-10T00:08:56.8063022Z +use common::*;
2025-11-10T00:08:56.8063115Z  
2025-11-10T00:08:56.8063217Z  #[tokio::test]
2025-11-10T00:08:56.8063364Z  async fn test_network_manager_creation() {
2025-11-10T00:08:56.8063773Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:878:
2025-11-10T00:08:56.8063904Z  async fn test_persistent_peers() {
2025-11-10T00:08:56.8064087Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-10T00:08:56.8064240Z      let manager = NetworkManager::new(addr);
2025-11-10T00:08:56.8064574Z -    
2025-11-10T00:08:56.8064676Z +
2025-11-10T00:08:56.8064879Z      let peer1: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-10T00:08:56.8065078Z      let peer2: SocketAddr = "127.0.0.1:8334".parse().unwrap();
2025-11-10T00:08:56.8065170Z -    
2025-11-10T00:08:56.8065260Z +
2025-11-10T00:08:56.8065395Z      // Test adding persistent peers
2025-11-10T00:08:56.8065532Z      manager.add_persistent_peer(peer1);
2025-11-10T00:08:56.8065662Z      manager.add_persistent_peer(peer2);
2025-11-10T00:08:56.8066058Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:888:
2025-11-10T00:08:56.8066160Z -    
2025-11-10T00:08:56.8066251Z +
2025-11-10T00:08:56.8066426Z      let persistent = manager.get_persistent_peers();
2025-11-10T00:08:56.8066567Z      assert_eq!(persistent.len(), 2);
2025-11-10T00:08:56.8066709Z      assert!(persistent.contains(&peer1));
2025-11-10T00:08:56.8067116Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:892:
2025-11-10T00:08:56.8067266Z      assert!(persistent.contains(&peer2));
2025-11-10T00:08:56.8067363Z -    
2025-11-10T00:08:56.8067453Z +
2025-11-10T00:08:56.8067580Z      // Test removing persistent peer
2025-11-10T00:08:56.8067733Z      manager.remove_persistent_peer(peer1);
2025-11-10T00:08:56.8067903Z      let persistent = manager.get_persistent_peers();
2025-11-10T00:08:56.8068298Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:903:
2025-11-10T00:08:56.8068422Z  async fn test_ban_list() {
2025-11-10T00:08:56.8068602Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-10T00:08:56.8068750Z      let manager = NetworkManager::new(addr);
2025-11-10T00:08:56.8068842Z -    
2025-11-10T00:08:56.8068939Z +
2025-11-10T00:08:56.8069169Z      let banned_peer: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-10T00:08:56.8069264Z -    
2025-11-10T00:08:56.8069358Z +
2025-11-10T00:08:56.8069512Z      // Test banning a peer (permanent ban)
2025-11-10T00:08:56.8069676Z      manager.ban_peer(banned_peer, 0);
2025-11-10T00:08:56.8069849Z      assert!(manager.is_banned(banned_peer));
2025-11-10T00:08:56.8070380Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:912:
2025-11-10T00:08:56.8070470Z -    
2025-11-10T00:08:56.8070561Z +
2025-11-10T00:08:56.8070685Z      // Test getting banned peers
2025-11-10T00:08:56.8070827Z      let banned = manager.get_banned_peers();
2025-11-10T00:08:56.8070943Z      assert_eq!(banned.len(), 1);
2025-11-10T00:08:56.8071339Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:916:
2025-11-10T00:08:56.8071467Z      assert_eq!(banned[0].0, banned_peer);
2025-11-10T00:08:56.8071558Z -    
2025-11-10T00:08:56.8071647Z +
2025-11-10T00:08:56.8071755Z      // Test unbanning
2025-11-10T00:08:56.8071881Z      manager.unban_peer(banned_peer);
2025-11-10T00:08:56.8072020Z      assert!(!manager.is_banned(banned_peer));
2025-11-10T00:08:56.8072545Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:921:
2025-11-10T00:08:56.8072912Z -    
2025-11-10T00:08:56.8072999Z +
2025-11-10T00:08:56.8073109Z      // Test temporary ban
2025-11-10T00:08:56.8073251Z      use std::time::{SystemTime, UNIX_EPOCH};
2025-11-10T00:08:56.8073369Z      let now = SystemTime::now()
2025-11-10T00:08:56.8073739Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:928:
2025-11-10T00:08:56.8073891Z      let unban_time = now + 3600; // 1 hour from now
2025-11-10T00:08:56.8076185Z      manager.ban_peer(banned_peer, unban_time);
2025-11-10T00:08:56.8076324Z      assert!(manager.is_banned(banned_peer));
2025-11-10T00:08:56.8076412Z -    
2025-11-10T00:08:56.8076508Z +
2025-11-10T00:08:56.8076618Z      // Test clearing all bans
2025-11-10T00:08:56.8076727Z      manager.clear_bans();
2025-11-10T00:08:56.8076871Z      assert!(!manager.is_banned(banned_peer));
2025-11-10T00:08:56.8077251Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:939:
2025-11-10T00:08:56.8077376Z  async fn test_network_stats() {
2025-11-10T00:08:56.8077561Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-10T00:08:56.8077702Z      let manager = NetworkManager::new(addr);
2025-11-10T00:08:56.8077789Z -    
2025-11-10T00:08:56.8077877Z +
2025-11-10T00:08:56.8078008Z      // Initially stats should be zero
2025-11-10T00:08:56.8078181Z      let (sent, received) = manager.get_network_stats();
2025-11-10T00:08:56.8078290Z      assert_eq!(sent, 0);
2025-11-10T00:08:56.8078683Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:946:
2025-11-10T00:08:56.8078796Z      assert_eq!(received, 0);
2025-11-10T00:08:56.8078885Z -    
2025-11-10T00:08:56.8078972Z +
2025-11-10T00:08:56.8079080Z      // Track some bytes
2025-11-10T00:08:56.8079203Z      manager.track_bytes_sent(100);
2025-11-10T00:08:56.8079327Z      manager.track_bytes_received(200);
2025-11-10T00:08:56.8079708Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:951:
2025-11-10T00:08:56.8079802Z -    
2025-11-10T00:08:56.8079892Z +
2025-11-10T00:08:56.8080058Z      let (sent, received) = manager.get_network_stats();
2025-11-10T00:08:56.8080171Z      assert_eq!(sent, 100);
2025-11-10T00:08:56.8080284Z      assert_eq!(received, 200);
2025-11-10T00:08:56.8080659Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:955:
2025-11-10T00:08:56.8080748Z -    
2025-11-10T00:08:56.8080856Z +
2025-11-10T00:08:56.8080989Z      // Track more bytes (should accumulate)
2025-11-10T00:08:56.8081108Z      manager.track_bytes_sent(50);
2025-11-10T00:08:56.8081219Z      manager.track_bytes_received(75);
2025-11-10T00:08:56.8081529Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:959:
2025-11-10T00:08:56.8081603Z -    
2025-11-10T00:08:56.8081677Z +
2025-11-10T00:08:56.8081820Z      let (sent, received) = manager.get_network_stats();
2025-11-10T00:08:56.8081910Z      assert_eq!(sent, 150);
2025-11-10T00:08:56.8082139Z      assert_eq!(received, 275);
2025-11-10T00:08:56.8082446Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:966:
2025-11-10T00:08:56.8082556Z  async fn test_ping_all_peers() {
2025-11-10T00:08:56.8082699Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-10T00:08:56.8082817Z      let manager = NetworkManager::new(addr);
2025-11-10T00:08:56.8082898Z -    
2025-11-10T00:08:56.8082972Z +
2025-11-10T00:08:56.8083097Z      // Test ping with no peers (should not error)
2025-11-10T00:08:56.8091614Z      let result = manager.ping_all_peers().await;
2025-11-10T00:08:56.8091749Z      assert!(result.is_ok());
2025-11-10T00:08:56.8092073Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:973:
2025-11-10T00:08:56.8092155Z -    
2025-11-10T00:08:56.8092225Z +
2025-11-10T00:08:56.8092707Z      // Note: Testing with actual peers would require setting up connections,
2025-11-10T00:08:56.8093039Z      // which is more complex. This test verifies the method doesn't panic.
2025-11-10T00:08:56.8093159Z  }
2025-11-10T00:08:56.8093704Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:1:
2025-11-10T00:08:56.8093835Z -use bllvm_protocol::ProtocolVersion;
2025-11-10T00:08:56.8093972Z  use bllvm_node::storage::blockstore::BlockStore;
2025-11-10T00:08:56.8094093Z  use bllvm_node::storage::chainstate::ChainState;
2025-11-10T00:08:56.8094203Z  use bllvm_node::storage::txindex::TxIndex;
2025-11-10T00:08:56.8094665Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:9:
2025-11-10T00:08:56.8094763Z  use bllvm_node::OutPoint;
2025-11-10T00:08:56.8094856Z  use bllvm_node::Transaction;
2025-11-10T00:08:56.8095060Z  use bllvm_node::{ByteString, TransactionInput, TransactionOutput};
2025-11-10T00:08:56.8095171Z +use bllvm_protocol::ProtocolVersion;
2025-11-10T00:08:56.8095274Z  use std::collections::HashMap;
2025-11-10T00:08:56.8095370Z  use tempfile::TempDir;
2025-11-10T00:08:56.8095444Z  
2025-11-10T00:08:56.8131388Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/node_tests.rs:5:
2025-11-10T00:08:56.8131532Z  use std::net::SocketAddr;
2025-11-10T00:08:56.8131634Z  use tempfile::TempDir;
2025-11-10T00:08:56.8131718Z  mod common;
2025-11-10T00:08:56.8131806Z -use common::*;
2025-11-10T00:08:56.8131945Z  use bllvm_protocol::ProtocolVersion;
2025-11-10T00:08:56.8132030Z +use common::*;
2025-11-10T00:08:56.8132107Z  
2025-11-10T00:08:56.8132201Z  #[tokio::test]
2025-11-10T00:08:56.8132310Z  async fn test_node_creation() {
2025-11-10T00:08:56.8142794Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/peer_stats_tests.rs:3:
2025-11-10T00:08:56.8142947Z  use bllvm_node::network::peer::Peer;
2025-11-10T00:08:56.8143067Z  use bllvm_node::network::NetworkMessage;
2025-11-10T00:08:56.8143165Z  use std::net::SocketAddr;
2025-11-10T00:08:56.8143276Z -use tokio::sync::mpsc;
2025-11-10T00:08:56.8143373Z  use tokio::net::TcpStream;
2025-11-10T00:08:56.8143468Z +use tokio::sync::mpsc;
2025-11-10T00:08:56.8143543Z  
2025-11-10T00:08:56.8145753Z  #[tokio::test]
2025-11-10T00:08:56.8145881Z  async fn test_peer_stats_initialization() {
2025-11-10T00:08:56.8146224Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/peer_stats_tests.rs:11:
2025-11-10T00:08:56.8146395Z      let addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-10T00:08:56.8146517Z      let (tx, _rx) = mpsc::unbounded_channel();
2025-11-10T00:08:56.8146593Z -    
2025-11-10T00:08:56.8146675Z +
2025-11-10T00:08:56.8146769Z      // Create a mock stream
2025-11-10T00:08:56.8146994Z      let listener = tokio::net::TcpListener::bind("127.0.0.1:0").await.unwrap();
2025-11-10T00:08:56.8147134Z      let local_addr = listener.local_addr().unwrap();
2025-11-10T00:08:56.8147478Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/peer_stats_tests.rs:17:
2025-11-10T00:08:56.8147686Z      let stream = tokio::net::TcpStream::connect(local_addr).await.unwrap();
2025-11-10T00:08:56.8147953Z -    
2025-11-10T00:08:56.8148035Z +
2025-11-10T00:08:56.8148155Z      let peer = Peer::new(stream, addr, tx);
2025-11-10T00:08:56.8148230Z -    
2025-11-10T00:08:56.8148311Z +
2025-11-10T00:08:56.8148405Z      // Check initial stats
2025-11-10T00:08:56.8148507Z      assert!(peer.conntime() > 0);
2025-11-10T00:08:56.8148638Z      assert_eq!(peer.conntime(), peer.last_send());
2025-11-10T00:08:56.8148985Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/peer_stats_tests.rs:30:
2025-11-10T00:08:56.8149090Z  async fn test_peer_record_send() {
2025-11-10T00:08:56.8149249Z      let addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-10T00:08:56.8149373Z      let (tx, _rx) = mpsc::unbounded_channel();
2025-11-10T00:08:56.8149449Z -    
2025-11-10T00:08:56.8149523Z +
2025-11-10T00:08:56.8149870Z      let listener = tokio::net::TcpListener::bind("127.0.0.1:0").await.unwrap();
2025-11-10T00:08:56.8150011Z      let local_addr = listener.local_addr().unwrap();
2025-11-10T00:08:56.8150218Z      let stream = tokio::net::TcpStream::connect(local_addr).await.unwrap();
2025-11-10T00:08:56.8150550Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/peer_stats_tests.rs:37:
2025-11-10T00:08:56.8150630Z -    
2025-11-10T00:08:56.8150704Z +
2025-11-10T00:08:56.8150828Z      let mut peer = Peer::new(stream, addr, tx);
2025-11-10T00:08:56.8150910Z -    
2025-11-10T00:08:56.8150983Z +
2025-11-10T00:08:56.8151093Z      let initial_send = peer.last_send();
2025-11-10T00:08:56.8151201Z      let initial_bytes = peer.bytes_sent();
2025-11-10T00:08:56.8151284Z -    
2025-11-10T00:08:56.8151359Z +
2025-11-10T00:08:56.8151445Z      // Record a send
2025-11-10T00:08:56.8151545Z      peer.record_send(100);
2025-11-10T00:08:56.8151622Z -    
2025-11-10T00:08:56.8151728Z +
2025-11-10T00:08:56.8151909Z      assert!(peer.last_send() >= initial_send);
2025-11-10T00:08:56.8152133Z      assert_eq!(peer.bytes_sent(), initial_bytes + 100);
2025-11-10T00:08:56.8152258Z  }
2025-11-10T00:08:56.8152817Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/peer_stats_tests.rs:51:
2025-11-10T00:08:56.8152932Z  async fn test_peer_record_receive() {
2025-11-10T00:08:56.8153091Z      let addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-10T00:08:56.8153208Z      let (tx, _rx) = mpsc::unbounded_channel();
2025-11-10T00:08:56.8153282Z -    
2025-11-10T00:08:56.8153363Z +
2025-11-10T00:08:56.8153575Z      let listener = tokio::net::TcpListener::bind("127.0.0.1:0").await.unwrap();
2025-11-10T00:08:56.8153707Z      let local_addr = listener.local_addr().unwrap();
2025-11-10T00:08:56.8155929Z      let stream = tokio::net::TcpStream::connect(local_addr).await.unwrap();
2025-11-10T00:08:56.8156255Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/peer_stats_tests.rs:58:
2025-11-10T00:08:56.8156332Z -    
2025-11-10T00:08:56.8156416Z +
2025-11-10T00:08:56.8156534Z      let mut peer = Peer::new(stream, addr, tx);
2025-11-10T00:08:56.8156613Z -    
2025-11-10T00:08:56.8156687Z +
2025-11-10T00:08:56.8156799Z      let initial_recv = peer.last_recv();
2025-11-10T00:08:56.8156908Z      let initial_bytes = peer.bytes_recv();
2025-11-10T00:08:56.8156983Z -    
2025-11-10T00:08:56.8157063Z +
2025-11-10T00:08:56.8157150Z      // Record a receive
2025-11-10T00:08:56.8157249Z      peer.record_receive(200);
2025-11-10T00:08:56.8157324Z -    
2025-11-10T00:08:56.8157404Z +
2025-11-10T00:08:56.8157520Z      assert!(peer.last_recv() >= initial_recv);
2025-11-10T00:08:56.8157662Z      assert_eq!(peer.bytes_recv(), initial_bytes + 200);
2025-11-10T00:08:56.8157743Z  }
2025-11-10T00:08:56.8158061Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/peer_stats_tests.rs:70:
2025-11-10T00:08:56.8158134Z -
2025-11-10T00:08:56.8158206Z  
2025-11-10T00:08:56.8158638Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/protocol_message_processing_tests.rs:1:
2025-11-10T00:08:56.8158948Z  //! Tests for protocol message processing integration
2025-11-10T00:08:56.8159022Z  
2025-11-10T00:08:56.8159124Z  use bllvm_node::network;
2025-11-10T00:08:56.8159226Z -use bllvm_node::storage::Storage;
2025-11-10T00:08:56.8159358Z  use bllvm_node::node::mempool::MempoolManager;
2025-11-10T00:08:56.8159462Z +use bllvm_node::storage::Storage;
2025-11-10T00:08:56.8159651Z  use bllvm_protocol::{BitcoinProtocolEngine, ProtocolVersion};
2025-11-10T00:08:56.8159738Z -use std::sync::Arc;
2025-11-10T00:08:56.8159840Z  use std::net::SocketAddr;
2025-11-10T00:08:56.8159923Z +use std::sync::Arc;
2025-11-10T00:08:56.8160014Z  use tempfile::TempDir;
2025-11-10T00:08:56.8160086Z  
2025-11-10T00:08:56.8160178Z  #[tokio::test]
2025-11-10T00:08:56.8160588Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/protocol_message_processing_tests.rs:14:
2025-11-10T00:08:56.8160881Z      let storage = Arc::new(Storage::new(temp_dir.path()).unwrap());
2025-11-10T00:08:56.8161001Z      let mempool = Arc::new(MempoolManager::new());
2025-11-10T00:08:56.8161267Z      let protocol_engine = Arc::new(BitcoinProtocolEngine::new(ProtocolVersion::Regtest).unwrap());
2025-11-10T00:08:56.8161329Z -    
2025-11-10T00:08:56.8161394Z +
2025-11-10T00:08:56.8161540Z      let network_addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-10T00:08:56.8161702Z -    let network_manager = network::NetworkManager::new(network_addr)
2025-11-10T00:08:56.8161852Z -        .with_dependencies(protocol_engine, storage, mempool);
2025-11-10T00:08:56.8161919Z -    
2025-11-10T00:08:56.8162149Z +    let network_manager = network::NetworkManager::new(network_addr).with_dependencies(
2025-11-10T00:08:56.8162229Z +        protocol_engine,
2025-11-10T00:08:56.8162298Z +        storage,
2025-11-10T00:08:56.8162362Z +        mempool,
2025-11-10T00:08:56.8162424Z +    );
2025-11-10T00:08:56.8162485Z +
2025-11-10T00:08:56.8162586Z      // Verify dependencies are set
2025-11-10T00:08:56.8162788Z      // (NetworkManager doesn't expose these, but we can verify it was created)
2025-11-10T00:08:56.8162899Z      assert!(true); // If we got here, setup worked
2025-11-10T00:08:56.8163261Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/protocol_message_processing_tests.rs:29:
2025-11-10T00:08:56.8163359Z      let temp_dir = TempDir::new().unwrap();
2025-11-10T00:08:56.8163488Z      let storage = Storage::new(temp_dir.path()).unwrap();
2025-11-10T00:08:56.8163605Z      let mempool = Arc::new(MempoolManager::new());
2025-11-10T00:08:56.8163667Z -    
2025-11-10T00:08:56.8163728Z +
2025-11-10T00:08:56.8163863Z      // Verify we can create NodeChainAccess with Storage Arcs
2025-11-10T00:08:56.8164009Z      use bllvm_node::network::chain_access::NodeChainAccess;
2025-11-10T00:08:56.8164115Z -    let chain_access = NodeChainAccess::new(
2025-11-10T00:08:56.8164195Z -        storage.blocks(),
2025-11-10T00:08:56.8164287Z -        storage.transactions(),
2025-11-10T00:08:56.8164481Z -        mempool,
2025-11-10T00:08:56.8164548Z -    );
2025-11-10T00:08:56.8164612Z -    
2025-11-10T00:08:56.8164873Z +    let chain_access = NodeChainAccess::new(storage.blocks(), storage.transactions(), mempool);
2025-11-10T00:08:56.8166811Z +
2025-11-10T00:08:56.8166886Z      // Test that it works
2025-11-10T00:08:56.8166964Z      let hash = [0u8; 32];
2025-11-10T00:08:56.8167104Z      assert!(!chain_access.has_object(&hash)); // Empty storage
2025-11-10T00:08:56.8167439Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/protocol_message_processing_tests.rs:44:
2025-11-10T00:08:56.8167507Z  }
2025-11-10T00:08:56.8167567Z -
2025-11-10T00:08:56.8167627Z  
2025-11-10T00:08:56.8200074Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:1:
2025-11-10T00:08:56.8200217Z -use bllvm_protocol::ProtocolVersion;
2025-11-10T00:08:56.8200346Z  use bllvm_node::storage::blockstore::BlockStore;
2025-11-10T00:08:56.8200471Z  use bllvm_node::storage::chainstate::ChainState;
2025-11-10T00:08:56.8200579Z  use bllvm_node::storage::txindex::TxIndex;
2025-11-10T00:08:56.8201021Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:9:
2025-11-10T00:08:56.8201113Z  use bllvm_node::OutPoint;
2025-11-10T00:08:56.8201209Z  use bllvm_node::Transaction;
2025-11-10T00:08:56.8201392Z  use bllvm_node::{ByteString, TransactionInput, TransactionOutput};
2025-11-10T00:08:56.8201494Z +use bllvm_protocol::ProtocolVersion;
2025-11-10T00:08:56.8201582Z  use std::collections::HashMap;
2025-11-10T00:08:56.8201671Z  use tempfile::TempDir;
2025-11-10T00:08:56.8201737Z  
2025-11-10T00:08:56.8247801Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:10:
2025-11-10T00:08:56.8247994Z  #[tokio::test]
2025-11-10T00:08:56.8248190Z  async fn test_message_size_validation() {
2025-11-10T00:08:56.8248490Z      use bllvm_node::network::protocol::MAX_PROTOCOL_MESSAGE_LENGTH;
2025-11-10T00:08:56.8248824Z -    
2025-11-10T00:08:56.8248910Z +
2025-11-10T00:08:56.8249072Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-10T00:08:56.8249202Z      let manager = NetworkManager::new(addr);
2025-11-10T00:08:56.8249278Z -    
2025-11-10T00:08:56.8249358Z +
2025-11-10T00:08:56.8249482Z      // Test that oversized messages are rejected
2025-11-10T00:08:56.8249686Z      // This is tested at the TransportConnection level, but we can verify
2025-11-10T00:08:56.8249808Z      // the protocol parser also validates size
2025-11-10T00:08:56.8250151Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:20:
2025-11-10T00:08:56.8250308Z      use bllvm_node::network::protocol::ProtocolParser;
2025-11-10T00:08:56.8250384Z -    
2025-11-10T00:08:56.8250466Z +
2025-11-10T00:08:56.8250573Z      // Create a message that's too large
2025-11-10T00:08:56.8250763Z      let oversized_data = vec![0u8; MAX_PROTOCOL_MESSAGE_LENGTH + 1];
2025-11-10T00:08:56.8250959Z      let result = ProtocolParser::parse_message(&oversized_data);
2025-11-10T00:08:56.8251281Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:29:
2025-11-10T00:08:56.8251388Z  async fn test_rate_limiting() {
2025-11-10T00:08:56.8251533Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-10T00:08:56.8251662Z      let manager = NetworkManager::new(addr);
2025-11-10T00:08:56.8251736Z -    
2025-11-10T00:08:56.8251810Z +
2025-11-10T00:08:56.8252009Z      // Rate limiting is tested implicitly through message processing
2025-11-10T00:08:56.8252225Z      // The rate limiter is checked in process_messages for RawMessageReceived
2025-11-10T00:08:56.8252412Z      // This test verifies the rate limiter structure exists and works
2025-11-10T00:08:56.8252738Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:36:
2025-11-10T00:08:56.8252815Z -    
2025-11-10T00:08:56.8252888Z +
2025-11-10T00:08:56.8253011Z      // Add a peer address to test rate limiting
2025-11-10T00:08:56.8253200Z      let test_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-10T00:08:56.8253278Z -    
2025-11-10T00:08:56.8253351Z +
2025-11-10T00:08:56.8253531Z      // Rate limiter should be created when first message arrives
2025-11-10T00:08:56.8253740Z      // We can't easily test this without a real connection, but the structure
2025-11-10T00:08:56.8253885Z      // is in place and will be tested in integration tests
2025-11-10T00:08:56.8254212Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:47:
2025-11-10T00:08:56.8254493Z  async fn test_per_ip_connection_limit() {
2025-11-10T00:08:56.8254638Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-10T00:08:56.8254758Z      let manager = NetworkManager::new(addr);
2025-11-10T00:08:56.8254840Z -    
2025-11-10T00:08:56.8254914Z +
2025-11-10T00:08:56.8255026Z      // Test that per-IP limits are enforced
2025-11-10T00:08:56.8255221Z      // This is tested in connect_to_peer, but we need a mock transport
2025-11-10T00:08:56.8257288Z      // For now, verify the structure exists
2025-11-10T00:08:56.8258030Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:54:
2025-11-10T00:08:56.8258149Z      let test_ip = "127.0.0.1".parse().unwrap();
2025-11-10T00:08:56.8258231Z -    
2025-11-10T00:08:56.8258304Z +
2025-11-10T00:08:56.8258453Z      // Connection limits are enforced in connect_to_peer
2025-11-10T00:08:56.8258588Z      // Integration test needed for full verification
2025-11-10T00:08:56.8258791Z      assert!(true); // Placeholder - per-IP limits tested in integration
2025-11-10T00:08:56.8259120Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:62:
2025-11-10T00:08:56.8259224Z  async fn test_ban_list_cleanup() {
2025-11-10T00:08:56.8259362Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-10T00:08:56.8259479Z      let manager = NetworkManager::new(addr);
2025-11-10T00:08:56.8259678Z -    
2025-11-10T00:08:56.8259753Z +
2025-11-10T00:08:56.8259863Z      // Test that expired bans are cleaned up
2025-11-10T00:08:56.8259979Z      use std::time::{SystemTime, UNIX_EPOCH};
2025-11-10T00:08:56.8260077Z      let now = SystemTime::now()
2025-11-10T00:08:56.8260387Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:69:
2025-11-10T00:08:56.8260490Z          .duration_since(UNIX_EPOCH)
2025-11-10T00:08:56.8260573Z          .unwrap()
2025-11-10T00:08:56.8260652Z          .as_secs();
2025-11-10T00:08:56.8260726Z -    
2025-11-10T00:08:56.8260805Z +
2025-11-10T00:08:56.8260977Z      let test_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-10T00:08:56.8261051Z -    
2025-11-10T00:08:56.8261130Z +
2025-11-10T00:08:56.8261235Z      // Ban with expiration in the past
2025-11-10T00:08:56.8261359Z      let past_timestamp = now - 3600; // 1 hour ago
2025-11-10T00:08:56.8261487Z      manager.ban_peer(test_addr, past_timestamp);
2025-11-10T00:08:56.8261813Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:78:
2025-11-10T00:08:56.8261893Z -    
2025-11-10T00:08:56.8261967Z +
2025-11-10T00:08:56.8262125Z      // is_banned should automatically clean up expired bans
2025-11-10T00:08:56.8262248Z      let was_banned = manager.is_banned(test_addr);
2025-11-10T00:08:56.8262434Z      assert!(!was_banned, "Expired ban should be automatically removed");
2025-11-10T00:08:56.8262705Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:82:
2025-11-10T00:08:56.8262775Z -    
2025-11-10T00:08:56.8262834Z +
2025-11-10T00:08:56.8262915Z      // Verify ban was removed
2025-11-10T00:08:56.8263021Z      let banned = manager.get_banned_peers();
2025-11-10T00:08:56.8263166Z -    assert!(!banned.iter().any(|(addr, _)| *addr == test_addr), 
2025-11-10T00:08:56.8263274Z -            "Expired ban should not be in ban list");
2025-11-10T00:08:56.8263342Z +    assert!(
2025-11-10T00:08:56.8263465Z +        !banned.iter().any(|(addr, _)| *addr == test_addr),
2025-11-10T00:08:56.8263563Z +        "Expired ban should not be in ban list"
2025-11-10T00:08:56.8263626Z +    );
2025-11-10T00:08:56.8263691Z  }
2025-11-10T00:08:56.8263751Z  
2025-11-10T00:08:56.8265957Z  #[tokio::test]
2025-11-10T00:08:56.8266592Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:90:
2025-11-10T00:08:56.8266697Z  async fn test_ban_list_permanent() {
2025-11-10T00:08:56.8266827Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-10T00:08:56.8266932Z      let manager = NetworkManager::new(addr);
2025-11-10T00:08:56.8267000Z -    
2025-11-10T00:08:56.8267062Z +
2025-11-10T00:08:56.8267207Z      let test_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-10T00:08:56.8267274Z -    
2025-11-10T00:08:56.8267335Z +
2025-11-10T00:08:56.8267430Z      // Test permanent ban (timestamp = 0)
2025-11-10T00:08:56.8267521Z      manager.ban_peer(test_addr, 0);
2025-11-10T00:08:56.8267714Z -    assert!(manager.is_banned(test_addr), "Permanent ban should be active");
2025-11-10T00:08:56.8267924Z -    
2025-11-10T00:08:56.8268034Z +    assert!(
2025-11-10T00:08:56.8268199Z +        manager.is_banned(test_addr),
2025-11-10T00:08:56.8268356Z +        "Permanent ban should be active"
2025-11-10T00:08:56.8268467Z +    );
2025-11-10T00:08:56.8268571Z +
2025-11-10T00:08:56.8268689Z      // Clean up
2025-11-10T00:08:56.8268830Z      manager.unban_peer(test_addr);
2025-11-10T00:08:56.8269156Z -    assert!(!manager.is_banned(test_addr), "Unbanned peer should not be banned");
2025-11-10T00:08:56.8269270Z +    assert!(
2025-11-10T00:08:56.8269411Z +        !manager.is_banned(test_addr),
2025-11-10T00:08:56.8269562Z +        "Unbanned peer should not be banned"
2025-11-10T00:08:56.8269665Z +    );
2025-11-10T00:08:56.8269775Z  }
2025-11-10T00:08:56.8269876Z  
2025-11-10T00:08:56.8269993Z  #[tokio::test]
2025-11-10T00:08:56.8270643Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:106:
2025-11-10T00:08:56.8270802Z  async fn test_ban_list_temporary() {
2025-11-10T00:08:56.8271006Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-10T00:08:56.8271172Z      let manager = NetworkManager::new(addr);
2025-11-10T00:08:56.8271282Z -    
2025-11-10T00:08:56.8271387Z +
2025-11-10T00:08:56.8272901Z      use std::time::{SystemTime, UNIX_EPOCH};
2025-11-10T00:08:56.8273017Z      let now = SystemTime::now()
2025-11-10T00:08:56.8273107Z          .duration_since(UNIX_EPOCH)
2025-11-10T00:08:56.8275378Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:113:
2025-11-10T00:08:56.8275503Z          .unwrap()
2025-11-10T00:08:56.8275573Z          .as_secs();
2025-11-10T00:08:56.8275642Z -    
2025-11-10T00:08:56.8275708Z +
2025-11-10T00:08:56.8275870Z      let test_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-10T00:08:56.8275935Z -    
2025-11-10T00:08:56.8276055Z +
2025-11-10T00:08:56.8276165Z      // Test temporary ban (1 hour from now)
2025-11-10T00:08:56.8276262Z      let future_timestamp = now + 3600;
2025-11-10T00:08:56.8276378Z      manager.ban_peer(test_addr, future_timestamp);
2025-11-10T00:08:56.8276664Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:121:
2025-11-10T00:08:56.8276882Z -    assert!(manager.is_banned(test_addr), "Active temporary ban should be active");
2025-11-10T00:08:56.8276950Z -    
2025-11-10T00:08:56.8277016Z +    assert!(
2025-11-10T00:08:56.8277111Z +        manager.is_banned(test_addr),
2025-11-10T00:08:56.8277210Z +        "Active temporary ban should be active"
2025-11-10T00:08:56.8277275Z +    );
2025-11-10T00:08:56.8277339Z +
2025-11-10T00:08:56.8277411Z      // Clean up
2025-11-10T00:08:56.8277500Z      manager.unban_peer(test_addr);
2025-11-10T00:08:56.8277563Z  }
2025-11-10T00:08:56.8277844Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:128:
2025-11-10T00:08:56.8277931Z  async fn test_clear_bans() {
2025-11-10T00:08:56.8278054Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-10T00:08:56.8278166Z      let manager = NetworkManager::new(addr);
2025-11-10T00:08:56.8278230Z -    
2025-11-10T00:08:56.8278293Z +
2025-11-10T00:08:56.8278441Z      let test_addr1: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-10T00:08:56.8278593Z      let test_addr2: SocketAddr = "127.0.0.1:8334".parse().unwrap();
2025-11-10T00:08:56.8278659Z -    
2025-11-10T00:08:56.8278722Z +
2025-11-10T00:08:56.8278807Z      // Add multiple bans
2025-11-10T00:08:56.8278898Z      manager.ban_peer(test_addr1, 0);
2025-11-10T00:08:56.8278985Z      manager.ban_peer(test_addr2, 0);
2025-11-10T00:08:56.8279258Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:138:
2025-11-10T00:08:56.8279329Z -    
2025-11-10T00:08:56.8279391Z +
2025-11-10T00:08:56.8279510Z      assert_eq!(manager.get_banned_peers().len(), 2);
2025-11-10T00:08:56.8279583Z -    
2025-11-10T00:08:56.8279647Z +
2025-11-10T00:08:56.8279720Z      // Clear all bans
2025-11-10T00:08:56.8279983Z      manager.clear_bans();
2025-11-10T00:08:56.8280380Z -    
2025-11-10T00:08:56.8280442Z +
2025-11-10T00:08:56.8280557Z      assert_eq!(manager.get_banned_peers().len(), 0);
2025-11-10T00:08:56.8280658Z      assert!(!manager.is_banned(test_addr1));
2025-11-10T00:08:56.8280747Z      assert!(!manager.is_banned(test_addr2));
2025-11-10T00:08:56.8281007Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:147:
2025-11-10T00:08:56.8281068Z  }
2025-11-10T00:08:56.8281134Z -
2025-11-10T00:08:56.8281192Z  
2025-11-10T00:08:56.8281471Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:2:
2025-11-10T00:08:56.8281537Z  
2025-11-10T00:08:56.8281603Z  #[cfg(test)]
2025-11-10T00:08:56.8281667Z  mod tests {
2025-11-10T00:08:56.8281791Z +    use bllvm_node::network::protocol::NetworkAddress;
2025-11-10T00:08:56.8282098Z      use bllvm_node::network::protocol::VersionMessage;
2025-11-10T00:08:56.8282435Z -    use bllvm_node::network::protocol::{NODE_UTXO_COMMITMENTS, NODE_BAN_LIST_SHARING, NODE_PACKAGE_RELAY, NODE_FIBRE};
2025-11-10T00:08:56.8282527Z +    use bllvm_node::network::protocol::{
2025-11-10T00:08:56.8282728Z +        NODE_BAN_LIST_SHARING, NODE_FIBRE, NODE_PACKAGE_RELAY, NODE_UTXO_COMMITMENTS,
2025-11-10T00:08:56.8282793Z +    };
2025-11-10T00:08:56.8282906Z      use bllvm_protocol::bip157::NODE_COMPACT_FILTERS;
2025-11-10T00:08:56.8283026Z -    use bllvm_node::network::protocol::NetworkAddress;
2025-11-10T00:08:56.8283085Z  
2025-11-10T00:08:56.8283236Z      fn create_version_message(services: u64) -> VersionMessage {
2025-11-10T00:08:56.8283314Z          VersionMessage {
2025-11-10T00:08:56.8283815Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:36:
2025-11-10T00:08:56.8284217Z              // Peer with UTXO commitments support
2025-11-10T00:08:56.8284706Z              let services = NODE_UTXO_COMMITMENTS;
2025-11-10T00:08:56.8284941Z              let version = create_version_message(services);
2025-11-10T00:08:56.8285186Z -            assert!(version.supports_utxo_commitments(), "Should support UTXO commitments");
2025-11-10T00:08:56.8285268Z +            assert!(
2025-11-10T00:08:56.8285379Z +                version.supports_utxo_commitments(),
2025-11-10T00:08:56.8285479Z +                "Should support UTXO commitments"
2025-11-10T00:08:56.8287070Z +            );
2025-11-10T00:08:56.8287133Z  
2025-11-10T00:08:56.8287231Z              // Peer without UTXO commitments support
2025-11-10T00:08:56.8287312Z              let services = 0;
2025-11-10T00:08:56.8287609Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:43:
2025-11-10T00:08:56.8287726Z              let version = create_version_message(services);
2025-11-10T00:08:56.8287965Z -            assert!(!version.supports_utxo_commitments(), "Should not support UTXO commitments");
2025-11-10T00:08:56.8288036Z +            assert!(
2025-11-10T00:08:56.8288139Z +                !version.supports_utxo_commitments(),
2025-11-10T00:08:56.8288231Z +                "Should not support UTXO commitments"
2025-11-10T00:08:56.8288299Z +            );
2025-11-10T00:08:56.8288361Z  
2025-11-10T00:08:56.8288491Z              // Peer with multiple flags including UTXO commitments
2025-11-10T00:08:56.8288701Z              let services = NODE_UTXO_COMMITMENTS | NODE_COMPACT_FILTERS | NODE_PACKAGE_RELAY;
2025-11-10T00:08:56.8288990Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:48:
2025-11-10T00:08:56.8289101Z              let version = create_version_message(services);
2025-11-10T00:08:56.8289370Z -            assert!(version.supports_utxo_commitments(), "Should support UTXO commitments with other flags");
2025-11-10T00:08:56.8289603Z -            assert!(version.supports_compact_filters(), "Should also support compact filters");
2025-11-10T00:08:56.8289813Z -            assert!(version.supports_package_relay(), "Should also support package relay");
2025-11-10T00:08:56.8290088Z +            assert!(
2025-11-10T00:08:56.8290192Z +                version.supports_utxo_commitments(),
2025-11-10T00:08:56.8290313Z +                "Should support UTXO commitments with other flags"
2025-11-10T00:08:56.8290375Z +            );
2025-11-10T00:08:56.8290445Z +            assert!(
2025-11-10T00:08:56.8290545Z +                version.supports_compact_filters(),
2025-11-10T00:08:56.8290637Z +                "Should also support compact filters"
2025-11-10T00:08:56.8290699Z +            );
2025-11-10T00:08:56.8290767Z +            assert!(
2025-11-10T00:08:56.8290858Z +                version.supports_package_relay(),
2025-11-10T00:08:56.8290948Z +                "Should also support package relay"
2025-11-10T00:08:56.8291015Z +            );
2025-11-10T00:08:56.8291080Z          }
2025-11-10T00:08:56.8291141Z      }
2025-11-10T00:08:56.8291316Z  
2025-11-10T00:08:56.8291608Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:57:
2025-11-10T00:08:56.8291705Z          // Peer with ban list sharing support
2025-11-10T00:08:56.8291795Z          let services = NODE_BAN_LIST_SHARING;
2025-11-10T00:08:56.8291912Z          let version = create_version_message(services);
2025-11-10T00:08:56.8292122Z -        assert!(version.supports_ban_list_sharing(), "Should support ban list sharing");
2025-11-10T00:08:56.8292186Z +        assert!(
2025-11-10T00:08:56.8292288Z +            version.supports_ban_list_sharing(),
2025-11-10T00:08:56.8292374Z +            "Should support ban list sharing"
2025-11-10T00:08:56.8292434Z +        );
2025-11-10T00:08:56.8292492Z  
2025-11-10T00:08:56.8292586Z          // Peer without ban list sharing support
2025-11-10T00:08:56.8292660Z          let services = 0;
2025-11-10T00:08:56.8292937Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:64:
2025-11-10T00:08:56.8293049Z          let version = create_version_message(services);
2025-11-10T00:08:56.8293270Z -        assert!(!version.supports_ban_list_sharing(), "Should not support ban list sharing");
2025-11-10T00:08:56.8293333Z +        assert!(
2025-11-10T00:08:56.8293428Z +            !version.supports_ban_list_sharing(),
2025-11-10T00:08:56.8293522Z +            "Should not support ban list sharing"
2025-11-10T00:08:56.8293584Z +        );
2025-11-10T00:08:56.8293642Z  
2025-11-10T00:08:56.8293777Z          // Peer with multiple flags including ban list sharing
2025-11-10T00:08:56.8293955Z          let services = NODE_BAN_LIST_SHARING | NODE_COMPACT_FILTERS | NODE_FIBRE;
2025-11-10T00:08:56.8294227Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:69:
2025-11-10T00:08:56.8294599Z          let version = create_version_message(services);
2025-11-10T00:08:56.8294894Z -        assert!(version.supports_ban_list_sharing(), "Should support ban list sharing with other flags");
2025-11-10T00:08:56.8295112Z -        assert!(version.supports_compact_filters(), "Should also support compact filters");
2025-11-10T00:08:56.8295179Z +        assert!(
2025-11-10T00:08:56.8295276Z +            version.supports_ban_list_sharing(),
2025-11-10T00:08:56.8295392Z +            "Should support ban list sharing with other flags"
2025-11-10T00:08:56.8295453Z +        );
2025-11-10T00:08:56.8295519Z +        assert!(
2025-11-10T00:08:56.8295615Z +            version.supports_compact_filters(),
2025-11-10T00:08:56.8295706Z +            "Should also support compact filters"
2025-11-10T00:08:56.8295771Z +        );
2025-11-10T00:08:56.8295930Z          assert!(version.supports_fibre(), "Should also support FIBRE");
2025-11-10T00:08:56.8295989Z      }
2025-11-10T00:08:56.8296066Z  
2025-11-10T00:08:56.8296504Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:77:
2025-11-10T00:08:56.8296654Z          // Peer with compact filters support
2025-11-10T00:08:56.8296792Z          let services = NODE_COMPACT_FILTERS;
2025-11-10T00:08:56.8297081Z          let version = create_version_message(services);
2025-11-10T00:08:56.8297288Z -        assert!(version.supports_compact_filters(), "Should support compact filters");
2025-11-10T00:08:56.8297352Z +        assert!(
2025-11-10T00:08:56.8297445Z +            version.supports_compact_filters(),
2025-11-10T00:08:56.8297537Z +            "Should support compact filters"
2025-11-10T00:08:56.8297598Z +        );
2025-11-10T00:08:56.8297655Z  
2025-11-10T00:08:56.8297751Z          // Peer without compact filters support
2025-11-10T00:08:56.8297823Z          let services = 0;
2025-11-10T00:08:56.8298089Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:84:
2025-11-10T00:08:56.8298197Z          let version = create_version_message(services);
2025-11-10T00:08:56.8298525Z -        assert!(!version.supports_compact_filters(), "Should not support compact filters");
2025-11-10T00:08:56.8298589Z +        assert!(
2025-11-10T00:08:56.8298687Z +            !version.supports_compact_filters(),
2025-11-10T00:08:56.8298779Z +            "Should not support compact filters"
2025-11-10T00:08:56.8298839Z +        );
2025-11-10T00:08:56.8298898Z      }
2025-11-10T00:08:56.8298960Z  
2025-11-10T00:08:56.8299022Z      #[test]
2025-11-10T00:08:56.8299290Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:90:
2025-11-10T00:08:56.8299380Z          // Peer with package relay support
2025-11-10T00:08:56.8299471Z          let services = NODE_PACKAGE_RELAY;
2025-11-10T00:08:56.8299573Z          let version = create_version_message(services);
2025-11-10T00:08:56.8299769Z -        assert!(version.supports_package_relay(), "Should support package relay");
2025-11-10T00:08:56.8299835Z +        assert!(
2025-11-10T00:08:56.8299935Z +            version.supports_package_relay(),
2025-11-10T00:08:56.8300022Z +            "Should support package relay"
2025-11-10T00:08:56.8300087Z +        );
2025-11-10T00:08:56.8300151Z  
2025-11-10T00:08:56.8300240Z          // Peer without package relay support
2025-11-10T00:08:56.8300309Z          let services = 0;
2025-11-10T00:08:56.8300580Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:97:
2025-11-10T00:08:56.8300683Z          let version = create_version_message(services);
2025-11-10T00:08:56.8300883Z -        assert!(!version.supports_package_relay(), "Should not support package relay");
2025-11-10T00:08:56.8300958Z +        assert!(
2025-11-10T00:08:56.8301067Z +            !version.supports_package_relay(),
2025-11-10T00:08:56.8301156Z +            "Should not support package relay"
2025-11-10T00:08:56.8301220Z +        );
2025-11-10T00:08:56.8301288Z      }
2025-11-10T00:08:56.8301349Z  
2025-11-10T00:08:56.8301413Z      #[test]
2025-11-10T00:08:56.8301708Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:115:
2025-11-10T00:08:56.8301792Z      fn test_multiple_flags() {
2025-11-10T00:08:56.8301870Z          // Peer with all flags
2025-11-10T00:08:56.8301966Z          #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.8302196Z -        let services = NODE_UTXO_COMMITMENTS | NODE_BAN_LIST_SHARING | NODE_COMPACT_FILTERS | 
2025-11-10T00:08:56.8302296Z -                      NODE_PACKAGE_RELAY | NODE_FIBRE;
2025-11-10T00:08:56.8302391Z +        let services = NODE_UTXO_COMMITMENTS
2025-11-10T00:08:56.8302477Z +            | NODE_BAN_LIST_SHARING
2025-11-10T00:08:56.8302554Z +            | NODE_COMPACT_FILTERS
2025-11-10T00:08:56.8302629Z +            | NODE_PACKAGE_RELAY
2025-11-10T00:08:56.8302709Z +            | NODE_FIBRE;
2025-11-10T00:08:56.8302808Z          #[cfg(not(feature = "utxo-commitments"))]
2025-11-10T00:08:56.8302962Z -        let services = NODE_BAN_LIST_SHARING | NODE_COMPACT_FILTERS | 
2025-11-10T00:08:56.8303054Z -                      NODE_PACKAGE_RELAY | NODE_FIBRE;
2025-11-10T00:08:56.8303137Z +        let services =
2025-11-10T00:08:56.8303331Z +            NODE_BAN_LIST_SHARING | NODE_COMPACT_FILTERS | NODE_PACKAGE_RELAY | NODE_FIBRE;
2025-11-10T00:08:56.8303542Z          let version = create_version_message(services);
2025-11-10T00:08:56.8303612Z -        
2025-11-10T00:08:56.8303672Z +
2025-11-10T00:08:56.8303759Z          #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.8303973Z -        assert!(version.supports_utxo_commitments(), "Should support UTXO commitments");
2025-11-10T00:08:56.8304183Z -        assert!(version.supports_ban_list_sharing(), "Should support ban list sharing");
2025-11-10T00:08:56.8304538Z -        assert!(version.supports_compact_filters(), "Should support compact filters");
2025-11-10T00:08:56.8304738Z -        assert!(version.supports_package_relay(), "Should support package relay");
2025-11-10T00:08:56.8304810Z +        assert!(
2025-11-10T00:08:56.8304909Z +            version.supports_utxo_commitments(),
2025-11-10T00:08:56.8305124Z +            "Should support UTXO commitments"
2025-11-10T00:08:56.8305197Z +        );
2025-11-10T00:08:56.8305265Z +        assert!(
2025-11-10T00:08:56.8305359Z +            version.supports_ban_list_sharing(),
2025-11-10T00:08:56.8305446Z +            "Should support ban list sharing"
2025-11-10T00:08:56.8305512Z +        );
2025-11-10T00:08:56.8305578Z +        assert!(
2025-11-10T00:08:56.8305676Z +            version.supports_compact_filters(),
2025-11-10T00:08:56.8305767Z +            "Should support compact filters"
2025-11-10T00:08:56.8305826Z +        );
2025-11-10T00:08:56.8305892Z +        assert!(
2025-11-10T00:08:56.8305983Z +            version.supports_package_relay(),
2025-11-10T00:08:56.8306077Z +            "Should support package relay"
2025-11-10T00:08:56.8306141Z +        );
2025-11-10T00:08:56.8306286Z          assert!(version.supports_fibre(), "Should support FIBRE");
2025-11-10T00:08:56.8306354Z      }
2025-11-10T00:08:56.8306414Z  
2025-11-10T00:08:56.8306705Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:137:
2025-11-10T00:08:56.8306769Z          {
2025-11-10T00:08:56.8306870Z              let services = NODE_UTXO_COMMITMENTS;
2025-11-10T00:08:56.8306986Z              let version = create_version_message(services);
2025-11-10T00:08:56.8307047Z -            
2025-11-10T00:08:56.8307270Z -            assert!(version.supports_utxo_commitments(), "Should support UTXO commitments");
2025-11-10T00:08:56.8307491Z -            assert!(!version.supports_ban_list_sharing(), "Should not support ban list sharing");
2025-11-10T00:08:56.8307705Z -            assert!(!version.supports_compact_filters(), "Should not support compact filters");
2025-11-10T00:08:56.8307771Z +
2025-11-10T00:08:56.8307837Z +            assert!(
2025-11-10T00:08:56.8307940Z +                version.supports_utxo_commitments(),
2025-11-10T00:08:56.8308036Z +                "Should support UTXO commitments"
2025-11-10T00:08:56.8308102Z +            );
2025-11-10T00:08:56.8308172Z +            assert!(
2025-11-10T00:08:56.8308268Z +                !version.supports_ban_list_sharing(),
2025-11-10T00:08:56.8308369Z +                "Should not support ban list sharing"
2025-11-10T00:08:56.8308430Z +            );
2025-11-10T00:08:56.8308492Z +            assert!(
2025-11-10T00:08:56.8308587Z +                !version.supports_compact_filters(),
2025-11-10T00:08:56.8308681Z +                "Should not support compact filters"
2025-11-10T00:08:56.8308741Z +            );
2025-11-10T00:08:56.8308804Z          }
2025-11-10T00:08:56.8308870Z      }
2025-11-10T00:08:56.8308928Z  
2025-11-10T00:08:56.8309216Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:149:
2025-11-10T00:08:56.8309475Z          // Verify bit positions don't overlap
2025-11-10T00:08:56.8309576Z          #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.8309637Z          {
2025-11-10T00:08:56.8309840Z -            assert_eq!(NODE_UTXO_COMMITMENTS, 1 << 27, "UTXO commitments should be bit 27");
2025-11-10T00:08:56.8309917Z +            assert_eq!(
2025-11-10T00:08:56.8310134Z +                NODE_UTXO_COMMITMENTS,
2025-11-10T00:08:56.8310200Z +                1 << 27,
2025-11-10T00:08:56.8310299Z +                "UTXO commitments should be bit 27"
2025-11-10T00:08:56.8310359Z +            );
2025-11-10T00:08:56.8310419Z          }
2025-11-10T00:08:56.8310602Z -        assert_eq!(NODE_BAN_LIST_SHARING, 1 << 28, "Ban list sharing should be bit 28");
2025-11-10T00:08:56.8310784Z -        assert_eq!(NODE_PACKAGE_RELAY, 1 << 25, "Package relay should be bit 25");
2025-11-10T00:08:56.8310850Z +        assert_eq!(
2025-11-10T00:08:56.8310931Z +            NODE_BAN_LIST_SHARING,
2025-11-10T00:08:56.8310996Z +            1 << 28,
2025-11-10T00:08:56.8311096Z +            "Ban list sharing should be bit 28"
2025-11-10T00:08:56.8311157Z +        );
2025-11-10T00:08:56.8311223Z +        assert_eq!(
2025-11-10T00:08:56.8311306Z +            NODE_PACKAGE_RELAY,
2025-11-10T00:08:56.8311456Z +            1 << 25,
2025-11-10T00:08:56.8311548Z +            "Package relay should be bit 25"
2025-11-10T00:08:56.8311616Z +        );
2025-11-10T00:08:56.8311755Z          assert_eq!(NODE_FIBRE, 1 << 26, "FIBRE should be bit 26");
2025-11-10T00:08:56.8311816Z -        
2025-11-10T00:08:56.8311876Z +
2025-11-10T00:08:56.8311954Z          // Verify no overlap
2025-11-10T00:08:56.8312043Z          #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.8312102Z          {
2025-11-10T00:08:56.8312386Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:161:
2025-11-10T00:08:56.8312610Z -            assert_eq!(NODE_UTXO_COMMITMENTS & NODE_BAN_LIST_SHARING, 0, "Flags should not overlap");
2025-11-10T00:08:56.8312821Z -            assert_eq!(NODE_UTXO_COMMITMENTS & NODE_PACKAGE_RELAY, 0, "Flags should not overlap");
2025-11-10T00:08:56.8313011Z -            assert_eq!(NODE_UTXO_COMMITMENTS & NODE_FIBRE, 0, "Flags should not overlap");
2025-11-10T00:08:56.8313092Z +            assert_eq!(
2025-11-10T00:08:56.8313207Z +                NODE_UTXO_COMMITMENTS & NODE_BAN_LIST_SHARING,
2025-11-10T00:08:56.8313274Z +                0,
2025-11-10T00:08:56.8313364Z +                "Flags should not overlap"
2025-11-10T00:08:56.8313424Z +            );
2025-11-10T00:08:56.8313493Z +            assert_eq!(
2025-11-10T00:08:56.8313599Z +                NODE_UTXO_COMMITMENTS & NODE_PACKAGE_RELAY,
2025-11-10T00:08:56.8313666Z +                0,
2025-11-10T00:08:56.8313748Z +                "Flags should not overlap"
2025-11-10T00:08:56.8313808Z +            );
2025-11-10T00:08:56.8313881Z +            assert_eq!(
2025-11-10T00:08:56.8313975Z +                NODE_UTXO_COMMITMENTS & NODE_FIBRE,
2025-11-10T00:08:56.8314037Z +                0,
2025-11-10T00:08:56.8314119Z +                "Flags should not overlap"
2025-11-10T00:08:56.8314186Z +            );
2025-11-10T00:08:56.8314247Z          }
2025-11-10T00:08:56.8314577Z -        assert_eq!(NODE_BAN_LIST_SHARING & NODE_PACKAGE_RELAY, 0, "Flags should not overlap");
2025-11-10T00:08:56.8314767Z -        assert_eq!(NODE_BAN_LIST_SHARING & NODE_FIBRE, 0, "Flags should not overlap");
2025-11-10T00:08:56.8314947Z -        assert_eq!(NODE_PACKAGE_RELAY & NODE_FIBRE, 0, "Flags should not overlap");
2025-11-10T00:08:56.8315013Z +        assert_eq!(
2025-11-10T00:08:56.8315118Z +            NODE_BAN_LIST_SHARING & NODE_PACKAGE_RELAY,
2025-11-10T00:08:56.8315185Z +            0,
2025-11-10T00:08:56.8315267Z +            "Flags should not overlap"
2025-11-10T00:08:56.8315325Z +        );
2025-11-10T00:08:56.8315394Z +        assert_eq!(
2025-11-10T00:08:56.8315482Z +            NODE_BAN_LIST_SHARING & NODE_FIBRE,
2025-11-10T00:08:56.8315540Z +            0,
2025-11-10T00:08:56.8315618Z +            "Flags should not overlap"
2025-11-10T00:08:56.8315683Z +        );
2025-11-10T00:08:56.8315748Z +        assert_eq!(
2025-11-10T00:08:56.8315838Z +            NODE_PACKAGE_RELAY & NODE_FIBRE,
2025-11-10T00:08:56.8315901Z +            0,
2025-11-10T00:08:56.8315983Z +            "Flags should not overlap"
2025-11-10T00:08:56.8316204Z +        );
2025-11-10T00:08:56.8316262Z      }
2025-11-10T00:08:56.8316329Z  }
2025-11-10T00:08:56.8316387Z -
2025-11-10T00:08:56.8316444Z  
2025-11-10T00:08:56.8316755Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/storage_arcs_tests.rs:1:
2025-11-10T00:08:56.8316847Z  //! Tests for Storage Arc refactoring
2025-11-10T00:08:56.8316906Z  
2025-11-10T00:08:56.8317004Z -use bllvm_node::storage::Storage;
2025-11-10T00:08:56.8317141Z  use bllvm_node::network::chain_access::NodeChainAccess;
2025-11-10T00:08:56.8317248Z  use bllvm_node::node::mempool::MempoolManager;
2025-11-10T00:08:56.8317337Z +use bllvm_node::storage::Storage;
2025-11-10T00:08:56.8317409Z  use std::sync::Arc;
2025-11-10T00:08:56.8317484Z  use tempfile::TempDir;
2025-11-10T00:08:56.8317544Z  
2025-11-10T00:08:56.8317825Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/storage_arcs_tests.rs:10:
2025-11-10T00:08:56.8318027Z  fn test_storage_returns_arcs() {
2025-11-10T00:08:56.8318124Z      let temp_dir = TempDir::new().unwrap();
2025-11-10T00:08:56.8318261Z      let storage = Storage::new(temp_dir.path()).unwrap();
2025-11-10T00:08:56.8318322Z -    
2025-11-10T00:08:56.8318380Z +
2025-11-10T00:08:56.8318460Z      // Verify blocks() returns Arc
2025-11-10T00:08:56.8318549Z      let blocks_arc = storage.blocks();
2025-11-10T00:08:56.8318634Z      let blocks_arc2 = storage.blocks();
2025-11-10T00:08:56.8318901Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/storage_arcs_tests.rs:17:
2025-11-10T00:08:56.8318966Z -    
2025-11-10T00:08:56.8319024Z +
2025-11-10T00:08:56.8319115Z      // Both should be valid Arcs (can clone)
2025-11-10T00:08:56.8319322Z      assert!(Arc::ptr_eq(&blocks_arc, &blocks_arc2) || blocks_arc.block_count().is_ok());
2025-11-10T00:08:56.8319427Z -    
2025-11-10T00:08:56.8319532Z +
2025-11-10T00:08:56.8319685Z      // Verify transactions() returns Arc
2025-11-10T00:08:56.8319852Z      let tx_arc = storage.transactions();
2025-11-10T00:08:56.8320010Z      let tx_arc2 = storage.transactions();
2025-11-10T00:08:56.8320342Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/storage_arcs_tests.rs:24:
2025-11-10T00:08:56.8320408Z -    
2025-11-10T00:08:56.8320469Z +
2025-11-10T00:08:56.8320657Z      assert!(Arc::ptr_eq(&tx_arc, &tx_arc2) || tx_arc.has_transaction(&[0u8; 32]).is_ok());
2025-11-10T00:08:56.8320717Z  }
2025-11-10T00:08:56.8320781Z  
2025-11-10T00:08:56.8321048Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/storage_arcs_tests.rs:30:
2025-11-10T00:08:56.8321141Z      let temp_dir = TempDir::new().unwrap();
2025-11-10T00:08:56.8321270Z      let storage = Storage::new(temp_dir.path()).unwrap();
2025-11-10T00:08:56.8321376Z      let mempool = Arc::new(MempoolManager::new());
2025-11-10T00:08:56.8321436Z -    
2025-11-10T00:08:56.8321499Z +
2025-11-10T00:08:56.8321657Z      // Should be able to create NodeChainAccess with Arcs from Storage
2025-11-10T00:08:56.8321756Z -    let chain_access = NodeChainAccess::new(
2025-11-10T00:08:56.8321837Z -        storage.blocks(),
2025-11-10T00:08:56.8321924Z -        storage.transactions(),
2025-11-10T00:08:56.8321988Z -        mempool,
2025-11-10T00:08:56.8322049Z -    );
2025-11-10T00:08:56.8322114Z -    
2025-11-10T00:08:56.8322355Z +    let chain_access = NodeChainAccess::new(storage.blocks(), storage.transactions(), mempool);
2025-11-10T00:08:56.8322416Z +
2025-11-10T00:08:56.8322487Z      // Verify it works
2025-11-10T00:08:56.8322565Z      let hash = [0u8; 32];
2025-11-10T00:08:56.8322676Z      let has_object = chain_access.has_object(&hash);
2025-11-10T00:08:56.8322939Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/storage_arcs_tests.rs:44:
2025-11-10T00:08:56.8323080Z      assert!(!has_object); // Empty storage, so should be false
2025-11-10T00:08:56.8323142Z  }
2025-11-10T00:08:56.8323200Z -
2025-11-10T00:08:56.8323258Z  
2025-11-10T00:08:56.8323503Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:1:
2025-11-10T00:08:56.8323745Z -use bllvm_protocol::ProtocolVersion;
2025-11-10T00:08:56.8323878Z  use bllvm_node::storage::blockstore::BlockStore;
2025-11-10T00:08:56.8323989Z  use bllvm_node::storage::chainstate::ChainState;
2025-11-10T00:08:56.8324083Z  use bllvm_node::storage::txindex::TxIndex;
2025-11-10T00:08:56.8326066Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:9:
2025-11-10T00:08:56.8326158Z  use bllvm_node::OutPoint;
2025-11-10T00:08:56.8326239Z  use bllvm_node::Transaction;
2025-11-10T00:08:56.8326410Z  use bllvm_node::{ByteString, TransactionInput, TransactionOutput};
2025-11-10T00:08:56.8326510Z +use bllvm_protocol::ProtocolVersion;
2025-11-10T00:08:56.8326593Z  use std::collections::HashMap;
2025-11-10T00:08:56.8326670Z  use tempfile::TempDir;
2025-11-10T00:08:56.8326729Z  
2025-11-10T00:08:56.8370701Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/storage_tests.rs:4:
2025-11-10T00:08:56.8370820Z  use bllvm_node::storage::*;
2025-11-10T00:08:56.8370907Z  use tempfile::TempDir;
2025-11-10T00:08:56.8370981Z  mod common;
2025-11-10T00:08:56.8371052Z -use common::*;
2025-11-10T00:08:56.8371174Z  use bllvm_node::storage::blockstore::BlockStore;
2025-11-10T00:08:56.8371286Z  use bllvm_node::storage::chainstate::ChainState;
2025-11-10T00:08:56.8371381Z  use bllvm_node::storage::txindex::TxIndex;
2025-11-10T00:08:56.8371659Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/storage_tests.rs:11:
2025-11-10T00:08:56.8371782Z  use bllvm_node::storage::utxostore::UtxoStore;
2025-11-10T00:08:56.8371854Z +use common::*;
2025-11-10T00:08:56.8371916Z  
2025-11-10T00:08:56.8371981Z  #[test]
2025-11-10T00:08:56.8372072Z  fn test_storage_creation() {
2025-11-10T00:08:56.8395529Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:1:
2025-11-10T00:08:56.8395699Z -use bllvm_protocol::ProtocolVersion;
2025-11-10T00:08:56.8397574Z  use bllvm_node::storage::blockstore::BlockStore;
2025-11-10T00:08:56.8397819Z  use bllvm_node::storage::chainstate::ChainState;
2025-11-10T00:08:56.8398028Z  use bllvm_node::storage::txindex::TxIndex;
2025-11-10T00:08:56.8398349Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:9:
2025-11-10T00:08:56.8398457Z  use bllvm_node::OutPoint;
2025-11-10T00:08:56.8398573Z  use bllvm_node::Transaction;
2025-11-10T00:08:56.8398791Z  use bllvm_node::{ByteString, TransactionInput, TransactionOutput};
2025-11-10T00:08:56.8398919Z +use bllvm_protocol::ProtocolVersion;
2025-11-10T00:08:56.8399032Z  use std::collections::HashMap;
2025-11-10T00:08:56.8399192Z  use tempfile::TempDir;
2025-11-10T00:08:56.8399329Z  
2025-11-10T00:08:56.8400019Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/stratum_v2_mining_tests.rs:1:
2025-11-10T00:08:56.8400196Z  //! Unit tests for Stratum V2 mining and share validation
2025-11-10T00:08:56.8400275Z  
2025-11-10T00:08:56.8400492Z -use bllvm_protocol::types::{Block, BlockHeader, Hash, Natural};
2025-11-10T00:08:56.8400666Z  use bllvm_node::network::stratum_v2::messages::ShareData;
2025-11-10T00:08:56.8400876Z  use bllvm_node::network::stratum_v2::pool::{JobInfo, StratumV2Pool};
2025-11-10T00:08:56.8401070Z +use bllvm_protocol::types::{Block, BlockHeader, Hash, Natural};
2025-11-10T00:08:56.8401174Z  use tempfile::TempDir;
2025-11-10T00:08:56.8401261Z  mod common;
2025-11-10T00:08:56.8410073Z  use common::*;
2025-11-10T00:08:56.8480299Z ##[error]Process completed with exit code 1.
2025-11-10T00:08:56.8562674Z Post job cleanup.
2025-11-10T00:08:56.9840173Z Post job cleanup.
2025-11-10T00:08:57.1151927Z Post job cleanup.
2025-11-10T00:08:57.2330065Z [command]/usr/bin/git version
2025-11-10T00:08:57.2372108Z git version 2.43.0
2025-11-10T00:08:57.2418423Z Copying '/home/jswift/.gitconfig' to '/home/jswift/actions-runner-org2/_work/_temp/90d0c85e-7c30-4510-8054-9001e5641115/.gitconfig'
2025-11-10T00:08:57.2432750Z Temporarily overriding HOME='/home/jswift/actions-runner-org2/_work/_temp/90d0c85e-7c30-4510-8054-9001e5641115' before making global git config changes
2025-11-10T00:08:57.2435945Z Adding repository directory to the temporary git global config as a safe directory
2025-11-10T00:08:57.2440168Z [command]/usr/bin/git config --global --add safe.directory /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node
2025-11-10T00:08:57.2485384Z [command]/usr/bin/git config --local --name-only --get-regexp core\.sshCommand
2025-11-10T00:08:57.2525358Z [command]/usr/bin/git submodule foreach --recursive sh -c "git config --local --name-only --get-regexp 'core\.sshCommand' && git config --local --unset-all 'core.sshCommand' || :"
2025-11-10T00:08:57.2820217Z [command]/usr/bin/git config --local --name-only --get-regexp http\.https\:\/\/github\.com\/\.extraheader
2025-11-10T00:08:57.2849224Z http.https://github.com/.extraheader
2025-11-10T00:08:57.2866776Z [command]/usr/bin/git config --local --unset-all http.https://github.com/.extraheader
2025-11-10T00:08:57.2902576Z [command]/usr/bin/git submodule foreach --recursive sh -c "git config --local --name-only --get-regexp 'http\.https\:\/\/github\.com\/\.extraheader' && git config --local --unset-all 'http.https://github.com/.extraheader' || :"
2025-11-10T00:08:57.3294978Z A job completed hook has been configured by the self-hosted runner administrator
2025-11-10T00:08:57.3342983Z ##[group]Run '/home/jswift/actions-runner-org2/cleanup-hooks/job-completed.sh'
2025-11-10T00:08:57.3373559Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2025-11-10T00:08:57.3373948Z ##[endgroup]
2025-11-10T00:08:57.3439533Z Job completed: Mon Nov 10 12:08:57 AM UTC 2025
2025-11-10T00:08:57.3475563Z Available disk space: 9.1G
2025-11-10T00:08:57.3477658Z Cleaning up after job completion...
2025-11-10T00:08:57.4486409Z Cleanup completed. Available disk space: 9.1G
2025-11-10T00:08:57.4536506Z Cleaning up orphan processes
