2025-11-10T00:08:56.0379482Z ##[group]Run cargo fmt -- --check
2025-11-10T00:08:56.0379802Z [36;1mcargo fmt -- --check[0m
2025-11-10T00:08:56.0413019Z shell: /usr/bin/bash -e {0}
2025-11-10T00:08:56.0413265Z env:
2025-11-10T00:08:56.0413448Z   CARGO_TERM_COLOR: always
2025-11-10T00:08:56.0413687Z   CARGO_HOME: /home/jswift/.cargo
2025-11-10T00:08:56.0413928Z   CARGO_INCREMENTAL: 0
2025-11-10T00:08:56.0414140Z ##[endgroup]
2025-11-10T00:08:56.3176924Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:332:
2025-11-10T00:08:56.3179803Z  pub enum PruningMode {
2025-11-10T00:08:56.3180229Z      /// No pruning (keep all blocks)
2025-11-10T00:08:56.3180647Z      Disabled,
2025-11-10T00:08:56.3180948Z -    
2025-11-10T00:08:56.3181234Z +
2025-11-10T00:08:56.3181627Z      /// Normal pruning (keep recent blocks for verification)
2025-11-10T00:08:56.3182164Z      Normal {
2025-11-10T00:08:56.3182509Z          /// Keep blocks from this height onwards
2025-11-10T00:08:56.3185396Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:342:
2025-11-10T00:08:56.3186307Z          #[serde(default = "default_min_recent_blocks")]
2025-11-10T00:08:56.3186815Z          min_recent_blocks: u64,
2025-11-10T00:08:56.3187196Z      },
2025-11-10T00:08:56.3187474Z -    
2025-11-10T00:08:56.3187737Z +
2025-11-10T00:08:56.3188063Z      /// Aggressive pruning with UTXO commitments
2025-11-10T00:08:56.3188576Z      /// Requires: utxo-commitments feature enabled
2025-11-10T00:08:56.3189066Z      Aggressive {
2025-11-10T00:08:56.3189690Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:359:
2025-11-10T00:08:56.3190467Z          #[serde(default = "default_min_blocks")]
2025-11-10T00:08:56.3190920Z          min_blocks: u64,
2025-11-10T00:08:56.3191250Z      },
2025-11-10T00:08:56.3191524Z -    
2025-11-10T00:08:56.3191786Z +
2025-11-10T00:08:56.3192084Z      /// Custom pruning configuration
2025-11-10T00:08:56.3192506Z      Custom {
2025-11-10T00:08:56.3192949Z          /// Keep block headers (always required for PoW verification)
2025-11-10T00:08:56.3193855Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:408:
2025-11-10T00:08:56.3194790Z      /// Pruning mode
2025-11-10T00:08:56.3195190Z      #[serde(default = "default_pruning_mode")]
2025-11-10T00:08:56.3197635Z      pub mode: PruningMode,
2025-11-10T00:08:56.3198000Z -    
2025-11-10T00:08:56.3198262Z +
2025-11-10T00:08:56.3198655Z      /// Automatic pruning (prune periodically as chain grows)
2025-11-10T00:08:56.3199226Z      #[serde(default = "default_false")]
2025-11-10T00:08:56.3199677Z      pub auto_prune: bool,
2025-11-10T00:08:56.3200367Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:415:
2025-11-10T00:08:56.3201161Z -    
2025-11-10T00:08:56.3201426Z +
2025-11-10T00:08:56.3201741Z      /// Automatic pruning interval (blocks)
2025-11-10T00:08:56.3202235Z      /// Prune every N blocks if auto_prune is enabled
2025-11-10T00:08:56.3202809Z      #[serde(default = "default_auto_prune_interval")]
2025-11-10T00:08:56.3204073Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:419:
2025-11-10T00:08:56.3205030Z      pub auto_prune_interval: u64,
2025-11-10T00:08:56.3207297Z -    
2025-11-10T00:08:56.3207555Z +
2025-11-10T00:08:56.3207862Z      /// Minimum blocks to keep (safety margin)
2025-11-10T00:08:56.3208463Z      /// Even with aggressive pruning, keep at least this many blocks
2025-11-10T00:08:56.3209113Z      #[serde(default = "default_min_blocks_to_keep")]
2025-11-10T00:08:56.3209922Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:424:
2025-11-10T00:08:56.3210708Z      pub min_blocks_to_keep: u64,
2025-11-10T00:08:56.3211105Z -    
2025-11-10T00:08:56.3211364Z +
2025-11-10T00:08:56.3211742Z      /// Prune on startup (prune old blocks when node starts)
2025-11-10T00:08:56.3212249Z      #[serde(default = "default_false")]
2025-11-10T00:08:56.3212694Z      pub prune_on_startup: bool,
2025-11-10T00:08:56.3215822Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:429:
2025-11-10T00:08:56.3216570Z -    
2025-11-10T00:08:56.3216823Z +
2025-11-10T00:08:56.3217356Z      /// Allow incremental pruning during IBD (requires UTXO commitments + aggressive mode)
2025-11-10T00:08:56.3218331Z      /// When enabled, old blocks are pruned incrementally during sync, keeping only a window
2025-11-10T00:08:56.3219272Z      /// of recent blocks. This prevents the need to download the full blockchain before pruning.
2025-11-10T00:08:56.3220254Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:433:
2025-11-10T00:08:56.3221038Z      #[serde(default = "default_false")]
2025-11-10T00:08:56.3221521Z      pub incremental_prune_during_ibd: bool,
2025-11-10T00:08:56.3221954Z -    
2025-11-10T00:08:56.3222204Z +
2025-11-10T00:08:56.3222665Z      /// Block window size for incremental pruning (number of recent blocks to keep)
2025-11-10T00:08:56.3223368Z      /// Only used when incremental_prune_during_ibd is true
2025-11-10T00:08:56.3240169Z      #[serde(default = "default_prune_window_size")]
2025-11-10T00:08:56.3241069Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:439:
2025-11-10T00:08:56.3241864Z      pub prune_window_size: u64,
2025-11-10T00:08:56.3242259Z -    
2025-11-10T00:08:56.3242522Z +
2025-11-10T00:08:56.3242965Z      /// Minimum blocks before starting incremental pruning during IBD
2025-11-10T00:08:56.3243634Z      /// Prevents pruning too early in the sync process
2025-11-10T00:08:56.3244255Z      #[serde(default = "default_min_blocks_for_incremental_prune")]
2025-11-10T00:08:56.3245318Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:444:
2025-11-10T00:08:56.3246117Z      pub min_blocks_for_incremental_prune: u64,
2025-11-10T00:08:56.3246568Z -    
2025-11-10T00:08:56.3246829Z +
2025-11-10T00:08:56.3247116Z      /// UTXO commitments integration
2025-11-10T00:08:56.3247575Z      #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.3248175Z      pub utxo_commitments: Option<UtxoCommitmentsPruningConfig>,
2025-11-10T00:08:56.3249069Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:449:
2025-11-10T00:08:56.3249796Z -    
2025-11-10T00:08:56.3250062Z +
2025-11-10T00:08:56.3250355Z      /// BIP158 filter integration
2025-11-10T00:08:56.3250775Z      #[cfg(feature = "bip158")]
2025-11-10T00:08:56.3251243Z      pub bip158_filters: Option<Bip158PruningConfig>,
2025-11-10T00:08:56.3252044Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:486:
2025-11-10T00:08:56.3252803Z                  keep_filtered_blocks: false,
2025-11-10T00:08:56.3253291Z                  min_blocks: 144, // ~1 day at 10 min/block
2025-11-10T00:08:56.3253724Z              },
2025-11-10T00:08:56.3254098Z -            auto_prune: true, // Enable automatic pruning
2025-11-10T00:08:56.3254865Z +            auto_prune: true,         // Enable automatic pruning
2025-11-10T00:08:56.3255872Z              auto_prune_interval: 144, // Prune every ~1 day
2025-11-10T00:08:56.3256376Z              min_blocks_to_keep: 144,
2025-11-10T00:08:56.3256887Z -            prune_on_startup: false, // Still false for safety
2025-11-10T00:08:56.3257625Z -            incremental_prune_during_ibd: true, // Enable incremental pruning during IBD
2025-11-10T00:08:56.3258457Z -            prune_window_size: 144, // Keep sliding window of 144 blocks during IBD
2025-11-10T00:08:56.3259250Z +            prune_on_startup: false,               // Still false for safety
2025-11-10T00:08:56.3260041Z +            incremental_prune_during_ibd: true,    // Enable incremental pruning during IBD
2025-11-10T00:08:56.3260896Z +            prune_window_size: 144,                // Keep sliding window of 144 blocks during IBD
2025-11-10T00:08:56.3261756Z              min_blocks_for_incremental_prune: 288, // Start pruning after 288 blocks (~2 days)
2025-11-10T00:08:56.3262772Z              #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.3263258Z              utxo_commitments: None,
2025-11-10T00:08:56.3263975Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:508:
2025-11-10T00:08:56.3264931Z      /// Keep UTXO commitments for pruned blocks
2025-11-10T00:08:56.3265406Z      #[serde(default = "default_true")]
2025-11-10T00:08:56.3265860Z      pub keep_commitments: bool,
2025-11-10T00:08:56.3266230Z -    
2025-11-10T00:08:56.3266499Z +
2025-11-10T00:08:56.3266891Z      /// Keep filtered blocks (spam-filtered) for pruned range
2025-11-10T00:08:56.3267433Z      #[serde(default = "default_false")]
2025-11-10T00:08:56.3267886Z      pub keep_filtered_blocks: bool,
2025-11-10T00:08:56.3268621Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:515:
2025-11-10T00:08:56.3269337Z -    
2025-11-10T00:08:56.3269596Z +
2025-11-10T00:08:56.3270025Z      /// Generate commitments before pruning (if not already generated)
2025-11-10T00:08:56.3270641Z      #[serde(default = "default_true")]
2025-11-10T00:08:56.3271090Z      pub generate_before_prune: bool,
2025-11-10T00:08:56.3271831Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:519:
2025-11-10T00:08:56.3272553Z -    
2025-11-10T00:08:56.3273057Z +
2025-11-10T00:08:56.3273423Z      /// Maximum age for commitments (days, 0 = keep forever)
2025-11-10T00:08:56.3274015Z      #[serde(default = "default_commitment_max_age")]
2025-11-10T00:08:56.3274719Z      pub max_commitment_age_days: u32,
2025-11-10T00:08:56.3275460Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:546:
2025-11-10T00:08:56.3276286Z      /// Keep BIP158 filters for pruned blocks
2025-11-10T00:08:56.3276775Z      #[serde(default = "default_true")]
2025-11-10T00:08:56.3277211Z      pub keep_filters: bool,
2025-11-10T00:08:56.3277581Z -    
2025-11-10T00:08:56.3277841Z +
2025-11-10T00:08:56.3278260Z      /// Keep filter header chain (always required for verification)
2025-11-10T00:08:56.3278858Z      #[serde(default = "default_true")]
2025-11-10T00:08:56.3279281Z      pub keep_filter_headers: bool,
2025-11-10T00:08:56.3279969Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:553:
2025-11-10T00:08:56.3280672Z -    
2025-11-10T00:08:56.3280924Z +
2025-11-10T00:08:56.3281268Z      /// Maximum age for filters (days, 0 = keep forever)
2025-11-10T00:08:56.3281814Z      #[serde(default = "default_filter_max_age")]
2025-11-10T00:08:56.3282293Z      pub max_filter_age_days: u32,
2025-11-10T00:08:56.3283025Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:578:
2025-11-10T00:08:56.3283784Z      /// Database backend selection
2025-11-10T00:08:56.3284258Z      #[serde(default = "default_database_backend")]
2025-11-10T00:08:56.3285030Z      pub database_backend: DatabaseBackendConfig,
2025-11-10T00:08:56.3285489Z -    
2025-11-10T00:08:56.3285748Z +
2025-11-10T00:08:56.3286038Z      /// Storage path
2025-11-10T00:08:56.3286697Z      #[serde(default = "default_storage_path")]
2025-11-10T00:08:56.3287184Z      pub data_dir: String,
2025-11-10T00:08:56.3287873Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:585:
2025-11-10T00:08:56.3288599Z -    
2025-11-10T00:08:56.3288872Z +
2025-11-10T00:08:56.3289157Z      /// Pruning configuration
2025-11-10T00:08:56.3289581Z      pub pruning: Option<PruningConfig>,
2025-11-10T00:08:56.3289999Z -    
2025-11-10T00:08:56.3290261Z +
2025-11-10T00:08:56.3290515Z      /// Cache sizes
2025-11-10T00:08:56.3290890Z      pub cache: Option<StorageCacheConfig>,
2025-11-10T00:08:56.3291311Z  }
2025-11-10T00:08:56.3291907Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:616:
2025-11-10T00:08:56.3292656Z      /// Block cache size (MB)
2025-11-10T00:08:56.3293084Z      #[serde(default = "default_block_cache_mb")]
2025-11-10T00:08:56.3293570Z      pub block_cache_mb: usize,
2025-11-10T00:08:56.3294169Z -    
2025-11-10T00:08:56.3294620Z +
2025-11-10T00:08:56.3294883Z      /// UTXO cache size (MB)
2025-11-10T00:08:56.3295280Z      #[serde(default = "default_utxo_cache_mb")]
2025-11-10T00:08:56.3295749Z      pub utxo_cache_mb: usize,
2025-11-10T00:08:56.3297993Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:623:
2025-11-10T00:08:56.3298716Z -    
2025-11-10T00:08:56.3298975Z +
2025-11-10T00:08:56.3299245Z      /// Header cache size (MB)
2025-11-10T00:08:56.3299652Z      #[serde(default = "default_header_cache_mb")]
2025-11-10T00:08:56.3300133Z      pub header_cache_mb: usize,
2025-11-10T00:08:56.3300835Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:668:
2025-11-10T00:08:56.3301670Z                  pruning.validate()?;
2025-11-10T00:08:56.3302083Z              }
2025-11-10T00:08:56.3302388Z          }
2025-11-10T00:08:56.3302653Z -        
2025-11-10T00:08:56.3302927Z +
2025-11-10T00:08:56.3303190Z          Ok(())
2025-11-10T00:08:56.3303494Z      }
2025-11-10T00:08:56.3303756Z  }
2025-11-10T00:08:56.3304523Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:686:
2025-11-10T00:08:56.3305268Z                  ));
2025-11-10T00:08:56.3305573Z              }
2025-11-10T00:08:56.3305857Z          }
2025-11-10T00:08:56.3306123Z -        
2025-11-10T00:08:56.3306386Z +
2025-11-10T00:08:56.3306705Z          // Validate min_blocks_to_keep is reasonable
2025-11-10T00:08:56.3307193Z          if self.min_blocks_to_keep == 0 {
2025-11-10T00:08:56.3314047Z              return Err(anyhow::anyhow!(
2025-11-10T00:08:56.3315053Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:693:
2025-11-10T00:08:56.3315905Z                  "min_blocks_to_keep must be greater than 0 for safety"
2025-11-10T00:08:56.3316425Z              ));
2025-11-10T00:08:56.3316720Z          }
2025-11-10T00:08:56.3317003Z -        
2025-11-10T00:08:56.3317287Z +
2025-11-10T00:08:56.3317597Z          // Validate auto_prune_interval
2025-11-10T00:08:56.3318136Z          if self.auto_prune && self.auto_prune_interval == 0 {
2025-11-10T00:08:56.3318692Z              return Err(anyhow::anyhow!(
2025-11-10T00:08:56.3319427Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:700:
2025-11-10T00:08:56.3320374Z                  "auto_prune_interval must be greater than 0 when auto_prune is enabled"
2025-11-10T00:08:56.3320978Z              ));
2025-11-10T00:08:56.3321263Z          }
2025-11-10T00:08:56.3321529Z -        
2025-11-10T00:08:56.3321788Z +
2025-11-10T00:08:56.3322098Z          // Validate mode-specific settings
2025-11-10T00:08:56.3322545Z          match &self.mode {
2025-11-10T00:08:56.3323020Z -            PruningMode::Normal { min_recent_blocks, .. } => {
2025-11-10T00:08:56.3323556Z +            PruningMode::Normal {
2025-11-10T00:08:56.3323980Z +                min_recent_blocks, ..
2025-11-10T00:08:56.3324586Z +            } => {
2025-11-10T00:08:56.3324955Z                  if *min_recent_blocks == 0 {
2025-11-10T00:08:56.3325706Z                      return Err(anyhow::anyhow!(
2025-11-10T00:08:56.3326334Z                          "min_recent_blocks must be greater than 0 in Normal pruning mode"
2025-11-10T00:08:56.3327257Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:728:
2025-11-10T00:08:56.3328013Z                  // No validation needed
2025-11-10T00:08:56.3328426Z              }
2025-11-10T00:08:56.3328706Z          }
2025-11-10T00:08:56.3328976Z -        
2025-11-10T00:08:56.3329241Z +
2025-11-10T00:08:56.3329501Z          Ok(())
2025-11-10T00:08:56.3329778Z      }
2025-11-10T00:08:56.3330026Z  }
2025-11-10T00:08:56.3330619Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/lib.rs:25:
2025-11-10T00:08:56.3331319Z  #[global_allocator]
2025-11-10T00:08:56.3331776Z  static GLOBAL: mimalloc::MiMalloc = mimalloc::MiMalloc;
2025-11-10T00:08:56.3332731Z  
2025-11-10T00:08:56.3333300Z -pub mod storage;
2025-11-10T00:08:56.3333651Z +pub mod bip21;
2025-11-10T00:08:56.3333945Z +pub mod config;
2025-11-10T00:08:56.3334243Z +pub mod module;
2025-11-10T00:08:56.3334717Z  pub mod network;
2025-11-10T00:08:56.3335038Z -pub mod rpc;
2025-11-10T00:08:56.3335324Z  pub mod node;
2025-11-10T00:08:56.3335630Z -pub mod config;
2025-11-10T00:08:56.3335912Z +pub mod rpc;
2025-11-10T00:08:56.3336173Z +pub mod storage;
2025-11-10T00:08:56.3338353Z  #[cfg(feature = "production")]
2025-11-10T00:08:56.3338697Z  pub mod validation;
2025-11-10T00:08:56.3338994Z -pub mod module;
2025-11-10T00:08:56.3339262Z -pub mod bip21;
2025-11-10T00:08:56.3339525Z  
2025-11-10T00:08:56.3339793Z  // Re-export config module
2025-11-10T00:08:56.3340156Z  pub use config::*;
2025-11-10T00:08:56.3340697Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/lib.rs:40:
2025-11-10T00:08:56.3341312Z  
2025-11-10T00:08:56.3341631Z  // Re-export commonly used types from protocol-engine
2025-11-10T00:08:56.3342402Z  // This allows depending only on protocol-engine (which transitively provides consensus-proof)
2025-11-10T00:08:56.3343172Z +pub use bllvm_protocol::mempool::Mempool;
2025-11-10T00:08:56.3343625Z  pub use bllvm_protocol::{
2025-11-10T00:08:56.3346247Z -    Block, BlockHeader, Transaction, TransactionInput, TransactionOutput,
2025-11-10T00:08:56.3347149Z -    OutPoint, UTXO, UtxoSet, ValidationResult, Hash, ByteString, Natural, Integer,
2025-11-10T00:08:56.3347933Z -    ConsensusError, Result,
2025-11-10T00:08:56.3348621Z +    Block, BlockHeader, ByteString, ConsensusError, Hash, Integer, Natural, OutPoint, Result,
2025-11-10T00:08:56.3349660Z +    Transaction, TransactionInput, TransactionOutput, UtxoSet, ValidationResult, UTXO,
2025-11-10T00:08:56.3350346Z  };
2025-11-10T00:08:56.3350657Z -pub use bllvm_protocol::mempool::Mempool;
2025-11-10T00:08:56.3351098Z  
2025-11-10T00:08:56.3351393Z  // Re-export protocol-engine types
2025-11-10T00:08:56.3351990Z  pub use bllvm_protocol::{BitcoinProtocolEngine, ProtocolVersion};
2025-11-10T00:08:56.3353235Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/lib.rs:81:
2025-11-10T00:08:56.3354072Z          // Test that protocol-engine works in reference-node context
2025-11-10T00:08:56.3357247Z          let node = ReferenceNode::new(Some(ProtocolVersion::Regtest)).unwrap();
2025-11-10T00:08:56.3357846Z          let protocol = node.protocol();
2025-11-10T00:08:56.3358231Z -        
2025-11-10T00:08:56.3358464Z +
2025-11-10T00:08:56.3358728Z          // Verify protocol version
2025-11-10T00:08:56.3359287Z          assert_eq!(protocol.get_protocol_version(), ProtocolVersion::Regtest);
2025-11-10T00:08:56.3359871Z -        
2025-11-10T00:08:56.3360112Z +
2025-11-10T00:08:56.3360364Z          // Test feature support
2025-11-10T00:08:56.3360789Z          assert!(protocol.supports_feature("fast_mining"));
2025-11-10T00:08:56.3361232Z      }
2025-11-10T00:08:56.3361731Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/lib.rs:94:
2025-11-10T00:08:56.3362548Z          // Test consensus validation through protocol-engine
2025-11-10T00:08:56.3363492Z          let node = ReferenceNode::new(None).unwrap(); // Uses default Regtest
2025-11-10T00:08:56.3364073Z          let protocol = node.protocol();
2025-11-10T00:08:56.3364598Z -        
2025-11-10T00:08:56.3364834Z +
2025-11-10T00:08:56.3365109Z          // Create a simple transaction
2025-11-10T00:08:56.3367168Z          let tx = Transaction {
2025-11-10T00:08:56.3367508Z              version: 1,
2025-11-10T00:08:56.3368076Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/lib.rs:105:
2025-11-10T00:08:56.3368756Z              }],
2025-11-10T00:08:56.3369074Z              lock_time: 0,
2025-11-10T00:08:56.3369413Z          };
2025-11-10T00:08:56.3369687Z -        
2025-11-10T00:08:56.3369944Z +
2025-11-10T00:08:56.3370243Z          // Test transaction validation
2025-11-10T00:08:56.3370745Z          let result = protocol.validate_transaction(&tx);
2025-11-10T00:08:56.3371519Z          assert!(result.is_ok());
2025-11-10T00:08:56.3372201Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/lib.rs:115:
2025-11-10T00:08:56.3373126Z      fn test_reference_node_creation() {
2025-11-10T00:08:56.3373550Z          // Test default (Regtest) creation
2025-11-10T00:08:56.3374004Z          let node = ReferenceNode::new(None).unwrap();
2025-11-10T00:08:56.3374836Z -        assert_eq!(node.protocol().get_protocol_version(), ProtocolVersion::Regtest);
2025-11-10T00:08:56.3375430Z -        
2025-11-10T00:08:56.3375689Z +        assert_eq!(
2025-11-10T00:08:56.3376026Z +            node.protocol().get_protocol_version(),
2025-11-10T00:08:56.3376466Z +            ProtocolVersion::Regtest
2025-11-10T00:08:56.3376845Z +        );
2025-11-10T00:08:56.3377127Z +
2025-11-10T00:08:56.3377403Z          // Test mainnet creation
2025-11-10T00:08:56.3378017Z          let mainnet_node = ReferenceNode::new(Some(ProtocolVersion::BitcoinV1)).unwrap();
2025-11-10T00:08:56.3378934Z -        assert_eq!(mainnet_node.protocol().get_protocol_version(), ProtocolVersion::BitcoinV1);
2025-11-10T00:08:56.3379594Z +        assert_eq!(
2025-11-10T00:08:56.3379991Z +            mainnet_node.protocol().get_protocol_version(),
2025-11-10T00:08:56.3380495Z +            ProtocolVersion::BitcoinV1
2025-11-10T00:08:56.3380907Z +        );
2025-11-10T00:08:56.3381164Z      }
2025-11-10T00:08:56.3381435Z  }
2025-11-10T00:08:56.3381698Z +
2025-11-10T00:08:56.3382322Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/api/hub.rs:81:
2025-11-10T00:08:56.3385139Z              .validate_request(module_id, &request.payload)?;
2025-11-10T00:08:56.3385641Z  
2025-11-10T00:08:56.3386123Z          // Handle handshake specially (no validation needed, just acknowledge)
2025-11-10T00:08:56.3387147Z -        if let RequestPayload::Handshake { module_id: handshake_id, module_name, version } = &request.payload {
2025-11-10T00:08:56.3387996Z +        if let RequestPayload::Handshake {
2025-11-10T00:08:56.3388470Z +            module_id: handshake_id,
2025-11-10T00:08:56.3388896Z +            module_name,
2025-11-10T00:08:56.3389254Z +            version,
2025-11-10T00:08:56.3389586Z +        } = &request.payload
2025-11-10T00:08:56.3389957Z +        {
2025-11-10T00:08:56.3390262Z              // Verify module_id matches
2025-11-10T00:08:56.3390721Z              if handshake_id != module_id {
2025-11-10T00:08:56.3391196Z -                return Err(ModuleError::OperationError(
2025-11-10T00:08:56.3391974Z -                    format!("Handshake module_id mismatch: expected {}, got {}", module_id, handshake_id)
2025-11-10T00:08:56.3392674Z -                ));
2025-11-10T00:08:56.3393089Z +                return Err(ModuleError::OperationError(format!(
2025-11-10T00:08:56.3395692Z +                    "Handshake module_id mismatch: expected {}, got {}",
2025-11-10T00:08:56.3396253Z +                    module_id, handshake_id
2025-11-10T00:08:56.3396661Z +                )));
2025-11-10T00:08:56.3396977Z              }
2025-11-10T00:08:56.3397539Z -            
2025-11-10T00:08:56.3398116Z -            info!("Handshake from module {} (name={}, version={})", module_id, module_name, version);
2025-11-10T00:08:56.3398784Z +
2025-11-10T00:08:56.3399026Z +            info!(
2025-11-10T00:08:56.3399422Z +                "Handshake from module {} (name={}, version={})",
2025-11-10T00:08:56.3399963Z +                module_id, module_name, version
2025-11-10T00:08:56.3400387Z +            );
2025-11-10T00:08:56.3400749Z              return Ok(ResponseMessage::success(
2025-11-10T00:08:56.3401217Z                  request.correlation_id,
2025-11-10T00:08:56.3401692Z                  ResponsePayload::HandshakeAck {
2025-11-10T00:08:56.3402466Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/api/hub.rs:96:
2025-11-10T00:08:56.3403324Z                      node_version: env!("CARGO_PKG_VERSION").to_string(),
2025-11-10T00:08:56.3404063Z -                }
2025-11-10T00:08:56.3406609Z +                },
2025-11-10T00:08:56.3406897Z              ));
2025-11-10T00:08:56.3407162Z          }
2025-11-10T00:08:56.3407415Z  
2025-11-10T00:08:56.3407993Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/api/hub.rs:108:
2025-11-10T00:08:56.3408763Z              RequestPayload::Handshake { .. } => {
2025-11-10T00:08:56.3409279Z                  // Handshake is handled at connection level, not here
2025-11-10T00:08:56.3409902Z                  return Err(crate::module::traits::ModuleError::IpcError(
2025-11-10T00:08:56.3410559Z -                    "Handshake should be handled at connection level".to_string()
2025-11-10T00:08:56.3411262Z +                    "Handshake should be handled at connection level".to_string(),
2025-11-10T00:08:56.3411807Z                  ));
2025-11-10T00:08:56.3412099Z              }
2025-11-10T00:08:56.3412432Z              RequestPayload::GetBlock { hash } => {
2025-11-10T00:08:56.3413227Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/ipc/protocol.rs:76:
2025-11-10T00:08:56.3416073Z  #[derive(Debug, Clone, Serialize, Deserialize)]
2025-11-10T00:08:56.3416539Z  pub enum RequestPayload {
2025-11-10T00:08:56.3417006Z      /// Handshake: Module identifies itself (first message)
2025-11-10T00:08:56.3417707Z -    Handshake { module_id: String, module_name: String, version: String },
2025-11-10T00:08:56.3418300Z -    GetBlock { hash: Hash },
2025-11-10T00:08:56.3418690Z -    GetBlockHeader { hash: Hash },
2025-11-10T00:08:56.3419102Z -    GetTransaction { hash: Hash },
2025-11-10T00:08:56.3419538Z -    HasTransaction { hash: Hash },
2025-11-10T00:08:56.3419929Z +    Handshake {
2025-11-10T00:08:56.3420259Z +        module_id: String,
2025-11-10T00:08:56.3420626Z +        module_name: String,
2025-11-10T00:08:56.3421004Z +        version: String,
2025-11-10T00:08:56.3421337Z +    },
2025-11-10T00:08:56.3421612Z +    GetBlock {
2025-11-10T00:08:56.3422090Z +        hash: Hash,
2025-11-10T00:08:56.3422407Z +    },
2025-11-10T00:08:56.3422690Z +    GetBlockHeader {
2025-11-10T00:08:56.3423022Z +        hash: Hash,
2025-11-10T00:08:56.3423334Z +    },
2025-11-10T00:08:56.3423596Z +    GetTransaction {
2025-11-10T00:08:56.3425964Z +        hash: Hash,
2025-11-10T00:08:56.3426266Z +    },
2025-11-10T00:08:56.3426544Z +    HasTransaction {
2025-11-10T00:08:56.3426870Z +        hash: Hash,
2025-11-10T00:08:56.3427164Z +    },
2025-11-10T00:08:56.3427429Z      GetChainTip,
2025-11-10T00:08:56.3427747Z      GetBlockHeight,
2025-11-10T00:08:56.3428109Z -    GetUtxo { outpoint: OutPoint },
2025-11-10T00:08:56.3428612Z -    SubscribeEvents { event_types: Vec<EventType> },
2025-11-10T00:08:56.3429109Z +    GetUtxo {
2025-11-10T00:08:56.3429419Z +        outpoint: OutPoint,
2025-11-10T00:08:56.3429773Z +    },
2025-11-10T00:08:56.3430045Z +    SubscribeEvents {
2025-11-10T00:08:56.3430411Z +        event_types: Vec<EventType>,
2025-11-10T00:08:56.3430814Z +    },
2025-11-10T00:08:56.3431075Z  }
2025-11-10T00:08:56.3431335Z  
2025-11-10T00:08:56.3431623Z  /// Response message from node to module
2025-11-10T00:08:56.3433151Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/ipc/protocol.rs:100:
2025-11-10T00:08:56.3434024Z  #[derive(Debug, Clone, Serialize, Deserialize)]
2025-11-10T00:08:56.3434682Z  pub enum ResponsePayload {
2025-11-10T00:08:56.3435125Z      /// Handshake acknowledgment with node version
2025-11-10T00:08:56.3435632Z -    HandshakeAck { node_version: String },
2025-11-10T00:08:56.3436066Z +    HandshakeAck {
2025-11-10T00:08:56.3436394Z +        node_version: String,
2025-11-10T00:08:56.3436746Z +    },
2025-11-10T00:08:56.3437020Z      Block(Option<Block>),
2025-11-10T00:08:56.3437427Z      BlockHeader(Option<BlockHeader>),
2025-11-10T00:08:56.3437889Z      Transaction(Option<Transaction>),
2025-11-10T00:08:56.3438736Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/ipc/server.rs:124:
2025-11-10T00:08:56.3439550Z              Some(Ok(bytes)) => {
2025-11-10T00:08:56.3440406Z                  let message: ModuleMessage = bincode::deserialize(bytes.as_ref())
2025-11-10T00:08:56.3441175Z                      .map_err(|e| ModuleError::SerializationError(e.to_string()))?;
2025-11-10T00:08:56.3441727Z -                
2025-11-10T00:08:56.3442031Z +
2025-11-10T00:08:56.3442289Z                  match message {
2025-11-10T00:08:56.3442737Z                      ModuleMessage::Request(request) => {
2025-11-10T00:08:56.3443510Z -                        if let RequestPayload::Handshake { module_id, module_name, version } = request.payload {
2025-11-10T00:08:56.3444881Z +                        if let RequestPayload::Handshake {
2025-11-10T00:08:56.3445378Z +                            module_id,
2025-11-10T00:08:56.3445787Z +                            module_name,
2025-11-10T00:08:56.3446214Z +                            version,
2025-11-10T00:08:56.3446605Z +                        } = request.payload
2025-11-10T00:08:56.3446998Z +                        {
2025-11-10T00:08:56.3447334Z                              info!(
2025-11-10T00:08:56.3447811Z                                  "Module handshake: id={}, name={}, version={}",
2025-11-10T00:08:56.3448363Z                                  module_id, module_name, version
2025-11-10T00:08:56.3449180Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/ipc/server.rs:134:
2025-11-10T00:08:56.3449972Z                              );
2025-11-10T00:08:56.3450326Z -                            
2025-11-10T00:08:56.3450676Z +
2025-11-10T00:08:56.3450988Z                              // Send handshake acknowledgment
2025-11-10T00:08:56.3451505Z                              let ack = ResponseMessage {
2025-11-10T00:08:56.3452022Z                                  correlation_id: request.correlation_id,
2025-11-10T00:08:56.3452864Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/ipc/server.rs:142:
2025-11-10T00:08:56.3453645Z                                  }),
2025-11-10T00:08:56.3454064Z                                  error: None,
2025-11-10T00:08:56.3454674Z                              };
2025-11-10T00:08:56.3455038Z -                            
2025-11-10T00:08:56.3455390Z +
2025-11-10T00:08:56.3455845Z                              let ack_bytes = bincode::serialize(&ModuleMessage::Response(ack))
2025-11-10T00:08:56.3456620Z                                  .map_err(|e| ModuleError::SerializationError(e.to_string()))?;
2025-11-10T00:08:56.3457307Z -                            writer.send(bytes::Bytes::from(ack_bytes)).await
2025-11-10T00:08:56.3458097Z -                                .map_err(|e| ModuleError::IpcError(format!("Failed to send handshake ack: {}", e)))?;
2025-11-10T00:08:56.3458793Z -                            
2025-11-10T00:08:56.3459155Z +                            writer
2025-11-10T00:08:56.3459598Z +                                .send(bytes::Bytes::from(ack_bytes))
2025-11-10T00:08:56.3460060Z +                                .await
2025-11-10T00:08:56.3460496Z +                                .map_err(|e| {
2025-11-10T00:08:56.3461288Z +                                    ModuleError::IpcError(format!(
2025-11-10T00:08:56.3461816Z +                                        "Failed to send handshake ack: {}",
2025-11-10T00:08:56.3462290Z +                                        e
2025-11-10T00:08:56.3462686Z +                                    ))
2025-11-10T00:08:56.3463063Z +                                })?;
2025-11-10T00:08:56.3463442Z +
2025-11-10T00:08:56.3463711Z                              module_id
2025-11-10T00:08:56.3464108Z                          } else {
2025-11-10T00:08:56.3464867Z                              // No handshake - use fallback ID (backward compatibility)
2025-11-10T00:08:56.3465802Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/ipc/server.rs:162:
2025-11-10T00:08:56.3466595Z                      }
2025-11-10T00:08:56.3466921Z                      _ => {
2025-11-10T00:08:56.3478375Z                          return Err(ModuleError::IpcError(
2025-11-10T00:08:56.3479027Z -                            "First message must be a handshake request".to_string()
2025-11-10T00:08:56.3479707Z +                            "First message must be a handshake request".to_string(),
2025-11-10T00:08:56.3480231Z                          ));
2025-11-10T00:08:56.3480590Z                      }
2025-11-10T00:08:56.3480908Z                  }
2025-11-10T00:08:56.3481571Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/ipc/server.rs:169:
2025-11-10T00:08:56.3482342Z              }
2025-11-10T00:08:56.3482652Z              Some(Err(e)) => {
2025-11-10T00:08:56.3483309Z -                return Err(ModuleError::IpcError(format!("Failed to read handshake: {}", e)));
2025-11-10T00:08:56.3484059Z +                return Err(ModuleError::IpcError(format!(
2025-11-10T00:08:56.3484783Z +                    "Failed to read handshake: {}",
2025-11-10T00:08:56.3485239Z +                    e
2025-11-10T00:08:56.3485580Z +                )));
2025-11-10T00:08:56.3485897Z              }
2025-11-10T00:08:56.3486180Z              None => {
2025-11-10T00:08:56.3486817Z -                return Err(ModuleError::IpcError("Connection closed before handshake".to_string()));
2025-11-10T00:08:56.3487564Z +                return Err(ModuleError::IpcError(
2025-11-10T00:08:56.3488121Z +                    "Connection closed before handshake".to_string(),
2025-11-10T00:08:56.3488618Z +                ));
2025-11-10T00:08:56.3488918Z              }
2025-11-10T00:08:56.3489197Z          };
2025-11-10T00:08:56.3489464Z  
2025-11-10T00:08:56.3490087Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/ipc/server.rs:372:
2025-11-10T00:08:56.3490939Z                  // Handshake is handled at connection level
2025-11-10T00:08:56.3491422Z                  Ok(ResponseMessage::success(
2025-11-10T00:08:56.3491843Z                      request.correlation_id,
2025-11-10T00:08:56.3492550Z -                    ResponsePayload::HandshakeAck { node_version: env!("CARGO_PKG_VERSION").to_string() },
2025-11-10T00:08:56.3493275Z +                    ResponsePayload::HandshakeAck {
2025-11-10T00:08:56.3493777Z +                        node_version: env!("CARGO_PKG_VERSION").to_string(),
2025-11-10T00:08:56.3494245Z +                    },
2025-11-10T00:08:56.3494747Z                  ))
2025-11-10T00:08:56.3495051Z              }
2025-11-10T00:08:56.3495402Z              RequestPayload::GetBlock { hash } => {
2025-11-10T00:08:56.3496221Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/manager.rs:159:
2025-11-10T00:08:56.3497120Z          // This allows both to access the process for different purposes
2025-11-10T00:08:56.3497700Z          use std::sync::Arc;
2025-11-10T00:08:56.3498225Z          let shared_process = Arc::new(tokio::sync::Mutex::new(process));
2025-11-10T00:08:56.3498778Z -        
2025-11-10T00:08:56.3499053Z +
2025-11-10T00:08:56.3499362Z          // Create monitor with shared process
2025-11-10T00:08:56.3500205Z          let monitor = ModuleProcessMonitor::new(self.crash_tx.clone());
2025-11-10T00:08:56.3500856Z          let module_name_clone = module_name.to_string();
2025-11-10T00:08:56.3516964Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:87:
2025-11-10T00:08:56.3517819Z  
2025-11-10T00:08:56.3518112Z              // Check heartbeat via IPC
2025-11-10T00:08:56.3518596Z              if let Some(client) = process.client_mut() {
2025-11-10T00:08:56.3519177Z +                use crate::module::ipc::protocol::MessageType;
2025-11-10T00:08:56.3519777Z                  use crate::module::ipc::protocol::RequestMessage;
2025-11-10T00:08:56.3520376Z                  use crate::module::ipc::protocol::RequestPayload;
2025-11-10T00:08:56.3520959Z -                use crate::module::ipc::protocol::MessageType;
2025-11-10T00:08:56.3521464Z -                
2025-11-10T00:08:56.3521765Z +
2025-11-10T00:08:56.3522413Z                  // Use GetChainTip as a lightweight heartbeat check
2025-11-10T00:08:56.3522991Z                  let heartbeat_request = RequestMessage {
2025-11-10T00:08:56.3525766Z                      correlation_id: 0, // Use 0 for heartbeat (won't match any real request)
2025-11-10T00:08:56.3526809Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:97:
2025-11-10T00:08:56.3527710Z                      request_type: MessageType::GetChainTip,
2025-11-10T00:08:56.3528257Z                      payload: RequestPayload::GetChainTip,
2025-11-10T00:08:56.3528703Z                  };
2025-11-10T00:08:56.3529024Z -                
2025-11-10T00:08:56.3529329Z +
2025-11-10T00:08:56.3529625Z                  // Send heartbeat with timeout
2025-11-10T00:08:56.3530142Z -                let heartbeat_result = tokio::time::timeout(
2025-11-10T00:08:56.3530643Z -                    Duration::from_secs(2),
2025-11-10T00:08:56.3531109Z -                    client.request(heartbeat_request)
2025-11-10T00:08:56.3531577Z -                ).await;
2025-11-10T00:08:56.3531904Z -                
2025-11-10T00:08:56.3532233Z +                let heartbeat_result =
2025-11-10T00:08:56.3532914Z +                    tokio::time::timeout(Duration::from_secs(2), client.request(heartbeat_request))
2025-11-10T00:08:56.3533595Z +                        .await;
2025-11-10T00:08:56.3533954Z +
2025-11-10T00:08:56.3534260Z                  match heartbeat_result {
2025-11-10T00:08:56.3534871Z                      Ok(Ok(_)) => {
2025-11-10T00:08:56.3535342Z                          // Heartbeat successful - module is responsive
2025-11-10T00:08:56.3536228Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:120:
2025-11-10T00:08:56.3537035Z                  }
2025-11-10T00:08:56.3537330Z              } else {
2025-11-10T00:08:56.3537736Z                  // No IPC client available - can't check heartbeat
2025-11-10T00:08:56.3538400Z -                debug!("Module {} has no IPC client for heartbeat check", module_name);
2025-11-10T00:08:56.3539019Z +                debug!(
2025-11-10T00:08:56.3539464Z +                    "Module {} has no IPC client for heartbeat check",
2025-11-10T00:08:56.3539976Z +                    module_name
2025-11-10T00:08:56.3540355Z +                );
2025-11-10T00:08:56.3540653Z              }
2025-11-10T00:08:56.3540946Z -            
2025-11-10T00:08:56.3541224Z +
2025-11-10T00:08:56.3541540Z              // Loop continues to next iteration
2025-11-10T00:08:56.3541985Z          }
2025-11-10T00:08:56.3542268Z      }
2025-11-10T00:08:56.3544876Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:145:
2025-11-10T00:08:56.3545789Z                  let mut process_guard = shared_process.lock().await;
2025-11-10T00:08:56.3546306Z                  process_guard.is_running()
2025-11-10T00:08:56.3546711Z              };
2025-11-10T00:08:56.3546996Z -            
2025-11-10T00:08:56.3547271Z +
2025-11-10T00:08:56.3547539Z              if !is_running {
2025-11-10T00:08:56.3548219Z                  // Process exited, check exit status
2025-11-10T00:08:56.3548708Z                  let exit_status = {
2025-11-10T00:08:56.3550108Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:152:
2025-11-10T00:08:56.3551095Z                      let mut process_guard = shared_process.lock().await;
2025-11-10T00:08:56.3553258Z                      process_guard.wait().await?
2025-11-10T00:08:56.3553681Z                  };
2025-11-10T00:08:56.3553983Z -                
2025-11-10T00:08:56.3554453Z +
2025-11-10T00:08:56.3554752Z                  match exit_status {
2025-11-10T00:08:56.3555167Z                      Some(status) => {
2025-11-10T00:08:56.3555598Z                          if status.success() {
2025-11-10T00:08:56.3556418Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:182:
2025-11-10T00:08:56.3557491Z              {
2025-11-10T00:08:56.3557924Z                  let mut process_guard = shared_process.lock().await;
2025-11-10T00:08:56.3558533Z                  if let Some(client) = process_guard.client_mut() {
2025-11-10T00:08:56.3559138Z +                    use crate::module::ipc::protocol::MessageType;
2025-11-10T00:08:56.3559731Z                      use crate::module::ipc::protocol::RequestMessage;
2025-11-10T00:08:56.3560448Z                      use crate::module::ipc::protocol::RequestPayload;
2025-11-10T00:08:56.3561040Z -                    use crate::module::ipc::protocol::MessageType;
2025-11-10T00:08:56.3561537Z -                    
2025-11-10T00:08:56.3561845Z +
2025-11-10T00:08:56.3562187Z                      // Use GetChainTip as a lightweight heartbeat check
2025-11-10T00:08:56.3562750Z                      let heartbeat_request = RequestMessage {
2025-11-10T00:08:56.3565588Z                          correlation_id: 0, // Use 0 for heartbeat (won't match any real request)
2025-11-10T00:08:56.3566629Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:192:
2025-11-10T00:08:56.3567560Z                          request_type: MessageType::GetChainTip,
2025-11-10T00:08:56.3568106Z                          payload: RequestPayload::GetChainTip,
2025-11-10T00:08:56.3568573Z                      };
2025-11-10T00:08:56.3568886Z -                    
2025-11-10T00:08:56.3569189Z +
2025-11-10T00:08:56.3569489Z                      // Send heartbeat with timeout
2025-11-10T00:08:56.3570000Z                      let heartbeat_result = tokio::time::timeout(
2025-11-10T00:08:56.3570514Z                          Duration::from_secs(2),
2025-11-10T00:08:56.3571337Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:199:
2025-11-10T00:08:56.3574595Z -                        client.request(heartbeat_request)
2025-11-10T00:08:56.3575060Z -                    ).await;
2025-11-10T00:08:56.3575517Z -                    
2025-11-10T00:08:56.3575905Z +                        client.request(heartbeat_request),
2025-11-10T00:08:56.3576353Z +                    )
2025-11-10T00:08:56.3576677Z +                    .await;
2025-11-10T00:08:56.3577013Z +
2025-11-10T00:08:56.3577311Z                      match heartbeat_result {
2025-11-10T00:08:56.3578199Z                          Ok(Ok(_)) => {
2025-11-10T00:08:56.3579095Z                              // Heartbeat successful - module is responsive
2025-11-10T00:08:56.3580344Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:215:
2025-11-10T00:08:56.3581170Z                      }
2025-11-10T00:08:56.3581496Z                  } else {
2025-11-10T00:08:56.3581916Z                      // No IPC client available - can't check heartbeat
2025-11-10T00:08:56.3582600Z -                    debug!("Module {} has no IPC client for heartbeat check", module_name);
2025-11-10T00:08:56.3585071Z +                    debug!(
2025-11-10T00:08:56.3585950Z +                        "Module {} has no IPC client for heartbeat check",
2025-11-10T00:08:56.3586741Z +                        module_name
2025-11-10T00:08:56.3587138Z +                    );
2025-11-10T00:08:56.3587445Z                  }
2025-11-10T00:08:56.3587744Z              }
2025-11-10T00:08:56.3588036Z -            
2025-11-10T00:08:56.3588314Z +
2025-11-10T00:08:56.3588629Z              // Loop continues to next iteration
2025-11-10T00:08:56.3589054Z          }
2025-11-10T00:08:56.3589325Z      }
2025-11-10T00:08:56.3590011Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:229:
2025-11-10T00:08:56.3591418Z              ModuleHealth::Crashed("Process exited".to_string())
2025-11-10T00:08:56.3592025Z          } else if let Some(client) = process.client_mut() {
2025-11-10T00:08:56.3592554Z              // Check heartbeat via IPC with short timeout
2025-11-10T00:08:56.3593253Z -            use crate::module::ipc::protocol::{RequestMessage, RequestPayload, MessageType};
2025-11-10T00:08:56.3594566Z +            use crate::module::ipc::protocol::{MessageType, RequestMessage, RequestPayload};
2025-11-10T00:08:56.3595271Z              use tokio::time::timeout;
2025-11-10T00:08:56.3595671Z -            
2025-11-10T00:08:56.3595967Z +
2025-11-10T00:08:56.3596299Z              let heartbeat_request = RequestMessage {
2025-11-10T00:08:56.3596791Z                  correlation_id: 0,
2025-11-10T00:08:56.3597247Z                  request_type: MessageType::GetChainTip,
2025-11-10T00:08:56.3598116Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:238:
2025-11-10T00:08:56.3598991Z                  payload: RequestPayload::GetChainTip,
2025-11-10T00:08:56.3599421Z              };
2025-11-10T00:08:56.3599709Z -            
2025-11-10T00:08:56.3599971Z +
2025-11-10T00:08:56.3600376Z              // Use tokio::runtime::Handle to run async code in sync context
2025-11-10T00:08:56.3601141Z              // This is a simplified check - in production would use proper async context
2025-11-10T00:08:56.3601857Z              match tokio::runtime::Handle::try_current() {
2025-11-10T00:08:56.3602729Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:244:
2025-11-10T00:08:56.3603529Z                  Ok(handle) => {
2025-11-10T00:08:56.3603946Z                      let result = handle.block_on(timeout(
2025-11-10T00:08:56.3604608Z                          Duration::from_secs(1),
2025-11-10T00:08:56.3605098Z -                        client.request(heartbeat_request)
2025-11-10T00:08:56.3605612Z +                        client.request(heartbeat_request),
2025-11-10T00:08:56.3607437Z                      ));
2025-11-10T00:08:56.3607758Z -                    
2025-11-10T00:08:56.3608056Z +
2025-11-10T00:08:56.3608325Z                      match result {
2025-11-10T00:08:56.3608765Z                          Ok(Ok(_)) => ModuleHealth::Healthy,
2025-11-10T00:08:56.3609276Z                          _ => ModuleHealth::Unresponsive,
2025-11-10T00:08:56.3654010Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/sandbox/process.rs:99:
2025-11-10T00:08:56.3655174Z                  if let Some(max_memory) = limits.max_memory_bytes {
2025-11-10T00:08:56.3655745Z                      let soft_limit = max_memory as u64;
2025-11-10T00:08:56.3656244Z                      let hard_limit = max_memory as u64;
2025-11-10T00:08:56.3656841Z -                    setrlimit(Resource::RLIMIT_AS, soft_limit, hard_limit)
2025-11-10T00:08:56.3657403Z -                        .map_err(|e| {
2025-11-10T00:08:56.3657899Z -                            ModuleError::OperationError(format!(
2025-11-10T00:08:56.3658428Z -                                "Failed to set memory limit: {}",
2025-11-10T00:08:56.3658905Z -                                e
2025-11-10T00:08:56.3659294Z -                            ))
2025-11-10T00:08:56.3659651Z -                        })?;
2025-11-10T00:08:56.3660248Z +                    setrlimit(Resource::RLIMIT_AS, soft_limit, hard_limit).map_err(|e| {
2025-11-10T00:08:56.3661444Z +                        ModuleError::OperationError(format!("Failed to set memory limit: {}", e))
2025-11-10T00:08:56.3662107Z +                    })?;
2025-11-10T00:08:56.3662529Z                      debug!("Set memory limit: {} bytes", max_memory);
2025-11-10T00:08:56.3662995Z                  }
2025-11-10T00:08:56.3663268Z  
2025-11-10T00:08:56.3666124Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/sandbox/process.rs:116:
2025-11-10T00:08:56.3666965Z                      #[cfg(feature = "nix")]
2025-11-10T00:08:56.3667355Z                      {
2025-11-10T00:08:56.3667747Z                          use nix::sys::resource::{setrlimit, Resource};
2025-11-10T00:08:56.3668372Z -                        setrlimit(Resource::RLIMIT_NOFILE, soft_limit, hard_limit)
2025-11-10T00:08:56.3668951Z -                            .map_err(|e| {
2025-11-10T00:08:56.3669821Z +                        setrlimit(Resource::RLIMIT_NOFILE, soft_limit, hard_limit).map_err(
2025-11-10T00:08:56.3670473Z +                            |e| {
2025-11-10T00:08:56.3670941Z                                  ModuleError::OperationError(format!(
2025-11-10T00:08:56.3671946Z                                      "Failed to set file descriptor limit: {}",
2025-11-10T00:08:56.3672472Z                                      e
2025-11-10T00:08:56.3675416Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/sandbox/process.rs:124:
2025-11-10T00:08:56.3676271Z                                  ))
2025-11-10T00:08:56.3676657Z -                            })?;
2025-11-10T00:08:56.3677036Z +                            },
2025-11-10T00:08:56.3677402Z +                        )?;
2025-11-10T00:08:56.3677748Z                      }
2025-11-10T00:08:56.3678106Z                      #[cfg(not(feature = "nix"))]
2025-11-10T00:08:56.3678528Z                      {
2025-11-10T00:08:56.3679261Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/sandbox/process.rs:139:
2025-11-10T00:08:56.3680101Z                      #[cfg(feature = "nix")]
2025-11-10T00:08:56.3680563Z                      let hard_limit = max_children as u64;
2025-11-10T00:08:56.3681031Z                      #[cfg(feature = "nix")]
2025-11-10T00:08:56.3681596Z -                    setrlimit(Resource::RLIMIT_NPROC, soft_limit, hard_limit)
2025-11-10T00:08:56.3682168Z -                        .map_err(|e| {
2025-11-10T00:08:56.3682647Z -                            ModuleError::OperationError(format!(
2025-11-10T00:08:56.3683164Z -                                "Failed to set process limit: {}",
2025-11-10T00:08:56.3685517Z -                                e
2025-11-10T00:08:56.3685903Z -                            ))
2025-11-10T00:08:56.3686258Z -                        })?;
2025-11-10T00:08:56.3686840Z +                    setrlimit(Resource::RLIMIT_NPROC, soft_limit, hard_limit).map_err(|e| {
2025-11-10T00:08:56.3687758Z +                        ModuleError::OperationError(format!("Failed to set process limit: {}", e))
2025-11-10T00:08:56.3688438Z +                    })?;
2025-11-10T00:08:56.3688863Z                      debug!("Set process limit: {}", max_children);
2025-11-10T00:08:56.3689325Z                  }
2025-11-10T00:08:56.3689626Z  
2025-11-10T00:08:56.3690297Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/sandbox/process.rs:191:
2025-11-10T00:08:56.3691207Z                          // Field 23 (index 22): rss - Resident Set Size (pages)
2025-11-10T00:08:56.3691905Z                          let utime: u64 = fields.get(13).and_then(|s| s.parse().ok()).unwrap_or(0);
2025-11-10T00:08:56.3692795Z                          let stime: u64 = fields.get(14).and_then(|s| s.parse().ok()).unwrap_or(0);
2025-11-10T00:08:56.3693596Z -                        let rss_pages: u64 = fields.get(22).and_then(|s| s.parse().ok()).unwrap_or(0);
2025-11-10T00:08:56.3696040Z +                        let rss_pages: u64 =
2025-11-10T00:08:56.3696838Z +                            fields.get(22).and_then(|s| s.parse().ok()).unwrap_or(0);
2025-11-10T00:08:56.3697368Z  
2025-11-10T00:08:56.3697730Z                          // Get page size (typically 4096 bytes on Linux)
2025-11-10T00:08:56.3698255Z                          #[cfg(feature = "libc")]
2025-11-10T00:08:56.3699152Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/security/validator.rs:155:
2025-11-10T00:08:56.3700109Z          let mut limiters = self.rate_limiters.lock().unwrap();
2025-11-10T00:08:56.3700602Z  
2025-11-10T00:08:56.3700938Z          // Get or create rate limiter for this module
2025-11-10T00:08:56.3701412Z -        let limiter = limiters
2025-11-10T00:08:56.3701826Z -            .entry(module_id.to_string())
2025-11-10T00:08:56.3702268Z -            .or_insert_with(|| {
2025-11-10T00:08:56.3702895Z -                RateLimiter::new(self.max_requests_per_second, self.time_window_seconds)
2025-11-10T00:08:56.3705838Z -            });
2025-11-10T00:08:56.3706373Z +        let limiter = limiters.entry(module_id.to_string()).or_insert_with(|| {
2025-11-10T00:08:56.3707218Z +            RateLimiter::new(self.max_requests_per_second, self.time_window_seconds)
2025-11-10T00:08:56.3707839Z +        });
2025-11-10T00:08:56.3708130Z  
2025-11-10T00:08:56.3708402Z          // Check rate limit
2025-11-10T00:08:56.3709071Z          if !limiter.check_rate_limit(self.max_requests_per_second, self.time_window_seconds) {
2025-11-10T00:08:56.3782921Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:104:
2025-11-10T00:08:56.3783964Z      pub fn add_address(&mut self, addr: NetworkAddress, services: u64) {
2025-11-10T00:08:56.3784787Z          // Convert NetworkAddress to SocketAddr for key
2025-11-10T00:08:56.3785366Z          let socket_addr = self.network_addr_to_socket(&addr);
2025-11-10T00:08:56.3785859Z -        
2025-11-10T00:08:56.3786137Z +
2025-11-10T00:08:56.3786472Z          match self.addresses.get_mut(&socket_addr) {
2025-11-10T00:08:56.3786977Z              Some(entry) => {
2025-11-10T00:08:56.3787403Z                  // Update existing entry
2025-11-10T00:08:56.3788205Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:116:
2025-11-10T00:08:56.3789094Z                  if self.addresses.len() >= self.max_addresses {
2025-11-10T00:08:56.3789610Z                      self.evict_oldest();
2025-11-10T00:08:56.3790026Z                  }
2025-11-10T00:08:56.3790577Z -                self.addresses.insert(socket_addr, AddressEntry::new(addr, services));
2025-11-10T00:08:56.3791218Z +                self.addresses
2025-11-10T00:08:56.3791688Z +                    .insert(socket_addr, AddressEntry::new(addr, services));
2025-11-10T00:08:56.3792212Z              }
2025-11-10T00:08:56.3792490Z          }
2025-11-10T00:08:56.3792729Z      }
2025-11-10T00:08:56.3793331Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:136:
2025-11-10T00:08:56.3794200Z              .filter(|entry| entry.is_fresh(self.expiration_seconds))
2025-11-10T00:08:56.3794939Z              .map(|entry| entry.addr.clone())
2025-11-10T00:08:56.3795370Z              .collect();
2025-11-10T00:08:56.3795713Z -        
2025-11-10T00:08:56.3796078Z +
2025-11-10T00:08:56.3796399Z          // Sort by last_seen (most recent first)
2025-11-10T00:08:56.3796857Z          fresh.sort_by_key(|addr| {
2025-11-10T00:08:56.3797334Z              let socket = self.network_addr_to_socket(addr);
2025-11-10T00:08:56.3798198Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:146:
2025-11-10T00:08:56.3798985Z                  .unwrap_or(0)
2025-11-10T00:08:56.3799341Z          });
2025-11-10T00:08:56.3799633Z          fresh.reverse();
2025-11-10T00:08:56.3799961Z -        
2025-11-10T00:08:56.3800228Z +
2025-11-10T00:08:56.3800545Z          fresh.into_iter().take(count).collect()
2025-11-10T00:08:56.3800993Z      }
2025-11-10T00:08:56.3801525Z  
2025-11-10T00:08:56.3802181Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:158:
2025-11-10T00:08:56.3802986Z      /// Remove expired addresses
2025-11-10T00:08:56.3803456Z      pub fn remove_expired(&mut self) -> usize {
2025-11-10T00:08:56.3803962Z          let before = self.addresses.len();
2025-11-10T00:08:56.3804807Z -        self.addresses.retain(|_, entry| entry.is_fresh(self.expiration_seconds));
2025-11-10T00:08:56.3805467Z +        self.addresses
2025-11-10T00:08:56.3805943Z +            .retain(|_, entry| entry.is_fresh(self.expiration_seconds));
2025-11-10T00:08:56.3806525Z          before - self.addresses.len()
2025-11-10T00:08:56.3806912Z      }
2025-11-10T00:08:56.3807164Z  
2025-11-10T00:08:56.3807783Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:196:
2025-11-10T00:08:56.3808607Z                      || ipv4.is_link_local()
2025-11-10T00:08:56.3809287Z                      || ipv4.is_broadcast()
2025-11-10T00:08:56.3809684Z              }
2025-11-10T00:08:56.3810012Z -            IpAddr::V6(ipv6) => {
2025-11-10T00:08:56.3810486Z -                ipv6.is_loopback() || ipv6.is_unspecified()
2025-11-10T00:08:56.3810965Z -            }
2025-11-10T00:08:56.3811418Z +            IpAddr::V6(ipv6) => ipv6.is_loopback() || ipv6.is_unspecified(),
2025-11-10T00:08:56.3811972Z          }
2025-11-10T00:08:56.3812237Z      }
2025-11-10T00:08:56.3812503Z  
2025-11-10T00:08:56.3813147Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:238:
2025-11-10T00:08:56.3816033Z                      ip: [0; 16],
2025-11-10T00:08:56.3816433Z                      port: 0,
2025-11-10T00:08:56.3816791Z                  };
2025-11-10T00:08:56.3817415Z -                self.iroh_addresses.insert(node_id, AddressEntry::new(placeholder_addr, services));
2025-11-10T00:08:56.3818123Z +                self.iroh_addresses
2025-11-10T00:08:56.3818695Z +                    .insert(node_id, AddressEntry::new(placeholder_addr, services));
2025-11-10T00:08:56.3819273Z              }
2025-11-10T00:08:56.3819560Z          }
2025-11-10T00:08:56.3819831Z      }
2025-11-10T00:08:56.3820465Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:252:
2025-11-10T00:08:56.3821387Z              .filter(|(_, entry)| entry.is_fresh(self.expiration_seconds))
2025-11-10T00:08:56.3821959Z              .map(|(node_id, _)| *node_id)
2025-11-10T00:08:56.3822386Z              .collect();
2025-11-10T00:08:56.3823196Z -        
2025-11-10T00:08:56.3823481Z +
2025-11-10T00:08:56.3823792Z          // Sort by last_seen (most recent first)
2025-11-10T00:08:56.3824276Z          fresh.sort_by_key(|node_id| {
2025-11-10T00:08:56.3824900Z              self.iroh_addresses
2025-11-10T00:08:56.3825672Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:261:
2025-11-10T00:08:56.3826482Z                  .unwrap_or(0)
2025-11-10T00:08:56.3826845Z          });
2025-11-10T00:08:56.3827154Z          fresh.reverse();
2025-11-10T00:08:56.3827493Z -        
2025-11-10T00:08:56.3827767Z +
2025-11-10T00:08:56.3828058Z          fresh.into_iter().take(count).collect()
2025-11-10T00:08:56.3828481Z      }
2025-11-10T00:08:56.3828733Z  
2025-11-10T00:08:56.3829385Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:319:
2025-11-10T00:08:56.3830110Z      }
2025-11-10T00:08:56.3830354Z  
2025-11-10T00:08:56.3830642Z      /// Convert NetworkAddress to SocketAddr
2025-11-10T00:08:56.3831036Z -    /// 
2025-11-10T00:08:56.3831291Z +    ///
2025-11-10T00:08:56.3831736Z      /// Note: This is public for use in NetworkManager when connecting to peers.
2025-11-10T00:08:56.3832537Z      pub fn network_addr_to_socket(&self, addr: &NetworkAddress) -> SocketAddr {
2025-11-10T00:08:56.3833150Z          // Convert IPv6 address bytes to SocketAddr
2025-11-10T00:08:56.3833929Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:327:
2025-11-10T00:08:56.3835264Z          let ip = if addr.ip[0..12] == [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0xff, 0xff] {
2025-11-10T00:08:56.3835786Z              // IPv4-mapped IPv6 address
2025-11-10T00:08:56.3836224Z              IpAddr::V4(std::net::Ipv4Addr::new(
2025-11-10T00:08:56.3836695Z -                addr.ip[12], addr.ip[13], addr.ip[14], addr.ip[15],
2025-11-10T00:08:56.3837153Z +                addr.ip[12],
2025-11-10T00:08:56.3837482Z +                addr.ip[13],
2025-11-10T00:08:56.3837840Z +                addr.ip[14],
2025-11-10T00:08:56.3838164Z +                addr.ip[15],
2025-11-10T00:08:56.3838479Z              ))
2025-11-10T00:08:56.3838735Z          } else {
2025-11-10T00:08:56.3839020Z              // Native IPv6
2025-11-10T00:08:56.3840074Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:342:
2025-11-10T00:08:56.3840960Z                  u16::from_be_bytes([addr.ip[14], addr.ip[15]]),
2025-11-10T00:08:56.3841735Z              ];
2025-11-10T00:08:56.3842102Z              IpAddr::V6(std::net::Ipv6Addr::new(
2025-11-10T00:08:56.3842629Z -                segments[0], segments[1], segments[2], segments[3],
2025-11-10T00:08:56.3843214Z -                segments[4], segments[5], segments[6], segments[7],
2025-11-10T00:08:56.3843700Z +                segments[0],
2025-11-10T00:08:56.3844058Z +                segments[1],
2025-11-10T00:08:56.3844606Z +                segments[2],
2025-11-10T00:08:56.3844973Z +                segments[3],
2025-11-10T00:08:56.3845345Z +                segments[4],
2025-11-10T00:08:56.3845712Z +                segments[5],
2025-11-10T00:08:56.3846082Z +                segments[6],
2025-11-10T00:08:56.3846439Z +                segments[7],
2025-11-10T00:08:56.3846790Z              ))
2025-11-10T00:08:56.3847087Z          };
2025-11-10T00:08:56.3847411Z          SocketAddr::new(ip, addr.port)
2025-11-10T00:08:56.3860789Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:406:
2025-11-10T00:08:56.3862191Z          let addr2 = create_test_address("192.168.1.2", 8333);
2025-11-10T00:08:56.3862713Z          db.add_address(addr1.clone(), 1);
2025-11-10T00:08:56.3865183Z          db.add_address(addr2.clone(), 1);
2025-11-10T00:08:56.3865595Z -        
2025-11-10T00:08:56.3865873Z +
2025-11-10T00:08:56.3866187Z          let fresh = db.get_fresh_addresses(10);
2025-11-10T00:08:56.3866640Z          assert_eq!(fresh.len(), 2);
2025-11-10T00:08:56.3867034Z      }
2025-11-10T00:08:56.3867690Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:417:
2025-11-10T00:08:56.3869515Z          let addr = create_test_address("192.168.1.1", 8333);
2025-11-10T00:08:56.3870066Z          db.add_address(addr.clone(), 1);
2025-11-10T00:08:56.3870524Z          assert_eq!(db.len(), 1);
2025-11-10T00:08:56.3870882Z -        
2025-11-10T00:08:56.3871144Z +
2025-11-10T00:08:56.3873559Z          // Wait for expiration
2025-11-10T00:08:56.3874066Z          std::thread::sleep(std::time::Duration::from_secs(2));
2025-11-10T00:08:56.3874763Z -        
2025-11-10T00:08:56.3875038Z +
2025-11-10T00:08:56.3875356Z          let fresh = db.get_fresh_addresses(10);
2025-11-10T00:08:56.3875858Z          assert_eq!(fresh.len(), 0); // Should be expired
2025-11-10T00:08:56.3876300Z      }
2025-11-10T00:08:56.3876920Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:433:
2025-11-10T00:08:56.3877713Z          db.add_address(addr1.clone(), 1);
2025-11-10T00:08:56.3878157Z          db.add_address(addr2.clone(), 1);
2025-11-10T00:08:56.3878595Z          assert_eq!(db.len(), 2);
2025-11-10T00:08:56.3878969Z -        
2025-11-10T00:08:56.3879219Z +
2025-11-10T00:08:56.3879493Z          // Wait for expiration
2025-11-10T00:08:56.3879978Z          std::thread::sleep(std::time::Duration::from_secs(2));
2025-11-10T00:08:56.3880476Z -        
2025-11-10T00:08:56.3880758Z +
2025-11-10T00:08:56.3881068Z          let removed = db.remove_expired();
2025-11-10T00:08:56.3881785Z          assert_eq!(removed, 2);
2025-11-10T00:08:56.3882612Z          assert_eq!(db.len(), 0);
2025-11-10T00:08:56.3885268Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:448:
2025-11-10T00:08:56.3886182Z          let localhost = create_test_address("127.0.0.1", 8333);
2025-11-10T00:08:56.3886794Z          let private = create_test_address("192.168.1.1", 8333);
2025-11-10T00:08:56.3887350Z          let public = create_test_address("8.8.8.8", 8333);
2025-11-10T00:08:56.3887832Z -        
2025-11-10T00:08:56.3888219Z +
2025-11-10T00:08:56.3888522Z          assert!(db.is_local(&localhost));
2025-11-10T00:08:56.3888977Z          assert!(db.is_local(&private));
2025-11-10T00:08:56.3889442Z          assert!(!db.is_local(&public));
2025-11-10T00:08:56.3890241Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:460:
2025-11-10T00:08:56.3891466Z          let addr = create_test_address("192.168.1.1", 8333);
2025-11-10T00:08:56.3892134Z          let socket = SocketAddr::new("192.168.1.1".parse().unwrap(), 8333);
2025-11-10T00:08:56.3892739Z          let mut ban_list = HashMap::new();
2025-11-10T00:08:56.3893177Z -        
2025-11-10T00:08:56.3893444Z +
2025-11-10T00:08:56.3895655Z          // Not banned
2025-11-10T00:08:56.3896039Z          assert!(!db.is_banned(&addr, &ban_list));
2025-11-10T00:08:56.3896492Z -        
2025-11-10T00:08:56.3896769Z +
2025-11-10T00:08:56.3897050Z          // Banned (permanent)
2025-11-10T00:08:56.3897479Z          ban_list.insert(socket, u64::MAX);
2025-11-10T00:08:56.3897951Z          assert!(db.is_banned(&addr, &ban_list));
2025-11-10T00:08:56.3898779Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:470:
2025-11-10T00:08:56.3900049Z -        
2025-11-10T00:08:56.3900343Z +
2025-11-10T00:08:56.3900644Z          // Banned (temporary, not expired)
2025-11-10T00:08:56.3901111Z          ban_list.clear();
2025-11-10T00:08:56.3901542Z          let future_time = std::time::SystemTime::now()
2025-11-10T00:08:56.3902380Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:474:
2025-11-10T00:08:56.3905384Z              .duration_since(std::time::UNIX_EPOCH)
2025-11-10T00:08:56.3905840Z              .unwrap()
2025-11-10T00:08:56.3906162Z -            .as_secs() + 3600;
2025-11-10T00:08:56.3906525Z +            .as_secs()
2025-11-10T00:08:56.3906851Z +            + 3600;
2025-11-10T00:08:56.3907209Z          ban_list.insert(socket, future_time);
2025-11-10T00:08:56.3907705Z          assert!(db.is_banned(&addr, &ban_list));
2025-11-10T00:08:56.3908148Z -        
2025-11-10T00:08:56.3908413Z +
2025-11-10T00:08:56.3908690Z          // Banned (expired)
2025-11-10T00:08:56.3909062Z          ban_list.clear();
2025-11-10T00:08:56.3909489Z          let past_time = std::time::SystemTime::now()
2025-11-10T00:08:56.3910324Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:483:
2025-11-10T00:08:56.3911144Z              .duration_since(std::time::UNIX_EPOCH)
2025-11-10T00:08:56.3911563Z              .unwrap()
2025-11-10T00:08:56.3911879Z -            .as_secs() - 3600;
2025-11-10T00:08:56.3912216Z +            .as_secs()
2025-11-10T00:08:56.3912520Z +            - 3600;
2025-11-10T00:08:56.3912864Z          ban_list.insert(socket, past_time);
2025-11-10T00:08:56.3913338Z          assert!(!db.is_banned(&addr, &ban_list));
2025-11-10T00:08:56.3913762Z      }
2025-11-10T00:08:56.3914560Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:493:
2025-11-10T00:08:56.3915400Z          let local = create_test_address("127.0.0.1", 8333);
2025-11-10T00:08:56.3915963Z          let banned = create_test_address("192.168.1.1", 8333);
2025-11-10T00:08:56.3916533Z          let public = create_test_address("8.8.8.8", 8333);
2025-11-10T00:08:56.3916996Z -        
2025-11-10T00:08:56.3917273Z +
2025-11-10T00:08:56.3918018Z          let socket_banned = SocketAddr::new("192.168.1.1".parse().unwrap(), 8333);
2025-11-10T00:08:56.3918829Z          let socket_connected = SocketAddr::new("8.8.8.8".parse().unwrap(), 8333);
2025-11-10T00:08:56.3919485Z          let mut ban_list = HashMap::new();
2025-11-10T00:08:56.3920285Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:500:
2025-11-10T00:08:56.3921145Z          ban_list.insert(socket_banned, u64::MAX);
2025-11-10T00:08:56.3921678Z          let connected_peers = vec![socket_connected];
2025-11-10T00:08:56.3922140Z -        
2025-11-10T00:08:56.3922425Z +
2025-11-10T00:08:56.3922759Z          let addresses = vec![local, banned, public];
2025-11-10T00:08:56.3923453Z          let filtered = db.filter_addresses(addresses, &ban_list, &connected_peers);
2025-11-10T00:08:56.3924081Z -        
2025-11-10T00:08:56.3924542Z +
2025-11-10T00:08:56.3924903Z          // Should filter out local, banned, and connected
2025-11-10T00:08:56.3925696Z          assert_eq!(filtered.len(), 0);
2025-11-10T00:08:56.3926110Z      }
2025-11-10T00:08:56.3926784Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:513:
2025-11-10T00:08:56.3927638Z          let addr1 = create_test_address("192.168.1.1", 8333);
2025-11-10T00:08:56.3928201Z          let addr2 = create_test_address("192.168.1.2", 8333);
2025-11-10T00:08:56.3928763Z          let addr3 = create_test_address("192.168.1.3", 8333);
2025-11-10T00:08:56.3929219Z -        
2025-11-10T00:08:56.3929495Z +
2025-11-10T00:08:56.3929796Z          db.add_address(addr1.clone(), 1);
2025-11-10T00:08:56.3930263Z          db.add_address(addr2.clone(), 1);
2025-11-10T00:08:56.3930700Z          assert_eq!(db.len(), 2);
2025-11-10T00:08:56.3931476Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:520:
2025-11-10T00:08:56.3932264Z -        
2025-11-10T00:08:56.3932535Z +
2025-11-10T00:08:56.3932854Z          // Adding third should evict oldest
2025-11-10T00:08:56.3933330Z          db.add_address(addr3.clone(), 1);
2025-11-10T00:08:56.3933810Z          assert_eq!(db.len(), 2); // Should still be 2
2025-11-10T00:08:56.3934832Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:528:
2025-11-10T00:08:56.3935660Z      fn test_add_iroh_address() {
2025-11-10T00:08:56.3936095Z          use iroh_net::NodeId;
2025-11-10T00:08:56.3936525Z          let mut db = AddressDatabase::new(100);
2025-11-10T00:08:56.3936962Z -        
2025-11-10T00:08:56.3937226Z +
2025-11-10T00:08:56.3937525Z          // Create a test NodeId (32 bytes)
2025-11-10T00:08:56.3937967Z          let node_id_bytes = [0u8; 32];
2025-11-10T00:08:56.3938498Z          let node_id = NodeId::from_bytes(&node_id_bytes).unwrap();
2025-11-10T00:08:56.3939384Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:535:
2025-11-10T00:08:56.3940152Z -        
2025-11-10T00:08:56.3940435Z +
2025-11-10T00:08:56.3940721Z          db.add_iroh_address(node_id, 1);
2025-11-10T00:08:56.3941180Z          assert_eq!(db.total_count(), 1);
2025-11-10T00:08:56.3941584Z -        
2025-11-10T00:08:56.3941856Z +
2025-11-10T00:08:56.3942221Z          // Add same address again (should update, not duplicate)
2025-11-10T00:08:56.3942775Z          db.add_iroh_address(node_id, 2);
2025-11-10T00:08:56.3943227Z          assert_eq!(db.total_count(), 1);
2025-11-10T00:08:56.3944024Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:546:
2025-11-10T00:08:56.3945030Z      fn test_get_fresh_iroh_addresses() {
2025-11-10T00:08:56.3947392Z          use iroh_net::NodeId;
2025-11-10T00:08:56.3947833Z          let mut db = AddressDatabase::new(100);
2025-11-10T00:08:56.3948276Z -        
2025-11-10T00:08:56.3948549Z +
2025-11-10T00:08:56.3948836Z          let node_id1_bytes = [1u8; 32];
2025-11-10T00:08:56.3949284Z          let node_id2_bytes = [2u8; 32];
2025-11-10T00:08:56.3949840Z          let node_id1 = NodeId::from_bytes(&node_id1_bytes).unwrap();
2025-11-10T00:08:56.3951006Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:553:
2025-11-10T00:08:56.3951929Z          let node_id2 = NodeId::from_bytes(&node_id2_bytes).unwrap();
2025-11-10T00:08:56.3952865Z -        
2025-11-10T00:08:56.3953177Z +
2025-11-10T00:08:56.3953475Z          db.add_iroh_address(node_id1, 1);
2025-11-10T00:08:56.3953938Z          db.add_iroh_address(node_id2, 1);
2025-11-10T00:08:56.3954540Z -        
2025-11-10T00:08:56.3954816Z +
2025-11-10T00:08:56.3955149Z          let fresh = db.get_fresh_iroh_addresses(10);
2025-11-10T00:08:56.3955632Z          assert_eq!(fresh.len(), 2);
2025-11-10T00:08:56.3957963Z      }
2025-11-10T00:08:56.3958604Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:564:
2025-11-10T00:08:56.3959427Z      fn test_total_count_includes_iroh() {
2025-11-10T00:08:56.3960147Z          use iroh_net::NodeId;
2025-11-10T00:08:56.3960585Z          let mut db = AddressDatabase::new(100);
2025-11-10T00:08:56.3961014Z -        
2025-11-10T00:08:56.3961282Z +
2025-11-10T00:08:56.3961568Z          // Add SocketAddr address
2025-11-10T00:08:56.3962032Z          let addr = create_test_address("192.168.1.1", 8333);
2025-11-10T00:08:56.3962173Z          db.add_address(addr, 1);
2025-11-10T00:08:56.3962679Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:571:
2025-11-10T00:08:56.3962836Z          assert_eq!(db.total_count(), 1);
2025-11-10T00:08:56.3962947Z -        
2025-11-10T00:08:56.3963061Z +
2025-11-10T00:08:56.3963190Z          // Add Iroh address
2025-11-10T00:08:56.3963336Z          let node_id_bytes = [0u8; 32];
2025-11-10T00:08:56.3963574Z          let node_id = NodeId::from_bytes(&node_id_bytes).unwrap();
2025-11-10T00:08:56.3965968Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:15:
2025-11-10T00:08:56.3966147Z  /// - Combine reasons from all sources
2025-11-10T00:08:56.3966462Z  pub fn merge_ban_lists(ban_lists: Vec<&BanListMessage>) -> Vec<BanEntry> {
2025-11-10T00:08:56.3966764Z      let mut merged: HashMap<NetworkAddress, BanEntry> = HashMap::new();
2025-11-10T00:08:56.3966868Z -    
2025-11-10T00:08:56.3966967Z +
2025-11-10T00:08:56.3967108Z      for ban_list in ban_lists {
2025-11-10T00:08:56.3967235Z          if !ban_list.is_full {
2025-11-10T00:08:56.3967400Z              continue; // Skip hash-only responses
2025-11-10T00:08:56.3967923Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:22:
2025-11-10T00:08:56.3968049Z          }
2025-11-10T00:08:56.3968153Z -        
2025-11-10T00:08:56.3968253Z +
2025-11-10T00:08:56.3968416Z          for entry in &ban_list.ban_entries {
2025-11-10T00:08:56.3968565Z              let addr = entry.addr.clone();
2025-11-10T00:08:56.3968670Z -            
2025-11-10T00:08:56.3968773Z +
2025-11-10T00:08:56.3968931Z              match merged.get_mut(&addr) {
2025-11-10T00:08:56.3969072Z                  Some(existing) => {
2025-11-10T00:08:56.3969241Z                      // Conflict resolution: use longest ban
2025-11-10T00:08:56.3969753Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:36:
2025-11-10T00:08:56.3969965Z                              existing.unban_timestamp = entry.unban_timestamp;
2025-11-10T00:08:56.3970076Z                          }
2025-11-10T00:08:56.3970190Z                      }
2025-11-10T00:08:56.3970299Z -                    
2025-11-10T00:08:56.3970400Z +
2025-11-10T00:08:56.3970527Z                      // Merge reasons
2025-11-10T00:08:56.3970714Z                      if let Some(ref reason) = entry.reason {
2025-11-10T00:08:56.3970963Z -                        existing.reason = existing.reason.as_ref().map(|r| {
2025-11-10T00:08:56.3971121Z -                            format!("{}; {}", r, reason)
2025-11-10T00:08:56.3971301Z -                        }).or_else(|| Some(reason.clone()));
2025-11-10T00:08:56.3971685Z +                        existing.reason = existing
2025-11-10T00:08:56.3971805Z +                            .reason
2025-11-10T00:08:56.3971922Z +                            .as_ref()
2025-11-10T00:08:56.3972099Z +                            .map(|r| format!("{}; {}", r, reason))
2025-11-10T00:08:56.3972263Z +                            .or_else(|| Some(reason.clone()));
2025-11-10T00:08:56.3972368Z                      }
2025-11-10T00:08:56.3972489Z                  }
2025-11-10T00:08:56.3972886Z                  None => {
2025-11-10T00:08:56.3973435Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:50:
2025-11-10T00:08:56.3973552Z              }
2025-11-10T00:08:56.3973673Z          }
2025-11-10T00:08:56.3975871Z      }
2025-11-10T00:08:56.3975989Z -    
2025-11-10T00:08:56.3976105Z +
2025-11-10T00:08:56.3976253Z      // Convert to sorted vector
2025-11-10T00:08:56.3976814Z      let mut result: Vec<BanEntry> = merged.into_values().collect();
2025-11-10T00:08:56.3976964Z      result.sort_by(|a, b| {
2025-11-10T00:08:56.3977514Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:57:
2025-11-10T00:08:56.3977697Z          // Sort by address for deterministic output
2025-11-10T00:08:56.3977842Z -        a.addr.ip.cmp(&b.addr.ip)
2025-11-10T00:08:56.3977964Z +        a.addr
2025-11-10T00:08:56.3978079Z +            .ip
2025-11-10T00:08:56.3978207Z +            .cmp(&b.addr.ip)
2025-11-10T00:08:56.3978412Z              .then_with(|| a.addr.port.cmp(&b.addr.port))
2025-11-10T00:08:56.3978519Z      });
2025-11-10T00:08:56.3978625Z -    
2025-11-10T00:08:56.3978730Z +
2025-11-10T00:08:56.3978850Z      result
2025-11-10T00:08:56.3978956Z  }
2025-11-10T00:08:56.3979062Z  
2025-11-10T00:08:56.3979590Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:72:
2025-11-10T00:08:56.3979766Z              .duration_since(UNIX_EPOCH)
2025-11-10T00:08:56.3979896Z              .unwrap()
2025-11-10T00:08:56.3980017Z              .as_secs();
2025-11-10T00:08:56.3980133Z -        
2025-11-10T00:08:56.3980242Z +
2025-11-10T00:08:56.3980403Z          if now >= entry.unban_timestamp {
2025-11-10T00:08:56.3980567Z              return false; // Ban already expired
2025-11-10T00:08:56.3980688Z          }
2025-11-10T00:08:56.3981222Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:79:
2025-11-10T00:08:56.3981333Z      }
2025-11-10T00:08:56.3981446Z -    
2025-11-10T00:08:56.3981547Z +
2025-11-10T00:08:56.3981712Z      // Additional validation could include:
2025-11-10T00:08:56.3981860Z      // - IP address format validation
2025-11-10T00:08:56.3982000Z      // - Reason length limits
2025-11-10T00:08:56.3982525Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:84:
2025-11-10T00:08:56.3982644Z      // - etc.
2025-11-10T00:08:56.3982768Z -    
2025-11-10T00:08:56.3982883Z +
2025-11-10T00:08:56.3982995Z      true
2025-11-10T00:08:56.3983099Z  }
2025-11-10T00:08:56.3983213Z  
2025-11-10T00:08:56.3983739Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:89:
2025-11-10T00:08:56.3983923Z  /// Calculate hash of ban list (for verification)
2025-11-10T00:08:56.3984205Z  pub fn calculate_ban_list_hash(entries: &[BanEntry]) -> [u8; 32] {
2025-11-10T00:08:56.3986368Z -    use sha2::{Sha256, Digest};
2025-11-10T00:08:56.3986486Z -    
2025-11-10T00:08:56.3986637Z +    use sha2::{Digest, Sha256};
2025-11-10T00:08:56.3986745Z +
2025-11-10T00:08:56.3986907Z      // Sort entries for deterministic hashing
2025-11-10T00:08:56.3987049Z      let mut sorted = entries.to_vec();
2025-11-10T00:08:56.3987191Z      sorted.sort_by(|a, b| {
2025-11-10T00:08:56.3987720Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:96:
2025-11-10T00:08:56.3987879Z -        a.addr.ip.cmp(&b.addr.ip)
2025-11-10T00:08:56.3988216Z +        a.addr
2025-11-10T00:08:56.3988326Z +            .ip
2025-11-10T00:08:56.3988447Z +            .cmp(&b.addr.ip)
2025-11-10T00:08:56.3988634Z              .then_with(|| a.addr.port.cmp(&b.addr.port))
2025-11-10T00:08:56.3988751Z      });
2025-11-10T00:08:56.3988855Z -    
2025-11-10T00:08:56.3988958Z +
2025-11-10T00:08:56.3989099Z      // Serialize and hash
2025-11-10T00:08:56.3989404Z      let serialized = bincode::serialize(&sorted).unwrap_or_default();
2025-11-10T00:08:56.3989572Z      let hash = Sha256::digest(&serialized);
2025-11-10T00:08:56.3990125Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:103:
2025-11-10T00:08:56.3990243Z -    
2025-11-10T00:08:56.3990349Z +
2025-11-10T00:08:56.3990483Z      let mut result = [0u8; 32];
2025-11-10T00:08:56.3990644Z      result.copy_from_slice(&hash);
2025-11-10T00:08:56.3990756Z      result
2025-11-10T00:08:56.3991543Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:111:
2025-11-10T00:08:56.3991777Z      let calculated = calculate_ban_list_hash(entries);
2025-11-10T00:08:56.3991923Z      calculated == *expected_hash
2025-11-10T00:08:56.3992033Z  }
2025-11-10T00:08:56.3992138Z -
2025-11-10T00:08:56.3992250Z -
2025-11-10T00:08:56.3992350Z -
2025-11-10T00:08:56.3992445Z  
2025-11-10T00:08:56.3992976Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_signing.rs:2:
2025-11-10T00:08:56.3993108Z  //!
2025-11-10T00:08:56.3993413Z  //! Provides functions to sign and verify ban lists for authenticity.
2025-11-10T00:08:56.3993517Z  
2025-11-10T00:08:56.3993779Z -use crate::network::protocol::{BanListMessage, BanEntry};
2025-11-10T00:08:56.3994127Z -use secp256k1::{Secp256k1, Message, ecdsa::Signature, SecretKey, PublicKey};
2025-11-10T00:08:56.3994540Z +use crate::network::protocol::{BanEntry, BanListMessage};
2025-11-10T00:08:56.3994905Z +use secp256k1::{ecdsa::Signature, Message, PublicKey, Secp256k1, SecretKey};
2025-11-10T00:08:56.3995034Z  
2025-11-10T00:08:56.3995192Z  /// Sign a ban list with a private key
2025-11-10T00:08:56.3995299Z  ///
2025-11-10T00:08:56.3995845Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_signing.rs:13:
2025-11-10T00:08:56.3995992Z      private_key: &SecretKey,
2025-11-10T00:08:56.3996156Z  ) -> Result<Vec<u8>, secp256k1::Error> {
2025-11-10T00:08:56.3996310Z      let secp = Secp256k1::new();
2025-11-10T00:08:56.3996419Z -    
2025-11-10T00:08:56.3996529Z +
2025-11-10T00:08:56.3996680Z      // Serialize ban list for signing
2025-11-10T00:08:56.3996886Z -    let serialized = bincode::serialize(ban_list)
2025-11-10T00:08:56.3997085Z -        .map_err(|_| secp256k1::Error::InvalidMessage)?;
2025-11-10T00:08:56.3997196Z -    
2025-11-10T00:08:56.3998075Z +    let serialized = bincode::serialize(ban_list).map_err(|_| secp256k1::Error::InvalidMessage)?;
2025-11-10T00:08:56.3998214Z +
2025-11-10T00:08:56.3998363Z      // Hash the serialized data
2025-11-10T00:08:56.3998509Z -    use sha2::{Sha256, Digest};
2025-11-10T00:08:56.3998653Z +    use sha2::{Digest, Sha256};
2025-11-10T00:08:56.3998819Z      let hash = Sha256::digest(&serialized);
2025-11-10T00:08:56.3998923Z -    
2025-11-10T00:08:56.3999033Z +
2025-11-10T00:08:56.3999170Z      // Create message from hash
2025-11-10T00:08:56.3999342Z -    let message = Message::from_slice(&hash)
2025-11-10T00:08:56.3999550Z -        .map_err(|_| secp256k1::Error::InvalidMessage)?;
2025-11-10T00:08:56.3999660Z -    
2025-11-10T00:08:56.4000056Z +    let message = Message::from_slice(&hash).map_err(|_| secp256k1::Error::InvalidMessage)?;
2025-11-10T00:08:56.4000166Z +
2025-11-10T00:08:56.4000281Z      // Sign
2025-11-10T00:08:56.4000517Z      let signature = secp.sign_ecdsa(&message, private_key);
2025-11-10T00:08:56.4000625Z -    
2025-11-10T00:08:56.4000731Z +
2025-11-10T00:08:56.4000867Z      // Serialize signature
2025-11-10T00:08:56.4001057Z      Ok(signature.serialize_compact().to_vec())
2025-11-10T00:08:56.4001425Z  }
2025-11-10T00:08:56.4001983Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_signing.rs:44:
2025-11-10T00:08:56.4002128Z      if signature.len() != 64 {
2025-11-10T00:08:56.4002258Z          return Ok(false);
2025-11-10T00:08:56.4002372Z      }
2025-11-10T00:08:56.4002470Z -    
2025-11-10T00:08:56.4002564Z +
2025-11-10T00:08:56.4002714Z      let secp = Secp256k1::new();
2025-11-10T00:08:56.4002832Z -    
2025-11-10T00:08:56.4002938Z +
2025-11-10T00:08:56.4003057Z      // Serialize ban list
2025-11-10T00:08:56.4004829Z -    let serialized = bincode::serialize(ban_list)
2025-11-10T00:08:56.4005029Z -        .map_err(|_| secp256k1::Error::InvalidMessage)?;
2025-11-10T00:08:56.4005126Z -    
2025-11-10T00:08:56.4005569Z +    let serialized = bincode::serialize(ban_list).map_err(|_| secp256k1::Error::InvalidMessage)?;
2025-11-10T00:08:56.4005690Z +
2025-11-10T00:08:56.4005836Z      // Hash the serialized data
2025-11-10T00:08:56.4006206Z -    use sha2::{Sha256, Digest};
2025-11-10T00:08:56.4006353Z +    use sha2::{Digest, Sha256};
2025-11-10T00:08:56.4006519Z      let hash = Sha256::digest(&serialized);
2025-11-10T00:08:56.4006627Z -    
2025-11-10T00:08:56.4006737Z +
2025-11-10T00:08:56.4006883Z      // Create message from hash
2025-11-10T00:08:56.4007044Z -    let message = Message::from_slice(&hash)
2025-11-10T00:08:56.4007230Z -        .map_err(|_| secp256k1::Error::InvalidMessage)?;
2025-11-10T00:08:56.4007346Z -    
2025-11-10T00:08:56.4007733Z +    let message = Message::from_slice(&hash).map_err(|_| secp256k1::Error::InvalidMessage)?;
2025-11-10T00:08:56.4007837Z +
2025-11-10T00:08:56.4007969Z      // Parse signature
2025-11-10T00:08:56.4008166Z -    let sig = Signature::from_compact(signature)
2025-11-10T00:08:56.4008372Z -        .map_err(|_| secp256k1::Error::InvalidSignature)?;
2025-11-10T00:08:56.4008479Z -    
2025-11-10T00:08:56.4008923Z +    let sig = Signature::from_compact(signature).map_err(|_| secp256k1::Error::InvalidSignature)?;
2025-11-10T00:08:56.4009049Z +
2025-11-10T00:08:56.4009160Z      // Verify
2025-11-10T00:08:56.4009397Z      Ok(secp.verify_ecdsa(&message, &sig, public_key).is_ok())
2025-11-10T00:08:56.4009514Z  }
2025-11-10T00:08:56.4010056Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_signing.rs:86:
2025-11-10T00:08:56.4010227Z      ) -> Result<Self, secp256k1::Error> {
2025-11-10T00:08:56.4010387Z          let secp = Secp256k1::new();
2025-11-10T00:08:56.4010674Z          let public_key = PublicKey::from_secret_key(&secp, private_key);
2025-11-10T00:08:56.4010787Z -        
2025-11-10T00:08:56.4010902Z +
2025-11-10T00:08:56.4011135Z          let signature = sign_ban_list(&ban_list, private_key)?;
2025-11-10T00:08:56.4011247Z -        
2025-11-10T00:08:56.4011357Z +
2025-11-10T00:08:56.4011484Z          Ok(Self {
2025-11-10T00:08:56.4011603Z              ban_list,
2025-11-10T00:08:56.4011725Z              signature,
2025-11-10T00:08:56.4012282Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_signing.rs:95:
2025-11-10T00:08:56.4012425Z              public_key,
2025-11-10T00:08:56.4012537Z          })
2025-11-10T00:08:56.4012648Z      }
2025-11-10T00:08:56.4012766Z -    
2025-11-10T00:08:56.4012874Z +
2025-11-10T00:08:56.4013012Z      /// Verify the signature
2025-11-10T00:08:56.4013266Z      pub fn verify(&self) -> Result<bool, secp256k1::Error> {
2025-11-10T00:08:56.4013632Z          verify_ban_list_signature(&self.ban_list, &self.signature, &self.public_key)
2025-11-10T00:08:56.4014166Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_signing.rs:102:
2025-11-10T00:08:56.4014280Z      }
2025-11-10T00:08:56.4014544Z  }
2025-11-10T00:08:56.4014655Z -
2025-11-10T00:08:56.4014765Z -
2025-11-10T00:08:56.4014880Z  
2025-11-10T00:08:56.4015393Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:4:
2025-11-10T00:08:56.4015560Z  //! using the BlockFilterService.
2025-11-10T00:08:56.4015927Z  
2025-11-10T00:08:56.4016192Z  use crate::network::filter_service::BlockFilterService;
2025-11-10T00:08:56.4016338Z -use crate::storage::Storage;
2025-11-10T00:08:56.4016480Z  use crate::network::protocol::{
2025-11-10T00:08:56.4016953Z      CfcheckptMessage, CfheadersMessage, CfilterMessage, FilterHeaderData, GetCfcheckptMessage,
2025-11-10T00:08:56.4017219Z      GetCfheadersMessage, GetCfiltersMessage, ProtocolMessage,
2025-11-10T00:08:56.4017726Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:11:
2025-11-10T00:08:56.4017839Z  };
2025-11-10T00:08:56.4017971Z +use crate::storage::Storage;
2025-11-10T00:08:56.4018105Z  use anyhow::{anyhow, Result};
2025-11-10T00:08:56.4018235Z  use bllvm_protocol::Hash;
2025-11-10T00:08:56.4018358Z  use std::sync::Arc;
2025-11-10T00:08:56.4018841Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:30:
2025-11-10T00:08:56.4019248Z          // Get current height to determine stop height
2025-11-10T00:08:56.4019566Z          let current_height = storage.chain().get_height()?.unwrap_or(0) as u32;
2025-11-10T00:08:56.4019733Z          let start_height = request.start_height;
2025-11-10T00:08:56.4019856Z -        
2025-11-10T00:08:56.4019972Z +
2025-11-10T00:08:56.4020249Z          // Find stop height by iterating from start until we find stop_hash
2025-11-10T00:08:56.4020404Z          let mut stop_height = start_height;
2025-11-10T00:08:56.4020541Z          let mut found_stop = false;
2025-11-10T00:08:56.4021039Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:37:
2025-11-10T00:08:56.4021143Z -        
2025-11-10T00:08:56.4021241Z +
2025-11-10T00:08:56.4021412Z          // Iterate through blocks from start_height
2025-11-10T00:08:56.4021701Z          for height in start_height..=current_height.min(start_height + 2000) {
2025-11-10T00:08:56.4021875Z              // Get block hash by height, then get block
2025-11-10T00:08:56.4022377Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:41:
2025-11-10T00:08:56.4022705Z              if let Ok(Some(block_hash)) = storage.blocks().get_hash_by_height(height as u64) {
2025-11-10T00:08:56.4022955Z                  if let Ok(Some(block)) = storage.blocks().get_block(&block_hash) {
2025-11-10T00:08:56.4023070Z -                
2025-11-10T00:08:56.4023229Z                      // Calculate block hash properly
2025-11-10T00:08:56.4023414Z                      use crate::storage::hashing::double_sha256;
2025-11-10T00:08:56.4023575Z                      let mut header_data = Vec::new();
2025-11-10T00:08:56.4024061Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:51:
2025-11-10T00:08:56.4024492Z                      header_data.extend_from_slice(&block.header.bits.to_le_bytes());
2025-11-10T00:08:56.4024800Z                      header_data.extend_from_slice(&block.header.nonce.to_le_bytes());
2025-11-10T00:08:56.4025025Z                      let calculated_hash = double_sha256(&header_data);
2025-11-10T00:08:56.4025134Z -                    
2025-11-10T00:08:56.4025235Z +
2025-11-10T00:08:56.4025398Z                      // Check if this is the stop hash
2025-11-10T00:08:56.4025580Z                      if calculated_hash == request.stop_hash {
2025-11-10T00:08:56.4025719Z                          found_stop = true;
2025-11-10T00:08:56.4026221Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:58:
2025-11-10T00:08:56.4026365Z                          stop_height = height;
2025-11-10T00:08:56.4026475Z                      }
2025-11-10T00:08:56.4026581Z -                    
2025-11-10T00:08:56.4026690Z +
2025-11-10T00:08:56.4026834Z                      // Try to get cached filter
2025-11-10T00:08:56.4027171Z                      let filter = if let Some(cached) = filter_service.get_filter(&calculated_hash) {
2025-11-10T00:08:56.4027536Z                          cached
2025-11-10T00:08:56.4029535Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:72:
2025-11-10T00:08:56.4029651Z                                  }
2025-11-10T00:08:56.4029763Z                              }
2025-11-10T00:08:56.4029870Z                          }
2025-11-10T00:08:56.4029973Z -                        
2025-11-10T00:08:56.4030069Z +
2025-11-10T00:08:56.4030411Z                          filter_service.generate_and_cache_filter(&block, &prev_scripts, height)?
2025-11-10T00:08:56.4030520Z                      };
2025-11-10T00:08:56.4030627Z -                    
2025-11-10T00:08:56.4030740Z +
2025-11-10T00:08:56.4031023Z                      responses.push(ProtocolMessage::Cfilter(CfilterMessage {
2025-11-10T00:08:56.4031166Z                          filter_type: 0,
2025-11-10T00:08:56.4031331Z                          block_hash: calculated_hash,
2025-11-10T00:08:56.4032072Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:82:
2025-11-10T00:08:56.4032251Z                          filter_data: filter.filter_data,
2025-11-10T00:08:56.4032423Z                          num_elements: filter.num_elements,
2025-11-10T00:08:56.4032548Z                      }));
2025-11-10T00:08:56.4032659Z -                    
2025-11-10T00:08:56.4032766Z +
2025-11-10T00:08:56.4032912Z                      if found_stop {
2025-11-10T00:08:56.4033033Z                          break;
2025-11-10T00:08:56.4033144Z                      }
2025-11-10T00:08:56.4033787Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:89:
2025-11-10T00:08:56.4033917Z                  }
2025-11-10T00:08:56.4034023Z              }
2025-11-10T00:08:56.4034129Z          }
2025-11-10T00:08:56.4034244Z -        
2025-11-10T00:08:56.4034559Z +
2025-11-10T00:08:56.4034853Z          if !found_stop && stop_height < current_height {
2025-11-10T00:08:56.4035141Z              // Stop hash not found in reasonable range, return what we have
2025-11-10T00:08:56.4035268Z          }
2025-11-10T00:08:56.4035778Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip70_handler.rs:3:
2025-11-10T00:08:56.4036025Z  //! Handles incoming BIP70 messages from the P2P network.
2025-11-10T00:08:56.4036198Z  //! Similar to bip157_handler.rs pattern.
2025-11-10T00:08:56.4036304Z  
2025-11-10T00:08:56.4036882Z -use bllvm_protocol::payment::{Bip70Error, PaymentProtocolClient, PaymentProtocolServer, PaymentRequest};
2025-11-10T00:08:56.4037041Z  use crate::network::protocol::{
2025-11-10T00:08:56.4037512Z      GetPaymentRequestMessage, PaymentACKMessage, PaymentMessage, PaymentRequestMessage,
2025-11-10T00:08:56.4037730Z      ProtocolMessage,
2025-11-10T00:08:56.4038245Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip70_handler.rs:10:
2025-11-10T00:08:56.4038359Z  };
2025-11-10T00:08:56.4038502Z  use anyhow::Result;
2025-11-10T00:08:56.4038659Z +use bllvm_protocol::payment::{
2025-11-10T00:08:56.4039051Z +    Bip70Error, PaymentProtocolClient, PaymentProtocolServer, PaymentRequest,
2025-11-10T00:08:56.4039159Z +};
2025-11-10T00:08:56.4039273Z +use hex;
2025-11-10T00:08:56.4039420Z  use std::collections::HashMap;
2025-11-10T00:08:56.4039567Z  use std::sync::{Arc, Mutex};
2025-11-10T00:08:56.4039676Z -use hex;
2025-11-10T00:08:56.4039785Z  
2025-11-10T00:08:56.4040242Z  /// In-memory payment request store (simplified - would use persistent storage in production)
2025-11-10T00:08:56.4040592Z  type PaymentRequestStore = Arc<Mutex<HashMap<String, PaymentRequest>>>;
2025-11-10T00:08:56.4041101Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip70_handler.rs:25:
2025-11-10T00:08:56.4041266Z  ) -> Result<PaymentRequestMessage> {
2025-11-10T00:08:56.4041422Z      if let Some(store) = payment_store {
2025-11-10T00:08:56.4041581Z          let store = store.lock().unwrap();
2025-11-10T00:08:56.4042026Z -        let key = format!("{}_{}", hex::encode(&request.payment_id), hex::encode(&request.merchant_pubkey));
2025-11-10T00:08:56.4042406Z +        let key = format!(
2025-11-10T00:08:56.4042524Z +            "{}_{}",
2025-11-10T00:08:56.4042697Z +            hex::encode(&request.payment_id),
2025-11-10T00:08:56.4042875Z +            hex::encode(&request.merchant_pubkey)
2025-11-10T00:08:56.4042988Z +        );
2025-11-10T00:08:56.4043191Z          if let Some(payment_request) = store.get(&key) {
2025-11-10T00:08:56.4043353Z              // Convert to P2P message format
2025-11-10T00:08:56.4043777Z              // Note: In production, merchant_signature would be generated by signing payment_request
2025-11-10T00:08:56.4044294Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip70_handler.rs:37:
2025-11-10T00:08:56.4044587Z              });
2025-11-10T00:08:56.4044704Z          }
2025-11-10T00:08:56.4044814Z      }
2025-11-10T00:08:56.4045146Z -    
2025-11-10T00:08:56.4047138Z +
2025-11-10T00:08:56.4047388Z      Err(anyhow::anyhow!("Payment request not found"))
2025-11-10T00:08:56.4047498Z  }
2025-11-10T00:08:56.4047603Z  
2025-11-10T00:08:56.4048138Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip70_handler.rs:58:
2025-11-10T00:08:56.4048256Z      } else {
2025-11-10T00:08:56.4048370Z          None
2025-11-10T00:08:56.4048480Z      };
2025-11-10T00:08:56.4048588Z -    
2025-11-10T00:08:56.4048694Z +
2025-11-10T00:08:56.4048988Z      if let Some(request) = original_request {
2025-11-10T00:08:56.4049179Z          // Use existing process_payment function
2025-11-10T00:08:56.4049423Z          use bllvm_protocol::payment::PaymentProtocolServer;
2025-11-10T00:08:56.4049938Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip70_handler.rs:65:
2025-11-10T00:08:56.4050538Z -        let payment_ack = PaymentProtocolServer::process_payment(&payment_msg.payment, &request, merchant_private_key)
2025-11-10T00:08:56.4050839Z -            .map_err(|e| anyhow::anyhow!("Payment processing failed: {:?}", e))?;
2025-11-10T00:08:56.4050950Z -        
2025-11-10T00:08:56.4051200Z +        let payment_ack = PaymentProtocolServer::process_payment(
2025-11-10T00:08:56.4051346Z +            &payment_msg.payment,
2025-11-10T00:08:56.4051461Z +            &request,
2025-11-10T00:08:56.4051590Z +            merchant_private_key,
2025-11-10T00:08:56.4051701Z +        )
2025-11-10T00:08:56.4051986Z +        .map_err(|e| anyhow::anyhow!("Payment processing failed: {:?}", e))?;
2025-11-10T00:08:56.4052094Z +
2025-11-10T00:08:56.4052243Z          // Convert to P2P message format
2025-11-10T00:08:56.4052389Z          Ok(PaymentACKMessage {
2025-11-10T00:08:56.4052507Z              payment_ack,
2025-11-10T00:08:56.4052990Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip70_handler.rs:79:
2025-11-10T00:08:56.4053212Z  /// Validate PaymentRequest message from P2P network
2025-11-10T00:08:56.4053693Z  pub fn validate_payment_request_message(msg: &PaymentRequestMessage) -> Result<(), Bip70Error> {
2025-11-10T00:08:56.4053935Z      use bllvm_protocol::payment::PaymentProtocolClient;
2025-11-10T00:08:56.4054642Z -    PaymentProtocolClient::validate_payment_request(&msg.payment_request, Some(&msg.merchant_pubkey))
2025-11-10T00:08:56.4054873Z +    PaymentProtocolClient::validate_payment_request(
2025-11-10T00:08:56.4055015Z +        &msg.payment_request,
2025-11-10T00:08:56.4055170Z +        Some(&msg.merchant_pubkey),
2025-11-10T00:08:56.4055281Z +    )
2025-11-10T00:08:56.4055386Z  }
2025-11-10T00:08:56.4055493Z  
2025-11-10T00:08:56.4057624Z  /// Validate PaymentACK message from merchant
2025-11-10T00:08:56.4058132Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip70_handler.rs:88:
2025-11-10T00:08:56.4058281Z      merchant_pubkey: &[u8],
2025-11-10T00:08:56.4058429Z  ) -> Result<(), Bip70Error> {
2025-11-10T00:08:56.4058665Z      use bllvm_protocol::payment::PaymentProtocolClient;
2025-11-10T00:08:56.4059502Z -    PaymentProtocolClient::validate_payment_ack(&ack.payment_ack, &ack.merchant_signature, merchant_pubkey)
2025-11-10T00:08:56.4059709Z +    PaymentProtocolClient::validate_payment_ack(
2025-11-10T00:08:56.4059856Z +        &ack.payment_ack,
2025-11-10T00:08:56.4060001Z +        &ack.merchant_signature,
2025-11-10T00:08:56.4060130Z +        merchant_pubkey,
2025-11-10T00:08:56.4060244Z +    )
2025-11-10T00:08:56.4060352Z  }
2025-11-10T00:08:56.4060457Z  
2025-11-10T00:08:56.4060957Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/chain_access.rs:3:
2025-11-10T00:08:56.4061275Z  //! Implements ChainStateAccess trait to bridge node storage modules
2025-11-10T00:08:56.4061672Z  //! (BlockStore, TxIndex, MempoolManager) with protocol layer network processing.
2025-11-10T00:08:56.4061780Z  
2025-11-10T00:08:56.4061952Z +use crate::node::mempool::MempoolManager;
2025-11-10T00:08:56.4062226Z +use crate::storage::{blockstore::BlockStore, txindex::TxIndex};
2025-11-10T00:08:56.4062565Z  use anyhow::Result;
2025-11-10T00:08:56.4062840Z  use bllvm_protocol::network::{ChainObject, ChainStateAccess};
2025-11-10T00:08:56.4063106Z  use bllvm_protocol::{Block, BlockHeader, Hash, Transaction};
2025-11-10T00:08:56.4063613Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/chain_access.rs:9:
2025-11-10T00:08:56.4063791Z -use crate::node::mempool::MempoolManager;
2025-11-10T00:08:56.4064064Z -use crate::storage::{blockstore::BlockStore, txindex::TxIndex};
2025-11-10T00:08:56.4064201Z  use std::sync::Arc;
2025-11-10T00:08:56.4064477Z  
2025-11-10T00:08:56.4064864Z  /// Chain state access implementation that bridges node storage to protocol layer
2025-11-10T00:08:56.4065396Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/chain_access.rs:68:
2025-11-10T00:08:56.4065629Z      /// This implements the Bitcoin block locator algorithm
2025-11-10T00:08:56.4066015Z      fn get_headers_for_locator(&self, locator: &[Hash], stop: &Hash) -> Vec<BlockHeader> {
2025-11-10T00:08:56.4066199Z          let mut headers = Vec::new();
2025-11-10T00:08:56.4066313Z -        
2025-11-10T00:08:56.4066416Z +
2025-11-10T00:08:56.4066578Z          // Bitcoin block locator algorithm:
2025-11-10T00:08:56.4066755Z          // 1. Start with the most recent block hash
2025-11-10T00:08:56.4067077Z          // 2. Go back exponentially (1, 2, 4, 8, 16, ...) until we find a common ancestor
2025-11-10T00:08:56.4067591Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/chain_access.rs:75:
2025-11-10T00:08:56.4067833Z          // 3. Stop when we reach the stop hash or run out of hashes
2025-11-10T00:08:56.4068040Z -        
2025-11-10T00:08:56.4068149Z +
2025-11-10T00:08:56.4068286Z          for hash in locator {
2025-11-10T00:08:56.4068465Z              // If we've reached the stop hash, stop
2025-11-10T00:08:56.4068596Z              if hash == stop {
2025-11-10T00:08:56.4069096Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/chain_access.rs:80:
2025-11-10T00:08:56.4069238Z                  break;
2025-11-10T00:08:56.4069347Z              }
2025-11-10T00:08:56.4069568Z -            
2025-11-10T00:08:56.4069850Z +
2025-11-10T00:08:56.4070071Z              // Try to get the header
2025-11-10T00:08:56.4070391Z              if let Ok(Some(header)) = self.blockstore.get_header(hash) {
2025-11-10T00:08:56.4070611Z                  headers.push(header);
2025-11-10T00:08:56.4071411Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/chain_access.rs:89:
2025-11-10T00:08:56.4086654Z                  continue;
2025-11-10T00:08:56.4086836Z              }
2025-11-10T00:08:56.4086950Z          }
2025-11-10T00:08:56.4087063Z -        
2025-11-10T00:08:56.4087166Z +
2025-11-10T00:08:56.4087283Z          headers
2025-11-10T00:08:56.4087392Z      }
2025-11-10T00:08:56.4087509Z  
2025-11-10T00:08:56.4088038Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/chain_access.rs:130:
2025-11-10T00:08:56.4088472Z      height: Option<u64>,
2025-11-10T00:08:56.4088734Z  ) -> Result<bllvm_protocol::network::NetworkResponse> {
2025-11-10T00:08:56.4089076Z      use bllvm_protocol::network::{process_network_message, ChainStateAccess};
2025-11-10T00:08:56.4089182Z -    
2025-11-10T00:08:56.4089287Z +
2025-11-10T00:08:56.4089446Z      process_network_message(
2025-11-10T00:08:56.4089560Z          engine,
2025-11-10T00:08:56.4089681Z          message,
2025-11-10T00:08:56.4090210Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/chain_access.rs:138:
2025-11-10T00:08:56.4090410Z          Some(chain_access as &dyn ChainStateAccess),
2025-11-10T00:08:56.4090530Z          utxo_set,
2025-11-10T00:08:56.4090649Z          height,
2025-11-10T00:08:56.4090951Z -    ).map_err(|e| anyhow::anyhow!("Network message processing error: {}", e))
2025-11-10T00:08:56.4091060Z +    )
2025-11-10T00:08:56.4091358Z +    .map_err(|e| anyhow::anyhow!("Network message processing error: {}", e))
2025-11-10T00:08:56.4091763Z  }
2025-11-10T00:08:56.4091876Z -
2025-11-10T00:08:56.4091984Z  
2025-11-10T00:08:56.4092549Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dns_seeds.rs:38:
2025-11-10T00:08:56.4092683Z      max_addresses: usize,
2025-11-10T00:08:56.4092825Z  ) -> Vec<NetworkAddress> {
2025-11-10T00:08:56.4093469Z      let mut addresses = Vec::new();
2025-11-10T00:08:56.4095677Z -    
2025-11-10T00:08:56.4095799Z +
2025-11-10T00:08:56.4095925Z      for seed in seeds {
2025-11-10T00:08:56.4096108Z          match resolve_dns_seed(*seed, port).await {
2025-11-10T00:08:56.4096236Z              Ok(mut addrs) => {
2025-11-10T00:08:56.4096715Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dns_seeds.rs:53:
2025-11-10T00:08:56.4096836Z              }
2025-11-10T00:08:56.4096949Z          }
2025-11-10T00:08:56.4097069Z      }
2025-11-10T00:08:56.4097177Z -    
2025-11-10T00:08:56.4097296Z +
2025-11-10T00:08:56.4097449Z      // Limit to max_addresses
2025-11-10T00:08:56.4097623Z      addresses.truncate(max_addresses);
2025-11-10T00:08:56.4097745Z      addresses
2025-11-10T00:08:56.4098229Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dns_seeds.rs:63:
2025-11-10T00:08:56.4099054Z  async fn resolve_dns_seed(seed: &str, port: u16) -> Result<Vec<NetworkAddress>, String> {
2025-11-10T00:08:56.4099262Z      // Create hostname:port string for DNS lookup
2025-11-10T00:08:56.4099441Z      let hostname = format!("{}:{}", seed, port);
2025-11-10T00:08:56.4099551Z -    
2025-11-10T00:08:56.4100062Z +
2025-11-10T00:08:56.4100246Z      // Perform DNS lookup with timeout
2025-11-10T00:08:56.4100428Z      let timeout = Duration::from_secs(5);
2025-11-10T00:08:56.4100865Z      let lookup_result = tokio::time::timeout(timeout, lookup_host(&hostname))
2025-11-10T00:08:56.4101354Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dns_seeds.rs:70:
2025-11-10T00:08:56.4101484Z          .await
2025-11-10T00:08:56.4101737Z          .map_err(|_| format!("DNS lookup timeout for {}", seed))?;
2025-11-10T00:08:56.4101845Z -    
2025-11-10T00:08:56.4101999Z -    let socket_addrs = lookup_result
2025-11-10T00:08:56.4102253Z -        .map_err(|e| format!("DNS lookup failed for {}: {}", seed, e))?;
2025-11-10T00:08:56.4102374Z -    
2025-11-10T00:08:56.4102483Z +
2025-11-10T00:08:56.4102616Z +    let socket_addrs =
2025-11-10T00:08:56.4102962Z +        lookup_result.map_err(|e| format!("DNS lookup failed for {}: {}", seed, e))?;
2025-11-10T00:08:56.4103073Z +
2025-11-10T00:08:56.4103243Z      // Convert SocketAddr to NetworkAddress
2025-11-10T00:08:56.4103402Z      let mut addresses = Vec::new();
2025-11-10T00:08:56.4103561Z      for socket_addr in socket_addrs {
2025-11-10T00:08:56.4106593Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dns_seeds.rs:79:
2025-11-10T00:08:56.4106922Z          addresses.push(socket_addr_to_network_address(socket_addr));
2025-11-10T00:08:56.4107295Z      }
2025-11-10T00:08:56.4107398Z -    
2025-11-10T00:08:56.4107494Z +
2025-11-10T00:08:56.4107620Z      Ok(addresses)
2025-11-10T00:08:56.4107737Z  }
2025-11-10T00:08:56.4107843Z  
2025-11-10T00:08:56.4108325Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dns_seeds.rs:85:
2025-11-10T00:08:56.4108503Z  /// Convert SocketAddr to NetworkAddress
2025-11-10T00:08:56.4108849Z  fn socket_addr_to_network_address(socket_addr: SocketAddr) -> NetworkAddress {
2025-11-10T00:08:56.4108984Z      use std::net::IpAddr;
2025-11-10T00:08:56.4109096Z -    
2025-11-10T00:08:56.4109211Z +
2025-11-10T00:08:56.4109372Z      let ip_bytes = match socket_addr.ip() {
2025-11-10T00:08:56.4109506Z          IpAddr::V4(ipv4) => {
2025-11-10T00:08:56.4109651Z              // IPv4-mapped IPv6 format
2025-11-10T00:08:56.4110113Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dns_seeds.rs:95:
2025-11-10T00:08:56.4110656Z              bytes[12..16].copy_from_slice(&ipv4.octets());
2025-11-10T00:08:56.4110791Z              bytes
2025-11-10T00:08:56.4110901Z          }
2025-11-10T00:08:56.4111046Z -        IpAddr::V6(ipv6) => {
2025-11-10T00:08:56.4111170Z -            ipv6.octets()
2025-11-10T00:08:56.4111292Z -        }
2025-11-10T00:08:56.4111453Z +        IpAddr::V6(ipv6) => ipv6.octets(),
2025-11-10T00:08:56.4111565Z      };
2025-11-10T00:08:56.4111682Z -    
2025-11-10T00:08:56.4111792Z +
2025-11-10T00:08:56.4111923Z      NetworkAddress {
2025-11-10T00:08:56.4112126Z          services: 0, // Will be updated when we connect
2025-11-10T00:08:56.4112266Z          ip: ip_bytes,
2025-11-10T00:08:56.4112767Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dns_seeds.rs:125:
2025-11-10T00:08:56.4112911Z          assert_eq!(addr.ip[15], 1);
2025-11-10T00:08:56.4113028Z      }
2025-11-10T00:08:56.4113134Z  }
2025-11-10T00:08:56.4113239Z -
2025-11-10T00:08:56.4113343Z  
2025-11-10T00:08:56.4113874Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:9:
2025-11-10T00:08:56.4114019Z  use std::sync::Arc;
2025-11-10T00:08:56.4114190Z  use std::time::{SystemTime, UNIX_EPOCH};
2025-11-10T00:08:56.4114578Z  use tokio::sync::Mutex;
2025-11-10T00:08:56.4114746Z -use tracing::{debug, warn, error};
2025-11-10T00:08:56.4114899Z +use tracing::{debug, error, warn};
2025-11-10T00:08:56.4115009Z  
2025-11-10T00:08:56.4115354Z  /// Connection rate limiter (tracks connection attempts per time window)
2025-11-10T00:08:56.4115527Z  pub struct ConnectionRateLimiter {
2025-11-10T00:08:56.4117604Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:40:
2025-11-10T00:08:56.4117725Z  
2025-11-10T00:08:56.4117925Z          // Clean up old entries outside the time window
2025-11-10T00:08:56.4118157Z          let cutoff = now.saturating_sub(self.window_seconds);
2025-11-10T00:08:56.4118275Z -        
2025-11-10T00:08:56.4118403Z +
2025-11-10T00:08:56.4118768Z          let attempts = self.connection_attempts.entry(ip).or_insert_with(Vec::new);
2025-11-10T00:08:56.4118993Z          attempts.retain(|&timestamp| timestamp > cutoff);
2025-11-10T00:08:56.4119112Z  
2025-11-10T00:08:56.4119635Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:47:
2025-11-10T00:08:56.4119796Z          // Check if we're within the limit
2025-11-10T00:08:56.4120494Z          if attempts.len() >= self.max_connections_per_window {
2025-11-10T00:08:56.4120877Z -            warn!("Connection rate limit exceeded for IP {}: {} attempts in {} seconds", 
2025-11-10T00:08:56.4121074Z -                  ip, attempts.len(), self.window_seconds);
2025-11-10T00:08:56.4121193Z +            warn!(
2025-11-10T00:08:56.4121526Z +                "Connection rate limit exceeded for IP {}: {} attempts in {} seconds",
2025-11-10T00:08:56.4121648Z +                ip,
2025-11-10T00:08:56.4121788Z +                attempts.len(),
2025-11-10T00:08:56.4121946Z +                self.window_seconds
2025-11-10T00:08:56.4122316Z +            );
2025-11-10T00:08:56.4122440Z              false
2025-11-10T00:08:56.4122558Z          } else {
2025-11-10T00:08:56.4122734Z              // Record this connection attempt
2025-11-10T00:08:56.4123263Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:72:
2025-11-10T00:08:56.4123375Z  
2025-11-10T00:08:56.4123574Z      /// Get current connection attempt count for an IP
2025-11-10T00:08:56.4123787Z      pub fn get_attempt_count(&self, ip: IpAddr) -> usize {
2025-11-10T00:08:56.4124069Z -        self.connection_attempts.get(&ip).map(|v| v.len()).unwrap_or(0)
2025-11-10T00:08:56.4124212Z +        self.connection_attempts
2025-11-10T00:08:56.4124544Z +            .get(&ip)
2025-11-10T00:08:56.4124676Z +            .map(|v| v.len())
2025-11-10T00:08:56.4124796Z +            .unwrap_or(0)
2025-11-10T00:08:56.4124906Z      }
2025-11-10T00:08:56.4125006Z  }
2025-11-10T00:08:56.4127203Z  
2025-11-10T00:08:56.4127737Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:171:
2025-11-10T00:08:56.4127880Z      /// Create with default settings
2025-11-10T00:08:56.4128016Z      pub fn default() -> Self {
2025-11-10T00:08:56.4128137Z          Self::new(
2025-11-10T00:08:56.4128708Z -            10,   // Max 10 connections per IP per window
2025-11-10T00:08:56.4128845Z -            60,   // 60 second window
2025-11-10T00:08:56.4129028Z +            10,    // Max 10 connections per IP per window
2025-11-10T00:08:56.4129175Z +            60,    // 60 second window
2025-11-10T00:08:56.4129332Z              10000, // Max 10k messages in queue
2025-11-10T00:08:56.4129486Z -            200,  // Max 200 active connections
2025-11-10T00:08:56.4129638Z +            200,   // Max 200 active connections
2025-11-10T00:08:56.4129757Z          )
2025-11-10T00:08:56.4129867Z      }
2025-11-10T00:08:56.4129973Z  
2025-11-10T00:08:56.4130525Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:194:
2025-11-10T00:08:56.4130724Z              metrics.connection_rate_violations += 1;
2025-11-10T00:08:56.4130834Z  
2025-11-10T00:08:56.4131452Z              if *count >= self.auto_ban_connection_violations {
2025-11-10T00:08:56.4131875Z -                warn!("Auto-banning IP {} for repeated connection rate violations ({} violations)", 
2025-11-10T00:08:56.4132008Z -                      ip, *count);
2025-11-10T00:08:56.4132463Z +                warn!(
2025-11-10T00:08:56.4132813Z +                    "Auto-banning IP {} for repeated connection rate violations ({} violations)",
2025-11-10T00:08:56.4132941Z +                    ip, *count
2025-11-10T00:08:56.4133059Z +                );
2025-11-10T00:08:56.4133230Z                  metrics.auto_bans_applied += 1;
2025-11-10T00:08:56.4133420Z                  // Return false to reject, caller should ban
2025-11-10T00:08:56.4133554Z                  return false;
2025-11-10T00:08:56.4134071Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:212:
2025-11-10T00:08:56.4134258Z      /// Check if message queue is within limits
2025-11-10T00:08:56.4134780Z      pub async fn check_message_queue_size(&self, current_size: usize) -> bool {
2025-11-10T00:08:56.4134981Z          if current_size > self.max_message_queue_size {
2025-11-10T00:08:56.4135367Z -            warn!("Message queue size exceeded: {} > {}", current_size, self.max_message_queue_size);
2025-11-10T00:08:56.4135483Z +            warn!(
2025-11-10T00:08:56.4135653Z +                "Message queue size exceeded: {} > {}",
2025-11-10T00:08:56.4135840Z +                current_size, self.max_message_queue_size
2025-11-10T00:08:56.4135951Z +            );
2025-11-10T00:08:56.4136139Z              let mut metrics = self.metrics.lock().await;
2025-11-10T00:08:56.4136314Z              metrics.message_queue_overflows += 1;
2025-11-10T00:08:56.4136441Z              false
2025-11-10T00:08:56.4136988Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:224:
2025-11-10T00:08:56.4137420Z      /// Check if we can accept more connections
2025-11-10T00:08:56.4137783Z      pub async fn check_active_connections(&self, current_count: usize) -> bool {
2025-11-10T00:08:56.4137988Z          if current_count >= self.max_active_connections {
2025-11-10T00:08:56.4138473Z -            warn!("Active connection limit exceeded: {} >= {}", current_count, self.max_active_connections);
2025-11-10T00:08:56.4138613Z +            warn!(
2025-11-10T00:08:56.4138809Z +                "Active connection limit exceeded: {} >= {}",
2025-11-10T00:08:56.4138999Z +                current_count, self.max_active_connections
2025-11-10T00:08:56.4139118Z +            );
2025-11-10T00:08:56.4139317Z              let mut metrics = self.metrics.lock().await;
2025-11-10T00:08:56.4139497Z              metrics.active_connection_limit_hits += 1;
2025-11-10T00:08:56.4139856Z              false
2025-11-10T00:08:56.4140407Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:262:
2025-11-10T00:08:56.4140596Z      /// Check if we're under DoS attack (heuristic)
2025-11-10T00:08:56.4140787Z      pub async fn detect_dos_attack(&self) -> bool {
2025-11-10T00:08:56.4141006Z          let metrics = self.resource_metrics.lock().await;
2025-11-10T00:08:56.4141223Z -        
2025-11-10T00:08:56.4141334Z +
2025-11-10T00:08:56.4141652Z          // Heuristic: If message queue is > 80% full and connections are > 80% of max
2025-11-10T00:08:56.4141982Z          let queue_threshold = (self.max_message_queue_size as f64 * 0.8) as usize;
2025-11-10T00:08:56.4142291Z          let conn_threshold = (self.max_active_connections as f64 * 0.8) as usize;
2025-11-10T00:08:56.4142832Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:269:
2025-11-10T00:08:56.4142952Z  
2025-11-10T00:08:56.4143147Z -        metrics.message_queue_size > queue_threshold 
2025-11-10T00:08:56.4143355Z -            && metrics.active_connections > conn_threshold
2025-11-10T00:08:56.4144498Z +        metrics.message_queue_size > queue_threshold && metrics.active_connections > conn_threshold
2025-11-10T00:08:56.4144627Z      }
2025-11-10T00:08:56.4144738Z  
2025-11-10T00:08:56.4144928Z      /// Cleanup old connection rate limiter entries
2025-11-10T00:08:56.4145791Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:368:
2025-11-10T00:08:56.4145983Z          assert!(dos.should_auto_ban(ip).await);
2025-11-10T00:08:56.4146097Z      }
2025-11-10T00:08:56.4146217Z  }
2025-11-10T00:08:56.4146327Z -
2025-11-10T00:08:56.4146435Z  
2025-11-10T00:08:56.4146942Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/filter_service.rs:3:
2025-11-10T00:08:56.4147321Z  //! Generates, caches, and serves compact block filters for light client support.
2025-11-10T00:08:56.4147848Z  //! Maintains filter header chain for efficient verification.
2025-11-10T00:08:56.4147977Z  
2025-11-10T00:08:56.4148141Z +use anyhow::{anyhow, Result};
2025-11-10T00:08:56.4148283Z  use bllvm_protocol::bip157;
2025-11-10T00:08:56.4148600Z  use bllvm_protocol::bip158::{build_block_filter, CompactBlockFilter};
2025-11-10T00:08:56.4148746Z -use anyhow::{anyhow, Result};
2025-11-10T00:08:56.4149007Z  use bllvm_protocol::{Block, BlockHeader, Hash, Transaction};
2025-11-10T00:08:56.4149157Z  use std::collections::HashMap;
2025-11-10T00:08:56.4149290Z  use std::sync::{Arc, RwLock};
2025-11-10T00:08:56.4149824Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/filter_service.rs:211:
2025-11-10T00:08:56.4150184Z      pub fn remove_filter_for_pruned_block(&self, block_hash: &Hash) -> Result<()> {
2025-11-10T00:08:56.4150324Z          // Remove filter from cache
2025-11-10T00:08:56.4150538Z          self.filters.write().unwrap().remove(block_hash);
2025-11-10T00:08:56.4150645Z -        
2025-11-10T00:08:56.4150753Z +
2025-11-10T00:08:56.4152170Z          // Note: We do NOT remove the filter header - it's required for verification
2025-11-10T00:08:56.4152452Z          // The filter header chain must remain intact even after pruning
2025-11-10T00:08:56.4152569Z -        
2025-11-10T00:08:56.4152685Z +
2025-11-10T00:08:56.4152807Z          Ok(())
2025-11-10T00:08:56.4152915Z      }
2025-11-10T00:08:56.4153025Z  
2025-11-10T00:08:56.4153574Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/message_bridge.rs:80:
2025-11-10T00:08:56.4154007Z      /// 3. Convert the `NetworkResponse` to wire format messages using `extract_send_messages()`
2025-11-10T00:08:56.4154127Z      ///
2025-11-10T00:08:56.4154614Z      /// For now, this method only handles message conversion, not processing.
2025-11-10T00:08:56.4154786Z -    pub fn process_incoming_message(
2025-11-10T00:08:56.4154909Z -        data: &[u8],
2025-11-10T00:08:56.4155069Z -        transport: TransportType,
2025-11-10T00:08:56.4155495Z -    ) -> Result<Vec<Vec<u8>>> {
2025-11-10T00:08:56.4155937Z +    pub fn process_incoming_message(data: &[u8], transport: TransportType) -> Result<Vec<Vec<u8>>> {
2025-11-10T00:08:56.4156099Z          // Convert to protocol message
2025-11-10T00:08:56.4156405Z          let protocol_msg = Self::from_transport_message(data, transport)?;
2025-11-10T00:08:56.4156514Z  
2025-11-10T00:08:56.4977863Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:4:
2025-11-10T00:08:56.4978894Z  //! message handling for communication with other Bitcoin nodes.
2025-11-10T00:08:56.4979469Z  
2025-11-10T00:08:56.4979752Z  pub mod address_db;
2025-11-10T00:08:56.4980121Z +pub mod ban_list_merging;
2025-11-10T00:08:56.4980514Z +pub mod ban_list_signing;
2025-11-10T00:08:56.4980884Z  pub mod chain_access;
2025-11-10T00:08:56.4981237Z  pub mod dns_seeds;
2025-11-10T00:08:56.4981579Z +pub mod dos_protection;
2025-11-10T00:08:56.4983367Z  pub mod inventory;
2025-11-10T00:08:56.4983727Z  pub mod message_bridge;
2025-11-10T00:08:56.4984100Z  pub mod peer;
2025-11-10T00:08:56.4984957Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:12:
2025-11-10T00:08:56.4985721Z  pub mod protocol;
2025-11-10T00:08:56.4986060Z  pub mod protocol_adapter;
2025-11-10T00:08:56.4986466Z  pub mod protocol_extensions;
2025-11-10T00:08:56.4986870Z -pub mod ban_list_merging;
2025-11-10T00:08:56.4987721Z -pub mod ban_list_signing;
2025-11-10T00:08:56.4988462Z -pub mod dos_protection;
2025-11-10T00:08:56.4988832Z  pub mod relay;
2025-11-10T00:08:56.4989167Z  pub mod tcp_transport;
2025-11-10T00:08:56.4989520Z  pub mod transport;
2025-11-10T00:08:56.4990188Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:40:
2025-11-10T00:08:56.4990959Z  // Payment Protocol (BIP70) - P2P handlers
2025-11-10T00:08:56.4991412Z  pub mod bip70_handler;
2025-11-10T00:08:56.4991730Z  
2025-11-10T00:08:56.4991986Z -
2025-11-10T00:08:56.4992614Z  // Privacy and Performance Enhancements
2025-11-10T00:08:56.4993097Z  #[cfg(feature = "dandelion")]
2025-11-10T00:08:56.4993689Z  pub mod dandelion; // Dandelion++ privacy-preserving transaction relay
2025-11-10T00:08:56.4994773Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:50:
2025-11-10T00:08:56.4995703Z  pub mod txhash; // Non-consensus hashing helpers for relay
2025-11-10T00:08:56.4996189Z  
2025-11-10T00:08:56.4996649Z  use crate::network::protocol::{ProtocolMessage, ProtocolParser};
2025-11-10T00:08:56.4997249Z +use crate::node::mempool::MempoolManager;
2025-11-10T00:08:56.4997711Z +use crate::storage::Storage;
2025-11-10T00:08:56.4998093Z  use anyhow::Result;
2025-11-10T00:08:56.4998449Z  use bllvm_protocol::mempool::Mempool;
2025-11-10T00:08:56.4999069Z  use bllvm_protocol::{BitcoinProtocolEngine, ConsensusProof, UtxoSet};
2025-11-10T00:08:56.4999981Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:58:
2025-11-10T00:08:56.5000737Z  use std::sync::{Arc, Mutex};
2025-11-10T00:08:56.5001457Z  use tokio::sync::mpsc;
2025-11-10T00:08:56.5001827Z  use tracing::{error, info, warn};
2025-11-10T00:08:56.5002248Z -use crate::storage::Storage;
2025-11-10T00:08:56.5002674Z -use crate::node::mempool::MempoolManager;
2025-11-10T00:08:56.5003104Z  
2025-11-10T00:08:56.5003439Z  use crate::network::tcp_transport::TcpTransport;
2025-11-10T00:08:56.5003931Z  use crate::network::transport::{
2025-11-10T00:08:56.5004796Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:86:
2025-11-10T00:08:56.5005872Z  }
2025-11-10T00:08:56.5006117Z  
2025-11-10T00:08:56.5006414Z  /// Peer manager for tracking connected peers
2025-11-10T00:08:56.5006824Z -/// 
2025-11-10T00:08:56.5007061Z +///
2025-11-10T00:08:56.5007514Z  /// Uses TransportAddr as key to support all transport types (TCP, Quinn, Iroh).
2025-11-10T00:08:56.5008316Z  /// This allows proper peer identification for Iroh (NodeId) while maintaining
2025-11-10T00:08:56.5009231Z  /// compatibility with TCP/Quinn (SocketAddr).
2025-11-10T00:08:56.5009969Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:130:
2025-11-10T00:08:56.5010757Z      pub fn peer_addresses(&self) -> Vec<TransportAddr> {
2025-11-10T00:08:56.5011232Z          self.peers.keys().cloned().collect()
2025-11-10T00:08:56.5011629Z      }
2025-11-10T00:08:56.5011877Z -    
2025-11-10T00:08:56.5012106Z +
2025-11-10T00:08:56.5012504Z      /// Get peer addresses as SocketAddr (for backward compatibility)
2025-11-10T00:08:56.5013178Z      /// Only returns SocketAddr for TCP/Quinn peers, skips Iroh peers
2025-11-10T00:08:56.5014154Z      pub fn peer_socket_addresses(&self) -> Vec<SocketAddr> {
2025-11-10T00:08:56.5017289Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:137:
2025-11-10T00:08:56.5017989Z -        self.peers.keys()
2025-11-10T00:08:56.5018304Z +        self.peers
2025-11-10T00:08:56.5018586Z +            .keys()
2025-11-10T00:08:56.5018892Z              .filter_map(|addr| {
2025-11-10T00:08:56.5019240Z                  match addr {
2025-11-10T00:08:56.5019622Z                      TransportAddr::Tcp(sock) => Some(*sock),
2025-11-10T00:08:56.5020320Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:150:
2025-11-10T00:08:56.5021053Z      pub fn can_accept_peer(&self) -> bool {
2025-11-10T00:08:56.5021912Z          self.peers.len() < self.max_peers
2025-11-10T00:08:56.5022311Z      }
2025-11-10T00:08:56.5022535Z -    
2025-11-10T00:08:56.5022762Z +
2025-11-10T00:08:56.5023039Z      /// Select best peers based on quality score
2025-11-10T00:08:56.5023445Z -    /// 
2025-11-10T00:08:56.5023702Z +    ///
2025-11-10T00:08:56.5024067Z      /// Returns peers sorted by quality score (highest first)
2025-11-10T00:08:56.5024937Z      pub fn select_best_peers(&self, count: usize) -> Vec<TransportAddr> {
2025-11-10T00:08:56.5025582Z -        let mut peers: Vec<_> = self.peers.iter()
2025-11-10T00:08:56.5028475Z +        let mut peers: Vec<_> = self
2025-11-10T00:08:56.5028881Z +            .peers
2025-11-10T00:08:56.5029198Z +            .iter()
2025-11-10T00:08:56.5029621Z              .map(|(addr, peer)| (addr.clone(), peer.quality_score()))
2025-11-10T00:08:56.5030149Z              .collect();
2025-11-10T00:08:56.5030484Z -        
2025-11-10T00:08:56.5030754Z +
2025-11-10T00:08:56.5031068Z          // Sort by quality score (descending)
2025-11-10T00:08:56.5031744Z          peers.sort_by(|a, b| b.1.partial_cmp(&a.1).unwrap_or(std::cmp::Ordering::Equal));
2025-11-10T00:08:56.5032375Z -        
2025-11-10T00:08:56.5032644Z +
2025-11-10T00:08:56.5032934Z          // Return top N addresses
2025-11-10T00:08:56.5033342Z -        peers.into_iter()
2025-11-10T00:08:56.5033706Z +        peers
2025-11-10T00:08:56.5033991Z +            .into_iter()
2025-11-10T00:08:56.5034500Z              .take(count)
2025-11-10T00:08:56.5034877Z              .map(|(addr, _)| addr)
2025-11-10T00:08:56.5035262Z              .collect()
2025-11-10T00:08:56.5035950Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:170:
2025-11-10T00:08:56.5036975Z      }
2025-11-10T00:08:56.5037227Z -    
2025-11-10T00:08:56.5037467Z +
2025-11-10T00:08:56.5037732Z      /// Select reliable peers only
2025-11-10T00:08:56.5038108Z -    /// 
2025-11-10T00:08:56.5038367Z +    ///
2025-11-10T00:08:56.5038713Z      /// Returns peers that meet reliability criteria
2025-11-10T00:08:56.5039337Z      pub fn select_reliable_peers(&self) -> Vec<TransportAddr> {
2025-11-10T00:08:56.5039890Z -        self.peers.iter()
2025-11-10T00:08:56.5040242Z +        self.peers
2025-11-10T00:08:56.5040556Z +            .iter()
2025-11-10T00:08:56.5041117Z              .filter(|(_, peer)| peer.quality_score() > 0.5) // Use quality_score as reliability indicator
2025-11-10T00:08:56.5045797Z              .map(|(addr, _)| addr.clone())
2025-11-10T00:08:56.5046242Z              .collect()
2025-11-10T00:08:56.5046911Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:180:
2025-11-10T00:08:56.5047940Z      }
2025-11-10T00:08:56.5048218Z -    
2025-11-10T00:08:56.5048480Z +
2025-11-10T00:08:56.5048779Z      /// Get peer quality statistics
2025-11-10T00:08:56.5049326Z      pub fn get_quality_stats(&self) -> (usize, usize, f64) {
2025-11-10T00:08:56.5049870Z          let total = self.peers.len();
2025-11-10T00:08:56.5050635Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:185:
2025-11-10T00:08:56.5051425Z -        let reliable = self.peers.values()
2025-11-10T00:08:56.5051891Z +        let reliable = self
2025-11-10T00:08:56.5052260Z +            .peers
2025-11-10T00:08:56.5052571Z +            .values()
2025-11-10T00:08:56.5053158Z              .filter(|peer| peer.quality_score() > 0.5) // Use quality_score as reliability indicator
2025-11-10T00:08:56.5053824Z              .count();
2025-11-10T00:08:56.5054165Z          let avg_quality = if total > 0 {
2025-11-10T00:08:56.5055129Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:189:
2025-11-10T00:08:56.5057180Z -            self.peers.values()
2025-11-10T00:08:56.5057577Z +            self.peers
2025-11-10T00:08:56.5057924Z +                .values()
2025-11-10T00:08:56.5058314Z                  .map(|peer| peer.quality_score())
2025-11-10T00:08:56.5058806Z -                .sum::<f64>() / total as f64
2025-11-10T00:08:56.5059238Z +                .sum::<f64>()
2025-11-10T00:08:56.5059603Z +                / total as f64
2025-11-10T00:08:56.5059968Z          } else {
2025-11-10T00:08:56.5060254Z              0.0
2025-11-10T00:08:56.5060550Z          };
2025-11-10T00:08:56.5061155Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:195:
2025-11-10T00:08:56.5061866Z -        
2025-11-10T00:08:56.5062119Z +
2025-11-10T00:08:56.5062399Z          (total, reliable, avg_quality)
2025-11-10T00:08:56.5062779Z      }
2025-11-10T00:08:56.5063024Z -    
2025-11-10T00:08:56.5063282Z +
2025-11-10T00:08:56.5065750Z      /// Find peer by SocketAddr (tries TCP and Quinn variants)
2025-11-10T00:08:56.5066287Z      /// Returns the TransportAddr if found
2025-11-10T00:08:56.5067061Z      pub fn find_transport_addr_by_socket(&self, addr: SocketAddr) -> Option<TransportAddr> {
2025-11-10T00:08:56.5068159Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:204:
2025-11-10T00:08:56.5068920Z          if self.peers.contains_key(&tcp_addr) {
2025-11-10T00:08:56.5069403Z              return Some(tcp_addr);
2025-11-10T00:08:56.5069793Z          }
2025-11-10T00:08:56.5070072Z -        
2025-11-10T00:08:56.5070340Z +
2025-11-10T00:08:56.5070593Z          // Try Quinn
2025-11-10T00:08:56.5070930Z          #[cfg(feature = "quinn")]
2025-11-10T00:08:56.5071390Z          {
2025-11-10T00:08:56.5071983Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:213:
2025-11-10T00:08:56.5075045Z                  return Some(quinn_addr);
2025-11-10T00:08:56.5075465Z              }
2025-11-10T00:08:56.5076124Z          }
2025-11-10T00:08:56.5076394Z -        
2025-11-10T00:08:56.5076643Z +
2025-11-10T00:08:56.5076876Z          None
2025-11-10T00:08:56.5077125Z      }
2025-11-10T00:08:56.5077383Z  }
2025-11-10T00:08:56.5077979Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:245:
2025-11-10T00:08:56.5078740Z              last_refill: now,
2025-11-10T00:08:56.5079104Z          }
2025-11-10T00:08:56.5079366Z      }
2025-11-10T00:08:56.5079627Z -    
2025-11-10T00:08:56.5079883Z +
2025-11-10T00:08:56.5080267Z      /// Check if a message can be consumed and consume a token
2025-11-10T00:08:56.5080847Z      pub fn check_and_consume(&mut self) -> bool {
2025-11-10T00:08:56.5081320Z          self.refill();
2025-11-10T00:08:56.5082472Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:256:
2025-11-10T00:08:56.5083193Z              false
2025-11-10T00:08:56.5083484Z          }
2025-11-10T00:08:56.5083977Z      }
2025-11-10T00:08:56.5084237Z -    
2025-11-10T00:08:56.5084755Z +
2025-11-10T00:08:56.5085074Z      /// Refill tokens based on elapsed time
2025-11-10T00:08:56.5085520Z      fn refill(&mut self) {
2025-11-10T00:08:56.5085949Z          use std::time::{SystemTime, UNIX_EPOCH};
2025-11-10T00:08:56.5086734Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:264:
2025-11-10T00:08:56.5087506Z              .duration_since(UNIX_EPOCH)
2025-11-10T00:08:56.5087908Z              .unwrap()
2025-11-10T00:08:56.5088224Z              .as_secs();
2025-11-10T00:08:56.5088555Z -        
2025-11-10T00:08:56.5088800Z +
2025-11-10T00:08:56.5089080Z          if now > self.last_refill {
2025-11-10T00:08:56.5089524Z              let elapsed = now - self.last_refill;
2025-11-10T00:08:56.5090053Z              let tokens_to_add = (elapsed as u32) * self.rate;
2025-11-10T00:08:56.5090853Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:271:
2025-11-10T00:08:56.5091813Z -            self.tokens = self.tokens.saturating_add(tokens_to_add).min(self.burst_limit);
2025-11-10T00:08:56.5092495Z +            self.tokens = self
2025-11-10T00:08:56.5092868Z +                .tokens
2025-11-10T00:08:56.5093208Z +                .saturating_add(tokens_to_add)
2025-11-10T00:08:56.5093658Z +                .min(self.burst_limit);
2025-11-10T00:08:56.5094089Z              self.last_refill = now;
2025-11-10T00:08:56.5095114Z          }
2025-11-10T00:08:56.5095393Z      }
2025-11-10T00:08:56.5095943Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:452:
2025-11-10T00:08:56.5096807Z              enable_self_advertisement: true, // Default: advertise ourselves
2025-11-10T00:08:56.5097328Z          }
2025-11-10T00:08:56.5097568Z      }
2025-11-10T00:08:56.5097804Z -    
2025-11-10T00:08:56.5098071Z +
2025-11-10T00:08:56.5098427Z      /// Set dependencies for protocol message processing
2025-11-10T00:08:56.5098973Z      pub fn with_dependencies(
2025-11-10T00:08:56.5099338Z          mut self,
2025-11-10T00:08:56.5099940Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:525:
2025-11-10T00:08:56.5100808Z      /// Discover peers from DNS seeds and add to address database
2025-11-10T00:08:56.5101610Z      pub async fn discover_peers_from_dns(&self, network: &str, port: u16) -> Result<()> {
2025-11-10T00:08:56.5102324Z          use crate::network::dns_seeds;
2025-11-10T00:08:56.5102730Z -        
2025-11-10T00:08:56.5102999Z +
2025-11-10T00:08:56.5103277Z          let seeds = match network {
2025-11-10T00:08:56.5103747Z              "mainnet" => dns_seeds::MAINNET_DNS_SEEDS,
2025-11-10T00:08:56.5104250Z              "testnet" => dns_seeds::TESTNET_DNS_SEEDS,
2025-11-10T00:08:56.5105656Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:534:
2025-11-10T00:08:56.5106424Z                  return Ok(());
2025-11-10T00:08:56.5106786Z              }
2025-11-10T00:08:56.5107334Z          };
2025-11-10T00:08:56.5107984Z -        
2025-11-10T00:08:56.5108368Z +
2025-11-10T00:08:56.5109210Z          info!("Discovering peers from DNS seeds for {}", network);
2025-11-10T00:08:56.5129323Z          let addresses = dns_seeds::resolve_dns_seeds(seeds, port, 100).await;
2025-11-10T00:08:56.5129968Z -        
2025-11-10T00:08:56.5130244Z +
2025-11-10T00:08:56.5130576Z          // Add discovered addresses to database
2025-11-10T00:08:56.5131017Z          {
2025-11-10T00:08:56.5131825Z              let mut db = self.address_database.lock().unwrap();
2025-11-10T00:08:56.5132658Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:545:
2025-11-10T00:08:56.5133578Z                  db.add_address(addr, 0); // Services will be updated on connection
2025-11-10T00:08:56.5136136Z              }
2025-11-10T00:08:56.5136442Z          }
2025-11-10T00:08:56.5136721Z -        
2025-11-10T00:08:56.5136984Z +
2025-11-10T00:08:56.5137416Z          info!("Discovered {} addresses from DNS seeds", addresses.len());
2025-11-10T00:08:56.5138263Z          Ok(())
2025-11-10T00:08:56.5138559Z      }
2025-11-10T00:08:56.5139161Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:555:
2025-11-10T00:08:56.5139950Z          for peer_addr in persistent_peers {
2025-11-10T00:08:56.5140421Z              // Add to persistent peer set
2025-11-10T00:08:56.5140903Z              self.add_persistent_peer(*peer_addr);
2025-11-10T00:08:56.5141351Z -            
2025-11-10T00:08:56.5141626Z +
2025-11-10T00:08:56.5141907Z              // Try to connect
2025-11-10T00:08:56.5142381Z              info!("Connecting to persistent peer: {}", peer_addr);
2025-11-10T00:08:56.5143010Z              if let Err(e) = self.connect_to_peer(*peer_addr).await {
2025-11-10T00:08:56.5143839Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:566:
2025-11-10T00:08:56.5144736Z      }
2025-11-10T00:08:56.5145009Z  
2025-11-10T00:08:56.5145383Z      /// Discover Iroh peers and add to address database
2025-11-10T00:08:56.5145883Z -    /// 
2025-11-10T00:08:56.5146156Z +    ///
2025-11-10T00:08:56.5146477Z      /// Iroh peers are discovered through:
2025-11-10T00:08:56.5146994Z      /// 1. Incoming connections (automatically stored)
2025-11-10T00:08:56.5147508Z      /// 2. DERP servers (if configured)
2025-11-10T00:08:56.5148260Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:573:
2025-11-10T00:08:56.5149037Z      /// 3. Gossip discovery (if available)
2025-11-10T00:08:56.5149444Z -    /// 
2025-11-10T00:08:56.5149717Z +    ///
2025-11-10T00:08:56.5150217Z      /// This method can be extended to use Iroh's gossip discovery APIs when available.
2025-11-10T00:08:56.5150868Z      #[cfg(feature = "iroh")]
2025-11-10T00:08:56.5151361Z      pub async fn discover_iroh_peers(&self) -> Result<usize> {
2025-11-10T00:08:56.5152200Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:579:
2025-11-10T00:08:56.5155267Z          // 1. Incoming connections (handled automatically in accept loop)
2025-11-10T00:08:56.5155899Z          // 2. DERP servers (configured in IrohTransport)
2025-11-10T00:08:56.5156536Z          // 3. Gossip discovery (would require iroh-gossip-discovery crate)
2025-11-10T00:08:56.5157083Z -        
2025-11-10T00:08:56.5157359Z +
2025-11-10T00:08:56.5157636Z          // For now, we rely on:
2025-11-10T00:08:56.5158059Z          // - Persistent Iroh peers from config
2025-11-10T00:08:56.5158595Z          // - Incoming connections (stored automatically)
2025-11-10T00:08:56.5159402Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:586:
2025-11-10T00:08:56.5160228Z          // - DERP servers (handled by Iroh's MagicEndpoint)
2025-11-10T00:08:56.5160697Z -        
2025-11-10T00:08:56.5160971Z +
2025-11-10T00:08:56.5161385Z          // Future: Integrate with iroh-gossip-discovery when available
2025-11-10T00:08:56.5162198Z          info!("Iroh peer discovery: relying on DERP servers and incoming connections");
2025-11-10T00:08:56.5165244Z          Ok(0) // Return 0 for now - discovery happens through Iroh's native mechanisms
2025-11-10T00:08:56.5166186Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:593:
2025-11-10T00:08:56.5166998Z      /// Connect to Iroh peers from address database
2025-11-10T00:08:56.5167475Z      #[cfg(feature = "iroh")]
2025-11-10T00:08:56.5168166Z      pub async fn connect_iroh_peers_from_database(&self, target_count: usize) -> Result<usize> {
2025-11-10T00:08:56.5168970Z -        use crate::network::transport::TransportAddr;
2025-11-10T00:08:56.5169493Z          use crate::network::peer::Peer;
2025-11-10T00:08:56.5169917Z -        
2025-11-10T00:08:56.5170271Z +        use crate::network::transport::TransportAddr;
2025-11-10T00:08:56.5170735Z +
2025-11-10T00:08:56.5171021Z          // Count current Iroh peers
2025-11-10T00:08:56.5171430Z          let current_iroh_count = {
2025-11-10T00:08:56.5172076Z              let pm = self.peer_manager.lock().unwrap();
2025-11-10T00:08:56.5173652Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:604:
2025-11-10T00:08:56.5174716Z                  .filter(|addr| matches!(addr, TransportAddr::Iroh(_)))
2025-11-10T00:08:56.5175258Z                  .count()
2025-11-10T00:08:56.5175595Z          };
2025-11-10T00:08:56.5175870Z -        
2025-11-10T00:08:56.5176152Z +
2025-11-10T00:08:56.5176469Z          if current_iroh_count >= target_count {
2025-11-10T00:08:56.5177322Z              return Ok(0);
2025-11-10T00:08:56.5177672Z          }
2025-11-10T00:08:56.5178276Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:611:
2025-11-10T00:08:56.5178971Z -        
2025-11-10T00:08:56.5179229Z +
2025-11-10T00:08:56.5179548Z          let needed = target_count - current_iroh_count;
2025-11-10T00:08:56.5180285Z -        info!("Need {} more Iroh peers (current: {}, target: {})", needed, current_iroh_count, target_count);
2025-11-10T00:08:56.5180973Z -        
2025-11-10T00:08:56.5181226Z +        info!(
2025-11-10T00:08:56.5181594Z +            "Need {} more Iroh peers (current: {}, target: {})",
2025-11-10T00:08:56.5182104Z +            needed, current_iroh_count, target_count
2025-11-10T00:08:56.5182524Z +        );
2025-11-10T00:08:56.5182771Z +
2025-11-10T00:08:56.5183068Z          // Get fresh Iroh NodeIds from database
2025-11-10T00:08:56.5183499Z          let node_ids = {
2025-11-10T00:08:56.5183909Z              let db = self.address_database.lock().unwrap();
2025-11-10T00:08:56.5184863Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:618:
2025-11-10T00:08:56.5185743Z              db.get_fresh_iroh_addresses(needed * 2) // Get 2x needed for retries
2025-11-10T00:08:56.5186310Z          };
2025-11-10T00:08:56.5186578Z -        
2025-11-10T00:08:56.5186824Z +
2025-11-10T00:08:56.5187074Z          if node_ids.is_empty() {
2025-11-10T00:08:56.5187560Z              warn!("No fresh Iroh addresses available in database");
2025-11-10T00:08:56.5188075Z              return Ok(0);
2025-11-10T00:08:56.5188717Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:624:
2025-11-10T00:08:56.5189457Z          }
2025-11-10T00:08:56.5189733Z -        
2025-11-10T00:08:56.5190009Z +
2025-11-10T00:08:56.5190285Z          // Get Iroh transport
2025-11-10T00:08:56.5190756Z          let iroh_transport = match &self.iroh_transport {
2025-11-10T00:08:56.5191289Z              Some(transport) => transport,
2025-11-10T00:08:56.5192052Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:631:
2025-11-10T00:08:56.5193230Z                  return Ok(0);
2025-11-10T00:08:56.5193609Z              }
2025-11-10T00:08:56.5193895Z          };
2025-11-10T00:08:56.5194180Z -        
2025-11-10T00:08:56.5194623Z +
2025-11-10T00:08:56.5194942Z          // Try to connect to Iroh peers
2025-11-10T00:08:56.5195413Z          let mut connected = 0;
2025-11-10T00:08:56.5196201Z          for node_id in node_ids.into_iter().take(needed * 2) {
2025-11-10T00:08:56.5197050Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:638:
2025-11-10T00:08:56.5197870Z              let node_id_bytes = node_id.as_bytes().to_vec();
2025-11-10T00:08:56.5198547Z              let transport_addr = TransportAddr::Iroh(node_id_bytes.clone());
2025-11-10T00:08:56.5199117Z -            
2025-11-10T00:08:56.5199405Z +
2025-11-10T00:08:56.5199717Z              // Connect directly using Iroh transport
2025-11-10T00:08:56.5200319Z              match iroh_transport.connect(transport_addr.clone()).await {
2025-11-10T00:08:56.5200905Z                  Ok(conn) => {
2025-11-10T00:08:56.5201599Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:650:
2025-11-10T00:08:56.5202341Z                          transport_addr.clone(),
2025-11-10T00:08:56.5202816Z                          self.peer_tx.clone(),
2025-11-10T00:08:56.5203477Z                      );
2025-11-10T00:08:56.5203794Z -                    
2025-11-10T00:08:56.5204083Z +
2025-11-10T00:08:56.5204545Z                      // Add peer to manager
2025-11-10T00:08:56.5204961Z                      {
2025-11-10T00:08:56.5205369Z                          let mut pm = self.peer_manager.lock().unwrap();
2025-11-10T00:08:56.5206197Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:659:
2025-11-10T00:08:56.5206922Z                              continue;
2025-11-10T00:08:56.5207285Z                          }
2025-11-10T00:08:56.5207606Z                      }
2025-11-10T00:08:56.5207917Z -                    
2025-11-10T00:08:56.5208215Z +
2025-11-10T00:08:56.5208522Z                      // Store mapping for Iroh (if needed)
2025-11-10T00:08:56.5208951Z                      {
2025-11-10T00:08:56.5209472Z                          let mut socket_to_transport = self.socket_to_transport.lock().unwrap();
2025-11-10T00:08:56.5210423Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:666:
2025-11-10T00:08:56.5211373Z                          socket_to_transport.insert(placeholder_socket, transport_addr.clone());
2025-11-10T00:08:56.5211965Z                      }
2025-11-10T00:08:56.5212259Z -                    
2025-11-10T00:08:56.5212549Z +
2025-11-10T00:08:56.5212919Z                      info!("Successfully connected to Iroh peer: {}", node_id);
2025-11-10T00:08:56.5213461Z                      connected += 1;
2025-11-10T00:08:56.5213851Z                      if connected >= needed {
2025-11-10T00:08:56.5216387Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:677:
2025-11-10T00:08:56.5217134Z                  }
2025-11-10T00:08:56.5217427Z              }
2025-11-10T00:08:56.5217713Z          }
2025-11-10T00:08:56.5217959Z -        
2025-11-10T00:08:56.5218423Z -        info!("Connected to {} new Iroh peers from address database", connected);
2025-11-10T00:08:56.5219053Z +
2025-11-10T00:08:56.5219321Z +        info!(
2025-11-10T00:08:56.5219738Z +            "Connected to {} new Iroh peers from address database",
2025-11-10T00:08:56.5220263Z +            connected
2025-11-10T00:08:56.5220574Z +        );
2025-11-10T00:08:56.5220856Z          Ok(connected)
2025-11-10T00:08:56.5221167Z      }
2025-11-10T00:08:56.5221424Z  
2025-11-10T00:08:56.5222025Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:685:
2025-11-10T00:08:56.5222908Z      /// Connect to peers from address database when below target count
2025-11-10T00:08:56.5223470Z -    /// 
2025-11-10T00:08:56.5223737Z +    ///
2025-11-10T00:08:56.5224234Z      /// Works with both SocketAddr-based addresses (TCP/Quinn) and Iroh NodeIds.
2025-11-10T00:08:56.5225322Z      pub async fn connect_peers_from_database(&self, target_count: usize) -> Result<usize> {
2025-11-10T00:08:56.5226071Z          let current_count = self.peer_count();
2025-11-10T00:08:56.5226858Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:692:
2025-11-10T00:08:56.5227862Z          }
2025-11-10T00:08:56.5228138Z  
2025-11-10T00:08:56.5228458Z          let needed = target_count - current_count;
2025-11-10T00:08:56.5229184Z -        info!("Need {} more peers (current: {}, target: {})", needed, current_count, target_count);
2025-11-10T00:08:56.5229835Z +        info!(
2025-11-10T00:08:56.5230207Z +            "Need {} more peers (current: {}, target: {})",
2025-11-10T00:08:56.5230691Z +            needed, current_count, target_count
2025-11-10T00:08:56.5231089Z +        );
2025-11-10T00:08:56.5233224Z  
2025-11-10T00:08:56.5233493Z          // Get fresh addresses from database
2025-11-10T00:08:56.5234014Z          let ban_list = self.ban_list.lock().unwrap().clone();
2025-11-10T00:08:56.5235020Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:715:
2025-11-10T00:08:56.5235790Z          // Convert addresses to SocketAddrs first
2025-11-10T00:08:56.5237464Z          let sockets: Vec<SocketAddr> = {
2025-11-10T00:08:56.5238273Z              let db = self.address_database.lock().unwrap();
2025-11-10T00:08:56.5238767Z -            addresses.iter()
2025-11-10T00:08:56.5239140Z +            addresses
2025-11-10T00:08:56.5239466Z +                .iter()
2025-11-10T00:08:56.5239809Z                  .take(needed * 2)
2025-11-10T00:08:56.5240251Z                  .map(|addr| db.network_addr_to_socket(addr))
2025-11-10T00:08:56.5240712Z                  .collect()
2025-11-10T00:08:56.5241813Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:724:
2025-11-10T00:08:56.5242595Z          // Try to connect to addresses
2025-11-10T00:08:56.5245167Z          let mut connected = 0;
2025-11-10T00:08:56.5245570Z          for socket in sockets {
2025-11-10T00:08:56.5245938Z -
2025-11-10T00:08:56.5246290Z              if let Err(e) = self.connect_to_peer(socket).await {
2025-11-10T00:08:56.5246908Z                  debug!("Failed to connect to {}: {}", socket, e);
2025-11-10T00:08:56.5247455Z                  // Continue trying other addresses
2025-11-10T00:08:56.5248233Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:737:
2025-11-10T00:08:56.5249489Z          }
2025-11-10T00:08:56.5249767Z  
2025-11-10T00:08:56.5250217Z          info!("Connected to {} new peers from address database", connected);
2025-11-10T00:08:56.5250775Z -        
2025-11-10T00:08:56.5251036Z +
2025-11-10T00:08:56.5253278Z          // Also try to connect Iroh peers if Iroh is enabled
2025-11-10T00:08:56.5253772Z          #[cfg(feature = "iroh")]
2025-11-10T00:08:56.5254231Z          if self.transport_preference.allows_iroh() {
2025-11-10T00:08:56.5255296Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:744:
2025-11-10T00:08:56.5256303Z              let iroh_connected = self.connect_iroh_peers_from_database(target_count).await?;
2025-11-10T00:08:56.5256980Z              connected += iroh_connected;
2025-11-10T00:08:56.5257380Z          }
2025-11-10T00:08:56.5257631Z -        
2025-11-10T00:08:56.5257885Z +
2025-11-10T00:08:56.5258126Z          Ok(connected)
2025-11-10T00:08:56.5258438Z      }
2025-11-10T00:08:56.5258701Z  
2025-11-10T00:08:56.5259256Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:751:
2025-11-10T00:08:56.5260034Z      /// Initialize peer connections after startup
2025-11-10T00:08:56.5260457Z -    /// 
2025-11-10T00:08:56.5260709Z +    ///
2025-11-10T00:08:56.5261039Z      /// This is automatically called by `start()` to:
2025-11-10T00:08:56.5261651Z      /// 1. Discover peers from DNS seeds (for TCP/Quinn transports)
2025-11-10T00:08:56.5262243Z      /// 2. Connect to persistent peers from config
2025-11-10T00:08:56.5262993Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:756:
2025-11-10T00:08:56.5265484Z      /// 3. Discover Iroh peers (if Iroh is enabled) - uses Iroh's DERP servers and gossip
2025-11-10T00:08:56.5266525Z      /// 4. Connect to peers from address database to reach target count
2025-11-10T00:08:56.5267495Z -    /// 
2025-11-10T00:08:56.5267773Z +    ///
2025-11-10T00:08:56.5268332Z      /// Note: The address database now supports both SocketAddr-based addresses (TCP/Quinn)
2025-11-10T00:08:56.5269131Z      /// and Iroh NodeIds. Iroh peers are discovered through:
2025-11-10T00:08:56.5269729Z      /// - DERP servers (handled by Iroh's MagicEndpoint)
2025-11-10T00:08:56.5270541Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:770:
2025-11-10T00:08:56.5271300Z          target_peer_count: usize,
2025-11-10T00:08:56.5271699Z      ) -> Result<()> {
2025-11-10T00:08:56.5272192Z          // 1. Discover peers from DNS seeds (only for TCP/Quinn, not Iroh)
2025-11-10T00:08:56.5273194Z -        let should_discover_dns = self.transport_preference.allows_tcp() || 
2025-11-10T00:08:56.5273971Z +        let should_discover_dns = self.transport_preference.allows_tcp() || {
2025-11-10T00:08:56.5277027Z +            #[cfg(feature = "quinn")]
2025-11-10T00:08:56.5277444Z              {
2025-11-10T00:08:56.5277780Z -                #[cfg(feature = "quinn")]
2025-11-10T00:08:56.5278203Z -                {
2025-11-10T00:08:56.5278583Z -                    self.transport_preference.allows_quinn()
2025-11-10T00:08:56.5279062Z -                }
2025-11-10T00:08:56.5279406Z -                #[cfg(not(feature = "quinn"))]
2025-11-10T00:08:56.5279844Z -                {
2025-11-10T00:08:56.5280154Z -                    false
2025-11-10T00:08:56.5280502Z -                }
2025-11-10T00:08:56.5280793Z -            };
2025-11-10T00:08:56.5281175Z +                self.transport_preference.allows_quinn()
2025-11-10T00:08:56.5281615Z +            }
2025-11-10T00:08:56.5281950Z +            #[cfg(not(feature = "quinn"))]
2025-11-10T00:08:56.5282376Z +            {
2025-11-10T00:08:56.5282659Z +                false
2025-11-10T00:08:56.5282988Z +            }
2025-11-10T00:08:56.5283275Z +        };
2025-11-10T00:08:56.5283581Z          if should_discover_dns {
2025-11-10T00:08:56.5284130Z              if let Err(e) = self.discover_peers_from_dns(network, port).await {
2025-11-10T00:08:56.5286864Z                  warn!("DNS seed discovery failed: {}", e);
2025-11-10T00:08:56.5287671Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:807:
2025-11-10T00:08:56.5288548Z          // 4. Connect to peers from address database to reach target count
2025-11-10T00:08:56.5289175Z          // Wait a bit for persistent peers to connect first
2025-11-10T00:08:56.5289792Z          tokio::time::sleep(tokio::time::Duration::from_secs(2)).await;
2025-11-10T00:08:56.5290297Z -        
2025-11-10T00:08:56.5290553Z +
2025-11-10T00:08:56.5291019Z          if let Err(e) = self.connect_peers_from_database(target_peer_count).await {
2025-11-10T00:08:56.5291732Z              warn!("Failed to connect peers from database: {}", e);
2025-11-10T00:08:56.5292244Z          }
2025-11-10T00:08:56.5292700Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:821:
2025-11-10T00:08:56.5292978Z              "Starting network manager with transport preference: {:?}",
2025-11-10T00:08:56.5293151Z              self.transport_preference
2025-11-10T00:08:56.5293264Z          );
2025-11-10T00:08:56.5293375Z -        
2025-11-10T00:08:56.5293491Z +
2025-11-10T00:08:56.5293632Z          // Start listening first
2025-11-10T00:08:56.5293740Z  
2025-11-10T00:08:56.5293912Z          // Initialize Quinn transport if enabled
2025-11-10T00:08:56.5296121Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:886:
2025-11-10T00:08:56.5296470Z                              let ip = socket_addr.ip();
2025-11-10T00:08:56.5296692Z                              if !dos_protection.check_connection(ip).await {
2025-11-10T00:08:56.5297071Z                                  warn!("Connection rate limit exceeded for IP {}, rejecting connection", ip);
2025-11-10T00:08:56.5297488Z -                                
2025-11-10T00:08:56.5297598Z +
2025-11-10T00:08:56.5297791Z                                  // Check if we should auto-ban
2025-11-10T00:08:56.5298004Z                                  if dos_protection.should_auto_ban(ip).await {
2025-11-10T00:08:56.5298778Z                                      warn!("Auto-banning IP {} for repeated connection rate violations", ip);
2025-11-10T00:08:56.5299267Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:899:
2025-11-10T00:08:56.5299497Z                                      let mut ban_list_guard = ban_list.lock().unwrap();
2025-11-10T00:08:56.5299739Z                                      ban_list_guard.insert(socket_addr, unban_timestamp);
2025-11-10T00:08:56.5300258Z                                  }
2025-11-10T00:08:56.5300407Z -                                
2025-11-10T00:08:56.5300514Z +
2025-11-10T00:08:56.5300954Z                                  // Close connection immediately
2025-11-10T00:08:56.5301122Z                                  drop(conn);
2025-11-10T00:08:56.5301266Z                                  continue;
2025-11-10T00:08:56.5301732Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:910:
2025-11-10T00:08:56.5301953Z                                  let pm = peer_manager_clone.lock().unwrap();
2025-11-10T00:08:56.5302103Z                                  pm.peer_count()
2025-11-10T00:08:56.5302226Z                              };
2025-11-10T00:08:56.5302581Z -                            if !dos_protection.check_active_connections(current_connections).await {
2025-11-10T00:08:56.5302739Z +                            if !dos_protection
2025-11-10T00:08:56.5302954Z +                                .check_active_connections(current_connections)
2025-11-10T00:08:56.5303082Z +                                .await
2025-11-10T00:08:56.5303214Z +                            {
2025-11-10T00:08:56.5303637Z                                  warn!("Active connection limit exceeded, rejecting connection from {}", socket_addr);
2025-11-10T00:08:56.5305745Z                                  drop(conn);
2025-11-10T00:08:56.5305894Z                                  continue;
2025-11-10T00:08:56.5306350Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:918:
2025-11-10T00:08:56.5306461Z  
2025-11-10T00:08:56.5306638Z                              // Send connection notification
2025-11-10T00:08:56.5306909Z                              let transport_addr = TransportAddr::Tcp(socket_addr);
2025-11-10T00:08:56.5307283Z -                            let _ = peer_tx.send(NetworkMessage::PeerConnected(transport_addr.clone()));
2025-11-10T00:08:56.5307413Z +                            let _ =
2025-11-10T00:08:56.5307765Z +                                peer_tx.send(NetworkMessage::PeerConnected(transport_addr.clone()));
2025-11-10T00:08:56.5307876Z  
2025-11-10T00:08:56.5308170Z                              // Handle connection in background with graceful error handling
2025-11-10T00:08:56.5308366Z                              let peer_tx_clone = peer_tx.clone();
2025-11-10T00:08:56.5308824Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:927:
2025-11-10T00:08:56.5309020Z                                  // Create peer from transport connection
2025-11-10T00:08:56.5309215Z                                  use crate::network::peer::Peer;
2025-11-10T00:08:56.5309431Z                                  use crate::network::transport::TransportAddr;
2025-11-10T00:08:56.5309649Z -                                
2025-11-10T00:08:56.5309762Z +
2025-11-10T00:08:56.5309990Z                                  let peer = peer::Peer::from_transport_connection(
2025-11-10T00:08:56.5310121Z                                      conn,
2025-11-10T00:08:56.5310268Z                                      socket_addr,
2025-11-10T00:08:56.5310747Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:934:
2025-11-10T00:08:56.5311250Z                                      TransportAddr::Tcp(socket_addr),
2025-11-10T00:08:56.5311425Z                                      peer_tx_clone.clone(),
2025-11-10T00:08:56.5311552Z                                  );
2025-11-10T00:08:56.5311668Z -                                
2025-11-10T00:08:56.5311856Z +
2025-11-10T00:08:56.5312097Z                                  // Add peer to manager (with graceful error handling)
2025-11-10T00:08:56.5312296Z                                  match peer_manager_for_peer.lock() {
2025-11-10T00:08:56.5312450Z                                      Ok(mut pm) => {
2025-11-10T00:08:56.5312900Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:941:
2025-11-10T00:08:56.5313173Z                                          if let Err(e) = pm.add_peer(transport_addr.clone(), peer) {
2025-11-10T00:08:56.5315024Z                                              warn!("Failed to add peer {}: {}", socket_addr, e);
2025-11-10T00:08:56.5315816Z -                                            let _ = peer_tx_clone.send(NetworkMessage::PeerDisconnected(transport_addr.clone()));
2025-11-10T00:08:56.5316014Z +                                            let _ = peer_tx_clone.send(
2025-11-10T00:08:56.5316300Z +                                                NetworkMessage::PeerDisconnected(
2025-11-10T00:08:56.5316477Z +                                                    transport_addr.clone(),
2025-11-10T00:08:56.5316627Z +                                                ),
2025-11-10T00:08:56.5316841Z +                                            );
2025-11-10T00:08:56.5316986Z                                              return;
2025-11-10T00:08:56.5317183Z                                          }
2025-11-10T00:08:56.5317971Z -                                        info!("Successfully added peer {} (transport: {:?})", socket_addr, transport_addr);
2025-11-10T00:08:56.5318130Z +                                        info!(
2025-11-10T00:08:56.5318367Z +                                            "Successfully added peer {} (transport: {:?})",
2025-11-10T00:08:56.5318550Z +                                            socket_addr, transport_addr
2025-11-10T00:08:56.5318672Z +                                        );
2025-11-10T00:08:56.5318792Z                                      }
2025-11-10T00:08:56.5318942Z                                      Err(e) => {
2025-11-10T00:08:56.5319236Z -                                        warn!("Failed to lock peer manager for {}: {}", socket_addr, e);
2025-11-10T00:08:56.5319664Z -                                        let _ = peer_tx_clone.send(NetworkMessage::PeerDisconnected(transport_addr.clone()));
2025-11-10T00:08:56.5319796Z +                                        warn!(
2025-11-10T00:08:56.5320005Z +                                            "Failed to lock peer manager for {}: {}",
2025-11-10T00:08:56.5320169Z +                                            socket_addr, e
2025-11-10T00:08:56.5320300Z +                                        );
2025-11-10T00:08:56.5320440Z +                                        let _ =
2025-11-10T00:08:56.5320704Z +                                            peer_tx_clone.send(NetworkMessage::PeerDisconnected(
2025-11-10T00:08:56.5320865Z +                                                transport_addr.clone(),
2025-11-10T00:08:56.5320997Z +                                            ));
2025-11-10T00:08:56.5321127Z                                          return;
2025-11-10T00:08:56.5321250Z                                      }
2025-11-10T00:08:56.5321373Z                                  }
2025-11-10T00:08:56.5321844Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:954:
2025-11-10T00:08:56.5321969Z -                                
2025-11-10T00:08:56.5322078Z +
2025-11-10T00:08:56.5322429Z                                  // Connection will be cleaned up automatically when read/write tasks exit
2025-11-10T00:08:56.5323096Z                                  // Peer removal happens in process_messages when PeerDisconnected is received
2025-11-10T00:08:56.5323227Z                              });
2025-11-10T00:08:56.5323764Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:974:
2025-11-10T00:08:56.5323984Z                      let peer_manager = Arc::clone(&self.peer_manager);
2025-11-10T00:08:56.5324704Z                      let dos_protection = Arc::clone(&self.dos_protection);
2025-11-10T00:08:56.5324902Z                      let ban_list = Arc::clone(&self.ban_list);
2025-11-10T00:08:56.5325014Z -                    
2025-11-10T00:08:56.5325114Z +
2025-11-10T00:08:56.5325269Z                      tokio::spawn(async move {
2025-11-10T00:08:56.5325385Z                          loop {
2025-11-10T00:08:56.5325554Z                              match quinn_listener.accept().await {
2025-11-10T00:08:56.5326193Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:993:
2025-11-10T00:08:56.5326374Z                                      let ip = socket_addr.ip();
2025-11-10T00:08:56.5326579Z                                      if !dos_protection.check_connection(ip).await {
2025-11-10T00:08:56.5326956Z                                          warn!("Connection rate limit exceeded for IP {}, rejecting Quinn connection", ip);
2025-11-10T00:08:56.5327090Z -                                        
2025-11-10T00:08:56.5327190Z +
2025-11-10T00:08:56.5327389Z                                          if dos_protection.should_auto_ban(ip).await {
2025-11-10T00:08:56.5327709Z                                              warn!("Auto-banning IP {} for repeated connection rate violations", ip);
2025-11-10T00:08:56.5327939Z                                              let unban_timestamp = std::time::SystemTime::now()
2025-11-10T00:08:56.5328385Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1013:
2025-11-10T00:08:56.5328604Z                                          let pm = peer_manager.lock().unwrap();
2025-11-10T00:08:56.5328764Z                                          pm.peer_count()
2025-11-10T00:08:56.5328889Z                                      };
2025-11-10T00:08:56.5329313Z -                                    if !dos_protection.check_active_connections(current_connections).await {
2025-11-10T00:08:56.5329483Z +                                    if !dos_protection
2025-11-10T00:08:56.5329705Z +                                        .check_active_connections(current_connections)
2025-11-10T00:08:56.5329837Z +                                        .await
2025-11-10T00:08:56.5329970Z +                                    {
2025-11-10T00:08:56.5330428Z                                          warn!("Active connection limit exceeded, rejecting Quinn connection from {}", socket_addr);
2025-11-10T00:08:56.5330582Z                                          drop(conn);
2025-11-10T00:08:56.5330750Z                                          continue;
2025-11-10T00:08:56.5331218Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1021:
2025-11-10T00:08:56.5331398Z  
2025-11-10T00:08:56.5331583Z                                      // Send connection notification
2025-11-10T00:08:56.5331906Z                                      let quinn_transport_addr = TransportAddr::Quinn(socket_addr);
2025-11-10T00:08:56.5332318Z -                                    let _ = peer_tx.send(NetworkMessage::PeerConnected(quinn_transport_addr.clone()));
2025-11-10T00:08:56.5332555Z +                                    let _ = peer_tx.send(NetworkMessage::PeerConnected(
2025-11-10T00:08:56.5332741Z +                                        quinn_transport_addr.clone(),
2025-11-10T00:08:56.5332915Z +                                    ));
2025-11-10T00:08:56.5333013Z  
2025-11-10T00:08:56.5333304Z                                      // Handle connection in background with graceful error handling
2025-11-10T00:08:56.5333745Z                                      let peer_tx_clone = peer_tx.clone();
2025-11-10T00:08:56.5334204Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1029:
2025-11-10T00:08:56.5334575Z                                      tokio::spawn(async move {
2025-11-10T00:08:56.5334772Z                                          use crate::network::peer::Peer;
2025-11-10T00:08:56.5334995Z                                          use crate::network::transport::TransportAddr;
2025-11-10T00:08:56.5335137Z -                                        
2025-11-10T00:08:56.5335247Z +
2025-11-10T00:08:56.5335487Z                                          let quinn_addr = TransportAddr::Quinn(socket_addr);
2025-11-10T00:08:56.5335720Z                                          let peer = peer::Peer::from_transport_connection(
2025-11-10T00:08:56.5335869Z                                              conn,
2025-11-10T00:08:56.5336554Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1037:
2025-11-10T00:08:56.5336712Z                                              quinn_addr,
2025-11-10T00:08:56.5336890Z                                              peer_tx_clone.clone(),
2025-11-10T00:08:56.5337016Z                                          );
2025-11-10T00:08:56.5337136Z -                                        
2025-11-10T00:08:56.5337248Z +
2025-11-10T00:08:56.5337471Z                                          // Add peer to manager (with graceful error handling)
2025-11-10T00:08:56.5337648Z                                          match peer_manager_clone.lock() {
2025-11-10T00:08:56.5337792Z                                              Ok(mut pm) => {
2025-11-10T00:08:56.5338244Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1044:
2025-11-10T00:08:56.5338493Z -                                                if let Err(e) = pm.add_peer(quinn_addr.clone(), peer) {
2025-11-10T00:08:56.5338769Z -                                                    warn!("Failed to add Quinn peer {}: {}", socket_addr, e);
2025-11-10T00:08:56.5339168Z -                                                    let _ = peer_tx_clone.send(NetworkMessage::PeerDisconnected(quinn_addr.clone()));
2025-11-10T00:08:56.5339324Z +                                                if let Err(e) =
2025-11-10T00:08:56.5339515Z +                                                    pm.add_peer(quinn_addr.clone(), peer)
2025-11-10T00:08:56.5339652Z +                                                {
2025-11-10T00:08:56.5339798Z +                                                    warn!(
2025-11-10T00:08:56.5339974Z +                                                        "Failed to add Quinn peer {}: {}",
2025-11-10T00:08:56.5340138Z +                                                        socket_addr, e
2025-11-10T00:08:56.5340278Z +                                                    );
2025-11-10T00:08:56.5340461Z +                                                    let _ = peer_tx_clone.send(
2025-11-10T00:08:56.5340676Z +                                                        NetworkMessage::PeerDisconnected(
2025-11-10T00:08:56.5340847Z +                                                            quinn_addr.clone(),
2025-11-10T00:08:56.5340982Z +                                                        ),
2025-11-10T00:08:56.5341110Z +                                                    );
2025-11-10T00:08:56.5343148Z                                                      return;
2025-11-10T00:08:56.5343281Z                                                  }
2025-11-10T00:08:56.5343544Z -                                                info!("Successfully added Quinn peer {}", socket_addr);
2025-11-10T00:08:56.5343693Z +                                                info!(
2025-11-10T00:08:56.5343886Z +                                                    "Successfully added Quinn peer {}",
2025-11-10T00:08:56.5344038Z +                                                    socket_addr
2025-11-10T00:08:56.5344577Z +                                                );
2025-11-10T00:08:56.5344718Z                                              }
2025-11-10T00:08:56.5344867Z                                              Err(e) => {
2025-11-10T00:08:56.5345206Z                                                  warn!("Failed to lock peer manager for Quinn peer {}: {}", socket_addr, e);
2025-11-10T00:08:56.5345655Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1053:
2025-11-10T00:08:56.5346066Z -                                                let _ = peer_tx_clone.send(NetworkMessage::PeerDisconnected(quinn_addr.clone()));
2025-11-10T00:08:56.5346232Z +                                                let _ = peer_tx_clone.send(
2025-11-10T00:08:56.5346444Z +                                                    NetworkMessage::PeerDisconnected(
2025-11-10T00:08:56.5346862Z +                                                        quinn_addr.clone(),
2025-11-10T00:08:56.5347004Z +                                                    ),
2025-11-10T00:08:56.5347148Z +                                                );
2025-11-10T00:08:56.5347284Z                                                  return;
2025-11-10T00:08:56.5347408Z                                              }
2025-11-10T00:08:56.5347539Z                                          }
2025-11-10T00:08:56.5347978Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1065:
2025-11-10T00:08:56.5348098Z                      });
2025-11-10T00:08:56.5348211Z                  }
2025-11-10T00:08:56.5348350Z                  Err(e) => {
2025-11-10T00:08:56.5348661Z -                    warn!("Failed to start Quinn listener (graceful degradation): {}", e);
2025-11-10T00:08:56.5348785Z +                    warn!(
2025-11-10T00:08:56.5349040Z +                        "Failed to start Quinn listener (graceful degradation): {}",
2025-11-10T00:08:56.5349165Z +                        e
2025-11-10T00:08:56.5349277Z +                    );
2025-11-10T00:08:56.5349557Z                      // Continue with other transports - don't fail entire startup
2025-11-10T00:08:56.5349672Z                  }
2025-11-10T00:08:56.5349780Z              }
2025-11-10T00:08:56.5350221Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1107:
2025-11-10T00:08:56.5350423Z                                          let pm = peer_manager.lock().unwrap();
2025-11-10T00:08:56.5350577Z                                          pm.peer_count()
2025-11-10T00:08:56.5350702Z                                      };
2025-11-10T00:08:56.5351062Z -                                    if !dos_protection.check_active_connections(current_connections).await {
2025-11-10T00:08:56.5351212Z +                                    if !dos_protection
2025-11-10T00:08:56.5351432Z +                                        .check_active_connections(current_connections)
2025-11-10T00:08:56.5353213Z +                                        .await
2025-11-10T00:08:56.5353337Z +                                    {
2025-11-10T00:08:56.5353661Z                                          warn!("Active connection limit exceeded, rejecting Iroh connection");
2025-11-10T00:08:56.5353801Z                                          drop(conn);
2025-11-10T00:08:56.5353943Z                                          continue;
2025-11-10T00:08:56.5354564Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1114:
2025-11-10T00:08:56.5354689Z                                      }
2025-11-10T00:08:56.5354807Z  
2025-11-10T00:08:56.5355081Z                                      // Send connection notification using TransportAddr directly
2025-11-10T00:08:56.5355426Z -                                    let _ = peer_tx.send(NetworkMessage::PeerConnected(iroh_addr.clone()));
2025-11-10T00:08:56.5355593Z +                                    let _ = peer_tx
2025-11-10T00:08:56.5356099Z +                                        .send(NetworkMessage::PeerConnected(iroh_addr.clone()));
2025-11-10T00:08:56.5356203Z  
2025-11-10T00:08:56.5356494Z                                      // Handle connection in background with graceful error handling
2025-11-10T00:08:56.5356693Z                                      let peer_tx_clone = peer_tx.clone();
2025-11-10T00:08:56.5357145Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1121:
2025-11-10T00:08:56.5357379Z                                      let peer_manager_clone = Arc::clone(&peer_manager);
2025-11-10T00:08:56.5357571Z                                      let iroh_addr_clone = iroh_addr.clone();
2025-11-10T00:08:56.5357879Z -                                    let socket_to_transport_clone = Arc::clone(&socket_to_transport);
2025-11-10T00:08:56.5358048Z +                                    let socket_to_transport_clone =
2025-11-10T00:08:56.5358421Z +                                        Arc::clone(&socket_to_transport);
2025-11-10T00:08:56.5358709Z                                      let address_database_clone = Arc::clone(&address_database);
2025-11-10T00:08:56.5358883Z                                      tokio::spawn(async move {
2025-11-10T00:08:56.5359078Z                                          use crate::network::peer::Peer;
2025-11-10T00:08:56.5359534Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1127:
2025-11-10T00:08:56.5359670Z -                                        
2025-11-10T00:08:56.5359786Z +
2025-11-10T00:08:56.5360083Z                                          // For Iroh, we need a SocketAddr for Peer::from_transport_connection
2025-11-10T00:08:56.5360369Z                                          // Generate a unique placeholder based on key hash for lookups
2025-11-10T00:08:56.5360775Z -                                        let placeholder_socket = if let TransportAddr::Iroh(ref key) = iroh_addr_clone {
2025-11-10T00:08:56.5361161Z -                                            // Use first 4 bytes of key for IP, last 2 bytes for port to create unique placeholder
2025-11-10T00:08:56.5372823Z -                                            let ip_bytes = if key.len() >= 4 {
2025-11-10T00:08:56.5373121Z -                                                [key[0], key[1], key[2], key[3]]
2025-11-10T00:08:56.5373308Z +                                        let placeholder_socket =
2025-11-10T00:08:56.5373578Z +                                            if let TransportAddr::Iroh(ref key) = iroh_addr_clone {
2025-11-10T00:08:56.5373962Z +                                                // Use first 4 bytes of key for IP, last 2 bytes for port to create unique placeholder
2025-11-10T00:08:56.5374145Z +                                                let ip_bytes = if key.len() >= 4 {
2025-11-10T00:08:56.5374480Z +                                                    [key[0], key[1], key[2], key[3]]
2025-11-10T00:08:56.5374644Z +                                                } else {
2025-11-10T00:08:56.5374801Z +                                                    [0, 0, 0, 0]
2025-11-10T00:08:56.5374938Z +                                                };
2025-11-10T00:08:56.5375118Z +                                                let port = if key.len() >= 6 {
2025-11-10T00:08:56.5375279Z +                                                    u16::from_be_bytes([
2025-11-10T00:08:56.5375447Z +                                                        key[key.len() - 2],
2025-11-10T00:08:56.5375613Z +                                                        key[key.len() - 1],
2025-11-10T00:08:56.5375754Z +                                                    ])
2025-11-10T00:08:56.5375870Z +                                                } else {
2025-11-10T00:08:56.5377673Z +                                                    0
2025-11-10T00:08:56.5377799Z +                                                };
2025-11-10T00:08:56.5378031Z +                                                std::net::SocketAddr::from((ip_bytes, port))
2025-11-10T00:08:56.5378427Z                                              } else {
2025-11-10T00:08:56.5378574Z -                                                [0, 0, 0, 0]
2025-11-10T00:08:56.5378773Z +                                                std::net::SocketAddr::from(([0, 0, 0, 0], 0))
2025-11-10T00:08:56.5378912Z                                              };
2025-11-10T00:08:56.5379071Z -                                            let port = if key.len() >= 6 {
2025-11-10T00:08:56.5379304Z -                                                u16::from_be_bytes([key[key.len()-2], key[key.len()-1]])
2025-11-10T00:08:56.5379447Z -                                            } else {
2025-11-10T00:08:56.5379586Z -                                                0
2025-11-10T00:08:56.5379718Z -                                            };
2025-11-10T00:08:56.5379936Z -                                            std::net::SocketAddr::from((ip_bytes, port))
2025-11-10T00:08:56.5380269Z -                                        } else {
2025-11-10T00:08:56.5380474Z -                                            std::net::SocketAddr::from(([0, 0, 0, 0], 0))
2025-11-10T00:08:56.5380607Z -                                        };
2025-11-10T00:08:56.5380741Z -                                        
2025-11-10T00:08:56.5380848Z +
2025-11-10T00:08:56.5381071Z                                          let peer = peer::Peer::from_transport_connection(
2025-11-10T00:08:56.5381307Z                                              conn,
2025-11-10T00:08:56.5381473Z                                              placeholder_socket,
2025-11-10T00:08:56.5381928Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1150:
2025-11-10T00:08:56.5382101Z                                              iroh_addr_clone.clone(),
2025-11-10T00:08:56.5382267Z                                              peer_tx_clone.clone(),
2025-11-10T00:08:56.5382399Z                                          );
2025-11-10T00:08:56.5382524Z -                                        
2025-11-10T00:08:56.5382636Z +
2025-11-10T00:08:56.5382858Z                                          // Add peer to manager (with graceful error handling)
2025-11-10T00:08:56.5383034Z                                          match peer_manager_clone.lock() {
2025-11-10T00:08:56.5383185Z                                              Ok(mut pm) => {
2025-11-10T00:08:56.5383613Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1157:
2025-11-10T00:08:56.5383880Z -                                                if let Err(e) = pm.add_peer(iroh_addr_clone.clone(), peer) {
2025-11-10T00:08:56.5384033Z +                                                if let Err(e) =
2025-11-10T00:08:56.5384251Z +                                                    pm.add_peer(iroh_addr_clone.clone(), peer)
2025-11-10T00:08:56.5384581Z +                                                {
2025-11-10T00:08:56.5384786Z                                                      warn!("Failed to add Iroh peer: {}", e);
2025-11-10T00:08:56.5385217Z -                                                    let _ = peer_tx_clone.send(NetworkMessage::PeerDisconnected(iroh_addr_clone.clone()));
2025-11-10T00:08:56.5385400Z +                                                    let _ = peer_tx_clone.send(
2025-11-10T00:08:56.5385601Z +                                                        NetworkMessage::PeerDisconnected(
2025-11-10T00:08:56.5385783Z +                                                            iroh_addr_clone.clone(),
2025-11-10T00:08:56.5385922Z +                                                        ),
2025-11-10T00:08:56.5386062Z +                                                    );
2025-11-10T00:08:56.5386208Z                                                      return;
2025-11-10T00:08:56.5386331Z                                                  }
2025-11-10T00:08:56.5387524Z                                                  // Store mapping from placeholder SocketAddr to TransportAddr for Iroh lookups
2025-11-10T00:08:56.5387983Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1163:
2025-11-10T00:08:56.5388426Z -                                                socket_to_transport_clone.lock().unwrap().insert(placeholder_socket, iroh_addr_clone.clone());
2025-11-10T00:08:56.5388549Z -                                                
2025-11-10T00:08:56.5388760Z +                                                socket_to_transport_clone.lock().unwrap().insert(
2025-11-10T00:08:56.5388926Z +                                                    placeholder_socket,
2025-11-10T00:08:56.5389083Z +                                                    iroh_addr_clone.clone(),
2025-11-10T00:08:56.5389202Z +                                                );
2025-11-10T00:08:56.5389307Z +
2025-11-10T00:08:56.5389698Z                                                  // Store Iroh NodeId in address database
2025-11-10T00:08:56.5389999Z -                                                if let TransportAddr::Iroh(ref node_id_bytes) = iroh_addr_clone {
2025-11-10T00:08:56.5390209Z +                                                if let TransportAddr::Iroh(ref node_id_bytes) =
2025-11-10T00:08:56.5390364Z +                                                    iroh_addr_clone
2025-11-10T00:08:56.5390494Z +                                                {
2025-11-10T00:08:56.5390670Z                                                      if node_id_bytes.len() == 32 {
2025-11-10T00:08:56.5390837Z                                                          use iroh_net::NodeId;
2025-11-10T00:08:56.5391087Z -                                                        if let Ok(node_id) = NodeId::from_bytes(node_id_bytes) {
2025-11-10T00:08:56.5391358Z -                                                            let address_db_clone = address_database_clone.clone();
2025-11-10T00:08:56.5391549Z +                                                        if let Ok(node_id) =
2025-11-10T00:08:56.5391749Z +                                                            NodeId::from_bytes(node_id_bytes)
2025-11-10T00:08:56.5391896Z +                                                        {
2025-11-10T00:08:56.5392079Z +                                                            let address_db_clone =
2025-11-10T00:08:56.5392276Z +                                                                address_database_clone.clone();
2025-11-10T00:08:56.5392463Z                                                              tokio::spawn(async move {
2025-11-10T00:08:56.5392696Z -                                                                let mut db = address_db_clone.lock().unwrap();
2025-11-10T00:08:56.5393078Z -                                                                db.add_iroh_address(node_id, 0); // Services will be updated on version exchange
2025-11-10T00:08:56.5393275Z +                                                                let mut db = address_db_clone
2025-11-10T00:08:56.5393453Z +                                                                    .lock()
2025-11-10T00:08:56.5393615Z +                                                                    .unwrap();
2025-11-10T00:08:56.5395847Z +                                                                db.add_iroh_address(node_id, 0);
2025-11-10T00:08:56.5396100Z +                                                                // Services will be updated on version exchange
2025-11-10T00:08:56.5396250Z                                                              });
2025-11-10T00:08:56.5396395Z                                                          }
2025-11-10T00:08:56.5396542Z                                                      }
2025-11-10T00:08:56.5397002Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1177:
2025-11-10T00:08:56.5397155Z                                                  }
2025-11-10T00:08:56.5397527Z -                                                
2025-11-10T00:08:56.5397659Z +
2025-11-10T00:08:56.5398015Z                                                  info!("Successfully added Iroh peer (transport: {:?})", iroh_addr_clone);
2025-11-10T00:08:56.5398147Z                                              }
2025-11-10T00:08:56.5398377Z                                              Err(e) => {
2025-11-10T00:08:56.5398836Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1182:
2025-11-10T00:08:56.5399111Z -                                                warn!("Failed to lock peer manager for Iroh peer: {}", e);
2025-11-10T00:08:56.5399571Z -                                                let _ = peer_tx_clone.send(NetworkMessage::PeerDisconnected(iroh_addr_clone.clone()));
2025-11-10T00:08:56.5399725Z +                                                warn!(
2025-11-10T00:08:56.5400230Z +                                                    "Failed to lock peer manager for Iroh peer: {}",
2025-11-10T00:08:56.5400395Z +                                                    e
2025-11-10T00:08:56.5400532Z +                                                );
2025-11-10T00:08:56.5400710Z +                                                let _ = peer_tx_clone.send(
2025-11-10T00:08:56.5400921Z +                                                    NetworkMessage::PeerDisconnected(
2025-11-10T00:08:56.5401113Z +                                                        iroh_addr_clone.clone(),
2025-11-10T00:08:56.5401251Z +                                                    ),
2025-11-10T00:08:56.5401388Z +                                                );
2025-11-10T00:08:56.5401552Z                                                  return;
2025-11-10T00:08:56.5401681Z                                              }
2025-11-10T00:08:56.5401877Z                                          }
2025-11-10T00:08:56.5402400Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1195:
2025-11-10T00:08:56.5402526Z                      });
2025-11-10T00:08:56.5402644Z                  }
2025-11-10T00:08:56.5402772Z                  Err(e) => {
2025-11-10T00:08:56.5403090Z -                    warn!("Failed to start Iroh listener (graceful degradation): {}", e);
2025-11-10T00:08:56.5403207Z +                    warn!(
2025-11-10T00:08:56.5403462Z +                        "Failed to start Iroh listener (graceful degradation): {}",
2025-11-10T00:08:56.5403595Z +                        e
2025-11-10T00:08:56.5403716Z +                    );
2025-11-10T00:08:56.5403997Z                      // Continue with other transports - don't fail entire startup
2025-11-10T00:08:56.5406065Z                  }
2025-11-10T00:08:56.5406182Z              }
2025-11-10T00:08:56.5406643Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1203:
2025-11-10T00:08:56.5406749Z  
2025-11-10T00:08:56.5406918Z          // Start periodic ban cleanup task
2025-11-10T00:08:56.5407067Z          self.start_ban_cleanup_task();
2025-11-10T00:08:56.5407176Z -        
2025-11-10T00:08:56.5407290Z +
2025-11-10T00:08:56.5407445Z          // Start pending request cleanup task
2025-11-10T00:08:56.5407584Z          self.start_request_cleanup_task();
2025-11-10T00:08:56.5407684Z -        
2025-11-10T00:08:56.5407784Z +
2025-11-10T00:08:56.5407928Z          // Start DoS protection cleanup task
2025-11-10T00:08:56.5408094Z          self.start_dos_protection_cleanup_task();
2025-11-10T00:08:56.5408211Z -        
2025-11-10T00:08:56.5408317Z +
2025-11-10T00:08:56.5408693Z          // Note: Peer connection initialization (DNS seeds, persistent peers, etc.)
2025-11-10T00:08:56.5409027Z          // should be called separately via initialize_peer_connections() after start()
2025-11-10T00:08:56.5409383Z          // This allows the caller to provide config, network type, and target peer count
2025-11-10T00:08:56.5409817Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1216:
2025-11-10T00:08:56.5410131Z -        
2025-11-10T00:08:56.5410236Z +
2025-11-10T00:08:56.5410336Z          Ok(())
2025-11-10T00:08:56.5410431Z      }
2025-11-10T00:08:56.5410528Z -    
2025-11-10T00:08:56.5410628Z +
2025-11-10T00:08:56.5410887Z      /// Generate a new request ID for async request-response patterns
2025-11-10T00:08:56.5411055Z      pub fn generate_request_id(&self) -> u64 {
2025-11-10T00:08:56.5411284Z          let mut counter = self.request_id_counter.lock().unwrap();
2025-11-10T00:08:56.5411700Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1224:
2025-11-10T00:08:56.5411852Z          *counter = counter.wrapping_add(1);
2025-11-10T00:08:56.5411966Z          id
2025-11-10T00:08:56.5412062Z      }
2025-11-10T00:08:56.5412157Z -    
2025-11-10T00:08:56.5412249Z +
2025-11-10T00:08:56.5412619Z      /// Register a pending request and return the response receiver
2025-11-10T00:08:56.5413331Z      /// Returns (request_id, response_receiver)
2025-11-10T00:08:56.5413812Z -    pub fn register_request(&self, peer_addr: SocketAddr) -> (u64, tokio::sync::oneshot::Receiver<Vec<u8>>) {
2025-11-10T00:08:56.5413950Z +    pub fn register_request(
2025-11-10T00:08:56.5414051Z +        &self,
2025-11-10T00:08:56.5414175Z +        peer_addr: SocketAddr,
2025-11-10T00:08:56.5414555Z +    ) -> (u64, tokio::sync::oneshot::Receiver<Vec<u8>>) {
2025-11-10T00:08:56.5414761Z          self.register_request_with_priority(peer_addr, 0)
2025-11-10T00:08:56.5414859Z      }
2025-11-10T00:08:56.5414962Z -    
2025-11-10T00:08:56.5415071Z +
2025-11-10T00:08:56.5415410Z      /// Register a pending request with priority and return the response receiver
2025-11-10T00:08:56.5415575Z      /// Returns (request_id, response_receiver)
2025-11-10T00:08:56.5415777Z      /// Priority: 0 = normal, higher = more important
2025-11-10T00:08:56.5416250Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1237:
2025-11-10T00:08:56.5416930Z -    pub fn register_request_with_priority(&self, peer_addr: SocketAddr, priority: u8) -> (u64, tokio::sync::oneshot::Receiver<Vec<u8>>) {
2025-11-10T00:08:56.5417106Z +    pub fn register_request_with_priority(
2025-11-10T00:08:56.5417227Z +        &self,
2025-11-10T00:08:56.5417366Z +        peer_addr: SocketAddr,
2025-11-10T00:08:56.5417492Z +        priority: u8,
2025-11-10T00:08:56.5417704Z +    ) -> (u64, tokio::sync::oneshot::Receiver<Vec<u8>>) {
2025-11-10T00:08:56.5417897Z          let request_id = self.generate_request_id();
2025-11-10T00:08:56.5418086Z          let (tx, rx) = tokio::sync::oneshot::channel();
2025-11-10T00:08:56.5418200Z -        
2025-11-10T00:08:56.5418318Z +
2025-11-10T00:08:56.5418494Z          use std::time::{SystemTime, UNIX_EPOCH};
2025-11-10T00:08:56.5418657Z          let timestamp = SystemTime::now()
2025-11-10T00:08:56.5418815Z              .duration_since(UNIX_EPOCH)
2025-11-10T00:08:56.5419283Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1244:
2025-11-10T00:08:56.5419422Z              .unwrap()
2025-11-10T00:08:56.5419551Z              .as_secs();
2025-11-10T00:08:56.5419666Z -        
2025-11-10T00:08:56.5419773Z +
2025-11-10T00:08:56.5419940Z          let pending_req = PendingRequest {
2025-11-10T00:08:56.5420069Z              sender: tx,
2025-11-10T00:08:56.5420188Z              peer_addr,
2025-11-10T00:08:56.5420645Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1251:
2025-11-10T00:08:56.5420780Z              priority,
2025-11-10T00:08:56.5420909Z              retry_count: 0,
2025-11-10T00:08:56.5421126Z          };
2025-11-10T00:08:56.5423117Z -        
2025-11-10T00:08:56.5423478Z -        self.pending_requests.lock().unwrap().insert(request_id, pending_req);
2025-11-10T00:08:56.5423588Z +
2025-11-10T00:08:56.5423730Z +        self.pending_requests
2025-11-10T00:08:56.5423856Z +            .lock()
2025-11-10T00:08:56.5423987Z +            .unwrap()
2025-11-10T00:08:56.5424656Z +            .insert(request_id, pending_req);
2025-11-10T00:08:56.5424795Z          (request_id, rx)
2025-11-10T00:08:56.5424918Z      }
2025-11-10T00:08:56.5425027Z -    
2025-11-10T00:08:56.5425137Z +
2025-11-10T00:08:56.5425369Z      /// Complete a pending request by sending the response
2025-11-10T00:08:56.5425827Z      pub fn complete_request(&self, request_id: u64, response: Vec<u8>) -> bool {
2025-11-10T00:08:56.5426082Z          let mut pending = self.pending_requests.lock().unwrap();
2025-11-10T00:08:56.5426542Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1266:
2025-11-10T00:08:56.5426672Z              false
2025-11-10T00:08:56.5426787Z          }
2025-11-10T00:08:56.5426896Z      }
2025-11-10T00:08:56.5427015Z -    
2025-11-10T00:08:56.5427127Z +
2025-11-10T00:08:56.5427273Z      /// Cancel a pending request
2025-11-10T00:08:56.5427506Z      pub fn cancel_request(&self, request_id: u64) -> bool {
2025-11-10T00:08:56.5428008Z          let mut pending = self.pending_requests.lock().unwrap();
2025-11-10T00:08:56.5428482Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1273:
2025-11-10T00:08:56.5428653Z          pending.remove(&request_id).is_some()
2025-11-10T00:08:56.5428771Z      }
2025-11-10T00:08:56.5428881Z -    
2025-11-10T00:08:56.5428990Z +
2025-11-10T00:08:56.5429170Z      /// Get pending requests for a specific peer
2025-11-10T00:08:56.5429546Z      pub fn get_pending_requests_for_peer(&self, peer_addr: SocketAddr) -> Vec<u64> {
2025-11-10T00:08:56.5429774Z          let pending = self.pending_requests.lock().unwrap();
2025-11-10T00:08:56.5430236Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1279:
2025-11-10T00:08:56.5430378Z -        pending.iter()
2025-11-10T00:08:56.5430560Z +        pending
2025-11-10T00:08:56.5430672Z +            .iter()
2025-11-10T00:08:56.5430860Z              .filter(|(_, req)| req.peer_addr == peer_addr)
2025-11-10T00:08:56.5431018Z              .map(|(id, _)| *id)
2025-11-10T00:08:56.5431146Z              .collect()
2025-11-10T00:08:56.5431597Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1283:
2025-11-10T00:08:56.5431722Z      }
2025-11-10T00:08:56.5431832Z -    
2025-11-10T00:08:56.5431935Z +
2025-11-10T00:08:56.5432181Z      /// Clean up expired requests (older than max_age_seconds)
2025-11-10T00:08:56.5432502Z      pub fn cleanup_expired_requests(&self, max_age_seconds: u64) -> usize {
2025-11-10T00:08:56.5432692Z          use std::time::{SystemTime, UNIX_EPOCH};
2025-11-10T00:08:56.5434968Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1289:
2025-11-10T00:08:56.5435128Z              .duration_since(UNIX_EPOCH)
2025-11-10T00:08:56.5435248Z              .unwrap()
2025-11-10T00:08:56.5435374Z              .as_secs();
2025-11-10T00:08:56.5435484Z -        
2025-11-10T00:08:56.5435590Z +
2025-11-10T00:08:56.5435840Z          let mut pending = self.pending_requests.lock().unwrap();
2025-11-10T00:08:56.5436019Z -        let expired: Vec<u64> = pending.iter()
2025-11-10T00:08:56.5436168Z +        let expired: Vec<u64> = pending
2025-11-10T00:08:56.5436282Z +            .iter()
2025-11-10T00:08:56.5436580Z              .filter(|(_, req)| now.saturating_sub(req.timestamp) > max_age_seconds)
2025-11-10T00:08:56.5436713Z              .map(|(id, _)| *id)
2025-11-10T00:08:56.5436833Z              .collect();
2025-11-10T00:08:56.5437286Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1298:
2025-11-10T00:08:56.5437401Z -        
2025-11-10T00:08:56.5437507Z +
2025-11-10T00:08:56.5437643Z          for id in &expired {
2025-11-10T00:08:56.5437793Z              pending.remove(id);
2025-11-10T00:08:56.5437899Z          }
2025-11-10T00:08:56.5438344Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1302:
2025-11-10T00:08:56.5438462Z -        
2025-11-10T00:08:56.5438571Z +
2025-11-10T00:08:56.5438931Z          expired.len()
2025-11-10T00:08:56.5439039Z      }
2025-11-10T00:08:56.5439155Z -    
2025-11-10T00:08:56.5439262Z +
2025-11-10T00:08:56.5439527Z      /// Start periodic task to clean up expired pending requests
2025-11-10T00:08:56.5439696Z      fn start_request_cleanup_task(&self) {
2025-11-10T00:08:56.5439955Z          let pending_requests = Arc::clone(&self.pending_requests);
2025-11-10T00:08:56.5440404Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1309:
2025-11-10T00:08:56.5440523Z -        
2025-11-10T00:08:56.5440626Z +
2025-11-10T00:08:56.5440770Z          tokio::spawn(async move {
2025-11-10T00:08:56.5441113Z              let mut interval = tokio::time::interval(tokio::time::Duration::from_secs(60));
2025-11-10T00:08:56.5441231Z              loop {
2025-11-10T00:08:56.5441671Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1313:
2025-11-10T00:08:56.5442037Z                  interval.tick().await;
2025-11-10T00:08:56.5442166Z -                
2025-11-10T00:08:56.5442272Z +
2025-11-10T00:08:56.5442502Z                  // Clean up old pending requests (older than 5 minutes)
2025-11-10T00:08:56.5442685Z                  use std::time::{SystemTime, UNIX_EPOCH};
2025-11-10T00:08:56.5442854Z                  let now = SystemTime::now()
2025-11-10T00:08:56.5443303Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1319:
2025-11-10T00:08:56.5443431Z                      .unwrap()
2025-11-10T00:08:56.5443561Z                      .as_secs();
2025-11-10T00:08:56.5443727Z                  let timeout_seconds = 300; // 5 minutes
2025-11-10T00:08:56.5443835Z -                
2025-11-10T00:08:56.5443936Z +
2025-11-10T00:08:56.5444155Z                  let mut pending = pending_requests.lock().unwrap();
2025-11-10T00:08:56.5444488Z                  let initial_count = pending.len();
2025-11-10T00:08:56.5444654Z -                pending.retain(|_, req| {
2025-11-10T00:08:56.5444898Z -                    now.saturating_sub(req.timestamp) < timeout_seconds
2025-11-10T00:08:56.5445018Z -                });
2025-11-10T00:08:56.5445371Z +                pending.retain(|_, req| now.saturating_sub(req.timestamp) < timeout_seconds);
2025-11-10T00:08:56.5445566Z                  let removed = initial_count - pending.len();
2025-11-10T00:08:56.5445695Z                  if removed > 0 {
2025-11-10T00:08:56.5446114Z -                    debug!("Cleaned up {} stale pending requests (older than {}s)", removed, timeout_seconds);
2025-11-10T00:08:56.5446306Z +                    debug!(
2025-11-10T00:08:56.5446552Z +                        "Cleaned up {} stale pending requests (older than {}s)",
2025-11-10T00:08:56.5446702Z +                        removed, timeout_seconds
2025-11-10T00:08:56.5446811Z +                    );
2025-11-10T00:08:56.5446930Z                  }
2025-11-10T00:08:56.5447077Z                  if !pending.is_empty() {
2025-11-10T00:08:56.5447286Z                      debug!("Pending requests: {}", pending.len());
2025-11-10T00:08:56.5447755Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1335:
2025-11-10T00:08:56.5447867Z              }
2025-11-10T00:08:56.5447973Z          });
2025-11-10T00:08:56.5448081Z      }
2025-11-10T00:08:56.5448193Z -    
2025-11-10T00:08:56.5448290Z +
2025-11-10T00:08:56.5448509Z      /// Start periodic task to clean up DoS protection data
2025-11-10T00:08:56.5448700Z      fn start_dos_protection_cleanup_task(&self) {
2025-11-10T00:08:56.5448926Z          let dos_protection = Arc::clone(&self.dos_protection);
2025-11-10T00:08:56.5449374Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1342:
2025-11-10T00:08:56.5449550Z          let ban_list = Arc::clone(&self.ban_list);
2025-11-10T00:08:56.5449657Z -        
2025-11-10T00:08:56.5449755Z +
2025-11-10T00:08:56.5449900Z          tokio::spawn(async move {
2025-11-10T00:08:56.5450367Z              let mut interval = tokio::time::interval(tokio::time::Duration::from_secs(300)); // Every 5 minutes
2025-11-10T00:08:56.5450754Z              loop {
2025-11-10T00:08:56.5451214Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1347:
2025-11-10T00:08:56.5451370Z                  interval.tick().await;
2025-11-10T00:08:56.5451481Z -                
2025-11-10T00:08:56.5451575Z +
2025-11-10T00:08:56.5451767Z                  // Cleanup old connection rate limiter entries
2025-11-10T00:08:56.5451941Z                  dos_protection.cleanup().await;
2025-11-10T00:08:56.5452055Z -                
2025-11-10T00:08:56.5452153Z +
2025-11-10T00:08:56.5452328Z                  // Auto-ban IPs that should be banned
2025-11-10T00:08:56.5452746Z                  // Note: This is a simplified version - in production, you'd want more sophisticated logic
2025-11-10T00:08:56.5452934Z                  let dos_clone = Arc::clone(&dos_protection);
2025-11-10T00:08:56.5453392Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1361:
2025-11-10T00:08:56.5453695Z              }
2025-11-10T00:08:56.5453807Z          });
2025-11-10T00:08:56.5453911Z      }
2025-11-10T00:08:56.5454026Z -    
2025-11-10T00:08:56.5454134Z +
2025-11-10T00:08:56.5454486Z      /// Start periodic task to clean up expired bans
2025-11-10T00:08:56.5454653Z      fn start_ban_cleanup_task(&self) {
2025-11-10T00:08:56.5454830Z          let ban_list = Arc::clone(&self.ban_list);
2025-11-10T00:08:56.5455284Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1369:
2025-11-10T00:08:56.5455736Z              let mut interval = tokio::time::interval(tokio::time::Duration::from_secs(300)); // Every 5 minutes
2025-11-10T00:08:56.5455862Z              loop {
2025-11-10T00:08:56.5457523Z                  interval.tick().await;
2025-11-10T00:08:56.5457634Z -                
2025-11-10T00:08:56.5457740Z +
2025-11-10T00:08:56.5457924Z                  use std::time::{SystemTime, UNIX_EPOCH};
2025-11-10T00:08:56.5458087Z                  let now = SystemTime::now()
2025-11-10T00:08:56.5458247Z                      .duration_since(UNIX_EPOCH)
2025-11-10T00:08:56.5458692Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1376:
2025-11-10T00:08:56.5458818Z                      .unwrap()
2025-11-10T00:08:56.5458939Z                      .as_secs();
2025-11-10T00:08:56.5459052Z -                
2025-11-10T00:08:56.5459152Z +
2025-11-10T00:08:56.5459353Z                  let mut ban_list_guard = ban_list.lock().unwrap();
2025-11-10T00:08:56.5459544Z                  let expired: Vec<SocketAddr> = ban_list_guard
2025-11-10T00:08:56.5459658Z                      .iter()
2025-11-10T00:08:56.5460094Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1384:
2025-11-10T00:08:56.5460210Z                      })
2025-11-10T00:08:56.5460344Z                      .map(|(addr, _)| *addr)
2025-11-10T00:08:56.5460469Z                      .collect();
2025-11-10T00:08:56.5460584Z -                
2025-11-10T00:08:56.5460696Z +
2025-11-10T00:08:56.5460841Z                  for addr in expired {
2025-11-10T00:08:56.5460997Z                      ban_list_guard.remove(&addr);
2025-11-10T00:08:56.5461200Z                      debug!("Cleaned up expired ban for {}", addr);
2025-11-10T00:08:56.5461642Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1391:
2025-11-10T00:08:56.5461757Z                  }
2025-11-10T00:08:56.5461865Z -                
2025-11-10T00:08:56.5461970Z +
2025-11-10T00:08:56.5462118Z                  if !expired.is_empty() {
2025-11-10T00:08:56.5462339Z                      info!("Cleaned up {} expired ban(s)", expired.len());
2025-11-10T00:08:56.5462458Z                  }
2025-11-10T00:08:56.5462894Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1406:
2025-11-10T00:08:56.5463095Z      pub fn peer_addresses(&self) -> Vec<SocketAddr> {
2025-11-10T00:08:56.5463583Z          self.peer_manager.lock().unwrap().peer_socket_addresses()
2025-11-10T00:08:56.5463698Z      }
2025-11-10T00:08:56.5463805Z -    
2025-11-10T00:08:56.5463909Z +
2025-11-10T00:08:56.5464089Z      /// Get all peer addresses (as TransportAddr)
2025-11-10T00:08:56.5466286Z      pub fn peer_transport_addresses(&self) -> Vec<TransportAddr> {
2025-11-10T00:08:56.5466606Z          self.peer_manager.lock().unwrap().peer_addresses()
2025-11-10T00:08:56.5467047Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1429:
2025-11-10T00:08:56.5467368Z      /// Uses peer quality to prioritize reliable peers for critical messages
2025-11-10T00:08:56.5467751Z      pub async fn broadcast_with_quality_priority(&self, message: Vec<u8>) -> Result<()> {
2025-11-10T00:08:56.5467925Z          let pm = self.peer_manager.lock().unwrap();
2025-11-10T00:08:56.5468035Z -        
2025-11-10T00:08:56.5468133Z +
2025-11-10T00:08:56.5468267Z          // Get reliable peers first
2025-11-10T00:08:56.5468675Z          let reliable_peers = pm.select_reliable_peers();
2025-11-10T00:08:56.5468789Z          drop(pm);
2025-11-10T00:08:56.5469289Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1436:
2025-11-10T00:08:56.5469395Z -        
2025-11-10T00:08:56.5469500Z +
2025-11-10T00:08:56.5469643Z          // Send to reliable peers first
2025-11-10T00:08:56.5469783Z          for addr in &reliable_peers {
2025-11-10T00:08:56.5470131Z -            if let Err(e) = self.send_to_peer_by_transport(addr.clone(), message.clone()).await {
2025-11-10T00:08:56.5470256Z +            if let Err(e) = self
2025-11-10T00:08:56.5470484Z +                .send_to_peer_by_transport(addr.clone(), message.clone())
2025-11-10T00:08:56.5470604Z +                .await
2025-11-10T00:08:56.5470715Z +            {
2025-11-10T00:08:56.5470947Z                  warn!("Failed to send to reliable peer {:?}: {}", addr, e);
2025-11-10T00:08:56.5471061Z              }
2025-11-10T00:08:56.5471171Z          }
2025-11-10T00:08:56.5471613Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1443:
2025-11-10T00:08:56.5471716Z -        
2025-11-10T00:08:56.5471824Z +
2025-11-10T00:08:56.5471964Z          // Then send to remaining peers
2025-11-10T00:08:56.5472136Z          let pm = self.peer_manager.lock().unwrap();
2025-11-10T00:08:56.5472285Z          let all_peers = pm.peer_addresses();
2025-11-10T00:08:56.5472910Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1447:
2025-11-10T00:08:56.5473099Z -        let remaining_peers: Vec<_> = all_peers.iter()
2025-11-10T00:08:56.5473252Z +        let remaining_peers: Vec<_> = all_peers
2025-11-10T00:08:56.5473375Z +            .iter()
2025-11-10T00:08:56.5473578Z              .filter(|addr| !reliable_peers.contains(addr))
2025-11-10T00:08:56.5473701Z              .collect();
2025-11-10T00:08:56.5473820Z          drop(pm);
2025-11-10T00:08:56.5474447Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1451:
2025-11-10T00:08:56.5474572Z -        
2025-11-10T00:08:56.5474681Z +
2025-11-10T00:08:56.5474842Z          for addr in remaining_peers {
2025-11-10T00:08:56.5475196Z -            if let Err(e) = self.send_to_peer_by_transport(addr.clone(), message.clone()).await {
2025-11-10T00:08:56.5475332Z +            if let Err(e) = self
2025-11-10T00:08:56.5475577Z +                .send_to_peer_by_transport(addr.clone(), message.clone())
2025-11-10T00:08:56.5475694Z +                .await
2025-11-10T00:08:56.5475800Z +            {
2025-11-10T00:08:56.5475988Z                  warn!("Failed to send to peer {:?}: {}", addr, e);
2025-11-10T00:08:56.5476101Z              }
2025-11-10T00:08:56.5476213Z          }
2025-11-10T00:08:56.5476669Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1457:
2025-11-10T00:08:56.5476791Z -        
2025-11-10T00:08:56.5476898Z +
2025-11-10T00:08:56.5477022Z          Ok(())
2025-11-10T00:08:56.5477368Z      }
2025-11-10T00:08:56.5477479Z  
2025-11-10T00:08:56.5477928Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1464:
2025-11-10T00:08:56.5478119Z          let pm = self.peer_manager.lock().unwrap();
2025-11-10T00:08:56.5478304Z          let best_peers = pm.select_best_peers(1);
2025-11-10T00:08:56.5478424Z          drop(pm);
2025-11-10T00:08:56.5478535Z -        
2025-11-10T00:08:56.5478641Z +
2025-11-10T00:08:56.5478821Z          if let Some(addr) = best_peers.first() {
2025-11-10T00:08:56.5479089Z -            self.send_to_peer_by_transport(addr.clone(), message).await?;
2025-11-10T00:08:56.5479321Z +            self.send_to_peer_by_transport(addr.clone(), message)
2025-11-10T00:08:56.5479447Z +                .await?;
2025-11-10T00:08:56.5479578Z              Ok(addr.clone())
2025-11-10T00:08:56.5479690Z          } else {
2025-11-10T00:08:56.5479882Z              Err(anyhow::anyhow!("No peers available"))
2025-11-10T00:08:56.5480559Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1479:
2025-11-10T00:08:56.5480760Z          let pm = self.peer_manager.lock().unwrap();
2025-11-10T00:08:56.5480966Z          let reliable_peers = pm.select_reliable_peers();
2025-11-10T00:08:56.5481094Z          drop(pm);
2025-11-10T00:08:56.5481203Z -        
2025-11-10T00:08:56.5481306Z +
2025-11-10T00:08:56.5481462Z          if reliable_peers.is_empty() {
2025-11-10T00:08:56.5481735Z              return Err(anyhow::anyhow!("No reliable peers available"));
2025-11-10T00:08:56.5481847Z          }
2025-11-10T00:08:56.5482304Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1486:
2025-11-10T00:08:56.5482417Z -        
2025-11-10T00:08:56.5482515Z +
2025-11-10T00:08:56.5482659Z          // Select best reliable peer
2025-11-10T00:08:56.5482850Z          let pm = self.peer_manager.lock().unwrap();
2025-11-10T00:08:56.5483030Z -        let best_reliable = reliable_peers.iter()
2025-11-10T00:08:56.5483165Z -            .max_by(|a, b| {
2025-11-10T00:08:56.5483483Z -                let score_a = pm.get_peer(a).map(|p| p.quality_score()).unwrap_or(0.0);
2025-11-10T00:08:56.5483789Z -                let score_b = pm.get_peer(b).map(|p| p.quality_score()).unwrap_or(0.0);
2025-11-10T00:08:56.5484096Z -                score_a.partial_cmp(&score_b).unwrap_or(std::cmp::Ordering::Equal)
2025-11-10T00:08:56.5484210Z -            });
2025-11-10T00:08:56.5484659Z +        let best_reliable = reliable_peers.iter().max_by(|a, b| {
2025-11-10T00:08:56.5484961Z +            let score_a = pm.get_peer(a).map(|p| p.quality_score()).unwrap_or(0.0);
2025-11-10T00:08:56.5485241Z +            let score_b = pm.get_peer(b).map(|p| p.quality_score()).unwrap_or(0.0);
2025-11-10T00:08:56.5485366Z +            score_a
2025-11-10T00:08:56.5485514Z +                .partial_cmp(&score_b)
2025-11-10T00:08:56.5485693Z +                .unwrap_or(std::cmp::Ordering::Equal)
2025-11-10T00:08:56.5485812Z +        });
2025-11-10T00:08:56.5485936Z          drop(pm);
2025-11-10T00:08:56.5486051Z -        
2025-11-10T00:08:56.5486159Z +
2025-11-10T00:08:56.5486326Z          if let Some(addr) = best_reliable {
2025-11-10T00:08:56.5486598Z -            self.send_to_peer_by_transport(addr.clone(), message).await?;
2025-11-10T00:08:56.5486831Z +            self.send_to_peer_by_transport(addr.clone(), message)
2025-11-10T00:08:56.5486955Z +                .await?;
2025-11-10T00:08:56.5487091Z              Ok(addr.clone())
2025-11-10T00:08:56.5487201Z          } else {
2025-11-10T00:08:56.5487430Z              Err(anyhow::anyhow!("No reliable peers available"))
2025-11-10T00:08:56.5487903Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1509:
2025-11-10T00:08:56.5488047Z          let transport_addr = {
2025-11-10T00:08:56.5488232Z              let pm = self.peer_manager.lock().unwrap();
2025-11-10T00:08:56.5488410Z              pm.find_transport_addr_by_socket(addr)
2025-11-10T00:08:56.5488545Z -                .or_else(|| {
2025-11-10T00:08:56.5489070Z -                    self.socket_to_transport.lock().unwrap().get(&addr).cloned()
2025-11-10T00:08:56.5489190Z -                })
2025-11-10T00:08:56.5489519Z +                .or_else(|| self.socket_to_transport.lock().unwrap().get(&addr).cloned())
2025-11-10T00:08:56.5489633Z          };
2025-11-10T00:08:56.5489742Z -        
2025-11-10T00:08:56.5489855Z +
2025-11-10T00:08:56.5490050Z          if let Some(transport_addr) = transport_addr {
2025-11-10T00:08:56.5490325Z -            self.send_to_peer_by_transport(transport_addr, message).await
2025-11-10T00:08:56.5490808Z +            self.send_to_peer_by_transport(transport_addr, message)
2025-11-10T00:08:56.5490950Z +                .await
2025-11-10T00:08:56.5491061Z          } else {
2025-11-10T00:08:56.5491269Z              // Fallback: try TCP (for backward compatibility)
2025-11-10T00:08:56.5491618Z -            self.send_to_peer_by_transport(TransportAddr::Tcp(addr), message).await
2025-11-10T00:08:56.5492182Z +            self.send_to_peer_by_transport(TransportAddr::Tcp(addr), message)
2025-11-10T00:08:56.5492301Z +                .await
2025-11-10T00:08:56.5492410Z          }
2025-11-10T00:08:56.5492512Z      }
2025-11-10T00:08:56.5492612Z -    
2025-11-10T00:08:56.5492711Z +
2025-11-10T00:08:56.5493066Z      /// Send a message to a specific peer (by TransportAddr - supports all transports)
2025-11-10T00:08:56.5493522Z -    pub async fn send_to_peer_by_transport(&self, addr: TransportAddr, message: Vec<u8>) -> Result<()> {
2025-11-10T00:08:56.5493686Z +    pub async fn send_to_peer_by_transport(
2025-11-10T00:08:56.5493800Z +        &self,
2025-11-10T00:08:56.5493932Z +        addr: TransportAddr,
2025-11-10T00:08:56.5494049Z +        message: Vec<u8>,
2025-11-10T00:08:56.5494165Z +    ) -> Result<()> {
2025-11-10T00:08:56.5494547Z          let message_len = message.len();
2025-11-10T00:08:56.5494690Z          // Track bytes sent
2025-11-10T00:08:56.5494868Z          self.track_bytes_sent(message_len as u64);
2025-11-10T00:08:56.5495345Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1530:
2025-11-10T00:08:56.5497482Z -        
2025-11-10T00:08:56.5497586Z +
2025-11-10T00:08:56.5497780Z          let mut pm = self.peer_manager.lock().unwrap();
2025-11-10T00:08:56.5497970Z          if let Some(peer) = pm.get_peer_mut(&addr) {
2025-11-10T00:08:56.5498138Z              peer.send_message(message).await?;
2025-11-10T00:08:56.5498587Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1539:
2025-11-10T00:08:56.5498704Z      }
2025-11-10T00:08:56.5498808Z  
2025-11-10T00:08:56.5498974Z      /// Connect to a peer at the given address
2025-11-10T00:08:56.5499091Z -    /// 
2025-11-10T00:08:56.5499202Z +    ///
2025-11-10T00:08:56.5499549Z      /// Attempts to connect using available transports with graceful degradation:
2025-11-10T00:08:56.5500269Z      /// 1. Tries preferred transport (based on transport_preference)
2025-11-10T00:08:56.5500515Z      /// 2. Falls back to TCP if preferred transport fails
2025-11-10T00:08:56.5500991Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1547:
2025-11-10T00:08:56.5501296Z      pub async fn connect_to_peer(&self, addr: SocketAddr) -> Result<()> {
2025-11-10T00:08:56.5501474Z          use crate::network::peer::Peer;
2025-11-10T00:08:56.5501678Z          use crate::network::transport::TransportAddr;
2025-11-10T00:08:56.5501786Z -        
2025-11-10T00:08:56.5501903Z +
2025-11-10T00:08:56.5502275Z          // Check DoS protection: connection rate limiting (for outgoing connections too)
2025-11-10T00:08:56.5502416Z          let ip = addr.ip();
2025-11-10T00:08:56.5502633Z          if !self.dos_protection.check_connection(ip).await {
2025-11-10T00:08:56.5503080Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1554:
2025-11-10T00:08:56.5503485Z -            warn!("Connection rate limit exceeded for IP {}, rejecting outgoing connection", ip);
2025-11-10T00:08:56.5503908Z -            
2025-11-10T00:08:56.5504042Z +            warn!(
2025-11-10T00:08:56.5504589Z +                "Connection rate limit exceeded for IP {}, rejecting outgoing connection",
2025-11-10T00:08:56.5504710Z +                ip
2025-11-10T00:08:56.5504821Z +            );
2025-11-10T00:08:56.5504941Z +
2025-11-10T00:08:56.5506980Z              // Check if we should auto-ban
2025-11-10T00:08:56.5507202Z              if self.dos_protection.should_auto_ban(ip).await {
2025-11-10T00:08:56.5507535Z -                warn!("Auto-banning IP {} for repeated connection rate violations", ip);
2025-11-10T00:08:56.5507650Z +                warn!(
2025-11-10T00:08:56.5507917Z +                    "Auto-banning IP {} for repeated connection rate violations",
2025-11-10T00:08:56.5508037Z +                    ip
2025-11-10T00:08:56.5508145Z +                );
2025-11-10T00:08:56.5508269Z                  // Ban the IP
2025-11-10T00:08:56.5508496Z                  let unban_timestamp = std::time::SystemTime::now()
2025-11-10T00:08:56.5508925Z                      .duration_since(std::time::UNIX_EPOCH)
2025-11-10T00:08:56.5509384Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1564:
2025-11-10T00:08:56.5509529Z                      + 3600; // Ban for 1 hour
2025-11-10T00:08:56.5509738Z                  let mut ban_list = self.ban_list.lock().unwrap();
2025-11-10T00:08:56.5509912Z                  ban_list.insert(addr, unban_timestamp);
2025-11-10T00:08:56.5510283Z -                return Err(anyhow::anyhow!("IP {} is banned due to connection rate violations", ip));
2025-11-10T00:08:56.5510447Z +                return Err(anyhow::anyhow!(
2025-11-10T00:08:56.5510651Z +                    "IP {} is banned due to connection rate violations",
2025-11-10T00:08:56.5510764Z +                    ip
2025-11-10T00:08:56.5510875Z +                ));
2025-11-10T00:08:56.5510997Z              }
2025-11-10T00:08:56.5511107Z -            
2025-11-10T00:08:56.5511469Z -            return Err(anyhow::anyhow!("Connection rate limit exceeded for IP {}", ip));
2025-11-10T00:08:56.5511589Z +
2025-11-10T00:08:56.5511739Z +            return Err(anyhow::anyhow!(
2025-11-10T00:08:56.5511925Z +                "Connection rate limit exceeded for IP {}",
2025-11-10T00:08:56.5512042Z +                ip
2025-11-10T00:08:56.5512163Z +            ));
2025-11-10T00:08:56.5512270Z          }
2025-11-10T00:08:56.5512376Z -        
2025-11-10T00:08:56.5512482Z +
2025-11-10T00:08:56.5512673Z          // Eclipse attack prevention: check IP diversity
2025-11-10T00:08:56.5512838Z          if !self.check_eclipse_prevention(ip) {
2025-11-10T00:08:56.5512994Z              let prefix = self.get_ip_prefix(ip);
2025-11-10T00:08:56.5513446Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1576:
2025-11-10T00:08:56.5513951Z              warn!("Eclipse attack prevention: too many connections from IP range {:?}, rejecting connection from {}", 
2025-11-10T00:08:56.5514091Z                    prefix, ip);
2025-11-10T00:08:56.5516908Z -            return Err(anyhow::anyhow!("Eclipse attack prevention: too many connections from IP range"));
2025-11-10T00:08:56.5517085Z +            return Err(anyhow::anyhow!(
2025-11-10T00:08:56.5517380Z +                "Eclipse attack prevention: too many connections from IP range"
2025-11-10T00:08:56.5517502Z +            ));
2025-11-10T00:08:56.5517614Z          }
2025-11-10T00:08:56.5517722Z -        
2025-11-10T00:08:56.5517921Z +
2025-11-10T00:08:56.5518080Z          let mut last_error = None;
2025-11-10T00:08:56.5518188Z -        
2025-11-10T00:08:56.5518294Z +
2025-11-10T00:08:56.5518581Z          // Try transports in preference order with graceful degradation
2025-11-10T00:08:56.5518855Z          let transports_to_try = self.get_transports_for_connection();
2025-11-10T00:08:56.5518968Z -        
2025-11-10T00:08:56.5519075Z +
2025-11-10T00:08:56.5519261Z          for transport_type in transports_to_try {
2025-11-10T00:08:56.5519584Z              match self.try_connect_with_transport(&transport_type, addr).await {
2025-11-10T00:08:56.5520013Z                  Ok((peer, transport_addr)) => {
2025-11-10T00:08:56.5520492Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1591:
2025-11-10T00:08:56.5520715Z                          let mut pm = self.peer_manager.lock().unwrap();
2025-11-10T00:08:56.5520919Z                          pm.add_peer(transport_addr.clone(), peer)?;
2025-11-10T00:08:56.5521048Z                      }
2025-11-10T00:08:56.5521163Z -                    
2025-11-10T00:08:56.5521346Z +
2025-11-10T00:08:56.5521664Z                      // Note: Peer handler is managed by Peer::from_transport_connection
2025-11-10T00:08:56.5521869Z                      // No need to spawn additional handler task
2025-11-10T00:08:56.5521983Z -                    
2025-11-10T00:08:56.5522447Z -                    info!("Successfully connected to {} via {:?} (transport: {:?})", addr, transport_type, transport_addr);
2025-11-10T00:08:56.5522793Z +
2025-11-10T00:08:56.5522915Z +                    info!(
2025-11-10T00:08:56.5523170Z +                        "Successfully connected to {} via {:?} (transport: {:?})",
2025-11-10T00:08:56.5523337Z +                        addr, transport_type, transport_addr
2025-11-10T00:08:56.5523454Z +                    );
2025-11-10T00:08:56.5523582Z                      return Ok(());
2025-11-10T00:08:56.5523697Z                  }
2025-11-10T00:08:56.5523834Z                  Err(e) => {
2025-11-10T00:08:56.5524437Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1602:
2025-11-10T00:08:56.5524741Z -                    warn!("Failed to connect to {} via {:?}: {}", addr, transport_type, e);
2025-11-10T00:08:56.5524873Z +                    warn!(
2025-11-10T00:08:56.5525046Z +                        "Failed to connect to {} via {:?}: {}",
2025-11-10T00:08:56.5525202Z +                        addr, transport_type, e
2025-11-10T00:08:56.5525338Z +                    );
2025-11-10T00:08:56.5525476Z                      last_error = Some(e);
2025-11-10T00:08:56.5525627Z                      // Continue to next transport
2025-11-10T00:08:56.5525738Z                  }
2025-11-10T00:08:56.5528043Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1606:
2025-11-10T00:08:56.5528149Z              }
2025-11-10T00:08:56.5528251Z          }
2025-11-10T00:08:56.5528368Z -        
2025-11-10T00:08:56.5528472Z +
2025-11-10T00:08:56.5528604Z          // All transports failed
2025-11-10T00:08:56.5528978Z          Err(last_error.unwrap_or_else(|| anyhow::anyhow!("All transport attempts failed")))
2025-11-10T00:08:56.5529091Z      }
2025-11-10T00:08:56.5529544Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1612:
2025-11-10T00:08:56.5529652Z -    
2025-11-10T00:08:56.5529767Z +
2025-11-10T00:08:56.5529999Z      /// Helper: Get list of transports to try for a connection
2025-11-10T00:08:56.5530443Z      fn get_transports_for_connection(&self) -> Vec<crate::network::transport::TransportType> {
2025-11-10T00:08:56.5530611Z          let mut transports = Vec::new();
2025-11-10T00:08:56.5531054Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1616:
2025-11-10T00:08:56.5531163Z -        
2025-11-10T00:08:56.5531267Z +
2025-11-10T00:08:56.5531442Z          // Add transports in preference order
2025-11-10T00:08:56.5531633Z          if self.transport_preference.allows_tcp() {
2025-11-10T00:08:56.5531953Z              transports.push(crate::network::transport::TransportType::Tcp);
2025-11-10T00:08:56.5532407Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1620:
2025-11-10T00:08:56.5532519Z          }
2025-11-10T00:08:56.5532627Z -        
2025-11-10T00:08:56.5532743Z +
2025-11-10T00:08:56.5533406Z          #[cfg(feature = "quinn")]
2025-11-10T00:08:56.5533636Z          if self.transport_preference.allows_quinn() {
2025-11-10T00:08:56.5534163Z              if let Some(ref _quinn) = self.quinn_transport {
2025-11-10T00:08:56.5534800Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1625:
2025-11-10T00:08:56.5535140Z                  transports.push(crate::network::transport::TransportType::Quinn);
2025-11-10T00:08:56.5535250Z              }
2025-11-10T00:08:56.5535366Z          }
2025-11-10T00:08:56.5535474Z -        
2025-11-10T00:08:56.5535575Z +
2025-11-10T00:08:56.5537374Z          #[cfg(feature = "iroh")]
2025-11-10T00:08:56.5537580Z          if self.transport_preference.allows_iroh() {
2025-11-10T00:08:56.5537779Z              if let Some(ref _iroh) = self.iroh_transport {
2025-11-10T00:08:56.5538620Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1632:
2025-11-10T00:08:56.5538959Z                  transports.push(crate::network::transport::TransportType::Iroh);
2025-11-10T00:08:56.5539074Z              }
2025-11-10T00:08:56.5539518Z          }
2025-11-10T00:08:56.5539644Z -        
2025-11-10T00:08:56.5539747Z +
2025-11-10T00:08:56.5539967Z          // Always try TCP as fallback if not already in list
2025-11-10T00:08:56.5540484Z -        if !transports.iter().any(|t| matches!(t, crate::network::transport::TransportType::Tcp)) {
2025-11-10T00:08:56.5540689Z +        if !transports
2025-11-10T00:08:56.5540805Z +            .iter()
2025-11-10T00:08:56.5541087Z +            .any(|t| matches!(t, crate::network::transport::TransportType::Tcp))
2025-11-10T00:08:56.5541204Z +        {
2025-11-10T00:08:56.5541512Z              transports.push(crate::network::transport::TransportType::Tcp);
2025-11-10T00:08:56.5541625Z          }
2025-11-10T00:08:56.5541735Z -        
2025-11-10T00:08:56.5541849Z +
2025-11-10T00:08:56.5541969Z          transports
2025-11-10T00:08:56.5542076Z      }
2025-11-10T00:08:56.5542188Z -    
2025-11-10T00:08:56.5542291Z +
2025-11-10T00:08:56.5542505Z      /// Helper: Try connecting with a specific transport
2025-11-10T00:08:56.5543397Z -    async fn try_connect_with_transport(&self, transport_type: &crate::network::transport::TransportType, addr: SocketAddr) -> Result<(peer::Peer, TransportAddr)> {
2025-11-10T00:08:56.5543618Z -        use crate::network::transport::TransportAddr;
2025-11-10T00:08:56.5543781Z +    async fn try_connect_with_transport(
2025-11-10T00:08:56.5543895Z +        &self,
2025-11-10T00:08:56.5544173Z +        transport_type: &crate::network::transport::TransportType,
2025-11-10T00:08:56.5544490Z +        addr: SocketAddr,
2025-11-10T00:08:56.5544685Z +    ) -> Result<(peer::Peer, TransportAddr)> {
2025-11-10T00:08:56.5544850Z          use crate::network::peer::Peer;
2025-11-10T00:08:56.5544959Z -        
2025-11-10T00:08:56.5545158Z +        use crate::network::transport::TransportAddr;
2025-11-10T00:08:56.5545263Z +
2025-11-10T00:08:56.5545403Z          match transport_type {
2025-11-10T00:08:56.5545619Z              crate::network::transport::TransportType::Tcp => {
2025-11-10T00:08:56.5545938Z                  // Use TcpTransport to create connection properly
2025-11-10T00:08:56.5546422Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1684:
2025-11-10T00:08:56.5546651Z              crate::network::transport::TransportType::Iroh => {
2025-11-10T00:08:56.5546832Z                  // Iroh requires public key, not SocketAddr
2025-11-10T00:08:56.5547170Z                  // For now, return error - would need peer discovery or address resolution
2025-11-10T00:08:56.5547511Z -                Err(anyhow::anyhow!("Iroh transport requires public key, not SocketAddr"))
2025-11-10T00:08:56.5547661Z +                Err(anyhow::anyhow!(
2025-11-10T00:08:56.5547898Z +                    "Iroh transport requires public key, not SocketAddr"
2025-11-10T00:08:56.5548019Z +                ))
2025-11-10T00:08:56.5548130Z              }
2025-11-10T00:08:56.5548237Z          }
2025-11-10T00:08:56.5548352Z      }
2025-11-10T00:08:56.5548810Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1691:
2025-11-10T00:08:56.5549167Z -    
2025-11-10T00:08:56.5549269Z +
2025-11-10T00:08:56.5549463Z      /// Send ping message to all connected peers
2025-11-10T00:08:56.5549677Z      pub async fn ping_all_peers(&self) -> Result<()> {
2025-11-10T00:08:56.5550066Z -        use crate::network::protocol::{ProtocolMessage, ProtocolParser, PingMessage};
2025-11-10T00:08:56.5550441Z +        use crate::network::protocol::{PingMessage, ProtocolMessage, ProtocolParser};
2025-11-10T00:08:56.5550618Z          use std::time::{SystemTime, UNIX_EPOCH};
2025-11-10T00:08:56.5550726Z -        
2025-11-10T00:08:56.5550844Z +
2025-11-10T00:08:56.5550987Z          // Generate nonce for ping
2025-11-10T00:08:56.5551140Z          let nonce = SystemTime::now()
2025-11-10T00:08:56.5551290Z              .duration_since(UNIX_EPOCH)
2025-11-10T00:08:56.5551757Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1700:
2025-11-10T00:08:56.5552122Z              .unwrap()
2025-11-10T00:08:56.5552262Z              .as_nanos() as u64;
2025-11-10T00:08:56.5552376Z -        
2025-11-10T00:08:56.5552481Z +
2025-11-10T00:08:56.5552764Z          let ping_msg = ProtocolMessage::Ping(PingMessage { nonce });
2025-11-10T00:08:56.5553039Z          let wire_msg = ProtocolParser::serialize_message(&ping_msg)?;
2025-11-10T00:08:56.5553159Z -        
2025-11-10T00:08:56.5553261Z +
2025-11-10T00:08:56.5553668Z          let peer_addrs = self.peer_manager.lock().unwrap().peer_addresses();
2025-11-10T00:08:56.5553816Z          for addr in peer_addrs {
2025-11-10T00:08:56.5555899Z              // Convert TransportAddr to SocketAddr for send_to_peer, or use send_to_peer_by_transport
2025-11-10T00:08:56.5556364Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1726:
2025-11-10T00:08:56.5556479Z                  }
2025-11-10T00:08:56.5556589Z              }
2025-11-10T00:08:56.5556696Z          }
2025-11-10T00:08:56.5556817Z -        
2025-11-10T00:08:56.5556936Z +
2025-11-10T00:08:56.5557046Z          Ok(())
2025-11-10T00:08:56.5557154Z      }
2025-11-10T00:08:56.5557267Z  
2025-11-10T00:08:56.5557719Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1761:
2025-11-10T00:08:56.5558051Z          // Track message queue size manually (unbounded channel doesn't have len())
2025-11-10T00:08:56.5558200Z          let mut message_count = 0u64;
2025-11-10T00:08:56.5558462Z          let mut last_metrics_update = std::time::SystemTime::now();
2025-11-10T00:08:56.5558569Z -        
2025-11-10T00:08:56.5558672Z +
2025-11-10T00:08:56.5558906Z          while let Some(message) = self.peer_rx.recv().await {
2025-11-10T00:08:56.5559045Z              message_count += 1;
2025-11-10T00:08:56.5559147Z -            
2025-11-10T00:08:56.5559252Z +
2025-11-10T00:08:56.5559614Z              // Update metrics periodically (every 100 messages or 10 seconds)
2025-11-10T00:08:56.5559780Z              let now = std::time::SystemTime::now();
2025-11-10T00:08:56.5559968Z -            let should_update = message_count % 100 == 0 
2025-11-10T00:08:56.5560150Z +            let should_update = message_count % 100 == 0
2025-11-10T00:08:56.5560443Z                  || now.duration_since(last_metrics_update).unwrap().as_secs() >= 10;
2025-11-10T00:08:56.5560559Z -            
2025-11-10T00:08:56.5560673Z +
2025-11-10T00:08:56.5560807Z              if should_update {
2025-11-10T00:08:56.5561098Z                  let pm = self.peer_manager.lock().unwrap();
2025-11-10T00:08:56.5561286Z                  let active_connections = pm.peer_count();
2025-11-10T00:08:56.5561752Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1776:
2025-11-10T00:08:56.5562011Z                  let bytes_received = *self.bytes_received.lock().unwrap();
2025-11-10T00:08:56.5562227Z                  let bytes_sent = *self.bytes_sent.lock().unwrap();
2025-11-10T00:08:56.5562353Z -                
2025-11-10T00:08:56.5562467Z +
2025-11-10T00:08:56.5562757Z                  // Approximate queue size (messages processed since last check)
2025-11-10T00:08:56.5563196Z                  let queue_size = message_count as usize;
2025-11-10T00:08:56.5563314Z -                
2025-11-10T00:08:56.5563510Z +
2025-11-10T00:08:56.5563750Z                  // Check message queue size limit
2025-11-10T00:08:56.5565927Z -                if !self.dos_protection.check_message_queue_size(queue_size).await {
2025-11-10T00:08:56.5566394Z -                    warn!("Message queue size limit exceeded (processed {} messages), potential DoS", queue_size);
2025-11-10T00:08:56.5566523Z +                if !self
2025-11-10T00:08:56.5566660Z +                    .dos_protection
2025-11-10T00:08:56.5566837Z +                    .check_message_queue_size(queue_size)
2025-11-10T00:08:56.5573535Z +                    .await
2025-11-10T00:08:56.5573687Z +                {
2025-11-10T00:08:56.5573811Z +                    warn!(
2025-11-10T00:08:56.5576635Z +                        "Message queue size limit exceeded (processed {} messages), potential DoS",
2025-11-10T00:08:56.5576789Z +                        queue_size
2025-11-10T00:08:56.5576908Z +                    );
2025-11-10T00:08:56.5577080Z                      // Optionally detect DoS attack
2025-11-10T00:08:56.5577317Z                      if self.dos_protection.detect_dos_attack().await {
2025-11-10T00:08:56.5577683Z                          warn!("DoS attack detected - message queue and connections at high levels");
2025-11-10T00:08:56.5578156Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1790:
2025-11-10T00:08:56.5578364Z                      // Reset counter to prevent false positives
2025-11-10T00:08:56.5578511Z                      message_count = 0;
2025-11-10T00:08:56.5578626Z                  }
2025-11-10T00:08:56.5578752Z -                
2025-11-10T00:08:56.5578935Z -                self.dos_protection.update_metrics(
2025-11-10T00:08:56.5579088Z -                    active_connections,
2025-11-10T00:08:56.5579231Z -                    queue_size,
2025-11-10T00:08:56.5579367Z -                    bytes_received,
2025-11-10T00:08:56.5579493Z -                    bytes_sent,
2025-11-10T00:08:56.5579614Z -                ).await;
2025-11-10T00:08:56.5579737Z -                
2025-11-10T00:08:56.5579844Z +
2025-11-10T00:08:56.5579985Z +                self.dos_protection
2025-11-10T00:08:56.5580342Z +                    .update_metrics(active_connections, queue_size, bytes_received, bytes_sent)
2025-11-10T00:08:56.5580466Z +                    .await;
2025-11-10T00:08:56.5580571Z +
2025-11-10T00:08:56.5580725Z                  last_metrics_update = now;
2025-11-10T00:08:56.5580915Z                  message_count = 0; // Reset after update
2025-11-10T00:08:56.5581029Z              }
2025-11-10T00:08:56.5581488Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1811:
2025-11-10T00:08:56.5581702Z                      let mut pm = self.peer_manager.lock().unwrap();
2025-11-10T00:08:56.5581917Z                      // Remove peer directly using TransportAddr
2025-11-10T00:08:56.5582066Z                      pm.remove_peer(&addr);
2025-11-10T00:08:56.5582183Z -                    
2025-11-10T00:08:56.5582297Z +
2025-11-10T00:08:56.5582589Z                      // Clean up per-IP connection count (only for TCP/Quinn, not Iroh)
2025-11-10T00:08:56.5582753Z                      if let Some(ip) = match &addr {
2025-11-10T00:08:56.5582983Z                          TransportAddr::Tcp(sock) => Some(sock.ip()),
2025-11-10T00:08:56.5583446Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1828:
2025-11-10T00:08:56.5583567Z                              }
2025-11-10T00:08:56.5583681Z                          }
2025-11-10T00:08:56.5583803Z                      }
2025-11-10T00:08:56.5583916Z -                    
2025-11-10T00:08:56.5584020Z +
2025-11-10T00:08:56.5584530Z                      // Clean up rate limiter (use SocketAddr for TCP/Quinn, or a key for Iroh)
2025-11-10T00:08:56.5584903Z                      {
2025-11-10T00:08:56.5585160Z                          let mut rates = self.peer_message_rates.lock().unwrap();
2025-11-10T00:08:56.5585617Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1844:
2025-11-10T00:08:56.5585781Z                              rates.remove(&sock_addr);
2025-11-10T00:08:56.5585888Z                          }
2025-11-10T00:08:56.5587932Z                      }
2025-11-10T00:08:56.5588040Z -                    
2025-11-10T00:08:56.5588135Z +
2025-11-10T00:08:56.5588316Z                      // Clean up eclipse attack prevention tracking
2025-11-10T00:08:56.5588470Z                      if let Some(ip) = match &addr {
2025-11-10T00:08:56.5588666Z                          TransportAddr::Tcp(sock) => Some(sock.ip()),
2025-11-10T00:08:56.5589080Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1967:
2025-11-10T00:08:56.5589370Z                      {
2025-11-10T00:08:56.5589577Z                          let mut pm = self.peer_manager.lock().unwrap();
2025-11-10T00:08:56.5589826Z                          // Try to find peer by SocketAddr (TCP or Quinn, or Iroh mapping)
2025-11-10T00:08:56.5590112Z -                        let transport_addr = pm.find_transport_addr_by_socket(peer_addr)
2025-11-10T00:08:56.5590245Z -                            .or_else(|| {
2025-11-10T00:08:56.5590383Z +                        let transport_addr =
2025-11-10T00:08:56.5590616Z +                            pm.find_transport_addr_by_socket(peer_addr).or_else(|| {
2025-11-10T00:08:56.5590761Z                                  // Check Iroh mapping
2025-11-10T00:08:56.5591050Z -                                self.socket_to_transport.lock().unwrap().get(&peer_addr).cloned()
2025-11-10T00:08:56.5591198Z +                                self.socket_to_transport
2025-11-10T00:08:56.5591331Z +                                    .lock()
2025-11-10T00:08:56.5591477Z +                                    .unwrap()
2025-11-10T00:08:56.5591633Z +                                    .get(&peer_addr)
2025-11-10T00:08:56.5591766Z +                                    .cloned()
2025-11-10T00:08:56.5591906Z                              });
2025-11-10T00:08:56.5592115Z                          if let Some(transport_addr) = transport_addr {
2025-11-10T00:08:56.5592354Z                              if let Some(peer) = pm.get_peer_mut(&transport_addr) {
2025-11-10T00:08:56.5592829Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1978:
2025-11-10T00:08:56.5592958Z                              }
2025-11-10T00:08:56.5593076Z                          }
2025-11-10T00:08:56.5593183Z                      }
2025-11-10T00:08:56.5593298Z -                    
2025-11-10T00:08:56.5593399Z +
2025-11-10T00:08:56.5593571Z                      // Check rate limiting before processing
2025-11-10T00:08:56.5593814Z                      let mut rates = self.peer_message_rates.lock().unwrap();
2025-11-10T00:08:56.5594080Z                      let rate_limiter = rates.entry(peer_addr).or_insert_with(|| {
2025-11-10T00:08:56.5595223Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1985:
2025-11-10T00:08:56.5597299Z                          // Default: 100 burst, 10 messages/second
2025-11-10T00:08:56.5597466Z                          PeerRateLimiter::new(100, 10)
2025-11-10T00:08:56.5597575Z                      });
2025-11-10T00:08:56.5597681Z -                    
2025-11-10T00:08:56.5597788Z +
2025-11-10T00:08:56.5597952Z                      if !rate_limiter.check_and_consume() {
2025-11-10T00:08:56.5598259Z -                        warn!("Rate limit exceeded for peer {}, dropping message", peer_addr);
2025-11-10T00:08:56.5598397Z +                        warn!(
2025-11-10T00:08:56.5598623Z +                            "Rate limit exceeded for peer {}, dropping message",
2025-11-10T00:08:56.5598761Z +                            peer_addr
2025-11-10T00:08:56.5599098Z +                        );
2025-11-10T00:08:56.5599382Z                          // Optionally ban peer after repeated rate limit violations
2025-11-10T00:08:56.5599556Z                          // For now, just drop the message
2025-11-10T00:08:56.5599683Z                          continue;
2025-11-10T00:08:56.5600130Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1994:
2025-11-10T00:08:56.5600238Z                      }
2025-11-10T00:08:56.5600360Z                      drop(rates);
2025-11-10T00:08:56.5600476Z -                    
2025-11-10T00:08:56.5600580Z +
2025-11-10T00:08:56.5600906Z                      // Check if this is a response to a pending request (UTXOSet or FilteredBlock)
2025-11-10T00:08:56.5601208Z                      // Extract request_id from message and route to correct pending request
2025-11-10T00:08:56.5601466Z                      if let Ok(parsed) = ProtocolParser::parse_message(&data) {
2025-11-10T00:08:56.5602075Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2002:
2025-11-10T00:08:56.5602360Z                              ProtocolMessage::FilteredBlock(msg) => Some(msg.request_id),
2025-11-10T00:08:56.5602493Z                              _ => None,
2025-11-10T00:08:56.5602605Z                          };
2025-11-10T00:08:56.5602717Z -                        
2025-11-10T00:08:56.5602826Z +
2025-11-10T00:08:56.5603068Z                          if let Some(request_id) = request_id_opt {
2025-11-10T00:08:56.5603246Z                              // Route to pending request by request_id
2025-11-10T00:08:56.5603491Z                              let mut pending = self.pending_requests.lock().unwrap();
2025-11-10T00:08:56.5603903Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2015:
2025-11-10T00:08:56.5604016Z                              }
2025-11-10T00:08:56.5604123Z                          }
2025-11-10T00:08:56.5605863Z                      }
2025-11-10T00:08:56.5605988Z -                    
2025-11-10T00:08:56.5606096Z +
2025-11-10T00:08:56.5606278Z                      // Process through protocol layer
2025-11-10T00:08:56.5606569Z                      if let Err(e) = self.handle_incoming_wire_tcp(peer_addr, data).await {
2025-11-10T00:08:56.5606818Z                          warn!("Failed to process message from {}: {}", peer_addr, e);
2025-11-10T00:08:56.5607248Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2034:
2025-11-10T00:08:56.5607452Z      /// 3. Creates NodeChainAccess from storage modules
2025-11-10T00:08:56.5607705Z      /// 4. Calls bllvm_protocol::network::process_network_message()
2025-11-10T00:08:56.5608043Z      /// 5. Converts NetworkResponse back to wire format and enqueues for sending
2025-11-10T00:08:56.5608522Z -    pub async fn handle_incoming_wire_tcp(&self, peer_addr: SocketAddr, data: Vec<u8>) -> Result<()> {
2025-11-10T00:08:56.5608713Z +    pub async fn handle_incoming_wire_tcp(
2025-11-10T00:08:56.5608834Z +        &self,
2025-11-10T00:08:56.5608985Z +        peer_addr: SocketAddr,
2025-11-10T00:08:56.5609116Z +        data: Vec<u8>,
2025-11-10T00:08:56.5609242Z +    ) -> Result<()> {
2025-11-10T00:08:56.5609376Z          // Track bytes received
2025-11-10T00:08:56.5609585Z          self.track_bytes_received(data.len() as u64);
2025-11-10T00:08:56.5609704Z -        
2025-11-10T00:08:56.5609812Z +
2025-11-10T00:08:56.5609965Z          // Check if peer is banned
2025-11-10T00:08:56.5610114Z          if self.is_banned(peer_addr) {
2025-11-10T00:08:56.5610376Z              warn!("Rejecting message from banned peer: {}", peer_addr);
2025-11-10T00:08:56.5610842Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2044:
2025-11-10T00:08:56.5611083Z              return Ok(()); // Silently drop messages from banned peers
2025-11-10T00:08:56.5611193Z          }
2025-11-10T00:08:56.5611433Z          let parsed = ProtocolParser::parse_message(&data)?;
2025-11-10T00:08:56.5611804Z -        
2025-11-10T00:08:56.5611914Z +
2025-11-10T00:08:56.5612179Z          // Handle special cases that don't go through protocol layer
2025-11-10T00:08:56.5612324Z          match parsed {
2025-11-10T00:08:56.5612444Z              // BIP331
2025-11-10T00:08:56.5612908Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2097:
2025-11-10T00:08:56.5613097Z                  // Continue to protocol layer processing
2025-11-10T00:08:56.5613216Z              }
2025-11-10T00:08:56.5613323Z          }
2025-11-10T00:08:56.5613429Z -        
2025-11-10T00:08:56.5613540Z +
2025-11-10T00:08:56.5613801Z          // Process with protocol layer if dependencies are available
2025-11-10T00:08:56.5614166Z -        if let (Some(ref protocol_engine), Some(ref storage), Some(ref mempool_manager)) = 
2025-11-10T00:08:56.5614756Z -            (self.protocol_engine.as_ref(), self.storage.as_ref(), self.mempool_manager.as_ref()) {
2025-11-10T00:08:56.5615167Z -            
2025-11-10T00:08:56.5615548Z +        if let (Some(ref protocol_engine), Some(ref storage), Some(ref mempool_manager)) = (
2025-11-10T00:08:56.5615716Z +            self.protocol_engine.as_ref(),
2025-11-10T00:08:56.5615868Z +            self.storage.as_ref(),
2025-11-10T00:08:56.5616019Z +            self.mempool_manager.as_ref(),
2025-11-10T00:08:56.5616134Z +        ) {
2025-11-10T00:08:56.5616483Z              // Convert ProtocolMessage to bllvm_protocol::network::NetworkMessage
2025-11-10T00:08:56.5616731Z              use crate::network::protocol_adapter::ProtocolAdapter;
2025-11-10T00:08:56.5617109Z              let protocol_msg = ProtocolAdapter::protocol_to_consensus_message(&parsed)?;
2025-11-10T00:08:56.5617585Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2108:
2025-11-10T00:08:56.5617700Z -            
2025-11-10T00:08:56.5617805Z +
2025-11-10T00:08:56.5617953Z              // Get or create PeerState
2025-11-10T00:08:56.5618206Z              let mut peer_states = self.peer_states.lock().unwrap();
2025-11-10T00:08:56.5618413Z -            let peer_state = peer_states.entry(peer_addr)
2025-11-10T00:08:56.5618562Z +            let peer_state = peer_states
2025-11-10T00:08:56.5618703Z +                .entry(peer_addr)
2025-11-10T00:08:56.5618974Z                  .or_insert_with(|| bllvm_protocol::network::PeerState::new());
2025-11-10T00:08:56.5619083Z -            
2025-11-10T00:08:56.5619202Z +
2025-11-10T00:08:56.5619350Z              // Create NodeChainAccess
2025-11-10T00:08:56.5619573Z              use crate::network::chain_access::NodeChainAccess;
2025-11-10T00:08:56.5619754Z              let chain_access = NodeChainAccess::new(
2025-11-10T00:08:56.5620228Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2118:
2025-11-10T00:08:56.5620381Z                  storage.transactions(),
2025-11-10T00:08:56.5620540Z                  Arc::clone(mempool_manager),
2025-11-10T00:08:56.5620670Z              );
2025-11-10T00:08:56.5620786Z -            
2025-11-10T00:08:56.5620893Z +
2025-11-10T00:08:56.5621033Z              // Get UTXO set and height
2025-11-10T00:08:56.5621237Z -            let utxo_set = storage.utxos().get_all_utxos()
2025-11-10T00:08:56.5621372Z +            let utxo_set = storage
2025-11-10T00:08:56.5621491Z +                .utxos()
2025-11-10T00:08:56.5621628Z +                .get_all_utxos()
2025-11-10T00:08:56.5621890Z                  .map_err(|e| anyhow::anyhow!("Failed to get UTXO set: {}", e))?;
2025-11-10T00:08:56.5622071Z -            let height = storage.chain().get_height()
2025-11-10T00:08:56.5622203Z +            let height = storage
2025-11-10T00:08:56.5622323Z +                .chain()
2025-11-10T00:08:56.5622445Z +                .get_height()
2025-11-10T00:08:56.5622696Z                  .map_err(|e| anyhow::anyhow!("Failed to get height: {}", e))?
2025-11-10T00:08:56.5622830Z                  .unwrap_or(0);
2025-11-10T00:08:56.5622949Z -            
2025-11-10T00:08:56.5625130Z +
2025-11-10T00:08:56.5625325Z              // Process message with protocol layer
2025-11-10T00:08:56.5625685Z              use bllvm_protocol::network::{process_network_message, ChainStateAccess};
2025-11-10T00:08:56.5625847Z              match process_network_message(
2025-11-10T00:08:56.5626308Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2140:
2025-11-10T00:08:56.5626606Z                      // Convert response to wire format and send via transport layer
2025-11-10T00:08:56.5626838Z                      use crate::network::message_bridge::MessageBridge;
2025-11-10T00:08:56.5627053Z                      use crate::network::transport::TransportType;
2025-11-10T00:08:56.5627538Z -                    if let Ok(wire_messages) = MessageBridge::extract_send_messages(&response, TransportType::Tcp) {
2025-11-10T00:08:56.5627701Z +                    if let Ok(wire_messages) =
2025-11-10T00:08:56.5628044Z +                        MessageBridge::extract_send_messages(&response, TransportType::Tcp)
2025-11-10T00:08:56.5628400Z +                    {
2025-11-10T00:08:56.5628571Z                          for wire_msg in wire_messages {
2025-11-10T00:08:56.5628831Z                              if let Err(e) = self.send_to_peer(peer_addr, wire_msg).await {
2025-11-10T00:08:56.5629141Z                                  warn!("Failed to send protocol response to {}: {}", peer_addr, e);
2025-11-10T00:08:56.5629597Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2158:
2025-11-10T00:08:56.5629810Z              // Dependencies not set - fall back to old behavior
2025-11-10T00:08:56.5630185Z              debug!("Protocol layer dependencies not set, skipping protocol processing");
2025-11-10T00:08:56.5630299Z          }
2025-11-10T00:08:56.5630403Z -        
2025-11-10T00:08:56.5630510Z +
2025-11-10T00:08:56.5630635Z          Ok(())
2025-11-10T00:08:56.5630742Z      }
2025-11-10T00:08:56.5630855Z  
2025-11-10T00:08:56.5631314Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2360:
2025-11-10T00:08:56.5631536Z          // Handle the request with storage and filter service
2025-11-10T00:08:56.5633244Z          let storage = self.storage.as_ref().map(Arc::clone);
2025-11-10T00:08:56.5633378Z          let response =
2025-11-10T00:08:56.5633932Z -            handle_get_filtered_block(get_filtered_block_msg, storage, Some(&self.filter_service)).await?;
2025-11-10T00:08:56.5634515Z +            handle_get_filtered_block(get_filtered_block_msg, storage, Some(&self.filter_service))
2025-11-10T00:08:56.5634648Z +                .await?;
2025-11-10T00:08:56.5634766Z  
2025-11-10T00:08:56.5634921Z          // Serialize and send response
2025-11-10T00:08:56.5635060Z          let response_wire =
2025-11-10T00:08:56.5635530Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2466:
2025-11-10T00:08:56.5635746Z      /// Handle GetAddr request - return known addresses
2025-11-10T00:08:56.5636058Z      async fn handle_get_addr(&self, peer_addr: SocketAddr) -> Result<()> {
2025-11-10T00:08:56.5636419Z          use crate::network::protocol::{AddrMessage, ProtocolMessage, ProtocolParser};
2025-11-10T00:08:56.5636535Z -        
2025-11-10T00:08:56.5636634Z +
2025-11-10T00:08:56.5636925Z          // Get fresh addresses from database (up to 2500, Bitcoin Core limit)
2025-11-10T00:08:56.5637147Z          let ban_list = self.ban_list.lock().unwrap().clone();
2025-11-10T00:08:56.5637318Z          let connected_peers: Vec<SocketAddr> = {
2025-11-10T00:08:56.5637757Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2473:
2025-11-10T00:08:56.5637938Z              let pm = self.peer_manager.lock().unwrap();
2025-11-10T00:08:56.5638082Z              pm.peer_socket_addresses()
2025-11-10T00:08:56.5638193Z          };
2025-11-10T00:08:56.5638299Z -        
2025-11-10T00:08:56.5638402Z +
2025-11-10T00:08:56.5638529Z          let addresses = {
2025-11-10T00:08:56.5638989Z              let mut db = self.address_database.lock().unwrap();
2025-11-10T00:08:56.5639169Z              let fresh = db.get_fresh_addresses(2500);
2025-11-10T00:08:56.5639622Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2480:
2025-11-10T00:08:56.5639874Z              db.filter_addresses(fresh, &ban_list, &connected_peers)
2025-11-10T00:08:56.5639981Z          };
2025-11-10T00:08:56.5640086Z -        
2025-11-10T00:08:56.5640189Z +
2025-11-10T00:08:56.5640327Z          // Create Addr message
2025-11-10T00:08:56.5640494Z          let addr_msg = AddrMessage { addresses };
2025-11-10T00:08:56.5640709Z          let response = ProtocolMessage::Addr(addr_msg);
2025-11-10T00:08:56.5641164Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2486:
2025-11-10T00:08:56.5641443Z          let wire_msg = ProtocolParser::serialize_message(&response)?;
2025-11-10T00:08:56.5641554Z -        
2025-11-10T00:08:56.5641876Z +
2025-11-10T00:08:56.5642022Z          // Send response
2025-11-10T00:08:56.5642221Z          self.send_to_peer(peer_addr, wire_msg).await?;
2025-11-10T00:08:56.5642337Z          Ok(())
2025-11-10T00:08:56.5642798Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2493:
2025-11-10T00:08:56.5643068Z      /// Handle Addr message - store addresses and optionally relay
2025-11-10T00:08:56.5643439Z      async fn handle_addr(&self, peer_addr: SocketAddr, msg: AddrMessage) -> Result<()> {
2025-11-10T00:08:56.5643650Z          use crate::network::protocol::NetworkAddress;
2025-11-10T00:08:56.5643760Z -        
2025-11-10T00:08:56.5643866Z +
2025-11-10T00:08:56.5644028Z          // Get peer services from peer state
2025-11-10T00:08:56.5644171Z          let peer_services = {
2025-11-10T00:08:56.5644579Z              let peer_states = self.peer_states.lock().unwrap();
2025-11-10T00:08:56.5645053Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2502:
2025-11-10T00:08:56.5645233Z                  .map(|state| state.services)
2025-11-10T00:08:56.5645365Z                  .unwrap_or(0)
2025-11-10T00:08:56.5645472Z          };
2025-11-10T00:08:56.5645583Z -        
2025-11-10T00:08:56.5645701Z +
2025-11-10T00:08:56.5645852Z          // Store addresses in database
2025-11-10T00:08:56.5645962Z          {
2025-11-10T00:08:56.5646181Z              let mut db = self.address_database.lock().unwrap();
2025-11-10T00:08:56.5646634Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2510:
2025-11-10T00:08:56.5646831Z                  db.add_address(addr.clone(), peer_services);
2025-11-10T00:08:56.5646954Z              }
2025-11-10T00:08:56.5647062Z          }
2025-11-10T00:08:56.5647171Z -        
2025-11-10T00:08:56.5647275Z +
2025-11-10T00:08:56.5647488Z          // Relay addresses to other peers (with rate limiting)
2025-11-10T00:08:56.5647717Z          self.relay_addresses(peer_addr, &msg.addresses).await?;
2025-11-10T00:08:56.5647829Z -        
2025-11-10T00:08:56.5647945Z +
2025-11-10T00:08:56.5648056Z          Ok(())
2025-11-10T00:08:56.5648166Z      }
2025-11-10T00:08:56.5648271Z  
2025-11-10T00:08:56.5648732Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2525:
2025-11-10T00:08:56.5648851Z      ) -> Result<()> {
2025-11-10T00:08:56.5649230Z          use crate::network::protocol::{AddrMessage, ProtocolMessage, ProtocolParser};
2025-11-10T00:08:56.5649416Z          use std::time::{SystemTime, UNIX_EPOCH};
2025-11-10T00:08:56.5649527Z -        
2025-11-10T00:08:56.5649633Z +
2025-11-10T00:08:56.5650021Z          // Rate limiting: don't send addr messages too frequently (Bitcoin Core: ~every 2.4 hours)
2025-11-10T00:08:56.5650176Z          let now = SystemTime::now()
2025-11-10T00:08:56.5650314Z              .duration_since(UNIX_EPOCH)
2025-11-10T00:08:56.5650726Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2532:
2025-11-10T00:08:56.5650850Z              .unwrap()
2025-11-10T00:08:56.5651177Z              .as_secs();
2025-11-10T00:08:56.5651413Z          let min_interval = 2 * 60 * 60 + 24 * 60; // 2.4 hours in seconds
2025-11-10T00:08:56.5651533Z -        
2025-11-10T00:08:56.5651639Z +
2025-11-10T00:08:56.5651747Z          {
2025-11-10T00:08:56.5651966Z              let last_sent = *self.last_addr_sent.lock().unwrap();
2025-11-10T00:08:56.5652177Z              if now.saturating_sub(last_sent) < min_interval {
2025-11-10T00:08:56.5652632Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2540:
2025-11-10T00:08:56.5652769Z                  return Ok(());
2025-11-10T00:08:56.5652888Z              }
2025-11-10T00:08:56.5652997Z          }
2025-11-10T00:08:56.5653104Z -        
2025-11-10T00:08:56.5653209Z +
2025-11-10T00:08:56.5653491Z          // Filter addresses (exclude local, banned, already connected)
2025-11-10T00:08:56.5653704Z          let ban_list = self.ban_list.lock().unwrap().clone();
2025-11-10T00:08:56.5654142Z          let connected_peers: Vec<SocketAddr> = {
2025-11-10T00:08:56.5654886Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2547:
2025-11-10T00:08:56.5655088Z              let pm = self.peer_manager.lock().unwrap();
2025-11-10T00:08:56.5655239Z              pm.peer_socket_addresses()
2025-11-10T00:08:56.5655352Z          };
2025-11-10T00:08:56.5655469Z -        
2025-11-10T00:08:56.5655576Z +
2025-11-10T00:08:56.5655712Z          let filtered = {
2025-11-10T00:08:56.5655910Z              let db = self.address_database.lock().unwrap();
2025-11-10T00:08:56.5656284Z              db.filter_addresses(addresses.to_vec(), &ban_list, &connected_peers)
2025-11-10T00:08:56.5656777Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2554:
2025-11-10T00:08:56.5656895Z          };
2025-11-10T00:08:56.5657000Z -        
2025-11-10T00:08:56.5657095Z +
2025-11-10T00:08:56.5657231Z          if filtered.is_empty() {
2025-11-10T00:08:56.5657378Z              return Ok(());
2025-11-10T00:08:56.5657493Z          }
2025-11-10T00:08:56.5657935Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2559:
2025-11-10T00:08:56.5658052Z -        
2025-11-10T00:08:56.5658149Z +
2025-11-10T00:08:56.5658386Z          // Limit to 1000 addresses per message (Bitcoin Core limit)
2025-11-10T00:08:56.5658819Z          let addresses_to_relay: Vec<NetworkAddress> = filtered.into_iter().take(1000).collect();
2025-11-10T00:08:56.5658929Z -        
2025-11-10T00:08:56.5659028Z +
2025-11-10T00:08:56.5659149Z          // Create Addr message
2025-11-10T00:08:56.5659299Z          let addr_msg = AddrMessage {
2025-11-10T00:08:56.5659456Z              addresses: addresses_to_relay,
2025-11-10T00:08:56.5659915Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2566:
2025-11-10T00:08:56.5660024Z          };
2025-11-10T00:08:56.5660245Z          let relay_msg = ProtocolMessage::Addr(addr_msg);
2025-11-10T00:08:56.5660527Z          let wire_msg = ProtocolParser::serialize_message(&relay_msg)?;
2025-11-10T00:08:56.5660641Z -        
2025-11-10T00:08:56.5660754Z +
2025-11-10T00:08:56.5660911Z          // Send to all peers except sender
2025-11-10T00:08:56.5661070Z          let peer_addrs: Vec<SocketAddr> = {
2025-11-10T00:08:56.5663130Z              let pm = self.peer_manager.lock().unwrap();
2025-11-10T00:08:56.5663602Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2575:
2025-11-10T00:08:56.5663769Z                  .filter(|addr| *addr != sender_addr)
2025-11-10T00:08:56.5663893Z                  .collect()
2025-11-10T00:08:56.5664012Z          };
2025-11-10T00:08:56.5664114Z -        
2025-11-10T00:08:56.5664219Z +
2025-11-10T00:08:56.5664545Z          for peer_addr in peer_addrs {
2025-11-10T00:08:56.5664843Z              if let Err(e) = self.send_to_peer(peer_addr, wire_msg.clone()).await {
2025-11-10T00:08:56.5665086Z                  warn!("Failed to relay addresses to {}: {}", peer_addr, e);
2025-11-10T00:08:56.5665841Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2582:
2025-11-10T00:08:56.5665964Z              }
2025-11-10T00:08:56.5666071Z          }
2025-11-10T00:08:56.5666182Z -        
2025-11-10T00:08:56.5666295Z +
2025-11-10T00:08:56.5666430Z          // Update last sent time
2025-11-10T00:08:56.5666614Z          *self.last_addr_sent.lock().unwrap() = now;
2025-11-10T00:08:56.5666719Z -        
2025-11-10T00:08:56.5666836Z +
2025-11-10T00:08:56.5666947Z          Ok(())
2025-11-10T00:08:56.5667049Z      }
2025-11-10T00:08:56.5667161Z  
2025-11-10T00:08:56.5667623Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2593:
2025-11-10T00:08:56.5667784Z          if !self.enable_self_advertisement {
2025-11-10T00:08:56.5667982Z              return Ok(()); // Self-advertisement disabled
2025-11-10T00:08:56.5668099Z          }
2025-11-10T00:08:56.5668417Z -        
2025-11-10T00:08:56.5668907Z -        use crate::network::protocol::{AddrMessage, NetworkAddress, ProtocolMessage, ProtocolParser};
2025-11-10T00:08:56.5669033Z +
2025-11-10T00:08:56.5669188Z +        use crate::network::protocol::{
2025-11-10T00:08:56.5669492Z +            AddrMessage, NetworkAddress, ProtocolMessage, ProtocolParser,
2025-11-10T00:08:56.5669605Z +        };
2025-11-10T00:08:56.5669747Z          use std::net::IpAddr;
2025-11-10T00:08:56.5669850Z -        
2025-11-10T00:08:56.5669951Z +
2025-11-10T00:08:56.5670132Z          // Convert SocketAddr to NetworkAddress
2025-11-10T00:08:56.5670299Z          let ip_bytes = match listen_addr.ip() {
2025-11-10T00:08:56.5670440Z              IpAddr::V4(ipv4) => {
2025-11-10T00:08:56.5670959Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2607:
2025-11-10T00:08:56.5671220Z                  bytes[12..16].copy_from_slice(&ipv4.octets());
2025-11-10T00:08:56.5671341Z                  bytes
2025-11-10T00:08:56.5671458Z              }
2025-11-10T00:08:56.5671605Z -            IpAddr::V6(ipv6) => {
2025-11-10T00:08:56.5671724Z -                ipv6.octets()
2025-11-10T00:08:56.5671832Z -            }
2025-11-10T00:08:56.5672006Z +            IpAddr::V6(ipv6) => ipv6.octets(),
2025-11-10T00:08:56.5672116Z          };
2025-11-10T00:08:56.5672222Z -        
2025-11-10T00:08:56.5672325Z +
2025-11-10T00:08:56.5672493Z          let our_addr = NetworkAddress {
2025-11-10T00:08:56.5672811Z              services,
2025-11-10T00:08:56.5672941Z              ip: ip_bytes,
2025-11-10T00:08:56.5673393Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2618:
2025-11-10T00:08:56.5673552Z              port: listen_addr.port(),
2025-11-10T00:08:56.5673712Z          };
2025-11-10T00:08:56.5673818Z -        
2025-11-10T00:08:56.5673925Z +
2025-11-10T00:08:56.5674097Z          // Create Addr message with just our address
2025-11-10T00:08:56.5674241Z          let addr_msg = AddrMessage {
2025-11-10T00:08:56.5674568Z              addresses: vec![our_addr.clone()],
2025-11-10T00:08:56.5675060Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2624:
2025-11-10T00:08:56.5675180Z          };
2025-11-10T00:08:56.5675401Z          let relay_msg = ProtocolMessage::Addr(addr_msg);
2025-11-10T00:08:56.5675685Z          let wire_msg = ProtocolParser::serialize_message(&relay_msg)?;
2025-11-10T00:08:56.5675795Z -        
2025-11-10T00:08:56.5675895Z +
2025-11-10T00:08:56.5676048Z          // Send to all connected peers
2025-11-10T00:08:56.5676201Z          let peer_addrs: Vec<SocketAddr> = {
2025-11-10T00:08:56.5676380Z              let pm = self.peer_manager.lock().unwrap();
2025-11-10T00:08:56.5676809Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2631:
2025-11-10T00:08:56.5676957Z              pm.peer_socket_addresses()
2025-11-10T00:08:56.5677115Z          };
2025-11-10T00:08:56.5677218Z -        
2025-11-10T00:08:56.5677323Z +
2025-11-10T00:08:56.5677471Z          for peer_addr in peer_addrs {
2025-11-10T00:08:56.5677976Z              if let Err(e) = self.send_to_peer(peer_addr, wire_msg.clone()).await {
2025-11-10T00:08:56.5678234Z                  warn!("Failed to advertise self to {}: {}", peer_addr, e);
2025-11-10T00:08:56.5678681Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2637:
2025-11-10T00:08:56.5678788Z              }
2025-11-10T00:08:56.5678896Z          }
2025-11-10T00:08:56.5679012Z -        
2025-11-10T00:08:56.5679117Z +
2025-11-10T00:08:56.5679285Z          // Also store our own address in database
2025-11-10T00:08:56.5679394Z          {
2025-11-10T00:08:56.5679598Z              let mut db = self.address_database.lock().unwrap();
2025-11-10T00:08:56.5680030Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2643:
2025-11-10T00:08:56.5680184Z              db.add_address(our_addr, services);
2025-11-10T00:08:56.5680299Z          }
2025-11-10T00:08:56.5680617Z -        
2025-11-10T00:08:56.5680731Z +
2025-11-10T00:08:56.5680851Z          Ok(())
2025-11-10T00:08:56.5680960Z      }
2025-11-10T00:08:56.5681063Z  
2025-11-10T00:08:56.5681586Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2649:
2025-11-10T00:08:56.5681739Z      /// Get list of banned peers
2025-11-10T00:08:56.5681986Z      pub fn get_banned_peers(&self) -> Vec<(SocketAddr, u64)> {
2025-11-10T00:08:56.5682173Z          let ban_list = self.ban_list.lock().unwrap();
2025-11-10T00:08:56.5682484Z -        ban_list.iter().map(|(addr, timestamp)| (*addr, *timestamp)).collect()
2025-11-10T00:08:56.5682604Z +        ban_list
2025-11-10T00:08:56.5682720Z +            .iter()
2025-11-10T00:08:56.5682912Z +            .map(|(addr, timestamp)| (*addr, *timestamp))
2025-11-10T00:08:56.5683044Z +            .collect()
2025-11-10T00:08:56.5683148Z      }
2025-11-10T00:08:56.5683252Z  
2025-11-10T00:08:56.5683446Z      /// Get peer addresses (async version for RPC)
2025-11-10T00:08:56.5683915Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2714:
2025-11-10T00:08:56.5684065Z          peer_addr: SocketAddr,
2025-11-10T00:08:56.5684516Z          msg: crate::network::protocol::GetBanListMessage,
2025-11-10T00:08:56.5684661Z      ) -> Result<()> {
2025-11-10T00:08:56.5686853Z -        use crate::network::protocol::{BanEntry, BanListMessage, NetworkAddress};
2025-11-10T00:08:56.5687129Z          use crate::network::ban_list_merging::calculate_ban_list_hash;
2025-11-10T00:08:56.5687469Z +        use crate::network::protocol::{BanEntry, BanListMessage, NetworkAddress};
2025-11-10T00:08:56.5687656Z          use std::time::{SystemTime, UNIX_EPOCH};
2025-11-10T00:08:56.5687761Z  
2025-11-10T00:08:56.5688039Z -        debug!("GetBanList request from {}: full={}, min_duration={}", 
2025-11-10T00:08:56.5688267Z -               peer_addr, msg.request_full, msg.min_ban_duration);
2025-11-10T00:08:56.5688389Z +        debug!(
2025-11-10T00:08:56.5688647Z +            "GetBanList request from {}: full={}, min_duration={}",
2025-11-10T00:08:56.5688866Z +            peer_addr, msg.request_full, msg.min_ban_duration
2025-11-10T00:08:56.5688976Z +        );
2025-11-10T00:08:56.5689083Z  
2025-11-10T00:08:56.5689233Z          // Get current ban list
2025-11-10T00:08:56.5689420Z          let ban_list = self.ban_list.lock().unwrap();
2025-11-10T00:08:56.5690323Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2776:
2025-11-10T00:08:56.5690507Z          let response = BanListMessage {
2025-11-10T00:08:56.5690748Z              is_full: msg.request_full,
2025-11-10T00:08:56.5690869Z              ban_list_hash,
2025-11-10T00:08:56.5691170Z -            ban_entries: if msg.request_full { ban_entries } else { Vec::new() },
2025-11-10T00:08:56.5691344Z +            ban_entries: if msg.request_full {
2025-11-10T00:08:56.5691473Z +                ban_entries
2025-11-10T00:08:56.5691590Z +            } else {
2025-11-10T00:08:56.5691737Z +                Vec::new()
2025-11-10T00:08:56.5692114Z +            },
2025-11-10T00:08:56.5692254Z              timestamp: now,
2025-11-10T00:08:56.5692360Z          };
2025-11-10T00:08:56.5692476Z  
2025-11-10T00:08:56.5692940Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2785:
2025-11-10T00:08:56.5693275Z          let serialized = ProtocolParser::serialize_message(&response_msg)?;
2025-11-10T00:08:56.5693500Z          self.send_to_peer(peer_addr, serialized).await?;
2025-11-10T00:08:56.5695692Z  
2025-11-10T00:08:56.5695961Z -        debug!("Sent BanList response to {}: {} entries", peer_addr, 
2025-11-10T00:08:56.5696200Z -               if msg.request_full { ban_entries.len() } else { 0 });
2025-11-10T00:08:56.5696316Z +        debug!(
2025-11-10T00:08:56.5696494Z +            "Sent BanList response to {}: {} entries",
2025-11-10T00:08:56.5696619Z +            peer_addr,
2025-11-10T00:08:56.5696771Z +            if msg.request_full {
2025-11-10T00:08:56.5697156Z +                ban_entries.len()
2025-11-10T00:08:56.5697281Z +            } else {
2025-11-10T00:08:56.5697405Z +                0
2025-11-10T00:08:56.5697512Z +            }
2025-11-10T00:08:56.5697614Z +        );
2025-11-10T00:08:56.5697715Z  
2025-11-10T00:08:56.5697827Z          Ok(())
2025-11-10T00:08:56.5697928Z      }
2025-11-10T00:08:56.5698370Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2800:
2025-11-10T00:08:56.5698728Z          use crate::network::ban_list_merging::{validate_ban_entry, verify_ban_list_hash};
2025-11-10T00:08:56.5698869Z          use std::net::IpAddr;
2025-11-10T00:08:56.5698973Z  
2025-11-10T00:08:56.5699192Z -        debug!("BanList received from {}: full={}, {} entries", 
2025-11-10T00:08:56.5699401Z -               peer_addr, msg.is_full, msg.ban_entries.len());
2025-11-10T00:08:56.5699507Z +        debug!(
2025-11-10T00:08:56.5699694Z +            "BanList received from {}: full={}, {} entries",
2025-11-10T00:08:56.5699827Z +            peer_addr,
2025-11-10T00:08:56.5699948Z +            msg.is_full,
2025-11-10T00:08:56.5700087Z +            msg.ban_entries.len()
2025-11-10T00:08:56.5700207Z +        );
2025-11-10T00:08:56.5700314Z  
2025-11-10T00:08:56.5700476Z          // Verify hash if full list provided
2025-11-10T00:08:56.5700602Z          if msg.is_full {
2025-11-10T00:08:56.5701182Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2813:
2025-11-10T00:08:56.5701293Z  
2025-11-10T00:08:56.5701561Z          // If hash-only, we can't merge (would need to request full list)
2025-11-10T00:08:56.5701706Z          if !msg.is_full {
2025-11-10T00:08:56.5702045Z -            debug!("Received hash-only ban list from {}, skipping merge", peer_addr);
2025-11-10T00:08:56.5702167Z +            debug!(
2025-11-10T00:08:56.5702407Z +                "Received hash-only ban list from {}, skipping merge",
2025-11-10T00:08:56.5702542Z +                peer_addr
2025-11-10T00:08:56.5702665Z +            );
2025-11-10T00:08:56.5702789Z              return Ok(());
2025-11-10T00:08:56.5702912Z          }
2025-11-10T00:08:56.5703016Z  
2025-11-10T00:08:56.5705628Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2831:
2025-11-10T00:08:56.5705800Z                  // IPv4-mapped IPv6 address
2025-11-10T00:08:56.5705999Z                  let ipv4_bytes = &entry.addr.ip[12..16];
2025-11-10T00:08:56.5706176Z                  IpAddr::V4(std::net::Ipv4Addr::new(
2025-11-10T00:08:56.5706423Z -                    ipv4_bytes[0], ipv4_bytes[1], ipv4_bytes[2], ipv4_bytes[3]
2025-11-10T00:08:56.5706566Z +                    ipv4_bytes[0],
2025-11-10T00:08:56.5706694Z +                    ipv4_bytes[1],
2025-11-10T00:08:56.5706821Z +                    ipv4_bytes[2],
2025-11-10T00:08:56.5706954Z +                    ipv4_bytes[3],
2025-11-10T00:08:56.5707066Z                  ))
2025-11-10T00:08:56.5707180Z              } else {
2025-11-10T00:08:56.5707313Z                  // IPv6 address
2025-11-10T00:08:56.5707788Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2882:
2025-11-10T00:08:56.5708182Z              ban_list.len()
2025-11-10T00:08:56.5708289Z          };
2025-11-10T00:08:56.5708579Z          let resource_metrics = self.dos_protection.get_metrics().await;
2025-11-10T00:08:56.5708689Z -        
2025-11-10T00:08:56.5708792Z +
2025-11-10T00:08:56.5708974Z          crate::node::metrics::NetworkMetrics {
2025-11-10T00:08:56.5709149Z              peer_count: active_connections,
2025-11-10T00:08:56.5709287Z              bytes_sent: sent,
2025-11-10T00:08:56.5709845Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2889:
2025-11-10T00:08:56.5710009Z              bytes_received: received,
2025-11-10T00:08:56.5710200Z -            messages_sent: 0, // Would need to track this
2025-11-10T00:08:56.5710402Z +            messages_sent: 0,     // Would need to track this
2025-11-10T00:08:56.5710598Z              messages_received: 0, // Would need to track this
2025-11-10T00:08:56.5710973Z              active_connections,
2025-11-10T00:08:56.5711131Z              banned_peers: banned_peers_count,
2025-11-10T00:08:56.5711564Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2894:
2025-11-10T00:08:56.5711780Z              connection_attempts: 0, // Would need to track this
2025-11-10T00:08:56.5711977Z              connection_failures: 0, // Would need to track this
2025-11-10T00:08:56.5712187Z              dos_protection: crate::node::metrics::DosMetrics {
2025-11-10T00:08:56.5712451Z -                connection_rate_violations: 0, // Would need to track this
2025-11-10T00:08:56.5712626Z -                auto_bans: 0, // Would need to track this
2025-11-10T00:08:56.5714975Z -                message_queue_overflows: 0, // Would need to track this
2025-11-10T00:08:56.5715254Z +                connection_rate_violations: 0,   // Would need to track this
2025-11-10T00:08:56.5715465Z +                auto_bans: 0,                    // Would need to track this
2025-11-10T00:08:56.5715716Z +                message_queue_overflows: 0,      // Would need to track this
2025-11-10T00:08:56.5715977Z                  active_connection_limit_hits: 0, // Would need to track this
2025-11-10T00:08:56.5716254Z -                resource_exhaustion_events: 0, // Would need to track this
2025-11-10T00:08:56.5716525Z +                resource_exhaustion_events: 0,   // Would need to track this
2025-11-10T00:08:56.5716640Z              },
2025-11-10T00:08:56.5716761Z          }
2025-11-10T00:08:56.5716868Z      }
2025-11-10T00:08:56.5717327Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2913:
2025-11-10T00:08:56.5717513Z      /// Create version message with service flags
2025-11-10T00:08:56.5717624Z      ///
2025-11-10T00:08:56.5717955Z      /// Creates version message with service flags for all supported features
2025-11-10T00:08:56.5718061Z -    /// 
2025-11-10T00:08:56.5718178Z +    ///
2025-11-10T00:08:56.5718332Z      /// Sets service flags based on:
2025-11-10T00:08:56.5718646Z      /// - BIP157: NODE_COMPACT_FILTERS (always enabled if filter service exists)
2025-11-10T00:08:56.5718932Z      /// - UTXO Commitments: NODE_UTXO_COMMITMENTS (if feature enabled)
2025-11-10T00:08:56.5719464Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2937:
2025-11-10T00:08:56.5719574Z  
2025-11-10T00:08:56.5719749Z          // Add service flags for supported features
2025-11-10T00:08:56.5719927Z          let mut services_with_filters = services;
2025-11-10T00:08:56.5720038Z -        
2025-11-10T00:08:56.5720140Z +
2025-11-10T00:08:56.5720482Z          // BIP157 Compact Block Filters (always enabled if filter service exists)
2025-11-10T00:08:56.5720681Z          services_with_filters |= NODE_COMPACT_FILTERS;
2025-11-10T00:08:56.5720791Z -        
2025-11-10T00:08:56.5720906Z +
2025-11-10T00:08:56.5721075Z          // UTXO Commitments (if feature enabled)
2025-11-10T00:08:56.5721546Z          #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.5721666Z          {
2025-11-10T00:08:56.5723602Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2947:
2025-11-10T00:08:56.5723965Z              services_with_filters |= crate::network::protocol::NODE_UTXO_COMMITMENTS;
2025-11-10T00:08:56.5724076Z          }
2025-11-10T00:08:56.5724195Z -        
2025-11-10T00:08:56.5724485Z +
2025-11-10T00:08:56.5724661Z          // Ban List Sharing (if config enabled)
2025-11-10T00:08:56.5724847Z          if self.ban_list_sharing_config.is_some() {
2025-11-10T00:08:56.5725198Z              services_with_filters |= crate::network::protocol::NODE_BAN_LIST_SHARING;
2025-11-10T00:08:56.5725662Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2953:
2025-11-10T00:08:56.5725776Z          }
2025-11-10T00:08:56.5725900Z -        
2025-11-10T00:08:56.5726003Z +
2025-11-10T00:08:56.5726426Z          // Dandelion (if feature enabled)
2025-11-10T00:08:56.5726588Z          #[cfg(feature = "dandelion")]
2025-11-10T00:08:56.5726707Z          {
2025-11-10T00:08:56.5727167Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2958:
2025-11-10T00:08:56.5727473Z              services_with_filters |= crate::network::protocol::NODE_DANDELION;
2025-11-10T00:08:56.5727590Z          }
2025-11-10T00:08:56.5727700Z -        
2025-11-10T00:08:56.5727804Z +
2025-11-10T00:08:56.5727986Z          // Package Relay (BIP331) - always enabled
2025-11-10T00:08:56.5728304Z          services_with_filters |= crate::network::protocol::NODE_PACKAGE_RELAY;
2025-11-10T00:08:56.5728408Z -        
2025-11-10T00:08:56.5728512Z +
2025-11-10T00:08:56.5728667Z          // FIBRE - always enabled
2025-11-10T00:08:56.5728946Z          services_with_filters |= crate::network::protocol::NODE_FIBRE;
2025-11-10T00:08:56.5729051Z  
2025-11-10T00:08:56.5729577Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/package_relay.rs:138:
2025-11-10T00:08:56.5729921Z      pub fn new(transactions: Vec<Transaction>) -> Result<Self, PackageError> {
2025-11-10T00:08:56.5730113Z          Self::new_with_utxo_set(transactions, None)
2025-11-10T00:08:56.5730226Z      }
2025-11-10T00:08:56.5730326Z -    
2025-11-10T00:08:56.5730421Z +
2025-11-10T00:08:56.5730707Z      /// Create a new transaction package with UTXO set for fee calculation
2025-11-10T00:08:56.5730842Z      pub fn new_with_utxo_set(
2025-11-10T00:08:56.5730987Z          transactions: Vec<Transaction>,
2025-11-10T00:08:56.5731468Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/package_relay.rs:168:
2025-11-10T00:08:56.5731687Z          // Calculate combined fee from UTXO set if provided
2025-11-10T00:08:56.5731904Z          let combined_fee = if let Some(utxo_set) = utxo_set {
2025-11-10T00:08:56.5732170Z              // Calculate fee for each transaction: sum(inputs) - sum(outputs)
2025-11-10T00:08:56.5732332Z -            transactions.iter().map(|tx| {
2025-11-10T00:08:56.5732501Z -                let input_total: u64 = tx.inputs.iter()
2025-11-10T00:08:56.5732688Z -                    .filter_map(|inp| utxo_set.get(&inp.prevout))
2025-11-10T00:08:56.5734888Z -                    .map(|utxo| utxo.value as u64)
2025-11-10T00:08:56.5735017Z -                    .sum();
2025-11-10T00:08:56.5735203Z -                let output_total: u64 = tx.outputs.iter()
2025-11-10T00:08:56.5735361Z -                    .map(|out| out.value as u64)
2025-11-10T00:08:56.5735494Z -                    .sum();
2025-11-10T00:08:56.5735646Z -                if input_total > output_total {
2025-11-10T00:08:56.5735805Z -                    input_total - output_total
2025-11-10T00:08:56.5735931Z -                } else {
2025-11-10T00:08:56.5736044Z -                    0
2025-11-10T00:08:56.5736156Z -                }
2025-11-10T00:08:56.5736267Z -            }).sum()
2025-11-10T00:08:56.5736390Z +            transactions
2025-11-10T00:08:56.5736511Z +                .iter()
2025-11-10T00:08:56.5736873Z +                .map(|tx| {
2025-11-10T00:08:56.5737031Z +                    let input_total: u64 = tx
2025-11-10T00:08:56.5737151Z +                        .inputs
2025-11-10T00:08:56.5737262Z +                        .iter()
2025-11-10T00:08:56.5737467Z +                        .filter_map(|inp| utxo_set.get(&inp.prevout))
2025-11-10T00:08:56.5737636Z +                        .map(|utxo| utxo.value as u64)
2025-11-10T00:08:56.5737755Z +                        .sum();
2025-11-10T00:08:56.5738091Z +                    let output_total: u64 = tx.outputs.iter().map(|out| out.value as u64).sum();
2025-11-10T00:08:56.5738259Z +                    if input_total > output_total {
2025-11-10T00:08:56.5738413Z +                        input_total - output_total
2025-11-10T00:08:56.5738526Z +                    } else {
2025-11-10T00:08:56.5738648Z +                        0
2025-11-10T00:08:56.5738762Z +                    }
2025-11-10T00:08:56.5739052Z +                })
2025-11-10T00:08:56.5739174Z +                .sum()
2025-11-10T00:08:56.5739289Z          } else {
2025-11-10T00:08:56.5739450Z              0 // Fee calculation requires UTXO set
2025-11-10T00:08:56.5739555Z          };
2025-11-10T00:08:56.5740107Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:4:
2025-11-10T00:08:56.5740222Z  
2025-11-10T00:08:56.5740359Z  use anyhow::Result;
2025-11-10T00:08:56.5740490Z  use std::net::SocketAddr;
2025-11-10T00:08:56.5740609Z +use std::sync::Arc;
2025-11-10T00:08:56.5741221Z  use std::time::{SystemTime, UNIX_EPOCH};
2025-11-10T00:08:56.5741350Z  use tokio::sync::mpsc;
2025-11-10T00:08:56.5741487Z  use tracing::{debug, info, warn};
2025-11-10T00:08:56.5741907Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:10:
2025-11-10T00:08:56.5742030Z -use std::sync::Arc;
2025-11-10T00:08:56.5742131Z  
2025-11-10T00:08:56.5742394Z +use super::transport::{TransportAddr, TransportConnection};
2025-11-10T00:08:56.5742543Z  use super::NetworkMessage;
2025-11-10T00:08:56.5742781Z -use super::transport::{TransportConnection, TransportAddr};
2025-11-10T00:08:56.5742881Z  
2025-11-10T00:08:56.5743003Z  /// Peer connection state
2025-11-10T00:08:56.5743098Z -/// 
2025-11-10T00:08:56.5743192Z +///
2025-11-10T00:08:56.5743593Z  /// Supports multiple transport types (TCP, Quinn, Iroh) via TransportConnection trait
2025-11-10T00:08:56.5743715Z  pub struct Peer {
2025-11-10T00:08:56.5743833Z      addr: SocketAddr,
2025-11-10T00:08:56.5744257Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:48:
2025-11-10T00:08:56.5744536Z  
2025-11-10T00:08:56.5744649Z  impl Peer {
2025-11-10T00:08:56.5744877Z      /// Create a new peer connection from a TransportConnection
2025-11-10T00:08:56.5744986Z -    /// 
2025-11-10T00:08:56.5745092Z +    ///
2025-11-10T00:08:56.5745470Z      /// This is the preferred method as it supports all transport types (TCP, Quinn, Iroh).
2025-11-10T00:08:56.5747289Z      /// The connection is managed via channels for concurrent read/write.
2025-11-10T00:08:56.5747601Z      pub fn from_transport_connection<C: TransportConnection + 'static>(
2025-11-10T00:08:56.5748050Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:59:
2025-11-10T00:08:56.5748169Z      ) -> Self {
2025-11-10T00:08:56.5748318Z          // Create channel for sending messages
2025-11-10T00:08:56.5748570Z          let (send_tx, send_rx) = mpsc::unbounded_channel::<Vec<u8>>();
2025-11-10T00:08:56.5748685Z -        
2025-11-10T00:08:56.5748790Z +
2025-11-10T00:08:56.5749005Z          let transport_addr_clone = transport_addr.clone();
2025-11-10T00:08:56.5749287Z          let message_tx_clone = message_tx.clone();
2025-11-10T00:08:56.5749408Z -        
2025-11-10T00:08:56.5749511Z +
2025-11-10T00:08:56.5749819Z          // Wrap connection in Arc<Mutex> to share between read and write tasks
2025-11-10T00:08:56.5749970Z          use std::sync::Arc;
2025-11-10T00:08:56.5750119Z          use tokio::sync::Mutex;
2025-11-10T00:08:56.5750810Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:69:
2025-11-10T00:08:56.5750967Z          let conn = Arc::new(Mutex::new(conn));
2025-11-10T00:08:56.5751116Z          let conn_read = Arc::clone(&conn);
2025-11-10T00:08:56.5751260Z          let conn_write = Arc::clone(&conn);
2025-11-10T00:08:56.5751359Z -        
2025-11-10T00:08:56.5751461Z +
2025-11-10T00:08:56.5751667Z          // Spawn read task using TransportConnection::recv
2025-11-10T00:08:56.5751809Z          tokio::spawn(async move {
2025-11-10T00:08:56.5751935Z              loop {
2025-11-10T00:08:56.5752381Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:83:
2025-11-10T00:08:56.5752501Z                          }
2025-11-10T00:08:56.5752608Z                      }
2025-11-10T00:08:56.5752727Z                  };
2025-11-10T00:08:56.5752837Z -                
2025-11-10T00:08:56.5753150Z +
2025-11-10T00:08:56.5753309Z                  if data.is_empty() {
2025-11-10T00:08:56.5753430Z                      break;
2025-11-10T00:08:56.5753538Z                  }
2025-11-10T00:08:56.5753979Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:90:
2025-11-10T00:08:56.5754098Z -                
2025-11-10T00:08:56.5754208Z +
2025-11-10T00:08:56.5754587Z                  let peer_addr = match &transport_addr_clone {
2025-11-10T00:08:56.5754837Z                      super::transport::TransportAddr::Tcp(sock) => *sock,
2025-11-10T00:08:56.5754986Z                      #[cfg(feature = "quinn")]
2025-11-10T00:08:56.5755433Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:100:
2025-11-10T00:08:56.5755818Z                  let _ = message_tx_clone.send(NetworkMessage::RawMessageReceived(data, peer_addr));
2025-11-10T00:08:56.5755936Z              }
2025-11-10T00:08:56.5756041Z          });
2025-11-10T00:08:56.5756155Z -        
2025-11-10T00:08:56.5756270Z +
2025-11-10T00:08:56.5756482Z          // Spawn write task using TransportConnection::send
2025-11-10T00:08:56.5756618Z          tokio::spawn(async move {
2025-11-10T00:08:56.5756772Z              let mut send_rx = send_rx;
2025-11-10T00:08:56.5757202Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:107:
2025-11-10T00:08:56.5757300Z -            
2025-11-10T00:08:56.5757396Z +
2025-11-10T00:08:56.5757506Z              loop {
2025-11-10T00:08:56.5757643Z                  match send_rx.recv().await {
2025-11-10T00:08:56.5757762Z                      Some(data) => {
2025-11-10T00:08:56.5758205Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:124:
2025-11-10T00:08:56.5758307Z                      }
2025-11-10T00:08:56.5758407Z                  }
2025-11-10T00:08:56.5758504Z              }
2025-11-10T00:08:56.5758610Z -            
2025-11-10T00:08:56.5758706Z +
2025-11-10T00:08:56.5758895Z              // Gracefully close connection on write task exit
2025-11-10T00:08:56.5759121Z              // Connection will be closed when conn_guard is dropped
2025-11-10T00:08:56.5759219Z          });
2025-11-10T00:08:56.5759635Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:131:
2025-11-10T00:08:56.5759732Z -        
2025-11-10T00:08:56.5759841Z +
2025-11-10T00:08:56.5759978Z          let now = SystemTime::now()
2025-11-10T00:08:56.5760113Z              .duration_since(UNIX_EPOCH)
2025-11-10T00:08:56.5760222Z              .unwrap()
2025-11-10T00:08:56.5760647Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:135:
2025-11-10T00:08:56.5760775Z              .as_secs();
2025-11-10T00:08:56.5760872Z -        
2025-11-10T00:08:56.5760967Z +
2025-11-10T00:08:56.5761076Z          Self {
2025-11-10T00:08:56.5761176Z              addr,
2025-11-10T00:08:56.5761296Z              transport_addr,
2025-11-10T00:08:56.5770783Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:153:
2025-11-10T00:08:56.5771272Z              last_tx_received: None,
2025-11-10T00:08:56.5771390Z          }
2025-11-10T00:08:56.5771500Z      }
2025-11-10T00:08:56.5771620Z -    
2025-11-10T00:08:56.5771722Z +
2025-11-10T00:08:56.5772061Z      /// Create a new peer connection from a TCP stream (backward compatibility)
2025-11-10T00:08:56.5772176Z -    /// 
2025-11-10T00:08:56.5772298Z +    ///
2025-11-10T00:08:56.5772816Z      /// This is a convenience method that wraps a TcpStream in a TcpConnection.
2025-11-10T00:08:56.5773662Z      #[deprecated(note = "Use from_transport_connection instead for transport abstraction")]
2025-11-10T00:08:56.5773793Z      pub fn new(
2025-11-10T00:08:56.5776129Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:165:
2025-11-10T00:08:56.5776251Z      ) -> Self {
2025-11-10T00:08:56.5776434Z          use super::tcp_transport::TcpConnection;
2025-11-10T00:08:56.5776855Z          use super::transport::TransportAddr;
2025-11-10T00:08:56.5776970Z -        
2025-11-10T00:08:56.5777078Z +
2025-11-10T00:08:56.5777301Z          let peer_addr = stream.peer_addr().unwrap_or(addr);
2025-11-10T00:08:56.5777440Z          let tcp_conn = TcpConnection {
2025-11-10T00:08:56.5777544Z              stream,
2025-11-10T00:08:56.5777977Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:172:
2025-11-10T00:08:56.5778164Z              peer_addr: TransportAddr::Tcp(peer_addr),
2025-11-10T00:08:56.5778300Z              connected: true,
2025-11-10T00:08:56.5778409Z          };
2025-11-10T00:08:56.5778529Z -        
2025-11-10T00:08:56.5778639Z +
2025-11-10T00:08:56.5779047Z          Self::from_transport_connection(tcp_conn, addr, TransportAddr::Tcp(addr), message_tx)
2025-11-10T00:08:56.5779166Z      }
2025-11-10T00:08:56.5779276Z  
2025-11-10T00:08:56.5779731Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:189:
2025-11-10T00:08:56.5779911Z          self.handle_peer_communication().await?;
2025-11-10T00:08:56.5780032Z  
2025-11-10T00:08:56.5780187Z          // Send disconnection notification
2025-11-10T00:08:56.5780302Z -        let _ = self
2025-11-10T00:08:56.5780427Z -            .message_tx
2025-11-10T00:08:56.5780774Z -            .send(NetworkMessage::PeerDisconnected(self.transport_addr.clone()));
2025-11-10T00:08:56.5781056Z +        let _ = self.message_tx.send(NetworkMessage::PeerDisconnected(
2025-11-10T00:08:56.5781215Z +            self.transport_addr.clone(),
2025-11-10T00:08:56.5781325Z +        ));
2025-11-10T00:08:56.5781430Z  
2025-11-10T00:08:56.5781534Z          Ok(())
2025-11-10T00:08:56.5781647Z      }
2025-11-10T00:08:56.5782089Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:198:
2025-11-10T00:08:56.5782187Z  
2025-11-10T00:08:56.5782334Z      /// Handle peer communication loop
2025-11-10T00:08:56.5782455Z -    /// 
2025-11-10T00:08:56.5782567Z +    ///
2025-11-10T00:08:56.5782841Z      /// Note: The read loop is now handled in `new()` via stream splitting.
2025-11-10T00:08:56.5783077Z      /// This method just waits for the connection to close.
2025-11-10T00:08:56.5783331Z      async fn handle_peer_communication(&mut self) -> Result<()> {
2025-11-10T00:08:56.5783753Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:205:
2025-11-10T00:08:56.5783952Z          // We just wait here to detect when connection closes
2025-11-10T00:08:56.5784495Z          // In a real implementation, we'd monitor the read task or connection state
2025-11-10T00:08:56.5784748Z          tokio::time::sleep(tokio::time::Duration::from_secs(1)).await;
2025-11-10T00:08:56.5784864Z -        
2025-11-10T00:08:56.5784965Z +
2025-11-10T00:08:56.5785386Z          // Connection close is automatically detected by the read task in from_transport_connection
2025-11-10T00:08:56.5785733Z          // When recv() returns empty data or error, the task breaks and sends PeerDisconnected
2025-11-10T00:08:56.5787983Z          self.connected = false;
2025-11-10T00:08:56.5788429Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:248:
2025-11-10T00:08:56.5788531Z      }
2025-11-10T00:08:56.5788635Z  
2025-11-10T00:08:56.5788765Z      /// Send a message to the peer
2025-11-10T00:08:56.5788863Z -    /// 
2025-11-10T00:08:56.5788962Z +    ///
2025-11-10T00:08:56.5789210Z      /// Messages are sent via a channel to a background write task.
2025-11-10T00:08:56.5789470Z      pub async fn send_message(&self, message: Vec<u8>) -> Result<()> {
2025-11-10T00:08:56.5789628Z          let message_len = message.len();
2025-11-10T00:08:56.5790107Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol.rs:2:
2025-11-10T00:08:56.5790211Z  //!
2025-11-10T00:08:56.5790559Z  //! Implements Bitcoin P2P protocol message serialization and deserialization.
2025-11-10T00:08:56.5790669Z  
2025-11-10T00:08:56.5791095Z -use bllvm_protocol::bip157::NODE_COMPACT_FILTERS;
2025-11-10T00:08:56.5791292Z  use crate::network::transport::TransportType;
2025-11-10T00:08:56.5791411Z  use anyhow::Result;
2025-11-10T00:08:56.5791624Z +use bllvm_protocol::bip157::NODE_COMPACT_FILTERS;
2025-11-10T00:08:56.5791892Z  use bllvm_protocol::{Block, BlockHeader, Hash, Transaction};
2025-11-10T00:08:56.5792055Z  use serde::{Deserialize, Serialize};
2025-11-10T00:08:56.5792170Z  
2025-11-10T00:08:56.5792656Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol.rs:145:
2025-11-10T00:08:56.5792853Z      pub fn supports_utxo_commitments(&self) -> bool {
2025-11-10T00:08:56.5793034Z          (self.services & NODE_UTXO_COMMITMENTS) != 0
2025-11-10T00:08:56.5793154Z      }
2025-11-10T00:08:56.5793266Z -    
2025-11-10T00:08:56.5793372Z +
2025-11-10T00:08:56.5793554Z      /// Check if peer supports ban list sharing
2025-11-10T00:08:56.5793752Z      pub fn supports_ban_list_sharing(&self) -> bool {
2025-11-10T00:08:56.5793941Z          (self.services & NODE_BAN_LIST_SHARING) != 0
2025-11-10T00:08:56.5794603Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol.rs:152:
2025-11-10T00:08:56.5794735Z      }
2025-11-10T00:08:56.5794838Z -    
2025-11-10T00:08:56.5794947Z +
2025-11-10T00:08:56.5795176Z      /// Check if peer supports BIP157 compact block filters
2025-11-10T00:08:56.5797101Z      pub fn supports_compact_filters(&self) -> bool {
2025-11-10T00:08:56.5797313Z          use bllvm_protocol::bip157::NODE_COMPACT_FILTERS;
2025-11-10T00:08:56.5797796Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol.rs:157:
2025-11-10T00:08:56.5797975Z          (self.services & NODE_COMPACT_FILTERS) != 0
2025-11-10T00:08:56.5798079Z      }
2025-11-10T00:08:56.5798181Z -    
2025-11-10T00:08:56.5798289Z +
2025-11-10T00:08:56.5798480Z      /// Check if peer supports package relay (BIP331)
2025-11-10T00:08:56.5798664Z      pub fn supports_package_relay(&self) -> bool {
2025-11-10T00:08:56.5798848Z          (self.services & NODE_PACKAGE_RELAY) != 0
2025-11-10T00:08:56.5799321Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol.rs:163:
2025-11-10T00:08:56.5799425Z      }
2025-11-10T00:08:56.5799522Z -    
2025-11-10T00:08:56.5799626Z +
2025-11-10T00:08:56.5799763Z      /// Check if peer supports FIBRE
2025-11-10T00:08:56.5799909Z      pub fn supports_fibre(&self) -> bool {
2025-11-10T00:08:56.5800056Z          (self.services & NODE_FIBRE) != 0
2025-11-10T00:08:56.5800490Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol.rs:168:
2025-11-10T00:08:56.5800588Z      }
2025-11-10T00:08:56.5800686Z -    
2025-11-10T00:08:56.5800789Z +
2025-11-10T00:08:56.5800917Z      #[cfg(feature = "dandelion")]
2025-11-10T00:08:56.5801058Z      /// Check if peer supports Dandelion
2025-11-10T00:08:56.5801227Z      pub fn supports_dandelion(&self) -> bool {
2025-11-10T00:08:56.5801723Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol_extensions.rs:7:
2025-11-10T00:08:56.5802146Z  //! - FilteredBlock: Response with filtered transactions
2025-11-10T00:08:56.5802251Z  
2025-11-10T00:08:56.5802395Z  use crate::network::protocol::*;
2025-11-10T00:08:56.5802528Z -use crate::storage::Storage;
2025-11-10T00:08:56.5802682Z  use crate::network::txhash::calculate_txid;
2025-11-10T00:08:56.5802810Z +use crate::storage::Storage;
2025-11-10T00:08:56.5802924Z  use anyhow::Result;
2025-11-10T00:08:56.5803061Z  #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.5803341Z  use bllvm_protocol::utxo_commitments::merkle_tree::UtxoMerkleTree;
2025-11-10T00:08:56.5805860Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol_extensions.rs:41:
2025-11-10T00:08:56.5805992Z      // Get UTXO set from storage
2025-11-10T00:08:56.5806178Z      let utxo_set = storage.utxos().get_all_utxos()?;
2025-11-10T00:08:56.5806371Z      let utxo_count = utxo_set.len() as u64;
2025-11-10T00:08:56.5806647Z -    
2025-11-10T00:08:56.5806749Z +
2025-11-10T00:08:56.5806885Z      // Calculate total supply
2025-11-10T00:08:56.5807188Z      let total_supply: u64 = utxo_set.values().map(|utxo| utxo.value as u64).sum();
2025-11-10T00:08:56.5807284Z  
2025-11-10T00:08:56.5807801Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol_extensions.rs:49:
2025-11-10T00:08:56.5807944Z      #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.5808107Z      let mut utxo_tree = UtxoMerkleTree::new()
2025-11-10T00:08:56.5808401Z          .map_err(|e| anyhow::anyhow!("Failed to create UTXO Merkle tree: {:?}", e))?;
2025-11-10T00:08:56.5808506Z -    
2025-11-10T00:08:56.5808599Z +
2025-11-10T00:08:56.5808733Z      #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.5808874Z      for (outpoint, utxo) in &utxo_set {
2025-11-10T00:08:56.5809033Z -        utxo_tree.insert(*outpoint, utxo.clone())
2025-11-10T00:08:56.5809136Z +        utxo_tree
2025-11-10T00:08:56.5809303Z +            .insert(*outpoint, utxo.clone())
2025-11-10T00:08:56.5809635Z              .map_err(|e| anyhow::anyhow!("Failed to insert UTXO into tree: {:?}", e))?;
2025-11-10T00:08:56.5809741Z      }
2025-11-10T00:08:56.5809841Z  
2025-11-10T00:08:56.5810371Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol_extensions.rs:68:
2025-11-10T00:08:56.5810497Z      // Generate commitment
2025-11-10T00:08:56.5810641Z      #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.5810961Z      let commitment = utxo_tree.generate_commitment(block_hash, block_height);
2025-11-10T00:08:56.5811065Z -    
2025-11-10T00:08:56.5811163Z +
2025-11-10T00:08:56.5811321Z      #[cfg(not(feature = "utxo-commitments"))]
2025-11-10T00:08:56.5811577Z      let commitment = crate::network::protocol::UTXOCommitment {
2025-11-10T00:08:56.5811702Z          merkle_root: [0; 32],
2025-11-10T00:08:56.5812230Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol_extensions.rs:161:
2025-11-10T00:08:56.5812394Z      #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.5812805Z      let (filtered_txs, spam_summary_from_filter) = spam_filter.filter_block(&block.transactions);
2025-11-10T00:08:56.5812962Z      #[cfg(not(feature = "utxo-commitments"))]
2025-11-10T00:08:56.5815959Z -    let (filtered_txs, spam_summary_from_filter): (Vec<bllvm_protocol::Transaction>, crate::network::protocol::SpamSummary) = (block.transactions.clone(), crate::network::protocol::SpamSummary {
2025-11-10T00:08:56.5816101Z -        filtered_count: 0,
2025-11-10T00:08:56.5816225Z -        filtered_size: 0,
2025-11-10T00:08:56.5816446Z -        by_type: crate::network::protocol::SpamBreakdown {
2025-11-10T00:08:56.5816582Z -            ordinals: 0,
2025-11-10T00:08:56.5816711Z -            inscriptions: 0,
2025-11-10T00:08:56.5816820Z -            dust: 0,
2025-11-10T00:08:56.5816937Z -            brc20: 0,
2025-11-10T00:08:56.5817123Z +    let (filtered_txs, spam_summary_from_filter): (
2025-11-10T00:08:56.5817288Z +        Vec<bllvm_protocol::Transaction>,
2025-11-10T00:08:56.5817724Z +        crate::network::protocol::SpamSummary,
2025-11-10T00:08:56.5817834Z +    ) = (
2025-11-10T00:08:56.5817980Z +        block.transactions.clone(),
2025-11-10T00:08:56.5818146Z +        crate::network::protocol::SpamSummary {
2025-11-10T00:08:56.5818281Z +            filtered_count: 0,
2025-11-10T00:08:56.5818405Z +            filtered_size: 0,
2025-11-10T00:08:56.5818613Z +            by_type: crate::network::protocol::SpamBreakdown {
2025-11-10T00:08:56.5818741Z +                ordinals: 0,
2025-11-10T00:08:56.5818869Z +                inscriptions: 0,
2025-11-10T00:08:56.5818980Z +                dust: 0,
2025-11-10T00:08:56.5819093Z +                brc20: 0,
2025-11-10T00:08:56.5819202Z +            },
2025-11-10T00:08:56.5819304Z          },
2025-11-10T00:08:56.5819406Z -    });
2025-11-10T00:08:56.5819513Z -    
2025-11-10T00:08:56.5819616Z +    );
2025-11-10T00:08:56.5819776Z +
2025-11-10T00:08:56.5820121Z      // Convert spam summary to protocol types
2025-11-10T00:08:56.5820285Z      let spam_summary = SpamSummary {
2025-11-10T00:08:56.5820532Z          filtered_count: spam_summary_from_filter.filtered_count,
2025-11-10T00:08:56.5821116Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol_extensions.rs:186:
2025-11-10T00:08:56.5821234Z  
2025-11-10T00:08:56.5823255Z      // Generate transaction indices (positions of filtered transactions in original block)
2025-11-10T00:08:56.5823434Z      let mut transaction_indices = Vec::new();
2025-11-10T00:08:56.5823751Z -    let filtered_txids: std::collections::HashSet<_> = filtered_txs.iter()
2025-11-10T00:08:56.5823915Z -        .map(|tx| calculate_txid(tx))
2025-11-10T00:08:56.5824037Z -        .collect();
2025-11-10T00:08:56.5824246Z +    let filtered_txids: std::collections::HashSet<_> =
2025-11-10T00:08:56.5824692Z +        filtered_txs.iter().map(|tx| calculate_txid(tx)).collect();
2025-11-10T00:08:56.5824979Z      for (original_idx, tx) in block.transactions.iter().enumerate() {
2025-11-10T00:08:56.5825141Z          let txid = calculate_txid(tx);
2025-11-10T00:08:56.5825314Z          if filtered_txids.contains(&txid) {
2025-11-10T00:08:56.5825848Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol_extensions.rs:200:
2025-11-10T00:08:56.5826005Z      #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.5826175Z      let mut utxo_tree = UtxoMerkleTree::new()
2025-11-10T00:08:56.5826489Z          .map_err(|e| anyhow::anyhow!("Failed to create UTXO Merkle tree: {:?}", e))?;
2025-11-10T00:08:56.5826593Z -    
2025-11-10T00:08:56.5826698Z +
2025-11-10T00:08:56.5826864Z      #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.5827034Z      // Add outputs from filtered transactions
2025-11-10T00:08:56.5827176Z      for tx in &filtered_txs {
2025-11-10T00:08:56.5827757Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol_extensions.rs:227:
2025-11-10T00:08:56.5827941Z      // Generate commitment for filtered block
2025-11-10T00:08:56.5828108Z      #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.5828488Z      let commitment = utxo_tree.generate_commitment(message.block_hash, block_height);
2025-11-10T00:08:56.5828612Z -    
2025-11-10T00:08:56.5828721Z +
2025-11-10T00:08:56.5828892Z      #[cfg(not(feature = "utxo-commitments"))]
2025-11-10T00:08:56.5829175Z      let commitment = crate::network::protocol::UTXOCommitment {
2025-11-10T00:08:56.5829316Z          merkle_root: [0; 32],
2025-11-10T00:08:56.5829871Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/stratum_v2/pool.rs:191:
2025-11-10T00:08:56.5829989Z  
2025-11-10T00:08:56.5830124Z          // Store template
2025-11-10T00:08:56.5830302Z          self.current_template = Some(template);
2025-11-10T00:08:56.5830411Z -        
2025-11-10T00:08:56.5830528Z +
2025-11-10T00:08:56.5830659Z          (job_id, messages)
2025-11-10T00:08:56.5830769Z      }
2025-11-10T00:08:56.5830892Z  
2025-11-10T00:08:56.5831691Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/stratum_v2/pool.rs:463:
2025-11-10T00:08:56.5831942Z          if let Some(coinbase) = template.transactions.first() {
2025-11-10T00:08:56.5832112Z              // Serialize coinbase transaction
2025-11-10T00:08:56.5832384Z              let coinbase_bytes = self.serialize_transaction(coinbase);
2025-11-10T00:08:56.5832496Z -            
2025-11-10T00:08:56.5832610Z +
2025-11-10T00:08:56.5834830Z              // Extract merkle path from coinbase (index 0) to root
2025-11-10T00:08:56.5835096Z              let merkle_path = self.extract_merkle_path(template, 0);
2025-11-10T00:08:56.5835219Z -            
2025-11-10T00:08:56.5835325Z +
2025-11-10T00:08:56.5835672Z              // For Stratum V2, coinbase prefix is the full coinbase (miners can modify it)
2025-11-10T00:08:56.5835890Z              // Coinbase suffix is empty (not used in Stratum V2)
2025-11-10T00:08:56.5836495Z              (coinbase_bytes, vec![], merkle_path)
2025-11-10T00:08:56.5837739Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/stratum_v2/pool.rs:477:
2025-11-10T00:08:56.5837856Z  
2025-11-10T00:08:56.5838152Z      /// Extract merkle path from a specific transaction index to root
2025-11-10T00:08:56.5838499Z      fn extract_merkle_path(&self, block: &Block, tx_index: usize) -> Vec<Hash> {
2025-11-10T00:08:56.5838701Z -        use bllvm_protocol::mempool::calculate_tx_id;
2025-11-10T00:08:56.5838884Z          use crate::storage::hashing::double_sha256;
2025-11-10T00:08:56.5839067Z +        use bllvm_protocol::mempool::calculate_tx_id;
2025-11-10T00:08:56.5839182Z  
2025-11-10T00:08:56.5839527Z          if block.transactions.is_empty() || tx_index >= block.transactions.len() {
2025-11-10T00:08:56.5839656Z              return vec![];
2025-11-10T00:08:56.5840177Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/stratum_v2/pool.rs:485:
2025-11-10T00:08:56.5840298Z          }
2025-11-10T00:08:56.5840410Z  
2025-11-10T00:08:56.5840562Z          // Calculate all transaction hashes
2025-11-10T00:08:56.5840804Z -        let mut tx_hashes: Vec<Hash> = block.transactions.iter()
2025-11-10T00:08:56.5840959Z +        let mut tx_hashes: Vec<Hash> = block
2025-11-10T00:08:56.5841097Z +            .transactions
2025-11-10T00:08:56.5841215Z +            .iter()
2025-11-10T00:08:56.5841369Z              .map(|tx| calculate_tx_id(tx))
2025-11-10T00:08:56.5841499Z              .collect();
2025-11-10T00:08:56.5841602Z  
2025-11-10T00:08:56.5842135Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/stratum_v2/pool.rs:528:
2025-11-10T00:08:56.5842329Z                      combined.extend_from_slice(&chunk[0]);
2025-11-10T00:08:56.5842514Z                      let parent_hash = double_sha256(&combined);
2025-11-10T00:08:56.5842676Z                      next_level.push(parent_hash);
2025-11-10T00:08:56.5842793Z -                    
2025-11-10T00:08:56.5842918Z +
2025-11-10T00:08:56.5843219Z                      // If current_index is the last (odd) transaction, no sibling to add
2025-11-10T00:08:56.5843379Z                      let pair_start = pair_idx * 2;
2025-11-10T00:08:56.5843541Z                      if current_index == pair_start {
2025-11-10T00:08:56.5844084Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/stratum_v2/server.rs:214:
2025-11-10T00:08:56.5844470Z          // Get block template from MiningCoordinator
2025-11-10T00:08:56.5844612Z          let template = {
2025-11-10T00:08:56.5844881Z              let mut coordinator = self.mining_coordinator.write().await;
2025-11-10T00:08:56.5845078Z -            coordinator.generate_block_template().await
2025-11-10T00:08:56.5847699Z -                .map_err(|e| StratumV2Error::MiningJob(format!("Failed to generate block template: {}", e)))?
2025-11-10T00:08:56.5847989Z +            coordinator.generate_block_template().await.map_err(|e| {
2025-11-10T00:08:56.5848375Z +                StratumV2Error::MiningJob(format!("Failed to generate block template: {}", e))
2025-11-10T00:08:56.5848734Z +            })?
2025-11-10T00:08:56.5848846Z          };
2025-11-10T00:08:56.5848944Z  
2025-11-10T00:08:56.5849369Z -        debug!("Generated new block template with {} transactions", template.transactions.len());
2025-11-10T00:08:56.5849488Z +        debug!(
2025-11-10T00:08:56.5849722Z +            "Generated new block template with {} transactions",
2025-11-10T00:08:56.5849889Z +            template.transactions.len()
2025-11-10T00:08:56.5850004Z +        );
2025-11-10T00:08:56.5850115Z  
2025-11-10T00:08:56.5850334Z          // Set template in pool and get distribution messages
2025-11-10T00:08:56.5850473Z          let (job_id, messages) = {
2025-11-10T00:08:56.5851013Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/stratum_v2/server.rs:273:
2025-11-10T00:08:56.5851179Z          if let Some(ref mut conn) = *conn {
2025-11-10T00:08:56.5851903Z              // Use channel-specific sending - transports that support channels (QUIC/Iroh)
2025-11-10T00:08:56.5852336Z              // will route to the appropriate channel stream, others will use default send()
2025-11-10T00:08:56.5852618Z -            conn.send_on_channel(channel_id, &encoded).await.map_err(|e| {
2025-11-10T00:08:56.5852967Z -                StratumV2Error::Network(format!("Failed to send job message: {}", e))
2025-11-10T00:08:56.5853082Z -            })?;
2025-11-10T00:08:56.5853278Z +            conn.send_on_channel(channel_id, &encoded)
2025-11-10T00:08:56.5853398Z +                .await
2025-11-10T00:08:56.5853524Z +                .map_err(|e| {
2025-11-10T00:08:56.5853865Z +                    StratumV2Error::Network(format!("Failed to send job message: {}", e))
2025-11-10T00:08:56.5853981Z +                })?;
2025-11-10T00:08:56.5854097Z          } else {
2025-11-10T00:08:56.5856227Z              return Err(StratumV2Error::Connection(anyhow::anyhow!(
2025-11-10T00:08:56.5856412Z                  "Connection not available"
2025-11-10T00:08:56.5857493Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:101:
2025-11-10T00:08:56.5857621Z                  {
2025-11-10T00:08:56.5857840Z                      use crate::network::transport::TransportAddr;
2025-11-10T00:08:56.5857965Z                      use hex;
2025-11-10T00:08:56.5858083Z -                    
2025-11-10T00:08:56.5858190Z +
2025-11-10T00:08:56.5858457Z                      let node_id_hex = peer_id.strip_prefix("iroh:").ok_or_else(|| {
2025-11-10T00:08:56.5858937Z                          bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-10T00:08:56.5859155Z                              format!("Invalid Iroh peer_id format: {}", peer_id)
2025-11-10T00:08:56.5859740Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:108:
2025-11-10T00:08:56.5859863Z                          )
2025-11-10T00:08:56.5859985Z                      })?;
2025-11-10T00:08:56.5860096Z -                    
2025-11-10T00:08:56.5860204Z +
2025-11-10T00:08:56.5860477Z                      let node_id_bytes = hex::decode(node_id_hex).map_err(|e| {
2025-11-10T00:08:56.5860923Z                          bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-10T00:08:56.5861114Z                              format!("Invalid Iroh node ID hex: {}", e)
2025-11-10T00:08:56.5861669Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:114:
2025-11-10T00:08:56.5861780Z                          )
2025-11-10T00:08:56.5861895Z                      })?;
2025-11-10T00:08:56.5862012Z -                    
2025-11-10T00:08:56.5862120Z +
2025-11-10T00:08:56.5862367Z                      // Validate node ID length (Iroh uses 32-byte public keys)
2025-11-10T00:08:56.5862527Z                      if node_id_bytes.len() != 32 {
2025-11-10T00:08:56.5863076Z                          return Err(bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-10T00:08:56.5863919Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:120:
2025-11-10T00:08:56.5864458Z                              format!("Invalid Iroh node ID length: expected 32 bytes, got {}", node_id_bytes.len())
2025-11-10T00:08:56.5864599Z                          ));
2025-11-10T00:08:56.5864715Z                      }
2025-11-10T00:08:56.5864825Z -                    
2025-11-10T00:08:56.5864938Z +
2025-11-10T00:08:56.5865252Z                      // Create placeholder SocketAddr for Iroh (same approach as mod.rs)
2025-11-10T00:08:56.5865490Z                      // Use first 4 bytes of key for IP, last 2 bytes for port
2025-11-10T00:08:56.5865859Z -                    let ip_bytes = [node_id_bytes[0], node_id_bytes[1], node_id_bytes[2], node_id_bytes[3]];
2025-11-10T00:08:56.5866217Z +                    let ip_bytes = [
2025-11-10T00:08:56.5866367Z +                        node_id_bytes[0],
2025-11-10T00:08:56.5866508Z +                        node_id_bytes[1],
2025-11-10T00:08:56.5866651Z +                        node_id_bytes[2],
2025-11-10T00:08:56.5866793Z +                        node_id_bytes[3],
2025-11-10T00:08:56.5866905Z +                    ];
2025-11-10T00:08:56.5867209Z                      let port = u16::from_be_bytes([node_id_bytes[30], node_id_bytes[31]]);
2025-11-10T00:08:56.5867535Z                      let placeholder_addr = std::net::SocketAddr::from((ip_bytes, port));
2025-11-10T00:08:56.5867649Z -                    
2025-11-10T00:08:56.5867762Z +
2025-11-10T00:08:56.5868019Z                      let transport_addr = TransportAddr::Iroh(node_id_bytes);
2025-11-10T00:08:56.5868224Z                      Some((placeholder_addr, Some(transport_addr)))
2025-11-10T00:08:56.5868337Z                  }
2025-11-10T00:08:56.5868924Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:148:
2025-11-10T00:08:56.5869057Z                      ));
2025-11-10T00:08:56.5869169Z                  }
2025-11-10T00:08:56.5869288Z              };
2025-11-10T00:08:56.5869398Z -            
2025-11-10T00:08:56.5869505Z +
2025-11-10T00:08:56.5869683Z              // Store TransportAddr mapping if Iroh
2025-11-10T00:08:56.5869897Z              if let Some(transport_addr) = transport_addr_opt {
2025-11-10T00:08:56.5870091Z                  let network = network_manager.read().await;
2025-11-10T00:08:56.5870661Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:155:
2025-11-10T00:08:56.5870923Z                  // Store mapping from placeholder SocketAddr to TransportAddr
2025-11-10T00:08:56.5871308Z -                network.socket_to_transport.lock().unwrap().insert(peer_addr, transport_addr);
2025-11-10T00:08:56.5871435Z +                network
2025-11-10T00:08:56.5871590Z +                    .socket_to_transport
2025-11-10T00:08:56.5871713Z +                    .lock()
2025-11-10T00:08:56.5871827Z +                    .unwrap()
2025-11-10T00:08:56.5871989Z +                    .insert(peer_addr, transport_addr);
2025-11-10T00:08:56.5872116Z                  drop(network);
2025-11-10T00:08:56.5872217Z              }
2025-11-10T00:08:56.5872316Z  
2025-11-10T00:08:56.5873148Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:160:
2025-11-10T00:08:56.5873427Z              // Check if peer supports UTXO commitments before sending request
2025-11-10T00:08:56.5873611Z              let network = network_manager.read().await;
2025-11-10T00:08:56.5873728Z -            
2025-11-10T00:08:56.5873831Z +
2025-11-10T00:08:56.5873994Z              // Get peer version to check capabilities
2025-11-10T00:08:56.5874159Z              let peer_supports_utxo_commitments = {
2025-11-10T00:08:56.5874535Z                  let peer_states = network.peer_states.lock().unwrap();
2025-11-10T00:08:56.5875390Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:178:
2025-11-10T00:08:56.5875520Z                      false
2025-11-10T00:08:56.5875639Z                  }
2025-11-10T00:08:56.5875748Z              };
2025-11-10T00:08:56.5875859Z -            
2025-11-10T00:08:56.5875967Z +
2025-11-10T00:08:56.5876299Z              // If we know the peer doesn't support UTXO commitments, return error early
2025-11-10T00:08:56.5876474Z              if !peer_supports_utxo_commitments {
2025-11-10T00:08:56.5876603Z                  drop(network);
2025-11-10T00:08:56.5877208Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:186:
2025-11-10T00:08:56.5877717Z                      format!("Peer {} does not support UTXO commitments (missing NODE_UTXO_COMMITMENTS service flag)", peer_id)
2025-11-10T00:08:56.5877833Z                  ));
2025-11-10T00:08:56.5878176Z              }
2025-11-10T00:08:56.5878292Z -            
2025-11-10T00:08:56.5878398Z +
2025-11-10T00:08:56.5878582Z              // Register pending request before sending
2025-11-10T00:08:56.5878899Z              let (request_id, response_rx) = network.register_request(peer_addr);
2025-11-10T00:08:56.5879126Z              drop(network); // Release read lock before async wait
2025-11-10T00:08:56.5879729Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:193:
2025-11-10T00:08:56.5879849Z -            
2025-11-10T00:08:56.5879955Z +
2025-11-10T00:08:56.5880147Z              // Create GetUTXOSet message with request_id
2025-11-10T00:08:56.5880343Z -            let get_utxo_set_msg = GetUTXOSetMessage { 
2025-11-10T00:08:56.5880532Z +            let get_utxo_set_msg = GetUTXOSetMessage {
2025-11-10T00:08:56.5880659Z                  request_id,
2025-11-10T00:08:56.5880783Z -                height, 
2025-11-10T00:08:56.5880915Z -                block_hash 
2025-11-10T00:08:56.5881044Z +                height,
2025-11-10T00:08:56.5881163Z +                block_hash,
2025-11-10T00:08:56.5881283Z              };
2025-11-10T00:08:56.5881388Z  
2025-11-10T00:08:56.5881724Z              // Serialize message using protocol adapter (handles TCP vs Iroh format)
2025-11-10T00:08:56.5882316Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:203:
2025-11-10T00:08:56.5882925Z                  .map_err(|e| bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-10T00:08:56.5883131Z                      format!("Failed to serialize GetUTXOSet: {}", e)
2025-11-10T00:08:56.5883236Z                  ))?;
2025-11-10T00:08:56.5883341Z -            
2025-11-10T00:08:56.5883443Z +
2025-11-10T00:08:56.5883623Z              // Send message to peer via NetworkManager
2025-11-10T00:08:56.5883743Z              {
2025-11-10T00:08:56.5883932Z                  let network = network_manager.read().await;
2025-11-10T00:08:56.5884764Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:212:
2025-11-10T00:08:56.5885063Z                          format!("Failed to send GetUTXOSet to peer {}: {}", peer_addr, e)
2025-11-10T00:08:56.5885198Z                      ))?;
2025-11-10T00:08:56.5885309Z              }
2025-11-10T00:08:56.5885419Z -            
2025-11-10T00:08:56.5885536Z +
2025-11-10T00:08:56.5885714Z              // Await response with timeout (30 seconds)
2025-11-10T00:08:56.5885854Z              tokio::select! {
2025-11-10T00:08:56.5886008Z                  result = response_rx => {
2025-11-10T00:08:56.5886596Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:224:
2025-11-10T00:08:56.5887134Z                                  .map_err(|e| bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-10T00:08:56.5887379Z                                      format!("Failed to parse UTXOSet response: {}", e)
2025-11-10T00:08:56.5887922Z                                  ))?;
2025-11-10T00:08:56.5888045Z -                            
2025-11-10T00:08:56.5888150Z +
2025-11-10T00:08:56.5888292Z                              match parsed {
2025-11-10T00:08:56.5888502Z                                  ProtocolMessage::UTXOSet(utxo_set_msg) => {
2025-11-10T00:08:56.5888676Z                                      // Convert to UtxoCommitment
2025-11-10T00:08:56.5889277Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:291:
2025-11-10T00:08:56.5889396Z                  {
2025-11-10T00:08:56.5889610Z                      use crate::network::transport::TransportAddr;
2025-11-10T00:08:56.5889734Z                      use hex;
2025-11-10T00:08:56.5889856Z -                    
2025-11-10T00:08:56.5889960Z +
2025-11-10T00:08:56.5890232Z                      let node_id_hex = peer_id.strip_prefix("iroh:").ok_or_else(|| {
2025-11-10T00:08:56.5890943Z                          bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-10T00:08:56.5891167Z                              format!("Invalid Iroh peer_id format: {}", peer_id)
2025-11-10T00:08:56.5891757Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:298:
2025-11-10T00:08:56.5891886Z                          )
2025-11-10T00:08:56.5892001Z                      })?;
2025-11-10T00:08:56.5892113Z -                    
2025-11-10T00:08:56.5892219Z +
2025-11-10T00:08:56.5892484Z                      let node_id_bytes = hex::decode(node_id_hex).map_err(|e| {
2025-11-10T00:08:56.5892953Z                          bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-10T00:08:56.5893130Z                              format!("Invalid Iroh node ID hex: {}", e)
2025-11-10T00:08:56.5893702Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:304:
2025-11-10T00:08:56.5893826Z                          )
2025-11-10T00:08:56.5893933Z                      })?;
2025-11-10T00:08:56.5894045Z -                    
2025-11-10T00:08:56.5894145Z +
2025-11-10T00:08:56.5894601Z                      // Validate node ID length (Iroh uses 32-byte public keys)
2025-11-10T00:08:56.5894760Z                      if node_id_bytes.len() != 32 {
2025-11-10T00:08:56.5895282Z                          return Err(bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-10T00:08:56.5895847Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:310:
2025-11-10T00:08:56.5896220Z                              format!("Invalid Iroh node ID length: expected 32 bytes, got {}", node_id_bytes.len())
2025-11-10T00:08:56.5896351Z                          ));
2025-11-10T00:08:56.5896466Z                      }
2025-11-10T00:08:56.5896576Z -                    
2025-11-10T00:08:56.5896681Z +
2025-11-10T00:08:56.5896978Z                      // Create placeholder SocketAddr for Iroh (same approach as mod.rs)
2025-11-10T00:08:56.5897194Z                      // Use first 4 bytes of key for IP, last 2 bytes for port
2025-11-10T00:08:56.5897543Z -                    let ip_bytes = [node_id_bytes[0], node_id_bytes[1], node_id_bytes[2], node_id_bytes[3]];
2025-11-10T00:08:56.5897671Z +                    let ip_bytes = [
2025-11-10T00:08:56.5897803Z +                        node_id_bytes[0],
2025-11-10T00:08:56.5897931Z +                        node_id_bytes[1],
2025-11-10T00:08:56.5898066Z +                        node_id_bytes[2],
2025-11-10T00:08:56.5898197Z +                        node_id_bytes[3],
2025-11-10T00:08:56.5898312Z +                    ];
2025-11-10T00:08:56.5898605Z                      let port = u16::from_be_bytes([node_id_bytes[30], node_id_bytes[31]]);
2025-11-10T00:08:56.5898914Z                      let placeholder_addr = std::net::SocketAddr::from((ip_bytes, port));
2025-11-10T00:08:56.5899242Z -                    
2025-11-10T00:08:56.5899350Z +
2025-11-10T00:08:56.5899588Z                      let transport_addr = TransportAddr::Iroh(node_id_bytes);
2025-11-10T00:08:56.5899778Z                      Some((placeholder_addr, Some(transport_addr)))
2025-11-10T00:08:56.5899884Z                  }
2025-11-10T00:08:56.5900450Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:338:
2025-11-10T00:08:56.5900563Z                      ));
2025-11-10T00:08:56.5900668Z                  }
2025-11-10T00:08:56.5900787Z              };
2025-11-10T00:08:56.5900897Z -            
2025-11-10T00:08:56.5900998Z +
2025-11-10T00:08:56.5901169Z              // Store TransportAddr mapping if Iroh
2025-11-10T00:08:56.5901386Z              if let Some(transport_addr) = transport_addr_opt {
2025-11-10T00:08:56.5901571Z                  let network = network_manager.read().await;
2025-11-10T00:08:56.5902326Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:345:
2025-11-10T00:08:56.5902604Z                  // Store mapping from placeholder SocketAddr to TransportAddr
2025-11-10T00:08:56.5902985Z -                network.socket_to_transport.lock().unwrap().insert(peer_addr, transport_addr);
2025-11-10T00:08:56.5903105Z +                network
2025-11-10T00:08:56.5903253Z +                    .socket_to_transport
2025-11-10T00:08:56.5903374Z +                    .lock()
2025-11-10T00:08:56.5903497Z +                    .unwrap()
2025-11-10T00:08:56.5903665Z +                    .insert(peer_addr, transport_addr);
2025-11-10T00:08:56.5903803Z                  drop(network);
2025-11-10T00:08:56.5903913Z              }
2025-11-10T00:08:56.5904018Z  
2025-11-10T00:08:56.5904770Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:351:
2025-11-10T00:08:56.5904958Z              let network = network_manager.read().await;
2025-11-10T00:08:56.5905261Z              let (request_id, response_rx) = network.register_request(peer_addr);
2025-11-10T00:08:56.5905491Z              drop(network); // Release read lock before async wait
2025-11-10T00:08:56.5905600Z -            
2025-11-10T00:08:56.5905704Z +
2025-11-10T00:08:56.5905909Z              // Create GetFilteredBlock message with request_id
2025-11-10T00:08:56.5906133Z              use crate::network::protocol::FilterPreferences;
2025-11-10T00:08:56.5906368Z              let get_filtered_block_msg = GetFilteredBlockMessage {
2025-11-10T00:08:56.5906920Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:371:
2025-11-10T00:08:56.5907416Z                  .map_err(|e| bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-10T00:08:56.5907660Z                      format!("Failed to serialize GetFilteredBlock: {}", e)
2025-11-10T00:08:56.5907783Z                  ))?;
2025-11-10T00:08:56.5907912Z -            
2025-11-10T00:08:56.5908021Z +
2025-11-10T00:08:56.5908202Z              // Send message to peer via NetworkManager
2025-11-10T00:08:56.5908313Z              {
2025-11-10T00:08:56.5908513Z                  let network = network_manager.read().await;
2025-11-10T00:08:56.5909102Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:380:
2025-11-10T00:08:56.5909426Z                          format!("Failed to send GetFilteredBlock to peer {}: {}", peer_addr, e)
2025-11-10T00:08:56.5909556Z                      ))?;
2025-11-10T00:08:56.5909666Z              }
2025-11-10T00:08:56.5909774Z -            
2025-11-10T00:08:56.5909895Z +
2025-11-10T00:08:56.5910070Z              // Await response with timeout (30 seconds)
2025-11-10T00:08:56.5910204Z              tokio::select! {
2025-11-10T00:08:56.5910351Z                  result = response_rx => {
2025-11-10T00:08:56.5910939Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:392:
2025-11-10T00:08:56.5911710Z                                  .map_err(|e| bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-10T00:08:56.5911982Z                                      format!("Failed to parse FilteredBlock response: {}", e)
2025-11-10T00:08:56.5912115Z                                  ))?;
2025-11-10T00:08:56.5912232Z -                            
2025-11-10T00:08:56.5912336Z +
2025-11-10T00:08:56.5912492Z                              match parsed {
2025-11-10T00:08:56.5912773Z                                  ProtocolMessage::FilteredBlock(filtered_block_msg) => {
2025-11-10T00:08:56.5912939Z                                      // Convert to FilteredBlock
2025-11-10T00:08:56.5913496Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/health.rs:144:
2025-11-10T00:08:56.5913642Z          // Determine overall status
2025-11-10T00:08:56.5914250Z          let overall_status = if components.iter().any(|c| c.status == HealthStatus::Down) {
2025-11-10T00:08:56.5914648Z              HealthStatus::Down
2025-11-10T00:08:56.5915006Z -        } else if components.iter().any(|c| c.status == HealthStatus::Unhealthy) {
2025-11-10T00:08:56.5915143Z +        } else if components
2025-11-10T00:08:56.5915259Z +            .iter()
2025-11-10T00:08:56.5915462Z +            .any(|c| c.status == HealthStatus::Unhealthy)
2025-11-10T00:08:56.5915574Z +        {
2025-11-10T00:08:56.5915719Z              HealthStatus::Unhealthy
2025-11-10T00:08:56.5916049Z -        } else if components.iter().any(|c| c.status == HealthStatus::Degraded) {
2025-11-10T00:08:56.5916182Z +        } else if components
2025-11-10T00:08:56.5916299Z +            .iter()
2025-11-10T00:08:56.5916487Z +            .any(|c| c.status == HealthStatus::Degraded)
2025-11-10T00:08:56.5916604Z +        {
2025-11-10T00:08:56.5916750Z              HealthStatus::Degraded
2025-11-10T00:08:56.5916873Z          } else {
2025-11-10T00:08:56.5917021Z              HealthStatus::Healthy
2025-11-10T00:08:56.5917453Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/health.rs:180:
2025-11-10T00:08:56.5917568Z          Self::new()
2025-11-10T00:08:56.5917668Z      }
2025-11-10T00:08:56.5917777Z  }
2025-11-10T00:08:56.5917877Z -
2025-11-10T00:08:56.5917975Z  
2025-11-10T00:08:56.5918409Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:1:
2025-11-10T00:08:56.5918530Z  //! Mempool manager
2025-11-10T00:08:56.5918634Z -//! 
2025-11-10T00:08:56.5918734Z +//!
2025-11-10T00:08:56.5919025Z  //! Handles transaction mempool management, validation, and relay.
2025-11-10T00:08:56.5919126Z  
2025-11-10T00:08:56.5919246Z  use anyhow::Result;
2025-11-10T00:08:56.5919664Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:6:
2025-11-10T00:08:56.5919907Z -use bllvm_protocol::{Transaction, UtxoSet, Hash, OutPoint};
2025-11-10T00:08:56.5920072Z  use bllvm_protocol::mempool::Mempool;
2025-11-10T00:08:56.5920310Z +use bllvm_protocol::{Hash, OutPoint, Transaction, UtxoSet};
2025-11-10T00:08:56.5920475Z  use std::collections::{HashMap, HashSet};
2025-11-10T00:08:56.5920607Z  use tracing::{debug, info};
2025-11-10T00:08:56.5920706Z  
2025-11-10T00:08:56.5921139Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:31:
2025-11-10T00:08:56.5921305Z              spent_outputs: HashSet::new(),
2025-11-10T00:08:56.5921415Z          }
2025-11-10T00:08:56.5921527Z      }
2025-11-10T00:08:56.5921628Z -    
2025-11-10T00:08:56.5921726Z +
2025-11-10T00:08:56.5921860Z      /// Start the mempool manager
2025-11-10T00:08:56.5922502Z      pub async fn start(&mut self) -> Result<()> {
2025-11-10T00:08:56.5922674Z          info!("Starting mempool manager");
2025-11-10T00:08:56.5923121Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:38:
2025-11-10T00:08:56.5923256Z -        
2025-11-10T00:08:56.5923620Z +
2025-11-10T00:08:56.5923764Z          // Initialize mempool
2025-11-10T00:08:56.5923917Z          self.initialize_mempool().await?;
2025-11-10T00:08:56.5924032Z -        
2025-11-10T00:08:56.5924141Z +
2025-11-10T00:08:56.5924479Z          // Start mempool processing loop
2025-11-10T00:08:56.5924645Z          self.process_loop().await?;
2025-11-10T00:08:56.5924756Z -        
2025-11-10T00:08:56.5924860Z +
2025-11-10T00:08:56.5924975Z          Ok(())
2025-11-10T00:08:56.5925090Z      }
2025-11-10T00:08:56.5925195Z -    
2025-11-10T00:08:56.5927245Z +
2025-11-10T00:08:56.5927427Z      /// Run mempool processing once (for testing)
2025-11-10T00:08:56.5927660Z      pub async fn process_once(&mut self) -> Result<()> {
2025-11-10T00:08:56.5927815Z          // Process pending transactions
2025-11-10T00:08:56.5928270Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:51:
2025-11-10T00:08:56.5928473Z          self.process_pending_transactions().await?;
2025-11-10T00:08:56.5928829Z -        
2025-11-10T00:08:56.5928938Z +
2025-11-10T00:08:56.5929097Z          // Clean up old transactions
2025-11-10T00:08:56.5929266Z          self.cleanup_old_transactions().await?;
2025-11-10T00:08:56.5929381Z -        
2025-11-10T00:08:56.5929488Z +
2025-11-10T00:08:56.5929604Z          Ok(())
2025-11-10T00:08:56.5929714Z      }
2025-11-10T00:08:56.5929825Z -    
2025-11-10T00:08:56.5929929Z +
2025-11-10T00:08:56.5930069Z      /// Initialize mempool
2025-11-10T00:08:56.5930299Z      async fn initialize_mempool(&mut self) -> Result<()> {
2025-11-10T00:08:56.5930454Z          debug!("Initializing mempool");
2025-11-10T00:08:56.5930915Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:62:
2025-11-10T00:08:56.5931029Z -        
2025-11-10T00:08:56.5931137Z +
2025-11-10T00:08:56.5931344Z          // Load existing mempool from storage if available
2025-11-10T00:08:56.5931603Z          // In a real implementation, this would restore mempool state
2025-11-10T00:08:56.5931722Z -        
2025-11-10T00:08:56.5931830Z +
2025-11-10T00:08:56.5931957Z          Ok(())
2025-11-10T00:08:56.5932068Z      }
2025-11-10T00:08:56.5932174Z -    
2025-11-10T00:08:56.5932280Z +
2025-11-10T00:08:56.5932439Z      /// Main mempool processing loop
2025-11-10T00:08:56.5932638Z      async fn process_loop(&mut self) -> Result<()> {
2025-11-10T00:08:56.5932756Z          loop {
2025-11-10T00:08:56.5933681Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:72:
2025-11-10T00:08:56.5933862Z              // Process pending transactions
2025-11-10T00:08:56.5934063Z              self.process_pending_transactions().await?;
2025-11-10T00:08:56.5934176Z -            
2025-11-10T00:08:56.5934460Z +
2025-11-10T00:08:56.5934618Z              // Clean up old transactions
2025-11-10T00:08:56.5934792Z              self.cleanup_old_transactions().await?;
2025-11-10T00:08:56.5934913Z -            
2025-11-10T00:08:56.5935034Z +
2025-11-10T00:08:56.5935209Z              // Small delay to prevent busy waiting
2025-11-10T00:08:56.5935515Z              tokio::time::sleep(tokio::time::Duration::from_millis(100)).await;
2025-11-10T00:08:56.5935627Z          }
2025-11-10T00:08:56.5936090Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:81:
2025-11-10T00:08:56.5936199Z      }
2025-11-10T00:08:56.5936319Z -    
2025-11-10T00:08:56.5936428Z +
2025-11-10T00:08:56.5936589Z      /// Process pending transactions
2025-11-10T00:08:56.5936885Z      async fn process_pending_transactions(&mut self) -> Result<()> {
2025-11-10T00:08:56.5937059Z          // In a real implementation, this would:
2025-11-10T00:08:56.5939037Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:87:
2025-11-10T00:08:56.5939236Z          // 2. Validate transactions using consensus-proof
2025-11-10T00:08:56.5939409Z          // 3. Add valid transactions to mempool
2025-11-10T00:08:56.5939573Z          // 4. Relay transactions to peers
2025-11-10T00:08:56.5939979Z -        
2025-11-10T00:08:56.5940099Z +
2025-11-10T00:08:56.5940287Z          debug!("Processing pending transactions");
2025-11-10T00:08:56.5940399Z          Ok(())
2025-11-10T00:08:56.5940507Z      }
2025-11-10T00:08:56.5941079Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:94:
2025-11-10T00:08:56.5941197Z -    
2025-11-10T00:08:56.5941305Z +
2025-11-10T00:08:56.5941457Z      /// Clean up old transactions
2025-11-10T00:08:56.5941716Z      async fn cleanup_old_transactions(&mut self) -> Result<()> {
2025-11-10T00:08:56.5941886Z          // In a real implementation, this would:
2025-11-10T00:08:56.5942330Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:98:
2025-11-10T00:08:56.5942515Z          // 1. Remove transactions that are too old
2025-11-10T00:08:56.5942732Z          // 2. Remove transactions that conflict with new blocks
2025-11-10T00:08:56.5943129Z          // 3. Update transaction priorities
2025-11-10T00:08:56.5943251Z -        
2025-11-10T00:08:56.5943354Z +
2025-11-10T00:08:56.5943522Z          debug!("Cleaning up old transactions");
2025-11-10T00:08:56.5943640Z          Ok(())
2025-11-10T00:08:56.5943745Z      }
2025-11-10T00:08:56.5944203Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:105:
2025-11-10T00:08:56.5944479Z -    
2025-11-10T00:08:56.5944597Z +
2025-11-10T00:08:56.5946698Z      /// Add transaction to mempool
2025-11-10T00:08:56.5947031Z      pub async fn add_transaction(&mut self, tx: Transaction) -> Result<bool> {
2025-11-10T00:08:56.5947207Z          debug!("Adding transaction to mempool");
2025-11-10T00:08:56.5947661Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:109:
2025-11-10T00:08:56.5947768Z -        
2025-11-10T00:08:56.5947871Z +
2025-11-10T00:08:56.5948116Z          // Check for conflicts with existing mempool transactions
2025-11-10T00:08:56.5948264Z          for input in &tx.inputs {
2025-11-10T00:08:56.5948486Z              if self.spent_outputs.contains(&input.prevout) {
2025-11-10T00:08:56.5948926Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:114:
2025-11-10T00:08:56.5949046Z                  return Ok(false);
2025-11-10T00:08:56.5949150Z              }
2025-11-10T00:08:56.5949265Z          }
2025-11-10T00:08:56.5949367Z -        
2025-11-10T00:08:56.5949461Z +
2025-11-10T00:08:56.5949668Z          // Add transaction to mempool (store full transaction)
2025-11-10T00:08:56.5949880Z          use bllvm_protocol::mempool::calculate_tx_id;
2025-11-10T00:08:56.5950037Z          let tx_hash = calculate_tx_id(&tx);
2025-11-10T00:08:56.5950481Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:121:
2025-11-10T00:08:56.5950689Z          self.transactions.insert(tx_hash, tx.clone());
2025-11-10T00:08:56.5950844Z          self.mempool.insert(tx_hash);
2025-11-10T00:08:56.5950957Z -        
2025-11-10T00:08:56.5951069Z +
2025-11-10T00:08:56.5951208Z          // Track spent outputs
2025-11-10T00:08:56.5951342Z          for input in &tx.inputs {
2025-11-10T00:08:56.5951565Z              self.spent_outputs.insert(input.prevout.clone());
2025-11-10T00:08:56.5952018Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:127:
2025-11-10T00:08:56.5952132Z          }
2025-11-10T00:08:56.5952233Z -        
2025-11-10T00:08:56.5952334Z +
2025-11-10T00:08:56.5952455Z          Ok(true)
2025-11-10T00:08:56.5952565Z      }
2025-11-10T00:08:56.5952673Z -    
2025-11-10T00:08:56.5952782Z +
2025-11-10T00:08:56.5952908Z      /// Get mempool size
2025-11-10T00:08:56.5953055Z      pub fn size(&self) -> usize {
2025-11-10T00:08:56.5953197Z          self.transactions.len()
2025-11-10T00:08:56.5953650Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:135:
2025-11-10T00:08:56.5953758Z      }
2025-11-10T00:08:56.5953867Z -    
2025-11-10T00:08:56.5953978Z +
2025-11-10T00:08:56.5954552Z      /// Get mempool transaction hashes
2025-11-10T00:08:56.5954760Z      pub fn transaction_hashes(&self) -> Vec<Hash> {
2025-11-10T00:08:56.5954948Z          self.transactions.keys().cloned().collect()
2025-11-10T00:08:56.5955371Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:140:
2025-11-10T00:08:56.5955468Z      }
2025-11-10T00:08:56.5955572Z -    
2025-11-10T00:08:56.5955684Z +
2025-11-10T00:08:56.5957459Z      /// Get transaction by hash
2025-11-10T00:08:56.5957749Z      pub fn get_transaction(&self, hash: &Hash) -> Option<Transaction> {
2025-11-10T00:08:56.5957904Z          self.transactions.get(hash).cloned()
2025-11-10T00:08:56.5958343Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:145:
2025-11-10T00:08:56.5958442Z      }
2025-11-10T00:08:56.5958537Z -    
2025-11-10T00:08:56.5958638Z +
2025-11-10T00:08:56.5958773Z      /// Get all transactions
2025-11-10T00:08:56.5959237Z      pub fn get_transactions(&self) -> Vec<Transaction> {
2025-11-10T00:08:56.5959860Z          self.transactions.values().cloned().collect()
2025-11-10T00:08:56.5960332Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:150:
2025-11-10T00:08:56.5960447Z      }
2025-11-10T00:08:56.5960552Z -    
2025-11-10T00:08:56.5960666Z +
2025-11-10T00:08:56.5960851Z      /// Get prioritized transactions by fee rate
2025-11-10T00:08:56.5960960Z -    /// 
2025-11-10T00:08:56.5961069Z +    ///
2025-11-10T00:08:56.5961457Z      /// Returns transactions sorted by fee rate (satoshis per vbyte) in descending order.
2025-11-10T00:08:56.5961624Z      /// Requires UTXO set to calculate fee rates.
2025-11-10T00:08:56.5962090Z -    pub fn get_prioritized_transactions(&self, limit: usize, utxo_set: &UtxoSet) -> Vec<Transaction> {
2025-11-10T00:08:56.5962271Z +    pub fn get_prioritized_transactions(
2025-11-10T00:08:56.5962388Z +        &self,
2025-11-10T00:08:56.5962525Z +        limit: usize,
2025-11-10T00:08:56.5962668Z +        utxo_set: &UtxoSet,
2025-11-10T00:08:56.5962799Z +    ) -> Vec<Transaction> {
2025-11-10T00:08:56.5963050Z          let mut tx_with_fees: Vec<(Transaction, u64)> = Vec::new();
2025-11-10T00:08:56.5963165Z -        
2025-11-10T00:08:56.5963280Z +
2025-11-10T00:08:56.5963459Z          for tx in self.transactions.values() {
2025-11-10T00:08:56.5963623Z              // Calculate fee for this transaction
2025-11-10T00:08:56.5963866Z              let fee = self.calculate_transaction_fee(tx, utxo_set);
2025-11-10T00:08:56.5964586Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:162:
2025-11-10T00:08:56.5964730Z -            
2025-11-10T00:08:56.5964836Z +
2025-11-10T00:08:56.5965193Z              // Calculate transaction size (simplified - use serialized size estimate)
2025-11-10T00:08:56.5965402Z              let size = self.estimate_transaction_size(tx);
2025-11-10T00:08:56.5965512Z -            
2025-11-10T00:08:56.5965628Z +
2025-11-10T00:08:56.5965822Z              // Calculate fee rate (satoshis per vbyte)
2025-11-10T00:08:56.5973214Z              let fee_rate = if size > 0 {
2025-11-10T00:08:56.5973678Z                  fee * 1000 / size as u64 // Convert to satoshis per vbyte (multiply by 1000 for precision)
2025-11-10T00:08:56.5974168Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:169:
2025-11-10T00:08:56.5974539Z              } else {
2025-11-10T00:08:56.5974666Z                  0
2025-11-10T00:08:56.5974784Z              };
2025-11-10T00:08:56.5974907Z -            
2025-11-10T00:08:56.5975012Z +
2025-11-10T00:08:56.5975207Z              tx_with_fees.push((tx.clone(), fee_rate));
2025-11-10T00:08:56.5975327Z          }
2025-11-10T00:08:56.5975439Z -        
2025-11-10T00:08:56.5975544Z +
2025-11-10T00:08:56.5975699Z          // Sort by fee rate (descending)
2025-11-10T00:08:56.5975893Z          tx_with_fees.sort_by(|a, b| b.1.cmp(&a.1));
2025-11-10T00:08:56.5976021Z -        
2025-11-10T00:08:56.5976384Z +
2025-11-10T00:08:56.5976553Z          // Return top N transactions
2025-11-10T00:08:56.5976698Z -        tx_with_fees.into_iter()
2025-11-10T00:08:56.5976823Z +        tx_with_fees
2025-11-10T00:08:56.5976951Z +            .into_iter()
2025-11-10T00:08:56.5977080Z              .take(limit)
2025-11-10T00:08:56.5977215Z              .map(|(tx, _)| tx)
2025-11-10T00:08:56.5977339Z              .collect()
2025-11-10T00:08:56.5977835Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:184:
2025-11-10T00:08:56.5977952Z      }
2025-11-10T00:08:56.5978063Z -    
2025-11-10T00:08:56.5978170Z +
2025-11-10T00:08:56.5978328Z      /// Calculate transaction fee
2025-11-10T00:08:56.5978441Z -    /// 
2025-11-10T00:08:56.5978553Z +    ///
2025-11-10T00:08:56.5978721Z      /// Fee = sum of inputs - sum of outputs
2025-11-10T00:08:56.5979140Z      pub fn calculate_transaction_fee(&self, tx: &Transaction, utxo_set: &UtxoSet) -> u64 {
2025-11-10T00:08:56.5979527Z          let mut input_total = 0u64;
2025-11-10T00:08:56.5980004Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:191:
2025-11-10T00:08:56.5980128Z -        
2025-11-10T00:08:56.5980237Z +
2025-11-10T00:08:56.5980393Z          // Sum input values from UTXO set
2025-11-10T00:08:56.5980545Z          for input in &tx.inputs {
2025-11-10T00:08:56.5980760Z              if let Some(utxo) = utxo_set.get(&input.prevout) {
2025-11-10T00:08:56.5981221Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:195:
2025-11-10T00:08:56.5983218Z                  input_total += utxo.value as u64;
2025-11-10T00:08:56.5983343Z              }
2025-11-10T00:08:56.5983451Z          }
2025-11-10T00:08:56.5983559Z -        
2025-11-10T00:08:56.5983674Z +
2025-11-10T00:08:56.5983809Z          // Sum output values
2025-11-10T00:08:56.5984145Z          let output_total: u64 = tx.outputs.iter().map(|out| out.value as u64).sum();
2025-11-10T00:08:56.5984267Z -        
2025-11-10T00:08:56.5984572Z +
2025-11-10T00:08:56.5984754Z          // Fee is difference (inputs - outputs)
2025-11-10T00:08:56.5984911Z          if input_total > output_total {
2025-11-10T00:08:56.5985074Z              input_total - output_total
2025-11-10T00:08:56.5985535Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:206:
2025-11-10T00:08:56.5985651Z              0
2025-11-10T00:08:56.5985762Z          }
2025-11-10T00:08:56.5985882Z      }
2025-11-10T00:08:56.5985990Z -    
2025-11-10T00:08:56.5986098Z +
2025-11-10T00:08:56.5986274Z      /// Estimate transaction size in vbytes
2025-11-10T00:08:56.5986387Z -    /// 
2025-11-10T00:08:56.5986497Z +    ///
2025-11-10T00:08:56.5986849Z      /// Simplified estimation - in production, would use actual serialized size
2025-11-10T00:08:56.5987152Z      fn estimate_transaction_size(&self, tx: &Transaction) -> usize {
2025-11-10T00:08:56.5987417Z          // Base transaction size: version (4) + locktime (4) = 8 bytes
2025-11-10T00:08:56.5987898Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:215:
2025-11-10T00:08:56.5988041Z          let mut size = 8;
2025-11-10T00:08:56.5988153Z -        
2025-11-10T00:08:56.5988258Z +
2025-11-10T00:08:56.5988519Z          // Input size: prevout (36) + script_sig (var) + sequence (4)
2025-11-10T00:08:56.5988666Z          for input in &tx.inputs {
2025-11-10T00:08:56.5988801Z              size += 36; // prevout
2025-11-10T00:08:56.5989253Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:220:
2025-11-10T00:08:56.5989424Z              size += input.script_sig.len();
2025-11-10T00:08:56.5989553Z              size += 4; // sequence
2025-11-10T00:08:56.5989661Z          }
2025-11-10T00:08:56.5989776Z -        
2025-11-10T00:08:56.5989882Z +
2025-11-10T00:08:56.5990072Z          // Output size: value (8) + script_pubkey (var)
2025-11-10T00:08:56.5990217Z          for output in &tx.outputs {
2025-11-10T00:08:56.5990367Z              size += 8; // value
2025-11-10T00:08:56.5991095Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:227:
2025-11-10T00:08:56.5991273Z              size += output.script_pubkey.len();
2025-11-10T00:08:56.5991393Z          }
2025-11-10T00:08:56.5991500Z -        
2025-11-10T00:08:56.5991606Z +
2025-11-10T00:08:56.5991938Z          // Add witness discount if segwit (simplified - assume no witness for now)
2025-11-10T00:08:56.5992068Z          size
2025-11-10T00:08:56.5992176Z      }
2025-11-10T00:08:56.5992640Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:233:
2025-11-10T00:08:56.5992755Z -    
2025-11-10T00:08:56.5992860Z +
2025-11-10T00:08:56.5993016Z      /// Remove transaction from mempool
2025-11-10T00:08:56.5993270Z      pub fn remove_transaction(&mut self, hash: &Hash) -> bool {
2025-11-10T00:08:56.5993493Z          if let Some(tx) = self.transactions.remove(hash) {
2025-11-10T00:08:56.5994870Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:237:
2025-11-10T00:08:56.5995061Z              self.mempool.remove(hash);
2025-11-10T00:08:56.5995183Z -            
2025-11-10T00:08:56.5995291Z +
2025-11-10T00:08:56.5995455Z              // Remove spent outputs tracking
2025-11-10T00:08:56.5995611Z              for input in &tx.inputs {
2025-11-10T00:08:56.5995808Z                  self.spent_outputs.remove(&input.prevout);
2025-11-10T00:08:56.5996274Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:242:
2025-11-10T00:08:56.5996390Z              }
2025-11-10T00:08:56.5996508Z -            
2025-11-10T00:08:56.5996617Z +
2025-11-10T00:08:56.5996736Z              true
2025-11-10T00:08:56.5996862Z          } else {
2025-11-10T00:08:56.5996980Z              false
2025-11-10T00:08:56.5997433Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:247:
2025-11-10T00:08:56.5997546Z          }
2025-11-10T00:08:56.5997672Z      }
2025-11-10T00:08:56.5997783Z -    
2025-11-10T00:08:56.5997890Z +
2025-11-10T00:08:56.5998029Z      /// Clear mempool
2025-11-10T00:08:56.5998170Z      pub fn clear(&mut self) {
2025-11-10T00:08:56.5998319Z          self.transactions.clear();
2025-11-10T00:08:56.5998763Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:253:
2025-11-10T00:08:56.5998919Z          self.mempool.clear();
2025-11-10T00:08:56.5999068Z          self.spent_outputs.clear();
2025-11-10T00:08:56.5999175Z      }
2025-11-10T00:08:56.5999292Z -    
2025-11-10T00:08:56.5999398Z +
2025-11-10T00:08:56.5999567Z      /// Save mempool to disk for persistence
2025-11-10T00:08:56.5999922Z      pub fn save_to_disk<P: AsRef<std::path::Path>>(&self, path: P) -> Result<()> {
2025-11-10T00:08:56.6000272Z +        use bllvm_protocol::serialization::transaction::serialize_transaction;
2025-11-10T00:08:56.6000411Z          use std::fs::File;
2025-11-10T00:08:56.6000546Z          use std::io::Write;
2025-11-10T00:08:56.6000898Z -        use bllvm_protocol::serialization::transaction::serialize_transaction;
2025-11-10T00:08:56.6001009Z -        
2025-11-10T00:08:56.6001118Z +
2025-11-10T00:08:56.6001310Z          let transactions = self.get_transactions();
2025-11-10T00:08:56.6001486Z          let mut file = File::create(path)?;
2025-11-10T00:08:56.6001595Z -        
2025-11-10T00:08:56.6001701Z +
2025-11-10T00:08:56.6001856Z          // Write transaction count
2025-11-10T00:08:56.6002118Z          file.write_all(&(transactions.len() as u32).to_le_bytes())?;
2025-11-10T00:08:56.6002230Z -        
2025-11-10T00:08:56.6002338Z +
2025-11-10T00:08:56.6002485Z          // Write each transaction
2025-11-10T00:08:56.6002627Z          for tx in transactions {
2025-11-10T00:08:56.6002823Z              let serialized = serialize_transaction(&tx);
2025-11-10T00:08:56.6003299Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:272:
2025-11-10T00:08:56.6003559Z              file.write_all(&(serialized.len() as u32).to_le_bytes())?;
2025-11-10T00:08:56.6003959Z              file.write_all(&serialized)?;
2025-11-10T00:08:56.6004082Z          }
2025-11-10T00:08:56.6004193Z -        
2025-11-10T00:08:56.6004468Z +
2025-11-10T00:08:56.6004695Z          file.sync_all()?;
2025-11-10T00:08:56.6004820Z          Ok(())
2025-11-10T00:08:56.6004928Z      }
2025-11-10T00:08:56.6005392Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:279:
2025-11-10T00:08:56.6005512Z  }
2025-11-10T00:08:56.6005621Z  
2025-11-10T00:08:56.6005781Z  impl Default for MempoolManager {
2025-11-10T00:08:56.6005949Z -    fn default() -> Self { Self::new() }
2025-11-10T00:08:56.6006096Z +    fn default() -> Self {
2025-11-10T00:08:56.6006220Z +        Self::new()
2025-11-10T00:08:56.6006332Z +    }
2025-11-10T00:08:56.6006448Z  }
2025-11-10T00:08:56.6006556Z  
2025-11-10T00:08:56.6006920Z  // Implement MempoolProvider trait for integration with MiningCoordinator
2025-11-10T00:08:56.6007629Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:298:
2025-11-10T00:08:56.6007774Z          self.size()
2025-11-10T00:08:56.6007876Z      }
2025-11-10T00:08:56.6007981Z  
2025-11-10T00:08:56.6008624Z -    fn get_prioritized_transactions(&self, limit: usize, utxo_set: &bllvm_protocol::UtxoSet) -> Vec<bllvm_protocol::Transaction> {
2025-11-10T00:08:56.6008784Z +    fn get_prioritized_transactions(
2025-11-10T00:08:56.6008897Z +        &self,
2025-11-10T00:08:56.6009017Z +        limit: usize,
2025-11-10T00:08:56.6009189Z +        utxo_set: &bllvm_protocol::UtxoSet,
2025-11-10T00:08:56.6009350Z +    ) -> Vec<bllvm_protocol::Transaction> {
2025-11-10T00:08:56.6009564Z          self.get_prioritized_transactions(limit, utxo_set)
2025-11-10T00:08:56.6009676Z      }
2025-11-10T00:08:56.6009779Z  
2025-11-10T00:08:56.6010235Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:312:
2025-11-10T00:08:56.6010376Z  impl MempoolManager {
2025-11-10T00:08:56.6010519Z      /// Load mempool from disk
2025-11-10T00:08:56.6010868Z      pub fn load_from_disk<P: AsRef<std::path::Path>>(&mut self, path: P) -> Result<()> {
2025-11-10T00:08:56.6011198Z +        use bllvm_protocol::serialization::transaction::deserialize_transaction;
2025-11-10T00:08:56.6011329Z          use std::fs::File;
2025-11-10T00:08:56.6011449Z          use std::io::Read;
2025-11-10T00:08:56.6011769Z -        use bllvm_protocol::serialization::transaction::deserialize_transaction;
2025-11-10T00:08:56.6011880Z -        
2025-11-10T00:08:56.6011980Z +
2025-11-10T00:08:56.6012146Z          let mut file = File::open(path)?;
2025-11-10T00:08:56.6012289Z          let mut count_bytes = [0u8; 4];
2025-11-10T00:08:56.6012448Z          file.read_exact(&mut count_bytes)?;
2025-11-10T00:08:56.6013207Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:322:
2025-11-10T00:08:56.6013420Z          let count = u32::from_le_bytes(count_bytes) as usize;
2025-11-10T00:08:56.6013542Z -        
2025-11-10T00:08:56.6013649Z +
2025-11-10T00:08:56.6013770Z          for _ in 0..count {
2025-11-10T00:08:56.6013908Z              let mut len_bytes = [0u8; 4];
2025-11-10T00:08:56.6014063Z              file.read_exact(&mut len_bytes)?;
2025-11-10T00:08:56.6014668Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:327:
2025-11-10T00:08:56.6014864Z              let len = u32::from_le_bytes(len_bytes) as usize;
2025-11-10T00:08:56.6014977Z -            
2025-11-10T00:08:56.6015079Z +
2025-11-10T00:08:56.6015224Z              let mut tx_bytes = vec![0u8; len];
2025-11-10T00:08:56.6015373Z              file.read_exact(&mut tx_bytes)?;
2025-11-10T00:08:56.6015476Z -            
2025-11-10T00:08:56.6015576Z +
2025-11-10T00:08:56.6015754Z              let tx = deserialize_transaction(&tx_bytes)?;
2025-11-10T00:08:56.6015907Z              let _ = self.add_transaction(tx);
2025-11-10T00:08:56.6016010Z          }
2025-11-10T00:08:56.6016449Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:335:
2025-11-10T00:08:56.6016782Z -        
2025-11-10T00:08:56.6016886Z +
2025-11-10T00:08:56.6017003Z          Ok(())
2025-11-10T00:08:56.6017113Z      }
2025-11-10T00:08:56.6017227Z  }
2025-11-10T00:08:56.6017684Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/metrics.rs:2:
2025-11-10T00:08:56.6017792Z  //!
2025-11-10T00:08:56.6018212Z  //! Provides comprehensive metrics for monitoring node health, performance, and behavior.
2025-11-10T00:08:56.6018315Z  
2025-11-10T00:08:56.6018470Z +use serde::{Deserialize, Serialize};
2025-11-10T00:08:56.6018611Z  use std::sync::Arc;
2025-11-10T00:08:56.6018735Z  use std::sync::Mutex;
2025-11-10T00:08:56.6018931Z  use std::time::{Duration, SystemTime, UNIX_EPOCH};
2025-11-10T00:08:56.6019360Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/metrics.rs:8:
2025-11-10T00:08:56.6019523Z -use serde::{Deserialize, Serialize};
2025-11-10T00:08:56.6019816Z  
2025-11-10T00:08:56.6019963Z  /// Comprehensive node metrics
2025-11-10T00:08:56.6020151Z  #[derive(Debug, Clone, Serialize, Deserialize)]
2025-11-10T00:08:56.6020593Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/metrics.rs:251:
2025-11-10T00:08:56.6020714Z          Self::new()
2025-11-10T00:08:56.6020819Z      }
2025-11-10T00:08:56.6020933Z  }
2025-11-10T00:08:56.6021036Z -
2025-11-10T00:08:56.6021137Z  
2025-11-10T00:08:56.6051967Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/miner.rs:20:
2025-11-10T00:08:56.6052091Z  
2025-11-10T00:08:56.6052272Z      /// Get prioritized transactions (by fee rate)
2025-11-10T00:08:56.6052461Z      /// Requires UTXO set for accurate fee calculation
2025-11-10T00:08:56.6052962Z -    fn get_prioritized_transactions(&self, limit: usize, utxo_set: &bllvm_protocol::UtxoSet) -> Vec<Transaction>;
2025-11-10T00:08:56.6053112Z +    fn get_prioritized_transactions(
2025-11-10T00:08:56.6053237Z +        &self,
2025-11-10T00:08:56.6053354Z +        limit: usize,
2025-11-10T00:08:56.6053513Z +        utxo_set: &bllvm_protocol::UtxoSet,
2025-11-10T00:08:56.6053639Z +    ) -> Vec<Transaction>;
2025-11-10T00:08:56.6053748Z  
2025-11-10T00:08:56.6053892Z      /// Remove transaction from mempool
2025-11-10T00:08:56.6054124Z      fn remove_transaction(&mut self, hash: &[u8; 32]) -> bool;
2025-11-10T00:08:56.6054811Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/miner.rs:57:
2025-11-10T00:08:56.6055010Z  
2025-11-10T00:08:56.6055170Z      /// Select transactions for block
2025-11-10T00:08:56.6055493Z      /// Note: Requires UTXO set for fee calculation - caller must provide it
2025-11-10T00:08:56.6056142Z -    pub fn select_transactions(&self, mempool: &dyn MempoolProvider, utxo_set: &bllvm_protocol::UtxoSet) -> Vec<Transaction> {
2025-11-10T00:08:56.6056305Z +    pub fn select_transactions(
2025-11-10T00:08:56.6056420Z +        &self,
2025-11-10T00:08:56.6056590Z +        mempool: &dyn MempoolProvider,
2025-11-10T00:08:56.6056768Z +        utxo_set: &bllvm_protocol::UtxoSet,
2025-11-10T00:08:56.6056991Z +    ) -> Vec<Transaction> {
2025-11-10T00:08:56.6057139Z          let mut selected = Vec::new();
2025-11-10T00:08:56.6057280Z          let mut current_size = 0;
2025-11-10T00:08:56.6057430Z          let mut current_weight = 0;
2025-11-10T00:08:56.6057882Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/miner.rs:392:
2025-11-10T00:08:56.6057991Z  
2025-11-10T00:08:56.6058265Z          // Get chain tip from storage for prev_block_hash and difficulty
2025-11-10T00:08:56.6058605Z          let (prev_block_hash, bits, height) = if let Some(ref storage) = self.storage {
2025-11-10T00:08:56.6058846Z -            if let Some(tip_header) = storage.chain().get_tip_header()
2025-11-10T00:08:56.6059559Z -                .map_err(|e| anyhow::anyhow!("Failed to get tip header: {}", e))? {
2025-11-10T00:08:56.6059762Z -                let tip_hash = storage.chain().get_tip_hash()
2025-11-10T00:08:56.6060202Z +            if let Some(tip_header) = storage
2025-11-10T00:08:56.6060324Z +                .chain()
2025-11-10T00:08:56.6060464Z +                .get_tip_header()
2025-11-10T00:08:56.6060742Z +                .map_err(|e| anyhow::anyhow!("Failed to get tip header: {}", e))?
2025-11-10T00:08:56.6060849Z +            {
2025-11-10T00:08:56.6060993Z +                let tip_hash = storage
2025-11-10T00:08:56.6061118Z +                    .chain()
2025-11-10T00:08:56.6061249Z +                    .get_tip_hash()
2025-11-10T00:08:56.6061508Z                      .map_err(|e| anyhow::anyhow!("Failed to get tip hash: {}", e))?
2025-11-10T00:08:56.6061664Z                      .unwrap_or([0u8; 32]);
2025-11-10T00:08:56.6061871Z -                let chain_height = storage.chain().get_height()
2025-11-10T00:08:56.6062021Z +                let chain_height = storage
2025-11-10T00:08:56.6062150Z +                    .chain()
2025-11-10T00:08:56.6062280Z +                    .get_height()
2025-11-10T00:08:56.6062882Z                      .map_err(|e| anyhow::anyhow!("Failed to get chain height: {}", e))?
2025-11-10T00:08:56.6063022Z                      .unwrap_or(0);
2025-11-10T00:08:56.6063201Z                  (tip_hash, tip_header.bits, chain_height)
2025-11-10T00:08:56.6063658Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/miner.rs:412:
2025-11-10T00:08:56.6063780Z  
2025-11-10T00:08:56.6063985Z          // Get UTXO set from storage for fee calculation
2025-11-10T00:08:56.6064221Z          let utxo_set = if let Some(ref storage) = self.storage {
2025-11-10T00:08:56.6064574Z -            storage.utxos().get_all_utxos()
2025-11-10T00:08:56.6064701Z +            storage
2025-11-10T00:08:56.6064821Z +                .utxos()
2025-11-10T00:08:56.6064948Z +                .get_all_utxos()
2025-11-10T00:08:56.6065227Z                  .map_err(|e| anyhow::anyhow!("Failed to get UTXO set: {}", e))?
2025-11-10T00:08:56.6065347Z          } else {
2025-11-10T00:08:56.6065597Z              // No storage - use empty UTXO set (will result in 0 fees)
2025-11-10T00:08:56.6066066Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/miner.rs:616:
2025-11-10T00:08:56.6066230Z          self.transactions.len()
2025-11-10T00:08:56.6066341Z      }
2025-11-10T00:08:56.6066449Z  
2025-11-10T00:08:56.6067013Z -    fn get_prioritized_transactions(&self, limit: usize, _utxo_set: &bllvm_protocol::UtxoSet) -> Vec<Transaction> {
2025-11-10T00:08:56.6067175Z +    fn get_prioritized_transactions(
2025-11-10T00:08:56.6067292Z +        &self,
2025-11-10T00:08:56.6067420Z +        limit: usize,
2025-11-10T00:08:56.6067595Z +        _utxo_set: &bllvm_protocol::UtxoSet,
2025-11-10T00:08:56.6067738Z +    ) -> Vec<Transaction> {
2025-11-10T00:08:56.6068096Z          // Mock implementation ignores UTXO set and uses pre-calculated priorities
2025-11-10T00:08:56.6068261Z          self.prioritized_transactions
2025-11-10T00:08:56.6068375Z              .iter()
2025-11-10T00:08:56.6068830Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/miner.rs:786:
2025-11-10T00:08:56.6069032Z          assert_eq!(mempool.get_mempool_size(), 0);
2025-11-10T00:08:56.6069238Z          assert!(mempool.get_transactions().is_empty());
2025-11-10T00:08:56.6069462Z          let empty_utxo_set = bllvm_protocol::UtxoSet::new();
2025-11-10T00:08:56.6069834Z -        assert!(mempool.get_prioritized_transactions(10, &empty_utxo_set).is_empty());
2025-11-10T00:08:56.6069977Z +        assert!(mempool
2025-11-10T00:08:56.6070190Z +            .get_prioritized_transactions(10, &empty_utxo_set)
2025-11-10T00:08:56.6070318Z +            .is_empty());
2025-11-10T00:08:56.6070436Z      }
2025-11-10T00:08:56.6070543Z  
2025-11-10T00:08:56.6070660Z      #[test]
2025-11-10T00:08:56.6181333Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:5:
2025-11-10T00:08:56.6181505Z  
2025-11-10T00:08:56.6181656Z  pub mod block_processor;
2025-11-10T00:08:56.6181818Z  pub mod event_publisher;
2025-11-10T00:08:56.6182180Z +pub mod health;
2025-11-10T00:08:56.6182307Z  pub mod mempool;
2025-11-10T00:08:56.6182436Z -pub mod miner;
2025-11-10T00:08:56.6182553Z -pub mod sync;
2025-11-10T00:08:56.6182675Z  pub mod metrics;
2025-11-10T00:08:56.6184856Z -pub mod health;
2025-11-10T00:08:56.6184991Z +pub mod miner;
2025-11-10T00:08:56.6185125Z  pub mod performance;
2025-11-10T00:08:56.6185243Z +pub mod sync;
2025-11-10T00:08:56.6185356Z  
2025-11-10T00:08:56.6185492Z  use anyhow::Result;
2025-11-10T00:08:56.6185631Z  use std::net::SocketAddr;
2025-11-10T00:08:56.6186068Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:70:
2025-11-10T00:08:56.6186183Z  
2025-11-10T00:08:56.6186326Z          // Initialize components
2025-11-10T00:08:56.6186699Z          let protocol_version = protocol_version.unwrap_or(ProtocolVersion::Regtest);
2025-11-10T00:08:56.6186826Z -        let protocol =
2025-11-10T00:08:56.6187035Z -            BitcoinProtocolEngine::new(protocol_version)?;
2025-11-10T00:08:56.6187555Z +        let protocol = BitcoinProtocolEngine::new(protocol_version)?;
2025-11-10T00:08:56.6187723Z          let protocol_arc = Arc::new(protocol);
2025-11-10T00:08:56.6187892Z          let storage = Storage::new(data_dir)?;
2025-11-10T00:08:56.6188039Z          let storage_arc = Arc::new(storage);
2025-11-10T00:08:56.6188486Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:78:
2025-11-10T00:08:56.6188797Z          let mempool_manager_arc = Arc::new(mempool::MempoolManager::new());
2025-11-10T00:08:56.6189010Z -        let network = NetworkManager::new(network_addr)
2025-11-10T00:08:56.6189535Z -            .with_dependencies(Arc::clone(&protocol_arc), Arc::clone(&storage_arc), Arc::clone(&mempool_manager_arc));
2025-11-10T00:08:56.6189856Z +        let network = NetworkManager::new(network_addr).with_dependencies(
2025-11-10T00:08:56.6190016Z +            Arc::clone(&protocol_arc),
2025-11-10T00:08:56.6190175Z +            Arc::clone(&storage_arc),
2025-11-10T00:08:56.6190352Z +            Arc::clone(&mempool_manager_arc),
2025-11-10T00:08:56.6190463Z +        );
2025-11-10T00:08:56.6190630Z          let network_arc = Arc::new(network);
2025-11-10T00:08:56.6190863Z          let metrics_arc = Arc::new(MetricsCollector::new());
2025-11-10T00:08:56.6191151Z          let profiler_arc = Arc::new(PerformanceProfiler::new(1000));
2025-11-10T00:08:56.6191594Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:187:
2025-11-10T00:08:56.6191771Z          info!("Sync coordinator initialized");
2025-11-10T00:08:56.6191943Z          info!("Mempool manager initialized");
2025-11-10T00:08:56.6192118Z          info!("Mining coordinator initialized");
2025-11-10T00:08:56.6192235Z -        
2025-11-10T00:08:56.6192353Z +
2025-11-10T00:08:56.6192493Z          // Start network manager
2025-11-10T00:08:56.6192754Z          if let Err(e) = self.network.start(self.network_addr).await {
2025-11-10T00:08:56.6192968Z              warn!("Failed to start network manager: {}", e);
2025-11-10T00:08:56.6193418Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:194:
2025-11-10T00:08:56.6193625Z              // Continue anyway - network might be optional
2025-11-10T00:08:56.6193743Z          }
2025-11-10T00:08:56.6193866Z -        
2025-11-10T00:08:56.6193978Z +
2025-11-10T00:08:56.6194171Z          // Initialize peer connections automatically
2025-11-10T00:08:56.6194569Z          self.initialize_peer_connections().await?;
2025-11-10T00:08:56.6194698Z  
2025-11-10T00:08:56.6195156Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:203:
2025-11-10T00:08:56.6195315Z              if config.prune_on_startup {
2025-11-10T00:08:56.6195655Z                  let current_height = self.storage.chain().get_height()?.unwrap_or(0);
2025-11-10T00:08:56.6195824Z                  let is_ibd = current_height == 0;
2025-11-10T00:08:56.6195939Z -                
2025-11-10T00:08:56.6196067Z +
2025-11-10T00:08:56.6196507Z                  if !is_ibd && pruning_manager.is_enabled() {
2025-11-10T00:08:56.6196823Z                      info!("Prune on startup enabled, checking if pruning is needed...");
2025-11-10T00:08:56.6196946Z -                    
2025-11-10T00:08:56.6197060Z +
2025-11-10T00:08:56.6197270Z                      // Calculate prune height based on configuration
2025-11-10T00:08:56.6197455Z                      let prune_height = match &config.mode {
2025-11-10T00:08:56.6197666Z                          crate::config::PruningMode::Disabled => {
2025-11-10T00:08:56.6198103Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:213:
2025-11-10T00:08:56.6198253Z                              // Skip if disabled
2025-11-10T00:08:56.6198388Z                              None
2025-11-10T00:08:56.6198512Z                          }
2025-11-10T00:08:56.6198817Z -                        crate::config::PruningMode::Normal { keep_from_height, .. } => {
2025-11-10T00:08:56.6199270Z +                        crate::config::PruningMode::Normal {
2025-11-10T00:08:56.6199438Z +                            keep_from_height, ..
2025-11-10T00:08:56.6199564Z +                        } => {
2025-11-10T00:08:56.6199739Z                              // Prune up to keep_from_height
2025-11-10T00:08:56.6199908Z                              Some(*keep_from_height)
2025-11-10T00:08:56.6200033Z                          }
2025-11-10T00:08:56.6200465Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:220:
2025-11-10T00:08:56.6200632Z                          #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.6200950Z -                        crate::config::PruningMode::Aggressive { keep_from_height, .. } => {
2025-11-10T00:08:56.6201130Z +                        crate::config::PruningMode::Aggressive {
2025-11-10T00:08:56.6201272Z +                            keep_from_height, ..
2025-11-10T00:08:56.6201399Z +                        } => {
2025-11-10T00:08:56.6201567Z                              // Prune up to keep_from_height
2025-11-10T00:08:56.6201727Z                              Some(*keep_from_height)
2025-11-10T00:08:56.6201854Z                          }
2025-11-10T00:08:56.6202257Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:228:
2025-11-10T00:08:56.6202459Z                              // Fall back to no pruning if feature is disabled
2025-11-10T00:08:56.6202583Z                              None
2025-11-10T00:08:56.6202694Z                          }
2025-11-10T00:08:56.6203012Z -                        crate::config::PruningMode::Custom { keep_bodies_from_height, .. } => {
2025-11-10T00:08:56.6203179Z +                        crate::config::PruningMode::Custom {
2025-11-10T00:08:56.6203333Z +                            keep_bodies_from_height,
2025-11-10T00:08:56.6203449Z +                            ..
2025-11-10T00:08:56.6203569Z +                        } => {
2025-11-10T00:08:56.6203768Z                              // Prune up to keep_bodies_from_height
2025-11-10T00:08:56.6203943Z                              Some(*keep_bodies_from_height)
2025-11-10T00:08:56.6204058Z                          }
2025-11-10T00:08:56.6204645Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:235:
2025-11-10T00:08:56.6204782Z                      };
2025-11-10T00:08:56.6204889Z -                    
2025-11-10T00:08:56.6204988Z +
2025-11-10T00:08:56.6205190Z                      if let Some(prune_to_height) = prune_height {
2025-11-10T00:08:56.6205355Z                          if prune_to_height < current_height {
2025-11-10T00:08:56.6205755Z -                            match pruning_manager.prune_to_height(prune_to_height, current_height, is_ibd) {
2025-11-10T00:08:56.6205955Z +                            match pruning_manager.prune_to_height(
2025-11-10T00:08:56.6206104Z +                                prune_to_height,
2025-11-10T00:08:56.6206259Z +                                current_height,
2025-11-10T00:08:56.6206648Z +                                is_ibd,
2025-11-10T00:08:56.6206785Z +                            ) {
2025-11-10T00:08:56.6206931Z                                  Ok(stats) => {
2025-11-10T00:08:56.6207263Z                                      info!("Startup pruning completed: {} blocks pruned, {} blocks kept", 
2025-11-10T00:08:56.6207479Z                                            stats.blocks_pruned, stats.blocks_kept);
2025-11-10T00:08:56.6207924Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:243:
2025-11-10T00:08:56.6208127Z                                      // Flush storage to persist pruning changes
2025-11-10T00:08:56.6208321Z                                      if let Err(e) = self.storage.flush() {
2025-11-10T00:08:56.6208615Z -                                        warn!("Failed to flush storage after startup pruning: {}", e);
2025-11-10T00:08:56.6208758Z +                                        warn!(
2025-11-10T00:08:56.6209251Z +                                            "Failed to flush storage after startup pruning: {}",
2025-11-10T00:08:56.6209479Z +                                            e
2025-11-10T00:08:56.6209614Z +                                        );
2025-11-10T00:08:56.6209742Z                                      }
2025-11-10T00:08:56.6209868Z                                  }
2025-11-10T00:08:56.6210004Z                                  Err(e) => {
2025-11-10T00:08:56.6210446Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:292:
2025-11-10T00:08:56.6210578Z      }
2025-11-10T00:08:56.6210689Z  
2025-11-10T00:08:56.6210879Z      /// Initialize peer connections automatically
2025-11-10T00:08:56.6210993Z -    /// 
2025-11-10T00:08:56.6211116Z +    ///
2025-11-10T00:08:56.6211486Z      /// Determines network type from protocol version and uses config if available.
2025-11-10T00:08:56.6211748Z      async fn initialize_peer_connections(&self) -> Result<()> {
2025-11-10T00:08:56.6211975Z          // Determine network type from protocol version
2025-11-10T00:08:56.6212406Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:306:
2025-11-10T00:08:56.6212581Z                  if let Some(ref config) = self.config {
2025-11-10T00:08:56.6212858Z                      if let Some(ref persistent_peers) = config.persistent_peers {
2025-11-10T00:08:56.6213033Z                          if !persistent_peers.is_empty() {
2025-11-10T00:08:56.6213391Z -                            if let Err(e) = self.network.connect_persistent_peers(persistent_peers).await {
2025-11-10T00:08:56.6213544Z +                            if let Err(e) = self
2025-11-10T00:08:56.6213677Z +                                .network
2025-11-10T00:08:56.6213883Z +                                .connect_persistent_peers(persistent_peers)
2025-11-10T00:08:56.6214006Z +                                .await
2025-11-10T00:08:56.6214139Z +                            {
2025-11-10T00:08:56.6214622Z                                  warn!("Failed to connect to some persistent peers: {}", e);
2025-11-10T00:08:56.6214750Z                              }
2025-11-10T00:08:56.6214873Z                          }
2025-11-10T00:08:56.6215303Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:315:
2025-11-10T00:08:56.6215432Z                  return Ok(());
2025-11-10T00:08:56.6215540Z              }
2025-11-10T00:08:56.6215658Z          };
2025-11-10T00:08:56.6215769Z -        
2025-11-10T00:08:56.6215878Z +
2025-11-10T00:08:56.6216046Z          // Get port from network address
2025-11-10T00:08:56.6216214Z          let port = self.network_addr.port();
2025-11-10T00:08:56.6216322Z -        
2025-11-10T00:08:56.6216427Z +
2025-11-10T00:08:56.6216776Z          // Default target peer count (Bitcoin Core uses 8-125, we'll use 8 as default)
2025-11-10T00:08:56.6216922Z          let target_peer_count = 8;
2025-11-10T00:08:56.6217042Z -        
2025-11-10T00:08:56.6217407Z +
2025-11-10T00:08:56.6217624Z          // Use config if available, otherwise use defaults
2025-11-10T00:08:56.6217793Z          let default_config = NodeConfig {
2025-11-10T00:08:56.6217965Z              listen_addr: Some(self.network_addr),
2025-11-10T00:08:56.6218409Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:328:
2025-11-10T00:08:56.6218558Z              ..Default::default()
2025-11-10T00:08:56.6218673Z          };
2025-11-10T00:08:56.6218948Z          let config = self.config.as_ref().unwrap_or(&default_config);
2025-11-10T00:08:56.6219059Z -        
2025-11-10T00:08:56.6219165Z +
2025-11-10T00:08:56.6219322Z          // Initialize peer connections
2025-11-10T00:08:56.6219563Z -        if let Err(e) = self.network.initialize_peer_connections(
2025-11-10T00:08:56.6219681Z -            config,
2025-11-10T00:08:56.6219800Z -            network,
2025-11-10T00:08:56.6219920Z -            port,
2025-11-10T00:08:56.6220240Z -            target_peer_count,
2025-11-10T00:08:56.6220365Z -        ).await {
2025-11-10T00:08:56.6220507Z +        if let Err(e) = self
2025-11-10T00:08:56.6220622Z +            .network
2025-11-10T00:08:56.6220961Z +            .initialize_peer_connections(config, network, port, target_peer_count)
2025-11-10T00:08:56.6221076Z +            .await
2025-11-10T00:08:56.6223027Z +        {
2025-11-10T00:08:56.6223266Z              warn!("Failed to initialize peer connections: {}", e);
2025-11-10T00:08:56.6223489Z              // Don't fail startup - peer connections are best-effort
2025-11-10T00:08:56.6223596Z          }
2025-11-10T00:08:56.6224014Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:342:
2025-11-10T00:08:56.6224121Z -        
2025-11-10T00:08:56.6224217Z +
2025-11-10T00:08:56.6224466Z          Ok(())
2025-11-10T00:08:56.6224567Z      }
2025-11-10T00:08:56.6224664Z  
2025-11-10T00:08:56.6225074Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:368:
2025-11-10T00:08:56.6225203Z                  ) {
2025-11-10T00:08:56.6225339Z                      Ok(true) => {
2025-11-10T00:08:56.6225570Z                          info!("Block accepted at height {}", current_height);
2025-11-10T00:08:56.6225688Z -                        
2025-11-10T00:08:56.6225783Z +
2025-11-10T00:08:56.6225990Z                          // Persist UTXO set to storage after block validation
2025-11-10T00:08:56.6226284Z                          // This is critical for commitment generation and incremental pruning
2025-11-10T00:08:56.6226540Z                          if let Err(e) = self.storage.utxos().store_utxo_set(&utxo_set) {
2025-11-10T00:08:56.6226969Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:375:
2025-11-10T00:08:56.6227325Z -                            warn!("Failed to persist UTXO set after block {}: {}", current_height, e);
2025-11-10T00:08:56.6227453Z +                            warn!(
2025-11-10T00:08:56.6227681Z +                                "Failed to persist UTXO set after block {}: {}",
2025-11-10T00:08:56.6227845Z +                                current_height, e
2025-11-10T00:08:56.6227980Z +                            );
2025-11-10T00:08:56.6228102Z                          }
2025-11-10T00:08:56.6228224Z -                        
2025-11-10T00:08:56.6228340Z +
2025-11-10T00:08:56.6228606Z                          // Generate UTXO commitment from current state (if enabled)
2025-11-10T00:08:56.6228961Z                          // Use current_height (the block that was just validated) before incrementing
2025-11-10T00:08:56.6229147Z                          #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.6229576Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:381:
2025-11-10T00:08:56.6229698Z                          {
2025-11-10T00:08:56.6229952Z                              if let Some(pruning_manager) = self.storage.pruning() {
2025-11-10T00:08:56.6230197Z -                                if let (Some(commitment_store), Some(_utxostore)) = 
2025-11-10T00:08:56.6230839Z -                                    (pruning_manager.commitment_store(), pruning_manager.utxostore()) 
2025-11-10T00:08:56.6230970Z -                                {
2025-11-10T00:08:56.6231211Z +                                if let (Some(commitment_store), Some(_utxostore)) = (
2025-11-10T00:08:56.6231406Z +                                    pruning_manager.commitment_store(),
2025-11-10T00:08:56.6231588Z +                                    pruning_manager.utxostore(),
2025-11-10T00:08:56.6231726Z +                                ) {
2025-11-10T00:08:56.6232057Z                                      // Get block hash from storage (block was just stored at current_height)
2025-11-10T00:08:56.6232252Z                                      let blocks_arc = self.storage.blocks();
2025-11-10T00:08:56.6232605Z -                                    if let Ok(Some(block_hash)) = blocks_arc.get_hash_by_height(current_height) {
2025-11-10T00:08:56.6232993Z +                                    if let Ok(Some(block_hash)) =
2025-11-10T00:08:56.6233208Z +                                        blocks_arc.get_hash_by_height(current_height)
2025-11-10T00:08:56.6233339Z +                                    {
2025-11-10T00:08:56.6233573Z                                          // Generate commitment from current UTXO set state
2025-11-10T00:08:56.6233896Z -                                        if let Err(e) = pruning_manager.generate_commitment_from_current_state(
2025-11-10T00:08:56.6234052Z -                                            &block_hash,
2025-11-10T00:08:56.6234225Z -                                            current_height,
2025-11-10T00:08:56.6235093Z -                                            &utxo_set,
2025-11-10T00:08:56.6235288Z -                                            &commitment_store,
2025-11-10T00:08:56.6235437Z -                                        ) {
2025-11-10T00:08:56.6235807Z -                                            warn!("Failed to generate commitment for block {}: {}", current_height, e);
2025-11-10T00:08:56.6235997Z +                                        if let Err(e) = pruning_manager
2025-11-10T00:08:56.6236212Z +                                            .generate_commitment_from_current_state(
2025-11-10T00:08:56.6236360Z +                                                &block_hash,
2025-11-10T00:08:56.6236510Z +                                                current_height,
2025-11-10T00:08:56.6236648Z +                                                &utxo_set,
2025-11-10T00:08:56.6236811Z +                                                &commitment_store,
2025-11-10T00:08:56.6236937Z +                                            )
2025-11-10T00:08:56.6237057Z +                                        {
2025-11-10T00:08:56.6237194Z +                                            warn!(
2025-11-10T00:08:56.6237415Z +                                                "Failed to generate commitment for block {}: {}",
2025-11-10T00:08:56.6237581Z +                                                current_height, e
2025-11-10T00:08:56.6237712Z +                                            );
2025-11-10T00:08:56.6237843Z                                          } else {
2025-11-10T00:08:56.6238142Z -                                            debug!("Generated UTXO commitment for block {}", current_height);
2025-11-10T00:08:56.6238275Z +                                            debug!(
2025-11-10T00:08:56.6238480Z +                                                "Generated UTXO commitment for block {}",
2025-11-10T00:08:56.6238639Z +                                                current_height
2025-11-10T00:08:56.6238769Z +                                            );
2025-11-10T00:08:56.6238899Z                                          }
2025-11-10T00:08:56.6239028Z                                      } else {
2025-11-10T00:08:56.6239415Z                                          warn!("Could not find block hash for height {} to generate commitment", current_height);
2025-11-10T00:08:56.6240111Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:403:
2025-11-10T00:08:56.6240229Z                                  }
2025-11-10T00:08:56.6240343Z                              }
2025-11-10T00:08:56.6240462Z                          }
2025-11-10T00:08:56.6240572Z -                        
2025-11-10T00:08:56.6240669Z +
2025-11-10T00:08:56.6240839Z                          // Increment height after processing
2025-11-10T00:08:56.6241086Z                          current_height += 1;
2025-11-10T00:08:56.6241272Z -                        
2025-11-10T00:08:56.6241374Z +
2025-11-10T00:08:56.6241572Z                          // Check for incremental pruning during IBD
2025-11-10T00:08:56.6241891Z                          // Consider IBD if we're still syncing (height < tip or no recent blocks)
2025-11-10T00:08:56.6242260Z                          let is_ibd = current_height < 1000; // Simple heuristic: consider IBD if < 1000 blocks
2025-11-10T00:08:56.6242951Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:413:
2025-11-10T00:08:56.6243212Z                          if let Some(pruning_manager) = self.storage.pruning() {
2025-11-10T00:08:56.6245452Z -                            if let Ok(Some(prune_stats)) = pruning_manager.incremental_prune_during_ibd(current_height, is_ibd) {
2025-11-10T00:08:56.6245637Z +                            if let Ok(Some(prune_stats)) =
2025-11-10T00:08:56.6246004Z +                                pruning_manager.incremental_prune_during_ibd(current_height, is_ibd)
2025-11-10T00:08:56.6246126Z +                            {
2025-11-10T00:08:56.6246484Z                                  info!("Incremental pruning during IBD: {} blocks pruned, {} bytes freed", 
2025-11-10T00:08:56.6246755Z                                        prune_stats.blocks_pruned, prune_stats.storage_freed);
2025-11-10T00:08:56.6246966Z                                  // Flush storage to persist pruning changes
2025-11-10T00:08:56.6247411Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:418:
2025-11-10T00:08:56.6247609Z                                  if let Err(e) = self.storage.flush() {
2025-11-10T00:08:56.6247916Z -                                    warn!("Failed to flush storage after incremental pruning: {}", e);
2025-11-10T00:08:56.6248047Z +                                    warn!(
2025-11-10T00:08:56.6248302Z +                                        "Failed to flush storage after incremental pruning: {}",
2025-11-10T00:08:56.6248432Z +                                        e
2025-11-10T00:08:56.6248559Z +                                    );
2025-11-10T00:08:56.6248682Z                                  }
2025-11-10T00:08:56.6248814Z                              }
2025-11-10T00:08:56.6248930Z                          }
2025-11-10T00:08:56.6249364Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:423:
2025-11-10T00:08:56.6249502Z -                        
2025-11-10T00:08:56.6249610Z +
2025-11-10T00:08:56.6249839Z                          // Check for automatic pruning after block acceptance
2025-11-10T00:08:56.6250081Z                          if let Some(pruning_manager) = self.storage.pruning() {
2025-11-10T00:08:56.6250278Z                              let stats = pruning_manager.get_stats();
2025-11-10T00:08:56.6250712Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:427:
2025-11-10T00:08:56.6250955Z -                            let should_prune = pruning_manager.should_auto_prune(
2025-11-10T00:08:56.6251115Z -                                current_height,
2025-11-10T00:08:56.6251803Z -                                stats.last_prune_height,
2025-11-10T00:08:56.6251937Z -                            );
2025-11-10T00:08:56.6252068Z -                            
2025-11-10T00:08:56.6252250Z +                            let should_prune = pruning_manager
2025-11-10T00:08:56.6252818Z +                                .should_auto_prune(current_height, stats.last_prune_height);
2025-11-10T00:08:56.6252937Z +
2025-11-10T00:08:56.6253093Z                              if should_prune {
2025-11-10T00:08:56.6255285Z                                  info!("Automatic pruning triggered at height {}", current_height);
2025-11-10T00:08:56.6255426Z -                                
2025-11-10T00:08:56.6255534Z +
2025-11-10T00:08:56.6255757Z                                  // Calculate prune height based on configuration
2025-11-10T00:08:56.6256026Z                                  let prune_height = match &pruning_manager.config.mode {
2025-11-10T00:08:56.6256255Z                                      crate::config::PruningMode::Disabled => None,
2025-11-10T00:08:56.6256686Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:438:
2025-11-10T00:08:56.6257004Z -                                    crate::config::PruningMode::Normal { keep_from_height, .. } => {
2025-11-10T00:08:56.6257448Z +                                    crate::config::PruningMode::Normal {
2025-11-10T00:08:56.6257619Z +                                        keep_from_height, ..
2025-11-10T00:08:56.6257751Z +                                    } => {
2025-11-10T00:08:56.6258026Z                                          // Prune to keep_from_height, but ensure we keep min_blocks
2025-11-10T00:08:56.6258289Z                                          let min_keep = pruning_manager.config.min_blocks_to_keep;
2025-11-10T00:08:56.6258708Z -                                        let effective_keep = (*keep_from_height).max(current_height.saturating_sub(min_keep));
2025-11-10T00:08:56.6258912Z +                                        let effective_keep = (*keep_from_height)
2025-11-10T00:08:56.6259133Z +                                            .max(current_height.saturating_sub(min_keep));
2025-11-10T00:08:56.6259296Z                                          Some(effective_keep)
2025-11-10T00:08:56.6259446Z                                      }
2025-11-10T00:08:56.6259626Z                                      #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.6260057Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:445:
2025-11-10T00:08:56.6260470Z -                                    crate::config::PruningMode::Aggressive { keep_from_height, min_blocks, .. } => {
2025-11-10T00:08:56.6260675Z +                                    crate::config::PruningMode::Aggressive {
2025-11-10T00:08:56.6260835Z +                                        keep_from_height,
2025-11-10T00:08:56.6260979Z +                                        min_blocks,
2025-11-10T00:08:56.6261122Z +                                        ..
2025-11-10T00:08:56.6261248Z +                                    } => {
2025-11-10T00:08:56.6261484Z                                          // Prune to keep_from_height, respecting min_blocks
2025-11-10T00:08:56.6261936Z -                                        let effective_keep = (*keep_from_height).max(current_height.saturating_sub(*min_blocks));
2025-11-10T00:08:56.6262137Z +                                        let effective_keep = (*keep_from_height)
2025-11-10T00:08:56.6262370Z +                                            .max(current_height.saturating_sub(*min_blocks));
2025-11-10T00:08:56.6262544Z                                          Some(effective_keep)
2025-11-10T00:08:56.6262673Z                                      }
2025-11-10T00:08:56.6262866Z                                      #[cfg(not(feature = "utxo-commitments"))]
2025-11-10T00:08:56.6263312Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:453:
2025-11-10T00:08:56.6263530Z                                          // Fall back to no pruning if feature is disabled
2025-11-10T00:08:56.6263670Z                                          None
2025-11-10T00:08:56.6265775Z                                      }
2025-11-10T00:08:56.6266389Z -                                    crate::config::PruningMode::Custom { keep_bodies_from_height, .. } => {
2025-11-10T00:08:56.6266583Z +                                    crate::config::PruningMode::Custom {
2025-11-10T00:08:56.6266750Z +                                        keep_bodies_from_height,
2025-11-10T00:08:56.6266883Z +                                        ..
2025-11-10T00:08:56.6267007Z +                                    } => {
2025-11-10T00:08:56.6267267Z                                          // Prune to keep_bodies_from_height, respecting min_blocks
2025-11-10T00:08:56.6267539Z                                          let min_keep = pruning_manager.config.min_blocks_to_keep;
2025-11-10T00:08:56.6268003Z -                                        let effective_keep = (*keep_bodies_from_height).max(current_height.saturating_sub(min_keep));
2025-11-10T00:08:56.6268228Z +                                        let effective_keep = (*keep_bodies_from_height)
2025-11-10T00:08:56.6268679Z +                                            .max(current_height.saturating_sub(min_keep));
2025-11-10T00:08:56.6268843Z                                          Some(effective_keep)
2025-11-10T00:08:56.6268970Z                                      }
2025-11-10T00:08:56.6269092Z                                  };
2025-11-10T00:08:56.6269533Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:463:
2025-11-10T00:08:56.6269660Z -                                
2025-11-10T00:08:56.6269768Z +
2025-11-10T00:08:56.6269989Z                                  if let Some(prune_to_height) = prune_height {
2025-11-10T00:08:56.6270171Z                                      if prune_to_height < current_height {
2025-11-10T00:08:56.6270578Z -                                        match pruning_manager.prune_to_height(prune_to_height, current_height, false) {
2025-11-10T00:08:56.6270783Z +                                        match pruning_manager.prune_to_height(
2025-11-10T00:08:56.6270961Z +                                            prune_to_height,
2025-11-10T00:08:56.6271123Z +                                            current_height,
2025-11-10T00:08:56.6271265Z +                                            false,
2025-11-10T00:08:56.6271407Z +                                        ) {
2025-11-10T00:08:56.6271571Z                                              Ok(prune_stats) => {
2025-11-10T00:08:56.6271921Z                                                  info!("Automatic pruning completed: {} blocks pruned, {} blocks kept", 
2025-11-10T00:08:56.6272193Z                                                        prune_stats.blocks_pruned, prune_stats.blocks_kept);
2025-11-10T00:08:56.6272861Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:596:
2025-11-10T00:08:56.6272999Z      /// Get health report
2025-11-10T00:08:56.6273226Z      pub fn health_check(&self) -> health::HealthReport {
2025-11-10T00:08:56.6273397Z          use crate::node::health::HealthChecker;
2025-11-10T00:08:56.6273506Z -        
2025-11-10T00:08:56.6273614Z +
2025-11-10T00:08:56.6273767Z          let checker = HealthChecker::new();
2025-11-10T00:08:56.6273986Z          let network_healthy = self.network.is_network_active();
2025-11-10T00:08:56.6274470Z          let storage_healthy = self.storage.check_storage_bounds().unwrap_or(false);
2025-11-10T00:08:56.6274898Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:603:
2025-11-10T00:08:56.6275170Z          let rpc_healthy = true; // RPC is always healthy if node is running
2025-11-10T00:08:56.6275289Z -        
2025-11-10T00:08:56.6275399Z +
2025-11-10T00:08:56.6275587Z          // Get metrics if available (simplified for now)
2025-11-10T00:08:56.6275724Z          checker.check_health(
2025-11-10T00:08:56.6275844Z              network_healthy,
2025-11-10T00:08:56.6276320Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/performance.rs:2:
2025-11-10T00:08:56.6276434Z  //!
2025-11-10T00:08:56.6277093Z  //! Provides performance tracking, profiling hooks, and performance metrics collection.
2025-11-10T00:08:56.6277200Z  
2025-11-10T00:08:56.6277354Z +use serde::{Deserialize, Serialize};
2025-11-10T00:08:56.6277473Z  use std::sync::Arc;
2025-11-10T00:08:56.6277600Z  use std::sync::Mutex;
2025-11-10T00:08:56.6277740Z  use std::time::{Duration, Instant};
2025-11-10T00:08:56.6278186Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/performance.rs:8:
2025-11-10T00:08:56.6278333Z -use serde::{Deserialize, Serialize};
2025-11-10T00:08:56.6278440Z  
2025-11-10T00:08:56.6278657Z  /// Performance profiler for tracking operation timings
2025-11-10T00:08:56.6278811Z  pub struct PerformanceProfiler {
2025-11-10T00:08:56.6279285Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/performance.rs:87:
2025-11-10T00:08:56.6279462Z          let total: Duration = times.iter().sum();
2025-11-10T00:08:56.6279781Z          let count = times.len();
2025-11-10T00:08:56.6279939Z          let avg = total / count as u32;
2025-11-10T00:08:56.6280060Z -        
2025-11-10T00:08:56.6280166Z +
2025-11-10T00:08:56.6280314Z          let mut sorted = times.to_vec();
2025-11-10T00:08:56.6280445Z          sorted.sort();
2025-11-10T00:08:56.6280556Z -        
2025-11-10T00:08:56.6280657Z +
2025-11-10T00:08:56.6280797Z          let p50 = sorted[count / 2];
2025-11-10T00:08:56.6280946Z          let p95 = sorted[(count * 95) / 100];
2025-11-10T00:08:56.6281085Z          let p99 = sorted[(count * 99) / 100];
2025-11-10T00:08:56.6281548Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/performance.rs:166:
2025-11-10T00:08:56.6281720Z      /// Stop the timer and record the duration
2025-11-10T00:08:56.6281859Z      pub fn stop(self) -> Duration {
2025-11-10T00:08:56.6282023Z          let duration = self.start.elapsed();
2025-11-10T00:08:56.6282143Z -        
2025-11-10T00:08:56.6282248Z +
2025-11-10T00:08:56.6282407Z          match self.operation_type {
2025-11-10T00:08:56.6282603Z              OperationType::BlockProcessing => {
2025-11-10T00:08:56.6282838Z                  self.profiler.record_block_processing(duration);
2025-11-10T00:08:56.6283316Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/performance.rs:181:
2025-11-10T00:08:56.6283540Z                  self.profiler.record_network_operation(duration);
2025-11-10T00:08:56.6283666Z              }
2025-11-10T00:08:56.6283775Z          }
2025-11-10T00:08:56.6283882Z -        
2025-11-10T00:08:56.6283990Z +
2025-11-10T00:08:56.6284115Z          duration
2025-11-10T00:08:56.6284226Z      }
2025-11-10T00:08:56.6284517Z  }
2025-11-10T00:08:56.6285039Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/performance.rs:191:
2025-11-10T00:08:56.6285221Z          Self::new(1000) // Keep last 1000 samples
2025-11-10T00:08:56.6285330Z      }
2025-11-10T00:08:56.6285436Z  }
2025-11-10T00:08:56.6285559Z -
2025-11-10T00:08:56.6285665Z  
2025-11-10T00:08:56.6286168Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/sync.rs:188:
2025-11-10T00:08:56.6286350Z          metrics: Option<Arc<MetricsCollector>>,
2025-11-10T00:08:56.6286553Z          profiler: Option<Arc<PerformanceProfiler>>,
2025-11-10T00:08:56.6286696Z      ) -> Result<bool> {
2025-11-10T00:08:56.6286880Z -        let _timer = profiler.as_ref().map(|p| {
2025-11-10T00:08:56.6287249Z -            PerformanceTimer::start(Arc::clone(p), OperationType::BlockProcessing)
2025-11-10T00:08:56.6287373Z -        });
2025-11-10T00:08:56.6287506Z +        let _timer = profiler
2025-11-10T00:08:56.6287622Z +            .as_ref()
2025-11-10T00:08:56.6288018Z +            .map(|p| PerformanceTimer::start(Arc::clone(p), OperationType::BlockProcessing));
2025-11-10T00:08:56.6288638Z          let start_time = Instant::now();
2025-11-10T00:08:56.6288757Z  
2025-11-10T00:08:56.6288992Z          // Parse block from wire format (extracts witness data)
2025-11-10T00:08:56.6289451Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/sync.rs:231:
2025-11-10T00:08:56.6289895Z                  metrics.update_performance(|m| {
2025-11-10T00:08:56.6290123Z                      let time_ms = processing_time.as_secs_f64() * 1000.0;
2025-11-10T00:08:56.6290443Z                      // Update average block processing time (exponential moving average)
2025-11-10T00:08:56.6290628Z -                    m.avg_block_processing_time_ms = 
2025-11-10T00:08:56.6290794Z +                    m.avg_block_processing_time_ms =
2025-11-10T00:08:56.6291033Z                          (m.avg_block_processing_time_ms * 0.9) + (time_ms * 0.1);
2025-11-10T00:08:56.6291194Z                      // Update blocks per second
2025-11-10T00:08:56.6291382Z                      if processing_time.as_secs_f64() > 0.0 {
2025-11-10T00:08:56.6299306Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/sync.rs:240:
2025-11-10T00:08:56.6299687Z                  });
2025-11-10T00:08:56.6299802Z              }
2025-11-10T00:08:56.6299912Z  
2025-11-10T00:08:56.6300348Z -            info!("Block validated and stored at height {} (took {:?})", current_height, processing_time);
2025-11-10T00:08:56.6300463Z +            info!(
2025-11-10T00:08:56.6300717Z +                "Block validated and stored at height {} (took {:?})",
2025-11-10T00:08:56.6300888Z +                current_height, processing_time
2025-11-10T00:08:56.6301001Z +            );
2025-11-10T00:08:56.6301114Z              Ok(true)
2025-11-10T00:08:56.6303152Z          } else {
2025-11-10T00:08:56.6303432Z              error!("Block validation failed at height {}", current_height);
2025-11-10T00:08:56.6303864Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:85:
2025-11-10T00:08:56.6304080Z          let elapsed = now.saturating_sub(self.last_refill);
2025-11-10T00:08:56.6304203Z          if elapsed > 0 {
2025-11-10T00:08:56.6304637Z              let tokens_to_add = (elapsed as u32).saturating_mul(self.rate);
2025-11-10T00:08:56.6305008Z -            self.tokens = self.tokens.saturating_add(tokens_to_add).min(self.burst_limit);
2025-11-10T00:08:56.6305132Z +            self.tokens = self
2025-11-10T00:08:56.6305241Z +                .tokens
2025-11-10T00:08:56.6305387Z +                .saturating_add(tokens_to_add)
2025-11-10T00:08:56.6305529Z +                .min(self.burst_limit);
2025-11-10T00:08:56.6305660Z              self.last_refill = now;
2025-11-10T00:08:56.6305760Z          }
2025-11-10T00:08:56.6305868Z  
2025-11-10T00:08:56.6306267Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:134:
2025-11-10T00:08:56.6306366Z      }
2025-11-10T00:08:56.6306462Z  
2025-11-10T00:08:56.6306605Z      /// Create with custom rate limits
2025-11-10T00:08:56.6306735Z -    pub fn with_rate_limits(
2025-11-10T00:08:56.6306865Z -        auth_required: bool,
2025-11-10T00:08:56.6307012Z -        default_burst: u32,
2025-11-10T00:08:56.6307150Z -        default_rate: u32,
2025-11-10T00:08:56.6307277Z -    ) -> Self {
2025-11-10T00:08:56.6307707Z +    pub fn with_rate_limits(auth_required: bool, default_burst: u32, default_rate: u32) -> Self {
2025-11-10T00:08:56.6307836Z          Self {
2025-11-10T00:08:56.6308065Z              valid_tokens: Arc::new(Mutex::new(HashMap::new())),
2025-11-10T00:08:56.6308328Z              valid_certificates: Arc::new(Mutex::new(HashMap::new())),
2025-11-10T00:08:56.6308763Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:154:
2025-11-10T00:08:56.6309014Z          let user_id = UserId::Token(AuthToken::new(token.clone()));
2025-11-10T00:08:56.6309214Z          let mut tokens = self.valid_tokens.lock().await;
2025-11-10T00:08:56.6309396Z          tokens.insert(token, user_id.clone());
2025-11-10T00:08:56.6309507Z -        
2025-11-10T00:08:56.6309618Z +
2025-11-10T00:08:56.6309789Z          // Initialize rate limiter for this user
2025-11-10T00:08:56.6310069Z          let (burst, rate) = self.get_rate_limit_for_user(&user_id).await;
2025-11-10T00:08:56.6310563Z          let mut limiters = self.rate_limiters.lock().await;
2025-11-10T00:08:56.6311006Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:161:
2025-11-10T00:08:56.6311297Z          limiters.insert(user_id, RpcRateLimiter::new(burst, rate));
2025-11-10T00:08:56.6311420Z -        
2025-11-10T00:08:56.6311529Z +
2025-11-10T00:08:56.6311657Z          Ok(())
2025-11-10T00:08:56.6311765Z      }
2025-11-10T00:08:56.6311872Z  
2025-11-10T00:08:56.6312303Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:178:
2025-11-10T00:08:56.6312556Z          let user_id = UserId::Certificate(fingerprint.clone());
2025-11-10T00:08:56.6314792Z          let mut certs = self.valid_certificates.lock().await;
2025-11-10T00:08:56.6314993Z          certs.insert(fingerprint, user_id.clone());
2025-11-10T00:08:56.6315119Z -        
2025-11-10T00:08:56.6315227Z +
2025-11-10T00:08:56.6315616Z          // Initialize rate limiter for this user
2025-11-10T00:08:56.6315895Z          let (burst, rate) = self.get_rate_limit_for_user(&user_id).await;
2025-11-10T00:08:56.6316105Z          let mut limiters = self.rate_limiters.lock().await;
2025-11-10T00:08:56.6316539Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:185:
2025-11-10T00:08:56.6316823Z          limiters.insert(user_id, RpcRateLimiter::new(burst, rate));
2025-11-10T00:08:56.6316944Z -        
2025-11-10T00:08:56.6317051Z +
2025-11-10T00:08:56.6317156Z          Ok(())
2025-11-10T00:08:56.6317259Z      }
2025-11-10T00:08:56.6317373Z  
2025-11-10T00:08:56.6317785Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:201:
2025-11-10T00:08:56.6318117Z      pub async fn set_user_rate_limit(&self, user_id: &UserId, burst: u32, rate: u32) {
2025-11-10T00:08:56.6318344Z          let mut limits = self.user_rate_limits.lock().await;
2025-11-10T00:08:56.6318542Z          limits.insert(user_id.clone(), (burst, rate));
2025-11-10T00:08:56.6318664Z -        
2025-11-10T00:08:56.6318777Z +
2025-11-10T00:08:56.6318958Z          // Update existing rate limiter if present
2025-11-10T00:08:56.6319166Z          let mut limiters = self.rate_limiters.lock().await;
2025-11-10T00:08:56.6319368Z          if let Some(limiter) = limiters.get_mut(user_id) {
2025-11-10T00:08:56.6319805Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:212:
2025-11-10T00:08:56.6320055Z      /// Get rate limit for a user (checks per-user limits first)
2025-11-10T00:08:56.6320354Z      async fn get_rate_limit_for_user(&self, user_id: &UserId) -> (u32, u32) {
2025-11-10T00:08:56.6320561Z          let limits = self.user_rate_limits.lock().await;
2025-11-10T00:08:56.6320840Z -        limits.get(user_id).copied().unwrap_or(self.default_rate_limit)
2025-11-10T00:08:56.6320955Z +        limits
2025-11-10T00:08:56.6321093Z +            .get(user_id)
2025-11-10T00:08:56.6321223Z +            .copied()
2025-11-10T00:08:56.6321383Z +            .unwrap_or(self.default_rate_limit)
2025-11-10T00:08:56.6321483Z      }
2025-11-10T00:08:56.6321597Z  
2025-11-10T00:08:56.6321772Z      /// Authenticate a request from HTTP headers
2025-11-10T00:08:56.6322197Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:283:
2025-11-10T00:08:56.6322354Z      /// Check rate limit for a user
2025-11-10T00:08:56.6322621Z      pub async fn check_rate_limit(&self, user_id: &UserId) -> bool {
2025-11-10T00:08:56.6322812Z          let mut limiters = self.rate_limiters.lock().await;
2025-11-10T00:08:56.6322915Z -        
2025-11-10T00:08:56.6323025Z +
2025-11-10T00:08:56.6323189Z          // Get or create rate limiter for this user
2025-11-10T00:08:56.6323471Z          let limiter = limiters.entry(user_id.clone()).or_insert_with(|| {
2025-11-10T00:08:56.6323661Z              let (burst, rate) = self.default_rate_limit;
2025-11-10T00:08:56.6324078Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:290:
2025-11-10T00:08:56.6324695Z              RpcRateLimiter::new(burst, rate)
2025-11-10T00:08:56.6324824Z          });
2025-11-10T00:08:56.6324936Z -        
2025-11-10T00:08:56.6325039Z +
2025-11-10T00:08:56.6325190Z          limiter.check_and_consume()
2025-11-10T00:08:56.6325299Z      }
2025-11-10T00:08:56.6325399Z  
2025-11-10T00:08:56.6325826Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:311:
2025-11-10T00:08:56.6326095Z          auth.add_token("test-token-123".to_string()).await.unwrap();
2025-11-10T00:08:56.6326200Z  
2025-11-10T00:08:56.6326379Z          let mut headers = hyper::HeaderMap::new();
2025-11-10T00:08:56.6326514Z -        headers.insert(
2025-11-10T00:08:56.6326656Z -            "authorization",
2025-11-10T00:08:56.6327513Z -            "***".parse().unwrap(),
2025-11-10T00:08:56.6327642Z -        );
2025-11-10T00:08:56.6328080Z +        headers.insert("authorization", "***".parse().unwrap());
2025-11-10T00:08:56.6328480Z  
2025-11-10T00:08:56.6328736Z          let addr: SocketAddr = "127.0.0.1:8080".parse().unwrap();
2025-11-10T00:08:56.6329001Z          let result = auth.authenticate_request(&headers, addr).await;
2025-11-10T00:08:56.6329432Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:329:
2025-11-10T00:08:56.6329675Z          auth.add_token("valid-token".to_string()).await.unwrap();
2025-11-10T00:08:56.6329794Z  
2025-11-10T00:08:56.6329986Z          let mut headers = hyper::HeaderMap::new();
2025-11-10T00:08:56.6330124Z -        headers.insert(
2025-11-10T00:08:56.6330272Z -            "authorization",
2025-11-10T00:08:56.6330513Z -            "***".parse().unwrap(),
2025-11-10T00:08:56.6330619Z -        );
2025-11-10T00:08:56.6330974Z +        headers.insert("authorization", "***".parse().unwrap());
2025-11-10T00:08:56.6331084Z  
2025-11-10T00:08:56.6333056Z          let addr: SocketAddr = "127.0.0.1:8080".parse().unwrap();
2025-11-10T00:08:56.6333324Z          let result = auth.authenticate_request(&headers, addr).await;
2025-11-10T00:08:56.6333747Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:368:
2025-11-10T00:08:56.6333896Z          assert!(result.error.is_none());
2025-11-10T00:08:56.6334015Z      }
2025-11-10T00:08:56.6334120Z  }
2025-11-10T00:08:56.6334225Z -
2025-11-10T00:08:56.6334506Z  
2025-11-10T00:08:56.6533488Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:30:
2025-11-10T00:08:56.6535859Z  
2025-11-10T00:08:56.6536017Z      /// Create with dependencies
2025-11-10T00:08:56.6536273Z      pub fn with_dependencies(storage: Arc<Storage>) -> Self {
2025-11-10T00:08:56.6536435Z -        Self { storage: Some(storage) }
2025-11-10T00:08:56.6536563Z +        Self {
2025-11-10T00:08:56.6536710Z +            storage: Some(storage),
2025-11-10T00:08:56.6536827Z +        }
2025-11-10T00:08:56.6536950Z      }
2025-11-10T00:08:56.6537060Z  
2025-11-10T00:08:56.6537307Z      /// Calculate difficulty from bits (compact target format)
2025-11-10T00:08:56.6538204Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:39:
2025-11-10T00:08:56.6538697Z          // MAX_TARGET for Bitcoin mainnet is 0x00000000FFFF0000000000000000000000000000000000000000000000000000
2025-11-10T00:08:56.6538989Z          // But we use a simpler calculation: difficulty = 2^256 / (target + 1)
2025-11-10T00:08:56.6539275Z          // For display purposes, we normalize to genesis difficulty = 1.0
2025-11-10T00:08:56.6539730Z -        const MAX_TARGET: u128 = 0x00000000FFFF0000000000000000000000000000000000000000000000000000u128;
2025-11-10T00:08:56.6539845Z -        
2025-11-10T00:08:56.6539990Z +        const MAX_TARGET: u128 =
2025-11-10T00:08:56.6540326Z +            0x00000000FFFF0000000000000000000000000000000000000000000000000000u128;
2025-11-10T00:08:56.6540438Z +
2025-11-10T00:08:56.6540603Z          // Simplified difficulty calculation
2025-11-10T00:08:56.6540897Z          // For display purposes, use a simple approximation based on bits
2025-11-10T00:08:56.6541343Z          if let Ok(_target) = expand_target(bits) {
2025-11-10T00:08:56.6541811Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:73:
2025-11-10T00:08:56.6542014Z      fn calculate_block_subsidy(height: u64) -> u64 {
2025-11-10T00:08:56.6542294Z          const INITIAL_SUBSIDY: u64 = 50_000_000_000; // 50 BTC in satoshis
2025-11-10T00:08:56.6542455Z          const HALVING_INTERVAL: u64 = 210_000;
2025-11-10T00:08:56.6542567Z -        
2025-11-10T00:08:56.6542686Z +
2025-11-10T00:08:56.6542859Z          let halvings = height / HALVING_INTERVAL;
2025-11-10T00:08:56.6542960Z -        
2025-11-10T00:08:56.6543065Z +
2025-11-10T00:08:56.6545284Z          // Subsidy halves each halving, but can't go below 0
2025-11-10T00:08:56.6545420Z          if halvings >= 64 {
2025-11-10T00:08:56.6545662Z              // After 64 halvings, subsidy is 0 (satoshi precision limit)
2025-11-10T00:08:56.6546337Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:82:
2025-11-10T00:08:56.6546461Z              return 0;
2025-11-10T00:08:56.6546569Z          }
2025-11-10T00:08:56.6546676Z -        
2025-11-10T00:08:56.6546786Z +
2025-11-10T00:08:56.6546923Z          INITIAL_SUBSIDY >> halvings
2025-11-10T00:08:56.6547022Z      }
2025-11-10T00:08:56.6547127Z  
2025-11-10T00:08:56.6547600Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:88:
2025-11-10T00:08:56.6547864Z      /// Calculate hash_serialized_2 for UTXO set (double SHA256)
2025-11-10T00:08:56.6547981Z -    /// 
2025-11-10T00:08:56.6548105Z +    ///
2025-11-10T00:08:56.6548442Z      /// Serializes UTXO set deterministically and computes double SHA256 hash.
2025-11-10T00:08:56.6548827Z      /// Matches Bitcoin Core's gettxoutsetinfo hash_serialized_2 calculation.
2025-11-10T00:08:56.6549207Z      fn calculate_utxo_set_hash(utxo_set: &bllvm_protocol::UtxoSet) -> [u8; 32] {
2025-11-10T00:08:56.6549690Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:93:
2025-11-10T00:08:56.6549855Z -        use sha2::{Sha256, Digest};
2025-11-10T00:08:56.6550055Z          use crate::storage::hashing::double_sha256;
2025-11-10T00:08:56.6550172Z -        
2025-11-10T00:08:56.6550318Z +        use sha2::{Digest, Sha256};
2025-11-10T00:08:56.6550426Z +
2025-11-10T00:08:56.6550791Z          // Sort UTXOs for deterministic hashing (by outpoint: hash first, then index)
2025-11-10T00:08:56.6551112Z          let mut entries: Vec<_> = utxo_set.iter().collect();
2025-11-10T00:08:56.6551274Z -        entries.sort_by(|(a, _), (b, _)| {
2025-11-10T00:08:56.6551437Z -            match a.hash.cmp(&b.hash) {
2025-11-10T00:08:56.6551665Z -                std::cmp::Ordering::Equal => a.index.cmp(&b.index),
2025-11-10T00:08:56.6551797Z -                other => other,
2025-11-10T00:08:56.6551921Z -            }
2025-11-10T00:08:56.6552175Z +        entries.sort_by(|(a, _), (b, _)| match a.hash.cmp(&b.hash) {
2025-11-10T00:08:56.6552411Z +            std::cmp::Ordering::Equal => a.index.cmp(&b.index),
2025-11-10T00:08:56.6552541Z +            other => other,
2025-11-10T00:08:56.6552662Z          });
2025-11-10T00:08:56.6552773Z -        
2025-11-10T00:08:56.6552880Z +
2025-11-10T00:08:56.6553034Z          // Serialize each UTXO entry
2025-11-10T00:08:56.6553188Z          let mut serialized = Vec::new();
2025-11-10T00:08:56.6553348Z          for (outpoint, utxo) in entries {
2025-11-10T00:08:56.6553828Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:108:
2025-11-10T00:08:56.6554143Z              // Serialize outpoint (32-byte hash + 8-byte index, little-endian)
2025-11-10T00:08:56.6554543Z              serialized.extend_from_slice(&outpoint.hash);
2025-11-10T00:08:56.6554841Z              serialized.extend_from_slice(&outpoint.index.to_le_bytes());
2025-11-10T00:08:56.6554964Z -            
2025-11-10T00:08:56.6555073Z +
2025-11-10T00:08:56.6555435Z              // Serialize UTXO (8-byte value + script_pubkey + 8-byte height, little-endian)
2025-11-10T00:08:56.6555956Z              serialized.extend_from_slice(&utxo.value.to_le_bytes());
2025-11-10T00:08:56.6556197Z              serialized.extend_from_slice(&utxo.script_pubkey);
2025-11-10T00:08:56.6556676Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:115:
2025-11-10T00:08:56.6556932Z              serialized.extend_from_slice(&utxo.height.to_le_bytes());
2025-11-10T00:08:56.6557059Z          }
2025-11-10T00:08:56.6557172Z -        
2025-11-10T00:08:56.6557282Z +
2025-11-10T00:08:56.6557430Z          // Double SHA256 hash
2025-11-10T00:08:56.6557578Z          double_sha256(&serialized)
2025-11-10T00:08:56.6557688Z      }
2025-11-10T00:08:56.6558157Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:121:
2025-11-10T00:08:56.6558276Z -    
2025-11-10T00:08:56.6558383Z +
2025-11-10T00:08:56.6558791Z      /// Calculate confirmations for a block
2025-11-10T00:08:56.6559135Z      fn calculate_confirmations(block_height: u64, tip_height: u64) -> i64 {
2025-11-10T00:08:56.6559288Z          if block_height > tip_height {
2025-11-10T00:08:56.6559762Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:222:
2025-11-10T00:08:56.6559874Z              }))
2025-11-10T00:08:56.6559987Z          } else {
2025-11-10T00:08:56.6560320Z              // Graceful degradation: return default values when storage unavailable
2025-11-10T00:08:56.6560824Z -            tracing::debug!("getblockchaininfo called but storage not available, returning default values");
2025-11-10T00:08:56.6560965Z +            tracing::debug!(
2025-11-10T00:08:56.6561354Z +                "getblockchaininfo called but storage not available, returning default values"
2025-11-10T00:08:56.6561475Z +            );
2025-11-10T00:08:56.6561595Z              Ok(json!({
2025-11-10T00:08:56.6561727Z                  "chain": "main",
2025-11-10T00:08:56.6561866Z                  "blocks": 0,
2025-11-10T00:08:56.6562329Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:311:
2025-11-10T00:08:56.6562573Z          debug!("RPC: getblockheader {} verbose={}", hash, verbose);
2025-11-10T00:08:56.6562683Z  
2025-11-10T00:08:56.6562866Z          if let Some(ref storage) = self.storage {
2025-11-10T00:08:56.6563039Z -            let hash_bytes = hex::decode(hash)
2025-11-10T00:08:56.6563265Z -                .map_err(|e| anyhow::anyhow!("Invalid hash: {}", e))?;
2025-11-10T00:08:56.6563402Z +            let hash_bytes =
2025-11-10T00:08:56.6563693Z +                hex::decode(hash).map_err(|e| anyhow::anyhow!("Invalid hash: {}", e))?;
2025-11-10T00:08:56.6563832Z              if hash_bytes.len() != 32 {
2025-11-10T00:08:56.6564051Z                  return Err(anyhow::anyhow!("Invalid hash length"));
2025-11-10T00:08:56.6564158Z              }
2025-11-10T00:08:56.6564798Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:319:
2025-11-10T00:08:56.6564972Z              let mut hash_array = [0u8; 32];
2025-11-10T00:08:56.6565158Z              hash_array.copy_from_slice(&hash_bytes);
2025-11-10T00:08:56.6565264Z -            
2025-11-10T00:08:56.6565366Z +
2025-11-10T00:08:56.6565637Z              if let Ok(Some(header)) = storage.blocks().get_header(&hash_array) {
2025-11-10T00:08:56.6565763Z                  if verbose {
2025-11-10T00:08:56.6567953Z                      // Find block height by searching height index
2025-11-10T00:08:56.6568403Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:360:
2025-11-10T00:08:56.6568513Z  
2025-11-10T00:08:56.6568654Z                      // Find next block hash
2025-11-10T00:08:56.6568856Z                      let next_blockhash = block_height.and_then(|h| {
2025-11-10T00:08:56.6569005Z -                        storage.blocks()
2025-11-10T00:08:56.6569125Z +                        storage
2025-11-10T00:08:56.6569408Z +                            .blocks()
2025-11-10T00:08:56.6569810Z                              .get_hash_by_height(h + 1)
2025-11-10T00:08:56.6569936Z                              .ok()
2025-11-10T00:08:56.6570065Z                              .flatten()
2025-11-10T00:08:56.6570526Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:380:
2025-11-10T00:08:56.6570649Z                          }
2025-11-10T00:08:56.6570816Z                          Self::format_chainwork(total_work)
2025-11-10T00:08:56.6570926Z                      } else {
2025-11-10T00:08:56.6571286Z -                        "0000000000000000000000000000000000000000000000000000000000000000".to_string()
2025-11-10T00:08:56.6571564Z +                        "0000000000000000000000000000000000000000000000000000000000000000"
2025-11-10T00:08:56.6571699Z +                            .to_string()
2025-11-10T00:08:56.6571820Z                      };
2025-11-10T00:08:56.6572108Z  
2025-11-10T00:08:56.6572220Z                      Ok(json!({
2025-11-10T00:08:56.6572903Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:443:
2025-11-10T00:08:56.6573130Z              if let Ok(Some(hash)) = storage.chain().get_tip_hash() {
2025-11-10T00:08:56.6573273Z                  Ok(json!(hex::encode(hash)))
2025-11-10T00:08:56.6573374Z              } else {
2025-11-10T00:08:56.6573690Z -                Ok(json!("0000000000000000000000000000000000000000000000000000000000000000"))
2025-11-10T00:08:56.6573814Z +                Ok(json!(
2025-11-10T00:08:56.6574063Z +                    "0000000000000000000000000000000000000000000000000000000000000000"
2025-11-10T00:08:56.6574172Z +                ))
2025-11-10T00:08:56.6574273Z              }
2025-11-10T00:08:56.6574543Z          } else {
2025-11-10T00:08:56.6574834Z -            Ok(json!("0000000000000000000000000000000000000000000000000000000000000000"))
2025-11-10T00:08:56.6574948Z +            Ok(json!(
2025-11-10T00:08:56.6575206Z +                "0000000000000000000000000000000000000000000000000000000000000000"
2025-11-10T00:08:56.6577186Z +            ))
2025-11-10T00:08:56.6577291Z          }
2025-11-10T00:08:56.6577386Z      }
2025-11-10T00:08:56.6577480Z  
2025-11-10T00:08:56.6577911Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:494:
2025-11-10T00:08:56.6578090Z              let utxos = storage.utxos().get_all_utxos()?;
2025-11-10T00:08:56.6578221Z              let txouts = utxos.len();
2025-11-10T00:08:56.6578522Z              let total_amount: u64 = utxos.values().map(|utxo| utxo.value as u64).sum();
2025-11-10T00:08:56.6578644Z -            
2025-11-10T00:08:56.6578749Z +
2025-11-10T00:08:56.6579054Z              // Calculate hash_serialized_2 (double SHA256 of serialized UTXO set)
2025-11-10T00:08:56.6579340Z              let hash_serialized_2 = Self::calculate_utxo_set_hash(&utxos);
2025-11-10T00:08:56.6579450Z  
2025-11-10T00:08:56.6579923Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:540:
2025-11-10T00:08:56.6580274Z              // Use protocol engine which provides the correct validate_block signature
2025-11-10T00:08:56.6580594Z              let engine = BitcoinProtocolEngine::new(ProtocolVersion::Regtest)
2025-11-10T00:08:56.6580914Z                  .map_err(|e| anyhow::anyhow!("Failed to create protocol engine: {}", e))?;
2025-11-10T00:08:56.6581027Z -            
2025-11-10T00:08:56.6581142Z +
2025-11-10T00:08:56.6581325Z              let check_level = checklevel.unwrap_or(3);
2025-11-10T00:08:56.6581503Z              let num_blocks = numblocks.unwrap_or(288);
2025-11-10T00:08:56.6581621Z -            
2025-11-10T00:08:56.6581729Z +
2025-11-10T00:08:56.6581972Z              let tip_height = storage.chain().get_height()?.unwrap_or(0);
2025-11-10T00:08:56.6582108Z              if tip_height == 0 {
2025-11-10T00:08:56.6582304Z                  return Ok(json!(true)); // Empty chain is valid
2025-11-10T00:08:56.6582775Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:557:
2025-11-10T00:08:56.6583122Z              };
2025-11-10T00:08:56.6583237Z  
2025-11-10T00:08:56.6583391Z              let mut errors = Vec::new();
2025-11-10T00:08:56.6583601Z -            let mut utxo_set = storage.utxos().get_all_utxos()
2025-11-10T00:08:56.6583744Z +            let mut utxo_set = storage
2025-11-10T00:08:56.6583873Z +                .utxos()
2025-11-10T00:08:56.6584000Z +                .get_all_utxos()
2025-11-10T00:08:56.6584258Z                  .map_err(|e| anyhow::anyhow!("Failed to get UTXO set: {}", e))?;
2025-11-10T00:08:56.6584580Z  
2025-11-10T00:08:56.6586727Z              // Verify blocks from start_height to tip
2025-11-10T00:08:56.6587201Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:572:
2025-11-10T00:08:56.6587372Z                                  // For now, just continue
2025-11-10T00:08:56.6587497Z                              }
2025-11-10T00:08:56.6588020Z                              Ok(bllvm_protocol::ValidationResult::Invalid(reason)) => {
2025-11-10T00:08:56.6588351Z -                                errors.push(format!("Block at height {} invalid: {}", height, reason));
2025-11-10T00:08:56.6588527Z +                                errors.push(format!(
2025-11-10T00:08:56.6588704Z +                                    "Block at height {} invalid: {}",
2025-11-10T00:08:56.6588848Z +                                    height, reason
2025-11-10T00:08:56.6588982Z +                                ));
2025-11-10T00:08:56.6589140Z                                  if check_level >= 4 {
2025-11-10T00:08:56.6589318Z                                      // Level 4: Stop on first error
2025-11-10T00:08:56.6589463Z                                      break;
2025-11-10T00:08:56.6590368Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:579:
2025-11-10T00:08:56.6590507Z                                  }
2025-11-10T00:08:56.6590651Z                              }
2025-11-10T00:08:56.6590784Z                              Err(e) => {
2025-11-10T00:08:56.6591142Z -                                errors.push(format!("Block at height {} validation error: {}", height, e));
2025-11-10T00:08:56.6591310Z +                                errors.push(format!(
2025-11-10T00:08:56.6591514Z +                                    "Block at height {} validation error: {}",
2025-11-10T00:08:56.6591655Z +                                    height, e
2025-11-10T00:08:56.6591777Z +                                ));
2025-11-10T00:08:56.6591939Z                                  if check_level >= 4 {
2025-11-10T00:08:56.6592069Z                                      break;
2025-11-10T00:08:56.6592191Z                                  }
2025-11-10T00:08:56.6592651Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:588:
2025-11-10T00:08:56.6592765Z  
2025-11-10T00:08:56.6592956Z                          // Check level 3: Verify block header linkage
2025-11-10T00:08:56.6593118Z                          if check_level >= 3 && height > 0 {
2025-11-10T00:08:56.6593460Z -                            if let Ok(Some(prev_hash)) = storage.blocks().get_hash_by_height(height - 1) {
2025-11-10T00:08:56.6593614Z +                            if let Ok(Some(prev_hash)) =
2025-11-10T00:08:56.6593823Z +                                storage.blocks().get_hash_by_height(height - 1)
2025-11-10T00:08:56.6593943Z +                            {
2025-11-10T00:08:56.6594140Z                                  if block.header.prev_block_hash != prev_hash {
2025-11-10T00:08:56.6594288Z                                      errors.push(format!(
2025-11-10T00:08:56.6594788Z                                          "Block at height {} has incorrect prev_block_hash: expected {}, got {}",
2025-11-10T00:08:56.6595241Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:606:
2025-11-10T00:08:56.6595423Z                          // Check level 2: Verify merkle root
2025-11-10T00:08:56.6595790Z                          if check_level >= 2 {
2025-11-10T00:08:56.6596023Z                              use bllvm_protocol::mining::calculate_merkle_root;
2025-11-10T00:08:56.6596345Z -                            if let Ok(calculated_root) = calculate_merkle_root(&block.transactions) {
2025-11-10T00:08:56.6596646Z +                            if let Ok(calculated_root) = calculate_merkle_root(&block.transactions)
2025-11-10T00:08:56.6596770Z +                            {
2025-11-10T00:08:56.6596977Z                                  if calculated_root != block.header.merkle_root {
2025-11-10T00:08:56.6597136Z                                      errors.push(format!(
2025-11-10T00:08:56.6597351Z                                          "Block at height {} has incorrect merkle root",
2025-11-10T00:08:56.6597800Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:657:
2025-11-10T00:08:56.6598160Z          if let Some(ref storage) = self.storage {
2025-11-10T00:08:56.6598333Z              // Get all chain tips (including forks)
2025-11-10T00:08:56.6598474Z              let mut tips = Vec::new();
2025-11-10T00:08:56.6598579Z -            
2025-11-10T00:08:56.6598681Z +
2025-11-10T00:08:56.6598813Z              // Add active tip
2025-11-10T00:08:56.6599054Z              if let Ok(Some(tip_hash)) = storage.chain().get_tip_hash() {
2025-11-10T00:08:56.6599319Z                  let tip_height = storage.chain().get_height()?.unwrap_or(0);
2025-11-10T00:08:56.6599787Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:668:
2025-11-10T00:08:56.6599923Z                      "status": "active"
2025-11-10T00:08:56.6600038Z                  }));
2025-11-10T00:08:56.6600149Z              }
2025-11-10T00:08:56.6600267Z -            
2025-11-10T00:08:56.6600365Z +
2025-11-10T00:08:56.6600517Z              // Add other tracked tips (forks, etc.)
2025-11-10T00:08:56.6600752Z              if let Ok(chain_tips) = storage.chain().get_chain_tips() {
2025-11-10T00:08:56.6600968Z                  for (hash, height, branchlen, status) in chain_tips {
2025-11-10T00:08:56.6601415Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:678:
2025-11-10T00:08:56.6601563Z                              continue;
2025-11-10T00:08:56.6601686Z                          }
2025-11-10T00:08:56.6601802Z                      }
2025-11-10T00:08:56.6601914Z -                    
2025-11-10T00:08:56.6602031Z +
2025-11-10T00:08:56.6602173Z                      tips.push(json!({
2025-11-10T00:08:56.6602313Z                          "height": height,
2025-11-10T00:08:56.6602485Z                          "hash": hex::encode(hash),
2025-11-10T00:08:56.6602951Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:687:
2025-11-10T00:08:56.6603071Z                      }));
2025-11-10T00:08:56.6603197Z                  }
2025-11-10T00:08:56.6603321Z              }
2025-11-10T00:08:56.6603429Z -            
2025-11-10T00:08:56.6603534Z +
2025-11-10T00:08:56.6605685Z              Ok(json!(tips))
2025-11-10T00:08:56.6605805Z          } else {
2025-11-10T00:08:56.6605934Z              Ok(json!([]))
2025-11-10T00:08:56.6606401Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:700:
2025-11-10T00:08:56.6606728Z      pub async fn get_chain_tx_stats(&self, params: &Value) -> Result<Value> {
2025-11-10T00:08:56.6606888Z          debug!("RPC: getchaintxstats");
2025-11-10T00:08:56.6606994Z  
2025-11-10T00:08:56.6607143Z -        let nblocks = params
2025-11-10T00:08:56.6607263Z -            .get(0)
2025-11-10T00:08:56.6607412Z -            .and_then(|p| p.as_u64())
2025-11-10T00:08:56.6607659Z -            .unwrap_or(144); // Default: 1 day (144 blocks at 10 min/block)
2025-11-10T00:08:56.6608154Z +        let nblocks = params.get(0).and_then(|p| p.as_u64()).unwrap_or(144); // Default: 1 day (144 blocks at 10 min/block)
2025-11-10T00:08:56.6608528Z  
2025-11-10T00:08:56.6608711Z          if let Some(ref storage) = self.storage {
2025-11-10T00:08:56.6608977Z              let tip_height = storage.chain().get_height()?.unwrap_or(0);
2025-11-10T00:08:56.6609448Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:710:
2025-11-10T00:08:56.6609563Z -            
2025-11-10T00:08:56.6609681Z +
2025-11-10T00:08:56.6609816Z              if tip_height == 0 {
2025-11-10T00:08:56.6609948Z                  return Ok(json!({
2025-11-10T00:08:56.6610076Z                      "time": 0,
2025-11-10T00:08:56.6610544Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:729:
2025-11-10T00:08:56.6610723Z              // Get timestamps and transaction counts
2025-11-10T00:08:56.6610897Z              let mut timestamps = Vec::new();
2025-11-10T00:08:56.6611058Z              let mut tx_counts = Vec::new();
2025-11-10T00:08:56.6611415Z -            
2025-11-10T00:08:56.6611533Z +
2025-11-10T00:08:56.6611730Z              for height in start_height..=tip_height {
2025-11-10T00:08:56.6612020Z                  if let Ok(Some(hash)) = storage.blocks().get_hash_by_height(height) {
2025-11-10T00:08:56.6612265Z                      if let Ok(Some(block)) = storage.blocks().get_block(&hash) {
2025-11-10T00:08:56.6612736Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:756:
2025-11-10T00:08:56.6613073Z              let window_interval = last_timestamp.saturating_sub(first_timestamp);
2025-11-10T00:08:56.6613283Z              let window_tx_count: u64 = tx_counts.iter().sum();
2025-11-10T00:08:56.6613488Z              let window_block_count = timestamps.len() as u64;
2025-11-10T00:08:56.6613599Z -            
2025-11-10T00:08:56.6613698Z +
2025-11-10T00:08:56.6613851Z              let txrate = if window_interval > 0 {
2025-11-10T00:08:56.6614048Z                  window_tx_count as f64 / window_interval as f64
2025-11-10T00:08:56.6614164Z              } else {
2025-11-10T00:08:56.6614798Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:794:
2025-11-10T00:08:56.6615093Z      pub async fn get_block_stats(&self, params: &Value) -> Result<Value> {
2025-11-10T00:08:56.6615251Z          debug!("RPC: getblockstats");
2025-11-10T00:08:56.6615352Z  
2025-11-10T00:08:56.6615558Z -        let hash_or_height: Option<String> = params.get(0)
2025-11-10T00:08:56.6615745Z +        let hash_or_height: Option<String> = params
2025-11-10T00:08:56.6615853Z +            .get(0)
2025-11-10T00:08:56.6615989Z              .and_then(|p| p.as_str())
2025-11-10T00:08:56.6616118Z              .map(|s| s.to_string())
2025-11-10T00:08:56.6616244Z              .or_else(|| {
2025-11-10T00:08:56.6616731Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:801:
2025-11-10T00:08:56.6616872Z -                params.get(0)
2025-11-10T00:08:56.6617005Z +                params
2025-11-10T00:08:56.6617144Z +                    .get(0)
2025-11-10T00:08:56.6617298Z                      .and_then(|p| p.as_u64())
2025-11-10T00:08:56.6617445Z                      .map(|h| h.to_string())
2025-11-10T00:08:56.6617560Z              });
2025-11-10T00:08:56.6618031Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:808:
2025-11-10T00:08:56.6618259Z              let block_hash = if let Some(hoh) = hash_or_height {
2025-11-10T00:08:56.6618840Z                  // Try to parse as height first
2025-11-10T00:08:56.6619054Z                  if let Ok(height) = hoh.parse::<u64>() {
2025-11-10T00:08:56.6619244Z -                    storage.blocks().get_hash_by_height(height)?
2025-11-10T00:08:56.6619365Z +                    storage
2025-11-10T00:08:56.6619486Z +                        .blocks()
2025-11-10T00:08:56.6619639Z +                        .get_hash_by_height(height)?
2025-11-10T00:08:56.6619953Z                          .ok_or_else(|| anyhow::anyhow!("Block at height {} not found", height))?
2025-11-10T00:08:56.6620341Z                  } else {
2025-11-10T00:08:56.6620481Z                      // Parse as hash
2025-11-10T00:08:56.6620928Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:823:
2025-11-10T00:08:56.6621039Z                  }
2025-11-10T00:08:56.6621141Z              } else {
2025-11-10T00:08:56.6621262Z                  // Default to tip
2025-11-10T00:08:56.6621414Z -                storage.chain().get_tip_hash()?
2025-11-10T00:08:56.6621520Z +                storage
2025-11-10T00:08:56.6621634Z +                    .chain()
2025-11-10T00:08:56.6621768Z +                    .get_tip_hash()?
2025-11-10T00:08:56.6622016Z                      .ok_or_else(|| anyhow::anyhow!("Chain not initialized"))?
2025-11-10T00:08:56.6622132Z              };
2025-11-10T00:08:56.6622241Z  
2025-11-10T00:08:56.6622722Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:831:
2025-11-10T00:08:56.6623149Z                  let tx_count = block.transactions.len();
2025-11-10T00:08:56.6623378Z                  let block_size = bincode::serialize(&block)?.len();
2025-11-10T00:08:56.6623730Z                  let block_weight = block_size; // Simplified - would calculate weight properly
2025-11-10T00:08:56.6623842Z -                
2025-11-10T00:08:56.6623944Z +
2025-11-10T00:08:56.6624071Z                  // Get block height
2025-11-10T00:08:56.6624585Z -                let height = storage.blocks().get_height_by_hash(&block_hash)?
2025-11-10T00:08:56.6624716Z +                let height = storage
2025-11-10T00:08:56.6624826Z +                    .blocks()
2025-11-10T00:08:56.6624989Z +                    .get_height_by_hash(&block_hash)?
2025-11-10T00:08:56.6625118Z                      .unwrap_or(0);
2025-11-10T00:08:56.6625223Z -                
2025-11-10T00:08:56.6625326Z +
2025-11-10T00:08:56.6625481Z                  // Count inputs and outputs
2025-11-10T00:08:56.6625718Z -                let input_count: usize = block.transactions.iter()
2025-11-10T00:08:56.6625874Z -                    .map(|tx| tx.inputs.len())
2025-11-10T00:08:56.6625995Z -                    .sum();
2025-11-10T00:08:56.6626200Z -                let output_count: usize = block.transactions.iter()
2025-11-10T00:08:56.6626337Z -                    .map(|tx| tx.outputs.len())
2025-11-10T00:08:56.6626447Z -                    .sum();
2025-11-10T00:08:56.6626553Z -                
2025-11-10T00:08:56.6626938Z +                let input_count: usize = block.transactions.iter().map(|tx| tx.inputs.len()).sum();
2025-11-10T00:08:56.6627076Z +                let output_count: usize =
2025-11-10T00:08:56.6627337Z +                    block.transactions.iter().map(|tx| tx.outputs.len()).sum();
2025-11-10T00:08:56.6627433Z +
2025-11-10T00:08:56.6627556Z                  // Sum output values
2025-11-10T00:08:56.6627745Z -                let total_out: u64 = block.transactions.iter()
2025-11-10T00:08:56.6627883Z +                let total_out: u64 = block
2025-11-10T00:08:56.6628004Z +                    .transactions
2025-11-10T00:08:56.6628109Z +                    .iter()
2025-11-10T00:08:56.6628278Z                      .flat_map(|tx| tx.outputs.iter())
2025-11-10T00:08:56.6628431Z                      .map(|out| out.value as u64)
2025-11-10T00:08:56.6628569Z                      .sum::<u64>();
2025-11-10T00:08:56.6629043Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:852:
2025-11-10T00:08:56.6629155Z -                
2025-11-10T00:08:56.6629255Z +
2025-11-10T00:08:56.6629396Z                  // Calculate block subsidy
2025-11-10T00:08:56.6629626Z                  let subsidy = Self::calculate_block_subsidy(height);
2025-11-10T00:08:56.6629731Z -                
2025-11-10T00:08:56.6629830Z +
2025-11-10T00:08:56.6630196Z                  // Calculate total fees (simplified - would need UTXO set for accurate calculation)
2025-11-10T00:08:56.6630474Z                  // For now, estimate: total_out - (subsidy * 100_000_000) if coinbase exists
2025-11-10T00:08:56.6630934Z                  let total_fees = if !block.transactions.is_empty() {
2025-11-10T00:08:56.6631370Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:859:
2025-11-10T00:08:56.6631530Z                      // Coinbase is first transaction
2025-11-10T00:08:56.6631813Z -                    let coinbase_outputs: u64 = block.transactions[0].outputs.iter()
2025-11-10T00:08:56.6632029Z +                    let coinbase_outputs: u64 = block.transactions[0]
2025-11-10T00:08:56.6632152Z +                        .outputs
2025-11-10T00:08:56.6632277Z +                        .iter()
2025-11-10T00:08:56.6632423Z                          .map(|out| out.value as u64)
2025-11-10T00:08:56.6632536Z                          .sum();
2025-11-10T00:08:56.6632778Z                      // Fee = total outputs - (coinbase outputs which include subsidy)
2025-11-10T00:08:56.6633196Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:903:
2025-11-10T00:08:56.6633508Z              }
2025-11-10T00:08:56.6633609Z          } else {
2025-11-10T00:08:56.6633938Z              // Graceful degradation: return informative error instead of failing silently
2025-11-10T00:08:56.6634546Z -            Err(anyhow::anyhow!("Storage not available. This operation requires storage to be initialized."))
2025-11-10T00:08:56.6634678Z +            Err(anyhow::anyhow!(
2025-11-10T00:08:56.6635015Z +                "Storage not available. This operation requires storage to be initialized."
2025-11-10T00:08:56.6635127Z +            ))
2025-11-10T00:08:56.6635249Z          }
2025-11-10T00:08:56.6635360Z      }
2025-11-10T00:08:56.6635469Z  
2025-11-10T00:08:56.6635955Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:913:
2025-11-10T00:08:56.6636278Z      pub async fn prune_blockchain(&self, params: &Value) -> Result<Value> {
2025-11-10T00:08:56.6636447Z          debug!("RPC: pruneblockchain");
2025-11-10T00:08:56.6636555Z  
2025-11-10T00:08:56.6636697Z -        let height = params.get(0)
2025-11-10T00:08:56.6636822Z +        let height = params
2025-11-10T00:08:56.6636934Z +            .get(0)
2025-11-10T00:08:56.6637092Z              .and_then(|p| p.as_u64())
2025-11-10T00:08:56.6637350Z              .ok_or_else(|| anyhow::anyhow!("Height parameter required"))?;
2025-11-10T00:08:56.6637448Z  
2025-11-10T00:08:56.6637887Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:920:
2025-11-10T00:08:56.6638067Z          if let Some(ref storage) = self.storage {
2025-11-10T00:08:56.6638324Z              let tip_height = storage.chain().get_height()?.unwrap_or(0);
2025-11-10T00:08:56.6638440Z -            
2025-11-10T00:08:56.6638558Z +
2025-11-10T00:08:56.6638848Z              // Check if IBD is in progress (height == 0 indicates no blocks synced)
2025-11-10T00:08:56.6638997Z              let is_ibd = tip_height == 0;
2025-11-10T00:08:56.6639120Z -            
2025-11-10T00:08:56.6639232Z +
2025-11-10T00:08:56.6639371Z              if height >= tip_height {
2025-11-10T00:08:56.6639830Z -                return Err(anyhow::anyhow!("Cannot prune to height >= tip height ({} >= {})", height, tip_height));
2025-11-10T00:08:56.6639998Z +                return Err(anyhow::anyhow!(
2025-11-10T00:08:56.6640216Z +                    "Cannot prune to height >= tip height ({} >= {})",
2025-11-10T00:08:56.6640334Z +                    height,
2025-11-10T00:08:56.6640470Z +                    tip_height
2025-11-10T00:08:56.6640576Z +                ));
2025-11-10T00:08:56.6640682Z              }
2025-11-10T00:08:56.6640789Z  
2025-11-10T00:08:56.6640936Z              // Get pruning manager
2025-11-10T00:08:56.6641394Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:931:
2025-11-10T00:08:56.6641617Z              if let Some(pruning_manager) = storage.pruning() {
2025-11-10T00:08:56.6641764Z                  // Perform pruning
2025-11-10T00:08:56.6642345Z                  let stats = pruning_manager.prune_to_height(height, tip_height, is_ibd)?;
2025-11-10T00:08:56.6642462Z -                
2025-11-10T00:08:56.6642576Z +
2025-11-10T00:08:56.6642746Z                  // Flush storage to persist changes
2025-11-10T00:08:56.6642884Z                  storage.flush()?;
2025-11-10T00:08:56.6642994Z -                
2025-11-10T00:08:56.6643102Z +
2025-11-10T00:08:56.6643217Z                  Ok(json!({
2025-11-10T00:08:56.6643377Z                      "pruned_height": height,
2025-11-10T00:08:56.6643559Z                      "blocks_pruned": stats.blocks_pruned,
2025-11-10T00:08:56.6644028Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:943:
2025-11-10T00:08:56.6644220Z                      "storage_freed_bytes": stats.storage_freed,
2025-11-10T00:08:56.6644505Z                  }))
2025-11-10T00:08:56.6644631Z              } else {
2025-11-10T00:08:56.6645277Z -                Err(anyhow::anyhow!("Pruning is not enabled. Configure pruning in node configuration."))
2025-11-10T00:08:56.6645426Z +                Err(anyhow::anyhow!(
2025-11-10T00:08:56.6645740Z +                    "Pruning is not enabled. Configure pruning in node configuration."
2025-11-10T00:08:56.6645849Z +                ))
2025-11-10T00:08:56.6645950Z              }
2025-11-10T00:08:56.6646060Z          } else {
2025-11-10T00:08:56.6646418Z              // Graceful degradation: return informative error instead of failing silently
2025-11-10T00:08:56.6646888Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:950:
2025-11-10T00:08:56.6647369Z -            Err(anyhow::anyhow!("Storage not available. This operation requires storage to be initialized."))
2025-11-10T00:08:56.6647522Z +            Err(anyhow::anyhow!(
2025-11-10T00:08:56.6647869Z +                "Storage not available. This operation requires storage to be initialized."
2025-11-10T00:08:56.6647988Z +            ))
2025-11-10T00:08:56.6648112Z          }
2025-11-10T00:08:56.6648214Z      }
2025-11-10T00:08:56.6648315Z  
2025-11-10T00:08:56.6648759Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:960:
2025-11-10T00:08:56.6648925Z          if let Some(ref storage) = self.storage {
2025-11-10T00:08:56.6649169Z              let tip_height = storage.chain().get_height()?.unwrap_or(0);
2025-11-10T00:08:56.6649389Z              let is_pruning_enabled = storage.is_pruning_enabled();
2025-11-10T00:08:56.6649501Z -            
2025-11-10T00:08:56.6649601Z +
2025-11-10T00:08:56.6649808Z              if let Some(pruning_manager) = storage.pruning() {
2025-11-10T00:08:56.6649989Z                  let stats = pruning_manager.get_stats();
2025-11-10T00:08:56.6650149Z                  let config = &pruning_manager.config;
2025-11-10T00:08:56.6650569Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:967:
2025-11-10T00:08:56.6650683Z -                
2025-11-10T00:08:56.6650799Z +
2025-11-10T00:08:56.6650942Z                  // Determine pruning mode
2025-11-10T00:08:56.6651098Z                  let mode_str = match &config.mode {
2025-11-10T00:08:56.6651314Z                      crate::config::PruningMode::Disabled => "disabled",
2025-11-10T00:08:56.6651733Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:975:
2025-11-10T00:08:56.6651969Z                      _ => "unknown", // Fallback for Aggressive if feature not enabled
2025-11-10T00:08:56.6652184Z                      crate::config::PruningMode::Custom { .. } => "custom",
2025-11-10T00:08:56.6652283Z                  };
2025-11-10T00:08:56.6652382Z -                
2025-11-10T00:08:56.6652482Z +
2025-11-10T00:08:56.6652601Z                  Ok(json!({
2025-11-10T00:08:56.6652756Z                      "pruning_enabled": is_pruning_enabled,
2025-11-10T00:08:56.6652876Z                      "mode": mode_str,
2025-11-10T00:08:56.6653313Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1013:
2025-11-10T00:08:56.6653812Z      pub async fn invalidate_block(&self, params: &Value) -> Result<Value> {
2025-11-10T00:08:56.6653972Z          debug!("RPC: invalidateblock");
2025-11-10T00:08:56.6654084Z  
2025-11-10T00:08:56.6654246Z -        let blockhash = params.get(0)
2025-11-10T00:08:56.6654563Z +        let blockhash = params
2025-11-10T00:08:56.6654678Z +            .get(0)
2025-11-10T00:08:56.6654811Z              .and_then(|p| p.as_str())
2025-11-10T00:08:56.6655063Z              .ok_or_else(|| anyhow::anyhow!("Block hash parameter required"))?;
2025-11-10T00:08:56.6655159Z  
2025-11-10T00:08:56.6655595Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1020:
2025-11-10T00:08:56.6655749Z -        let hash_bytes = hex::decode(blockhash)
2025-11-10T00:08:56.6655971Z -            .map_err(|e| anyhow::anyhow!("Invalid block hash: {}", e))?;
2025-11-10T00:08:56.6656283Z +        let hash_bytes =
2025-11-10T00:08:56.6656655Z +            hex::decode(blockhash).map_err(|e| anyhow::anyhow!("Invalid block hash: {}", e))?;
2025-11-10T00:08:56.6656786Z          if hash_bytes.len() != 32 {
2025-11-10T00:08:56.6657016Z              return Err(anyhow::anyhow!("Block hash must be 32 bytes"));
2025-11-10T00:08:56.6657121Z          }
2025-11-10T00:08:56.6657547Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1028:
2025-11-10T00:08:56.6657706Z          if let Some(ref storage) = self.storage {
2025-11-10T00:08:56.6657835Z              // Mark block as invalid
2025-11-10T00:08:56.6657978Z              storage.chain().mark_invalid(&hash)?;
2025-11-10T00:08:56.6658076Z -            
2025-11-10T00:08:56.6658173Z +
2025-11-10T00:08:56.6658449Z              // Check if this is the current tip - if so, we'd need to trigger a reorg
2025-11-10T00:08:56.6658756Z              // For now, we just mark it as invalid and let the node handle it on next block
2025-11-10T00:08:56.6659013Z              if let Ok(Some(tip_hash)) = storage.chain().get_tip_hash() {
2025-11-10T00:08:56.6659509Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1040:
2025-11-10T00:08:56.6659642Z              Ok(json!(null))
2025-11-10T00:08:56.6659751Z          } else {
2025-11-10T00:08:56.6660111Z              // Graceful degradation: return informative error instead of failing silently
2025-11-10T00:08:56.6660597Z -            Err(anyhow::anyhow!("Storage not available. This operation requires storage to be initialized."))
2025-11-10T00:08:56.6660739Z +            Err(anyhow::anyhow!(
2025-11-10T00:08:56.6661088Z +                "Storage not available. This operation requires storage to be initialized."
2025-11-10T00:08:56.6661210Z +            ))
2025-11-10T00:08:56.6661313Z          }
2025-11-10T00:08:56.6661417Z      }
2025-11-10T00:08:56.6661530Z  
2025-11-10T00:08:56.6661995Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1050:
2025-11-10T00:08:56.6662331Z      pub async fn reconsider_block(&self, params: &Value) -> Result<Value> {
2025-11-10T00:08:56.6662491Z          debug!("RPC: reconsiderblock");
2025-11-10T00:08:56.6662608Z  
2025-11-10T00:08:56.6662759Z -        let blockhash = params.get(0)
2025-11-10T00:08:56.6662898Z +        let blockhash = params
2025-11-10T00:08:56.6663016Z +            .get(0)
2025-11-10T00:08:56.6663151Z              .and_then(|p| p.as_str())
2025-11-10T00:08:56.6663422Z              .ok_or_else(|| anyhow::anyhow!("Block hash parameter required"))?;
2025-11-10T00:08:56.6663530Z  
2025-11-10T00:08:56.6666169Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1057:
2025-11-10T00:08:56.6666350Z -        let hash_bytes = hex::decode(blockhash)
2025-11-10T00:08:56.6666597Z -            .map_err(|e| anyhow::anyhow!("Invalid block hash: {}", e))?;
2025-11-10T00:08:56.6666732Z +        let hash_bytes =
2025-11-10T00:08:56.6667084Z +            hex::decode(blockhash).map_err(|e| anyhow::anyhow!("Invalid block hash: {}", e))?;
2025-11-10T00:08:56.6667483Z          if hash_bytes.len() != 32 {
2025-11-10T00:08:56.6667741Z              return Err(anyhow::anyhow!("Block hash must be 32 bytes"));
2025-11-10T00:08:56.6667848Z          }
2025-11-10T00:08:56.6668321Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1065:
2025-11-10T00:08:56.6668508Z          if let Some(ref storage) = self.storage {
2025-11-10T00:08:56.6668670Z              // Remove from invalid blocks set
2025-11-10T00:08:56.6668843Z              storage.chain().unmark_invalid(&hash)?;
2025-11-10T00:08:56.6668955Z -            
2025-11-10T00:08:56.6669067Z +
2025-11-10T00:08:56.6669369Z              // If this block is now valid, it may be reconsidered for chain inclusion
2025-11-10T00:08:56.6669588Z              // The node will handle this on next block processing
2025-11-10T00:08:56.6669702Z  
2025-11-10T00:08:56.6670177Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1072:
2025-11-10T00:08:56.6670543Z              Ok(json!(null))
2025-11-10T00:08:56.6670656Z          } else {
2025-11-10T00:08:56.6671029Z              // Graceful degradation: return informative error instead of failing silently
2025-11-10T00:08:56.6671500Z -            Err(anyhow::anyhow!("Storage not available. This operation requires storage to be initialized."))
2025-11-10T00:08:56.6671640Z +            Err(anyhow::anyhow!(
2025-11-10T00:08:56.6672002Z +                "Storage not available. This operation requires storage to be initialized."
2025-11-10T00:08:56.6672109Z +            ))
2025-11-10T00:08:56.6672207Z          }
2025-11-10T00:08:56.6672308Z      }
2025-11-10T00:08:56.6672404Z  
2025-11-10T00:08:56.6673064Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1079:
2025-11-10T00:08:56.6673192Z      /// Wait for new block
2025-11-10T00:08:56.6673306Z      ///
2025-11-10T00:08:56.6673630Z      /// Params: ["timeout"] (optional, timeout in seconds, default: no timeout)
2025-11-10T00:08:56.6673744Z -    /// 
2025-11-10T00:08:56.6673855Z +    ///
2025-11-10T00:08:56.6674152Z      /// Note: Full implementation requires async notification infrastructure.
2025-11-10T00:08:56.6676481Z      /// Currently returns current tip immediately. Future enhancement will:
2025-11-10T00:08:56.6676645Z      /// 1. Subscribe to block notifications
2025-11-10T00:08:56.6677105Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1088:
2025-11-10T00:08:56.6677384Z      pub async fn wait_for_new_block(&self, params: &Value) -> Result<Value> {
2025-11-10T00:08:56.6677521Z          debug!("RPC: waitfornewblock");
2025-11-10T00:08:56.6677628Z  
2025-11-10T00:08:56.6677763Z -        let _timeout = params.get(0)
2025-11-10T00:08:56.6677885Z +        let _timeout = params
2025-11-10T00:08:56.6677994Z +            .get(0)
2025-11-10T00:08:56.6678125Z              .and_then(|p| p.as_u64())
2025-11-10T00:08:56.6678315Z              .map(|t| tokio::time::Duration::from_secs(t));
2025-11-10T00:08:56.6678417Z  
2025-11-10T00:08:56.6678849Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1104:
2025-11-10T00:08:56.6678949Z              }
2025-11-10T00:08:56.6679050Z          } else {
2025-11-10T00:08:56.6679383Z              // Graceful degradation: return informative error instead of failing silently
2025-11-10T00:08:56.6679829Z -            Err(anyhow::anyhow!("Storage not available. This operation requires storage to be initialized."))
2025-11-10T00:08:56.6679971Z +            Err(anyhow::anyhow!(
2025-11-10T00:08:56.6680322Z +                "Storage not available. This operation requires storage to be initialized."
2025-11-10T00:08:56.6680433Z +            ))
2025-11-10T00:08:56.6680529Z          }
2025-11-10T00:08:56.6680624Z      }
2025-11-10T00:08:56.6680727Z  
2025-11-10T00:08:56.6681154Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1111:
2025-11-10T00:08:56.6681537Z      /// Wait for specific block
2025-11-10T00:08:56.6681639Z      ///
2025-11-10T00:08:56.6681881Z      /// Params: ["blockhash", "timeout"] (block hash, optional timeout)
2025-11-10T00:08:56.6681986Z -    /// 
2025-11-10T00:08:56.6682094Z +    ///
2025-11-10T00:08:56.6682420Z      /// Note: Full implementation requires async notification infrastructure.
2025-11-10T00:08:56.6682714Z      /// Currently checks if block exists immediately. Future enhancement will:
2025-11-10T00:08:56.6682856Z      /// 1. Subscribe to block notifications
2025-11-10T00:08:56.6683280Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1120:
2025-11-10T00:08:56.6683541Z      pub async fn wait_for_block(&self, params: &Value) -> Result<Value> {
2025-11-10T00:08:56.6683680Z          debug!("RPC: waitforblock");
2025-11-10T00:08:56.6683774Z  
2025-11-10T00:08:56.6683918Z -        let blockhash = params.get(0)
2025-11-10T00:08:56.6684210Z +        let blockhash = params
2025-11-10T00:08:56.6684507Z +            .get(0)
2025-11-10T00:08:56.6684645Z              .and_then(|p| p.as_str())
2025-11-10T00:08:56.6684895Z              .ok_or_else(|| anyhow::anyhow!("Block hash parameter required"))?;
2025-11-10T00:08:56.6684991Z  
2025-11-10T00:08:56.6685456Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1127:
2025-11-10T00:08:56.6685618Z -        let _timeout = params.get(1)
2025-11-10T00:08:56.6685787Z +        let _timeout = params
2025-11-10T00:08:56.6685901Z +            .get(1)
2025-11-10T00:08:56.6686046Z              .and_then(|p| p.as_u64())
2025-11-10T00:08:56.6686253Z              .map(|t| tokio::time::Duration::from_secs(t));
2025-11-10T00:08:56.6694246Z  
2025-11-10T00:08:56.6694979Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1131:
2025-11-10T00:08:56.6695196Z -        let hash_bytes = hex::decode(blockhash)
2025-11-10T00:08:56.6695473Z -            .map_err(|e| anyhow::anyhow!("Invalid block hash: {}", e))?;
2025-11-10T00:08:56.6695605Z +        let hash_bytes =
2025-11-10T00:08:56.6695970Z +            hex::decode(blockhash).map_err(|e| anyhow::anyhow!("Invalid block hash: {}", e))?;
2025-11-10T00:08:56.6696129Z          if hash_bytes.len() != 32 {
2025-11-10T00:08:56.6696385Z              return Err(anyhow::anyhow!("Block hash must be 32 bytes"));
2025-11-10T00:08:56.6696498Z          }
2025-11-10T00:08:56.6696981Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1140:
2025-11-10T00:08:56.6697172Z          // For now, check if block exists immediately
2025-11-10T00:08:56.6697337Z          if let Some(ref storage) = self.storage {
2025-11-10T00:08:56.6697586Z              if let Ok(Some(_block)) = storage.blocks().get_block(&hash) {
2025-11-10T00:08:56.6697823Z -                let height = storage.blocks().get_height_by_hash(&hash)?
2025-11-10T00:08:56.6697963Z -                    .unwrap_or(0);
2025-11-10T00:08:56.6698290Z +                let height = storage.blocks().get_height_by_hash(&hash)?.unwrap_or(0);
2025-11-10T00:08:56.6698434Z                  Ok(json!({
2025-11-10T00:08:56.6698572Z                      "hash": blockhash,
2025-11-10T00:08:56.6698711Z                      "height": height
2025-11-10T00:08:56.6699188Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1151:
2025-11-10T00:08:56.6699296Z              }
2025-11-10T00:08:56.6699408Z          } else {
2025-11-10T00:08:56.6699774Z              // Graceful degradation: return informative error instead of failing silently
2025-11-10T00:08:56.6700245Z -            Err(anyhow::anyhow!("Storage not available. This operation requires storage to be initialized."))
2025-11-10T00:08:56.6700382Z +            Err(anyhow::anyhow!(
2025-11-10T00:08:56.6700710Z +                "Storage not available. This operation requires storage to be initialized."
2025-11-10T00:08:56.6700819Z +            ))
2025-11-10T00:08:56.6700925Z          }
2025-11-10T00:08:56.6701264Z      }
2025-11-10T00:08:56.6701371Z  
2025-11-10T00:08:56.6701811Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1158:
2025-11-10T00:08:56.6701934Z      /// Wait for block height
2025-11-10T00:08:56.6702032Z      ///
2025-11-10T00:08:56.6702290Z      /// Params: ["height", "timeout"] (block height, optional timeout)
2025-11-10T00:08:56.6702402Z -    /// 
2025-11-10T00:08:56.6702508Z +    ///
2025-11-10T00:08:56.6702825Z      /// Note: Full implementation requires async notification infrastructure.
2025-11-10T00:08:56.6703166Z      /// Currently checks if block at height exists immediately. Future enhancement will:
2025-11-10T00:08:56.6703309Z      /// 1. Subscribe to block notifications
2025-11-10T00:08:56.6703744Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1167:
2025-11-10T00:08:56.6704050Z      pub async fn wait_for_block_height(&self, params: &Value) -> Result<Value> {
2025-11-10T00:08:56.6704617Z          debug!("RPC: waitforblockheight");
2025-11-10T00:08:56.6704721Z  
2025-11-10T00:08:56.6704872Z -        let height = params.get(0)
2025-11-10T00:08:56.6705012Z +        let height = params
2025-11-10T00:08:56.6705132Z +            .get(0)
2025-11-10T00:08:56.6705287Z              .and_then(|p| p.as_u64())
2025-11-10T00:08:56.6705571Z              .ok_or_else(|| anyhow::anyhow!("Height parameter required"))?;
2025-11-10T00:08:56.6705683Z  
2025-11-10T00:08:56.6706169Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1174:
2025-11-10T00:08:56.6706331Z -        let _timeout = params.get(1)
2025-11-10T00:08:56.6706468Z +        let _timeout = params
2025-11-10T00:08:56.6706582Z +            .get(1)
2025-11-10T00:08:56.6706736Z              .and_then(|p| p.as_u64())
2025-11-10T00:08:56.6706919Z              .map(|t| tokio::time::Duration::from_secs(t));
2025-11-10T00:08:56.6707080Z          if let Some(ref storage) = self.storage {
2025-11-10T00:08:56.6707538Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1186:
2025-11-10T00:08:56.6707781Z                      Err(anyhow::anyhow!("Block at height {} not found", height))
2025-11-10T00:08:56.6707883Z                  }
2025-11-10T00:08:56.6707987Z              } else {
2025-11-10T00:08:56.6708368Z -                Err(anyhow::anyhow!("Block at height {} not yet available (tip: {})", height, tip_height))
2025-11-10T00:08:56.6708499Z +                Err(anyhow::anyhow!(
2025-11-10T00:08:56.6708691Z +                    "Block at height {} not yet available (tip: {})",
2025-11-10T00:08:56.6708817Z +                    height,
2025-11-10T00:08:56.6708944Z +                    tip_height
2025-11-10T00:08:56.6709058Z +                ))
2025-11-10T00:08:56.6709174Z              }
2025-11-10T00:08:56.6709288Z          } else {
2025-11-10T00:08:56.6709657Z              // Graceful degradation: return informative error instead of failing silently
2025-11-10T00:08:56.6710146Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1193:
2025-11-10T00:08:56.6710636Z -            Err(anyhow::anyhow!("Storage not available. This operation requires storage to be initialized."))
2025-11-10T00:08:56.6710778Z +            Err(anyhow::anyhow!(
2025-11-10T00:08:56.6711132Z +                "Storage not available. This operation requires storage to be initialized."
2025-11-10T00:08:56.6711263Z +            ))
2025-11-10T00:08:56.6711373Z          }
2025-11-10T00:08:56.6711476Z      }
2025-11-10T00:08:56.6711576Z  
2025-11-10T00:08:56.6712033Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1200:
2025-11-10T00:08:56.6712323Z      pub async fn get_block_filter(&self, params: &Value) -> Result<Value> {
2025-11-10T00:08:56.6712465Z          debug!("RPC: getblockfilter");
2025-11-10T00:08:56.6712572Z  
2025-11-10T00:08:56.6712715Z -        let blockhash = params.get(0)
2025-11-10T00:08:56.6712852Z +        let blockhash = params
2025-11-10T00:08:56.6713181Z +            .get(0)
2025-11-10T00:08:56.6713315Z              .and_then(|p| p.as_str())
2025-11-10T00:08:56.6713978Z              .ok_or_else(|| anyhow::anyhow!("Block hash parameter required"))?;
2025-11-10T00:08:56.6714087Z  
2025-11-10T00:08:56.6714717Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1207:
2025-11-10T00:08:56.6714864Z -        let filtertype = params.get(1)
2025-11-10T00:08:56.6714994Z -            .and_then(|p| p.as_u64())
2025-11-10T00:08:56.6715163Z -            .unwrap_or(0); // Default: Basic filter
2025-11-10T00:08:56.6715559Z +        let filtertype = params.get(1).and_then(|p| p.as_u64()).unwrap_or(0); // Default: Basic filter
2025-11-10T00:08:56.6715667Z  
2025-11-10T00:08:56.6715796Z          if filtertype != 0 {
2025-11-10T00:08:56.6716107Z              return Err(anyhow::anyhow!("Only filter type 0 (Basic) is supported"));
2025-11-10T00:08:56.6716806Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1213:
2025-11-10T00:08:56.6716933Z          }
2025-11-10T00:08:56.6717049Z  
2025-11-10T00:08:56.6717218Z -        let hash_bytes = hex::decode(blockhash)
2025-11-10T00:08:56.6717458Z -            .map_err(|e| anyhow::anyhow!("Invalid block hash: {}", e))?;
2025-11-10T00:08:56.6717586Z +        let hash_bytes =
2025-11-10T00:08:56.6717933Z +            hex::decode(blockhash).map_err(|e| anyhow::anyhow!("Invalid block hash: {}", e))?;
2025-11-10T00:08:56.6718069Z          if hash_bytes.len() != 32 {
2025-11-10T00:08:56.6718312Z              return Err(anyhow::anyhow!("Block hash must be 32 bytes"));
2025-11-10T00:08:56.6718427Z          }
2025-11-10T00:08:56.6718880Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1226:
2025-11-10T00:08:56.6719108Z                  // Get filter service from network manager (if available)
2025-11-10T00:08:56.6719275Z                  // For now, generate filter directly
2025-11-10T00:08:56.6719484Z                  use bllvm_protocol::bip158::build_block_filter;
2025-11-10T00:08:56.6719589Z -                
2025-11-10T00:08:56.6719697Z +
2025-11-10T00:08:56.6719883Z                  // Get previous outpoint scripts from UTXO set
2025-11-10T00:08:56.6720106Z                  // For each input, find the UTXO and get its script_pubkey
2025-11-10T00:08:56.6720276Z                  let mut previous_scripts = Vec::new();
2025-11-10T00:08:56.6720733Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1239:
2025-11-10T00:08:56.6720847Z                          }
2025-11-10T00:08:56.6720957Z                      }
2025-11-10T00:08:56.6721072Z                  }
2025-11-10T00:08:56.6721176Z -                
2025-11-10T00:08:56.6721277Z +
2025-11-10T00:08:56.6721579Z                  match build_block_filter(&block.transactions, &previous_scripts) {
2025-11-10T00:08:56.6721708Z                      Ok(filter) => {
2025-11-10T00:08:56.6721836Z                          Ok(json!({
2025-11-10T00:08:56.6722284Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1247:
2025-11-10T00:08:56.6722554Z                              "header": hex::encode([0u8; 32]), // Would calculate filter header
2025-11-10T00:08:56.6722667Z                          }))
2025-11-10T00:08:56.6722774Z                      }
2025-11-10T00:08:56.6723025Z -                    Err(e) => Err(anyhow::anyhow!("Failed to build filter: {}", e))
2025-11-10T00:08:56.6723262Z +                    Err(e) => Err(anyhow::anyhow!("Failed to build filter: {}", e)),
2025-11-10T00:08:56.6723368Z                  }
2025-11-10T00:08:56.6723484Z              } else {
2025-11-10T00:08:56.6723651Z                  Err(anyhow::anyhow!("Block not found"))
2025-11-10T00:08:56.6724095Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1254:
2025-11-10T00:08:56.6724199Z              }
2025-11-10T00:08:56.6724476Z          } else {
2025-11-10T00:08:56.6725025Z              // Graceful degradation: return informative error instead of failing silently
2025-11-10T00:08:56.6725479Z -            Err(anyhow::anyhow!("Storage not available. This operation requires storage to be initialized."))
2025-11-10T00:08:56.6725615Z +            Err(anyhow::anyhow!(
2025-11-10T00:08:56.6725953Z +                "Storage not available. This operation requires storage to be initialized."
2025-11-10T00:08:56.6726058Z +            ))
2025-11-10T00:08:56.6726166Z          }
2025-11-10T00:08:56.6726264Z      }
2025-11-10T00:08:56.6726365Z  
2025-11-10T00:08:56.6726850Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/control.rs:89:
2025-11-10T00:08:56.6727182Z      pub async fn getmemoryinfo(&self, params: &Value) -> RpcResult<Value> {
2025-11-10T00:08:56.6727334Z          debug!("RPC: getmemoryinfo");
2025-11-10T00:08:56.6727446Z  
2025-11-10T00:08:56.6727579Z -        let mode = params
2025-11-10T00:08:56.6727917Z -            .get(0)
2025-11-10T00:08:56.6728068Z -            .and_then(|p| p.as_str())
2025-11-10T00:08:56.6728205Z -            .unwrap_or("stats");
2025-11-10T00:08:56.6728491Z +        let mode = params.get(0).and_then(|p| p.as_str()).unwrap_or("stats");
2025-11-10T00:08:56.6728601Z  
2025-11-10T00:08:56.6728725Z          match mode {
2025-11-10T00:08:56.6728846Z              "stats" => {
2025-11-10T00:08:56.6729289Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/control.rs:224:
2025-11-10T00:08:56.6729400Z          } else {
2025-11-10T00:08:56.6729617Z              // No command specified, return list of all commands
2025-11-10T00:08:56.6729749Z              let commands = vec![
2025-11-10T00:08:56.6730066Z -                "getblockchaininfo", "getblock", "getblockhash", "getblockheader",
2025-11-10T00:08:56.6730410Z -                "getbestblockhash", "getblockcount", "getdifficulty", "gettxoutsetinfo",
2025-11-10T00:08:56.6730791Z -                "verifychain", "getrawtransaction", "sendrawtransaction", "testmempoolaccept",
2025-11-10T00:08:56.6731132Z -                "decoderawtransaction", "gettxout", "gettxoutproof", "verifytxoutproof",
2025-11-10T00:08:56.6731435Z -                "getmempoolinfo", "getrawmempool", "savemempool", "getnetworkinfo",
2025-11-10T00:08:56.6731766Z -                "getpeerinfo", "getconnectioncount", "ping", "addnode", "disconnectnode",
2025-11-10T00:08:56.6732078Z -                "getnettotals", "clearbanned", "setban", "listbanned", "getmininginfo",
2025-11-10T00:08:56.6732399Z -                "getblocktemplate", "submitblock", "estimatesmartfee", "stop", "uptime",
2025-11-10T00:08:56.6732612Z -                "getmemoryinfo", "getrpcinfo", "help", "logging",
2025-11-10T00:08:56.6732751Z +                "getblockchaininfo",
2025-11-10T00:08:56.6732874Z +                "getblock",
2025-11-10T00:08:56.6733015Z +                "getblockhash",
2025-11-10T00:08:56.6733148Z +                "getblockheader",
2025-11-10T00:08:56.6733292Z +                "getbestblockhash",
2025-11-10T00:08:56.6733437Z +                "getblockcount",
2025-11-10T00:08:56.6733567Z +                "getdifficulty",
2025-11-10T00:08:56.6733704Z +                "gettxoutsetinfo",
2025-11-10T00:08:56.6733830Z +                "verifychain",
2025-11-10T00:08:56.6733988Z +                "getrawtransaction",
2025-11-10T00:08:56.6734136Z +                "sendrawtransaction",
2025-11-10T00:08:56.6734451Z +                "testmempoolaccept",
2025-11-10T00:08:56.6734623Z +                "decoderawtransaction",
2025-11-10T00:08:56.6734752Z +                "gettxout",
2025-11-10T00:08:56.6734890Z +                "gettxoutproof",
2025-11-10T00:08:56.6735029Z +                "verifytxoutproof",
2025-11-10T00:08:56.6735178Z +                "getmempoolinfo",
2025-11-10T00:08:56.6735314Z +                "getrawmempool",
2025-11-10T00:08:56.6735444Z +                "savemempool",
2025-11-10T00:08:56.6735586Z +                "getnetworkinfo",
2025-11-10T00:08:56.6735719Z +                "getpeerinfo",
2025-11-10T00:08:56.6736105Z +                "getconnectioncount",
2025-11-10T00:08:56.6736238Z +                "ping",
2025-11-10T00:08:56.6736360Z +                "addnode",
2025-11-10T00:08:56.6736486Z +                "disconnectnode",
2025-11-10T00:08:56.6736616Z +                "getnettotals",
2025-11-10T00:08:56.6736748Z +                "clearbanned",
2025-11-10T00:08:56.6736869Z +                "setban",
2025-11-10T00:08:56.6736997Z +                "listbanned",
2025-11-10T00:08:56.6737135Z +                "getmininginfo",
2025-11-10T00:08:56.6737279Z +                "getblocktemplate",
2025-11-10T00:08:56.6737404Z +                "submitblock",
2025-11-10T00:08:56.6737534Z +                "estimatesmartfee",
2025-11-10T00:08:56.6737659Z +                "stop",
2025-11-10T00:08:56.6737780Z +                "uptime",
2025-11-10T00:08:56.6737912Z +                "getmemoryinfo",
2025-11-10T00:08:56.6738045Z +                "getrpcinfo",
2025-11-10T00:08:56.6738368Z +                "help",
2025-11-10T00:08:56.6738489Z +                "logging",
2025-11-10T00:08:56.6738595Z              ];
2025-11-10T00:08:56.6738709Z  
2025-11-10T00:08:56.6738869Z              Ok(json!(commands.join("\n")))
2025-11-10T00:08:56.6739337Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/control.rs:275:
2025-11-10T00:08:56.6739534Z          // 1. Store a reference to the EnvFilter layer
2025-11-10T00:08:56.6739755Z          // 2. Provide methods to update the filter dynamically
2025-11-10T00:08:56.6739941Z          // 3. Rebuild the subscriber with the new filter
2025-11-10T00:08:56.6740054Z -        
2025-11-10T00:08:56.6740171Z +
2025-11-10T00:08:56.6740355Z          // Check current filter state from environment
2025-11-10T00:08:56.6740554Z -        let current_filter = std::env::var("RUST_LOG")
2025-11-10T00:08:56.6740738Z -            .unwrap_or_else(|_| "info".to_string());
2025-11-10T00:08:56.6740848Z -        
2025-11-10T00:08:56.6741207Z +        let current_filter = std::env::var("RUST_LOG").unwrap_or_else(|_| "info".to_string());
2025-11-10T00:08:56.6741317Z +
2025-11-10T00:08:56.6741549Z          // Determine if debug logging is active based on filter
2025-11-10T00:08:56.6742285Z -        let active = current_filter.contains("debug") || 
2025-11-10T00:08:56.6742479Z -                     current_filter.contains("trace") ||
2025-11-10T00:08:56.6742674Z -                     !exclude.contains(&"all".to_string());
2025-11-10T00:08:56.6742865Z +        let active = current_filter.contains("debug")
2025-11-10T00:08:56.6743026Z +            || current_filter.contains("trace")
2025-11-10T00:08:56.6743192Z +            || !exclude.contains(&"all".to_string());
2025-11-10T00:08:56.6743294Z  
2025-11-10T00:08:56.6745437Z          Ok(json!({
2025-11-10T00:08:56.6745576Z              "active": active,
2025-11-10T00:08:56.6746036Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/control.rs:297:
2025-11-10T00:08:56.6746330Z      /// Returns comprehensive health report for all node components
2025-11-10T00:08:56.6746632Z      pub async fn gethealth(&self, _params: &Value) -> RpcResult<Value> {
2025-11-10T00:08:56.6746782Z          debug!("RPC: gethealth");
2025-11-10T00:08:56.6746897Z -        
2025-11-10T00:08:56.6747000Z +
2025-11-10T00:08:56.6747282Z          // This would need access to Node instance to get full health report
2025-11-10T00:08:56.6747444Z          // For now, return basic health status
2025-11-10T00:08:56.6747550Z          Ok(json!({
2025-11-10T00:08:56.6747988Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/control.rs:312:
2025-11-10T00:08:56.6748181Z      /// Returns comprehensive metrics for monitoring
2025-11-10T00:08:56.6748484Z      pub async fn getmetrics(&self, _params: &Value) -> RpcResult<Value> {
2025-11-10T00:08:56.6748633Z          debug!("RPC: getmetrics");
2025-11-10T00:08:56.6748743Z -        
2025-11-10T00:08:56.6748852Z +
2025-11-10T00:08:56.6749132Z          // This would need access to MetricsCollector to get full metrics
2025-11-10T00:08:56.6749541Z          // For now, return basic metrics
2025-11-10T00:08:56.6749734Z          let uptime = self.start_time.elapsed().as_secs();
2025-11-10T00:08:56.6750161Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/control.rs:328:
2025-11-10T00:08:56.6750289Z          Self::new()
2025-11-10T00:08:56.6750393Z      }
2025-11-10T00:08:56.6750495Z  }
2025-11-10T00:08:56.6750607Z -
2025-11-10T00:08:56.6750710Z  
2025-11-10T00:08:56.6751232Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:23:
2025-11-10T00:08:56.6751369Z  impl MempoolRpc {
2025-11-10T00:08:56.6751535Z      /// Create a new mempool RPC handler
2025-11-10T00:08:56.6751673Z      pub fn new() -> Self {
2025-11-10T00:08:56.6751838Z -        Self { mempool: None, storage: None }
2025-11-10T00:08:56.6751959Z +        Self {
2025-11-10T00:08:56.6752088Z +            mempool: None,
2025-11-10T00:08:56.6752451Z +            storage: None,
2025-11-10T00:08:56.6752568Z +        }
2025-11-10T00:08:56.6752683Z      }
2025-11-10T00:08:56.6752788Z  
2025-11-10T00:08:56.6752934Z      /// Create with dependencies
2025-11-10T00:08:56.6753795Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:30:
2025-11-10T00:08:56.6754224Z      pub fn with_dependencies(mempool: Arc<MempoolManager>, storage: Arc<Storage>) -> Self {
2025-11-10T00:08:56.6754608Z -        Self { mempool: Some(mempool), storage: Some(storage) }
2025-11-10T00:08:56.6754729Z +        Self {
2025-11-10T00:08:56.6754879Z +            mempool: Some(mempool),
2025-11-10T00:08:56.6755016Z +            storage: Some(storage),
2025-11-10T00:08:56.6755124Z +        }
2025-11-10T00:08:56.6755242Z      }
2025-11-10T00:08:56.6755348Z  
2025-11-10T00:08:56.6755485Z      /// Get mempool information
2025-11-10T00:08:56.6755907Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:40:
2025-11-10T00:08:56.6756105Z          if let Some(ref mempool) = self.mempool {
2025-11-10T00:08:56.6756260Z              let size = mempool.size();
2025-11-10T00:08:56.6756452Z              let transactions = mempool.get_transactions();
2025-11-10T00:08:56.6756675Z -            let bytes: usize = transactions.iter().map(|tx| {
2025-11-10T00:08:56.6757007Z -                use bllvm_protocol::serialization::transaction::serialize_transaction;
2025-11-10T00:08:56.6757163Z -                serialize_transaction(tx).len()
2025-11-10T00:08:56.6757280Z -            }).sum();
2025-11-10T00:08:56.6757429Z +            let bytes: usize = transactions
2025-11-10T00:08:56.6757535Z +                .iter()
2025-11-10T00:08:56.6757653Z +                .map(|tx| {
2025-11-10T00:08:56.6758001Z +                    use bllvm_protocol::serialization::transaction::serialize_transaction;
2025-11-10T00:08:56.6758171Z +                    serialize_transaction(tx).len()
2025-11-10T00:08:56.6758286Z +                })
2025-11-10T00:08:56.6758420Z +                .sum();
2025-11-10T00:08:56.6758535Z  
2025-11-10T00:08:56.6758656Z              Ok(json!({
2025-11-10T00:08:56.6758788Z                  "loaded": true,
2025-11-10T00:08:56.6759245Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:56:
2025-11-10T00:08:56.6759360Z              }))
2025-11-10T00:08:56.6759468Z          } else {
2025-11-10T00:08:56.6759825Z              // Graceful degradation: return empty mempool info when mempool unavailable
2025-11-10T00:08:56.6760290Z -            tracing::debug!("getmempoolinfo called but mempool not available, returning empty mempool");
2025-11-10T00:08:56.6760427Z +            tracing::debug!(
2025-11-10T00:08:56.6760789Z +                "getmempoolinfo called but mempool not available, returning empty mempool"
2025-11-10T00:08:56.6760907Z +            );
2025-11-10T00:08:56.6761025Z              Ok(json!({
2025-11-10T00:08:56.6761157Z                  "loaded": false,
2025-11-10T00:08:56.6761298Z                  "size": 0,
2025-11-10T00:08:56.6763134Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:82:
2025-11-10T00:08:56.6765311Z              let transactions = mempool.get_transactions();
2025-11-10T00:08:56.6765547Z              use bllvm_protocol::mempool::calculate_tx_id;
2025-11-10T00:08:56.6765892Z              use bllvm_protocol::serialization::transaction::serialize_transaction;
2025-11-10T00:08:56.6766000Z -            
2025-11-10T00:08:56.6766111Z +
2025-11-10T00:08:56.6766231Z              if verbose {
2025-11-10T00:08:56.6766406Z                  let mut result = serde_json::Map::new();
2025-11-10T00:08:56.6766556Z                  for tx in transactions {
2025-11-10T00:08:56.6767017Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:90:
2025-11-10T00:08:56.6767195Z                      let txid_hex = hex::encode(txid);
2025-11-10T00:08:56.6767370Z                      let txid_hex_clone = txid_hex.clone();
2025-11-10T00:08:56.6767823Z                      let size = serialize_transaction(&tx).len();
2025-11-10T00:08:56.6767952Z -                    
2025-11-10T00:08:56.6768060Z +
2025-11-10T00:08:56.6768223Z                      result.insert(txid_hex, json!({
2025-11-10T00:08:56.6768369Z                          "size": size,
2025-11-10T00:08:56.6768821Z                          "fee": if let (Some(ref mempool), Some(ref storage)) = (self.mempool.as_ref(), self.storage.as_ref()) {
2025-11-10T00:08:56.6769269Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:126:
2025-11-10T00:08:56.6769383Z                  }
2025-11-10T00:08:56.6769514Z                  Ok(json!(result))
2025-11-10T00:08:56.6769628Z              } else {
2025-11-10T00:08:56.6769855Z -                let txids: Vec<String> = transactions.iter().map(|tx| {
2025-11-10T00:08:56.6770010Z -                    let txid = calculate_tx_id(tx);
2025-11-10T00:08:56.6770154Z -                    hex::encode(txid)
2025-11-10T00:08:56.6770294Z -                }).collect();
2025-11-10T00:08:56.6770479Z +                let txids: Vec<String> = transactions
2025-11-10T00:08:56.6770604Z +                    .iter()
2025-11-10T00:08:56.6770734Z +                    .map(|tx| {
2025-11-10T00:08:56.6771389Z +                        let txid = calculate_tx_id(tx);
2025-11-10T00:08:56.6771542Z +                        hex::encode(txid)
2025-11-10T00:08:56.6771659Z +                    })
2025-11-10T00:08:56.6771787Z +                    .collect();
2025-11-10T00:08:56.6771927Z                  Ok(json!(txids))
2025-11-10T00:08:56.6772038Z              }
2025-11-10T00:08:56.6772148Z          } else {
2025-11-10T00:08:56.6772871Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:174:
2025-11-10T00:08:56.6773049Z          if let Some(mempool) = &self.mempool {
2025-11-10T00:08:56.6775246Z              let data_dir = std::env::var("DATA_DIR").unwrap_or_else(|_| "data".to_string());
2025-11-10T00:08:56.6775594Z              let mempool_path = std::path::Path::new(&data_dir).join("mempool.dat");
2025-11-10T00:08:56.6775711Z -            
2025-11-10T00:08:56.6775817Z +
2025-11-10T00:08:56.6776064Z              // Arc implements Deref, so we can call methods directly
2025-11-10T00:08:56.6776295Z              if let Err(e) = mempool.save_to_disk(&mempool_path) {
2025-11-10T00:08:56.6776555Z -                return Err(crate::rpc::errors::RpcError::internal_error(
2025-11-10T00:08:56.6776747Z -                    format!("Failed to save mempool: {}", e)
2025-11-10T00:08:56.6776867Z -                ));
2025-11-10T00:08:56.6777152Z +                return Err(crate::rpc::errors::RpcError::internal_error(format!(
2025-11-10T00:08:56.6777315Z +                    "Failed to save mempool: {}",
2025-11-10T00:08:56.6777441Z +                    e
2025-11-10T00:08:56.6777556Z +                )));
2025-11-10T00:08:56.6777665Z              }
2025-11-10T00:08:56.6777795Z              Ok(json!(null))
2025-11-10T00:08:56.6777925Z          } else {
2025-11-10T00:08:56.6778635Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:186:
2025-11-10T00:08:56.6778862Z              Err(crate::rpc::errors::RpcError::internal_error(
2025-11-10T00:08:56.6779047Z -                "Mempool not initialized".to_string()
2025-11-10T00:08:56.6779222Z +                "Mempool not initialized".to_string(),
2025-11-10T00:08:56.6779334Z              ))
2025-11-10T00:08:56.6779440Z          }
2025-11-10T00:08:56.6779559Z      }
2025-11-10T00:08:56.6780018Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:195:
2025-11-10T00:08:56.6780382Z      pub async fn getmempoolancestors(&self, params: &Value) -> RpcResult<Value> {
2025-11-10T00:08:56.6780561Z          debug!("RPC: getmempoolancestors");
2025-11-10T00:08:56.6780669Z  
2025-11-10T00:08:56.6780818Z -        let txid = params.get(0)
2025-11-10T00:08:56.6780970Z -            .and_then(|p| p.as_str())
2025-11-10T00:08:56.6781684Z -            .ok_or_else(|| crate::rpc::errors::RpcError::invalid_params("Transaction ID required".to_string()))?;
2025-11-10T00:08:56.6781972Z +        let txid = params.get(0).and_then(|p| p.as_str()).ok_or_else(|| {
2025-11-10T00:08:56.6782364Z +            crate::rpc::errors::RpcError::invalid_params("Transaction ID required".to_string())
2025-11-10T00:08:56.6782497Z +        })?;
2025-11-10T00:08:56.6782605Z  
2025-11-10T00:08:56.6782909Z          let verbose = params.get(1).and_then(|p| p.as_bool()).unwrap_or(false);
2025-11-10T00:08:56.6783037Z  
2025-11-10T00:08:56.6785340Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:204:
2025-11-10T00:08:56.6785524Z -        let hash_bytes = hex::decode(txid)
2025-11-10T00:08:56.6786002Z -            .map_err(|e| crate::rpc::errors::RpcError::invalid_params(format!("Invalid transaction ID: {}", e)))?;
2025-11-10T00:08:56.6786195Z +        let hash_bytes = hex::decode(txid).map_err(|e| {
2025-11-10T00:08:56.6786593Z +            crate::rpc::errors::RpcError::invalid_params(format!("Invalid transaction ID: {}", e))
2025-11-10T00:08:56.6786716Z +        })?;
2025-11-10T00:08:56.6786867Z          if hash_bytes.len() != 32 {
2025-11-10T00:08:56.6787745Z -            return Err(crate::rpc::errors::RpcError::invalid_params("Transaction ID must be 32 bytes".to_string()));
2025-11-10T00:08:56.6788005Z +            return Err(crate::rpc::errors::RpcError::invalid_params(
2025-11-10T00:08:56.6788213Z +                "Transaction ID must be 32 bytes".to_string(),
2025-11-10T00:08:56.6788327Z +            ));
2025-11-10T00:08:56.6788436Z          }
2025-11-10T00:08:56.6788581Z          let mut hash = [0u8; 32];
2025-11-10T00:08:56.6788739Z          hash.copy_from_slice(&hash_bytes);
2025-11-10T00:08:56.6789199Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:222:
2025-11-10T00:08:56.6789419Z                          let ancestor_txid_clone = ancestor_txid.clone();
2025-11-10T00:08:56.6789778Z                          use bllvm_protocol::serialization::transaction::serialize_transaction;
2025-11-10T00:08:56.6790013Z                          let size = serialize_transaction(&ancestor_tx).len();
2025-11-10T00:08:56.6790136Z -                        
2025-11-10T00:08:56.6790247Z +
2025-11-10T00:08:56.6790423Z                          result.insert(ancestor_txid, json!({
2025-11-10T00:08:56.6790566Z                              "size": size,
2025-11-10T00:08:56.6790779Z                              "fee": if let Some(ref storage) = self.storage {
2025-11-10T00:08:56.6791235Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:278:
2025-11-10T00:08:56.6791625Z      pub async fn getmempooldescendants(&self, params: &Value) -> RpcResult<Value> {
2025-11-10T00:08:56.6791801Z          debug!("RPC: getmempooldescendants");
2025-11-10T00:08:56.6791917Z  
2025-11-10T00:08:56.6792061Z -        let txid = params.get(0)
2025-11-10T00:08:56.6792212Z -            .and_then(|p| p.as_str())
2025-11-10T00:08:56.6792689Z -            .ok_or_else(|| crate::rpc::errors::RpcError::invalid_params("Transaction ID required".to_string()))?;
2025-11-10T00:08:56.6793196Z +        let txid = params.get(0).and_then(|p| p.as_str()).ok_or_else(|| {
2025-11-10T00:08:56.6793570Z +            crate::rpc::errors::RpcError::invalid_params("Transaction ID required".to_string())
2025-11-10T00:08:56.6793692Z +        })?;
2025-11-10T00:08:56.6793800Z  
2025-11-10T00:08:56.6794092Z          let verbose = params.get(1).and_then(|p| p.as_bool()).unwrap_or(false);
2025-11-10T00:08:56.6794191Z  
2025-11-10T00:08:56.6794787Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:287:
2025-11-10T00:08:56.6794944Z -        let hash_bytes = hex::decode(txid)
2025-11-10T00:08:56.6795408Z -            .map_err(|e| crate::rpc::errors::RpcError::invalid_params(format!("Invalid transaction ID: {}", e)))?;
2025-11-10T00:08:56.6795613Z +        let hash_bytes = hex::decode(txid).map_err(|e| {
2025-11-10T00:08:56.6796188Z +            crate::rpc::errors::RpcError::invalid_params(format!("Invalid transaction ID: {}", e))
2025-11-10T00:08:56.6796308Z +        })?;
2025-11-10T00:08:56.6796461Z          if hash_bytes.len() != 32 {
2025-11-10T00:08:56.6796941Z -            return Err(crate::rpc::errors::RpcError::invalid_params("Transaction ID must be 32 bytes".to_string()));
2025-11-10T00:08:56.6797174Z +            return Err(crate::rpc::errors::RpcError::invalid_params(
2025-11-10T00:08:56.6797351Z +                "Transaction ID must be 32 bytes".to_string(),
2025-11-10T00:08:56.6797464Z +            ));
2025-11-10T00:08:56.6797568Z          }
2025-11-10T00:08:56.6797690Z          let mut hash = [0u8; 32];
2025-11-10T00:08:56.6797836Z          hash.copy_from_slice(&hash_bytes);
2025-11-10T00:08:56.6798273Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:295:
2025-11-10T00:08:56.6798435Z          if let Some(ref mempool) = self.mempool {
2025-11-10T00:08:56.6798868Z              // Find descendants by checking which transactions spend outputs created by this transaction
2025-11-10T00:08:56.6799030Z              let mut descendants = Vec::new();
2025-11-10T00:08:56.6799142Z -            
2025-11-10T00:08:56.6799252Z +
2025-11-10T00:08:56.6799459Z              if let Some(tx) = mempool.get_transaction(&hash) {
2025-11-10T00:08:56.6799663Z                  // Get all output outpoints from this transaction
2025-11-10T00:08:56.6799828Z                  let mut output_outpoints = Vec::new();
2025-11-10T00:08:56.6800252Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:329:
2025-11-10T00:08:56.6800463Z                          let descendant_txid_clone = descendant_txid.clone();
2025-11-10T00:08:56.6800782Z                          use bllvm_protocol::serialization::transaction::serialize_transaction;
2025-11-10T00:08:56.6801010Z                          let size = serialize_transaction(&descendant_tx).len();
2025-11-10T00:08:56.6801133Z -                        
2025-11-10T00:08:56.6801244Z +
2025-11-10T00:08:56.6801427Z                          result.insert(descendant_txid, json!({
2025-11-10T00:08:56.6801571Z                              "size": size,
2025-11-10T00:08:56.6801772Z                              "fee": if let Some(ref storage) = self.storage {
2025-11-10T00:08:56.6802222Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:385:
2025-11-10T00:08:56.6802564Z      pub async fn getmempoolentry(&self, params: &Value) -> RpcResult<Value> {
2025-11-10T00:08:56.6802717Z          debug!("RPC: getmempoolentry");
2025-11-10T00:08:56.6802816Z  
2025-11-10T00:08:56.6802966Z -        let txid = params.get(0)
2025-11-10T00:08:56.6803116Z -            .and_then(|p| p.as_str())
2025-11-10T00:08:56.6803581Z -            .ok_or_else(|| crate::rpc::errors::RpcError::invalid_params("Transaction ID required".to_string()))?;
2025-11-10T00:08:56.6803853Z +        let txid = params.get(0).and_then(|p| p.as_str()).ok_or_else(|| {
2025-11-10T00:08:56.6804614Z +            crate::rpc::errors::RpcError::invalid_params("Transaction ID required".to_string())
2025-11-10T00:08:56.6804738Z +        })?;
2025-11-10T00:08:56.6804842Z  
2025-11-10T00:08:56.6805155Z          let verbose = params.get(1).and_then(|p| p.as_bool()).unwrap_or(false);
2025-11-10T00:08:56.6805268Z  
2025-11-10T00:08:56.6805725Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:394:
2025-11-10T00:08:56.6805894Z -        let hash_bytes = hex::decode(txid)
2025-11-10T00:08:56.6806355Z -            .map_err(|e| crate::rpc::errors::RpcError::invalid_params(format!("Invalid transaction ID: {}", e)))?;
2025-11-10T00:08:56.6806555Z +        let hash_bytes = hex::decode(txid).map_err(|e| {
2025-11-10T00:08:56.6806945Z +            crate::rpc::errors::RpcError::invalid_params(format!("Invalid transaction ID: {}", e))
2025-11-10T00:08:56.6807064Z +        })?;
2025-11-10T00:08:56.6807206Z          if hash_bytes.len() != 32 {
2025-11-10T00:08:56.6807951Z -            return Err(crate::rpc::errors::RpcError::invalid_params("Transaction ID must be 32 bytes".to_string()));
2025-11-10T00:08:56.6808224Z +            return Err(crate::rpc::errors::RpcError::invalid_params(
2025-11-10T00:08:56.6808421Z +                "Transaction ID must be 32 bytes".to_string(),
2025-11-10T00:08:56.6808534Z +            ));
2025-11-10T00:08:56.6808650Z          }
2025-11-10T00:08:56.6808787Z          let mut hash = [0u8; 32];
2025-11-10T00:08:56.6808946Z          hash.copy_from_slice(&hash_bytes);
2025-11-10T00:08:56.6809399Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:403:
2025-11-10T00:08:56.6809617Z              if let Some(tx) = mempool.get_transaction(&hash) {
2025-11-10T00:08:56.6809961Z                  use bllvm_protocol::serialization::transaction::serialize_transaction;
2025-11-10T00:08:56.6810149Z                  let size = serialize_transaction(&tx).len();
2025-11-10T00:08:56.6810269Z -                
2025-11-10T00:08:56.6810382Z +
2025-11-10T00:08:56.6810552Z                  // Get ancestors and descendants
2025-11-10T00:08:56.6810779Z                  let ancestors = self.get_ancestors(mempool, &hash);
2025-11-10T00:08:56.6811019Z                  let descendants = self.get_descendants(mempool, &hash);
2025-11-10T00:08:56.6811464Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:410:
2025-11-10T00:08:56.6811580Z -                
2025-11-10T00:08:56.6811692Z +
2025-11-10T00:08:56.6811861Z                  let ancestor_count = ancestors.len();
2025-11-10T00:08:56.6812044Z                  let descendant_count = descendants.len();
2025-11-10T00:08:56.6812239Z -                let ancestor_size: usize = ancestors.iter()
2025-11-10T00:08:56.6812405Z +                let ancestor_size: usize = ancestors
2025-11-10T00:08:56.6812532Z +                    .iter()
2025-11-10T00:08:56.6812722Z                      .filter_map(|h| mempool.get_transaction(h))
2025-11-10T00:08:56.6812920Z                      .map(|tx| serialize_transaction(&tx).len())
2025-11-10T00:08:56.6813047Z                      .sum();
2025-11-10T00:08:56.6813489Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:417:
2025-11-10T00:08:56.6813697Z -                let descendant_size: usize = descendants.iter()
2025-11-10T00:08:56.6813876Z +                let descendant_size: usize = descendants
2025-11-10T00:08:56.6813996Z +                    .iter()
2025-11-10T00:08:56.6814184Z                      .filter_map(|h| mempool.get_transaction(h))
2025-11-10T00:08:56.6814539Z                      .map(|tx| serialize_transaction(&tx).len())
2025-11-10T00:08:56.6814669Z                      .sum();
2025-11-10T00:08:56.6815107Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:454:
2025-11-10T00:08:56.6815272Z                      "bip125-replaceable": false
2025-11-10T00:08:56.6815386Z                  }))
2025-11-10T00:08:56.6815510Z              } else {
2025-11-10T00:08:56.6815975Z -                Err(crate::rpc::errors::RpcError::invalid_params(
2025-11-10T00:08:56.6816186Z -                    format!("Transaction {} not found in mempool", txid)
2025-11-10T00:08:56.6816287Z -                ))
2025-11-10T00:08:56.6816535Z +                Err(crate::rpc::errors::RpcError::invalid_params(format!(
2025-11-10T00:08:56.6816712Z +                    "Transaction {} not found in mempool",
2025-11-10T00:08:56.6816834Z +                    txid
2025-11-10T00:08:56.6816953Z +                )))
2025-11-10T00:08:56.6817074Z              }
2025-11-10T00:08:56.6817183Z          } else {
2025-11-10T00:08:56.6817395Z              Err(crate::rpc::errors::RpcError::internal_error(
2025-11-10T00:08:56.6817855Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:463:
2025-11-10T00:08:56.6818023Z -                "Mempool not initialized".to_string()
2025-11-10T00:08:56.6818196Z +                "Mempool not initialized".to_string(),
2025-11-10T00:08:56.6818523Z              ))
2025-11-10T00:08:56.6818629Z          }
2025-11-10T00:08:56.6818733Z      }
2025-11-10T00:08:56.6819153Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:468:
2025-11-10T00:08:56.6819328Z      /// Helper: Get ancestors for a transaction
2025-11-10T00:08:56.6819689Z      fn get_ancestors(&self, mempool: &MempoolManager, tx_hash: &Hash) -> Vec<Hash> {
2025-11-10T00:08:56.6819855Z          let mut ancestors = Vec::new();
2025-11-10T00:08:56.6819975Z -        
2025-11-10T00:08:56.6820082Z +
2025-11-10T00:08:56.6820296Z          if let Some(tx) = mempool.get_transaction(tx_hash) {
2025-11-10T00:08:56.6820641Z              // Find transactions that this transaction depends on (spends their outputs)
2025-11-10T00:08:56.6820854Z              use bllvm_protocol::mempool::calculate_tx_id;
2025-11-10T00:08:56.6821302Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:478:
2025-11-10T00:08:56.6821479Z                  for ancestor_tx in transactions {
2025-11-10T00:08:56.6821712Z                      let ancestor_hash = calculate_tx_id(&ancestor_tx);
2025-11-10T00:08:56.6821956Z                      for (idx, _output) in ancestor_tx.outputs.iter().enumerate() {
2025-11-10T00:08:56.6822322Z -                        if input.prevout.hash == ancestor_hash && input.prevout.index == idx as u64 {
2025-11-10T00:08:56.6822680Z +                        if input.prevout.hash == ancestor_hash && input.prevout.index == idx as u64
2025-11-10T00:08:56.6822801Z +                        {
2025-11-10T00:08:56.6822993Z                              if !ancestors.contains(&ancestor_hash) {
2025-11-10T00:08:56.6823178Z                                  ancestors.push(ancestor_hash);
2025-11-10T00:08:56.6823301Z                              }
2025-11-10T00:08:56.6823729Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:487:
2025-11-10T00:08:56.6823835Z                  }
2025-11-10T00:08:56.6823963Z              }
2025-11-10T00:08:56.6824082Z          }
2025-11-10T00:08:56.6824191Z -        
2025-11-10T00:08:56.6824495Z +
2025-11-10T00:08:56.6824622Z          ancestors
2025-11-10T00:08:56.6824732Z      }
2025-11-10T00:08:56.6824838Z  
2025-11-10T00:08:56.6825289Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:494:
2025-11-10T00:08:56.6825455Z      /// Helper: Get descendants for a transaction
2025-11-10T00:08:56.6825814Z      fn get_descendants(&self, mempool: &MempoolManager, tx_hash: &Hash) -> Vec<Hash> {
2025-11-10T00:08:56.6825991Z          let mut descendants = Vec::new();
2025-11-10T00:08:56.6827693Z -        
2025-11-10T00:08:56.6827800Z +
2025-11-10T00:08:56.6828014Z          if let Some(tx) = mempool.get_transaction(tx_hash) {
2025-11-10T00:08:56.6828226Z              // Get all output outpoints from this transaction
2025-11-10T00:08:56.6828389Z              let mut output_outpoints = Vec::new();
2025-11-10T00:08:56.6828827Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:520:
2025-11-10T00:08:56.6829195Z                  }
2025-11-10T00:08:56.6829306Z              }
2025-11-10T00:08:56.6829408Z          }
2025-11-10T00:08:56.6829512Z -        
2025-11-10T00:08:56.6829615Z +
2025-11-10T00:08:56.6829724Z          descendants
2025-11-10T00:08:56.6829822Z      }
2025-11-10T00:08:56.6829933Z  }
2025-11-10T00:08:56.6862558Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:1:
2025-11-10T00:08:56.6862755Z  //! Mining RPC methods
2025-11-10T00:08:56.6862868Z -//! 
2025-11-10T00:08:56.6862977Z +//!
2025-11-10T00:08:56.6863400Z  //! Implements mining-related JSON-RPC methods for block template generation and mining.
2025-11-10T00:08:56.6863664Z  //! Uses formally verified consensus-proof mining functions.
2025-11-10T00:08:56.6863775Z  
2025-11-10T00:08:56.6864204Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:6:
2025-11-10T00:08:56.6864805Z -use serde_json::{Value, json};
2025-11-10T00:08:56.6864959Z -use tracing::{debug, warn};
2025-11-10T00:08:56.6865074Z -use hex;
2025-11-10T00:08:56.6865252Z +use crate::node::mempool::MempoolManager;
2025-11-10T00:08:56.6865457Z  use crate::rpc::errors::{RpcError, RpcResult};
2025-11-10T00:08:56.6867634Z -use bllvm_protocol::{ConsensusProof, types::{BlockHeader, Transaction, UtxoSet, Natural, ByteString, Hash}, ValidationResult};
2025-11-10T00:08:56.6867889Z -use bllvm_protocol::serialization::serialize_transaction;
2025-11-10T00:08:56.6868042Z +use crate::storage::Storage;
2025-11-10T00:08:56.6868218Z  use bllvm_protocol::mining::BlockTemplate;
2025-11-10T00:08:56.6868529Z -use bllvm_protocol::serialization::deserialize_block_with_witnesses;
2025-11-10T00:08:56.6869071Z  use bllvm_protocol::pow::expand_target;
2025-11-10T00:08:56.6869211Z -use std::sync::Arc;
2025-11-10T00:08:56.6869353Z -use crate::storage::Storage;
2025-11-10T00:08:56.6869529Z -use crate::node::mempool::MempoolManager;
2025-11-10T00:08:56.6869859Z +use bllvm_protocol::serialization::deserialize_block_with_witnesses;
2025-11-10T00:08:56.6870190Z +use bllvm_protocol::serialization::serialize_transaction;
2025-11-10T00:08:56.6870324Z +use bllvm_protocol::{
2025-11-10T00:08:56.6870654Z +    types::{BlockHeader, ByteString, Hash, Natural, Transaction, UtxoSet},
2025-11-10T00:08:56.6870820Z +    ConsensusProof, ValidationResult,
2025-11-10T00:08:56.6870931Z +};
2025-11-10T00:08:56.6871052Z +use hex;
2025-11-10T00:08:56.6871197Z +use serde_json::{json, Value};
2025-11-10T00:08:56.6871336Z  use sha2::{Digest, Sha256};
2025-11-10T00:08:56.6871464Z +use std::sync::Arc;
2025-11-10T00:08:56.6871609Z +use tracing::{debug, warn};
2025-11-10T00:08:56.6871713Z  
2025-11-10T00:08:56.6871876Z  /// Mining RPC methods with dependencies
2025-11-10T00:08:56.6872024Z  pub struct MiningRpc {
2025-11-10T00:08:56.6872524Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:36:
2025-11-10T00:08:56.6872945Z              mempool: None,
2025-11-10T00:08:56.6873055Z          }
2025-11-10T00:08:56.6873151Z      }
2025-11-10T00:08:56.6873253Z -    
2025-11-10T00:08:56.6873348Z +
2025-11-10T00:08:56.6873538Z      /// Create with dependencies (storage and mempool)
2025-11-10T00:08:56.6873942Z      pub fn with_dependencies(storage: Arc<Storage>, mempool: Arc<MempoolManager>) -> Self {
2025-11-10T00:08:56.6874062Z          Self {
2025-11-10T00:08:56.6874726Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:45:
2025-11-10T00:08:56.6874870Z              mempool: Some(mempool),
2025-11-10T00:08:56.6874985Z          }
2025-11-10T00:08:56.6875096Z      }
2025-11-10T00:08:56.6875203Z -    
2025-11-10T00:08:56.6875305Z +
2025-11-10T00:08:56.6875455Z      /// Get mining information
2025-11-10T00:08:56.6875698Z      pub async fn get_mining_info(&self) -> RpcResult<Value> {
2025-11-10T00:08:56.6875852Z          debug!("RPC: getmininginfo");
2025-11-10T00:08:56.6876294Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:52:
2025-11-10T00:08:56.6876667Z -        
2025-11-10T00:08:56.6876779Z +
2025-11-10T00:08:56.6876960Z          // Get current block height from storage
2025-11-10T00:08:56.6877644Z          let blocks = if let Some(ref storage) = self.storage {
2025-11-10T00:08:56.6877826Z -            storage.chain().get_height()
2025-11-10T00:08:56.6877942Z +            storage
2025-11-10T00:08:56.6878074Z +                .chain()
2025-11-10T00:08:56.6878203Z +                .get_height()
2025-11-10T00:08:56.6878575Z                  .map_err(|e| RpcError::internal_error(format!("Failed to get height: {}", e)))?
2025-11-10T00:08:56.6878716Z                  .unwrap_or(0)
2025-11-10T00:08:56.6878829Z          } else {
2025-11-10T00:08:56.6879273Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:59:
2025-11-10T00:08:56.6879391Z              0
2025-11-10T00:08:56.6879509Z          };
2025-11-10T00:08:56.6879620Z -        
2025-11-10T00:08:56.6879973Z +
2025-11-10T00:08:56.6880128Z          // Get mempool size
2025-11-10T00:08:56.6880375Z          let pooledtx = if let Some(ref mempool) = self.mempool {
2025-11-10T00:08:56.6880506Z              mempool.size()
2025-11-10T00:08:56.6880948Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:65:
2025-11-10T00:08:56.6881071Z          } else {
2025-11-10T00:08:56.6881174Z              0
2025-11-10T00:08:56.6883217Z          };
2025-11-10T00:08:56.6883332Z -        
2025-11-10T00:08:56.6883437Z +
2025-11-10T00:08:56.6883756Z          // Get difficulty from latest block's bits field (graceful degradation)
2025-11-10T00:08:56.6884002Z          let difficulty = if let Some(ref storage) = self.storage {
2025-11-10T00:08:56.6884276Z              if let Ok(Some(tip_header)) = storage.chain().get_tip_header() {
2025-11-10T00:08:56.6884904Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:78:
2025-11-10T00:08:56.6885222Z              tracing::debug!("Storage not available, using default difficulty");
2025-11-10T00:08:56.6885402Z              1.0 // Graceful fallback if no storage
2025-11-10T00:08:56.6885514Z          };
2025-11-10T00:08:56.6885623Z -        
2025-11-10T00:08:56.6885737Z +
2025-11-10T00:08:56.6886514Z          // Calculate network hashrate from recent block timestamps (graceful degradation)
2025-11-10T00:08:56.6886817Z          let networkhashps = if let Some(ref storage) = self.storage {
2025-11-10T00:08:56.6887102Z -            self.calculate_network_hashrate(storage).unwrap_or_else(|e| {
2025-11-10T00:08:56.6887460Z -                tracing::debug!("Failed to calculate network hashrate: {}, using 0.0", e);
2025-11-10T00:08:56.6887578Z -                0.0
2025-11-10T00:08:56.6887690Z -            })
2025-11-10T00:08:56.6887883Z +            self.calculate_network_hashrate(storage)
2025-11-10T00:08:56.6888027Z +                .unwrap_or_else(|e| {
2025-11-10T00:08:56.6888358Z +                    tracing::debug!("Failed to calculate network hashrate: {}, using 0.0", e);
2025-11-10T00:08:56.6888495Z +                    0.0
2025-11-10T00:08:56.6888602Z +                })
2025-11-10T00:08:56.6888709Z          } else {
2025-11-10T00:08:56.6889024Z              tracing::debug!("Storage not available, network hashrate unavailable");
2025-11-10T00:08:56.6889142Z              0.0
2025-11-10T00:08:56.6889571Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:91:
2025-11-10T00:08:56.6889677Z          };
2025-11-10T00:08:56.6889787Z -        
2025-11-10T00:08:56.6889890Z +
2025-11-10T00:08:56.6890093Z          // Get current block template info (if available)
2025-11-10T00:08:56.6890237Z          let currentblocksize = 0;
2025-11-10T00:08:56.6890391Z          let currentblockweight = 0;
2025-11-10T00:08:56.6890826Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:96:
2025-11-10T00:08:56.6890964Z          let currentblocktx = 0;
2025-11-10T00:08:56.6891086Z -        
2025-11-10T00:08:56.6891426Z +
2025-11-10T00:08:56.6891641Z          // Determine chain name from storage chain params
2025-11-10T00:08:56.6891858Z          let chain = if let Some(ref storage) = self.storage {
2025-11-10T00:08:56.6892106Z              if let Ok(Some(info)) = storage.chain().load_chain_info() {
2025-11-10T00:08:56.6892553Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:110:
2025-11-10T00:08:56.6892662Z          } else {
2025-11-10T00:08:56.6892793Z              "main" // Default
2025-11-10T00:08:56.6892893Z          };
2025-11-10T00:08:56.6893130Z -        
2025-11-10T00:08:56.6893233Z +
2025-11-10T00:08:56.6893339Z          Ok(json!({
2025-11-10T00:08:56.6893453Z              "blocks": blocks,
2025-11-10T00:08:56.6893619Z              "currentblocksize": currentblocksize,
2025-11-10T00:08:56.6894069Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:123:
2025-11-10T00:08:56.6894198Z              "warnings": ""
2025-11-10T00:08:56.6894704Z          }))
2025-11-10T00:08:56.6894824Z      }
2025-11-10T00:08:56.6894928Z -    
2025-11-10T00:08:56.6895032Z +
2025-11-10T00:08:56.6895163Z      /// Get block template
2025-11-10T00:08:56.6895275Z -    /// 
2025-11-10T00:08:56.6895379Z +    ///
2025-11-10T00:08:56.6895550Z      /// Params: [template_request (optional)]
2025-11-10T00:08:56.6895665Z -    /// 
2025-11-10T00:08:56.6895770Z +    ///
2025-11-10T00:08:56.6896170Z      /// Uses formally verified consensus-proof::mining::create_block_template() function
2025-11-10T00:08:56.6896506Z      /// which has Kani proofs ensuring correctness per Orange Paper Section 12.4
2025-11-10T00:08:56.6896847Z      pub async fn get_block_template(&self, params: &Value) -> RpcResult<Value> {
2025-11-10T00:08:56.6897291Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:134:
2025-11-10T00:08:56.6897449Z          debug!("RPC: getblocktemplate");
2025-11-10T00:08:56.6897560Z -        
2025-11-10T00:08:56.6897670Z +
2025-11-10T00:08:56.6897812Z          // 1. Get current chainstate
2025-11-10T00:08:56.6898021Z -        let height: Natural = self.get_current_height()?
2025-11-10T00:08:56.6898166Z +        let height: Natural = self
2025-11-10T00:08:56.6898302Z +            .get_current_height()?
2025-11-10T00:08:56.6898675Z              .ok_or_else(|| RpcError::internal_error("Chain not initialized"))?;
2025-11-10T00:08:56.6898858Z -        let prev_header = self.get_tip_header()?
2025-11-10T00:08:56.6898986Z +        let prev_header = self
2025-11-10T00:08:56.6899104Z +            .get_tip_header()?
2025-11-10T00:08:56.6899326Z              .ok_or_else(|| RpcError::internal_error("No chain tip"))?;
2025-11-10T00:08:56.6899531Z          let prev_headers = self.get_headers_for_difficulty()?;
2025-11-10T00:08:56.6899629Z -        
2025-11-10T00:08:56.6899740Z +
2025-11-10T00:08:56.6899886Z          // 2. Get mempool transactions
2025-11-10T00:08:56.6900194Z          let mempool_txs: Vec<Transaction> = self.get_mempool_transactions()?;
2025-11-10T00:08:56.6900310Z -        
2025-11-10T00:08:56.6900415Z +
2025-11-10T00:08:56.6900533Z          // 3. Get UTXO set
2025-11-10T00:08:56.6900679Z          let utxo_set = self.get_utxo_set()?;
2025-11-10T00:08:56.6900786Z -        
2025-11-10T00:08:56.6900881Z +
2025-11-10T00:08:56.6901117Z          // 4. Extract coinbase parameters from request or use defaults
2025-11-10T00:08:56.6901462Z          let coinbase_script = self.extract_coinbase_script(params).unwrap_or_default();
2025-11-10T00:08:56.6901835Z          let coinbase_address = self.extract_coinbase_address(params).unwrap_or_default();
2025-11-10T00:08:56.6902250Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:152:
2025-11-10T00:08:56.6902350Z -        
2025-11-10T00:08:56.6902453Z +
2025-11-10T00:08:56.6904736Z          // 5. Use formally verified function from consensus-proof
2025-11-10T00:08:56.6905074Z          // This function has Kani proofs: kani_create_block_template_completeness
2025-11-10T00:08:56.6905590Z          let template = match self.consensus.create_block_template(
2025-11-10T00:08:56.6906055Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:164:
2025-11-10T00:08:56.6906183Z              Ok(t) => t,
2025-11-10T00:08:56.6906294Z              Err(e) => {
2025-11-10T00:08:56.6906506Z                  warn!("Failed to create block template: {}", e);
2025-11-10T00:08:56.6906905Z -                return Err(RpcError::internal_error(format!("Template creation failed: {}", e)));
2025-11-10T00:08:56.6907109Z +                return Err(RpcError::internal_error(format!(
2025-11-10T00:08:56.6907282Z +                    "Template creation failed: {}",
2025-11-10T00:08:56.6907466Z +                    e
2025-11-10T00:08:56.6907624Z +                )));
2025-11-10T00:08:56.6907742Z              }
2025-11-10T00:08:56.6907869Z          };
2025-11-10T00:08:56.6907988Z -        
2025-11-10T00:08:56.6908097Z +
2025-11-10T00:08:56.6908526Z          // 6. Convert to JSON-RPC format (BIP 22/23)
2025-11-10T00:08:56.6908783Z          self.template_to_json_rpc(&template, &prev_header, height)
2025-11-10T00:08:56.6908884Z      }
2025-11-10T00:08:56.6909304Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:174:
2025-11-10T00:08:56.6909402Z -    
2025-11-10T00:08:56.6909504Z +
2025-11-10T00:08:56.6909675Z      /// Convert BlockTemplate to JSON-RPC format
2025-11-10T00:08:56.6909810Z      fn template_to_json_rpc(
2025-11-10T00:08:56.6909929Z          &self,
2025-11-10T00:08:56.6918045Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:181:
2025-11-10T00:08:56.6918256Z      ) -> RpcResult<Value> {
2025-11-10T00:08:56.6918494Z          // Convert previous block hash to hex (big-endian)
2025-11-10T00:08:56.6918780Z          let prev_hash_hex = hex::encode(prev_header.prev_block_hash);
2025-11-10T00:08:56.6918892Z -        
2025-11-10T00:08:56.6919011Z +
2025-11-10T00:08:56.6919253Z          // Convert target to hex (64 characters, big-endian)
2025-11-10T00:08:56.6919485Z          let target_hex = format!("{:064x}", template.target);
2025-11-10T00:08:56.6919607Z -        
2025-11-10T00:08:56.6919727Z +
2025-11-10T00:08:56.6919883Z          // Convert bits to hex (8 characters)
2025-11-10T00:08:56.6920102Z          let bits_hex = format!("{:08x}", template.header.bits);
2025-11-10T00:08:56.6920222Z -        
2025-11-10T00:08:56.6920327Z +
2025-11-10T00:08:56.6920484Z          // Convert transactions to JSON array
2025-11-10T00:08:56.6920749Z -        let transactions_json: Vec<Value> = template.transactions
2025-11-10T00:08:56.6920932Z +        let transactions_json: Vec<Value> = template
2025-11-10T00:08:56.6921059Z +            .transactions
2025-11-10T00:08:56.6921168Z              .iter()
2025-11-10T00:08:56.6921352Z              .map(|tx| self.transaction_to_json(tx))
2025-11-10T00:08:56.6921479Z              .collect();
2025-11-10T00:08:56.6921937Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:196:
2025-11-10T00:08:56.6922072Z -        
2025-11-10T00:08:56.6922181Z +
2025-11-10T00:08:56.6922365Z          // Calculate coinbase value (subsidy + fees)
2025-11-10T00:08:56.6922675Z          let coinbase_value = self.calculate_coinbase_value(template, height);
2025-11-10T00:08:56.6922798Z -        
2025-11-10T00:08:56.6922901Z +
2025-11-10T00:08:56.6923063Z          // Get active rules (BIP 9 feature flags)
2025-11-10T00:08:56.6923229Z          let rules = self.get_active_rules(height);
2025-11-10T00:08:56.6923327Z -        
2025-11-10T00:08:56.6923420Z +
2025-11-10T00:08:56.6923562Z          // Get minimum time (median time + 1)
2025-11-10T00:08:56.6923724Z          let min_time = self.get_min_time(height);
2025-11-10T00:08:56.6923820Z -        
2025-11-10T00:08:56.6923913Z +
2025-11-10T00:08:56.6924028Z          Ok(json!({
2025-11-10T00:08:56.6924185Z              "capabilities": ["proposal"],
2025-11-10T00:08:56.6924561Z              "version": template.header.version as i32,
2025-11-10T00:08:56.6925284Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:228:
2025-11-10T00:08:56.6925436Z              "height": template.height
2025-11-10T00:08:56.6925535Z          }))
2025-11-10T00:08:56.6925629Z      }
2025-11-10T00:08:56.6925731Z -    
2025-11-10T00:08:56.6925826Z +
2025-11-10T00:08:56.6926015Z      // Helper methods - access chainstate and mempool
2025-11-10T00:08:56.6926110Z -    
2025-11-10T00:08:56.6926210Z +
2025-11-10T00:08:56.6926452Z      fn get_current_height(&self) -> RpcResult<Option<Natural>> {
2025-11-10T00:08:56.6926621Z          if let Some(ref storage) = self.storage {
2025-11-10T00:08:56.6926780Z -            storage.chain().get_height()
2025-11-10T00:08:56.6926886Z +            storage
2025-11-10T00:08:56.6926994Z +                .chain()
2025-11-10T00:08:56.6927107Z +                .get_height()
2025-11-10T00:08:56.6927454Z                  .map_err(|e| RpcError::internal_error(format!("Failed to get height: {}", e)))
2025-11-10T00:08:56.6927772Z          } else {
2025-11-10T00:08:56.6927890Z              Ok(None)
2025-11-10T00:08:56.6928350Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:240:
2025-11-10T00:08:56.6928464Z          }
2025-11-10T00:08:56.6928563Z      }
2025-11-10T00:08:56.6928664Z -    
2025-11-10T00:08:56.6928760Z +
2025-11-10T00:08:56.6928991Z      fn get_tip_header(&self) -> RpcResult<Option<BlockHeader>> {
2025-11-10T00:08:56.6929149Z          if let Some(ref storage) = self.storage {
2025-11-10T00:08:56.6929304Z -            storage.chain().get_tip_header()
2025-11-10T00:08:56.6929405Z +            storage
2025-11-10T00:08:56.6929524Z +                .chain()
2025-11-10T00:08:56.6929658Z +                .get_tip_header()
2025-11-10T00:08:56.6930003Z                  .map_err(|e| RpcError::internal_error(format!("Failed to get tip header: {}", e)))
2025-11-10T00:08:56.6930105Z          } else {
2025-11-10T00:08:56.6930209Z              Ok(None)
2025-11-10T00:08:56.6930632Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:249:
2025-11-10T00:08:56.6930738Z          }
2025-11-10T00:08:56.6930831Z      }
2025-11-10T00:08:56.6930932Z -    
2025-11-10T00:08:56.6931030Z +
2025-11-10T00:08:56.6931307Z      fn get_headers_for_difficulty(&self) -> RpcResult<Vec<BlockHeader>> {
2025-11-10T00:08:56.6931464Z          if let Some(ref storage) = self.storage {
2025-11-10T00:08:56.6931654Z              // Get last 2016 headers for difficulty adjustment
2025-11-10T00:08:56.6932084Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:255:
2025-11-10T00:08:56.6932385Z              // For now, return just the tip (full implementation would get last 2016)
2025-11-10T00:08:56.6932592Z -            if let Some(tip) = storage.chain().get_tip_header()
2025-11-10T00:08:56.6932731Z +            if let Some(tip) = storage
2025-11-10T00:08:56.6932843Z +                .chain()
2025-11-10T00:08:56.6932976Z +                .get_tip_header()
2025-11-10T00:08:56.6933293Z                  .map_err(|e| RpcError::internal_error(format!("Failed to get tip: {}", e)))?
2025-11-10T00:08:56.6933401Z              {
2025-11-10T00:08:56.6933522Z                  Ok(vec![tip])
2025-11-10T00:08:56.6934007Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:264:
2025-11-10T00:08:56.6934115Z              Ok(vec![])
2025-11-10T00:08:56.6934217Z          }
2025-11-10T00:08:56.6934499Z      }
2025-11-10T00:08:56.6934614Z -    
2025-11-10T00:08:56.6934715Z +
2025-11-10T00:08:56.6934997Z      fn get_mempool_transactions(&self) -> RpcResult<Vec<Transaction>> {
2025-11-10T00:08:56.6935163Z          if let Some(ref mempool) = self.mempool {
2025-11-10T00:08:56.6935309Z              // Get UTXO set for fee calculation
2025-11-10T00:08:56.6935707Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:271:
2025-11-10T00:08:56.6935860Z              let utxo_set = self.get_utxo_set()?;
2025-11-10T00:08:56.6936220Z -            
2025-11-10T00:08:56.6936336Z +
2025-11-10T00:08:56.6936730Z              // Get prioritized transactions (limit to reasonable number for block template)
2025-11-10T00:08:56.6936867Z              let limit = 1000;
2025-11-10T00:08:56.6937127Z              Ok(mempool.get_prioritized_transactions(limit, &utxo_set))
2025-11-10T00:08:56.6937556Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:277:
2025-11-10T00:08:56.6937682Z              Ok(vec![])
2025-11-10T00:08:56.6937794Z          }
2025-11-10T00:08:56.6937896Z      }
2025-11-10T00:08:56.6938138Z -    
2025-11-10T00:08:56.6938247Z +
2025-11-10T00:08:56.6938489Z      /// Calculate difficulty from bits (compact target format)
2025-11-10T00:08:56.6938757Z      /// Uses the same logic as BlockchainRpc::calculate_difficulty
2025-11-10T00:08:56.6938950Z      fn calculate_difficulty(bits: u64) -> f64 {
2025-11-10T00:08:56.6939390Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:284:
2025-11-10T00:08:56.6939797Z          // Difficulty = MAX_TARGET / target
2025-11-10T00:08:56.6940287Z          // MAX_TARGET for Bitcoin mainnet is 0x00000000FFFF0000000000000000000000000000000000000000000000000000
2025-11-10T00:08:56.6940580Z          // For display purposes, we normalize to genesis difficulty = 1.0
2025-11-10T00:08:56.6941130Z -        const MAX_TARGET: u128 = 0x00000000FFFF0000000000000000000000000000000000000000000000000000u128;
2025-11-10T00:08:56.6941259Z -        
2025-11-10T00:08:56.6941402Z +        const MAX_TARGET: u128 =
2025-11-10T00:08:56.6941731Z +            0x00000000FFFF0000000000000000000000000000000000000000000000000000u128;
2025-11-10T00:08:56.6941838Z +
2025-11-10T00:08:56.6942094Z          // Simplified difficulty calculation using bits directly
2025-11-10T00:08:56.6942382Z          // For display purposes, use a simple approximation based on bits
2025-11-10T00:08:56.6942554Z          let mantissa = (bits & 0x00ffffff) as f64;
2025-11-10T00:08:56.6943019Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:295:
2025-11-10T00:08:56.6943183Z          let max_mantissa = 0x00ffff00 as f64;
2025-11-10T00:08:56.6943338Z          (max_mantissa / mantissa).max(1.0)
2025-11-10T00:08:56.6943457Z      }
2025-11-10T00:08:56.6943640Z -    
2025-11-10T00:08:56.6943749Z +
2025-11-10T00:08:56.6944000Z      /// Calculate network hashrate from recent block timestamps
2025-11-10T00:08:56.6944442Z      /// Estimates hashrate based on the time between recent blocks
2025-11-10T00:08:56.6944850Z      fn calculate_network_hashrate(&self, storage: &Storage) -> Result<f64, anyhow::Error> {
2025-11-10T00:08:56.6945278Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:302:
2025-11-10T00:08:56.6945428Z          // Get tip height
2025-11-10T00:08:56.6945618Z -        let tip_height = storage.chain().get_height()?
2025-11-10T00:08:56.6945759Z +        let tip_height = storage
2025-11-10T00:08:56.6945894Z +            .chain()
2025-11-10T00:08:56.6946021Z +            .get_height()?
2025-11-10T00:08:56.6946245Z              .ok_or_else(|| anyhow::anyhow!("Chain not initialized"))?;
2025-11-10T00:08:56.6946350Z -        
2025-11-10T00:08:56.6946451Z +
2025-11-10T00:08:56.6946622Z          // Need at least 2 blocks to calculate hashrate
2025-11-10T00:08:56.6946742Z          if tip_height < 1 {
2025-11-10T00:08:56.6946860Z              return Ok(0.0);
2025-11-10T00:08:56.6947270Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:309:
2025-11-10T00:08:56.6947379Z          }
2025-11-10T00:08:56.6947485Z -        
2025-11-10T00:08:56.6947593Z +
2025-11-10T00:08:56.6947820Z          // Get last 144 blocks (approximately 1 day at 10 min/block)
2025-11-10T00:08:56.6947977Z          // Or use fewer blocks if chain is shorter
2025-11-10T00:08:56.6948145Z          let num_blocks = (tip_height + 1).min(144);
2025-11-10T00:08:56.6948548Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:314:
2025-11-10T00:08:56.6949044Z          let start_height = tip_height.saturating_sub(num_blocks - 1);
2025-11-10T00:08:56.6949166Z -        
2025-11-10T00:08:56.6949274Z +
2025-11-10T00:08:56.6949429Z          // Get timestamps from blocks
2025-11-10T00:08:56.6949594Z          let mut timestamps = Vec::new();
2025-11-10T00:08:56.6949775Z          for height in start_height..=tip_height {
2025-11-10T00:08:56.6950211Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:322:
2025-11-10T00:08:56.6950327Z                  }
2025-11-10T00:08:56.6950442Z              }
2025-11-10T00:08:56.6950547Z          }
2025-11-10T00:08:56.6950651Z -        
2025-11-10T00:08:56.6950752Z +
2025-11-10T00:08:56.6950905Z          if timestamps.len() < 2 {
2025-11-10T00:08:56.6951034Z              return Ok(0.0);
2025-11-10T00:08:56.6953044Z          }
2025-11-10T00:08:56.6953492Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:329:
2025-11-10T00:08:56.6953834Z -        
2025-11-10T00:08:56.6953941Z +
2025-11-10T00:08:56.6954108Z          // Calculate average time between blocks
2025-11-10T00:08:56.6954505Z          let first_timestamp = timestamps[0].1;
2025-11-10T00:08:56.6954770Z          let last_timestamp = timestamps[timestamps.len() - 1].1;
2025-11-10T00:08:56.6955210Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:333:
2025-11-10T00:08:56.6955498Z          let time_span = last_timestamp.saturating_sub(first_timestamp);
2025-11-10T00:08:56.6955685Z          let num_intervals = timestamps.len() - 1;
2025-11-10T00:08:56.6955802Z -        
2025-11-10T00:08:56.6955912Z +
2025-11-10T00:08:56.6956087Z          if time_span == 0 || num_intervals == 0 {
2025-11-10T00:08:56.6956216Z              return Ok(0.0);
2025-11-10T00:08:56.6956327Z          }
2025-11-10T00:08:56.6956759Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:339:
2025-11-10T00:08:56.6956889Z -        
2025-11-10T00:08:56.6956998Z +
2025-11-10T00:08:56.6957268Z          let avg_time_per_block = time_span as f64 / num_intervals as f64;
2025-11-10T00:08:56.6957390Z -        
2025-11-10T00:08:56.6957496Z +
2025-11-10T00:08:56.6957644Z          // Get difficulty from tip block
2025-11-10T00:08:56.6957918Z -        let tip_hash = storage.blocks().get_hash_by_height(tip_height)?
2025-11-10T00:08:56.6958048Z +        let tip_hash = storage
2025-11-10T00:08:56.6958164Z +            .blocks()
2025-11-10T00:08:56.6958318Z +            .get_hash_by_height(tip_height)?
2025-11-10T00:08:56.6958552Z              .ok_or_else(|| anyhow::anyhow!("Tip block not found"))?;
2025-11-10T00:08:56.6958772Z -        let tip_block = storage.blocks().get_block(&tip_hash)?
2025-11-10T00:08:56.6958896Z +        let tip_block = storage
2025-11-10T00:08:56.6959013Z +            .blocks()
2025-11-10T00:08:56.6959140Z +            .get_block(&tip_hash)?
2025-11-10T00:08:56.6959350Z              .ok_or_else(|| anyhow::anyhow!("Tip block not found"))?;
2025-11-10T00:08:56.6959658Z          let difficulty = Self::calculate_difficulty(tip_block.header.bits);
2025-11-10T00:08:56.6959768Z -        
2025-11-10T00:08:56.6959877Z +
2025-11-10T00:08:56.6960142Z          // Calculate hashrate: difficulty * 2^32 / avg_time_per_block
2025-11-10T00:08:56.6960405Z          // This estimates the network hashrate in hashes per second
2025-11-10T00:08:56.6960763Z          // 2^32 is the number of hashes needed on average to find a block at difficulty 1.0
2025-11-10T00:08:56.6961221Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:352:
2025-11-10T00:08:56.6961461Z          const HASHES_PER_DIFFICULTY: f64 = 4294967296.0; // 2^32
2025-11-10T00:08:56.6961789Z          let hashrate = (difficulty * HASHES_PER_DIFFICULTY) / avg_time_per_block;
2025-11-10T00:08:56.6961899Z -        
2025-11-10T00:08:56.6962019Z +
2025-11-10T00:08:56.6962144Z          Ok(hashrate)
2025-11-10T00:08:56.6962263Z      }
2025-11-10T00:08:56.6962612Z -    
2025-11-10T00:08:56.6964758Z +
2025-11-10T00:08:56.6964961Z      fn get_utxo_set(&self) -> RpcResult<UtxoSet> {
2025-11-10T00:08:56.6965140Z          if let Some(ref storage) = self.storage {
2025-11-10T00:08:56.6965299Z              // Get UTXO set from storage
2025-11-10T00:08:56.6965754Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:361:
2025-11-10T00:08:56.6965914Z -            storage.utxos().get_all_utxos()
2025-11-10T00:08:56.6966029Z +            storage
2025-11-10T00:08:56.6966160Z +                .utxos()
2025-11-10T00:08:56.6966294Z +                .get_all_utxos()
2025-11-10T00:08:56.6966664Z                  .map_err(|e| RpcError::internal_error(format!("Failed to get UTXO set: {}", e)))
2025-11-10T00:08:56.6966793Z          } else {
2025-11-10T00:08:56.6966933Z              Ok(UtxoSet::new())
2025-11-10T00:08:56.6967443Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:365:
2025-11-10T00:08:56.6967851Z          }
2025-11-10T00:08:56.6967959Z      }
2025-11-10T00:08:56.6968065Z -    
2025-11-10T00:08:56.6968169Z +
2025-11-10T00:08:56.6968529Z      fn extract_coinbase_script(&self, params: &Value) -> Option<ByteString> {
2025-11-10T00:08:56.6968745Z          // Extract coinbase script from params if provided
2025-11-10T00:08:56.6968942Z          if let Some(template_request) = params.get(0) {
2025-11-10T00:08:56.6969400Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:379:
2025-11-10T00:08:56.6969547Z          // Default: empty script
2025-11-10T00:08:56.6969668Z          Some(vec![])
2025-11-10T00:08:56.6969779Z      }
2025-11-10T00:08:56.6969902Z -    
2025-11-10T00:08:56.6970007Z +
2025-11-10T00:08:56.6970340Z      fn extract_coinbase_address(&self, params: &Value) -> Option<ByteString> {
2025-11-10T00:08:56.6970563Z          // Extract coinbase address from params if provided
2025-11-10T00:08:56.6970756Z          if let Some(template_request) = params.get(0) {
2025-11-10T00:08:56.6971208Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:393:
2025-11-10T00:08:56.6971328Z          // Default: empty
2025-11-10T00:08:56.6971434Z          Some(vec![])
2025-11-10T00:08:56.6971532Z      }
2025-11-10T00:08:56.6971634Z -    
2025-11-10T00:08:56.6971728Z +
2025-11-10T00:08:56.6971949Z      fn transaction_to_json(&self, tx: &Transaction) -> Value {
2025-11-10T00:08:56.6972129Z          // Convert transaction to JSON-RPC format
2025-11-10T00:08:56.6972301Z          let tx_bytes = serialize_transaction(tx);
2025-11-10T00:08:56.6972963Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:401:
2025-11-10T00:08:56.6973158Z          let fee = self.calculate_transaction_fee(tx);
2025-11-10T00:08:56.6973327Z          let sigops = self.count_sigops(tx);
2025-11-10T00:08:56.6973486Z          let weight = self.calculate_weight(tx);
2025-11-10T00:08:56.6973586Z -        
2025-11-10T00:08:56.6973700Z +
2025-11-10T00:08:56.6973809Z          json!({
2025-11-10T00:08:56.6973954Z              "data": hex::encode(&tx_bytes),
2025-11-10T00:08:56.6974097Z              "txid": hex::encode(tx_hash),
2025-11-10T00:08:56.6974680Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:410:
2025-11-10T00:08:56.6974818Z              "weight": weight,
2025-11-10T00:08:56.6974926Z          })
2025-11-10T00:08:56.6975041Z      }
2025-11-10T00:08:56.6975699Z -    
2025-11-10T00:08:56.6975801Z +
2025-11-10T00:08:56.6976043Z      fn calculate_tx_hash(&self, tx_bytes: &[u8]) -> [u8; 32] {
2025-11-10T00:08:56.6976281Z          // Transaction hash is double SHA256 of transaction bytes
2025-11-10T00:08:56.6976437Z          let hash1 = Sha256::digest(tx_bytes);
2025-11-10T00:08:56.6976868Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:417:
2025-11-10T00:08:56.6977032Z          let hash2 = Sha256::digest(hash1);
2025-11-10T00:08:56.6977145Z -        
2025-11-10T00:08:56.6977483Z +
2025-11-10T00:08:56.6977632Z          let mut result = [0u8; 32];
2025-11-10T00:08:56.6977775Z          result.copy_from_slice(&hash2);
2025-11-10T00:08:56.6977879Z          result
2025-11-10T00:08:56.6978300Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:422:
2025-11-10T00:08:56.6978425Z      }
2025-11-10T00:08:56.6978534Z -    
2025-11-10T00:08:56.6978637Z +
2025-11-10T00:08:56.6978937Z      fn calculate_transaction_fee(&self, tx: &Transaction) -> u64 {
2025-11-10T00:08:56.6979160Z          // Use MempoolManager's fee calculation if available
2025-11-10T00:08:56.6979338Z          if let Some(ref mempool) = self.mempool {
2025-11-10T00:08:56.6979797Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:447:
2025-11-10T00:08:56.6979907Z              0
2025-11-10T00:08:56.6980020Z          }
2025-11-10T00:08:56.6980129Z      }
2025-11-10T00:08:56.6980245Z -    
2025-11-10T00:08:56.6980587Z +
2025-11-10T00:08:56.6980801Z      fn count_sigops(&self, tx: &Transaction) -> u32 {
2025-11-10T00:08:56.6980981Z          // Use consensus layer sigop counting
2025-11-10T00:08:56.6981123Z          #[cfg(feature = "sigop")]
2025-11-10T00:08:56.6981565Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:456:
2025-11-10T00:08:56.6981857Z              // Convert protocol transaction to consensus transaction format
2025-11-10T00:08:56.6982030Z              let consensus_tx = ConsensusTx {
2025-11-10T00:08:56.6982170Z                  version: tx.version,
2025-11-10T00:08:56.6982501Z -                inputs: tx.inputs.iter().map(|inp| bllvm_protocol::TransactionInput {
2025-11-10T00:08:56.6982695Z -                    prevout: bllvm_protocol::OutPoint {
2025-11-10T00:08:56.6982855Z -                        hash: inp.prevout.hash,
2025-11-10T00:08:56.6983014Z -                        index: inp.prevout.index,
2025-11-10T00:08:56.6983129Z -                    },
2025-11-10T00:08:56.6983318Z -                    script_sig: inp.script_sig.clone(),
2025-11-10T00:08:56.6983475Z -                    sequence: inp.sequence,
2025-11-10T00:08:56.6983601Z -                }).collect(),
2025-11-10T00:08:56.6984570Z -                outputs: tx.outputs.iter().map(|out| bllvm_protocol::TransactionOutput {
2025-11-10T00:08:56.6984737Z -                    value: out.value,
2025-11-10T00:08:56.6984939Z -                    script_pubkey: out.script_pubkey.clone(),
2025-11-10T00:08:56.6985077Z -                }).collect(),
2025-11-10T00:08:56.6985204Z +                inputs: tx
2025-11-10T00:08:56.6985332Z +                    .inputs
2025-11-10T00:08:56.6985447Z +                    .iter()
2025-11-10T00:08:56.6985663Z +                    .map(|inp| bllvm_protocol::TransactionInput {
2025-11-10T00:08:56.6985830Z +                        prevout: bllvm_protocol::OutPoint {
2025-11-10T00:08:56.6985991Z +                            hash: inp.prevout.hash,
2025-11-10T00:08:56.6986163Z +                            index: inp.prevout.index,
2025-11-10T00:08:56.6986301Z +                        },
2025-11-10T00:08:56.6986480Z +                        script_sig: inp.script_sig.clone(),
2025-11-10T00:08:56.6986622Z +                        sequence: inp.sequence,
2025-11-10T00:08:56.6986733Z +                    })
2025-11-10T00:08:56.6986846Z +                    .collect(),
2025-11-10T00:08:56.6986959Z +                outputs: tx
2025-11-10T00:08:56.6987077Z +                    .outputs
2025-11-10T00:08:56.6987181Z +                    .iter()
2025-11-10T00:08:56.6987383Z +                    .map(|out| bllvm_protocol::TransactionOutput {
2025-11-10T00:08:56.6987535Z +                        value: out.value,
2025-11-10T00:08:56.6987731Z +                        script_pubkey: out.script_pubkey.clone(),
2025-11-10T00:08:56.6987850Z +                    })
2025-11-10T00:08:56.6987975Z +                    .collect(),
2025-11-10T00:08:56.6988123Z                  lock_time: tx.lock_time,
2025-11-10T00:08:56.6988246Z              };
2025-11-10T00:08:56.6988763Z              use bllvm_protocol::sigop::get_legacy_sigop_count;
2025-11-10T00:08:56.6989236Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:480:
2025-11-10T00:08:56.6989393Z              for output in &tx.outputs {
2025-11-10T00:08:56.6989567Z                  for &byte in &output.script_pubkey {
2025-11-10T00:08:56.6989700Z                      match byte {
2025-11-10T00:08:56.6989935Z -                        0xac => count += 1, // OP_CHECKSIG
2025-11-10T00:08:56.6990112Z -                        0xad => count += 1, // OP_CHECKSIGVERIFY
2025-11-10T00:08:56.6990276Z -                        0xae => count += 1, // OP_CHECKMULTISIG
2025-11-10T00:08:56.6990441Z +                        0xac => count += 1,  // OP_CHECKSIG
2025-11-10T00:08:56.6990614Z +                        0xad => count += 1,  // OP_CHECKSIGVERIFY
2025-11-10T00:08:56.6990776Z +                        0xae => count += 1,  // OP_CHECKMULTISIG
2025-11-10T00:08:56.6991198Z                          0xaf => count += 20, // OP_CHECKMULTISIGVERIFY
2025-11-10T00:08:56.6991324Z                          _ => {}
2025-11-10T00:08:56.6991438Z                      }
2025-11-10T00:08:56.6991878Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:491:
2025-11-10T00:08:56.6992005Z              count
2025-11-10T00:08:56.6992119Z          }
2025-11-10T00:08:56.6992221Z      }
2025-11-10T00:08:56.6992323Z -    
2025-11-10T00:08:56.6992418Z +
2025-11-10T00:08:56.6992626Z      fn calculate_weight(&self, tx: &Transaction) -> u64 {
2025-11-10T00:08:56.6992880Z          // Transaction weight = (base_size * 3) + total_size (for SegWit)
2025-11-10T00:08:56.6993090Z          // For now, return base size * 4 (non-SegWit transaction)
2025-11-10T00:08:56.6993504Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:498:
2025-11-10T00:08:56.6993726Z          let base_size = serialize_transaction(tx).len() as u64;
2025-11-10T00:08:56.6993863Z          base_size * 4
2025-11-10T00:08:56.6993978Z      }
2025-11-10T00:08:56.6994090Z -    
2025-11-10T00:08:56.6994203Z +
2025-11-10T00:08:56.6994765Z      fn calculate_coinbase_value(&self, template: &BlockTemplate, _height: Natural) -> u64 {
2025-11-10T00:08:56.6995043Z          // Use consensus-proof's get_block_subsidy (formally verified)
2025-11-10T00:08:56.6995369Z          let subsidy = self.consensus.get_block_subsidy(template.height) as u64;
2025-11-10T00:08:56.6995820Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:505:
2025-11-10T00:08:56.6995931Z -        
2025-11-10T00:08:56.6996036Z +
2025-11-10T00:08:56.6996214Z          // Calculate total fees from transactions
2025-11-10T00:08:56.6996381Z -        let fees: u64 = template.transactions
2025-11-10T00:08:56.6996515Z +        let fees: u64 = template
2025-11-10T00:08:56.6996643Z +            .transactions
2025-11-10T00:08:56.6996763Z              .iter()
2025-11-10T00:08:56.6996968Z              .map(|tx| self.calculate_transaction_fee(tx))
2025-11-10T00:08:56.6997082Z              .sum();
2025-11-10T00:08:56.6997525Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:511:
2025-11-10T00:08:56.6997640Z -        
2025-11-10T00:08:56.6997744Z +
2025-11-10T00:08:56.6997863Z          subsidy + fees
2025-11-10T00:08:56.6997980Z      }
2025-11-10T00:08:56.6998085Z -    
2025-11-10T00:08:56.6998192Z +
2025-11-10T00:08:56.7000303Z      fn get_active_rules(&self, height: Natural) -> Vec<String> {
2025-11-10T00:08:56.7000498Z          // Determine active BIP 9 rules based on height
2025-11-10T00:08:56.7000788Z          let mut rules = vec!["csv".to_string()]; // CSV always active after height
2025-11-10T00:08:56.7001227Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:518:
2025-11-10T00:08:56.7001327Z -        
2025-11-10T00:08:56.7001529Z -        if height >= 481824 { // SegWit activation (mainnet)
2025-11-10T00:08:56.7001646Z +
2025-11-10T00:08:56.7002000Z +        if height >= 481824 {
2025-11-10T00:08:56.7002145Z +            // SegWit activation (mainnet)
2025-11-10T00:08:56.7002297Z              rules.push("segwit".to_string());
2025-11-10T00:08:56.7002407Z          }
2025-11-10T00:08:56.7002506Z -        
2025-11-10T00:08:56.7002700Z -        if height >= 709632 { // Taproot activation (mainnet)
2025-11-10T00:08:56.7002800Z +
2025-11-10T00:08:56.7002925Z +        if height >= 709632 {
2025-11-10T00:08:56.7003068Z +            // Taproot activation (mainnet)
2025-11-10T00:08:56.7003220Z              rules.push("taproot".to_string());
2025-11-10T00:08:56.7003328Z          }
2025-11-10T00:08:56.7003427Z -        
2025-11-10T00:08:56.7003526Z +
2025-11-10T00:08:56.7003630Z          rules
2025-11-10T00:08:56.7003738Z      }
2025-11-10T00:08:56.7003838Z -    
2025-11-10T00:08:56.7003935Z +
2025-11-10T00:08:56.7004130Z      fn get_min_time(&self, _height: Natural) -> Natural {
2025-11-10T00:08:56.7004488Z          // Get minimum time (median time of last 11 blocks + 1)
2025-11-10T00:08:56.7004812Z          // For now, return current time
2025-11-10T00:08:56.7005233Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:535:
2025-11-10T00:08:56.7005346Z              .unwrap()
2025-11-10T00:08:56.7005470Z              .as_secs() as Natural
2025-11-10T00:08:56.7005582Z      }
2025-11-10T00:08:56.7005697Z -    
2025-11-10T00:08:56.7005803Z +
2025-11-10T00:08:56.7005943Z      /// Submit a block to the network
2025-11-10T00:08:56.7006046Z -    /// 
2025-11-10T00:08:56.7006158Z +    ///
2025-11-10T00:08:56.7006297Z      /// Params: ["hexdata", "dummy"]
2025-11-10T00:08:56.7006589Z      pub async fn submit_block(&self, params: &Value) -> RpcResult<Value> {
2025-11-10T00:08:56.7008386Z          debug!("RPC: submitblock");
2025-11-10T00:08:56.7008846Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:544:
2025-11-10T00:08:56.7008953Z -        
2025-11-10T00:08:56.7009097Z -        let hex_data = params.get(0)
2025-11-10T00:08:56.7009211Z +
2025-11-10T00:08:56.7009335Z +        let hex_data = params
2025-11-10T00:08:56.7009440Z +            .get(0)
2025-11-10T00:08:56.7009577Z              .and_then(|p| p.as_str())
2025-11-10T00:08:56.7009883Z              .ok_or_else(|| RpcError::invalid_params("Missing hexdata parameter"))?;
2025-11-10T00:08:56.7009984Z -        
2025-11-10T00:08:56.7010084Z +
2025-11-10T00:08:56.7010203Z          // Decode hex
2025-11-10T00:08:56.7010361Z          let block_bytes = hex::decode(hex_data)
2025-11-10T00:08:56.7010676Z              .map_err(|e| RpcError::invalid_params(format!("Invalid hex data: {}", e)))?;
2025-11-10T00:08:56.7011104Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:552:
2025-11-10T00:08:56.7011209Z -        
2025-11-10T00:08:56.7011308Z +
2025-11-10T00:08:56.7011438Z          // Deserialize block
2025-11-10T00:08:56.7011734Z          let (block, witnesses) = deserialize_block_with_witnesses(&block_bytes)
2025-11-10T00:08:56.7012121Z              .map_err(|e| RpcError::invalid_params(format!("Failed to deserialize block: {}", e)))?;
2025-11-10T00:08:56.7012538Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:556:
2025-11-10T00:08:56.7012648Z -        
2025-11-10T00:08:56.7012747Z +
2025-11-10T00:08:56.7012878Z          // Get current chain state
2025-11-10T00:08:56.7013042Z -        let height = self.get_current_height()?
2025-11-10T00:08:56.7013162Z +        let height = self
2025-11-10T00:08:56.7013286Z +            .get_current_height()?
2025-11-10T00:08:56.7013554Z              .ok_or_else(|| RpcError::internal_error("Chain not initialized"))?;
2025-11-10T00:08:56.7013703Z          let utxo_set = self.get_utxo_set()?;
2025-11-10T00:08:56.7013805Z -        
2025-11-10T00:08:56.7013904Z +
2025-11-10T00:08:56.7014606Z          // Validate block using consensus layer
2025-11-10T00:08:56.7014967Z          // Note: This validates consensus rules, but doesn't check if block extends chain
2025-11-10T00:08:56.7015325Z          // In production, would also check:
2025-11-10T00:08:56.7015755Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:572:
2025-11-10T00:08:56.7015927Z                  debug!("Block submitted successfully");
2025-11-10T00:08:56.7016048Z                  Ok(json!(null))
2025-11-10T00:08:56.7016150Z              }
2025-11-10T00:08:56.7016346Z -            Ok((ValidationResult::Invalid(reason), _)) => {
2025-11-10T00:08:56.7016635Z -                Err(RpcError::invalid_params(format!("Invalid block: {}", reason)))
2025-11-10T00:08:56.7016737Z -            }
2025-11-10T00:08:56.7016857Z -            Err(e) => {
2025-11-10T00:08:56.7017138Z -                Err(RpcError::internal_error(format!("Validation error: {}", e)))
2025-11-10T00:08:56.7017241Z -            }
2025-11-10T00:08:56.7017616Z +            Ok((ValidationResult::Invalid(reason), _)) => Err(RpcError::invalid_params(format!(
2025-11-10T00:08:56.7018297Z +                "Invalid block: {}",
2025-11-10T00:08:56.7018414Z +                reason
2025-11-10T00:08:56.7018516Z +            ))),
2025-11-10T00:08:56.7018830Z +            Err(e) => Err(RpcError::internal_error(format!("Validation error: {}", e))),
2025-11-10T00:08:56.7018936Z          }
2025-11-10T00:08:56.7019038Z      }
2025-11-10T00:08:56.7019149Z -    
2025-11-10T00:08:56.7019250Z +
2025-11-10T00:08:56.7019379Z      /// Estimate smart fee rate
2025-11-10T00:08:56.7019481Z -    /// 
2025-11-10T00:08:56.7019588Z +    ///
2025-11-10T00:08:56.7020015Z      /// Params: [conf_target (optional, default: 6), estimate_mode (optional, default: "conservative")]
2025-11-10T00:08:56.7020356Z      pub async fn estimate_smart_fee(&self, params: &Value) -> RpcResult<Value> {
2025-11-10T00:08:56.7020521Z          debug!("RPC: estimatesmartfee");
2025-11-10T00:08:56.7020964Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:589:
2025-11-10T00:08:56.7021083Z -        
2025-11-10T00:08:56.7021234Z -        let conf_target = params.get(0)
2025-11-10T00:08:56.7021387Z -            .and_then(|p| p.as_u64())
2025-11-10T00:08:56.7021520Z -            .unwrap_or(6);
2025-11-10T00:08:56.7021628Z -        
2025-11-10T00:08:56.7021789Z -        let estimate_mode = params.get(1)
2025-11-10T00:08:56.7021896Z +
2025-11-10T00:08:56.7022194Z +        let conf_target = params.get(0).and_then(|p| p.as_u64()).unwrap_or(6);
2025-11-10T00:08:56.7022300Z +
2025-11-10T00:08:56.7022449Z +        let estimate_mode = params
2025-11-10T00:08:56.7022561Z +            .get(1)
2025-11-10T00:08:56.7022699Z              .and_then(|p| p.as_str())
2025-11-10T00:08:56.7022851Z              .unwrap_or("conservative");
2025-11-10T00:08:56.7022960Z -        
2025-11-10T00:08:56.7023066Z +
2025-11-10T00:08:56.7023204Z          // Validate estimate_mode
2025-11-10T00:08:56.7023686Z          match estimate_mode {
2025-11-10T00:08:56.7023871Z              "unset" | "economical" | "conservative" => {}
2025-11-10T00:08:56.7024467Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:601:
2025-11-10T00:08:56.7025162Z -            _ => return Err(RpcError::invalid_params(format!("Invalid estimate_mode: {}. Must be 'unset', 'economical', or 'conservative'", estimate_mode)))
2025-11-10T00:08:56.7025281Z +            _ => {
2025-11-10T00:08:56.7025486Z +                return Err(RpcError::invalid_params(format!(
2025-11-10T00:08:56.7025850Z +                    "Invalid estimate_mode: {}. Must be 'unset', 'economical', or 'conservative'",
2025-11-10T00:08:56.7025984Z +                    estimate_mode
2025-11-10T00:08:56.7026095Z +                )))
2025-11-10T00:08:56.7026206Z +            }
2025-11-10T00:08:56.7026326Z          }
2025-11-10T00:08:56.7026436Z -        
2025-11-10T00:08:56.7026546Z +
2025-11-10T00:08:56.7026814Z          // Get mempool transactions and UTXO set for fee calculation
2025-11-10T00:08:56.7027076Z          let mempool_txs = if let Some(ref mempool) = self.mempool {
2025-11-10T00:08:56.7027250Z              let utxo_set = self.get_utxo_set()?;
2025-11-10T00:08:56.7027967Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:608:
2025-11-10T00:08:56.7028101Z          } else {
2025-11-10T00:08:56.7028213Z              vec![]
2025-11-10T00:08:56.7028322Z          };
2025-11-10T00:08:56.7028436Z -        
2025-11-10T00:08:56.7028541Z +
2025-11-10T00:08:56.7028728Z          // Calculate fee rate based on mempool state
2025-11-10T00:08:56.7029088Z          // Simple algorithm: use median fee rate of top transactions
2025-11-10T00:08:56.7029271Z          let fee_rate = if !mempool_txs.is_empty() {
2025-11-10T00:08:56.7029712Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:615:
2025-11-10T00:08:56.7029880Z              let utxo_set = self.get_utxo_set()?;
2025-11-10T00:08:56.7030051Z              let mut fee_rates = Vec::new();
2025-11-10T00:08:56.7030169Z -            
2025-11-10T00:08:56.7030505Z +
2025-11-10T00:08:56.7030931Z              // MempoolManager.get_prioritized_transactions() already calculates fees correctly
2025-11-10T00:08:56.7033076Z              // We can extract fee rates from the prioritized list, but for now calculate directly
2025-11-10T00:08:56.7033227Z              for tx in &mempool_txs {
2025-11-10T00:08:56.7033674Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:621:
2025-11-10T00:08:56.7033967Z                  let fee = self.calculate_transaction_fee(tx); // Now uses UTXO set
2025-11-10T00:08:56.7034165Z                  let size = self.calculate_weight(tx) as usize;
2025-11-10T00:08:56.7034278Z -                
2025-11-10T00:08:56.7034586Z +
2025-11-10T00:08:56.7034725Z                  if size > 0 {
2025-11-10T00:08:56.7034880Z                      // Fee rate in BTC per vbyte
2025-11-10T00:08:56.7035201Z                      let rate = (fee as f64) / (size as f64) / 100_000_000.0; // Convert satoshis to BTC
2025-11-10T00:08:56.7035662Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:627:
2025-11-10T00:08:56.7035824Z                      fee_rates.push(rate);
2025-11-10T00:08:56.7035934Z                  }
2025-11-10T00:08:56.7036055Z              }
2025-11-10T00:08:56.7036164Z -            
2025-11-10T00:08:56.7036270Z +
2025-11-10T00:08:56.7036500Z              // Use median fee rate, or minimum if no transactions
2025-11-10T00:08:56.7036650Z              if !fee_rates.is_empty() {
2025-11-10T00:08:56.7037002Z                  fee_rates.sort_by(|a, b| a.partial_cmp(b).unwrap_or(std::cmp::Ordering::Equal));
2025-11-10T00:08:56.7037435Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:640:
2025-11-10T00:08:56.7037631Z              // No mempool transactions - return minimum fee
2025-11-10T00:08:56.7037754Z              0.00001 // 1 sat/vB
2025-11-10T00:08:56.7037863Z          };
2025-11-10T00:08:56.7037982Z -        
2025-11-10T00:08:56.7038088Z +
2025-11-10T00:08:56.7038248Z          // Adjust based on estimate_mode
2025-11-10T00:08:56.7038439Z          let adjusted_rate = match estimate_mode {
2025-11-10T00:08:56.7038685Z -            "economical" => fee_rate * 0.8, // 20% lower for economical
2025-11-10T00:08:56.7038941Z +            "economical" => fee_rate * 0.8,   // 20% lower for economical
2025-11-10T00:08:56.7039216Z              "conservative" => fee_rate * 1.2, // 20% higher for conservative
2025-11-10T00:08:56.7039345Z              _ => fee_rate,
2025-11-10T00:08:56.7039461Z          };
2025-11-10T00:08:56.7039889Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:650:
2025-11-10T00:08:56.7040012Z -        
2025-11-10T00:08:56.7040120Z +
2025-11-10T00:08:56.7040238Z          Ok(json!({
2025-11-10T00:08:56.7040387Z              "feerate": adjusted_rate,
2025-11-10T00:08:56.7040529Z              "blocks": conf_target
2025-11-10T00:08:56.7041082Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:660:
2025-11-10T00:08:56.7041722Z      pub async fn prioritise_transaction(&self, params: &Value) -> RpcResult<Value> {
2025-11-10T00:08:56.7041897Z          debug!("RPC: prioritisetransaction");
2025-11-10T00:08:56.7042000Z  
2025-11-10T00:08:56.7042135Z -        let txid = params.get(0)
2025-11-10T00:08:56.7042265Z +        let txid = params
2025-11-10T00:08:56.7042377Z +            .get(0)
2025-11-10T00:08:56.7042522Z              .and_then(|p| p.as_str())
2025-11-10T00:08:56.7042879Z              .ok_or_else(|| RpcError::invalid_params("Transaction ID required".to_string()))?;
2025-11-10T00:08:56.7042993Z  
2025-11-10T00:08:56.7043405Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:667:
2025-11-10T00:08:56.7043551Z -        let fee_delta = params.get(1)
2025-11-10T00:08:56.7045788Z +        let fee_delta = params
2025-11-10T00:08:56.7045905Z +            .get(1)
2025-11-10T00:08:56.7046050Z              .and_then(|p| p.as_i64())
2025-11-10T00:08:56.7046734Z              .ok_or_else(|| RpcError::invalid_params("Fee delta required".to_string()))?;
2025-11-10T00:08:56.7046852Z  
2025-11-10T00:08:56.7047293Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:671:
2025-11-10T00:08:56.7047454Z          let hash_bytes = hex::decode(txid)
2025-11-10T00:08:56.7047831Z              .map_err(|e| RpcError::invalid_params(format!("Invalid transaction ID: {}", e)))?;
2025-11-10T00:08:56.7047982Z          if hash_bytes.len() != 32 {
2025-11-10T00:08:56.7048391Z -            return Err(RpcError::invalid_params("Transaction ID must be 32 bytes".to_string()));
2025-11-10T00:08:56.7048572Z +            return Err(RpcError::invalid_params(
2025-11-10T00:08:56.7048770Z +                "Transaction ID must be 32 bytes".to_string(),
2025-11-10T00:08:56.7048880Z +            ));
2025-11-10T00:08:56.7049098Z          }
2025-11-10T00:08:56.7049232Z          let mut hash = [0u8; 32];
2025-11-10T00:08:56.7049384Z          hash.copy_from_slice(&hash_bytes);
2025-11-10T00:08:56.7049843Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:681:
2025-11-10T00:08:56.7050047Z              if mempool.get_transaction(&hash).is_some() {
2025-11-10T00:08:56.7050336Z                  // Note: In production, would update transaction priority/fee delta
2025-11-10T00:08:56.7050490Z                  // For now, just return success
2025-11-10T00:08:56.7050824Z -                debug!("Transaction {} prioritized with fee delta: {}", txid, fee_delta);
2025-11-10T00:08:56.7050946Z +                debug!(
2025-11-10T00:08:56.7051164Z +                    "Transaction {} prioritized with fee delta: {}",
2025-11-10T00:08:56.7051301Z +                    txid, fee_delta
2025-11-10T00:08:56.7051412Z +                );
2025-11-10T00:08:56.7051536Z                  Ok(json!(true))
2025-11-10T00:08:56.7051652Z              } else {
2025-11-10T00:08:56.7051820Z -                Err(RpcError::invalid_params(
2025-11-10T00:08:56.7052051Z -                    format!("Transaction {} not found in mempool", txid)
2025-11-10T00:08:56.7052168Z -                ))
2025-11-10T00:08:56.7052355Z +                Err(RpcError::invalid_params(format!(
2025-11-10T00:08:56.7052529Z +                    "Transaction {} not found in mempool",
2025-11-10T00:08:56.7052647Z +                    txid
2025-11-10T00:08:56.7052759Z +                )))
2025-11-10T00:08:56.7052876Z              }
2025-11-10T00:08:56.7052987Z          } else {
2025-11-10T00:08:56.7053303Z -            Err(RpcError::internal_error("Mempool not initialized".to_string()))
2025-11-10T00:08:56.7053470Z +            Err(RpcError::internal_error(
2025-11-10T00:08:56.7053643Z +                "Mempool not initialized".to_string(),
2025-11-10T00:08:56.7053754Z +            ))
2025-11-10T00:08:56.7053865Z          }
2025-11-10T00:08:56.7053982Z      }
2025-11-10T00:08:56.7054084Z  }
2025-11-10T00:08:56.7054711Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:696:
2025-11-10T00:08:56.7054924Z  
2025-11-10T00:08:56.7055328Z  impl Default for MiningRpc {
2025-11-10T00:08:56.7055496Z -    fn default() -> Self { Self::new() }
2025-11-10T00:08:56.7055636Z +    fn default() -> Self {
2025-11-10T00:08:56.7055753Z +        Self::new()
2025-11-10T00:08:56.7055869Z +    }
2025-11-10T00:08:56.7055973Z  }
2025-11-10T00:08:56.7056077Z  
2025-11-10T00:08:56.7056606Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mod.rs:120:
2025-11-10T00:08:56.7056744Z          self.mining_rpc =
2025-11-10T00:08:56.7057137Z              mining::MiningRpc::with_dependencies(Arc::clone(&storage), Arc::clone(&mempool));
2025-11-10T00:08:56.7057579Z          self.blockchain_rpc = blockchain::BlockchainRpc::with_dependencies(Arc::clone(&storage));
2025-11-10T00:08:56.7058075Z -        let mempool_rpc = mempool::MempoolRpc::with_dependencies(Arc::clone(&mempool), Arc::clone(&storage));
2025-11-10T00:08:56.7058209Z +        let mempool_rpc =
2025-11-10T00:08:56.7058836Z +            mempool::MempoolRpc::with_dependencies(Arc::clone(&mempool), Arc::clone(&storage));
2025-11-10T00:08:56.7059072Z          let rawtx_rpc = rawtx::RawTxRpc::with_dependencies(
2025-11-10T00:08:56.7059212Z              Arc::clone(&storage),
2025-11-10T00:08:56.7059351Z              Arc::clone(&mempool),
2025-11-10T00:08:56.7059776Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mod.rs:148:
2025-11-10T00:08:56.7059885Z      }
2025-11-10T00:08:56.7059987Z  
2025-11-10T00:08:56.7060146Z      /// Set network manager dependency
2025-11-10T00:08:56.7060618Z -    pub fn with_network_manager(mut self, network_manager: Arc<crate::network::NetworkManager>) -> Self {
2025-11-10T00:08:56.7060766Z +    pub fn with_network_manager(
2025-11-10T00:08:56.7060883Z +        mut self,
2025-11-10T00:08:56.7061128Z +        network_manager: Arc<crate::network::NetworkManager>,
2025-11-10T00:08:56.7061249Z +    ) -> Self {
2025-11-10T00:08:56.7061669Z          self.network_rpc = network::NetworkRpc::with_dependencies(Arc::clone(&network_manager));
2025-11-10T00:08:56.7061888Z          self.network_manager = Some(network_manager);
2025-11-10T00:08:56.7062002Z          self
2025-11-10T00:08:56.7062416Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mod.rs:196:
2025-11-10T00:08:56.7062536Z          ));
2025-11-10T00:08:56.7062642Z  
2025-11-10T00:08:56.7062828Z          // Create server with or without authentication
2025-11-10T00:08:56.7063280Z -        let server = if let (Some(ref storage), Some(ref mempool)) = (self.storage.as_ref(), self.mempool.as_ref()) {
2025-11-10T00:08:56.7063744Z -            let blockchain = Arc::new(blockchain::BlockchainRpc::with_dependencies(Arc::clone(storage)));
2025-11-10T00:08:56.7064269Z -            let mempool_rpc = Arc::new(mempool::MempoolRpc::with_dependencies(Arc::clone(mempool), Arc::clone(&storage)));
2025-11-10T00:08:56.7064968Z -            let rawtx_rpc = Arc::new(rawtx::RawTxRpc::with_dependencies(Arc::clone(storage), Arc::clone(mempool), None, None));
2025-11-10T00:08:56.7065440Z -            let mining = Arc::new(mining::MiningRpc::with_dependencies(Arc::clone(storage), Arc::clone(mempool)));
2025-11-10T00:08:56.7065669Z +        let server = if let (Some(ref storage), Some(ref mempool)) =
2025-11-10T00:08:56.7065848Z +            (self.storage.as_ref(), self.mempool.as_ref())
2025-11-10T00:08:56.7065954Z +        {
2025-11-10T00:08:56.7066314Z +            let blockchain = Arc::new(blockchain::BlockchainRpc::with_dependencies(Arc::clone(
2025-11-10T00:08:56.7066442Z +                storage,
2025-11-10T00:08:56.7066561Z +            )));
2025-11-10T00:08:56.7066850Z +            let mempool_rpc = Arc::new(mempool::MempoolRpc::with_dependencies(
2025-11-10T00:08:56.7067000Z +                Arc::clone(mempool),
2025-11-10T00:08:56.7067144Z +                Arc::clone(&storage),
2025-11-10T00:08:56.7067257Z +            ));
2025-11-10T00:08:56.7067510Z +            let rawtx_rpc = Arc::new(rawtx::RawTxRpc::with_dependencies(
2025-11-10T00:08:56.7067654Z +                Arc::clone(storage),
2025-11-10T00:08:56.7068085Z +                Arc::clone(mempool),
2025-11-10T00:08:56.7068205Z +                None,
2025-11-10T00:08:56.7068325Z +                None,
2025-11-10T00:08:56.7068435Z +            ));
2025-11-10T00:08:56.7068697Z +            let mining = Arc::new(mining::MiningRpc::with_dependencies(
2025-11-10T00:08:56.7068832Z +                Arc::clone(storage),
2025-11-10T00:08:56.7068968Z +                Arc::clone(mempool),
2025-11-10T00:08:56.7069085Z +            ));
2025-11-10T00:08:56.7069375Z              let network = if let Some(ref network_manager) = self.network_manager {
2025-11-10T00:08:56.7069741Z -                Arc::new(network::NetworkRpc::with_dependencies(Arc::clone(network_manager)))
2025-11-10T00:08:56.7070001Z +                Arc::new(network::NetworkRpc::with_dependencies(Arc::clone(
2025-11-10T00:08:56.7070140Z +                    network_manager,
2025-11-10T00:08:56.7070253Z +                )))
2025-11-10T00:08:56.7070572Z              } else {
2025-11-10T00:08:56.7070753Z                  Arc::new(network::NetworkRpc::new())
2025-11-10T00:08:56.7070852Z              };
2025-11-10T00:08:56.7071245Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mod.rs:209:
2025-11-10T00:08:56.7071350Z -            
2025-11-10T00:08:56.7071456Z +
2025-11-10T00:08:56.7071613Z              // Use auth manager if configured
2025-11-10T00:08:56.7071818Z              if let Some(ref auth_manager) = self.auth_manager {
2025-11-10T00:08:56.7072024Z                  server::RpcServer::with_dependencies_and_auth(
2025-11-10T00:08:56.7072432Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mod.rs:233:
2025-11-10T00:08:56.7072544Z          } else {
2025-11-10T00:08:56.7072894Z              // No dependencies - use auth if configured
2025-11-10T00:08:56.7073080Z              if let Some(ref auth_manager) = self.auth_manager {
2025-11-10T00:08:56.7073227Z -                server::RpcServer::with_auth(
2025-11-10T00:08:56.7073371Z -                    self.server_addr,
2025-11-10T00:08:56.7073507Z -                    Arc::clone(auth_manager),
2025-11-10T00:08:56.7073607Z -                )
2025-11-10T00:08:56.7073914Z +                server::RpcServer::with_auth(self.server_addr, Arc::clone(auth_manager))
2025-11-10T00:08:56.7074025Z              } else {
2025-11-10T00:08:56.7074192Z                  server::RpcServer::new(self.server_addr)
2025-11-10T00:08:56.7074446Z              }
2025-11-10T00:08:56.7074974Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:18:
2025-11-10T00:08:56.7075103Z  impl NetworkRpc {
2025-11-10T00:08:56.7075252Z      /// Create a new network RPC handler
2025-11-10T00:08:56.7075382Z      pub fn new() -> Self {
2025-11-10T00:08:56.7075520Z -        Self { network_manager: None }
2025-11-10T00:08:56.7075621Z +        Self {
2025-11-10T00:08:56.7075746Z +            network_manager: None,
2025-11-10T00:08:56.7075856Z +        }
2025-11-10T00:08:56.7075957Z      }
2025-11-10T00:08:56.7076053Z  
2025-11-10T00:08:56.7076180Z      /// Create with dependencies
2025-11-10T00:08:56.7077015Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:25:
2025-11-10T00:08:56.7077331Z      pub fn with_dependencies(network_manager: Arc<NetworkManager>) -> Self {
2025-11-10T00:08:56.7077509Z -        Self { network_manager: Some(network_manager) }
2025-11-10T00:08:56.7077614Z +        Self {
2025-11-10T00:08:56.7077772Z +            network_manager: Some(network_manager),
2025-11-10T00:08:56.7077870Z +        }
2025-11-10T00:08:56.7077970Z      }
2025-11-10T00:08:56.7078070Z  
2025-11-10T00:08:56.7078214Z      /// Get network information
2025-11-10T00:08:56.7078674Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:103:
2025-11-10T00:08:56.7078883Z          if let Some(ref network) = self.network_manager {
2025-11-10T00:08:56.7079068Z              let peer_manager = network.peer_manager();
2025-11-10T00:08:56.7079568Z              let peer_addresses = peer_manager.peer_addresses();
2025-11-10T00:08:56.7079831Z -            let peers: Vec<Value> = peer_addresses.iter().map(|addr| {
2025-11-10T00:08:56.7080038Z -                if let Some(peer) = peer_manager.get_peer(addr) {
2025-11-10T00:08:56.7080165Z -                    json!({
2025-11-10T00:08:56.7080517Z -                        "id": addr.port().unwrap_or(0) as u64, // Use port as peer ID (unique per connection)
2025-11-10T00:08:56.7080687Z -                        "addr": addr.to_string(),
2025-11-10T00:08:56.7080832Z -                        "addrlocal": "",
2025-11-10T00:08:56.7080982Z -                        "services": "0000000000000001",
2025-11-10T00:08:56.7081135Z -                        "relaytxes": true,
2025-11-10T00:08:56.7081297Z -                        "lastsend": peer.last_send(),
2025-11-10T00:08:56.7081454Z -                        "lastrecv": peer.last_recv(),
2025-11-10T00:08:56.7081838Z -                        "bytessent": peer.bytes_sent(),
2025-11-10T00:08:56.7082007Z -                        "bytesrecv": peer.bytes_recv(),
2025-11-10T00:08:56.7082173Z -                        "conntime": peer.conntime(),
2025-11-10T00:08:56.7082313Z -                        "timeoffset": 0,
2025-11-10T00:08:56.7082456Z -                        "pingtime": 0.0,
2025-11-10T00:08:56.7082595Z -                        "minping": 0.0,
2025-11-10T00:08:56.7082736Z -                        "version": 70015,
2025-11-10T00:08:56.7082916Z -                        "subver": "/reference-node:0.1.0/",
2025-11-10T00:08:56.7083054Z -                        "inbound": false,
2025-11-10T00:08:56.7083190Z -                        "addnode": false,
2025-11-10T00:08:56.7083354Z -                        "startingheight": 0,
2025-11-10T00:08:56.7083507Z -                        "synced_headers": -1,
2025-11-10T00:08:56.7083652Z -                        "synced_blocks": -1,
2025-11-10T00:08:56.7083782Z -                        "inflight": [],
2025-11-10T00:08:56.7083950Z -                        "whitelisted": false,
2025-11-10T00:08:56.7084102Z -                        "minfeefilter": 0.00001000,
2025-11-10T00:08:56.7084256Z -                        "bytessent_per_msg": {},
2025-11-10T00:08:56.7084602Z -                        "bytesrecv_per_msg": {}
2025-11-10T00:08:56.7084722Z -                    })
2025-11-10T00:08:56.7084840Z -                } else {
2025-11-10T00:08:56.7084959Z -                    json!({})
2025-11-10T00:08:56.7085079Z -                }
2025-11-10T00:08:56.7085202Z -            }).collect();
2025-11-10T00:08:56.7085372Z +            let peers: Vec<Value> = peer_addresses
2025-11-10T00:08:56.7085496Z +                .iter()
2025-11-10T00:08:56.7085616Z +                .map(|addr| {
2025-11-10T00:08:56.7085833Z +                    if let Some(peer) = peer_manager.get_peer(addr) {
2025-11-10T00:08:56.7085960Z +                        json!({
2025-11-10T00:08:56.7086318Z +                            "id": addr.port().unwrap_or(0) as u64, // Use port as peer ID (unique per connection)
2025-11-10T00:08:56.7086484Z +                            "addr": addr.to_string(),
2025-11-10T00:08:56.7086623Z +                            "addrlocal": "",
2025-11-10T00:08:56.7086781Z +                            "services": "0000000000000001",
2025-11-10T00:08:56.7086947Z +                            "relaytxes": true,
2025-11-10T00:08:56.7087104Z +                            "lastsend": peer.last_send(),
2025-11-10T00:08:56.7087259Z +                            "lastrecv": peer.last_recv(),
2025-11-10T00:08:56.7087430Z +                            "bytessent": peer.bytes_sent(),
2025-11-10T00:08:56.7087596Z +                            "bytesrecv": peer.bytes_recv(),
2025-11-10T00:08:56.7087761Z +                            "conntime": peer.conntime(),
2025-11-10T00:08:56.7087902Z +                            "timeoffset": 0,
2025-11-10T00:08:56.7088050Z +                            "pingtime": 0.0,
2025-11-10T00:08:56.7088188Z +                            "minping": 0.0,
2025-11-10T00:08:56.7088566Z +                            "version": 70015,
2025-11-10T00:08:56.7097544Z +                            "subver": "/reference-node:0.1.0/",
2025-11-10T00:08:56.7097768Z +                            "inbound": false,
2025-11-10T00:08:56.7097932Z +                            "addnode": false,
2025-11-10T00:08:56.7098088Z +                            "startingheight": 0,
2025-11-10T00:08:56.7098244Z +                            "synced_headers": -1,
2025-11-10T00:08:56.7098399Z +                            "synced_blocks": -1,
2025-11-10T00:08:56.7098557Z +                            "inflight": [],
2025-11-10T00:08:56.7098707Z +                            "whitelisted": false,
2025-11-10T00:08:56.7098955Z +                            "minfeefilter": 0.00001000,
2025-11-10T00:08:56.7099129Z +                            "bytessent_per_msg": {},
2025-11-10T00:08:56.7099292Z +                            "bytesrecv_per_msg": {}
2025-11-10T00:08:56.7099762Z +                        })
2025-11-10T00:08:56.7099899Z +                    } else {
2025-11-10T00:08:56.7100043Z +                        json!({})
2025-11-10T00:08:56.7100162Z +                    }
2025-11-10T00:08:56.7100272Z +                })
2025-11-10T00:08:56.7100406Z +                .collect();
2025-11-10T00:08:56.7100534Z              Ok(json!(peers))
2025-11-10T00:08:56.7100647Z          } else {
2025-11-10T00:08:56.7100772Z              Ok(json!([]))
2025-11-10T00:08:56.7101247Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:164:
2025-11-10T00:08:56.7101984Z          if let Some(ref network) = self.network_manager {
2025-11-10T00:08:56.7102160Z              // Send ping to all peers
2025-11-10T00:08:56.7102380Z              if let Err(e) = network.ping_all_peers().await {
2025-11-10T00:08:56.7102760Z -                return Err(RpcError::internal_error(format!("Failed to ping peers: {}", e)));
2025-11-10T00:08:56.7102972Z +                return Err(RpcError::internal_error(format!(
2025-11-10T00:08:56.7103154Z +                    "Failed to ping peers: {}",
2025-11-10T00:08:56.7103278Z +                    e
2025-11-10T00:08:56.7103387Z +                )));
2025-11-10T00:08:56.7105524Z              }
2025-11-10T00:08:56.7105734Z              debug!("Sent ping to all connected peers");
2025-11-10T00:08:56.7105850Z          }
2025-11-10T00:08:56.7106313Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:205:
2025-11-10T00:08:56.7106463Z                  "onetry" => {
2025-11-10T00:08:56.7106620Z                      // Try to connect to node once
2025-11-10T00:08:56.7106840Z                      if let Err(e) = network.connect_to_peer(addr).await {
2025-11-10T00:08:56.7107269Z -                        return Err(RpcError::internal_error(format!("Failed to connect to {}: {}", addr, e)));
2025-11-10T00:08:56.7107477Z +                        return Err(RpcError::internal_error(format!(
2025-11-10T00:08:56.7107654Z +                            "Failed to connect to {}: {}",
2025-11-10T00:08:56.7107790Z +                            addr, e
2025-11-10T00:08:56.7107916Z +                        )));
2025-11-10T00:08:56.7108025Z                      }
2025-11-10T00:08:56.7108220Z                      debug!("Connected to node {} (onetry)", addr);
2025-11-10T00:08:56.7108360Z                      Ok(json!(null))
2025-11-10T00:08:56.7108800Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:310:
2025-11-10T00:08:56.7108969Z                  active_connection_limit_hits: 0,
2025-11-10T00:08:56.7109139Z                  resource_exhaustion_events: 0,
2025-11-10T00:08:56.7109250Z              };
2025-11-10T00:08:56.7109358Z -            
2025-11-10T00:08:56.7109469Z +
2025-11-10T00:08:56.7109597Z              Ok(json!({
2025-11-10T00:08:56.7109723Z                  "metrics": {
2025-11-10T00:08:56.7110020Z                      "connection_rate_violations": metrics.connection_rate_violations,
2025-11-10T00:08:56.7110756Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:365:
2025-11-10T00:08:56.7110918Z          let addr: SocketAddr = subnet
2025-11-10T00:08:56.7111042Z              .parse()
2025-11-10T00:08:56.7113135Z              .map_err(|_| RpcError::invalid_params(format!("Invalid address/subnet: {}", subnet)))?;
2025-11-10T00:08:56.7113260Z -        
2025-11-10T00:08:56.7113370Z +
2025-11-10T00:08:56.7113545Z          // Parse bantime (seconds) - 0 = permanent
2025-11-10T00:08:56.7113992Z          let bantime = params.get(2).and_then(|p| p.as_u64()).unwrap_or(86400); // Default 24 hours
2025-11-10T00:08:56.7114102Z -        
2025-11-10T00:08:56.7114208Z +
2025-11-10T00:08:56.7114686Z          // Parse absolute (whether bantime is absolute timestamp or relative)
2025-11-10T00:08:56.7115017Z          let absolute = params.get(3).and_then(|p| p.as_bool()).unwrap_or(false);
2025-11-10T00:08:56.7115125Z -        
2025-11-10T00:08:56.7115482Z +
2025-11-10T00:08:56.7115700Z          if let Some(ref network) = self.network_manager {
2025-11-10T00:08:56.7115885Z              use std::time::{SystemTime, UNIX_EPOCH};
2025-11-10T00:08:56.7116023Z              let now = SystemTime::now()
2025-11-10T00:08:56.7116452Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:378:
2025-11-10T00:08:56.7116592Z                  .duration_since(UNIX_EPOCH)
2025-11-10T00:08:56.7117031Z                  .unwrap()
2025-11-10T00:08:56.7117155Z                  .as_secs();
2025-11-10T00:08:56.7117279Z -            
2025-11-10T00:08:56.7117382Z +
2025-11-10T00:08:56.7117541Z              let unban_timestamp = if absolute {
2025-11-10T00:08:56.7117709Z                  bantime // Already a timestamp
2025-11-10T00:08:56.7117849Z              } else if bantime == 0 {
2025-11-10T00:08:56.7118609Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:386:
2025-11-10T00:08:56.7118719Z              } else {
2025-11-10T00:08:56.7118875Z                  now + bantime // Relative ban
2025-11-10T00:08:56.7118977Z              };
2025-11-10T00:08:56.7119077Z -            
2025-11-10T00:08:56.7119183Z +
2025-11-10T00:08:56.7119297Z              match command {
2025-11-10T00:08:56.7119404Z                  "add" => {
2025-11-10T00:08:56.7119573Z                      network.ban_peer(addr, unban_timestamp);
2025-11-10T00:08:56.7119984Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:422:
2025-11-10T00:08:56.7120087Z  
2025-11-10T00:08:56.7120287Z          if let Some(ref network) = self.network_manager {
2025-11-10T00:08:56.7120470Z              let banned = network.get_banned_peers();
2025-11-10T00:08:56.7120784Z -            let result: Vec<Value> = banned.iter().map(|(addr, unban_timestamp)| {
2025-11-10T00:08:56.7120909Z -                json!({
2025-11-10T00:08:56.7121072Z -                    "address": addr.to_string(),
2025-11-10T00:08:56.7121303Z -                    "banned_until": if *unban_timestamp == u64::MAX {
2025-11-10T00:08:56.7121514Z -                        serde_json::Value::Null // Permanent ban
2025-11-10T00:08:56.7121638Z -                    } else {
2025-11-10T00:08:56.7121881Z -                        serde_json::Value::Number((*unban_timestamp).into())
2025-11-10T00:08:56.7121996Z -                    },
2025-11-10T00:08:56.7122234Z -                    "banned_until_absolute": *unban_timestamp == u64::MAX
2025-11-10T00:08:56.7122398Z +            let result: Vec<Value> = banned
2025-11-10T00:08:56.7122517Z +                .iter()
2025-11-10T00:08:56.7122677Z +                .map(|(addr, unban_timestamp)| {
2025-11-10T00:08:56.7122813Z +                    json!({
2025-11-10T00:08:56.7122975Z +                        "address": addr.to_string(),
2025-11-10T00:08:56.7123193Z +                        "banned_until": if *unban_timestamp == u64::MAX {
2025-11-10T00:08:56.7123381Z +                            serde_json::Value::Null // Permanent ban
2025-11-10T00:08:56.7123529Z +                        } else {
2025-11-10T00:08:56.7124050Z +                            serde_json::Value::Number((*unban_timestamp).into())
2025-11-10T00:08:56.7124177Z +                        },
2025-11-10T00:08:56.7124606Z +                        "banned_until_absolute": *unban_timestamp == u64::MAX
2025-11-10T00:08:56.7124727Z +                    })
2025-11-10T00:08:56.7124845Z                  })
2025-11-10T00:08:56.7124973Z -            }).collect();
2025-11-10T00:08:56.7125110Z +                .collect();
2025-11-10T00:08:56.7125243Z              Ok(json!(result))
2025-11-10T00:08:56.7125356Z          } else {
2025-11-10T00:08:56.7125492Z              Ok(json!([]))
2025-11-10T00:08:56.7125955Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:445:
2025-11-10T00:08:56.7126313Z      pub async fn getaddednodeinfo(&self, params: &Value) -> RpcResult<Value> {
2025-11-10T00:08:56.7126486Z          debug!("RPC: getaddednodeinfo");
2025-11-10T00:08:56.7126840Z  
2025-11-10T00:08:56.7126999Z -        let node = params.get(0)
2025-11-10T00:08:56.7127131Z +        let node = params
2025-11-10T00:08:56.7127254Z +            .get(0)
2025-11-10T00:08:56.7127400Z              .and_then(|p| p.as_str())
2025-11-10T00:08:56.7127764Z              .ok_or_else(|| RpcError::invalid_params("Node address required".to_string()))?;
2025-11-10T00:08:56.7127881Z  
2025-11-10T00:08:56.7128334Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:453:
2025-11-10T00:08:56.7128439Z  
2025-11-10T00:08:56.7128642Z          if let Some(ref network) = self.network_manager {
2025-11-10T00:08:56.7128801Z              // Parse node address
2025-11-10T00:08:56.7128969Z -            let addr: SocketAddr = node.parse()
2025-11-10T00:08:56.7129115Z +            let addr: SocketAddr = node
2025-11-10T00:08:56.7129251Z +                .parse()
2025-11-10T00:08:56.7129619Z                  .map_err(|e| RpcError::invalid_params(format!("Invalid node address: {}", e)))?;
2025-11-10T00:08:56.7129748Z  
2025-11-10T00:08:56.7129936Z              // Check if node is in persistent peer list
2025-11-10T00:08:56.7130389Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:494:
2025-11-10T00:08:56.7130732Z      pub async fn getnodeaddresses(&self, params: &Value) -> RpcResult<Value> {
2025-11-10T00:08:56.7130894Z          debug!("RPC: getnodeaddresses");
2025-11-10T00:08:56.7131007Z  
2025-11-10T00:08:56.7131149Z -        let count = params.get(0)
2025-11-10T00:08:56.7131296Z -            .and_then(|p| p.as_u64())
2025-11-10T00:08:56.7131434Z -            .unwrap_or(1)
2025-11-10T00:08:56.7131593Z -            .min(100) as usize; // Limit to 100
2025-11-10T00:08:56.7131997Z +        let count = params.get(0).and_then(|p| p.as_u64()).unwrap_or(1).min(100) as usize; // Limit to 100
2025-11-10T00:08:56.7132110Z  
2025-11-10T00:08:56.7132324Z          if let Some(ref network) = self.network_manager {
2025-11-10T00:08:56.7132470Z              // Get peer addresses
2025-11-10T00:08:56.7134898Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:504:
2025-11-10T00:08:56.7135139Z              let peer_addrs = network.get_peer_addresses().await;
2025-11-10T00:08:56.7135250Z -            
2025-11-10T00:08:56.7135356Z +
2025-11-10T00:08:56.7135521Z              // Convert to node address format
2025-11-10T00:08:56.7135684Z              let mut addresses = Vec::new();
2025-11-10T00:08:56.7135879Z              for addr in peer_addrs.into_iter().take(count) {
2025-11-10T00:08:56.7136330Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:551:
2025-11-10T00:08:56.7136675Z      pub async fn setnetworkactive(&self, params: &Value) -> RpcResult<Value> {
2025-11-10T00:08:56.7136833Z          debug!("RPC: setnetworkactive");
2025-11-10T00:08:56.7136937Z  
2025-11-10T00:08:56.7137085Z -        let state = params.get(0)
2025-11-10T00:08:56.7137226Z -            .and_then(|p| p.as_bool())
2025-11-10T00:08:56.7137642Z -            .ok_or_else(|| RpcError::invalid_params("State parameter required (true/false)".to_string()))?;
2025-11-10T00:08:56.7138144Z +        let state = params.get(0).and_then(|p| p.as_bool()).ok_or_else(|| {
2025-11-10T00:08:56.7138475Z +            RpcError::invalid_params("State parameter required (true/false)".to_string())
2025-11-10T00:08:56.7138581Z +        })?;
2025-11-10T00:08:56.7138688Z  
2025-11-10T00:08:56.7138885Z          if let Some(ref network) = self.network_manager {
2025-11-10T00:08:56.7139046Z -            network.set_network_active(state).await
2025-11-10T00:08:56.7139411Z -                .map_err(|e| RpcError::internal_error(format!("Failed to set network active: {}", e)))?;
2025-11-10T00:08:56.7139627Z +            network.set_network_active(state).await.map_err(|e| {
2025-11-10T00:08:56.7139942Z +                RpcError::internal_error(format!("Failed to set network active: {}", e))
2025-11-10T00:08:56.7140042Z +            })?;
2025-11-10T00:08:56.7140339Z              Ok(json!(state))
2025-11-10T00:08:56.7140445Z          } else {
2025-11-10T00:08:56.7140760Z -            Err(RpcError::internal_error("Network manager not available".to_string()))
2025-11-10T00:08:56.7140900Z +            Err(RpcError::internal_error(
2025-11-10T00:08:56.7141091Z +                "Network manager not available".to_string(),
2025-11-10T00:08:56.7141203Z +            ))
2025-11-10T00:08:56.7141314Z          }
2025-11-10T00:08:56.7141434Z      }
2025-11-10T00:08:56.7141542Z  }
2025-11-10T00:08:56.7191651Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:68:
2025-11-10T00:08:56.7191906Z          let tx_bytes = hex::decode(hex_string)
2025-11-10T00:08:56.7192262Z              .map_err(|e| RpcError::invalid_params(format!("Invalid hex string: {}", e)))?;
2025-11-10T00:08:56.7192386Z  
2025-11-10T00:08:56.7192809Z -        if let (Some(ref storage), Some(ref mempool)) = (self.storage.as_ref(), self.mempool.as_ref()) {
2025-11-10T00:08:56.7193017Z +        if let (Some(ref storage), Some(ref mempool)) =
2025-11-10T00:08:56.7193232Z +            (self.storage.as_ref(), self.mempool.as_ref())
2025-11-10T00:08:56.7193345Z +        {
2025-11-10T00:08:56.7193693Z              use bllvm_protocol::serialization::transaction::deserialize_transaction;
2025-11-10T00:08:56.7193890Z -            let tx = deserialize_transaction(&tx_bytes)
2025-11-10T00:08:56.7194440Z -                .map_err(|e| RpcError::invalid_params(format!("Failed to parse transaction: {}", e)))?;
2025-11-10T00:08:56.7194553Z -            
2025-11-10T00:08:56.7194791Z +            let tx = deserialize_transaction(&tx_bytes).map_err(|e| {
2025-11-10T00:08:56.7195127Z +                RpcError::invalid_params(format!("Failed to parse transaction: {}", e))
2025-11-10T00:08:56.7195241Z +            })?;
2025-11-10T00:08:56.7195353Z +
2025-11-10T00:08:56.7195564Z              use bllvm_protocol::mempool::calculate_tx_id;
2025-11-10T00:08:56.7195717Z              let txid = calculate_tx_id(&tx);
2025-11-10T00:08:56.7195840Z -            
2025-11-10T00:08:56.7195956Z +
2025-11-10T00:08:56.7196104Z              // Check if already in mempool
2025-11-10T00:08:56.7196283Z              if mempool.get_transaction(&txid).is_some() {
2025-11-10T00:08:56.7196609Z                  return Err(RpcError::invalid_params("Transaction already in mempool"));
2025-11-10T00:08:56.7197037Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:82:
2025-11-10T00:08:56.7197146Z              }
2025-11-10T00:08:56.7197254Z -            
2025-11-10T00:08:56.7197372Z +
2025-11-10T00:08:56.7197503Z              // Check if in chain
2025-11-10T00:08:56.7197821Z -            if storage.transactions().has_transaction(&txid).unwrap_or(false) {
2025-11-10T00:08:56.7197951Z +            if storage
2025-11-10T00:08:56.7198087Z +                .transactions()
2025-11-10T00:08:56.7198232Z +                .has_transaction(&txid)
2025-11-10T00:08:56.7198365Z +                .unwrap_or(false)
2025-11-10T00:08:56.7198494Z +            {
2025-11-10T00:08:56.7199097Z                  return Err(RpcError::invalid_params("Transaction already in chain"));
2025-11-10T00:08:56.7199221Z              }
2025-11-10T00:08:56.7199345Z -            
2025-11-10T00:08:56.7199451Z +
2025-11-10T00:08:56.7199640Z              // Validate transaction using consensus layer
2025-11-10T00:08:56.7199835Z -            let _timer = self.profiler.as_ref().map(|p| {
2025-11-10T00:08:56.7200181Z -                PerformanceTimer::start(Arc::clone(p), OperationType::TxValidation)
2025-11-10T00:08:56.7200291Z -            });
2025-11-10T00:08:56.7200422Z +            let _timer = self
2025-11-10T00:08:56.7200555Z +                .profiler
2025-11-10T00:08:56.7200675Z +                .as_ref()
2025-11-10T00:08:56.7201051Z +                .map(|p| PerformanceTimer::start(Arc::clone(p), OperationType::TxValidation));
2025-11-10T00:08:56.7203105Z              let validation_start = Instant::now();
2025-11-10T00:08:56.7203510Z              use bllvm_protocol::ConsensusProof;
2025-11-10T00:08:56.7203700Z              let consensus = ConsensusProof::new();
2025-11-10T00:08:56.7204142Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:97:
2025-11-10T00:08:56.7204671Z                  Ok(bllvm_protocol::ValidationResult::Valid) => {
2025-11-10T00:08:56.7204913Z                      let validation_time = validation_start.elapsed();
2025-11-10T00:08:56.7205103Z                      // Timer will record duration when dropped
2025-11-10T00:08:56.7205229Z -                    
2025-11-10T00:08:56.7205346Z +
2025-11-10T00:08:56.7205490Z                      // Update metrics
2025-11-10T00:08:56.7205660Z                      if let Some(ref metrics) = self.metrics {
2025-11-10T00:08:56.7205822Z                          metrics.update_performance(|m| {
2025-11-10T00:08:56.7206257Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:104:
2025-11-10T00:08:56.7206894Z                              let time_ms = validation_time.as_secs_f64() * 1000.0;
2025-11-10T00:08:56.7207291Z                              // Update average transaction validation time (exponential moving average)
2025-11-10T00:08:56.7207463Z -                            m.avg_tx_validation_time_ms = 
2025-11-10T00:08:56.7207636Z +                            m.avg_tx_validation_time_ms =
2025-11-10T00:08:56.7207848Z                                  (m.avg_tx_validation_time_ms * 0.9) + (time_ms * 0.1);
2025-11-10T00:08:56.7208013Z                              // Update transactions per second
2025-11-10T00:08:56.7208193Z                              if validation_time.as_secs_f64() > 0.0 {
2025-11-10T00:08:56.7208633Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:111:
2025-11-10T00:08:56.7208756Z                              }
2025-11-10T00:08:56.7208875Z                          });
2025-11-10T00:08:56.7208979Z                      }
2025-11-10T00:08:56.7209085Z -                    
2025-11-10T00:08:56.7209193Z +
2025-11-10T00:08:56.7209505Z                      // Transaction structure is valid, now check inputs against UTXO set
2025-11-10T00:08:56.7209689Z -                    let utxo_set = storage.utxos().get_all_utxos()
2025-11-10T00:08:56.7210044Z -                        .map_err(|e| RpcError::internal_error(format!("Failed to get UTXO set: {}", e)))?;
2025-11-10T00:08:56.7210157Z -                    
2025-11-10T00:08:56.7210392Z +                    let utxo_set = storage.utxos().get_all_utxos().map_err(|e| {
2025-11-10T00:08:56.7210685Z +                        RpcError::internal_error(format!("Failed to get UTXO set: {}", e))
2025-11-10T00:08:56.7210799Z +                    })?;
2025-11-10T00:08:56.7210898Z +
2025-11-10T00:08:56.7211072Z                      // Check if all inputs exist in UTXO set
2025-11-10T00:08:56.7211222Z                      for input in &tx.inputs {
2025-11-10T00:08:56.7211414Z                          if !utxo_set.contains_key(&input.prevout) {
2025-11-10T00:08:56.7211827Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:126:
2025-11-10T00:08:56.7212161Z                              )));
2025-11-10T00:08:56.7212276Z                          }
2025-11-10T00:08:56.7212377Z                      }
2025-11-10T00:08:56.7212478Z -                    
2025-11-10T00:08:56.7212573Z +
2025-11-10T00:08:56.7214759Z                      // Add to mempool
2025-11-10T00:08:56.7215094Z                      // Note: add_transaction requires &mut self, but we have Arc<MempoolManager>
2025-11-10T00:08:56.7215406Z                      // In production, this would need to use interior mutability (Mutex/RwLock)
2025-11-10T00:08:56.7215841Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:133:
2025-11-10T00:08:56.7216129Z                      // For now, we'll skip adding to mempool as it requires mutable access
2025-11-10T00:08:56.7216543Z -                    debug!("Transaction validated but not added to mempool (requires mutable access)");
2025-11-10T00:08:56.7216954Z +                    debug!(
2025-11-10T00:08:56.7217323Z +                        "Transaction validated but not added to mempool (requires mutable access)"
2025-11-10T00:08:56.7217443Z +                    );
2025-11-10T00:08:56.7217547Z                  }
2025-11-10T00:08:56.7217811Z                  Ok(bllvm_protocol::ValidationResult::Invalid(reason)) => {
2025-11-10T00:08:56.7218241Z -                    return Err(RpcError::invalid_params(format!("Transaction validation failed: {}", reason)));
2025-11-10T00:08:56.7218449Z +                    return Err(RpcError::invalid_params(format!(
2025-11-10T00:08:56.7218637Z +                        "Transaction validation failed: {}",
2025-11-10T00:08:56.7218761Z +                        reason
2025-11-10T00:08:56.7218883Z +                    )));
2025-11-10T00:08:56.7219003Z                  }
2025-11-10T00:08:56.7219120Z                  Err(e) => {
2025-11-10T00:08:56.7219643Z -                    return Err(RpcError::internal_error(format!("Transaction validation error: {}", e)));
2025-11-10T00:08:56.7219845Z +                    return Err(RpcError::internal_error(format!(
2025-11-10T00:08:56.7220022Z +                        "Transaction validation error: {}",
2025-11-10T00:08:56.7220139Z +                        e
2025-11-10T00:08:56.7220255Z +                    )));
2025-11-10T00:08:56.7220375Z                  }
2025-11-10T00:08:56.7220483Z              }
2025-11-10T00:08:56.7220594Z -            
2025-11-10T00:08:56.7220706Z +
2025-11-10T00:08:56.7220870Z              Ok(json!(hex::encode(txid)))
2025-11-10T00:08:56.7220980Z          } else {
2025-11-10T00:08:56.7221296Z -            Err(RpcError::invalid_params("RPC not initialized with dependencies"))
2025-11-10T00:08:56.7221461Z +            Err(RpcError::invalid_params(
2025-11-10T00:08:56.7221645Z +                "RPC not initialized with dependencies",
2025-11-10T00:08:56.7221757Z +            ))
2025-11-10T00:08:56.7221875Z          }
2025-11-10T00:08:56.7221978Z      }
2025-11-10T00:08:56.7222073Z  
2025-11-10T00:08:56.7222495Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:175:
2025-11-10T00:08:56.7222684Z          let consensus = ConsensusProof::new();
2025-11-10T00:08:56.7222965Z          let validation_result = consensus.validate_transaction(&tx);
2025-11-10T00:08:56.7223072Z  
2025-11-10T00:08:56.7223497Z -        let allowed = matches!(validation_result, Ok(bllvm_protocol::ValidationResult::Valid));
2025-11-10T00:08:56.7223640Z +        let allowed = matches!(
2025-11-10T00:08:56.7223839Z +            validation_result,
2025-11-10T00:08:56.7224039Z +            Ok(bllvm_protocol::ValidationResult::Valid)
2025-11-10T00:08:56.7224153Z +        );
2025-11-10T00:08:56.7224574Z          let reject_reason = if !allowed {
2025-11-10T00:08:56.7224731Z              match validation_result {
2025-11-10T00:08:56.7225078Z                  Ok(bllvm_protocol::ValidationResult::Invalid(reason)) => Some(reason),
2025-11-10T00:08:56.7225774Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:232:
2025-11-10T00:08:56.7226139Z          use bllvm_protocol::serialization::transaction::deserialize_transaction;
2025-11-10T00:08:56.7226330Z          let tx = deserialize_transaction(&tx_bytes)
2025-11-10T00:08:56.7226896Z              .map_err(|e| RpcError::invalid_params(format!("Failed to parse transaction: {}", e)))?;
2025-11-10T00:08:56.7227028Z -        
2025-11-10T00:08:56.7227139Z +
2025-11-10T00:08:56.7227341Z          use bllvm_protocol::mempool::calculate_tx_id;
2025-11-10T00:08:56.7227500Z          let txid = calculate_tx_id(&tx);
2025-11-10T00:08:56.7227649Z          let txid_hex = hex::encode(txid);
2025-11-10T00:08:56.7228087Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:239:
2025-11-10T00:08:56.7228240Z          let size = tx_bytes.len();
2025-11-10T00:08:56.7228352Z -        
2025-11-10T00:08:56.7228463Z +
2025-11-10T00:08:56.7228802Z          Ok(json!({
2025-11-10T00:08:56.7228965Z              "txid": txid_hex.clone(),
2025-11-10T00:08:56.7229098Z              "hash": txid_hex,
2025-11-10T00:08:56.7229533Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:295:
2025-11-10T00:08:56.7229858Z              if let Ok(Some(tx)) = storage.transactions().get_transaction(&txid_array) {
2025-11-10T00:08:56.7230208Z                  use bllvm_protocol::serialization::transaction::serialize_transaction;
2025-11-10T00:08:56.7230433Z                  let tx_hex = hex::encode(serialize_transaction(&tx));
2025-11-10T00:08:56.7230555Z -                
2025-11-10T00:08:56.7230663Z +
2025-11-10T00:08:56.7230792Z                  if verbose {
2025-11-10T00:08:56.7231005Z                      use bllvm_protocol::mempool::calculate_tx_id;
2025-11-10T00:08:56.7231196Z                      let calculated_txid = calculate_tx_id(&tx);
2025-11-10T00:08:56.7231637Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:417:
2025-11-10T00:08:56.7231899Z              if let Ok(Some(utxo)) = storage.utxos().get_utxo(&outpoint) {
2025-11-10T00:08:56.7232207Z                  let best_hash = storage.chain().get_tip_hash()?.unwrap_or([0u8; 32]);
2025-11-10T00:08:56.7232462Z                  let tip_height = storage.chain().get_height()?.unwrap_or(0);
2025-11-10T00:08:56.7232577Z -                
2025-11-10T00:08:56.7232688Z +
2025-11-10T00:08:56.7232893Z                  // Find block height containing this transaction
2025-11-10T00:08:56.7233066Z                  let mut tx_height: Option<u64> = None;
2025-11-10T00:08:56.7233216Z                  for h in 0..=tip_height {
2025-11-10T00:08:56.7233658Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:437:
2025-11-10T00:08:56.7233779Z                          }
2025-11-10T00:08:56.7233894Z                      }
2025-11-10T00:08:56.7234013Z                  }
2025-11-10T00:08:56.7234122Z -                
2025-11-10T00:08:56.7234239Z +
2025-11-10T00:08:56.7234604Z                  let confirmations = tx_height
2025-11-10T00:08:56.7234747Z                      .map(|h| {
2025-11-10T00:08:56.7234893Z                          if h > tip_height {
2025-11-10T00:08:56.7235317Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:447:
2025-11-10T00:08:56.7235447Z                          }
2025-11-10T00:08:56.7237908Z                      })
2025-11-10T00:08:56.7238062Z                      .unwrap_or(0);
2025-11-10T00:08:56.7238167Z -                
2025-11-10T00:08:56.7238283Z +
2025-11-10T00:08:56.7238407Z                  Ok(json!({
2025-11-10T00:08:56.7238591Z                      "bestblock": hex::encode(best_hash),
2025-11-10T00:08:56.7238766Z                      "confirmations": confirmations,
2025-11-10T00:08:56.7239193Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:470:
2025-11-10T00:08:56.7239303Z      }
2025-11-10T00:08:56.7239424Z  
2025-11-10T00:08:56.7239636Z      /// Build merkle proof for transactions in a block
2025-11-10T00:08:56.7240518Z -    fn build_merkle_proof(transactions: &[bllvm_protocol::Transaction], tx_indices: &[usize]) -> Result<Vec<[u8; 32]>, RpcError> {
2025-11-10T00:08:56.7240728Z -        use bllvm_protocol::mempool::calculate_tx_id;
2025-11-10T00:08:56.7240881Z +    fn build_merkle_proof(
2025-11-10T00:08:56.7241082Z +        transactions: &[bllvm_protocol::Transaction],
2025-11-10T00:08:56.7241212Z +        tx_indices: &[usize],
2025-11-10T00:08:56.7241377Z +    ) -> Result<Vec<[u8; 32]>, RpcError> {
2025-11-10T00:08:56.7241561Z          use crate::storage::hashing::double_sha256;
2025-11-10T00:08:56.7241752Z +        use bllvm_protocol::mempool::calculate_tx_id;
2025-11-10T00:08:56.7241860Z  
2025-11-10T00:08:56.7242019Z          if transactions.is_empty() {
2025-11-10T00:08:56.7242402Z -            return Err(RpcError::internal_error("Block has no transactions".to_string()));
2025-11-10T00:08:56.7242776Z +            return Err(RpcError::internal_error(
2025-11-10T00:08:56.7242976Z +                "Block has no transactions".to_string(),
2025-11-10T00:08:56.7243084Z +            ));
2025-11-10T00:08:56.7243191Z          }
2025-11-10T00:08:56.7243303Z  
2025-11-10T00:08:56.7243459Z          // Calculate all transaction hashes
2025-11-10T00:08:56.7243893Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:482:
2025-11-10T00:08:56.7244118Z -        let mut tx_hashes: Vec<[u8; 32]> = transactions.iter()
2025-11-10T00:08:56.7244449Z -            .map(|tx| calculate_tx_id(tx))
2025-11-10T00:08:56.7244583Z -            .collect();
2025-11-10T00:08:56.7244734Z +        let mut tx_hashes: Vec<[u8; 32]> =
2025-11-10T00:08:56.7246879Z +            transactions.iter().map(|tx| calculate_tx_id(tx)).collect();
2025-11-10T00:08:56.7246986Z  
2025-11-10T00:08:56.7247139Z          let mut proof = Vec::new();
2025-11-10T00:08:56.7247315Z          let mut current_level = tx_hashes.clone();
2025-11-10T00:08:56.7248156Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:501:
2025-11-10T00:08:56.7248362Z                      combined.extend_from_slice(&chunk[1]);
2025-11-10T00:08:56.7248555Z                      let parent_hash = double_sha256(&combined);
2025-11-10T00:08:56.7248735Z                      next_level.push(parent_hash);
2025-11-10T00:08:56.7248852Z -                    
2025-11-10T00:08:56.7248950Z +
2025-11-10T00:08:56.7249139Z                      // Check if we need to add sibling to proof
2025-11-10T00:08:56.7249276Z                      if !proof_added {
2025-11-10T00:08:56.7249428Z                          for &idx in tx_indices {
2025-11-10T00:08:56.7249860Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:581:
2025-11-10T00:08:56.7250036Z                              for tx in &b.transactions {
2025-11-10T00:08:56.7250201Z                                  let txid = calculate_tx_id(tx);
2025-11-10T00:08:56.7250390Z                                  let txid_hex = hex::encode(txid);
2025-11-10T00:08:56.7250694Z -                                if txids.iter().any(|tid| tid.as_str() == Some(txid_hex.as_str())) {
2025-11-10T00:08:56.7250829Z +                                if txids
2025-11-10T00:08:56.7250966Z +                                    .iter()
2025-11-10T00:08:56.7251187Z +                                    .any(|tid| tid.as_str() == Some(txid_hex.as_str()))
2025-11-10T00:08:56.7251307Z +                                {
2025-11-10T00:08:56.7251456Z                                      block = Some(b);
2025-11-10T00:08:56.7251584Z                                      break;
2025-11-10T00:08:56.7251712Z                                  }
2025-11-10T00:08:56.7252139Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:601:
2025-11-10T00:08:56.7252374Z                  for (idx, tx) in block.transactions.iter().enumerate() {
2025-11-10T00:08:56.7252543Z                      let txid = calculate_tx_id(tx);
2025-11-10T00:08:56.7253049Z                      let txid_hex = hex::encode(txid);
2025-11-10T00:08:56.7253337Z -                    if txids.iter().any(|tid| tid.as_str() == Some(txid_hex.as_str())) {
2025-11-10T00:08:56.7253471Z +                    if txids
2025-11-10T00:08:56.7253590Z +                        .iter()
2025-11-10T00:08:56.7253797Z +                        .any(|tid| tid.as_str() == Some(txid_hex.as_str()))
2025-11-10T00:08:56.7253913Z +                    {
2025-11-10T00:08:56.7256139Z                          tx_indices.push(idx);
2025-11-10T00:08:56.7256254Z                      }
2025-11-10T00:08:56.7256361Z                  }
2025-11-10T00:08:56.7256891Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:608:
2025-11-10T00:08:56.7257001Z  
2025-11-10T00:08:56.7257146Z                  if tx_indices.is_empty() {
2025-11-10T00:08:56.7257598Z -                    return Err(RpcError::invalid_params("None of the specified transactions found in block"));
2025-11-10T00:08:56.7258023Z +                    return Err(RpcError::invalid_params(
2025-11-10T00:08:56.7258247Z +                        "None of the specified transactions found in block",
2025-11-10T00:08:56.7258366Z +                    ));
2025-11-10T00:08:56.7258485Z                  }
2025-11-10T00:08:56.7258592Z  
2025-11-10T00:08:56.7258728Z                  // Build merkle proof
2025-11-10T00:08:56.7259174Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:614:
2025-11-10T00:08:56.7259529Z                  let proof_hashes = Self::build_merkle_proof(&block.transactions, &tx_indices)
2025-11-10T00:08:56.7259940Z -                    .map_err(|e| RpcError::internal_error(format!("Failed to build merkle proof: {}", e)))?;
2025-11-10T00:08:56.7260084Z +                    .map_err(|e| {
2025-11-10T00:08:56.7260933Z +                        RpcError::internal_error(format!("Failed to build merkle proof: {}", e))
2025-11-10T00:08:56.7261074Z +                    })?;
2025-11-10T00:08:56.7261186Z  
2025-11-10T00:08:56.7261895Z                  // Serialize proof (simplified - Bitcoin Core uses a more complex format)
2025-11-10T00:08:56.7262084Z                  let mut proof_bytes = Vec::new();
2025-11-10T00:08:56.7262527Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:626:
2025-11-10T00:08:56.7262755Z                  Err(RpcError::invalid_params("Block not found"))
2025-11-10T00:08:56.7262872Z              }
2025-11-10T00:08:56.7262988Z          } else {
2025-11-10T00:08:56.7265715Z -            Err(RpcError::invalid_params("RPC not initialized with dependencies"))
2025-11-10T00:08:56.7265896Z +            Err(RpcError::invalid_params(
2025-11-10T00:08:56.7266079Z +                "RPC not initialized with dependencies",
2025-11-10T00:08:56.7266192Z +            ))
2025-11-10T00:08:56.7266309Z          }
2025-11-10T00:08:56.7266415Z      }
2025-11-10T00:08:56.7266525Z  
2025-11-10T00:08:56.7267318Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:650:
2025-11-10T00:08:56.7267465Z              // Decode proof
2025-11-10T00:08:56.7267652Z              let proof_bytes = hex::decode(proof_hex)
2025-11-10T00:08:56.7267995Z                  .map_err(|e| RpcError::invalid_params(format!("Invalid proof hex: {}", e)))?;
2025-11-10T00:08:56.7268116Z -            
2025-11-10T00:08:56.7268223Z +
2025-11-10T00:08:56.7268377Z              if proof_bytes.is_empty() {
2025-11-10T00:08:56.7268623Z                  return Err(RpcError::invalid_params("Empty proof"));
2025-11-10T00:08:56.7268731Z              }
2025-11-10T00:08:56.7269166Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:681:
2025-11-10T00:08:56.7269467Z              if let Ok(Some(block)) = storage.blocks().get_block(&blockhash_array) {
2025-11-10T00:08:56.7269631Z                  // Calculate merkle root from block
2025-11-10T00:08:56.7269855Z                  use bllvm_protocol::mining::calculate_merkle_root;
2025-11-10T00:08:56.7270392Z -                let calculated_root = calculate_merkle_root(&block.transactions)
2025-11-10T00:08:56.7270824Z -                    .map_err(|e| RpcError::internal_error(format!("Failed to calculate merkle root: {}", e)))?;
2025-11-10T00:08:56.7271194Z +                let calculated_root = calculate_merkle_root(&block.transactions).map_err(|e| {
2025-11-10T00:08:56.7271549Z +                    RpcError::internal_error(format!("Failed to calculate merkle root: {}", e))
2025-11-10T00:08:56.7271669Z +                })?;
2025-11-10T00:08:56.7271774Z  
2025-11-10T00:08:56.7272158Z                  // Verify proof by reconstructing root (simplified - would need txids from proof)
2025-11-10T00:08:56.7272442Z                  // For now, just verify the block's merkle root matches the header
2025-11-10T00:08:56.7273131Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:690:
2025-11-10T00:08:56.7273238Z  
2025-11-10T00:08:56.7273971Z                  // Extract transaction IDs from proof (simplified - full implementation would decode txids)
2025-11-10T00:08:56.7274191Z                  use bllvm_protocol::mempool::calculate_tx_id;
2025-11-10T00:08:56.7274654Z -                let txids: Vec<String> = block.transactions.iter()
2025-11-10T00:08:56.7274825Z +                let txids: Vec<String> = block
2025-11-10T00:08:56.7274968Z +                    .transactions
2025-11-10T00:08:56.7275089Z +                    .iter()
2025-11-10T00:08:56.7275275Z                      .map(|tx| hex::encode(calculate_tx_id(tx)))
2025-11-10T00:08:56.7275412Z                      .collect();
2025-11-10T00:08:56.7275521Z  
2025-11-10T00:08:56.7275971Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:703:
2025-11-10T00:08:56.7276194Z                  Err(RpcError::invalid_params("Block not found"))
2025-11-10T00:08:56.7276305Z              }
2025-11-10T00:08:56.7276419Z          } else {
2025-11-10T00:08:56.7276762Z -            Err(RpcError::invalid_params("RPC not initialized with dependencies"))
2025-11-10T00:08:56.7276936Z +            Err(RpcError::invalid_params(
2025-11-10T00:08:56.7277121Z +                "RPC not initialized with dependencies",
2025-11-10T00:08:56.7277645Z +            ))
2025-11-10T00:08:56.7277764Z          }
2025-11-10T00:08:56.7277862Z      }
2025-11-10T00:08:56.7277957Z  }
2025-11-10T00:08:56.7334155Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:54:
2025-11-10T00:08:56.7334301Z      }
2025-11-10T00:08:56.7340527Z  
2025-11-10T00:08:56.7340992Z      /// Create a new RPC server with authentication
2025-11-10T00:08:56.7341224Z -    pub fn with_auth(
2025-11-10T00:08:56.7341431Z -        addr: SocketAddr,
2025-11-10T00:08:56.7341734Z -        auth_manager: Arc<auth::RpcAuthManager>,
2025-11-10T00:08:56.7341920Z -    ) -> Self {
2025-11-10T00:08:56.7342536Z +    pub fn with_auth(addr: SocketAddr, auth_manager: Arc<auth::RpcAuthManager>) -> Self {
2025-11-10T00:08:56.7342736Z          Self {
2025-11-10T00:08:56.7342904Z              addr,
2025-11-10T00:08:56.7343159Z              blockchain: Arc::new(blockchain::BlockchainRpc::new()),
2025-11-10T00:08:56.7343541Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:134:
2025-11-10T00:08:56.7343691Z              control: Arc::clone(&self.control),
2025-11-10T00:08:56.7343844Z              auth_manager: self.auth_manager.clone(),
2025-11-10T00:08:56.7343939Z          });
2025-11-10T00:08:56.7344038Z -        
2025-11-10T00:08:56.7344129Z +
2025-11-10T00:08:56.7344582Z          loop {
2025-11-10T00:08:56.7344829Z              match listener.accept().await {
2025-11-10T00:08:56.7344966Z                  Ok((stream, addr)) => {
2025-11-10T00:08:56.7345343Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:141:
2025-11-10T00:08:56.7345502Z                      debug!("New RPC connection from {}", addr);
2025-11-10T00:08:56.7345632Z                      let peer_addr = addr;
2025-11-10T00:08:56.7345992Z                      let server = Arc::clone(&server);
2025-11-10T00:08:56.7346085Z -                    
2025-11-10T00:08:56.7346176Z +
2025-11-10T00:08:56.7346313Z                      // Spawn task to handle connection
2025-11-10T00:08:56.7346440Z                      tokio::spawn(async move {
2025-11-10T00:08:56.7346714Z                          // Use hyper for HTTP - it will handle protocol detection and parsing
2025-11-10T00:08:56.7347078Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:148:
2025-11-10T00:08:56.7347209Z                          let io = TokioIo::new(stream);
2025-11-10T00:08:56.7347348Z                          let service = service_fn(move |req| {
2025-11-10T00:08:56.7347643Z -                            Self::handle_http_request_with_server(Arc::clone(&server), req, peer_addr)
2025-11-10T00:08:56.7347793Z +                            Self::handle_http_request_with_server(
2025-11-10T00:08:56.7348035Z +                                Arc::clone(&server),
2025-11-10T00:08:56.7348153Z +                                req,
2025-11-10T00:08:56.7348268Z +                                peer_addr,
2025-11-10T00:08:56.7348369Z +                            )
2025-11-10T00:08:56.7348470Z                          });
2025-11-10T00:08:56.7348565Z -                        
2025-11-10T00:08:56.7348653Z +
2025-11-10T00:08:56.7348774Z                          // Try to serve as HTTP
2025-11-10T00:08:56.7348922Z -                        if let Err(e) = http1::Builder::new()
2025-11-10T00:08:56.7349061Z -                            .serve_connection(io, service)
2025-11-10T00:08:56.7349164Z -                            .await
2025-11-10T00:08:56.7349265Z -                        {
2025-11-10T00:08:56.7349520Z +                        if let Err(e) = http1::Builder::new().serve_connection(io, service).await {
2025-11-10T00:08:56.7349668Z                              // If hyper fails, it might be raw TCP
2025-11-10T00:08:56.7349907Z                              // But we can't recover here since hyper consumed the connection
2025-11-10T00:08:56.7350170Z                              // For now, log and continue - raw TCP support would need separate port
2025-11-10T00:08:56.7350468Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:161:
2025-11-10T00:08:56.7350675Z -                            debug!("HTTP connection failed from {} (might be raw TCP): {}", peer_addr, e);
2025-11-10T00:08:56.7350757Z +                            debug!(
2025-11-10T00:08:56.7350900Z +                                "HTTP connection failed from {} (might be raw TCP): {}",
2025-11-10T00:08:56.7350985Z +                                peer_addr, e
2025-11-10T00:08:56.7351059Z +                            );
2025-11-10T00:08:56.7351125Z                          }
2025-11-10T00:08:56.7351189Z                      });
2025-11-10T00:08:56.7351251Z                  }
2025-11-10T00:08:56.7351515Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:185:
2025-11-10T00:08:56.7351579Z  
2025-11-10T00:08:56.7351696Z          // Extract headers before consuming request body
2025-11-10T00:08:56.7351793Z          let headers = req.headers().clone();
2025-11-10T00:08:56.7351857Z -        
2025-11-10T00:08:56.7351917Z +
2025-11-10T00:08:56.7352001Z          // Check Content-Type
2025-11-10T00:08:56.7352138Z          if let Some(content_type) = headers.get("content-type") {
2025-11-10T00:08:56.7352238Z              if content_type != "application/json" {
2025-11-10T00:08:56.7352482Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:196:
2025-11-10T00:08:56.7352576Z          // Read request body with size limit
2025-11-10T00:08:56.7352661Z          let body = req.collect().await?;
2025-11-10T00:08:56.7352749Z          let body_bytes = body.to_bytes();
2025-11-10T00:08:56.7352818Z -        
2025-11-10T00:08:56.7352878Z +
2025-11-10T00:08:56.7352965Z          // Enforce maximum request size
2025-11-10T00:08:56.7353159Z          if body_bytes.len() > MAX_REQUEST_SIZE {
2025-11-10T00:08:56.7353262Z              return Ok(Self::http_error_response(
2025-11-10T00:08:56.7353496Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:203:
2025-11-10T00:08:56.7353593Z                  StatusCode::PAYLOAD_TOO_LARGE,
2025-11-10T00:08:56.7353830Z -                &format!("Request body too large: {} bytes (max: {} bytes)", body_bytes.len(), MAX_REQUEST_SIZE),
2025-11-10T00:08:56.7353901Z +                &format!(
2025-11-10T00:08:56.7354023Z +                    "Request body too large: {} bytes (max: {} bytes)",
2025-11-10T00:08:56.7354106Z +                    body_bytes.len(),
2025-11-10T00:08:56.7354184Z +                    MAX_REQUEST_SIZE
2025-11-10T00:08:56.7354246Z +                ),
2025-11-10T00:08:56.7354488Z              ));
2025-11-10T00:08:56.7354590Z          }
2025-11-10T00:08:56.7354651Z  
2025-11-10T00:08:56.7355056Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:221:
2025-11-10T00:08:56.7355199Z          // Authenticate request if authentication is enabled
2025-11-10T00:08:56.7355321Z          if let Some(ref auth_manager) = server.auth_manager {
2025-11-10T00:08:56.7355509Z              let auth_result = auth_manager.authenticate_request(&headers, addr).await;
2025-11-10T00:08:56.7355576Z -            
2025-11-10T00:08:56.7355636Z +
2025-11-10T00:08:56.7355729Z              // Check if authentication failed
2025-11-10T00:08:56.7355829Z              if let Some(error) = auth_result.error {
2025-11-10T00:08:56.7355937Z -                return Ok(Self::http_error_response(
2025-11-10T00:08:56.7356028Z -                    StatusCode::UNAUTHORIZED,
2025-11-10T00:08:56.7356099Z -                    &error,
2025-11-10T00:08:56.7356170Z -                ));
2025-11-10T00:08:56.7356350Z +                return Ok(Self::http_error_response(StatusCode::UNAUTHORIZED, &error));
2025-11-10T00:08:56.7356417Z              }
2025-11-10T00:08:56.7356479Z  
2025-11-10T00:08:56.7356562Z              // Check rate limiting
2025-11-10T00:08:56.7356806Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:243:
2025-11-10T00:08:56.7356864Z  
2025-11-10T00:08:56.7357053Z          // Process JSON-RPC request (reuse server instance with cached handlers)
2025-11-10T00:08:56.7357243Z          let response = Self::process_request_with_server(server, &json_body).await;
2025-11-10T00:08:56.7357319Z -        let response_json =
2025-11-10T00:08:56.7357496Z -            serde_json::to_string(&response).unwrap_or_else(|_| "{}".to_string());
2025-11-10T00:08:56.7357715Z +        let response_json = serde_json::to_string(&response).unwrap_or_else(|_| "{}".to_string());
2025-11-10T00:08:56.7357775Z  
2025-11-10T00:08:56.7357877Z          // Build HTTP response
2025-11-10T00:08:56.7357983Z          Ok(Response::builder()
2025-11-10T00:08:56.7358234Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:255:
2025-11-10T00:08:56.7358312Z              .unwrap())
2025-11-10T00:08:56.7358379Z      }
2025-11-10T00:08:56.7358440Z  
2025-11-10T00:08:56.7358497Z -
2025-11-10T00:08:56.7358578Z      /// Create HTTP error response
2025-11-10T00:08:56.7358796Z      fn http_error_response(status: StatusCode, message: &str) -> Response<Full<Bytes>> {
2025-11-10T00:08:56.7358869Z          let body = json!({
2025-11-10T00:08:56.7359105Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:321:
2025-11-10T00:08:56.7359340Z      async fn call_method(&self, method: &str, params: Value) -> Result<Value, errors::RpcError> {
2025-11-10T00:08:56.7359411Z          match method {
2025-11-10T00:08:56.7359491Z              // Blockchain methods
2025-11-10T00:08:56.7359582Z -            "getblockchaininfo" => {
2025-11-10T00:08:56.7359660Z -                self.blockchain
2025-11-10T00:08:56.7359748Z -                    .get_blockchain_info()
2025-11-10T00:08:56.7359819Z -                    .await
2025-11-10T00:08:56.7360212Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-10T00:08:56.7360325Z -            }
2025-11-10T00:08:56.7360484Z +            "getblockchaininfo" => self
2025-11-10T00:08:56.7360599Z +                .blockchain
2025-11-10T00:08:56.7360687Z +                .get_blockchain_info()
2025-11-10T00:08:56.7360754Z +                .await
2025-11-10T00:08:56.7360989Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-10T00:08:56.7361411Z              "getblock" => {
2025-11-10T00:08:56.7361712Z                  let hash = params.get(0).and_then(|p| p.as_str()).unwrap_or("");
2025-11-10T00:08:56.7362033Z                  self.blockchain
2025-11-10T00:08:56.7362439Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:349:
2025-11-10T00:08:56.7362852Z                      .await
2025-11-10T00:08:56.7363139Z                      .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-10T00:08:56.7363571Z              }
2025-11-10T00:08:56.7363761Z -            "getbestblockhash" => {
2025-11-10T00:08:56.7364008Z -                self.blockchain
2025-11-10T00:08:56.7364236Z -                    .get_best_block_hash()
2025-11-10T00:08:56.7364780Z -                    .await
2025-11-10T00:08:56.7365131Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-10T00:08:56.7365434Z -            }
2025-11-10T00:08:56.7365612Z -            "getblockcount" => {
2025-11-10T00:08:56.7365836Z -                self.blockchain
2025-11-10T00:08:56.7366050Z -                    .get_block_count()
2025-11-10T00:08:56.7366420Z -                    .await
2025-11-10T00:08:56.7367001Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-10T00:08:56.7367547Z -            }
2025-11-10T00:08:56.7367865Z -            "getdifficulty" => {
2025-11-10T00:08:56.7368287Z -                self.blockchain
2025-11-10T00:08:56.7368702Z -                    .get_difficulty()
2025-11-10T00:08:56.7369127Z -                    .await
2025-11-10T00:08:56.7369641Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-10T00:08:56.7370189Z -            }
2025-11-10T00:08:56.7370519Z -            "gettxoutsetinfo" => {
2025-11-10T00:08:56.7370944Z -                self.blockchain
2025-11-10T00:08:56.7371363Z -                    .get_txoutset_info()
2025-11-10T00:08:56.7371817Z -                    .await
2025-11-10T00:08:56.7372336Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-10T00:08:56.7373147Z -            }
2025-11-10T00:08:56.7373488Z +            "getbestblockhash" => self
2025-11-10T00:08:56.7373963Z +                .blockchain
2025-11-10T00:08:56.7374609Z +                .get_best_block_hash()
2025-11-10T00:08:56.7375041Z +                .await
2025-11-10T00:08:56.7375541Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-10T00:08:56.7376174Z +            "getblockcount" => self
2025-11-10T00:08:56.7376602Z +                .blockchain
2025-11-10T00:08:56.7376984Z +                .get_block_count()
2025-11-10T00:08:56.7377209Z +                .await
2025-11-10T00:08:56.7377482Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-10T00:08:56.7377806Z +            "getdifficulty" => self
2025-11-10T00:08:56.7378049Z +                .blockchain
2025-11-10T00:08:56.7378261Z +                .get_difficulty()
2025-11-10T00:08:56.7378473Z +                .await
2025-11-10T00:08:56.7378740Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-10T00:08:56.7385796Z +            "gettxoutsetinfo" => self
2025-11-10T00:08:56.7386144Z +                .blockchain
2025-11-10T00:08:56.7386389Z +                .get_txoutset_info()
2025-11-10T00:08:56.7386616Z +                .await
2025-11-10T00:08:56.7386924Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-10T00:08:56.7387717Z              "verifychain" => {
2025-11-10T00:08:56.7388024Z                  let checklevel = params.get(0).and_then(|p| p.as_u64());
2025-11-10T00:08:56.7388398Z                  let numblocks = params.get(1).and_then(|p| p.as_u64());
2025-11-10T00:08:56.7388900Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:381:
2025-11-10T00:08:56.7389311Z                      .await
2025-11-10T00:08:56.7389604Z                      .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-10T00:08:56.7389915Z              }
2025-11-10T00:08:56.7390102Z -            "getchaintips" => {
2025-11-10T00:08:56.7390336Z -                self.blockchain
2025-11-10T00:08:56.7390560Z -                    .get_chain_tips()
2025-11-10T00:08:56.7390797Z -                    .await
2025-11-10T00:08:56.7391213Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-10T00:08:56.7392012Z -            }
2025-11-10T00:08:56.7392341Z -            "getchaintxstats" => {
2025-11-10T00:08:56.7392773Z -                self.blockchain
2025-11-10T00:08:56.7393212Z -                    .get_chain_tx_stats(&params)
2025-11-10T00:08:56.7393661Z -                    .await
2025-11-10T00:08:56.7394187Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-10T00:08:56.7394876Z -            }
2025-11-10T00:08:56.7395080Z -            "getblockstats" => {
2025-11-10T00:08:56.7395321Z -                self.blockchain
2025-11-10T00:08:56.7395570Z -                    .get_block_stats(&params)
2025-11-10T00:08:56.7395824Z -                    .await
2025-11-10T00:08:56.7396118Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-10T00:08:56.7396806Z -            }
2025-11-10T00:08:56.7396992Z -            "pruneblockchain" => {
2025-11-10T00:08:56.7397239Z -                self.blockchain
2025-11-10T00:08:56.7397494Z -                    .prune_blockchain(&params)
2025-11-10T00:08:56.7397752Z -                    .await
2025-11-10T00:08:56.7398026Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-10T00:08:56.7398324Z -            }
2025-11-10T00:08:56.7398498Z -            "getpruneinfo" => {
2025-11-10T00:08:56.7398720Z -                self.blockchain
2025-11-10T00:08:56.7398945Z -                    .get_prune_info(&params)
2025-11-10T00:08:56.7399186Z -                    .await
2025-11-10T00:08:56.7399455Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-10T00:08:56.7399744Z -            }
2025-11-10T00:08:56.7399933Z -            "invalidateblock" => {
2025-11-10T00:08:56.7400163Z -                self.blockchain
2025-11-10T00:08:56.7400398Z -                    .invalidate_block(&params)
2025-11-10T00:08:56.7400635Z -                    .await
2025-11-10T00:08:56.7400900Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-10T00:08:56.7401204Z -            }
2025-11-10T00:08:56.7401383Z -            "reconsiderblock" => {
2025-11-10T00:08:56.7401619Z -                self.blockchain
2025-11-10T00:08:56.7401842Z -                    .reconsider_block(&params)
2025-11-10T00:08:56.7402084Z -                    .await
2025-11-10T00:08:56.7402346Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-10T00:08:56.7402649Z -            }
2025-11-10T00:08:56.7402824Z -            "waitfornewblock" => {
2025-11-10T00:08:56.7403053Z -                self.blockchain
2025-11-10T00:08:56.7403289Z -                    .wait_for_new_block(&params)
2025-11-10T00:08:56.7403692Z -                    .await
2025-11-10T00:08:56.7403975Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-10T00:08:56.7404275Z -            }
2025-11-10T00:08:56.7404673Z -            "waitforblock" => {
2025-11-10T00:08:56.7404903Z -                self.blockchain
2025-11-10T00:08:56.7405360Z -                    .wait_for_block(&params)
2025-11-10T00:08:56.7405597Z -                    .await
2025-11-10T00:08:56.7405877Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-10T00:08:56.7406166Z -            }
2025-11-10T00:08:56.7406358Z -            "waitforblockheight" => {
2025-11-10T00:08:56.7406601Z -                self.blockchain
2025-11-10T00:08:56.7406844Z -                    .wait_for_block_height(&params)
2025-11-10T00:08:56.7407095Z -                    .await
2025-11-10T00:08:56.7407423Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-10T00:08:56.7407955Z -            }
2025-11-10T00:08:56.7408220Z +            "getchaintips" => self
2025-11-10T00:08:56.7408455Z +                .blockchain
2025-11-10T00:08:56.7408665Z +                .get_chain_tips()
2025-11-10T00:08:56.7408881Z +                .await
2025-11-10T00:08:56.7409300Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-10T00:08:56.7409632Z +            "getchaintxstats" => self
2025-11-10T00:08:56.7409868Z +                .blockchain
2025-11-10T00:08:56.7410087Z +                .get_chain_tx_stats(&params)
2025-11-10T00:08:56.7410328Z +                .await
2025-11-10T00:08:56.7410582Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-10T00:08:56.7410905Z +            "getblockstats" => self
2025-11-10T00:08:56.7411135Z +                .blockchain
2025-11-10T00:08:56.7413209Z +                .get_block_stats(&params)
2025-11-10T00:08:56.7413444Z +                .await
2025-11-10T00:08:56.7413702Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-10T00:08:56.7414025Z +            "pruneblockchain" => self
2025-11-10T00:08:56.7414259Z +                .blockchain
2025-11-10T00:08:56.7415738Z +                .prune_blockchain(&params)
2025-11-10T00:08:56.7416007Z +                .await
2025-11-10T00:08:56.7416297Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-10T00:08:56.7416613Z +            "getpruneinfo" => self
2025-11-10T00:08:56.7416865Z +                .blockchain
2025-11-10T00:08:56.7417244Z +                .get_prune_info(&params)
2025-11-10T00:08:56.7417563Z +                .await
2025-11-10T00:08:56.7417833Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-10T00:08:56.7418148Z +            "invalidateblock" => self
2025-11-10T00:08:56.7418390Z +                .blockchain
2025-11-10T00:08:56.7418607Z +                .invalidate_block(&params)
2025-11-10T00:08:56.7418843Z +                .await
2025-11-10T00:08:56.7419096Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-10T00:08:56.7419416Z +            "reconsiderblock" => self
2025-11-10T00:08:56.7419646Z +                .blockchain
2025-11-10T00:08:56.7419869Z +                .reconsider_block(&params)
2025-11-10T00:08:56.7420119Z +                .await
2025-11-10T00:08:56.7420371Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-10T00:08:56.7420688Z +            "waitfornewblock" => self
2025-11-10T00:08:56.7420916Z +                .blockchain
2025-11-10T00:08:56.7421143Z +                .wait_for_new_block(&params)
2025-11-10T00:08:56.7421378Z +                .await
2025-11-10T00:08:56.7421637Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-10T00:08:56.7421944Z +            "waitforblock" => self
2025-11-10T00:08:56.7422173Z +                .blockchain
2025-11-10T00:08:56.7422382Z +                .wait_for_block(&params)
2025-11-10T00:08:56.7422618Z +                .await
2025-11-10T00:08:56.7422874Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-10T00:08:56.7423192Z +            "waitforblockheight" => self
2025-11-10T00:08:56.7423439Z +                .blockchain
2025-11-10T00:08:56.7423844Z +                .wait_for_block_height(&params)
2025-11-10T00:08:56.7424101Z +                .await
2025-11-10T00:08:56.7424603Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-10T00:08:56.7424946Z  
2025-11-10T00:08:56.7425130Z              // Raw Transaction methods
2025-11-10T00:08:56.7425385Z -            "getrawtransaction" => {
2025-11-10T00:08:56.7425674Z -                self.rawtx.getrawtransaction(&params).await
2025-11-10T00:08:56.7425945Z -            }
2025-11-10T00:08:56.7426138Z -            "sendrawtransaction" => {
2025-11-10T00:08:56.7426427Z -                self.rawtx.sendrawtransaction(&params).await
2025-11-10T00:08:56.7426697Z -            }
2025-11-10T00:08:56.7426885Z -            "testmempoolaccept" => {
2025-11-10T00:08:56.7427157Z -                self.rawtx.testmempoolaccept(&params).await
2025-11-10T00:08:56.7427425Z -            }
2025-11-10T00:08:56.7427607Z -            "decoderawtransaction" => {
2025-11-10T00:08:56.7428065Z -                self.rawtx.decoderawtransaction(&params).await
2025-11-10T00:08:56.7428342Z -            }
2025-11-10T00:08:56.7428515Z -            "gettxout" => {
2025-11-10T00:08:56.7428748Z -                self.rawtx.gettxout(&params).await
2025-11-10T00:08:56.7428997Z -            }
2025-11-10T00:08:56.7429178Z -            "gettxoutproof" => {
2025-11-10T00:08:56.7429437Z -                self.rawtx.gettxoutproof(&params).await
2025-11-10T00:08:56.7429697Z -            }
2025-11-10T00:08:56.7429876Z -            "verifytxoutproof" => {
2025-11-10T00:08:56.7430156Z -                self.rawtx.verifytxoutproof(&params).await
2025-11-10T00:08:56.7430417Z -            }
2025-11-10T00:08:56.7430702Z +            "getrawtransaction" => self.rawtx.getrawtransaction(&params).await,
2025-11-10T00:08:56.7431171Z +            "sendrawtransaction" => self.rawtx.sendrawtransaction(&params).await,
2025-11-10T00:08:56.7431630Z +            "testmempoolaccept" => self.rawtx.testmempoolaccept(&params).await,
2025-11-10T00:08:56.7432106Z +            "decoderawtransaction" => self.rawtx.decoderawtransaction(&params).await,
2025-11-10T00:08:56.7432518Z +            "gettxout" => self.rawtx.gettxout(&params).await,
2025-11-10T00:08:56.7432876Z +            "gettxoutproof" => self.rawtx.gettxoutproof(&params).await,
2025-11-10T00:08:56.7433283Z +            "verifytxoutproof" => self.rawtx.verifytxoutproof(&params).await,
2025-11-10T00:08:56.7433609Z  
2025-11-10T00:08:56.7433767Z              // Mempool methods
2025-11-10T00:08:56.7433993Z -            "getmempoolinfo" => {
2025-11-10T00:08:56.7434281Z -                self.mempool.getmempoolinfo(&params).await
2025-11-10T00:08:56.7434927Z -            }
2025-11-10T00:08:56.7435128Z -            "getrawmempool" => {
2025-11-10T00:08:56.7435399Z -                self.mempool.getrawmempool(&params).await
2025-11-10T00:08:56.7435666Z -            }
2025-11-10T00:08:56.7435848Z -            "savemempool" => {
2025-11-10T00:08:56.7436116Z -                self.mempool.savemempool(&params).await
2025-11-10T00:08:56.7436377Z -            }
2025-11-10T00:08:56.7436568Z -            "getmempoolancestors" => {
2025-11-10T00:08:56.7436877Z -                self.mempool.getmempoolancestors(&params).await
2025-11-10T00:08:56.7437156Z -            }
2025-11-10T00:08:56.7437352Z -            "getmempooldescendants" => {
2025-11-10T00:08:56.7437662Z -                self.mempool.getmempooldescendants(&params).await
2025-11-10T00:08:56.7437956Z -            }
2025-11-10T00:08:56.7438135Z -            "getmempoolentry" => {
2025-11-10T00:08:56.7438419Z -                self.mempool.getmempoolentry(&params).await
2025-11-10T00:08:56.7438683Z -            }
2025-11-10T00:08:56.7438953Z +            "getmempoolinfo" => self.mempool.getmempoolinfo(&params).await,
2025-11-10T00:08:56.7439374Z +            "getrawmempool" => self.mempool.getrawmempool(&params).await,
2025-11-10T00:08:56.7439765Z +            "savemempool" => self.mempool.savemempool(&params).await,
2025-11-10T00:08:56.7440207Z +            "getmempoolancestors" => self.mempool.getmempoolancestors(&params).await,
2025-11-10T00:08:56.7440866Z +            "getmempooldescendants" => self.mempool.getmempooldescendants(&params).await,
2025-11-10T00:08:56.7441347Z +            "getmempoolentry" => self.mempool.getmempoolentry(&params).await,
2025-11-10T00:08:56.7441669Z  
2025-11-10T00:08:56.7441833Z              // Network methods
2025-11-10T00:08:56.7442053Z -            "getnetworkinfo" => {
2025-11-10T00:08:56.7442307Z -                self.network.get_network_info().await
2025-11-10T00:08:56.7442562Z -            }
2025-11-10T00:08:56.7444798Z -            "getpeerinfo" => {
2025-11-10T00:08:56.7445044Z -                self.network.get_peer_info().await
2025-11-10T00:08:56.7445286Z -            }
2025-11-10T00:08:56.7445474Z -            "getconnectioncount" => {
2025-11-10T00:08:56.7445763Z -                self.network.get_connection_count(&params).await
2025-11-10T00:08:56.7446037Z -            }
2025-11-10T00:08:56.7446363Z -            "ping" => {
2025-11-10T00:08:56.7446601Z -                self.network.ping(&params).await
2025-11-10T00:08:56.7446852Z -            }
2025-11-10T00:08:56.7447021Z -            "addnode" => {
2025-11-10T00:08:56.7447261Z -                self.network.add_node(&params).await
2025-11-10T00:08:56.7447507Z -            }
2025-11-10T00:08:56.7447686Z -            "disconnectnode" => {
2025-11-10T00:08:56.7447956Z -                self.network.disconnect_node(&params).await
2025-11-10T00:08:56.7448225Z -            }
2025-11-10T00:08:56.7448396Z -            "getnettotals" => {
2025-11-10T00:08:56.7448652Z -                self.network.get_net_totals(&params).await
2025-11-10T00:08:56.7448905Z -            }
2025-11-10T00:08:56.7449078Z -            "clearbanned" => {
2025-11-10T00:08:56.7449325Z -                self.network.clear_banned(&params).await
2025-11-10T00:08:56.7449581Z -            }
2025-11-10T00:08:56.7449751Z -            "setban" => {
2025-11-10T00:08:56.7449985Z -                self.network.set_ban(&params).await
2025-11-10T00:08:56.7450249Z -            }
2025-11-10T00:08:56.7450434Z -            "listbanned" => {
2025-11-10T00:08:56.7450689Z -                self.network.list_banned(&params).await
2025-11-10T00:08:56.7450945Z -            }
2025-11-10T00:08:56.7451133Z -            "getaddednodeinfo" => {
2025-11-10T00:08:56.7451415Z -                self.network.getaddednodeinfo(&params).await
2025-11-10T00:08:56.7451693Z -            }
2025-11-10T00:08:56.7451875Z -            "getnodeaddresses" => {
2025-11-10T00:08:56.7452146Z -                self.network.getnodeaddresses(&params).await
2025-11-10T00:08:56.7452415Z -            }
2025-11-10T00:08:56.7452587Z -            "setnetworkactive" => {
2025-11-10T00:08:56.7454920Z -                self.network.setnetworkactive(&params).await
2025-11-10T00:08:56.7455187Z -            }
2025-11-10T00:08:56.7455454Z +            "getnetworkinfo" => self.network.get_network_info().await,
2025-11-10T00:08:56.7456099Z +            "getpeerinfo" => self.network.get_peer_info().await,
2025-11-10T00:08:56.7456825Z +            "getconnectioncount" => self.network.get_connection_count(&params).await,
2025-11-10T00:08:56.7457524Z +            "ping" => self.network.ping(&params).await,
2025-11-10T00:08:56.7458060Z +            "addnode" => self.network.add_node(&params).await,
2025-11-10T00:08:56.7458708Z +            "disconnectnode" => self.network.disconnect_node(&params).await,
2025-11-10T00:08:56.7459163Z +            "getnettotals" => self.network.get_net_totals(&params).await,
2025-11-10T00:08:56.7459548Z +            "clearbanned" => self.network.clear_banned(&params).await,
2025-11-10T00:08:56.7459891Z +            "setban" => self.network.set_ban(&params).await,
2025-11-10T00:08:56.7460226Z +            "listbanned" => self.network.list_banned(&params).await,
2025-11-10T00:08:56.7460629Z +            "getaddednodeinfo" => self.network.getaddednodeinfo(&params).await,
2025-11-10T00:08:56.7461068Z +            "getnodeaddresses" => self.network.getnodeaddresses(&params).await,
2025-11-10T00:08:56.7462034Z +            "setnetworkactive" => self.network.setnetworkactive(&params).await,
2025-11-10T00:08:56.7462621Z  
2025-11-10T00:08:56.7464947Z              // Mining methods
2025-11-10T00:08:56.7465169Z -            "getmininginfo" => {
2025-11-10T00:08:56.7465434Z -                self.mining.get_mining_info().await
2025-11-10T00:08:56.7465685Z -            }
2025-11-10T00:08:56.7465871Z -            "getblocktemplate" => {
2025-11-10T00:08:56.7466155Z -                self.mining.get_block_template(&params).await
2025-11-10T00:08:56.7466420Z -            }
2025-11-10T00:08:56.7466600Z -            "submitblock" => {
2025-11-10T00:08:56.7466845Z -                self.mining.submit_block(&params).await
2025-11-10T00:08:56.7467099Z -            }
2025-11-10T00:08:56.7467275Z -            "estimatesmartfee" => {
2025-11-10T00:08:56.7467548Z -                self.mining.estimate_smart_fee(&params).await
2025-11-10T00:08:56.7467973Z -            }
2025-11-10T00:08:56.7468169Z -            "prioritisetransaction" => {
2025-11-10T00:08:56.7468476Z -                self.mining.prioritise_transaction(&params).await
2025-11-10T00:08:56.7468749Z -            }
2025-11-10T00:08:56.7468930Z -            "getblockfilter" => {
2025-11-10T00:08:56.7469156Z -                self.blockchain
2025-11-10T00:08:56.7469398Z -                    .get_block_filter(&params)
2025-11-10T00:08:56.7469641Z -                    .await
2025-11-10T00:08:56.7469933Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-10T00:08:56.7470232Z -            }
2025-11-10T00:08:56.7470415Z -            "getindexinfo" => {
2025-11-10T00:08:56.7470640Z -                self.blockchain
2025-11-10T00:08:56.7470866Z -                    .get_index_info(&params)
2025-11-10T00:08:56.7471107Z -                    .await
2025-11-10T00:08:56.7471372Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-10T00:08:56.7471669Z -            }
2025-11-10T00:08:56.7471902Z +            "getmininginfo" => self.mining.get_mining_info().await,
2025-11-10T00:08:56.7472303Z +            "getblocktemplate" => self.mining.get_block_template(&params).await,
2025-11-10T00:08:56.7472838Z +            "submitblock" => self.mining.submit_block(&params).await,
2025-11-10T00:08:56.7473237Z +            "estimatesmartfee" => self.mining.estimate_smart_fee(&params).await,
2025-11-10T00:08:56.7473718Z +            "prioritisetransaction" => self.mining.prioritise_transaction(&params).await,
2025-11-10T00:08:56.7474104Z +            "getblockfilter" => self
2025-11-10T00:08:56.7474446Z +                .blockchain
2025-11-10T00:08:56.7474670Z +                .get_block_filter(&params)
2025-11-10T00:08:56.7474911Z +                .await
2025-11-10T00:08:56.7475175Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-10T00:08:56.7475495Z +            "getindexinfo" => self
2025-11-10T00:08:56.7475722Z +                .blockchain
2025-11-10T00:08:56.7475945Z +                .get_index_info(&params)
2025-11-10T00:08:56.7476178Z +                .await
2025-11-10T00:08:56.7476431Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-10T00:08:56.7477175Z  
2025-11-10T00:08:56.7477334Z              // Control methods
2025-11-10T00:08:56.7477552Z -            "stop" => {
2025-11-10T00:08:56.7477781Z -                self.control.stop(&params).await
2025-11-10T00:08:56.7478028Z -            }
2025-11-10T00:08:56.7478200Z -            "uptime" => {
2025-11-10T00:08:56.7478436Z -                self.control.uptime(&params).await
2025-11-10T00:08:56.7478690Z -            }
2025-11-10T00:08:56.7478867Z -            "getmemoryinfo" => {
2025-11-10T00:08:56.7479136Z -                self.control.getmemoryinfo(&params).await
2025-11-10T00:08:56.7479396Z -            }
2025-11-10T00:08:56.7479572Z -            "getrpcinfo" => {
2025-11-10T00:08:56.7479816Z -                self.control.getrpcinfo(&params).await
2025-11-10T00:08:56.7480540Z -            }
2025-11-10T00:08:56.7480708Z -            "help" => {
2025-11-10T00:08:56.7480931Z -                self.control.help(&params).await
2025-11-10T00:08:56.7481174Z -            }
2025-11-10T00:08:56.7481347Z -            "logging" => {
2025-11-10T00:08:56.7481581Z -                self.control.logging(&params).await
2025-11-10T00:08:56.7481827Z -            }
2025-11-10T00:08:56.7482001Z -            "gethealth" => {
2025-11-10T00:08:56.7482248Z -                self.control.gethealth(&params).await
2025-11-10T00:08:56.7482500Z -            }
2025-11-10T00:08:56.7482670Z -            "getmetrics" => {
2025-11-10T00:08:56.7482909Z -                self.control.getmetrics(&params).await
2025-11-10T00:08:56.7483156Z -            }
2025-11-10T00:08:56.7483362Z +            "stop" => self.control.stop(&params).await,
2025-11-10T00:08:56.7483661Z +            "uptime" => self.control.uptime(&params).await,
2025-11-10T00:08:56.7484022Z +            "getmemoryinfo" => self.control.getmemoryinfo(&params).await,
2025-11-10T00:08:56.7484702Z +            "getrpcinfo" => self.control.getrpcinfo(&params).await,
2025-11-10T00:08:56.7485025Z +            "help" => self.control.help(&params).await,
2025-11-10T00:08:56.7485333Z +            "logging" => self.control.logging(&params).await,
2025-11-10T00:08:56.7485661Z +            "gethealth" => self.control.gethealth(&params).await,
2025-11-10T00:08:56.7486010Z +            "getmetrics" => self.control.getmetrics(&params).await,
2025-11-10T00:08:56.7486290Z  
2025-11-10T00:08:56.7486500Z              _ => Err(errors::RpcError::method_not_found(method)),
2025-11-10T00:08:56.7486771Z          }
2025-11-10T00:08:56.7487119Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:605:
2025-11-10T00:08:56.7487554Z          // Start server on random port
2025-11-10T00:08:56.7487906Z          let listener = tokio::net::TcpListener::bind("127.0.0.1:0").await.unwrap();
2025-11-10T00:08:56.7488312Z          let server_addr = listener.local_addr().unwrap();
2025-11-10T00:08:56.7488581Z -        
2025-11-10T00:08:56.7488736Z +
2025-11-10T00:08:56.7488904Z          // Spawn server task using hyper
2025-11-10T00:08:56.7489193Z          let server_handle = tokio::spawn(async move {
2025-11-10T00:08:56.7489460Z              loop {
2025-11-10T00:08:56.7489822Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:617:
2025-11-10T00:08:56.7490271Z                              let service = service_fn(move |req| {
2025-11-10T00:08:56.7490588Z                                  RpcServer::handle_http_request(req, peer_addr)
2025-11-10T00:08:56.7490880Z                              });
2025-11-10T00:08:56.7491118Z -                            let _ = http1::Builder::new()
2025-11-10T00:08:56.7491408Z -                                .serve_connection(io, service)
2025-11-10T00:08:56.7491676Z -                                .await;
2025-11-10T00:08:56.7491993Z +                            let _ = http1::Builder::new().serve_connection(io, service).await;
2025-11-10T00:08:56.7492326Z                          });
2025-11-10T00:08:56.7492527Z                      }
2025-11-10T00:08:56.7492719Z                      Err(_) => break,
2025-11-10T00:08:56.7493118Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:632:
2025-11-10T00:08:56.7493520Z  
2025-11-10T00:08:56.7493678Z          // Connect to server
2025-11-10T00:08:56.7493997Z          let mut client = TokioTcpStream::connect(server_addr).await.unwrap();
2025-11-10T00:08:56.7494431Z -        
2025-11-10T00:08:56.7494583Z +
2025-11-10T00:08:56.7494743Z          // Send HTTP POST request
2025-11-10T00:08:56.7495060Z          let json_body = r#"{"jsonrpc":"2.0","method":"ping","params":[],"id":1}"#;
2025-11-10T00:08:56.7495395Z          let http_request = format!(
2025-11-10T00:08:56.7495793Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:645:
2025-11-10T00:08:56.7496206Z              json_body.len(),
2025-11-10T00:08:56.7496539Z              json_body
2025-11-10T00:08:56.7496726Z          );
2025-11-10T00:08:56.7496887Z -        
2025-11-10T00:08:56.7497033Z +
2025-11-10T00:08:56.7497260Z          client.write_all(http_request.as_bytes()).await.unwrap();
2025-11-10T00:08:56.7497548Z -        
2025-11-10T00:08:56.7497699Z +
2025-11-10T00:08:56.7497852Z          // Read response
2025-11-10T00:08:56.7498072Z          let mut response = vec![0u8; 4096];
2025-11-10T00:08:56.7498328Z          let n = tokio::time::timeout(
2025-11-10T00:08:56.7498738Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:654:
2025-11-10T00:08:56.7499164Z              tokio::time::Duration::from_secs(2),
2025-11-10T00:08:56.7499435Z -            client.read(&mut response)
2025-11-10T00:08:56.7499691Z -        ).await.unwrap().unwrap();
2025-11-10T00:08:56.7499908Z -        
2025-11-10T00:08:56.7500086Z +            client.read(&mut response),
2025-11-10T00:08:56.7500439Z +        )
2025-11-10T00:08:56.7500599Z +        .await
2025-11-10T00:08:56.7500765Z +        .unwrap()
2025-11-10T00:08:56.7500939Z +        .unwrap();
2025-11-10T00:08:56.7501107Z +
2025-11-10T00:08:56.7501337Z          let response_str = String::from_utf8_lossy(&response[..n]);
2025-11-10T00:08:56.7501623Z -        
2025-11-10T00:08:56.7501776Z +
2025-11-10T00:08:56.7501993Z          // Verify HTTP response (hyper uses lowercase headers)
2025-11-10T00:08:56.7502509Z -        assert!(response_str.contains("HTTP/1.1 200 OK") || response_str.contains("200 OK"), "Response: {}", response_str);
2025-11-10T00:08:56.7503250Z -        assert!(response_str.contains("content-type: application/json") || response_str.contains("Content-Type: application/json"));
2025-11-10T00:08:56.7503750Z +        assert!(
2025-11-10T00:08:56.7504054Z +            response_str.contains("HTTP/1.1 200 OK") || response_str.contains("200 OK"),
2025-11-10T00:08:56.7504520Z +            "Response: {}",
2025-11-10T00:08:56.7504737Z +            response_str
2025-11-10T00:08:56.7504930Z +        );
2025-11-10T00:08:56.7505084Z +        assert!(
2025-11-10T00:08:56.7505331Z +            response_str.contains("content-type: application/json")
2025-11-10T00:08:56.7505699Z +                || response_str.contains("Content-Type: application/json")
2025-11-10T00:08:56.7505995Z +        );
2025-11-10T00:08:56.7506190Z          assert!(response_str.contains("jsonrpc"));
2025-11-10T00:08:56.7506495Z          assert!(response_str.contains("\"result\""));
2025-11-10T00:08:56.7506748Z -        
2025-11-10T00:08:56.7506902Z +
2025-11-10T00:08:56.7507057Z          server_handle.abort();
2025-11-10T00:08:56.7507263Z      }
2025-11-10T00:08:56.7507417Z  
2025-11-10T00:08:56.7507740Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:669:
2025-11-10T00:08:56.7508145Z -
2025-11-10T00:08:56.7508305Z      #[tokio::test]
2025-11-10T00:08:56.7508520Z      async fn test_process_request_valid_json() {
2025-11-10T00:08:56.7508915Z          let request = r#"{"jsonrpc":"2.0","method":"getblockchaininfo","params":[],"id":1}"#;
2025-11-10T00:08:56.7509565Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:684:
2025-11-10T00:08:56.7510265Z  
2025-11-10T00:08:56.7510572Z          assert_eq!(response["jsonrpc"], "2.0");
2025-11-10T00:08:56.7518197Z          assert_eq!(response["error"]["code"], -32700);
2025-11-10T00:08:56.7518749Z -        assert!(response["error"]["message"].as_str().unwrap().contains("Parse error") || 
2025-11-10T00:08:56.7519265Z -                response["error"]["message"].as_str().unwrap().contains("Invalid JSON"));
2025-11-10T00:08:56.7519617Z +        assert!(
2025-11-10T00:08:56.7519820Z +            response["error"]["message"]
2025-11-10T00:08:56.7520075Z +                .as_str()
2025-11-10T00:08:56.7520286Z +                .unwrap()
2025-11-10T00:08:56.7520504Z +                .contains("Parse error")
2025-11-10T00:08:56.7520771Z +                || response["error"]["message"]
2025-11-10T00:08:56.7521266Z +                    .as_str()
2025-11-10T00:08:56.7521478Z +                    .unwrap()
2025-11-10T00:08:56.7521710Z +                    .contains("Invalid JSON")
2025-11-10T00:08:56.7521956Z +        );
2025-11-10T00:08:56.7522111Z      }
2025-11-10T00:08:56.7522261Z  
2025-11-10T00:08:56.7522424Z      #[tokio::test]
2025-11-10T00:08:56.7522802Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:695:
2025-11-10T00:08:56.7523210Z  
2025-11-10T00:08:56.7523385Z          assert_eq!(response["jsonrpc"], "2.0");
2025-11-10T00:08:56.7523686Z          assert_eq!(response["error"]["code"], -32601);
2025-11-10T00:08:56.7524099Z -        assert!(response["error"]["message"].as_str().unwrap().contains("Method not found"));
2025-11-10T00:08:56.7524663Z +        assert!(response["error"]["message"]
2025-11-10T00:08:56.7524901Z +            .as_str()
2025-11-10T00:08:56.7525095Z +            .unwrap()
2025-11-10T00:08:56.7525433Z +            .contains("Method not found"));
2025-11-10T00:08:56.7525698Z          assert_eq!(response["id"], 1);
2025-11-10T00:08:56.7525924Z      }
2025-11-10T00:08:56.7526069Z  
2025-11-10T00:08:56.7526412Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:822:
2025-11-10T00:08:56.7526816Z  
2025-11-10T00:08:56.7526994Z          assert_eq!(response["jsonrpc"], "2.0");
2025-11-10T00:08:56.7527283Z          assert_eq!(response["error"]["code"], -32700);
2025-11-10T00:08:56.7527680Z -        assert!(response["error"]["message"].as_str().unwrap().contains("Parse error") ||
2025-11-10T00:08:56.7528144Z -                response["error"]["message"].as_str().unwrap().contains("Invalid JSON"));
2025-11-10T00:08:56.7528476Z +        assert!(
2025-11-10T00:08:56.7528676Z +            response["error"]["message"]
2025-11-10T00:08:56.7528917Z +                .as_str()
2025-11-10T00:08:56.7529118Z +                .unwrap()
2025-11-10T00:08:56.7529321Z +                .contains("Parse error")
2025-11-10T00:08:56.7529578Z +                || response["error"]["message"]
2025-11-10T00:08:56.7529820Z +                    .as_str()
2025-11-10T00:08:56.7530028Z +                    .unwrap()
2025-11-10T00:08:56.7530253Z +                    .contains("Invalid JSON")
2025-11-10T00:08:56.7530498Z +        );
2025-11-10T00:08:56.7530655Z      }
2025-11-10T00:08:56.7530809Z  
2025-11-10T00:08:56.7530964Z      #[tokio::test]
2025-11-10T00:08:56.7533142Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:833:
2025-11-10T00:08:56.7533547Z  
2025-11-10T00:08:56.7533725Z          assert_eq!(response["jsonrpc"], "2.0");
2025-11-10T00:08:56.7534017Z          assert_eq!(response["error"]["code"], -32601);
2025-11-10T00:08:56.7534537Z -        assert!(response["error"]["message"].as_str().unwrap().contains("Method not found"));
2025-11-10T00:08:56.7534942Z +        assert!(response["error"]["message"]
2025-11-10T00:08:56.7535183Z +            .as_str()
2025-11-10T00:08:56.7535379Z +            .unwrap()
2025-11-10T00:08:56.7535588Z +            .contains("Method not found"));
2025-11-10T00:08:56.7535961Z          assert!(response["error"]["data"].is_string() || response["error"]["data"].is_null());
2025-11-10T00:08:56.7536347Z          assert_eq!(response["id"], 42);
2025-11-10T00:08:56.7536569Z      }
2025-11-10T00:08:56.7536904Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:855:
2025-11-10T00:08:56.7536968Z  
2025-11-10T00:08:56.7537061Z          assert_eq!(response["jsonrpc"], "2.0");
2025-11-10T00:08:56.7537591Z          assert_eq!(response["error"]["code"], -32601);
2025-11-10T00:08:56.7537802Z -        assert!(response["error"]["message"].as_str().unwrap().contains("Method not found"));
2025-11-10T00:08:56.7537898Z +        assert!(response["error"]["message"]
2025-11-10T00:08:56.7537971Z +            .as_str()
2025-11-10T00:08:56.7538038Z +            .unwrap()
2025-11-10T00:08:56.7538128Z +            .contains("Method not found"));
2025-11-10T00:08:56.7538375Z          assert_eq!(response["id"], 1);
2025-11-10T00:08:56.7538446Z      }
2025-11-10T00:08:56.7538510Z  
2025-11-10T00:08:56.7538871Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/blockstore.rs:2:
2025-11-10T00:08:56.7538938Z  //!
2025-11-10T00:08:56.7539085Z  //! Stores blocks by hash and maintains block index by height.
2025-11-10T00:08:56.7539147Z  
2025-11-10T00:08:56.7539256Z +use crate::storage::database::{Database, Tree};
2025-11-10T00:08:56.7539341Z  use anyhow::Result;
2025-11-10T00:08:56.7539432Z  use bllvm_protocol::segwit::Witness;
2025-11-10T00:08:56.7539540Z  use bllvm_protocol::{Block, BlockHeader, Hash};
2025-11-10T00:08:56.7539806Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/blockstore.rs:8:
2025-11-10T00:08:56.7539914Z -use crate::storage::database::{Database, Tree};
2025-11-10T00:08:56.7539987Z  use std::sync::Arc;
2025-11-10T00:08:56.7540053Z  
2025-11-10T00:08:56.7540256Z  /// Block storage manager
2025-11-10T00:08:56.7540549Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/blockstore.rs:45:
2025-11-10T00:08:56.7540613Z  
2025-11-10T00:08:56.7540764Z          self.blocks.insert(block_hash.as_slice(), &block_data)?;
2025-11-10T00:08:56.7540899Z          let header_data = bincode::serialize(&block.header)?;
2025-11-10T00:08:56.7540970Z -        self.headers
2025-11-10T00:08:56.7541091Z -            .insert(block_hash.as_slice(), &header_data)?;
2025-11-10T00:08:56.7541242Z +        self.headers.insert(block_hash.as_slice(), &header_data)?;
2025-11-10T00:08:56.7541306Z  
2025-11-10T00:08:56.7541426Z          // Store header for median time-past calculation
2025-11-10T00:08:56.7541637Z          // We'll need height passed separately, so this will be called after store_height
2025-11-10T00:08:56.7541905Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/blockstore.rs:81:
2025-11-10T00:08:56.7541991Z      /// Store witness data for a block
2025-11-10T00:08:56.7542207Z      pub fn store_witness(&self, block_hash: &Hash, witness: &[Witness]) -> Result<()> {
2025-11-10T00:08:56.7542326Z          let witness_data = bincode::serialize(witness)?;
2025-11-10T00:08:56.7542491Z -        self.witnesses.insert(block_hash.as_slice(), &witness_data)?;
2025-11-10T00:08:56.7542572Z +        self.witnesses
2025-11-10T00:08:56.7544685Z +            .insert(block_hash.as_slice(), &witness_data)?;
2025-11-10T00:08:56.7544754Z          Ok(())
2025-11-10T00:08:56.7544816Z      }
2025-11-10T00:08:56.7544881Z  
2025-11-10T00:08:56.7545154Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/chainstate.rs:2:
2025-11-10T00:08:56.7545216Z  //!
2025-11-10T00:08:56.7545400Z  //! Stores chain metadata including tip, height, and chain parameters.
2025-11-10T00:08:56.7545460Z  
2025-11-10T00:08:56.7545568Z +use crate::storage::database::{Database, Tree};
2025-11-10T00:08:56.7545646Z  use anyhow::Result;
2025-11-10T00:08:56.7545749Z  use bllvm_protocol::{BlockHeader, Hash};
2025-11-10T00:08:56.7545843Z  use serde::{Deserialize, Serialize};
2025-11-10T00:08:56.7546111Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/chainstate.rs:8:
2025-11-10T00:08:56.7546229Z -use crate::storage::database::{Database, Tree};
2025-11-10T00:08:56.7546302Z  use std::sync::Arc;
2025-11-10T00:08:56.7546361Z  
2025-11-10T00:08:56.7546445Z  /// Chain state information
2025-11-10T00:08:56.7546724Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/chainstate.rs:223:
2025-11-10T00:08:56.7546788Z      }
2025-11-10T00:08:56.7546847Z  
2025-11-10T00:08:56.7546951Z      /// Add a chain tip (for fork tracking)
2025-11-10T00:08:56.7547208Z -    pub fn add_chain_tip(&self, hash: &Hash, height: u64, branchlen: u64, status: &str) -> Result<()> {
2025-11-10T00:08:56.7547288Z +    pub fn add_chain_tip(
2025-11-10T00:08:56.7547360Z +        &self,
2025-11-10T00:08:56.7547430Z +        hash: &Hash,
2025-11-10T00:08:56.7547499Z +        height: u64,
2025-11-10T00:08:56.7547715Z +        branchlen: u64,
2025-11-10T00:08:56.7547791Z +        status: &str,
2025-11-10T00:08:56.7547862Z +    ) -> Result<()> {
2025-11-10T00:08:56.7547959Z          #[derive(Serialize, Deserialize)]
2025-11-10T00:08:56.7548041Z          struct TipInfo {
2025-11-10T00:08:56.7548113Z              height: u64,
2025-11-10T00:08:56.7548400Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/chainstate.rs:230:
2025-11-10T00:08:56.7548480Z              branchlen: u64,
2025-11-10T00:08:56.7548551Z              status: String,
2025-11-10T00:08:56.7548613Z          }
2025-11-10T00:08:56.7548676Z -        
2025-11-10T00:08:56.7548740Z +
2025-11-10T00:08:56.7548821Z          let tip_info = TipInfo {
2025-11-10T00:08:56.7548885Z              height,
2025-11-10T00:08:56.7548953Z              branchlen,
2025-11-10T00:08:56.7549229Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/chainstate.rs:255:
2025-11-10T00:08:56.7549421Z              branchlen: u64,
2025-11-10T00:08:56.7549497Z              status: String,
2025-11-10T00:08:56.7549568Z          }
2025-11-10T00:08:56.7549628Z -        
2025-11-10T00:08:56.7549687Z +
2025-11-10T00:08:56.7549770Z          let mut tips = Vec::new();
2025-11-10T00:08:56.7549876Z          for result in self.chain_tips.iter() {
2025-11-10T00:08:56.7549958Z              let (key, data) = result?;
2025-11-10T00:08:56.7550249Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/commitment_store.rs:4:
2025-11-10T00:08:56.7550347Z  //! without requiring full block history.
2025-11-10T00:08:56.7550408Z  
2025-11-10T00:08:56.7550498Z  #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.7550610Z +use crate::storage::database::{Database, Tree};
2025-11-10T00:08:56.7550699Z +#[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.7550770Z  use anyhow::Result;
2025-11-10T00:08:56.7550852Z  #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.7551042Z  use bllvm_protocol::utxo_commitments::data_structures::UtxoCommitment;
2025-11-10T00:08:56.7553030Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/commitment_store.rs:10:
2025-11-10T00:08:56.7553117Z  #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.7553205Z  use bllvm_protocol::Hash;
2025-11-10T00:08:56.7553289Z  #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.7553395Z -use crate::storage::database::{Database, Tree};
2025-11-10T00:08:56.7553487Z -#[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.7553559Z  use std::sync::Arc;
2025-11-10T00:08:56.7553619Z  
2025-11-10T00:08:56.7553703Z  /// UTXO Commitment storage manager
2025-11-10T00:08:56.7553994Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/commitment_store.rs:48:
2025-11-10T00:08:56.7554133Z          let commitment_data = bincode::serialize(commitment)?;
2025-11-10T00:08:56.7554194Z  
2025-11-10T00:08:56.7554389Z          // Store by block hash
2025-11-10T00:08:56.7554575Z -        self.commitments.insert(block_hash.as_slice(), commitment_data)?;
2025-11-10T00:08:56.7554653Z +        self.commitments
2025-11-10T00:08:56.7554776Z +            .insert(block_hash.as_slice(), commitment_data)?;
2025-11-10T00:08:56.7554845Z  
2025-11-10T00:08:56.7554940Z          // Store height index for quick lookup
2025-11-10T00:08:56.7555038Z          let height_bytes = height.to_be_bytes();
2025-11-10T00:08:56.7555328Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/commitment_store.rs:55:
2025-11-10T00:08:56.7555490Z -        self.height_index.insert(height_bytes, block_hash.as_slice())?;
2025-11-10T00:08:56.7555564Z +        self.height_index
2025-11-10T00:08:56.7555680Z +            .insert(height_bytes, block_hash.as_slice())?;
2025-11-10T00:08:56.7555739Z  
2025-11-10T00:08:56.7555804Z          Ok(())
2025-11-10T00:08:56.7555868Z      }
2025-11-10T00:08:56.7556161Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/commitment_store.rs:128:
2025-11-10T00:08:56.7556450Z          Err(anyhow::anyhow!("UTXO commitments feature not enabled"))
2025-11-10T00:08:56.7556517Z      }
2025-11-10T00:08:56.7556576Z  }
2025-11-10T00:08:56.7556635Z -
2025-11-10T00:08:56.7556697Z  
2025-11-10T00:08:56.7556962Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:7:
2025-11-10T00:08:56.7557042Z  use std::path::Path;
2025-11-10T00:08:56.7557101Z  
2025-11-10T00:08:56.7557189Z  /// Database abstraction trait
2025-11-10T00:08:56.7557249Z -/// 
2025-11-10T00:08:56.7557309Z +///
2025-11-10T00:08:56.7557475Z  /// Provides a unified interface for key-value storage operations
2025-11-10T00:08:56.7557631Z  /// that can be implemented by different backends (sled, redb).
2025-11-10T00:08:56.7557720Z  pub trait Database: Send + Sync {
2025-11-10T00:08:56.7557985Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:14:
2025-11-10T00:08:56.7558071Z      /// Open a named tree/table
2025-11-10T00:08:56.7558328Z      fn open_tree(&self, name: &str) -> Result<Box<dyn Tree>>;
2025-11-10T00:08:56.7558391Z -    
2025-11-10T00:08:56.7558458Z +
2025-11-10T00:08:56.7558539Z      /// Flush all pending writes
2025-11-10T00:08:56.7558624Z      fn flush(&self) -> Result<()>;
2025-11-10T00:08:56.7558684Z  }
2025-11-10T00:08:56.7558945Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:20:
2025-11-10T00:08:56.7559007Z  
2025-11-10T00:08:56.7559087Z  /// Tree/Table abstraction trait
2025-11-10T00:08:56.7559150Z -/// 
2025-11-10T00:08:56.7559209Z +///
2025-11-10T00:08:56.7559393Z  /// Represents a named collection of key-value pairs within a database.
2025-11-10T00:08:56.7559478Z  pub trait Tree: Send + Sync {
2025-11-10T00:08:56.7559564Z      /// Insert a key-value pair
2025-11-10T00:08:56.7559816Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:26:
2025-11-10T00:08:56.7559942Z      fn insert(&self, key: &[u8], value: &[u8]) -> Result<()>;
2025-11-10T00:08:56.7560014Z -    
2025-11-10T00:08:56.7560072Z +
2025-11-10T00:08:56.7560146Z      /// Get a value by key
2025-11-10T00:08:56.7560262Z      fn get(&self, key: &[u8]) -> Result<Option<Vec<u8>>>;
2025-11-10T00:08:56.7560327Z -    
2025-11-10T00:08:56.7560386Z +
2025-11-10T00:08:56.7560464Z      /// Remove a key-value pair
2025-11-10T00:08:56.7560563Z      fn remove(&self, key: &[u8]) -> Result<()>;
2025-11-10T00:08:56.7560624Z -    
2025-11-10T00:08:56.7560681Z +
2025-11-10T00:08:56.7560756Z      /// Check if a key exists
2025-11-10T00:08:56.7560875Z      fn contains_key(&self, key: &[u8]) -> Result<bool>;
2025-11-10T00:08:56.7560938Z -    
2025-11-10T00:08:56.7560996Z +
2025-11-10T00:08:56.7561071Z      /// Clear all entries
2025-11-10T00:08:56.7561150Z      fn clear(&self) -> Result<()>;
2025-11-10T00:08:56.7561208Z -    
2025-11-10T00:08:56.7561267Z +
2025-11-10T00:08:56.7561346Z      /// Get number of entries
2025-11-10T00:08:56.7561431Z      fn len(&self) -> Result<usize>;
2025-11-10T00:08:56.7561494Z -    
2025-11-10T00:08:56.7561560Z +
2025-11-10T00:08:56.7561638Z      /// Check if tree is empty
2025-11-10T00:08:56.7561727Z      fn is_empty(&self) -> Result<bool> {
2025-11-10T00:08:56.7561802Z          Ok(self.len()? == 0)
2025-11-10T00:08:56.7562058Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:46:
2025-11-10T00:08:56.7562119Z      }
2025-11-10T00:08:56.7562177Z -    
2025-11-10T00:08:56.7562239Z +
2025-11-10T00:08:56.7562327Z      /// Iterate over all key-value pairs
2025-11-10T00:08:56.7562501Z      fn iter(&self) -> Box<dyn Iterator<Item = Result<(Vec<u8>, Vec<u8>)>> + '_>;
2025-11-10T00:08:56.7562561Z  }
2025-11-10T00:08:56.7564706Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:63:
2025-11-10T00:08:56.7564791Z  ) -> Result<Box<dyn Database>> {
2025-11-10T00:08:56.7564861Z      match backend {
2025-11-10T00:08:56.7564941Z          #[cfg(feature = "sled")]
2025-11-10T00:08:56.7565028Z -        DatabaseBackend::Sled => {
2025-11-10T00:08:56.7565324Z -            Ok(Box::new(sled_impl::SledDatabase::new(data_dir)?))
2025-11-10T00:08:56.7565387Z -        }
2025-11-10T00:08:56.7565590Z +        DatabaseBackend::Sled => Ok(Box::new(sled_impl::SledDatabase::new(data_dir)?)),
2025-11-10T00:08:56.7565677Z          #[cfg(not(feature = "sled"))]
2025-11-10T00:08:56.7565758Z -        DatabaseBackend::Sled => {
2025-11-10T00:08:56.7565944Z -            Err(anyhow::anyhow!("Sled backend not available (feature not enabled)"))
2025-11-10T00:08:56.7566006Z -        }
2025-11-10T00:08:56.7566163Z +        DatabaseBackend::Sled => Err(anyhow::anyhow!(
2025-11-10T00:08:56.7566291Z +            "Sled backend not available (feature not enabled)"
2025-11-10T00:08:56.7566352Z +        )),
2025-11-10T00:08:56.7566427Z          #[cfg(feature = "redb")]
2025-11-10T00:08:56.7566507Z -        DatabaseBackend::Redb => {
2025-11-10T00:08:56.7566632Z -            Ok(Box::new(redb_impl::RedbDatabase::new(data_dir)?))
2025-11-10T00:08:56.7566820Z -        }
2025-11-10T00:08:56.7567012Z +        DatabaseBackend::Redb => Ok(Box::new(redb_impl::RedbDatabase::new(data_dir)?)),
2025-11-10T00:08:56.7567098Z          #[cfg(not(feature = "redb"))]
2025-11-10T00:08:56.7567178Z -        DatabaseBackend::Redb => {
2025-11-10T00:08:56.7567349Z -            Err(anyhow::anyhow!("Redb backend not available (feature not enabled)"))
2025-11-10T00:08:56.7567410Z -        }
2025-11-10T00:08:56.7567520Z +        DatabaseBackend::Redb => Err(anyhow::anyhow!(
2025-11-10T00:08:56.7567633Z +            "Redb backend not available (feature not enabled)"
2025-11-10T00:08:56.7567694Z +        )),
2025-11-10T00:08:56.7567759Z      }
2025-11-10T00:08:56.7567818Z  }
2025-11-10T00:08:56.7567880Z  
2025-11-10T00:08:56.7568135Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:84:
2025-11-10T00:08:56.7568220Z  /// Get default database backend
2025-11-10T00:08:56.7568283Z -/// 
2025-11-10T00:08:56.7568342Z +///
2025-11-10T00:08:56.7568523Z  /// Returns the preferred backend (redb if available, otherwise sled).
2025-11-10T00:08:56.7568728Z  /// This function will not panic - it returns a backend if at least one is available.
2025-11-10T00:08:56.7568840Z  pub fn default_backend() -> DatabaseBackend {
2025-11-10T00:08:56.7569111Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:104:
2025-11-10T00:08:56.7569171Z  }
2025-11-10T00:08:56.7569229Z  
2025-11-10T00:08:56.7569311Z  /// Get fallback database backend
2025-11-10T00:08:56.7569377Z -/// 
2025-11-10T00:08:56.7569435Z +///
2025-11-10T00:08:56.7569562Z  /// Returns an alternative backend if the primary fails.
2025-11-10T00:08:56.7569663Z  /// Returns None if no fallback is available.
2025-11-10T00:08:56.7569871Z  pub fn fallback_backend(primary: DatabaseBackend) -> Option<DatabaseBackend> {
2025-11-10T00:08:56.7570136Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:148:
2025-11-10T00:08:56.7570222Z      impl SledDatabase {
2025-11-10T00:08:56.7570361Z          pub fn new<P: AsRef<Path>>(data_dir: P) -> Result<Self> {
2025-11-10T00:08:56.7570450Z              let db = sled::open(data_dir)?;
2025-11-10T00:08:56.7570519Z -            Ok(Self {
2025-11-10T00:08:56.7570601Z -                db: Arc::new(db),
2025-11-10T00:08:56.7570663Z -            })
2025-11-10T00:08:56.7570752Z +            Ok(Self { db: Arc::new(db) })
2025-11-10T00:08:56.7570812Z          }
2025-11-10T00:08:56.7570879Z      }
2025-11-10T00:08:56.7570937Z  
2025-11-10T00:08:56.7571196Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:224:
2025-11-10T00:08:56.7571432Z      static HEADERS_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("headers");
2025-11-10T00:08:56.7571686Z      static HEIGHT_INDEX_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("height_index");
2025-11-10T00:08:56.7571920Z      static WITNESSES_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("witnesses");
2025-11-10T00:08:56.7572288Z -    static RECENT_HEADERS_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("recent_headers");
2025-11-10T00:08:56.7572437Z +    static RECENT_HEADERS_TABLE: TableDefinition<&[u8], &[u8]> =
2025-11-10T00:08:56.7572535Z +        TableDefinition::new("recent_headers");
2025-11-10T00:08:56.7572954Z      static UTXOS_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("utxos");
2025-11-10T00:08:56.7573212Z -    static SPENT_OUTPUTS_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("spent_outputs");
2025-11-10T00:08:56.7573684Z +    static SPENT_OUTPUTS_TABLE: TableDefinition<&[u8], &[u8]> =
2025-11-10T00:08:56.7573807Z +        TableDefinition::new("spent_outputs");
2025-11-10T00:08:56.7574049Z      static CHAIN_INFO_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("chain_info");
2025-11-10T00:08:56.7574279Z      static WORK_CACHE_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("work_cache");
2025-11-10T00:08:56.7574833Z      static TX_BY_HASH_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("tx_by_hash");
2025-11-10T00:08:56.7575105Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:233:
2025-11-10T00:08:56.7575338Z      static TX_BY_BLOCK_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("tx_by_block");
2025-11-10T00:08:56.7575574Z      static TX_METADATA_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("tx_metadata");
2025-11-10T00:08:56.7575834Z -    static INVALID_BLOCKS_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("invalid_blocks");
2025-11-10T00:08:56.7575985Z +    static INVALID_BLOCKS_TABLE: TableDefinition<&[u8], &[u8]> =
2025-11-10T00:08:56.7576090Z +        TableDefinition::new("invalid_blocks");
2025-11-10T00:08:56.7576317Z      static CHAIN_TIPS_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("chain_tips");
2025-11-10T00:08:56.7576377Z  
2025-11-10T00:08:56.7576467Z      pub struct RedbDatabase {
2025-11-10T00:08:56.7576733Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:243:
2025-11-10T00:08:56.7576871Z          pub fn new<P: AsRef<Path>>(data_dir: P) -> Result<Self> {
2025-11-10T00:08:56.7576990Z              let db_path = data_dir.as_ref().join("redb.db");
2025-11-10T00:08:56.7577087Z              let db = RedbDb::create(&db_path)?;
2025-11-10T00:08:56.7577149Z -            
2025-11-10T00:08:56.7577208Z +
2025-11-10T00:08:56.7577328Z              // Initialize all tables in a write transaction
2025-11-10T00:08:56.7577418Z              let write_txn = db.begin_write()?;
2025-11-10T00:08:56.7577480Z              {
2025-11-10T00:08:56.7577740Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:264:
2025-11-10T00:08:56.7577858Z                  let _ = write_txn.open_table(CHAIN_TIPS_TABLE)?;
2025-11-10T00:08:56.7577922Z              }
2025-11-10T00:08:56.7578001Z              write_txn.commit()?;
2025-11-10T00:08:56.7578074Z -            
2025-11-10T00:08:56.7578140Z -            Ok(Self {
2025-11-10T00:08:56.7578215Z -                db: Arc::new(db),
2025-11-10T00:08:56.7578277Z -            })
2025-11-10T00:08:56.7578343Z +
2025-11-10T00:08:56.7578427Z +            Ok(Self { db: Arc::new(db) })
2025-11-10T00:08:56.7578487Z          }
2025-11-10T00:08:56.7578552Z -        
2025-11-10T00:08:56.7578775Z -        fn get_table_def(&self, name: &str) -> Option<TableDefinition<&'static [u8], &'static [u8]>> {
2025-11-10T00:08:56.7578834Z +
2025-11-10T00:08:56.7578908Z +        fn get_table_def(
2025-11-10T00:08:56.7578975Z +            &self,
2025-11-10T00:08:56.7579045Z +            name: &str,
2025-11-10T00:08:56.7579185Z +        ) -> Option<TableDefinition<&'static [u8], &'static [u8]>> {
2025-11-10T00:08:56.7579262Z              match name {
2025-11-10T00:08:56.7579350Z                  "blocks" => Some(BLOCKS_TABLE),
2025-11-10T00:08:56.7579439Z                  "headers" => Some(HEADERS_TABLE),
2025-11-10T00:08:56.7579824Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:293:
2025-11-10T00:08:56.7579889Z  
2025-11-10T00:08:56.7579978Z      impl Database for RedbDatabase {
2025-11-10T00:08:56.7580108Z          fn open_tree(&self, name: &str) -> Result<Box<dyn Tree>> {
2025-11-10T00:08:56.7580216Z -            let table_def = self.get_table_def(name)
2025-11-10T00:08:56.7580468Z -                .ok_or_else(|| anyhow::anyhow!("Unknown table name: {}. Redb requires pre-defined tables.", name))?;
2025-11-10T00:08:56.7580530Z -            
2025-11-10T00:08:56.7580662Z +            let table_def = self.get_table_def(name).ok_or_else(|| {
2025-11-10T00:08:56.7580737Z +                anyhow::anyhow!(
2025-11-10T00:08:56.7580888Z +                    "Unknown table name: {}. Redb requires pre-defined tables.",
2025-11-10T00:08:56.7580963Z +                    name
2025-11-10T00:08:56.7581034Z +                )
2025-11-10T00:08:56.7581265Z +            })?;
2025-11-10T00:08:56.7581334Z +
2025-11-10T00:08:56.7581424Z              Ok(Box::new(RedbTree {
2025-11-10T00:08:56.7581514Z                  db: Arc::clone(&self.db),
2025-11-10T00:08:56.7581587Z                  table_def,
2025-11-10T00:08:56.7581861Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:374:
2025-11-10T00:08:56.7581979Z              let read_txn = match self.db.begin_read() {
2025-11-10T00:08:56.7582056Z                  Ok(txn) => txn,
2025-11-10T00:08:56.7582129Z                  Err(e) => {
2025-11-10T00:08:56.7582382Z -                    return Box::new(std::iter::once(Err(anyhow::anyhow!("Failed to begin read transaction: {}", e))));
2025-11-10T00:08:56.7582512Z +                    return Box::new(std::iter::once(Err(anyhow::anyhow!(
2025-11-10T00:08:56.7582618Z +                        "Failed to begin read transaction: {}",
2025-11-10T00:08:56.7582694Z +                        e
2025-11-10T00:08:56.7582760Z +                    ))));
2025-11-10T00:08:56.7582826Z                  }
2025-11-10T00:08:56.7582891Z              };
2025-11-10T00:08:56.7582958Z -            
2025-11-10T00:08:56.7583018Z +
2025-11-10T00:08:56.7583153Z              let table = match read_txn.open_table(self.table_def) {
2025-11-10T00:08:56.7583234Z                  Ok(tbl) => tbl,
2025-11-10T00:08:56.7583306Z                  Err(e) => {
2025-11-10T00:08:56.7583577Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:384:
2025-11-10T00:08:56.7583849Z -                    return Box::new(std::iter::once(Err(anyhow::anyhow!("Failed to open table: {}", e))));
2025-11-10T00:08:56.7583980Z +                    return Box::new(std::iter::once(Err(anyhow::anyhow!(
2025-11-10T00:08:56.7584076Z +                        "Failed to open table: {}",
2025-11-10T00:08:56.7584146Z +                        e
2025-11-10T00:08:56.7584217Z +                    ))));
2025-11-10T00:08:56.7584465Z                  }
2025-11-10T00:08:56.7584538Z              };
2025-11-10T00:08:56.7584606Z -            
2025-11-10T00:08:56.7584667Z +
2025-11-10T00:08:56.7584792Z              let items: Vec<Result<(Vec<u8>, Vec<u8>)>> = table
2025-11-10T00:08:56.7584861Z                  .iter()
2025-11-10T00:08:56.7584940Z                  .map(|item| {
2025-11-10T00:08:56.7585205Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:392:
2025-11-10T00:08:56.7585356Z                          .map_err(|e| anyhow::anyhow!("Redb iteration error: {}", e))
2025-11-10T00:08:56.7585426Z                  })
2025-11-10T00:08:56.7585498Z                  .collect();
2025-11-10T00:08:56.7585559Z -            
2025-11-10T00:08:56.7585617Z +
2025-11-10T00:08:56.7585711Z              Box::new(items.into_iter())
2025-11-10T00:08:56.7585772Z          }
2025-11-10T00:08:56.7585831Z      }
2025-11-10T00:08:56.7586094Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:399:
2025-11-10T00:08:56.7586158Z  }
2025-11-10T00:08:56.7586216Z -
2025-11-10T00:08:56.7586412Z  
2025-11-10T00:08:56.7586666Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:4:
2025-11-10T00:08:56.7586865Z  //! Supports multiple database backends via feature flags (sled, redb).
2025-11-10T00:08:56.7586973Z  
2025-11-10T00:08:56.7587112Z  pub mod blockstore;
2025-11-10T00:08:56.7587240Z +pub mod chainstate;
2025-11-10T00:08:56.7587396Z  #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.7587530Z  pub mod commitment_store;
2025-11-10T00:08:56.7588060Z -pub mod chainstate;
2025-11-10T00:08:56.7588193Z  pub mod database;
2025-11-10T00:08:56.7588316Z  pub mod hashing;
2025-11-10T00:08:56.7588444Z  pub mod pruning;
2025-11-10T00:08:56.7588885Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:13:
2025-11-10T00:08:56.7589008Z  pub mod txindex;
2025-11-10T00:08:56.7589127Z  pub mod utxostore;
2025-11-10T00:08:56.7589237Z  
2025-11-10T00:08:56.7589393Z +use crate::config::PruningConfig;
2025-11-10T00:08:56.7589771Z  use anyhow::Result;
2025-11-10T00:08:56.7590331Z  use database::{create_database, default_backend, fallback_backend, Database, DatabaseBackend};
2025-11-10T00:08:56.7590465Z  use std::path::Path;
2025-11-10T00:08:56.7590900Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:19:
2025-11-10T00:08:56.7591033Z  use std::sync::Arc;
2025-11-10T00:08:56.7591172Z -use tracing::{warn, info};
2025-11-10T00:08:56.7591322Z -use crate::config::PruningConfig;
2025-11-10T00:08:56.7591403Z +use tracing::{info, warn};
2025-11-10T00:08:56.7591466Z  
2025-11-10T00:08:56.7591611Z  /// Storage manager that coordinates all storage operations
2025-11-10T00:08:56.7591690Z  pub struct Storage {
2025-11-10T00:08:56.7591943Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:32:
2025-11-10T00:08:56.7592003Z  
2025-11-10T00:08:56.7592073Z  impl Storage {
2025-11-10T00:08:56.7592202Z      /// Create a new storage instance with default backend
2025-11-10T00:08:56.7592282Z -    /// 
2025-11-10T00:08:56.7592343Z +    ///
2025-11-10T00:08:56.7592527Z      /// Attempts to use the default backend (redb), and gracefully falls back
2025-11-10T00:08:56.7592641Z      /// to sled if redb fails and sled is available.
2025-11-10T00:08:56.7592779Z      pub fn new<P: AsRef<Path>>(data_dir: P) -> Result<Self> {
2025-11-10T00:08:56.7593026Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:39:
2025-11-10T00:08:56.7593119Z          let default = default_backend();
2025-11-10T00:08:56.7593181Z -        
2025-11-10T00:08:56.7593239Z +
2025-11-10T00:08:56.7593324Z          // Try default backend first
2025-11-10T00:08:56.7593461Z          match Self::with_backend(data_dir.as_ref(), default) {
2025-11-10T00:08:56.7593545Z              Ok(storage) => Ok(storage),
2025-11-10T00:08:56.7593784Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:44:
2025-11-10T00:08:56.7593863Z              Err(e) => {
2025-11-10T00:08:56.7593970Z                  // If default backend fails, try fallback
2025-11-10T00:08:56.7594119Z                  if let Some(fallback_backend) = fallback_backend(default) {
2025-11-10T00:08:56.7594516Z -                    warn!("Failed to initialize {:?} backend: {}. Falling back to {:?}.", default, e, fallback_backend);
2025-11-10T00:08:56.7594757Z -                    info!("Attempting to initialize storage with fallback backend: {:?}", fallback_backend);
2025-11-10T00:08:56.7594829Z +                    warn!(
2025-11-10T00:08:56.7594982Z +                        "Failed to initialize {:?} backend: {}. Falling back to {:?}.",
2025-11-10T00:08:56.7595083Z +                        default, e, fallback_backend
2025-11-10T00:08:56.7595149Z +                    );
2025-11-10T00:08:56.7595215Z +                    info!(
2025-11-10T00:08:56.7595380Z +                        "Attempting to initialize storage with fallback backend: {:?}",
2025-11-10T00:08:56.7595464Z +                        fallback_backend
2025-11-10T00:08:56.7595680Z +                    );
2025-11-10T00:08:56.7595802Z                      Self::with_backend(data_dir, fallback_backend)
2025-11-10T00:08:56.7595877Z                  } else {
2025-11-10T00:08:56.7595959Z                      Err(anyhow::anyhow!(
2025-11-10T00:08:56.7596204Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:52:
2025-11-10T00:08:56.7596389Z                          "Failed to initialize {:?} backend: {}. No fallback backend available.",
2025-11-10T00:08:56.7596467Z -                        default, e
2025-11-10T00:08:56.7596540Z +                        default,
2025-11-10T00:08:56.7596616Z +                        e
2025-11-10T00:08:56.7596680Z                      ))
2025-11-10T00:08:56.7596746Z                  }
2025-11-10T00:08:56.7596810Z              }
2025-11-10T00:08:56.7597061Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:145:
2025-11-10T00:08:56.7597276Z      pub fn flush(&self) -> Result<()> {
2025-11-10T00:08:56.7597356Z          self.db.flush()
2025-11-10T00:08:56.7597425Z      }
2025-11-10T00:08:56.7597487Z -    
2025-11-10T00:08:56.7597545Z +
2025-11-10T00:08:56.7597684Z      /// Get approximate disk size used by storage (in bytes)
2025-11-10T00:08:56.7597754Z -    /// 
2025-11-10T00:08:56.7597817Z +    ///
2025-11-10T00:08:56.7597981Z      /// Returns an estimate based on tree sizes. If any operation fails,
2025-11-10T00:08:56.7598091Z      /// returns 0 gracefully rather than erroring.
2025-11-10T00:08:56.7598205Z      /// Includes bounds checking to prevent overflow.
2025-11-10T00:08:56.7598450Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:154:
2025-11-10T00:08:56.7598555Z      pub fn disk_size(&self) -> Result<u64> {
2025-11-10T00:08:56.7598722Z          // Estimate based on tree sizes (graceful degradation if counts fail)
2025-11-10T00:08:56.7598800Z          let mut size = 0u64;
2025-11-10T00:08:56.7598865Z -        
2025-11-10T00:08:56.7598935Z +
2025-11-10T00:08:56.7599110Z          // Block size estimate (gracefully handle errors, with bounds checking)
2025-11-10T00:08:56.7599231Z          if let Ok(count) = self.blockstore.block_count() {
2025-11-10T00:08:56.7599392Z              const MAX_BLOCKS: u64 = 10_000_000; // 10M blocks max (safety limit)
2025-11-10T00:08:56.7599633Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:162:
2025-11-10T00:08:56.7599768Z              const BYTES_PER_BLOCK: u64 = 1_024_000; // ~1MB per block
2025-11-10T00:08:56.7599955Z              size = size.saturating_add(safe_count.saturating_mul(BYTES_PER_BLOCK));
2025-11-10T00:08:56.7600017Z          }
2025-11-10T00:08:56.7600077Z -        
2025-11-10T00:08:56.7600135Z +
2025-11-10T00:08:56.7600315Z          // UTXO size estimate (gracefully handle errors, with bounds checking)
2025-11-10T00:08:56.7600428Z          if let Ok(count) = self.utxostore.utxo_count() {
2025-11-10T00:08:56.7600580Z              const MAX_UTXOS: u64 = 1_000_000_000; // 1B UTXOs max (safety limit)
2025-11-10T00:08:56.7600828Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:170:
2025-11-10T00:08:56.7600957Z              const BYTES_PER_UTXO: u64 = 100; // ~100 bytes per UTXO
2025-11-10T00:08:56.7601133Z              size = size.saturating_add(safe_count.saturating_mul(BYTES_PER_UTXO));
2025-11-10T00:08:56.7601194Z          }
2025-11-10T00:08:56.7601258Z -        
2025-11-10T00:08:56.7601317Z +
2025-11-10T00:08:56.7601511Z          // Transaction size estimate (gracefully handle errors, with bounds checking)
2025-11-10T00:08:56.7601639Z          if let Ok(count) = self.txindex.transaction_count() {
2025-11-10T00:08:56.7601792Z              const MAX_TXS: u64 = 1_000_000_000; // 1B transactions max (safety limit)
2025-11-10T00:08:56.7602036Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:178:
2025-11-10T00:08:56.7602183Z              const BYTES_PER_TX: u64 = 500; // ~500 bytes per transaction
2025-11-10T00:08:56.7602454Z              size = size.saturating_add(safe_count.saturating_mul(BYTES_PER_TX));
2025-11-10T00:08:56.7602517Z          }
2025-11-10T00:08:56.7602577Z -        
2025-11-10T00:08:56.7602641Z +
2025-11-10T00:08:56.7602778Z          // Final bounds check: prevent returning unrealistic values
2025-11-10T00:08:56.7602935Z          const MAX_DISK_SIZE: u64 = 10_000_000_000_000; // 10TB max (safety limit)
2025-11-10T00:08:56.7603025Z          Ok(size.min(MAX_DISK_SIZE))
2025-11-10T00:08:56.7603273Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:185:
2025-11-10T00:08:56.7603333Z      }
2025-11-10T00:08:56.7603397Z -    
2025-11-10T00:08:56.7603458Z +
2025-11-10T00:08:56.7603558Z      /// Check storage bounds before operations
2025-11-10T00:08:56.7603743Z      /// Returns true if storage is within safe bounds, false if approaching limits
2025-11-10T00:08:56.7603964Z      pub fn check_storage_bounds(&self) -> Result<bool> {
2025-11-10T00:08:56.7604205Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:190:
2025-11-10T00:08:56.7604435Z          const MAX_BLOCKS: usize = 10_000_000; // 10M blocks
2025-11-10T00:08:56.7604547Z          const MAX_UTXOS: usize = 1_000_000_000; // 1B UTXOs
2025-11-10T00:08:56.7604670Z          const MAX_TXS: usize = 1_000_000_000; // 1B transactions
2025-11-10T00:08:56.7604731Z -        
2025-11-10T00:08:56.7604789Z +
2025-11-10T00:08:56.7604942Z          let block_count = self.blockstore.block_count().unwrap_or(0);
2025-11-10T00:08:56.7605080Z          let utxo_count = self.utxostore.utxo_count().unwrap_or(0);
2025-11-10T00:08:56.7605224Z          let tx_count = self.txindex.transaction_count().unwrap_or(0);
2025-11-10T00:08:56.7605469Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:197:
2025-11-10T00:08:56.7605534Z -        
2025-11-10T00:08:56.7605598Z +
2025-11-10T00:08:56.7605722Z          // Check if we're approaching limits (80% threshold)
2025-11-10T00:08:56.7605841Z          let blocks_ok = block_count < (MAX_BLOCKS * 8 / 10);
2025-11-10T00:08:56.7605950Z          let utxos_ok = utxo_count < (MAX_UTXOS * 8 / 10);
2025-11-10T00:08:56.7606194Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:201:
2025-11-10T00:08:56.7606294Z          let txs_ok = tx_count < (MAX_TXS * 8 / 10);
2025-11-10T00:08:56.7606356Z -        
2025-11-10T00:08:56.7606420Z +
2025-11-10T00:08:56.7606492Z          if !blocks_ok {
2025-11-10T00:08:56.7606722Z -            warn!("Storage bounds: block count ({}) approaching limit ({})", block_count, MAX_BLOCKS);
2025-11-10T00:08:56.7606792Z +            warn!(
2025-11-10T00:08:56.7606936Z +                "Storage bounds: block count ({}) approaching limit ({})",
2025-11-10T00:08:56.7607029Z +                block_count, MAX_BLOCKS
2025-11-10T00:08:56.7607137Z +            );
2025-11-10T00:08:56.7607267Z          }
2025-11-10T00:08:56.7607395Z          if !utxos_ok {
2025-11-10T00:08:56.7607739Z -            warn!("Storage bounds: UTXO count ({}) approaching limit ({})", utxo_count, MAX_UTXOS);
2025-11-10T00:08:56.7607815Z +            warn!(
2025-11-10T00:08:56.7607960Z +                "Storage bounds: UTXO count ({}) approaching limit ({})",
2025-11-10T00:08:56.7608043Z +                utxo_count, MAX_UTXOS
2025-11-10T00:08:56.7608106Z +            );
2025-11-10T00:08:56.7608175Z          }
2025-11-10T00:08:56.7608243Z          if !txs_ok {
2025-11-10T00:08:56.7608487Z -            warn!("Storage bounds: transaction count ({}) approaching limit ({})", tx_count, MAX_TXS);
2025-11-10T00:08:56.7608557Z +            warn!(
2025-11-10T00:08:56.7608722Z +                "Storage bounds: transaction count ({}) approaching limit ({})",
2025-11-10T00:08:56.7608801Z +                tx_count, MAX_TXS
2025-11-10T00:08:56.7608864Z +            );
2025-11-10T00:08:56.7608931Z          }
2025-11-10T00:08:56.7608996Z -        
2025-11-10T00:08:56.7609056Z +
2025-11-10T00:08:56.7609312Z          Ok(blocks_ok && utxos_ok && txs_ok)
2025-11-10T00:08:56.7609375Z      }
2025-11-10T00:08:56.7609436Z -    
2025-11-10T00:08:56.7609495Z +
2025-11-10T00:08:56.7609591Z      /// Get transaction count from txindex
2025-11-10T00:08:56.7609719Z      pub fn transaction_count(&self) -> Result<usize> {
2025-11-10T00:08:56.7609815Z          self.txindex.transaction_count()
2025-11-10T00:08:56.7610149Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:7:
2025-11-10T00:08:56.7610270Z  //! - Custom: Fine-grained control over what to keep
2025-11-10T00:08:56.7610330Z  
2025-11-10T00:08:56.7610464Z  use crate::config::{PruningConfig, PruningMode};
2025-11-10T00:08:56.7610544Z +#[cfg(feature = "bip158")]
2025-11-10T00:08:56.7610690Z +use crate::network::filter_service::BlockFilterService;
2025-11-10T00:08:56.7610792Z  use crate::storage::blockstore::BlockStore;
2025-11-10T00:08:56.7610891Z  #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.7611140Z  use crate::storage::commitment_store::CommitmentStore;
2025-11-10T00:08:56.7611410Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:13:
2025-11-10T00:08:56.7611505Z  #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.7611603Z  use crate::storage::utxostore::UtxoStore;
2025-11-10T00:08:56.7611683Z -#[cfg(feature = "bip158")]
2025-11-10T00:08:56.7611820Z -use crate::network::filter_service::BlockFilterService;
2025-11-10T00:08:56.7611904Z  use anyhow::{anyhow, Result};
2025-11-10T00:08:56.7611989Z  #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.7612072Z  use bllvm_protocol::Hash;
2025-11-10T00:08:56.7612339Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:89:
2025-11-10T00:08:56.7612418Z      pub fn with_features(
2025-11-10T00:08:56.7612501Z          config: PruningConfig,
2025-11-10T00:08:56.7612594Z          blockstore: Arc<BlockStore>,
2025-11-10T00:08:56.7612697Z -        #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.7612821Z -        commitment_store: Option<Arc<CommitmentStore>>,
2025-11-10T00:08:56.7612917Z -        #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.7614793Z -        utxostore: Option<Arc<UtxoStore>>,
2025-11-10T00:08:56.7614878Z -        #[cfg(feature = "bip158")]
2025-11-10T00:08:56.7615003Z -        filter_service: Option<Arc<BlockFilterService>>,
2025-11-10T00:08:56.7615230Z +        #[cfg(feature = "utxo-commitments")] commitment_store: Option<Arc<CommitmentStore>>,
2025-11-10T00:08:56.7615405Z +        #[cfg(feature = "utxo-commitments")] utxostore: Option<Arc<UtxoStore>>,
2025-11-10T00:08:56.7615586Z +        #[cfg(feature = "bip158")] filter_service: Option<Arc<BlockFilterService>>,
2025-11-10T00:08:56.7615659Z      ) -> Self {
2025-11-10T00:08:56.7615722Z          Self {
2025-11-10T00:08:56.7615787Z              config,
2025-11-10T00:08:56.7616058Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:153:
2025-11-10T00:08:56.7616136Z          {
2025-11-10T00:08:56.7616245Z              // Check if UTXO commitments are available
2025-11-10T00:08:56.7616465Z              let has_commitments = self.commitment_store.is_some() && self.utxostore.is_some();
2025-11-10T00:08:56.7616532Z -            
2025-11-10T00:08:56.7616590Z +
2025-11-10T00:08:56.7616706Z              // Check if mode supports incremental pruning
2025-11-10T00:08:56.7616803Z              let mode_supports = matches!(
2025-11-10T00:08:56.7616884Z                  &self.config.mode,
2025-11-10T00:08:56.7617269Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:160:
2025-11-10T00:08:56.7617868Z -                PruningMode::Aggressive { .. } | PruningMode::Custom { keep_commitments: true, .. }
2025-11-10T00:08:56.7618196Z +                PruningMode::Aggressive { .. }
2025-11-10T00:08:56.7618352Z +                    | PruningMode::Custom {
2025-11-10T00:08:56.7618502Z +                        keep_commitments: true,
2025-11-10T00:08:56.7618826Z +                        ..
2025-11-10T00:08:56.7618937Z +                    }
2025-11-10T00:08:56.7619049Z              );
2025-11-10T00:08:56.7619157Z -            
2025-11-10T00:08:56.7619227Z +
2025-11-10T00:08:56.7619327Z              has_commitments && mode_supports
2025-11-10T00:08:56.7619389Z          }
2025-11-10T00:08:56.7619496Z          #[cfg(not(feature = "utxo-commitments"))]
2025-11-10T00:08:56.7619771Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:169:
2025-11-10T00:08:56.7619834Z      }
2025-11-10T00:08:56.7619895Z  
2025-11-10T00:08:56.7619990Z      /// Incremental prune during IBD
2025-11-10T00:08:56.7620051Z -    /// 
2025-11-10T00:08:56.7620111Z +    ///
2025-11-10T00:08:56.7620322Z      /// This method prunes old blocks while keeping a sliding window of recent blocks.
2025-11-10T00:08:56.7620535Z      /// It's designed to be called periodically during IBD to prevent storage from growing
2025-11-10T00:08:56.7620900Z      /// unbounded. Only works when incremental_prune_during_ibd is enabled and UTXO
2025-11-10T00:08:56.7621173Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:203:
2025-11-10T00:08:56.7621234Z  
2025-11-10T00:08:56.7621409Z          // Calculate prune height: keep only the last prune_window_size blocks
2025-11-10T00:08:56.7621634Z          let prune_to_height = current_height.saturating_sub(self.config.prune_window_size);
2025-11-10T00:08:56.7621702Z -        
2025-11-10T00:08:56.7621762Z +
2025-11-10T00:08:56.7621896Z          // Don't prune if window size is larger than current height
2025-11-10T00:08:56.7622046Z          if prune_to_height == 0 || prune_to_height >= current_height {
2025-11-10T00:08:56.7622123Z              return Ok(None);
2025-11-10T00:08:56.7622377Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:245:
2025-11-10T00:08:56.7622502Z              // 1. Incremental pruning is explicitly enabled
2025-11-10T00:08:56.7622660Z              // 2. UTXO commitments are available (for state verification)
2025-11-10T00:08:56.7622795Z              // 3. Aggressive or Custom mode with commitments enabled
2025-11-10T00:08:56.7622981Z -            let can_incremental_prune = self.config.incremental_prune_during_ibd
2025-11-10T00:08:56.7623094Z -                && self.can_incremental_prune_during_ibd();
2025-11-10T00:08:56.7623158Z -            
2025-11-10T00:08:56.7623245Z +            let can_incremental_prune =
2025-11-10T00:08:56.7623484Z +                self.config.incremental_prune_during_ibd && self.can_incremental_prune_during_ibd();
2025-11-10T00:08:56.7623545Z +
2025-11-10T00:08:56.7623632Z              if !can_incremental_prune {
2025-11-10T00:08:56.7623716Z                  return Err(anyhow!(
2025-11-10T00:08:56.7624103Z                      "Cannot prune during initial block download. Wait for IBD to complete, or enable incremental_prune_during_ibd with UTXO commitments."
2025-11-10T00:08:56.7624514Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:254:
2025-11-10T00:08:56.7624586Z                  ));
2025-11-10T00:08:56.7624655Z              }
2025-11-10T00:08:56.7624717Z -            
2025-11-10T00:08:56.7624776Z +
2025-11-10T00:08:56.7624954Z              // For incremental pruning during IBD, ensure we have enough blocks
2025-11-10T00:08:56.7625128Z              if current_height < self.config.min_blocks_for_incremental_prune {
2025-11-10T00:08:56.7625208Z                  return Err(anyhow!(
2025-11-10T00:08:56.7625466Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:295:
2025-11-10T00:08:56.7625560Z              PruningMode::Normal {
2025-11-10T00:08:56.7625634Z                  keep_from_height,
2025-11-10T00:08:56.7625710Z                  min_recent_blocks,
2025-11-10T00:08:56.7625974Z -            } => self.prune_normal(prune_to_height, current_height, *keep_from_height, *min_recent_blocks)?,
2025-11-10T00:08:56.7626184Z +            } => self.prune_normal(
2025-11-10T00:08:56.7626261Z +                prune_to_height,
2025-11-10T00:08:56.7626340Z +                current_height,
2025-11-10T00:08:56.7626414Z +                *keep_from_height,
2025-11-10T00:08:56.7626487Z +                *min_recent_blocks,
2025-11-10T00:08:56.7626551Z +            )?,
2025-11-10T00:08:56.7626646Z              PruningMode::Aggressive {
2025-11-10T00:08:56.7626727Z                  keep_from_height,
2025-11-10T00:08:56.7626805Z                  keep_commitments,
2025-11-10T00:08:56.7627091Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:370:
2025-11-10T00:08:56.7627209Z          let mut stats = PruningStats::default();
2025-11-10T00:08:56.7627271Z  
2025-11-10T00:08:56.7627472Z          // Calculate actual keep height (max of keep_from_height and min_recent_blocks)
2025-11-10T00:08:56.7627601Z -        let effective_keep_height = keep_from_height.max(
2025-11-10T00:08:56.7627863Z -            current_height.saturating_sub(min_recent_blocks)
2025-11-10T00:08:56.7627932Z -        );
2025-11-10T00:08:56.7628020Z +        let effective_keep_height =
2025-11-10T00:08:56.7628211Z +            keep_from_height.max(current_height.saturating_sub(min_recent_blocks));
2025-11-10T00:08:56.7628273Z  
2025-11-10T00:08:56.7628401Z          // Ensure we don't prune below effective keep height
2025-11-10T00:08:56.7628587Z          let actual_prune_height = prune_to_height.min(effective_keep_height);
2025-11-10T00:08:56.7628850Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:415:
2025-11-10T00:08:56.7628960Z          let mut stats = PruningStats::default();
2025-11-10T00:08:56.7629022Z  
2025-11-10T00:08:56.7629126Z          // Calculate effective keep height
2025-11-10T00:08:56.7629252Z -        let effective_keep_height = keep_from_height.max(
2025-11-10T00:08:56.7629366Z -            current_height.saturating_sub(min_blocks)
2025-11-10T00:08:56.7629438Z -        );
2025-11-10T00:08:56.7629690Z +        let effective_keep_height = keep_from_height.max(current_height.saturating_sub(min_blocks));
2025-11-10T00:08:56.7629752Z  
2025-11-10T00:08:56.7638268Z          let actual_prune_height = prune_to_height.min(effective_keep_height);
2025-11-10T00:08:56.7638418Z  
2025-11-10T00:08:56.7638893Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:428:
2025-11-10T00:08:56.7638995Z  
2025-11-10T00:08:56.7639221Z          // Generate UTXO commitments before pruning if enabled
2025-11-10T00:08:56.7639380Z          if keep_commitments {
2025-11-10T00:08:56.7639630Z -            if let (Some(ref commitment_store), Some(ref utxostore)) = 
2025-11-10T00:08:56.7639909Z -                (self.commitment_store.as_ref(), self.utxostore.as_ref()) 
2025-11-10T00:08:56.7640139Z +            if let (Some(ref commitment_store), Some(ref utxostore)) =
2025-11-10T00:08:56.7640367Z +                (self.commitment_store.as_ref(), self.utxostore.as_ref())
2025-11-10T00:08:56.7640503Z              {
2025-11-10T00:08:56.7640771Z                  info!("Generating UTXO commitments for blocks to be pruned...");
2025-11-10T00:08:56.7640959Z                  self.generate_commitments_before_prune(
2025-11-10T00:08:56.7643054Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:439:
2025-11-10T00:08:56.7643175Z                      utxostore,
2025-11-10T00:08:56.7643292Z                  )?;
2025-11-10T00:08:56.7643401Z              } else {
2025-11-10T00:08:56.7643776Z -                warn!("UTXO commitments requested but commitment store or UTXO store not available");
2025-11-10T00:08:56.7643903Z +                warn!(
2025-11-10T00:08:56.7644266Z +                    "UTXO commitments requested but commitment store or UTXO store not available"
2025-11-10T00:08:56.7644587Z +                );
2025-11-10T00:08:56.7644701Z              }
2025-11-10T00:08:56.7644826Z          }
2025-11-10T00:08:56.7644943Z  
2025-11-10T00:08:56.7645668Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:464:
2025-11-10T00:08:56.7645902Z                      // Remove filter from cache but keep filter header
2025-11-10T00:08:56.7646081Z                      if filter_service.has_filter(&hash) {
2025-11-10T00:08:56.7646341Z                          filter_service.remove_filter_for_pruned_block(&hash)?;
2025-11-10T00:08:56.7646732Z -                        debug!("Removed BIP158 filter for pruned block at height {} (header kept)", height);
2025-11-10T00:08:56.7646879Z +                        debug!(
2025-11-10T00:08:56.7647204Z +                            "Removed BIP158 filter for pruned block at height {} (header kept)",
2025-11-10T00:08:56.7647337Z +                            height
2025-11-10T00:08:56.7647470Z +                        );
2025-11-10T00:08:56.7647584Z                      }
2025-11-10T00:08:56.7647696Z                  }
2025-11-10T00:08:56.7648078Z              }
2025-11-10T00:08:56.7648575Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:524:
2025-11-10T00:08:56.7648735Z                  if keep_commitments {
2025-11-10T00:08:56.7648917Z                      #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.7649043Z                      {
2025-11-10T00:08:56.7649300Z -                        if let (Some(ref commitment_store), Some(ref utxostore)) = 
2025-11-10T00:08:56.7649572Z -                            (self.commitment_store.as_ref(), self.utxostore.as_ref()) 
2025-11-10T00:08:56.7649810Z +                        if let (Some(ref commitment_store), Some(ref utxostore)) =
2025-11-10T00:08:56.7650058Z +                            (self.commitment_store.as_ref(), self.utxostore.as_ref())
2025-11-10T00:08:56.7650180Z                          {
2025-11-10T00:08:56.7650368Z                              // Generate commitment if not exists
2025-11-10T00:08:56.7650576Z                              if !commitment_store.has_commitment(&hash)? {
2025-11-10T00:08:56.7651064Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:547:
2025-11-10T00:08:56.7651310Z                          // Filter headers are always kept for chain verification
2025-11-10T00:08:56.7651493Z                          if filter_service.has_filter(&hash) {
2025-11-10T00:08:56.7651736Z                              filter_service.remove_filter_for_pruned_block(&hash)?;
2025-11-10T00:08:56.7652115Z -                            debug!("Removed BIP158 filter for pruned block at height {} (header kept)", height);
2025-11-10T00:08:56.7652250Z +                            debug!(
2025-11-10T00:08:56.7652550Z +                                "Removed BIP158 filter for pruned block at height {} (header kept)",
2025-11-10T00:08:56.7652678Z +                                height
2025-11-10T00:08:56.7654885Z +                            );
2025-11-10T00:08:56.7655007Z                          }
2025-11-10T00:08:56.7655134Z                      }
2025-11-10T00:08:56.7655251Z                  }
2025-11-10T00:08:56.7655738Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:569:
2025-11-10T00:08:56.7655901Z          commitment_store: &CommitmentStore,
2025-11-10T00:08:56.7656030Z          utxostore: &UtxoStore,
2025-11-10T00:08:56.7656157Z      ) -> Result<()> {
2025-11-10T00:08:56.7656480Z -        info!("Generating UTXO commitments for heights 0..{}", prune_to_height);
2025-11-10T00:08:56.7656586Z +        info!(
2025-11-10T00:08:56.7656806Z +            "Generating UTXO commitments for heights 0..{}",
2025-11-10T00:08:56.7656934Z +            prune_to_height
2025-11-10T00:08:56.7657038Z +        );
2025-11-10T00:08:56.7657144Z  
2025-11-10T00:08:56.7657367Z          // For each block to be pruned, generate a commitment
2025-11-10T00:08:56.7657682Z          // We'll generate commitments at checkpoint intervals to save computation
2025-11-10T00:08:56.7658142Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:601:
2025-11-10T00:08:56.7658611Z          commitment_store: &CommitmentStore,
2025-11-10T00:08:56.7658752Z          utxostore: &UtxoStore,
2025-11-10T00:08:56.7658876Z      ) -> Result<()> {
2025-11-10T00:08:56.7659040Z -        #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.7659359Z -        use bllvm_protocol::utxo_commitments::merkle_tree::UtxoMerkleTree;
2025-11-10T00:08:56.7659540Z          use bllvm_protocol::block::connect_block;
2025-11-10T00:08:56.7659693Z          use bllvm_protocol::segwit::Witness;
2025-11-10T00:08:56.7659852Z +        #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.7660139Z +        use bllvm_protocol::utxo_commitments::merkle_tree::UtxoMerkleTree;
2025-11-10T00:08:56.7660244Z  
2025-11-10T00:08:56.7660539Z          // Reconstruct UTXO set at historical height by replaying blocks
2025-11-10T00:08:56.7660857Z          let utxo_set = self.reconstruct_utxo_set_at_height(height, utxostore)?;
2025-11-10T00:08:56.7661549Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:614:
2025-11-10T00:08:56.7661897Z              .map_err(|e| anyhow::anyhow!("Failed to create UTXO Merkle tree: {:?}", e))?;
2025-11-10T00:08:56.7662006Z  
2025-11-10T00:08:56.7662165Z          for (outpoint, utxo) in &utxo_set {
2025-11-10T00:08:56.7662356Z -            utxo_tree.insert(*outpoint, utxo.clone())
2025-11-10T00:08:56.7662478Z +            utxo_tree
2025-11-10T00:08:56.7663100Z +                .insert(*outpoint, utxo.clone())
2025-11-10T00:08:56.7663394Z                  .map_err(|e| anyhow::anyhow!("Failed to insert UTXO: {:?}", e))?;
2025-11-10T00:08:56.7663516Z          }
2025-11-10T00:08:56.7663619Z  
2025-11-10T00:08:56.7664072Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:624:
2025-11-10T00:08:56.7664206Z          // Store commitment
2025-11-10T00:08:56.7664755Z          commitment_store.store_commitment(block_hash, height, &commitment)?;
2025-11-10T00:08:56.7664883Z  
2025-11-10T00:08:56.7665184Z -        debug!("Generated and stored commitment for height {} (hash: {})", 
2025-11-10T00:08:56.7665364Z -               height, hex::encode(block_hash));
2025-11-10T00:08:56.7665471Z +        debug!(
2025-11-10T00:08:56.7665731Z +            "Generated and stored commitment for height {} (hash: {})",
2025-11-10T00:08:56.7665850Z +            height,
2025-11-10T00:08:56.7665991Z +            hex::encode(block_hash)
2025-11-10T00:08:56.7666097Z +        );
2025-11-10T00:08:56.7666202Z  
2025-11-10T00:08:56.7666315Z          Ok(())
2025-11-10T00:08:56.7666420Z      }
2025-11-10T00:08:56.7666864Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:632:
2025-11-10T00:08:56.7666980Z  
2025-11-10T00:08:56.7667207Z      /// Generate UTXO commitment from current UTXO set state
2025-11-10T00:08:56.7667312Z -    /// 
2025-11-10T00:08:56.7667413Z +    ///
2025-11-10T00:08:56.7667828Z      /// This method generates a commitment from the current UTXO set without replaying blocks.
2025-11-10T00:08:56.7668181Z      /// Used during incremental sync when the UTXO set is maintained incrementally.
2025-11-10T00:08:56.7668283Z -    /// 
2025-11-10T00:08:56.7668385Z +    ///
2025-11-10T00:08:56.7668495Z      /// # Arguments
2025-11-10T00:08:56.7668725Z      /// * `block_hash` - Hash of the block at this height
2025-11-10T00:08:56.7668879Z      /// * `height` - Block height
2025-11-10T00:08:56.7669373Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:641:
2025-11-10T00:08:56.7669532Z      /// * `utxo_set` - Current UTXO set (from incremental updates)
2025-11-10T00:08:56.7669690Z      /// * `commitment_store` - Commitment store to save the commitment
2025-11-10T00:08:56.7669762Z -    /// 
2025-11-10T00:08:56.7669825Z +    ///
2025-11-10T00:08:56.7669894Z      /// # Returns
2025-11-10T00:08:56.7669991Z      /// Result indicating success or failure
2025-11-10T00:08:56.7670102Z      #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.7670607Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:658:
2025-11-10T00:08:56.7670803Z              .map_err(|e| anyhow::anyhow!("Failed to create UTXO Merkle tree: {:?}", e))?;
2025-11-10T00:08:56.7670872Z  
2025-11-10T00:08:56.7670965Z          for (outpoint, utxo) in utxo_set {
2025-11-10T00:08:56.7671079Z -            utxo_tree.insert(*outpoint, utxo.clone())
2025-11-10T00:08:56.7671154Z +            utxo_tree
2025-11-10T00:08:56.7671249Z +                .insert(*outpoint, utxo.clone())
2025-11-10T00:08:56.7671401Z                  .map_err(|e| anyhow::anyhow!("Failed to insert UTXO: {:?}", e))?;
2025-11-10T00:08:56.7671470Z          }
2025-11-10T00:08:56.7671532Z  
2025-11-10T00:08:56.7671792Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:668:
2025-11-10T00:08:56.7671872Z          // Store commitment
2025-11-10T00:08:56.7672059Z          commitment_store.store_commitment(block_hash, height, &commitment)?;
2025-11-10T00:08:56.7672248Z  
2025-11-10T00:08:56.7672440Z -        debug!("Generated commitment from current state for height {} (hash: {})", 
2025-11-10T00:08:56.7672542Z -               height, hex::encode(block_hash));
2025-11-10T00:08:56.7672823Z +        debug!(
2025-11-10T00:08:56.7673000Z +            "Generated commitment from current state for height {} (hash: {})",
2025-11-10T00:08:56.7673067Z +            height,
2025-11-10T00:08:56.7673159Z +            hex::encode(block_hash)
2025-11-10T00:08:56.7673223Z +        );
2025-11-10T00:08:56.7673284Z  
2025-11-10T00:08:56.7673351Z          Ok(())
2025-11-10T00:08:56.7673411Z      }
2025-11-10T00:08:56.7673667Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:676:
2025-11-10T00:08:56.7673729Z  
2025-11-10T00:08:56.7673878Z      /// Reconstruct UTXO set at a specific historical height
2025-11-10T00:08:56.7673943Z -    /// 
2025-11-10T00:08:56.7674011Z +    ///
2025-11-10T00:08:56.7674178Z      /// This function replays blocks from genesis to the target height
2025-11-10T00:08:56.7674526Z      /// to reconstruct the exact UTXO set at that point in history.
2025-11-10T00:08:56.7674624Z      #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.7674900Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:703:
2025-11-10T00:08:56.7674981Z                  // Get block
2025-11-10T00:08:56.7675132Z                  if let Some(block) = self.blockstore.get_block(&block_hash)? {
2025-11-10T00:08:56.7675229Z                      // Get witnesses for this block
2025-11-10T00:08:56.7677140Z -                    let witnesses = self.blockstore.get_witness(&block_hash)?
2025-11-10T00:08:56.7677272Z -                        .unwrap_or_else(|| {
2025-11-10T00:08:56.7677481Z -                            // If no witnesses stored, create empty witnesses
2025-11-10T00:08:56.7677755Z -                            block.transactions.iter().map(|_| Vec::new()).collect()
2025-11-10T00:08:56.7677885Z -                        });
2025-11-10T00:08:56.7678014Z +                    let witnesses =
2025-11-10T00:08:56.7678150Z +                        self.blockstore
2025-11-10T00:08:56.7678314Z +                            .get_witness(&block_hash)?
2025-11-10T00:08:56.7678464Z +                            .unwrap_or_else(|| {
2025-11-10T00:08:56.7678619Z +                                // If no witnesses stored, create empty witnesses
2025-11-10T00:08:56.7678786Z +                                block.transactions.iter().map(|_| Vec::new()).collect()
2025-11-10T00:08:56.7678861Z +                            });
2025-11-10T00:08:56.7678924Z  
2025-11-10T00:08:56.7679045Z                      // Apply block to UTXO set using connect_block
2025-11-10T00:08:56.7679255Z                      // This properly handles coinbase transactions and input/output processing
2025-11-10T00:08:56.7679525Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:714:
2025-11-10T00:08:56.7679836Z                      let (validation_result, new_utxo_set) = connect_block(
2025-11-10T00:08:56.7679915Z -                        &block,
2025-11-10T00:08:56.7679989Z -                        &witnesses,
2025-11-10T00:08:56.7680066Z -                        utxo_set,
2025-11-10T00:08:56.7680143Z -                        height,
2025-11-10T00:08:56.7680248Z +                        &block, &witnesses, utxo_set, height,
2025-11-10T00:08:56.7680387Z                          None, // No recent headers needed for historical replay
2025-11-10T00:08:56.7680459Z                      )?;
2025-11-10T00:08:56.7680521Z  
2025-11-10T00:08:56.7680783Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:722:
2025-11-10T00:08:56.7680876Z                      // Check validation result
2025-11-10T00:08:56.7681075Z                      if !matches!(validation_result, bllvm_protocol::ValidationResult::Valid) {
2025-11-10T00:08:56.7681413Z -                        warn!("Block at height {} failed validation during UTXO reconstruction", height);
2025-11-10T00:08:56.7681489Z +                        warn!(
2025-11-10T00:08:56.7681661Z +                            "Block at height {} failed validation during UTXO reconstruction",
2025-11-10T00:08:56.7681735Z +                            height
2025-11-10T00:08:56.7681805Z +                        );
2025-11-10T00:08:56.7681974Z                          // Continue anyway - this might be expected for some edge cases
2025-11-10T00:08:56.7682041Z                      }
2025-11-10T00:08:56.7682101Z  
2025-11-10T00:08:56.7682357Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:740:
2025-11-10T00:08:56.7682427Z              }
2025-11-10T00:08:56.7682491Z          }
2025-11-10T00:08:56.7682551Z  
2025-11-10T00:08:56.7682787Z -        debug!("Reconstructed UTXO set at height {} with {} UTXOs", target_height, utxo_set.len());
2025-11-10T00:08:56.7682856Z +        debug!(
2025-11-10T00:08:56.7682989Z +            "Reconstructed UTXO set at height {} with {} UTXOs",
2025-11-10T00:08:56.7683064Z +            target_height,
2025-11-10T00:08:56.7683140Z +            utxo_set.len()
2025-11-10T00:08:56.7683202Z +        );
2025-11-10T00:08:56.7683270Z          Ok(utxo_set)
2025-11-10T00:08:56.7683340Z      }
2025-11-10T00:08:56.7683400Z  }
2025-11-10T00:08:56.7683651Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:747:
2025-11-10T00:08:56.7683713Z -
2025-11-10T00:08:56.7683780Z  
2025-11-10T00:08:56.7686653Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/txindex.rs:2:
2025-11-10T00:08:56.7686737Z  //!
2025-11-10T00:08:56.7686978Z  //! Provides fast lookup of transactions by hash and maintains transaction metadata.
2025-11-10T00:08:56.7687042Z  
2025-11-10T00:08:56.7687163Z +use crate::storage::database::{Database, Tree};
2025-11-10T00:08:56.7687246Z  use anyhow::Result;
2025-11-10T00:08:56.7687355Z  use bllvm_protocol::{Hash, Transaction};
2025-11-10T00:08:56.7687458Z  use serde::{Deserialize, Serialize};
2025-11-10T00:08:56.7688025Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/txindex.rs:8:
2025-11-10T00:08:56.7688154Z -use crate::storage::database::{Database, Tree};
2025-11-10T00:08:56.7688229Z  use std::sync::Arc;
2025-11-10T00:08:56.7688290Z  
2025-11-10T00:08:56.7688376Z  /// Transaction metadata
2025-11-10T00:08:56.7688633Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/txindex.rs:68:
2025-11-10T00:08:56.7688697Z          };
2025-11-10T00:08:56.7688759Z  
2025-11-10T00:08:56.7688897Z          let metadata_data = bincode::serialize(&metadata)?;
2025-11-10T00:08:56.7689057Z -        self.tx_metadata.insert(tx_hash.as_slice(), &metadata_data)?;
2025-11-10T00:08:56.7689132Z +        self.tx_metadata
2025-11-10T00:08:56.7689248Z +            .insert(tx_hash.as_slice(), &metadata_data)?;
2025-11-10T00:08:56.7689315Z  
2025-11-10T00:08:56.7689392Z          // Index by block
2025-11-10T00:08:56.7689699Z          let block_key = self.block_tx_key(block_hash, tx_index);
2025-11-10T00:08:56.7689875Z error[internal]: left behind trailing whitespace
2025-11-10T00:08:56.7690127Z   --> /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:91:91:1
2025-11-10T00:08:56.7690188Z    |
2025-11-10T00:08:56.7690254Z 91 |                 
2025-11-10T00:08:56.7690318Z    | ^^^^^^^^^^^^^^^^
2025-11-10T00:08:56.7690385Z    |
2025-11-10T00:08:56.7690389Z 
2025-11-10T00:08:56.7690547Z warning: rustfmt has failed to format. See previous 1 errors.
2025-11-10T00:08:56.7690553Z 
2025-11-10T00:08:56.7690813Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/utxostore.rs:2:
2025-11-10T00:08:56.7690880Z  //!
2025-11-10T00:08:56.7691056Z  //! Stores and manages the UTXO set for efficient transaction validation.
2025-11-10T00:08:56.7691119Z  
2025-11-10T00:08:56.7691234Z +use crate::storage::database::{Database, Tree};
2025-11-10T00:08:56.7691432Z  use anyhow::Result;
2025-11-10T00:08:56.7691546Z  use bllvm_protocol::{OutPoint, UtxoSet, UTXO};
2025-11-10T00:08:56.7691653Z -use crate::storage::database::{Database, Tree};
2025-11-10T00:08:56.7691748Z  use std::collections::HashMap;
2025-11-10T00:08:56.7691823Z  use std::sync::Arc;
2025-11-10T00:08:56.7691884Z  
2025-11-10T00:08:56.7692144Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/validation/mod.rs:51:
2025-11-10T00:08:56.7692242Z          context: &BlockValidationContext,
2025-11-10T00:08:56.7692345Z      ) -> Result<(ValidationResult, UtxoSet)> {
2025-11-10T00:08:56.7692458Z          // Create empty witnesses for each transaction
2025-11-10T00:08:56.7692729Z -        let witnesses: Vec<Witness> = context.block.transactions.iter().map(|_| Vec::new()).collect();
2025-11-10T00:08:56.7692827Z +        let witnesses: Vec<Witness> = context
2025-11-10T00:08:56.7692895Z +            .block
2025-11-10T00:08:56.7692979Z +            .transactions
2025-11-10T00:08:56.7693048Z +            .iter()
2025-11-10T00:08:56.7693130Z +            .map(|_| Vec::new())
2025-11-10T00:08:56.7693207Z +            .collect();
2025-11-10T00:08:56.7693279Z          connect_block(
2025-11-10T00:08:56.7693355Z              &context.block,
2025-11-10T00:08:56.7693424Z              &witnesses,
2025-11-10T00:08:56.7695584Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/validation/mod.rs:87:
2025-11-10T00:08:56.7695660Z              .par_iter()
2025-11-10T00:08:56.7695738Z              .map(|context| {
2025-11-10T00:08:56.7695864Z                  // Create empty witnesses for each transaction
2025-11-10T00:08:56.7696128Z -                let witnesses: Vec<Witness> = context.block.transactions.iter().map(|_| Vec::new()).collect();
2025-11-10T00:08:56.7696229Z +                let witnesses: Vec<Witness> = context
2025-11-10T00:08:56.7696297Z +                    .block
2025-11-10T00:08:56.7696378Z +                    .transactions
2025-11-10T00:08:56.7696450Z +                    .iter()
2025-11-10T00:08:56.7696537Z +                    .map(|_| Vec::new())
2025-11-10T00:08:56.7696617Z +                    .collect();
2025-11-10T00:08:56.7696691Z                  connect_block(
2025-11-10T00:08:56.7696769Z                      &context.block,
2025-11-10T00:08:56.7696845Z                      &witnesses,
2025-11-10T00:08:56.7697108Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/validation/mod.rs:116:
2025-11-10T00:08:56.7697169Z  
2025-11-10T00:08:56.7697249Z          for context in contexts {
2025-11-10T00:08:56.7697367Z              // Create empty witnesses for each transaction
2025-11-10T00:08:56.7697629Z -            let witnesses: Vec<Witness> = context.block.transactions.iter().map(|_| Vec::new()).collect();
2025-11-10T00:08:56.7697726Z +            let witnesses: Vec<Witness> = context
2025-11-10T00:08:56.7697851Z +                .block
2025-11-10T00:08:56.7697982Z +                .transactions
2025-11-10T00:08:56.7698106Z +                .iter()
2025-11-10T00:08:56.7698635Z +                .map(|_| Vec::new())
2025-11-10T00:08:56.7698774Z +                .collect();
2025-11-10T00:08:56.7698921Z              let result = connect_block(
2025-11-10T00:08:56.7699048Z                  &context.block,
2025-11-10T00:08:56.7699171Z                  &witnesses,
2025-11-10T00:08:56.7699622Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:9:
2025-11-10T00:08:56.7699719Z  async fn test_request_id_matching() {
2025-11-10T00:08:56.7699859Z      // Test that requests are matched by request_id, not FIFO
2025-11-10T00:08:56.7700040Z      let manager = NetworkManager::new(TransportPreference::TcpOnly);
2025-11-10T00:08:56.7700102Z -    
2025-11-10T00:08:56.7700162Z +
2025-11-10T00:08:56.7700321Z      let peer_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-10T00:08:56.7700384Z -    
2025-11-10T00:08:56.7700443Z +
2025-11-10T00:08:56.7700683Z      // Register multiple requests
2025-11-10T00:08:56.7700812Z      let (id1, rx1) = manager.register_request(peer_addr);
2025-11-10T00:08:56.7700929Z      let (id2, rx2) = manager.register_request(peer_addr);
2025-11-10T00:08:56.7701226Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:18:
2025-11-10T00:08:56.7701351Z      let (id3, rx3) = manager.register_request(peer_addr);
2025-11-10T00:08:56.7701413Z -    
2025-11-10T00:08:56.7701473Z +
2025-11-10T00:08:56.7701566Z      // Complete requests out of order
2025-11-10T00:08:56.7701650Z      let response2 = vec![2, 2, 2];
2025-11-10T00:08:56.7701727Z      let response1 = vec![1, 1, 1];
2025-11-10T00:08:56.7702003Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:23:
2025-11-10T00:08:56.7702087Z      let response3 = vec![3, 3, 3];
2025-11-10T00:08:56.7702147Z -    
2025-11-10T00:08:56.7702207Z +
2025-11-10T00:08:56.7702362Z      assert!(manager.complete_request(id2, response2.clone()));
2025-11-10T00:08:56.7702511Z      assert!(manager.complete_request(id1, response1.clone()));
2025-11-10T00:08:56.7702650Z      assert!(manager.complete_request(id3, response3.clone()));
2025-11-10T00:08:56.7702930Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:28:
2025-11-10T00:08:56.7702994Z -    
2025-11-10T00:08:56.7703055Z +
2025-11-10T00:08:56.7703168Z      // Verify each receiver got the correct response
2025-11-10T00:08:56.7703246Z      tokio::select! {
2025-11-10T00:08:56.7703321Z          result = rx1 => {
2025-11-10T00:08:56.7703591Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:35:
2025-11-10T00:08:56.7703684Z              panic!("Request 1 timeout");
2025-11-10T00:08:56.7703749Z          }
2025-11-10T00:08:56.7703810Z      }
2025-11-10T00:08:56.7703874Z -    
2025-11-10T00:08:56.7703938Z +
2025-11-10T00:08:56.7704012Z      tokio::select! {
2025-11-10T00:08:56.7704090Z          result = rx2 => {
2025-11-10T00:08:56.7704211Z              assert_eq!(result.unwrap(), response2);
2025-11-10T00:08:56.7704664Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:44:
2025-11-10T00:08:56.7704752Z              panic!("Request 2 timeout");
2025-11-10T00:08:56.7704817Z          }
2025-11-10T00:08:56.7704883Z      }
2025-11-10T00:08:56.7704947Z -    
2025-11-10T00:08:56.7705005Z +
2025-11-10T00:08:56.7705081Z      tokio::select! {
2025-11-10T00:08:56.7705150Z          result = rx3 => {
2025-11-10T00:08:56.7705250Z              assert_eq!(result.unwrap(), response3);
2025-11-10T00:08:56.7705525Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:59:
2025-11-10T00:08:56.7705625Z  async fn test_request_cancellation() {
2025-11-10T00:08:56.7705797Z      let manager = NetworkManager::new(TransportPreference::TcpOnly);
2025-11-10T00:08:56.7705941Z      let peer_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-10T00:08:56.7706014Z -    
2025-11-10T00:08:56.7706252Z +
2025-11-10T00:08:56.7706399Z      let (request_id, rx) = manager.register_request(peer_addr);
2025-11-10T00:08:56.7706467Z -    
2025-11-10T00:08:56.7706528Z +
2025-11-10T00:08:56.7706601Z      // Cancel the request
2025-11-10T00:08:56.7706709Z      assert!(manager.cancel_request(request_id));
2025-11-10T00:08:56.7706775Z -    
2025-11-10T00:08:56.7706836Z +
2025-11-10T00:08:56.7706925Z      // Try to complete it (should fail)
2025-11-10T00:08:56.7707078Z      assert!(!manager.complete_request(request_id, vec![1, 2, 3]));
2025-11-10T00:08:56.7707139Z -    
2025-11-10T00:08:56.7707198Z +
2025-11-10T00:08:56.7707281Z      // Receiver should be closed
2025-11-10T00:08:56.7707367Z      assert!(rx.await.is_err());
2025-11-10T00:08:56.7707428Z  }
2025-11-10T00:08:56.7707868Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:76:
2025-11-10T00:08:56.7707991Z  async fn test_timestamp_cleanup() {
2025-11-10T00:08:56.7708304Z      let manager = NetworkManager::new(TransportPreference::TcpOnly);
2025-11-10T00:08:56.7708454Z      let peer_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-10T00:08:56.7708516Z -    
2025-11-10T00:08:56.7708585Z +
2025-11-10T00:08:56.7708689Z      // Register a request
2025-11-10T00:08:56.7708926Z      let (request_id, _rx) = manager.register_request(peer_addr);
2025-11-10T00:08:56.7708998Z -    
2025-11-10T00:08:56.7709058Z +
2025-11-10T00:08:56.7709202Z      // Cleanup requests older than 0 seconds (should remove all)
2025-11-10T00:08:56.7709325Z      let cleaned = manager.cleanup_expired_requests(0);
2025-11-10T00:08:56.7709409Z      assert_eq!(cleaned, 1);
2025-11-10T00:08:56.7709687Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:86:
2025-11-10T00:08:56.7709749Z -    
2025-11-10T00:08:56.7709816Z +
2025-11-10T00:08:56.7709901Z      // Request should be gone
2025-11-10T00:08:56.7710147Z      assert!(!manager.complete_request(request_id, vec![1, 2, 3]));
2025-11-10T00:08:56.7710267Z  }
2025-11-10T00:08:56.7710779Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:92:
2025-11-10T00:08:56.7710935Z  async fn test_multiple_concurrent_requests_per_peer() {
2025-11-10T00:08:56.7711106Z      let manager = NetworkManager::new(TransportPreference::TcpOnly);
2025-11-10T00:08:56.7711253Z      let peer_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-10T00:08:56.7711313Z -    
2025-11-10T00:08:56.7711374Z +
2025-11-10T00:08:56.7711484Z      // Register multiple requests from same peer
2025-11-10T00:08:56.7711608Z      let (id1, rx1) = manager.register_request(peer_addr);
2025-11-10T00:08:56.7711725Z      let (id2, rx2) = manager.register_request(peer_addr);
2025-11-10T00:08:56.7712003Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:99:
2025-11-10T00:08:56.7712121Z      let (id3, rx3) = manager.register_request(peer_addr);
2025-11-10T00:08:56.7712187Z -    
2025-11-10T00:08:56.7712250Z +
2025-11-10T00:08:56.7712337Z      // All should be registered
2025-11-10T00:08:56.7712495Z      let pending = manager.get_pending_requests_for_peer(peer_addr);
2025-11-10T00:08:56.7712585Z      assert_eq!(pending.len(), 3);
2025-11-10T00:08:56.7712870Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:104:
2025-11-10T00:08:56.7712961Z      assert!(pending.contains(&id1));
2025-11-10T00:08:56.7713049Z      assert!(pending.contains(&id2));
2025-11-10T00:08:56.7714776Z      assert!(pending.contains(&id3));
2025-11-10T00:08:56.7714846Z -    
2025-11-10T00:08:56.7714907Z +
2025-11-10T00:08:56.7714979Z      // Complete all
2025-11-10T00:08:56.7715087Z      manager.complete_request(id1, vec![1]);
2025-11-10T00:08:56.7715181Z      manager.complete_request(id2, vec![2]);
2025-11-10T00:08:56.7715461Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:111:
2025-11-10T00:08:56.7715562Z      manager.complete_request(id3, vec![3]);
2025-11-10T00:08:56.7715801Z -    
2025-11-10T00:08:56.7715862Z +
2025-11-10T00:08:56.7715947Z      // All should receive responses
2025-11-10T00:08:56.7716048Z      assert_eq!(rx1.await.unwrap(), vec![1]);
2025-11-10T00:08:56.7716141Z      assert_eq!(rx2.await.unwrap(), vec![2]);
2025-11-10T00:08:56.7716415Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:120:
2025-11-10T00:08:56.7716502Z  async fn test_request_metrics() {
2025-11-10T00:08:56.7716677Z      let manager = NetworkManager::new(TransportPreference::TcpOnly);
2025-11-10T00:08:56.7716817Z      let peer_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-10T00:08:56.7716879Z -    
2025-11-10T00:08:56.7716943Z +
2025-11-10T00:08:56.7717029Z      // Register and complete a request
2025-11-10T00:08:56.7717153Z      let (id1, _rx1) = manager.register_request(peer_addr);
2025-11-10T00:08:56.7717268Z      manager.complete_request(id1, vec![1, 2, 3]);
2025-11-10T00:08:56.7717662Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:127:
2025-11-10T00:08:56.7717723Z -    
2025-11-10T00:08:56.7717782Z +
2025-11-10T00:08:56.7717856Z      // Check metrics
2025-11-10T00:08:56.7717979Z      let metrics = manager.get_request_metrics(peer_addr);
2025-11-10T00:08:56.7718061Z      assert!(metrics.is_some());
2025-11-10T00:08:56.7718337Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:132:
2025-11-10T00:08:56.7718422Z      assert_eq!(m.total_requests, 1);
2025-11-10T00:08:56.7718516Z      assert_eq!(m.successful_responses, 1);
2025-11-10T00:08:56.7718605Z      assert_eq!(m.failed_requests, 0);
2025-11-10T00:08:56.7718672Z -    
2025-11-10T00:08:56.7718731Z +
2025-11-10T00:08:56.7718804Z      // Record a failure
2025-11-10T00:08:56.7718927Z      let (id2, _rx2) = manager.register_request(peer_addr);
2025-11-10T00:08:56.7719018Z      manager.record_failed_request(id2);
2025-11-10T00:08:56.7719300Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:139:
2025-11-10T00:08:56.7719365Z -    
2025-11-10T00:08:56.7719425Z +
2025-11-10T00:08:56.7719544Z      let metrics = manager.get_request_metrics(peer_addr);
2025-11-10T00:08:56.7719629Z      let m = metrics.unwrap();
2025-11-10T00:08:56.7719718Z      assert_eq!(m.total_requests, 2);
2025-11-10T00:08:56.7719992Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:148:
2025-11-10T00:08:56.7720082Z  async fn test_request_priority() {
2025-11-10T00:08:56.7720251Z      let manager = NetworkManager::new(TransportPreference::TcpOnly);
2025-11-10T00:08:56.7720394Z      let peer_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-10T00:08:56.7720459Z -    
2025-11-10T00:08:56.7720519Z +
2025-11-10T00:08:56.7720634Z      // Register requests with different priorities
2025-11-10T00:08:56.7720804Z      let (_id1, _rx1) = manager.register_request_with_priority(peer_addr, 0);
2025-11-10T00:08:56.7720966Z      let (_id2, _rx2) = manager.register_request_with_priority(peer_addr, 5);
2025-11-10T00:08:56.7721256Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:155:
2025-11-10T00:08:56.7721421Z      let (_id3, _rx3) = manager.register_request_with_priority(peer_addr, 10);
2025-11-10T00:08:56.7721482Z -    
2025-11-10T00:08:56.7721550Z +
2025-11-10T00:08:56.7721627Z      // All should be registered
2025-11-10T00:08:56.7721789Z      let pending = manager.get_pending_requests_for_peer(peer_addr);
2025-11-10T00:08:56.7721876Z      assert_eq!(pending.len(), 3);
2025-11-10T00:08:56.7722155Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:160:
2025-11-10T00:08:56.7722216Z  }
2025-11-10T00:08:56.7722276Z -
2025-11-10T00:08:56.7722337Z -
2025-11-10T00:08:56.7722397Z -
2025-11-10T00:08:56.7722456Z  
2025-11-10T00:08:56.7722755Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:8:
2025-11-10T00:08:56.7722955Z  async fn test_ban_list_operations() {
2025-11-10T00:08:56.7723072Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-10T00:08:56.7723173Z      let manager = NetworkManager::new(addr);
2025-11-10T00:08:56.7723237Z -    
2025-11-10T00:08:56.7723295Z +
2025-11-10T00:08:56.7723432Z      let test_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-10T00:08:56.7723492Z -    
2025-11-10T00:08:56.7723554Z +
2025-11-10T00:08:56.7723618Z      // Test ban
2025-11-10T00:08:56.7723699Z      let now = SystemTime::now()
2025-11-10T00:08:56.7723784Z          .duration_since(UNIX_EPOCH)
2025-11-10T00:08:56.7724286Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:18:
2025-11-10T00:08:56.7724525Z          .as_secs();
2025-11-10T00:08:56.7725182Z      let future_timestamp = now + 3600; // 1 hour from now
2025-11-10T00:08:56.7725608Z      manager.ban_peer(test_addr, future_timestamp);
2025-11-10T00:08:56.7725724Z -    
2025-11-10T00:08:56.7725823Z +
2025-11-10T00:08:56.7725930Z      assert!(manager.is_banned(test_addr));
2025-11-10T00:08:56.7725993Z -    
2025-11-10T00:08:56.7726051Z +
2025-11-10T00:08:56.7726120Z      // Test unban
2025-11-10T00:08:56.7726214Z      manager.unban_peer(test_addr);
2025-11-10T00:08:56.7726308Z      assert!(!manager.is_banned(test_addr));
2025-11-10T00:08:56.7726623Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:30:
2025-11-10T00:08:56.7726719Z  async fn test_ban_list_expiration() {
2025-11-10T00:08:56.7726840Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-10T00:08:56.7726946Z      let manager = NetworkManager::new(addr);
2025-11-10T00:08:56.7727011Z -    
2025-11-10T00:08:56.7727069Z +
2025-11-10T00:08:56.7727212Z      let test_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-10T00:08:56.7727277Z -    
2025-11-10T00:08:56.7727341Z +
2025-11-10T00:08:56.7727435Z      // Ban with expiration in the past
2025-11-10T00:08:56.7727520Z      let now = SystemTime::now()
2025-11-10T00:08:56.7727607Z          .duration_since(UNIX_EPOCH)
2025-11-10T00:08:56.7727920Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:40:
2025-11-10T00:08:56.7727988Z          .as_secs();
2025-11-10T00:08:56.7728096Z      let past_timestamp = now - 3600; // 1 hour ago
2025-11-10T00:08:56.7728209Z      manager.ban_peer(test_addr, past_timestamp);
2025-11-10T00:08:56.7728273Z -    
2025-11-10T00:08:56.7728331Z +
2025-11-10T00:08:56.7728453Z      // is_banned should automatically check expiration
2025-11-10T00:08:56.7728547Z      assert!(!manager.is_banned(test_addr));
2025-11-10T00:08:56.7728608Z  }
2025-11-10T00:08:56.7728909Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:49:
2025-11-10T00:08:56.7729005Z  async fn test_ban_list_permanent() {
2025-11-10T00:08:56.7729127Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-10T00:08:56.7729231Z      let manager = NetworkManager::new(addr);
2025-11-10T00:08:56.7729300Z -    
2025-11-10T00:08:56.7729360Z +
2025-11-10T00:08:56.7729499Z      let test_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-10T00:08:56.7729564Z -    
2025-11-10T00:08:56.7729623Z +
2025-11-10T00:08:56.7729712Z      // Permanent ban (timestamp = 0)
2025-11-10T00:08:56.7729798Z      manager.ban_peer(test_addr, 0);
2025-11-10T00:08:56.7729897Z      assert!(manager.is_banned(test_addr));
2025-11-10T00:08:56.7730195Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:58:
2025-11-10T00:08:56.7730256Z -    
2025-11-10T00:08:56.7730321Z +
2025-11-10T00:08:56.7730392Z      // Clear all bans
2025-11-10T00:08:56.7730470Z      manager.clear_bans();
2025-11-10T00:08:56.7730561Z      assert!(!manager.is_banned(test_addr));
2025-11-10T00:08:56.7730864Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:66:
2025-11-10T00:08:56.7731122Z  async fn test_ban_list_multiple_peers() {
2025-11-10T00:08:56.7731236Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-10T00:08:56.7731346Z      let manager = NetworkManager::new(addr);
2025-11-10T00:08:56.7731406Z -    
2025-11-10T00:08:56.7731465Z +
2025-11-10T00:08:56.7731598Z      let addr1: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-10T00:08:56.7731730Z      let addr2: SocketAddr = "127.0.0.1:8334".parse().unwrap();
2025-11-10T00:08:56.7731849Z      let addr3: SocketAddr = "127.0.0.1:8335".parse().unwrap();
2025-11-10T00:08:56.7732148Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:73:
2025-11-10T00:08:56.7732214Z -    
2025-11-10T00:08:56.7732273Z +
2025-11-10T00:08:56.7732356Z      let now = SystemTime::now()
2025-11-10T00:08:56.7732443Z          .duration_since(UNIX_EPOCH)
2025-11-10T00:08:56.7732634Z          .unwrap()
2025-11-10T00:08:56.7732934Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:77:
2025-11-10T00:08:56.7733002Z          .as_secs();
2025-11-10T00:08:56.7733069Z -    
2025-11-10T00:08:56.7733129Z +
2025-11-10T00:08:56.7733220Z      manager.ban_peer(addr1, now + 3600);
2025-11-10T00:08:56.7733315Z      manager.ban_peer(addr2, 0); // Permanent
2025-11-10T00:08:56.7733399Z      manager.ban_peer(addr3, now + 7200);
2025-11-10T00:08:56.7733694Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:82:
2025-11-10T00:08:56.7733754Z -    
2025-11-10T00:08:56.7733821Z +
2025-11-10T00:08:56.7733938Z      assert_eq!(manager.get_banned_peers().len(), 3);
2025-11-10T00:08:56.7734026Z      assert!(manager.is_banned(addr1));
2025-11-10T00:08:56.7734117Z      assert!(manager.is_banned(addr2));
2025-11-10T00:08:56.7734607Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:86:
2025-11-10T00:08:56.7734705Z      assert!(manager.is_banned(addr3));
2025-11-10T00:08:56.7734770Z -    
2025-11-10T00:08:56.7734828Z +
2025-11-10T00:08:56.7734894Z      // Unban one
2025-11-10T00:08:56.7734978Z      manager.unban_peer(addr2);
2025-11-10T00:08:56.7735094Z      assert_eq!(manager.get_banned_peers().len(), 2);
2025-11-10T00:08:56.7735389Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:91:
2025-11-10T00:08:56.7735477Z      assert!(!manager.is_banned(addr2));
2025-11-10T00:08:56.7735541Z  }
2025-11-10T00:08:56.7735600Z -
2025-11-10T00:08:56.7735658Z  
2025-11-10T00:08:56.7735973Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_tests.rs:22:
2025-11-10T00:08:56.7736060Z          .duration_since(UNIX_EPOCH)
2025-11-10T00:08:56.7736125Z          .unwrap()
2025-11-10T00:08:56.7736191Z          .as_secs();
2025-11-10T00:08:56.7736256Z -    
2025-11-10T00:08:56.7736320Z +
2025-11-10T00:08:56.7736431Z      // Create two ban lists with overlapping entries
2025-11-10T00:08:56.7736518Z      let list1 = BanListMessage {
2025-11-10T00:08:56.7736596Z          is_full: true,
2025-11-10T00:08:56.7736851Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_tests.rs:29:
2025-11-10T00:08:56.7736928Z          ban_list_hash: [0; 32],
2025-11-10T00:08:56.7737011Z          ban_entries: vec![
2025-11-10T00:08:56.7737193Z -            create_test_ban_entry([127, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 8333, now + 3600),
2025-11-10T00:08:56.7737372Z -            create_test_ban_entry([192, 168, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 8333, now + 7200),
2025-11-10T00:08:56.7737456Z +            create_test_ban_entry(
2025-11-10T00:08:56.7737555Z +                [127, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
2025-11-10T00:08:56.7737622Z +                8333,
2025-11-10T00:08:56.7737693Z +                now + 3600,
2025-11-10T00:08:56.7737764Z +            ),
2025-11-10T00:08:56.7737981Z +            create_test_ban_entry(
2025-11-10T00:08:56.7738086Z +                [192, 168, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
2025-11-10T00:08:56.7738157Z +                8333,
2025-11-10T00:08:56.7738227Z +                now + 7200,
2025-11-10T00:08:56.7738289Z +            ),
2025-11-10T00:08:56.7738350Z          ],
2025-11-10T00:08:56.7738434Z          timestamp: now,
2025-11-10T00:08:56.7738498Z      };
2025-11-10T00:08:56.7738754Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_tests.rs:36:
2025-11-10T00:08:56.7738819Z -    
2025-11-10T00:08:56.7738879Z +
2025-11-10T00:08:56.7738965Z      let list2 = BanListMessage {
2025-11-10T00:08:56.7739036Z          is_full: true,
2025-11-10T00:08:56.7739116Z          ban_list_hash: [0; 32],
2025-11-10T00:08:56.7739372Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_tests.rs:40:
2025-11-10T00:08:56.7739458Z          ban_entries: vec![
2025-11-10T00:08:56.7739669Z              // Same address, longer ban
2025-11-10T00:08:56.7739849Z -            create_test_ban_entry([127, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 8333, now + 7200),
2025-11-10T00:08:56.7739934Z +            create_test_ban_entry(
2025-11-10T00:08:56.7740031Z +                [127, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
2025-11-10T00:08:56.7740096Z +                8333,
2025-11-10T00:08:56.7740165Z +                now + 7200,
2025-11-10T00:08:56.7740233Z +            ),
2025-11-10T00:08:56.7740301Z              // New address
2025-11-10T00:08:56.7740467Z -            create_test_ban_entry([10, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 8333, now + 1800),
2025-11-10T00:08:56.7740553Z +            create_test_ban_entry(
2025-11-10T00:08:56.7740644Z +                [10, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
2025-11-10T00:08:56.7740709Z +                8333,
2025-11-10T00:08:56.7740778Z +                now + 1800,
2025-11-10T00:08:56.7740850Z +            ),
2025-11-10T00:08:56.7740914Z          ],
2025-11-10T00:08:56.7740988Z          timestamp: now,
2025-11-10T00:08:56.7741056Z      };
2025-11-10T00:08:56.7741312Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_tests.rs:48:
2025-11-10T00:08:56.7741375Z -    
2025-11-10T00:08:56.7741434Z +
2025-11-10T00:08:56.7741562Z      let merged = merge_ban_lists(vec![&list1, &list2]);
2025-11-10T00:08:56.7741624Z -    
2025-11-10T00:08:56.7741684Z +
2025-11-10T00:08:56.7741776Z      // Should have 3 unique addresses
2025-11-10T00:08:56.7741860Z      assert_eq!(merged.len(), 3);
2025-11-10T00:08:56.7741920Z -    
2025-11-10T00:08:56.7741981Z +
2025-11-10T00:08:56.7742081Z      // 127.0.0.1 should have longer ban (7200)
2025-11-10T00:08:56.7742168Z -    let entry_127 = merged.iter()
2025-11-10T00:08:56.7742253Z -        .find(|e| e.addr.ip[0] == 127)
2025-11-10T00:08:56.7742327Z -        .unwrap();
2025-11-10T00:08:56.7742494Z +    let entry_127 = merged.iter().find(|e| e.addr.ip[0] == 127).unwrap();
2025-11-10T00:08:56.7742619Z      assert_eq!(entry_127.unban_timestamp, now + 7200);
2025-11-10T00:08:56.7742680Z  }
2025-11-10T00:08:56.7742746Z  
2025-11-10T00:08:56.7743005Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_tests.rs:64:
2025-11-10T00:08:56.7743092Z          .duration_since(UNIX_EPOCH)
2025-11-10T00:08:56.7743162Z          .unwrap()
2025-11-10T00:08:56.7743229Z          .as_secs();
2025-11-10T00:08:56.7743290Z -    
2025-11-10T00:08:56.7743348Z +
2025-11-10T00:08:56.7743424Z      // Valid future ban
2025-11-10T00:08:56.7743641Z -    let future_ban = create_test_ban_entry([127, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 8333, now + 3600);
2025-11-10T00:08:56.7743740Z +    let future_ban = create_test_ban_entry(
2025-11-10T00:08:56.7743842Z +        [127, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
2025-11-10T00:08:56.7743904Z +        8333,
2025-11-10T00:08:56.7743970Z +        now + 3600,
2025-11-10T00:08:56.7744037Z +    );
2025-11-10T00:08:56.7744135Z      assert!(validate_ban_entry(&future_ban));
2025-11-10T00:08:56.7744294Z -    
2025-11-10T00:08:56.7744511Z +
2025-11-10T00:08:56.7744600Z      // Valid permanent ban
2025-11-10T00:08:56.7745001Z -    let permanent_ban = create_test_ban_entry([192, 168, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 8333, u64::MAX);
2025-11-10T00:08:56.7745178Z +    let permanent_ban = create_test_ban_entry(
2025-11-10T00:08:56.7745532Z +        [192, 168, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
2025-11-10T00:08:56.7745607Z +        8333,
2025-11-10T00:08:56.7745678Z +        u64::MAX,
2025-11-10T00:08:56.7745742Z +    );
2025-11-10T00:08:56.7745865Z      assert!(validate_ban_entry(&permanent_ban));
2025-11-10T00:08:56.7745926Z -    
2025-11-10T00:08:56.7745989Z +
2025-11-10T00:08:56.7746082Z      // Expired ban (should be invalid)
2025-11-10T00:08:56.7746341Z -    let expired_ban = create_test_ban_entry([10, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 8333, now.saturating_sub(3600));
2025-11-10T00:08:56.7746606Z +    let expired_ban = create_test_ban_entry(
2025-11-10T00:08:56.7746697Z +        [10, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
2025-11-10T00:08:56.7746765Z +        8333,
2025-11-10T00:08:56.7746848Z +        now.saturating_sub(3600),
2025-11-10T00:08:56.7746909Z +    );
2025-11-10T00:08:56.7747017Z      assert!(!validate_ban_entry(&expired_ban));
2025-11-10T00:08:56.7747078Z  }
2025-11-10T00:08:56.7747137Z  
2025-11-10T00:08:56.7747405Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_tests.rs:84:
2025-11-10T00:08:56.7747492Z          .duration_since(UNIX_EPOCH)
2025-11-10T00:08:56.7747558Z          .unwrap()
2025-11-10T00:08:56.7747622Z          .as_secs();
2025-11-10T00:08:56.7747688Z -    
2025-11-10T00:08:56.7747749Z +
2025-11-10T00:08:56.7747820Z      let entries = vec![
2025-11-10T00:08:56.7748001Z -        create_test_ban_entry([127, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 8333, now + 3600),
2025-11-10T00:08:56.7748186Z -        create_test_ban_entry([192, 168, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 8333, now + 7200),
2025-11-10T00:08:56.7748272Z +        create_test_ban_entry(
2025-11-10T00:08:56.7748368Z +            [127, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
2025-11-10T00:08:56.7748434Z +            8333,
2025-11-10T00:08:56.7748501Z +            now + 3600,
2025-11-10T00:08:56.7748562Z +        ),
2025-11-10T00:08:56.7748642Z +        create_test_ban_entry(
2025-11-10T00:08:56.7748743Z +            [192, 168, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
2025-11-10T00:08:56.7748807Z +            8333,
2025-11-10T00:08:56.7748873Z +            now + 7200,
2025-11-10T00:08:56.7748943Z +        ),
2025-11-10T00:08:56.7749003Z      ];
2025-11-10T00:08:56.7749062Z -    
2025-11-10T00:08:56.7749121Z +
2025-11-10T00:08:56.7749235Z      let hash1 = calculate_ban_list_hash(&entries);
2025-11-10T00:08:56.7749335Z      let hash2 = calculate_ban_list_hash(&entries);
2025-11-10T00:08:56.7749396Z -    
2025-11-10T00:08:56.7749464Z +
2025-11-10T00:08:56.7749557Z      // Same entries should produce same hash
2025-11-10T00:08:56.7749641Z      assert_eq!(hash1, hash2);
2025-11-10T00:08:56.7749701Z -    
2025-11-10T00:08:56.7749764Z +
2025-11-10T00:08:56.7749830Z      // Verify hash
2025-11-10T00:08:56.7749941Z      assert!(verify_ban_list_hash(&entries, &hash1));
2025-11-10T00:08:56.7750007Z  }
2025-11-10T00:08:56.7750281Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_tests.rs:102:
2025-11-10T00:08:56.7750341Z -
2025-11-10T00:08:56.7750400Z -
2025-11-10T00:08:56.7750465Z -
2025-11-10T00:08:56.7750525Z  
2025-11-10T00:08:56.7750836Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip158_implementation_tests.rs:1:
2025-11-10T00:08:56.7750928Z  //! Tests for BIP158 implementation
2025-11-10T00:08:56.7750989Z  
2025-11-10T00:08:56.7753096Z  use bllvm_node::bip158::{build_block_filter, match_filter, CompactBlockFilter};
2025-11-10T00:08:56.7753327Z -use bllvm_protocol::{Transaction, TransactionInput, TransactionOutput, OutPoint};
2025-11-10T00:08:56.7753672Z +use bllvm_protocol::{OutPoint, Transaction, TransactionInput, TransactionOutput};
2025-11-10T00:08:56.7753734Z  
2025-11-10T00:08:56.7753798Z  #[test]
2025-11-10T00:08:56.7753918Z  fn test_build_block_filter_with_transactions() {
2025-11-10T00:08:56.7754230Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip158_implementation_tests.rs:15:
2025-11-10T00:08:56.7754294Z          }],
2025-11-10T00:08:56.7754533Z          lock_time: 0,
2025-11-10T00:08:56.7754595Z      };
2025-11-10T00:08:56.7754657Z -    
2025-11-10T00:08:56.7754716Z +
2025-11-10T00:08:56.7754800Z      let tx2 = Transaction {
2025-11-10T00:08:56.7754869Z          version: 1,
2025-11-10T00:08:56.7754945Z          inputs: vec![],
2025-11-10T00:08:56.7755250Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip158_implementation_tests.rs:25:
2025-11-10T00:08:56.7755316Z          }],
2025-11-10T00:08:56.7755512Z          lock_time: 0,
2025-11-10T00:08:56.7755579Z      };
2025-11-10T00:08:56.7755647Z -    
2025-11-10T00:08:56.7755707Z +
2025-11-10T00:08:56.7755846Z      let filter = build_block_filter(&[tx1, tx2], &[]).unwrap();
2025-11-10T00:08:56.7755945Z      assert_eq!(filter.num_elements, 2);
2025-11-10T00:08:56.7756042Z      assert!(!filter.filter_data.is_empty());
2025-11-10T00:08:56.7756351Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip158_implementation_tests.rs:42:
2025-11-10T00:08:56.7756412Z          }],
2025-11-10T00:08:56.7756487Z          lock_time: 0,
2025-11-10T00:08:56.7756549Z      };
2025-11-10T00:08:56.7756608Z -    
2025-11-10T00:08:56.7756675Z +
2025-11-10T00:08:56.7756816Z      let filter = build_block_filter(&[tx.clone()], &[]).unwrap();
2025-11-10T00:08:56.7756876Z -    
2025-11-10T00:08:56.7756935Z +
2025-11-10T00:08:56.7757040Z      // Script that's in the filter should match
2025-11-10T00:08:56.7757186Z      assert!(match_filter(&filter, &tx.outputs[0].script_pubkey));
2025-11-10T00:08:56.7757261Z  }
2025-11-10T00:08:56.7757570Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip158_implementation_tests.rs:67:
2025-11-10T00:08:56.7757639Z          }],
2025-11-10T00:08:56.7757708Z          lock_time: 0,
2025-11-10T00:08:56.7757769Z      };
2025-11-10T00:08:56.7757831Z -    
2025-11-10T00:08:56.7757898Z +
2025-11-10T00:08:56.7758000Z      // Previous output script (UTXO being spent)
2025-11-10T00:08:56.7758109Z      let prev_script = vec![0x54, 0x55]; // OP_4 OP_5
2025-11-10T00:08:56.7758177Z -    
2025-11-10T00:08:56.7758237Z +
2025-11-10T00:08:56.7758413Z      let filter = build_block_filter(&[tx], &[prev_script.clone()]).unwrap();
2025-11-10T00:08:56.7758476Z -    
2025-11-10T00:08:56.7758542Z +
2025-11-10T00:08:56.7758671Z      // Both output script and previous script should match
2025-11-10T00:08:56.7758763Z      assert!(filter.num_elements >= 1);
2025-11-10T00:08:56.7758835Z  }
2025-11-10T00:08:56.7759141Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip158_implementation_tests.rs:79:
2025-11-10T00:08:56.7759212Z -
2025-11-10T00:08:56.7766925Z  
2025-11-10T00:08:56.7767268Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:1:
2025-11-10T00:08:56.7767414Z  //! Tests for BIP70 payment verification and signing
2025-11-10T00:08:56.7767481Z  
2025-11-10T00:08:56.7767745Z -use bllvm_node::bip70::{PaymentRequest, Payment, PaymentOutput, PaymentProtocolServer};
2025-11-10T00:08:56.7767880Z -use bllvm_node::network::protocol::PaymentMessage;
2025-11-10T00:08:56.7768115Z -use bllvm_protocol::{Transaction, TransactionInput, TransactionOutput, OutPoint};
2025-11-10T00:08:56.7768306Z  use bllvm_consensus::serialization::transaction::serialize_transaction;
2025-11-10T00:08:56.7768539Z +use bllvm_node::bip70::{Payment, PaymentOutput, PaymentProtocolServer, PaymentRequest};
2025-11-10T00:08:56.7768666Z +use bllvm_node::network::protocol::PaymentMessage;
2025-11-10T00:08:56.7768889Z +use bllvm_protocol::{OutPoint, Transaction, TransactionInput, TransactionOutput};
2025-11-10T00:08:56.7769170Z  use secp256k1::{Secp256k1, SecretKey};
2025-11-10T00:08:56.7769240Z  
2025-11-10T00:08:56.7769306Z  #[test]
2025-11-10T00:08:56.7769572Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:13:
2025-11-10T00:08:56.7769663Z          script: vec![0x51], // OP_1
2025-11-10T00:08:56.7769742Z          amount: Some(1000),
2025-11-10T00:08:56.7769806Z      };
2025-11-10T00:08:56.7769867Z -    
2025-11-10T00:08:56.7769986Z -    let payment_request = PaymentRequest::new(
2025-11-10T00:08:56.7770064Z -        "main".to_string(),
2025-11-10T00:08:56.7770144Z -        vec![output.clone()],
2025-11-10T00:08:56.7770214Z -        1234567890,
2025-11-10T00:08:56.7770277Z -    );
2025-11-10T00:08:56.7770337Z -    
2025-11-10T00:08:56.7770395Z +
2025-11-10T00:08:56.7770657Z +    let payment_request = PaymentRequest::new("main".to_string(), vec![output.clone()], 1234567890);
2025-11-10T00:08:56.7770866Z +
2025-11-10T00:08:56.7770956Z      // Create a payment transaction
2025-11-10T00:08:56.7771032Z      let tx = Transaction {
2025-11-10T00:08:56.7771104Z          version: 1,
2025-11-10T00:08:56.7771355Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:37:
2025-11-10T00:08:56.7771418Z          }],
2025-11-10T00:08:56.7771498Z          lock_time: 0,
2025-11-10T00:08:56.7771560Z      };
2025-11-10T00:08:56.7771621Z -    
2025-11-10T00:08:56.7771683Z +
2025-11-10T00:08:56.7771789Z      let tx_bytes = serialize_transaction(&tx);
2025-11-10T00:08:56.7771849Z -    
2025-11-10T00:08:56.7771911Z +
2025-11-10T00:08:56.7772020Z      let payment = Payment::new(vec![tx_bytes]);
2025-11-10T00:08:56.7772079Z -    
2025-11-10T00:08:56.7772136Z +
2025-11-10T00:08:56.7772215Z      // Create payment message
2025-11-10T00:08:56.7772311Z      let payment_msg = PaymentMessage {
2025-11-10T00:08:56.7772377Z          payment,
2025-11-10T00:08:56.7772833Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:48:
2025-11-10T00:08:56.7772935Z          payment_id: vec![1, 2, 3, 4],
2025-11-10T00:08:56.7772996Z      };
2025-11-10T00:08:56.7773056Z -    
2025-11-10T00:08:56.7773116Z +
2025-11-10T00:08:56.7773243Z      // Process payment (without merchant key for now)
2025-11-10T00:08:56.7773384Z      let result = PaymentProtocolServer::process_payment(
2025-11-10T00:08:56.7773457Z          &payment_msg,
2025-11-10T00:08:56.7773709Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:54:
2025-11-10T00:08:56.7773787Z          &payment_request,
2025-11-10T00:08:56.7773870Z          None, // No merchant key
2025-11-10T00:08:56.7773937Z      );
2025-11-10T00:08:56.7773999Z -    
2025-11-10T00:08:56.7774060Z +
2025-11-10T00:08:56.7774157Z      // Should succeed (validation passes)
2025-11-10T00:08:56.7774244Z      assert!(result.is_ok());
2025-11-10T00:08:56.7774305Z  }
2025-11-10T00:08:56.7774690Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:63:
2025-11-10T00:08:56.7774789Z  fn test_payment_ack_signing() {
2025-11-10T00:08:56.7774871Z      let secp = Secp256k1::new();
2025-11-10T00:08:56.7775016Z      let merchant_key = SecretKey::from_slice(&[1; 32]).unwrap();
2025-11-10T00:08:56.7775077Z -    
2025-11-10T00:08:56.7775141Z +
2025-11-10T00:08:56.7775249Z      // Create payment request with merchant pubkey
2025-11-10T00:08:56.7775335Z      let output = PaymentOutput {
2025-11-10T00:08:56.7775416Z          script: vec![0x51],
2025-11-10T00:08:56.7775656Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:70:
2025-11-10T00:08:56.7775731Z          amount: Some(1000),
2025-11-10T00:08:56.7775792Z      };
2025-11-10T00:08:56.7775858Z -    
2025-11-10T00:08:56.7775971Z -    let mut payment_request = PaymentRequest::new(
2025-11-10T00:08:56.7776045Z -        "main".to_string(),
2025-11-10T00:08:56.7776118Z -        vec![output],
2025-11-10T00:08:56.7776187Z -        1234567890,
2025-11-10T00:08:56.7776389Z -    );
2025-11-10T00:08:56.7776449Z -    
2025-11-10T00:08:56.7776514Z +
2025-11-10T00:08:56.7776766Z +    let mut payment_request = PaymentRequest::new("main".to_string(), vec![output], 1234567890);
2025-11-10T00:08:56.7776827Z +
2025-11-10T00:08:56.7776913Z      // Set merchant pubkey
2025-11-10T00:08:56.7777131Z      let merchant_pubkey = secp256k1::PublicKey::from_secret_key(&secp, &merchant_key);
2025-11-10T00:08:56.7777337Z      payment_request.merchant_pubkey = Some(merchant_pubkey.serialize().to_vec());
2025-11-10T00:08:56.7777598Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:82:
2025-11-10T00:08:56.7777659Z -    
2025-11-10T00:08:56.7777718Z +
2025-11-10T00:08:56.7777788Z      // Create payment
2025-11-10T00:08:56.7777869Z      let tx = Transaction {
2025-11-10T00:08:56.7777936Z          version: 1,
2025-11-10T00:08:56.7778175Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:97:
2025-11-10T00:08:56.7778363Z          }],
2025-11-10T00:08:56.7778433Z          lock_time: 0,
2025-11-10T00:08:56.7778496Z      };
2025-11-10T00:08:56.7778555Z -    
2025-11-10T00:08:56.7778622Z +
2025-11-10T00:08:56.7778721Z      let tx_bytes = serialize_transaction(&tx);
2025-11-10T00:08:56.7778824Z      let payment = Payment::new(vec![tx_bytes]);
2025-11-10T00:08:56.7778890Z -    
2025-11-10T00:08:56.7778949Z +
2025-11-10T00:08:56.7779042Z      let payment_msg = PaymentMessage {
2025-11-10T00:08:56.7779111Z          payment,
2025-11-10T00:08:56.7779201Z          payment_id: vec![1, 2, 3, 4],
2025-11-10T00:08:56.7779907Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:107:
2025-11-10T00:08:56.7779972Z      };
2025-11-10T00:08:56.7780039Z -    
2025-11-10T00:08:56.7780101Z +
2025-11-10T00:08:56.7780195Z      // Process payment with merchant key
2025-11-10T00:08:56.7780331Z -    let result = PaymentProtocolServer::process_payment(
2025-11-10T00:08:56.7780416Z -        &payment_msg,
2025-11-10T00:08:56.7780494Z -        &payment_request,
2025-11-10T00:08:56.7780571Z -        Some(&merchant_key),
2025-11-10T00:08:56.7780640Z -    );
2025-11-10T00:08:56.7780700Z -    
2025-11-10T00:08:56.7780766Z +    let result =
2025-11-10T00:08:56.7781034Z +        PaymentProtocolServer::process_payment(&payment_msg, &payment_request, Some(&merchant_key));
2025-11-10T00:08:56.7781102Z +
2025-11-10T00:08:56.7781180Z      assert!(result.is_ok());
2025-11-10T00:08:56.7781265Z      let ack_msg = result.unwrap();
2025-11-10T00:08:56.7781328Z -    
2025-11-10T00:08:56.7781384Z +
2025-11-10T00:08:56.7781498Z      // Verify signature is present when key provided
2025-11-10T00:08:56.7781612Z      assert!(!ack_msg.merchant_signature.is_empty());
2025-11-10T00:08:56.7781678Z  }
2025-11-10T00:08:56.7781926Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:122:
2025-11-10T00:08:56.7781987Z -
2025-11-10T00:08:56.7782052Z  
2025-11-10T00:08:56.7782301Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:1:
2025-11-10T00:08:56.7782405Z -use bllvm_protocol::ProtocolVersion;
2025-11-10T00:08:56.7782517Z  use bllvm_node::storage::blockstore::BlockStore;
2025-11-10T00:08:56.7782628Z  use bllvm_node::storage::chainstate::ChainState;
2025-11-10T00:08:56.7782726Z  use bllvm_node::storage::txindex::TxIndex;
2025-11-10T00:08:56.7782948Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:9:
2025-11-10T00:08:56.7783035Z  use bllvm_node::OutPoint;
2025-11-10T00:08:56.7783115Z  use bllvm_node::Transaction;
2025-11-10T00:08:56.7783284Z  use bllvm_node::{ByteString, TransactionInput, TransactionOutput};
2025-11-10T00:08:56.7783382Z +use bllvm_protocol::ProtocolVersion;
2025-11-10T00:08:56.7783466Z  use std::collections::HashMap;
2025-11-10T00:08:56.7783544Z  use tempfile::TempDir;
2025-11-10T00:08:56.7783609Z  
2025-11-10T00:08:56.7801492Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:1:
2025-11-10T00:08:56.7801880Z  //! Tests for fee calculation functionality
2025-11-10T00:08:56.7801968Z  
2025-11-10T00:08:56.7802129Z  use bllvm_node::node::mempool::MempoolManager;
2025-11-10T00:08:56.7802326Z -use bllvm_protocol::{Transaction, UtxoSet, OutPoint, UTXO};
2025-11-10T00:08:56.7802521Z +use bllvm_protocol::{OutPoint, Transaction, UtxoSet, UTXO};
2025-11-10T00:08:56.7802600Z  
2025-11-10T00:08:56.7802680Z  #[test]
2025-11-10T00:08:56.7802800Z  fn test_calculate_transaction_fee() {
2025-11-10T00:08:56.7803207Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:8:
2025-11-10T00:08:56.7803417Z      let mempool = MempoolManager::new();
2025-11-10T00:08:56.7803547Z -    
2025-11-10T00:08:56.7803655Z +
2025-11-10T00:08:56.7803767Z      // Create a simple transaction
2025-11-10T00:08:56.7803880Z      let mut utxo_set = UtxoSet::new();
2025-11-10T00:08:56.7806115Z -    
2025-11-10T00:08:56.7806390Z +
2025-11-10T00:08:56.7806477Z      // Add a UTXO
2025-11-10T00:08:56.7806598Z      let outpoint = OutPoint {
2025-11-10T00:08:56.7806699Z          hash: [0u8; 32],
2025-11-10T00:08:56.7807088Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:16:
2025-11-10T00:08:56.7807171Z          index: 0,
2025-11-10T00:08:56.7807247Z      };
2025-11-10T00:08:56.7807345Z      let utxo = UTXO {
2025-11-10T00:08:56.7807444Z -        value: 100_000_000, // 1 BTC
2025-11-10T00:08:56.7807576Z +        value: 100_000_000,                    // 1 BTC
2025-11-10T00:08:56.7807755Z          script_pubkey: vec![0x76, 0xa9, 0x14], // P2PKH script
2025-11-10T00:08:56.7807833Z      };
2025-11-10T00:08:56.7807945Z      utxo_set.insert(outpoint, utxo);
2025-11-10T00:08:56.7808321Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:23:
2025-11-10T00:08:56.7808397Z -    
2025-11-10T00:08:56.7808470Z +
2025-11-10T00:08:56.7808612Z      // Create transaction with 1 input and 1 output
2025-11-10T00:08:56.7808730Z      let tx = Transaction {
2025-11-10T00:08:56.7808817Z          version: 1,
2025-11-10T00:08:56.7809171Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:36:
2025-11-10T00:08:56.7809257Z          }],
2025-11-10T00:08:56.7809342Z          lock_time: 0,
2025-11-10T00:08:56.7809417Z      };
2025-11-10T00:08:56.7809493Z -    
2025-11-10T00:08:56.7809575Z +
2025-11-10T00:08:56.7809759Z      let fee = mempool.calculate_transaction_fee(&tx, &utxo_set);
2025-11-10T00:08:56.7809835Z -    
2025-11-10T00:08:56.7809948Z +
2025-11-10T00:08:56.7810282Z      // Fee should be 1 BTC - 0.99 BTC = 0.01 BTC = 1,000,000 satoshis
2025-11-10T00:08:56.7810462Z      assert_eq!(fee, 1_000_000);
2025-11-10T00:08:56.7810581Z  }
2025-11-10T00:08:56.7810976Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:46:
2025-11-10T00:08:56.7811044Z  #[test]
2025-11-10T00:08:56.7811165Z  fn test_calculate_transaction_fee_zero_fee() {
2025-11-10T00:08:56.7811274Z      let mempool = MempoolManager::new();
2025-11-10T00:08:56.7811337Z -    
2025-11-10T00:08:56.7811399Z +
2025-11-10T00:08:56.7811489Z      let mut utxo_set = UtxoSet::new();
2025-11-10T00:08:56.7811584Z      let outpoint = OutPoint {
2025-11-10T00:08:56.7811659Z          hash: [0u8; 32],
2025-11-10T00:08:56.7811957Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:57:
2025-11-10T00:08:56.7812047Z          script_pubkey: vec![],
2025-11-10T00:08:56.7812112Z      };
2025-11-10T00:08:56.7812201Z      utxo_set.insert(outpoint, utxo);
2025-11-10T00:08:56.7812262Z -    
2025-11-10T00:08:56.7812332Z +
2025-11-10T00:08:56.7812458Z      // Transaction with same input and output (no fee)
2025-11-10T00:08:56.7812540Z      let tx = Transaction {
2025-11-10T00:08:56.7812617Z          version: 1,
2025-11-10T00:08:56.7812916Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:73:
2025-11-10T00:08:56.7813139Z          }],
2025-11-10T00:08:56.7813210Z          lock_time: 0,
2025-11-10T00:08:56.7813279Z      };
2025-11-10T00:08:56.7813339Z -    
2025-11-10T00:08:56.7813399Z +
2025-11-10T00:08:56.7813560Z      let fee = mempool.calculate_transaction_fee(&tx, &utxo_set);
2025-11-10T00:08:56.7813636Z      assert_eq!(fee, 0);
2025-11-10T00:08:56.7813701Z  }
2025-11-10T00:08:56.7813986Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:81:
2025-11-10T00:08:56.7814059Z  #[test]
2025-11-10T00:08:56.7816271Z  fn test_calculate_transaction_fee_missing_utxo() {
2025-11-10T00:08:56.7816374Z      let mempool = MempoolManager::new();
2025-11-10T00:08:56.7816444Z -    
2025-11-10T00:08:56.7816504Z +
2025-11-10T00:08:56.7816621Z      let utxo_set = UtxoSet::new(); // Empty UTXO set
2025-11-10T00:08:56.7816691Z -    
2025-11-10T00:08:56.7816751Z +
2025-11-10T00:08:56.7816836Z      let outpoint = OutPoint {
2025-11-10T00:08:56.7817037Z          hash: [0u8; 32],
2025-11-10T00:08:56.7817137Z          index: 0,
2025-11-10T00:08:56.7817615Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:90:
2025-11-10T00:08:56.7817682Z      };
2025-11-10T00:08:56.7817743Z -    
2025-11-10T00:08:56.7817810Z +
2025-11-10T00:08:56.7817888Z      let tx = Transaction {
2025-11-10T00:08:56.7817956Z          version: 1,
2025-11-10T00:08:56.7818063Z          inputs: vec![bllvm_protocol::TxIn {
2025-11-10T00:08:56.7818358Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:103:
2025-11-10T00:08:56.7818421Z          }],
2025-11-10T00:08:56.7818493Z          lock_time: 0,
2025-11-10T00:08:56.7818553Z      };
2025-11-10T00:08:56.7818613Z -    
2025-11-10T00:08:56.7818684Z +
2025-11-10T00:08:56.7818828Z      let fee = mempool.calculate_transaction_fee(&tx, &utxo_set);
2025-11-10T00:08:56.7819050Z      // If UTXO is missing, input_total will be 0, so fee will be 0 (or negative, but we return 0)
2025-11-10T00:08:56.7819161Z      assert_eq!(fee, 0);
2025-11-10T00:08:56.7819446Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:110:
2025-11-10T00:08:56.7819510Z  }
2025-11-10T00:08:56.7819570Z -
2025-11-10T00:08:56.7819631Z  
2025-11-10T00:08:56.7819920Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/iroh_peer_tracking_tests.rs:1:
2025-11-10T00:08:56.7820046Z  //! Tests for Iroh peer tracking with TransportAddr
2025-11-10T00:08:56.7820107Z  
2025-11-10T00:08:56.7820252Z -use bllvm_node::network::{NetworkManager, PeerManager};
2025-11-10T00:08:56.7820378Z  use bllvm_node::network::transport::TransportAddr;
2025-11-10T00:08:56.7820508Z +use bllvm_node::network::{NetworkManager, PeerManager};
2025-11-10T00:08:56.7820589Z  use std::net::SocketAddr;
2025-11-10T00:08:56.7820648Z  
2025-11-10T00:08:56.7820716Z  #[test]
2025-11-10T00:08:56.7821006Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/iroh_peer_tracking_tests.rs:8:
2025-11-10T00:08:56.7821110Z  fn test_peer_manager_transport_addr() {
2025-11-10T00:08:56.7821211Z      let mut manager = PeerManager::new(10);
2025-11-10T00:08:56.7821271Z -    
2025-11-10T00:08:56.7821330Z +
2025-11-10T00:08:56.7821464Z      let addr1: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-10T00:08:56.7821595Z      let addr2: SocketAddr = "127.0.0.1:8334".parse().unwrap();
2025-11-10T00:08:56.7821655Z -    
2025-11-10T00:08:56.7821714Z +
2025-11-10T00:08:56.7821792Z      // Test TCP peer
2025-11-10T00:08:56.7821896Z      let tcp_addr1 = TransportAddr::Tcp(addr1);
2025-11-10T00:08:56.7821992Z      let tcp_addr2 = TransportAddr::Tcp(addr2);
2025-11-10T00:08:56.7822291Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/iroh_peer_tracking_tests.rs:17:
2025-11-10T00:08:56.7822358Z -    
2025-11-10T00:08:56.7822421Z +
2025-11-10T00:08:56.7822588Z      // Create mock peers (would need actual Peer instances in real test)
2025-11-10T00:08:56.7822740Z      // For now, just test that TransportAddr works as HashMap key
2025-11-10T00:08:56.7823003Z      assert_ne!(tcp_addr1, tcp_addr2);
2025-11-10T00:08:56.7823297Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/iroh_peer_tracking_tests.rs:21:
2025-11-10T00:08:56.7823364Z -    
2025-11-10T00:08:56.7823422Z +
2025-11-10T00:08:56.7823524Z      // Test Iroh peer (different transport type)
2025-11-10T00:08:56.7823602Z      #[cfg(feature = "iroh")]
2025-11-10T00:08:56.7823669Z      {
2025-11-10T00:08:56.7823965Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/iroh_peer_tracking_tests.rs:31:
2025-11-10T00:08:56.7824028Z  #[test]
2025-11-10T00:08:56.7824131Z  fn test_find_transport_addr_by_socket() {
2025-11-10T00:08:56.7824227Z      let mut manager = PeerManager::new(10);
2025-11-10T00:08:56.7824412Z -    
2025-11-10T00:08:56.7824475Z +
2025-11-10T00:08:56.7824617Z      let addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-10T00:08:56.7824873Z      let tcp_addr = TransportAddr::Tcp(addr);
2025-11-10T00:08:56.7824940Z -    
2025-11-10T00:08:56.7825007Z +
2025-11-10T00:08:56.7825103Z      // Should not find peer that doesn't exist
2025-11-10T00:08:56.7825266Z      assert!(manager.find_transport_addr_by_socket(addr).is_none());
2025-11-10T00:08:56.7825332Z -    
2025-11-10T00:08:56.7825391Z +
2025-11-10T00:08:56.7825476Z      // After adding, should find it
2025-11-10T00:08:56.7825601Z      // Note: Would need actual Peer instance to test fully
2025-11-10T00:08:56.7825698Z      // This test validates the lookup logic
2025-11-10T00:08:56.7825988Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/iroh_peer_tracking_tests.rs:46:
2025-11-10T00:08:56.7826051Z  #[test]
2025-11-10T00:08:56.7826142Z  fn test_peer_socket_addresses() {
2025-11-10T00:08:56.7826237Z      let mut manager = PeerManager::new(10);
2025-11-10T00:08:56.7826295Z -    
2025-11-10T00:08:56.7826351Z +
2025-11-10T00:08:56.7826492Z      let addr1: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-10T00:08:56.7826614Z      let addr2: SocketAddr = "127.0.0.1:8334".parse().unwrap();
2025-11-10T00:08:56.7826675Z -    
2025-11-10T00:08:56.7826739Z +
2025-11-10T00:08:56.7826810Z      // Add TCP peers
2025-11-10T00:08:56.7826908Z      let tcp_addr1 = TransportAddr::Tcp(addr1);
2025-11-10T00:08:56.7827002Z      let tcp_addr2 = TransportAddr::Tcp(addr2);
2025-11-10T00:08:56.7827302Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/iroh_peer_tracking_tests.rs:56:
2025-11-10T00:08:56.7827364Z -    
2025-11-10T00:08:56.7827422Z +
2025-11-10T00:08:56.7827574Z      // Test that peer_socket_addresses returns TCP/Quinn addresses
2025-11-10T00:08:56.7827655Z      // and skips Iroh addresses
2025-11-10T00:08:56.7827778Z      let socket_addrs = manager.peer_socket_addresses();
2025-11-10T00:08:56.7828072Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/iroh_peer_tracking_tests.rs:60:
2025-11-10T00:08:56.7828245Z      // Should be empty since no peers added, but validates method exists
2025-11-10T00:08:56.7828337Z      assert_eq!(socket_addrs.len(), 0);
2025-11-10T00:08:56.7828397Z  }
2025-11-10T00:08:56.7828462Z -
2025-11-10T00:08:56.7828522Z  
2025-11-10T00:08:56.7829748Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:1:
2025-11-10T00:08:56.7829928Z  //! Tests for MempoolManager refactoring
2025-11-10T00:08:56.7830031Z  
2025-11-10T00:08:56.7830223Z  use bllvm_node::node::mempool::MempoolManager;
2025-11-10T00:08:56.7830525Z -use bllvm_protocol::{Transaction, TransactionInput, TransactionOutput, OutPoint, UtxoSet, UTXO};
2025-11-10T00:08:56.7830796Z +use bllvm_protocol::{OutPoint, Transaction, TransactionInput, TransactionOutput, UtxoSet, UTXO};
2025-11-10T00:08:56.7830885Z  use std::collections::HashMap;
2025-11-10T00:08:56.7830945Z  
2025-11-10T00:08:56.7831021Z  #[tokio::test]
2025-11-10T00:08:56.7831284Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:8:
2025-11-10T00:08:56.7831568Z  async fn test_mempool_stores_full_transactions() {
2025-11-10T00:08:56.7831679Z      let mut mempool = MempoolManager::new();
2025-11-10T00:08:56.7831740Z -    
2025-11-10T00:08:56.7831799Z +
2025-11-10T00:08:56.7831889Z      // Create a test transaction
2025-11-10T00:08:56.7831967Z      let tx = Transaction {
2025-11-10T00:08:56.7832037Z          version: 1,
2025-11-10T00:08:56.7832303Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:25:
2025-11-10T00:08:56.7832371Z          }],
2025-11-10T00:08:56.7832441Z          lock_time: 0,
2025-11-10T00:08:56.7832529Z      };
2025-11-10T00:08:56.7832590Z -    
2025-11-10T00:08:56.7832650Z +
2025-11-10T00:08:56.7832722Z      // Add transaction
2025-11-10T00:08:56.7835020Z      let added = mempool.add_transaction(tx.clone()).await.unwrap();
2025-11-10T00:08:56.7835094Z      assert!(added);
2025-11-10T00:08:56.7835358Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:32:
2025-11-10T00:08:56.7835566Z -    
2025-11-10T00:08:56.7835626Z +
2025-11-10T00:08:56.7835707Z      // Verify we can retrieve it
2025-11-10T00:08:56.7835821Z      use bllvm_protocol::mempool::calculate_tx_id;
2025-11-10T00:08:56.7835918Z      let tx_hash = calculate_tx_id(&tx);
2025-11-10T00:08:56.7836169Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:42:
2025-11-10T00:08:56.7836302Z  async fn test_mempool_get_prioritized_transactions() {
2025-11-10T00:08:56.7836412Z      let mut mempool = MempoolManager::new();
2025-11-10T00:08:56.7836514Z      let mut utxo_set: UtxoSet = HashMap::new();
2025-11-10T00:08:56.7836575Z -    
2025-11-10T00:08:56.7836640Z +
2025-11-10T00:08:56.7836723Z      // Create UTXO for input
2025-11-10T00:08:56.7836806Z      let outpoint = OutPoint {
2025-11-10T00:08:56.7836877Z          hash: [0u8; 32],
2025-11-10T00:08:56.7837134Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:49:
2025-11-10T00:08:56.7837208Z          index: 0,
2025-11-10T00:08:56.7837269Z      };
2025-11-10T00:08:56.7837370Z -    utxo_set.insert(outpoint.clone(), UTXO {
2025-11-10T00:08:56.7837447Z -        value: 10000,
2025-11-10T00:08:56.7837531Z -        script_pubkey: vec![0x51],
2025-11-10T00:08:56.7837596Z -    });
2025-11-10T00:08:56.7837663Z -    
2025-11-10T00:08:56.7837735Z +    utxo_set.insert(
2025-11-10T00:08:56.7837813Z +        outpoint.clone(),
2025-11-10T00:08:56.7837879Z +        UTXO {
2025-11-10T00:08:56.7837955Z +            value: 10000,
2025-11-10T00:08:56.7838040Z +            script_pubkey: vec![0x51],
2025-11-10T00:08:56.7838103Z +        },
2025-11-10T00:08:56.7838172Z +    );
2025-11-10T00:08:56.7838231Z +
2025-11-10T00:08:56.7838357Z      // Create two transactions with different fee rates
2025-11-10T00:08:56.7838438Z      // High fee transaction
2025-11-10T00:08:56.7838530Z      let high_fee_tx = Transaction {
2025-11-10T00:08:56.7838799Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:68:
2025-11-10T00:08:56.7838865Z          }],
2025-11-10T00:08:56.7838942Z          lock_time: 0,
2025-11-10T00:08:56.7839004Z      };
2025-11-10T00:08:56.7839065Z -    
2025-11-10T00:08:56.7839124Z +
2025-11-10T00:08:56.7839207Z      // Low fee transaction
2025-11-10T00:08:56.7839288Z      let low_fee_tx = Transaction {
2025-11-10T00:08:56.7839357Z          version: 1,
2025-11-10T00:08:56.7839610Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:86:
2025-11-10T00:08:56.7839673Z          }],
2025-11-10T00:08:56.7839741Z          lock_time: 0,
2025-11-10T00:08:56.7839802Z      };
2025-11-10T00:08:56.7839870Z -    
2025-11-10T00:08:56.7839931Z +
2025-11-10T00:08:56.7840012Z      // Add both transactions
2025-11-10T00:08:56.7840170Z      mempool.add_transaction(low_fee_tx.clone()).await.unwrap();
2025-11-10T00:08:56.7840325Z      mempool.add_transaction(high_fee_tx.clone()).await.unwrap();
2025-11-10T00:08:56.7840588Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:93:
2025-11-10T00:08:56.7840777Z -    
2025-11-10T00:08:56.7840841Z +
2025-11-10T00:08:56.7840965Z      // Get prioritized (should return high fee first)
2025-11-10T00:08:56.7841151Z      let prioritized = mempool.get_prioritized_transactions(10, &utxo_set);
2025-11-10T00:08:56.7841300Z      assert_eq!(prioritized.len(), 1); // Only one has valid UTXO
2025-11-10T00:08:56.7841565Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:97:
2025-11-10T00:08:56.7841627Z -    
2025-11-10T00:08:56.7841691Z +
2025-11-10T00:08:56.7841786Z      // Verify high fee transaction is first
2025-11-10T00:08:56.7841894Z      use bllvm_protocol::mempool::calculate_tx_id;
2025-11-10T00:08:56.7842011Z      let high_fee_hash = calculate_tx_id(&high_fee_tx);
2025-11-10T00:08:56.7842277Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:104:
2025-11-10T00:08:56.7842442Z  #[tokio::test]
2025-11-10T00:08:56.7842554Z  async fn test_mempool_remove_transaction() {
2025-11-10T00:08:56.7842656Z      let mut mempool = MempoolManager::new();
2025-11-10T00:08:56.7842716Z -    
2025-11-10T00:08:56.7842778Z +
2025-11-10T00:08:56.7842856Z      let tx = Transaction {
2025-11-10T00:08:56.7842929Z          version: 1,
2025-11-10T00:08:56.7843021Z          inputs: vec![TransactionInput {
2025-11-10T00:08:56.7843277Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:121:
2025-11-10T00:08:56.7843346Z          }],
2025-11-10T00:08:56.7843414Z          lock_time: 0,
2025-11-10T00:08:56.7843476Z      };
2025-11-10T00:08:56.7843535Z -    
2025-11-10T00:08:56.7843600Z +
2025-11-10T00:08:56.7843727Z      mempool.add_transaction(tx.clone()).await.unwrap();
2025-11-10T00:08:56.7843811Z      assert_eq!(mempool.size(), 1);
2025-11-10T00:08:56.7843876Z -    
2025-11-10T00:08:56.7843935Z +
2025-11-10T00:08:56.7844047Z      use bllvm_protocol::mempool::calculate_tx_id;
2025-11-10T00:08:56.7844140Z      let tx_hash = calculate_tx_id(&tx);
2025-11-10T00:08:56.7844267Z      let removed = mempool.remove_transaction(&tx_hash);
2025-11-10T00:08:56.7844642Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:131:
2025-11-10T00:08:56.7844716Z      assert!(removed);
2025-11-10T00:08:56.7844803Z      assert_eq!(mempool.size(), 0);
2025-11-10T00:08:56.7844862Z  }
2025-11-10T00:08:56.7844922Z -
2025-11-10T00:08:56.7844987Z  
2025-11-10T00:08:56.7856471Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:1:
2025-11-10T00:08:56.7856594Z -use bllvm_protocol::ProtocolVersion;
2025-11-10T00:08:56.7856711Z  use bllvm_node::storage::blockstore::BlockStore;
2025-11-10T00:08:56.7856824Z  use bllvm_node::storage::chainstate::ChainState;
2025-11-10T00:08:56.7856924Z  use bllvm_node::storage::txindex::TxIndex;
2025-11-10T00:08:56.7857157Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:9:
2025-11-10T00:08:56.7857256Z  use bllvm_node::OutPoint;
2025-11-10T00:08:56.7857337Z  use bllvm_node::Transaction;
2025-11-10T00:08:56.7857509Z  use bllvm_node::{ByteString, TransactionInput, TransactionOutput};
2025-11-10T00:08:56.7857609Z +use bllvm_protocol::ProtocolVersion;
2025-11-10T00:08:56.7857691Z  use std::collections::HashMap;
2025-11-10T00:08:56.7857769Z  use tempfile::TempDir;
2025-11-10T00:08:56.7857828Z  
2025-11-10T00:08:56.7863086Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_property_tests.rs:2:
2025-11-10T00:08:56.7863172Z  //!
2025-11-10T00:08:56.7863405Z  //! Uses proptest to verify invariants and properties that should hold for all inputs.
2025-11-10T00:08:56.7863477Z  
2025-11-10T00:08:56.7863543Z -use hex;
2025-11-10T00:08:56.7863634Z -use proptest::prelude::*;
2025-11-10T00:08:56.7863757Z +use bllvm_node::node::mempool::MempoolManager;
2025-11-10T00:08:56.7863850Z +use bllvm_node::rpc::mining::MiningRpc;
2025-11-10T00:08:56.7863946Z +use bllvm_node::storage::Storage;
2025-11-10T00:08:56.7864266Z  use bllvm_protocol::serialization::serialize_transaction;
2025-11-10T00:08:56.7864556Z  use bllvm_protocol::types::{
2025-11-10T00:08:56.7864911Z      BlockHeader, OutPoint, Transaction, TransactionInput, TransactionOutput,
2025-11-10T00:08:56.7865241Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_property_tests.rs:10:
2025-11-10T00:08:56.7865312Z  };
2025-11-10T00:08:56.7865503Z -use bllvm_node::node::mempool::MempoolManager;
2025-11-10T00:08:56.7865664Z -use bllvm_node::rpc::mining::MiningRpc;
2025-11-10T00:08:56.7865801Z -use bllvm_node::storage::Storage;
2025-11-10T00:08:56.7865868Z +use hex;
2025-11-10T00:08:56.7865954Z +use proptest::prelude::*;
2025-11-10T00:08:56.7866036Z  use sha2::{Digest, Sha256};
2025-11-10T00:08:56.7866112Z  use std::sync::Arc;
2025-11-10T00:08:56.7866190Z  use tempfile::TempDir;
2025-11-10T00:08:56.7872837Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_rpc_implementation_tests.rs:1:
2025-11-10T00:08:56.7873165Z  //! Tests for mining RPC implementation
2025-11-10T00:08:56.7873231Z  
2025-11-10T00:08:56.7873361Z +use bllvm_node::node::mempool::MempoolManager;
2025-11-10T00:08:56.7873460Z  use bllvm_node::rpc::mining::MiningRpc;
2025-11-10T00:08:56.7873550Z  use bllvm_node::storage::Storage;
2025-11-10T00:08:56.7875773Z -use bllvm_node::node::mempool::MempoolManager;
2025-11-10T00:08:56.7875861Z +use serde_json::json;
2025-11-10T00:08:56.7875934Z  use std::sync::Arc;
2025-11-10T00:08:56.7876014Z  use tempfile::TempDir;
2025-11-10T00:08:56.7876094Z -use serde_json::json;
2025-11-10T00:08:56.7876155Z  
2025-11-10T00:08:56.7876225Z  #[tokio::test]
2025-11-10T00:08:56.7876312Z  async fn test_get_mining_info() {
2025-11-10T00:08:56.7876663Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_rpc_implementation_tests.rs:12:
2025-11-10T00:08:56.7876766Z      let temp_dir = TempDir::new().unwrap();
2025-11-10T00:08:56.7876909Z      let storage = Storage::new(temp_dir.path()).unwrap();
2025-11-10T00:08:56.7877018Z      let mempool = MempoolManager::new();
2025-11-10T00:08:56.7877080Z -    
2025-11-10T00:08:56.7877140Z +
2025-11-10T00:08:56.7877366Z      let mining_rpc = MiningRpc::with_dependencies(Arc::new(storage), Arc::new(mempool));
2025-11-10T00:08:56.7877429Z -    
2025-11-10T00:08:56.7877489Z +
2025-11-10T00:08:56.7877621Z      let info = mining_rpc.get_mining_info().await.unwrap();
2025-11-10T00:08:56.7877689Z -    
2025-11-10T00:08:56.7877749Z +
2025-11-10T00:08:56.7877834Z      // Verify response structure
2025-11-10T00:08:56.7877932Z      assert!(info.get("blocks").is_some());
2025-11-10T00:08:56.7878033Z      assert!(info.get("pooledtx").is_some());
2025-11-10T00:08:56.7878375Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_rpc_implementation_tests.rs:29:
2025-11-10T00:08:56.7878477Z      let temp_dir = TempDir::new().unwrap();
2025-11-10T00:08:56.7878610Z      let storage = Storage::new(temp_dir.path()).unwrap();
2025-11-10T00:08:56.7878708Z      let mempool = MempoolManager::new();
2025-11-10T00:08:56.7878770Z -    
2025-11-10T00:08:56.7878837Z +
2025-11-10T00:08:56.7879047Z      let mining_rpc = MiningRpc::with_dependencies(Arc::new(storage), Arc::new(mempool));
2025-11-10T00:08:56.7879109Z -    
2025-11-10T00:08:56.7879178Z +
2025-11-10T00:08:56.7879258Z      let params = json!([]);
2025-11-10T00:08:56.7879409Z      let template = mining_rpc.get_block_template(&params).await;
2025-11-10T00:08:56.7879471Z -    
2025-11-10T00:08:56.7879536Z +
2025-11-10T00:08:56.7879636Z      // Should either succeed or fail gracefully
2025-11-10T00:08:56.7879767Z      // (may fail if chain not initialized, which is expected)
2025-11-10T00:08:56.7879889Z      assert!(template.is_ok() || template.is_err());
2025-11-10T00:08:56.7880227Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_rpc_implementation_tests.rs:45:
2025-11-10T00:08:56.7880326Z      let temp_dir = TempDir::new().unwrap();
2025-11-10T00:08:56.7880623Z      let storage = Storage::new(temp_dir.path()).unwrap();
2025-11-10T00:08:56.7880716Z      let mempool = MempoolManager::new();
2025-11-10T00:08:56.7880778Z -    
2025-11-10T00:08:56.7880839Z +
2025-11-10T00:08:56.7881058Z      let mining_rpc = MiningRpc::with_dependencies(Arc::new(storage), Arc::new(mempool));
2025-11-10T00:08:56.7881121Z -    
2025-11-10T00:08:56.7881181Z +
2025-11-10T00:08:56.7881386Z      // Create a minimal invalid block hex (will fail validation, which is expected)
2025-11-10T00:08:56.7881604Z      let invalid_block_hex = "0000000000000000000000000000000000000000000000000000000000000000";
2025-11-10T00:08:56.7881711Z      let params = json!([invalid_block_hex, ""]);
2025-11-10T00:08:56.7882042Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_rpc_implementation_tests.rs:54:
2025-11-10T00:08:56.7882105Z -    
2025-11-10T00:08:56.7882164Z +
2025-11-10T00:08:56.7882290Z      let result = mining_rpc.submit_block(&params).await;
2025-11-10T00:08:56.7882485Z -    
2025-11-10T00:08:56.7882545Z +
2025-11-10T00:08:56.7882671Z      // Should fail validation (expected for invalid block)
2025-11-10T00:08:56.7882759Z      assert!(result.is_err());
2025-11-10T00:08:56.7882820Z  }
2025-11-10T00:08:56.7883146Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_rpc_implementation_tests.rs:63:
2025-11-10T00:08:56.7883245Z      let temp_dir = TempDir::new().unwrap();
2025-11-10T00:08:56.7883383Z      let storage = Storage::new(temp_dir.path()).unwrap();
2025-11-10T00:08:56.7883476Z      let mempool = MempoolManager::new();
2025-11-10T00:08:56.7883538Z -    
2025-11-10T00:08:56.7883605Z +
2025-11-10T00:08:56.7883820Z      let mining_rpc = MiningRpc::with_dependencies(Arc::new(storage), Arc::new(mempool));
2025-11-10T00:08:56.7885943Z -    
2025-11-10T00:08:56.7886012Z +
2025-11-10T00:08:56.7886110Z      let params = json!([6, "conservative"]);
2025-11-10T00:08:56.7886300Z      let fee_estimate = mining_rpc.estimate_smart_fee(&params).await.unwrap();
2025-11-10T00:08:56.7886366Z -    
2025-11-10T00:08:56.7886431Z +
2025-11-10T00:08:56.7886515Z      // Verify response structure
2025-11-10T00:08:56.7886631Z      assert!(fee_estimate.get("feerate").is_some());
2025-11-10T00:08:56.7886744Z      assert!(fee_estimate.get("blocks").is_some());
2025-11-10T00:08:56.7887081Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_rpc_implementation_tests.rs:75:
2025-11-10T00:08:56.7887249Z      assert_eq!(fee_estimate.get("blocks").unwrap().as_u64().unwrap(), 6);
2025-11-10T00:08:56.7887312Z  }
2025-11-10T00:08:56.7887378Z -
2025-11-10T00:08:56.7887438Z  
2025-11-10T00:08:56.7905319Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:1:
2025-11-10T00:08:56.7905456Z -use bllvm_protocol::ProtocolVersion;
2025-11-10T00:08:56.7905577Z  use bllvm_node::storage::blockstore::BlockStore;
2025-11-10T00:08:56.7905694Z  use bllvm_node::storage::chainstate::ChainState;
2025-11-10T00:08:56.7905821Z  use bllvm_node::storage::txindex::TxIndex;
2025-11-10T00:08:56.7906067Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:9:
2025-11-10T00:08:56.7906154Z  use bllvm_node::OutPoint;
2025-11-10T00:08:56.7906245Z  use bllvm_node::Transaction;
2025-11-10T00:08:56.7906423Z  use bllvm_node::{ByteString, TransactionInput, TransactionOutput};
2025-11-10T00:08:56.7906523Z +use bllvm_protocol::ProtocolVersion;
2025-11-10T00:08:56.7906611Z  use std::collections::HashMap;
2025-11-10T00:08:56.7906695Z  use tempfile::TempDir;
2025-11-10T00:08:56.7906758Z  
2025-11-10T00:08:56.7933062Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_rpc_tests.rs:1:
2025-11-10T00:08:56.7933190Z  //! Unit tests for Mining RPC methods
2025-11-10T00:08:56.7933257Z  
2025-11-10T00:08:56.7933418Z -use bllvm_protocol::serialization::serialize_transaction;
2025-11-10T00:08:56.7933658Z -use bllvm_protocol::{BlockHeader, Natural, OutPoint, Transaction, UtxoSet, UTXO};
2025-11-10T00:08:56.7933972Z  use bllvm_node::node::mempool::MempoolManager;
2025-11-10T00:08:56.7934071Z  use bllvm_node::rpc::mining::MiningRpc;
2025-11-10T00:08:56.7934167Z  use bllvm_node::storage::Storage;
2025-11-10T00:08:56.7934655Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_rpc_tests.rs:8:
2025-11-10T00:08:56.7934805Z +use bllvm_protocol::serialization::serialize_transaction;
2025-11-10T00:08:56.7935027Z +use bllvm_protocol::{BlockHeader, Natural, OutPoint, Transaction, UtxoSet, UTXO};
2025-11-10T00:08:56.7935112Z  use std::sync::Arc;
2025-11-10T00:08:56.7935193Z  use tempfile::TempDir;
2025-11-10T00:08:56.7935284Z  // Sha256 not needed directly in tests
2025-11-10T00:08:56.7940568Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/module_process_sharing_tests.rs:3:
2025-11-10T00:08:56.7940777Z  use bllvm_node::module::process::monitor::ModuleProcessMonitor;
2025-11-10T00:08:56.7941187Z  use bllvm_node::module::process::spawner::{ModuleProcess, ModuleProcessSpawner};
2025-11-10T00:08:56.7941285Z  use std::sync::{Arc, Mutex};
2025-11-10T00:08:56.7941366Z -use tokio::sync::mpsc;
2025-11-10T00:08:56.7941448Z  use tempfile::TempDir;
2025-11-10T00:08:56.7941531Z +use tokio::sync::mpsc;
2025-11-10T00:08:56.7941596Z  
2025-11-10T00:08:56.7941667Z  #[tokio::test]
2025-11-10T00:08:56.7941778Z  async fn test_monitor_module_shared() {
2025-11-10T00:08:56.7942133Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/module_process_sharing_tests.rs:11:
2025-11-10T00:08:56.7942238Z      let temp_dir = TempDir::new().unwrap();
2025-11-10T00:08:56.7942373Z      let (crash_tx, _crash_rx) = mpsc::unbounded_channel();
2025-11-10T00:08:56.7942509Z      let monitor = ModuleProcessMonitor::new(crash_tx);
2025-11-10T00:08:56.7942578Z -    
2025-11-10T00:08:56.7942643Z +
2025-11-10T00:08:56.7942829Z      // Create a dummy process (using true command which exits immediately)
2025-11-10T00:08:56.7942956Z -    let process = tokio::process::Command::new("true")
2025-11-10T00:08:56.7943029Z -        .spawn()
2025-11-10T00:08:56.7943099Z -        .unwrap();
2025-11-10T00:08:56.7943168Z -    
2025-11-10T00:08:56.7943351Z +    let process = tokio::process::Command::new("true").spawn().unwrap();
2025-11-10T00:08:56.7943418Z +
2025-11-10T00:08:56.7943514Z      let module_process = ModuleProcess {
2025-11-10T00:08:56.7943607Z          module_name: "test".to_string(),
2025-11-10T00:08:56.7943678Z          process,
2025-11-10T00:08:56.7944027Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/module_process_sharing_tests.rs:23:
2025-11-10T00:08:56.7944139Z          socket_path: std::path::PathBuf::new(),
2025-11-10T00:08:56.7944212Z          client: None,
2025-11-10T00:08:56.7944278Z      };
2025-11-10T00:08:56.7944572Z -    
2025-11-10T00:08:56.7944641Z +
2025-11-10T00:08:56.7944795Z      let shared_process = Arc::new(Mutex::new(module_process));
2025-11-10T00:08:56.7944859Z -    
2025-11-10T00:08:56.7944934Z +
2025-11-10T00:08:56.7945052Z      // Test that monitor_module_shared can be called
2025-11-10T00:08:56.7945180Z      // (will exit quickly since process exits immediately)
2025-11-10T00:08:56.7945418Z -    let result = monitor.monitor_module_shared("test".to_string(), shared_process).await;
2025-11-10T00:08:56.7945488Z -    
2025-11-10T00:08:56.7945566Z +    let result = monitor
2025-11-10T00:08:56.7945715Z +        .monitor_module_shared("test".to_string(), shared_process)
2025-11-10T00:08:56.7945789Z +        .await;
2025-11-10T00:08:56.7945853Z +
2025-11-10T00:08:56.7945955Z      // Should succeed (process exits normally)
2025-11-10T00:08:56.7946037Z      assert!(result.is_ok());
2025-11-10T00:08:56.7946107Z  }
2025-11-10T00:08:56.7946446Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/module_process_sharing_tests.rs:36:
2025-11-10T00:08:56.7946510Z -
2025-11-10T00:08:56.7946579Z  
2025-11-10T00:08:56.7970698Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:1:
2025-11-10T00:08:56.7971012Z -use bllvm_protocol::ProtocolVersion;
2025-11-10T00:08:56.7971151Z  use bllvm_node::storage::blockstore::BlockStore;
2025-11-10T00:08:56.7971273Z  use bllvm_node::storage::chainstate::ChainState;
2025-11-10T00:08:56.7971383Z  use bllvm_node::storage::txindex::TxIndex;
2025-11-10T00:08:56.7971650Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:9:
2025-11-10T00:08:56.7971750Z  use bllvm_node::OutPoint;
2025-11-10T00:08:56.7971845Z  use bllvm_node::Transaction;
2025-11-10T00:08:56.7972034Z  use bllvm_node::{ByteString, TransactionInput, TransactionOutput};
2025-11-10T00:08:56.7972144Z +use bllvm_protocol::ProtocolVersion;
2025-11-10T00:08:56.7972236Z  use std::collections::HashMap;
2025-11-10T00:08:56.7972324Z  use tempfile::TempDir;
2025-11-10T00:08:56.7972399Z  
2025-11-10T00:08:56.8061581Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:8:
2025-11-10T00:08:56.8062007Z  use std::net::SocketAddr;
2025-11-10T00:08:56.8062126Z  use tokio::sync::mpsc;
2025-11-10T00:08:56.8062223Z  mod common;
2025-11-10T00:08:56.8062333Z -use common::*;
2025-11-10T00:08:56.8062623Z  use bllvm_node::network::inventory::{InventoryRequest, MSG_BLOCK, MSG_TX};
2025-11-10T00:08:56.8062909Z  use bllvm_node::network::protocol::InventoryItem as NetworkInventoryItem;
2025-11-10T00:08:56.8063020Z +use common::*;
2025-11-10T00:08:56.8063112Z  
2025-11-10T00:08:56.8063214Z  #[tokio::test]
2025-11-10T00:08:56.8063361Z  async fn test_network_manager_creation() {
2025-11-10T00:08:56.8063769Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:878:
2025-11-10T00:08:56.8063901Z  async fn test_persistent_peers() {
2025-11-10T00:08:56.8064084Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-10T00:08:56.8064237Z      let manager = NetworkManager::new(addr);
2025-11-10T00:08:56.8064571Z -    
2025-11-10T00:08:56.8064667Z +
2025-11-10T00:08:56.8064876Z      let peer1: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-10T00:08:56.8065075Z      let peer2: SocketAddr = "127.0.0.1:8334".parse().unwrap();
2025-11-10T00:08:56.8065168Z -    
2025-11-10T00:08:56.8065258Z +
2025-11-10T00:08:56.8065392Z      // Test adding persistent peers
2025-11-10T00:08:56.8065529Z      manager.add_persistent_peer(peer1);
2025-11-10T00:08:56.8065659Z      manager.add_persistent_peer(peer2);
2025-11-10T00:08:56.8066055Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:888:
2025-11-10T00:08:56.8066157Z -    
2025-11-10T00:08:56.8066249Z +
2025-11-10T00:08:56.8066423Z      let persistent = manager.get_persistent_peers();
2025-11-10T00:08:56.8066565Z      assert_eq!(persistent.len(), 2);
2025-11-10T00:08:56.8066706Z      assert!(persistent.contains(&peer1));
2025-11-10T00:08:56.8067113Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:892:
2025-11-10T00:08:56.8067258Z      assert!(persistent.contains(&peer2));
2025-11-10T00:08:56.8067360Z -    
2025-11-10T00:08:56.8067451Z +
2025-11-10T00:08:56.8067578Z      // Test removing persistent peer
2025-11-10T00:08:56.8067730Z      manager.remove_persistent_peer(peer1);
2025-11-10T00:08:56.8067900Z      let persistent = manager.get_persistent_peers();
2025-11-10T00:08:56.8068295Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:903:
2025-11-10T00:08:56.8068418Z  async fn test_ban_list() {
2025-11-10T00:08:56.8068599Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-10T00:08:56.8068747Z      let manager = NetworkManager::new(addr);
2025-11-10T00:08:56.8068839Z -    
2025-11-10T00:08:56.8068936Z +
2025-11-10T00:08:56.8069166Z      let banned_peer: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-10T00:08:56.8069261Z -    
2025-11-10T00:08:56.8069356Z +
2025-11-10T00:08:56.8069509Z      // Test banning a peer (permanent ban)
2025-11-10T00:08:56.8069667Z      manager.ban_peer(banned_peer, 0);
2025-11-10T00:08:56.8069847Z      assert!(manager.is_banned(banned_peer));
2025-11-10T00:08:56.8070377Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:912:
2025-11-10T00:08:56.8070468Z -    
2025-11-10T00:08:56.8070559Z +
2025-11-10T00:08:56.8070682Z      // Test getting banned peers
2025-11-10T00:08:56.8070825Z      let banned = manager.get_banned_peers();
2025-11-10T00:08:56.8070940Z      assert_eq!(banned.len(), 1);
2025-11-10T00:08:56.8071332Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:916:
2025-11-10T00:08:56.8071464Z      assert_eq!(banned[0].0, banned_peer);
2025-11-10T00:08:56.8071556Z -    
2025-11-10T00:08:56.8071645Z +
2025-11-10T00:08:56.8071752Z      // Test unbanning
2025-11-10T00:08:56.8071879Z      manager.unban_peer(banned_peer);
2025-11-10T00:08:56.8072018Z      assert!(!manager.is_banned(banned_peer));
2025-11-10T00:08:56.8072393Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:921:
2025-11-10T00:08:56.8072909Z -    
2025-11-10T00:08:56.8072997Z +
2025-11-10T00:08:56.8073107Z      // Test temporary ban
2025-11-10T00:08:56.8073249Z      use std::time::{SystemTime, UNIX_EPOCH};
2025-11-10T00:08:56.8073367Z      let now = SystemTime::now()
2025-11-10T00:08:56.8073736Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:928:
2025-11-10T00:08:56.8073889Z      let unban_time = now + 3600; // 1 hour from now
2025-11-10T00:08:56.8076182Z      manager.ban_peer(banned_peer, unban_time);
2025-11-10T00:08:56.8076321Z      assert!(manager.is_banned(banned_peer));
2025-11-10T00:08:56.8076409Z -    
2025-11-10T00:08:56.8076506Z +
2025-11-10T00:08:56.8076616Z      // Test clearing all bans
2025-11-10T00:08:56.8076725Z      manager.clear_bans();
2025-11-10T00:08:56.8076869Z      assert!(!manager.is_banned(banned_peer));
2025-11-10T00:08:56.8077244Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:939:
2025-11-10T00:08:56.8077373Z  async fn test_network_stats() {
2025-11-10T00:08:56.8077552Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-10T00:08:56.8077699Z      let manager = NetworkManager::new(addr);
2025-11-10T00:08:56.8077787Z -    
2025-11-10T00:08:56.8077874Z +
2025-11-10T00:08:56.8078006Z      // Initially stats should be zero
2025-11-10T00:08:56.8078179Z      let (sent, received) = manager.get_network_stats();
2025-11-10T00:08:56.8078287Z      assert_eq!(sent, 0);
2025-11-10T00:08:56.8078675Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:946:
2025-11-10T00:08:56.8078794Z      assert_eq!(received, 0);
2025-11-10T00:08:56.8078882Z -    
2025-11-10T00:08:56.8078970Z +
2025-11-10T00:08:56.8079078Z      // Track some bytes
2025-11-10T00:08:56.8079200Z      manager.track_bytes_sent(100);
2025-11-10T00:08:56.8079325Z      manager.track_bytes_received(200);
2025-11-10T00:08:56.8079701Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:951:
2025-11-10T00:08:56.8079800Z -    
2025-11-10T00:08:56.8079890Z +
2025-11-10T00:08:56.8080055Z      let (sent, received) = manager.get_network_stats();
2025-11-10T00:08:56.8080168Z      assert_eq!(sent, 100);
2025-11-10T00:08:56.8080282Z      assert_eq!(received, 200);
2025-11-10T00:08:56.8080656Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:955:
2025-11-10T00:08:56.8080746Z -    
2025-11-10T00:08:56.8080847Z +
2025-11-10T00:08:56.8080987Z      // Track more bytes (should accumulate)
2025-11-10T00:08:56.8081106Z      manager.track_bytes_sent(50);
2025-11-10T00:08:56.8081217Z      manager.track_bytes_received(75);
2025-11-10T00:08:56.8081526Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:959:
2025-11-10T00:08:56.8081601Z -    
2025-11-10T00:08:56.8081675Z +
2025-11-10T00:08:56.8081814Z      let (sent, received) = manager.get_network_stats();
2025-11-10T00:08:56.8081908Z      assert_eq!(sent, 150);
2025-11-10T00:08:56.8082136Z      assert_eq!(received, 275);
2025-11-10T00:08:56.8082443Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:966:
2025-11-10T00:08:56.8082553Z  async fn test_ping_all_peers() {
2025-11-10T00:08:56.8082696Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-10T00:08:56.8082814Z      let manager = NetworkManager::new(addr);
2025-11-10T00:08:56.8082896Z -    
2025-11-10T00:08:56.8082970Z +
2025-11-10T00:08:56.8083095Z      // Test ping with no peers (should not error)
2025-11-10T00:08:56.8091600Z      let result = manager.ping_all_peers().await;
2025-11-10T00:08:56.8091746Z      assert!(result.is_ok());
2025-11-10T00:08:56.8092070Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:973:
2025-11-10T00:08:56.8092153Z -    
2025-11-10T00:08:56.8092222Z +
2025-11-10T00:08:56.8092453Z      // Note: Testing with actual peers would require setting up connections,
2025-11-10T00:08:56.8093026Z      // which is more complex. This test verifies the method doesn't panic.
2025-11-10T00:08:56.8093155Z  }
2025-11-10T00:08:56.8093700Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:1:
2025-11-10T00:08:56.8093826Z -use bllvm_protocol::ProtocolVersion;
2025-11-10T00:08:56.8093969Z  use bllvm_node::storage::blockstore::BlockStore;
2025-11-10T00:08:56.8094091Z  use bllvm_node::storage::chainstate::ChainState;
2025-11-10T00:08:56.8094201Z  use bllvm_node::storage::txindex::TxIndex;
2025-11-10T00:08:56.8094662Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:9:
2025-11-10T00:08:56.8094760Z  use bllvm_node::OutPoint;
2025-11-10T00:08:56.8094854Z  use bllvm_node::Transaction;
2025-11-10T00:08:56.8095058Z  use bllvm_node::{ByteString, TransactionInput, TransactionOutput};
2025-11-10T00:08:56.8095169Z +use bllvm_protocol::ProtocolVersion;
2025-11-10T00:08:56.8095266Z  use std::collections::HashMap;
2025-11-10T00:08:56.8095367Z  use tempfile::TempDir;
2025-11-10T00:08:56.8095442Z  
2025-11-10T00:08:56.8131376Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/node_tests.rs:5:
2025-11-10T00:08:56.8131521Z  use std::net::SocketAddr;
2025-11-10T00:08:56.8131631Z  use tempfile::TempDir;
2025-11-10T00:08:56.8131715Z  mod common;
2025-11-10T00:08:56.8131803Z -use common::*;
2025-11-10T00:08:56.8131942Z  use bllvm_protocol::ProtocolVersion;
2025-11-10T00:08:56.8132028Z +use common::*;
2025-11-10T00:08:56.8132104Z  
2025-11-10T00:08:56.8132192Z  #[tokio::test]
2025-11-10T00:08:56.8132308Z  async fn test_node_creation() {
2025-11-10T00:08:56.8142785Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/peer_stats_tests.rs:3:
2025-11-10T00:08:56.8142945Z  use bllvm_node::network::peer::Peer;
2025-11-10T00:08:56.8143064Z  use bllvm_node::network::NetworkMessage;
2025-11-10T00:08:56.8143163Z  use std::net::SocketAddr;
2025-11-10T00:08:56.8143264Z -use tokio::sync::mpsc;
2025-11-10T00:08:56.8143371Z  use tokio::net::TcpStream;
2025-11-10T00:08:56.8143466Z +use tokio::sync::mpsc;
2025-11-10T00:08:56.8143541Z  
2025-11-10T00:08:56.8145749Z  #[tokio::test]
2025-11-10T00:08:56.8145878Z  async fn test_peer_stats_initialization() {
2025-11-10T00:08:56.8146221Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/peer_stats_tests.rs:11:
2025-11-10T00:08:56.8146392Z      let addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-10T00:08:56.8146515Z      let (tx, _rx) = mpsc::unbounded_channel();
2025-11-10T00:08:56.8146591Z -    
2025-11-10T00:08:56.8146672Z +
2025-11-10T00:08:56.8146767Z      // Create a mock stream
2025-11-10T00:08:56.8146992Z      let listener = tokio::net::TcpListener::bind("127.0.0.1:0").await.unwrap();
2025-11-10T00:08:56.8147132Z      let local_addr = listener.local_addr().unwrap();
2025-11-10T00:08:56.8147470Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/peer_stats_tests.rs:17:
2025-11-10T00:08:56.8147684Z      let stream = tokio::net::TcpStream::connect(local_addr).await.unwrap();
2025-11-10T00:08:56.8147951Z -    
2025-11-10T00:08:56.8148032Z +
2025-11-10T00:08:56.8148153Z      let peer = Peer::new(stream, addr, tx);
2025-11-10T00:08:56.8148228Z -    
2025-11-10T00:08:56.8148301Z +
2025-11-10T00:08:56.8148403Z      // Check initial stats
2025-11-10T00:08:56.8148505Z      assert!(peer.conntime() > 0);
2025-11-10T00:08:56.8148636Z      assert_eq!(peer.conntime(), peer.last_send());
2025-11-10T00:08:56.8148982Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/peer_stats_tests.rs:30:
2025-11-10T00:08:56.8149088Z  async fn test_peer_record_send() {
2025-11-10T00:08:56.8149247Z      let addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-10T00:08:56.8149371Z      let (tx, _rx) = mpsc::unbounded_channel();
2025-11-10T00:08:56.8149447Z -    
2025-11-10T00:08:56.8149521Z +
2025-11-10T00:08:56.8149740Z      let listener = tokio::net::TcpListener::bind("127.0.0.1:0").await.unwrap();
2025-11-10T00:08:56.8150009Z      let local_addr = listener.local_addr().unwrap();
2025-11-10T00:08:56.8150215Z      let stream = tokio::net::TcpStream::connect(local_addr).await.unwrap();
2025-11-10T00:08:56.8150548Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/peer_stats_tests.rs:37:
2025-11-10T00:08:56.8150629Z -    
2025-11-10T00:08:56.8150702Z +
2025-11-10T00:08:56.8150826Z      let mut peer = Peer::new(stream, addr, tx);
2025-11-10T00:08:56.8150908Z -    
2025-11-10T00:08:56.8150981Z +
2025-11-10T00:08:56.8151090Z      let initial_send = peer.last_send();
2025-11-10T00:08:56.8151199Z      let initial_bytes = peer.bytes_sent();
2025-11-10T00:08:56.8151283Z -    
2025-11-10T00:08:56.8151357Z +
2025-11-10T00:08:56.8151442Z      // Record a send
2025-11-10T00:08:56.8151543Z      peer.record_send(100);
2025-11-10T00:08:56.8151620Z -    
2025-11-10T00:08:56.8151724Z +
2025-11-10T00:08:56.8151898Z      assert!(peer.last_send() >= initial_send);
2025-11-10T00:08:56.8152129Z      assert_eq!(peer.bytes_sent(), initial_bytes + 100);
2025-11-10T00:08:56.8152254Z  }
2025-11-10T00:08:56.8152812Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/peer_stats_tests.rs:51:
2025-11-10T00:08:56.8152930Z  async fn test_peer_record_receive() {
2025-11-10T00:08:56.8153088Z      let addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-10T00:08:56.8153206Z      let (tx, _rx) = mpsc::unbounded_channel();
2025-11-10T00:08:56.8153280Z -    
2025-11-10T00:08:56.8153361Z +
2025-11-10T00:08:56.8153573Z      let listener = tokio::net::TcpListener::bind("127.0.0.1:0").await.unwrap();
2025-11-10T00:08:56.8153704Z      let local_addr = listener.local_addr().unwrap();
2025-11-10T00:08:56.8155926Z      let stream = tokio::net::TcpStream::connect(local_addr).await.unwrap();
2025-11-10T00:08:56.8156253Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/peer_stats_tests.rs:58:
2025-11-10T00:08:56.8156330Z -    
2025-11-10T00:08:56.8156408Z +
2025-11-10T00:08:56.8156532Z      let mut peer = Peer::new(stream, addr, tx);
2025-11-10T00:08:56.8156611Z -    
2025-11-10T00:08:56.8156685Z +
2025-11-10T00:08:56.8156797Z      let initial_recv = peer.last_recv();
2025-11-10T00:08:56.8156906Z      let initial_bytes = peer.bytes_recv();
2025-11-10T00:08:56.8156981Z -    
2025-11-10T00:08:56.8157061Z +
2025-11-10T00:08:56.8157148Z      // Record a receive
2025-11-10T00:08:56.8157246Z      peer.record_receive(200);
2025-11-10T00:08:56.8157322Z -    
2025-11-10T00:08:56.8157402Z +
2025-11-10T00:08:56.8157518Z      assert!(peer.last_recv() >= initial_recv);
2025-11-10T00:08:56.8157659Z      assert_eq!(peer.bytes_recv(), initial_bytes + 200);
2025-11-10T00:08:56.8157741Z  }
2025-11-10T00:08:56.8158059Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/peer_stats_tests.rs:70:
2025-11-10T00:08:56.8158133Z -
2025-11-10T00:08:56.8158205Z  
2025-11-10T00:08:56.8158631Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/protocol_message_processing_tests.rs:1:
2025-11-10T00:08:56.8158945Z  //! Tests for protocol message processing integration
2025-11-10T00:08:56.8159020Z  
2025-11-10T00:08:56.8159121Z  use bllvm_node::network;
2025-11-10T00:08:56.8159224Z -use bllvm_node::storage::Storage;
2025-11-10T00:08:56.8159356Z  use bllvm_node::node::mempool::MempoolManager;
2025-11-10T00:08:56.8159461Z +use bllvm_node::storage::Storage;
2025-11-10T00:08:56.8159649Z  use bllvm_protocol::{BitcoinProtocolEngine, ProtocolVersion};
2025-11-10T00:08:56.8159736Z -use std::sync::Arc;
2025-11-10T00:08:56.8159837Z  use std::net::SocketAddr;
2025-11-10T00:08:56.8159922Z +use std::sync::Arc;
2025-11-10T00:08:56.8160012Z  use tempfile::TempDir;
2025-11-10T00:08:56.8160084Z  
2025-11-10T00:08:56.8160176Z  #[tokio::test]
2025-11-10T00:08:56.8160586Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/protocol_message_processing_tests.rs:14:
2025-11-10T00:08:56.8160761Z      let storage = Arc::new(Storage::new(temp_dir.path()).unwrap());
2025-11-10T00:08:56.8160999Z      let mempool = Arc::new(MempoolManager::new());
2025-11-10T00:08:56.8161264Z      let protocol_engine = Arc::new(BitcoinProtocolEngine::new(ProtocolVersion::Regtest).unwrap());
2025-11-10T00:08:56.8161327Z -    
2025-11-10T00:08:56.8161392Z +
2025-11-10T00:08:56.8161538Z      let network_addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-10T00:08:56.8161700Z -    let network_manager = network::NetworkManager::new(network_addr)
2025-11-10T00:08:56.8161850Z -        .with_dependencies(protocol_engine, storage, mempool);
2025-11-10T00:08:56.8161917Z -    
2025-11-10T00:08:56.8162146Z +    let network_manager = network::NetworkManager::new(network_addr).with_dependencies(
2025-11-10T00:08:56.8162226Z +        protocol_engine,
2025-11-10T00:08:56.8162296Z +        storage,
2025-11-10T00:08:56.8162360Z +        mempool,
2025-11-10T00:08:56.8162422Z +    );
2025-11-10T00:08:56.8162483Z +
2025-11-10T00:08:56.8162579Z      // Verify dependencies are set
2025-11-10T00:08:56.8162785Z      // (NetworkManager doesn't expose these, but we can verify it was created)
2025-11-10T00:08:56.8162897Z      assert!(true); // If we got here, setup worked
2025-11-10T00:08:56.8163258Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/protocol_message_processing_tests.rs:29:
2025-11-10T00:08:56.8163357Z      let temp_dir = TempDir::new().unwrap();
2025-11-10T00:08:56.8163486Z      let storage = Storage::new(temp_dir.path()).unwrap();
2025-11-10T00:08:56.8163603Z      let mempool = Arc::new(MempoolManager::new());
2025-11-10T00:08:56.8163665Z -    
2025-11-10T00:08:56.8163726Z +
2025-11-10T00:08:56.8163860Z      // Verify we can create NodeChainAccess with Storage Arcs
2025-11-10T00:08:56.8164006Z      use bllvm_node::network::chain_access::NodeChainAccess;
2025-11-10T00:08:56.8164113Z -    let chain_access = NodeChainAccess::new(
2025-11-10T00:08:56.8164192Z -        storage.blocks(),
2025-11-10T00:08:56.8164285Z -        storage.transactions(),
2025-11-10T00:08:56.8164475Z -        mempool,
2025-11-10T00:08:56.8164545Z -    );
2025-11-10T00:08:56.8164610Z -    
2025-11-10T00:08:56.8164871Z +    let chain_access = NodeChainAccess::new(storage.blocks(), storage.transactions(), mempool);
2025-11-10T00:08:56.8166809Z +
2025-11-10T00:08:56.8166884Z      // Test that it works
2025-11-10T00:08:56.8166962Z      let hash = [0u8; 32];
2025-11-10T00:08:56.8167101Z      assert!(!chain_access.has_object(&hash)); // Empty storage
2025-11-10T00:08:56.8167436Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/protocol_message_processing_tests.rs:44:
2025-11-10T00:08:56.8167498Z  }
2025-11-10T00:08:56.8167565Z -
2025-11-10T00:08:56.8167625Z  
2025-11-10T00:08:56.8200062Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:1:
2025-11-10T00:08:56.8200214Z -use bllvm_protocol::ProtocolVersion;
2025-11-10T00:08:56.8200344Z  use bllvm_node::storage::blockstore::BlockStore;
2025-11-10T00:08:56.8200460Z  use bllvm_node::storage::chainstate::ChainState;
2025-11-10T00:08:56.8200576Z  use bllvm_node::storage::txindex::TxIndex;
2025-11-10T00:08:56.8201018Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:9:
2025-11-10T00:08:56.8201111Z  use bllvm_node::OutPoint;
2025-11-10T00:08:56.8201206Z  use bllvm_node::Transaction;
2025-11-10T00:08:56.8201389Z  use bllvm_node::{ByteString, TransactionInput, TransactionOutput};
2025-11-10T00:08:56.8201492Z +use bllvm_protocol::ProtocolVersion;
2025-11-10T00:08:56.8201579Z  use std::collections::HashMap;
2025-11-10T00:08:56.8201669Z  use tempfile::TempDir;
2025-11-10T00:08:56.8201734Z  
2025-11-10T00:08:56.8247790Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:10:
2025-11-10T00:08:56.8247991Z  #[tokio::test]
2025-11-10T00:08:56.8248187Z  async fn test_message_size_validation() {
2025-11-10T00:08:56.8248486Z      use bllvm_node::network::protocol::MAX_PROTOCOL_MESSAGE_LENGTH;
2025-11-10T00:08:56.8248601Z -    
2025-11-10T00:08:56.8248907Z +
2025-11-10T00:08:56.8249070Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-10T00:08:56.8249200Z      let manager = NetworkManager::new(addr);
2025-11-10T00:08:56.8249276Z -    
2025-11-10T00:08:56.8249356Z +
2025-11-10T00:08:56.8249480Z      // Test that oversized messages are rejected
2025-11-10T00:08:56.8249683Z      // This is tested at the TransportConnection level, but we can verify
2025-11-10T00:08:56.8249806Z      // the protocol parser also validates size
2025-11-10T00:08:56.8250149Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:20:
2025-11-10T00:08:56.8250306Z      use bllvm_node::network::protocol::ProtocolParser;
2025-11-10T00:08:56.8250383Z -    
2025-11-10T00:08:56.8250464Z +
2025-11-10T00:08:56.8250571Z      // Create a message that's too large
2025-11-10T00:08:56.8250760Z      let oversized_data = vec![0u8; MAX_PROTOCOL_MESSAGE_LENGTH + 1];
2025-11-10T00:08:56.8250953Z      let result = ProtocolParser::parse_message(&oversized_data);
2025-11-10T00:08:56.8251279Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:29:
2025-11-10T00:08:56.8251385Z  async fn test_rate_limiting() {
2025-11-10T00:08:56.8251530Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-10T00:08:56.8251660Z      let manager = NetworkManager::new(addr);
2025-11-10T00:08:56.8251734Z -    
2025-11-10T00:08:56.8251808Z +
2025-11-10T00:08:56.8252007Z      // Rate limiting is tested implicitly through message processing
2025-11-10T00:08:56.8252222Z      // The rate limiter is checked in process_messages for RawMessageReceived
2025-11-10T00:08:56.8252410Z      // This test verifies the rate limiter structure exists and works
2025-11-10T00:08:56.8252736Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:36:
2025-11-10T00:08:56.8252813Z -    
2025-11-10T00:08:56.8252886Z +
2025-11-10T00:08:56.8253005Z      // Add a peer address to test rate limiting
2025-11-10T00:08:56.8253198Z      let test_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-10T00:08:56.8253276Z -    
2025-11-10T00:08:56.8253349Z +
2025-11-10T00:08:56.8253528Z      // Rate limiter should be created when first message arrives
2025-11-10T00:08:56.8253737Z      // We can't easily test this without a real connection, but the structure
2025-11-10T00:08:56.8253883Z      // is in place and will be tested in integration tests
2025-11-10T00:08:56.8254209Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:47:
2025-11-10T00:08:56.8254491Z  async fn test_per_ip_connection_limit() {
2025-11-10T00:08:56.8254635Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-10T00:08:56.8254756Z      let manager = NetworkManager::new(addr);
2025-11-10T00:08:56.8254837Z -    
2025-11-10T00:08:56.8254912Z +
2025-11-10T00:08:56.8255024Z      // Test that per-IP limits are enforced
2025-11-10T00:08:56.8255209Z      // This is tested in connect_to_peer, but we need a mock transport
2025-11-10T00:08:56.8257286Z      // For now, verify the structure exists
2025-11-10T00:08:56.8258027Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:54:
2025-11-10T00:08:56.8258147Z      let test_ip = "127.0.0.1".parse().unwrap();
2025-11-10T00:08:56.8258229Z -    
2025-11-10T00:08:56.8258302Z +
2025-11-10T00:08:56.8258451Z      // Connection limits are enforced in connect_to_peer
2025-11-10T00:08:56.8258586Z      // Integration test needed for full verification
2025-11-10T00:08:56.8258788Z      assert!(true); // Placeholder - per-IP limits tested in integration
2025-11-10T00:08:56.8259118Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:62:
2025-11-10T00:08:56.8259222Z  async fn test_ban_list_cleanup() {
2025-11-10T00:08:56.8259360Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-10T00:08:56.8259477Z      let manager = NetworkManager::new(addr);
2025-11-10T00:08:56.8259556Z -    
2025-11-10T00:08:56.8259750Z +
2025-11-10T00:08:56.8259861Z      // Test that expired bans are cleaned up
2025-11-10T00:08:56.8259977Z      use std::time::{SystemTime, UNIX_EPOCH};
2025-11-10T00:08:56.8260075Z      let now = SystemTime::now()
2025-11-10T00:08:56.8260385Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:69:
2025-11-10T00:08:56.8260488Z          .duration_since(UNIX_EPOCH)
2025-11-10T00:08:56.8260571Z          .unwrap()
2025-11-10T00:08:56.8260650Z          .as_secs();
2025-11-10T00:08:56.8260724Z -    
2025-11-10T00:08:56.8260803Z +
2025-11-10T00:08:56.8260975Z      let test_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-10T00:08:56.8261049Z -    
2025-11-10T00:08:56.8261123Z +
2025-11-10T00:08:56.8261233Z      // Ban with expiration in the past
2025-11-10T00:08:56.8261357Z      let past_timestamp = now - 3600; // 1 hour ago
2025-11-10T00:08:56.8261484Z      manager.ban_peer(test_addr, past_timestamp);
2025-11-10T00:08:56.8261807Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:78:
2025-11-10T00:08:56.8261891Z -    
2025-11-10T00:08:56.8261965Z +
2025-11-10T00:08:56.8262123Z      // is_banned should automatically clean up expired bans
2025-11-10T00:08:56.8262247Z      let was_banned = manager.is_banned(test_addr);
2025-11-10T00:08:56.8262431Z      assert!(!was_banned, "Expired ban should be automatically removed");
2025-11-10T00:08:56.8262702Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:82:
2025-11-10T00:08:56.8262773Z -    
2025-11-10T00:08:56.8262832Z +
2025-11-10T00:08:56.8262913Z      // Verify ban was removed
2025-11-10T00:08:56.8263019Z      let banned = manager.get_banned_peers();
2025-11-10T00:08:56.8263164Z -    assert!(!banned.iter().any(|(addr, _)| *addr == test_addr), 
2025-11-10T00:08:56.8263271Z -            "Expired ban should not be in ban list");
2025-11-10T00:08:56.8263340Z +    assert!(
2025-11-10T00:08:56.8263459Z +        !banned.iter().any(|(addr, _)| *addr == test_addr),
2025-11-10T00:08:56.8263561Z +        "Expired ban should not be in ban list"
2025-11-10T00:08:56.8263624Z +    );
2025-11-10T00:08:56.8263689Z  }
2025-11-10T00:08:56.8263749Z  
2025-11-10T00:08:56.8265954Z  #[tokio::test]
2025-11-10T00:08:56.8266589Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:90:
2025-11-10T00:08:56.8266695Z  async fn test_ban_list_permanent() {
2025-11-10T00:08:56.8266824Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-10T00:08:56.8266930Z      let manager = NetworkManager::new(addr);
2025-11-10T00:08:56.8266998Z -    
2025-11-10T00:08:56.8267060Z +
2025-11-10T00:08:56.8267204Z      let test_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-10T00:08:56.8267272Z -    
2025-11-10T00:08:56.8267333Z +
2025-11-10T00:08:56.8267428Z      // Test permanent ban (timestamp = 0)
2025-11-10T00:08:56.8267514Z      manager.ban_peer(test_addr, 0);
2025-11-10T00:08:56.8267711Z -    assert!(manager.is_banned(test_addr), "Permanent ban should be active");
2025-11-10T00:08:56.8267922Z -    
2025-11-10T00:08:56.8268030Z +    assert!(
2025-11-10T00:08:56.8268194Z +        manager.is_banned(test_addr),
2025-11-10T00:08:56.8268352Z +        "Permanent ban should be active"
2025-11-10T00:08:56.8268464Z +    );
2025-11-10T00:08:56.8268568Z +
2025-11-10T00:08:56.8268686Z      // Clean up
2025-11-10T00:08:56.8268827Z      manager.unban_peer(test_addr);
2025-11-10T00:08:56.8269152Z -    assert!(!manager.is_banned(test_addr), "Unbanned peer should not be banned");
2025-11-10T00:08:56.8269268Z +    assert!(
2025-11-10T00:08:56.8269408Z +        !manager.is_banned(test_addr),
2025-11-10T00:08:56.8269558Z +        "Unbanned peer should not be banned"
2025-11-10T00:08:56.8269662Z +    );
2025-11-10T00:08:56.8269772Z  }
2025-11-10T00:08:56.8269873Z  
2025-11-10T00:08:56.8269989Z  #[tokio::test]
2025-11-10T00:08:56.8270464Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:106:
2025-11-10T00:08:56.8270799Z  async fn test_ban_list_temporary() {
2025-11-10T00:08:56.8271002Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-10T00:08:56.8271169Z      let manager = NetworkManager::new(addr);
2025-11-10T00:08:56.8271279Z -    
2025-11-10T00:08:56.8271384Z +
2025-11-10T00:08:56.8272892Z      use std::time::{SystemTime, UNIX_EPOCH};
2025-11-10T00:08:56.8273014Z      let now = SystemTime::now()
2025-11-10T00:08:56.8273104Z          .duration_since(UNIX_EPOCH)
2025-11-10T00:08:56.8275374Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:113:
2025-11-10T00:08:56.8275499Z          .unwrap()
2025-11-10T00:08:56.8275571Z          .as_secs();
2025-11-10T00:08:56.8275640Z -    
2025-11-10T00:08:56.8275706Z +
2025-11-10T00:08:56.8275867Z      let test_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-10T00:08:56.8275933Z -    
2025-11-10T00:08:56.8276053Z +
2025-11-10T00:08:56.8276154Z      // Test temporary ban (1 hour from now)
2025-11-10T00:08:56.8276259Z      let future_timestamp = now + 3600;
2025-11-10T00:08:56.8276376Z      manager.ban_peer(test_addr, future_timestamp);
2025-11-10T00:08:56.8276661Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:121:
2025-11-10T00:08:56.8276879Z -    assert!(manager.is_banned(test_addr), "Active temporary ban should be active");
2025-11-10T00:08:56.8276948Z -    
2025-11-10T00:08:56.8277014Z +    assert!(
2025-11-10T00:08:56.8277109Z +        manager.is_banned(test_addr),
2025-11-10T00:08:56.8277208Z +        "Active temporary ban should be active"
2025-11-10T00:08:56.8277273Z +    );
2025-11-10T00:08:56.8277337Z +
2025-11-10T00:08:56.8277409Z      // Clean up
2025-11-10T00:08:56.8277498Z      manager.unban_peer(test_addr);
2025-11-10T00:08:56.8277561Z  }
2025-11-10T00:08:56.8277841Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:128:
2025-11-10T00:08:56.8277926Z  async fn test_clear_bans() {
2025-11-10T00:08:56.8278052Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-10T00:08:56.8278159Z      let manager = NetworkManager::new(addr);
2025-11-10T00:08:56.8278228Z -    
2025-11-10T00:08:56.8278291Z +
2025-11-10T00:08:56.8278439Z      let test_addr1: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-10T00:08:56.8278590Z      let test_addr2: SocketAddr = "127.0.0.1:8334".parse().unwrap();
2025-11-10T00:08:56.8278657Z -    
2025-11-10T00:08:56.8278720Z +
2025-11-10T00:08:56.8278799Z      // Add multiple bans
2025-11-10T00:08:56.8278896Z      manager.ban_peer(test_addr1, 0);
2025-11-10T00:08:56.8278983Z      manager.ban_peer(test_addr2, 0);
2025-11-10T00:08:56.8279255Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:138:
2025-11-10T00:08:56.8279327Z -    
2025-11-10T00:08:56.8279389Z +
2025-11-10T00:08:56.8279507Z      assert_eq!(manager.get_banned_peers().len(), 2);
2025-11-10T00:08:56.8279578Z -    
2025-11-10T00:08:56.8279645Z +
2025-11-10T00:08:56.8279717Z      // Clear all bans
2025-11-10T00:08:56.8279980Z      manager.clear_bans();
2025-11-10T00:08:56.8280376Z -    
2025-11-10T00:08:56.8280441Z +
2025-11-10T00:08:56.8280554Z      assert_eq!(manager.get_banned_peers().len(), 0);
2025-11-10T00:08:56.8280651Z      assert!(!manager.is_banned(test_addr1));
2025-11-10T00:08:56.8280745Z      assert!(!manager.is_banned(test_addr2));
2025-11-10T00:08:56.8281004Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:147:
2025-11-10T00:08:56.8281066Z  }
2025-11-10T00:08:56.8281132Z -
2025-11-10T00:08:56.8281191Z  
2025-11-10T00:08:56.8281469Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:2:
2025-11-10T00:08:56.8281535Z  
2025-11-10T00:08:56.8281600Z  #[cfg(test)]
2025-11-10T00:08:56.8281665Z  mod tests {
2025-11-10T00:08:56.8281789Z +    use bllvm_node::network::protocol::NetworkAddress;
2025-11-10T00:08:56.8281914Z      use bllvm_node::network::protocol::VersionMessage;
2025-11-10T00:08:56.8282432Z -    use bllvm_node::network::protocol::{NODE_UTXO_COMMITMENTS, NODE_BAN_LIST_SHARING, NODE_PACKAGE_RELAY, NODE_FIBRE};
2025-11-10T00:08:56.8282525Z +    use bllvm_node::network::protocol::{
2025-11-10T00:08:56.8282726Z +        NODE_BAN_LIST_SHARING, NODE_FIBRE, NODE_PACKAGE_RELAY, NODE_UTXO_COMMITMENTS,
2025-11-10T00:08:56.8282791Z +    };
2025-11-10T00:08:56.8282904Z      use bllvm_protocol::bip157::NODE_COMPACT_FILTERS;
2025-11-10T00:08:56.8283020Z -    use bllvm_node::network::protocol::NetworkAddress;
2025-11-10T00:08:56.8283083Z  
2025-11-10T00:08:56.8283233Z      fn create_version_message(services: u64) -> VersionMessage {
2025-11-10T00:08:56.8283307Z          VersionMessage {
2025-11-10T00:08:56.8283810Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:36:
2025-11-10T00:08:56.8284211Z              // Peer with UTXO commitments support
2025-11-10T00:08:56.8284690Z              let services = NODE_UTXO_COMMITMENTS;
2025-11-10T00:08:56.8284938Z              let version = create_version_message(services);
2025-11-10T00:08:56.8285183Z -            assert!(version.supports_utxo_commitments(), "Should support UTXO commitments");
2025-11-10T00:08:56.8285266Z +            assert!(
2025-11-10T00:08:56.8285377Z +                version.supports_utxo_commitments(),
2025-11-10T00:08:56.8285477Z +                "Should support UTXO commitments"
2025-11-10T00:08:56.8287068Z +            );
2025-11-10T00:08:56.8287131Z  
2025-11-10T00:08:56.8287229Z              // Peer without UTXO commitments support
2025-11-10T00:08:56.8287310Z              let services = 0;
2025-11-10T00:08:56.8287606Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:43:
2025-11-10T00:08:56.8287724Z              let version = create_version_message(services);
2025-11-10T00:08:56.8287958Z -            assert!(!version.supports_utxo_commitments(), "Should not support UTXO commitments");
2025-11-10T00:08:56.8288034Z +            assert!(
2025-11-10T00:08:56.8288137Z +                !version.supports_utxo_commitments(),
2025-11-10T00:08:56.8288229Z +                "Should not support UTXO commitments"
2025-11-10T00:08:56.8288297Z +            );
2025-11-10T00:08:56.8288359Z  
2025-11-10T00:08:56.8288489Z              // Peer with multiple flags including UTXO commitments
2025-11-10T00:08:56.8288694Z              let services = NODE_UTXO_COMMITMENTS | NODE_COMPACT_FILTERS | NODE_PACKAGE_RELAY;
2025-11-10T00:08:56.8288988Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:48:
2025-11-10T00:08:56.8289098Z              let version = create_version_message(services);
2025-11-10T00:08:56.8289367Z -            assert!(version.supports_utxo_commitments(), "Should support UTXO commitments with other flags");
2025-11-10T00:08:56.8289598Z -            assert!(version.supports_compact_filters(), "Should also support compact filters");
2025-11-10T00:08:56.8289810Z -            assert!(version.supports_package_relay(), "Should also support package relay");
2025-11-10T00:08:56.8290085Z +            assert!(
2025-11-10T00:08:56.8290190Z +                version.supports_utxo_commitments(),
2025-11-10T00:08:56.8290311Z +                "Should support UTXO commitments with other flags"
2025-11-10T00:08:56.8290373Z +            );
2025-11-10T00:08:56.8290443Z +            assert!(
2025-11-10T00:08:56.8290543Z +                version.supports_compact_filters(),
2025-11-10T00:08:56.8290635Z +                "Should also support compact filters"
2025-11-10T00:08:56.8290697Z +            );
2025-11-10T00:08:56.8290765Z +            assert!(
2025-11-10T00:08:56.8290856Z +                version.supports_package_relay(),
2025-11-10T00:08:56.8290946Z +                "Should also support package relay"
2025-11-10T00:08:56.8291013Z +            );
2025-11-10T00:08:56.8291077Z          }
2025-11-10T00:08:56.8291139Z      }
2025-11-10T00:08:56.8291198Z  
2025-11-10T00:08:56.8291605Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:57:
2025-11-10T00:08:56.8291703Z          // Peer with ban list sharing support
2025-11-10T00:08:56.8291793Z          let services = NODE_BAN_LIST_SHARING;
2025-11-10T00:08:56.8291910Z          let version = create_version_message(services);
2025-11-10T00:08:56.8292120Z -        assert!(version.supports_ban_list_sharing(), "Should support ban list sharing");
2025-11-10T00:08:56.8292184Z +        assert!(
2025-11-10T00:08:56.8292279Z +            version.supports_ban_list_sharing(),
2025-11-10T00:08:56.8292372Z +            "Should support ban list sharing"
2025-11-10T00:08:56.8292432Z +        );
2025-11-10T00:08:56.8292490Z  
2025-11-10T00:08:56.8292584Z          // Peer without ban list sharing support
2025-11-10T00:08:56.8292658Z          let services = 0;
2025-11-10T00:08:56.8292932Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:64:
2025-11-10T00:08:56.8293047Z          let version = create_version_message(services);
2025-11-10T00:08:56.8293267Z -        assert!(!version.supports_ban_list_sharing(), "Should not support ban list sharing");
2025-11-10T00:08:56.8293331Z +        assert!(
2025-11-10T00:08:56.8293426Z +            !version.supports_ban_list_sharing(),
2025-11-10T00:08:56.8293520Z +            "Should not support ban list sharing"
2025-11-10T00:08:56.8293582Z +        );
2025-11-10T00:08:56.8293641Z  
2025-11-10T00:08:56.8293774Z          // Peer with multiple flags including ban list sharing
2025-11-10T00:08:56.8293952Z          let services = NODE_BAN_LIST_SHARING | NODE_COMPACT_FILTERS | NODE_FIBRE;
2025-11-10T00:08:56.8294225Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:69:
2025-11-10T00:08:56.8294594Z          let version = create_version_message(services);
2025-11-10T00:08:56.8294886Z -        assert!(version.supports_ban_list_sharing(), "Should support ban list sharing with other flags");
2025-11-10T00:08:56.8295110Z -        assert!(version.supports_compact_filters(), "Should also support compact filters");
2025-11-10T00:08:56.8295177Z +        assert!(
2025-11-10T00:08:56.8295274Z +            version.supports_ban_list_sharing(),
2025-11-10T00:08:56.8295390Z +            "Should support ban list sharing with other flags"
2025-11-10T00:08:56.8295451Z +        );
2025-11-10T00:08:56.8295517Z +        assert!(
2025-11-10T00:08:56.8295612Z +            version.supports_compact_filters(),
2025-11-10T00:08:56.8295704Z +            "Should also support compact filters"
2025-11-10T00:08:56.8295764Z +        );
2025-11-10T00:08:56.8295927Z          assert!(version.supports_fibre(), "Should also support FIBRE");
2025-11-10T00:08:56.8295987Z      }
2025-11-10T00:08:56.8296062Z  
2025-11-10T00:08:56.8296500Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:77:
2025-11-10T00:08:56.8296644Z          // Peer with compact filters support
2025-11-10T00:08:56.8296789Z          let services = NODE_COMPACT_FILTERS;
2025-11-10T00:08:56.8297078Z          let version = create_version_message(services);
2025-11-10T00:08:56.8297285Z -        assert!(version.supports_compact_filters(), "Should support compact filters");
2025-11-10T00:08:56.8297350Z +        assert!(
2025-11-10T00:08:56.8297443Z +            version.supports_compact_filters(),
2025-11-10T00:08:56.8297535Z +            "Should support compact filters"
2025-11-10T00:08:56.8297596Z +        );
2025-11-10T00:08:56.8297653Z  
2025-11-10T00:08:56.8297749Z          // Peer without compact filters support
2025-11-10T00:08:56.8297821Z          let services = 0;
2025-11-10T00:08:56.8298087Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:84:
2025-11-10T00:08:56.8298191Z          let version = create_version_message(services);
2025-11-10T00:08:56.8298406Z -        assert!(!version.supports_compact_filters(), "Should not support compact filters");
2025-11-10T00:08:56.8298587Z +        assert!(
2025-11-10T00:08:56.8298685Z +            !version.supports_compact_filters(),
2025-11-10T00:08:56.8298777Z +            "Should not support compact filters"
2025-11-10T00:08:56.8298837Z +        );
2025-11-10T00:08:56.8298896Z      }
2025-11-10T00:08:56.8298957Z  
2025-11-10T00:08:56.8299020Z      #[test]
2025-11-10T00:08:56.8299288Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:90:
2025-11-10T00:08:56.8299377Z          // Peer with package relay support
2025-11-10T00:08:56.8299469Z          let services = NODE_PACKAGE_RELAY;
2025-11-10T00:08:56.8299571Z          let version = create_version_message(services);
2025-11-10T00:08:56.8299766Z -        assert!(version.supports_package_relay(), "Should support package relay");
2025-11-10T00:08:56.8299833Z +        assert!(
2025-11-10T00:08:56.8299932Z +            version.supports_package_relay(),
2025-11-10T00:08:56.8300017Z +            "Should support package relay"
2025-11-10T00:08:56.8300081Z +        );
2025-11-10T00:08:56.8300149Z  
2025-11-10T00:08:56.8300237Z          // Peer without package relay support
2025-11-10T00:08:56.8300307Z          let services = 0;
2025-11-10T00:08:56.8300578Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:97:
2025-11-10T00:08:56.8300681Z          let version = create_version_message(services);
2025-11-10T00:08:56.8300880Z -        assert!(!version.supports_package_relay(), "Should not support package relay");
2025-11-10T00:08:56.8300956Z +        assert!(
2025-11-10T00:08:56.8301065Z +            !version.supports_package_relay(),
2025-11-10T00:08:56.8301154Z +            "Should not support package relay"
2025-11-10T00:08:56.8301217Z +        );
2025-11-10T00:08:56.8301286Z      }
2025-11-10T00:08:56.8301347Z  
2025-11-10T00:08:56.8301411Z      #[test]
2025-11-10T00:08:56.8301702Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:115:
2025-11-10T00:08:56.8301789Z      fn test_multiple_flags() {
2025-11-10T00:08:56.8301868Z          // Peer with all flags
2025-11-10T00:08:56.8301964Z          #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.8302194Z -        let services = NODE_UTXO_COMMITMENTS | NODE_BAN_LIST_SHARING | NODE_COMPACT_FILTERS | 
2025-11-10T00:08:56.8302294Z -                      NODE_PACKAGE_RELAY | NODE_FIBRE;
2025-11-10T00:08:56.8302389Z +        let services = NODE_UTXO_COMMITMENTS
2025-11-10T00:08:56.8302475Z +            | NODE_BAN_LIST_SHARING
2025-11-10T00:08:56.8302552Z +            | NODE_COMPACT_FILTERS
2025-11-10T00:08:56.8302627Z +            | NODE_PACKAGE_RELAY
2025-11-10T00:08:56.8302701Z +            | NODE_FIBRE;
2025-11-10T00:08:56.8302805Z          #[cfg(not(feature = "utxo-commitments"))]
2025-11-10T00:08:56.8302959Z -        let services = NODE_BAN_LIST_SHARING | NODE_COMPACT_FILTERS | 
2025-11-10T00:08:56.8303052Z -                      NODE_PACKAGE_RELAY | NODE_FIBRE;
2025-11-10T00:08:56.8303131Z +        let services =
2025-11-10T00:08:56.8303328Z +            NODE_BAN_LIST_SHARING | NODE_COMPACT_FILTERS | NODE_PACKAGE_RELAY | NODE_FIBRE;
2025-11-10T00:08:56.8303540Z          let version = create_version_message(services);
2025-11-10T00:08:56.8303609Z -        
2025-11-10T00:08:56.8303669Z +
2025-11-10T00:08:56.8303757Z          #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.8303970Z -        assert!(version.supports_utxo_commitments(), "Should support UTXO commitments");
2025-11-10T00:08:56.8304180Z -        assert!(version.supports_ban_list_sharing(), "Should support ban list sharing");
2025-11-10T00:08:56.8304535Z -        assert!(version.supports_compact_filters(), "Should support compact filters");
2025-11-10T00:08:56.8304735Z -        assert!(version.supports_package_relay(), "Should support package relay");
2025-11-10T00:08:56.8304808Z +        assert!(
2025-11-10T00:08:56.8304907Z +            version.supports_utxo_commitments(),
2025-11-10T00:08:56.8304999Z +            "Should support UTXO commitments"
2025-11-10T00:08:56.8305194Z +        );
2025-11-10T00:08:56.8305263Z +        assert!(
2025-11-10T00:08:56.8305357Z +            version.supports_ban_list_sharing(),
2025-11-10T00:08:56.8305443Z +            "Should support ban list sharing"
2025-11-10T00:08:56.8305510Z +        );
2025-11-10T00:08:56.8305576Z +        assert!(
2025-11-10T00:08:56.8305674Z +            version.supports_compact_filters(),
2025-11-10T00:08:56.8305765Z +            "Should support compact filters"
2025-11-10T00:08:56.8305824Z +        );
2025-11-10T00:08:56.8305890Z +        assert!(
2025-11-10T00:08:56.8305980Z +            version.supports_package_relay(),
2025-11-10T00:08:56.8306075Z +            "Should support package relay"
2025-11-10T00:08:56.8306139Z +        );
2025-11-10T00:08:56.8306283Z          assert!(version.supports_fibre(), "Should support FIBRE");
2025-11-10T00:08:56.8306352Z      }
2025-11-10T00:08:56.8306411Z  
2025-11-10T00:08:56.8306698Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:137:
2025-11-10T00:08:56.8306767Z          {
2025-11-10T00:08:56.8306868Z              let services = NODE_UTXO_COMMITMENTS;
2025-11-10T00:08:56.8306983Z              let version = create_version_message(services);
2025-11-10T00:08:56.8307044Z -            
2025-11-10T00:08:56.8307268Z -            assert!(version.supports_utxo_commitments(), "Should support UTXO commitments");
2025-11-10T00:08:56.8307488Z -            assert!(!version.supports_ban_list_sharing(), "Should not support ban list sharing");
2025-11-10T00:08:56.8307702Z -            assert!(!version.supports_compact_filters(), "Should not support compact filters");
2025-11-10T00:08:56.8307769Z +
2025-11-10T00:08:56.8307835Z +            assert!(
2025-11-10T00:08:56.8307938Z +                version.supports_utxo_commitments(),
2025-11-10T00:08:56.8308034Z +                "Should support UTXO commitments"
2025-11-10T00:08:56.8308100Z +            );
2025-11-10T00:08:56.8308166Z +            assert!(
2025-11-10T00:08:56.8308266Z +                !version.supports_ban_list_sharing(),
2025-11-10T00:08:56.8308367Z +                "Should not support ban list sharing"
2025-11-10T00:08:56.8308428Z +            );
2025-11-10T00:08:56.8308489Z +            assert!(
2025-11-10T00:08:56.8308585Z +                !version.supports_compact_filters(),
2025-11-10T00:08:56.8308679Z +                "Should not support compact filters"
2025-11-10T00:08:56.8308740Z +            );
2025-11-10T00:08:56.8308802Z          }
2025-11-10T00:08:56.8308868Z      }
2025-11-10T00:08:56.8308926Z  
2025-11-10T00:08:56.8309213Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:149:
2025-11-10T00:08:56.8309473Z          // Verify bit positions don't overlap
2025-11-10T00:08:56.8309574Z          #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.8309635Z          {
2025-11-10T00:08:56.8309832Z -            assert_eq!(NODE_UTXO_COMMITMENTS, 1 << 27, "UTXO commitments should be bit 27");
2025-11-10T00:08:56.8309915Z +            assert_eq!(
2025-11-10T00:08:56.8310131Z +                NODE_UTXO_COMMITMENTS,
2025-11-10T00:08:56.8310198Z +                1 << 27,
2025-11-10T00:08:56.8310297Z +                "UTXO commitments should be bit 27"
2025-11-10T00:08:56.8310357Z +            );
2025-11-10T00:08:56.8310417Z          }
2025-11-10T00:08:56.8310599Z -        assert_eq!(NODE_BAN_LIST_SHARING, 1 << 28, "Ban list sharing should be bit 28");
2025-11-10T00:08:56.8310781Z -        assert_eq!(NODE_PACKAGE_RELAY, 1 << 25, "Package relay should be bit 25");
2025-11-10T00:08:56.8310848Z +        assert_eq!(
2025-11-10T00:08:56.8310929Z +            NODE_BAN_LIST_SHARING,
2025-11-10T00:08:56.8310994Z +            1 << 28,
2025-11-10T00:08:56.8311094Z +            "Ban list sharing should be bit 28"
2025-11-10T00:08:56.8311155Z +        );
2025-11-10T00:08:56.8311221Z +        assert_eq!(
2025-11-10T00:08:56.8311304Z +            NODE_PACKAGE_RELAY,
2025-11-10T00:08:56.8311366Z +            1 << 25,
2025-11-10T00:08:56.8311546Z +            "Package relay should be bit 25"
2025-11-10T00:08:56.8311613Z +        );
2025-11-10T00:08:56.8311752Z          assert_eq!(NODE_FIBRE, 1 << 26, "FIBRE should be bit 26");
2025-11-10T00:08:56.8311814Z -        
2025-11-10T00:08:56.8311874Z +
2025-11-10T00:08:56.8311952Z          // Verify no overlap
2025-11-10T00:08:56.8312040Z          #[cfg(feature = "utxo-commitments")]
2025-11-10T00:08:56.8312100Z          {
2025-11-10T00:08:56.8312384Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:161:
2025-11-10T00:08:56.8312608Z -            assert_eq!(NODE_UTXO_COMMITMENTS & NODE_BAN_LIST_SHARING, 0, "Flags should not overlap");
2025-11-10T00:08:56.8312818Z -            assert_eq!(NODE_UTXO_COMMITMENTS & NODE_PACKAGE_RELAY, 0, "Flags should not overlap");
2025-11-10T00:08:56.8313008Z -            assert_eq!(NODE_UTXO_COMMITMENTS & NODE_FIBRE, 0, "Flags should not overlap");
2025-11-10T00:08:56.8313086Z +            assert_eq!(
2025-11-10T00:08:56.8313205Z +                NODE_UTXO_COMMITMENTS & NODE_BAN_LIST_SHARING,
2025-11-10T00:08:56.8313272Z +                0,
2025-11-10T00:08:56.8313362Z +                "Flags should not overlap"
2025-11-10T00:08:56.8313422Z +            );
2025-11-10T00:08:56.8313490Z +            assert_eq!(
2025-11-10T00:08:56.8313596Z +                NODE_UTXO_COMMITMENTS & NODE_PACKAGE_RELAY,
2025-11-10T00:08:56.8313665Z +                0,
2025-11-10T00:08:56.8313746Z +                "Flags should not overlap"
2025-11-10T00:08:56.8313806Z +            );
2025-11-10T00:08:56.8313879Z +            assert_eq!(
2025-11-10T00:08:56.8313973Z +                NODE_UTXO_COMMITMENTS & NODE_FIBRE,
2025-11-10T00:08:56.8314035Z +                0,
2025-11-10T00:08:56.8314117Z +                "Flags should not overlap"
2025-11-10T00:08:56.8314184Z +            );
2025-11-10T00:08:56.8314245Z          }
2025-11-10T00:08:56.8314570Z -        assert_eq!(NODE_BAN_LIST_SHARING & NODE_PACKAGE_RELAY, 0, "Flags should not overlap");
2025-11-10T00:08:56.8314764Z -        assert_eq!(NODE_BAN_LIST_SHARING & NODE_FIBRE, 0, "Flags should not overlap");
2025-11-10T00:08:56.8314945Z -        assert_eq!(NODE_PACKAGE_RELAY & NODE_FIBRE, 0, "Flags should not overlap");
2025-11-10T00:08:56.8315011Z +        assert_eq!(
2025-11-10T00:08:56.8315116Z +            NODE_BAN_LIST_SHARING & NODE_PACKAGE_RELAY,
2025-11-10T00:08:56.8315183Z +            0,
2025-11-10T00:08:56.8315264Z +            "Flags should not overlap"
2025-11-10T00:08:56.8315323Z +        );
2025-11-10T00:08:56.8315392Z +        assert_eq!(
2025-11-10T00:08:56.8315479Z +            NODE_BAN_LIST_SHARING & NODE_FIBRE,
2025-11-10T00:08:56.8315539Z +            0,
2025-11-10T00:08:56.8315616Z +            "Flags should not overlap"
2025-11-10T00:08:56.8315681Z +        );
2025-11-10T00:08:56.8315746Z +        assert_eq!(
2025-11-10T00:08:56.8315836Z +            NODE_PACKAGE_RELAY & NODE_FIBRE,
2025-11-10T00:08:56.8315899Z +            0,
2025-11-10T00:08:56.8315977Z +            "Flags should not overlap"
2025-11-10T00:08:56.8316201Z +        );
2025-11-10T00:08:56.8316260Z      }
2025-11-10T00:08:56.8316326Z  }
2025-11-10T00:08:56.8316385Z -
2025-11-10T00:08:56.8316442Z  
2025-11-10T00:08:56.8316753Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/storage_arcs_tests.rs:1:
2025-11-10T00:08:56.8316844Z  //! Tests for Storage Arc refactoring
2025-11-10T00:08:56.8316904Z  
2025-11-10T00:08:56.8317001Z -use bllvm_node::storage::Storage;
2025-11-10T00:08:56.8317138Z  use bllvm_node::network::chain_access::NodeChainAccess;
2025-11-10T00:08:56.8317246Z  use bllvm_node::node::mempool::MempoolManager;
2025-11-10T00:08:56.8317335Z +use bllvm_node::storage::Storage;
2025-11-10T00:08:56.8317406Z  use std::sync::Arc;
2025-11-10T00:08:56.8317482Z  use tempfile::TempDir;
2025-11-10T00:08:56.8317541Z  
2025-11-10T00:08:56.8317822Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/storage_arcs_tests.rs:10:
2025-11-10T00:08:56.8317905Z  fn test_storage_returns_arcs() {
2025-11-10T00:08:56.8318122Z      let temp_dir = TempDir::new().unwrap();
2025-11-10T00:08:56.8318259Z      let storage = Storage::new(temp_dir.path()).unwrap();
2025-11-10T00:08:56.8318320Z -    
2025-11-10T00:08:56.8318378Z +
2025-11-10T00:08:56.8318458Z      // Verify blocks() returns Arc
2025-11-10T00:08:56.8318546Z      let blocks_arc = storage.blocks();
2025-11-10T00:08:56.8318632Z      let blocks_arc2 = storage.blocks();
2025-11-10T00:08:56.8318899Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/storage_arcs_tests.rs:17:
2025-11-10T00:08:56.8318964Z -    
2025-11-10T00:08:56.8319022Z +
2025-11-10T00:08:56.8319113Z      // Both should be valid Arcs (can clone)
2025-11-10T00:08:56.8319315Z      assert!(Arc::ptr_eq(&blocks_arc, &blocks_arc2) || blocks_arc.block_count().is_ok());
2025-11-10T00:08:56.8319423Z -    
2025-11-10T00:08:56.8319528Z +
2025-11-10T00:08:56.8319681Z      // Verify transactions() returns Arc
2025-11-10T00:08:56.8319842Z      let tx_arc = storage.transactions();
2025-11-10T00:08:56.8320006Z      let tx_arc2 = storage.transactions();
2025-11-10T00:08:56.8320339Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/storage_arcs_tests.rs:24:
2025-11-10T00:08:56.8320405Z -    
2025-11-10T00:08:56.8320468Z +
2025-11-10T00:08:56.8320654Z      assert!(Arc::ptr_eq(&tx_arc, &tx_arc2) || tx_arc.has_transaction(&[0u8; 32]).is_ok());
2025-11-10T00:08:56.8320715Z  }
2025-11-10T00:08:56.8320779Z  
2025-11-10T00:08:56.8321045Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/storage_arcs_tests.rs:30:
2025-11-10T00:08:56.8321139Z      let temp_dir = TempDir::new().unwrap();
2025-11-10T00:08:56.8321267Z      let storage = Storage::new(temp_dir.path()).unwrap();
2025-11-10T00:08:56.8321374Z      let mempool = Arc::new(MempoolManager::new());
2025-11-10T00:08:56.8321434Z -    
2025-11-10T00:08:56.8321497Z +
2025-11-10T00:08:56.8321651Z      // Should be able to create NodeChainAccess with Arcs from Storage
2025-11-10T00:08:56.8321753Z -    let chain_access = NodeChainAccess::new(
2025-11-10T00:08:56.8321835Z -        storage.blocks(),
2025-11-10T00:08:56.8321921Z -        storage.transactions(),
2025-11-10T00:08:56.8321986Z -        mempool,
2025-11-10T00:08:56.8322047Z -    );
2025-11-10T00:08:56.8322111Z -    
2025-11-10T00:08:56.8322353Z +    let chain_access = NodeChainAccess::new(storage.blocks(), storage.transactions(), mempool);
2025-11-10T00:08:56.8322414Z +
2025-11-10T00:08:56.8322485Z      // Verify it works
2025-11-10T00:08:56.8322563Z      let hash = [0u8; 32];
2025-11-10T00:08:56.8322673Z      let has_object = chain_access.has_object(&hash);
2025-11-10T00:08:56.8322937Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/storage_arcs_tests.rs:44:
2025-11-10T00:08:56.8323078Z      assert!(!has_object); // Empty storage, so should be false
2025-11-10T00:08:56.8323140Z  }
2025-11-10T00:08:56.8323198Z -
2025-11-10T00:08:56.8323256Z  
2025-11-10T00:08:56.8323497Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:1:
2025-11-10T00:08:56.8323741Z -use bllvm_protocol::ProtocolVersion;
2025-11-10T00:08:56.8323876Z  use bllvm_node::storage::blockstore::BlockStore;
2025-11-10T00:08:56.8323987Z  use bllvm_node::storage::chainstate::ChainState;
2025-11-10T00:08:56.8324081Z  use bllvm_node::storage::txindex::TxIndex;
2025-11-10T00:08:56.8326064Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:9:
2025-11-10T00:08:56.8326156Z  use bllvm_node::OutPoint;
2025-11-10T00:08:56.8326237Z  use bllvm_node::Transaction;
2025-11-10T00:08:56.8326408Z  use bllvm_node::{ByteString, TransactionInput, TransactionOutput};
2025-11-10T00:08:56.8326508Z +use bllvm_protocol::ProtocolVersion;
2025-11-10T00:08:56.8326591Z  use std::collections::HashMap;
2025-11-10T00:08:56.8326668Z  use tempfile::TempDir;
2025-11-10T00:08:56.8326727Z  
2025-11-10T00:08:56.8370507Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/storage_tests.rs:4:
2025-11-10T00:08:56.8370817Z  use bllvm_node::storage::*;
2025-11-10T00:08:56.8370905Z  use tempfile::TempDir;
2025-11-10T00:08:56.8370978Z  mod common;
2025-11-10T00:08:56.8371050Z -use common::*;
2025-11-10T00:08:56.8371172Z  use bllvm_node::storage::blockstore::BlockStore;
2025-11-10T00:08:56.8371284Z  use bllvm_node::storage::chainstate::ChainState;
2025-11-10T00:08:56.8371379Z  use bllvm_node::storage::txindex::TxIndex;
2025-11-10T00:08:56.8371657Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/storage_tests.rs:11:
2025-11-10T00:08:56.8371774Z  use bllvm_node::storage::utxostore::UtxoStore;
2025-11-10T00:08:56.8371852Z +use common::*;
2025-11-10T00:08:56.8371914Z  
2025-11-10T00:08:56.8371979Z  #[test]
2025-11-10T00:08:56.8372070Z  fn test_storage_creation() {
2025-11-10T00:08:56.8395518Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:1:
2025-11-10T00:08:56.8395696Z -use bllvm_protocol::ProtocolVersion;
2025-11-10T00:08:56.8397556Z  use bllvm_node::storage::blockstore::BlockStore;
2025-11-10T00:08:56.8397814Z  use bllvm_node::storage::chainstate::ChainState;
2025-11-10T00:08:56.8398025Z  use bllvm_node::storage::txindex::TxIndex;
2025-11-10T00:08:56.8398346Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:9:
2025-11-10T00:08:56.8398454Z  use bllvm_node::OutPoint;
2025-11-10T00:08:56.8398570Z  use bllvm_node::Transaction;
2025-11-10T00:08:56.8398789Z  use bllvm_node::{ByteString, TransactionInput, TransactionOutput};
2025-11-10T00:08:56.8398916Z +use bllvm_protocol::ProtocolVersion;
2025-11-10T00:08:56.8399029Z  use std::collections::HashMap;
2025-11-10T00:08:56.8399187Z  use tempfile::TempDir;
2025-11-10T00:08:56.8399324Z  
2025-11-10T00:08:56.8400013Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/stratum_v2_mining_tests.rs:1:
2025-11-10T00:08:56.8400192Z  //! Unit tests for Stratum V2 mining and share validation
2025-11-10T00:08:56.8400273Z  
2025-11-10T00:08:56.8400480Z -use bllvm_protocol::types::{Block, BlockHeader, Hash, Natural};
2025-11-10T00:08:56.8400663Z  use bllvm_node::network::stratum_v2::messages::ShareData;
2025-11-10T00:08:56.8400872Z  use bllvm_node::network::stratum_v2::pool::{JobInfo, StratumV2Pool};
2025-11-10T00:08:56.8401060Z +use bllvm_protocol::types::{Block, BlockHeader, Hash, Natural};
2025-11-10T00:08:56.8401171Z  use tempfile::TempDir;
2025-11-10T00:08:56.8401258Z  mod common;
2025-11-10T00:08:56.8401345Z  use common::*;
2025-11-10T00:08:56.8480284Z ##[error]Process completed with exit code 1.
