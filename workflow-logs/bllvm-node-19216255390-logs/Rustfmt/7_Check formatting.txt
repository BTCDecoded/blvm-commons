2025-11-09T23:42:54.1899385Z ##[group]Run cargo fmt -- --check
2025-11-09T23:42:54.1899694Z [36;1mcargo fmt -- --check[0m
2025-11-09T23:42:54.1935363Z shell: /usr/bin/bash -e {0}
2025-11-09T23:42:54.1937508Z env:
2025-11-09T23:42:54.1937690Z   CARGO_TERM_COLOR: always
2025-11-09T23:42:54.1937937Z   CARGO_HOME: /home/jswift/.cargo
2025-11-09T23:42:54.1938177Z   CARGO_INCREMENTAL: 0
2025-11-09T23:42:54.1938387Z ##[endgroup]
2025-11-09T23:42:54.4944062Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:332:
2025-11-09T23:42:54.4946525Z  pub enum PruningMode {
2025-11-09T23:42:54.4946995Z      /// No pruning (keep all blocks)
2025-11-09T23:42:54.4947430Z      Disabled,
2025-11-09T23:42:54.4947743Z -    
2025-11-09T23:42:54.4948023Z +
2025-11-09T23:42:54.4948419Z      /// Normal pruning (keep recent blocks for verification)
2025-11-09T23:42:54.4948937Z      Normal {
2025-11-09T23:42:54.4949293Z          /// Keep blocks from this height onwards
2025-11-09T23:42:54.4950074Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:342:
2025-11-09T23:42:54.4950936Z          #[serde(default = "default_min_recent_blocks")]
2025-11-09T23:42:54.4951449Z          min_recent_blocks: u64,
2025-11-09T23:42:54.4951842Z      },
2025-11-09T23:42:54.4952106Z -    
2025-11-09T23:42:54.4952364Z +
2025-11-09T23:42:54.4952664Z      /// Aggressive pruning with UTXO commitments
2025-11-09T23:42:54.4953177Z      /// Requires: utxo-commitments feature enabled
2025-11-09T23:42:54.4953625Z      Aggressive {
2025-11-09T23:42:54.4957966Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:359:
2025-11-09T23:42:54.4958859Z          #[serde(default = "default_min_blocks")]
2025-11-09T23:42:54.4959351Z          min_blocks: u64,
2025-11-09T23:42:54.4959701Z      },
2025-11-09T23:42:54.4959982Z -    
2025-11-09T23:42:54.4960260Z +
2025-11-09T23:42:54.4960565Z      /// Custom pruning configuration
2025-11-09T23:42:54.4960995Z      Custom {
2025-11-09T23:42:54.4961460Z          /// Keep block headers (always required for PoW verification)
2025-11-09T23:42:54.4962478Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:408:
2025-11-09T23:42:54.4963223Z      /// Pruning mode
2025-11-09T23:42:54.4963613Z      #[serde(default = "default_pruning_mode")]
2025-11-09T23:42:54.4964089Z      pub mode: PruningMode,
2025-11-09T23:42:54.4966700Z -    
2025-11-09T23:42:54.4967984Z +
2025-11-09T23:42:54.4968421Z      /// Automatic pruning (prune periodically as chain grows)
2025-11-09T23:42:54.4969009Z      #[serde(default = "default_false")]
2025-11-09T23:42:54.4969820Z      pub auto_prune: bool,
2025-11-09T23:42:54.4970517Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:415:
2025-11-09T23:42:54.4971255Z -    
2025-11-09T23:42:54.4971536Z +
2025-11-09T23:42:54.4971857Z      /// Automatic pruning interval (blocks)
2025-11-09T23:42:54.4972367Z      /// Prune every N blocks if auto_prune is enabled
2025-11-09T23:42:54.4988556Z      #[serde(default = "default_auto_prune_interval")]
2025-11-09T23:42:54.4989418Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:419:
2025-11-09T23:42:54.4990215Z      pub auto_prune_interval: u64,
2025-11-09T23:42:54.4990618Z -    
2025-11-09T23:42:54.4990898Z +
2025-11-09T23:42:54.4991218Z      /// Minimum blocks to keep (safety margin)
2025-11-09T23:42:54.4991825Z      /// Even with aggressive pruning, keep at least this many blocks
2025-11-09T23:42:54.4992476Z      #[serde(default = "default_min_blocks_to_keep")]
2025-11-09T23:42:54.4993259Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:424:
2025-11-09T23:42:54.4993991Z      pub min_blocks_to_keep: u64,
2025-11-09T23:42:54.4995948Z -    
2025-11-09T23:42:54.4996278Z +
2025-11-09T23:42:54.4997520Z      /// Prune on startup (prune old blocks when node starts)
2025-11-09T23:42:54.4998075Z      #[serde(default = "default_false")]
2025-11-09T23:42:54.4998523Z      pub prune_on_startup: bool,
2025-11-09T23:42:54.4999615Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:429:
2025-11-09T23:42:54.5002365Z -    
2025-11-09T23:42:54.5014871Z +
2025-11-09T23:42:54.5015510Z      /// Allow incremental pruning during IBD (requires UTXO commitments + aggressive mode)
2025-11-09T23:42:54.5016499Z      /// When enabled, old blocks are pruned incrementally during sync, keeping only a window
2025-11-09T23:42:54.5017509Z      /// of recent blocks. This prevents the need to download the full blockchain before pruning.
2025-11-09T23:42:54.5018521Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:433:
2025-11-09T23:42:54.5019298Z      #[serde(default = "default_false")]
2025-11-09T23:42:54.5019770Z      pub incremental_prune_during_ibd: bool,
2025-11-09T23:42:54.5020192Z -    
2025-11-09T23:42:54.5020469Z +
2025-11-09T23:42:54.5020967Z      /// Block window size for incremental pruning (number of recent blocks to keep)
2025-11-09T23:42:54.5021721Z      /// Only used when incremental_prune_during_ibd is true
2025-11-09T23:42:54.5024008Z      #[serde(default = "default_prune_window_size")]
2025-11-09T23:42:54.5025729Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:439:
2025-11-09T23:42:54.5026504Z      pub prune_window_size: u64,
2025-11-09T23:42:54.5026899Z -    
2025-11-09T23:42:54.5027168Z +
2025-11-09T23:42:54.5027602Z      /// Minimum blocks before starting incremental pruning during IBD
2025-11-09T23:42:54.5028262Z      /// Prevents pruning too early in the sync process
2025-11-09T23:42:54.5028882Z      #[serde(default = "default_min_blocks_for_incremental_prune")]
2025-11-09T23:42:54.5029765Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:444:
2025-11-09T23:42:54.5030546Z      pub min_blocks_for_incremental_prune: u64,
2025-11-09T23:42:54.5030994Z -    
2025-11-09T23:42:54.5031255Z +
2025-11-09T23:42:54.5031547Z      /// UTXO commitments integration
2025-11-09T23:42:54.5032010Z      #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.5032599Z      pub utxo_commitments: Option<UtxoCommitmentsPruningConfig>,
2025-11-09T23:42:54.5033485Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:449:
2025-11-09T23:42:54.5034216Z -    
2025-11-09T23:42:54.5035103Z +
2025-11-09T23:42:54.5035421Z      /// BIP158 filter integration
2025-11-09T23:42:54.5035837Z      #[cfg(feature = "bip158")]
2025-11-09T23:42:54.5036303Z      pub bip158_filters: Option<Bip158PruningConfig>,
2025-11-09T23:42:54.5037416Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:486:
2025-11-09T23:42:54.5038202Z                  keep_filtered_blocks: false,
2025-11-09T23:42:54.5038676Z                  min_blocks: 144, // ~1 day at 10 min/block
2025-11-09T23:42:54.5039360Z              },
2025-11-09T23:42:54.5039754Z -            auto_prune: true, // Enable automatic pruning
2025-11-09T23:42:54.5040353Z +            auto_prune: true,         // Enable automatic pruning
2025-11-09T23:42:54.5040952Z              auto_prune_interval: 144, // Prune every ~1 day
2025-11-09T23:42:54.5041466Z              min_blocks_to_keep: 144,
2025-11-09T23:42:54.5041958Z -            prune_on_startup: false, // Still false for safety
2025-11-09T23:42:54.5042708Z -            incremental_prune_during_ibd: true, // Enable incremental pruning during IBD
2025-11-09T23:42:54.5043550Z -            prune_window_size: 144, // Keep sliding window of 144 blocks during IBD
2025-11-09T23:42:54.5063220Z +            prune_on_startup: false,               // Still false for safety
2025-11-09T23:42:54.5066249Z +            incremental_prune_during_ibd: true,    // Enable incremental pruning during IBD
2025-11-09T23:42:54.5067147Z +            prune_window_size: 144,                // Keep sliding window of 144 blocks during IBD
2025-11-09T23:42:54.5071580Z              min_blocks_for_incremental_prune: 288, // Start pruning after 288 blocks (~2 days)
2025-11-09T23:42:54.5072728Z              #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.5073205Z              utxo_commitments: None,
2025-11-09T23:42:54.5073946Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:508:
2025-11-09T23:42:54.5079243Z      /// Keep UTXO commitments for pruned blocks
2025-11-09T23:42:54.5079792Z      #[serde(default = "default_true")]
2025-11-09T23:42:54.5080228Z      pub keep_commitments: bool,
2025-11-09T23:42:54.5080607Z -    
2025-11-09T23:42:54.5080862Z +
2025-11-09T23:42:54.5081240Z      /// Keep filtered blocks (spam-filtered) for pruned range
2025-11-09T23:42:54.5081780Z      #[serde(default = "default_false")]
2025-11-09T23:42:54.5082230Z      pub keep_filtered_blocks: bool,
2025-11-09T23:42:54.5082946Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:515:
2025-11-09T23:42:54.5083639Z -    
2025-11-09T23:42:54.5083898Z +
2025-11-09T23:42:54.5084474Z      /// Generate commitments before pruning (if not already generated)
2025-11-09T23:42:54.5085626Z      #[serde(default = "default_true")]
2025-11-09T23:42:54.5086066Z      pub generate_before_prune: bool,
2025-11-09T23:42:54.5086788Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:519:
2025-11-09T23:42:54.5087483Z -    
2025-11-09T23:42:54.5087730Z +
2025-11-09T23:42:54.5088094Z      /// Maximum age for commitments (days, 0 = keep forever)
2025-11-09T23:42:54.5088651Z      #[serde(default = "default_commitment_max_age")]
2025-11-09T23:42:54.5089141Z      pub max_commitment_age_days: u32,
2025-11-09T23:42:54.5089850Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:546:
2025-11-09T23:42:54.5090757Z      /// Keep BIP158 filters for pruned blocks
2025-11-09T23:42:54.5091221Z      #[serde(default = "default_true")]
2025-11-09T23:42:54.5091632Z      pub keep_filters: bool,
2025-11-09T23:42:54.5091986Z -    
2025-11-09T23:42:54.5092242Z +
2025-11-09T23:42:54.5092628Z      /// Keep filter header chain (always required for verification)
2025-11-09T23:42:54.5093211Z      #[serde(default = "default_true")]
2025-11-09T23:42:54.5094113Z      pub keep_filter_headers: bool,
2025-11-09T23:42:54.5095713Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:553:
2025-11-09T23:42:54.5096455Z -    
2025-11-09T23:42:54.5096719Z +
2025-11-09T23:42:54.5097052Z      /// Maximum age for filters (days, 0 = keep forever)
2025-11-09T23:42:54.5097589Z      #[serde(default = "default_filter_max_age")]
2025-11-09T23:42:54.5098071Z      pub max_filter_age_days: u32,
2025-11-09T23:42:54.5099595Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:578:
2025-11-09T23:42:54.5100377Z      /// Database backend selection
2025-11-09T23:42:54.5100851Z      #[serde(default = "default_database_backend")]
2025-11-09T23:42:54.5101479Z      pub database_backend: DatabaseBackendConfig,
2025-11-09T23:42:54.5101947Z -    
2025-11-09T23:42:54.5102215Z +
2025-11-09T23:42:54.5102498Z      /// Storage path
2025-11-09T23:42:54.5102882Z      #[serde(default = "default_storage_path")]
2025-11-09T23:42:54.5103341Z      pub data_dir: String,
2025-11-09T23:42:54.5104112Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:585:
2025-11-09T23:42:54.5104995Z -    
2025-11-09T23:42:54.5105257Z +
2025-11-09T23:42:54.5105544Z      /// Pruning configuration
2025-11-09T23:42:54.5105961Z      pub pruning: Option<PruningConfig>,
2025-11-09T23:42:54.5106402Z -    
2025-11-09T23:42:54.5106665Z +
2025-11-09T23:42:54.5106948Z      /// Cache sizes
2025-11-09T23:42:54.5107315Z      pub cache: Option<StorageCacheConfig>,
2025-11-09T23:42:54.5107751Z  }
2025-11-09T23:42:54.5108345Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:616:
2025-11-09T23:42:54.5109091Z      /// Block cache size (MB)
2025-11-09T23:42:54.5109525Z      #[serde(default = "default_block_cache_mb")]
2025-11-09T23:42:54.5110005Z      pub block_cache_mb: usize,
2025-11-09T23:42:54.5110657Z -    
2025-11-09T23:42:54.5110921Z +
2025-11-09T23:42:54.5111210Z      /// UTXO cache size (MB)
2025-11-09T23:42:54.5111626Z      #[serde(default = "default_utxo_cache_mb")]
2025-11-09T23:42:54.5112108Z      pub utxo_cache_mb: usize,
2025-11-09T23:42:54.5112789Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:623:
2025-11-09T23:42:54.5113519Z -    
2025-11-09T23:42:54.5114003Z +
2025-11-09T23:42:54.5114277Z      /// Header cache size (MB)
2025-11-09T23:42:54.5114849Z      #[serde(default = "default_header_cache_mb")]
2025-11-09T23:42:54.5115354Z      pub header_cache_mb: usize,
2025-11-09T23:42:54.5116059Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:668:
2025-11-09T23:42:54.5116804Z                  pruning.validate()?;
2025-11-09T23:42:54.5117200Z              }
2025-11-09T23:42:54.5117480Z          }
2025-11-09T23:42:54.5117743Z -        
2025-11-09T23:42:54.5117999Z +
2025-11-09T23:42:54.5118258Z          Ok(())
2025-11-09T23:42:54.5118524Z      }
2025-11-09T23:42:54.5118781Z  }
2025-11-09T23:42:54.5119360Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:686:
2025-11-09T23:42:54.5120043Z                  ));
2025-11-09T23:42:54.5120324Z              }
2025-11-09T23:42:54.5120574Z          }
2025-11-09T23:42:54.5120879Z -        
2025-11-09T23:42:54.5121128Z +
2025-11-09T23:42:54.5121417Z          // Validate min_blocks_to_keep is reasonable
2025-11-09T23:42:54.5121867Z          if self.min_blocks_to_keep == 0 {
2025-11-09T23:42:54.5126664Z              return Err(anyhow::anyhow!(
2025-11-09T23:42:54.5127411Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:693:
2025-11-09T23:42:54.5128281Z                  "min_blocks_to_keep must be greater than 0 for safety"
2025-11-09T23:42:54.5128802Z              ));
2025-11-09T23:42:54.5129118Z          }
2025-11-09T23:42:54.5129383Z -        
2025-11-09T23:42:54.5129677Z +
2025-11-09T23:42:54.5129980Z          // Validate auto_prune_interval
2025-11-09T23:42:54.5130511Z          if self.auto_prune && self.auto_prune_interval == 0 {
2025-11-09T23:42:54.5131061Z              return Err(anyhow::anyhow!(
2025-11-09T23:42:54.5131770Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:700:
2025-11-09T23:42:54.5132703Z                  "auto_prune_interval must be greater than 0 when auto_prune is enabled"
2025-11-09T23:42:54.5133316Z              ));
2025-11-09T23:42:54.5133599Z          }
2025-11-09T23:42:54.5134146Z -        
2025-11-09T23:42:54.5134610Z +
2025-11-09T23:42:54.5134910Z          // Validate mode-specific settings
2025-11-09T23:42:54.5135352Z          match &self.mode {
2025-11-09T23:42:54.5135791Z -            PruningMode::Normal { min_recent_blocks, .. } => {
2025-11-09T23:42:54.5136325Z +            PruningMode::Normal {
2025-11-09T23:42:54.5136721Z +                min_recent_blocks, ..
2025-11-09T23:42:54.5137113Z +            } => {
2025-11-09T23:42:54.5137432Z                  if *min_recent_blocks == 0 {
2025-11-09T23:42:54.5137861Z                      return Err(anyhow::anyhow!(
2025-11-09T23:42:54.5138406Z                          "min_recent_blocks must be greater than 0 in Normal pruning mode"
2025-11-09T23:42:54.5139212Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:728:
2025-11-09T23:42:54.5139920Z                  // No validation needed
2025-11-09T23:42:54.5140290Z              }
2025-11-09T23:42:54.5140544Z          }
2025-11-09T23:42:54.5140786Z -        
2025-11-09T23:42:54.5141028Z +
2025-11-09T23:42:54.5141253Z          Ok(())
2025-11-09T23:42:54.5141512Z      }
2025-11-09T23:42:54.5141738Z  }
2025-11-09T23:42:54.5142356Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/lib.rs:25:
2025-11-09T23:42:54.5142996Z  #[global_allocator]
2025-11-09T23:42:54.5143433Z  static GLOBAL: mimalloc::MiMalloc = mimalloc::MiMalloc;
2025-11-09T23:42:54.5143898Z  
2025-11-09T23:42:54.5145319Z -pub mod storage;
2025-11-09T23:42:54.5145667Z +pub mod bip21;
2025-11-09T23:42:54.5145959Z +pub mod config;
2025-11-09T23:42:54.5146230Z +pub mod module;
2025-11-09T23:42:54.5146507Z  pub mod network;
2025-11-09T23:42:54.5146786Z -pub mod rpc;
2025-11-09T23:42:54.5147091Z  pub mod node;
2025-11-09T23:42:54.5147397Z -pub mod config;
2025-11-09T23:42:54.5147700Z +pub mod rpc;
2025-11-09T23:42:54.5148006Z +pub mod storage;
2025-11-09T23:42:54.5148337Z  #[cfg(feature = "production")]
2025-11-09T23:42:54.5148741Z  pub mod validation;
2025-11-09T23:42:54.5149083Z -pub mod module;
2025-11-09T23:42:54.5149403Z -pub mod bip21;
2025-11-09T23:42:54.5149696Z  
2025-11-09T23:42:54.5149997Z  // Re-export config module
2025-11-09T23:42:54.5150386Z  pub use config::*;
2025-11-09T23:42:54.5151001Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/lib.rs:40:
2025-11-09T23:42:54.5151654Z  
2025-11-09T23:42:54.5152007Z  // Re-export commonly used types from protocol-engine
2025-11-09T23:42:54.5152804Z  // This allows depending only on protocol-engine (which transitively provides consensus-proof)
2025-11-09T23:42:54.5153544Z +pub use bllvm_protocol::mempool::Mempool;
2025-11-09T23:42:54.5154036Z  pub use bllvm_protocol::{
2025-11-09T23:42:54.5154754Z -    Block, BlockHeader, Transaction, TransactionInput, TransactionOutput,
2025-11-09T23:42:54.5155553Z -    OutPoint, UTXO, UtxoSet, ValidationResult, Hash, ByteString, Natural, Integer,
2025-11-09T23:42:54.5156186Z -    ConsensusError, Result,
2025-11-09T23:42:54.5156845Z +    Block, BlockHeader, ByteString, ConsensusError, Hash, Integer, Natural, OutPoint, Result,
2025-11-09T23:42:54.5157790Z +    Transaction, TransactionInput, TransactionOutput, UtxoSet, ValidationResult, UTXO,
2025-11-09T23:42:54.5158419Z  };
2025-11-09T23:42:54.5158746Z -pub use bllvm_protocol::mempool::Mempool;
2025-11-09T23:42:54.5159173Z  
2025-11-09T23:42:54.5159477Z  // Re-export protocol-engine types
2025-11-09T23:42:54.5160089Z  pub use bllvm_protocol::{BitcoinProtocolEngine, ProtocolVersion};
2025-11-09T23:42:54.5160967Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/lib.rs:81:
2025-11-09T23:42:54.5161796Z          // Test that protocol-engine works in reference-node context
2025-11-09T23:42:54.5164246Z          let node = ReferenceNode::new(Some(ProtocolVersion::Regtest)).unwrap();
2025-11-09T23:42:54.5165090Z          let protocol = node.protocol();
2025-11-09T23:42:54.5165518Z -        
2025-11-09T23:42:54.5165799Z +
2025-11-09T23:42:54.5166086Z          // Verify protocol version
2025-11-09T23:42:54.5167075Z          assert_eq!(protocol.get_protocol_version(), ProtocolVersion::Regtest);
2025-11-09T23:42:54.5167691Z -        
2025-11-09T23:42:54.5167975Z +
2025-11-09T23:42:54.5168259Z          // Test feature support
2025-11-09T23:42:54.5168760Z          assert!(protocol.supports_feature("fast_mining"));
2025-11-09T23:42:54.5169259Z      }
2025-11-09T23:42:54.5169797Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/lib.rs:94:
2025-11-09T23:42:54.5170619Z          // Test consensus validation through protocol-engine
2025-11-09T23:42:54.5171321Z          let node = ReferenceNode::new(None).unwrap(); // Uses default Regtest
2025-11-09T23:42:54.5171963Z          let protocol = node.protocol();
2025-11-09T23:42:54.5172379Z -        
2025-11-09T23:42:54.5172651Z +
2025-11-09T23:42:54.5172948Z          // Create a simple transaction
2025-11-09T23:42:54.5173387Z          let tx = Transaction {
2025-11-09T23:42:54.5173782Z              version: 1,
2025-11-09T23:42:54.5176510Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/lib.rs:105:
2025-11-09T23:42:54.5177199Z              }],
2025-11-09T23:42:54.5177519Z              lock_time: 0,
2025-11-09T23:42:54.5177866Z          };
2025-11-09T23:42:54.5178138Z -        
2025-11-09T23:42:54.5178408Z +
2025-11-09T23:42:54.5178703Z          // Test transaction validation
2025-11-09T23:42:54.5179221Z          let result = protocol.validate_transaction(&tx);
2025-11-09T23:42:54.5180012Z          assert!(result.is_ok());
2025-11-09T23:42:54.5180680Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/lib.rs:115:
2025-11-09T23:42:54.5181335Z      fn test_reference_node_creation() {
2025-11-09T23:42:54.5181750Z          // Test default (Regtest) creation
2025-11-09T23:42:54.5182209Z          let node = ReferenceNode::new(None).unwrap();
2025-11-09T23:42:54.5182874Z -        assert_eq!(node.protocol().get_protocol_version(), ProtocolVersion::Regtest);
2025-11-09T23:42:54.5183492Z -        
2025-11-09T23:42:54.5183768Z +        assert_eq!(
2025-11-09T23:42:54.5184124Z +            node.protocol().get_protocol_version(),
2025-11-09T23:42:54.5184759Z +            ProtocolVersion::Regtest
2025-11-09T23:42:54.5185140Z +        );
2025-11-09T23:42:54.5185393Z +
2025-11-09T23:42:54.5185646Z          // Test mainnet creation
2025-11-09T23:42:54.5186267Z          let mainnet_node = ReferenceNode::new(Some(ProtocolVersion::BitcoinV1)).unwrap();
2025-11-09T23:42:54.5187227Z -        assert_eq!(mainnet_node.protocol().get_protocol_version(), ProtocolVersion::BitcoinV1);
2025-11-09T23:42:54.5187909Z +        assert_eq!(
2025-11-09T23:42:54.5188290Z +            mainnet_node.protocol().get_protocol_version(),
2025-11-09T23:42:54.5188796Z +            ProtocolVersion::BitcoinV1
2025-11-09T23:42:54.5189180Z +        );
2025-11-09T23:42:54.5189444Z      }
2025-11-09T23:42:54.5189702Z  }
2025-11-09T23:42:54.5189940Z +
2025-11-09T23:42:54.5190530Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/api/hub.rs:81:
2025-11-09T23:42:54.5191367Z              .validate_request(module_id, &request.payload)?;
2025-11-09T23:42:54.5192411Z  
2025-11-09T23:42:54.5192902Z          // Handle handshake specially (no validation needed, just acknowledge)
2025-11-09T23:42:54.5193868Z -        if let RequestPayload::Handshake { module_id: handshake_id, module_name, version } = &request.payload {
2025-11-09T23:42:54.5194860Z +        if let RequestPayload::Handshake {
2025-11-09T23:42:54.5195355Z +            module_id: handshake_id,
2025-11-09T23:42:54.5195788Z +            module_name,
2025-11-09T23:42:54.5196629Z +            version,
2025-11-09T23:42:54.5196982Z +        } = &request.payload
2025-11-09T23:42:54.5198762Z +        {
2025-11-09T23:42:54.5199079Z              // Verify module_id matches
2025-11-09T23:42:54.5199526Z              if handshake_id != module_id {
2025-11-09T23:42:54.5200034Z -                return Err(ModuleError::OperationError(
2025-11-09T23:42:54.5200809Z -                    format!("Handshake module_id mismatch: expected {}, got {}", module_id, handshake_id)
2025-11-09T23:42:54.5201842Z -                ));
2025-11-09T23:42:54.5202293Z +                return Err(ModuleError::OperationError(format!(
2025-11-09T23:42:54.5202909Z +                    "Handshake module_id mismatch: expected {}, got {}",
2025-11-09T23:42:54.5203474Z +                    module_id, handshake_id
2025-11-09T23:42:54.5203899Z +                )));
2025-11-09T23:42:54.5204229Z              }
2025-11-09T23:42:54.5204719Z -            
2025-11-09T23:42:54.5206819Z -            info!("Handshake from module {} (name={}, version={})", module_id, module_name, version);
2025-11-09T23:42:54.5207481Z +
2025-11-09T23:42:54.5207756Z +            info!(
2025-11-09T23:42:54.5208160Z +                "Handshake from module {} (name={}, version={})",
2025-11-09T23:42:54.5208675Z +                module_id, module_name, version
2025-11-09T23:42:54.5209088Z +            );
2025-11-09T23:42:54.5209424Z              return Ok(ResponseMessage::success(
2025-11-09T23:42:54.5209913Z                  request.correlation_id,
2025-11-09T23:42:54.5210392Z                  ResponsePayload::HandshakeAck {
2025-11-09T23:42:54.5211183Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/api/hub.rs:96:
2025-11-09T23:42:54.5212039Z                      node_version: env!("CARGO_PKG_VERSION").to_string(),
2025-11-09T23:42:54.5212545Z -                }
2025-11-09T23:42:54.5213130Z +                },
2025-11-09T23:42:54.5213414Z              ));
2025-11-09T23:42:54.5213937Z          }
2025-11-09T23:42:54.5214203Z  
2025-11-09T23:42:54.5215072Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/api/hub.rs:108:
2025-11-09T23:42:54.5215905Z              RequestPayload::Handshake { .. } => {
2025-11-09T23:42:54.5216470Z                  // Handshake is handled at connection level, not here
2025-11-09T23:42:54.5217689Z                  return Err(crate::module::traits::ModuleError::IpcError(
2025-11-09T23:42:54.5218435Z -                    "Handshake should be handled at connection level".to_string()
2025-11-09T23:42:54.5219185Z +                    "Handshake should be handled at connection level".to_string(),
2025-11-09T23:42:54.5219736Z                  ));
2025-11-09T23:42:54.5220055Z              }
2025-11-09T23:42:54.5220414Z              RequestPayload::GetBlock { hash } => {
2025-11-09T23:42:54.5221262Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/ipc/protocol.rs:76:
2025-11-09T23:42:54.5222127Z  #[derive(Debug, Clone, Serialize, Deserialize)]
2025-11-09T23:42:54.5222642Z  pub enum RequestPayload {
2025-11-09T23:42:54.5223120Z      /// Handshake: Module identifies itself (first message)
2025-11-09T23:42:54.5223794Z -    Handshake { module_id: String, module_name: String, version: String },
2025-11-09T23:42:54.5224575Z -    GetBlock { hash: Hash },
2025-11-09T23:42:54.5224975Z -    GetBlockHeader { hash: Hash },
2025-11-09T23:42:54.5225392Z -    GetTransaction { hash: Hash },
2025-11-09T23:42:54.5225824Z -    HasTransaction { hash: Hash },
2025-11-09T23:42:54.5226212Z +    Handshake {
2025-11-09T23:42:54.5226523Z +        module_id: String,
2025-11-09T23:42:54.5226893Z +        module_name: String,
2025-11-09T23:42:54.5227260Z +        version: String,
2025-11-09T23:42:54.5227597Z +    },
2025-11-09T23:42:54.5227869Z +    GetBlock {
2025-11-09T23:42:54.5228164Z +        hash: Hash,
2025-11-09T23:42:54.5228488Z +    },
2025-11-09T23:42:54.5228768Z +    GetBlockHeader {
2025-11-09T23:42:54.5229119Z +        hash: Hash,
2025-11-09T23:42:54.5229416Z +    },
2025-11-09T23:42:54.5229694Z +    GetTransaction {
2025-11-09T23:42:54.5230063Z +        hash: Hash,
2025-11-09T23:42:54.5230364Z +    },
2025-11-09T23:42:54.5230642Z +    HasTransaction {
2025-11-09T23:42:54.5230970Z +        hash: Hash,
2025-11-09T23:42:54.5231266Z +    },
2025-11-09T23:42:54.5231541Z      GetChainTip,
2025-11-09T23:42:54.5231853Z      GetBlockHeight,
2025-11-09T23:42:54.5232215Z -    GetUtxo { outpoint: OutPoint },
2025-11-09T23:42:54.5233031Z -    SubscribeEvents { event_types: Vec<EventType> },
2025-11-09T23:42:54.5233533Z +    GetUtxo {
2025-11-09T23:42:54.5233860Z +        outpoint: OutPoint,
2025-11-09T23:42:54.5234216Z +    },
2025-11-09T23:42:54.5234705Z +    SubscribeEvents {
2025-11-09T23:42:54.5235069Z +        event_types: Vec<EventType>,
2025-11-09T23:42:54.5235481Z +    },
2025-11-09T23:42:54.5235729Z  }
2025-11-09T23:42:54.5236000Z  
2025-11-09T23:42:54.5236297Z  /// Response message from node to module
2025-11-09T23:42:54.5237130Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/ipc/protocol.rs:100:
2025-11-09T23:42:54.5237989Z  #[derive(Debug, Clone, Serialize, Deserialize)]
2025-11-09T23:42:54.5238494Z  pub enum ResponsePayload {
2025-11-09T23:42:54.5238943Z      /// Handshake acknowledgment with node version
2025-11-09T23:42:54.5239455Z -    HandshakeAck { node_version: String },
2025-11-09T23:42:54.5239891Z +    HandshakeAck {
2025-11-09T23:42:54.5240197Z +        node_version: String,
2025-11-09T23:42:54.5240546Z +    },
2025-11-09T23:42:54.5240833Z      Block(Option<Block>),
2025-11-09T23:42:54.5241233Z      BlockHeader(Option<BlockHeader>),
2025-11-09T23:42:54.5241679Z      Transaction(Option<Transaction>),
2025-11-09T23:42:54.5242551Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/ipc/server.rs:124:
2025-11-09T23:42:54.5243370Z              Some(Ok(bytes)) => {
2025-11-09T23:42:54.5244498Z                  let message: ModuleMessage = bincode::deserialize(bytes.as_ref())
2025-11-09T23:42:54.5245299Z                      .map_err(|e| ModuleError::SerializationError(e.to_string()))?;
2025-11-09T23:42:54.5245881Z -                
2025-11-09T23:42:54.5246183Z +
2025-11-09T23:42:54.5246471Z                  match message {
2025-11-09T23:42:54.5246946Z                      ModuleMessage::Request(request) => {
2025-11-09T23:42:54.5247742Z -                        if let RequestPayload::Handshake { module_id, module_name, version } = request.payload {
2025-11-09T23:42:54.5248553Z +                        if let RequestPayload::Handshake {
2025-11-09T23:42:54.5249039Z +                            module_id,
2025-11-09T23:42:54.5249464Z +                            module_name,
2025-11-09T23:42:54.5249896Z +                            version,
2025-11-09T23:42:54.5250329Z +                        } = request.payload
2025-11-09T23:42:54.5250746Z +                        {
2025-11-09T23:42:54.5251133Z                              info!(
2025-11-09T23:42:54.5251617Z                                  "Module handshake: id={}, name={}, version={}",
2025-11-09T23:42:54.5252161Z                                  module_id, module_name, version
2025-11-09T23:42:54.5252990Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/ipc/server.rs:134:
2025-11-09T23:42:54.5253740Z                              );
2025-11-09T23:42:54.5254083Z -                            
2025-11-09T23:42:54.5254665Z +
2025-11-09T23:42:54.5254962Z                              // Send handshake acknowledgment
2025-11-09T23:42:54.5266209Z                              let ack = ResponseMessage {
2025-11-09T23:42:54.5266794Z                                  correlation_id: request.correlation_id,
2025-11-09T23:42:54.5267630Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/ipc/server.rs:142:
2025-11-09T23:42:54.5268338Z                                  }),
2025-11-09T23:42:54.5268744Z                                  error: None,
2025-11-09T23:42:54.5269138Z                              };
2025-11-09T23:42:54.5269474Z -                            
2025-11-09T23:42:54.5269796Z +
2025-11-09T23:42:54.5270222Z                              let ack_bytes = bincode::serialize(&ModuleMessage::Response(ack))
2025-11-09T23:42:54.5270958Z                                  .map_err(|e| ModuleError::SerializationError(e.to_string()))?;
2025-11-09T23:42:54.5271641Z -                            writer.send(bytes::Bytes::from(ack_bytes)).await
2025-11-09T23:42:54.5272730Z -                                .map_err(|e| ModuleError::IpcError(format!("Failed to send handshake ack: {}", e)))?;
2025-11-09T23:42:54.5273434Z -                            
2025-11-09T23:42:54.5273804Z +                            writer
2025-11-09T23:42:54.5274259Z +                                .send(bytes::Bytes::from(ack_bytes))
2025-11-09T23:42:54.5274905Z +                                .await
2025-11-09T23:42:54.5275437Z +                                .map_err(|e| {
2025-11-09T23:42:54.5275882Z +                                    ModuleError::IpcError(format!(
2025-11-09T23:42:54.5276388Z +                                        "Failed to send handshake ack: {}",
2025-11-09T23:42:54.5276892Z +                                        e
2025-11-09T23:42:54.5277294Z +                                    ))
2025-11-09T23:42:54.5277686Z +                                })?;
2025-11-09T23:42:54.5278048Z +
2025-11-09T23:42:54.5278319Z                              module_id
2025-11-09T23:42:54.5278732Z                          } else {
2025-11-09T23:42:54.5279255Z                              // No handshake - use fallback ID (backward compatibility)
2025-11-09T23:42:54.5280094Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/ipc/server.rs:162:
2025-11-09T23:42:54.5280790Z                      }
2025-11-09T23:42:54.5281088Z                      _ => {
2025-11-09T23:42:54.5281685Z                          return Err(ModuleError::IpcError(
2025-11-09T23:42:54.5282755Z -                            "First message must be a handshake request".to_string()
2025-11-09T23:42:54.5283366Z +                            "First message must be a handshake request".to_string(),
2025-11-09T23:42:54.5283852Z                          ));
2025-11-09T23:42:54.5284158Z                      }
2025-11-09T23:42:54.5284592Z                  }
2025-11-09T23:42:54.5285275Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/ipc/server.rs:169:
2025-11-09T23:42:54.5286060Z              }
2025-11-09T23:42:54.5286378Z              Some(Err(e)) => {
2025-11-09T23:42:54.5288312Z -                return Err(ModuleError::IpcError(format!("Failed to read handshake: {}", e)));
2025-11-09T23:42:54.5289038Z +                return Err(ModuleError::IpcError(format!(
2025-11-09T23:42:54.5289510Z +                    "Failed to read handshake: {}",
2025-11-09T23:42:54.5289921Z +                    e
2025-11-09T23:42:54.5290215Z +                )));
2025-11-09T23:42:54.5290495Z              }
2025-11-09T23:42:54.5290774Z              None => {
2025-11-09T23:42:54.5291372Z -                return Err(ModuleError::IpcError("Connection closed before handshake".to_string()));
2025-11-09T23:42:54.5292089Z +                return Err(ModuleError::IpcError(
2025-11-09T23:42:54.5292602Z +                    "Connection closed before handshake".to_string(),
2025-11-09T23:42:54.5293138Z +                ));
2025-11-09T23:42:54.5293448Z              }
2025-11-09T23:42:54.5293741Z          };
2025-11-09T23:42:54.5294003Z  
2025-11-09T23:42:54.5294802Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/ipc/server.rs:372:
2025-11-09T23:42:54.5297141Z                  // Handshake is handled at connection level
2025-11-09T23:42:54.5297675Z                  Ok(ResponseMessage::success(
2025-11-09T23:42:54.5298155Z                      request.correlation_id,
2025-11-09T23:42:54.5298892Z -                    ResponsePayload::HandshakeAck { node_version: env!("CARGO_PKG_VERSION").to_string() },
2025-11-09T23:42:54.5299694Z +                    ResponsePayload::HandshakeAck {
2025-11-09T23:42:54.5300250Z +                        node_version: env!("CARGO_PKG_VERSION").to_string(),
2025-11-09T23:42:54.5300779Z +                    },
2025-11-09T23:42:54.5301103Z                  ))
2025-11-09T23:42:54.5301408Z              }
2025-11-09T23:42:54.5301773Z              RequestPayload::GetBlock { hash } => {
2025-11-09T23:42:54.5302630Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/manager.rs:159:
2025-11-09T23:42:54.5303818Z          // This allows both to access the process for different purposes
2025-11-09T23:42:54.5304583Z          use std::sync::Arc;
2025-11-09T23:42:54.5305143Z          let shared_process = Arc::new(tokio::sync::Mutex::new(process));
2025-11-09T23:42:54.5305690Z -        
2025-11-09T23:42:54.5305976Z +
2025-11-09T23:42:54.5306303Z          // Create monitor with shared process
2025-11-09T23:42:54.5306934Z          let monitor = ModuleProcessMonitor::new(self.crash_tx.clone());
2025-11-09T23:42:54.5309181Z          let module_name_clone = module_name.to_string();
2025-11-09T23:42:54.5310135Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:87:
2025-11-09T23:42:54.5310913Z  
2025-11-09T23:42:54.5311212Z              // Check heartbeat via IPC
2025-11-09T23:42:54.5311690Z              if let Some(client) = process.client_mut() {
2025-11-09T23:42:54.5312258Z +                use crate::module::ipc::protocol::MessageType;
2025-11-09T23:42:54.5312851Z                  use crate::module::ipc::protocol::RequestMessage;
2025-11-09T23:42:54.5313424Z                  use crate::module::ipc::protocol::RequestPayload;
2025-11-09T23:42:54.5314236Z -                use crate::module::ipc::protocol::MessageType;
2025-11-09T23:42:54.5314871Z -                
2025-11-09T23:42:54.5315186Z +
2025-11-09T23:42:54.5315821Z                  // Use GetChainTip as a lightweight heartbeat check
2025-11-09T23:42:54.5316399Z                  let heartbeat_request = RequestMessage {
2025-11-09T23:42:54.5318714Z                      correlation_id: 0, // Use 0 for heartbeat (won't match any real request)
2025-11-09T23:42:54.5319707Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:97:
2025-11-09T23:42:54.5320601Z                      request_type: MessageType::GetChainTip,
2025-11-09T23:42:54.5321129Z                      payload: RequestPayload::GetChainTip,
2025-11-09T23:42:54.5321594Z                  };
2025-11-09T23:42:54.5321882Z -                
2025-11-09T23:42:54.5322178Z +
2025-11-09T23:42:54.5322468Z                  // Send heartbeat with timeout
2025-11-09T23:42:54.5322993Z -                let heartbeat_result = tokio::time::timeout(
2025-11-09T23:42:54.5323533Z -                    Duration::from_secs(2),
2025-11-09T23:42:54.5324020Z -                    client.request(heartbeat_request)
2025-11-09T23:42:54.5324741Z -                ).await;
2025-11-09T23:42:54.5325093Z -                
2025-11-09T23:42:54.5325440Z +                let heartbeat_result =
2025-11-09T23:42:54.5326118Z +                    tokio::time::timeout(Duration::from_secs(2), client.request(heartbeat_request))
2025-11-09T23:42:54.5328417Z +                        .await;
2025-11-09T23:42:54.5328781Z +
2025-11-09T23:42:54.5329087Z                  match heartbeat_result {
2025-11-09T23:42:54.5329502Z                      Ok(Ok(_)) => {
2025-11-09T23:42:54.5329946Z                          // Heartbeat successful - module is responsive
2025-11-09T23:42:54.5330816Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:120:
2025-11-09T23:42:54.5331610Z                  }
2025-11-09T23:42:54.5331929Z              } else {
2025-11-09T23:42:54.5332349Z                  // No IPC client available - can't check heartbeat
2025-11-09T23:42:54.5333041Z -                debug!("Module {} has no IPC client for heartbeat check", module_name);
2025-11-09T23:42:54.5333668Z +                debug!(
2025-11-09T23:42:54.5334101Z +                    "Module {} has no IPC client for heartbeat check",
2025-11-09T23:42:54.5334809Z +                    module_name
2025-11-09T23:42:54.5335175Z +                );
2025-11-09T23:42:54.5335481Z              }
2025-11-09T23:42:54.5335766Z -            
2025-11-09T23:42:54.5336051Z +
2025-11-09T23:42:54.5336357Z              // Loop continues to next iteration
2025-11-09T23:42:54.5336788Z          }
2025-11-09T23:42:54.5337314Z      }
2025-11-09T23:42:54.5337995Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:145:
2025-11-09T23:42:54.5338922Z                  let mut process_guard = shared_process.lock().await;
2025-11-09T23:42:54.5339456Z                  process_guard.is_running()
2025-11-09T23:42:54.5339881Z              };
2025-11-09T23:42:54.5340168Z -            
2025-11-09T23:42:54.5340469Z +
2025-11-09T23:42:54.5340745Z              if !is_running {
2025-11-09T23:42:54.5341176Z                  // Process exited, check exit status
2025-11-09T23:42:54.5341640Z                  let exit_status = {
2025-11-09T23:42:54.5342460Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:152:
2025-11-09T23:42:54.5343392Z                      let mut process_guard = shared_process.lock().await;
2025-11-09T23:42:54.5343959Z                      process_guard.wait().await?
2025-11-09T23:42:54.5344544Z                  };
2025-11-09T23:42:54.5346735Z -                
2025-11-09T23:42:54.5347027Z +
2025-11-09T23:42:54.5347291Z                  match exit_status {
2025-11-09T23:42:54.5347702Z                      Some(status) => {
2025-11-09T23:42:54.5348137Z                          if status.success() {
2025-11-09T23:42:54.5348982Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:182:
2025-11-09T23:42:54.5350123Z              {
2025-11-09T23:42:54.5350549Z                  let mut process_guard = shared_process.lock().await;
2025-11-09T23:42:54.5351153Z                  if let Some(client) = process_guard.client_mut() {
2025-11-09T23:42:54.5351730Z +                    use crate::module::ipc::protocol::MessageType;
2025-11-09T23:42:54.5352325Z                      use crate::module::ipc::protocol::RequestMessage;
2025-11-09T23:42:54.5352936Z                      use crate::module::ipc::protocol::RequestPayload;
2025-11-09T23:42:54.5353523Z -                    use crate::module::ipc::protocol::MessageType;
2025-11-09T23:42:54.5354003Z -                    
2025-11-09T23:42:54.5354488Z +
2025-11-09T23:42:54.5354876Z                      // Use GetChainTip as a lightweight heartbeat check
2025-11-09T23:42:54.5355453Z                      let heartbeat_request = RequestMessage {
2025-11-09T23:42:54.5356108Z                          correlation_id: 0, // Use 0 for heartbeat (won't match any real request)
2025-11-09T23:42:54.5358863Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:192:
2025-11-09T23:42:54.5359772Z                          request_type: MessageType::GetChainTip,
2025-11-09T23:42:54.5360314Z                          payload: RequestPayload::GetChainTip,
2025-11-09T23:42:54.5360770Z                      };
2025-11-09T23:42:54.5361088Z -                    
2025-11-09T23:42:54.5361388Z +
2025-11-09T23:42:54.5361689Z                      // Send heartbeat with timeout
2025-11-09T23:42:54.5362195Z                      let heartbeat_result = tokio::time::timeout(
2025-11-09T23:42:54.5362705Z                          Duration::from_secs(2),
2025-11-09T23:42:54.5363509Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:199:
2025-11-09T23:42:54.5364630Z -                        client.request(heartbeat_request)
2025-11-09T23:42:54.5365137Z -                    ).await;
2025-11-09T23:42:54.5366980Z -                    
2025-11-09T23:42:54.5367383Z +                        client.request(heartbeat_request),
2025-11-09T23:42:54.5367840Z +                    )
2025-11-09T23:42:54.5368171Z +                    .await;
2025-11-09T23:42:54.5368518Z +
2025-11-09T23:42:54.5368822Z                      match heartbeat_result {
2025-11-09T23:42:54.5369267Z                          Ok(Ok(_)) => {
2025-11-09T23:42:54.5369756Z                              // Heartbeat successful - module is responsive
2025-11-09T23:42:54.5370637Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:215:
2025-11-09T23:42:54.5371753Z                      }
2025-11-09T23:42:54.5372104Z                  } else {
2025-11-09T23:42:54.5372537Z                      // No IPC client available - can't check heartbeat
2025-11-09T23:42:54.5373226Z -                    debug!("Module {} has no IPC client for heartbeat check", module_name);
2025-11-09T23:42:54.5373836Z +                    debug!(
2025-11-09T23:42:54.5374480Z +                        "Module {} has no IPC client for heartbeat check",
2025-11-09T23:42:54.5375008Z +                        module_name
2025-11-09T23:42:54.5375400Z +                    );
2025-11-09T23:42:54.5375700Z                  }
2025-11-09T23:42:54.5375973Z              }
2025-11-09T23:42:54.5376244Z -            
2025-11-09T23:42:54.5376514Z +
2025-11-09T23:42:54.5376820Z              // Loop continues to next iteration
2025-11-09T23:42:54.5377227Z          }
2025-11-09T23:42:54.5377494Z      }
2025-11-09T23:42:54.5378175Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:229:
2025-11-09T23:42:54.5379149Z              ModuleHealth::Crashed("Process exited".to_string())
2025-11-09T23:42:54.5379765Z          } else if let Some(client) = process.client_mut() {
2025-11-09T23:42:54.5380313Z              // Check heartbeat via IPC with short timeout
2025-11-09T23:42:54.5381040Z -            use crate::module::ipc::protocol::{RequestMessage, RequestPayload, MessageType};
2025-11-09T23:42:54.5382193Z +            use crate::module::ipc::protocol::{MessageType, RequestMessage, RequestPayload};
2025-11-09T23:42:54.5382863Z              use tokio::time::timeout;
2025-11-09T23:42:54.5383254Z -            
2025-11-09T23:42:54.5383543Z +
2025-11-09T23:42:54.5383868Z              let heartbeat_request = RequestMessage {
2025-11-09T23:42:54.5384751Z                  correlation_id: 0,
2025-11-09T23:42:54.5385240Z                  request_type: MessageType::GetChainTip,
2025-11-09T23:42:54.5386094Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:238:
2025-11-09T23:42:54.5388910Z                  payload: RequestPayload::GetChainTip,
2025-11-09T23:42:54.5389340Z              };
2025-11-09T23:42:54.5389642Z -            
2025-11-09T23:42:54.5389922Z +
2025-11-09T23:42:54.5390348Z              // Use tokio::runtime::Handle to run async code in sync context
2025-11-09T23:42:54.5391115Z              // This is a simplified check - in production would use proper async context
2025-11-09T23:42:54.5391832Z              match tokio::runtime::Handle::try_current() {
2025-11-09T23:42:54.5392709Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:244:
2025-11-09T23:42:54.5393546Z                  Ok(handle) => {
2025-11-09T23:42:54.5394003Z                      let result = handle.block_on(timeout(
2025-11-09T23:42:54.5394713Z                          Duration::from_secs(1),
2025-11-09T23:42:54.5395216Z -                        client.request(heartbeat_request)
2025-11-09T23:42:54.5395752Z +                        client.request(heartbeat_request),
2025-11-09T23:42:54.5398159Z                      ));
2025-11-09T23:42:54.5398481Z -                    
2025-11-09T23:42:54.5398783Z +
2025-11-09T23:42:54.5399060Z                      match result {
2025-11-09T23:42:54.5399502Z                          Ok(Ok(_)) => ModuleHealth::Healthy,
2025-11-09T23:42:54.5400002Z                          _ => ModuleHealth::Unresponsive,
2025-11-09T23:42:54.5442286Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/sandbox/process.rs:99:
2025-11-09T23:42:54.5443306Z                  if let Some(max_memory) = limits.max_memory_bytes {
2025-11-09T23:42:54.5443886Z                      let soft_limit = max_memory as u64;
2025-11-09T23:42:54.5444605Z                      let hard_limit = max_memory as u64;
2025-11-09T23:42:54.5445214Z -                    setrlimit(Resource::RLIMIT_AS, soft_limit, hard_limit)
2025-11-09T23:42:54.5446195Z -                        .map_err(|e| {
2025-11-09T23:42:54.5446711Z -                            ModuleError::OperationError(format!(
2025-11-09T23:42:54.5447251Z -                                "Failed to set memory limit: {}",
2025-11-09T23:42:54.5447732Z -                                e
2025-11-09T23:42:54.5448121Z -                            ))
2025-11-09T23:42:54.5448489Z -                        })?;
2025-11-09T23:42:54.5449085Z +                    setrlimit(Resource::RLIMIT_AS, soft_limit, hard_limit).map_err(|e| {
2025-11-09T23:42:54.5449968Z +                        ModuleError::OperationError(format!("Failed to set memory limit: {}", e))
2025-11-09T23:42:54.5450636Z +                    })?;
2025-11-09T23:42:54.5451057Z                      debug!("Set memory limit: {} bytes", max_memory);
2025-11-09T23:42:54.5451522Z                  }
2025-11-09T23:42:54.5451806Z  
2025-11-09T23:42:54.5452476Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/sandbox/process.rs:116:
2025-11-09T23:42:54.5453307Z                      #[cfg(feature = "nix")]
2025-11-09T23:42:54.5453691Z                      {
2025-11-09T23:42:54.5454089Z                          use nix::sys::resource::{setrlimit, Resource};
2025-11-09T23:42:54.5454977Z -                        setrlimit(Resource::RLIMIT_NOFILE, soft_limit, hard_limit)
2025-11-09T23:42:54.5455572Z -                            .map_err(|e| {
2025-11-09T23:42:54.5456471Z +                        setrlimit(Resource::RLIMIT_NOFILE, soft_limit, hard_limit).map_err(
2025-11-09T23:42:54.5457113Z +                            |e| {
2025-11-09T23:42:54.5457594Z                                  ModuleError::OperationError(format!(
2025-11-09T23:42:54.5458149Z                                      "Failed to set file descriptor limit: {}",
2025-11-09T23:42:54.5458661Z                                      e
2025-11-09T23:42:54.5459469Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/sandbox/process.rs:124:
2025-11-09T23:42:54.5460321Z                                  ))
2025-11-09T23:42:54.5460706Z -                            })?;
2025-11-09T23:42:54.5461088Z +                            },
2025-11-09T23:42:54.5461449Z +                        )?;
2025-11-09T23:42:54.5461795Z                      }
2025-11-09T23:42:54.5462157Z                      #[cfg(not(feature = "nix"))]
2025-11-09T23:42:54.5462577Z                      {
2025-11-09T23:42:54.5463318Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/sandbox/process.rs:139:
2025-11-09T23:42:54.5465921Z                      #[cfg(feature = "nix")]
2025-11-09T23:42:54.5466408Z                      let hard_limit = max_children as u64;
2025-11-09T23:42:54.5466892Z                      #[cfg(feature = "nix")]
2025-11-09T23:42:54.5467463Z -                    setrlimit(Resource::RLIMIT_NPROC, soft_limit, hard_limit)
2025-11-09T23:42:54.5468047Z -                        .map_err(|e| {
2025-11-09T23:42:54.5468539Z -                            ModuleError::OperationError(format!(
2025-11-09T23:42:54.5469073Z -                                "Failed to set process limit: {}",
2025-11-09T23:42:54.5469518Z -                                e
2025-11-09T23:42:54.5469884Z -                            ))
2025-11-09T23:42:54.5470241Z -                        })?;
2025-11-09T23:42:54.5470827Z +                    setrlimit(Resource::RLIMIT_NPROC, soft_limit, hard_limit).map_err(|e| {
2025-11-09T23:42:54.5471746Z +                        ModuleError::OperationError(format!("Failed to set process limit: {}", e))
2025-11-09T23:42:54.5472407Z +                    })?;
2025-11-09T23:42:54.5472847Z                      debug!("Set process limit: {}", max_children);
2025-11-09T23:42:54.5473324Z                  }
2025-11-09T23:42:54.5473631Z  
2025-11-09T23:42:54.5474490Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/sandbox/process.rs:191:
2025-11-09T23:42:54.5475457Z                          // Field 23 (index 22): rss - Resident Set Size (pages)
2025-11-09T23:42:54.5476454Z                          let utime: u64 = fields.get(13).and_then(|s| s.parse().ok()).unwrap_or(0);
2025-11-09T23:42:54.5477259Z                          let stime: u64 = fields.get(14).and_then(|s| s.parse().ok()).unwrap_or(0);
2025-11-09T23:42:54.5478067Z -                        let rss_pages: u64 = fields.get(22).and_then(|s| s.parse().ok()).unwrap_or(0);
2025-11-09T23:42:54.5478740Z +                        let rss_pages: u64 =
2025-11-09T23:42:54.5479275Z +                            fields.get(22).and_then(|s| s.parse().ok()).unwrap_or(0);
2025-11-09T23:42:54.5479780Z  
2025-11-09T23:42:54.5480123Z                          // Get page size (typically 4096 bytes on Linux)
2025-11-09T23:42:54.5480636Z                          #[cfg(feature = "libc")]
2025-11-09T23:42:54.5481954Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/security/validator.rs:155:
2025-11-09T23:42:54.5484738Z          let mut limiters = self.rate_limiters.lock().unwrap();
2025-11-09T23:42:54.5485282Z  
2025-11-09T23:42:54.5485618Z          // Get or create rate limiter for this module
2025-11-09T23:42:54.5486101Z -        let limiter = limiters
2025-11-09T23:42:54.5486525Z -            .entry(module_id.to_string())
2025-11-09T23:42:54.5486967Z -            .or_insert_with(|| {
2025-11-09T23:42:54.5487607Z -                RateLimiter::new(self.max_requests_per_second, self.time_window_seconds)
2025-11-09T23:42:54.5488508Z -            });
2025-11-09T23:42:54.5489026Z +        let limiter = limiters.entry(module_id.to_string()).or_insert_with(|| {
2025-11-09T23:42:54.5489863Z +            RateLimiter::new(self.max_requests_per_second, self.time_window_seconds)
2025-11-09T23:42:54.5490483Z +        });
2025-11-09T23:42:54.5490775Z  
2025-11-09T23:42:54.5491052Z          // Check rate limit
2025-11-09T23:42:54.5491709Z          if !limiter.check_rate_limit(self.max_requests_per_second, self.time_window_seconds) {
2025-11-09T23:42:54.5569478Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:104:
2025-11-09T23:42:54.5570581Z      pub fn add_address(&mut self, addr: NetworkAddress, services: u64) {
2025-11-09T23:42:54.5571250Z          // Convert NetworkAddress to SocketAddr for key
2025-11-09T23:42:54.5571802Z          let socket_addr = self.network_addr_to_socket(&addr);
2025-11-09T23:42:54.5572268Z -        
2025-11-09T23:42:54.5572523Z +
2025-11-09T23:42:54.5572848Z          match self.addresses.get_mut(&socket_addr) {
2025-11-09T23:42:54.5573322Z              Some(entry) => {
2025-11-09T23:42:54.5575852Z                  // Update existing entry
2025-11-09T23:42:54.5576675Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:116:
2025-11-09T23:42:54.5577563Z                  if self.addresses.len() >= self.max_addresses {
2025-11-09T23:42:54.5578173Z                      self.evict_oldest();
2025-11-09T23:42:54.5578625Z                  }
2025-11-09T23:42:54.5579188Z -                self.addresses.insert(socket_addr, AddressEntry::new(addr, services));
2025-11-09T23:42:54.5579878Z +                self.addresses
2025-11-09T23:42:54.5580395Z +                    .insert(socket_addr, AddressEntry::new(addr, services));
2025-11-09T23:42:54.5580910Z              }
2025-11-09T23:42:54.5581172Z          }
2025-11-09T23:42:54.5581426Z      }
2025-11-09T23:42:54.5582009Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:136:
2025-11-09T23:42:54.5582846Z              .filter(|entry| entry.is_fresh(self.expiration_seconds))
2025-11-09T23:42:54.5583395Z              .map(|entry| entry.addr.clone())
2025-11-09T23:42:54.5583845Z              .collect();
2025-11-09T23:42:54.5584185Z -        
2025-11-09T23:42:54.5586550Z +
2025-11-09T23:42:54.5586866Z          // Sort by last_seen (most recent first)
2025-11-09T23:42:54.5587343Z          fresh.sort_by_key(|addr| {
2025-11-09T23:42:54.5587842Z              let socket = self.network_addr_to_socket(addr);
2025-11-09T23:42:54.5589000Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:146:
2025-11-09T23:42:54.5589796Z                  .unwrap_or(0)
2025-11-09T23:42:54.5590138Z          });
2025-11-09T23:42:54.5590454Z          fresh.reverse();
2025-11-09T23:42:54.5590873Z -        
2025-11-09T23:42:54.5591154Z +
2025-11-09T23:42:54.5591472Z          fresh.into_iter().take(count).collect()
2025-11-09T23:42:54.5591933Z      }
2025-11-09T23:42:54.5592195Z  
2025-11-09T23:42:54.5592843Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:158:
2025-11-09T23:42:54.5593654Z      /// Remove expired addresses
2025-11-09T23:42:54.5594112Z      pub fn remove_expired(&mut self) -> usize {
2025-11-09T23:42:54.5594803Z          let before = self.addresses.len();
2025-11-09T23:42:54.5595473Z -        self.addresses.retain(|_, entry| entry.is_fresh(self.expiration_seconds));
2025-11-09T23:42:54.5598537Z +        self.addresses
2025-11-09T23:42:54.5599015Z +            .retain(|_, entry| entry.is_fresh(self.expiration_seconds));
2025-11-09T23:42:54.5599588Z          before - self.addresses.len()
2025-11-09T23:42:54.5599983Z      }
2025-11-09T23:42:54.5600233Z  
2025-11-09T23:42:54.5600880Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:196:
2025-11-09T23:42:54.5601957Z                      || ipv4.is_link_local()
2025-11-09T23:42:54.5602690Z                      || ipv4.is_broadcast()
2025-11-09T23:42:54.5603098Z              }
2025-11-09T23:42:54.5603440Z -            IpAddr::V6(ipv6) => {
2025-11-09T23:42:54.5603906Z -                ipv6.is_loopback() || ipv6.is_unspecified()
2025-11-09T23:42:54.5604579Z -            }
2025-11-09T23:42:54.5605055Z +            IpAddr::V6(ipv6) => ipv6.is_loopback() || ipv6.is_unspecified(),
2025-11-09T23:42:54.5605603Z          }
2025-11-09T23:42:54.5606493Z      }
2025-11-09T23:42:54.5606773Z  
2025-11-09T23:42:54.5607434Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:238:
2025-11-09T23:42:54.5608235Z                      ip: [0; 16],
2025-11-09T23:42:54.5608621Z                      port: 0,
2025-11-09T23:42:54.5608969Z                  };
2025-11-09T23:42:54.5609571Z -                self.iroh_addresses.insert(node_id, AddressEntry::new(placeholder_addr, services));
2025-11-09T23:42:54.5610295Z +                self.iroh_addresses
2025-11-09T23:42:54.5610874Z +                    .insert(node_id, AddressEntry::new(placeholder_addr, services));
2025-11-09T23:42:54.5611434Z              }
2025-11-09T23:42:54.5612237Z          }
2025-11-09T23:42:54.5612549Z      }
2025-11-09T23:42:54.5613207Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:252:
2025-11-09T23:42:54.5614519Z              .filter(|(_, entry)| entry.is_fresh(self.expiration_seconds))
2025-11-09T23:42:54.5615145Z              .map(|(node_id, _)| *node_id)
2025-11-09T23:42:54.5615564Z              .collect();
2025-11-09T23:42:54.5615913Z -        
2025-11-09T23:42:54.5616182Z +
2025-11-09T23:42:54.5616502Z          // Sort by last_seen (most recent first)
2025-11-09T23:42:54.5616989Z          fresh.sort_by_key(|node_id| {
2025-11-09T23:42:54.5617416Z              self.iroh_addresses
2025-11-09T23:42:54.5618179Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:261:
2025-11-09T23:42:54.5618980Z                  .unwrap_or(0)
2025-11-09T23:42:54.5619341Z          });
2025-11-09T23:42:54.5636500Z          fresh.reverse();
2025-11-09T23:42:54.5636958Z -        
2025-11-09T23:42:54.5637240Z +
2025-11-09T23:42:54.5637573Z          fresh.into_iter().take(count).collect()
2025-11-09T23:42:54.5638020Z      }
2025-11-09T23:42:54.5638296Z  
2025-11-09T23:42:54.5638954Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:319:
2025-11-09T23:42:54.5639780Z      }
2025-11-09T23:42:54.5640060Z  
2025-11-09T23:42:54.5640360Z      /// Convert NetworkAddress to SocketAddr
2025-11-09T23:42:54.5641036Z -    /// 
2025-11-09T23:42:54.5641313Z +    ///
2025-11-09T23:42:54.5641785Z      /// Note: This is public for use in NetworkManager when connecting to peers.
2025-11-09T23:42:54.5642602Z      pub fn network_addr_to_socket(&self, addr: &NetworkAddress) -> SocketAddr {
2025-11-09T23:42:54.5643278Z          // Convert IPv6 address bytes to SocketAddr
2025-11-09T23:42:54.5644060Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:327:
2025-11-09T23:42:54.5645179Z          let ip = if addr.ip[0..12] == [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0xff, 0xff] {
2025-11-09T23:42:54.5645768Z              // IPv4-mapped IPv6 address
2025-11-09T23:42:54.5646264Z              IpAddr::V4(std::net::Ipv4Addr::new(
2025-11-09T23:42:54.5646791Z -                addr.ip[12], addr.ip[13], addr.ip[14], addr.ip[15],
2025-11-09T23:42:54.5647280Z +                addr.ip[12],
2025-11-09T23:42:54.5647641Z +                addr.ip[13],
2025-11-09T23:42:54.5648019Z +                addr.ip[14],
2025-11-09T23:42:54.5648405Z +                addr.ip[15],
2025-11-09T23:42:54.5648760Z              ))
2025-11-09T23:42:54.5649074Z          } else {
2025-11-09T23:42:54.5649377Z              // Native IPv6
2025-11-09T23:42:54.5650114Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:342:
2025-11-09T23:42:54.5650984Z                  u16::from_be_bytes([addr.ip[14], addr.ip[15]]),
2025-11-09T23:42:54.5651715Z              ];
2025-11-09T23:42:54.5652083Z              IpAddr::V6(std::net::Ipv6Addr::new(
2025-11-09T23:42:54.5652582Z -                segments[0], segments[1], segments[2], segments[3],
2025-11-09T23:42:54.5653179Z -                segments[4], segments[5], segments[6], segments[7],
2025-11-09T23:42:54.5653662Z +                segments[0],
2025-11-09T23:42:54.5654016Z +                segments[1],
2025-11-09T23:42:54.5654551Z +                segments[2],
2025-11-09T23:42:54.5654907Z +                segments[3],
2025-11-09T23:42:54.5655270Z +                segments[4],
2025-11-09T23:42:54.5655652Z +                segments[5],
2025-11-09T23:42:54.5656014Z +                segments[6],
2025-11-09T23:42:54.5656363Z +                segments[7],
2025-11-09T23:42:54.5656693Z              ))
2025-11-09T23:42:54.5656976Z          };
2025-11-09T23:42:54.5657315Z          SocketAddr::new(ip, addr.port)
2025-11-09T23:42:54.5658125Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:406:
2025-11-09T23:42:54.5659020Z          let addr2 = create_test_address("192.168.1.2", 8333);
2025-11-09T23:42:54.5659551Z          db.add_address(addr1.clone(), 1);
2025-11-09T23:42:54.5660016Z          db.add_address(addr2.clone(), 1);
2025-11-09T23:42:54.5660436Z -        
2025-11-09T23:42:54.5661530Z +
2025-11-09T23:42:54.5661877Z          let fresh = db.get_fresh_addresses(10);
2025-11-09T23:42:54.5662371Z          assert_eq!(fresh.len(), 2);
2025-11-09T23:42:54.5662776Z      }
2025-11-09T23:42:54.5663441Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:417:
2025-11-09T23:42:54.5664261Z          let addr = create_test_address("192.168.1.1", 8333);
2025-11-09T23:42:54.5664957Z          db.add_address(addr.clone(), 1);
2025-11-09T23:42:54.5665393Z          assert_eq!(db.len(), 1);
2025-11-09T23:42:54.5665752Z -        
2025-11-09T23:42:54.5666026Z +
2025-11-09T23:42:54.5666328Z          // Wait for expiration
2025-11-09T23:42:54.5666818Z          std::thread::sleep(std::time::Duration::from_secs(2));
2025-11-09T23:42:54.5667296Z -        
2025-11-09T23:42:54.5667555Z +
2025-11-09T23:42:54.5667873Z          let fresh = db.get_fresh_addresses(10);
2025-11-09T23:42:54.5668395Z          assert_eq!(fresh.len(), 0); // Should be expired
2025-11-09T23:42:54.5668865Z      }
2025-11-09T23:42:54.5669520Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:433:
2025-11-09T23:42:54.5670345Z          db.add_address(addr1.clone(), 1);
2025-11-09T23:42:54.5671094Z          db.add_address(addr2.clone(), 1);
2025-11-09T23:42:54.5671538Z          assert_eq!(db.len(), 2);
2025-11-09T23:42:54.5671925Z -        
2025-11-09T23:42:54.5672196Z +
2025-11-09T23:42:54.5672478Z          // Wait for expiration
2025-11-09T23:42:54.5672969Z          std::thread::sleep(std::time::Duration::from_secs(2));
2025-11-09T23:42:54.5673472Z -        
2025-11-09T23:42:54.5673752Z +
2025-11-09T23:42:54.5674062Z          let removed = db.remove_expired();
2025-11-09T23:42:54.5674712Z          assert_eq!(removed, 2);
2025-11-09T23:42:54.5675127Z          assert_eq!(db.len(), 0);
2025-11-09T23:42:54.5675880Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:448:
2025-11-09T23:42:54.5676774Z          let localhost = create_test_address("127.0.0.1", 8333);
2025-11-09T23:42:54.5677386Z          let private = create_test_address("192.168.1.1", 8333);
2025-11-09T23:42:54.5677953Z          let public = create_test_address("8.8.8.8", 8333);
2025-11-09T23:42:54.5678447Z -        
2025-11-09T23:42:54.5678799Z +
2025-11-09T23:42:54.5679106Z          assert!(db.is_local(&localhost));
2025-11-09T23:42:54.5679569Z          assert!(db.is_local(&private));
2025-11-09T23:42:54.5680967Z          assert!(!db.is_local(&public));
2025-11-09T23:42:54.5681808Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:460:
2025-11-09T23:42:54.5682944Z          let addr = create_test_address("192.168.1.1", 8333);
2025-11-09T23:42:54.5683611Z          let socket = SocketAddr::new("192.168.1.1".parse().unwrap(), 8333);
2025-11-09T23:42:54.5684224Z          let mut ban_list = HashMap::new();
2025-11-09T23:42:54.5684840Z -        
2025-11-09T23:42:54.5685124Z +
2025-11-09T23:42:54.5685406Z          // Not banned
2025-11-09T23:42:54.5685785Z          assert!(!db.is_banned(&addr, &ban_list));
2025-11-09T23:42:54.5686238Z -        
2025-11-09T23:42:54.5686511Z +
2025-11-09T23:42:54.5686791Z          // Banned (permanent)
2025-11-09T23:42:54.5687247Z          ban_list.insert(socket, u64::MAX);
2025-11-09T23:42:54.5687722Z          assert!(db.is_banned(&addr, &ban_list));
2025-11-09T23:42:54.5688551Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:470:
2025-11-09T23:42:54.5689325Z -        
2025-11-09T23:42:54.5689611Z +
2025-11-09T23:42:54.5689897Z          // Banned (temporary, not expired)
2025-11-09T23:42:54.5690770Z          ban_list.clear();
2025-11-09T23:42:54.5691186Z          let future_time = std::time::SystemTime::now()
2025-11-09T23:42:54.5691988Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:474:
2025-11-09T23:42:54.5693276Z              .duration_since(std::time::UNIX_EPOCH)
2025-11-09T23:42:54.5693924Z              .unwrap()
2025-11-09T23:42:54.5694261Z -            .as_secs() + 3600;
2025-11-09T23:42:54.5698333Z +            .as_secs()
2025-11-09T23:42:54.5698694Z +            + 3600;
2025-11-09T23:42:54.5699267Z          ban_list.insert(socket, future_time);
2025-11-09T23:42:54.5699820Z          assert!(db.is_banned(&addr, &ban_list));
2025-11-09T23:42:54.5700281Z -        
2025-11-09T23:42:54.5700557Z +
2025-11-09T23:42:54.5700843Z          // Banned (expired)
2025-11-09T23:42:54.5701213Z          ban_list.clear();
2025-11-09T23:42:54.5701663Z          let past_time = std::time::SystemTime::now()
2025-11-09T23:42:54.5702517Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:483:
2025-11-09T23:42:54.5703393Z              .duration_since(std::time::UNIX_EPOCH)
2025-11-09T23:42:54.5703848Z              .unwrap()
2025-11-09T23:42:54.5704196Z -            .as_secs() - 3600;
2025-11-09T23:42:54.5704730Z +            .as_secs()
2025-11-09T23:42:54.5705062Z +            - 3600;
2025-11-09T23:42:54.5705439Z          ban_list.insert(socket, past_time);
2025-11-09T23:42:54.5705924Z          assert!(!db.is_banned(&addr, &ban_list));
2025-11-09T23:42:54.5706379Z      }
2025-11-09T23:42:54.5707288Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:493:
2025-11-09T23:42:54.5708180Z          let local = create_test_address("127.0.0.1", 8333);
2025-11-09T23:42:54.5708740Z          let banned = create_test_address("192.168.1.1", 8333);
2025-11-09T23:42:54.5709315Z          let public = create_test_address("8.8.8.8", 8333);
2025-11-09T23:42:54.5709797Z -        
2025-11-09T23:42:54.5710076Z +
2025-11-09T23:42:54.5710566Z          let socket_banned = SocketAddr::new("192.168.1.1".parse().unwrap(), 8333);
2025-11-09T23:42:54.5711396Z          let socket_connected = SocketAddr::new("8.8.8.8".parse().unwrap(), 8333);
2025-11-09T23:42:54.5712064Z          let mut ban_list = HashMap::new();
2025-11-09T23:42:54.5712878Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:500:
2025-11-09T23:42:54.5713953Z          ban_list.insert(socket_banned, u64::MAX);
2025-11-09T23:42:54.5714745Z          let connected_peers = vec![socket_connected];
2025-11-09T23:42:54.5715249Z -        
2025-11-09T23:42:54.5715534Z +
2025-11-09T23:42:54.5715874Z          let addresses = vec![local, banned, public];
2025-11-09T23:42:54.5716569Z          let filtered = db.filter_addresses(addresses, &ban_list, &connected_peers);
2025-11-09T23:42:54.5717194Z -        
2025-11-09T23:42:54.5717466Z +
2025-11-09T23:42:54.5717811Z          // Should filter out local, banned, and connected
2025-11-09T23:42:54.5718576Z          assert_eq!(filtered.len(), 0);
2025-11-09T23:42:54.5718972Z      }
2025-11-09T23:42:54.5719631Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:513:
2025-11-09T23:42:54.5720491Z          let addr1 = create_test_address("192.168.1.1", 8333);
2025-11-09T23:42:54.5721063Z          let addr2 = create_test_address("192.168.1.2", 8333);
2025-11-09T23:42:54.5721621Z          let addr3 = create_test_address("192.168.1.3", 8333);
2025-11-09T23:42:54.5722095Z -        
2025-11-09T23:42:54.5722390Z +
2025-11-09T23:42:54.5722698Z          db.add_address(addr1.clone(), 1);
2025-11-09T23:42:54.5723166Z          db.add_address(addr2.clone(), 1);
2025-11-09T23:42:54.5723615Z          assert_eq!(db.len(), 2);
2025-11-09T23:42:54.5724658Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:520:
2025-11-09T23:42:54.5727867Z -        
2025-11-09T23:42:54.5728171Z +
2025-11-09T23:42:54.5728490Z          // Adding third should evict oldest
2025-11-09T23:42:54.5728976Z          db.add_address(addr3.clone(), 1);
2025-11-09T23:42:54.5729472Z          assert_eq!(db.len(), 2); // Should still be 2
2025-11-09T23:42:54.5730324Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:528:
2025-11-09T23:42:54.5731138Z      fn test_add_iroh_address() {
2025-11-09T23:42:54.5731588Z          use iroh_net::NodeId;
2025-11-09T23:42:54.5732027Z          let mut db = AddressDatabase::new(100);
2025-11-09T23:42:54.5732468Z -        
2025-11-09T23:42:54.5732762Z +
2025-11-09T23:42:54.5733057Z          // Create a test NodeId (32 bytes)
2025-11-09T23:42:54.5733510Z          let node_id_bytes = [0u8; 32];
2025-11-09T23:42:54.5734042Z          let node_id = NodeId::from_bytes(&node_id_bytes).unwrap();
2025-11-09T23:42:54.5735197Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:535:
2025-11-09T23:42:54.5735991Z -        
2025-11-09T23:42:54.5736286Z +
2025-11-09T23:42:54.5736584Z          db.add_iroh_address(node_id, 1);
2025-11-09T23:42:54.5737038Z          assert_eq!(db.total_count(), 1);
2025-11-09T23:42:54.5737456Z -        
2025-11-09T23:42:54.5737716Z +
2025-11-09T23:42:54.5738101Z          // Add same address again (should update, not duplicate)
2025-11-09T23:42:54.5738662Z          db.add_iroh_address(node_id, 2);
2025-11-09T23:42:54.5739118Z          assert_eq!(db.total_count(), 1);
2025-11-09T23:42:54.5739892Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:546:
2025-11-09T23:42:54.5740913Z      fn test_get_fresh_iroh_addresses() {
2025-11-09T23:42:54.5741337Z          use iroh_net::NodeId;
2025-11-09T23:42:54.5741739Z          let mut db = AddressDatabase::new(100);
2025-11-09T23:42:54.5742150Z -        
2025-11-09T23:42:54.5742396Z +
2025-11-09T23:42:54.5742668Z          let node_id1_bytes = [1u8; 32];
2025-11-09T23:42:54.5743083Z          let node_id2_bytes = [2u8; 32];
2025-11-09T23:42:54.5743629Z          let node_id1 = NodeId::from_bytes(&node_id1_bytes).unwrap();
2025-11-09T23:42:54.5744656Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:553:
2025-11-09T23:42:54.5745541Z          let node_id2 = NodeId::from_bytes(&node_id2_bytes).unwrap();
2025-11-09T23:42:54.5746498Z -        
2025-11-09T23:42:54.5746781Z +
2025-11-09T23:42:54.5747064Z          db.add_iroh_address(node_id1, 1);
2025-11-09T23:42:54.5747500Z          db.add_iroh_address(node_id2, 1);
2025-11-09T23:42:54.5747906Z -        
2025-11-09T23:42:54.5748192Z +
2025-11-09T23:42:54.5749360Z          let fresh = db.get_fresh_iroh_addresses(10);
2025-11-09T23:42:54.5749860Z          assert_eq!(fresh.len(), 2);
2025-11-09T23:42:54.5750257Z      }
2025-11-09T23:42:54.5750912Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:564:
2025-11-09T23:42:54.5751753Z      fn test_total_count_includes_iroh() {
2025-11-09T23:42:54.5752792Z          use iroh_net::NodeId;
2025-11-09T23:42:54.5753244Z          let mut db = AddressDatabase::new(100);
2025-11-09T23:42:54.5753682Z -        
2025-11-09T23:42:54.5753956Z +
2025-11-09T23:42:54.5754242Z          // Add SocketAddr address
2025-11-09T23:42:54.5754844Z          let addr = create_test_address("192.168.1.1", 8333);
2025-11-09T23:42:54.5754989Z          db.add_address(addr, 1);
2025-11-09T23:42:54.5755457Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:571:
2025-11-09T23:42:54.5755605Z          assert_eq!(db.total_count(), 1);
2025-11-09T23:42:54.5756149Z -        
2025-11-09T23:42:54.5756277Z +
2025-11-09T23:42:54.5756401Z          // Add Iroh address
2025-11-09T23:42:54.5756534Z          let node_id_bytes = [0u8; 32];
2025-11-09T23:42:54.5760223Z          let node_id = NodeId::from_bytes(&node_id_bytes).unwrap();
2025-11-09T23:42:54.5760786Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:15:
2025-11-09T23:42:54.5760974Z  /// - Combine reasons from all sources
2025-11-09T23:42:54.5761316Z  pub fn merge_ban_lists(ban_lists: Vec<&BanListMessage>) -> Vec<BanEntry> {
2025-11-09T23:42:54.5761652Z      let mut merged: HashMap<NetworkAddress, BanEntry> = HashMap::new();
2025-11-09T23:42:54.5761769Z -    
2025-11-09T23:42:54.5761881Z +
2025-11-09T23:42:54.5762051Z      for ban_list in ban_lists {
2025-11-09T23:42:54.5762191Z          if !ban_list.is_full {
2025-11-09T23:42:54.5762375Z              continue; // Skip hash-only responses
2025-11-09T23:42:54.5762920Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:22:
2025-11-09T23:42:54.5763042Z          }
2025-11-09T23:42:54.5763151Z -        
2025-11-09T23:42:54.5763258Z +
2025-11-09T23:42:54.5763425Z          for entry in &ban_list.ban_entries {
2025-11-09T23:42:54.5763583Z              let addr = entry.addr.clone();
2025-11-09T23:42:54.5763701Z -            
2025-11-09T23:42:54.5763817Z +
2025-11-09T23:42:54.5763975Z              match merged.get_mut(&addr) {
2025-11-09T23:42:54.5764111Z                  Some(existing) => {
2025-11-09T23:42:54.5764472Z                      // Conflict resolution: use longest ban
2025-11-09T23:42:54.5765027Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:36:
2025-11-09T23:42:54.5765267Z                              existing.unban_timestamp = entry.unban_timestamp;
2025-11-09T23:42:54.5765389Z                          }
2025-11-09T23:42:54.5765508Z                      }
2025-11-09T23:42:54.5765884Z -                    
2025-11-09T23:42:54.5765998Z +
2025-11-09T23:42:54.5766149Z                      // Merge reasons
2025-11-09T23:42:54.5766338Z                      if let Some(ref reason) = entry.reason {
2025-11-09T23:42:54.5766588Z -                        existing.reason = existing.reason.as_ref().map(|r| {
2025-11-09T23:42:54.5766746Z -                            format!("{}; {}", r, reason)
2025-11-09T23:42:54.5766937Z -                        }).or_else(|| Some(reason.clone()));
2025-11-09T23:42:54.5767098Z +                        existing.reason = existing
2025-11-09T23:42:54.5767225Z +                            .reason
2025-11-09T23:42:54.5767368Z +                            .as_ref()
2025-11-09T23:42:54.5767545Z +                            .map(|r| format!("{}; {}", r, reason))
2025-11-09T23:42:54.5767716Z +                            .or_else(|| Some(reason.clone()));
2025-11-09T23:42:54.5767847Z                      }
2025-11-09T23:42:54.5767963Z                  }
2025-11-09T23:42:54.5768099Z                  None => {
2025-11-09T23:42:54.5768644Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:50:
2025-11-09T23:42:54.5768774Z              }
2025-11-09T23:42:54.5768884Z          }
2025-11-09T23:42:54.5768998Z      }
2025-11-09T23:42:54.5769115Z -    
2025-11-09T23:42:54.5769228Z +
2025-11-09T23:42:54.5769376Z      // Convert to sorted vector
2025-11-09T23:42:54.5769886Z      let mut result: Vec<BanEntry> = merged.into_values().collect();
2025-11-09T23:42:54.5770021Z      result.sort_by(|a, b| {
2025-11-09T23:42:54.5770511Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:57:
2025-11-09T23:42:54.5770704Z          // Sort by address for deterministic output
2025-11-09T23:42:54.5770859Z -        a.addr.ip.cmp(&b.addr.ip)
2025-11-09T23:42:54.5770974Z +        a.addr
2025-11-09T23:42:54.5771088Z +            .ip
2025-11-09T23:42:54.5771222Z +            .cmp(&b.addr.ip)
2025-11-09T23:42:54.5771438Z              .then_with(|| a.addr.port.cmp(&b.addr.port))
2025-11-09T23:42:54.5771558Z      });
2025-11-09T23:42:54.5771673Z -    
2025-11-09T23:42:54.5771791Z +
2025-11-09T23:42:54.5771909Z      result
2025-11-09T23:42:54.5772016Z  }
2025-11-09T23:42:54.5772127Z  
2025-11-09T23:42:54.5772674Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:72:
2025-11-09T23:42:54.5772841Z              .duration_since(UNIX_EPOCH)
2025-11-09T23:42:54.5772968Z              .unwrap()
2025-11-09T23:42:54.5773104Z              .as_secs();
2025-11-09T23:42:54.5773219Z -        
2025-11-09T23:42:54.5773328Z +
2025-11-09T23:42:54.5773485Z          if now >= entry.unban_timestamp {
2025-11-09T23:42:54.5773668Z              return false; // Ban already expired
2025-11-09T23:42:54.5773782Z          }
2025-11-09T23:42:54.5774531Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:79:
2025-11-09T23:42:54.5774673Z      }
2025-11-09T23:42:54.5774792Z -    
2025-11-09T23:42:54.5774903Z +
2025-11-09T23:42:54.5775077Z      // Additional validation could include:
2025-11-09T23:42:54.5775245Z      // - IP address format validation
2025-11-09T23:42:54.5775386Z      // - Reason length limits
2025-11-09T23:42:54.5775912Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:84:
2025-11-09T23:42:54.5776040Z      // - etc.
2025-11-09T23:42:54.5776162Z -    
2025-11-09T23:42:54.5776270Z +
2025-11-09T23:42:54.5776379Z      true
2025-11-09T23:42:54.5776495Z  }
2025-11-09T23:42:54.5776601Z  
2025-11-09T23:42:54.5777118Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:89:
2025-11-09T23:42:54.5777314Z  /// Calculate hash of ban list (for verification)
2025-11-09T23:42:54.5777600Z  pub fn calculate_ban_list_hash(entries: &[BanEntry]) -> [u8; 32] {
2025-11-09T23:42:54.5777749Z -    use sha2::{Sha256, Digest};
2025-11-09T23:42:54.5777860Z -    
2025-11-09T23:42:54.5778266Z +    use sha2::{Digest, Sha256};
2025-11-09T23:42:54.5778383Z +
2025-11-09T23:42:54.5778562Z      // Sort entries for deterministic hashing
2025-11-09T23:42:54.5778727Z      let mut sorted = entries.to_vec();
2025-11-09T23:42:54.5778869Z      sorted.sort_by(|a, b| {
2025-11-09T23:42:54.5779399Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:96:
2025-11-09T23:42:54.5779551Z -        a.addr.ip.cmp(&b.addr.ip)
2025-11-09T23:42:54.5779670Z +        a.addr
2025-11-09T23:42:54.5779787Z +            .ip
2025-11-09T23:42:54.5779922Z +            .cmp(&b.addr.ip)
2025-11-09T23:42:54.5780118Z              .then_with(|| a.addr.port.cmp(&b.addr.port))
2025-11-09T23:42:54.5780220Z      });
2025-11-09T23:42:54.5780322Z -    
2025-11-09T23:42:54.5780420Z +
2025-11-09T23:42:54.5780548Z      // Serialize and hash
2025-11-09T23:42:54.5780850Z      let serialized = bincode::serialize(&sorted).unwrap_or_default();
2025-11-09T23:42:54.5781035Z      let hash = Sha256::digest(&serialized);
2025-11-09T23:42:54.5781567Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:103:
2025-11-09T23:42:54.5781684Z -    
2025-11-09T23:42:54.5781794Z +
2025-11-09T23:42:54.5781947Z      let mut result = [0u8; 32];
2025-11-09T23:42:54.5783887Z      result.copy_from_slice(&hash);
2025-11-09T23:42:54.5784000Z      result
2025-11-09T23:42:54.5785054Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:111:
2025-11-09T23:42:54.5785287Z      let calculated = calculate_ban_list_hash(entries);
2025-11-09T23:42:54.5785435Z      calculated == *expected_hash
2025-11-09T23:42:54.5785547Z  }
2025-11-09T23:42:54.5785663Z -
2025-11-09T23:42:54.5785766Z -
2025-11-09T23:42:54.5785871Z -
2025-11-09T23:42:54.5785981Z  
2025-11-09T23:42:54.5786522Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_signing.rs:2:
2025-11-09T23:42:54.5786633Z  //!
2025-11-09T23:42:54.5786966Z  //! Provides functions to sign and verify ban lists for authenticity.
2025-11-09T23:42:54.5787087Z  
2025-11-09T23:42:54.5787358Z -use crate::network::protocol::{BanListMessage, BanEntry};
2025-11-09T23:42:54.5787725Z -use secp256k1::{Secp256k1, Message, ecdsa::Signature, SecretKey, PublicKey};
2025-11-09T23:42:54.5787977Z +use crate::network::protocol::{BanEntry, BanListMessage};
2025-11-09T23:42:54.5788314Z +use secp256k1::{ecdsa::Signature, Message, PublicKey, Secp256k1, SecretKey};
2025-11-09T23:42:54.5788439Z  
2025-11-09T23:42:54.5788600Z  /// Sign a ban list with a private key
2025-11-09T23:42:54.5788721Z  ///
2025-11-09T23:42:54.5789266Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_signing.rs:13:
2025-11-09T23:42:54.5789425Z      private_key: &SecretKey,
2025-11-09T23:42:54.5789598Z  ) -> Result<Vec<u8>, secp256k1::Error> {
2025-11-09T23:42:54.5789765Z      let secp = Secp256k1::new();
2025-11-09T23:42:54.5789883Z -    
2025-11-09T23:42:54.5789999Z +
2025-11-09T23:42:54.5790164Z      // Serialize ban list for signing
2025-11-09T23:42:54.5790370Z -    let serialized = bincode::serialize(ban_list)
2025-11-09T23:42:54.5790585Z -        .map_err(|_| secp256k1::Error::InvalidMessage)?;
2025-11-09T23:42:54.5790709Z -    
2025-11-09T23:42:54.5791162Z +    let serialized = bincode::serialize(ban_list).map_err(|_| secp256k1::Error::InvalidMessage)?;
2025-11-09T23:42:54.5791295Z +
2025-11-09T23:42:54.5791444Z      // Hash the serialized data
2025-11-09T23:42:54.5791601Z -    use sha2::{Sha256, Digest};
2025-11-09T23:42:54.5791741Z +    use sha2::{Digest, Sha256};
2025-11-09T23:42:54.5791914Z      let hash = Sha256::digest(&serialized);
2025-11-09T23:42:54.5792030Z -    
2025-11-09T23:42:54.5792139Z +
2025-11-09T23:42:54.5792281Z      // Create message from hash
2025-11-09T23:42:54.5792457Z -    let message = Message::from_slice(&hash)
2025-11-09T23:42:54.5792670Z -        .map_err(|_| secp256k1::Error::InvalidMessage)?;
2025-11-09T23:42:54.5793038Z -    
2025-11-09T23:42:54.5793442Z +    let message = Message::from_slice(&hash).map_err(|_| secp256k1::Error::InvalidMessage)?;
2025-11-09T23:42:54.5793569Z +
2025-11-09T23:42:54.5793688Z      // Sign
2025-11-09T23:42:54.5797066Z      let signature = secp.sign_ecdsa(&message, private_key);
2025-11-09T23:42:54.5797217Z -    
2025-11-09T23:42:54.5797328Z +
2025-11-09T23:42:54.5797464Z      // Serialize signature
2025-11-09T23:42:54.5797655Z      Ok(signature.serialize_compact().to_vec())
2025-11-09T23:42:54.5797765Z  }
2025-11-09T23:42:54.5798500Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_signing.rs:44:
2025-11-09T23:42:54.5798659Z      if signature.len() != 64 {
2025-11-09T23:42:54.5798790Z          return Ok(false);
2025-11-09T23:42:54.5802412Z      }
2025-11-09T23:42:54.5802548Z -    
2025-11-09T23:42:54.5802658Z +
2025-11-09T23:42:54.5802835Z      let secp = Secp256k1::new();
2025-11-09T23:42:54.5802949Z -    
2025-11-09T23:42:54.5803054Z +
2025-11-09T23:42:54.5803199Z      // Serialize ban list
2025-11-09T23:42:54.5803403Z -    let serialized = bincode::serialize(ban_list)
2025-11-09T23:42:54.5803609Z -        .map_err(|_| secp256k1::Error::InvalidMessage)?;
2025-11-09T23:42:54.5803714Z -    
2025-11-09T23:42:54.5804147Z +    let serialized = bincode::serialize(ban_list).map_err(|_| secp256k1::Error::InvalidMessage)?;
2025-11-09T23:42:54.5804257Z +
2025-11-09T23:42:54.5804557Z      // Hash the serialized data
2025-11-09T23:42:54.5804957Z -    use sha2::{Sha256, Digest};
2025-11-09T23:42:54.5805097Z +    use sha2::{Digest, Sha256};
2025-11-09T23:42:54.5805259Z      let hash = Sha256::digest(&serialized);
2025-11-09T23:42:54.5805364Z -    
2025-11-09T23:42:54.5805473Z +
2025-11-09T23:42:54.5805607Z      // Create message from hash
2025-11-09T23:42:54.5805776Z -    let message = Message::from_slice(&hash)
2025-11-09T23:42:54.5805976Z -        .map_err(|_| secp256k1::Error::InvalidMessage)?;
2025-11-09T23:42:54.5806089Z -    
2025-11-09T23:42:54.5806469Z +    let message = Message::from_slice(&hash).map_err(|_| secp256k1::Error::InvalidMessage)?;
2025-11-09T23:42:54.5806582Z +
2025-11-09T23:42:54.5806717Z      // Parse signature
2025-11-09T23:42:54.5806904Z -    let sig = Signature::from_compact(signature)
2025-11-09T23:42:54.5807104Z -        .map_err(|_| secp256k1::Error::InvalidSignature)?;
2025-11-09T23:42:54.5807207Z -    
2025-11-09T23:42:54.5807637Z +    let sig = Signature::from_compact(signature).map_err(|_| secp256k1::Error::InvalidSignature)?;
2025-11-09T23:42:54.5807752Z +
2025-11-09T23:42:54.5807863Z      // Verify
2025-11-09T23:42:54.5808108Z      Ok(secp.verify_ecdsa(&message, &sig, public_key).is_ok())
2025-11-09T23:42:54.5808216Z  }
2025-11-09T23:42:54.5808735Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_signing.rs:86:
2025-11-09T23:42:54.5808904Z      ) -> Result<Self, secp256k1::Error> {
2025-11-09T23:42:54.5809058Z          let secp = Secp256k1::new();
2025-11-09T23:42:54.5809338Z          let public_key = PublicKey::from_secret_key(&secp, private_key);
2025-11-09T23:42:54.5809455Z -        
2025-11-09T23:42:54.5809568Z +
2025-11-09T23:42:54.5809807Z          let signature = sign_ban_list(&ban_list, private_key)?;
2025-11-09T23:42:54.5809927Z -        
2025-11-09T23:42:54.5810042Z +
2025-11-09T23:42:54.5810162Z          Ok(Self {
2025-11-09T23:42:54.5810282Z              ban_list,
2025-11-09T23:42:54.5810406Z              signature,
2025-11-09T23:42:54.5810945Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_signing.rs:95:
2025-11-09T23:42:54.5811080Z              public_key,
2025-11-09T23:42:54.5811191Z          })
2025-11-09T23:42:54.5811309Z      }
2025-11-09T23:42:54.5811409Z -    
2025-11-09T23:42:54.5811508Z +
2025-11-09T23:42:54.5811635Z      /// Verify the signature
2025-11-09T23:42:54.5811875Z      pub fn verify(&self) -> Result<bool, secp256k1::Error> {
2025-11-09T23:42:54.5812221Z          verify_ban_list_signature(&self.ban_list, &self.signature, &self.public_key)
2025-11-09T23:42:54.5813016Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_signing.rs:102:
2025-11-09T23:42:54.5813144Z      }
2025-11-09T23:42:54.5813256Z  }
2025-11-09T23:42:54.5813368Z -
2025-11-09T23:42:54.5813476Z -
2025-11-09T23:42:54.5813594Z  
2025-11-09T23:42:54.5814462Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:4:
2025-11-09T23:42:54.5814649Z  //! using the BlockFilterService.
2025-11-09T23:42:54.5814770Z  
2025-11-09T23:42:54.5815026Z  use crate::network::filter_service::BlockFilterService;
2025-11-09T23:42:54.5815181Z -use crate::storage::Storage;
2025-11-09T23:42:54.5815341Z  use crate::network::protocol::{
2025-11-09T23:42:54.5817661Z      CfcheckptMessage, CfheadersMessage, CfilterMessage, FilterHeaderData, GetCfcheckptMessage,
2025-11-09T23:42:54.5817958Z      GetCfheadersMessage, GetCfiltersMessage, ProtocolMessage,
2025-11-09T23:42:54.5818487Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:11:
2025-11-09T23:42:54.5818627Z  };
2025-11-09T23:42:54.5818786Z +use crate::storage::Storage;
2025-11-09T23:42:54.5818934Z  use anyhow::{anyhow, Result};
2025-11-09T23:42:54.5819098Z  use bllvm_protocol::Hash;
2025-11-09T23:42:54.5819233Z  use std::sync::Arc;
2025-11-09T23:42:54.5819753Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:30:
2025-11-09T23:42:54.5820210Z          // Get current height to determine stop height
2025-11-09T23:42:54.5820542Z          let current_height = storage.chain().get_height()?.unwrap_or(0) as u32;
2025-11-09T23:42:54.5820723Z          let start_height = request.start_height;
2025-11-09T23:42:54.5820841Z -        
2025-11-09T23:42:54.5820958Z +
2025-11-09T23:42:54.5821252Z          // Find stop height by iterating from start until we find stop_hash
2025-11-09T23:42:54.5821417Z          let mut stop_height = start_height;
2025-11-09T23:42:54.5821573Z          let mut found_stop = false;
2025-11-09T23:42:54.5822098Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:37:
2025-11-09T23:42:54.5822214Z -        
2025-11-09T23:42:54.5822326Z +
2025-11-09T23:42:54.5822518Z          // Iterate through blocks from start_height
2025-11-09T23:42:54.5822835Z          for height in start_height..=current_height.min(start_height + 2000) {
2025-11-09T23:42:54.5823025Z              // Get block hash by height, then get block
2025-11-09T23:42:54.5823548Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:41:
2025-11-09T23:42:54.5823909Z              if let Ok(Some(block_hash)) = storage.blocks().get_hash_by_height(height as u64) {
2025-11-09T23:42:54.5824179Z                  if let Ok(Some(block)) = storage.blocks().get_block(&block_hash) {
2025-11-09T23:42:54.5824643Z -                
2025-11-09T23:42:54.5824846Z                      // Calculate block hash properly
2025-11-09T23:42:54.5825078Z                      use crate::storage::hashing::double_sha256;
2025-11-09T23:42:54.5825248Z                      let mut header_data = Vec::new();
2025-11-09T23:42:54.5827605Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:51:
2025-11-09T23:42:54.5827905Z                      header_data.extend_from_slice(&block.header.bits.to_le_bytes());
2025-11-09T23:42:54.5828221Z                      header_data.extend_from_slice(&block.header.nonce.to_le_bytes());
2025-11-09T23:42:54.5828458Z                      let calculated_hash = double_sha256(&header_data);
2025-11-09T23:42:54.5828583Z -                    
2025-11-09T23:42:54.5828697Z +
2025-11-09T23:42:54.5828876Z                      // Check if this is the stop hash
2025-11-09T23:42:54.5829573Z                      if calculated_hash == request.stop_hash {
2025-11-09T23:42:54.5829745Z                          found_stop = true;
2025-11-09T23:42:54.5830271Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:58:
2025-11-09T23:42:54.5830710Z                          stop_height = height;
2025-11-09T23:42:54.5830838Z                      }
2025-11-09T23:42:54.5830953Z -                    
2025-11-09T23:42:54.5831070Z +
2025-11-09T23:42:54.5831230Z                      // Try to get cached filter
2025-11-09T23:42:54.5831590Z                      let filter = if let Some(cached) = filter_service.get_filter(&calculated_hash) {
2025-11-09T23:42:54.5831736Z                          cached
2025-11-09T23:42:54.5832248Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:72:
2025-11-09T23:42:54.5832381Z                                  }
2025-11-09T23:42:54.5832506Z                              }
2025-11-09T23:42:54.5832634Z                          }
2025-11-09T23:42:54.5832748Z -                        
2025-11-09T23:42:54.5832857Z +
2025-11-09T23:42:54.5833236Z                          filter_service.generate_and_cache_filter(&block, &prev_scripts, height)?
2025-11-09T23:42:54.5833370Z                      };
2025-11-09T23:42:54.5833482Z -                    
2025-11-09T23:42:54.5833590Z +
2025-11-09T23:42:54.5833907Z                      responses.push(ProtocolMessage::Cfilter(CfilterMessage {
2025-11-09T23:42:54.5834059Z                          filter_type: 0,
2025-11-09T23:42:54.5834234Z                          block_hash: calculated_hash,
2025-11-09T23:42:54.5835306Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:82:
2025-11-09T23:42:54.5835497Z                          filter_data: filter.filter_data,
2025-11-09T23:42:54.5835666Z                          num_elements: filter.num_elements,
2025-11-09T23:42:54.5835791Z                      }));
2025-11-09T23:42:54.5835901Z -                    
2025-11-09T23:42:54.5836006Z +
2025-11-09T23:42:54.5836138Z                      if found_stop {
2025-11-09T23:42:54.5836261Z                          break;
2025-11-09T23:42:54.5836383Z                      }
2025-11-09T23:42:54.5836889Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:89:
2025-11-09T23:42:54.5837017Z                  }
2025-11-09T23:42:54.5837129Z              }
2025-11-09T23:42:54.5837237Z          }
2025-11-09T23:42:54.5837345Z -        
2025-11-09T23:42:54.5837464Z +
2025-11-09T23:42:54.5837701Z          if !found_stop && stop_height < current_height {
2025-11-09T23:42:54.5837982Z              // Stop hash not found in reasonable range, return what we have
2025-11-09T23:42:54.5838091Z          }
2025-11-09T23:42:54.5838593Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip70_handler.rs:3:
2025-11-09T23:42:54.5838848Z  //! Handles incoming BIP70 messages from the P2P network.
2025-11-09T23:42:54.5839015Z  //! Similar to bip157_handler.rs pattern.
2025-11-09T23:42:54.5839123Z  
2025-11-09T23:42:54.5839708Z -use bllvm_protocol::payment::{Bip70Error, PaymentProtocolClient, PaymentProtocolServer, PaymentRequest};
2025-11-09T23:42:54.5839884Z  use crate::network::protocol::{
2025-11-09T23:42:54.5840345Z      GetPaymentRequestMessage, PaymentACKMessage, PaymentMessage, PaymentRequestMessage,
2025-11-09T23:42:54.5840493Z      ProtocolMessage,
2025-11-09T23:42:54.5841018Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip70_handler.rs:10:
2025-11-09T23:42:54.5841134Z  };
2025-11-09T23:42:54.5841285Z  use anyhow::Result;
2025-11-09T23:42:54.5841447Z +use bllvm_protocol::payment::{
2025-11-09T23:42:54.5841836Z +    Bip70Error, PaymentProtocolClient, PaymentProtocolServer, PaymentRequest,
2025-11-09T23:42:54.5841950Z +};
2025-11-09T23:42:54.5842073Z +use hex;
2025-11-09T23:42:54.5842226Z  use std::collections::HashMap;
2025-11-09T23:42:54.5842370Z  use std::sync::{Arc, Mutex};
2025-11-09T23:42:54.5842484Z -use hex;
2025-11-09T23:42:54.5842602Z  
2025-11-09T23:42:54.5843050Z  /// In-memory payment request store (simplified - would use persistent storage in production)
2025-11-09T23:42:54.5843659Z  type PaymentRequestStore = Arc<Mutex<HashMap<String, PaymentRequest>>>;
2025-11-09T23:42:54.5844195Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip70_handler.rs:25:
2025-11-09T23:42:54.5844535Z  ) -> Result<PaymentRequestMessage> {
2025-11-09T23:42:54.5844702Z      if let Some(store) = payment_store {
2025-11-09T23:42:54.5844862Z          let store = store.lock().unwrap();
2025-11-09T23:42:54.5845325Z -        let key = format!("{}_{}", hex::encode(&request.payment_id), hex::encode(&request.merchant_pubkey));
2025-11-09T23:42:54.5845466Z +        let key = format!(
2025-11-09T23:42:54.5845584Z +            "{}_{}",
2025-11-09T23:42:54.5845773Z +            hex::encode(&request.payment_id),
2025-11-09T23:42:54.5845956Z +            hex::encode(&request.merchant_pubkey)
2025-11-09T23:42:54.5846076Z +        );
2025-11-09T23:42:54.5846459Z          if let Some(payment_request) = store.get(&key) {
2025-11-09T23:42:54.5846697Z              // Convert to P2P message format
2025-11-09T23:42:54.5847239Z              // Note: In production, merchant_signature would be generated by signing payment_request
2025-11-09T23:42:54.5848381Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip70_handler.rs:37:
2025-11-09T23:42:54.5848591Z              });
2025-11-09T23:42:54.5861318Z          }
2025-11-09T23:42:54.5861494Z      }
2025-11-09T23:42:54.5861856Z -    
2025-11-09T23:42:54.5861964Z +
2025-11-09T23:42:54.5862204Z      Err(anyhow::anyhow!("Payment request not found"))
2025-11-09T23:42:54.5862319Z  }
2025-11-09T23:42:54.5862436Z  
2025-11-09T23:42:54.5862954Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip70_handler.rs:58:
2025-11-09T23:42:54.5863066Z      } else {
2025-11-09T23:42:54.5863187Z          None
2025-11-09T23:42:54.5863298Z      };
2025-11-09T23:42:54.5863414Z -    
2025-11-09T23:42:54.5863523Z +
2025-11-09T23:42:54.5863709Z      if let Some(request) = original_request {
2025-11-09T23:42:54.5863892Z          // Use existing process_payment function
2025-11-09T23:42:54.5864131Z          use bllvm_protocol::payment::PaymentProtocolServer;
2025-11-09T23:42:54.5864829Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip70_handler.rs:65:
2025-11-09T23:42:54.5865448Z -        let payment_ack = PaymentProtocolServer::process_payment(&payment_msg.payment, &request, merchant_private_key)
2025-11-09T23:42:54.5865786Z -            .map_err(|e| anyhow::anyhow!("Payment processing failed: {:?}", e))?;
2025-11-09T23:42:54.5865915Z -        
2025-11-09T23:42:54.5866198Z +        let payment_ack = PaymentProtocolServer::process_payment(
2025-11-09T23:42:54.5866351Z +            &payment_msg.payment,
2025-11-09T23:42:54.5866477Z +            &request,
2025-11-09T23:42:54.5866634Z +            merchant_private_key,
2025-11-09T23:42:54.5866751Z +        )
2025-11-09T23:42:54.5867054Z +        .map_err(|e| anyhow::anyhow!("Payment processing failed: {:?}", e))?;
2025-11-09T23:42:54.5867198Z +
2025-11-09T23:42:54.5867365Z          // Convert to P2P message format
2025-11-09T23:42:54.5867513Z          Ok(PaymentACKMessage {
2025-11-09T23:42:54.5867645Z              payment_ack,
2025-11-09T23:42:54.5868190Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip70_handler.rs:79:
2025-11-09T23:42:54.5868413Z  /// Validate PaymentRequest message from P2P network
2025-11-09T23:42:54.5868876Z  pub fn validate_payment_request_message(msg: &PaymentRequestMessage) -> Result<(), Bip70Error> {
2025-11-09T23:42:54.5869139Z      use bllvm_protocol::payment::PaymentProtocolClient;
2025-11-09T23:42:54.5869669Z -    PaymentProtocolClient::validate_payment_request(&msg.payment_request, Some(&msg.merchant_pubkey))
2025-11-09T23:42:54.5869902Z +    PaymentProtocolClient::validate_payment_request(
2025-11-09T23:42:54.5870062Z +        &msg.payment_request,
2025-11-09T23:42:54.5870213Z +        Some(&msg.merchant_pubkey),
2025-11-09T23:42:54.5870327Z +    )
2025-11-09T23:42:54.5870701Z  }
2025-11-09T23:42:54.5870823Z  
2025-11-09T23:42:54.5871017Z  /// Validate PaymentACK message from merchant
2025-11-09T23:42:54.5871537Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip70_handler.rs:88:
2025-11-09T23:42:54.5871707Z      merchant_pubkey: &[u8],
2025-11-09T23:42:54.5871858Z  ) -> Result<(), Bip70Error> {
2025-11-09T23:42:54.5872113Z      use bllvm_protocol::payment::PaymentProtocolClient;
2025-11-09T23:42:54.5872698Z -    PaymentProtocolClient::validate_payment_ack(&ack.payment_ack, &ack.merchant_signature, merchant_pubkey)
2025-11-09T23:42:54.5872908Z +    PaymentProtocolClient::validate_payment_ack(
2025-11-09T23:42:54.5873048Z +        &ack.payment_ack,
2025-11-09T23:42:54.5873187Z +        &ack.merchant_signature,
2025-11-09T23:42:54.5873324Z +        merchant_pubkey,
2025-11-09T23:42:54.5873437Z +    )
2025-11-09T23:42:54.5873548Z  }
2025-11-09T23:42:54.5873671Z  
2025-11-09T23:42:54.5874185Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/chain_access.rs:3:
2025-11-09T23:42:54.5874693Z  //! Implements ChainStateAccess trait to bridge node storage modules
2025-11-09T23:42:54.5875083Z  //! (BlockStore, TxIndex, MempoolManager) with protocol layer network processing.
2025-11-09T23:42:54.5875203Z  
2025-11-09T23:42:54.5875379Z +use crate::node::mempool::MempoolManager;
2025-11-09T23:42:54.5875640Z +use crate::storage::{blockstore::BlockStore, txindex::TxIndex};
2025-11-09T23:42:54.5876021Z  use anyhow::Result;
2025-11-09T23:42:54.5876289Z  use bllvm_protocol::network::{ChainObject, ChainStateAccess};
2025-11-09T23:42:54.5876545Z  use bllvm_protocol::{Block, BlockHeader, Hash, Transaction};
2025-11-09T23:42:54.5877048Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/chain_access.rs:9:
2025-11-09T23:42:54.5877239Z -use crate::node::mempool::MempoolManager;
2025-11-09T23:42:54.5877514Z -use crate::storage::{blockstore::BlockStore, txindex::TxIndex};
2025-11-09T23:42:54.5877664Z  use std::sync::Arc;
2025-11-09T23:42:54.5877787Z  
2025-11-09T23:42:54.5878167Z  /// Chain state access implementation that bridges node storage to protocol layer
2025-11-09T23:42:54.5878688Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/chain_access.rs:68:
2025-11-09T23:42:54.5878923Z      /// This implements the Bitcoin block locator algorithm
2025-11-09T23:42:54.5879298Z      fn get_headers_for_locator(&self, locator: &[Hash], stop: &Hash) -> Vec<BlockHeader> {
2025-11-09T23:42:54.5879482Z          let mut headers = Vec::new();
2025-11-09T23:42:54.5879606Z -        
2025-11-09T23:42:54.5879715Z +
2025-11-09T23:42:54.5879879Z          // Bitcoin block locator algorithm:
2025-11-09T23:42:54.5880059Z          // 1. Start with the most recent block hash
2025-11-09T23:42:54.5880396Z          // 2. Go back exponentially (1, 2, 4, 8, 16, ...) until we find a common ancestor
2025-11-09T23:42:54.5880916Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/chain_access.rs:75:
2025-11-09T23:42:54.5881171Z          // 3. Stop when we reach the stop hash or run out of hashes
2025-11-09T23:42:54.5881296Z -        
2025-11-09T23:42:54.5881407Z +
2025-11-09T23:42:54.5881547Z          for hash in locator {
2025-11-09T23:42:54.5881724Z              // If we've reached the stop hash, stop
2025-11-09T23:42:54.5881858Z              if hash == stop {
2025-11-09T23:42:54.5882356Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/chain_access.rs:80:
2025-11-09T23:42:54.5882484Z                  break;
2025-11-09T23:42:54.5882609Z              }
2025-11-09T23:42:54.5882725Z -            
2025-11-09T23:42:54.5882832Z +
2025-11-09T23:42:54.5882988Z              // Try to get the header
2025-11-09T23:42:54.5883247Z              if let Ok(Some(header)) = self.blockstore.get_header(hash) {
2025-11-09T23:42:54.5883402Z                  headers.push(header);
2025-11-09T23:42:54.5883905Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/chain_access.rs:89:
2025-11-09T23:42:54.5884594Z                  continue;
2025-11-09T23:42:54.5884730Z              }
2025-11-09T23:42:54.5884844Z          }
2025-11-09T23:42:54.5884965Z -        
2025-11-09T23:42:54.5885070Z +
2025-11-09T23:42:54.5885186Z          headers
2025-11-09T23:42:54.5885296Z      }
2025-11-09T23:42:54.5885417Z  
2025-11-09T23:42:54.5885922Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/chain_access.rs:130:
2025-11-09T23:42:54.5886067Z      height: Option<u64>,
2025-11-09T23:42:54.5886315Z  ) -> Result<bllvm_protocol::network::NetworkResponse> {
2025-11-09T23:42:54.5886668Z      use bllvm_protocol::network::{process_network_message, ChainStateAccess};
2025-11-09T23:42:54.5886782Z -    
2025-11-09T23:42:54.5886894Z +
2025-11-09T23:42:54.5887053Z      process_network_message(
2025-11-09T23:42:54.5887170Z          engine,
2025-11-09T23:42:54.5887290Z          message,
2025-11-09T23:42:54.5887785Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/chain_access.rs:138:
2025-11-09T23:42:54.5887991Z          Some(chain_access as &dyn ChainStateAccess),
2025-11-09T23:42:54.5888102Z          utxo_set,
2025-11-09T23:42:54.5888220Z          height,
2025-11-09T23:42:54.5888509Z -    ).map_err(|e| anyhow::anyhow!("Network message processing error: {}", e))
2025-11-09T23:42:54.5888617Z +    )
2025-11-09T23:42:54.5888908Z +    .map_err(|e| anyhow::anyhow!("Network message processing error: {}", e))
2025-11-09T23:42:54.5889263Z  }
2025-11-09T23:42:54.5889374Z -
2025-11-09T23:42:54.5889483Z  
2025-11-09T23:42:54.5890104Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dns_seeds.rs:38:
2025-11-09T23:42:54.5890258Z      max_addresses: usize,
2025-11-09T23:42:54.5890414Z  ) -> Vec<NetworkAddress> {
2025-11-09T23:42:54.5890578Z      let mut addresses = Vec::new();
2025-11-09T23:42:54.5890688Z -    
2025-11-09T23:42:54.5890808Z +
2025-11-09T23:42:54.5890943Z      for seed in seeds {
2025-11-09T23:42:54.5891144Z          match resolve_dns_seed(*seed, port).await {
2025-11-09T23:42:54.5891280Z              Ok(mut addrs) => {
2025-11-09T23:42:54.5891774Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dns_seeds.rs:53:
2025-11-09T23:42:54.5891890Z              }
2025-11-09T23:42:54.5892001Z          }
2025-11-09T23:42:54.5892120Z      }
2025-11-09T23:42:54.5892231Z -    
2025-11-09T23:42:54.5892349Z +
2025-11-09T23:42:54.5892490Z      // Limit to max_addresses
2025-11-09T23:42:54.5892660Z      addresses.truncate(max_addresses);
2025-11-09T23:42:54.5892780Z      addresses
2025-11-09T23:42:54.5893251Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dns_seeds.rs:63:
2025-11-09T23:42:54.5893642Z  async fn resolve_dns_seed(seed: &str, port: u16) -> Result<Vec<NetworkAddress>, String> {
2025-11-09T23:42:54.5893840Z      // Create hostname:port string for DNS lookup
2025-11-09T23:42:54.5894021Z      let hostname = format!("{}:{}", seed, port);
2025-11-09T23:42:54.5894146Z -    
2025-11-09T23:42:54.5894264Z +
2025-11-09T23:42:54.5894595Z      // Perform DNS lookup with timeout
2025-11-09T23:42:54.5894784Z      let timeout = Duration::from_secs(5);
2025-11-09T23:42:54.5895131Z      let lookup_result = tokio::time::timeout(timeout, lookup_host(&hostname))
2025-11-09T23:42:54.5895619Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dns_seeds.rs:70:
2025-11-09T23:42:54.5895751Z          .await
2025-11-09T23:42:54.5895998Z          .map_err(|_| format!("DNS lookup timeout for {}", seed))?;
2025-11-09T23:42:54.5896117Z -    
2025-11-09T23:42:54.5896264Z -    let socket_addrs = lookup_result
2025-11-09T23:42:54.5896508Z -        .map_err(|e| format!("DNS lookup failed for {}: {}", seed, e))?;
2025-11-09T23:42:54.5896633Z -    
2025-11-09T23:42:54.5896747Z +
2025-11-09T23:42:54.5896884Z +    let socket_addrs =
2025-11-09T23:42:54.5897226Z +        lookup_result.map_err(|e| format!("DNS lookup failed for {}: {}", seed, e))?;
2025-11-09T23:42:54.5898466Z +
2025-11-09T23:42:54.5898673Z      // Convert SocketAddr to NetworkAddress
2025-11-09T23:42:54.5898848Z      let mut addresses = Vec::new();
2025-11-09T23:42:54.5899016Z      for socket_addr in socket_addrs {
2025-11-09T23:42:54.5899517Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dns_seeds.rs:79:
2025-11-09T23:42:54.5899812Z          addresses.push(socket_addr_to_network_address(socket_addr));
2025-11-09T23:42:54.5899950Z      }
2025-11-09T23:42:54.5900062Z -    
2025-11-09T23:42:54.5900173Z +
2025-11-09T23:42:54.5900305Z      Ok(addresses)
2025-11-09T23:42:54.5900423Z  }
2025-11-09T23:42:54.5900527Z  
2025-11-09T23:42:54.5900989Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dns_seeds.rs:85:
2025-11-09T23:42:54.5901170Z  /// Convert SocketAddr to NetworkAddress
2025-11-09T23:42:54.5901539Z  fn socket_addr_to_network_address(socket_addr: SocketAddr) -> NetworkAddress {
2025-11-09T23:42:54.5901715Z      use std::net::IpAddr;
2025-11-09T23:42:54.5901826Z -    
2025-11-09T23:42:54.5901938Z +
2025-11-09T23:42:54.5902103Z      let ip_bytes = match socket_addr.ip() {
2025-11-09T23:42:54.5902240Z          IpAddr::V4(ipv4) => {
2025-11-09T23:42:54.5902392Z              // IPv4-mapped IPv6 format
2025-11-09T23:42:54.5902864Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dns_seeds.rs:95:
2025-11-09T23:42:54.5903283Z              bytes[12..16].copy_from_slice(&ipv4.octets());
2025-11-09T23:42:54.5903846Z              bytes
2025-11-09T23:42:54.5903982Z          }
2025-11-09T23:42:54.5904125Z -        IpAddr::V6(ipv6) => {
2025-11-09T23:42:54.5906544Z -            ipv6.octets()
2025-11-09T23:42:54.5906676Z -        }
2025-11-09T23:42:54.5906832Z +        IpAddr::V6(ipv6) => ipv6.octets(),
2025-11-09T23:42:54.5906936Z      };
2025-11-09T23:42:54.5907054Z -    
2025-11-09T23:42:54.5907160Z +
2025-11-09T23:42:54.5907286Z      NetworkAddress {
2025-11-09T23:42:54.5907488Z          services: 0, // Will be updated when we connect
2025-11-09T23:42:54.5907642Z          ip: ip_bytes,
2025-11-09T23:42:54.5908138Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dns_seeds.rs:125:
2025-11-09T23:42:54.5908291Z          assert_eq!(addr.ip[15], 1);
2025-11-09T23:42:54.5908417Z      }
2025-11-09T23:42:54.5908525Z  }
2025-11-09T23:42:54.5908634Z -
2025-11-09T23:42:54.5908741Z  
2025-11-09T23:42:54.5909285Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:9:
2025-11-09T23:42:54.5909441Z  use std::sync::Arc;
2025-11-09T23:42:54.5909625Z  use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:42:54.5909782Z  use tokio::sync::Mutex;
2025-11-09T23:42:54.5909939Z -use tracing::{debug, warn, error};
2025-11-09T23:42:54.5910097Z +use tracing::{debug, error, warn};
2025-11-09T23:42:54.5910207Z  
2025-11-09T23:42:54.5910555Z  /// Connection rate limiter (tracks connection attempts per time window)
2025-11-09T23:42:54.5910733Z  pub struct ConnectionRateLimiter {
2025-11-09T23:42:54.5911248Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:40:
2025-11-09T23:42:54.5911366Z  
2025-11-09T23:42:54.5911553Z          // Clean up old entries outside the time window
2025-11-09T23:42:54.5911785Z          let cutoff = now.saturating_sub(self.window_seconds);
2025-11-09T23:42:54.5911901Z -        
2025-11-09T23:42:54.5912035Z +
2025-11-09T23:42:54.5912396Z          let attempts = self.connection_attempts.entry(ip).or_insert_with(Vec::new);
2025-11-09T23:42:54.5912607Z          attempts.retain(|&timestamp| timestamp > cutoff);
2025-11-09T23:42:54.5912728Z  
2025-11-09T23:42:54.5913242Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:47:
2025-11-09T23:42:54.5913403Z          // Check if we're within the limit
2025-11-09T23:42:54.5913642Z          if attempts.len() >= self.max_connections_per_window {
2025-11-09T23:42:54.5916279Z -            warn!("Connection rate limit exceeded for IP {}: {} attempts in {} seconds", 
2025-11-09T23:42:54.5916748Z -                  ip, attempts.len(), self.window_seconds);
2025-11-09T23:42:54.5916875Z +            warn!(
2025-11-09T23:42:54.5917216Z +                "Connection rate limit exceeded for IP {}: {} attempts in {} seconds",
2025-11-09T23:42:54.5917343Z +                ip,
2025-11-09T23:42:54.5917485Z +                attempts.len(),
2025-11-09T23:42:54.5917645Z +                self.window_seconds
2025-11-09T23:42:54.5917764Z +            );
2025-11-09T23:42:54.5917883Z              false
2025-11-09T23:42:54.5918000Z          } else {
2025-11-09T23:42:54.5918174Z              // Record this connection attempt
2025-11-09T23:42:54.5918709Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:72:
2025-11-09T23:42:54.5918826Z  
2025-11-09T23:42:54.5919036Z      /// Get current connection attempt count for an IP
2025-11-09T23:42:54.5919267Z      pub fn get_attempt_count(&self, ip: IpAddr) -> usize {
2025-11-09T23:42:54.5919600Z -        self.connection_attempts.get(&ip).map(|v| v.len()).unwrap_or(0)
2025-11-09T23:42:54.5919775Z +        self.connection_attempts
2025-11-09T23:42:54.5919905Z +            .get(&ip)
2025-11-09T23:42:54.5920089Z +            .map(|v| v.len())
2025-11-09T23:42:54.5920234Z +            .unwrap_or(0)
2025-11-09T23:42:54.5920348Z      }
2025-11-09T23:42:54.5920467Z  }
2025-11-09T23:42:54.5920819Z  
2025-11-09T23:42:54.5921357Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:171:
2025-11-09T23:42:54.5921520Z      /// Create with default settings
2025-11-09T23:42:54.5921683Z      pub fn default() -> Self {
2025-11-09T23:42:54.5921821Z          Self::new(
2025-11-09T23:42:54.5922019Z -            10,   // Max 10 connections per IP per window
2025-11-09T23:42:54.5922168Z -            60,   // 60 second window
2025-11-09T23:42:54.5922344Z +            10,    // Max 10 connections per IP per window
2025-11-09T23:42:54.5922483Z +            60,    // 60 second window
2025-11-09T23:42:54.5922641Z              10000, // Max 10k messages in queue
2025-11-09T23:42:54.5922800Z -            200,  // Max 200 active connections
2025-11-09T23:42:54.5922954Z +            200,   // Max 200 active connections
2025-11-09T23:42:54.5923064Z          )
2025-11-09T23:42:54.5923182Z      }
2025-11-09T23:42:54.5923296Z  
2025-11-09T23:42:54.5923847Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:194:
2025-11-09T23:42:54.5924036Z              metrics.connection_rate_violations += 1;
2025-11-09T23:42:54.5924150Z  
2025-11-09T23:42:54.5924546Z              if *count >= self.auto_ban_connection_violations {
2025-11-09T23:42:54.5924947Z -                warn!("Auto-banning IP {} for repeated connection rate violations ({} violations)", 
2025-11-09T23:42:54.5925096Z -                      ip, *count);
2025-11-09T23:42:54.5925219Z +                warn!(
2025-11-09T23:42:54.5925586Z +                    "Auto-banning IP {} for repeated connection rate violations ({} violations)",
2025-11-09T23:42:54.5925728Z +                    ip, *count
2025-11-09T23:42:54.5925842Z +                );
2025-11-09T23:42:54.5926004Z                  metrics.auto_bans_applied += 1;
2025-11-09T23:42:54.5926194Z                  // Return false to reject, caller should ban
2025-11-09T23:42:54.5926334Z                  return false;
2025-11-09T23:42:54.5926865Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:212:
2025-11-09T23:42:54.5927043Z      /// Check if message queue is within limits
2025-11-09T23:42:54.5927391Z      pub async fn check_message_queue_size(&self, current_size: usize) -> bool {
2025-11-09T23:42:54.5927597Z          if current_size > self.max_message_queue_size {
2025-11-09T23:42:54.5927989Z -            warn!("Message queue size exceeded: {} > {}", current_size, self.max_message_queue_size);
2025-11-09T23:42:54.5928119Z +            warn!(
2025-11-09T23:42:54.5928551Z +                "Message queue size exceeded: {} > {}",
2025-11-09T23:42:54.5928739Z +                current_size, self.max_message_queue_size
2025-11-09T23:42:54.5928861Z +            );
2025-11-09T23:42:54.5929046Z              let mut metrics = self.metrics.lock().await;
2025-11-09T23:42:54.5929219Z              metrics.message_queue_overflows += 1;
2025-11-09T23:42:54.5929335Z              false
2025-11-09T23:42:54.5929886Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:224:
2025-11-09T23:42:54.5930059Z      /// Check if we can accept more connections
2025-11-09T23:42:54.5930404Z      pub async fn check_active_connections(&self, current_count: usize) -> bool {
2025-11-09T23:42:54.5930615Z          if current_count >= self.max_active_connections {
2025-11-09T23:42:54.5931056Z -            warn!("Active connection limit exceeded: {} >= {}", current_count, self.max_active_connections);
2025-11-09T23:42:54.5931171Z +            warn!(
2025-11-09T23:42:54.5931377Z +                "Active connection limit exceeded: {} >= {}",
2025-11-09T23:42:54.5931568Z +                current_count, self.max_active_connections
2025-11-09T23:42:54.5931677Z +            );
2025-11-09T23:42:54.5931862Z              let mut metrics = self.metrics.lock().await;
2025-11-09T23:42:54.5932052Z              metrics.active_connection_limit_hits += 1;
2025-11-09T23:42:54.5932390Z              false
2025-11-09T23:42:54.5932934Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:262:
2025-11-09T23:42:54.5933137Z      /// Check if we're under DoS attack (heuristic)
2025-11-09T23:42:54.5933332Z      pub async fn detect_dos_attack(&self) -> bool {
2025-11-09T23:42:54.5933547Z          let metrics = self.resource_metrics.lock().await;
2025-11-09T23:42:54.5933665Z -        
2025-11-09T23:42:54.5933781Z +
2025-11-09T23:42:54.5934124Z          // Heuristic: If message queue is > 80% full and connections are > 80% of max
2025-11-09T23:42:54.5936559Z          let queue_threshold = (self.max_message_queue_size as f64 * 0.8) as usize;
2025-11-09T23:42:54.5936887Z          let conn_threshold = (self.max_active_connections as f64 * 0.8) as usize;
2025-11-09T23:42:54.5937422Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:269:
2025-11-09T23:42:54.5937563Z  
2025-11-09T23:42:54.5937767Z -        metrics.message_queue_size > queue_threshold 
2025-11-09T23:42:54.5937968Z -            && metrics.active_connections > conn_threshold
2025-11-09T23:42:54.5938425Z +        metrics.message_queue_size > queue_threshold && metrics.active_connections > conn_threshold
2025-11-09T23:42:54.5938543Z      }
2025-11-09T23:42:54.5938654Z  
2025-11-09T23:42:54.5938850Z      /// Cleanup old connection rate limiter entries
2025-11-09T23:42:54.5939362Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:368:
2025-11-09T23:42:54.5939539Z          assert!(dos.should_auto_ban(ip).await);
2025-11-09T23:42:54.5939659Z      }
2025-11-09T23:42:54.5939772Z  }
2025-11-09T23:42:54.5939881Z -
2025-11-09T23:42:54.5939992Z  
2025-11-09T23:42:54.5940508Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/filter_service.rs:3:
2025-11-09T23:42:54.5940885Z  //! Generates, caches, and serves compact block filters for light client support.
2025-11-09T23:42:54.5941171Z  //! Maintains filter header chain for efficient verification.
2025-11-09T23:42:54.5941283Z  
2025-11-09T23:42:54.5941450Z +use anyhow::{anyhow, Result};
2025-11-09T23:42:54.5941596Z  use bllvm_protocol::bip157;
2025-11-09T23:42:54.5941910Z  use bllvm_protocol::bip158::{build_block_filter, CompactBlockFilter};
2025-11-09T23:42:54.5942071Z -use anyhow::{anyhow, Result};
2025-11-09T23:42:54.5942341Z  use bllvm_protocol::{Block, BlockHeader, Hash, Transaction};
2025-11-09T23:42:54.5942496Z  use std::collections::HashMap;
2025-11-09T23:42:54.5942645Z  use std::sync::{Arc, RwLock};
2025-11-09T23:42:54.5943457Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/filter_service.rs:211:
2025-11-09T23:42:54.5943815Z      pub fn remove_filter_for_pruned_block(&self, block_hash: &Hash) -> Result<()> {
2025-11-09T23:42:54.5943967Z          // Remove filter from cache
2025-11-09T23:42:54.5944186Z          self.filters.write().unwrap().remove(block_hash);
2025-11-09T23:42:54.5944296Z -        
2025-11-09T23:42:54.5946489Z +
2025-11-09T23:42:54.5946829Z          // Note: We do NOT remove the filter header - it's required for verification
2025-11-09T23:42:54.5947106Z          // The filter header chain must remain intact even after pruning
2025-11-09T23:42:54.5947217Z -        
2025-11-09T23:42:54.5947334Z +
2025-11-09T23:42:54.5947450Z          Ok(())
2025-11-09T23:42:54.5947558Z      }
2025-11-09T23:42:54.5947667Z  
2025-11-09T23:42:54.5948238Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/message_bridge.rs:80:
2025-11-09T23:42:54.5948672Z      /// 3. Convert the `NetworkResponse` to wire format messages using `extract_send_messages()`
2025-11-09T23:42:54.5948787Z      ///
2025-11-09T23:42:54.5949200Z      /// For now, this method only handles message conversion, not processing.
2025-11-09T23:42:54.5949365Z -    pub fn process_incoming_message(
2025-11-09T23:42:54.5949486Z -        data: &[u8],
2025-11-09T23:42:54.5949641Z -        transport: TransportType,
2025-11-09T23:42:54.5950030Z -    ) -> Result<Vec<Vec<u8>>> {
2025-11-09T23:42:54.5950476Z +    pub fn process_incoming_message(data: &[u8], transport: TransportType) -> Result<Vec<Vec<u8>>> {
2025-11-09T23:42:54.5950634Z          // Convert to protocol message
2025-11-09T23:42:54.5950951Z          let protocol_msg = Self::from_transport_message(data, transport)?;
2025-11-09T23:42:54.5951064Z  
2025-11-09T23:42:54.6721587Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:4:
2025-11-09T23:42:54.6722019Z  //! message handling for communication with other Bitcoin nodes.
2025-11-09T23:42:54.6722271Z  
2025-11-09T23:42:54.6722448Z  pub mod address_db;
2025-11-09T23:42:54.6722643Z +pub mod ban_list_merging;
2025-11-09T23:42:54.6722839Z +pub mod ban_list_signing;
2025-11-09T23:42:54.6723022Z  pub mod chain_access;
2025-11-09T23:42:54.6723192Z  pub mod dns_seeds;
2025-11-09T23:42:54.6723395Z +pub mod dos_protection;
2025-11-09T23:42:54.6723571Z  pub mod inventory;
2025-11-09T23:42:54.6723786Z  pub mod message_bridge;
2025-11-09T23:42:54.6723956Z  pub mod peer;
2025-11-09T23:42:54.6724755Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:12:
2025-11-09T23:42:54.6724937Z  pub mod protocol;
2025-11-09T23:42:54.6725130Z  pub mod protocol_adapter;
2025-11-09T23:42:54.6725332Z  pub mod protocol_extensions;
2025-11-09T23:42:54.6725517Z -pub mod ban_list_merging;
2025-11-09T23:42:54.6725693Z -pub mod ban_list_signing;
2025-11-09T23:42:54.6725875Z -pub mod dos_protection;
2025-11-09T23:42:54.6726040Z  pub mod relay;
2025-11-09T23:42:54.6726228Z  pub mod tcp_transport;
2025-11-09T23:42:54.6726399Z  pub mod transport;
2025-11-09T23:42:54.6727004Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:40:
2025-11-09T23:42:54.6727251Z  // Payment Protocol (BIP70) - P2P handlers
2025-11-09T23:42:54.6727413Z  pub mod bip70_handler;
2025-11-09T23:42:54.6727556Z  
2025-11-09T23:42:54.6727724Z -
2025-11-09T23:42:54.6727951Z  // Privacy and Performance Enhancements
2025-11-09T23:42:54.6728159Z  #[cfg(feature = "dandelion")]
2025-11-09T23:42:54.6728618Z  pub mod dandelion; // Dandelion++ privacy-preserving transaction relay
2025-11-09T23:42:54.6729237Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:50:
2025-11-09T23:42:54.6729567Z  pub mod txhash; // Non-consensus hashing helpers for relay
2025-11-09T23:42:54.6729738Z  
2025-11-09T23:42:54.6730153Z  use crate::network::protocol::{ProtocolMessage, ProtocolParser};
2025-11-09T23:42:54.6730385Z +use crate::node::mempool::MempoolManager;
2025-11-09T23:42:54.6730893Z +use crate::storage::Storage;
2025-11-09T23:42:54.6731076Z  use anyhow::Result;
2025-11-09T23:42:54.6731262Z  use bllvm_protocol::mempool::Mempool;
2025-11-09T23:42:54.6731613Z  use bllvm_protocol::{BitcoinProtocolEngine, ConsensusProof, UtxoSet};
2025-11-09T23:42:54.6732092Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:58:
2025-11-09T23:42:54.6732251Z  use std::sync::{Arc, Mutex};
2025-11-09T23:42:54.6732397Z  use tokio::sync::mpsc;
2025-11-09T23:42:54.6732574Z  use tracing::{error, info, warn};
2025-11-09T23:42:54.6732749Z -use crate::storage::Storage;
2025-11-09T23:42:54.6732952Z -use crate::node::mempool::MempoolManager;
2025-11-09T23:42:54.6733075Z  
2025-11-09T23:42:54.6733296Z  use crate::network::tcp_transport::TcpTransport;
2025-11-09T23:42:54.6733468Z  use crate::network::transport::{
2025-11-09T23:42:54.6734023Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:86:
2025-11-09T23:42:54.6734184Z  }
2025-11-09T23:42:54.6734464Z  
2025-11-09T23:42:54.6734700Z  /// Peer manager for tracking connected peers
2025-11-09T23:42:54.6734840Z -/// 
2025-11-09T23:42:54.6734992Z +///
2025-11-09T23:42:54.6735921Z  /// Uses TransportAddr as key to support all transport types (TCP, Quinn, Iroh).
2025-11-09T23:42:54.6736392Z  /// This allows proper peer identification for Iroh (NodeId) while maintaining
2025-11-09T23:42:54.6738373Z  /// compatibility with TCP/Quinn (SocketAddr).
2025-11-09T23:42:54.6738853Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:130:
2025-11-09T23:42:54.6739123Z      pub fn peer_addresses(&self) -> Vec<TransportAddr> {
2025-11-09T23:42:54.6739331Z          self.peers.keys().cloned().collect()
2025-11-09T23:42:54.6739459Z      }
2025-11-09T23:42:54.6739594Z -    
2025-11-09T23:42:54.6739724Z +
2025-11-09T23:42:54.6740055Z      /// Get peer addresses as SocketAddr (for backward compatibility)
2025-11-09T23:42:54.6740367Z      /// Only returns SocketAddr for TCP/Quinn peers, skips Iroh peers
2025-11-09T23:42:54.6740632Z      pub fn peer_socket_addresses(&self) -> Vec<SocketAddr> {
2025-11-09T23:42:54.6741137Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:137:
2025-11-09T23:42:54.6741294Z -        self.peers.keys()
2025-11-09T23:42:54.6741433Z +        self.peers
2025-11-09T23:42:54.6741572Z +            .keys()
2025-11-09T23:42:54.6741734Z              .filter_map(|addr| {
2025-11-09T23:42:54.6741877Z                  match addr {
2025-11-09T23:42:54.6742095Z                      TransportAddr::Tcp(sock) => Some(*sock),
2025-11-09T23:42:54.6742599Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:150:
2025-11-09T23:42:54.6742787Z      pub fn can_accept_peer(&self) -> bool {
2025-11-09T23:42:54.6742952Z          self.peers.len() < self.max_peers
2025-11-09T23:42:54.6743070Z      }
2025-11-09T23:42:54.6743179Z -    
2025-11-09T23:42:54.6743289Z +
2025-11-09T23:42:54.6743470Z      /// Select best peers based on quality score
2025-11-09T23:42:54.6743595Z -    /// 
2025-11-09T23:42:54.6743712Z +    ///
2025-11-09T23:42:54.6743953Z      /// Returns peers sorted by quality score (highest first)
2025-11-09T23:42:54.6744252Z      pub fn select_best_peers(&self, count: usize) -> Vec<TransportAddr> {
2025-11-09T23:42:54.6745340Z -        let mut peers: Vec<_> = self.peers.iter()
2025-11-09T23:42:54.6745510Z +        let mut peers: Vec<_> = self
2025-11-09T23:42:54.6745630Z +            .peers
2025-11-09T23:42:54.6745755Z +            .iter()
2025-11-09T23:42:54.6745998Z              .map(|(addr, peer)| (addr.clone(), peer.quality_score()))
2025-11-09T23:42:54.6746121Z              .collect();
2025-11-09T23:42:54.6746233Z -        
2025-11-09T23:42:54.6746351Z +
2025-11-09T23:42:54.6746517Z          // Sort by quality score (descending)
2025-11-09T23:42:54.6746833Z          peers.sort_by(|a, b| b.1.partial_cmp(&a.1).unwrap_or(std::cmp::Ordering::Equal));
2025-11-09T23:42:54.6747089Z -        
2025-11-09T23:42:54.6747158Z +
2025-11-09T23:42:54.6747248Z          // Return top N addresses
2025-11-09T23:42:54.6747338Z -        peers.into_iter()
2025-11-09T23:42:54.6747418Z +        peers
2025-11-09T23:42:54.6747495Z +            .into_iter()
2025-11-09T23:42:54.6747568Z              .take(count)
2025-11-09T23:42:54.6747657Z              .map(|(addr, _)| addr)
2025-11-09T23:42:54.6747730Z              .collect()
2025-11-09T23:42:54.6748008Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:170:
2025-11-09T23:42:54.6748083Z      }
2025-11-09T23:42:54.6748148Z -    
2025-11-09T23:42:54.6748213Z +
2025-11-09T23:42:54.6748303Z      /// Select reliable peers only
2025-11-09T23:42:54.6748375Z -    /// 
2025-11-09T23:42:54.6748441Z +    ///
2025-11-09T23:42:54.6748566Z      /// Returns peers that meet reliability criteria
2025-11-09T23:42:54.6748731Z      pub fn select_reliable_peers(&self) -> Vec<TransportAddr> {
2025-11-09T23:42:54.6748815Z -        self.peers.iter()
2025-11-09T23:42:54.6748891Z +        self.peers
2025-11-09T23:42:54.6748960Z +            .iter()
2025-11-09T23:42:54.6749200Z              .filter(|(_, peer)| peer.quality_score() > 0.5) // Use quality_score as reliability indicator
2025-11-09T23:42:54.6749291Z              .map(|(addr, _)| addr.clone())
2025-11-09T23:42:54.6749364Z              .collect()
2025-11-09T23:42:54.6749631Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:180:
2025-11-09T23:42:54.6749821Z      }
2025-11-09T23:42:54.6749887Z -    
2025-11-09T23:42:54.6749951Z +
2025-11-09T23:42:54.6750048Z      /// Get peer quality statistics
2025-11-09T23:42:54.6750187Z      pub fn get_quality_stats(&self) -> (usize, usize, f64) {
2025-11-09T23:42:54.6750283Z          let total = self.peers.len();
2025-11-09T23:42:54.6750538Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:185:
2025-11-09T23:42:54.6750636Z -        let reliable = self.peers.values()
2025-11-09T23:42:54.6750723Z +        let reliable = self
2025-11-09T23:42:54.6750794Z +            .peers
2025-11-09T23:42:54.6750869Z +            .values()
2025-11-09T23:42:54.6751088Z              .filter(|peer| peer.quality_score() > 0.5) // Use quality_score as reliability indicator
2025-11-09T23:42:54.6751159Z              .count();
2025-11-09T23:42:54.6751254Z          let avg_quality = if total > 0 {
2025-11-09T23:42:54.6751499Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:189:
2025-11-09T23:42:54.6751592Z -            self.peers.values()
2025-11-09T23:42:54.6751670Z +            self.peers
2025-11-09T23:42:54.6751745Z +                .values()
2025-11-09T23:42:54.6751847Z                  .map(|peer| peer.quality_score())
2025-11-09T23:42:54.6751940Z -                .sum::<f64>() / total as f64
2025-11-09T23:42:54.6752024Z +                .sum::<f64>()
2025-11-09T23:42:54.6752100Z +                / total as f64
2025-11-09T23:42:54.6752169Z          } else {
2025-11-09T23:42:54.6752247Z              0.0
2025-11-09T23:42:54.6752314Z          };
2025-11-09T23:42:54.6752552Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:195:
2025-11-09T23:42:54.6752620Z -        
2025-11-09T23:42:54.6752692Z +
2025-11-09T23:42:54.6752781Z          (total, reliable, avg_quality)
2025-11-09T23:42:54.6752847Z      }
2025-11-09T23:42:54.6752922Z -    
2025-11-09T23:42:54.6752989Z +
2025-11-09T23:42:54.6753126Z      /// Find peer by SocketAddr (tries TCP and Quinn variants)
2025-11-09T23:42:54.6753221Z      /// Returns the TransportAddr if found
2025-11-09T23:42:54.6753455Z      pub fn find_transport_addr_by_socket(&self, addr: SocketAddr) -> Option<TransportAddr> {
2025-11-09T23:42:54.6753697Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:204:
2025-11-09T23:42:54.6753802Z          if self.peers.contains_key(&tcp_addr) {
2025-11-09T23:42:54.6753891Z              return Some(tcp_addr);
2025-11-09T23:42:54.6754059Z          }
2025-11-09T23:42:54.6754124Z -        
2025-11-09T23:42:54.6754187Z +
2025-11-09T23:42:54.6754264Z          // Try Quinn
2025-11-09T23:42:54.6754516Z          #[cfg(feature = "quinn")]
2025-11-09T23:42:54.6754590Z          {
2025-11-09T23:42:54.6754841Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:213:
2025-11-09T23:42:54.6754931Z                  return Some(quinn_addr);
2025-11-09T23:42:54.6755003Z              }
2025-11-09T23:42:54.6755069Z          }
2025-11-09T23:42:54.6755140Z -        
2025-11-09T23:42:54.6755204Z +
2025-11-09T23:42:54.6755270Z          None
2025-11-09T23:42:54.6755339Z      }
2025-11-09T23:42:54.6755402Z  }
2025-11-09T23:42:54.6755637Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:245:
2025-11-09T23:42:54.6755715Z              last_refill: now,
2025-11-09T23:42:54.6755788Z          }
2025-11-09T23:42:54.6755852Z      }
2025-11-09T23:42:54.6755915Z -    
2025-11-09T23:42:54.6755988Z +
2025-11-09T23:42:54.6756125Z      /// Check if a message can be consumed and consume a token
2025-11-09T23:42:54.6756233Z      pub fn check_and_consume(&mut self) -> bool {
2025-11-09T23:42:54.6756310Z          self.refill();
2025-11-09T23:42:54.6756555Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:256:
2025-11-09T23:42:54.6756623Z              false
2025-11-09T23:42:54.6756692Z          }
2025-11-09T23:42:54.6756903Z      }
2025-11-09T23:42:54.6756967Z -    
2025-11-09T23:42:54.6757030Z +
2025-11-09T23:42:54.6757127Z      /// Refill tokens based on elapsed time
2025-11-09T23:42:54.6757214Z      fn refill(&mut self) {
2025-11-09T23:42:54.6757321Z          use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:42:54.6757557Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:264:
2025-11-09T23:42:54.6757653Z              .duration_since(UNIX_EPOCH)
2025-11-09T23:42:54.6757725Z              .unwrap()
2025-11-09T23:42:54.6757803Z              .as_secs();
2025-11-09T23:42:54.6757869Z -        
2025-11-09T23:42:54.6757939Z +
2025-11-09T23:42:54.6758026Z          if now > self.last_refill {
2025-11-09T23:42:54.6758123Z              let elapsed = now - self.last_refill;
2025-11-09T23:42:54.6758251Z              let tokens_to_add = (elapsed as u32) * self.rate;
2025-11-09T23:42:54.6758487Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:271:
2025-11-09T23:42:54.6758699Z -            self.tokens = self.tokens.saturating_add(tokens_to_add).min(self.burst_limit);
2025-11-09T23:42:54.6758785Z +            self.tokens = self
2025-11-09T23:42:54.6758860Z +                .tokens
2025-11-09T23:42:54.6758956Z +                .saturating_add(tokens_to_add)
2025-11-09T23:42:54.6759042Z +                .min(self.burst_limit);
2025-11-09T23:42:54.6759132Z              self.last_refill = now;
2025-11-09T23:42:54.6759197Z          }
2025-11-09T23:42:54.6759264Z      }
2025-11-09T23:42:54.6759511Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:452:
2025-11-09T23:42:54.6759686Z              enable_self_advertisement: true, // Default: advertise ourselves
2025-11-09T23:42:54.6759753Z          }
2025-11-09T23:42:54.6759819Z      }
2025-11-09T23:42:54.6759891Z -    
2025-11-09T23:42:54.6759954Z +
2025-11-09T23:42:54.6760082Z      /// Set dependencies for protocol message processing
2025-11-09T23:42:54.6760180Z      pub fn with_dependencies(
2025-11-09T23:42:54.6760249Z          mut self,
2025-11-09T23:42:54.6760555Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:525:
2025-11-09T23:42:54.6760810Z      /// Discover peers from DNS seeds and add to address database
2025-11-09T23:42:54.6761061Z      pub async fn discover_peers_from_dns(&self, network: &str, port: u16) -> Result<()> {
2025-11-09T23:42:54.6761156Z          use crate::network::dns_seeds;
2025-11-09T23:42:54.6761224Z -        
2025-11-09T23:42:54.6761293Z +
2025-11-09T23:42:54.6761521Z          let seeds = match network {
2025-11-09T23:42:54.6761633Z              "mainnet" => dns_seeds::MAINNET_DNS_SEEDS,
2025-11-09T23:42:54.6761743Z              "testnet" => dns_seeds::TESTNET_DNS_SEEDS,
2025-11-09T23:42:54.6761987Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:534:
2025-11-09T23:42:54.6762066Z                  return Ok(());
2025-11-09T23:42:54.6762132Z              }
2025-11-09T23:42:54.6762209Z          };
2025-11-09T23:42:54.6762277Z -        
2025-11-09T23:42:54.6762340Z +
2025-11-09T23:42:54.6762492Z          info!("Discovering peers from DNS seeds for {}", network);
2025-11-09T23:42:54.6762668Z          let addresses = dns_seeds::resolve_dns_seeds(seeds, port, 100).await;
2025-11-09T23:42:54.6762735Z -        
2025-11-09T23:42:54.6762799Z +
2025-11-09T23:42:54.6762899Z          // Add discovered addresses to database
2025-11-09T23:42:54.6762976Z          {
2025-11-09T23:42:54.6763101Z              let mut db = self.address_database.lock().unwrap();
2025-11-09T23:42:54.6763345Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:545:
2025-11-09T23:42:54.6763514Z                  db.add_address(addr, 0); // Services will be updated on connection
2025-11-09T23:42:54.6763580Z              }
2025-11-09T23:42:54.6763645Z          }
2025-11-09T23:42:54.6763716Z -        
2025-11-09T23:42:54.6763781Z +
2025-11-09T23:42:54.6763944Z          info!("Discovered {} addresses from DNS seeds", addresses.len());
2025-11-09T23:42:54.6764136Z          Ok(())
2025-11-09T23:42:54.6764206Z      }
2025-11-09T23:42:54.6766451Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:555:
2025-11-09T23:42:54.6766560Z          for peer_addr in persistent_peers {
2025-11-09T23:42:54.6766662Z              // Add to persistent peer set
2025-11-09T23:42:54.6766767Z              self.add_persistent_peer(*peer_addr);
2025-11-09T23:42:54.6766836Z -            
2025-11-09T23:42:54.6766901Z +
2025-11-09T23:42:54.6766992Z              // Try to connect
2025-11-09T23:42:54.6767129Z              info!("Connecting to persistent peer: {}", peer_addr);
2025-11-09T23:42:54.6767267Z              if let Err(e) = self.connect_to_peer(*peer_addr).await {
2025-11-09T23:42:54.6767520Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:566:
2025-11-09T23:42:54.6767587Z      }
2025-11-09T23:42:54.6767653Z  
2025-11-09T23:42:54.6767779Z      /// Discover Iroh peers and add to address database
2025-11-09T23:42:54.6767853Z -    /// 
2025-11-09T23:42:54.6767920Z +    ///
2025-11-09T23:42:54.6768019Z      /// Iroh peers are discovered through:
2025-11-09T23:42:54.6768144Z      /// 1. Incoming connections (automatically stored)
2025-11-09T23:42:54.6768235Z      /// 2. DERP servers (if configured)
2025-11-09T23:42:54.6768476Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:573:
2025-11-09T23:42:54.6768570Z      /// 3. Gossip discovery (if available)
2025-11-09T23:42:54.6768646Z -    /// 
2025-11-09T23:42:54.6768712Z +    ///
2025-11-09T23:42:54.6768909Z      /// This method can be extended to use Iroh's gossip discovery APIs when available.
2025-11-09T23:42:54.6768994Z      #[cfg(feature = "iroh")]
2025-11-09T23:42:54.6769138Z      pub async fn discover_iroh_peers(&self) -> Result<usize> {
2025-11-09T23:42:54.6769385Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:579:
2025-11-09T23:42:54.6769563Z          // 1. Incoming connections (handled automatically in accept loop)
2025-11-09T23:42:54.6769676Z          // 2. DERP servers (configured in IrohTransport)
2025-11-09T23:42:54.6769837Z          // 3. Gossip discovery (would require iroh-gossip-discovery crate)
2025-11-09T23:42:54.6769903Z -        
2025-11-09T23:42:54.6769975Z +
2025-11-09T23:42:54.6770055Z          // For now, we rely on:
2025-11-09T23:42:54.6770156Z          // - Persistent Iroh peers from config
2025-11-09T23:42:54.6770275Z          // - Incoming connections (stored automatically)
2025-11-09T23:42:54.6770652Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:586:
2025-11-09T23:42:54.6770772Z          // - DERP servers (handled by Iroh's MagicEndpoint)
2025-11-09T23:42:54.6770854Z -        
2025-11-09T23:42:54.6770918Z +
2025-11-09T23:42:54.6771073Z          // Future: Integrate with iroh-gossip-discovery when available
2025-11-09T23:42:54.6771277Z          info!("Iroh peer discovery: relying on DERP servers and incoming connections");
2025-11-09T23:42:54.6771468Z          Ok(0) // Return 0 for now - discovery happens through Iroh's native mechanisms
2025-11-09T23:42:54.6771707Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:593:
2025-11-09T23:42:54.6771815Z      /// Connect to Iroh peers from address database
2025-11-09T23:42:54.6771903Z      #[cfg(feature = "iroh")]
2025-11-09T23:42:54.6772138Z      pub async fn connect_iroh_peers_from_database(&self, target_count: usize) -> Result<usize> {
2025-11-09T23:42:54.6772265Z -        use crate::network::transport::TransportAddr;
2025-11-09T23:42:54.6772368Z          use crate::network::peer::Peer;
2025-11-09T23:42:54.6772434Z -        
2025-11-09T23:42:54.6772549Z +        use crate::network::transport::TransportAddr;
2025-11-09T23:42:54.6772617Z +
2025-11-09T23:42:54.6772712Z          // Count current Iroh peers
2025-11-09T23:42:54.6772796Z          let current_iroh_count = {
2025-11-09T23:42:54.6773030Z              let pm = self.peer_manager.lock().unwrap();
2025-11-09T23:42:54.6773279Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:604:
2025-11-09T23:42:54.6773418Z                  .filter(|addr| matches!(addr, TransportAddr::Iroh(_)))
2025-11-09T23:42:54.6773492Z                  .count()
2025-11-09T23:42:54.6773559Z          };
2025-11-09T23:42:54.6773631Z -        
2025-11-09T23:42:54.6773698Z +
2025-11-09T23:42:54.6773797Z          if current_iroh_count >= target_count {
2025-11-09T23:42:54.6773889Z              return Ok(0);
2025-11-09T23:42:54.6773955Z          }
2025-11-09T23:42:54.6774194Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:611:
2025-11-09T23:42:54.6774261Z -        
2025-11-09T23:42:54.6776334Z +
2025-11-09T23:42:54.6776451Z          let needed = target_count - current_iroh_count;
2025-11-09T23:42:54.6776689Z -        info!("Need {} more Iroh peers (current: {}, target: {})", needed, current_iroh_count, target_count);
2025-11-09T23:42:54.6776767Z -        
2025-11-09T23:42:54.6776834Z +        info!(
2025-11-09T23:42:54.6776956Z +            "Need {} more Iroh peers (current: {}, target: {})",
2025-11-09T23:42:54.6777067Z +            needed, current_iroh_count, target_count
2025-11-09T23:42:54.6777132Z +        );
2025-11-09T23:42:54.6777199Z +
2025-11-09T23:42:54.6777292Z          // Get fresh Iroh NodeIds from database
2025-11-09T23:42:54.6777374Z          let node_ids = {
2025-11-09T23:42:54.6777490Z              let db = self.address_database.lock().unwrap();
2025-11-09T23:42:54.6777733Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:618:
2025-11-09T23:42:54.6777904Z              db.get_fresh_iroh_addresses(needed * 2) // Get 2x needed for retries
2025-11-09T23:42:54.6777969Z          };
2025-11-09T23:42:54.6778037Z -        
2025-11-09T23:42:54.6778102Z +
2025-11-09T23:42:54.6778191Z          if node_ids.is_empty() {
2025-11-09T23:42:54.6778329Z              warn!("No fresh Iroh addresses available in database");
2025-11-09T23:42:54.6778423Z              return Ok(0);
2025-11-09T23:42:54.6778663Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:624:
2025-11-09T23:42:54.6778730Z          }
2025-11-09T23:42:54.6778802Z -        
2025-11-09T23:42:54.6778866Z +
2025-11-09T23:42:54.6778945Z          // Get Iroh transport
2025-11-09T23:42:54.6779068Z          let iroh_transport = match &self.iroh_transport {
2025-11-09T23:42:54.6779165Z              Some(transport) => transport,
2025-11-09T23:42:54.6779532Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:631:
2025-11-09T23:42:54.6779612Z                  return Ok(0);
2025-11-09T23:42:54.6779685Z              }
2025-11-09T23:42:54.6779751Z          };
2025-11-09T23:42:54.6779816Z -        
2025-11-09T23:42:54.6779887Z +
2025-11-09T23:42:54.6779973Z          // Try to connect to Iroh peers
2025-11-09T23:42:54.6780058Z          let mut connected = 0;
2025-11-09T23:42:54.6780186Z          for node_id in node_ids.into_iter().take(needed * 2) {
2025-11-09T23:42:54.6780428Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:638:
2025-11-09T23:42:54.6780542Z              let node_id_bytes = node_id.as_bytes().to_vec();
2025-11-09T23:42:54.6780710Z              let transport_addr = TransportAddr::Iroh(node_id_bytes.clone());
2025-11-09T23:42:54.6780783Z -            
2025-11-09T23:42:54.6780848Z +
2025-11-09T23:42:54.6780952Z              // Connect directly using Iroh transport
2025-11-09T23:42:54.6781115Z              match iroh_transport.connect(transport_addr.clone()).await {
2025-11-09T23:42:54.6781197Z                  Ok(conn) => {
2025-11-09T23:42:54.6781438Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:650:
2025-11-09T23:42:54.6781528Z                          transport_addr.clone(),
2025-11-09T23:42:54.6781623Z                          self.peer_tx.clone(),
2025-11-09T23:42:54.6781812Z                      );
2025-11-09T23:42:54.6781883Z -                    
2025-11-09T23:42:54.6781952Z +
2025-11-09T23:42:54.6782038Z                      // Add peer to manager
2025-11-09T23:42:54.6782106Z                      {
2025-11-09T23:42:54.6782232Z                          let mut pm = self.peer_manager.lock().unwrap();
2025-11-09T23:42:54.6782479Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:659:
2025-11-09T23:42:54.6782559Z                              continue;
2025-11-09T23:42:54.6782633Z                          }
2025-11-09T23:42:54.6782707Z                      }
2025-11-09T23:42:54.6782851Z -                    
2025-11-09T23:42:54.6782962Z +
2025-11-09T23:42:54.6783132Z                      // Store mapping for Iroh (if needed)
2025-11-09T23:42:54.6783296Z                      {
2025-11-09T23:42:54.6783527Z                          let mut socket_to_transport = self.socket_to_transport.lock().unwrap();
2025-11-09T23:42:54.6783814Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:666:
2025-11-09T23:42:54.6784199Z                          socket_to_transport.insert(placeholder_socket, transport_addr.clone());
2025-11-09T23:42:54.6786507Z                      }
2025-11-09T23:42:54.6800360Z -                    
2025-11-09T23:42:54.6800549Z +
2025-11-09T23:42:54.6800854Z                      info!("Successfully connected to Iroh peer: {}", node_id);
2025-11-09T23:42:54.6801007Z                      connected += 1;
2025-11-09T23:42:54.6801189Z                      if connected >= needed {
2025-11-09T23:42:54.6801615Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:677:
2025-11-09T23:42:54.6801692Z                  }
2025-11-09T23:42:54.6801770Z              }
2025-11-09T23:42:54.6801836Z          }
2025-11-09T23:42:54.6801905Z -        
2025-11-09T23:42:54.6802107Z -        info!("Connected to {} new Iroh peers from address database", connected);
2025-11-09T23:42:54.6802193Z +
2025-11-09T23:42:54.6802265Z +        info!(
2025-11-09T23:42:54.6802414Z +            "Connected to {} new Iroh peers from address database",
2025-11-09T23:42:54.6802497Z +            connected
2025-11-09T23:42:54.6802564Z +        );
2025-11-09T23:42:54.6802637Z          Ok(connected)
2025-11-09T23:42:54.6802702Z      }
2025-11-09T23:42:54.6802773Z  
2025-11-09T23:42:54.6803040Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:685:
2025-11-09T23:42:54.6803206Z      /// Connect to peers from address database when below target count
2025-11-09T23:42:54.6803485Z -    /// 
2025-11-09T23:42:54.6803552Z +    ///
2025-11-09T23:42:54.6803752Z      /// Works with both SocketAddr-based addresses (TCP/Quinn) and Iroh NodeIds.
2025-11-09T23:42:54.6803986Z      pub async fn connect_peers_from_database(&self, target_count: usize) -> Result<usize> {
2025-11-09T23:42:54.6804103Z          let current_count = self.peer_count();
2025-11-09T23:42:54.6804531Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:692:
2025-11-09T23:42:54.6804604Z          }
2025-11-09T23:42:54.6804678Z  
2025-11-09T23:42:54.6804788Z          let needed = target_count - current_count;
2025-11-09T23:42:54.6805004Z -        info!("Need {} more peers (current: {}, target: {})", needed, current_count, target_count);
2025-11-09T23:42:54.6805080Z +        info!(
2025-11-09T23:42:54.6805198Z +            "Need {} more peers (current: {}, target: {})",
2025-11-09T23:42:54.6805296Z +            needed, current_count, target_count
2025-11-09T23:42:54.6805366Z +        );
2025-11-09T23:42:54.6805436Z  
2025-11-09T23:42:54.6805537Z          // Get fresh addresses from database
2025-11-09T23:42:54.6805670Z          let ban_list = self.ban_list.lock().unwrap().clone();
2025-11-09T23:42:54.6805935Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:715:
2025-11-09T23:42:54.6806044Z          // Convert addresses to SocketAddrs first
2025-11-09T23:42:54.6806272Z          let sockets: Vec<SocketAddr> = {
2025-11-09T23:42:54.6806391Z              let db = self.address_database.lock().unwrap();
2025-11-09T23:42:54.6806482Z -            addresses.iter()
2025-11-09T23:42:54.6806554Z +            addresses
2025-11-09T23:42:54.6806627Z +                .iter()
2025-11-09T23:42:54.6806718Z                  .take(needed * 2)
2025-11-09T23:42:54.6806832Z                  .map(|addr| db.network_addr_to_socket(addr))
2025-11-09T23:42:54.6806905Z                  .collect()
2025-11-09T23:42:54.6807161Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:724:
2025-11-09T23:42:54.6807254Z          // Try to connect to addresses
2025-11-09T23:42:54.6807336Z          let mut connected = 0;
2025-11-09T23:42:54.6807419Z          for socket in sockets {
2025-11-09T23:42:54.6807490Z -
2025-11-09T23:42:54.6807616Z              if let Err(e) = self.connect_to_peer(socket).await {
2025-11-09T23:42:54.6807740Z                  debug!("Failed to connect to {}: {}", socket, e);
2025-11-09T23:42:54.6807843Z                  // Continue trying other addresses
2025-11-09T23:42:54.6808094Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:737:
2025-11-09T23:42:54.6808162Z          }
2025-11-09T23:42:54.6808226Z  
2025-11-09T23:42:54.6808401Z          info!("Connected to {} new peers from address database", connected);
2025-11-09T23:42:54.6808469Z -        
2025-11-09T23:42:54.6808535Z +
2025-11-09T23:42:54.6808664Z          // Also try to connect Iroh peers if Iroh is enabled
2025-11-09T23:42:54.6808751Z          #[cfg(feature = "iroh")]
2025-11-09T23:42:54.6808867Z          if self.transport_preference.allows_iroh() {
2025-11-09T23:42:54.6809107Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:744:
2025-11-09T23:42:54.6809318Z              let iroh_connected = self.connect_iroh_peers_from_database(target_count).await?;
2025-11-09T23:42:54.6809412Z              connected += iroh_connected;
2025-11-09T23:42:54.6809478Z          }
2025-11-09T23:42:54.6809552Z -        
2025-11-09T23:42:54.6809615Z +
2025-11-09T23:42:54.6809689Z          Ok(connected)
2025-11-09T23:42:54.6809755Z      }
2025-11-09T23:42:54.6809825Z  
2025-11-09T23:42:54.6810065Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:751:
2025-11-09T23:42:54.6810170Z      /// Initialize peer connections after startup
2025-11-09T23:42:54.6810248Z -    /// 
2025-11-09T23:42:54.6810313Z +    ///
2025-11-09T23:42:54.6810567Z      /// This is automatically called by `start()` to:
2025-11-09T23:42:54.6810735Z      /// 1. Discover peers from DNS seeds (for TCP/Quinn transports)
2025-11-09T23:42:54.6810843Z      /// 2. Connect to persistent peers from config
2025-11-09T23:42:54.6811080Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:756:
2025-11-09T23:42:54.6811281Z      /// 3. Discover Iroh peers (if Iroh is enabled) - uses Iroh's DERP servers and gossip
2025-11-09T23:42:54.6811445Z      /// 4. Connect to peers from address database to reach target count
2025-11-09T23:42:54.6811511Z -    /// 
2025-11-09T23:42:54.6811577Z +    ///
2025-11-09T23:42:54.6811797Z      /// Note: The address database now supports both SocketAddr-based addresses (TCP/Quinn)
2025-11-09T23:42:54.6811923Z      /// and Iroh NodeIds. Iroh peers are discovered through:
2025-11-09T23:42:54.6812046Z      /// - DERP servers (handled by Iroh's MagicEndpoint)
2025-11-09T23:42:54.6812288Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:770:
2025-11-09T23:42:54.6812378Z          target_peer_count: usize,
2025-11-09T23:42:54.6812455Z      ) -> Result<()> {
2025-11-09T23:42:54.6812616Z          // 1. Discover peers from DNS seeds (only for TCP/Quinn, not Iroh)
2025-11-09T23:42:54.6812807Z -        let should_discover_dns = self.transport_preference.allows_tcp() || 
2025-11-09T23:42:54.6812986Z +        let should_discover_dns = self.transport_preference.allows_tcp() || {
2025-11-09T23:42:54.6813168Z +            #[cfg(feature = "quinn")]
2025-11-09T23:42:54.6813242Z              {
2025-11-09T23:42:54.6813332Z -                #[cfg(feature = "quinn")]
2025-11-09T23:42:54.6813399Z -                {
2025-11-09T23:42:54.6813513Z -                    self.transport_preference.allows_quinn()
2025-11-09T23:42:54.6813587Z -                }
2025-11-09T23:42:54.6813922Z -                #[cfg(not(feature = "quinn"))]
2025-11-09T23:42:54.6813993Z -                {
2025-11-09T23:42:54.6814080Z -                    false
2025-11-09T23:42:54.6814152Z -                }
2025-11-09T23:42:54.6814218Z -            };
2025-11-09T23:42:54.6814441Z +                self.transport_preference.allows_quinn()
2025-11-09T23:42:54.6814523Z +            }
2025-11-09T23:42:54.6814612Z +            #[cfg(not(feature = "quinn"))]
2025-11-09T23:42:54.6814678Z +            {
2025-11-09T23:42:54.6814756Z +                false
2025-11-09T23:42:54.6814826Z +            }
2025-11-09T23:42:54.6814891Z +        };
2025-11-09T23:42:54.6814974Z          if should_discover_dns {
2025-11-09T23:42:54.6815141Z              if let Err(e) = self.discover_peers_from_dns(network, port).await {
2025-11-09T23:42:54.6815255Z                  warn!("DNS seed discovery failed: {}", e);
2025-11-09T23:42:54.6815499Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:807:
2025-11-09T23:42:54.6815661Z          // 4. Connect to peers from address database to reach target count
2025-11-09T23:42:54.6815785Z          // Wait a bit for persistent peers to connect first
2025-11-09T23:42:54.6815951Z          tokio::time::sleep(tokio::time::Duration::from_secs(2)).await;
2025-11-09T23:42:54.6816023Z -        
2025-11-09T23:42:54.6816087Z +
2025-11-09T23:42:54.6816264Z          if let Err(e) = self.connect_peers_from_database(target_peer_count).await {
2025-11-09T23:42:54.6816398Z              warn!("Failed to connect peers from database: {}", e);
2025-11-09T23:42:54.6816476Z          }
2025-11-09T23:42:54.6816718Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:821:
2025-11-09T23:42:54.6818688Z              "Starting network manager with transport preference: {:?}",
2025-11-09T23:42:54.6818801Z              self.transport_preference
2025-11-09T23:42:54.6818870Z          );
2025-11-09T23:42:54.6818937Z -        
2025-11-09T23:42:54.6819008Z +
2025-11-09T23:42:54.6819089Z          // Start listening first
2025-11-09T23:42:54.6819156Z  
2025-11-09T23:42:54.6819256Z          // Initialize Quinn transport if enabled
2025-11-09T23:42:54.6819675Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:886:
2025-11-09T23:42:54.6819779Z                              let ip = socket_addr.ip();
2025-11-09T23:42:54.6819901Z                              if !dos_protection.check_connection(ip).await {
2025-11-09T23:42:54.6820117Z                                  warn!("Connection rate limit exceeded for IP {}, rejecting connection", ip);
2025-11-09T23:42:54.6820197Z -                                
2025-11-09T23:42:54.6820262Z +
2025-11-09T23:42:54.6820367Z                                  // Check if we should auto-ban
2025-11-09T23:42:54.6820492Z                                  if dos_protection.should_auto_ban(ip).await {
2025-11-09T23:42:54.6820678Z                                      warn!("Auto-banning IP {} for repeated connection rate violations", ip);
2025-11-09T23:42:54.6820919Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:899:
2025-11-09T23:42:54.6821057Z                                      let mut ban_list_guard = ban_list.lock().unwrap();
2025-11-09T23:42:54.6821192Z                                      ban_list_guard.insert(socket_addr, unban_timestamp);
2025-11-09T23:42:54.6821269Z                                  }
2025-11-09T23:42:54.6821350Z -                                
2025-11-09T23:42:54.6821415Z +
2025-11-09T23:42:54.6821642Z                                  // Close connection immediately
2025-11-09T23:42:54.6821734Z                                  drop(conn);
2025-11-09T23:42:54.6821815Z                                  continue;
2025-11-09T23:42:54.6822053Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:910:
2025-11-09T23:42:54.6822168Z                                  let pm = peer_manager_clone.lock().unwrap();
2025-11-09T23:42:54.6822264Z                                  pm.peer_count()
2025-11-09T23:42:54.6822337Z                              };
2025-11-09T23:42:54.6822537Z -                            if !dos_protection.check_active_connections(current_connections).await {
2025-11-09T23:42:54.6822631Z +                            if !dos_protection
2025-11-09T23:42:54.6822763Z +                                .check_active_connections(current_connections)
2025-11-09T23:42:54.6822842Z +                                .await
2025-11-09T23:42:54.6822922Z +                            {
2025-11-09T23:42:54.6823157Z                                  warn!("Active connection limit exceeded, rejecting connection from {}", socket_addr);
2025-11-09T23:42:54.6823243Z                                  drop(conn);
2025-11-09T23:42:54.6823324Z                                  continue;
2025-11-09T23:42:54.6823576Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:918:
2025-11-09T23:42:54.6823643Z  
2025-11-09T23:42:54.6823742Z                              // Send connection notification
2025-11-09T23:42:54.6823899Z                              let transport_addr = TransportAddr::Tcp(socket_addr);
2025-11-09T23:42:54.6824109Z -                            let _ = peer_tx.send(NetworkMessage::PeerConnected(transport_addr.clone()));
2025-11-09T23:42:54.6824185Z +                            let _ =
2025-11-09T23:42:54.6824502Z +                                peer_tx.send(NetworkMessage::PeerConnected(transport_addr.clone()));
2025-11-09T23:42:54.6824570Z  
2025-11-09T23:42:54.6824731Z                              // Handle connection in background with graceful error handling
2025-11-09T23:42:54.6824837Z                              let peer_tx_clone = peer_tx.clone();
2025-11-09T23:42:54.6825083Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:927:
2025-11-09T23:42:54.6825195Z                                  // Create peer from transport connection
2025-11-09T23:42:54.6825303Z                                  use crate::network::peer::Peer;
2025-11-09T23:42:54.6826987Z                                  use crate::network::transport::TransportAddr;
2025-11-09T23:42:54.6827220Z -                                
2025-11-09T23:42:54.6827285Z +
2025-11-09T23:42:54.6827424Z                                  let peer = peer::Peer::from_transport_connection(
2025-11-09T23:42:54.6827503Z                                      conn,
2025-11-09T23:42:54.6827589Z                                      socket_addr,
2025-11-09T23:42:54.6827841Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:934:
2025-11-09T23:42:54.6827955Z                                      TransportAddr::Tcp(socket_addr),
2025-11-09T23:42:54.6828056Z                                      peer_tx_clone.clone(),
2025-11-09T23:42:54.6828132Z                                  );
2025-11-09T23:42:54.6828209Z -                                
2025-11-09T23:42:54.6828276Z +
2025-11-09T23:42:54.6828406Z                                  // Add peer to manager (with graceful error handling)
2025-11-09T23:42:54.6828520Z                                  match peer_manager_for_peer.lock() {
2025-11-09T23:42:54.6828610Z                                      Ok(mut pm) => {
2025-11-09T23:42:54.6828848Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:941:
2025-11-09T23:42:54.6829002Z                                          if let Err(e) = pm.add_peer(transport_addr.clone(), peer) {
2025-11-09T23:42:54.6829201Z                                              warn!("Failed to add peer {}: {}", socket_addr, e);
2025-11-09T23:42:54.6829972Z -                                            let _ = peer_tx_clone.send(NetworkMessage::PeerDisconnected(transport_addr.clone()));
2025-11-09T23:42:54.6830173Z +                                            let _ = peer_tx_clone.send(
2025-11-09T23:42:54.6830383Z +                                                NetworkMessage::PeerDisconnected(
2025-11-09T23:42:54.6830565Z +                                                    transport_addr.clone(),
2025-11-09T23:42:54.6830713Z +                                                ),
2025-11-09T23:42:54.6830857Z +                                            );
2025-11-09T23:42:54.6831001Z                                              return;
2025-11-09T23:42:54.6831138Z                                          }
2025-11-09T23:42:54.6831469Z -                                        info!("Successfully added peer {} (transport: {:?})", socket_addr, transport_addr);
2025-11-09T23:42:54.6831565Z +                                        info!(
2025-11-09T23:42:54.6831702Z +                                            "Successfully added peer {} (transport: {:?})",
2025-11-09T23:42:54.6831819Z +                                            socket_addr, transport_addr
2025-11-09T23:42:54.6831901Z +                                        );
2025-11-09T23:42:54.6831980Z                                      }
2025-11-09T23:42:54.6832066Z                                      Err(e) => {
2025-11-09T23:42:54.6832250Z -                                        warn!("Failed to lock peer manager for {}: {}", socket_addr, e);
2025-11-09T23:42:54.6832502Z -                                        let _ = peer_tx_clone.send(NetworkMessage::PeerDisconnected(transport_addr.clone()));
2025-11-09T23:42:54.6832589Z +                                        warn!(
2025-11-09T23:42:54.6832717Z +                                            "Failed to lock peer manager for {}: {}",
2025-11-09T23:42:54.6832819Z +                                            socket_addr, e
2025-11-09T23:42:54.6832898Z +                                        );
2025-11-09T23:42:54.6832987Z +                                        let _ =
2025-11-09T23:42:54.6833143Z +                                            peer_tx_clone.send(NetworkMessage::PeerDisconnected(
2025-11-09T23:42:54.6833248Z +                                                transport_addr.clone(),
2025-11-09T23:42:54.6833333Z +                                            ));
2025-11-09T23:42:54.6833412Z                                          return;
2025-11-09T23:42:54.6833610Z                                      }
2025-11-09T23:42:54.6833687Z                                  }
2025-11-09T23:42:54.6833950Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:954:
2025-11-09T23:42:54.6834027Z -                                
2025-11-09T23:42:54.6834093Z +
2025-11-09T23:42:54.6834537Z                                  // Connection will be cleaned up automatically when read/write tasks exit
2025-11-09T23:42:54.6834821Z                                  // Peer removal happens in process_messages when PeerDisconnected is received
2025-11-09T23:42:54.6834900Z                              });
2025-11-09T23:42:54.6835162Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:974:
2025-11-09T23:42:54.6835305Z                      let peer_manager = Arc::clone(&self.peer_manager);
2025-11-09T23:42:54.6835449Z                      let dos_protection = Arc::clone(&self.dos_protection);
2025-11-09T23:42:54.6835567Z                      let ban_list = Arc::clone(&self.ban_list);
2025-11-09T23:42:54.6835645Z -                    
2025-11-09T23:42:54.6835712Z +
2025-11-09T23:42:54.6835807Z                      tokio::spawn(async move {
2025-11-09T23:42:54.6835890Z                          loop {
2025-11-09T23:42:54.6836005Z                              match quinn_listener.accept().await {
2025-11-09T23:42:54.6836407Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:993:
2025-11-09T23:42:54.6838128Z                                      let ip = socket_addr.ip();
2025-11-09T23:42:54.6838263Z                                      if !dos_protection.check_connection(ip).await {
2025-11-09T23:42:54.6838497Z                                          warn!("Connection rate limit exceeded for IP {}, rejecting Quinn connection", ip);
2025-11-09T23:42:54.6838581Z -                                        
2025-11-09T23:42:54.6838653Z +
2025-11-09T23:42:54.6838785Z                                          if dos_protection.should_auto_ban(ip).await {
2025-11-09T23:42:54.6838979Z                                              warn!("Auto-banning IP {} for repeated connection rate violations", ip);
2025-11-09T23:42:54.6839133Z                                              let unban_timestamp = std::time::SystemTime::now()
2025-11-09T23:42:54.6839386Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1013:
2025-11-09T23:42:54.6839504Z                                          let pm = peer_manager.lock().unwrap();
2025-11-09T23:42:54.6839608Z                                          pm.peer_count()
2025-11-09T23:42:54.6839685Z                                      };
2025-11-09T23:42:54.6839885Z -                                    if !dos_protection.check_active_connections(current_connections).await {
2025-11-09T23:42:54.6839986Z +                                    if !dos_protection
2025-11-09T23:42:54.6840117Z +                                        .check_active_connections(current_connections)
2025-11-09T23:42:54.6840204Z +                                        .await
2025-11-09T23:42:54.6840279Z +                                    {
2025-11-09T23:42:54.6840539Z                                          warn!("Active connection limit exceeded, rejecting Quinn connection from {}", socket_addr);
2025-11-09T23:42:54.6840630Z                                          drop(conn);
2025-11-09T23:42:54.6840719Z                                          continue;
2025-11-09T23:42:54.6840976Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1021:
2025-11-09T23:42:54.6841042Z  
2025-11-09T23:42:54.6841153Z                                      // Send connection notification
2025-11-09T23:42:54.6841330Z                                      let quinn_transport_addr = TransportAddr::Quinn(socket_addr);
2025-11-09T23:42:54.6841556Z -                                    let _ = peer_tx.send(NetworkMessage::PeerConnected(quinn_transport_addr.clone()));
2025-11-09T23:42:54.6841827Z +                                    let _ = peer_tx.send(NetworkMessage::PeerConnected(
2025-11-09T23:42:54.6841940Z +                                        quinn_transport_addr.clone(),
2025-11-09T23:42:54.6842048Z +                                    ));
2025-11-09T23:42:54.6842159Z  
2025-11-09T23:42:54.6842455Z                                      // Handle connection in background with graceful error handling
2025-11-09T23:42:54.6842658Z                                      let peer_tx_clone = peer_tx.clone();
2025-11-09T23:42:54.6842969Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1029:
2025-11-09T23:42:54.6843645Z                                      tokio::spawn(async move {
2025-11-09T23:42:54.6843955Z                                          use crate::network::peer::Peer;
2025-11-09T23:42:54.6846384Z                                          use crate::network::transport::TransportAddr;
2025-11-09T23:42:54.6846747Z -                                        
2025-11-09T23:42:54.6846988Z +
2025-11-09T23:42:54.6847230Z                                          let quinn_addr = TransportAddr::Quinn(socket_addr);
2025-11-09T23:42:54.6847595Z                                          let peer = peer::Peer::from_transport_connection(
2025-11-09T23:42:54.6847908Z                                              conn,
2025-11-09T23:42:54.6848505Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1037:
2025-11-09T23:42:54.6848938Z                                              quinn_addr,
2025-11-09T23:42:54.6849209Z                                              peer_tx_clone.clone(),
2025-11-09T23:42:54.6849815Z                                          );
2025-11-09T23:42:54.6850064Z -                                        
2025-11-09T23:42:54.6850286Z +
2025-11-09T23:42:54.6850498Z                                          // Add peer to manager (with graceful error handling)
2025-11-09T23:42:54.6850829Z                                          match peer_manager_clone.lock() {
2025-11-09T23:42:54.6851115Z                                              Ok(mut pm) => {
2025-11-09T23:42:54.6851529Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1044:
2025-11-09T23:42:54.6852002Z -                                                if let Err(e) = pm.add_peer(quinn_addr.clone(), peer) {
2025-11-09T23:42:54.6852380Z -                                                    warn!("Failed to add Quinn peer {}: {}", socket_addr, e);
2025-11-09T23:42:54.6852840Z -                                                    let _ = peer_tx_clone.send(NetworkMessage::PeerDisconnected(quinn_addr.clone()));
2025-11-09T23:42:54.6853237Z +                                                if let Err(e) =
2025-11-09T23:42:54.6853528Z +                                                    pm.add_peer(quinn_addr.clone(), peer)
2025-11-09T23:42:54.6853819Z +                                                {
2025-11-09T23:42:54.6854068Z +                                                    warn!(
2025-11-09T23:42:54.6854489Z +                                                        "Failed to add Quinn peer {}: {}",
2025-11-09T23:42:54.6854786Z +                                                        socket_addr, e
2025-11-09T23:42:54.6856831Z +                                                    );
2025-11-09T23:42:54.6857110Z +                                                    let _ = peer_tx_clone.send(
2025-11-09T23:42:54.6857419Z +                                                        NetworkMessage::PeerDisconnected(
2025-11-09T23:42:54.6857723Z +                                                            quinn_addr.clone(),
2025-11-09T23:42:54.6857995Z +                                                        ),
2025-11-09T23:42:54.6858295Z +                                                    );
2025-11-09T23:42:54.6858556Z                                                      return;
2025-11-09T23:42:54.6858963Z                                                  }
2025-11-09T23:42:54.6859273Z -                                                info!("Successfully added Quinn peer {}", socket_addr);
2025-11-09T23:42:54.6859585Z +                                                info!(
2025-11-09T23:42:54.6859869Z +                                                    "Successfully added Quinn peer {}",
2025-11-09T23:42:54.6860167Z +                                                    socket_addr
2025-11-09T23:42:54.6860430Z +                                                );
2025-11-09T23:42:54.6860680Z                                              }
2025-11-09T23:42:54.6860924Z                                              Err(e) => {
2025-11-09T23:42:54.6861297Z                                                  warn!("Failed to lock peer manager for Quinn peer {}: {}", socket_addr, e);
2025-11-09T23:42:54.6861835Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1053:
2025-11-09T23:42:54.6862417Z -                                                let _ = peer_tx_clone.send(NetworkMessage::PeerDisconnected(quinn_addr.clone()));
2025-11-09T23:42:54.6862825Z +                                                let _ = peer_tx_clone.send(
2025-11-09T23:42:54.6863133Z +                                                    NetworkMessage::PeerDisconnected(
2025-11-09T23:42:54.6863561Z +                                                        quinn_addr.clone(),
2025-11-09T23:42:54.6863849Z +                                                    ),
2025-11-09T23:42:54.6864113Z +                                                );
2025-11-09T23:42:54.6864493Z                                                  return;
2025-11-09T23:42:54.6864736Z                                              }
2025-11-09T23:42:54.6864971Z                                          }
2025-11-09T23:42:54.6865376Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1065:
2025-11-09T23:42:54.6865790Z                      });
2025-11-09T23:42:54.6865983Z                  }
2025-11-09T23:42:54.6866160Z                  Err(e) => {
2025-11-09T23:42:54.6866470Z -                    warn!("Failed to start Quinn listener (graceful degradation): {}", e);
2025-11-09T23:42:54.6866798Z +                    warn!(
2025-11-09T23:42:54.6867075Z +                        "Failed to start Quinn listener (graceful degradation): {}",
2025-11-09T23:42:54.6867383Z +                        e
2025-11-09T23:42:54.6867581Z +                    );
2025-11-09T23:42:54.6867848Z                      // Continue with other transports - don't fail entire startup
2025-11-09T23:42:54.6868155Z                  }
2025-11-09T23:42:54.6868329Z              }
2025-11-09T23:42:54.6868674Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1107:
2025-11-09T23:42:54.6869123Z                                          let pm = peer_manager.lock().unwrap();
2025-11-09T23:42:54.6869412Z                                          pm.peer_count()
2025-11-09T23:42:54.6869661Z                                      };
2025-11-09T23:42:54.6870011Z -                                    if !dos_protection.check_active_connections(current_connections).await {
2025-11-09T23:42:54.6870385Z +                                    if !dos_protection
2025-11-09T23:42:54.6870680Z +                                        .check_active_connections(current_connections)
2025-11-09T23:42:54.6870975Z +                                        .await
2025-11-09T23:42:54.6871209Z +                                    {
2025-11-09T23:42:54.6871544Z                                          warn!("Active connection limit exceeded, rejecting Iroh connection");
2025-11-09T23:42:54.6871903Z                                          drop(conn);
2025-11-09T23:42:54.6872545Z                                          continue;
2025-11-09T23:42:54.6872963Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1114:
2025-11-09T23:42:54.6873552Z                                      }
2025-11-09T23:42:54.6873770Z  
2025-11-09T23:42:54.6874026Z                                      // Send connection notification using TransportAddr directly
2025-11-09T23:42:54.6874645Z -                                    let _ = peer_tx.send(NetworkMessage::PeerConnected(iroh_addr.clone()));
2025-11-09T23:42:54.6875026Z +                                    let _ = peer_tx
2025-11-09T23:42:54.6875359Z +                                        .send(NetworkMessage::PeerConnected(iroh_addr.clone()));
2025-11-09T23:42:54.6875660Z  
2025-11-09T23:42:54.6875912Z                                      // Handle connection in background with graceful error handling
2025-11-09T23:42:54.6876269Z                                      let peer_tx_clone = peer_tx.clone();
2025-11-09T23:42:54.6876718Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1121:
2025-11-09T23:42:54.6877192Z                                      let peer_manager_clone = Arc::clone(&peer_manager);
2025-11-09T23:42:54.6877523Z                                      let iroh_addr_clone = iroh_addr.clone();
2025-11-09T23:42:54.6877888Z -                                    let socket_to_transport_clone = Arc::clone(&socket_to_transport);
2025-11-09T23:42:54.6878253Z +                                    let socket_to_transport_clone =
2025-11-09T23:42:54.6878678Z +                                        Arc::clone(&socket_to_transport);
2025-11-09T23:42:54.6879023Z                                      let address_database_clone = Arc::clone(&address_database);
2025-11-09T23:42:54.6879365Z                                      tokio::spawn(async move {
2025-11-09T23:42:54.6879652Z                                          use crate::network::peer::Peer;
2025-11-09T23:42:54.6880089Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1127:
2025-11-09T23:42:54.6880502Z -                                        
2025-11-09T23:42:54.6880724Z +
2025-11-09T23:42:54.6880984Z                                          // For Iroh, we need a SocketAddr for Peer::from_transport_connection
2025-11-09T23:42:54.6881403Z                                          // Generate a unique placeholder based on key hash for lookups
2025-11-09T23:42:54.6881868Z -                                        let placeholder_socket = if let TransportAddr::Iroh(ref key) = iroh_addr_clone {
2025-11-09T23:42:54.6882383Z -                                            // Use first 4 bytes of key for IP, last 2 bytes for port to create unique placeholder
2025-11-09T23:42:54.6882783Z -                                            let ip_bytes = if key.len() >= 4 {
2025-11-09T23:42:54.6883080Z -                                                [key[0], key[1], key[2], key[3]]
2025-11-09T23:42:54.6883367Z +                                        let placeholder_socket =
2025-11-09T23:42:54.6883701Z +                                            if let TransportAddr::Iroh(ref key) = iroh_addr_clone {
2025-11-09T23:42:54.6884226Z +                                                // Use first 4 bytes of key for IP, last 2 bytes for port to create unique placeholder
2025-11-09T23:42:54.6887214Z +                                                let ip_bytes = if key.len() >= 4 {
2025-11-09T23:42:54.6887545Z +                                                    [key[0], key[1], key[2], key[3]]
2025-11-09T23:42:54.6887845Z +                                                } else {
2025-11-09T23:42:54.6888118Z +                                                    [0, 0, 0, 0]
2025-11-09T23:42:54.6888378Z +                                                };
2025-11-09T23:42:54.6888653Z +                                                let port = if key.len() >= 6 {
2025-11-09T23:42:54.6888961Z +                                                    u16::from_be_bytes([
2025-11-09T23:42:54.6889246Z +                                                        key[key.len() - 2],
2025-11-09T23:42:54.6889705Z +                                                        key[key.len() - 1],
2025-11-09T23:42:54.6889970Z +                                                    ])
2025-11-09T23:42:54.6890227Z +                                                } else {
2025-11-09T23:42:54.6890476Z +                                                    0
2025-11-09T23:42:54.6890729Z +                                                };
2025-11-09T23:42:54.6891030Z +                                                std::net::SocketAddr::from((ip_bytes, port))
2025-11-09T23:42:54.6891327Z                                              } else {
2025-11-09T23:42:54.6891586Z -                                                [0, 0, 0, 0]
2025-11-09T23:42:54.6891875Z +                                                std::net::SocketAddr::from(([0, 0, 0, 0], 0))
2025-11-09T23:42:54.6892170Z                                              };
2025-11-09T23:42:54.6892436Z -                                            let port = if key.len() >= 6 {
2025-11-09T23:42:54.6892790Z -                                                u16::from_be_bytes([key[key.len()-2], key[key.len()-1]])
2025-11-09T23:42:54.6893185Z -                                            } else {
2025-11-09T23:42:54.6893436Z -                                                0
2025-11-09T23:42:54.6893683Z -                                            };
2025-11-09T23:42:54.6893965Z -                                            std::net::SocketAddr::from((ip_bytes, port))
2025-11-09T23:42:54.6896423Z -                                        } else {
2025-11-09T23:42:54.6896715Z -                                            std::net::SocketAddr::from(([0, 0, 0, 0], 0))
2025-11-09T23:42:54.6897007Z -                                        };
2025-11-09T23:42:54.6897249Z -                                        
2025-11-09T23:42:54.6897471Z +
2025-11-09T23:42:54.6897703Z                                          let peer = peer::Peer::from_transport_connection(
2025-11-09T23:42:54.6898011Z                                              conn,
2025-11-09T23:42:54.6898281Z                                              placeholder_socket,
2025-11-09T23:42:54.6898724Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1150:
2025-11-09T23:42:54.6899170Z                                              iroh_addr_clone.clone(),
2025-11-09T23:42:54.6899460Z                                              peer_tx_clone.clone(),
2025-11-09T23:42:54.6899724Z                                          );
2025-11-09T23:42:54.6899965Z -                                        
2025-11-09T23:42:54.6900178Z +
2025-11-09T23:42:54.6900396Z                                          // Add peer to manager (with graceful error handling)
2025-11-09T23:42:54.6900993Z                                          match peer_manager_clone.lock() {
2025-11-09T23:42:54.6901290Z                                              Ok(mut pm) => {
2025-11-09T23:42:54.6901709Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1157:
2025-11-09T23:42:54.6902203Z -                                                if let Err(e) = pm.add_peer(iroh_addr_clone.clone(), peer) {
2025-11-09T23:42:54.6902538Z +                                                if let Err(e) =
2025-11-09T23:42:54.6902836Z +                                                    pm.add_peer(iroh_addr_clone.clone(), peer)
2025-11-09T23:42:54.6903138Z +                                                {
2025-11-09T23:42:54.6903409Z                                                      warn!("Failed to add Iroh peer: {}", e);
2025-11-09T23:42:54.6903851Z -                                                    let _ = peer_tx_clone.send(NetworkMessage::PeerDisconnected(iroh_addr_clone.clone()));
2025-11-09T23:42:54.6904397Z +                                                    let _ = peer_tx_clone.send(
2025-11-09T23:42:54.6904715Z +                                                        NetworkMessage::PeerDisconnected(
2025-11-09T23:42:54.6905179Z +                                                            iroh_addr_clone.clone(),
2025-11-09T23:42:54.6905456Z +                                                        ),
2025-11-09T23:42:54.6905714Z +                                                    );
2025-11-09T23:42:54.6905966Z                                                      return;
2025-11-09T23:42:54.6907736Z                                                  }
2025-11-09T23:42:54.6908123Z                                                  // Store mapping from placeholder SocketAddr to TransportAddr for Iroh lookups
2025-11-09T23:42:54.6908676Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1163:
2025-11-09T23:42:54.6909278Z -                                                socket_to_transport_clone.lock().unwrap().insert(placeholder_socket, iroh_addr_clone.clone());
2025-11-09T23:42:54.6909703Z -                                                
2025-11-09T23:42:54.6910010Z +                                                socket_to_transport_clone.lock().unwrap().insert(
2025-11-09T23:42:54.6910337Z +                                                    placeholder_socket,
2025-11-09T23:42:54.6910632Z +                                                    iroh_addr_clone.clone(),
2025-11-09T23:42:54.6910906Z +                                                );
2025-11-09T23:42:54.6911137Z +
2025-11-09T23:42:54.6911484Z                                                  // Store Iroh NodeId in address database
2025-11-09T23:42:54.6911867Z -                                                if let TransportAddr::Iroh(ref node_id_bytes) = iroh_addr_clone {
2025-11-09T23:42:54.6912263Z +                                                if let TransportAddr::Iroh(ref node_id_bytes) =
2025-11-09T23:42:54.6912576Z +                                                    iroh_addr_clone
2025-11-09T23:42:54.6912830Z +                                                {
2025-11-09T23:42:54.6913100Z                                                      if node_id_bytes.len() == 32 {
2025-11-09T23:42:54.6913397Z                                                          use iroh_net::NodeId;
2025-11-09T23:42:54.6913917Z -                                                        if let Ok(node_id) = NodeId::from_bytes(node_id_bytes) {
2025-11-09T23:42:54.6916331Z -                                                            let address_db_clone = address_database_clone.clone();
2025-11-09T23:42:54.6916673Z +                                                        if let Ok(node_id) =
2025-11-09T23:42:54.6916978Z +                                                            NodeId::from_bytes(node_id_bytes)
2025-11-09T23:42:54.6917262Z +                                                        {
2025-11-09T23:42:54.6917533Z +                                                            let address_db_clone =
2025-11-09T23:42:54.6917829Z +                                                                address_database_clone.clone();
2025-11-09T23:42:54.6918149Z                                                              tokio::spawn(async move {
2025-11-09T23:42:54.6918474Z -                                                                let mut db = address_db_clone.lock().unwrap();
2025-11-09T23:42:54.6918894Z -                                                                db.add_iroh_address(node_id, 0); // Services will be updated on version exchange
2025-11-09T23:42:54.6919300Z +                                                                let mut db = address_db_clone
2025-11-09T23:42:54.6919583Z +                                                                    .lock()
2025-11-09T23:42:54.6919860Z +                                                                    .unwrap();
2025-11-09T23:42:54.6920154Z +                                                                db.add_iroh_address(node_id, 0);
2025-11-09T23:42:54.6920479Z +                                                                // Services will be updated on version exchange
2025-11-09T23:42:54.6920924Z                                                              });
2025-11-09T23:42:54.6921185Z                                                          }
2025-11-09T23:42:54.6921435Z                                                      }
2025-11-09T23:42:54.6921856Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1177:
2025-11-09T23:42:54.6922284Z                                                  }
2025-11-09T23:42:54.6922526Z -                                                
2025-11-09T23:42:54.6922760Z +
2025-11-09T23:42:54.6923042Z                                                  info!("Successfully added Iroh peer (transport: {:?})", iroh_addr_clone);
2025-11-09T23:42:54.6923409Z                                              }
2025-11-09T23:42:54.6923656Z                                              Err(e) => {
2025-11-09T23:42:54.6924069Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1182:
2025-11-09T23:42:54.6924692Z -                                                warn!("Failed to lock peer manager for Iroh peer: {}", e);
2025-11-09T23:42:54.6925168Z -                                                let _ = peer_tx_clone.send(NetworkMessage::PeerDisconnected(iroh_addr_clone.clone()));
2025-11-09T23:42:54.6925572Z +                                                warn!(
2025-11-09T23:42:54.6926030Z +                                                    "Failed to lock peer manager for Iroh peer: {}",
2025-11-09T23:42:54.6926339Z +                                                    e
2025-11-09T23:42:54.6926587Z +                                                );
2025-11-09T23:42:54.6926852Z +                                                let _ = peer_tx_clone.send(
2025-11-09T23:42:54.6927165Z +                                                    NetworkMessage::PeerDisconnected(
2025-11-09T23:42:54.6927471Z +                                                        iroh_addr_clone.clone(),
2025-11-09T23:42:54.6927748Z +                                                    ),
2025-11-09T23:42:54.6927989Z +                                                );
2025-11-09T23:42:54.6928231Z                                                  return;
2025-11-09T23:42:54.6928519Z                                              }
2025-11-09T23:42:54.6928753Z                                          }
2025-11-09T23:42:54.6929172Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1195:
2025-11-09T23:42:54.6929578Z                      });
2025-11-09T23:42:54.6929767Z                  }
2025-11-09T23:42:54.6929943Z                  Err(e) => {
2025-11-09T23:42:54.6930246Z -                    warn!("Failed to start Iroh listener (graceful degradation): {}", e);
2025-11-09T23:42:54.6930573Z +                    warn!(
2025-11-09T23:42:54.6930846Z +                        "Failed to start Iroh listener (graceful degradation): {}",
2025-11-09T23:42:54.6931155Z +                        e
2025-11-09T23:42:54.6931350Z +                    );
2025-11-09T23:42:54.6931620Z                      // Continue with other transports - don't fail entire startup
2025-11-09T23:42:54.6931924Z                  }
2025-11-09T23:42:54.6932098Z              }
2025-11-09T23:42:54.6932447Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1203:
2025-11-09T23:42:54.6932851Z  
2025-11-09T23:42:54.6933039Z          // Start periodic ban cleanup task
2025-11-09T23:42:54.6933304Z          self.start_ban_cleanup_task();
2025-11-09T23:42:54.6933540Z -        
2025-11-09T23:42:54.6933695Z +
2025-11-09T23:42:54.6933878Z          // Start pending request cleanup task
2025-11-09T23:42:54.6936162Z          self.start_request_cleanup_task();
2025-11-09T23:42:54.6936401Z -        
2025-11-09T23:42:54.6936556Z +
2025-11-09T23:42:54.6936738Z          // Start DoS protection cleanup task
2025-11-09T23:42:54.6942664Z          self.start_dos_protection_cleanup_task();
2025-11-09T23:42:54.6943471Z -        
2025-11-09T23:42:54.6943655Z +
2025-11-09T23:42:54.6945972Z          // Note: Peer connection initialization (DNS seeds, persistent peers, etc.)
2025-11-09T23:42:54.6946476Z          // should be called separately via initialize_peer_connections() after start()
2025-11-09T23:42:54.6946966Z          // This allows the caller to provide config, network type, and target peer count
2025-11-09T23:42:54.6947517Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1216:
2025-11-09T23:42:54.6947927Z -        
2025-11-09T23:42:54.6948083Z +
2025-11-09T23:42:54.6948239Z          Ok(())
2025-11-09T23:42:54.6948404Z      }
2025-11-09T23:42:54.6948560Z -    
2025-11-09T23:42:54.6948707Z +
2025-11-09T23:42:54.6948960Z      /// Generate a new request ID for async request-response patterns
2025-11-09T23:42:54.6949335Z      pub fn generate_request_id(&self) -> u64 {
2025-11-09T23:42:54.6949663Z          let mut counter = self.request_id_counter.lock().unwrap();
2025-11-09T23:42:54.6950158Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1224:
2025-11-09T23:42:54.6950616Z          *counter = counter.wrapping_add(1);
2025-11-09T23:42:54.6950876Z          id
2025-11-09T23:42:54.6951043Z      }
2025-11-09T23:42:54.6951210Z -    
2025-11-09T23:42:54.6951367Z +
2025-11-09T23:42:54.6951625Z      /// Register a pending request and return the response receiver
2025-11-09T23:42:54.6952130Z      /// Returns (request_id, response_receiver)
2025-11-09T23:42:54.6952612Z -    pub fn register_request(&self, peer_addr: SocketAddr) -> (u64, tokio::sync::oneshot::Receiver<Vec<u8>>) {
2025-11-09T23:42:54.6953408Z +    pub fn register_request(
2025-11-09T23:42:54.6953634Z +        &self,
2025-11-09T23:42:54.6953838Z +        peer_addr: SocketAddr,
2025-11-09T23:42:54.6954119Z +    ) -> (u64, tokio::sync::oneshot::Receiver<Vec<u8>>) {
2025-11-09T23:42:54.6954644Z          self.register_request_with_priority(peer_addr, 0)
2025-11-09T23:42:54.6954936Z      }
2025-11-09T23:42:54.6955109Z -    
2025-11-09T23:42:54.6955270Z +
2025-11-09T23:42:54.6955567Z      /// Register a pending request with priority and return the response receiver
2025-11-09T23:42:54.6955961Z      /// Returns (request_id, response_receiver)
2025-11-09T23:42:54.6956265Z      /// Priority: 0 = normal, higher = more important
2025-11-09T23:42:54.6956980Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1237:
2025-11-09T23:42:54.6957697Z -    pub fn register_request_with_priority(&self, peer_addr: SocketAddr, priority: u8) -> (u64, tokio::sync::oneshot::Receiver<Vec<u8>>) {
2025-11-09T23:42:54.6958482Z +    pub fn register_request_with_priority(
2025-11-09T23:42:54.6958742Z +        &self,
2025-11-09T23:42:54.6958943Z +        peer_addr: SocketAddr,
2025-11-09T23:42:54.6959173Z +        priority: u8,
2025-11-09T23:42:54.6959419Z +    ) -> (u64, tokio::sync::oneshot::Receiver<Vec<u8>>) {
2025-11-09T23:42:54.6959738Z          let request_id = self.generate_request_id();
2025-11-09T23:42:54.6960052Z          let (tx, rx) = tokio::sync::oneshot::channel();
2025-11-09T23:42:54.6960317Z -        
2025-11-09T23:42:54.6960481Z +
2025-11-09T23:42:54.6960690Z          use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:42:54.6960977Z          let timestamp = SystemTime::now()
2025-11-09T23:42:54.6961248Z              .duration_since(UNIX_EPOCH)
2025-11-09T23:42:54.6961687Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1244:
2025-11-09T23:42:54.6962111Z              .unwrap()
2025-11-09T23:42:54.6962316Z              .as_secs();
2025-11-09T23:42:54.6962509Z -        
2025-11-09T23:42:54.6962678Z +
2025-11-09T23:42:54.6962866Z          let pending_req = PendingRequest {
2025-11-09T23:42:54.6963131Z              sender: tx,
2025-11-09T23:42:54.6963327Z              peer_addr,
2025-11-09T23:42:54.6963706Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1251:
2025-11-09T23:42:54.6966349Z              priority,
2025-11-09T23:42:54.6966570Z              retry_count: 0,
2025-11-09T23:42:54.6966790Z          };
2025-11-09T23:42:54.6966956Z -        
2025-11-09T23:42:54.6967252Z -        self.pending_requests.lock().unwrap().insert(request_id, pending_req);
2025-11-09T23:42:54.6967601Z +
2025-11-09T23:42:54.6967783Z +        self.pending_requests
2025-11-09T23:42:54.6968007Z +            .lock()
2025-11-09T23:42:54.6968209Z +            .unwrap()
2025-11-09T23:42:54.6968425Z +            .insert(request_id, pending_req);
2025-11-09T23:42:54.6968694Z          (request_id, rx)
2025-11-09T23:42:54.6968892Z      }
2025-11-09T23:42:54.6969055Z -    
2025-11-09T23:42:54.6969213Z +
2025-11-09T23:42:54.6969437Z      /// Complete a pending request by sending the response
2025-11-09T23:42:54.6969846Z      pub fn complete_request(&self, request_id: u64, response: Vec<u8>) -> bool {
2025-11-09T23:42:54.6970267Z          let mut pending = self.pending_requests.lock().unwrap();
2025-11-09T23:42:54.6970762Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1266:
2025-11-09T23:42:54.6971179Z              false
2025-11-09T23:42:54.6971368Z          }
2025-11-09T23:42:54.6971534Z      }
2025-11-09T23:42:54.6971700Z -    
2025-11-09T23:42:54.6971858Z +
2025-11-09T23:42:54.6972037Z      /// Cancel a pending request
2025-11-09T23:42:54.6972332Z      pub fn cancel_request(&self, request_id: u64) -> bool {
2025-11-09T23:42:54.6972823Z          let mut pending = self.pending_requests.lock().unwrap();
2025-11-09T23:42:54.6973302Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1273:
2025-11-09T23:42:54.6973741Z          pending.remove(&request_id).is_some()
2025-11-09T23:42:54.6973997Z      }
2025-11-09T23:42:54.6974156Z -    
2025-11-09T23:42:54.6974432Z +
2025-11-09T23:42:54.6974632Z      /// Get pending requests for a specific peer
2025-11-09T23:42:54.6975030Z      pub fn get_pending_requests_for_peer(&self, peer_addr: SocketAddr) -> Vec<u64> {
2025-11-09T23:42:54.6975468Z          let pending = self.pending_requests.lock().unwrap();
2025-11-09T23:42:54.6975923Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1279:
2025-11-09T23:42:54.6978032Z -        pending.iter()
2025-11-09T23:42:54.6978232Z +        pending
2025-11-09T23:42:54.6978418Z +            .iter()
2025-11-09T23:42:54.6978649Z              .filter(|(_, req)| req.peer_addr == peer_addr)
2025-11-09T23:42:54.6978939Z              .map(|(id, _)| *id)
2025-11-09T23:42:54.6979157Z              .collect()
2025-11-09T23:42:54.6979524Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1283:
2025-11-09T23:42:54.6979930Z      }
2025-11-09T23:42:54.6980089Z -    
2025-11-09T23:42:54.6980256Z +
2025-11-09T23:42:54.6980479Z      /// Clean up expired requests (older than max_age_seconds)
2025-11-09T23:42:54.6980882Z      pub fn cleanup_expired_requests(&self, max_age_seconds: u64) -> usize {
2025-11-09T23:42:54.6981258Z          use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:42:54.6981695Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1289:
2025-11-09T23:42:54.6982121Z              .duration_since(UNIX_EPOCH)
2025-11-09T23:42:54.6982373Z              .unwrap()
2025-11-09T23:42:54.6982576Z              .as_secs();
2025-11-09T23:42:54.6982776Z -        
2025-11-09T23:42:54.6982944Z +
2025-11-09T23:42:54.6983172Z          let mut pending = self.pending_requests.lock().unwrap();
2025-11-09T23:42:54.6983508Z -        let expired: Vec<u64> = pending.iter()
2025-11-09T23:42:54.6983781Z +        let expired: Vec<u64> = pending
2025-11-09T23:42:54.6984023Z +            .iter()
2025-11-09T23:42:54.6984427Z              .filter(|(_, req)| now.saturating_sub(req.timestamp) > max_age_seconds)
2025-11-09T23:42:54.6984776Z              .map(|(id, _)| *id)
2025-11-09T23:42:54.6984995Z              .collect();
2025-11-09T23:42:54.6985375Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1298:
2025-11-09T23:42:54.6985925Z -        
2025-11-09T23:42:54.6986087Z +
2025-11-09T23:42:54.6986261Z          for id in &expired {
2025-11-09T23:42:54.6986491Z              pending.remove(id);
2025-11-09T23:42:54.6986714Z          }
2025-11-09T23:42:54.6987057Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1302:
2025-11-09T23:42:54.6987859Z -        
2025-11-09T23:42:54.6988030Z +
2025-11-09T23:42:54.6988198Z          expired.len()
2025-11-09T23:42:54.6988389Z      }
2025-11-09T23:42:54.6988553Z -    
2025-11-09T23:42:54.6988711Z +
2025-11-09T23:42:54.6988949Z      /// Start periodic task to clean up expired pending requests
2025-11-09T23:42:54.6989283Z      fn start_request_cleanup_task(&self) {
2025-11-09T23:42:54.6989621Z          let pending_requests = Arc::clone(&self.pending_requests);
2025-11-09T23:42:54.6990111Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1309:
2025-11-09T23:42:54.6990531Z -        
2025-11-09T23:42:54.6990701Z +
2025-11-09T23:42:54.6990875Z          tokio::spawn(async move {
2025-11-09T23:42:54.6991246Z              let mut interval = tokio::time::interval(tokio::time::Duration::from_secs(60));
2025-11-09T23:42:54.6991611Z              loop {
2025-11-09T23:42:54.6991972Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1313:
2025-11-09T23:42:54.6992551Z                  interval.tick().await;
2025-11-09T23:42:54.6992790Z -                
2025-11-09T23:42:54.6992972Z +
2025-11-09T23:42:54.6993194Z                  // Clean up old pending requests (older than 5 minutes)
2025-11-09T23:42:54.6993537Z                  use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:42:54.6993827Z                  let now = SystemTime::now()
2025-11-09T23:42:54.6996228Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1319:
2025-11-09T23:42:54.6996644Z                      .unwrap()
2025-11-09T23:42:54.6996877Z                      .as_secs();
2025-11-09T23:42:54.6997123Z                  let timeout_seconds = 300; // 5 minutes
2025-11-09T23:42:54.6997376Z -                
2025-11-09T23:42:54.6997549Z +
2025-11-09T23:42:54.6997766Z                  let mut pending = pending_requests.lock().unwrap();
2025-11-09T23:42:54.6998075Z                  let initial_count = pending.len();
2025-11-09T23:42:54.6998354Z -                pending.retain(|_, req| {
2025-11-09T23:42:54.6998667Z -                    now.saturating_sub(req.timestamp) < timeout_seconds
2025-11-09T23:42:54.6998956Z -                });
2025-11-09T23:42:54.6999279Z +                pending.retain(|_, req| now.saturating_sub(req.timestamp) < timeout_seconds);
2025-11-09T23:42:54.6999679Z                  let removed = initial_count - pending.len();
2025-11-09T23:42:54.6999957Z                  if removed > 0 {
2025-11-09T23:42:54.7000342Z -                    debug!("Cleaned up {} stale pending requests (older than {}s)", removed, timeout_seconds);
2025-11-09T23:42:54.7000759Z +                    debug!(
2025-11-09T23:42:54.7001032Z +                        "Cleaned up {} stale pending requests (older than {}s)",
2025-11-09T23:42:54.7001357Z +                        removed, timeout_seconds
2025-11-09T23:42:54.7001610Z +                    );
2025-11-09T23:42:54.7001799Z                  }
2025-11-09T23:42:54.7002000Z                  if !pending.is_empty() {
2025-11-09T23:42:54.7002295Z                      debug!("Pending requests: {}", pending.len());
2025-11-09T23:42:54.7002762Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1335:
2025-11-09T23:42:54.7003177Z              }
2025-11-09T23:42:54.7003359Z          });
2025-11-09T23:42:54.7003529Z      }
2025-11-09T23:42:54.7003695Z -    
2025-11-09T23:42:54.7003863Z +
2025-11-09T23:42:54.7004079Z      /// Start periodic task to clean up DoS protection data
2025-11-09T23:42:54.7006362Z      fn start_dos_protection_cleanup_task(&self) {
2025-11-09T23:42:54.7006837Z          let dos_protection = Arc::clone(&self.dos_protection);
2025-11-09T23:42:54.7007305Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1342:
2025-11-09T23:42:54.7007753Z          let ban_list = Arc::clone(&self.ban_list);
2025-11-09T23:42:54.7008019Z -        
2025-11-09T23:42:54.7008184Z +
2025-11-09T23:42:54.7008365Z          tokio::spawn(async move {
2025-11-09T23:42:54.7008783Z              let mut interval = tokio::time::interval(tokio::time::Duration::from_secs(300)); // Every 5 minutes
2025-11-09T23:42:54.7009193Z              loop {
2025-11-09T23:42:54.7009552Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1347:
2025-11-09T23:42:54.7009974Z                  interval.tick().await;
2025-11-09T23:42:54.7010215Z -                
2025-11-09T23:42:54.7010387Z +
2025-11-09T23:42:54.7010591Z                  // Cleanup old connection rate limiter entries
2025-11-09T23:42:54.7010892Z                  dos_protection.cleanup().await;
2025-11-09T23:42:54.7011211Z -                
2025-11-09T23:42:54.7011392Z +
2025-11-09T23:42:54.7011581Z                  // Auto-ban IPs that should be banned
2025-11-09T23:42:54.7012011Z                  // Note: This is a simplified version - in production, you'd want more sophisticated logic
2025-11-09T23:42:54.7012449Z                  let dos_clone = Arc::clone(&dos_protection);
2025-11-09T23:42:54.7012965Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1361:
2025-11-09T23:42:54.7013536Z              }
2025-11-09T23:42:54.7013861Z          });
2025-11-09T23:42:54.7014033Z      }
2025-11-09T23:42:54.7014197Z -    
2025-11-09T23:42:54.7014472Z +
2025-11-09T23:42:54.7014676Z      /// Start periodic task to clean up expired bans
2025-11-09T23:42:54.7014969Z      fn start_ban_cleanup_task(&self) {
2025-11-09T23:42:54.7015252Z          let ban_list = Arc::clone(&self.ban_list);
2025-11-09T23:42:54.7015692Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1369:
2025-11-09T23:42:54.7016306Z              let mut interval = tokio::time::interval(tokio::time::Duration::from_secs(300)); // Every 5 minutes
2025-11-09T23:42:54.7016721Z              loop {
2025-11-09T23:42:54.7016918Z                  interval.tick().await;
2025-11-09T23:42:54.7017147Z -                
2025-11-09T23:42:54.7017329Z +
2025-11-09T23:42:54.7017523Z                  use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:42:54.7017820Z                  let now = SystemTime::now()
2025-11-09T23:42:54.7018087Z                      .duration_since(UNIX_EPOCH)
2025-11-09T23:42:54.7018514Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1376:
2025-11-09T23:42:54.7018926Z                      .unwrap()
2025-11-09T23:42:54.7019145Z                      .as_secs();
2025-11-09T23:42:54.7019362Z -                
2025-11-09T23:42:54.7019532Z +
2025-11-09T23:42:54.7019742Z                  let mut ban_list_guard = ban_list.lock().unwrap();
2025-11-09T23:42:54.7020069Z                  let expired: Vec<SocketAddr> = ban_list_guard
2025-11-09T23:42:54.7020348Z                      .iter()
2025-11-09T23:42:54.7020726Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1384:
2025-11-09T23:42:54.7021138Z                      })
2025-11-09T23:42:54.7021344Z                      .map(|(addr, _)| *addr)
2025-11-09T23:42:54.7021598Z                      .collect();
2025-11-09T23:42:54.7021813Z -                
2025-11-09T23:42:54.7021986Z +
2025-11-09T23:42:54.7022165Z                  for addr in expired {
2025-11-09T23:42:54.7022429Z                      ban_list_guard.remove(&addr);
2025-11-09T23:42:54.7022729Z                      debug!("Cleaned up expired ban for {}", addr);
2025-11-09T23:42:54.7023175Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1391:
2025-11-09T23:42:54.7023580Z                  }
2025-11-09T23:42:54.7023756Z -                
2025-11-09T23:42:54.7024089Z +
2025-11-09T23:42:54.7024263Z                  if !expired.is_empty() {
2025-11-09T23:42:54.7024694Z                      info!("Cleaned up {} expired ban(s)", expired.len());
2025-11-09T23:42:54.7024988Z                  }
2025-11-09T23:42:54.7025340Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1406:
2025-11-09T23:42:54.7025798Z      pub fn peer_addresses(&self) -> Vec<SocketAddr> {
2025-11-09T23:42:54.7026159Z          self.peer_manager.lock().unwrap().peer_socket_addresses()
2025-11-09T23:42:54.7026460Z      }
2025-11-09T23:42:54.7026616Z -    
2025-11-09T23:42:54.7026776Z +
2025-11-09T23:42:54.7026964Z      /// Get all peer addresses (as TransportAddr)
2025-11-09T23:42:54.7027314Z      pub fn peer_transport_addresses(&self) -> Vec<TransportAddr> {
2025-11-09T23:42:54.7027676Z          self.peer_manager.lock().unwrap().peer_addresses()
2025-11-09T23:42:54.7028135Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1429:
2025-11-09T23:42:54.7028654Z      /// Uses peer quality to prioritize reliable peers for critical messages
2025-11-09T23:42:54.7029136Z      pub async fn broadcast_with_quality_priority(&self, message: Vec<u8>) -> Result<()> {
2025-11-09T23:42:54.7029560Z          let pm = self.peer_manager.lock().unwrap();
2025-11-09T23:42:54.7029818Z -        
2025-11-09T23:42:54.7029983Z +
2025-11-09T23:42:54.7030157Z          // Get reliable peers first
2025-11-09T23:42:54.7030576Z          let reliable_peers = pm.select_reliable_peers();
2025-11-09T23:42:54.7030861Z          drop(pm);
2025-11-09T23:42:54.7031221Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1436:
2025-11-09T23:42:54.7031292Z -        
2025-11-09T23:42:54.7031362Z +
2025-11-09T23:42:54.7031457Z          // Send to reliable peers first
2025-11-09T23:42:54.7031547Z          for addr in &reliable_peers {
2025-11-09T23:42:54.7031759Z -            if let Err(e) = self.send_to_peer_by_transport(addr.clone(), message.clone()).await {
2025-11-09T23:42:54.7031845Z +            if let Err(e) = self
2025-11-09T23:42:54.7031990Z +                .send_to_peer_by_transport(addr.clone(), message.clone())
2025-11-09T23:42:54.7032064Z +                .await
2025-11-09T23:42:54.7032137Z +            {
2025-11-09T23:42:54.7032280Z                  warn!("Failed to send to reliable peer {:?}: {}", addr, e);
2025-11-09T23:42:54.7032355Z              }
2025-11-09T23:42:54.7032434Z          }
2025-11-09T23:42:54.7032681Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1443:
2025-11-09T23:42:54.7032751Z -        
2025-11-09T23:42:54.7032819Z +
2025-11-09T23:42:54.7032919Z          // Then send to remaining peers
2025-11-09T23:42:54.7033032Z          let pm = self.peer_manager.lock().unwrap();
2025-11-09T23:42:54.7033134Z          let all_peers = pm.peer_addresses();
2025-11-09T23:42:54.7033383Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1447:
2025-11-09T23:42:54.7033509Z -        let remaining_peers: Vec<_> = all_peers.iter()
2025-11-09T23:42:54.7033609Z +        let remaining_peers: Vec<_> = all_peers
2025-11-09T23:42:54.7033690Z +            .iter()
2025-11-09T23:42:54.7033811Z              .filter(|addr| !reliable_peers.contains(addr))
2025-11-09T23:42:54.7033890Z              .collect();
2025-11-09T23:42:54.7033964Z          drop(pm);
2025-11-09T23:42:54.7034217Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1451:
2025-11-09T23:42:54.7034407Z -        
2025-11-09T23:42:54.7034478Z +
2025-11-09T23:42:54.7034573Z          for addr in remaining_peers {
2025-11-09T23:42:54.7034772Z -            if let Err(e) = self.send_to_peer_by_transport(addr.clone(), message.clone()).await {
2025-11-09T23:42:54.7034855Z +            if let Err(e) = self
2025-11-09T23:42:54.7034997Z +                .send_to_peer_by_transport(addr.clone(), message.clone())
2025-11-09T23:42:54.7035073Z +                .await
2025-11-09T23:42:54.7035272Z +            {
2025-11-09T23:42:54.7035394Z                  warn!("Failed to send to peer {:?}: {}", addr, e);
2025-11-09T23:42:54.7035470Z              }
2025-11-09T23:42:54.7035540Z          }
2025-11-09T23:42:54.7035786Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1457:
2025-11-09T23:42:54.7035861Z -        
2025-11-09T23:42:54.7035929Z +
2025-11-09T23:42:54.7036005Z          Ok(())
2025-11-09T23:42:54.7036074Z      }
2025-11-09T23:42:54.7036147Z  
2025-11-09T23:42:54.7036396Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1464:
2025-11-09T23:42:54.7036513Z          let pm = self.peer_manager.lock().unwrap();
2025-11-09T23:42:54.7036624Z          let best_peers = pm.select_best_peers(1);
2025-11-09T23:42:54.7036698Z          drop(pm);
2025-11-09T23:42:54.7036767Z -        
2025-11-09T23:42:54.7036834Z +
2025-11-09T23:42:54.7036943Z          if let Some(addr) = best_peers.first() {
2025-11-09T23:42:54.7037104Z -            self.send_to_peer_by_transport(addr.clone(), message).await?;
2025-11-09T23:42:54.7037241Z +            self.send_to_peer_by_transport(addr.clone(), message)
2025-11-09T23:42:54.7037321Z +                .await?;
2025-11-09T23:42:54.7037404Z              Ok(addr.clone())
2025-11-09T23:42:54.7037477Z          } else {
2025-11-09T23:42:54.7037594Z              Err(anyhow::anyhow!("No peers available"))
2025-11-09T23:42:54.7037979Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1479:
2025-11-09T23:42:54.7038090Z          let pm = self.peer_manager.lock().unwrap();
2025-11-09T23:42:54.7038214Z          let reliable_peers = pm.select_reliable_peers();
2025-11-09T23:42:54.7038296Z          drop(pm);
2025-11-09T23:42:54.7038365Z -        
2025-11-09T23:42:54.7038433Z +
2025-11-09T23:42:54.7038526Z          if reliable_peers.is_empty() {
2025-11-09T23:42:54.7038687Z              return Err(anyhow::anyhow!("No reliable peers available"));
2025-11-09T23:42:54.7038762Z          }
2025-11-09T23:42:54.7039011Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1486:
2025-11-09T23:42:54.7039086Z -        
2025-11-09T23:42:54.7039154Z +
2025-11-09T23:42:54.7039246Z          // Select best reliable peer
2025-11-09T23:42:54.7039359Z          let pm = self.peer_manager.lock().unwrap();
2025-11-09T23:42:54.7039466Z -        let best_reliable = reliable_peers.iter()
2025-11-09T23:42:54.7039550Z -            .max_by(|a, b| {
2025-11-09T23:42:54.7039743Z -                let score_a = pm.get_peer(a).map(|p| p.quality_score()).unwrap_or(0.0);
2025-11-09T23:42:54.7039916Z -                let score_b = pm.get_peer(b).map(|p| p.quality_score()).unwrap_or(0.0);
2025-11-09T23:42:54.7040098Z -                score_a.partial_cmp(&score_b).unwrap_or(std::cmp::Ordering::Equal)
2025-11-09T23:42:54.7040170Z -            });
2025-11-09T23:42:54.7040321Z +        let best_reliable = reliable_peers.iter().max_by(|a, b| {
2025-11-09T23:42:54.7040495Z +            let score_a = pm.get_peer(a).map(|p| p.quality_score()).unwrap_or(0.0);
2025-11-09T23:42:54.7040655Z +            let score_b = pm.get_peer(b).map(|p| p.quality_score()).unwrap_or(0.0);
2025-11-09T23:42:54.7040734Z +            score_a
2025-11-09T23:42:54.7040826Z +                .partial_cmp(&score_b)
2025-11-09T23:42:54.7040936Z +                .unwrap_or(std::cmp::Ordering::Equal)
2025-11-09T23:42:54.7041012Z +        });
2025-11-09T23:42:54.7041094Z          drop(pm);
2025-11-09T23:42:54.7041164Z -        
2025-11-09T23:42:54.7041232Z +
2025-11-09T23:42:54.7041336Z          if let Some(addr) = best_reliable {
2025-11-09T23:42:54.7041494Z -            self.send_to_peer_by_transport(addr.clone(), message).await?;
2025-11-09T23:42:54.7041630Z +            self.send_to_peer_by_transport(addr.clone(), message)
2025-11-09T23:42:54.7041706Z +                .await?;
2025-11-09T23:42:54.7041794Z              Ok(addr.clone())
2025-11-09T23:42:54.7041865Z          } else {
2025-11-09T23:42:54.7042104Z              Err(anyhow::anyhow!("No reliable peers available"))
2025-11-09T23:42:54.7042371Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1509:
2025-11-09T23:42:54.7042458Z          let transport_addr = {
2025-11-09T23:42:54.7042575Z              let pm = self.peer_manager.lock().unwrap();
2025-11-09T23:42:54.7042683Z              pm.find_transport_addr_by_socket(addr)
2025-11-09T23:42:54.7042773Z -                .or_else(|| {
2025-11-09T23:42:54.7042936Z -                    self.socket_to_transport.lock().unwrap().get(&addr).cloned()
2025-11-09T23:42:54.7043008Z -                })
2025-11-09T23:42:54.7043193Z +                .or_else(|| self.socket_to_transport.lock().unwrap().get(&addr).cloned())
2025-11-09T23:42:54.7043264Z          };
2025-11-09T23:42:54.7043333Z -        
2025-11-09T23:42:54.7043405Z +
2025-11-09T23:42:54.7043521Z          if let Some(transport_addr) = transport_addr {
2025-11-09T23:42:54.7043676Z -            self.send_to_peer_by_transport(transport_addr, message).await
2025-11-09T23:42:54.7043821Z +            self.send_to_peer_by_transport(transport_addr, message)
2025-11-09T23:42:54.7043900Z +                .await
2025-11-09T23:42:54.7043971Z          } else {
2025-11-09T23:42:54.7044098Z              // Fallback: try TCP (for backward compatibility)
2025-11-09T23:42:54.7044429Z -            self.send_to_peer_by_transport(TransportAddr::Tcp(addr), message).await
2025-11-09T23:42:54.7044737Z +            self.send_to_peer_by_transport(TransportAddr::Tcp(addr), message)
2025-11-09T23:42:54.7044814Z +                .await
2025-11-09T23:42:54.7044889Z          }
2025-11-09T23:42:54.7044958Z      }
2025-11-09T23:42:54.7045026Z -    
2025-11-09T23:42:54.7045093Z +
2025-11-09T23:42:54.7045302Z      /// Send a message to a specific peer (by TransportAddr - supports all transports)
2025-11-09T23:42:54.7045561Z -    pub async fn send_to_peer_by_transport(&self, addr: TransportAddr, message: Vec<u8>) -> Result<()> {
2025-11-09T23:42:54.7045669Z +    pub async fn send_to_peer_by_transport(
2025-11-09T23:42:54.7045746Z +        &self,
2025-11-09T23:42:54.7045832Z +        addr: TransportAddr,
2025-11-09T23:42:54.7045913Z +        message: Vec<u8>,
2025-11-09T23:42:54.7045990Z +    ) -> Result<()> {
2025-11-09T23:42:54.7046093Z          let message_len = message.len();
2025-11-09T23:42:54.7046175Z          // Track bytes sent
2025-11-09T23:42:54.7046283Z          self.track_bytes_sent(message_len as u64);
2025-11-09T23:42:54.7046549Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1530:
2025-11-09T23:42:54.7046619Z -        
2025-11-09T23:42:54.7046688Z +
2025-11-09T23:42:54.7046806Z          let mut pm = self.peer_manager.lock().unwrap();
2025-11-09T23:42:54.7046923Z          if let Some(peer) = pm.get_peer_mut(&addr) {
2025-11-09T23:42:54.7047026Z              peer.send_message(message).await?;
2025-11-09T23:42:54.7047275Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1539:
2025-11-09T23:42:54.7047352Z      }
2025-11-09T23:42:54.7047420Z  
2025-11-09T23:42:54.7047516Z      /// Connect to a peer at the given address
2025-11-09T23:42:54.7047584Z -    /// 
2025-11-09T23:42:54.7047661Z +    ///
2025-11-09T23:42:54.7047859Z      /// Attempts to connect using available transports with graceful degradation:
2025-11-09T23:42:54.7048015Z      /// 1. Tries preferred transport (based on transport_preference)
2025-11-09T23:42:54.7048147Z      /// 2. Falls back to TCP if preferred transport fails
2025-11-09T23:42:54.7048395Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1547:
2025-11-09T23:42:54.7048565Z      pub async fn connect_to_peer(&self, addr: SocketAddr) -> Result<()> {
2025-11-09T23:42:54.7048670Z          use crate::network::peer::Peer;
2025-11-09T23:42:54.7048790Z          use crate::network::transport::TransportAddr;
2025-11-09T23:42:54.7048859Z -        
2025-11-09T23:42:54.7048926Z +
2025-11-09T23:42:54.7049139Z          // Check DoS protection: connection rate limiting (for outgoing connections too)
2025-11-09T23:42:54.7049376Z          let ip = addr.ip();
2025-11-09T23:42:54.7049508Z          if !self.dos_protection.check_connection(ip).await {
2025-11-09T23:42:54.7049764Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1554:
2025-11-09T23:42:54.7049992Z -            warn!("Connection rate limit exceeded for IP {}, rejecting outgoing connection", ip);
2025-11-09T23:42:54.7050069Z -            
2025-11-09T23:42:54.7050149Z +            warn!(
2025-11-09T23:42:54.7050347Z +                "Connection rate limit exceeded for IP {}, rejecting outgoing connection",
2025-11-09T23:42:54.7050421Z +                ip
2025-11-09T23:42:54.7050495Z +            );
2025-11-09T23:42:54.7050570Z +
2025-11-09T23:42:54.7050664Z              // Check if we should auto-ban
2025-11-09T23:42:54.7050794Z              if self.dos_protection.should_auto_ban(ip).await {
2025-11-09T23:42:54.7050983Z -                warn!("Auto-banning IP {} for repeated connection rate violations", ip);
2025-11-09T23:42:54.7051062Z +                warn!(
2025-11-09T23:42:54.7051221Z +                    "Auto-banning IP {} for repeated connection rate violations",
2025-11-09T23:42:54.7051295Z +                    ip
2025-11-09T23:42:54.7051371Z +                );
2025-11-09T23:42:54.7051451Z                  // Ban the IP
2025-11-09T23:42:54.7051586Z                  let unban_timestamp = std::time::SystemTime::now()
2025-11-09T23:42:54.7051800Z                      .duration_since(std::time::UNIX_EPOCH)
2025-11-09T23:42:54.7053941Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1564:
2025-11-09T23:42:54.7054032Z                      + 3600; // Ban for 1 hour
2025-11-09T23:42:54.7054164Z                  let mut ban_list = self.ban_list.lock().unwrap();
2025-11-09T23:42:54.7054275Z                  ban_list.insert(addr, unban_timestamp);
2025-11-09T23:42:54.7054617Z -                return Err(anyhow::anyhow!("IP {} is banned due to connection rate violations", ip));
2025-11-09T23:42:54.7054727Z +                return Err(anyhow::anyhow!(
2025-11-09T23:42:54.7054855Z +                    "IP {} is banned due to connection rate violations",
2025-11-09T23:42:54.7054937Z +                    ip
2025-11-09T23:42:54.7055010Z +                ));
2025-11-09T23:42:54.7055078Z              }
2025-11-09T23:42:54.7055148Z -            
2025-11-09T23:42:54.7055356Z -            return Err(anyhow::anyhow!("Connection rate limit exceeded for IP {}", ip));
2025-11-09T23:42:54.7055426Z +
2025-11-09T23:42:54.7055521Z +            return Err(anyhow::anyhow!(
2025-11-09T23:42:54.7055645Z +                "Connection rate limit exceeded for IP {}",
2025-11-09T23:42:54.7055716Z +                ip
2025-11-09T23:42:54.7055785Z +            ));
2025-11-09T23:42:54.7055855Z          }
2025-11-09T23:42:54.7055927Z -        
2025-11-09T23:42:54.7055994Z +
2025-11-09T23:42:54.7056115Z          // Eclipse attack prevention: check IP diversity
2025-11-09T23:42:54.7056232Z          if !self.check_eclipse_prevention(ip) {
2025-11-09T23:42:54.7056339Z              let prefix = self.get_ip_prefix(ip);
2025-11-09T23:42:54.7056590Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1576:
2025-11-09T23:42:54.7056887Z              warn!("Eclipse attack prevention: too many connections from IP range {:?}, rejecting connection from {}", 
2025-11-09T23:42:54.7056978Z                    prefix, ip);
2025-11-09T23:42:54.7057235Z -            return Err(anyhow::anyhow!("Eclipse attack prevention: too many connections from IP range"));
2025-11-09T23:42:54.7057328Z +            return Err(anyhow::anyhow!(
2025-11-09T23:42:54.7057503Z +                "Eclipse attack prevention: too many connections from IP range"
2025-11-09T23:42:54.7057575Z +            ));
2025-11-09T23:42:54.7057645Z          }
2025-11-09T23:42:54.7057721Z -        
2025-11-09T23:42:54.7057788Z +
2025-11-09T23:42:54.7057877Z          let mut last_error = None;
2025-11-09T23:42:54.7058080Z -        
2025-11-09T23:42:54.7058153Z +
2025-11-09T23:42:54.7058312Z          // Try transports in preference order with graceful degradation
2025-11-09T23:42:54.7058471Z          let transports_to_try = self.get_transports_for_connection();
2025-11-09T23:42:54.7058545Z -        
2025-11-09T23:42:54.7058616Z +
2025-11-09T23:42:54.7058722Z          for transport_type in transports_to_try {
2025-11-09T23:42:54.7058901Z              match self.try_connect_with_transport(&transport_type, addr).await {
2025-11-09T23:42:54.7059007Z                  Ok((peer, transport_addr)) => {
2025-11-09T23:42:54.7059260Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1591:
2025-11-09T23:42:54.7059388Z                          let mut pm = self.peer_manager.lock().unwrap();
2025-11-09T23:42:54.7059513Z                          pm.add_peer(transport_addr.clone(), peer)?;
2025-11-09T23:42:54.7059587Z                      }
2025-11-09T23:42:54.7059664Z -                    
2025-11-09T23:42:54.7059739Z +
2025-11-09T23:42:54.7059916Z                      // Note: Peer handler is managed by Peer::from_transport_connection
2025-11-09T23:42:54.7060032Z                      // No need to spawn additional handler task
2025-11-09T23:42:54.7060106Z -                    
2025-11-09T23:42:54.7060376Z -                    info!("Successfully connected to {} via {:?} (transport: {:?})", addr, transport_type, transport_addr);
2025-11-09T23:42:54.7060570Z +
2025-11-09T23:42:54.7060650Z +                    info!(
2025-11-09T23:42:54.7060816Z +                        "Successfully connected to {} via {:?} (transport: {:?})",
2025-11-09T23:42:54.7060929Z +                        addr, transport_type, transport_addr
2025-11-09T23:42:54.7061003Z +                    );
2025-11-09T23:42:54.7061092Z                      return Ok(());
2025-11-09T23:42:54.7061165Z                  }
2025-11-09T23:42:54.7061245Z                  Err(e) => {
2025-11-09T23:42:54.7061508Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1602:
2025-11-09T23:42:54.7061690Z -                    warn!("Failed to connect to {} via {:?}: {}", addr, transport_type, e);
2025-11-09T23:42:54.7061767Z +                    warn!(
2025-11-09T23:42:54.7061876Z +                        "Failed to connect to {} via {:?}: {}",
2025-11-09T23:42:54.7061979Z +                        addr, transport_type, e
2025-11-09T23:42:54.7062057Z +                    );
2025-11-09T23:42:54.7062148Z                      last_error = Some(e);
2025-11-09T23:42:54.7062252Z                      // Continue to next transport
2025-11-09T23:42:54.7062323Z                  }
2025-11-09T23:42:54.7062574Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1606:
2025-11-09T23:42:54.7062646Z              }
2025-11-09T23:42:54.7062723Z          }
2025-11-09T23:42:54.7062792Z -        
2025-11-09T23:42:54.7062862Z +
2025-11-09T23:42:54.7062959Z          // All transports failed
2025-11-09T23:42:54.7063175Z          Err(last_error.unwrap_or_else(|| anyhow::anyhow!("All transport attempts failed")))
2025-11-09T23:42:54.7063255Z      }
2025-11-09T23:42:54.7063682Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1612:
2025-11-09T23:42:54.7063783Z -    
2025-11-09T23:42:54.7063854Z +
2025-11-09T23:42:54.7063996Z      /// Helper: Get list of transports to try for a connection
2025-11-09T23:42:54.7066245Z      fn get_transports_for_connection(&self) -> Vec<crate::network::transport::TransportType> {
2025-11-09T23:42:54.7066348Z          let mut transports = Vec::new();
2025-11-09T23:42:54.7066596Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1616:
2025-11-09T23:42:54.7066671Z -        
2025-11-09T23:42:54.7066739Z +
2025-11-09T23:42:54.7066843Z          // Add transports in preference order
2025-11-09T23:42:54.7066958Z          if self.transport_preference.allows_tcp() {
2025-11-09T23:42:54.7067293Z              transports.push(crate::network::transport::TransportType::Tcp);
2025-11-09T23:42:54.7067542Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1620:
2025-11-09T23:42:54.7067615Z          }
2025-11-09T23:42:54.7067690Z -        
2025-11-09T23:42:54.7067759Z +
2025-11-09T23:42:54.7067846Z          #[cfg(feature = "quinn")]
2025-11-09T23:42:54.7067963Z          if self.transport_preference.allows_quinn() {
2025-11-09T23:42:54.7068093Z              if let Some(ref _quinn) = self.quinn_transport {
2025-11-09T23:42:54.7068336Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1625:
2025-11-09T23:42:54.7068518Z                  transports.push(crate::network::transport::TransportType::Quinn);
2025-11-09T23:42:54.7068595Z              }
2025-11-09T23:42:54.7068672Z          }
2025-11-09T23:42:54.7068748Z -        
2025-11-09T23:42:54.7068816Z +
2025-11-09T23:42:54.7068903Z          #[cfg(feature = "iroh")]
2025-11-09T23:42:54.7069031Z          if self.transport_preference.allows_iroh() {
2025-11-09T23:42:54.7069151Z              if let Some(ref _iroh) = self.iroh_transport {
2025-11-09T23:42:54.7069396Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1632:
2025-11-09T23:42:54.7074022Z                  transports.push(crate::network::transport::TransportType::Iroh);
2025-11-09T23:42:54.7074132Z              }
2025-11-09T23:42:54.7074559Z          }
2025-11-09T23:42:54.7074635Z -        
2025-11-09T23:42:54.7074707Z +
2025-11-09T23:42:54.7074859Z          // Always try TCP as fallback if not already in list
2025-11-09T23:42:54.7075129Z -        if !transports.iter().any(|t| matches!(t, crate::network::transport::TransportType::Tcp)) {
2025-11-09T23:42:54.7075214Z +        if !transports
2025-11-09T23:42:54.7075291Z +            .iter()
2025-11-09T23:42:54.7075478Z +            .any(|t| matches!(t, crate::network::transport::TransportType::Tcp))
2025-11-09T23:42:54.7075553Z +        {
2025-11-09T23:42:54.7075749Z              transports.push(crate::network::transport::TransportType::Tcp);
2025-11-09T23:42:54.7075820Z          }
2025-11-09T23:42:54.7075899Z -        
2025-11-09T23:42:54.7075968Z +
2025-11-09T23:42:54.7076044Z          transports
2025-11-09T23:42:54.7076120Z      }
2025-11-09T23:42:54.7076190Z -    
2025-11-09T23:42:54.7076258Z +
2025-11-09T23:42:54.7076390Z      /// Helper: Try connecting with a specific transport
2025-11-09T23:42:54.7076870Z -    async fn try_connect_with_transport(&self, transport_type: &crate::network::transport::TransportType, addr: SocketAddr) -> Result<(peer::Peer, TransportAddr)> {
2025-11-09T23:42:54.7076996Z -        use crate::network::transport::TransportAddr;
2025-11-09T23:42:54.7077098Z +    async fn try_connect_with_transport(
2025-11-09T23:42:54.7077177Z +        &self,
2025-11-09T23:42:54.7077338Z +        transport_type: &crate::network::transport::TransportType,
2025-11-09T23:42:54.7077425Z +        addr: SocketAddr,
2025-11-09T23:42:54.7077550Z +    ) -> Result<(peer::Peer, TransportAddr)> {
2025-11-09T23:42:54.7077650Z          use crate::network::peer::Peer;
2025-11-09T23:42:54.7077722Z -        
2025-11-09T23:42:54.7077845Z +        use crate::network::transport::TransportAddr;
2025-11-09T23:42:54.7077922Z +
2025-11-09T23:42:54.7078013Z          match transport_type {
2025-11-09T23:42:54.7078150Z              crate::network::transport::TransportType::Tcp => {
2025-11-09T23:42:54.7078295Z                  // Use TcpTransport to create connection properly
2025-11-09T23:42:54.7078568Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1684:
2025-11-09T23:42:54.7078707Z              crate::network::transport::TransportType::Iroh => {
2025-11-09T23:42:54.7078828Z                  // Iroh requires public key, not SocketAddr
2025-11-09T23:42:54.7079014Z                  // For now, return error - would need peer discovery or address resolution
2025-11-09T23:42:54.7079209Z -                Err(anyhow::anyhow!("Iroh transport requires public key, not SocketAddr"))
2025-11-09T23:42:54.7079437Z +                Err(anyhow::anyhow!(
2025-11-09T23:42:54.7079586Z +                    "Iroh transport requires public key, not SocketAddr"
2025-11-09T23:42:54.7079659Z +                ))
2025-11-09T23:42:54.7079732Z              }
2025-11-09T23:42:54.7079807Z          }
2025-11-09T23:42:54.7079878Z      }
2025-11-09T23:42:54.7080136Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1691:
2025-11-09T23:42:54.7080209Z -    
2025-11-09T23:42:54.7080286Z +
2025-11-09T23:42:54.7080394Z      /// Send ping message to all connected peers
2025-11-09T23:42:54.7080522Z      pub async fn ping_all_peers(&self) -> Result<()> {
2025-11-09T23:42:54.7080743Z -        use crate::network::protocol::{ProtocolMessage, ProtocolParser, PingMessage};
2025-11-09T23:42:54.7080948Z +        use crate::network::protocol::{PingMessage, ProtocolMessage, ProtocolParser};
2025-11-09T23:42:54.7081052Z          use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:42:54.7081134Z -        
2025-11-09T23:42:54.7081204Z +
2025-11-09T23:42:54.7081295Z          // Generate nonce for ping
2025-11-09T23:42:54.7081391Z          let nonce = SystemTime::now()
2025-11-09T23:42:54.7081496Z              .duration_since(UNIX_EPOCH)
2025-11-09T23:42:54.7081755Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1700:
2025-11-09T23:42:54.7081955Z              .unwrap()
2025-11-09T23:42:54.7082046Z              .as_nanos() as u64;
2025-11-09T23:42:54.7082118Z -        
2025-11-09T23:42:54.7082186Z +
2025-11-09T23:42:54.7082348Z          let ping_msg = ProtocolMessage::Ping(PingMessage { nonce });
2025-11-09T23:42:54.7082512Z          let wire_msg = ProtocolParser::serialize_message(&ping_msg)?;
2025-11-09T23:42:54.7082582Z -        
2025-11-09T23:42:54.7082651Z +
2025-11-09T23:42:54.7082825Z          let peer_addrs = self.peer_manager.lock().unwrap().peer_addresses();
2025-11-09T23:42:54.7082916Z          for addr in peer_addrs {
2025-11-09T23:42:54.7083161Z              // Convert TransportAddr to SocketAddr for send_to_peer, or use send_to_peer_by_transport
2025-11-09T23:42:54.7083423Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1726:
2025-11-09T23:42:54.7083496Z                  }
2025-11-09T23:42:54.7083568Z              }
2025-11-09T23:42:54.7083638Z          }
2025-11-09T23:42:54.7083717Z -        
2025-11-09T23:42:54.7083784Z +
2025-11-09T23:42:54.7083856Z          Ok(())
2025-11-09T23:42:54.7083930Z      }
2025-11-09T23:42:54.7083999Z  
2025-11-09T23:42:54.7084245Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1761:
2025-11-09T23:42:54.7084562Z          // Track message queue size manually (unbounded channel doesn't have len())
2025-11-09T23:42:54.7084664Z          let mut message_count = 0u64;
2025-11-09T23:42:54.7084816Z          let mut last_metrics_update = std::time::SystemTime::now();
2025-11-09T23:42:54.7084891Z -        
2025-11-09T23:42:54.7084969Z +
2025-11-09T23:42:54.7085100Z          while let Some(message) = self.peer_rx.recv().await {
2025-11-09T23:42:54.7085187Z              message_count += 1;
2025-11-09T23:42:54.7085259Z -            
2025-11-09T23:42:54.7085332Z +
2025-11-09T23:42:54.7085497Z              // Update metrics periodically (every 100 messages or 10 seconds)
2025-11-09T23:42:54.7085608Z              let now = std::time::SystemTime::now();
2025-11-09T23:42:54.7085735Z -            let should_update = message_count % 100 == 0 
2025-11-09T23:42:54.7085848Z +            let should_update = message_count % 100 == 0
2025-11-09T23:42:54.7086019Z                  || now.duration_since(last_metrics_update).unwrap().as_secs() >= 10;
2025-11-09T23:42:54.7086094Z -            
2025-11-09T23:42:54.7086162Z +
2025-11-09T23:42:54.7086252Z              if should_update {
2025-11-09T23:42:54.7086372Z                  let pm = self.peer_manager.lock().unwrap();
2025-11-09T23:42:54.7086488Z                  let active_connections = pm.peer_count();
2025-11-09T23:42:54.7086937Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1776:
2025-11-09T23:42:54.7087089Z                  let bytes_received = *self.bytes_received.lock().unwrap();
2025-11-09T23:42:54.7087221Z                  let bytes_sent = *self.bytes_sent.lock().unwrap();
2025-11-09T23:42:54.7087295Z -                
2025-11-09T23:42:54.7087370Z +
2025-11-09T23:42:54.7087535Z                  // Approximate queue size (messages processed since last check)
2025-11-09T23:42:54.7087648Z                  let queue_size = message_count as usize;
2025-11-09T23:42:54.7087720Z -                
2025-11-09T23:42:54.7087787Z +
2025-11-09T23:42:54.7087893Z                  // Check message queue size limit
2025-11-09T23:42:54.7088068Z -                if !self.dos_protection.check_message_queue_size(queue_size).await {
2025-11-09T23:42:54.7088327Z -                    warn!("Message queue size limit exceeded (processed {} messages), potential DoS", queue_size);
2025-11-09T23:42:54.7088414Z +                if !self
2025-11-09T23:42:54.7088502Z +                    .dos_protection
2025-11-09T23:42:54.7088605Z +                    .check_message_queue_size(queue_size)
2025-11-09T23:42:54.7088682Z +                    .await
2025-11-09T23:42:54.7088757Z +                {
2025-11-09T23:42:54.7088869Z +                    warn!(
2025-11-09T23:42:54.7089232Z +                        "Message queue size limit exceeded (processed {} messages), potential DoS",
2025-11-09T23:42:54.7089319Z +                        queue_size
2025-11-09T23:42:54.7089394Z +                    );
2025-11-09T23:42:54.7089495Z                      // Optionally detect DoS attack
2025-11-09T23:42:54.7089637Z                      if self.dos_protection.detect_dos_attack().await {
2025-11-09T23:42:54.7089844Z                          warn!("DoS attack detected - message queue and connections at high levels");
2025-11-09T23:42:54.7090104Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1790:
2025-11-09T23:42:54.7090226Z                      // Reset counter to prevent false positives
2025-11-09T23:42:54.7090322Z                      message_count = 0;
2025-11-09T23:42:54.7090392Z                  }
2025-11-09T23:42:54.7090462Z -                
2025-11-09T23:42:54.7090575Z -                self.dos_protection.update_metrics(
2025-11-09T23:42:54.7090669Z -                    active_connections,
2025-11-09T23:42:54.7090751Z -                    queue_size,
2025-11-09T23:42:54.7090834Z -                    bytes_received,
2025-11-09T23:42:54.7090919Z -                    bytes_sent,
2025-11-09T23:42:54.7090996Z -                ).await;
2025-11-09T23:42:54.7091067Z -                
2025-11-09T23:42:54.7091142Z +
2025-11-09T23:42:54.7091226Z +                self.dos_protection
2025-11-09T23:42:54.7091433Z +                    .update_metrics(active_connections, queue_size, bytes_received, bytes_sent)
2025-11-09T23:42:54.7091517Z +                    .await;
2025-11-09T23:42:54.7091585Z +
2025-11-09T23:42:54.7091680Z                  last_metrics_update = now;
2025-11-09T23:42:54.7091788Z                  message_count = 0; // Reset after update
2025-11-09T23:42:54.7091865Z              }
2025-11-09T23:42:54.7092120Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1811:
2025-11-09T23:42:54.7092247Z                      let mut pm = self.peer_manager.lock().unwrap();
2025-11-09T23:42:54.7092368Z                      // Remove peer directly using TransportAddr
2025-11-09T23:42:54.7092462Z                      pm.remove_peer(&addr);
2025-11-09T23:42:54.7092536Z -                    
2025-11-09T23:42:54.7092605Z +
2025-11-09T23:42:54.7092775Z                      // Clean up per-IP connection count (only for TCP/Quinn, not Iroh)
2025-11-09T23:42:54.7092874Z                      if let Some(ip) = match &addr {
2025-11-09T23:42:54.7093003Z                          TransportAddr::Tcp(sock) => Some(sock.ip()),
2025-11-09T23:42:54.7093362Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1828:
2025-11-09T23:42:54.7093443Z                              }
2025-11-09T23:42:54.7093519Z                          }
2025-11-09T23:42:54.7093595Z                      }
2025-11-09T23:42:54.7093666Z -                    
2025-11-09T23:42:54.7093736Z +
2025-11-09T23:42:54.7093923Z                      // Clean up rate limiter (use SocketAddr for TCP/Quinn, or a key for Iroh)
2025-11-09T23:42:54.7094005Z                      {
2025-11-09T23:42:54.7094152Z                          let mut rates = self.peer_message_rates.lock().unwrap();
2025-11-09T23:42:54.7094534Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1844:
2025-11-09T23:42:54.7094645Z                              rates.remove(&sock_addr);
2025-11-09T23:42:54.7094721Z                          }
2025-11-09T23:42:54.7094792Z                      }
2025-11-09T23:42:54.7094864Z -                    
2025-11-09T23:42:54.7094945Z +
2025-11-09T23:42:54.7095064Z                      // Clean up eclipse attack prevention tracking
2025-11-09T23:42:54.7095161Z                      if let Some(ip) = match &addr {
2025-11-09T23:42:54.7095292Z                          TransportAddr::Tcp(sock) => Some(sock.ip()),
2025-11-09T23:42:54.7095535Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1967:
2025-11-09T23:42:54.7095739Z                      {
2025-11-09T23:42:54.7095873Z                          let mut pm = self.peer_manager.lock().unwrap();
2025-11-09T23:42:54.7096032Z                          // Try to find peer by SocketAddr (TCP or Quinn, or Iroh mapping)
2025-11-09T23:42:54.7096204Z -                        let transport_addr = pm.find_transport_addr_by_socket(peer_addr)
2025-11-09T23:42:54.7096294Z -                            .or_else(|| {
2025-11-09T23:42:54.7096392Z +                        let transport_addr =
2025-11-09T23:42:54.7096540Z +                            pm.find_transport_addr_by_socket(peer_addr).or_else(|| {
2025-11-09T23:42:54.7096640Z                                  // Check Iroh mapping
2025-11-09T23:42:54.7096826Z -                                self.socket_to_transport.lock().unwrap().get(&peer_addr).cloned()
2025-11-09T23:42:54.7096928Z +                                self.socket_to_transport
2025-11-09T23:42:54.7097017Z +                                    .lock()
2025-11-09T23:42:54.7097112Z +                                    .unwrap()
2025-11-09T23:42:54.7097206Z +                                    .get(&peer_addr)
2025-11-09T23:42:54.7097289Z +                                    .cloned()
2025-11-09T23:42:54.7097368Z                              });
2025-11-09T23:42:54.7097497Z                          if let Some(transport_addr) = transport_addr {
2025-11-09T23:42:54.7097640Z                              if let Some(peer) = pm.get_peer_mut(&transport_addr) {
2025-11-09T23:42:54.7097891Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1978:
2025-11-09T23:42:54.7097978Z                              }
2025-11-09T23:42:54.7098054Z                          }
2025-11-09T23:42:54.7098124Z                      }
2025-11-09T23:42:54.7098199Z -                    
2025-11-09T23:42:54.7098268Z +
2025-11-09T23:42:54.7098383Z                      // Check rate limiting before processing
2025-11-09T23:42:54.7098529Z                      let mut rates = self.peer_message_rates.lock().unwrap();
2025-11-09T23:42:54.7098692Z                      let rate_limiter = rates.entry(peer_addr).or_insert_with(|| {
2025-11-09T23:42:54.7098945Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1985:
2025-11-09T23:42:54.7099055Z                          // Default: 100 burst, 10 messages/second
2025-11-09T23:42:54.7099167Z                          PeerRateLimiter::new(100, 10)
2025-11-09T23:42:54.7099241Z                      });
2025-11-09T23:42:54.7099314Z -                    
2025-11-09T23:42:54.7099513Z +
2025-11-09T23:42:54.7099625Z                      if !rate_limiter.check_and_consume() {
2025-11-09T23:42:54.7099813Z -                        warn!("Rate limit exceeded for peer {}, dropping message", peer_addr);
2025-11-09T23:42:54.7099891Z +                        warn!(
2025-11-09T23:42:54.7100032Z +                            "Rate limit exceeded for peer {}, dropping message",
2025-11-09T23:42:54.7100121Z +                            peer_addr
2025-11-09T23:42:54.7100196Z +                        );
2025-11-09T23:42:54.7100355Z                          // Optionally ban peer after repeated rate limit violations
2025-11-09T23:42:54.7100457Z                          // For now, just drop the message
2025-11-09T23:42:54.7100539Z                          continue;
2025-11-09T23:42:54.7100799Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1994:
2025-11-09T23:42:54.7100871Z                      }
2025-11-09T23:42:54.7100954Z                      drop(rates);
2025-11-09T23:42:54.7101033Z -                    
2025-11-09T23:42:54.7101106Z +
2025-11-09T23:42:54.7101307Z                      // Check if this is a response to a pending request (UTXOSet or FilteredBlock)
2025-11-09T23:42:54.7101490Z                      // Extract request_id from message and route to correct pending request
2025-11-09T23:42:54.7101646Z                      if let Ok(parsed) = ProtocolParser::parse_message(&data) {
2025-11-09T23:42:54.7101996Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2002:
2025-11-09T23:42:54.7102170Z                              ProtocolMessage::FilteredBlock(msg) => Some(msg.request_id),
2025-11-09T23:42:54.7102257Z                              _ => None,
2025-11-09T23:42:54.7102333Z                          };
2025-11-09T23:42:54.7102406Z -                        
2025-11-09T23:42:54.7102475Z +
2025-11-09T23:42:54.7102594Z                          if let Some(request_id) = request_id_opt {
2025-11-09T23:42:54.7102712Z                              // Route to pending request by request_id
2025-11-09T23:42:54.7102862Z                              let mut pending = self.pending_requests.lock().unwrap();
2025-11-09T23:42:54.7103116Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2015:
2025-11-09T23:42:54.7103192Z                              }
2025-11-09T23:42:54.7103266Z                          }
2025-11-09T23:42:54.7103345Z                      }
2025-11-09T23:42:54.7103418Z -                    
2025-11-09T23:42:54.7103488Z +
2025-11-09T23:42:54.7103595Z                      // Process through protocol layer
2025-11-09T23:42:54.7103766Z                      if let Err(e) = self.handle_incoming_wire_tcp(peer_addr, data).await {
2025-11-09T23:42:54.7103919Z                          warn!("Failed to process message from {}: {}", peer_addr, e);
2025-11-09T23:42:54.7104164Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2034:
2025-11-09T23:42:54.7104415Z      /// 3. Creates NodeChainAccess from storage modules
2025-11-09T23:42:54.7104570Z      /// 4. Calls bllvm_protocol::network::process_network_message()
2025-11-09T23:42:54.7104760Z      /// 5. Converts NetworkResponse back to wire format and enqueues for sending
2025-11-09T23:42:54.7105025Z -    pub async fn handle_incoming_wire_tcp(&self, peer_addr: SocketAddr, data: Vec<u8>) -> Result<()> {
2025-11-09T23:42:54.7105131Z +    pub async fn handle_incoming_wire_tcp(
2025-11-09T23:42:54.7105203Z +        &self,
2025-11-09T23:42:54.7105291Z +        peer_addr: SocketAddr,
2025-11-09T23:42:54.7105372Z +        data: Vec<u8>,
2025-11-09T23:42:54.7105451Z +    ) -> Result<()> {
2025-11-09T23:42:54.7105537Z          // Track bytes received
2025-11-09T23:42:54.7105657Z          self.track_bytes_received(data.len() as u64);
2025-11-09T23:42:54.7105729Z -        
2025-11-09T23:42:54.7105796Z +
2025-11-09T23:42:54.7105883Z          // Check if peer is banned
2025-11-09T23:42:54.7106115Z          if self.is_banned(peer_addr) {
2025-11-09T23:42:54.7106266Z              warn!("Rejecting message from banned peer: {}", peer_addr);
2025-11-09T23:42:54.7106522Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2044:
2025-11-09T23:42:54.7108097Z              return Ok(()); // Silently drop messages from banned peers
2025-11-09T23:42:54.7108168Z          }
2025-11-09T23:42:54.7108308Z          let parsed = ProtocolParser::parse_message(&data)?;
2025-11-09T23:42:54.7108383Z -        
2025-11-09T23:42:54.7108454Z +
2025-11-09T23:42:54.7108604Z          // Handle special cases that don't go through protocol layer
2025-11-09T23:42:54.7108684Z          match parsed {
2025-11-09T23:42:54.7108766Z              // BIP331
2025-11-09T23:42:54.7109014Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2097:
2025-11-09T23:42:54.7109124Z                  // Continue to protocol layer processing
2025-11-09T23:42:54.7109203Z              }
2025-11-09T23:42:54.7109277Z          }
2025-11-09T23:42:54.7109346Z -        
2025-11-09T23:42:54.7109414Z +
2025-11-09T23:42:54.7109566Z          // Process with protocol layer if dependencies are available
2025-11-09T23:42:54.7109772Z -        if let (Some(ref protocol_engine), Some(ref storage), Some(ref mempool_manager)) = 
2025-11-09T23:42:54.7110003Z -            (self.protocol_engine.as_ref(), self.storage.as_ref(), self.mempool_manager.as_ref()) {
2025-11-09T23:42:54.7110225Z -            
2025-11-09T23:42:54.7110426Z +        if let (Some(ref protocol_engine), Some(ref storage), Some(ref mempool_manager)) = (
2025-11-09T23:42:54.7110523Z +            self.protocol_engine.as_ref(),
2025-11-09T23:42:54.7110610Z +            self.storage.as_ref(),
2025-11-09T23:42:54.7110710Z +            self.mempool_manager.as_ref(),
2025-11-09T23:42:54.7110778Z +        ) {
2025-11-09T23:42:54.7110971Z              // Convert ProtocolMessage to bllvm_protocol::network::NetworkMessage
2025-11-09T23:42:54.7111124Z              use crate::network::protocol_adapter::ProtocolAdapter;
2025-11-09T23:42:54.7111333Z              let protocol_msg = ProtocolAdapter::protocol_to_consensus_message(&parsed)?;
2025-11-09T23:42:54.7111584Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2108:
2025-11-09T23:42:54.7111657Z -            
2025-11-09T23:42:54.7111725Z +
2025-11-09T23:42:54.7111811Z              // Get or create PeerState
2025-11-09T23:42:54.7111955Z              let mut peer_states = self.peer_states.lock().unwrap();
2025-11-09T23:42:54.7112073Z -            let peer_state = peer_states.entry(peer_addr)
2025-11-09T23:42:54.7112168Z +            let peer_state = peer_states
2025-11-09T23:42:54.7112252Z +                .entry(peer_addr)
2025-11-09T23:42:54.7112416Z                  .or_insert_with(|| bllvm_protocol::network::PeerState::new());
2025-11-09T23:42:54.7112484Z -            
2025-11-09T23:42:54.7112551Z +
2025-11-09T23:42:54.7112647Z              // Create NodeChainAccess
2025-11-09T23:42:54.7112787Z              use crate::network::chain_access::NodeChainAccess;
2025-11-09T23:42:54.7112903Z              let chain_access = NodeChainAccess::new(
2025-11-09T23:42:54.7113151Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2118:
2025-11-09T23:42:54.7113249Z                  storage.transactions(),
2025-11-09T23:42:54.7113356Z                  Arc::clone(mempool_manager),
2025-11-09T23:42:54.7113429Z              );
2025-11-09T23:42:54.7113497Z -            
2025-11-09T23:42:54.7113564Z +
2025-11-09T23:42:54.7113651Z              // Get UTXO set and height
2025-11-09T23:42:54.7113989Z -            let utxo_set = storage.utxos().get_all_utxos()
2025-11-09T23:42:54.7114076Z +            let utxo_set = storage
2025-11-09T23:42:54.7114156Z +                .utxos()
2025-11-09T23:42:54.7114238Z +                .get_all_utxos()
2025-11-09T23:42:54.7114525Z                  .map_err(|e| anyhow::anyhow!("Failed to get UTXO set: {}", e))?;
2025-11-09T23:42:54.7114783Z -            let height = storage.chain().get_height()
2025-11-09T23:42:54.7114867Z +            let height = storage
2025-11-09T23:42:54.7114942Z +                .chain()
2025-11-09T23:42:54.7115019Z +                .get_height()
2025-11-09T23:42:54.7116567Z                  .map_err(|e| anyhow::anyhow!("Failed to get height: {}", e))?
2025-11-09T23:42:54.7116648Z                  .unwrap_or(0);
2025-11-09T23:42:54.7116722Z -            
2025-11-09T23:42:54.7116794Z +
2025-11-09T23:42:54.7116902Z              // Process message with protocol layer
2025-11-09T23:42:54.7117100Z              use bllvm_protocol::network::{process_network_message, ChainStateAccess};
2025-11-09T23:42:54.7117200Z              match process_network_message(
2025-11-09T23:42:54.7117465Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2140:
2025-11-09T23:42:54.7117627Z                      // Convert response to wire format and send via transport layer
2025-11-09T23:42:54.7117767Z                      use crate::network::message_bridge::MessageBridge;
2025-11-09T23:42:54.7117901Z                      use crate::network::transport::TransportType;
2025-11-09T23:42:54.7118169Z -                    if let Ok(wire_messages) = MessageBridge::extract_send_messages(&response, TransportType::Tcp) {
2025-11-09T23:42:54.7118269Z +                    if let Ok(wire_messages) =
2025-11-09T23:42:54.7118463Z +                        MessageBridge::extract_send_messages(&response, TransportType::Tcp)
2025-11-09T23:42:54.7118671Z +                    {
2025-11-09T23:42:54.7118780Z                          for wire_msg in wire_messages {
2025-11-09T23:42:54.7118939Z                              if let Err(e) = self.send_to_peer(peer_addr, wire_msg).await {
2025-11-09T23:42:54.7119111Z                                  warn!("Failed to send protocol response to {}: {}", peer_addr, e);
2025-11-09T23:42:54.7119366Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2158:
2025-11-09T23:42:54.7119500Z              // Dependencies not set - fall back to old behavior
2025-11-09T23:42:54.7119705Z              debug!("Protocol layer dependencies not set, skipping protocol processing");
2025-11-09T23:42:54.7119776Z          }
2025-11-09T23:42:54.7119845Z -        
2025-11-09T23:42:54.7119918Z +
2025-11-09T23:42:54.7119990Z          Ok(())
2025-11-09T23:42:54.7120058Z      }
2025-11-09T23:42:54.7120133Z  
2025-11-09T23:42:54.7120381Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2360:
2025-11-09T23:42:54.7120508Z          // Handle the request with storage and filter service
2025-11-09T23:42:54.7120645Z          let storage = self.storage.as_ref().map(Arc::clone);
2025-11-09T23:42:54.7120732Z          let response =
2025-11-09T23:42:54.7120989Z -            handle_get_filtered_block(get_filtered_block_msg, storage, Some(&self.filter_service)).await?;
2025-11-09T23:42:54.7121219Z +            handle_get_filtered_block(get_filtered_block_msg, storage, Some(&self.filter_service))
2025-11-09T23:42:54.7121305Z +                .await?;
2025-11-09T23:42:54.7121374Z  
2025-11-09T23:42:54.7121465Z          // Serialize and send response
2025-11-09T23:42:54.7121553Z          let response_wire =
2025-11-09T23:42:54.7121801Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2466:
2025-11-09T23:42:54.7121923Z      /// Handle GetAddr request - return known addresses
2025-11-09T23:42:54.7122104Z      async fn handle_get_addr(&self, peer_addr: SocketAddr) -> Result<()> {
2025-11-09T23:42:54.7122321Z          use crate::network::protocol::{AddrMessage, ProtocolMessage, ProtocolParser};
2025-11-09T23:42:54.7122391Z -        
2025-11-09T23:42:54.7122458Z +
2025-11-09T23:42:54.7122631Z          // Get fresh addresses from database (up to 2500, Bitcoin Core limit)
2025-11-09T23:42:54.7122756Z          let ban_list = self.ban_list.lock().unwrap().clone();
2025-11-09T23:42:54.7122864Z          let connected_peers: Vec<SocketAddr> = {
2025-11-09T23:42:54.7123225Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2473:
2025-11-09T23:42:54.7123339Z              let pm = self.peer_manager.lock().unwrap();
2025-11-09T23:42:54.7123432Z              pm.peer_socket_addresses()
2025-11-09T23:42:54.7123503Z          };
2025-11-09T23:42:54.7123576Z -        
2025-11-09T23:42:54.7123644Z +
2025-11-09T23:42:54.7123724Z          let addresses = {
2025-11-09T23:42:54.7123858Z              let mut db = self.address_database.lock().unwrap();
2025-11-09T23:42:54.7123966Z              let fresh = db.get_fresh_addresses(2500);
2025-11-09T23:42:54.7124213Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2480:
2025-11-09T23:42:54.7124471Z              db.filter_addresses(fresh, &ban_list, &connected_peers)
2025-11-09T23:42:54.7124547Z          };
2025-11-09T23:42:54.7124616Z -        
2025-11-09T23:42:54.7124684Z +
2025-11-09T23:42:54.7124769Z          // Create Addr message
2025-11-09T23:42:54.7124879Z          let addr_msg = AddrMessage { addresses };
2025-11-09T23:42:54.7125002Z          let response = ProtocolMessage::Addr(addr_msg);
2025-11-09T23:42:54.7125250Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2486:
2025-11-09T23:42:54.7125408Z          let wire_msg = ProtocolParser::serialize_message(&response)?;
2025-11-09T23:42:54.7125478Z -        
2025-11-09T23:42:54.7125675Z +
2025-11-09T23:42:54.7125761Z          // Send response
2025-11-09T23:42:54.7125879Z          self.send_to_peer(peer_addr, wire_msg).await?;
2025-11-09T23:42:54.7125951Z          Ok(())
2025-11-09T23:42:54.7126202Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2493:
2025-11-09T23:42:54.7126353Z      /// Handle Addr message - store addresses and optionally relay
2025-11-09T23:42:54.7126562Z      async fn handle_addr(&self, peer_addr: SocketAddr, msg: AddrMessage) -> Result<()> {
2025-11-09T23:42:54.7126682Z          use crate::network::protocol::NetworkAddress;
2025-11-09T23:42:54.7126756Z -        
2025-11-09T23:42:54.7126823Z +
2025-11-09T23:42:54.7126925Z          // Get peer services from peer state
2025-11-09T23:42:54.7127016Z          let peer_services = {
2025-11-09T23:42:54.7127142Z              let peer_states = self.peer_states.lock().unwrap();
2025-11-09T23:42:54.7127390Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2502:
2025-11-09T23:42:54.7127494Z                  .map(|state| state.services)
2025-11-09T23:42:54.7127575Z                  .unwrap_or(0)
2025-11-09T23:42:54.7127645Z          };
2025-11-09T23:42:54.7127713Z -        
2025-11-09T23:42:54.7127784Z +
2025-11-09T23:42:54.7127874Z          // Store addresses in database
2025-11-09T23:42:54.7127942Z          {
2025-11-09T23:42:54.7128065Z              let mut db = self.address_database.lock().unwrap();
2025-11-09T23:42:54.7128320Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2510:
2025-11-09T23:42:54.7128441Z                  db.add_address(addr.clone(), peer_services);
2025-11-09T23:42:54.7128511Z              }
2025-11-09T23:42:54.7128585Z          }
2025-11-09T23:42:54.7128654Z -        
2025-11-09T23:42:54.7128722Z +
2025-11-09T23:42:54.7128855Z          // Relay addresses to other peers (with rate limiting)
2025-11-09T23:42:54.7128992Z          self.relay_addresses(peer_addr, &msg.addresses).await?;
2025-11-09T23:42:54.7129064Z -        
2025-11-09T23:42:54.7129132Z +
2025-11-09T23:42:54.7129208Z          Ok(())
2025-11-09T23:42:54.7129289Z      }
2025-11-09T23:42:54.7129399Z  
2025-11-09T23:42:54.7129839Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2525:
2025-11-09T23:42:54.7129946Z      ) -> Result<()> {
2025-11-09T23:42:54.7130160Z          use crate::network::protocol::{AddrMessage, ProtocolMessage, ProtocolParser};
2025-11-09T23:42:54.7130271Z          use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:42:54.7130491Z -        
2025-11-09T23:42:54.7130560Z +
2025-11-09T23:42:54.7130782Z          // Rate limiting: don't send addr messages too frequently (Bitcoin Core: ~every 2.4 hours)
2025-11-09T23:42:54.7130883Z          let now = SystemTime::now()
2025-11-09T23:42:54.7130977Z              .duration_since(UNIX_EPOCH)
2025-11-09T23:42:54.7131222Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2532:
2025-11-09T23:42:54.7131309Z              .unwrap()
2025-11-09T23:42:54.7131386Z              .as_secs();
2025-11-09T23:42:54.7131532Z          let min_interval = 2 * 60 * 60 + 24 * 60; // 2.4 hours in seconds
2025-11-09T23:42:54.7131603Z -        
2025-11-09T23:42:54.7131677Z +
2025-11-09T23:42:54.7131745Z          {
2025-11-09T23:42:54.7131878Z              let last_sent = *self.last_addr_sent.lock().unwrap();
2025-11-09T23:42:54.7132004Z              if now.saturating_sub(last_sent) < min_interval {
2025-11-09T23:42:54.7132250Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2540:
2025-11-09T23:42:54.7132337Z                  return Ok(());
2025-11-09T23:42:54.7132407Z              }
2025-11-09T23:42:54.7132480Z          }
2025-11-09T23:42:54.7132547Z -        
2025-11-09T23:42:54.7132613Z +
2025-11-09T23:42:54.7132771Z          // Filter addresses (exclude local, banned, already connected)
2025-11-09T23:42:54.7132898Z          let ban_list = self.ban_list.lock().unwrap().clone();
2025-11-09T23:42:54.7133137Z          let connected_peers: Vec<SocketAddr> = {
2025-11-09T23:42:54.7133383Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2547:
2025-11-09T23:42:54.7133499Z              let pm = self.peer_manager.lock().unwrap();
2025-11-09T23:42:54.7133589Z              pm.peer_socket_addresses()
2025-11-09T23:42:54.7133659Z          };
2025-11-09T23:42:54.7133736Z -        
2025-11-09T23:42:54.7133803Z +
2025-11-09T23:42:54.7133884Z          let filtered = {
2025-11-09T23:42:54.7134004Z              let db = self.address_database.lock().unwrap();
2025-11-09T23:42:54.7134190Z              db.filter_addresses(addresses.to_vec(), &ban_list, &connected_peers)
2025-11-09T23:42:54.7134568Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2554:
2025-11-09T23:42:54.7134641Z          };
2025-11-09T23:42:54.7134713Z -        
2025-11-09T23:42:54.7134783Z +
2025-11-09T23:42:54.7134875Z          if filtered.is_empty() {
2025-11-09T23:42:54.7134965Z              return Ok(());
2025-11-09T23:42:54.7135035Z          }
2025-11-09T23:42:54.7135720Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2559:
2025-11-09T23:42:54.7135794Z -        
2025-11-09T23:42:54.7135866Z +
2025-11-09T23:42:54.7136272Z          // Limit to 1000 addresses per message (Bitcoin Core limit)
2025-11-09T23:42:54.7136757Z          let addresses_to_relay: Vec<NetworkAddress> = filtered.into_iter().take(1000).collect();
2025-11-09T23:42:54.7136835Z -        
2025-11-09T23:42:54.7136910Z +
2025-11-09T23:42:54.7136991Z          // Create Addr message
2025-11-09T23:42:54.7137086Z          let addr_msg = AddrMessage {
2025-11-09T23:42:54.7137189Z              addresses: addresses_to_relay,
2025-11-09T23:42:54.7137448Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2566:
2025-11-09T23:42:54.7137517Z          };
2025-11-09T23:42:54.7137656Z          let relay_msg = ProtocolMessage::Addr(addr_msg);
2025-11-09T23:42:54.7137819Z          let wire_msg = ProtocolParser::serialize_message(&relay_msg)?;
2025-11-09T23:42:54.7137888Z -        
2025-11-09T23:42:54.7137958Z +
2025-11-09T23:42:54.7138051Z          // Send to all peers except sender
2025-11-09T23:42:54.7138149Z          let peer_addrs: Vec<SocketAddr> = {
2025-11-09T23:42:54.7138263Z              let pm = self.peer_manager.lock().unwrap();
2025-11-09T23:42:54.7138517Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2575:
2025-11-09T23:42:54.7138617Z                  .filter(|addr| *addr != sender_addr)
2025-11-09T23:42:54.7138930Z                  .collect()
2025-11-09T23:42:54.7139060Z          };
2025-11-09T23:42:54.7139175Z -        
2025-11-09T23:42:54.7139288Z +
2025-11-09T23:42:54.7139451Z          for peer_addr in peer_addrs {
2025-11-09T23:42:54.7139692Z              if let Err(e) = self.send_to_peer(peer_addr, wire_msg.clone()).await {
2025-11-09T23:42:54.7139844Z                  warn!("Failed to relay addresses to {}: {}", peer_addr, e);
2025-11-09T23:42:54.7140113Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2582:
2025-11-09T23:42:54.7140190Z              }
2025-11-09T23:42:54.7140257Z          }
2025-11-09T23:42:54.7140329Z -        
2025-11-09T23:42:54.7140400Z +
2025-11-09T23:42:54.7140488Z          // Update last sent time
2025-11-09T23:42:54.7140599Z          *self.last_addr_sent.lock().unwrap() = now;
2025-11-09T23:42:54.7140666Z -        
2025-11-09T23:42:54.7140736Z +
2025-11-09T23:42:54.7140809Z          Ok(())
2025-11-09T23:42:54.7140879Z      }
2025-11-09T23:42:54.7140947Z  
2025-11-09T23:42:54.7141202Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2593:
2025-11-09T23:42:54.7141307Z          if !self.enable_self_advertisement {
2025-11-09T23:42:54.7141430Z              return Ok(()); // Self-advertisement disabled
2025-11-09T23:42:54.7141507Z          }
2025-11-09T23:42:54.7142142Z -        
2025-11-09T23:42:54.7142434Z -        use crate::network::protocol::{AddrMessage, NetworkAddress, ProtocolMessage, ProtocolParser};
2025-11-09T23:42:54.7142772Z +
2025-11-09T23:42:54.7142882Z +        use crate::network::protocol::{
2025-11-09T23:42:54.7143062Z +            AddrMessage, NetworkAddress, ProtocolMessage, ProtocolParser,
2025-11-09T23:42:54.7143132Z +        };
2025-11-09T23:42:54.7143229Z          use std::net::IpAddr;
2025-11-09T23:42:54.7143299Z -        
2025-11-09T23:42:54.7143366Z +
2025-11-09T23:42:54.7143475Z          // Convert SocketAddr to NetworkAddress
2025-11-09T23:42:54.7143584Z          let ip_bytes = match listen_addr.ip() {
2025-11-09T23:42:54.7143674Z              IpAddr::V4(ipv4) => {
2025-11-09T23:42:54.7143940Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2607:
2025-11-09T23:42:54.7144067Z                  bytes[12..16].copy_from_slice(&ipv4.octets());
2025-11-09T23:42:54.7144142Z                  bytes
2025-11-09T23:42:54.7144217Z              }
2025-11-09T23:42:54.7144451Z -            IpAddr::V6(ipv6) => {
2025-11-09T23:42:54.7144536Z -                ipv6.octets()
2025-11-09T23:42:54.7144606Z -            }
2025-11-09T23:42:54.7144707Z +            IpAddr::V6(ipv6) => ipv6.octets(),
2025-11-09T23:42:54.7144781Z          };
2025-11-09T23:42:54.7144849Z -        
2025-11-09T23:42:54.7144916Z +
2025-11-09T23:42:54.7145016Z          let our_addr = NetworkAddress {
2025-11-09T23:42:54.7145092Z              services,
2025-11-09T23:42:54.7145172Z              ip: ip_bytes,
2025-11-09T23:42:54.7145432Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2618:
2025-11-09T23:42:54.7145530Z              port: listen_addr.port(),
2025-11-09T23:42:54.7145600Z          };
2025-11-09T23:42:54.7145667Z -        
2025-11-09T23:42:54.7145739Z +
2025-11-09T23:42:54.7145848Z          // Create Addr message with just our address
2025-11-09T23:42:54.7145940Z          let addr_msg = AddrMessage {
2025-11-09T23:42:54.7146041Z              addresses: vec![our_addr.clone()],
2025-11-09T23:42:54.7147836Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2624:
2025-11-09T23:42:54.7147904Z          };
2025-11-09T23:42:54.7148033Z          let relay_msg = ProtocolMessage::Addr(addr_msg);
2025-11-09T23:42:54.7148200Z          let wire_msg = ProtocolParser::serialize_message(&relay_msg)?;
2025-11-09T23:42:54.7148270Z -        
2025-11-09T23:42:54.7148337Z +
2025-11-09T23:42:54.7148433Z          // Send to all connected peers
2025-11-09T23:42:54.7148686Z          let peer_addrs: Vec<SocketAddr> = {
2025-11-09T23:42:54.7148804Z              let pm = self.peer_manager.lock().unwrap();
2025-11-09T23:42:54.7149055Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2631:
2025-11-09T23:42:54.7149153Z              pm.peer_socket_addresses()
2025-11-09T23:42:54.7149222Z          };
2025-11-09T23:42:54.7149291Z -        
2025-11-09T23:42:54.7149363Z +
2025-11-09T23:42:54.7149459Z          for peer_addr in peer_addrs {
2025-11-09T23:42:54.7149627Z              if let Err(e) = self.send_to_peer(peer_addr, wire_msg.clone()).await {
2025-11-09T23:42:54.7149771Z                  warn!("Failed to advertise self to {}: {}", peer_addr, e);
2025-11-09T23:42:54.7150026Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2637:
2025-11-09T23:42:54.7150097Z              }
2025-11-09T23:42:54.7150167Z          }
2025-11-09T23:42:54.7150238Z -        
2025-11-09T23:42:54.7150306Z +
2025-11-09T23:42:54.7150414Z          // Also store our own address in database
2025-11-09T23:42:54.7150483Z          {
2025-11-09T23:42:54.7150615Z              let mut db = self.address_database.lock().unwrap();
2025-11-09T23:42:54.7150861Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2643:
2025-11-09T23:42:54.7150961Z              db.add_address(our_addr, services);
2025-11-09T23:42:54.7151033Z          }
2025-11-09T23:42:54.7151229Z -        
2025-11-09T23:42:54.7151298Z +
2025-11-09T23:42:54.7151374Z          Ok(())
2025-11-09T23:42:54.7151448Z      }
2025-11-09T23:42:54.7151517Z  
2025-11-09T23:42:54.7151763Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2649:
2025-11-09T23:42:54.7151856Z      /// Get list of banned peers
2025-11-09T23:42:54.7151999Z      pub fn get_banned_peers(&self) -> Vec<(SocketAddr, u64)> {
2025-11-09T23:42:54.7152115Z          let ban_list = self.ban_list.lock().unwrap();
2025-11-09T23:42:54.7152296Z -        ban_list.iter().map(|(addr, timestamp)| (*addr, *timestamp)).collect()
2025-11-09T23:42:54.7152372Z +        ban_list
2025-11-09T23:42:54.7152446Z +            .iter()
2025-11-09T23:42:54.7152563Z +            .map(|(addr, timestamp)| (*addr, *timestamp))
2025-11-09T23:42:54.7152644Z +            .collect()
2025-11-09T23:42:54.7152713Z      }
2025-11-09T23:42:54.7152781Z  
2025-11-09T23:42:54.7152895Z      /// Get peer addresses (async version for RPC)
2025-11-09T23:42:54.7153148Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2714:
2025-11-09T23:42:54.7153234Z          peer_addr: SocketAddr,
2025-11-09T23:42:54.7153362Z          msg: crate::network::protocol::GetBanListMessage,
2025-11-09T23:42:54.7153445Z      ) -> Result<()> {
2025-11-09T23:42:54.7153643Z -        use crate::network::protocol::{BanEntry, BanListMessage, NetworkAddress};
2025-11-09T23:42:54.7153799Z          use crate::network::ban_list_merging::calculate_ban_list_hash;
2025-11-09T23:42:54.7153991Z +        use crate::network::protocol::{BanEntry, BanListMessage, NetworkAddress};
2025-11-09T23:42:54.7154103Z          use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:42:54.7154171Z  
2025-11-09T23:42:54.7154579Z -        debug!("GetBanList request from {}: full={}, min_duration={}", 
2025-11-09T23:42:54.7154723Z -               peer_addr, msg.request_full, msg.min_ban_duration);
2025-11-09T23:42:54.7154796Z +        debug!(
2025-11-09T23:42:54.7154941Z +            "GetBanList request from {}: full={}, min_duration={}",
2025-11-09T23:42:54.7155074Z +            peer_addr, msg.request_full, msg.min_ban_duration
2025-11-09T23:42:54.7155146Z +        );
2025-11-09T23:42:54.7155213Z  
2025-11-09T23:42:54.7155304Z          // Get current ban list
2025-11-09T23:42:54.7155418Z          let ban_list = self.ban_list.lock().unwrap();
2025-11-09T23:42:54.7155679Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2776:
2025-11-09T23:42:54.7155782Z          let response = BanListMessage {
2025-11-09T23:42:54.7156010Z              is_full: msg.request_full,
2025-11-09T23:42:54.7156091Z              ban_list_hash,
2025-11-09T23:42:54.7156275Z -            ban_entries: if msg.request_full { ban_entries } else { Vec::new() },
2025-11-09T23:42:54.7156383Z +            ban_entries: if msg.request_full {
2025-11-09T23:42:54.7156462Z +                ban_entries
2025-11-09T23:42:54.7156535Z +            } else {
2025-11-09T23:42:54.7156624Z +                Vec::new()
2025-11-09T23:42:54.7156699Z +            },
2025-11-09T23:42:54.7156779Z              timestamp: now,
2025-11-09T23:42:54.7156849Z          };
2025-11-09T23:42:54.7156919Z  
2025-11-09T23:42:54.7157178Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2785:
2025-11-09T23:42:54.7157362Z          let serialized = ProtocolParser::serialize_message(&response_msg)?;
2025-11-09T23:42:54.7157493Z          self.send_to_peer(peer_addr, serialized).await?;
2025-11-09T23:42:54.7157564Z  
2025-11-09T23:42:54.7157723Z -        debug!("Sent BanList response to {}: {} entries", peer_addr, 
2025-11-09T23:42:54.7157856Z -               if msg.request_full { ban_entries.len() } else { 0 });
2025-11-09T23:42:54.7157933Z +        debug!(
2025-11-09T23:42:54.7158043Z +            "Sent BanList response to {}: {} entries",
2025-11-09T23:42:54.7158122Z +            peer_addr,
2025-11-09T23:42:54.7158215Z +            if msg.request_full {
2025-11-09T23:42:54.7158421Z +                ban_entries.len()
2025-11-09T23:42:54.7158494Z +            } else {
2025-11-09T23:42:54.7158569Z +                0
2025-11-09T23:42:54.7158638Z +            }
2025-11-09T23:42:54.7158706Z +        );
2025-11-09T23:42:54.7158775Z  
2025-11-09T23:42:54.7158851Z          Ok(())
2025-11-09T23:42:54.7158919Z      }
2025-11-09T23:42:54.7159173Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2800:
2025-11-09T23:42:54.7159386Z          use crate::network::ban_list_merging::{validate_ban_entry, verify_ban_list_hash};
2025-11-09T23:42:54.7159477Z          use std::net::IpAddr;
2025-11-09T23:42:54.7159544Z  
2025-11-09T23:42:54.7159682Z -        debug!("BanList received from {}: full={}, {} entries", 
2025-11-09T23:42:54.7159814Z -               peer_addr, msg.is_full, msg.ban_entries.len());
2025-11-09T23:42:54.7159885Z +        debug!(
2025-11-09T23:42:54.7160003Z +            "BanList received from {}: full={}, {} entries",
2025-11-09T23:42:54.7160089Z +            peer_addr,
2025-11-09T23:42:54.7160167Z +            msg.is_full,
2025-11-09T23:42:54.7160251Z +            msg.ban_entries.len()
2025-11-09T23:42:54.7160320Z +        );
2025-11-09T23:42:54.7160393Z  
2025-11-09T23:42:54.7160652Z          // Verify hash if full list provided
2025-11-09T23:42:54.7160731Z          if msg.is_full {
2025-11-09T23:42:54.7160994Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2813:
2025-11-09T23:42:54.7161064Z  
2025-11-09T23:42:54.7161218Z          // If hash-only, we can't merge (would need to request full list)
2025-11-09T23:42:54.7161307Z          if !msg.is_full {
2025-11-09T23:42:54.7161496Z -            debug!("Received hash-only ban list from {}, skipping merge", peer_addr);
2025-11-09T23:42:54.7161570Z +            debug!(
2025-11-09T23:42:54.7161713Z +                "Received hash-only ban list from {}, skipping merge",
2025-11-09T23:42:54.7161794Z +                peer_addr
2025-11-09T23:42:54.7161866Z +            );
2025-11-09T23:42:54.7161945Z              return Ok(());
2025-11-09T23:42:54.7162016Z          }
2025-11-09T23:42:54.7162085Z  
2025-11-09T23:42:54.7162338Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2831:
2025-11-09T23:42:54.7162433Z                  // IPv4-mapped IPv6 address
2025-11-09T23:42:54.7162547Z                  let ipv4_bytes = &entry.addr.ip[12..16];
2025-11-09T23:42:54.7162653Z                  IpAddr::V4(std::net::Ipv4Addr::new(
2025-11-09T23:42:54.7162796Z -                    ipv4_bytes[0], ipv4_bytes[1], ipv4_bytes[2], ipv4_bytes[3]
2025-11-09T23:42:54.7162994Z +                    ipv4_bytes[0],
2025-11-09T23:42:54.7163073Z +                    ipv4_bytes[1],
2025-11-09T23:42:54.7163149Z +                    ipv4_bytes[2],
2025-11-09T23:42:54.7163229Z +                    ipv4_bytes[3],
2025-11-09T23:42:54.7163299Z                  ))
2025-11-09T23:42:54.7163371Z              } else {
2025-11-09T23:42:54.7163451Z                  // IPv6 address
2025-11-09T23:42:54.7163723Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2882:
2025-11-09T23:42:54.7163805Z              ban_list.len()
2025-11-09T23:42:54.7163876Z          };
2025-11-09T23:42:54.7164045Z          let resource_metrics = self.dos_protection.get_metrics().await;
2025-11-09T23:42:54.7164114Z -        
2025-11-09T23:42:54.7164181Z +
2025-11-09T23:42:54.7164424Z          crate::node::metrics::NetworkMetrics {
2025-11-09T23:42:54.7164531Z              peer_count: active_connections,
2025-11-09T23:42:54.7164618Z              bytes_sent: sent,
2025-11-09T23:42:54.7164876Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2889:
2025-11-09T23:42:54.7166701Z              bytes_received: received,
2025-11-09T23:42:54.7166822Z -            messages_sent: 0, // Would need to track this
2025-11-09T23:42:54.7166944Z +            messages_sent: 0,     // Would need to track this
2025-11-09T23:42:54.7167062Z              messages_received: 0, // Would need to track this
2025-11-09T23:42:54.7167290Z              active_connections,
2025-11-09T23:42:54.7167394Z              banned_peers: banned_peers_count,
2025-11-09T23:42:54.7167649Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2894:
2025-11-09T23:42:54.7167779Z              connection_attempts: 0, // Would need to track this
2025-11-09T23:42:54.7167909Z              connection_failures: 0, // Would need to track this
2025-11-09T23:42:54.7168042Z              dos_protection: crate::node::metrics::DosMetrics {
2025-11-09T23:42:54.7168207Z -                connection_rate_violations: 0, // Would need to track this
2025-11-09T23:42:54.7168323Z -                auto_bans: 0, // Would need to track this
2025-11-09T23:42:54.7168464Z -                message_queue_overflows: 0, // Would need to track this
2025-11-09T23:42:54.7168623Z +                connection_rate_violations: 0,   // Would need to track this
2025-11-09T23:42:54.7168759Z +                auto_bans: 0,                    // Would need to track this
2025-11-09T23:42:54.7168908Z +                message_queue_overflows: 0,      // Would need to track this
2025-11-09T23:42:54.7169056Z                  active_connection_limit_hits: 0, // Would need to track this
2025-11-09T23:42:54.7169207Z -                resource_exhaustion_events: 0, // Would need to track this
2025-11-09T23:42:54.7169356Z +                resource_exhaustion_events: 0,   // Would need to track this
2025-11-09T23:42:54.7169427Z              },
2025-11-09T23:42:54.7169500Z          }
2025-11-09T23:42:54.7169573Z      }
2025-11-09T23:42:54.7169825Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2913:
2025-11-09T23:42:54.7169934Z      /// Create version message with service flags
2025-11-09T23:42:54.7170013Z      ///
2025-11-09T23:42:54.7170196Z      /// Creates version message with service flags for all supported features
2025-11-09T23:42:54.7170269Z -    /// 
2025-11-09T23:42:54.7170340Z +    ///
2025-11-09T23:42:54.7170516Z      /// Sets service flags based on:
2025-11-09T23:42:54.7170705Z      /// - BIP157: NODE_COMPACT_FILTERS (always enabled if filter service exists)
2025-11-09T23:42:54.7170866Z      /// - UTXO Commitments: NODE_UTXO_COMMITMENTS (if feature enabled)
2025-11-09T23:42:54.7171120Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2937:
2025-11-09T23:42:54.7171191Z  
2025-11-09T23:42:54.7171302Z          // Add service flags for supported features
2025-11-09T23:42:54.7171413Z          let mut services_with_filters = services;
2025-11-09T23:42:54.7171641Z -        
2025-11-09T23:42:54.7171711Z +
2025-11-09T23:42:54.7171898Z          // BIP157 Compact Block Filters (always enabled if filter service exists)
2025-11-09T23:42:54.7172020Z          services_with_filters |= NODE_COMPACT_FILTERS;
2025-11-09T23:42:54.7172091Z -        
2025-11-09T23:42:54.7172157Z +
2025-11-09T23:42:54.7172264Z          // UTXO Commitments (if feature enabled)
2025-11-09T23:42:54.7172370Z          #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.7172440Z          {
2025-11-09T23:42:54.7172687Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2947:
2025-11-09T23:42:54.7172891Z              services_with_filters |= crate::network::protocol::NODE_UTXO_COMMITMENTS;
2025-11-09T23:42:54.7172960Z          }
2025-11-09T23:42:54.7173052Z -        
2025-11-09T23:42:54.7173167Z +
2025-11-09T23:42:54.7173324Z          // Ban List Sharing (if config enabled)
2025-11-09T23:42:54.7173482Z          if self.ban_list_sharing_config.is_some() {
2025-11-09T23:42:54.7173681Z              services_with_filters |= crate::network::protocol::NODE_BAN_LIST_SHARING;
2025-11-09T23:42:54.7173934Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2953:
2025-11-09T23:42:54.7174005Z          }
2025-11-09T23:42:54.7174078Z -        
2025-11-09T23:42:54.7174153Z +
2025-11-09T23:42:54.7176526Z          // Dandelion (if feature enabled)
2025-11-09T23:42:54.7176618Z          #[cfg(feature = "dandelion")]
2025-11-09T23:42:54.7176695Z          {
2025-11-09T23:42:54.7176948Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2958:
2025-11-09T23:42:54.7177125Z              services_with_filters |= crate::network::protocol::NODE_DANDELION;
2025-11-09T23:42:54.7177195Z          }
2025-11-09T23:42:54.7177270Z -        
2025-11-09T23:42:54.7177337Z +
2025-11-09T23:42:54.7177444Z          // Package Relay (BIP331) - always enabled
2025-11-09T23:42:54.7177638Z          services_with_filters |= crate::network::protocol::NODE_PACKAGE_RELAY;
2025-11-09T23:42:54.7177708Z -        
2025-11-09T23:42:54.7177775Z +
2025-11-09T23:42:54.7177866Z          // FIBRE - always enabled
2025-11-09T23:42:54.7178027Z          services_with_filters |= crate::network::protocol::NODE_FIBRE;
2025-11-09T23:42:54.7178097Z  
2025-11-09T23:42:54.7178393Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/package_relay.rs:138:
2025-11-09T23:42:54.7178593Z      pub fn new(transactions: Vec<Transaction>) -> Result<Self, PackageError> {
2025-11-09T23:42:54.7178711Z          Self::new_with_utxo_set(transactions, None)
2025-11-09T23:42:54.7178781Z      }
2025-11-09T23:42:54.7178855Z -    
2025-11-09T23:42:54.7178922Z +
2025-11-09T23:42:54.7179096Z      /// Create a new transaction package with UTXO set for fee calculation
2025-11-09T23:42:54.7179185Z      pub fn new_with_utxo_set(
2025-11-09T23:42:54.7179286Z          transactions: Vec<Transaction>,
2025-11-09T23:42:54.7179574Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/package_relay.rs:168:
2025-11-09T23:42:54.7179703Z          // Calculate combined fee from UTXO set if provided
2025-11-09T23:42:54.7179842Z          let combined_fee = if let Some(utxo_set) = utxo_set {
2025-11-09T23:42:54.7180011Z              // Calculate fee for each transaction: sum(inputs) - sum(outputs)
2025-11-09T23:42:54.7180115Z -            transactions.iter().map(|tx| {
2025-11-09T23:42:54.7180232Z -                let input_total: u64 = tx.inputs.iter()
2025-11-09T23:42:54.7180357Z -                    .filter_map(|inp| utxo_set.get(&inp.prevout))
2025-11-09T23:42:54.7180455Z -                    .map(|utxo| utxo.value as u64)
2025-11-09T23:42:54.7180534Z -                    .sum();
2025-11-09T23:42:54.7180652Z -                let output_total: u64 = tx.outputs.iter()
2025-11-09T23:42:54.7180750Z -                    .map(|out| out.value as u64)
2025-11-09T23:42:54.7180826Z -                    .sum();
2025-11-09T23:42:54.7181064Z -                if input_total > output_total {
2025-11-09T23:42:54.7181163Z -                    input_total - output_total
2025-11-09T23:42:54.7181239Z -                } else {
2025-11-09T23:42:54.7181315Z -                    0
2025-11-09T23:42:54.7181386Z -                }
2025-11-09T23:42:54.7181460Z -            }).sum()
2025-11-09T23:42:54.7181547Z +            transactions
2025-11-09T23:42:54.7181627Z +                .iter()
2025-11-09T23:42:54.7181706Z +                .map(|tx| {
2025-11-09T23:42:54.7181810Z +                    let input_total: u64 = tx
2025-11-09T23:42:54.7181889Z +                        .inputs
2025-11-09T23:42:54.7181967Z +                        .iter()
2025-11-09T23:42:54.7182098Z +                        .filter_map(|inp| utxo_set.get(&inp.prevout))
2025-11-09T23:42:54.7182199Z +                        .map(|utxo| utxo.value as u64)
2025-11-09T23:42:54.7182276Z +                        .sum();
2025-11-09T23:42:54.7182476Z +                    let output_total: u64 = tx.outputs.iter().map(|out| out.value as u64).sum();
2025-11-09T23:42:54.7188491Z +                    if input_total > output_total {
2025-11-09T23:42:54.7188649Z +                        input_total - output_total
2025-11-09T23:42:54.7188739Z +                    } else {
2025-11-09T23:42:54.7188819Z +                        0
2025-11-09T23:42:54.7188893Z +                    }
2025-11-09T23:42:54.7189150Z +                })
2025-11-09T23:42:54.7189229Z +                .sum()
2025-11-09T23:42:54.7189301Z          } else {
2025-11-09T23:42:54.7189417Z              0 // Fee calculation requires UTXO set
2025-11-09T23:42:54.7189494Z          };
2025-11-09T23:42:54.7189776Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:4:
2025-11-09T23:42:54.7189847Z  
2025-11-09T23:42:54.7189944Z  use anyhow::Result;
2025-11-09T23:42:54.7190041Z  use std::net::SocketAddr;
2025-11-09T23:42:54.7190120Z +use std::sync::Arc;
2025-11-09T23:42:54.7190234Z  use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:42:54.7190327Z  use tokio::sync::mpsc;
2025-11-09T23:42:54.7190422Z  use tracing::{debug, info, warn};
2025-11-09T23:42:54.7190697Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:10:
2025-11-09T23:42:54.7190782Z -use std::sync::Arc;
2025-11-09T23:42:54.7190859Z  
2025-11-09T23:42:54.7191024Z +use super::transport::{TransportAddr, TransportConnection};
2025-11-09T23:42:54.7191122Z  use super::NetworkMessage;
2025-11-09T23:42:54.7191288Z -use super::transport::{TransportConnection, TransportAddr};
2025-11-09T23:42:54.7191358Z  
2025-11-09T23:42:54.7191450Z  /// Peer connection state
2025-11-09T23:42:54.7191524Z -/// 
2025-11-09T23:42:54.7191595Z +///
2025-11-09T23:42:54.7191832Z  /// Supports multiple transport types (TCP, Quinn, Iroh) via TransportConnection trait
2025-11-09T23:42:54.7191918Z  pub struct Peer {
2025-11-09T23:42:54.7192004Z      addr: SocketAddr,
2025-11-09T23:42:54.7192378Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:48:
2025-11-09T23:42:54.7192498Z  
2025-11-09T23:42:54.7192635Z  impl Peer {
2025-11-09T23:42:54.7192881Z      /// Create a new peer connection from a TransportConnection
2025-11-09T23:42:54.7192998Z -    /// 
2025-11-09T23:42:54.7193115Z +    ///
2025-11-09T23:42:54.7193369Z      /// This is the preferred method as it supports all transport types (TCP, Quinn, Iroh).
2025-11-09T23:42:54.7193547Z      /// The connection is managed via channels for concurrent read/write.
2025-11-09T23:42:54.7193725Z      pub fn from_transport_connection<C: TransportConnection + 'static>(
2025-11-09T23:42:54.7194001Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:59:
2025-11-09T23:42:54.7194079Z      ) -> Self {
2025-11-09T23:42:54.7194186Z          // Create channel for sending messages
2025-11-09T23:42:54.7194496Z          let (send_tx, send_rx) = mpsc::unbounded_channel::<Vec<u8>>();
2025-11-09T23:42:54.7194778Z -        
2025-11-09T23:42:54.7194894Z +
2025-11-09T23:42:54.7195123Z          let transport_addr_clone = transport_addr.clone();
2025-11-09T23:42:54.7195313Z          let message_tx_clone = message_tx.clone();
2025-11-09T23:42:54.7195429Z -        
2025-11-09T23:42:54.7195551Z +
2025-11-09T23:42:54.7195780Z          // Wrap connection in Arc<Mutex> to share between read and write tasks
2025-11-09T23:42:54.7195875Z          use std::sync::Arc;
2025-11-09T23:42:54.7195973Z          use tokio::sync::Mutex;
2025-11-09T23:42:54.7196235Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:69:
2025-11-09T23:42:54.7196346Z          let conn = Arc::new(Mutex::new(conn));
2025-11-09T23:42:54.7196446Z          let conn_read = Arc::clone(&conn);
2025-11-09T23:42:54.7196544Z          let conn_write = Arc::clone(&conn);
2025-11-09T23:42:54.7196625Z -        
2025-11-09T23:42:54.7196695Z +
2025-11-09T23:42:54.7196828Z          // Spawn read task using TransportConnection::recv
2025-11-09T23:42:54.7196933Z          tokio::spawn(async move {
2025-11-09T23:42:54.7197010Z              loop {
2025-11-09T23:42:54.7197261Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:83:
2025-11-09T23:42:54.7197340Z                          }
2025-11-09T23:42:54.7197416Z                      }
2025-11-09T23:42:54.7197488Z                  };
2025-11-09T23:42:54.7197559Z -                
2025-11-09T23:42:54.7197792Z +
2025-11-09T23:42:54.7197886Z                  if data.is_empty() {
2025-11-09T23:42:54.7197962Z                      break;
2025-11-09T23:42:54.7198033Z                  }
2025-11-09T23:42:54.7198285Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:90:
2025-11-09T23:42:54.7198355Z -                
2025-11-09T23:42:54.7198423Z +
2025-11-09T23:42:54.7198551Z                  let peer_addr = match &transport_addr_clone {
2025-11-09T23:42:54.7198699Z                      super::transport::TransportAddr::Tcp(sock) => *sock,
2025-11-09T23:42:54.7198798Z                      #[cfg(feature = "quinn")]
2025-11-09T23:42:54.7199052Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:100:
2025-11-09T23:42:54.7199287Z                  let _ = message_tx_clone.send(NetworkMessage::RawMessageReceived(data, peer_addr));
2025-11-09T23:42:54.7199359Z              }
2025-11-09T23:42:54.7199429Z          });
2025-11-09T23:42:54.7199511Z -        
2025-11-09T23:42:54.7199579Z +
2025-11-09T23:42:54.7199713Z          // Spawn write task using TransportConnection::send
2025-11-09T23:42:54.7199809Z          tokio::spawn(async move {
2025-11-09T23:42:54.7199899Z              let mut send_rx = send_rx;
2025-11-09T23:42:54.7200154Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:107:
2025-11-09T23:42:54.7200226Z -            
2025-11-09T23:42:54.7200299Z +
2025-11-09T23:42:54.7200372Z              loop {
2025-11-09T23:42:54.7200467Z                  match send_rx.recv().await {
2025-11-09T23:42:54.7200558Z                      Some(data) => {
2025-11-09T23:42:54.7200805Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:124:
2025-11-09T23:42:54.7200878Z                      }
2025-11-09T23:42:54.7200951Z                  }
2025-11-09T23:42:54.7201026Z              }
2025-11-09T23:42:54.7201094Z -            
2025-11-09T23:42:54.7201162Z +
2025-11-09T23:42:54.7201293Z              // Gracefully close connection on write task exit
2025-11-09T23:42:54.7201433Z              // Connection will be closed when conn_guard is dropped
2025-11-09T23:42:54.7201504Z          });
2025-11-09T23:42:54.7201748Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:131:
2025-11-09T23:42:54.7201825Z -        
2025-11-09T23:42:54.7201895Z +
2025-11-09T23:42:54.7201985Z          let now = SystemTime::now()
2025-11-09T23:42:54.7202087Z              .duration_since(UNIX_EPOCH)
2025-11-09T23:42:54.7202161Z              .unwrap()
2025-11-09T23:42:54.7202513Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:135:
2025-11-09T23:42:54.7202597Z              .as_secs();
2025-11-09T23:42:54.7202665Z -        
2025-11-09T23:42:54.7202733Z +
2025-11-09T23:42:54.7202804Z          Self {
2025-11-09T23:42:54.7202882Z              addr,
2025-11-09T23:42:54.7202964Z              transport_addr,
2025-11-09T23:42:54.7203208Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:153:
2025-11-09T23:42:54.7203310Z              last_tx_received: None,
2025-11-09T23:42:54.7203380Z          }
2025-11-09T23:42:54.7203446Z      }
2025-11-09T23:42:54.7203514Z -    
2025-11-09T23:42:54.7203587Z +
2025-11-09T23:42:54.7203781Z      /// Create a new peer connection from a TCP stream (backward compatibility)
2025-11-09T23:42:54.7203853Z -    /// 
2025-11-09T23:42:54.7203922Z +    ///
2025-11-09T23:42:54.7204112Z      /// This is a convenience method that wraps a TcpStream in a TcpConnection.
2025-11-09T23:42:54.7206778Z      #[deprecated(note = "Use from_transport_connection instead for transport abstraction")]
2025-11-09T23:42:54.7206874Z      pub fn new(
2025-11-09T23:42:54.7207152Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:165:
2025-11-09T23:42:54.7207234Z      ) -> Self {
2025-11-09T23:42:54.7207363Z          use super::tcp_transport::TcpConnection;
2025-11-09T23:42:54.7207630Z          use super::transport::TransportAddr;
2025-11-09T23:42:54.7207704Z -        
2025-11-09T23:42:54.7207775Z +
2025-11-09T23:42:54.7207910Z          let peer_addr = stream.peer_addr().unwrap_or(addr);
2025-11-09T23:42:54.7208012Z          let tcp_conn = TcpConnection {
2025-11-09T23:42:54.7208089Z              stream,
2025-11-09T23:42:54.7208355Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:172:
2025-11-09T23:42:54.7208479Z              peer_addr: TransportAddr::Tcp(peer_addr),
2025-11-09T23:42:54.7208565Z              connected: true,
2025-11-09T23:42:54.7208641Z          };
2025-11-09T23:42:54.7208713Z -        
2025-11-09T23:42:54.7208782Z +
2025-11-09T23:42:54.7209007Z          Self::from_transport_connection(tcp_conn, addr, TransportAddr::Tcp(addr), message_tx)
2025-11-09T23:42:54.7209078Z      }
2025-11-09T23:42:54.7209151Z  
2025-11-09T23:42:54.7209403Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:189:
2025-11-09T23:42:54.7209514Z          self.handle_peer_communication().await?;
2025-11-09T23:42:54.7209591Z  
2025-11-09T23:42:54.7209690Z          // Send disconnection notification
2025-11-09T23:42:54.7209770Z -        let _ = self
2025-11-09T23:42:54.7209846Z -            .message_tx
2025-11-09T23:42:54.7210058Z -            .send(NetworkMessage::PeerDisconnected(self.transport_addr.clone()));
2025-11-09T23:42:54.7210226Z +        let _ = self.message_tx.send(NetworkMessage::PeerDisconnected(
2025-11-09T23:42:54.7210323Z +            self.transport_addr.clone(),
2025-11-09T23:42:54.7210407Z +        ));
2025-11-09T23:42:54.7210477Z  
2025-11-09T23:42:54.7210548Z          Ok(())
2025-11-09T23:42:54.7210616Z      }
2025-11-09T23:42:54.7210884Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:198:
2025-11-09T23:42:54.7210953Z  
2025-11-09T23:42:54.7211050Z      /// Handle peer communication loop
2025-11-09T23:42:54.7211126Z -    /// 
2025-11-09T23:42:54.7211200Z +    ///
2025-11-09T23:42:54.7211367Z      /// Note: The read loop is now handled in `new()` via stream splitting.
2025-11-09T23:42:54.7211497Z      /// This method just waits for the connection to close.
2025-11-09T23:42:54.7211658Z      async fn handle_peer_communication(&mut self) -> Result<()> {
2025-11-09T23:42:54.7211908Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:205:
2025-11-09T23:42:54.7212036Z          // We just wait here to detect when connection closes
2025-11-09T23:42:54.7212226Z          // In a real implementation, we'd monitor the read task or connection state
2025-11-09T23:42:54.7212543Z          tokio::time::sleep(tokio::time::Duration::from_secs(1)).await;
2025-11-09T23:42:54.7212615Z -        
2025-11-09T23:42:54.7212689Z +
2025-11-09T23:42:54.7212935Z          // Connection close is automatically detected by the read task in from_transport_connection
2025-11-09T23:42:54.7213149Z          // When recv() returns empty data or error, the task breaks and sends PeerDisconnected
2025-11-09T23:42:54.7213246Z          self.connected = false;
2025-11-09T23:42:54.7213502Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:248:
2025-11-09T23:42:54.7213572Z      }
2025-11-09T23:42:54.7213641Z  
2025-11-09T23:42:54.7214010Z      /// Send a message to the peer
2025-11-09T23:42:54.7216100Z -    /// 
2025-11-09T23:42:54.7216173Z +    ///
2025-11-09T23:42:54.7216331Z      /// Messages are sent via a channel to a background write task.
2025-11-09T23:42:54.7216497Z      pub async fn send_message(&self, message: Vec<u8>) -> Result<()> {
2025-11-09T23:42:54.7216598Z          let message_len = message.len();
2025-11-09T23:42:54.7217160Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol.rs:2:
2025-11-09T23:42:54.7217240Z  //!
2025-11-09T23:42:54.7217447Z  //! Implements Bitcoin P2P protocol message serialization and deserialization.
2025-11-09T23:42:54.7217518Z  
2025-11-09T23:42:54.7217806Z -use bllvm_protocol::bip157::NODE_COMPACT_FILTERS;
2025-11-09T23:42:54.7217928Z  use crate::network::transport::TransportType;
2025-11-09T23:42:54.7218009Z  use anyhow::Result;
2025-11-09T23:42:54.7218130Z +use bllvm_protocol::bip157::NODE_COMPACT_FILTERS;
2025-11-09T23:42:54.7218291Z  use bllvm_protocol::{Block, BlockHeader, Hash, Transaction};
2025-11-09T23:42:54.7218393Z  use serde::{Deserialize, Serialize};
2025-11-09T23:42:54.7218462Z  
2025-11-09T23:42:54.7218737Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol.rs:145:
2025-11-09T23:42:54.7218867Z      pub fn supports_utxo_commitments(&self) -> bool {
2025-11-09T23:42:54.7218980Z          (self.services & NODE_UTXO_COMMITMENTS) != 0
2025-11-09T23:42:54.7219052Z      }
2025-11-09T23:42:54.7219122Z -    
2025-11-09T23:42:54.7219189Z +
2025-11-09T23:42:54.7219294Z      /// Check if peer supports ban list sharing
2025-11-09T23:42:54.7219415Z      pub fn supports_ban_list_sharing(&self) -> bool {
2025-11-09T23:42:54.7219529Z          (self.services & NODE_BAN_LIST_SHARING) != 0
2025-11-09T23:42:54.7219790Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol.rs:152:
2025-11-09T23:42:54.7219865Z      }
2025-11-09T23:42:54.7219935Z -    
2025-11-09T23:42:54.7220004Z +
2025-11-09T23:42:54.7220133Z      /// Check if peer supports BIP157 compact block filters
2025-11-09T23:42:54.7220254Z      pub fn supports_compact_filters(&self) -> bool {
2025-11-09T23:42:54.7220381Z          use bllvm_protocol::bip157::NODE_COMPACT_FILTERS;
2025-11-09T23:42:54.7220638Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol.rs:157:
2025-11-09T23:42:54.7220757Z          (self.services & NODE_COMPACT_FILTERS) != 0
2025-11-09T23:42:54.7220826Z      }
2025-11-09T23:42:54.7220894Z -    
2025-11-09T23:42:54.7220967Z +
2025-11-09T23:42:54.7221084Z      /// Check if peer supports package relay (BIP331)
2025-11-09T23:42:54.7221198Z      pub fn supports_package_relay(&self) -> bool {
2025-11-09T23:42:54.7221308Z          (self.services & NODE_PACKAGE_RELAY) != 0
2025-11-09T23:42:54.7221570Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol.rs:163:
2025-11-09T23:42:54.7221640Z      }
2025-11-09T23:42:54.7221709Z -    
2025-11-09T23:42:54.7221781Z +
2025-11-09T23:42:54.7221876Z      /// Check if peer supports FIBRE
2025-11-09T23:42:54.7221977Z      pub fn supports_fibre(&self) -> bool {
2025-11-09T23:42:54.7222071Z          (self.services & NODE_FIBRE) != 0
2025-11-09T23:42:54.7224202Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol.rs:168:
2025-11-09T23:42:54.7224571Z      }
2025-11-09T23:42:54.7224640Z -    
2025-11-09T23:42:54.7224715Z +
2025-11-09T23:42:54.7224809Z      #[cfg(feature = "dandelion")]
2025-11-09T23:42:54.7224908Z      /// Check if peer supports Dandelion
2025-11-09T23:42:54.7225015Z      pub fn supports_dandelion(&self) -> bool {
2025-11-09T23:42:54.7225328Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol_extensions.rs:7:
2025-11-09T23:42:54.7225475Z  //! - FilteredBlock: Response with filtered transactions
2025-11-09T23:42:54.7225544Z  
2025-11-09T23:42:54.7225646Z  use crate::network::protocol::*;
2025-11-09T23:42:54.7225738Z -use crate::storage::Storage;
2025-11-09T23:42:54.7225849Z  use crate::network::txhash::calculate_txid;
2025-11-09T23:42:54.7225940Z +use crate::storage::Storage;
2025-11-09T23:42:54.7226025Z  use anyhow::Result;
2025-11-09T23:42:54.7226120Z  #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.7226300Z  use bllvm_protocol::utxo_commitments::merkle_tree::UtxoMerkleTree;
2025-11-09T23:42:54.7226613Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol_extensions.rs:41:
2025-11-09T23:42:54.7226701Z      // Get UTXO set from storage
2025-11-09T23:42:54.7226823Z      let utxo_set = storage.utxos().get_all_utxos()?;
2025-11-09T23:42:54.7226927Z      let utxo_count = utxo_set.len() as u64;
2025-11-09T23:42:54.7227120Z -    
2025-11-09T23:42:54.7227190Z +
2025-11-09T23:42:54.7227287Z      // Calculate total supply
2025-11-09T23:42:54.7227485Z      let total_supply: u64 = utxo_set.values().map(|utxo| utxo.value as u64).sum();
2025-11-09T23:42:54.7227557Z  
2025-11-09T23:42:54.7227856Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol_extensions.rs:49:
2025-11-09T23:42:54.7227959Z      #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.7228070Z      let mut utxo_tree = UtxoMerkleTree::new()
2025-11-09T23:42:54.7228258Z          .map_err(|e| anyhow::anyhow!("Failed to create UTXO Merkle tree: {:?}", e))?;
2025-11-09T23:42:54.7228338Z -    
2025-11-09T23:42:54.7228408Z +
2025-11-09T23:42:54.7228504Z      #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.7228599Z      for (outpoint, utxo) in &utxo_set {
2025-11-09T23:42:54.7228712Z -        utxo_tree.insert(*outpoint, utxo.clone())
2025-11-09T23:42:54.7228788Z +        utxo_tree
2025-11-09T23:42:54.7228889Z +            .insert(*outpoint, utxo.clone())
2025-11-09T23:42:54.7229076Z              .map_err(|e| anyhow::anyhow!("Failed to insert UTXO into tree: {:?}", e))?;
2025-11-09T23:42:54.7229146Z      }
2025-11-09T23:42:54.7229220Z  
2025-11-09T23:42:54.7229517Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol_extensions.rs:68:
2025-11-09T23:42:54.7229607Z      // Generate commitment
2025-11-09T23:42:54.7229702Z      #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.7229891Z      let commitment = utxo_tree.generate_commitment(block_hash, block_height);
2025-11-09T23:42:54.7229970Z -    
2025-11-09T23:42:54.7230039Z +
2025-11-09T23:42:54.7230143Z      #[cfg(not(feature = "utxo-commitments"))]
2025-11-09T23:42:54.7230304Z      let commitment = crate::network::protocol::UTXOCommitment {
2025-11-09T23:42:54.7230388Z          merkle_root: [0; 32],
2025-11-09T23:42:54.7230694Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol_extensions.rs:161:
2025-11-09T23:42:54.7230795Z      #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.7231044Z      let (filtered_txs, spam_summary_from_filter) = spam_filter.filter_block(&block.transactions);
2025-11-09T23:42:54.7231144Z      #[cfg(not(feature = "utxo-commitments"))]
2025-11-09T23:42:54.7231704Z -    let (filtered_txs, spam_summary_from_filter): (Vec<bllvm_protocol::Transaction>, crate::network::protocol::SpamSummary) = (block.transactions.clone(), crate::network::protocol::SpamSummary {
2025-11-09T23:42:54.7231795Z -        filtered_count: 0,
2025-11-09T23:42:54.7231994Z -        filtered_size: 0,
2025-11-09T23:42:54.7232129Z -        by_type: crate::network::protocol::SpamBreakdown {
2025-11-09T23:42:54.7232217Z -            ordinals: 0,
2025-11-09T23:42:54.7232303Z -            inscriptions: 0,
2025-11-09T23:42:54.7232377Z -            dust: 0,
2025-11-09T23:42:54.7232451Z -            brc20: 0,
2025-11-09T23:42:54.7232576Z +    let (filtered_txs, spam_summary_from_filter): (
2025-11-09T23:42:54.7232681Z +        Vec<bllvm_protocol::Transaction>,
2025-11-09T23:42:54.7232790Z +        crate::network::protocol::SpamSummary,
2025-11-09T23:42:54.7232867Z +    ) = (
2025-11-09T23:42:54.7232964Z +        block.transactions.clone(),
2025-11-09T23:42:54.7233069Z +        crate::network::protocol::SpamSummary {
2025-11-09T23:42:54.7233152Z +            filtered_count: 0,
2025-11-09T23:42:54.7233240Z +            filtered_size: 0,
2025-11-09T23:42:54.7233373Z +            by_type: crate::network::protocol::SpamBreakdown {
2025-11-09T23:42:54.7233453Z +                ordinals: 0,
2025-11-09T23:42:54.7233544Z +                inscriptions: 0,
2025-11-09T23:42:54.7233618Z +                dust: 0,
2025-11-09T23:42:54.7233702Z +                brc20: 0,
2025-11-09T23:42:54.7233773Z +            },
2025-11-09T23:42:54.7233841Z          },
2025-11-09T23:42:54.7233915Z -    });
2025-11-09T23:42:54.7233984Z -    
2025-11-09T23:42:54.7234052Z +    );
2025-11-09T23:42:54.7234118Z +
2025-11-09T23:42:54.7236340Z      // Convert spam summary to protocol types
2025-11-09T23:42:54.7236435Z      let spam_summary = SpamSummary {
2025-11-09T23:42:54.7236583Z          filtered_count: spam_summary_from_filter.filtered_count,
2025-11-09T23:42:54.7236908Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol_extensions.rs:186:
2025-11-09T23:42:54.7236977Z  
2025-11-09T23:42:54.7237214Z      // Generate transaction indices (positions of filtered transactions in original block)
2025-11-09T23:42:54.7237322Z      let mut transaction_indices = Vec::new();
2025-11-09T23:42:54.7237517Z -    let filtered_txids: std::collections::HashSet<_> = filtered_txs.iter()
2025-11-09T23:42:54.7237610Z -        .map(|tx| calculate_txid(tx))
2025-11-09T23:42:54.7237685Z -        .collect();
2025-11-09T23:42:54.7237815Z +    let filtered_txids: std::collections::HashSet<_> =
2025-11-09T23:42:54.7237969Z +        filtered_txs.iter().map(|tx| calculate_txid(tx)).collect();
2025-11-09T23:42:54.7238133Z      for (original_idx, tx) in block.transactions.iter().enumerate() {
2025-11-09T23:42:54.7238252Z          let txid = calculate_txid(tx);
2025-11-09T23:42:54.7238351Z          if filtered_txids.contains(&txid) {
2025-11-09T23:42:54.7238660Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol_extensions.rs:200:
2025-11-09T23:42:54.7238756Z      #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.7238866Z      let mut utxo_tree = UtxoMerkleTree::new()
2025-11-09T23:42:54.7239053Z          .map_err(|e| anyhow::anyhow!("Failed to create UTXO Merkle tree: {:?}", e))?;
2025-11-09T23:42:54.7239125Z -    
2025-11-09T23:42:54.7239198Z +
2025-11-09T23:42:54.7239291Z      #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.7239394Z      // Add outputs from filtered transactions
2025-11-09T23:42:54.7239484Z      for tx in &filtered_txs {
2025-11-09T23:42:54.7239790Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol_extensions.rs:227:
2025-11-09T23:42:54.7239891Z      // Generate commitment for filtered block
2025-11-09T23:42:54.7239983Z      #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.7240195Z      let commitment = utxo_tree.generate_commitment(message.block_hash, block_height);
2025-11-09T23:42:54.7240265Z -    
2025-11-09T23:42:54.7240333Z +
2025-11-09T23:42:54.7240439Z      #[cfg(not(feature = "utxo-commitments"))]
2025-11-09T23:42:54.7240593Z      let commitment = crate::network::protocol::UTXOCommitment {
2025-11-09T23:42:54.7240676Z          merkle_root: [0; 32],
2025-11-09T23:42:54.7241104Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/stratum_v2/pool.rs:191:
2025-11-09T23:42:54.7241176Z  
2025-11-09T23:42:54.7241259Z          // Store template
2025-11-09T23:42:54.7241365Z          self.current_template = Some(template);
2025-11-09T23:42:54.7241439Z -        
2025-11-09T23:42:54.7241507Z +
2025-11-09T23:42:54.7241587Z          (job_id, messages)
2025-11-09T23:42:54.7241659Z      }
2025-11-09T23:42:54.7241731Z  
2025-11-09T23:42:54.7242018Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/stratum_v2/pool.rs:463:
2025-11-09T23:42:54.7242159Z          if let Some(coinbase) = template.transactions.first() {
2025-11-09T23:42:54.7242263Z              // Serialize coinbase transaction
2025-11-09T23:42:54.7242418Z              let coinbase_bytes = self.serialize_transaction(coinbase);
2025-11-09T23:42:54.7242488Z -            
2025-11-09T23:42:54.7242563Z +
2025-11-09T23:42:54.7242694Z              // Extract merkle path from coinbase (index 0) to root
2025-11-09T23:42:54.7242840Z              let merkle_path = self.extract_merkle_path(template, 0);
2025-11-09T23:42:54.7242910Z -            
2025-11-09T23:42:54.7242984Z +
2025-11-09T23:42:54.7243183Z              // For Stratum V2, coinbase prefix is the full coinbase (miners can modify it)
2025-11-09T23:42:54.7243313Z              // Coinbase suffix is empty (not used in Stratum V2)
2025-11-09T23:42:54.7243419Z              (coinbase_bytes, vec![], merkle_path)
2025-11-09T23:42:54.7243846Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/stratum_v2/pool.rs:477:
2025-11-09T23:42:54.7243916Z  
2025-11-09T23:42:54.7244084Z      /// Extract merkle path from a specific transaction index to root
2025-11-09T23:42:54.7244411Z      fn extract_merkle_path(&self, block: &Block, tx_index: usize) -> Vec<Hash> {
2025-11-09T23:42:54.7244540Z -        use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:42:54.7244654Z          use crate::storage::hashing::double_sha256;
2025-11-09T23:42:54.7244783Z +        use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:42:54.7244851Z  
2025-11-09T23:42:54.7245049Z          if block.transactions.is_empty() || tx_index >= block.transactions.len() {
2025-11-09T23:42:54.7245135Z              return vec![];
2025-11-09T23:42:54.7245422Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/stratum_v2/pool.rs:485:
2025-11-09T23:42:54.7245497Z          }
2025-11-09T23:42:54.7245568Z  
2025-11-09T23:42:54.7245666Z          // Calculate all transaction hashes
2025-11-09T23:42:54.7245810Z -        let mut tx_hashes: Vec<Hash> = block.transactions.iter()
2025-11-09T23:42:54.7245906Z +        let mut tx_hashes: Vec<Hash> = block
2025-11-09T23:42:54.7245989Z +            .transactions
2025-11-09T23:42:54.7246062Z +            .iter()
2025-11-09T23:42:54.7246156Z              .map(|tx| calculate_tx_id(tx))
2025-11-09T23:42:54.7246238Z              .collect();
2025-11-09T23:42:54.7246308Z  
2025-11-09T23:42:54.7246595Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/stratum_v2/pool.rs:528:
2025-11-09T23:42:54.7246706Z                      combined.extend_from_slice(&chunk[0]);
2025-11-09T23:42:54.7246825Z                      let parent_hash = double_sha256(&combined);
2025-11-09T23:42:54.7246924Z                      next_level.push(parent_hash);
2025-11-09T23:42:54.7246997Z -                    
2025-11-09T23:42:54.7247071Z +
2025-11-09T23:42:54.7247242Z                      // If current_index is the last (odd) transaction, no sibling to add
2025-11-09T23:42:54.7247344Z                      let pair_start = pair_idx * 2;
2025-11-09T23:42:54.7247445Z                      if current_index == pair_start {
2025-11-09T23:42:54.7247791Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/stratum_v2/server.rs:214:
2025-11-09T23:42:54.7247901Z          // Get block template from MiningCoordinator
2025-11-09T23:42:54.7247989Z          let template = {
2025-11-09T23:42:54.7248277Z              let mut coordinator = self.mining_coordinator.write().await;
2025-11-09T23:42:54.7248399Z -            coordinator.generate_block_template().await
2025-11-09T23:42:54.7248649Z -                .map_err(|e| StratumV2Error::MiningJob(format!("Failed to generate block template: {}", e)))?
2025-11-09T23:42:54.7248810Z +            coordinator.generate_block_template().await.map_err(|e| {
2025-11-09T23:42:54.7249032Z +                StratumV2Error::MiningJob(format!("Failed to generate block template: {}", e))
2025-11-09T23:42:54.7249102Z +            })?
2025-11-09T23:42:54.7249178Z          };
2025-11-09T23:42:54.7249247Z  
2025-11-09T23:42:54.7249491Z -        debug!("Generated new block template with {} transactions", template.transactions.len());
2025-11-09T23:42:54.7249565Z +        debug!(
2025-11-09T23:42:54.7249700Z +            "Generated new block template with {} transactions",
2025-11-09T23:42:54.7249801Z +            template.transactions.len()
2025-11-09T23:42:54.7249876Z +        );
2025-11-09T23:42:54.7249947Z  
2025-11-09T23:42:54.7250109Z          // Set template in pool and get distribution messages
2025-11-09T23:42:54.7250211Z          let (job_id, messages) = {
2025-11-09T23:42:54.7250515Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/stratum_v2/server.rs:273:
2025-11-09T23:42:54.7250615Z          if let Some(ref mut conn) = *conn {
2025-11-09T23:42:54.7250955Z              // Use channel-specific sending - transports that support channels (QUIC/Iroh)
2025-11-09T23:42:54.7251159Z              // will route to the appropriate channel stream, others will use default send()
2025-11-09T23:42:54.7251320Z -            conn.send_on_channel(channel_id, &encoded).await.map_err(|e| {
2025-11-09T23:42:54.7251510Z -                StratumV2Error::Network(format!("Failed to send job message: {}", e))
2025-11-09T23:42:54.7251581Z -            })?;
2025-11-09T23:42:54.7251698Z +            conn.send_on_channel(channel_id, &encoded)
2025-11-09T23:42:54.7251777Z +                .await
2025-11-09T23:42:54.7251860Z +                .map_err(|e| {
2025-11-09T23:42:54.7252053Z +                    StratumV2Error::Network(format!("Failed to send job message: {}", e))
2025-11-09T23:42:54.7252125Z +                })?;
2025-11-09T23:42:54.7252195Z          } else {
2025-11-09T23:42:54.7252341Z              return Err(StratumV2Error::Connection(anyhow::anyhow!(
2025-11-09T23:42:54.7252444Z                  "Connection not available"
2025-11-09T23:42:54.7289319Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:101:
2025-11-09T23:42:54.7290437Z                  {
2025-11-09T23:42:54.7291055Z                      use crate::network::transport::TransportAddr;
2025-11-09T23:42:54.7291197Z                      use hex;
2025-11-09T23:42:54.7291337Z -                    
2025-11-09T23:42:54.7291453Z +
2025-11-09T23:42:54.7291788Z                      let node_id_hex = peer_id.strip_prefix("iroh:").ok_or_else(|| {
2025-11-09T23:42:54.7292303Z                          bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-09T23:42:54.7292543Z                              format!("Invalid Iroh peer_id format: {}", peer_id)
2025-11-09T23:42:54.7293184Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:108:
2025-11-09T23:42:54.7293337Z                          )
2025-11-09T23:42:54.7293482Z                      })?;
2025-11-09T23:42:54.7293612Z -                    
2025-11-09T23:42:54.7293739Z +
2025-11-09T23:42:54.7294019Z                      let node_id_bytes = hex::decode(node_id_hex).map_err(|e| {
2025-11-09T23:42:54.7294744Z                          bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-09T23:42:54.7294988Z                              format!("Invalid Iroh node ID hex: {}", e)
2025-11-09T23:42:54.7295827Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:114:
2025-11-09T23:42:54.7296256Z                          )
2025-11-09T23:42:54.7296398Z                      })?;
2025-11-09T23:42:54.7296535Z -                    
2025-11-09T23:42:54.7296656Z +
2025-11-09T23:42:54.7296945Z                      // Validate node ID length (Iroh uses 32-byte public keys)
2025-11-09T23:42:54.7297136Z                      if node_id_bytes.len() != 32 {
2025-11-09T23:42:54.7297749Z                          return Err(bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-09T23:42:54.7298407Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:120:
2025-11-09T23:42:54.7298850Z                              format!("Invalid Iroh node ID length: expected 32 bytes, got {}", node_id_bytes.len())
2025-11-09T23:42:54.7298991Z                          ));
2025-11-09T23:42:54.7299120Z                      }
2025-11-09T23:42:54.7299256Z -                    
2025-11-09T23:42:54.7299389Z +
2025-11-09T23:42:54.7299731Z                      // Create placeholder SocketAddr for Iroh (same approach as mod.rs)
2025-11-09T23:42:54.7299988Z                      // Use first 4 bytes of key for IP, last 2 bytes for port
2025-11-09T23:42:54.7300378Z -                    let ip_bytes = [node_id_bytes[0], node_id_bytes[1], node_id_bytes[2], node_id_bytes[3]];
2025-11-09T23:42:54.7300765Z +                    let ip_bytes = [
2025-11-09T23:42:54.7300927Z +                        node_id_bytes[0],
2025-11-09T23:42:54.7301092Z +                        node_id_bytes[1],
2025-11-09T23:42:54.7301242Z +                        node_id_bytes[2],
2025-11-09T23:42:54.7301380Z +                        node_id_bytes[3],
2025-11-09T23:42:54.7301499Z +                    ];
2025-11-09T23:42:54.7301813Z                      let port = u16::from_be_bytes([node_id_bytes[30], node_id_bytes[31]]);
2025-11-09T23:42:54.7302145Z                      let placeholder_addr = std::net::SocketAddr::from((ip_bytes, port));
2025-11-09T23:42:54.7302277Z -                    
2025-11-09T23:42:54.7302395Z +
2025-11-09T23:42:54.7302651Z                      let transport_addr = TransportAddr::Iroh(node_id_bytes);
2025-11-09T23:42:54.7302869Z                      Some((placeholder_addr, Some(transport_addr)))
2025-11-09T23:42:54.7302991Z                  }
2025-11-09T23:42:54.7303562Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:148:
2025-11-09T23:42:54.7303697Z                      ));
2025-11-09T23:42:54.7303809Z                  }
2025-11-09T23:42:54.7303925Z              };
2025-11-09T23:42:54.7304035Z -            
2025-11-09T23:42:54.7304145Z +
2025-11-09T23:42:54.7304476Z              // Store TransportAddr mapping if Iroh
2025-11-09T23:42:54.7304707Z              if let Some(transport_addr) = transport_addr_opt {
2025-11-09T23:42:54.7304908Z                  let network = network_manager.read().await;
2025-11-09T23:42:54.7305510Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:155:
2025-11-09T23:42:54.7305806Z                  // Store mapping from placeholder SocketAddr to TransportAddr
2025-11-09T23:42:54.7306197Z -                network.socket_to_transport.lock().unwrap().insert(peer_addr, transport_addr);
2025-11-09T23:42:54.7306323Z +                network
2025-11-09T23:42:54.7306493Z +                    .socket_to_transport
2025-11-09T23:42:54.7306616Z +                    .lock()
2025-11-09T23:42:54.7306745Z +                    .unwrap()
2025-11-09T23:42:54.7306929Z +                    .insert(peer_addr, transport_addr);
2025-11-09T23:42:54.7307065Z                  drop(network);
2025-11-09T23:42:54.7307178Z              }
2025-11-09T23:42:54.7307290Z  
2025-11-09T23:42:54.7307892Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:160:
2025-11-09T23:42:54.7308279Z              // Check if peer supports UTXO commitments before sending request
2025-11-09T23:42:54.7308733Z              let network = network_manager.read().await;
2025-11-09T23:42:54.7308848Z -            
2025-11-09T23:42:54.7308963Z +
2025-11-09T23:42:54.7309157Z              // Get peer version to check capabilities
2025-11-09T23:42:54.7309331Z              let peer_supports_utxo_commitments = {
2025-11-09T23:42:54.7309574Z                  let peer_states = network.peer_states.lock().unwrap();
2025-11-09T23:42:54.7310157Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:178:
2025-11-09T23:42:54.7310288Z                      false
2025-11-09T23:42:54.7310400Z                  }
2025-11-09T23:42:54.7310517Z              };
2025-11-09T23:42:54.7310628Z -            
2025-11-09T23:42:54.7310742Z +
2025-11-09T23:42:54.7311074Z              // If we know the peer doesn't support UTXO commitments, return error early
2025-11-09T23:42:54.7311264Z              if !peer_supports_utxo_commitments {
2025-11-09T23:42:54.7311410Z                  drop(network);
2025-11-09T23:42:54.7311995Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:186:
2025-11-09T23:42:54.7312520Z                      format!("Peer {} does not support UTXO commitments (missing NODE_UTXO_COMMITMENTS service flag)", peer_id)
2025-11-09T23:42:54.7312645Z                  ));
2025-11-09T23:42:54.7312999Z              }
2025-11-09T23:42:54.7313114Z -            
2025-11-09T23:42:54.7313231Z +
2025-11-09T23:42:54.7313421Z              // Register pending request before sending
2025-11-09T23:42:54.7313986Z              let (request_id, response_rx) = network.register_request(peer_addr);
2025-11-09T23:42:54.7314231Z              drop(network); // Release read lock before async wait
2025-11-09T23:42:54.7316343Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:193:
2025-11-09T23:42:54.7316467Z -            
2025-11-09T23:42:54.7316604Z +
2025-11-09T23:42:54.7316804Z              // Create GetUTXOSet message with request_id
2025-11-09T23:42:54.7316999Z -            let get_utxo_set_msg = GetUTXOSetMessage { 
2025-11-09T23:42:54.7317185Z +            let get_utxo_set_msg = GetUTXOSetMessage {
2025-11-09T23:42:54.7317323Z                  request_id,
2025-11-09T23:42:54.7317451Z -                height, 
2025-11-09T23:42:54.7317578Z -                block_hash 
2025-11-09T23:42:54.7317714Z +                height,
2025-11-09T23:42:54.7317843Z +                block_hash,
2025-11-09T23:42:54.7317951Z              };
2025-11-09T23:42:54.7318059Z  
2025-11-09T23:42:54.7318403Z              // Serialize message using protocol adapter (handles TCP vs Iroh format)
2025-11-09T23:42:54.7319091Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:203:
2025-11-09T23:42:54.7319636Z                  .map_err(|e| bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-09T23:42:54.7319875Z                      format!("Failed to serialize GetUTXOSet: {}", e)
2025-11-09T23:42:54.7319996Z                  ))?;
2025-11-09T23:42:54.7320108Z -            
2025-11-09T23:42:54.7320221Z +
2025-11-09T23:42:54.7320403Z              // Send message to peer via NetworkManager
2025-11-09T23:42:54.7320516Z              {
2025-11-09T23:42:54.7320712Z                  let network = network_manager.read().await;
2025-11-09T23:42:54.7321293Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:212:
2025-11-09T23:42:54.7321591Z                          format!("Failed to send GetUTXOSet to peer {}: {}", peer_addr, e)
2025-11-09T23:42:54.7321707Z                      ))?;
2025-11-09T23:42:54.7321826Z              }
2025-11-09T23:42:54.7321930Z -            
2025-11-09T23:42:54.7322037Z +
2025-11-09T23:42:54.7322216Z              // Await response with timeout (30 seconds)
2025-11-09T23:42:54.7322589Z              tokio::select! {
2025-11-09T23:42:54.7322733Z                  result = response_rx => {
2025-11-09T23:42:54.7323317Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:224:
2025-11-09T23:42:54.7323857Z                                  .map_err(|e| bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-09T23:42:54.7326152Z                                      format!("Failed to parse UTXOSet response: {}", e)
2025-11-09T23:42:54.7326297Z                                  ))?;
2025-11-09T23:42:54.7326425Z -                            
2025-11-09T23:42:54.7326537Z +
2025-11-09T23:42:54.7326693Z                              match parsed {
2025-11-09T23:42:54.7326923Z                                  ProtocolMessage::UTXOSet(utxo_set_msg) => {
2025-11-09T23:42:54.7327102Z                                      // Convert to UtxoCommitment
2025-11-09T23:42:54.7327684Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:291:
2025-11-09T23:42:54.7327814Z                  {
2025-11-09T23:42:54.7328042Z                      use crate::network::transport::TransportAddr;
2025-11-09T23:42:54.7328167Z                      use hex;
2025-11-09T23:42:54.7328283Z -                    
2025-11-09T23:42:54.7328396Z +
2025-11-09T23:42:54.7328667Z                      let node_id_hex = peer_id.strip_prefix("iroh:").ok_or_else(|| {
2025-11-09T23:42:54.7329433Z                          bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-09T23:42:54.7329677Z                              format!("Invalid Iroh peer_id format: {}", peer_id)
2025-11-09T23:42:54.7330266Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:298:
2025-11-09T23:42:54.7330389Z                          )
2025-11-09T23:42:54.7330510Z                      })?;
2025-11-09T23:42:54.7330643Z -                    
2025-11-09T23:42:54.7330760Z +
2025-11-09T23:42:54.7331017Z                      let node_id_bytes = hex::decode(node_id_hex).map_err(|e| {
2025-11-09T23:42:54.7331510Z                          bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-09T23:42:54.7331699Z                              format!("Invalid Iroh node ID hex: {}", e)
2025-11-09T23:42:54.7332284Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:304:
2025-11-09T23:42:54.7332424Z                          )
2025-11-09T23:42:54.7332541Z                      })?;
2025-11-09T23:42:54.7332655Z -                    
2025-11-09T23:42:54.7332768Z +
2025-11-09T23:42:54.7333019Z                      // Validate node ID length (Iroh uses 32-byte public keys)
2025-11-09T23:42:54.7333183Z                      if node_id_bytes.len() != 32 {
2025-11-09T23:42:54.7333695Z                          return Err(bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-09T23:42:54.7334272Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:310:
2025-11-09T23:42:54.7334809Z                              format!("Invalid Iroh node ID length: expected 32 bytes, got {}", node_id_bytes.len())
2025-11-09T23:42:54.7334935Z                          ));
2025-11-09T23:42:54.7335059Z                      }
2025-11-09T23:42:54.7335168Z -                    
2025-11-09T23:42:54.7335270Z +
2025-11-09T23:42:54.7335575Z                      // Create placeholder SocketAddr for Iroh (same approach as mod.rs)
2025-11-09T23:42:54.7335799Z                      // Use first 4 bytes of key for IP, last 2 bytes for port
2025-11-09T23:42:54.7336589Z -                    let ip_bytes = [node_id_bytes[0], node_id_bytes[1], node_id_bytes[2], node_id_bytes[3]];
2025-11-09T23:42:54.7337488Z +                    let ip_bytes = [
2025-11-09T23:42:54.7337667Z +                        node_id_bytes[0],
2025-11-09T23:42:54.7338074Z +                        node_id_bytes[1],
2025-11-09T23:42:54.7338217Z +                        node_id_bytes[2],
2025-11-09T23:42:54.7338366Z +                        node_id_bytes[3],
2025-11-09T23:42:54.7338483Z +                    ];
2025-11-09T23:42:54.7338804Z                      let port = u16::from_be_bytes([node_id_bytes[30], node_id_bytes[31]]);
2025-11-09T23:42:54.7339162Z                      let placeholder_addr = std::net::SocketAddr::from((ip_bytes, port));
2025-11-09T23:42:54.7339284Z -                    
2025-11-09T23:42:54.7339396Z +
2025-11-09T23:42:54.7339673Z                      let transport_addr = TransportAddr::Iroh(node_id_bytes);
2025-11-09T23:42:54.7339900Z                      Some((placeholder_addr, Some(transport_addr)))
2025-11-09T23:42:54.7340019Z                  }
2025-11-09T23:42:54.7340593Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:338:
2025-11-09T23:42:54.7340734Z                      ));
2025-11-09T23:42:54.7340850Z                  }
2025-11-09T23:42:54.7340961Z              };
2025-11-09T23:42:54.7341077Z -            
2025-11-09T23:42:54.7341188Z +
2025-11-09T23:42:54.7341366Z              // Store TransportAddr mapping if Iroh
2025-11-09T23:42:54.7341591Z              if let Some(transport_addr) = transport_addr_opt {
2025-11-09T23:42:54.7341792Z                  let network = network_manager.read().await;
2025-11-09T23:42:54.7342632Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:345:
2025-11-09T23:42:54.7342929Z                  // Store mapping from placeholder SocketAddr to TransportAddr
2025-11-09T23:42:54.7343328Z -                network.socket_to_transport.lock().unwrap().insert(peer_addr, transport_addr);
2025-11-09T23:42:54.7343454Z +                network
2025-11-09T23:42:54.7343606Z +                    .socket_to_transport
2025-11-09T23:42:54.7343736Z +                    .lock()
2025-11-09T23:42:54.7343876Z +                    .unwrap()
2025-11-09T23:42:54.7344054Z +                    .insert(peer_addr, transport_addr);
2025-11-09T23:42:54.7344192Z                  drop(network);
2025-11-09T23:42:54.7344481Z              }
2025-11-09T23:42:54.7344597Z  
2025-11-09T23:42:54.7345193Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:351:
2025-11-09T23:42:54.7345408Z              let network = network_manager.read().await;
2025-11-09T23:42:54.7345715Z              let (request_id, response_rx) = network.register_request(peer_addr);
2025-11-09T23:42:54.7346422Z              drop(network); // Release read lock before async wait
2025-11-09T23:42:54.7346557Z -            
2025-11-09T23:42:54.7346666Z +
2025-11-09T23:42:54.7346872Z              // Create GetFilteredBlock message with request_id
2025-11-09T23:42:54.7347098Z              use crate::network::protocol::FilterPreferences;
2025-11-09T23:42:54.7347356Z              let get_filtered_block_msg = GetFilteredBlockMessage {
2025-11-09T23:42:54.7347966Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:371:
2025-11-09T23:42:54.7348500Z                  .map_err(|e| bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-09T23:42:54.7348757Z                      format!("Failed to serialize GetFilteredBlock: {}", e)
2025-11-09T23:42:54.7348886Z                  ))?;
2025-11-09T23:42:54.7349003Z -            
2025-11-09T23:42:54.7349114Z +
2025-11-09T23:42:54.7349311Z              // Send message to peer via NetworkManager
2025-11-09T23:42:54.7349427Z              {
2025-11-09T23:42:54.7349619Z                  let network = network_manager.read().await;
2025-11-09T23:42:54.7350213Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:380:
2025-11-09T23:42:54.7350549Z                          format!("Failed to send GetFilteredBlock to peer {}: {}", peer_addr, e)
2025-11-09T23:42:54.7350932Z                      ))?;
2025-11-09T23:42:54.7351054Z              }
2025-11-09T23:42:54.7351163Z -            
2025-11-09T23:42:54.7351279Z +
2025-11-09T23:42:54.7351469Z              // Await response with timeout (30 seconds)
2025-11-09T23:42:54.7351628Z              tokio::select! {
2025-11-09T23:42:54.7351787Z                  result = response_rx => {
2025-11-09T23:42:54.7352405Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:392:
2025-11-09T23:42:54.7352943Z                                  .map_err(|e| bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-09T23:42:54.7353221Z                                      format!("Failed to parse FilteredBlock response: {}", e)
2025-11-09T23:42:54.7353359Z                                  ))?;
2025-11-09T23:42:54.7353489Z -                            
2025-11-09T23:42:54.7353601Z +
2025-11-09T23:42:54.7353769Z                              match parsed {
2025-11-09T23:42:54.7354058Z                                  ProtocolMessage::FilteredBlock(filtered_block_msg) => {
2025-11-09T23:42:54.7354246Z                                      // Convert to FilteredBlock
2025-11-09T23:42:54.7354923Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/health.rs:144:
2025-11-09T23:42:54.7355080Z          // Determine overall status
2025-11-09T23:42:54.7355760Z          let overall_status = if components.iter().any(|c| c.status == HealthStatus::Down) {
2025-11-09T23:42:54.7355917Z              HealthStatus::Down
2025-11-09T23:42:54.7356251Z -        } else if components.iter().any(|c| c.status == HealthStatus::Unhealthy) {
2025-11-09T23:42:54.7356405Z +        } else if components
2025-11-09T23:42:54.7356528Z +            .iter()
2025-11-09T23:42:54.7356736Z +            .any(|c| c.status == HealthStatus::Unhealthy)
2025-11-09T23:42:54.7356858Z +        {
2025-11-09T23:42:54.7357021Z              HealthStatus::Unhealthy
2025-11-09T23:42:54.7357347Z -        } else if components.iter().any(|c| c.status == HealthStatus::Degraded) {
2025-11-09T23:42:54.7357485Z +        } else if components
2025-11-09T23:42:54.7357613Z +            .iter()
2025-11-09T23:42:54.7357800Z +            .any(|c| c.status == HealthStatus::Degraded)
2025-11-09T23:42:54.7357903Z +        {
2025-11-09T23:42:54.7358051Z              HealthStatus::Degraded
2025-11-09T23:42:54.7358168Z          } else {
2025-11-09T23:42:54.7358310Z              HealthStatus::Healthy
2025-11-09T23:42:54.7358745Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/health.rs:180:
2025-11-09T23:42:54.7358870Z          Self::new()
2025-11-09T23:42:54.7358987Z      }
2025-11-09T23:42:54.7359097Z  }
2025-11-09T23:42:54.7359202Z -
2025-11-09T23:42:54.7359310Z  
2025-11-09T23:42:54.7370939Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:1:
2025-11-09T23:42:54.7371115Z  //! Mempool manager
2025-11-09T23:42:54.7371242Z -//! 
2025-11-09T23:42:54.7371358Z +//!
2025-11-09T23:42:54.7371657Z  //! Handles transaction mempool management, validation, and relay.
2025-11-09T23:42:54.7371770Z  
2025-11-09T23:42:54.7373812Z  use anyhow::Result;
2025-11-09T23:42:54.7375032Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:6:
2025-11-09T23:42:54.7375322Z -use bllvm_protocol::{Transaction, UtxoSet, Hash, OutPoint};
2025-11-09T23:42:54.7375515Z  use bllvm_protocol::mempool::Mempool;
2025-11-09T23:42:54.7375783Z +use bllvm_protocol::{Hash, OutPoint, Transaction, UtxoSet};
2025-11-09T23:42:54.7375957Z  use std::collections::{HashMap, HashSet};
2025-11-09T23:42:54.7376112Z  use tracing::{debug, info};
2025-11-09T23:42:54.7376229Z  
2025-11-09T23:42:54.7376682Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:31:
2025-11-09T23:42:54.7376858Z              spent_outputs: HashSet::new(),
2025-11-09T23:42:54.7376981Z          }
2025-11-09T23:42:54.7377359Z      }
2025-11-09T23:42:54.7377473Z -    
2025-11-09T23:42:54.7377584Z +
2025-11-09T23:42:54.7377745Z      /// Start the mempool manager
2025-11-09T23:42:54.7378103Z      pub async fn start(&mut self) -> Result<()> {
2025-11-09T23:42:54.7378273Z          info!("Starting mempool manager");
2025-11-09T23:42:54.7378745Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:38:
2025-11-09T23:42:54.7378869Z -        
2025-11-09T23:42:54.7378979Z +
2025-11-09T23:42:54.7379124Z          // Initialize mempool
2025-11-09T23:42:54.7379295Z          self.initialize_mempool().await?;
2025-11-09T23:42:54.7379409Z -        
2025-11-09T23:42:54.7379518Z +
2025-11-09T23:42:54.7379684Z          // Start mempool processing loop
2025-11-09T23:42:54.7379841Z          self.process_loop().await?;
2025-11-09T23:42:54.7379956Z -        
2025-11-09T23:42:54.7380067Z +
2025-11-09T23:42:54.7380189Z          Ok(())
2025-11-09T23:42:54.7380298Z      }
2025-11-09T23:42:54.7380418Z -    
2025-11-09T23:42:54.7380534Z +
2025-11-09T23:42:54.7380730Z      /// Run mempool processing once (for testing)
2025-11-09T23:42:54.7380956Z      pub async fn process_once(&mut self) -> Result<()> {
2025-11-09T23:42:54.7381118Z          // Process pending transactions
2025-11-09T23:42:54.7381564Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:51:
2025-11-09T23:42:54.7381746Z          self.process_pending_transactions().await?;
2025-11-09T23:42:54.7382060Z -        
2025-11-09T23:42:54.7382170Z +
2025-11-09T23:42:54.7382311Z          // Clean up old transactions
2025-11-09T23:42:54.7382477Z          self.cleanup_old_transactions().await?;
2025-11-09T23:42:54.7382592Z -        
2025-11-09T23:42:54.7382708Z +
2025-11-09T23:42:54.7382819Z          Ok(())
2025-11-09T23:42:54.7382925Z      }
2025-11-09T23:42:54.7383042Z -    
2025-11-09T23:42:54.7383152Z +
2025-11-09T23:42:54.7383284Z      /// Initialize mempool
2025-11-09T23:42:54.7383506Z      async fn initialize_mempool(&mut self) -> Result<()> {
2025-11-09T23:42:54.7383672Z          debug!("Initializing mempool");
2025-11-09T23:42:54.7384106Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:62:
2025-11-09T23:42:54.7386286Z -        
2025-11-09T23:42:54.7386409Z +
2025-11-09T23:42:54.7386622Z          // Load existing mempool from storage if available
2025-11-09T23:42:54.7386874Z          // In a real implementation, this would restore mempool state
2025-11-09T23:42:54.7386991Z -        
2025-11-09T23:42:54.7387101Z +
2025-11-09T23:42:54.7387208Z          Ok(())
2025-11-09T23:42:54.7387311Z      }
2025-11-09T23:42:54.7387420Z -    
2025-11-09T23:42:54.7387522Z +
2025-11-09T23:42:54.7387670Z      /// Main mempool processing loop
2025-11-09T23:42:54.7387871Z      async fn process_loop(&mut self) -> Result<()> {
2025-11-09T23:42:54.7388002Z          loop {
2025-11-09T23:42:54.7388450Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:72:
2025-11-09T23:42:54.7388623Z              // Process pending transactions
2025-11-09T23:42:54.7388819Z              self.process_pending_transactions().await?;
2025-11-09T23:42:54.7388932Z -            
2025-11-09T23:42:54.7389042Z +
2025-11-09T23:42:54.7389195Z              // Clean up old transactions
2025-11-09T23:42:54.7389381Z              self.cleanup_old_transactions().await?;
2025-11-09T23:42:54.7389515Z -            
2025-11-09T23:42:54.7389632Z +
2025-11-09T23:42:54.7389799Z              // Small delay to prevent busy waiting
2025-11-09T23:42:54.7390109Z              tokio::time::sleep(tokio::time::Duration::from_millis(100)).await;
2025-11-09T23:42:54.7390232Z          }
2025-11-09T23:42:54.7390686Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:81:
2025-11-09T23:42:54.7390802Z      }
2025-11-09T23:42:54.7390919Z -    
2025-11-09T23:42:54.7391028Z +
2025-11-09T23:42:54.7391192Z      /// Process pending transactions
2025-11-09T23:42:54.7391487Z      async fn process_pending_transactions(&mut self) -> Result<()> {
2025-11-09T23:42:54.7391936Z          // In a real implementation, this would:
2025-11-09T23:42:54.7401366Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:87:
2025-11-09T23:42:54.7403127Z          // 2. Validate transactions using consensus-proof
2025-11-09T23:42:54.7403306Z          // 3. Add valid transactions to mempool
2025-11-09T23:42:54.7403495Z          // 4. Relay transactions to peers
2025-11-09T23:42:54.7403623Z -        
2025-11-09T23:42:54.7403736Z +
2025-11-09T23:42:54.7403933Z          debug!("Processing pending transactions");
2025-11-09T23:42:54.7406936Z          Ok(())
2025-11-09T23:42:54.7407084Z      }
2025-11-09T23:42:54.7407563Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:94:
2025-11-09T23:42:54.7407688Z -    
2025-11-09T23:42:54.7407808Z +
2025-11-09T23:42:54.7407966Z      /// Clean up old transactions
2025-11-09T23:42:54.7408238Z      async fn cleanup_old_transactions(&mut self) -> Result<()> {
2025-11-09T23:42:54.7408437Z          // In a real implementation, this would:
2025-11-09T23:42:54.7408898Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:98:
2025-11-09T23:42:54.7409078Z          // 1. Remove transactions that are too old
2025-11-09T23:42:54.7409301Z          // 2. Remove transactions that conflict with new blocks
2025-11-09T23:42:54.7409791Z          // 3. Update transaction priorities
2025-11-09T23:42:54.7409907Z -        
2025-11-09T23:42:54.7410018Z +
2025-11-09T23:42:54.7410198Z          debug!("Cleaning up old transactions");
2025-11-09T23:42:54.7410312Z          Ok(())
2025-11-09T23:42:54.7410420Z      }
2025-11-09T23:42:54.7410874Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:105:
2025-11-09T23:42:54.7411459Z -    
2025-11-09T23:42:54.7411599Z +
2025-11-09T23:42:54.7411752Z      /// Add transaction to mempool
2025-11-09T23:42:54.7412071Z      pub async fn add_transaction(&mut self, tx: Transaction) -> Result<bool> {
2025-11-09T23:42:54.7412248Z          debug!("Adding transaction to mempool");
2025-11-09T23:42:54.7412675Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:109:
2025-11-09T23:42:54.7412794Z -        
2025-11-09T23:42:54.7412906Z +
2025-11-09T23:42:54.7413153Z          // Check for conflicts with existing mempool transactions
2025-11-09T23:42:54.7413320Z          for input in &tx.inputs {
2025-11-09T23:42:54.7413560Z              if self.spent_outputs.contains(&input.prevout) {
2025-11-09T23:42:54.7416355Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:114:
2025-11-09T23:42:54.7416513Z                  return Ok(false);
2025-11-09T23:42:54.7416635Z              }
2025-11-09T23:42:54.7416748Z          }
2025-11-09T23:42:54.7416865Z -        
2025-11-09T23:42:54.7416978Z +
2025-11-09T23:42:54.7417215Z          // Add transaction to mempool (store full transaction)
2025-11-09T23:42:54.7417441Z          use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:42:54.7417604Z          let tx_hash = calculate_tx_id(&tx);
2025-11-09T23:42:54.7418070Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:121:
2025-11-09T23:42:54.7418274Z          self.transactions.insert(tx_hash, tx.clone());
2025-11-09T23:42:54.7418423Z          self.mempool.insert(tx_hash);
2025-11-09T23:42:54.7418544Z -        
2025-11-09T23:42:54.7418662Z +
2025-11-09T23:42:54.7418796Z          // Track spent outputs
2025-11-09T23:42:54.7418932Z          for input in &tx.inputs {
2025-11-09T23:42:54.7419155Z              self.spent_outputs.insert(input.prevout.clone());
2025-11-09T23:42:54.7419603Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:127:
2025-11-09T23:42:54.7419725Z          }
2025-11-09T23:42:54.7419842Z -        
2025-11-09T23:42:54.7419949Z +
2025-11-09T23:42:54.7420068Z          Ok(true)
2025-11-09T23:42:54.7420424Z      }
2025-11-09T23:42:54.7420543Z -    
2025-11-09T23:42:54.7420655Z +
2025-11-09T23:42:54.7420795Z      /// Get mempool size
2025-11-09T23:42:54.7420936Z      pub fn size(&self) -> usize {
2025-11-09T23:42:54.7421078Z          self.transactions.len()
2025-11-09T23:42:54.7421498Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:135:
2025-11-09T23:42:54.7421607Z      }
2025-11-09T23:42:54.7421721Z -    
2025-11-09T23:42:54.7421815Z +
2025-11-09T23:42:54.7421960Z      /// Get mempool transaction hashes
2025-11-09T23:42:54.7422150Z      pub fn transaction_hashes(&self) -> Vec<Hash> {
2025-11-09T23:42:54.7422329Z          self.transactions.keys().cloned().collect()
2025-11-09T23:42:54.7422754Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:140:
2025-11-09T23:42:54.7422866Z      }
2025-11-09T23:42:54.7422983Z -    
2025-11-09T23:42:54.7423091Z +
2025-11-09T23:42:54.7423237Z      /// Get transaction by hash
2025-11-09T23:42:54.7423536Z      pub fn get_transaction(&self, hash: &Hash) -> Option<Transaction> {
2025-11-09T23:42:54.7423708Z          self.transactions.get(hash).cloned()
2025-11-09T23:42:54.7424148Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:145:
2025-11-09T23:42:54.7424265Z      }
2025-11-09T23:42:54.7424385Z -    
2025-11-09T23:42:54.7424494Z +
2025-11-09T23:42:54.7424637Z      /// Get all transactions
2025-11-09T23:42:54.7425074Z      pub fn get_transactions(&self) -> Vec<Transaction> {
2025-11-09T23:42:54.7425263Z          self.transactions.values().cloned().collect()
2025-11-09T23:42:54.7426365Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:150:
2025-11-09T23:42:54.7426507Z      }
2025-11-09T23:42:54.7426628Z -    
2025-11-09T23:42:54.7426741Z +
2025-11-09T23:42:54.7426936Z      /// Get prioritized transactions by fee rate
2025-11-09T23:42:54.7427062Z -    /// 
2025-11-09T23:42:54.7427177Z +    ///
2025-11-09T23:42:54.7427591Z      /// Returns transactions sorted by fee rate (satoshis per vbyte) in descending order.
2025-11-09T23:42:54.7428205Z      /// Requires UTXO set to calculate fee rates.
2025-11-09T23:42:54.7428710Z -    pub fn get_prioritized_transactions(&self, limit: usize, utxo_set: &UtxoSet) -> Vec<Transaction> {
2025-11-09T23:42:54.7428890Z +    pub fn get_prioritized_transactions(
2025-11-09T23:42:54.7429008Z +        &self,
2025-11-09T23:42:54.7429153Z +        limit: usize,
2025-11-09T23:42:54.7429285Z +        utxo_set: &UtxoSet,
2025-11-09T23:42:54.7429424Z +    ) -> Vec<Transaction> {
2025-11-09T23:42:54.7429680Z          let mut tx_with_fees: Vec<(Transaction, u64)> = Vec::new();
2025-11-09T23:42:54.7429805Z -        
2025-11-09T23:42:54.7429914Z +
2025-11-09T23:42:54.7430092Z          for tx in self.transactions.values() {
2025-11-09T23:42:54.7430266Z              // Calculate fee for this transaction
2025-11-09T23:42:54.7430499Z              let fee = self.calculate_transaction_fee(tx, utxo_set);
2025-11-09T23:42:54.7430947Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:162:
2025-11-09T23:42:54.7431065Z -            
2025-11-09T23:42:54.7431174Z +
2025-11-09T23:42:54.7431525Z              // Calculate transaction size (simplified - use serialized size estimate)
2025-11-09T23:42:54.7431725Z              let size = self.estimate_transaction_size(tx);
2025-11-09T23:42:54.7431846Z -            
2025-11-09T23:42:54.7431961Z +
2025-11-09T23:42:54.7432138Z              // Calculate fee rate (satoshis per vbyte)
2025-11-09T23:42:54.7432294Z              let fee_rate = if size > 0 {
2025-11-09T23:42:54.7432673Z                  fee * 1000 / size as u64 // Convert to satoshis per vbyte (multiply by 1000 for precision)
2025-11-09T23:42:54.7433136Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:169:
2025-11-09T23:42:54.7433258Z              } else {
2025-11-09T23:42:54.7433381Z                  0
2025-11-09T23:42:54.7433497Z              };
2025-11-09T23:42:54.7433870Z -            
2025-11-09T23:42:54.7433991Z +
2025-11-09T23:42:54.7434176Z              tx_with_fees.push((tx.clone(), fee_rate));
2025-11-09T23:42:54.7436314Z          }
2025-11-09T23:42:54.7436441Z -        
2025-11-09T23:42:54.7436561Z +
2025-11-09T23:42:54.7436720Z          // Sort by fee rate (descending)
2025-11-09T23:42:54.7436908Z          tx_with_fees.sort_by(|a, b| b.1.cmp(&a.1));
2025-11-09T23:42:54.7437043Z -        
2025-11-09T23:42:54.7437154Z +
2025-11-09T23:42:54.7437308Z          // Return top N transactions
2025-11-09T23:42:54.7437451Z -        tx_with_fees.into_iter()
2025-11-09T23:42:54.7437580Z +        tx_with_fees
2025-11-09T23:42:54.7437710Z +            .into_iter()
2025-11-09T23:42:54.7437836Z              .take(limit)
2025-11-09T23:42:54.7437977Z              .map(|(tx, _)| tx)
2025-11-09T23:42:54.7438100Z              .collect()
2025-11-09T23:42:54.7438563Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:184:
2025-11-09T23:42:54.7438690Z      }
2025-11-09T23:42:54.7438808Z -    
2025-11-09T23:42:54.7438920Z +
2025-11-09T23:42:54.7439071Z      /// Calculate transaction fee
2025-11-09T23:42:54.7439193Z -    /// 
2025-11-09T23:42:54.7439306Z +    ///
2025-11-09T23:42:54.7439479Z      /// Fee = sum of inputs - sum of outputs
2025-11-09T23:42:54.7439885Z      pub fn calculate_transaction_fee(&self, tx: &Transaction, utxo_set: &UtxoSet) -> u64 {
2025-11-09T23:42:54.7440287Z          let mut input_total = 0u64;
2025-11-09T23:42:54.7440763Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:191:
2025-11-09T23:42:54.7440881Z -        
2025-11-09T23:42:54.7440998Z +
2025-11-09T23:42:54.7441157Z          // Sum input values from UTXO set
2025-11-09T23:42:54.7441303Z          for input in &tx.inputs {
2025-11-09T23:42:54.7441517Z              if let Some(utxo) = utxo_set.get(&input.prevout) {
2025-11-09T23:42:54.7441983Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:195:
2025-11-09T23:42:54.7442167Z                  input_total += utxo.value as u64;
2025-11-09T23:42:54.7442280Z              }
2025-11-09T23:42:54.7442399Z          }
2025-11-09T23:42:54.7442513Z -        
2025-11-09T23:42:54.7442620Z +
2025-11-09T23:42:54.7442759Z          // Sum output values
2025-11-09T23:42:54.7443091Z          let output_total: u64 = tx.outputs.iter().map(|out| out.value as u64).sum();
2025-11-09T23:42:54.7443220Z -        
2025-11-09T23:42:54.7443328Z +
2025-11-09T23:42:54.7443511Z          // Fee is difference (inputs - outputs)
2025-11-09T23:42:54.7443667Z          if input_total > output_total {
2025-11-09T23:42:54.7443820Z              input_total - output_total
2025-11-09T23:42:54.7444468Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:206:
2025-11-09T23:42:54.7446439Z              0
2025-11-09T23:42:54.7446552Z          }
2025-11-09T23:42:54.7446666Z      }
2025-11-09T23:42:54.7446781Z -    
2025-11-09T23:42:54.7446900Z +
2025-11-09T23:42:54.7447071Z      /// Estimate transaction size in vbytes
2025-11-09T23:42:54.7447193Z -    /// 
2025-11-09T23:42:54.7447302Z +    ///
2025-11-09T23:42:54.7447656Z      /// Simplified estimation - in production, would use actual serialized size
2025-11-09T23:42:54.7447952Z      fn estimate_transaction_size(&self, tx: &Transaction) -> usize {
2025-11-09T23:42:54.7448223Z          // Base transaction size: version (4) + locktime (4) = 8 bytes
2025-11-09T23:42:54.7448690Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:215:
2025-11-09T23:42:54.7448827Z          let mut size = 8;
2025-11-09T23:42:54.7448950Z -        
2025-11-09T23:42:54.7449059Z +
2025-11-09T23:42:54.7449315Z          // Input size: prevout (36) + script_sig (var) + sequence (4)
2025-11-09T23:42:54.7449471Z          for input in &tx.inputs {
2025-11-09T23:42:54.7449617Z              size += 36; // prevout
2025-11-09T23:42:54.7450066Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:220:
2025-11-09T23:42:54.7450485Z              size += input.script_sig.len();
2025-11-09T23:42:54.7450631Z              size += 4; // sequence
2025-11-09T23:42:54.7450743Z          }
2025-11-09T23:42:54.7450853Z -        
2025-11-09T23:42:54.7450961Z +
2025-11-09T23:42:54.7451166Z          // Output size: value (8) + script_pubkey (var)
2025-11-09T23:42:54.7451320Z          for output in &tx.outputs {
2025-11-09T23:42:54.7451462Z              size += 8; // value
2025-11-09T23:42:54.7451918Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:227:
2025-11-09T23:42:54.7452094Z              size += output.script_pubkey.len();
2025-11-09T23:42:54.7452205Z          }
2025-11-09T23:42:54.7452322Z -        
2025-11-09T23:42:54.7452431Z +
2025-11-09T23:42:54.7452773Z          // Add witness discount if segwit (simplified - assume no witness for now)
2025-11-09T23:42:54.7452895Z          size
2025-11-09T23:42:54.7453013Z      }
2025-11-09T23:42:54.7453478Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:233:
2025-11-09T23:42:54.7453593Z -    
2025-11-09T23:42:54.7453711Z +
2025-11-09T23:42:54.7453873Z      /// Remove transaction from mempool
2025-11-09T23:42:54.7454127Z      pub fn remove_transaction(&mut self, hash: &Hash) -> bool {
2025-11-09T23:42:54.7454575Z          if let Some(tx) = self.transactions.remove(hash) {
2025-11-09T23:42:54.7455296Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:237:
2025-11-09T23:42:54.7455461Z              self.mempool.remove(hash);
2025-11-09T23:42:54.7455575Z -            
2025-11-09T23:42:54.7455694Z +
2025-11-09T23:42:54.7455861Z              // Remove spent outputs tracking
2025-11-09T23:42:54.7456012Z              for input in &tx.inputs {
2025-11-09T23:42:54.7456216Z                  self.spent_outputs.remove(&input.prevout);
2025-11-09T23:42:54.7456686Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:242:
2025-11-09T23:42:54.7456816Z              }
2025-11-09T23:42:54.7456928Z -            
2025-11-09T23:42:54.7457049Z +
2025-11-09T23:42:54.7457164Z              true
2025-11-09T23:42:54.7457276Z          } else {
2025-11-09T23:42:54.7457393Z              false
2025-11-09T23:42:54.7457860Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:247:
2025-11-09T23:42:54.7457976Z          }
2025-11-09T23:42:54.7458097Z      }
2025-11-09T23:42:54.7458213Z -    
2025-11-09T23:42:54.7458324Z +
2025-11-09T23:42:54.7458451Z      /// Clear mempool
2025-11-09T23:42:54.7458596Z      pub fn clear(&mut self) {
2025-11-09T23:42:54.7458756Z          self.transactions.clear();
2025-11-09T23:42:54.7459219Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:253:
2025-11-09T23:42:54.7459367Z          self.mempool.clear();
2025-11-09T23:42:54.7459529Z          self.spent_outputs.clear();
2025-11-09T23:42:54.7459644Z      }
2025-11-09T23:42:54.7459763Z -    
2025-11-09T23:42:54.7459872Z +
2025-11-09T23:42:54.7460055Z      /// Save mempool to disk for persistence
2025-11-09T23:42:54.7460420Z      pub fn save_to_disk<P: AsRef<std::path::Path>>(&self, path: P) -> Result<()> {
2025-11-09T23:42:54.7460763Z +        use bllvm_protocol::serialization::transaction::serialize_transaction;
2025-11-09T23:42:54.7460908Z          use std::fs::File;
2025-11-09T23:42:54.7461047Z          use std::io::Write;
2025-11-09T23:42:54.7461395Z -        use bllvm_protocol::serialization::transaction::serialize_transaction;
2025-11-09T23:42:54.7461520Z -        
2025-11-09T23:42:54.7461632Z +
2025-11-09T23:42:54.7461826Z          let transactions = self.get_transactions();
2025-11-09T23:42:54.7462001Z          let mut file = File::create(path)?;
2025-11-09T23:42:54.7462119Z -        
2025-11-09T23:42:54.7462225Z +
2025-11-09T23:42:54.7462369Z          // Write transaction count
2025-11-09T23:42:54.7462636Z          file.write_all(&(transactions.len() as u32).to_le_bytes())?;
2025-11-09T23:42:54.7463039Z -        
2025-11-09T23:42:54.7463152Z +
2025-11-09T23:42:54.7463300Z          // Write each transaction
2025-11-09T23:42:54.7463448Z          for tx in transactions {
2025-11-09T23:42:54.7463642Z              let serialized = serialize_transaction(&tx);
2025-11-09T23:42:54.7464102Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:272:
2025-11-09T23:42:54.7464543Z              file.write_all(&(serialized.len() as u32).to_le_bytes())?;
2025-11-09T23:42:54.7464710Z              file.write_all(&serialized)?;
2025-11-09T23:42:54.7464823Z          }
2025-11-09T23:42:54.7464932Z -        
2025-11-09T23:42:54.7466934Z +
2025-11-09T23:42:54.7467067Z          file.sync_all()?;
2025-11-09T23:42:54.7467184Z          Ok(())
2025-11-09T23:42:54.7467305Z      }
2025-11-09T23:42:54.7467762Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:279:
2025-11-09T23:42:54.7467873Z  }
2025-11-09T23:42:54.7467981Z  
2025-11-09T23:42:54.7468155Z  impl Default for MempoolManager {
2025-11-09T23:42:54.7468331Z -    fn default() -> Self { Self::new() }
2025-11-09T23:42:54.7468472Z +    fn default() -> Self {
2025-11-09T23:42:54.7468602Z +        Self::new()
2025-11-09T23:42:54.7468712Z +    }
2025-11-09T23:42:54.7468822Z  }
2025-11-09T23:42:54.7468932Z  
2025-11-09T23:42:54.7469294Z  // Implement MempoolProvider trait for integration with MiningCoordinator
2025-11-09T23:42:54.7469988Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:298:
2025-11-09T23:42:54.7470118Z          self.size()
2025-11-09T23:42:54.7470242Z      }
2025-11-09T23:42:54.7470352Z  
2025-11-09T23:42:54.7470993Z -    fn get_prioritized_transactions(&self, limit: usize, utxo_set: &bllvm_protocol::UtxoSet) -> Vec<bllvm_protocol::Transaction> {
2025-11-09T23:42:54.7471165Z +    fn get_prioritized_transactions(
2025-11-09T23:42:54.7471279Z +        &self,
2025-11-09T23:42:54.7471403Z +        limit: usize,
2025-11-09T23:42:54.7471587Z +        utxo_set: &bllvm_protocol::UtxoSet,
2025-11-09T23:42:54.7471765Z +    ) -> Vec<bllvm_protocol::Transaction> {
2025-11-09T23:42:54.7471986Z          self.get_prioritized_transactions(limit, utxo_set)
2025-11-09T23:42:54.7472101Z      }
2025-11-09T23:42:54.7472217Z  
2025-11-09T23:42:54.7472674Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:312:
2025-11-09T23:42:54.7472827Z  impl MempoolManager {
2025-11-09T23:42:54.7472972Z      /// Load mempool from disk
2025-11-09T23:42:54.7473352Z      pub fn load_from_disk<P: AsRef<std::path::Path>>(&mut self, path: P) -> Result<()> {
2025-11-09T23:42:54.7473708Z +        use bllvm_protocol::serialization::transaction::deserialize_transaction;
2025-11-09T23:42:54.7473851Z          use std::fs::File;
2025-11-09T23:42:54.7473998Z          use std::io::Read;
2025-11-09T23:42:54.7474513Z -        use bllvm_protocol::serialization::transaction::deserialize_transaction;
2025-11-09T23:42:54.7474636Z -        
2025-11-09T23:42:54.7476612Z +
2025-11-09T23:42:54.7476779Z          let mut file = File::open(path)?;
2025-11-09T23:42:54.7476934Z          let mut count_bytes = [0u8; 4];
2025-11-09T23:42:54.7477094Z          file.read_exact(&mut count_bytes)?;
2025-11-09T23:42:54.7477549Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:322:
2025-11-09T23:42:54.7477766Z          let count = u32::from_le_bytes(count_bytes) as usize;
2025-11-09T23:42:54.7477886Z -        
2025-11-09T23:42:54.7477999Z +
2025-11-09T23:42:54.7478128Z          for _ in 0..count {
2025-11-09T23:42:54.7478273Z              let mut len_bytes = [0u8; 4];
2025-11-09T23:42:54.7478430Z              file.read_exact(&mut len_bytes)?;
2025-11-09T23:42:54.7478880Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:327:
2025-11-09T23:42:54.7479089Z              let len = u32::from_le_bytes(len_bytes) as usize;
2025-11-09T23:42:54.7479196Z -            
2025-11-09T23:42:54.7479303Z +
2025-11-09T23:42:54.7479664Z              let mut tx_bytes = vec![0u8; len];
2025-11-09T23:42:54.7479811Z              file.read_exact(&mut tx_bytes)?;
2025-11-09T23:42:54.7479922Z -            
2025-11-09T23:42:54.7480023Z +
2025-11-09T23:42:54.7480206Z              let tx = deserialize_transaction(&tx_bytes)?;
2025-11-09T23:42:54.7480353Z              let _ = self.add_transaction(tx);
2025-11-09T23:42:54.7480463Z          }
2025-11-09T23:42:54.7480895Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:335:
2025-11-09T23:42:54.7480999Z -        
2025-11-09T23:42:54.7481108Z +
2025-11-09T23:42:54.7481215Z          Ok(())
2025-11-09T23:42:54.7481319Z      }
2025-11-09T23:42:54.7481421Z  }
2025-11-09T23:42:54.7481887Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/metrics.rs:2:
2025-11-09T23:42:54.7481995Z  //!
2025-11-09T23:42:54.7482398Z  //! Provides comprehensive metrics for monitoring node health, performance, and behavior.
2025-11-09T23:42:54.7482515Z  
2025-11-09T23:42:54.7482670Z +use serde::{Deserialize, Serialize};
2025-11-09T23:42:54.7482791Z  use std::sync::Arc;
2025-11-09T23:42:54.7482920Z  use std::sync::Mutex;
2025-11-09T23:42:54.7483113Z  use std::time::{Duration, SystemTime, UNIX_EPOCH};
2025-11-09T23:42:54.7483526Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/metrics.rs:8:
2025-11-09T23:42:54.7483677Z -use serde::{Deserialize, Serialize};
2025-11-09T23:42:54.7484040Z  
2025-11-09T23:42:54.7484179Z  /// Comprehensive node metrics
2025-11-09T23:42:54.7484575Z  #[derive(Debug, Clone, Serialize, Deserialize)]
2025-11-09T23:42:54.7485011Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/metrics.rs:251:
2025-11-09T23:42:54.7485143Z          Self::new()
2025-11-09T23:42:54.7485260Z      }
2025-11-09T23:42:54.7485376Z  }
2025-11-09T23:42:54.7485486Z -
2025-11-09T23:42:54.7485590Z  
2025-11-09T23:42:54.7519534Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/miner.rs:20:
2025-11-09T23:42:54.7519758Z  
2025-11-09T23:42:54.7519964Z      /// Get prioritized transactions (by fee rate)
2025-11-09T23:42:54.7520185Z      /// Requires UTXO set for accurate fee calculation
2025-11-09T23:42:54.7520714Z -    fn get_prioritized_transactions(&self, limit: usize, utxo_set: &bllvm_protocol::UtxoSet) -> Vec<Transaction>;
2025-11-09T23:42:54.7520881Z +    fn get_prioritized_transactions(
2025-11-09T23:42:54.7521010Z +        &self,
2025-11-09T23:42:54.7521137Z +        limit: usize,
2025-11-09T23:42:54.7521306Z +        utxo_set: &bllvm_protocol::UtxoSet,
2025-11-09T23:42:54.7521444Z +    ) -> Vec<Transaction>;
2025-11-09T23:42:54.7521567Z  
2025-11-09T23:42:54.7521724Z      /// Remove transaction from mempool
2025-11-09T23:42:54.7521968Z      fn remove_transaction(&mut self, hash: &[u8; 32]) -> bool;
2025-11-09T23:42:54.7522420Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/miner.rs:57:
2025-11-09T23:42:54.7522541Z  
2025-11-09T23:42:54.7522706Z      /// Select transactions for block
2025-11-09T23:42:54.7523022Z      /// Note: Requires UTXO set for fee calculation - caller must provide it
2025-11-09T23:42:54.7523661Z -    pub fn select_transactions(&self, mempool: &dyn MempoolProvider, utxo_set: &bllvm_protocol::UtxoSet) -> Vec<Transaction> {
2025-11-09T23:42:54.7523818Z +    pub fn select_transactions(
2025-11-09T23:42:54.7523937Z +        &self,
2025-11-09T23:42:54.7524113Z +        mempool: &dyn MempoolProvider,
2025-11-09T23:42:54.7524547Z +        utxo_set: &bllvm_protocol::UtxoSet,
2025-11-09T23:42:54.7524713Z +    ) -> Vec<Transaction> {
2025-11-09T23:42:54.7524874Z          let mut selected = Vec::new();
2025-11-09T23:42:54.7525018Z          let mut current_size = 0;
2025-11-09T23:42:54.7525159Z          let mut current_weight = 0;
2025-11-09T23:42:54.7525606Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/miner.rs:392:
2025-11-09T23:42:54.7525723Z  
2025-11-09T23:42:54.7525987Z          // Get chain tip from storage for prev_block_hash and difficulty
2025-11-09T23:42:54.7526588Z          let (prev_block_hash, bits, height) = if let Some(ref storage) = self.storage {
2025-11-09T23:42:54.7526832Z -            if let Some(tip_header) = storage.chain().get_tip_header()
2025-11-09T23:42:54.7527127Z -                .map_err(|e| anyhow::anyhow!("Failed to get tip header: {}", e))? {
2025-11-09T23:42:54.7527329Z -                let tip_hash = storage.chain().get_tip_hash()
2025-11-09T23:42:54.7527507Z +            if let Some(tip_header) = storage
2025-11-09T23:42:54.7527641Z +                .chain()
2025-11-09T23:42:54.7527781Z +                .get_tip_header()
2025-11-09T23:42:54.7528059Z +                .map_err(|e| anyhow::anyhow!("Failed to get tip header: {}", e))?
2025-11-09T23:42:54.7528180Z +            {
2025-11-09T23:42:54.7528325Z +                let tip_hash = storage
2025-11-09T23:42:54.7528451Z +                    .chain()
2025-11-09T23:42:54.7528589Z +                    .get_tip_hash()
2025-11-09T23:42:54.7528870Z                      .map_err(|e| anyhow::anyhow!("Failed to get tip hash: {}", e))?
2025-11-09T23:42:54.7529014Z                      .unwrap_or([0u8; 32]);
2025-11-09T23:42:54.7529221Z -                let chain_height = storage.chain().get_height()
2025-11-09T23:42:54.7529382Z +                let chain_height = storage
2025-11-09T23:42:54.7529511Z +                    .chain()
2025-11-09T23:42:54.7529647Z +                    .get_height()
2025-11-09T23:42:54.7530192Z                      .map_err(|e| anyhow::anyhow!("Failed to get chain height: {}", e))?
2025-11-09T23:42:54.7530330Z                      .unwrap_or(0);
2025-11-09T23:42:54.7530514Z                  (tip_hash, tip_header.bits, chain_height)
2025-11-09T23:42:54.7530962Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/miner.rs:412:
2025-11-09T23:42:54.7531086Z  
2025-11-09T23:42:54.7531290Z          // Get UTXO set from storage for fee calculation
2025-11-09T23:42:54.7531526Z          let utxo_set = if let Some(ref storage) = self.storage {
2025-11-09T23:42:54.7531710Z -            storage.utxos().get_all_utxos()
2025-11-09T23:42:54.7531834Z +            storage
2025-11-09T23:42:54.7531960Z +                .utxos()
2025-11-09T23:42:54.7532094Z +                .get_all_utxos()
2025-11-09T23:42:54.7532370Z                  .map_err(|e| anyhow::anyhow!("Failed to get UTXO set: {}", e))?
2025-11-09T23:42:54.7532490Z          } else {
2025-11-09T23:42:54.7532739Z              // No storage - use empty UTXO set (will result in 0 fees)
2025-11-09T23:42:54.7533189Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/miner.rs:616:
2025-11-09T23:42:54.7533343Z          self.transactions.len()
2025-11-09T23:42:54.7533456Z      }
2025-11-09T23:42:54.7533577Z  
2025-11-09T23:42:54.7534120Z -    fn get_prioritized_transactions(&self, limit: usize, _utxo_set: &bllvm_protocol::UtxoSet) -> Vec<Transaction> {
2025-11-09T23:42:54.7534573Z +    fn get_prioritized_transactions(
2025-11-09T23:42:54.7534722Z +        &self,
2025-11-09T23:42:54.7534855Z +        limit: usize,
2025-11-09T23:42:54.7535035Z +        _utxo_set: &bllvm_protocol::UtxoSet,
2025-11-09T23:42:54.7535172Z +    ) -> Vec<Transaction> {
2025-11-09T23:42:54.7535532Z          // Mock implementation ignores UTXO set and uses pre-calculated priorities
2025-11-09T23:42:54.7535698Z          self.prioritized_transactions
2025-11-09T23:42:54.7535819Z              .iter()
2025-11-09T23:42:54.7536275Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/miner.rs:786:
2025-11-09T23:42:54.7536474Z          assert_eq!(mempool.get_mempool_size(), 0);
2025-11-09T23:42:54.7536682Z          assert!(mempool.get_transactions().is_empty());
2025-11-09T23:42:54.7536913Z          let empty_utxo_set = bllvm_protocol::UtxoSet::new();
2025-11-09T23:42:54.7537292Z -        assert!(mempool.get_prioritized_transactions(10, &empty_utxo_set).is_empty());
2025-11-09T23:42:54.7537427Z +        assert!(mempool
2025-11-09T23:42:54.7537902Z +            .get_prioritized_transactions(10, &empty_utxo_set)
2025-11-09T23:42:54.7538045Z +            .is_empty());
2025-11-09T23:42:54.7538157Z      }
2025-11-09T23:42:54.7538260Z  
2025-11-09T23:42:54.7538365Z      #[test]
2025-11-09T23:42:54.7635432Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:5:
2025-11-09T23:42:54.7635611Z  
2025-11-09T23:42:54.7635767Z  pub mod block_processor;
2025-11-09T23:42:54.7635925Z  pub mod event_publisher;
2025-11-09T23:42:54.7636050Z +pub mod health;
2025-11-09T23:42:54.7636176Z  pub mod mempool;
2025-11-09T23:42:54.7636310Z -pub mod miner;
2025-11-09T23:42:54.7636430Z -pub mod sync;
2025-11-09T23:42:54.7636555Z  pub mod metrics;
2025-11-09T23:42:54.7636676Z -pub mod health;
2025-11-09T23:42:54.7636804Z +pub mod miner;
2025-11-09T23:42:54.7636935Z  pub mod performance;
2025-11-09T23:42:54.7637052Z +pub mod sync;
2025-11-09T23:42:54.7637167Z  
2025-11-09T23:42:54.7637310Z  use anyhow::Result;
2025-11-09T23:42:54.7637447Z  use std::net::SocketAddr;
2025-11-09T23:42:54.7638722Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:70:
2025-11-09T23:42:54.7638839Z  
2025-11-09T23:42:54.7638980Z          // Initialize components
2025-11-09T23:42:54.7639338Z          let protocol_version = protocol_version.unwrap_or(ProtocolVersion::Regtest);
2025-11-09T23:42:54.7639470Z -        let protocol =
2025-11-09T23:42:54.7639692Z -            BitcoinProtocolEngine::new(protocol_version)?;
2025-11-09T23:42:54.7640229Z +        let protocol = BitcoinProtocolEngine::new(protocol_version)?;
2025-11-09T23:42:54.7640419Z          let protocol_arc = Arc::new(protocol);
2025-11-09T23:42:54.7640594Z          let storage = Storage::new(data_dir)?;
2025-11-09T23:42:54.7640762Z          let storage_arc = Arc::new(storage);
2025-11-09T23:42:54.7641187Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:78:
2025-11-09T23:42:54.7641505Z          let mempool_manager_arc = Arc::new(mempool::MempoolManager::new());
2025-11-09T23:42:54.7641727Z -        let network = NetworkManager::new(network_addr)
2025-11-09T23:42:54.7642253Z -            .with_dependencies(Arc::clone(&protocol_arc), Arc::clone(&storage_arc), Arc::clone(&mempool_manager_arc));
2025-11-09T23:42:54.7642590Z +        let network = NetworkManager::new(network_addr).with_dependencies(
2025-11-09T23:42:54.7642756Z +            Arc::clone(&protocol_arc),
2025-11-09T23:42:54.7642923Z +            Arc::clone(&storage_arc),
2025-11-09T23:42:54.7643105Z +            Arc::clone(&mempool_manager_arc),
2025-11-09T23:42:54.7643222Z +        );
2025-11-09T23:42:54.7643389Z          let network_arc = Arc::new(network);
2025-11-09T23:42:54.7643632Z          let metrics_arc = Arc::new(MetricsCollector::new());
2025-11-09T23:42:54.7643916Z          let profiler_arc = Arc::new(PerformanceProfiler::new(1000));
2025-11-09T23:42:54.7644594Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:187:
2025-11-09T23:42:54.7644809Z          info!("Sync coordinator initialized");
2025-11-09T23:42:54.7644984Z          info!("Mempool manager initialized");
2025-11-09T23:42:54.7645333Z          info!("Mining coordinator initialized");
2025-11-09T23:42:54.7645449Z -        
2025-11-09T23:42:54.7645570Z +
2025-11-09T23:42:54.7645713Z          // Start network manager
2025-11-09T23:42:54.7645978Z          if let Err(e) = self.network.start(self.network_addr).await {
2025-11-09T23:42:54.7646209Z              warn!("Failed to start network manager: {}", e);
2025-11-09T23:42:54.7646654Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:194:
2025-11-09T23:42:54.7646856Z              // Continue anyway - network might be optional
2025-11-09T23:42:54.7646975Z          }
2025-11-09T23:42:54.7647086Z -        
2025-11-09T23:42:54.7647195Z +
2025-11-09T23:42:54.7647392Z          // Initialize peer connections automatically
2025-11-09T23:42:54.7647584Z          self.initialize_peer_connections().await?;
2025-11-09T23:42:54.7647980Z  
2025-11-09T23:42:54.7648425Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:203:
2025-11-09T23:42:54.7648594Z              if config.prune_on_startup {
2025-11-09T23:42:54.7648915Z                  let current_height = self.storage.chain().get_height()?.unwrap_or(0);
2025-11-09T23:42:54.7649080Z                  let is_ibd = current_height == 0;
2025-11-09T23:42:54.7649195Z -                
2025-11-09T23:42:54.7649319Z +
2025-11-09T23:42:54.7649513Z                  if !is_ibd && pruning_manager.is_enabled() {
2025-11-09T23:42:54.7649824Z                      info!("Prune on startup enabled, checking if pruning is needed...");
2025-11-09T23:42:54.7649950Z -                    
2025-11-09T23:42:54.7650058Z +
2025-11-09T23:42:54.7650279Z                      // Calculate prune height based on configuration
2025-11-09T23:42:54.7650471Z                      let prune_height = match &config.mode {
2025-11-09T23:42:54.7650698Z                          crate::config::PruningMode::Disabled => {
2025-11-09T23:42:54.7651151Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:213:
2025-11-09T23:42:54.7651308Z                              // Skip if disabled
2025-11-09T23:42:54.7651444Z                              None
2025-11-09T23:42:54.7651560Z                          }
2025-11-09T23:42:54.7651853Z -                        crate::config::PruningMode::Normal { keep_from_height, .. } => {
2025-11-09T23:42:54.7652241Z +                        crate::config::PruningMode::Normal {
2025-11-09T23:42:54.7652390Z +                            keep_from_height, ..
2025-11-09T23:42:54.7652510Z +                        } => {
2025-11-09T23:42:54.7652685Z                              // Prune up to keep_from_height
2025-11-09T23:42:54.7652843Z                              Some(*keep_from_height)
2025-11-09T23:42:54.7652976Z                          }
2025-11-09T23:42:54.7653387Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:220:
2025-11-09T23:42:54.7653566Z                          #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.7653875Z -                        crate::config::PruningMode::Aggressive { keep_from_height, .. } => {
2025-11-09T23:42:54.7654061Z +                        crate::config::PruningMode::Aggressive {
2025-11-09T23:42:54.7654212Z +                            keep_from_height, ..
2025-11-09T23:42:54.7654518Z +                        } => {
2025-11-09T23:42:54.7654699Z                              // Prune up to keep_from_height
2025-11-09T23:42:54.7654854Z                              Some(*keep_from_height)
2025-11-09T23:42:54.7654989Z                          }
2025-11-09T23:42:54.7655423Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:228:
2025-11-09T23:42:54.7655634Z                              // Fall back to no pruning if feature is disabled
2025-11-09T23:42:54.7655763Z                              None
2025-11-09T23:42:54.7655877Z                          }
2025-11-09T23:42:54.7656221Z -                        crate::config::PruningMode::Custom { keep_bodies_from_height, .. } => {
2025-11-09T23:42:54.7656416Z +                        crate::config::PruningMode::Custom {
2025-11-09T23:42:54.7656577Z +                            keep_bodies_from_height,
2025-11-09T23:42:54.7656699Z +                            ..
2025-11-09T23:42:54.7656817Z +                        } => {
2025-11-09T23:42:54.7657027Z                              // Prune up to keep_bodies_from_height
2025-11-09T23:42:54.7657198Z                              Some(*keep_bodies_from_height)
2025-11-09T23:42:54.7657317Z                          }
2025-11-09T23:42:54.7657754Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:235:
2025-11-09T23:42:54.7657875Z                      };
2025-11-09T23:42:54.7657992Z -                    
2025-11-09T23:42:54.7658115Z +
2025-11-09T23:42:54.7658324Z                      if let Some(prune_to_height) = prune_height {
2025-11-09T23:42:54.7658769Z                          if prune_to_height < current_height {
2025-11-09T23:42:54.7659192Z -                            match pruning_manager.prune_to_height(prune_to_height, current_height, is_ibd) {
2025-11-09T23:42:54.7659402Z +                            match pruning_manager.prune_to_height(
2025-11-09T23:42:54.7659558Z +                                prune_to_height,
2025-11-09T23:42:54.7659719Z +                                current_height,
2025-11-09T23:42:54.7659863Z +                                is_ibd,
2025-11-09T23:42:54.7659993Z +                            ) {
2025-11-09T23:42:54.7660142Z                                  Ok(stats) => {
2025-11-09T23:42:54.7660482Z                                      info!("Startup pruning completed: {} blocks pruned, {} blocks kept", 
2025-11-09T23:42:54.7660711Z                                            stats.blocks_pruned, stats.blocks_kept);
2025-11-09T23:42:54.7661154Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:243:
2025-11-09T23:42:54.7661374Z                                      // Flush storage to persist pruning changes
2025-11-09T23:42:54.7661576Z                                      if let Err(e) = self.storage.flush() {
2025-11-09T23:42:54.7661875Z -                                        warn!("Failed to flush storage after startup pruning: {}", e);
2025-11-09T23:42:54.7662015Z +                                        warn!(
2025-11-09T23:42:54.7662512Z +                                            "Failed to flush storage after startup pruning: {}",
2025-11-09T23:42:54.7662656Z +                                            e
2025-11-09T23:42:54.7662785Z +                                        );
2025-11-09T23:42:54.7662920Z                                      }
2025-11-09T23:42:54.7663043Z                                  }
2025-11-09T23:42:54.7663186Z                                  Err(e) => {
2025-11-09T23:42:54.7663615Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:292:
2025-11-09T23:42:54.7663743Z      }
2025-11-09T23:42:54.7663848Z  
2025-11-09T23:42:54.7664034Z      /// Initialize peer connections automatically
2025-11-09T23:42:54.7664150Z -    /// 
2025-11-09T23:42:54.7664263Z +    ///
2025-11-09T23:42:54.7664776Z      /// Determines network type from protocol version and uses config if available.
2025-11-09T23:42:54.7665042Z      async fn initialize_peer_connections(&self) -> Result<()> {
2025-11-09T23:42:54.7665259Z          // Determine network type from protocol version
2025-11-09T23:42:54.7665675Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:306:
2025-11-09T23:42:54.7665854Z                  if let Some(ref config) = self.config {
2025-11-09T23:42:54.7666133Z                      if let Some(ref persistent_peers) = config.persistent_peers {
2025-11-09T23:42:54.7666816Z                          if !persistent_peers.is_empty() {
2025-11-09T23:42:54.7667224Z -                            if let Err(e) = self.network.connect_persistent_peers(persistent_peers).await {
2025-11-09T23:42:54.7667387Z +                            if let Err(e) = self
2025-11-09T23:42:54.7667521Z +                                .network
2025-11-09T23:42:54.7667741Z +                                .connect_persistent_peers(persistent_peers)
2025-11-09T23:42:54.7667889Z +                                .await
2025-11-09T23:42:54.7668021Z +                            {
2025-11-09T23:42:54.7668301Z                                  warn!("Failed to connect to some persistent peers: {}", e);
2025-11-09T23:42:54.7668427Z                              }
2025-11-09T23:42:54.7668557Z                          }
2025-11-09T23:42:54.7668986Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:315:
2025-11-09T23:42:54.7669119Z                  return Ok(());
2025-11-09T23:42:54.7669243Z              }
2025-11-09T23:42:54.7669358Z          };
2025-11-09T23:42:54.7669474Z -        
2025-11-09T23:42:54.7669822Z +
2025-11-09T23:42:54.7669978Z          // Get port from network address
2025-11-09T23:42:54.7670148Z          let port = self.network_addr.port();
2025-11-09T23:42:54.7670264Z -        
2025-11-09T23:42:54.7670380Z +
2025-11-09T23:42:54.7670707Z          // Default target peer count (Bitcoin Core uses 8-125, we'll use 8 as default)
2025-11-09T23:42:54.7670840Z          let target_peer_count = 8;
2025-11-09T23:42:54.7670962Z -        
2025-11-09T23:42:54.7671079Z +
2025-11-09T23:42:54.7671285Z          // Use config if available, otherwise use defaults
2025-11-09T23:42:54.7671443Z          let default_config = NodeConfig {
2025-11-09T23:42:54.7671615Z              listen_addr: Some(self.network_addr),
2025-11-09T23:42:54.7673924Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:328:
2025-11-09T23:42:54.7674081Z              ..Default::default()
2025-11-09T23:42:54.7674195Z          };
2025-11-09T23:42:54.7674598Z          let config = self.config.as_ref().unwrap_or(&default_config);
2025-11-09T23:42:54.7674721Z -        
2025-11-09T23:42:54.7674820Z +
2025-11-09T23:42:54.7674971Z          // Initialize peer connections
2025-11-09T23:42:54.7675195Z -        if let Err(e) = self.network.initialize_peer_connections(
2025-11-09T23:42:54.7675304Z -            config,
2025-11-09T23:42:54.7675423Z -            network,
2025-11-09T23:42:54.7675533Z -            port,
2025-11-09T23:42:54.7675883Z -            target_peer_count,
2025-11-09T23:42:54.7676002Z -        ).await {
2025-11-09T23:42:54.7676143Z +        if let Err(e) = self
2025-11-09T23:42:54.7676255Z +            .network
2025-11-09T23:42:54.7676567Z +            .initialize_peer_connections(config, network, port, target_peer_count)
2025-11-09T23:42:54.7676681Z +            .await
2025-11-09T23:42:54.7676783Z +        {
2025-11-09T23:42:54.7676997Z              warn!("Failed to initialize peer connections: {}", e);
2025-11-09T23:42:54.7677233Z              // Don't fail startup - peer connections are best-effort
2025-11-09T23:42:54.7677364Z          }
2025-11-09T23:42:54.7677796Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:342:
2025-11-09T23:42:54.7677911Z -        
2025-11-09T23:42:54.7678027Z +
2025-11-09T23:42:54.7678142Z          Ok(())
2025-11-09T23:42:54.7678249Z      }
2025-11-09T23:42:54.7678359Z  
2025-11-09T23:42:54.7678796Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:368:
2025-11-09T23:42:54.7678927Z                  ) {
2025-11-09T23:42:54.7679065Z                      Ok(true) => {
2025-11-09T23:42:54.7679314Z                          info!("Block accepted at height {}", current_height);
2025-11-09T23:42:54.7679439Z -                        
2025-11-09T23:42:54.7679551Z +
2025-11-09T23:42:54.7679787Z                          // Persist UTXO set to storage after block validation
2025-11-09T23:42:54.7680111Z                          // This is critical for commitment generation and incremental pruning
2025-11-09T23:42:54.7680396Z                          if let Err(e) = self.storage.utxos().store_utxo_set(&utxo_set) {
2025-11-09T23:42:54.7680825Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:375:
2025-11-09T23:42:54.7681175Z -                            warn!("Failed to persist UTXO set after block {}: {}", current_height, e);
2025-11-09T23:42:54.7681305Z +                            warn!(
2025-11-09T23:42:54.7681529Z +                                "Failed to persist UTXO set after block {}: {}",
2025-11-09T23:42:54.7681694Z +                                current_height, e
2025-11-09T23:42:54.7681819Z +                            );
2025-11-09T23:42:54.7681938Z                          }
2025-11-09T23:42:54.7682054Z -                        
2025-11-09T23:42:54.7682171Z +
2025-11-09T23:42:54.7682441Z                          // Generate UTXO commitment from current state (if enabled)
2025-11-09T23:42:54.7682803Z                          // Use current_height (the block that was just validated) before incrementing
2025-11-09T23:42:54.7683255Z                          #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.7683701Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:381:
2025-11-09T23:42:54.7683831Z                          {
2025-11-09T23:42:54.7684095Z                              if let Some(pruning_manager) = self.storage.pruning() {
2025-11-09T23:42:54.7686279Z -                                if let (Some(commitment_store), Some(_utxostore)) = 
2025-11-09T23:42:54.7686632Z -                                    (pruning_manager.commitment_store(), pruning_manager.utxostore()) 
2025-11-09T23:42:54.7686777Z -                                {
2025-11-09T23:42:54.7687013Z +                                if let (Some(commitment_store), Some(_utxostore)) = (
2025-11-09T23:42:54.7687213Z +                                    pruning_manager.commitment_store(),
2025-11-09T23:42:54.7687402Z +                                    pruning_manager.utxostore(),
2025-11-09T23:42:54.7687551Z +                                ) {
2025-11-09T23:42:54.7687888Z                                      // Get block hash from storage (block was just stored at current_height)
2025-11-09T23:42:54.7688088Z                                      let blocks_arc = self.storage.blocks();
2025-11-09T23:42:54.7688447Z -                                    if let Ok(Some(block_hash)) = blocks_arc.get_hash_by_height(current_height) {
2025-11-09T23:42:54.7688901Z +                                    if let Ok(Some(block_hash)) =
2025-11-09T23:42:54.7689115Z +                                        blocks_arc.get_hash_by_height(current_height)
2025-11-09T23:42:54.7689244Z +                                    {
2025-11-09T23:42:54.7689463Z                                          // Generate commitment from current UTXO set state
2025-11-09T23:42:54.7689774Z -                                        if let Err(e) = pruning_manager.generate_commitment_from_current_state(
2025-11-09T23:42:54.7689938Z -                                            &block_hash,
2025-11-09T23:42:54.7690091Z -                                            current_height,
2025-11-09T23:42:54.7690231Z -                                            &utxo_set,
2025-11-09T23:42:54.7690385Z -                                            &commitment_store,
2025-11-09T23:42:54.7690522Z -                                        ) {
2025-11-09T23:42:54.7690881Z -                                            warn!("Failed to generate commitment for block {}: {}", current_height, e);
2025-11-09T23:42:54.7691052Z +                                        if let Err(e) = pruning_manager
2025-11-09T23:42:54.7691271Z +                                            .generate_commitment_from_current_state(
2025-11-09T23:42:54.7691427Z +                                                &block_hash,
2025-11-09T23:42:54.7691580Z +                                                current_height,
2025-11-09T23:42:54.7691729Z +                                                &utxo_set,
2025-11-09T23:42:54.7691891Z +                                                &commitment_store,
2025-11-09T23:42:54.7692033Z +                                            )
2025-11-09T23:42:54.7692165Z +                                        {
2025-11-09T23:42:54.7692310Z +                                            warn!(
2025-11-09T23:42:54.7692559Z +                                                "Failed to generate commitment for block {}: {}",
2025-11-09T23:42:54.7692731Z +                                                current_height, e
2025-11-09T23:42:54.7692863Z +                                            );
2025-11-09T23:42:54.7693003Z                                          } else {
2025-11-09T23:42:54.7693306Z -                                            debug!("Generated UTXO commitment for block {}", current_height);
2025-11-09T23:42:54.7693447Z +                                            debug!(
2025-11-09T23:42:54.7693652Z +                                                "Generated UTXO commitment for block {}",
2025-11-09T23:42:54.7694040Z +                                                current_height
2025-11-09T23:42:54.7694176Z +                                            );
2025-11-09T23:42:54.7696394Z                                          }
2025-11-09T23:42:54.7696560Z                                      } else {
2025-11-09T23:42:54.7696985Z                                          warn!("Could not find block hash for height {} to generate commitment", current_height);
2025-11-09T23:42:54.7697441Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:403:
2025-11-09T23:42:54.7697582Z                                  }
2025-11-09T23:42:54.7697705Z                              }
2025-11-09T23:42:54.7697825Z                          }
2025-11-09T23:42:54.7697945Z -                        
2025-11-09T23:42:54.7698066Z +
2025-11-09T23:42:54.7698256Z                          // Increment height after processing
2025-11-09T23:42:54.7698417Z                          current_height += 1;
2025-11-09T23:42:54.7698543Z -                        
2025-11-09T23:42:54.7698654Z +
2025-11-09T23:42:54.7698854Z                          // Check for incremental pruning during IBD
2025-11-09T23:42:54.7699175Z                          // Consider IBD if we're still syncing (height < tip or no recent blocks)
2025-11-09T23:42:54.7699563Z                          let is_ibd = current_height < 1000; // Simple heuristic: consider IBD if < 1000 blocks
2025-11-09T23:42:54.7700258Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:413:
2025-11-09T23:42:54.7700513Z                          if let Some(pruning_manager) = self.storage.pruning() {
2025-11-09T23:42:54.7701028Z -                            if let Ok(Some(prune_stats)) = pruning_manager.incremental_prune_during_ibd(current_height, is_ibd) {
2025-11-09T23:42:54.7701204Z +                            if let Ok(Some(prune_stats)) =
2025-11-09T23:42:54.7701567Z +                                pruning_manager.incremental_prune_during_ibd(current_height, is_ibd)
2025-11-09T23:42:54.7701701Z +                            {
2025-11-09T23:42:54.7702061Z                                  info!("Incremental pruning during IBD: {} blocks pruned, {} bytes freed", 
2025-11-09T23:42:54.7702329Z                                        prune_stats.blocks_pruned, prune_stats.storage_freed);
2025-11-09T23:42:54.7702547Z                                  // Flush storage to persist pruning changes
2025-11-09T23:42:54.7702976Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:418:
2025-11-09T23:42:54.7703160Z                                  if let Err(e) = self.storage.flush() {
2025-11-09T23:42:54.7703479Z -                                    warn!("Failed to flush storage after incremental pruning: {}", e);
2025-11-09T23:42:54.7703624Z +                                    warn!(
2025-11-09T23:42:54.7703896Z +                                        "Failed to flush storage after incremental pruning: {}",
2025-11-09T23:42:54.7704052Z +                                        e
2025-11-09T23:42:54.7704181Z +                                    );
2025-11-09T23:42:54.7704474Z                                  }
2025-11-09T23:42:54.7704607Z                              }
2025-11-09T23:42:54.7704732Z                          }
2025-11-09T23:42:54.7705169Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:423:
2025-11-09T23:42:54.7705303Z -                        
2025-11-09T23:42:54.7705423Z +
2025-11-09T23:42:54.7705658Z                          // Check for automatic pruning after block acceptance
2025-11-09T23:42:54.7705909Z                          if let Some(pruning_manager) = self.storage.pruning() {
2025-11-09T23:42:54.7706108Z                              let stats = pruning_manager.get_stats();
2025-11-09T23:42:54.7706548Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:427:
2025-11-09T23:42:54.7707043Z -                            let should_prune = pruning_manager.should_auto_prune(
2025-11-09T23:42:54.7707203Z -                                current_height,
2025-11-09T23:42:54.7707386Z -                                stats.last_prune_height,
2025-11-09T23:42:54.7707512Z -                            );
2025-11-09T23:42:54.7707634Z -                            
2025-11-09T23:42:54.7707828Z +                            let should_prune = pruning_manager
2025-11-09T23:42:54.7708136Z +                                .should_auto_prune(current_height, stats.last_prune_height);
2025-11-09T23:42:54.7708247Z +
2025-11-09T23:42:54.7708401Z                              if should_prune {
2025-11-09T23:42:54.7708729Z                                  info!("Automatic pruning triggered at height {}", current_height);
2025-11-09T23:42:54.7708862Z -                                
2025-11-09T23:42:54.7708976Z +
2025-11-09T23:42:54.7709204Z                                  // Calculate prune height based on configuration
2025-11-09T23:42:54.7709473Z                                  let prune_height = match &pruning_manager.config.mode {
2025-11-09T23:42:54.7709715Z                                      crate::config::PruningMode::Disabled => None,
2025-11-09T23:42:54.7710153Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:438:
2025-11-09T23:42:54.7710478Z -                                    crate::config::PruningMode::Normal { keep_from_height, .. } => {
2025-11-09T23:42:54.7710907Z +                                    crate::config::PruningMode::Normal {
2025-11-09T23:42:54.7711091Z +                                        keep_from_height, ..
2025-11-09T23:42:54.7711225Z +                                    } => {
2025-11-09T23:42:54.7711502Z                                          // Prune to keep_from_height, but ensure we keep min_blocks
2025-11-09T23:42:54.7711776Z                                          let min_keep = pruning_manager.config.min_blocks_to_keep;
2025-11-09T23:42:54.7712317Z -                                        let effective_keep = (*keep_from_height).max(current_height.saturating_sub(min_keep));
2025-11-09T23:42:54.7712533Z +                                        let effective_keep = (*keep_from_height)
2025-11-09T23:42:54.7712765Z +                                            .max(current_height.saturating_sub(min_keep));
2025-11-09T23:42:54.7712942Z                                          Some(effective_keep)
2025-11-09T23:42:54.7713084Z                                      }
2025-11-09T23:42:54.7713273Z                                      #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.7714037Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:445:
2025-11-09T23:42:54.7716360Z -                                    crate::config::PruningMode::Aggressive { keep_from_height, min_blocks, .. } => {
2025-11-09T23:42:54.7716592Z +                                    crate::config::PruningMode::Aggressive {
2025-11-09T23:42:54.7716786Z +                                        keep_from_height,
2025-11-09T23:42:54.7716937Z +                                        min_blocks,
2025-11-09T23:42:54.7717067Z +                                        ..
2025-11-09T23:42:54.7717194Z +                                    } => {
2025-11-09T23:42:54.7717438Z                                          // Prune to keep_from_height, respecting min_blocks
2025-11-09T23:42:54.7717891Z -                                        let effective_keep = (*keep_from_height).max(current_height.saturating_sub(*min_blocks));
2025-11-09T23:42:54.7718087Z +                                        let effective_keep = (*keep_from_height)
2025-11-09T23:42:54.7718330Z +                                            .max(current_height.saturating_sub(*min_blocks));
2025-11-09T23:42:54.7718520Z                                          Some(effective_keep)
2025-11-09T23:42:54.7719090Z                                      }
2025-11-09T23:42:54.7719583Z                                      #[cfg(not(feature = "utxo-commitments"))]
2025-11-09T23:42:54.7720019Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:453:
2025-11-09T23:42:54.7720268Z                                          // Fall back to no pruning if feature is disabled
2025-11-09T23:42:54.7720412Z                                          None
2025-11-09T23:42:54.7720541Z                                      }
2025-11-09T23:42:54.7720927Z -                                    crate::config::PruningMode::Custom { keep_bodies_from_height, .. } => {
2025-11-09T23:42:54.7721126Z +                                    crate::config::PruningMode::Custom {
2025-11-09T23:42:54.7721295Z +                                        keep_bodies_from_height,
2025-11-09T23:42:54.7729406Z +                                        ..
2025-11-09T23:42:54.7729588Z +                                    } => {
2025-11-09T23:42:54.7729882Z                                          // Prune to keep_bodies_from_height, respecting min_blocks
2025-11-09T23:42:54.7730162Z                                          let min_keep = pruning_manager.config.min_blocks_to_keep;
2025-11-09T23:42:54.7730643Z -                                        let effective_keep = (*keep_bodies_from_height).max(current_height.saturating_sub(min_keep));
2025-11-09T23:42:54.7730873Z +                                        let effective_keep = (*keep_bodies_from_height)
2025-11-09T23:42:54.7731332Z +                                            .max(current_height.saturating_sub(min_keep));
2025-11-09T23:42:54.7731512Z                                          Some(effective_keep)
2025-11-09T23:42:54.7731644Z                                      }
2025-11-09T23:42:54.7731772Z                                  };
2025-11-09T23:42:54.7732206Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:463:
2025-11-09T23:42:54.7732328Z -                                
2025-11-09T23:42:54.7732437Z +
2025-11-09T23:42:54.7732657Z                                  if let Some(prune_to_height) = prune_height {
2025-11-09T23:42:54.7732845Z                                      if prune_to_height < current_height {
2025-11-09T23:42:54.7733245Z -                                        match pruning_manager.prune_to_height(prune_to_height, current_height, false) {
2025-11-09T23:42:54.7733456Z +                                        match pruning_manager.prune_to_height(
2025-11-09T23:42:54.7733648Z +                                            prune_to_height,
2025-11-09T23:42:54.7733814Z +                                            current_height,
2025-11-09T23:42:54.7733960Z +                                            false,
2025-11-09T23:42:54.7736235Z +                                        ) {
2025-11-09T23:42:54.7736432Z                                              Ok(prune_stats) => {
2025-11-09T23:42:54.7736804Z                                                  info!("Automatic pruning completed: {} blocks pruned, {} blocks kept", 
2025-11-09T23:42:54.7737106Z                                                        prune_stats.blocks_pruned, prune_stats.blocks_kept);
2025-11-09T23:42:54.7737550Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:596:
2025-11-09T23:42:54.7737696Z      /// Get health report
2025-11-09T23:42:54.7737960Z      pub fn health_check(&self) -> health::HealthReport {
2025-11-09T23:42:54.7738162Z          use crate::node::health::HealthChecker;
2025-11-09T23:42:54.7738281Z -        
2025-11-09T23:42:54.7738394Z +
2025-11-09T23:42:54.7738578Z          let checker = HealthChecker::new();
2025-11-09T23:42:54.7738816Z          let network_healthy = self.network.is_network_active();
2025-11-09T23:42:54.7739167Z          let storage_healthy = self.storage.check_storage_bounds().unwrap_or(false);
2025-11-09T23:42:54.7739613Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:603:
2025-11-09T23:42:54.7739908Z          let rpc_healthy = true; // RPC is always healthy if node is running
2025-11-09T23:42:54.7740283Z -        
2025-11-09T23:42:54.7740412Z +
2025-11-09T23:42:54.7740625Z          // Get metrics if available (simplified for now)
2025-11-09T23:42:54.7740774Z          checker.check_health(
2025-11-09T23:42:54.7740912Z              network_healthy,
2025-11-09T23:42:54.7741522Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/performance.rs:2:
2025-11-09T23:42:54.7741653Z  //!
2025-11-09T23:42:54.7742082Z  //! Provides performance tracking, profiling hooks, and performance metrics collection.
2025-11-09T23:42:54.7742195Z  
2025-11-09T23:42:54.7742375Z +use serde::{Deserialize, Serialize};
2025-11-09T23:42:54.7742510Z  use std::sync::Arc;
2025-11-09T23:42:54.7742643Z  use std::sync::Mutex;
2025-11-09T23:42:54.7742793Z  use std::time::{Duration, Instant};
2025-11-09T23:42:54.7743275Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/performance.rs:8:
2025-11-09T23:42:54.7743463Z -use serde::{Deserialize, Serialize};
2025-11-09T23:42:54.7743577Z  
2025-11-09T23:42:54.7743811Z  /// Performance profiler for tracking operation timings
2025-11-09T23:42:54.7743991Z  pub struct PerformanceProfiler {
2025-11-09T23:42:54.7746350Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/performance.rs:87:
2025-11-09T23:42:54.7746543Z          let total: Duration = times.iter().sum();
2025-11-09T23:42:54.7746951Z          let count = times.len();
2025-11-09T23:42:54.7747094Z          let avg = total / count as u32;
2025-11-09T23:42:54.7747206Z -        
2025-11-09T23:42:54.7747320Z +
2025-11-09T23:42:54.7747485Z          let mut sorted = times.to_vec();
2025-11-09T23:42:54.7747615Z          sorted.sort();
2025-11-09T23:42:54.7747730Z -        
2025-11-09T23:42:54.7747848Z +
2025-11-09T23:42:54.7748010Z          let p50 = sorted[count / 2];
2025-11-09T23:42:54.7748171Z          let p95 = sorted[(count * 95) / 100];
2025-11-09T23:42:54.7748329Z          let p99 = sorted[(count * 99) / 100];
2025-11-09T23:42:54.7748793Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/performance.rs:166:
2025-11-09T23:42:54.7748952Z      /// Stop the timer and record the duration
2025-11-09T23:42:54.7749093Z      pub fn stop(self) -> Duration {
2025-11-09T23:42:54.7749257Z          let duration = self.start.elapsed();
2025-11-09T23:42:54.7749360Z -        
2025-11-09T23:42:54.7749458Z +
2025-11-09T23:42:54.7749610Z          match self.operation_type {
2025-11-09T23:42:54.7749787Z              OperationType::BlockProcessing => {
2025-11-09T23:42:54.7749991Z                  self.profiler.record_block_processing(duration);
2025-11-09T23:42:54.7750464Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/performance.rs:181:
2025-11-09T23:42:54.7750698Z                  self.profiler.record_network_operation(duration);
2025-11-09T23:42:54.7750815Z              }
2025-11-09T23:42:54.7750931Z          }
2025-11-09T23:42:54.7751052Z -        
2025-11-09T23:42:54.7751166Z +
2025-11-09T23:42:54.7751289Z          duration
2025-11-09T23:42:54.7751399Z      }
2025-11-09T23:42:54.7751518Z  }
2025-11-09T23:42:54.7752004Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/performance.rs:191:
2025-11-09T23:42:54.7752184Z          Self::new(1000) // Keep last 1000 samples
2025-11-09T23:42:54.7752306Z      }
2025-11-09T23:42:54.7752412Z  }
2025-11-09T23:42:54.7752523Z -
2025-11-09T23:42:54.7752631Z  
2025-11-09T23:42:54.7753095Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/sync.rs:188:
2025-11-09T23:42:54.7753275Z          metrics: Option<Arc<MetricsCollector>>,
2025-11-09T23:42:54.7753469Z          profiler: Option<Arc<PerformanceProfiler>>,
2025-11-09T23:42:54.7753612Z      ) -> Result<bool> {
2025-11-09T23:42:54.7753789Z -        let _timer = profiler.as_ref().map(|p| {
2025-11-09T23:42:54.7756147Z -            PerformanceTimer::start(Arc::clone(p), OperationType::BlockProcessing)
2025-11-09T23:42:54.7756493Z -        });
2025-11-09T23:42:54.7756643Z +        let _timer = profiler
2025-11-09T23:42:54.7756765Z +            .as_ref()
2025-11-09T23:42:54.7757159Z +            .map(|p| PerformanceTimer::start(Arc::clone(p), OperationType::BlockProcessing));
2025-11-09T23:42:54.7757331Z          let start_time = Instant::now();
2025-11-09T23:42:54.7757443Z  
2025-11-09T23:42:54.7757673Z          // Parse block from wire format (extracts witness data)
2025-11-09T23:42:54.7758093Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/sync.rs:231:
2025-11-09T23:42:54.7758252Z                  metrics.update_performance(|m| {
2025-11-09T23:42:54.7758457Z                      let time_ms = processing_time.as_secs_f64() * 1000.0;
2025-11-09T23:42:54.7758744Z                      // Update average block processing time (exponential moving average)
2025-11-09T23:42:54.7758912Z -                    m.avg_block_processing_time_ms = 
2025-11-09T23:42:54.7759066Z +                    m.avg_block_processing_time_ms =
2025-11-09T23:42:54.7759297Z                          (m.avg_block_processing_time_ms * 0.9) + (time_ms * 0.1);
2025-11-09T23:42:54.7759455Z                      // Update blocks per second
2025-11-09T23:42:54.7759620Z                      if processing_time.as_secs_f64() > 0.0 {
2025-11-09T23:42:54.7760008Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/sync.rs:240:
2025-11-09T23:42:54.7760909Z                  });
2025-11-09T23:42:54.7761255Z              }
2025-11-09T23:42:54.7761377Z  
2025-11-09T23:42:54.7761830Z -            info!("Block validated and stored at height {} (took {:?})", current_height, processing_time);
2025-11-09T23:42:54.7761967Z +            info!(
2025-11-09T23:42:54.7762210Z +                "Block validated and stored at height {} (took {:?})",
2025-11-09T23:42:54.7762381Z +                current_height, processing_time
2025-11-09T23:42:54.7762506Z +            );
2025-11-09T23:42:54.7762626Z              Ok(true)
2025-11-09T23:42:54.7762757Z          } else {
2025-11-09T23:42:54.7763042Z              error!("Block validation failed at height {}", current_height);
2025-11-09T23:42:54.7763494Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:85:
2025-11-09T23:42:54.7763732Z          let elapsed = now.saturating_sub(self.last_refill);
2025-11-09T23:42:54.7763873Z          if elapsed > 0 {
2025-11-09T23:42:54.7764158Z              let tokens_to_add = (elapsed as u32).saturating_mul(self.rate);
2025-11-09T23:42:54.7766455Z -            self.tokens = self.tokens.saturating_add(tokens_to_add).min(self.burst_limit);
2025-11-09T23:42:54.7766618Z +            self.tokens = self
2025-11-09T23:42:54.7766752Z +                .tokens
2025-11-09T23:42:54.7766916Z +                .saturating_add(tokens_to_add)
2025-11-09T23:42:54.7767066Z +                .min(self.burst_limit);
2025-11-09T23:42:54.7767212Z              self.last_refill = now;
2025-11-09T23:42:54.7767335Z          }
2025-11-09T23:42:54.7767454Z  
2025-11-09T23:42:54.7767900Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:134:
2025-11-09T23:42:54.7768023Z      }
2025-11-09T23:42:54.7768135Z  
2025-11-09T23:42:54.7768294Z      /// Create with custom rate limits
2025-11-09T23:42:54.7768436Z -    pub fn with_rate_limits(
2025-11-09T23:42:54.7768580Z -        auth_required: bool,
2025-11-09T23:42:54.7768715Z -        default_burst: u32,
2025-11-09T23:42:54.7768857Z -        default_rate: u32,
2025-11-09T23:42:54.7768987Z -    ) -> Self {
2025-11-09T23:42:54.7769417Z +    pub fn with_rate_limits(auth_required: bool, default_burst: u32, default_rate: u32) -> Self {
2025-11-09T23:42:54.7769542Z          Self {
2025-11-09T23:42:54.7769793Z              valid_tokens: Arc::new(Mutex::new(HashMap::new())),
2025-11-09T23:42:54.7770057Z              valid_certificates: Arc::new(Mutex::new(HashMap::new())),
2025-11-09T23:42:54.7770490Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:154:
2025-11-09T23:42:54.7770990Z          let user_id = UserId::Token(AuthToken::new(token.clone()));
2025-11-09T23:42:54.7771207Z          let mut tokens = self.valid_tokens.lock().await;
2025-11-09T23:42:54.7771382Z          tokens.insert(token, user_id.clone());
2025-11-09T23:42:54.7771496Z -        
2025-11-09T23:42:54.7771615Z +
2025-11-09T23:42:54.7771791Z          // Initialize rate limiter for this user
2025-11-09T23:42:54.7772063Z          let (burst, rate) = self.get_rate_limit_for_user(&user_id).await;
2025-11-09T23:42:54.7772289Z          let mut limiters = self.rate_limiters.lock().await;
2025-11-09T23:42:54.7772716Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:161:
2025-11-09T23:42:54.7773000Z          limiters.insert(user_id, RpcRateLimiter::new(burst, rate));
2025-11-09T23:42:54.7773111Z -        
2025-11-09T23:42:54.7773227Z +
2025-11-09T23:42:54.7773344Z          Ok(())
2025-11-09T23:42:54.7773457Z      }
2025-11-09T23:42:54.7773576Z  
2025-11-09T23:42:54.7773990Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:178:
2025-11-09T23:42:54.7774232Z          let user_id = UserId::Certificate(fingerprint.clone());
2025-11-09T23:42:54.7774694Z          let mut certs = self.valid_certificates.lock().await;
2025-11-09T23:42:54.7774906Z          certs.insert(fingerprint, user_id.clone());
2025-11-09T23:42:54.7775021Z -        
2025-11-09T23:42:54.7775131Z +
2025-11-09T23:42:54.7775533Z          // Initialize rate limiter for this user
2025-11-09T23:42:54.7775790Z          let (burst, rate) = self.get_rate_limit_for_user(&user_id).await;
2025-11-09T23:42:54.7775993Z          let mut limiters = self.rate_limiters.lock().await;
2025-11-09T23:42:54.7776430Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:185:
2025-11-09T23:42:54.7776719Z          limiters.insert(user_id, RpcRateLimiter::new(burst, rate));
2025-11-09T23:42:54.7776838Z -        
2025-11-09T23:42:54.7776947Z +
2025-11-09T23:42:54.7777080Z          Ok(())
2025-11-09T23:42:54.7777179Z      }
2025-11-09T23:42:54.7777281Z  
2025-11-09T23:42:54.7777726Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:201:
2025-11-09T23:42:54.7778081Z      pub async fn set_user_rate_limit(&self, user_id: &UserId, burst: u32, rate: u32) {
2025-11-09T23:42:54.7778311Z          let mut limits = self.user_rate_limits.lock().await;
2025-11-09T23:42:54.7778518Z          limits.insert(user_id.clone(), (burst, rate));
2025-11-09T23:42:54.7778645Z -        
2025-11-09T23:42:54.7778745Z +
2025-11-09T23:42:54.7778917Z          // Update existing rate limiter if present
2025-11-09T23:42:54.7779130Z          let mut limiters = self.rate_limiters.lock().await;
2025-11-09T23:42:54.7779322Z          if let Some(limiter) = limiters.get_mut(user_id) {
2025-11-09T23:42:54.7779759Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:212:
2025-11-09T23:42:54.7780016Z      /// Get rate limit for a user (checks per-user limits first)
2025-11-09T23:42:54.7780340Z      async fn get_rate_limit_for_user(&self, user_id: &UserId) -> (u32, u32) {
2025-11-09T23:42:54.7780543Z          let limits = self.user_rate_limits.lock().await;
2025-11-09T23:42:54.7780809Z -        limits.get(user_id).copied().unwrap_or(self.default_rate_limit)
2025-11-09T23:42:54.7780928Z +        limits
2025-11-09T23:42:54.7781056Z +            .get(user_id)
2025-11-09T23:42:54.7781194Z +            .copied()
2025-11-09T23:42:54.7781371Z +            .unwrap_or(self.default_rate_limit)
2025-11-09T23:42:54.7781485Z      }
2025-11-09T23:42:54.7781596Z  
2025-11-09T23:42:54.7781771Z      /// Authenticate a request from HTTP headers
2025-11-09T23:42:54.7782178Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:283:
2025-11-09T23:42:54.7782317Z      /// Check rate limit for a user
2025-11-09T23:42:54.7782588Z      pub async fn check_rate_limit(&self, user_id: &UserId) -> bool {
2025-11-09T23:42:54.7782793Z          let mut limiters = self.rate_limiters.lock().await;
2025-11-09T23:42:54.7783108Z -        
2025-11-09T23:42:54.7783209Z +
2025-11-09T23:42:54.7783380Z          // Get or create rate limiter for this user
2025-11-09T23:42:54.7783663Z          let limiter = limiters.entry(user_id.clone()).or_insert_with(|| {
2025-11-09T23:42:54.7783854Z              let (burst, rate) = self.default_rate_limit;
2025-11-09T23:42:54.7784280Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:290:
2025-11-09T23:42:54.7784672Z              RpcRateLimiter::new(burst, rate)
2025-11-09T23:42:54.7784781Z          });
2025-11-09T23:42:54.7784884Z -        
2025-11-09T23:42:54.7784991Z +
2025-11-09T23:42:54.7785125Z          limiter.check_and_consume()
2025-11-09T23:42:54.7785227Z      }
2025-11-09T23:42:54.7785328Z  
2025-11-09T23:42:54.7785716Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:311:
2025-11-09T23:42:54.7785949Z          auth.add_token("test-token-123".to_string()).await.unwrap();
2025-11-09T23:42:54.7786063Z  
2025-11-09T23:42:54.7786238Z          let mut headers = hyper::HeaderMap::new();
2025-11-09T23:42:54.7787888Z -        headers.insert(
2025-11-09T23:42:54.7788024Z -            "authorization",
2025-11-09T23:42:54.7788518Z -            "***".parse().unwrap(),
2025-11-09T23:42:54.7788630Z -        );
2025-11-09T23:42:54.7788976Z +        headers.insert("authorization", "***".parse().unwrap());
2025-11-09T23:42:54.7789294Z  
2025-11-09T23:42:54.7789513Z          let addr: SocketAddr = "127.0.0.1:8080".parse().unwrap();
2025-11-09T23:42:54.7789780Z          let result = auth.authenticate_request(&headers, addr).await;
2025-11-09T23:42:54.7790199Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:329:
2025-11-09T23:42:54.7790424Z          auth.add_token("valid-token".to_string()).await.unwrap();
2025-11-09T23:42:54.7790525Z  
2025-11-09T23:42:54.7790703Z          let mut headers = hyper::HeaderMap::new();
2025-11-09T23:42:54.7790840Z -        headers.insert(
2025-11-09T23:42:54.7790963Z -            "authorization",
2025-11-09T23:42:54.7791211Z -            "***".parse().unwrap(),
2025-11-09T23:42:54.7791319Z -        );
2025-11-09T23:42:54.7791689Z +        headers.insert("authorization", "***".parse().unwrap());
2025-11-09T23:42:54.7791810Z  
2025-11-09T23:42:54.7792032Z          let addr: SocketAddr = "127.0.0.1:8080".parse().unwrap();
2025-11-09T23:42:54.7792300Z          let result = auth.authenticate_request(&headers, addr).await;
2025-11-09T23:42:54.7792724Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:368:
2025-11-09T23:42:54.7792895Z          assert!(result.error.is_none());
2025-11-09T23:42:54.7793009Z      }
2025-11-09T23:42:54.7793115Z  }
2025-11-09T23:42:54.7793224Z -
2025-11-09T23:42:54.7793326Z  
2025-11-09T23:42:54.7982354Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:30:
2025-11-09T23:42:54.7982585Z  
2025-11-09T23:42:54.7982744Z      /// Create with dependencies
2025-11-09T23:42:54.7983024Z      pub fn with_dependencies(storage: Arc<Storage>) -> Self {
2025-11-09T23:42:54.7983185Z -        Self { storage: Some(storage) }
2025-11-09T23:42:54.7983302Z +        Self {
2025-11-09T23:42:54.7983460Z +            storage: Some(storage),
2025-11-09T23:42:54.7983571Z +        }
2025-11-09T23:42:54.7983682Z      }
2025-11-09T23:42:54.7983792Z  
2025-11-09T23:42:54.7984050Z      /// Calculate difficulty from bits (compact target format)
2025-11-09T23:42:54.7984711Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:39:
2025-11-09T23:42:54.7985188Z          // MAX_TARGET for Bitcoin mainnet is 0x00000000FFFF0000000000000000000000000000000000000000000000000000
2025-11-09T23:42:54.7985486Z          // But we use a simpler calculation: difficulty = 2^256 / (target + 1)
2025-11-09T23:42:54.7985774Z          // For display purposes, we normalize to genesis difficulty = 1.0
2025-11-09T23:42:54.7986212Z -        const MAX_TARGET: u128 = 0x00000000FFFF0000000000000000000000000000000000000000000000000000u128;
2025-11-09T23:42:54.7986625Z -        
2025-11-09T23:42:54.7986777Z +        const MAX_TARGET: u128 =
2025-11-09T23:42:54.7987099Z +            0x00000000FFFF0000000000000000000000000000000000000000000000000000u128;
2025-11-09T23:42:54.7987210Z +
2025-11-09T23:42:54.7987393Z          // Simplified difficulty calculation
2025-11-09T23:42:54.7987683Z          // For display purposes, use a simple approximation based on bits
2025-11-09T23:42:54.7987861Z          if let Ok(_target) = expand_target(bits) {
2025-11-09T23:42:54.7988329Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:73:
2025-11-09T23:42:54.7988532Z      fn calculate_block_subsidy(height: u64) -> u64 {
2025-11-09T23:42:54.7988800Z          const INITIAL_SUBSIDY: u64 = 50_000_000_000; // 50 BTC in satoshis
2025-11-09T23:42:54.7988968Z          const HALVING_INTERVAL: u64 = 210_000;
2025-11-09T23:42:54.7989080Z -        
2025-11-09T23:42:54.7989200Z +
2025-11-09T23:42:54.7989377Z          let halvings = height / HALVING_INTERVAL;
2025-11-09T23:42:54.7989497Z -        
2025-11-09T23:42:54.7989604Z +
2025-11-09T23:42:54.7989813Z          // Subsidy halves each halving, but can't go below 0
2025-11-09T23:42:54.7989958Z          if halvings >= 64 {
2025-11-09T23:42:54.7990210Z              // After 64 halvings, subsidy is 0 (satoshi precision limit)
2025-11-09T23:42:54.7990856Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:82:
2025-11-09T23:42:54.7990983Z              return 0;
2025-11-09T23:42:54.7991105Z          }
2025-11-09T23:42:54.7991210Z -        
2025-11-09T23:42:54.7991314Z +
2025-11-09T23:42:54.7991460Z          INITIAL_SUBSIDY >> halvings
2025-11-09T23:42:54.7991570Z      }
2025-11-09T23:42:54.7991673Z  
2025-11-09T23:42:54.7992129Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:88:
2025-11-09T23:42:54.7992389Z      /// Calculate hash_serialized_2 for UTXO set (double SHA256)
2025-11-09T23:42:54.7992517Z -    /// 
2025-11-09T23:42:54.7992632Z +    ///
2025-11-09T23:42:54.7992965Z      /// Serializes UTXO set deterministically and computes double SHA256 hash.
2025-11-09T23:42:54.7993295Z      /// Matches Bitcoin Core's gettxoutsetinfo hash_serialized_2 calculation.
2025-11-09T23:42:54.7993659Z      fn calculate_utxo_set_hash(utxo_set: &bllvm_protocol::UtxoSet) -> [u8; 32] {
2025-11-09T23:42:54.7996250Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:93:
2025-11-09T23:42:54.7996415Z -        use sha2::{Sha256, Digest};
2025-11-09T23:42:54.7996611Z          use crate::storage::hashing::double_sha256;
2025-11-09T23:42:54.7996725Z -        
2025-11-09T23:42:54.7996881Z +        use sha2::{Digest, Sha256};
2025-11-09T23:42:54.7996992Z +
2025-11-09T23:42:54.7997345Z          // Sort UTXOs for deterministic hashing (by outpoint: hash first, then index)
2025-11-09T23:42:54.7997567Z          let mut entries: Vec<_> = utxo_set.iter().collect();
2025-11-09T23:42:54.7997836Z -        entries.sort_by(|(a, _), (b, _)| {
2025-11-09T23:42:54.7998000Z -            match a.hash.cmp(&b.hash) {
2025-11-09T23:42:54.7998235Z -                std::cmp::Ordering::Equal => a.index.cmp(&b.index),
2025-11-09T23:42:54.7998373Z -                other => other,
2025-11-09T23:42:54.7998487Z -            }
2025-11-09T23:42:54.7998749Z +        entries.sort_by(|(a, _), (b, _)| match a.hash.cmp(&b.hash) {
2025-11-09T23:42:54.7998993Z +            std::cmp::Ordering::Equal => a.index.cmp(&b.index),
2025-11-09T23:42:54.7999128Z +            other => other,
2025-11-09T23:42:54.7999243Z          });
2025-11-09T23:42:54.7999368Z -        
2025-11-09T23:42:54.7999482Z +
2025-11-09T23:42:54.7999630Z          // Serialize each UTXO entry
2025-11-09T23:42:54.7999796Z          let mut serialized = Vec::new();
2025-11-09T23:42:54.7999964Z          for (outpoint, utxo) in entries {
2025-11-09T23:42:54.8000442Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:108:
2025-11-09T23:42:54.8001027Z              // Serialize outpoint (32-byte hash + 8-byte index, little-endian)
2025-11-09T23:42:54.8001262Z              serialized.extend_from_slice(&outpoint.hash);
2025-11-09T23:42:54.8001552Z              serialized.extend_from_slice(&outpoint.index.to_le_bytes());
2025-11-09T23:42:54.8001666Z -            
2025-11-09T23:42:54.8001791Z +
2025-11-09T23:42:54.8002160Z              // Serialize UTXO (8-byte value + script_pubkey + 8-byte height, little-endian)
2025-11-09T23:42:54.8002422Z              serialized.extend_from_slice(&utxo.value.to_le_bytes());
2025-11-09T23:42:54.8002649Z              serialized.extend_from_slice(&utxo.script_pubkey);
2025-11-09T23:42:54.8003131Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:115:
2025-11-09T23:42:54.8003412Z              serialized.extend_from_slice(&utxo.height.to_le_bytes());
2025-11-09T23:42:54.8003530Z          }
2025-11-09T23:42:54.8003665Z -        
2025-11-09T23:42:54.8003778Z +
2025-11-09T23:42:54.8003916Z          // Double SHA256 hash
2025-11-09T23:42:54.8006117Z          double_sha256(&serialized)
2025-11-09T23:42:54.8006248Z      }
2025-11-09T23:42:54.8006724Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:121:
2025-11-09T23:42:54.8006848Z -    
2025-11-09T23:42:54.8006974Z +
2025-11-09T23:42:54.8007413Z      /// Calculate confirmations for a block
2025-11-09T23:42:54.8007759Z      fn calculate_confirmations(block_height: u64, tip_height: u64) -> i64 {
2025-11-09T23:42:54.8007916Z          if block_height > tip_height {
2025-11-09T23:42:54.8008401Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:222:
2025-11-09T23:42:54.8008602Z              }))
2025-11-09T23:42:54.8008722Z          } else {
2025-11-09T23:42:54.8009068Z              // Graceful degradation: return default values when storage unavailable
2025-11-09T23:42:54.8009584Z -            tracing::debug!("getblockchaininfo called but storage not available, returning default values");
2025-11-09T23:42:54.8009728Z +            tracing::debug!(
2025-11-09T23:42:54.8010131Z +                "getblockchaininfo called but storage not available, returning default values"
2025-11-09T23:42:54.8010251Z +            );
2025-11-09T23:42:54.8010376Z              Ok(json!({
2025-11-09T23:42:54.8010515Z                  "chain": "main",
2025-11-09T23:42:54.8010663Z                  "blocks": 0,
2025-11-09T23:42:54.8011131Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:311:
2025-11-09T23:42:54.8011390Z          debug!("RPC: getblockheader {} verbose={}", hash, verbose);
2025-11-09T23:42:54.8011510Z  
2025-11-09T23:42:54.8011691Z          if let Some(ref storage) = self.storage {
2025-11-09T23:42:54.8011862Z -            let hash_bytes = hex::decode(hash)
2025-11-09T23:42:54.8012098Z -                .map_err(|e| anyhow::anyhow!("Invalid hash: {}", e))?;
2025-11-09T23:42:54.8012247Z +            let hash_bytes =
2025-11-09T23:42:54.8012560Z +                hex::decode(hash).map_err(|e| anyhow::anyhow!("Invalid hash: {}", e))?;
2025-11-09T23:42:54.8012716Z              if hash_bytes.len() != 32 {
2025-11-09T23:42:54.8012964Z                  return Err(anyhow::anyhow!("Invalid hash length"));
2025-11-09T23:42:54.8013083Z              }
2025-11-09T23:42:54.8013545Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:319:
2025-11-09T23:42:54.8013926Z              let mut hash_array = [0u8; 32];
2025-11-09T23:42:54.8014109Z              hash_array.copy_from_slice(&hash_bytes);
2025-11-09T23:42:54.8014221Z -            
2025-11-09T23:42:54.8014490Z +
2025-11-09T23:42:54.8014775Z              if let Ok(Some(header)) = storage.blocks().get_header(&hash_array) {
2025-11-09T23:42:54.8014906Z                  if verbose {
2025-11-09T23:42:54.8015105Z                      // Find block height by searching height index
2025-11-09T23:42:54.8015821Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:360:
2025-11-09T23:42:54.8015931Z  
2025-11-09T23:42:54.8016076Z                      // Find next block hash
2025-11-09T23:42:54.8016294Z                      let next_blockhash = block_height.and_then(|h| {
2025-11-09T23:42:54.8016438Z -                        storage.blocks()
2025-11-09T23:42:54.8016566Z +                        storage
2025-11-09T23:42:54.8016980Z +                            .blocks()
2025-11-09T23:42:54.8017148Z                              .get_hash_by_height(h + 1)
2025-11-09T23:42:54.8017270Z                              .ok()
2025-11-09T23:42:54.8017394Z                              .flatten()
2025-11-09T23:42:54.8017866Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:380:
2025-11-09T23:42:54.8017987Z                          }
2025-11-09T23:42:54.8018177Z                          Self::format_chainwork(total_work)
2025-11-09T23:42:54.8018310Z                      } else {
2025-11-09T23:42:54.8018636Z -                        "0000000000000000000000000000000000000000000000000000000000000000".to_string()
2025-11-09T23:42:54.8018904Z +                        "0000000000000000000000000000000000000000000000000000000000000000"
2025-11-09T23:42:54.8019048Z +                            .to_string()
2025-11-09T23:42:54.8019165Z                      };
2025-11-09T23:42:54.8019473Z  
2025-11-09T23:42:54.8019601Z                      Ok(json!({
2025-11-09T23:42:54.8020033Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:443:
2025-11-09T23:42:54.8020258Z              if let Ok(Some(hash)) = storage.chain().get_tip_hash() {
2025-11-09T23:42:54.8020417Z                  Ok(json!(hex::encode(hash)))
2025-11-09T23:42:54.8020533Z              } else {
2025-11-09T23:42:54.8020828Z -                Ok(json!("0000000000000000000000000000000000000000000000000000000000000000"))
2025-11-09T23:42:54.8020953Z +                Ok(json!(
2025-11-09T23:42:54.8021321Z +                    "0000000000000000000000000000000000000000000000000000000000000000"
2025-11-09T23:42:54.8021441Z +                ))
2025-11-09T23:42:54.8021544Z              }
2025-11-09T23:42:54.8021648Z          } else {
2025-11-09T23:42:54.8021937Z -            Ok(json!("0000000000000000000000000000000000000000000000000000000000000000"))
2025-11-09T23:42:54.8022048Z +            Ok(json!(
2025-11-09T23:42:54.8022296Z +                "0000000000000000000000000000000000000000000000000000000000000000"
2025-11-09T23:42:54.8022404Z +            ))
2025-11-09T23:42:54.8022503Z          }
2025-11-09T23:42:54.8022605Z      }
2025-11-09T23:42:54.8022702Z  
2025-11-09T23:42:54.8023123Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:494:
2025-11-09T23:42:54.8023298Z              let utxos = storage.utxos().get_all_utxos()?;
2025-11-09T23:42:54.8023429Z              let txouts = utxos.len();
2025-11-09T23:42:54.8023727Z              let total_amount: u64 = utxos.values().map(|utxo| utxo.value as u64).sum();
2025-11-09T23:42:54.8023829Z -            
2025-11-09T23:42:54.8023925Z +
2025-11-09T23:42:54.8024227Z              // Calculate hash_serialized_2 (double SHA256 of serialized UTXO set)
2025-11-09T23:42:54.8026602Z              let hash_serialized_2 = Self::calculate_utxo_set_hash(&utxos);
2025-11-09T23:42:54.8026723Z  
2025-11-09T23:42:54.8027199Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:540:
2025-11-09T23:42:54.8027562Z              // Use protocol engine which provides the correct validate_block signature
2025-11-09T23:42:54.8027900Z              let engine = BitcoinProtocolEngine::new(ProtocolVersion::Regtest)
2025-11-09T23:42:54.8028226Z                  .map_err(|e| anyhow::anyhow!("Failed to create protocol engine: {}", e))?;
2025-11-09T23:42:54.8028349Z -            
2025-11-09T23:42:54.8028464Z +
2025-11-09T23:42:54.8028663Z              let check_level = checklevel.unwrap_or(3);
2025-11-09T23:42:54.8029091Z              let num_blocks = numblocks.unwrap_or(288);
2025-11-09T23:42:54.8029222Z -            
2025-11-09T23:42:54.8029332Z +
2025-11-09T23:42:54.8029598Z              let tip_height = storage.chain().get_height()?.unwrap_or(0);
2025-11-09T23:42:54.8029745Z              if tip_height == 0 {
2025-11-09T23:42:54.8029947Z                  return Ok(json!(true)); // Empty chain is valid
2025-11-09T23:42:54.8030428Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:557:
2025-11-09T23:42:54.8030545Z              };
2025-11-09T23:42:54.8030650Z  
2025-11-09T23:42:54.8030803Z              let mut errors = Vec::new();
2025-11-09T23:42:54.8031008Z -            let mut utxo_set = storage.utxos().get_all_utxos()
2025-11-09T23:42:54.8031158Z +            let mut utxo_set = storage
2025-11-09T23:42:54.8031284Z +                .utxos()
2025-11-09T23:42:54.8031417Z +                .get_all_utxos()
2025-11-09T23:42:54.8031695Z                  .map_err(|e| anyhow::anyhow!("Failed to get UTXO set: {}", e))?;
2025-11-09T23:42:54.8031819Z  
2025-11-09T23:42:54.8031999Z              // Verify blocks from start_height to tip
2025-11-09T23:42:54.8032478Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:572:
2025-11-09T23:42:54.8032653Z                                  // For now, just continue
2025-11-09T23:42:54.8032782Z                              }
2025-11-09T23:42:54.8033274Z                              Ok(bllvm_protocol::ValidationResult::Invalid(reason)) => {
2025-11-09T23:42:54.8033612Z -                                errors.push(format!("Block at height {} invalid: {}", height, reason));
2025-11-09T23:42:54.8033782Z +                                errors.push(format!(
2025-11-09T23:42:54.8033958Z +                                    "Block at height {} invalid: {}",
2025-11-09T23:42:54.8034109Z +                                    height, reason
2025-11-09T23:42:54.8036385Z +                                ));
2025-11-09T23:42:54.8036575Z                                  if check_level >= 4 {
2025-11-09T23:42:54.8036762Z                                      // Level 4: Stop on first error
2025-11-09T23:42:54.8036898Z                                      break;
2025-11-09T23:42:54.8037363Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:579:
2025-11-09T23:42:54.8037499Z                                  }
2025-11-09T23:42:54.8037635Z                              }
2025-11-09T23:42:54.8037771Z                              Err(e) => {
2025-11-09T23:42:54.8038132Z -                                errors.push(format!("Block at height {} validation error: {}", height, e));
2025-11-09T23:42:54.8038309Z +                                errors.push(format!(
2025-11-09T23:42:54.8038517Z +                                    "Block at height {} validation error: {}",
2025-11-09T23:42:54.8038664Z +                                    height, e
2025-11-09T23:42:54.8038803Z +                                ));
2025-11-09T23:42:54.8038951Z                                  if check_level >= 4 {
2025-11-09T23:42:54.8039086Z                                      break;
2025-11-09T23:42:54.8039215Z                                  }
2025-11-09T23:42:54.8039696Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:588:
2025-11-09T23:42:54.8039811Z  
2025-11-09T23:42:54.8040017Z                          // Check level 3: Verify block header linkage
2025-11-09T23:42:54.8040201Z                          if check_level >= 3 && height > 0 {
2025-11-09T23:42:54.8040560Z -                            if let Ok(Some(prev_hash)) = storage.blocks().get_hash_by_height(height - 1) {
2025-11-09T23:42:54.8040739Z +                            if let Ok(Some(prev_hash)) =
2025-11-09T23:42:54.8040976Z +                                storage.blocks().get_hash_by_height(height - 1)
2025-11-09T23:42:54.8041103Z +                            {
2025-11-09T23:42:54.8041585Z                                  if block.header.prev_block_hash != prev_hash {
2025-11-09T23:42:54.8041740Z                                      errors.push(format!(
2025-11-09T23:42:54.8042064Z                                          "Block at height {} has incorrect prev_block_hash: expected {}, got {}",
2025-11-09T23:42:54.8042513Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:606:
2025-11-09T23:42:54.8042685Z                          // Check level 2: Verify merkle root
2025-11-09T23:42:54.8042834Z                          if check_level >= 2 {
2025-11-09T23:42:54.8043069Z                              use bllvm_protocol::mining::calculate_merkle_root;
2025-11-09T23:42:54.8043389Z -                            if let Ok(calculated_root) = calculate_merkle_root(&block.transactions) {
2025-11-09T23:42:54.8043704Z +                            if let Ok(calculated_root) = calculate_merkle_root(&block.transactions)
2025-11-09T23:42:54.8043830Z +                            {
2025-11-09T23:42:54.8044065Z                                  if calculated_root != block.header.merkle_root {
2025-11-09T23:42:54.8046250Z                                      errors.push(format!(
2025-11-09T23:42:54.8046492Z                                          "Block at height {} has incorrect merkle root",
2025-11-09T23:42:54.8046941Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:657:
2025-11-09T23:42:54.8047299Z          if let Some(ref storage) = self.storage {
2025-11-09T23:42:54.8047474Z              // Get all chain tips (including forks)
2025-11-09T23:42:54.8047624Z              let mut tips = Vec::new();
2025-11-09T23:42:54.8047733Z -            
2025-11-09T23:42:54.8047844Z +
2025-11-09T23:42:54.8047971Z              // Add active tip
2025-11-09T23:42:54.8048208Z              if let Ok(Some(tip_hash)) = storage.chain().get_tip_hash() {
2025-11-09T23:42:54.8048463Z                  let tip_height = storage.chain().get_height()?.unwrap_or(0);
2025-11-09T23:42:54.8048931Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:668:
2025-11-09T23:42:54.8049074Z                      "status": "active"
2025-11-09T23:42:54.8049192Z                  }));
2025-11-09T23:42:54.8049313Z              }
2025-11-09T23:42:54.8049425Z -            
2025-11-09T23:42:54.8049536Z +
2025-11-09T23:42:54.8049716Z              // Add other tracked tips (forks, etc.)
2025-11-09T23:42:54.8049966Z              if let Ok(chain_tips) = storage.chain().get_chain_tips() {
2025-11-09T23:42:54.8050192Z                  for (hash, height, branchlen, status) in chain_tips {
2025-11-09T23:42:54.8050626Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:678:
2025-11-09T23:42:54.8050768Z                              continue;
2025-11-09T23:42:54.8051440Z                          }
2025-11-09T23:42:54.8051585Z                      }
2025-11-09T23:42:54.8051717Z -                    
2025-11-09T23:42:54.8051839Z +
2025-11-09T23:42:54.8051991Z                      tips.push(json!({
2025-11-09T23:42:54.8052142Z                          "height": height,
2025-11-09T23:42:54.8052335Z                          "hash": hex::encode(hash),
2025-11-09T23:42:54.8052823Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:687:
2025-11-09T23:42:54.8052950Z                      }));
2025-11-09T23:42:54.8053082Z                  }
2025-11-09T23:42:54.8053196Z              }
2025-11-09T23:42:54.8053312Z -            
2025-11-09T23:42:54.8053426Z +
2025-11-09T23:42:54.8053564Z              Ok(json!(tips))
2025-11-09T23:42:54.8053683Z          } else {
2025-11-09T23:42:54.8053811Z              Ok(json!([]))
2025-11-09T23:42:54.8056351Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:700:
2025-11-09T23:42:54.8056698Z      pub async fn get_chain_tx_stats(&self, params: &Value) -> Result<Value> {
2025-11-09T23:42:54.8056863Z          debug!("RPC: getchaintxstats");
2025-11-09T23:42:54.8057244Z  
2025-11-09T23:42:54.8057392Z -        let nblocks = params
2025-11-09T23:42:54.8057510Z -            .get(0)
2025-11-09T23:42:54.8057663Z -            .and_then(|p| p.as_u64())
2025-11-09T23:42:54.8057934Z -            .unwrap_or(144); // Default: 1 day (144 blocks at 10 min/block)
2025-11-09T23:42:54.8058421Z +        let nblocks = params.get(0).and_then(|p| p.as_u64()).unwrap_or(144); // Default: 1 day (144 blocks at 10 min/block)
2025-11-09T23:42:54.8058543Z  
2025-11-09T23:42:54.8058738Z          if let Some(ref storage) = self.storage {
2025-11-09T23:42:54.8059009Z              let tip_height = storage.chain().get_height()?.unwrap_or(0);
2025-11-09T23:42:54.8059487Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:710:
2025-11-09T23:42:54.8059620Z -            
2025-11-09T23:42:54.8059734Z +
2025-11-09T23:42:54.8059875Z              if tip_height == 0 {
2025-11-09T23:42:54.8060012Z                  return Ok(json!({
2025-11-09T23:42:54.8060164Z                      "time": 0,
2025-11-09T23:42:54.8060633Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:729:
2025-11-09T23:42:54.8060815Z              // Get timestamps and transaction counts
2025-11-09T23:42:54.8061008Z              let mut timestamps = Vec::new();
2025-11-09T23:42:54.8061176Z              let mut tx_counts = Vec::new();
2025-11-09T23:42:54.8061630Z -            
2025-11-09T23:42:54.8061745Z +
2025-11-09T23:42:54.8061951Z              for height in start_height..=tip_height {
2025-11-09T23:42:54.8062256Z                  if let Ok(Some(hash)) = storage.blocks().get_hash_by_height(height) {
2025-11-09T23:42:54.8062514Z                      if let Ok(Some(block)) = storage.blocks().get_block(&hash) {
2025-11-09T23:42:54.8063007Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:756:
2025-11-09T23:42:54.8063336Z              let window_interval = last_timestamp.saturating_sub(first_timestamp);
2025-11-09T23:42:54.8063553Z              let window_tx_count: u64 = tx_counts.iter().sum();
2025-11-09T23:42:54.8063758Z              let window_block_count = timestamps.len() as u64;
2025-11-09T23:42:54.8063865Z -            
2025-11-09T23:42:54.8063968Z +
2025-11-09T23:42:54.8064127Z              let txrate = if window_interval > 0 {
2025-11-09T23:42:54.8064330Z                  window_tx_count as f64 / window_interval as f64
2025-11-09T23:42:54.8064450Z              } else {
2025-11-09T23:42:54.8064898Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:794:
2025-11-09T23:42:54.8065210Z      pub async fn get_block_stats(&self, params: &Value) -> Result<Value> {
2025-11-09T23:42:54.8065362Z          debug!("RPC: getblockstats");
2025-11-09T23:42:54.8065470Z  
2025-11-09T23:42:54.8065683Z -        let hash_or_height: Option<String> = params.get(0)
2025-11-09T23:42:54.8065863Z +        let hash_or_height: Option<String> = params
2025-11-09T23:42:54.8065993Z +            .get(0)
2025-11-09T23:42:54.8066142Z              .and_then(|p| p.as_str())
2025-11-09T23:42:54.8066487Z              .map(|s| s.to_string())
2025-11-09T23:42:54.8066621Z              .or_else(|| {
2025-11-09T23:42:54.8067096Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:801:
2025-11-09T23:42:54.8067245Z -                params.get(0)
2025-11-09T23:42:54.8067367Z +                params
2025-11-09T23:42:54.8067509Z +                    .get(0)
2025-11-09T23:42:54.8067672Z                      .and_then(|p| p.as_u64())
2025-11-09T23:42:54.8067832Z                      .map(|h| h.to_string())
2025-11-09T23:42:54.8067951Z              });
2025-11-09T23:42:54.8068416Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:808:
2025-11-09T23:42:54.8068647Z              let block_hash = if let Some(hoh) = hash_or_height {
2025-11-09T23:42:54.8068815Z                  // Try to parse as height first
2025-11-09T23:42:54.8069264Z                  if let Ok(height) = hoh.parse::<u64>() {
2025-11-09T23:42:54.8069469Z -                    storage.blocks().get_hash_by_height(height)?
2025-11-09T23:42:54.8069605Z +                    storage
2025-11-09T23:42:54.8069737Z +                        .blocks()
2025-11-09T23:42:54.8069902Z +                        .get_hash_by_height(height)?
2025-11-09T23:42:54.8070229Z                          .ok_or_else(|| anyhow::anyhow!("Block at height {} not found", height))?
2025-11-09T23:42:54.8070362Z                  } else {
2025-11-09T23:42:54.8070493Z                      // Parse as hash
2025-11-09T23:42:54.8070941Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:823:
2025-11-09T23:42:54.8071047Z                  }
2025-11-09T23:42:54.8071152Z              } else {
2025-11-09T23:42:54.8071276Z                  // Default to tip
2025-11-09T23:42:54.8071438Z -                storage.chain().get_tip_hash()?
2025-11-09T23:42:54.8071561Z +                storage
2025-11-09T23:42:54.8071694Z +                    .chain()
2025-11-09T23:42:54.8071843Z +                    .get_tip_hash()?
2025-11-09T23:42:54.8072096Z                      .ok_or_else(|| anyhow::anyhow!("Chain not initialized"))?
2025-11-09T23:42:54.8072215Z              };
2025-11-09T23:42:54.8072337Z  
2025-11-09T23:42:54.8072808Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:831:
2025-11-09T23:42:54.8073230Z                  let tx_count = block.transactions.len();
2025-11-09T23:42:54.8073462Z                  let block_size = bincode::serialize(&block)?.len();
2025-11-09T23:42:54.8073840Z                  let block_weight = block_size; // Simplified - would calculate weight properly
2025-11-09T23:42:54.8073947Z -                
2025-11-09T23:42:54.8074045Z +
2025-11-09T23:42:54.8074175Z                  // Get block height
2025-11-09T23:42:54.8074624Z -                let height = storage.blocks().get_height_by_hash(&block_hash)?
2025-11-09T23:42:54.8074787Z +                let height = storage
2025-11-09T23:42:54.8074914Z +                    .blocks()
2025-11-09T23:42:54.8075070Z +                    .get_height_by_hash(&block_hash)?
2025-11-09T23:42:54.8075206Z                      .unwrap_or(0);
2025-11-09T23:42:54.8075323Z -                
2025-11-09T23:42:54.8075437Z +
2025-11-09T23:42:54.8075584Z                  // Count inputs and outputs
2025-11-09T23:42:54.8075815Z -                let input_count: usize = block.transactions.iter()
2025-11-09T23:42:54.8075982Z -                    .map(|tx| tx.inputs.len())
2025-11-09T23:42:54.8076107Z -                    .sum();
2025-11-09T23:42:54.8078217Z -                let output_count: usize = block.transactions.iter()
2025-11-09T23:42:54.8078367Z -                    .map(|tx| tx.outputs.len())
2025-11-09T23:42:54.8078487Z -                    .sum();
2025-11-09T23:42:54.8078588Z -                
2025-11-09T23:42:54.8078965Z +                let input_count: usize = block.transactions.iter().map(|tx| tx.inputs.len()).sum();
2025-11-09T23:42:54.8079130Z +                let output_count: usize =
2025-11-09T23:42:54.8079399Z +                    block.transactions.iter().map(|tx| tx.outputs.len()).sum();
2025-11-09T23:42:54.8079500Z +
2025-11-09T23:42:54.8079627Z                  // Sum output values
2025-11-09T23:42:54.8079822Z -                let total_out: u64 = block.transactions.iter()
2025-11-09T23:42:54.8079964Z +                let total_out: u64 = block
2025-11-09T23:42:54.8080084Z +                    .transactions
2025-11-09T23:42:54.8080200Z +                    .iter()
2025-11-09T23:42:54.8080355Z                      .flat_map(|tx| tx.outputs.iter())
2025-11-09T23:42:54.8080505Z                      .map(|out| out.value as u64)
2025-11-09T23:42:54.8080660Z                      .sum::<u64>();
2025-11-09T23:42:54.8081137Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:852:
2025-11-09T23:42:54.8081249Z -                
2025-11-09T23:42:54.8081605Z +
2025-11-09T23:42:54.8081764Z                  // Calculate block subsidy
2025-11-09T23:42:54.8081999Z                  let subsidy = Self::calculate_block_subsidy(height);
2025-11-09T23:42:54.8082112Z -                
2025-11-09T23:42:54.8082222Z +
2025-11-09T23:42:54.8082584Z                  // Calculate total fees (simplified - would need UTXO set for accurate calculation)
2025-11-09T23:42:54.8082900Z                  // For now, estimate: total_out - (subsidy * 100_000_000) if coinbase exists
2025-11-09T23:42:54.8083146Z                  let total_fees = if !block.transactions.is_empty() {
2025-11-09T23:42:54.8083580Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:859:
2025-11-09T23:42:54.8083735Z                      // Coinbase is first transaction
2025-11-09T23:42:54.8084005Z -                    let coinbase_outputs: u64 = block.transactions[0].outputs.iter()
2025-11-09T23:42:54.8084211Z +                    let coinbase_outputs: u64 = block.transactions[0]
2025-11-09T23:42:54.8084509Z +                        .outputs
2025-11-09T23:42:54.8084646Z +                        .iter()
2025-11-09T23:42:54.8084809Z                          .map(|out| out.value as u64)
2025-11-09T23:42:54.8084928Z                          .sum();
2025-11-09T23:42:54.8085207Z                      // Fee = total outputs - (coinbase outputs which include subsidy)
2025-11-09T23:42:54.8087550Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:903:
2025-11-09T23:42:54.8087923Z              }
2025-11-09T23:42:54.8088027Z          } else {
2025-11-09T23:42:54.8088351Z              // Graceful degradation: return informative error instead of failing silently
2025-11-09T23:42:54.8088790Z -            Err(anyhow::anyhow!("Storage not available. This operation requires storage to be initialized."))
2025-11-09T23:42:54.8088920Z +            Err(anyhow::anyhow!(
2025-11-09T23:42:54.8089239Z +                "Storage not available. This operation requires storage to be initialized."
2025-11-09T23:42:54.8089356Z +            ))
2025-11-09T23:42:54.8089457Z          }
2025-11-09T23:42:54.8089556Z      }
2025-11-09T23:42:54.8089660Z  
2025-11-09T23:42:54.8090087Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:913:
2025-11-09T23:42:54.8090406Z      pub async fn prune_blockchain(&self, params: &Value) -> Result<Value> {
2025-11-09T23:42:54.8090588Z          debug!("RPC: pruneblockchain");
2025-11-09T23:42:54.8090707Z  
2025-11-09T23:42:54.8090861Z -        let height = params.get(0)
2025-11-09T23:42:54.8090998Z +        let height = params
2025-11-09T23:42:54.8091225Z +            .get(0)
2025-11-09T23:42:54.8091386Z              .and_then(|p| p.as_u64())
2025-11-09T23:42:54.8091661Z              .ok_or_else(|| anyhow::anyhow!("Height parameter required"))?;
2025-11-09T23:42:54.8091764Z  
2025-11-09T23:42:54.8092220Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:920:
2025-11-09T23:42:54.8092407Z          if let Some(ref storage) = self.storage {
2025-11-09T23:42:54.8092652Z              let tip_height = storage.chain().get_height()?.unwrap_or(0);
2025-11-09T23:42:54.8092762Z -            
2025-11-09T23:42:54.8093348Z +
2025-11-09T23:42:54.8093673Z              // Check if IBD is in progress (height == 0 indicates no blocks synced)
2025-11-09T23:42:54.8093847Z              let is_ibd = tip_height == 0;
2025-11-09T23:42:54.8093973Z -            
2025-11-09T23:42:54.8094086Z +
2025-11-09T23:42:54.8094232Z              if height >= tip_height {
2025-11-09T23:42:54.8094888Z -                return Err(anyhow::anyhow!("Cannot prune to height >= tip height ({} >= {})", height, tip_height));
2025-11-09T23:42:54.8095062Z +                return Err(anyhow::anyhow!(
2025-11-09T23:42:54.8095289Z +                    "Cannot prune to height >= tip height ({} >= {})",
2025-11-09T23:42:54.8095425Z +                    height,
2025-11-09T23:42:54.8095556Z +                    tip_height
2025-11-09T23:42:54.8095922Z +                ));
2025-11-09T23:42:54.8096032Z              }
2025-11-09T23:42:54.8096144Z  
2025-11-09T23:42:54.8096286Z              // Get pruning manager
2025-11-09T23:42:54.8096746Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:931:
2025-11-09T23:42:54.8096981Z              if let Some(pruning_manager) = storage.pruning() {
2025-11-09T23:42:54.8097134Z                  // Perform pruning
2025-11-09T23:42:54.8097475Z                  let stats = pruning_manager.prune_to_height(height, tip_height, is_ibd)?;
2025-11-09T23:42:54.8097601Z -                
2025-11-09T23:42:54.8097709Z +
2025-11-09T23:42:54.8097877Z                  // Flush storage to persist changes
2025-11-09T23:42:54.8098010Z                  storage.flush()?;
2025-11-09T23:42:54.8098129Z -                
2025-11-09T23:42:54.8098236Z +
2025-11-09T23:42:54.8098360Z                  Ok(json!({
2025-11-09T23:42:54.8098515Z                      "pruned_height": height,
2025-11-09T23:42:54.8098713Z                      "blocks_pruned": stats.blocks_pruned,
2025-11-09T23:42:54.8099173Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:943:
2025-11-09T23:42:54.8099366Z                      "storage_freed_bytes": stats.storage_freed,
2025-11-09T23:42:54.8099489Z                  }))
2025-11-09T23:42:54.8099609Z              } else {
2025-11-09T23:42:54.8100234Z -                Err(anyhow::anyhow!("Pruning is not enabled. Configure pruning in node configuration."))
2025-11-09T23:42:54.8100400Z +                Err(anyhow::anyhow!(
2025-11-09T23:42:54.8100689Z +                    "Pruning is not enabled. Configure pruning in node configuration."
2025-11-09T23:42:54.8100809Z +                ))
2025-11-09T23:42:54.8100925Z              }
2025-11-09T23:42:54.8101053Z          } else {
2025-11-09T23:42:54.8101417Z              // Graceful degradation: return informative error instead of failing silently
2025-11-09T23:42:54.8101899Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:950:
2025-11-09T23:42:54.8102396Z -            Err(anyhow::anyhow!("Storage not available. This operation requires storage to be initialized."))
2025-11-09T23:42:54.8102548Z +            Err(anyhow::anyhow!(
2025-11-09T23:42:54.8102901Z +                "Storage not available. This operation requires storage to be initialized."
2025-11-09T23:42:54.8103029Z +            ))
2025-11-09T23:42:54.8103138Z          }
2025-11-09T23:42:54.8103237Z      }
2025-11-09T23:42:54.8103335Z  
2025-11-09T23:42:54.8103770Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:960:
2025-11-09T23:42:54.8103941Z          if let Some(ref storage) = self.storage {
2025-11-09T23:42:54.8104189Z              let tip_height = storage.chain().get_height()?.unwrap_or(0);
2025-11-09T23:42:54.8104596Z              let is_pruning_enabled = storage.is_pruning_enabled();
2025-11-09T23:42:54.8106560Z -            
2025-11-09T23:42:54.8106673Z +
2025-11-09T23:42:54.8106869Z              if let Some(pruning_manager) = storage.pruning() {
2025-11-09T23:42:54.8107042Z                  let stats = pruning_manager.get_stats();
2025-11-09T23:42:54.8107226Z                  let config = &pruning_manager.config;
2025-11-09T23:42:54.8107683Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:967:
2025-11-09T23:42:54.8107806Z -                
2025-11-09T23:42:54.8107904Z +
2025-11-09T23:42:54.8108043Z                  // Determine pruning mode
2025-11-09T23:42:54.8108208Z                  let mode_str = match &config.mode {
2025-11-09T23:42:54.8108424Z                      crate::config::PruningMode::Disabled => "disabled",
2025-11-09T23:42:54.8108834Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:975:
2025-11-09T23:42:54.8109080Z                      _ => "unknown", // Fallback for Aggressive if feature not enabled
2025-11-09T23:42:54.8109307Z                      crate::config::PruningMode::Custom { .. } => "custom",
2025-11-09T23:42:54.8109615Z                  };
2025-11-09T23:42:54.8109719Z -                
2025-11-09T23:42:54.8109826Z +
2025-11-09T23:42:54.8109940Z                  Ok(json!({
2025-11-09T23:42:54.8110103Z                      "pruning_enabled": is_pruning_enabled,
2025-11-09T23:42:54.8110237Z                      "mode": mode_str,
2025-11-09T23:42:54.8110716Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1013:
2025-11-09T23:42:54.8111047Z      pub async fn invalidate_block(&self, params: &Value) -> Result<Value> {
2025-11-09T23:42:54.8111202Z          debug!("RPC: invalidateblock");
2025-11-09T23:42:54.8111312Z  
2025-11-09T23:42:54.8111474Z -        let blockhash = params.get(0)
2025-11-09T23:42:54.8111602Z +        let blockhash = params
2025-11-09T23:42:54.8111707Z +            .get(0)
2025-11-09T23:42:54.8111839Z              .and_then(|p| p.as_str())
2025-11-09T23:42:54.8112207Z              .ok_or_else(|| anyhow::anyhow!("Block hash parameter required"))?;
2025-11-09T23:42:54.8112318Z  
2025-11-09T23:42:54.8112821Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1020:
2025-11-09T23:42:54.8113019Z -        let hash_bytes = hex::decode(blockhash)
2025-11-09T23:42:54.8113332Z -            .map_err(|e| anyhow::anyhow!("Invalid block hash: {}", e))?;
2025-11-09T23:42:54.8113652Z +        let hash_bytes =
2025-11-09T23:42:54.8114123Z +            hex::decode(blockhash).map_err(|e| anyhow::anyhow!("Invalid block hash: {}", e))?;
2025-11-09T23:42:54.8116354Z          if hash_bytes.len() != 32 {
2025-11-09T23:42:54.8125121Z              return Err(anyhow::anyhow!("Block hash must be 32 bytes"));
2025-11-09T23:42:54.8125299Z          }
2025-11-09T23:42:54.8125814Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1028:
2025-11-09T23:42:54.8126008Z          if let Some(ref storage) = self.storage {
2025-11-09T23:42:54.8126185Z              // Mark block as invalid
2025-11-09T23:42:54.8126358Z              storage.chain().mark_invalid(&hash)?;
2025-11-09T23:42:54.8126476Z -            
2025-11-09T23:42:54.8126599Z +
2025-11-09T23:42:54.8126918Z              // Check if this is the current tip - if so, we'd need to trigger a reorg
2025-11-09T23:42:54.8127239Z              // For now, we just mark it as invalid and let the node handle it on next block
2025-11-09T23:42:54.8127508Z              if let Ok(Some(tip_hash)) = storage.chain().get_tip_hash() {
2025-11-09T23:42:54.8127992Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1040:
2025-11-09T23:42:54.8128125Z              Ok(json!(null))
2025-11-09T23:42:54.8128239Z          } else {
2025-11-09T23:42:54.8128598Z              // Graceful degradation: return informative error instead of failing silently
2025-11-09T23:42:54.8129073Z -            Err(anyhow::anyhow!("Storage not available. This operation requires storage to be initialized."))
2025-11-09T23:42:54.8129217Z +            Err(anyhow::anyhow!(
2025-11-09T23:42:54.8129552Z +                "Storage not available. This operation requires storage to be initialized."
2025-11-09T23:42:54.8129667Z +            ))
2025-11-09T23:42:54.8129775Z          }
2025-11-09T23:42:54.8129890Z      }
2025-11-09T23:42:54.8129996Z  
2025-11-09T23:42:54.8130466Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1050:
2025-11-09T23:42:54.8130769Z      pub async fn reconsider_block(&self, params: &Value) -> Result<Value> {
2025-11-09T23:42:54.8130924Z          debug!("RPC: reconsiderblock");
2025-11-09T23:42:54.8131022Z  
2025-11-09T23:42:54.8131173Z -        let blockhash = params.get(0)
2025-11-09T23:42:54.8131327Z +        let blockhash = params
2025-11-09T23:42:54.8131441Z +            .get(0)
2025-11-09T23:42:54.8131583Z              .and_then(|p| p.as_str())
2025-11-09T23:42:54.8131849Z              .ok_or_else(|| anyhow::anyhow!("Block hash parameter required"))?;
2025-11-09T23:42:54.8132199Z  
2025-11-09T23:42:54.8132637Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1057:
2025-11-09T23:42:54.8132797Z -        let hash_bytes = hex::decode(blockhash)
2025-11-09T23:42:54.8133043Z -            .map_err(|e| anyhow::anyhow!("Invalid block hash: {}", e))?;
2025-11-09T23:42:54.8133165Z +        let hash_bytes =
2025-11-09T23:42:54.8133564Z +            hex::decode(blockhash).map_err(|e| anyhow::anyhow!("Invalid block hash: {}", e))?;
2025-11-09T23:42:54.8133755Z          if hash_bytes.len() != 32 {
2025-11-09T23:42:54.8134078Z              return Err(anyhow::anyhow!("Block hash must be 32 bytes"));
2025-11-09T23:42:54.8134179Z          }
2025-11-09T23:42:54.8134881Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1065:
2025-11-09T23:42:54.8135187Z          if let Some(ref storage) = self.storage {
2025-11-09T23:42:54.8135342Z              // Remove from invalid blocks set
2025-11-09T23:42:54.8135514Z              storage.chain().unmark_invalid(&hash)?;
2025-11-09T23:42:54.8135624Z -            
2025-11-09T23:42:54.8135722Z +
2025-11-09T23:42:54.8136009Z              // If this block is now valid, it may be reconsidered for chain inclusion
2025-11-09T23:42:54.8136213Z              // The node will handle this on next block processing
2025-11-09T23:42:54.8138323Z  
2025-11-09T23:42:54.8138784Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1072:
2025-11-09T23:42:54.8139111Z              Ok(json!(null))
2025-11-09T23:42:54.8139224Z          } else {
2025-11-09T23:42:54.8139551Z              // Graceful degradation: return informative error instead of failing silently
2025-11-09T23:42:54.8140045Z -            Err(anyhow::anyhow!("Storage not available. This operation requires storage to be initialized."))
2025-11-09T23:42:54.8140188Z +            Err(anyhow::anyhow!(
2025-11-09T23:42:54.8140598Z +                "Storage not available. This operation requires storage to be initialized."
2025-11-09T23:42:54.8140709Z +            ))
2025-11-09T23:42:54.8140809Z          }
2025-11-09T23:42:54.8140959Z      }
2025-11-09T23:42:54.8141060Z  
2025-11-09T23:42:54.8141576Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1079:
2025-11-09T23:42:54.8141789Z      /// Wait for new block
2025-11-09T23:42:54.8141957Z      ///
2025-11-09T23:42:54.8142372Z      /// Params: ["timeout"] (optional, timeout in seconds, default: no timeout)
2025-11-09T23:42:54.8142488Z -    /// 
2025-11-09T23:42:54.8142612Z +    ///
2025-11-09T23:42:54.8142940Z      /// Note: Full implementation requires async notification infrastructure.
2025-11-09T23:42:54.8143260Z      /// Currently returns current tip immediately. Future enhancement will:
2025-11-09T23:42:54.8143494Z      /// 1. Subscribe to block notifications
2025-11-09T23:42:54.8143960Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1088:
2025-11-09T23:42:54.8144932Z      pub async fn wait_for_new_block(&self, params: &Value) -> Result<Value> {
2025-11-09T23:42:54.8145159Z          debug!("RPC: waitfornewblock");
2025-11-09T23:42:54.8145275Z  
2025-11-09T23:42:54.8145434Z -        let _timeout = params.get(0)
2025-11-09T23:42:54.8145582Z +        let _timeout = params
2025-11-09T23:42:54.8147708Z +            .get(0)
2025-11-09T23:42:54.8147867Z              .and_then(|p| p.as_u64())
2025-11-09T23:42:54.8148094Z              .map(|t| tokio::time::Duration::from_secs(t));
2025-11-09T23:42:54.8148212Z  
2025-11-09T23:42:54.8148678Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1104:
2025-11-09T23:42:54.8148792Z              }
2025-11-09T23:42:54.8149736Z          } else {
2025-11-09T23:42:54.8150154Z              // Graceful degradation: return informative error instead of failing silently
2025-11-09T23:42:54.8150662Z -            Err(anyhow::anyhow!("Storage not available. This operation requires storage to be initialized."))
2025-11-09T23:42:54.8151089Z +            Err(anyhow::anyhow!(
2025-11-09T23:42:54.8151474Z +                "Storage not available. This operation requires storage to be initialized."
2025-11-09T23:42:54.8151596Z +            ))
2025-11-09T23:42:54.8151710Z          }
2025-11-09T23:42:54.8151828Z      }
2025-11-09T23:42:54.8151939Z  
2025-11-09T23:42:54.8152420Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1111:
2025-11-09T23:42:54.8152571Z      /// Wait for specific block
2025-11-09T23:42:54.8152689Z      ///
2025-11-09T23:42:54.8152974Z      /// Params: ["blockhash", "timeout"] (block hash, optional timeout)
2025-11-09T23:42:54.8153090Z -    /// 
2025-11-09T23:42:54.8153203Z +    ///
2025-11-09T23:42:54.8153536Z      /// Note: Full implementation requires async notification infrastructure.
2025-11-09T23:42:54.8153858Z      /// Currently checks if block exists immediately. Future enhancement will:
2025-11-09T23:42:54.8154021Z      /// 1. Subscribe to block notifications
2025-11-09T23:42:54.8154711Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1120:
2025-11-09T23:42:54.8155029Z      pub async fn wait_for_block(&self, params: &Value) -> Result<Value> {
2025-11-09T23:42:54.8155188Z          debug!("RPC: waitforblock");
2025-11-09T23:42:54.8155309Z  
2025-11-09T23:42:54.8155529Z -        let blockhash = params.get(0)
2025-11-09T23:42:54.8155927Z +        let blockhash = params
2025-11-09T23:42:54.8156049Z +            .get(0)
2025-11-09T23:42:54.8156196Z              .and_then(|p| p.as_str())
2025-11-09T23:42:54.8156478Z              .ok_or_else(|| anyhow::anyhow!("Block hash parameter required"))?;
2025-11-09T23:42:54.8156588Z  
2025-11-09T23:42:54.8157051Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1127:
2025-11-09T23:42:54.8157198Z -        let _timeout = params.get(1)
2025-11-09T23:42:54.8157327Z +        let _timeout = params
2025-11-09T23:42:54.8157448Z +            .get(1)
2025-11-09T23:42:54.8157580Z              .and_then(|p| p.as_u64())
2025-11-09T23:42:54.8157766Z              .map(|t| tokio::time::Duration::from_secs(t));
2025-11-09T23:42:54.8157865Z  
2025-11-09T23:42:54.8158307Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1131:
2025-11-09T23:42:54.8158470Z -        let hash_bytes = hex::decode(blockhash)
2025-11-09T23:42:54.8158710Z -            .map_err(|e| anyhow::anyhow!("Invalid block hash: {}", e))?;
2025-11-09T23:42:54.8158835Z +        let hash_bytes =
2025-11-09T23:42:54.8159193Z +            hex::decode(blockhash).map_err(|e| anyhow::anyhow!("Invalid block hash: {}", e))?;
2025-11-09T23:42:54.8159330Z          if hash_bytes.len() != 32 {
2025-11-09T23:42:54.8159578Z              return Err(anyhow::anyhow!("Block hash must be 32 bytes"));
2025-11-09T23:42:54.8159682Z          }
2025-11-09T23:42:54.8160104Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1140:
2025-11-09T23:42:54.8160279Z          // For now, check if block exists immediately
2025-11-09T23:42:54.8160447Z          if let Some(ref storage) = self.storage {
2025-11-09T23:42:54.8160666Z              if let Ok(Some(_block)) = storage.blocks().get_block(&hash) {
2025-11-09T23:42:54.8160887Z -                let height = storage.blocks().get_height_by_hash(&hash)?
2025-11-09T23:42:54.8161017Z -                    .unwrap_or(0);
2025-11-09T23:42:54.8161313Z +                let height = storage.blocks().get_height_by_hash(&hash)?.unwrap_or(0);
2025-11-09T23:42:54.8161441Z                  Ok(json!({
2025-11-09T23:42:54.8161591Z                      "hash": blockhash,
2025-11-09T23:42:54.8161730Z                      "height": height
2025-11-09T23:42:54.8162203Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1151:
2025-11-09T23:42:54.8162325Z              }
2025-11-09T23:42:54.8162455Z          } else {
2025-11-09T23:42:54.8162826Z              // Graceful degradation: return informative error instead of failing silently
2025-11-09T23:42:54.8163519Z -            Err(anyhow::anyhow!("Storage not available. This operation requires storage to be initialized."))
2025-11-09T23:42:54.8163666Z +            Err(anyhow::anyhow!(
2025-11-09T23:42:54.8163986Z +                "Storage not available. This operation requires storage to be initialized."
2025-11-09T23:42:54.8164093Z +            ))
2025-11-09T23:42:54.8164209Z          }
2025-11-09T23:42:54.8164481Z      }
2025-11-09T23:42:54.8164586Z  
2025-11-09T23:42:54.8165033Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1158:
2025-11-09T23:42:54.8165169Z      /// Wait for block height
2025-11-09T23:42:54.8165270Z      ///
2025-11-09T23:42:54.8165531Z      /// Params: ["height", "timeout"] (block height, optional timeout)
2025-11-09T23:42:54.8165651Z -    /// 
2025-11-09T23:42:54.8165767Z +    ///
2025-11-09T23:42:54.8166095Z      /// Note: Full implementation requires async notification infrastructure.
2025-11-09T23:42:54.8166490Z      /// Currently checks if block at height exists immediately. Future enhancement will:
2025-11-09T23:42:54.8166665Z      /// 1. Subscribe to block notifications
2025-11-09T23:42:54.8167143Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1167:
2025-11-09T23:42:54.8167488Z      pub async fn wait_for_block_height(&self, params: &Value) -> Result<Value> {
2025-11-09T23:42:54.8167906Z          debug!("RPC: waitforblockheight");
2025-11-09T23:42:54.8168021Z  
2025-11-09T23:42:54.8168167Z -        let height = params.get(0)
2025-11-09T23:42:54.8168303Z +        let height = params
2025-11-09T23:42:54.8168413Z +            .get(0)
2025-11-09T23:42:54.8168553Z              .and_then(|p| p.as_u64())
2025-11-09T23:42:54.8168821Z              .ok_or_else(|| anyhow::anyhow!("Height parameter required"))?;
2025-11-09T23:42:54.8168937Z  
2025-11-09T23:42:54.8169392Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1174:
2025-11-09T23:42:54.8169545Z -        let _timeout = params.get(1)
2025-11-09T23:42:54.8169680Z +        let _timeout = params
2025-11-09T23:42:54.8169788Z +            .get(1)
2025-11-09T23:42:54.8169922Z              .and_then(|p| p.as_u64())
2025-11-09T23:42:54.8170110Z              .map(|t| tokio::time::Duration::from_secs(t));
2025-11-09T23:42:54.8170287Z          if let Some(ref storage) = self.storage {
2025-11-09T23:42:54.8170737Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1186:
2025-11-09T23:42:54.8170991Z                      Err(anyhow::anyhow!("Block at height {} not found", height))
2025-11-09T23:42:54.8171106Z                  }
2025-11-09T23:42:54.8171217Z              } else {
2025-11-09T23:42:54.8171596Z -                Err(anyhow::anyhow!("Block at height {} not yet available (tip: {})", height, tip_height))
2025-11-09T23:42:54.8171740Z +                Err(anyhow::anyhow!(
2025-11-09T23:42:54.8171953Z +                    "Block at height {} not yet available (tip: {})",
2025-11-09T23:42:54.8172081Z +                    height,
2025-11-09T23:42:54.8172206Z +                    tip_height
2025-11-09T23:42:54.8172327Z +                ))
2025-11-09T23:42:54.8172436Z              }
2025-11-09T23:42:54.8172546Z          } else {
2025-11-09T23:42:54.8173483Z              // Graceful degradation: return informative error instead of failing silently
2025-11-09T23:42:54.8173977Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1193:
2025-11-09T23:42:54.8174612Z -            Err(anyhow::anyhow!("Storage not available. This operation requires storage to be initialized."))
2025-11-09T23:42:54.8174762Z +            Err(anyhow::anyhow!(
2025-11-09T23:42:54.8175102Z +                "Storage not available. This operation requires storage to be initialized."
2025-11-09T23:42:54.8175210Z +            ))
2025-11-09T23:42:54.8175317Z          }
2025-11-09T23:42:54.8175635Z      }
2025-11-09T23:42:54.8175741Z  
2025-11-09T23:42:54.8176194Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1200:
2025-11-09T23:42:54.8176496Z      pub async fn get_block_filter(&self, params: &Value) -> Result<Value> {
2025-11-09T23:42:54.8176644Z          debug!("RPC: getblockfilter");
2025-11-09T23:42:54.8176749Z  
2025-11-09T23:42:54.8176895Z -        let blockhash = params.get(0)
2025-11-09T23:42:54.8177044Z +        let blockhash = params
2025-11-09T23:42:54.8177155Z +            .get(0)
2025-11-09T23:42:54.8177289Z              .and_then(|p| p.as_str())
2025-11-09T23:42:54.8177565Z              .ok_or_else(|| anyhow::anyhow!("Block hash parameter required"))?;
2025-11-09T23:42:54.8177670Z  
2025-11-09T23:42:54.8178115Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1207:
2025-11-09T23:42:54.8178273Z -        let filtertype = params.get(1)
2025-11-09T23:42:54.8178409Z -            .and_then(|p| p.as_u64())
2025-11-09T23:42:54.8178583Z -            .unwrap_or(0); // Default: Basic filter
2025-11-09T23:42:54.8178977Z +        let filtertype = params.get(1).and_then(|p| p.as_u64()).unwrap_or(0); // Default: Basic filter
2025-11-09T23:42:54.8179094Z  
2025-11-09T23:42:54.8179227Z          if filtertype != 0 {
2025-11-09T23:42:54.8179537Z              return Err(anyhow::anyhow!("Only filter type 0 (Basic) is supported"));
2025-11-09T23:42:54.8180155Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1213:
2025-11-09T23:42:54.8180259Z          }
2025-11-09T23:42:54.8180365Z  
2025-11-09T23:42:54.8180545Z -        let hash_bytes = hex::decode(blockhash)
2025-11-09T23:42:54.8180784Z -            .map_err(|e| anyhow::anyhow!("Invalid block hash: {}", e))?;
2025-11-09T23:42:54.8180908Z +        let hash_bytes =
2025-11-09T23:42:54.8181273Z +            hex::decode(blockhash).map_err(|e| anyhow::anyhow!("Invalid block hash: {}", e))?;
2025-11-09T23:42:54.8181420Z          if hash_bytes.len() != 32 {
2025-11-09T23:42:54.8181677Z              return Err(anyhow::anyhow!("Block hash must be 32 bytes"));
2025-11-09T23:42:54.8181784Z          }
2025-11-09T23:42:54.8182234Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1226:
2025-11-09T23:42:54.8182459Z                  // Get filter service from network manager (if available)
2025-11-09T23:42:54.8182626Z                  // For now, generate filter directly
2025-11-09T23:42:54.8182855Z                  use bllvm_protocol::bip158::build_block_filter;
2025-11-09T23:42:54.8182970Z -                
2025-11-09T23:42:54.8183082Z +
2025-11-09T23:42:54.8183286Z                  // Get previous outpoint scripts from UTXO set
2025-11-09T23:42:54.8183537Z                  // For each input, find the UTXO and get its script_pubkey
2025-11-09T23:42:54.8183724Z                  let mut previous_scripts = Vec::new();
2025-11-09T23:42:54.8184188Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1239:
2025-11-09T23:42:54.8184466Z                          }
2025-11-09T23:42:54.8184587Z                      }
2025-11-09T23:42:54.8184701Z                  }
2025-11-09T23:42:54.8184814Z -                
2025-11-09T23:42:54.8184932Z +
2025-11-09T23:42:54.8185248Z                  match build_block_filter(&block.transactions, &previous_scripts) {
2025-11-09T23:42:54.8185385Z                      Ok(filter) => {
2025-11-09T23:42:54.8185529Z                          Ok(json!({
2025-11-09T23:42:54.8185998Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1247:
2025-11-09T23:42:54.8186288Z                              "header": hex::encode([0u8; 32]), // Would calculate filter header
2025-11-09T23:42:54.8186424Z                          }))
2025-11-09T23:42:54.8186537Z                      }
2025-11-09T23:42:54.8186800Z -                    Err(e) => Err(anyhow::anyhow!("Failed to build filter: {}", e))
2025-11-09T23:42:54.8187052Z +                    Err(e) => Err(anyhow::anyhow!("Failed to build filter: {}", e)),
2025-11-09T23:42:54.8187371Z                  }
2025-11-09T23:42:54.8187489Z              } else {
2025-11-09T23:42:54.8187664Z                  Err(anyhow::anyhow!("Block not found"))
2025-11-09T23:42:54.8188126Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1254:
2025-11-09T23:42:54.8188239Z              }
2025-11-09T23:42:54.8188354Z          } else {
2025-11-09T23:42:54.8188708Z              // Graceful degradation: return informative error instead of failing silently
2025-11-09T23:42:54.8189186Z -            Err(anyhow::anyhow!("Storage not available. This operation requires storage to be initialized."))
2025-11-09T23:42:54.8189331Z +            Err(anyhow::anyhow!(
2025-11-09T23:42:54.8189686Z +                "Storage not available. This operation requires storage to be initialized."
2025-11-09T23:42:54.8189807Z +            ))
2025-11-09T23:42:54.8189918Z          }
2025-11-09T23:42:54.8190039Z      }
2025-11-09T23:42:54.8190153Z  
2025-11-09T23:42:54.8190794Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/control.rs:89:
2025-11-09T23:42:54.8191130Z      pub async fn getmemoryinfo(&self, params: &Value) -> RpcResult<Value> {
2025-11-09T23:42:54.8191298Z          debug!("RPC: getmemoryinfo");
2025-11-09T23:42:54.8191410Z  
2025-11-09T23:42:54.8191547Z -        let mode = params
2025-11-09T23:42:54.8191920Z -            .get(0)
2025-11-09T23:42:54.8192084Z -            .and_then(|p| p.as_str())
2025-11-09T23:42:54.8192219Z -            .unwrap_or("stats");
2025-11-09T23:42:54.8192519Z +        let mode = params.get(0).and_then(|p| p.as_str()).unwrap_or("stats");
2025-11-09T23:42:54.8192636Z  
2025-11-09T23:42:54.8192759Z          match mode {
2025-11-09T23:42:54.8192886Z              "stats" => {
2025-11-09T23:42:54.8193331Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/control.rs:224:
2025-11-09T23:42:54.8193462Z          } else {
2025-11-09T23:42:54.8193690Z              // No command specified, return list of all commands
2025-11-09T23:42:54.8193829Z              let commands = vec![
2025-11-09T23:42:54.8194152Z -                "getblockchaininfo", "getblock", "getblockhash", "getblockheader",
2025-11-09T23:42:54.8194687Z -                "getbestblockhash", "getblockcount", "getdifficulty", "gettxoutsetinfo",
2025-11-09T23:42:54.8195067Z -                "verifychain", "getrawtransaction", "sendrawtransaction", "testmempoolaccept",
2025-11-09T23:42:54.8195431Z -                "decoderawtransaction", "gettxout", "gettxoutproof", "verifytxoutproof",
2025-11-09T23:42:54.8195813Z -                "getmempoolinfo", "getrawmempool", "savemempool", "getnetworkinfo",
2025-11-09T23:42:54.8196165Z -                "getpeerinfo", "getconnectioncount", "ping", "addnode", "disconnectnode",
2025-11-09T23:42:54.8196494Z -                "getnettotals", "clearbanned", "setban", "listbanned", "getmininginfo",
2025-11-09T23:42:54.8198404Z -                "getblocktemplate", "submitblock", "estimatesmartfee", "stop", "uptime",
2025-11-09T23:42:54.8198637Z -                "getmemoryinfo", "getrpcinfo", "help", "logging",
2025-11-09T23:42:54.8198789Z +                "getblockchaininfo",
2025-11-09T23:42:54.8198930Z +                "getblock",
2025-11-09T23:42:54.8199069Z +                "getblockhash",
2025-11-09T23:42:54.8199207Z +                "getblockheader",
2025-11-09T23:42:54.8199358Z +                "getbestblockhash",
2025-11-09T23:42:54.8199481Z +                "getblockcount",
2025-11-09T23:42:54.8199606Z +                "getdifficulty",
2025-11-09T23:42:54.8199744Z +                "gettxoutsetinfo",
2025-11-09T23:42:54.8199873Z +                "verifychain",
2025-11-09T23:42:54.8200013Z +                "getrawtransaction",
2025-11-09T23:42:54.8200157Z +                "sendrawtransaction",
2025-11-09T23:42:54.8200313Z +                "testmempoolaccept",
2025-11-09T23:42:54.8200470Z +                "decoderawtransaction",
2025-11-09T23:42:54.8200880Z +                "gettxout",
2025-11-09T23:42:54.8201025Z +                "gettxoutproof",
2025-11-09T23:42:54.8201405Z +                "verifytxoutproof",
2025-11-09T23:42:54.8201542Z +                "getmempoolinfo",
2025-11-09T23:42:54.8201674Z +                "getrawmempool",
2025-11-09T23:42:54.8201809Z +                "savemempool",
2025-11-09T23:42:54.8201939Z +                "getnetworkinfo",
2025-11-09T23:42:54.8202081Z +                "getpeerinfo",
2025-11-09T23:42:54.8202237Z +                "getconnectioncount",
2025-11-09T23:42:54.8202365Z +                "ping",
2025-11-09T23:42:54.8202485Z +                "addnode",
2025-11-09T23:42:54.8202622Z +                "disconnectnode",
2025-11-09T23:42:54.8202757Z +                "getnettotals",
2025-11-09T23:42:54.8202883Z +                "clearbanned",
2025-11-09T23:42:54.8203006Z +                "setban",
2025-11-09T23:42:54.8203136Z +                "listbanned",
2025-11-09T23:42:54.8203318Z +                "getmininginfo",
2025-11-09T23:42:54.8203518Z +                "getblocktemplate",
2025-11-09T23:42:54.8203682Z +                "submitblock",
2025-11-09T23:42:54.8203863Z +                "estimatesmartfee",
2025-11-09T23:42:54.8203978Z +                "stop",
2025-11-09T23:42:54.8204098Z +                "uptime",
2025-11-09T23:42:54.8204239Z +                "getmemoryinfo",
2025-11-09T23:42:54.8204586Z +                "getrpcinfo",
2025-11-09T23:42:54.8204966Z +                "help",
2025-11-09T23:42:54.8205097Z +                "logging",
2025-11-09T23:42:54.8205225Z              ];
2025-11-09T23:42:54.8205339Z  
2025-11-09T23:42:54.8205503Z              Ok(json!(commands.join("\n")))
2025-11-09T23:42:54.8207196Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/control.rs:275:
2025-11-09T23:42:54.8207380Z          // 1. Store a reference to the EnvFilter layer
2025-11-09T23:42:54.8207584Z          // 2. Provide methods to update the filter dynamically
2025-11-09T23:42:54.8207772Z          // 3. Rebuild the subscriber with the new filter
2025-11-09T23:42:54.8207884Z -        
2025-11-09T23:42:54.8208050Z +
2025-11-09T23:42:54.8208231Z          // Check current filter state from environment
2025-11-09T23:42:54.8208440Z -        let current_filter = std::env::var("RUST_LOG")
2025-11-09T23:42:54.8208614Z -            .unwrap_or_else(|_| "info".to_string());
2025-11-09T23:42:54.8208728Z -        
2025-11-09T23:42:54.8209118Z +        let current_filter = std::env::var("RUST_LOG").unwrap_or_else(|_| "info".to_string());
2025-11-09T23:42:54.8209241Z +
2025-11-09T23:42:54.8209470Z          // Determine if debug logging is active based on filter
2025-11-09T23:42:54.8209680Z -        let active = current_filter.contains("debug") || 
2025-11-09T23:42:54.8210403Z -                     current_filter.contains("trace") ||
2025-11-09T23:42:54.8210613Z -                     !exclude.contains(&"all".to_string());
2025-11-09T23:42:54.8210811Z +        let active = current_filter.contains("debug")
2025-11-09T23:42:54.8210998Z +            || current_filter.contains("trace")
2025-11-09T23:42:54.8211162Z +            || !exclude.contains(&"all".to_string());
2025-11-09T23:42:54.8211275Z  
2025-11-09T23:42:54.8211394Z          Ok(json!({
2025-11-09T23:42:54.8211535Z              "active": active,
2025-11-09T23:42:54.8211997Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/control.rs:297:
2025-11-09T23:42:54.8212288Z      /// Returns comprehensive health report for all node components
2025-11-09T23:42:54.8212600Z      pub async fn gethealth(&self, _params: &Value) -> RpcResult<Value> {
2025-11-09T23:42:54.8212749Z          debug!("RPC: gethealth");
2025-11-09T23:42:54.8212856Z -        
2025-11-09T23:42:54.8212958Z +
2025-11-09T23:42:54.8213234Z          // This would need access to Node instance to get full health report
2025-11-09T23:42:54.8213395Z          // For now, return basic health status
2025-11-09T23:42:54.8213516Z          Ok(json!({
2025-11-09T23:42:54.8214152Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/control.rs:312:
2025-11-09T23:42:54.8214787Z      /// Returns comprehensive metrics for monitoring
2025-11-09T23:42:54.8215088Z      pub async fn getmetrics(&self, _params: &Value) -> RpcResult<Value> {
2025-11-09T23:42:54.8215239Z          debug!("RPC: getmetrics");
2025-11-09T23:42:54.8215341Z -        
2025-11-09T23:42:54.8215446Z +
2025-11-09T23:42:54.8215733Z          // This would need access to MetricsCollector to get full metrics
2025-11-09T23:42:54.8215901Z          // For now, return basic metrics
2025-11-09T23:42:54.8216112Z          let uptime = self.start_time.elapsed().as_secs();
2025-11-09T23:42:54.8216568Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/control.rs:328:
2025-11-09T23:42:54.8216720Z          Self::new()
2025-11-09T23:42:54.8216832Z      }
2025-11-09T23:42:54.8216941Z  }
2025-11-09T23:42:54.8217052Z -
2025-11-09T23:42:54.8217169Z  
2025-11-09T23:42:54.8217613Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:23:
2025-11-09T23:42:54.8217762Z  impl MempoolRpc {
2025-11-09T23:42:54.8217933Z      /// Create a new mempool RPC handler
2025-11-09T23:42:54.8218072Z      pub fn new() -> Self {
2025-11-09T23:42:54.8218242Z -        Self { mempool: None, storage: None }
2025-11-09T23:42:54.8218354Z +        Self {
2025-11-09T23:42:54.8218493Z +            mempool: None,
2025-11-09T23:42:54.8218856Z +            storage: None,
2025-11-09T23:42:54.8218975Z +        }
2025-11-09T23:42:54.8219096Z      }
2025-11-09T23:42:54.8219201Z  
2025-11-09T23:42:54.8219350Z      /// Create with dependencies
2025-11-09T23:42:54.8219798Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:30:
2025-11-09T23:42:54.8220212Z      pub fn with_dependencies(mempool: Arc<MempoolManager>, storage: Arc<Storage>) -> Self {
2025-11-09T23:42:54.8220966Z -        Self { mempool: Some(mempool), storage: Some(storage) }
2025-11-09T23:42:54.8221108Z +        Self {
2025-11-09T23:42:54.8221279Z +            mempool: Some(mempool),
2025-11-09T23:42:54.8221418Z +            storage: Some(storage),
2025-11-09T23:42:54.8221530Z +        }
2025-11-09T23:42:54.8221647Z      }
2025-11-09T23:42:54.8221756Z  
2025-11-09T23:42:54.8221901Z      /// Get mempool information
2025-11-09T23:42:54.8222332Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:40:
2025-11-09T23:42:54.8222605Z          if let Some(ref mempool) = self.mempool {
2025-11-09T23:42:54.8222763Z              let size = mempool.size();
2025-11-09T23:42:54.8222972Z              let transactions = mempool.get_transactions();
2025-11-09T23:42:54.8223199Z -            let bytes: usize = transactions.iter().map(|tx| {
2025-11-09T23:42:54.8223546Z -                use bllvm_protocol::serialization::transaction::serialize_transaction;
2025-11-09T23:42:54.8223709Z -                serialize_transaction(tx).len()
2025-11-09T23:42:54.8223829Z -            }).sum();
2025-11-09T23:42:54.8224006Z +            let bytes: usize = transactions
2025-11-09T23:42:54.8224128Z +                .iter()
2025-11-09T23:42:54.8224255Z +                .map(|tx| {
2025-11-09T23:42:54.8224777Z +                    use bllvm_protocol::serialization::transaction::serialize_transaction;
2025-11-09T23:42:54.8224957Z +                    serialize_transaction(tx).len()
2025-11-09T23:42:54.8225071Z +                })
2025-11-09T23:42:54.8225194Z +                .sum();
2025-11-09T23:42:54.8225314Z  
2025-11-09T23:42:54.8225435Z              Ok(json!({
2025-11-09T23:42:54.8225557Z                  "loaded": true,
2025-11-09T23:42:54.8225990Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:56:
2025-11-09T23:42:54.8226094Z              }))
2025-11-09T23:42:54.8226206Z          } else {
2025-11-09T23:42:54.8226564Z              // Graceful degradation: return empty mempool info when mempool unavailable
2025-11-09T23:42:54.8227032Z -            tracing::debug!("getmempoolinfo called but mempool not available, returning empty mempool");
2025-11-09T23:42:54.8227443Z +            tracing::debug!(
2025-11-09T23:42:54.8227792Z +                "getmempoolinfo called but mempool not available, returning empty mempool"
2025-11-09T23:42:54.8227917Z +            );
2025-11-09T23:42:54.8228032Z              Ok(json!({
2025-11-09T23:42:54.8228166Z                  "loaded": false,
2025-11-09T23:42:54.8228309Z                  "size": 0,
2025-11-09T23:42:54.8228751Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:82:
2025-11-09T23:42:54.8228965Z              let transactions = mempool.get_transactions();
2025-11-09T23:42:54.8229182Z              use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:42:54.8229522Z              use bllvm_protocol::serialization::transaction::serialize_transaction;
2025-11-09T23:42:54.8229641Z -            
2025-11-09T23:42:54.8229750Z +
2025-11-09T23:42:54.8229889Z              if verbose {
2025-11-09T23:42:54.8230088Z                  let mut result = serde_json::Map::new();
2025-11-09T23:42:54.8230235Z                  for tx in transactions {
2025-11-09T23:42:54.8230686Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:90:
2025-11-09T23:42:54.8230865Z                      let txid_hex = hex::encode(txid);
2025-11-09T23:42:54.8231038Z                      let txid_hex_clone = txid_hex.clone();
2025-11-09T23:42:54.8231485Z                      let size = serialize_transaction(&tx).len();
2025-11-09T23:42:54.8231604Z -                    
2025-11-09T23:42:54.8231716Z +
2025-11-09T23:42:54.8231885Z                      result.insert(txid_hex, json!({
2025-11-09T23:42:54.8232035Z                          "size": size,
2025-11-09T23:42:54.8232493Z                          "fee": if let (Some(ref mempool), Some(ref storage)) = (self.mempool.as_ref(), self.storage.as_ref()) {
2025-11-09T23:42:54.8232959Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:126:
2025-11-09T23:42:54.8233096Z                  }
2025-11-09T23:42:54.8233234Z                  Ok(json!(result))
2025-11-09T23:42:54.8233353Z              } else {
2025-11-09T23:42:54.8233601Z -                let txids: Vec<String> = transactions.iter().map(|tx| {
2025-11-09T23:42:54.8233777Z -                    let txid = calculate_tx_id(tx);
2025-11-09T23:42:54.8233924Z -                    hex::encode(txid)
2025-11-09T23:42:54.8234063Z -                }).collect();
2025-11-09T23:42:54.8234244Z +                let txids: Vec<String> = transactions
2025-11-09T23:42:54.8234557Z +                    .iter()
2025-11-09T23:42:54.8234698Z +                    .map(|tx| {
2025-11-09T23:42:54.8234865Z +                        let txid = calculate_tx_id(tx);
2025-11-09T23:42:54.8235017Z +                        hex::encode(txid)
2025-11-09T23:42:54.8235134Z +                    })
2025-11-09T23:42:54.8235261Z +                    .collect();
2025-11-09T23:42:54.8235405Z                  Ok(json!(txids))
2025-11-09T23:42:54.8235526Z              }
2025-11-09T23:42:54.8235639Z          } else {
2025-11-09T23:42:54.8236105Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:174:
2025-11-09T23:42:54.8236281Z          if let Some(mempool) = &self.mempool {
2025-11-09T23:42:54.8236608Z              let data_dir = std::env::var("DATA_DIR").unwrap_or_else(|_| "data".to_string());
2025-11-09T23:42:54.8236938Z              let mempool_path = std::path::Path::new(&data_dir).join("mempool.dat");
2025-11-09T23:42:54.8237066Z -            
2025-11-09T23:42:54.8237174Z +
2025-11-09T23:42:54.8237412Z              // Arc implements Deref, so we can call methods directly
2025-11-09T23:42:54.8237638Z              if let Err(e) = mempool.save_to_disk(&mempool_path) {
2025-11-09T23:42:54.8237907Z -                return Err(crate::rpc::errors::RpcError::internal_error(
2025-11-09T23:42:54.8238099Z -                    format!("Failed to save mempool: {}", e)
2025-11-09T23:42:54.8238450Z -                ));
2025-11-09T23:42:54.8238736Z +                return Err(crate::rpc::errors::RpcError::internal_error(format!(
2025-11-09T23:42:54.8238892Z +                    "Failed to save mempool: {}",
2025-11-09T23:42:54.8239012Z +                    e
2025-11-09T23:42:54.8239142Z +                )));
2025-11-09T23:42:54.8239258Z              }
2025-11-09T23:42:54.8239392Z              Ok(json!(null))
2025-11-09T23:42:54.8239524Z          } else {
2025-11-09T23:42:54.8239984Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:186:
2025-11-09T23:42:54.8240209Z              Err(crate::rpc::errors::RpcError::internal_error(
2025-11-09T23:42:54.8240396Z -                "Mempool not initialized".to_string()
2025-11-09T23:42:54.8240576Z +                "Mempool not initialized".to_string(),
2025-11-09T23:42:54.8240690Z              ))
2025-11-09T23:42:54.8240801Z          }
2025-11-09T23:42:54.8240914Z      }
2025-11-09T23:42:54.8241372Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:195:
2025-11-09T23:42:54.8241760Z      pub async fn getmempoolancestors(&self, params: &Value) -> RpcResult<Value> {
2025-11-09T23:42:54.8241943Z          debug!("RPC: getmempoolancestors");
2025-11-09T23:42:54.8242054Z  
2025-11-09T23:42:54.8242202Z -        let txid = params.get(0)
2025-11-09T23:42:54.8242353Z -            .and_then(|p| p.as_str())
2025-11-09T23:42:54.8243061Z -            .ok_or_else(|| crate::rpc::errors::RpcError::invalid_params("Transaction ID required".to_string()))?;
2025-11-09T23:42:54.8243348Z +        let txid = params.get(0).and_then(|p| p.as_str()).ok_or_else(|| {
2025-11-09T23:42:54.8243746Z +            crate::rpc::errors::RpcError::invalid_params("Transaction ID required".to_string())
2025-11-09T23:42:54.8243874Z +        })?;
2025-11-09T23:42:54.8243989Z  
2025-11-09T23:42:54.8244467Z          let verbose = params.get(1).and_then(|p| p.as_bool()).unwrap_or(false);
2025-11-09T23:42:54.8244607Z  
2025-11-09T23:42:54.8245077Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:204:
2025-11-09T23:42:54.8245256Z -        let hash_bytes = hex::decode(txid)
2025-11-09T23:42:54.8245694Z -            .map_err(|e| crate::rpc::errors::RpcError::invalid_params(format!("Invalid transaction ID: {}", e)))?;
2025-11-09T23:42:54.8245897Z +        let hash_bytes = hex::decode(txid).map_err(|e| {
2025-11-09T23:42:54.8246303Z +            crate::rpc::errors::RpcError::invalid_params(format!("Invalid transaction ID: {}", e))
2025-11-09T23:42:54.8246414Z +        })?;
2025-11-09T23:42:54.8246555Z          if hash_bytes.len() != 32 {
2025-11-09T23:42:54.8247019Z -            return Err(crate::rpc::errors::RpcError::invalid_params("Transaction ID must be 32 bytes".to_string()));
2025-11-09T23:42:54.8247272Z +            return Err(crate::rpc::errors::RpcError::invalid_params(
2025-11-09T23:42:54.8247480Z +                "Transaction ID must be 32 bytes".to_string(),
2025-11-09T23:42:54.8247596Z +            ));
2025-11-09T23:42:54.8247709Z          }
2025-11-09T23:42:54.8247836Z          let mut hash = [0u8; 32];
2025-11-09T23:42:54.8247996Z          hash.copy_from_slice(&hash_bytes);
2025-11-09T23:42:54.8248425Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:222:
2025-11-09T23:42:54.8248645Z                          let ancestor_txid_clone = ancestor_txid.clone();
2025-11-09T23:42:54.8248994Z                          use bllvm_protocol::serialization::transaction::serialize_transaction;
2025-11-09T23:42:54.8249216Z                          let size = serialize_transaction(&ancestor_tx).len();
2025-11-09T23:42:54.8249325Z -                        
2025-11-09T23:42:54.8249427Z +
2025-11-09T23:42:54.8249600Z                          result.insert(ancestor_txid, json!({
2025-11-09T23:42:54.8249730Z                              "size": size,
2025-11-09T23:42:54.8249914Z                              "fee": if let Some(ref storage) = self.storage {
2025-11-09T23:42:54.8250643Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:278:
2025-11-09T23:42:54.8250999Z      pub async fn getmempooldescendants(&self, params: &Value) -> RpcResult<Value> {
2025-11-09T23:42:54.8251170Z          debug!("RPC: getmempooldescendants");
2025-11-09T23:42:54.8251290Z  
2025-11-09T23:42:54.8251438Z -        let txid = params.get(0)
2025-11-09T23:42:54.8251591Z -            .and_then(|p| p.as_str())
2025-11-09T23:42:54.8252051Z -            .ok_or_else(|| crate::rpc::errors::RpcError::invalid_params("Transaction ID required".to_string()))?;
2025-11-09T23:42:54.8252305Z +        let txid = params.get(0).and_then(|p| p.as_str()).ok_or_else(|| {
2025-11-09T23:42:54.8252657Z +            crate::rpc::errors::RpcError::invalid_params("Transaction ID required".to_string())
2025-11-09T23:42:54.8252763Z +        })?;
2025-11-09T23:42:54.8252875Z  
2025-11-09T23:42:54.8253164Z          let verbose = params.get(1).and_then(|p| p.as_bool()).unwrap_or(false);
2025-11-09T23:42:54.8253285Z  
2025-11-09T23:42:54.8253749Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:287:
2025-11-09T23:42:54.8253920Z -        let hash_bytes = hex::decode(txid)
2025-11-09T23:42:54.8254569Z -            .map_err(|e| crate::rpc::errors::RpcError::invalid_params(format!("Invalid transaction ID: {}", e)))?;
2025-11-09T23:42:54.8254805Z +        let hash_bytes = hex::decode(txid).map_err(|e| {
2025-11-09T23:42:54.8255441Z +            crate::rpc::errors::RpcError::invalid_params(format!("Invalid transaction ID: {}", e))
2025-11-09T23:42:54.8255564Z +        })?;
2025-11-09T23:42:54.8255712Z          if hash_bytes.len() != 32 {
2025-11-09T23:42:54.8256224Z -            return Err(crate::rpc::errors::RpcError::invalid_params("Transaction ID must be 32 bytes".to_string()));
2025-11-09T23:42:54.8256488Z +            return Err(crate::rpc::errors::RpcError::invalid_params(
2025-11-09T23:42:54.8256687Z +                "Transaction ID must be 32 bytes".to_string(),
2025-11-09T23:42:54.8256820Z +            ));
2025-11-09T23:42:54.8256933Z          }
2025-11-09T23:42:54.8257074Z          let mut hash = [0u8; 32];
2025-11-09T23:42:54.8257239Z          hash.copy_from_slice(&hash_bytes);
2025-11-09T23:42:54.8257695Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:295:
2025-11-09T23:42:54.8257879Z          if let Some(ref mempool) = self.mempool {
2025-11-09T23:42:54.8258339Z              // Find descendants by checking which transactions spend outputs created by this transaction
2025-11-09T23:42:54.8258522Z              let mut descendants = Vec::new();
2025-11-09T23:42:54.8258636Z -            
2025-11-09T23:42:54.8258740Z +
2025-11-09T23:42:54.8258944Z              if let Some(tx) = mempool.get_transaction(&hash) {
2025-11-09T23:42:54.8259154Z                  // Get all output outpoints from this transaction
2025-11-09T23:42:54.8259340Z                  let mut output_outpoints = Vec::new();
2025-11-09T23:42:54.8259805Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:329:
2025-11-09T23:42:54.8260052Z                          let descendant_txid_clone = descendant_txid.clone();
2025-11-09T23:42:54.8260401Z                          use bllvm_protocol::serialization::transaction::serialize_transaction;
2025-11-09T23:42:54.8260641Z                          let size = serialize_transaction(&descendant_tx).len();
2025-11-09T23:42:54.8260779Z -                        
2025-11-09T23:42:54.8260889Z +
2025-11-09T23:42:54.8261075Z                          result.insert(descendant_txid, json!({
2025-11-09T23:42:54.8261223Z                              "size": size,
2025-11-09T23:42:54.8261431Z                              "fee": if let Some(ref storage) = self.storage {
2025-11-09T23:42:54.8261879Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:385:
2025-11-09T23:42:54.8262223Z      pub async fn getmempoolentry(&self, params: &Value) -> RpcResult<Value> {
2025-11-09T23:42:54.8262615Z          debug!("RPC: getmempoolentry");
2025-11-09T23:42:54.8262732Z  
2025-11-09T23:42:54.8262878Z -        let txid = params.get(0)
2025-11-09T23:42:54.8263038Z -            .and_then(|p| p.as_str())
2025-11-09T23:42:54.8263499Z -            .ok_or_else(|| crate::rpc::errors::RpcError::invalid_params("Transaction ID required".to_string()))?;
2025-11-09T23:42:54.8263780Z +        let txid = params.get(0).and_then(|p| p.as_str()).ok_or_else(|| {
2025-11-09T23:42:54.8267029Z +            crate::rpc::errors::RpcError::invalid_params("Transaction ID required".to_string())
2025-11-09T23:42:54.8267173Z +        })?;
2025-11-09T23:42:54.8267286Z  
2025-11-09T23:42:54.8267617Z          let verbose = params.get(1).and_then(|p| p.as_bool()).unwrap_or(false);
2025-11-09T23:42:54.8267724Z  
2025-11-09T23:42:54.8268179Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:394:
2025-11-09T23:42:54.8268363Z -        let hash_bytes = hex::decode(txid)
2025-11-09T23:42:54.8268856Z -            .map_err(|e| crate::rpc::errors::RpcError::invalid_params(format!("Invalid transaction ID: {}", e)))?;
2025-11-09T23:42:54.8269064Z +        let hash_bytes = hex::decode(txid).map_err(|e| {
2025-11-09T23:42:54.8269452Z +            crate::rpc::errors::RpcError::invalid_params(format!("Invalid transaction ID: {}", e))
2025-11-09T23:42:54.8269578Z +        })?;
2025-11-09T23:42:54.8269715Z          if hash_bytes.len() != 32 {
2025-11-09T23:42:54.8270440Z -            return Err(crate::rpc::errors::RpcError::invalid_params("Transaction ID must be 32 bytes".to_string()));
2025-11-09T23:42:54.8270720Z +            return Err(crate::rpc::errors::RpcError::invalid_params(
2025-11-09T23:42:54.8270914Z +                "Transaction ID must be 32 bytes".to_string(),
2025-11-09T23:42:54.8271036Z +            ));
2025-11-09T23:42:54.8271148Z          }
2025-11-09T23:42:54.8271298Z          let mut hash = [0u8; 32];
2025-11-09T23:42:54.8271465Z          hash.copy_from_slice(&hash_bytes);
2025-11-09T23:42:54.8272175Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:403:
2025-11-09T23:42:54.8272399Z              if let Some(tx) = mempool.get_transaction(&hash) {
2025-11-09T23:42:54.8272722Z                  use bllvm_protocol::serialization::transaction::serialize_transaction;
2025-11-09T23:42:54.8272907Z                  let size = serialize_transaction(&tx).len();
2025-11-09T23:42:54.8273031Z -                
2025-11-09T23:42:54.8273158Z +
2025-11-09T23:42:54.8273328Z                  // Get ancestors and descendants
2025-11-09T23:42:54.8273559Z                  let ancestors = self.get_ancestors(mempool, &hash);
2025-11-09T23:42:54.8273826Z                  let descendants = self.get_descendants(mempool, &hash);
2025-11-09T23:42:54.8276286Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:410:
2025-11-09T23:42:54.8276422Z -                
2025-11-09T23:42:54.8276540Z +
2025-11-09T23:42:54.8276722Z                  let ancestor_count = ancestors.len();
2025-11-09T23:42:54.8276926Z                  let descendant_count = descendants.len();
2025-11-09T23:42:54.8277130Z -                let ancestor_size: usize = ancestors.iter()
2025-11-09T23:42:54.8277299Z +                let ancestor_size: usize = ancestors
2025-11-09T23:42:54.8277427Z +                    .iter()
2025-11-09T23:42:54.8277613Z                      .filter_map(|h| mempool.get_transaction(h))
2025-11-09T23:42:54.8277808Z                      .map(|tx| serialize_transaction(&tx).len())
2025-11-09T23:42:54.8277930Z                      .sum();
2025-11-09T23:42:54.8278396Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:417:
2025-11-09T23:42:54.8278618Z -                let descendant_size: usize = descendants.iter()
2025-11-09T23:42:54.8278806Z +                let descendant_size: usize = descendants
2025-11-09T23:42:54.8278929Z +                    .iter()
2025-11-09T23:42:54.8279121Z                      .filter_map(|h| mempool.get_transaction(h))
2025-11-09T23:42:54.8279534Z                      .map(|tx| serialize_transaction(&tx).len())
2025-11-09T23:42:54.8279653Z                      .sum();
2025-11-09T23:42:54.8280117Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:454:
2025-11-09T23:42:54.8280289Z                      "bip125-replaceable": false
2025-11-09T23:42:54.8280407Z                  }))
2025-11-09T23:42:54.8280538Z              } else {
2025-11-09T23:42:54.8280762Z -                Err(crate::rpc::errors::RpcError::invalid_params(
2025-11-09T23:42:54.8280978Z -                    format!("Transaction {} not found in mempool", txid)
2025-11-09T23:42:54.8281086Z -                ))
2025-11-09T23:42:54.8281332Z +                Err(crate::rpc::errors::RpcError::invalid_params(format!(
2025-11-09T23:42:54.8281528Z +                    "Transaction {} not found in mempool",
2025-11-09T23:42:54.8281650Z +                    txid
2025-11-09T23:42:54.8281764Z +                )))
2025-11-09T23:42:54.8281900Z              }
2025-11-09T23:42:54.8282017Z          } else {
2025-11-09T23:42:54.8282235Z              Err(crate::rpc::errors::RpcError::internal_error(
2025-11-09T23:42:54.8282674Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:463:
2025-11-09T23:42:54.8282853Z -                "Mempool not initialized".to_string()
2025-11-09T23:42:54.8283014Z +                "Mempool not initialized".to_string(),
2025-11-09T23:42:54.8283308Z              ))
2025-11-09T23:42:54.8283422Z          }
2025-11-09T23:42:54.8283529Z      }
2025-11-09T23:42:54.8283941Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:468:
2025-11-09T23:42:54.8284118Z      /// Helper: Get ancestors for a transaction
2025-11-09T23:42:54.8284638Z      fn get_ancestors(&self, mempool: &MempoolManager, tx_hash: &Hash) -> Vec<Hash> {
2025-11-09T23:42:54.8284807Z          let mut ancestors = Vec::new();
2025-11-09T23:42:54.8284917Z -        
2025-11-09T23:42:54.8285047Z +
2025-11-09T23:42:54.8285264Z          if let Some(tx) = mempool.get_transaction(tx_hash) {
2025-11-09T23:42:54.8285624Z              // Find transactions that this transaction depends on (spends their outputs)
2025-11-09T23:42:54.8285849Z              use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:42:54.8286305Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:478:
2025-11-09T23:42:54.8286492Z                  for ancestor_tx in transactions {
2025-11-09T23:42:54.8286725Z                      let ancestor_hash = calculate_tx_id(&ancestor_tx);
2025-11-09T23:42:54.8286985Z                      for (idx, _output) in ancestor_tx.outputs.iter().enumerate() {
2025-11-09T23:42:54.8287356Z -                        if input.prevout.hash == ancestor_hash && input.prevout.index == idx as u64 {
2025-11-09T23:42:54.8287709Z +                        if input.prevout.hash == ancestor_hash && input.prevout.index == idx as u64
2025-11-09T23:42:54.8287850Z +                        {
2025-11-09T23:42:54.8288049Z                              if !ancestors.contains(&ancestor_hash) {
2025-11-09T23:42:54.8288228Z                                  ancestors.push(ancestor_hash);
2025-11-09T23:42:54.8288353Z                              }
2025-11-09T23:42:54.8288805Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:487:
2025-11-09T23:42:54.8288924Z                  }
2025-11-09T23:42:54.8289050Z              }
2025-11-09T23:42:54.8289162Z          }
2025-11-09T23:42:54.8289277Z -        
2025-11-09T23:42:54.8289383Z +
2025-11-09T23:42:54.8289510Z          ancestors
2025-11-09T23:42:54.8289615Z      }
2025-11-09T23:42:54.8289724Z  
2025-11-09T23:42:54.8290190Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:494:
2025-11-09T23:42:54.8290378Z      /// Helper: Get descendants for a transaction
2025-11-09T23:42:54.8290750Z      fn get_descendants(&self, mempool: &MempoolManager, tx_hash: &Hash) -> Vec<Hash> {
2025-11-09T23:42:54.8291155Z          let mut descendants = Vec::new();
2025-11-09T23:42:54.8291277Z -        
2025-11-09T23:42:54.8291395Z +
2025-11-09T23:42:54.8291622Z          if let Some(tx) = mempool.get_transaction(tx_hash) {
2025-11-09T23:42:54.8291828Z              // Get all output outpoints from this transaction
2025-11-09T23:42:54.8292013Z              let mut output_outpoints = Vec::new();
2025-11-09T23:42:54.8293966Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:520:
2025-11-09T23:42:54.8294085Z                  }
2025-11-09T23:42:54.8294199Z              }
2025-11-09T23:42:54.8294504Z          }
2025-11-09T23:42:54.8294628Z -        
2025-11-09T23:42:54.8294738Z +
2025-11-09T23:42:54.8294871Z          descendants
2025-11-09T23:42:54.8294985Z      }
2025-11-09T23:42:54.8295089Z  }
2025-11-09T23:42:54.8318936Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:1:
2025-11-09T23:42:54.8319166Z  //! Mining RPC methods
2025-11-09T23:42:54.8319301Z -//! 
2025-11-09T23:42:54.8319417Z +//!
2025-11-09T23:42:54.8319839Z  //! Implements mining-related JSON-RPC methods for block template generation and mining.
2025-11-09T23:42:54.8320096Z  //! Uses formally verified consensus-proof mining functions.
2025-11-09T23:42:54.8320212Z  
2025-11-09T23:42:54.8320643Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:6:
2025-11-09T23:42:54.8321065Z -use serde_json::{Value, json};
2025-11-09T23:42:54.8321217Z -use tracing::{debug, warn};
2025-11-09T23:42:54.8321349Z -use hex;
2025-11-09T23:42:54.8321532Z +use crate::node::mempool::MempoolManager;
2025-11-09T23:42:54.8321727Z  use crate::rpc::errors::{RpcError, RpcResult};
2025-11-09T23:42:54.8322394Z -use bllvm_protocol::{ConsensusProof, types::{BlockHeader, Transaction, UtxoSet, Natural, ByteString, Hash}, ValidationResult};
2025-11-09T23:42:54.8322647Z -use bllvm_protocol::serialization::serialize_transaction;
2025-11-09T23:42:54.8322791Z +use crate::storage::Storage;
2025-11-09T23:42:54.8322984Z  use bllvm_protocol::mining::BlockTemplate;
2025-11-09T23:42:54.8323294Z -use bllvm_protocol::serialization::deserialize_block_with_witnesses;
2025-11-09T23:42:54.8323466Z  use bllvm_protocol::pow::expand_target;
2025-11-09T23:42:54.8323599Z -use std::sync::Arc;
2025-11-09T23:42:54.8323750Z -use crate::storage::Storage;
2025-11-09T23:42:54.8323925Z -use crate::node::mempool::MempoolManager;
2025-11-09T23:42:54.8324244Z +use bllvm_protocol::serialization::deserialize_block_with_witnesses;
2025-11-09T23:42:54.8324667Z +use bllvm_protocol::serialization::serialize_transaction;
2025-11-09T23:42:54.8324809Z +use bllvm_protocol::{
2025-11-09T23:42:54.8325135Z +    types::{BlockHeader, ByteString, Hash, Natural, Transaction, UtxoSet},
2025-11-09T23:42:54.8325302Z +    ConsensusProof, ValidationResult,
2025-11-09T23:42:54.8325421Z +};
2025-11-09T23:42:54.8325536Z +use hex;
2025-11-09T23:42:54.8325678Z +use serde_json::{json, Value};
2025-11-09T23:42:54.8325836Z  use sha2::{Digest, Sha256};
2025-11-09T23:42:54.8325964Z +use std::sync::Arc;
2025-11-09T23:42:54.8326103Z +use tracing::{debug, warn};
2025-11-09T23:42:54.8326212Z  
2025-11-09T23:42:54.8326381Z  /// Mining RPC methods with dependencies
2025-11-09T23:42:54.8326521Z  pub struct MiningRpc {
2025-11-09T23:42:54.8326958Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:36:
2025-11-09T23:42:54.8327099Z              mempool: None,
2025-11-09T23:42:54.8327202Z          }
2025-11-09T23:42:54.8327302Z      }
2025-11-09T23:42:54.8327404Z -    
2025-11-09T23:42:54.8327512Z +
2025-11-09T23:42:54.8327706Z      /// Create with dependencies (storage and mempool)
2025-11-09T23:42:54.8328097Z      pub fn with_dependencies(storage: Arc<Storage>, mempool: Arc<MempoolManager>) -> Self {
2025-11-09T23:42:54.8328220Z          Self {
2025-11-09T23:42:54.8328650Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:45:
2025-11-09T23:42:54.8328804Z              mempool: Some(mempool),
2025-11-09T23:42:54.8329118Z          }
2025-11-09T23:42:54.8329224Z      }
2025-11-09T23:42:54.8329336Z -    
2025-11-09T23:42:54.8329445Z +
2025-11-09T23:42:54.8329591Z      /// Get mining information
2025-11-09T23:42:54.8329837Z      pub async fn get_mining_info(&self) -> RpcResult<Value> {
2025-11-09T23:42:54.8329996Z          debug!("RPC: getmininginfo");
2025-11-09T23:42:54.8330445Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:52:
2025-11-09T23:42:54.8330568Z -        
2025-11-09T23:42:54.8330674Z +
2025-11-09T23:42:54.8330850Z          // Get current block height from storage
2025-11-09T23:42:54.8331083Z          let blocks = if let Some(ref storage) = self.storage {
2025-11-09T23:42:54.8331243Z -            storage.chain().get_height()
2025-11-09T23:42:54.8331358Z +            storage
2025-11-09T23:42:54.8331493Z +                .chain()
2025-11-09T23:42:54.8331625Z +                .get_height()
2025-11-09T23:42:54.8331994Z                  .map_err(|e| RpcError::internal_error(format!("Failed to get height: {}", e)))?
2025-11-09T23:42:54.8332137Z                  .unwrap_or(0)
2025-11-09T23:42:54.8332263Z          } else {
2025-11-09T23:42:54.8332729Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:59:
2025-11-09T23:42:54.8332848Z              0
2025-11-09T23:42:54.8332962Z          };
2025-11-09T23:42:54.8333067Z -        
2025-11-09T23:42:54.8333426Z +
2025-11-09T23:42:54.8333569Z          // Get mempool size
2025-11-09T23:42:54.8333822Z          let pooledtx = if let Some(ref mempool) = self.mempool {
2025-11-09T23:42:54.8333971Z              mempool.size()
2025-11-09T23:42:54.8334632Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:65:
2025-11-09T23:42:54.8334772Z          } else {
2025-11-09T23:42:54.8334886Z              0
2025-11-09T23:42:54.8335003Z          };
2025-11-09T23:42:54.8335116Z -        
2025-11-09T23:42:54.8335225Z +
2025-11-09T23:42:54.8335567Z          // Get difficulty from latest block's bits field (graceful degradation)
2025-11-09T23:42:54.8335824Z          let difficulty = if let Some(ref storage) = self.storage {
2025-11-09T23:42:54.8345384Z              if let Ok(Some(tip_header)) = storage.chain().get_tip_header() {
2025-11-09T23:42:54.8345897Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:78:
2025-11-09T23:42:54.8346255Z              tracing::debug!("Storage not available, using default difficulty");
2025-11-09T23:42:54.8346424Z              1.0 // Graceful fallback if no storage
2025-11-09T23:42:54.8346537Z          };
2025-11-09T23:42:54.8346652Z -        
2025-11-09T23:42:54.8346754Z +
2025-11-09T23:42:54.8347110Z          // Calculate network hashrate from recent block timestamps (graceful degradation)
2025-11-09T23:42:54.8347377Z          let networkhashps = if let Some(ref storage) = self.storage {
2025-11-09T23:42:54.8347679Z -            self.calculate_network_hashrate(storage).unwrap_or_else(|e| {
2025-11-09T23:42:54.8348037Z -                tracing::debug!("Failed to calculate network hashrate: {}, using 0.0", e);
2025-11-09T23:42:54.8348153Z -                0.0
2025-11-09T23:42:54.8348278Z -            })
2025-11-09T23:42:54.8348454Z +            self.calculate_network_hashrate(storage)
2025-11-09T23:42:54.8348599Z +                .unwrap_or_else(|e| {
2025-11-09T23:42:54.8348930Z +                    tracing::debug!("Failed to calculate network hashrate: {}, using 0.0", e);
2025-11-09T23:42:54.8349072Z +                    0.0
2025-11-09T23:42:54.8349179Z +                })
2025-11-09T23:42:54.8349292Z          } else {
2025-11-09T23:42:54.8349617Z              tracing::debug!("Storage not available, network hashrate unavailable");
2025-11-09T23:42:54.8349726Z              0.0
2025-11-09T23:42:54.8350161Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:91:
2025-11-09T23:42:54.8350282Z          };
2025-11-09T23:42:54.8350389Z -        
2025-11-09T23:42:54.8350757Z +
2025-11-09T23:42:54.8350963Z          // Get current block template info (if available)
2025-11-09T23:42:54.8351381Z          let currentblocksize = 0;
2025-11-09T23:42:54.8351530Z          let currentblockweight = 0;
2025-11-09T23:42:54.8351963Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:96:
2025-11-09T23:42:54.8352110Z          let currentblocktx = 0;
2025-11-09T23:42:54.8352223Z -        
2025-11-09T23:42:54.8352333Z +
2025-11-09T23:42:54.8352530Z          // Determine chain name from storage chain params
2025-11-09T23:42:54.8352745Z          let chain = if let Some(ref storage) = self.storage {
2025-11-09T23:42:54.8352965Z              if let Ok(Some(info)) = storage.chain().load_chain_info() {
2025-11-09T23:42:54.8353372Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:110:
2025-11-09T23:42:54.8353502Z          } else {
2025-11-09T23:42:54.8353632Z              "main" // Default
2025-11-09T23:42:54.8353754Z          };
2025-11-09T23:42:54.8353865Z -        
2025-11-09T23:42:54.8353964Z +
2025-11-09T23:42:54.8354077Z          Ok(json!({
2025-11-09T23:42:54.8354197Z              "blocks": blocks,
2025-11-09T23:42:54.8354626Z              "currentblocksize": currentblocksize,
2025-11-09T23:42:54.8355036Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:123:
2025-11-09T23:42:54.8355163Z              "warnings": ""
2025-11-09T23:42:54.8355510Z          }))
2025-11-09T23:42:54.8355617Z      }
2025-11-09T23:42:54.8355724Z -    
2025-11-09T23:42:54.8355826Z +
2025-11-09T23:42:54.8355959Z      /// Get block template
2025-11-09T23:42:54.8356062Z -    /// 
2025-11-09T23:42:54.8356162Z +    ///
2025-11-09T23:42:54.8356321Z      /// Params: [template_request (optional)]
2025-11-09T23:42:54.8356428Z -    /// 
2025-11-09T23:42:54.8356537Z +    ///
2025-11-09T23:42:54.8356946Z      /// Uses formally verified consensus-proof::mining::create_block_template() function
2025-11-09T23:42:54.8357322Z      /// which has Kani proofs ensuring correctness per Orange Paper Section 12.4
2025-11-09T23:42:54.8357667Z      pub async fn get_block_template(&self, params: &Value) -> RpcResult<Value> {
2025-11-09T23:42:54.8358105Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:134:
2025-11-09T23:42:54.8358284Z          debug!("RPC: getblocktemplate");
2025-11-09T23:42:54.8358400Z -        
2025-11-09T23:42:54.8358522Z +
2025-11-09T23:42:54.8358669Z          // 1. Get current chainstate
2025-11-09T23:42:54.8358888Z -        let height: Natural = self.get_current_height()?
2025-11-09T23:42:54.8359027Z +        let height: Natural = self
2025-11-09T23:42:54.8359160Z +            .get_current_height()?
2025-11-09T23:42:54.8359463Z              .ok_or_else(|| RpcError::internal_error("Chain not initialized"))?;
2025-11-09T23:42:54.8359641Z -        let prev_header = self.get_tip_header()?
2025-11-09T23:42:54.8359784Z +        let prev_header = self
2025-11-09T23:42:54.8359928Z +            .get_tip_header()?
2025-11-09T23:42:54.8360163Z              .ok_or_else(|| RpcError::internal_error("No chain tip"))?;
2025-11-09T23:42:54.8360376Z          let prev_headers = self.get_headers_for_difficulty()?;
2025-11-09T23:42:54.8360479Z -        
2025-11-09T23:42:54.8360586Z +
2025-11-09T23:42:54.8360722Z          // 2. Get mempool transactions
2025-11-09T23:42:54.8361009Z          let mempool_txs: Vec<Transaction> = self.get_mempool_transactions()?;
2025-11-09T23:42:54.8361126Z -        
2025-11-09T23:42:54.8361230Z +
2025-11-09T23:42:54.8361352Z          // 3. Get UTXO set
2025-11-09T23:42:54.8361510Z          let utxo_set = self.get_utxo_set()?;
2025-11-09T23:42:54.8361638Z -        
2025-11-09T23:42:54.8361747Z +
2025-11-09T23:42:54.8362014Z          // 4. Extract coinbase parameters from request or use defaults
2025-11-09T23:42:54.8362403Z          let coinbase_script = self.extract_coinbase_script(params).unwrap_or_default();
2025-11-09T23:42:54.8362793Z          let coinbase_address = self.extract_coinbase_address(params).unwrap_or_default();
2025-11-09T23:42:54.8363487Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:152:
2025-11-09T23:42:54.8363615Z -        
2025-11-09T23:42:54.8363722Z +
2025-11-09T23:42:54.8363947Z          // 5. Use formally verified function from consensus-proof
2025-11-09T23:42:54.8364261Z          // This function has Kani proofs: kani_create_block_template_completeness
2025-11-09T23:42:54.8364685Z          let template = match self.consensus.create_block_template(
2025-11-09T23:42:54.8365109Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:164:
2025-11-09T23:42:54.8365230Z              Ok(t) => t,
2025-11-09T23:42:54.8365353Z              Err(e) => {
2025-11-09T23:42:54.8365548Z                  warn!("Failed to create block template: {}", e);
2025-11-09T23:42:54.8365945Z -                return Err(RpcError::internal_error(format!("Template creation failed: {}", e)));
2025-11-09T23:42:54.8366168Z +                return Err(RpcError::internal_error(format!(
2025-11-09T23:42:54.8366336Z +                    "Template creation failed: {}",
2025-11-09T23:42:54.8366454Z +                    e
2025-11-09T23:42:54.8366565Z +                )));
2025-11-09T23:42:54.8366682Z              }
2025-11-09T23:42:54.8366787Z          };
2025-11-09T23:42:54.8366890Z -        
2025-11-09T23:42:54.8367005Z +
2025-11-09T23:42:54.8367426Z          // 6. Convert to JSON-RPC format (BIP 22/23)
2025-11-09T23:42:54.8367690Z          self.template_to_json_rpc(&template, &prev_header, height)
2025-11-09T23:42:54.8367802Z      }
2025-11-09T23:42:54.8368387Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:174:
2025-11-09T23:42:54.8368543Z -    
2025-11-09T23:42:54.8368651Z +
2025-11-09T23:42:54.8368916Z      /// Convert BlockTemplate to JSON-RPC format
2025-11-09T23:42:54.8369099Z      fn template_to_json_rpc(
2025-11-09T23:42:54.8369218Z          &self,
2025-11-09T23:42:54.8369720Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:181:
2025-11-09T23:42:54.8369883Z      ) -> RpcResult<Value> {
2025-11-09T23:42:54.8370099Z          // Convert previous block hash to hex (big-endian)
2025-11-09T23:42:54.8370376Z          let prev_hash_hex = hex::encode(prev_header.prev_block_hash);
2025-11-09T23:42:54.8370504Z -        
2025-11-09T23:42:54.8370616Z +
2025-11-09T23:42:54.8370855Z          // Convert target to hex (64 characters, big-endian)
2025-11-09T23:42:54.8371076Z          let target_hex = format!("{:064x}", template.target);
2025-11-09T23:42:54.8371196Z -        
2025-11-09T23:42:54.8371307Z +
2025-11-09T23:42:54.8371469Z          // Convert bits to hex (8 characters)
2025-11-09T23:42:54.8371706Z          let bits_hex = format!("{:08x}", template.header.bits);
2025-11-09T23:42:54.8371817Z -        
2025-11-09T23:42:54.8371925Z +
2025-11-09T23:42:54.8372087Z          // Convert transactions to JSON array
2025-11-09T23:42:54.8372355Z -        let transactions_json: Vec<Value> = template.transactions
2025-11-09T23:42:54.8372555Z +        let transactions_json: Vec<Value> = template
2025-11-09T23:42:54.8372690Z +            .transactions
2025-11-09T23:42:54.8372895Z              .iter()
2025-11-09T23:42:54.8373122Z              .map(|tx| self.transaction_to_json(tx))
2025-11-09T23:42:54.8373304Z              .collect();
2025-11-09T23:42:54.8373768Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:196:
2025-11-09T23:42:54.8373896Z -        
2025-11-09T23:42:54.8374001Z +
2025-11-09T23:42:54.8374174Z          // Calculate coinbase value (subsidy + fees)
2025-11-09T23:42:54.8374627Z          let coinbase_value = self.calculate_coinbase_value(template, height);
2025-11-09T23:42:54.8374734Z -        
2025-11-09T23:42:54.8374828Z +
2025-11-09T23:42:54.8374975Z          // Get active rules (BIP 9 feature flags)
2025-11-09T23:42:54.8375128Z          let rules = self.get_active_rules(height);
2025-11-09T23:42:54.8375484Z -        
2025-11-09T23:42:54.8375586Z +
2025-11-09T23:42:54.8375734Z          // Get minimum time (median time + 1)
2025-11-09T23:42:54.8376697Z          let min_time = self.get_min_time(height);
2025-11-09T23:42:54.8376809Z -        
2025-11-09T23:42:54.8376916Z +
2025-11-09T23:42:54.8377026Z          Ok(json!({
2025-11-09T23:42:54.8377178Z              "capabilities": ["proposal"],
2025-11-09T23:42:54.8377352Z              "version": template.header.version as i32,
2025-11-09T23:42:54.8377799Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:228:
2025-11-09T23:42:54.8377945Z              "height": template.height
2025-11-09T23:42:54.8378051Z          }))
2025-11-09T23:42:54.8378159Z      }
2025-11-09T23:42:54.8378259Z -    
2025-11-09T23:42:54.8378358Z +
2025-11-09T23:42:54.8378543Z      // Helper methods - access chainstate and mempool
2025-11-09T23:42:54.8378662Z -    
2025-11-09T23:42:54.8378773Z +
2025-11-09T23:42:54.8379035Z      fn get_current_height(&self) -> RpcResult<Option<Natural>> {
2025-11-09T23:42:54.8379223Z          if let Some(ref storage) = self.storage {
2025-11-09T23:42:54.8379383Z -            storage.chain().get_height()
2025-11-09T23:42:54.8379498Z +            storage
2025-11-09T23:42:54.8379620Z +                .chain()
2025-11-09T23:42:54.8379749Z +                .get_height()
2025-11-09T23:42:54.8380079Z                  .map_err(|e| RpcError::internal_error(format!("Failed to get height: {}", e)))
2025-11-09T23:42:54.8380430Z          } else {
2025-11-09T23:42:54.8380540Z              Ok(None)
2025-11-09T23:42:54.8380956Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:240:
2025-11-09T23:42:54.8381062Z          }
2025-11-09T23:42:54.8381161Z      }
2025-11-09T23:42:54.8381265Z -    
2025-11-09T23:42:54.8381361Z +
2025-11-09T23:42:54.8381593Z      fn get_tip_header(&self) -> RpcResult<Option<BlockHeader>> {
2025-11-09T23:42:54.8381754Z          if let Some(ref storage) = self.storage {
2025-11-09T23:42:54.8381912Z -            storage.chain().get_tip_header()
2025-11-09T23:42:54.8382019Z +            storage
2025-11-09T23:42:54.8382129Z +                .chain()
2025-11-09T23:42:54.8382261Z +                .get_tip_header()
2025-11-09T23:42:54.8382606Z                  .map_err(|e| RpcError::internal_error(format!("Failed to get tip header: {}", e)))
2025-11-09T23:42:54.8382710Z          } else {
2025-11-09T23:42:54.8382825Z              Ok(None)
2025-11-09T23:42:54.8383271Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:249:
2025-11-09T23:42:54.8383379Z          }
2025-11-09T23:42:54.8383488Z      }
2025-11-09T23:42:54.8383587Z -    
2025-11-09T23:42:54.8383684Z +
2025-11-09T23:42:54.8383963Z      fn get_headers_for_difficulty(&self) -> RpcResult<Vec<BlockHeader>> {
2025-11-09T23:42:54.8384135Z          if let Some(ref storage) = self.storage {
2025-11-09T23:42:54.8384519Z              // Get last 2016 headers for difficulty adjustment
2025-11-09T23:42:54.8384939Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:255:
2025-11-09T23:42:54.8385322Z              // For now, return just the tip (full implementation would get last 2016)
2025-11-09T23:42:54.8385532Z -            if let Some(tip) = storage.chain().get_tip_header()
2025-11-09T23:42:54.8385662Z +            if let Some(tip) = storage
2025-11-09T23:42:54.8385781Z +                .chain()
2025-11-09T23:42:54.8385914Z +                .get_tip_header()
2025-11-09T23:42:54.8386230Z                  .map_err(|e| RpcError::internal_error(format!("Failed to get tip: {}", e)))?
2025-11-09T23:42:54.8386333Z              {
2025-11-09T23:42:54.8386470Z                  Ok(vec![tip])
2025-11-09T23:42:54.8386892Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:264:
2025-11-09T23:42:54.8387008Z              Ok(vec![])
2025-11-09T23:42:54.8387128Z          }
2025-11-09T23:42:54.8387241Z      }
2025-11-09T23:42:54.8387353Z -    
2025-11-09T23:42:54.8387725Z +
2025-11-09T23:42:54.8388053Z      fn get_mempool_transactions(&self) -> RpcResult<Vec<Transaction>> {
2025-11-09T23:42:54.8388303Z          if let Some(ref mempool) = self.mempool {
2025-11-09T23:42:54.8388478Z              // Get UTXO set for fee calculation
2025-11-09T23:42:54.8388926Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:271:
2025-11-09T23:42:54.8389093Z              let utxo_set = self.get_utxo_set()?;
2025-11-09T23:42:54.8389213Z -            
2025-11-09T23:42:54.8389317Z +
2025-11-09T23:42:54.8389699Z              // Get prioritized transactions (limit to reasonable number for block template)
2025-11-09T23:42:54.8389837Z              let limit = 1000;
2025-11-09T23:42:54.8390106Z              Ok(mempool.get_prioritized_transactions(limit, &utxo_set))
2025-11-09T23:42:54.8390572Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:277:
2025-11-09T23:42:54.8390698Z              Ok(vec![])
2025-11-09T23:42:54.8390823Z          }
2025-11-09T23:42:54.8390945Z      }
2025-11-09T23:42:54.8391056Z -    
2025-11-09T23:42:54.8391162Z +
2025-11-09T23:42:54.8391409Z      /// Calculate difficulty from bits (compact target format)
2025-11-09T23:42:54.8391692Z      /// Uses the same logic as BlockchainRpc::calculate_difficulty
2025-11-09T23:42:54.8391877Z      fn calculate_difficulty(bits: u64) -> f64 {
2025-11-09T23:42:54.8394031Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:284:
2025-11-09T23:42:54.8394627Z          // Difficulty = MAX_TARGET / target
2025-11-09T23:42:54.8395122Z          // MAX_TARGET for Bitcoin mainnet is 0x00000000FFFF0000000000000000000000000000000000000000000000000000
2025-11-09T23:42:54.8395416Z          // For display purposes, we normalize to genesis difficulty = 1.0
2025-11-09T23:42:54.8395876Z -        const MAX_TARGET: u128 = 0x00000000FFFF0000000000000000000000000000000000000000000000000000u128;
2025-11-09T23:42:54.8395998Z -        
2025-11-09T23:42:54.8396161Z +        const MAX_TARGET: u128 =
2025-11-09T23:42:54.8396494Z +            0x00000000FFFF0000000000000000000000000000000000000000000000000000u128;
2025-11-09T23:42:54.8396621Z +
2025-11-09T23:42:54.8396862Z          // Simplified difficulty calculation using bits directly
2025-11-09T23:42:54.8397138Z          // For display purposes, use a simple approximation based on bits
2025-11-09T23:42:54.8397308Z          let mantissa = (bits & 0x00ffffff) as f64;
2025-11-09T23:42:54.8397825Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:295:
2025-11-09T23:42:54.8398004Z          let max_mantissa = 0x00ffff00 as f64;
2025-11-09T23:42:54.8398163Z          (max_mantissa / mantissa).max(1.0)
2025-11-09T23:42:54.8398275Z      }
2025-11-09T23:42:54.8398385Z -    
2025-11-09T23:42:54.8398491Z +
2025-11-09T23:42:54.8398734Z      /// Calculate network hashrate from recent block timestamps
2025-11-09T23:42:54.8398980Z      /// Estimates hashrate based on the time between recent blocks
2025-11-09T23:42:54.8399365Z      fn calculate_network_hashrate(&self, storage: &Storage) -> Result<f64, anyhow::Error> {
2025-11-09T23:42:54.8399799Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:302:
2025-11-09T23:42:54.8399938Z          // Get tip height
2025-11-09T23:42:54.8400127Z -        let tip_height = storage.chain().get_height()?
2025-11-09T23:42:54.8400264Z +        let tip_height = storage
2025-11-09T23:42:54.8400390Z +            .chain()
2025-11-09T23:42:54.8400506Z +            .get_height()?
2025-11-09T23:42:54.8400735Z              .ok_or_else(|| anyhow::anyhow!("Chain not initialized"))?;
2025-11-09T23:42:54.8400845Z -        
2025-11-09T23:42:54.8400946Z +
2025-11-09T23:42:54.8401119Z          // Need at least 2 blocks to calculate hashrate
2025-11-09T23:42:54.8401250Z          if tip_height < 1 {
2025-11-09T23:42:54.8401379Z              return Ok(0.0);
2025-11-09T23:42:54.8401817Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:309:
2025-11-09T23:42:54.8402190Z          }
2025-11-09T23:42:54.8402315Z -        
2025-11-09T23:42:54.8402429Z +
2025-11-09T23:42:54.8402679Z          // Get last 144 blocks (approximately 1 day at 10 min/block)
2025-11-09T23:42:54.8402855Z          // Or use fewer blocks if chain is shorter
2025-11-09T23:42:54.8403032Z          let num_blocks = (tip_height + 1).min(144);
2025-11-09T23:42:54.8403477Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:314:
2025-11-09T23:42:54.8403768Z          let start_height = tip_height.saturating_sub(num_blocks - 1);
2025-11-09T23:42:54.8403891Z -        
2025-11-09T23:42:54.8406209Z +
2025-11-09T23:42:54.8406402Z          // Get timestamps from blocks
2025-11-09T23:42:54.8406585Z          let mut timestamps = Vec::new();
2025-11-09T23:42:54.8406773Z          for height in start_height..=tip_height {
2025-11-09T23:42:54.8408520Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:322:
2025-11-09T23:42:54.8408695Z                  }
2025-11-09T23:42:54.8408811Z              }
2025-11-09T23:42:54.8408926Z          }
2025-11-09T23:42:54.8409041Z -        
2025-11-09T23:42:54.8409160Z +
2025-11-09T23:42:54.8409382Z          if timestamps.len() < 2 {
2025-11-09T23:42:54.8409523Z              return Ok(0.0);
2025-11-09T23:42:54.8409634Z          }
2025-11-09T23:42:54.8410084Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:329:
2025-11-09T23:42:54.8410447Z -        
2025-11-09T23:42:54.8410557Z +
2025-11-09T23:42:54.8410744Z          // Calculate average time between blocks
2025-11-09T23:42:54.8410909Z          let first_timestamp = timestamps[0].1;
2025-11-09T23:42:54.8411136Z          let last_timestamp = timestamps[timestamps.len() - 1].1;
2025-11-09T23:42:54.8411547Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:333:
2025-11-09T23:42:54.8411814Z          let time_span = last_timestamp.saturating_sub(first_timestamp);
2025-11-09T23:42:54.8412014Z          let num_intervals = timestamps.len() - 1;
2025-11-09T23:42:54.8412129Z -        
2025-11-09T23:42:54.8412248Z +
2025-11-09T23:42:54.8412424Z          if time_span == 0 || num_intervals == 0 {
2025-11-09T23:42:54.8412558Z              return Ok(0.0);
2025-11-09T23:42:54.8412684Z          }
2025-11-09T23:42:54.8413136Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:339:
2025-11-09T23:42:54.8413271Z -        
2025-11-09T23:42:54.8413380Z +
2025-11-09T23:42:54.8413665Z          let avg_time_per_block = time_span as f64 / num_intervals as f64;
2025-11-09T23:42:54.8416090Z -        
2025-11-09T23:42:54.8416217Z +
2025-11-09T23:42:54.8416386Z          // Get difficulty from tip block
2025-11-09T23:42:54.8416664Z -        let tip_hash = storage.blocks().get_hash_by_height(tip_height)?
2025-11-09T23:42:54.8416808Z +        let tip_hash = storage
2025-11-09T23:42:54.8416929Z +            .blocks()
2025-11-09T23:42:54.8417181Z +            .get_hash_by_height(tip_height)?
2025-11-09T23:42:54.8417436Z              .ok_or_else(|| anyhow::anyhow!("Tip block not found"))?;
2025-11-09T23:42:54.8417670Z -        let tip_block = storage.blocks().get_block(&tip_hash)?
2025-11-09T23:42:54.8417821Z +        let tip_block = storage
2025-11-09T23:42:54.8417936Z +            .blocks()
2025-11-09T23:42:54.8418078Z +            .get_block(&tip_hash)?
2025-11-09T23:42:54.8418317Z              .ok_or_else(|| anyhow::anyhow!("Tip block not found"))?;
2025-11-09T23:42:54.8418630Z          let difficulty = Self::calculate_difficulty(tip_block.header.bits);
2025-11-09T23:42:54.8418748Z -        
2025-11-09T23:42:54.8418854Z +
2025-11-09T23:42:54.8419126Z          // Calculate hashrate: difficulty * 2^32 / avg_time_per_block
2025-11-09T23:42:54.8419383Z          // This estimates the network hashrate in hashes per second
2025-11-09T23:42:54.8419729Z          // 2^32 is the number of hashes needed on average to find a block at difficulty 1.0
2025-11-09T23:42:54.8420442Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:352:
2025-11-09T23:42:54.8420681Z          const HASHES_PER_DIFFICULTY: f64 = 4294967296.0; // 2^32
2025-11-09T23:42:54.8421014Z          let hashrate = (difficulty * HASHES_PER_DIFFICULTY) / avg_time_per_block;
2025-11-09T23:42:54.8421130Z -        
2025-11-09T23:42:54.8421242Z +
2025-11-09T23:42:54.8421367Z          Ok(hashrate)
2025-11-09T23:42:54.8421490Z      }
2025-11-09T23:42:54.8421609Z -    
2025-11-09T23:42:54.8421720Z +
2025-11-09T23:42:54.8421907Z      fn get_utxo_set(&self) -> RpcResult<UtxoSet> {
2025-11-09T23:42:54.8422091Z          if let Some(ref storage) = self.storage {
2025-11-09T23:42:54.8422243Z              // Get UTXO set from storage
2025-11-09T23:42:54.8422699Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:361:
2025-11-09T23:42:54.8422868Z -            storage.utxos().get_all_utxos()
2025-11-09T23:42:54.8422995Z +            storage
2025-11-09T23:42:54.8423125Z +                .utxos()
2025-11-09T23:42:54.8423255Z +                .get_all_utxos()
2025-11-09T23:42:54.8423637Z                  .map_err(|e| RpcError::internal_error(format!("Failed to get UTXO set: {}", e)))
2025-11-09T23:42:54.8423758Z          } else {
2025-11-09T23:42:54.8423899Z              Ok(UtxoSet::new())
2025-11-09T23:42:54.8424497Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:365:
2025-11-09T23:42:54.8424830Z          }
2025-11-09T23:42:54.8424936Z      }
2025-11-09T23:42:54.8425034Z -    
2025-11-09T23:42:54.8425138Z +
2025-11-09T23:42:54.8425474Z      fn extract_coinbase_script(&self, params: &Value) -> Option<ByteString> {
2025-11-09T23:42:54.8425698Z          // Extract coinbase script from params if provided
2025-11-09T23:42:54.8425909Z          if let Some(template_request) = params.get(0) {
2025-11-09T23:42:54.8428148Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:379:
2025-11-09T23:42:54.8428306Z          // Default: empty script
2025-11-09T23:42:54.8428425Z          Some(vec![])
2025-11-09T23:42:54.8428534Z      }
2025-11-09T23:42:54.8428631Z -    
2025-11-09T23:42:54.8428732Z +
2025-11-09T23:42:54.8429046Z      fn extract_coinbase_address(&self, params: &Value) -> Option<ByteString> {
2025-11-09T23:42:54.8429256Z          // Extract coinbase address from params if provided
2025-11-09T23:42:54.8429438Z          if let Some(template_request) = params.get(0) {
2025-11-09T23:42:54.8429887Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:393:
2025-11-09T23:42:54.8430034Z          // Default: empty
2025-11-09T23:42:54.8430144Z          Some(vec![])
2025-11-09T23:42:54.8430249Z      }
2025-11-09T23:42:54.8430357Z -    
2025-11-09T23:42:54.8430455Z +
2025-11-09T23:42:54.8430684Z      fn transaction_to_json(&self, tx: &Transaction) -> Value {
2025-11-09T23:42:54.8431281Z          // Convert transaction to JSON-RPC format
2025-11-09T23:42:54.8431454Z          let tx_bytes = serialize_transaction(tx);
2025-11-09T23:42:54.8431892Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:401:
2025-11-09T23:42:54.8432071Z          let fee = self.calculate_transaction_fee(tx);
2025-11-09T23:42:54.8432227Z          let sigops = self.count_sigops(tx);
2025-11-09T23:42:54.8432398Z          let weight = self.calculate_weight(tx);
2025-11-09T23:42:54.8432508Z -        
2025-11-09T23:42:54.8432633Z +
2025-11-09T23:42:54.8432758Z          json!({
2025-11-09T23:42:54.8432925Z              "data": hex::encode(&tx_bytes),
2025-11-09T23:42:54.8433079Z              "txid": hex::encode(tx_hash),
2025-11-09T23:42:54.8433537Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:410:
2025-11-09T23:42:54.8433668Z              "weight": weight,
2025-11-09T23:42:54.8433778Z          })
2025-11-09T23:42:54.8433896Z      }
2025-11-09T23:42:54.8434005Z -    
2025-11-09T23:42:54.8434115Z +
2025-11-09T23:42:54.8434518Z      fn calculate_tx_hash(&self, tx_bytes: &[u8]) -> [u8; 32] {
2025-11-09T23:42:54.8435078Z          // Transaction hash is double SHA256 of transaction bytes
2025-11-09T23:42:54.8435249Z          let hash1 = Sha256::digest(tx_bytes);
2025-11-09T23:42:54.8435691Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:417:
2025-11-09T23:42:54.8435863Z          let hash2 = Sha256::digest(hash1);
2025-11-09T23:42:54.8435985Z -        
2025-11-09T23:42:54.8436095Z +
2025-11-09T23:42:54.8436237Z          let mut result = [0u8; 32];
2025-11-09T23:42:54.8436402Z          result.copy_from_slice(&hash2);
2025-11-09T23:42:54.8436520Z          result
2025-11-09T23:42:54.8436961Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:422:
2025-11-09T23:42:54.8437080Z      }
2025-11-09T23:42:54.8437188Z -    
2025-11-09T23:42:54.8437298Z +
2025-11-09T23:42:54.8437576Z      fn calculate_transaction_fee(&self, tx: &Transaction) -> u64 {
2025-11-09T23:42:54.8437814Z          // Use MempoolManager's fee calculation if available
2025-11-09T23:42:54.8437995Z          if let Some(ref mempool) = self.mempool {
2025-11-09T23:42:54.8438448Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:447:
2025-11-09T23:42:54.8438566Z              0
2025-11-09T23:42:54.8438678Z          }
2025-11-09T23:42:54.8438789Z      }
2025-11-09T23:42:54.8438911Z -    
2025-11-09T23:42:54.8439243Z +
2025-11-09T23:42:54.8439447Z      fn count_sigops(&self, tx: &Transaction) -> u32 {
2025-11-09T23:42:54.8439600Z          // Use consensus layer sigop counting
2025-11-09T23:42:54.8439752Z          #[cfg(feature = "sigop")]
2025-11-09T23:42:54.8440192Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:456:
2025-11-09T23:42:54.8440475Z              // Convert protocol transaction to consensus transaction format
2025-11-09T23:42:54.8440628Z              let consensus_tx = ConsensusTx {
2025-11-09T23:42:54.8440763Z                  version: tx.version,
2025-11-09T23:42:54.8441075Z -                inputs: tx.inputs.iter().map(|inp| bllvm_protocol::TransactionInput {
2025-11-09T23:42:54.8441265Z -                    prevout: bllvm_protocol::OutPoint {
2025-11-09T23:42:54.8441437Z -                        hash: inp.prevout.hash,
2025-11-09T23:42:54.8441603Z -                        index: inp.prevout.index,
2025-11-09T23:42:54.8441725Z -                    },
2025-11-09T23:42:54.8441916Z -                    script_sig: inp.script_sig.clone(),
2025-11-09T23:42:54.8442071Z -                    sequence: inp.sequence,
2025-11-09T23:42:54.8442203Z -                }).collect(),
2025-11-09T23:42:54.8442565Z -                outputs: tx.outputs.iter().map(|out| bllvm_protocol::TransactionOutput {
2025-11-09T23:42:54.8442710Z -                    value: out.value,
2025-11-09T23:42:54.8442902Z -                    script_pubkey: out.script_pubkey.clone(),
2025-11-09T23:42:54.8443027Z -                }).collect(),
2025-11-09T23:42:54.8443158Z +                inputs: tx
2025-11-09T23:42:54.8443286Z +                    .inputs
2025-11-09T23:42:54.8443404Z +                    .iter()
2025-11-09T23:42:54.8443626Z +                    .map(|inp| bllvm_protocol::TransactionInput {
2025-11-09T23:42:54.8443814Z +                        prevout: bllvm_protocol::OutPoint {
2025-11-09T23:42:54.8443985Z +                            hash: inp.prevout.hash,
2025-11-09T23:42:54.8444152Z +                            index: inp.prevout.index,
2025-11-09T23:42:54.8444287Z +                        },
2025-11-09T23:42:54.8446448Z +                        script_sig: inp.script_sig.clone(),
2025-11-09T23:42:54.8446605Z +                        sequence: inp.sequence,
2025-11-09T23:42:54.8446730Z +                    })
2025-11-09T23:42:54.8446859Z +                    .collect(),
2025-11-09T23:42:54.8446987Z +                outputs: tx
2025-11-09T23:42:54.8447121Z +                    .outputs
2025-11-09T23:42:54.8447243Z +                    .iter()
2025-11-09T23:42:54.8447691Z +                    .map(|out| bllvm_protocol::TransactionOutput {
2025-11-09T23:42:54.8447822Z +                        value: out.value,
2025-11-09T23:42:54.8448003Z +                        script_pubkey: out.script_pubkey.clone(),
2025-11-09T23:42:54.8448115Z +                    })
2025-11-09T23:42:54.8448231Z +                    .collect(),
2025-11-09T23:42:54.8448369Z                  lock_time: tx.lock_time,
2025-11-09T23:42:54.8448480Z              };
2025-11-09T23:42:54.8448683Z              use bllvm_protocol::sigop::get_legacy_sigop_count;
2025-11-09T23:42:54.8449193Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:480:
2025-11-09T23:42:54.8449366Z              for output in &tx.outputs {
2025-11-09T23:42:54.8449544Z                  for &byte in &output.script_pubkey {
2025-11-09T23:42:54.8449676Z                      match byte {
2025-11-09T23:42:54.8449851Z -                        0xac => count += 1, // OP_CHECKSIG
2025-11-09T23:42:54.8450044Z -                        0xad => count += 1, // OP_CHECKSIGVERIFY
2025-11-09T23:42:54.8450218Z -                        0xae => count += 1, // OP_CHECKMULTISIG
2025-11-09T23:42:54.8450384Z +                        0xac => count += 1,  // OP_CHECKSIG
2025-11-09T23:42:54.8450561Z +                        0xad => count += 1,  // OP_CHECKSIGVERIFY
2025-11-09T23:42:54.8450728Z +                        0xae => count += 1,  // OP_CHECKMULTISIG
2025-11-09T23:42:54.8451162Z                          0xaf => count += 20, // OP_CHECKMULTISIGVERIFY
2025-11-09T23:42:54.8451299Z                          _ => {}
2025-11-09T23:42:54.8451416Z                      }
2025-11-09T23:42:54.8451864Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:491:
2025-11-09T23:42:54.8451990Z              count
2025-11-09T23:42:54.8452100Z          }
2025-11-09T23:42:54.8452208Z      }
2025-11-09T23:42:54.8452323Z -    
2025-11-09T23:42:54.8452429Z +
2025-11-09T23:42:54.8452660Z      fn calculate_weight(&self, tx: &Transaction) -> u64 {
2025-11-09T23:42:54.8452957Z          // Transaction weight = (base_size * 3) + total_size (for SegWit)
2025-11-09T23:42:54.8453189Z          // For now, return base size * 4 (non-SegWit transaction)
2025-11-09T23:42:54.8453643Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:498:
2025-11-09T23:42:54.8453876Z          let base_size = serialize_transaction(tx).len() as u64;
2025-11-09T23:42:54.8454017Z          base_size * 4
2025-11-09T23:42:54.8454124Z      }
2025-11-09T23:42:54.8454229Z -    
2025-11-09T23:42:54.8454512Z +
2025-11-09T23:42:54.8454931Z      fn calculate_coinbase_value(&self, template: &BlockTemplate, _height: Natural) -> u64 {
2025-11-09T23:42:54.8455197Z          // Use consensus-proof's get_block_subsidy (formally verified)
2025-11-09T23:42:54.8455522Z          let subsidy = self.consensus.get_block_subsidy(template.height) as u64;
2025-11-09T23:42:54.8455956Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:505:
2025-11-09T23:42:54.8456076Z -        
2025-11-09T23:42:54.8456179Z +
2025-11-09T23:42:54.8456341Z          // Calculate total fees from transactions
2025-11-09T23:42:54.8456511Z -        let fees: u64 = template.transactions
2025-11-09T23:42:54.8456640Z +        let fees: u64 = template
2025-11-09T23:42:54.8456763Z +            .transactions
2025-11-09T23:42:54.8456880Z              .iter()
2025-11-09T23:42:54.8457074Z              .map(|tx| self.calculate_transaction_fee(tx))
2025-11-09T23:42:54.8457181Z              .sum();
2025-11-09T23:42:54.8457600Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:511:
2025-11-09T23:42:54.8457707Z -        
2025-11-09T23:42:54.8457809Z +
2025-11-09T23:42:54.8457927Z          subsidy + fees
2025-11-09T23:42:54.8458039Z      }
2025-11-09T23:42:54.8458144Z -    
2025-11-09T23:42:54.8458245Z +
2025-11-09T23:42:54.8458481Z      fn get_active_rules(&self, height: Natural) -> Vec<String> {
2025-11-09T23:42:54.8458873Z          // Determine active BIP 9 rules based on height
2025-11-09T23:42:54.8459159Z          let mut rules = vec!["csv".to_string()]; // CSV always active after height
2025-11-09T23:42:54.8459593Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:518:
2025-11-09T23:42:54.8459711Z -        
2025-11-09T23:42:54.8459912Z -        if height >= 481824 { // SegWit activation (mainnet)
2025-11-09T23:42:54.8460038Z +
2025-11-09T23:42:54.8460192Z +        if height >= 481824 {
2025-11-09T23:42:54.8460364Z +            // SegWit activation (mainnet)
2025-11-09T23:42:54.8460542Z              rules.push("segwit".to_string());
2025-11-09T23:42:54.8460652Z          }
2025-11-09T23:42:54.8460763Z -        
2025-11-09T23:42:54.8460965Z -        if height >= 709632 { // Taproot activation (mainnet)
2025-11-09T23:42:54.8461067Z +
2025-11-09T23:42:54.8461198Z +        if height >= 709632 {
2025-11-09T23:42:54.8461350Z +            // Taproot activation (mainnet)
2025-11-09T23:42:54.8461514Z              rules.push("taproot".to_string());
2025-11-09T23:42:54.8461621Z          }
2025-11-09T23:42:54.8461731Z -        
2025-11-09T23:42:54.8461832Z +
2025-11-09T23:42:54.8461941Z          rules
2025-11-09T23:42:54.8462053Z      }
2025-11-09T23:42:54.8462158Z -    
2025-11-09T23:42:54.8462261Z +
2025-11-09T23:42:54.8462465Z      fn get_min_time(&self, _height: Natural) -> Natural {
2025-11-09T23:42:54.8462684Z          // Get minimum time (median time of last 11 blocks + 1)
2025-11-09T23:42:54.8463001Z          // For now, return current time
2025-11-09T23:42:54.8463424Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:535:
2025-11-09T23:42:54.8463547Z              .unwrap()
2025-11-09T23:42:54.8463675Z              .as_secs() as Natural
2025-11-09T23:42:54.8463780Z      }
2025-11-09T23:42:54.8463881Z -    
2025-11-09T23:42:54.8463991Z +
2025-11-09T23:42:54.8464129Z      /// Submit a block to the network
2025-11-09T23:42:54.8464238Z -    /// 
2025-11-09T23:42:54.8464524Z +    ///
2025-11-09T23:42:54.8464672Z      /// Params: ["hexdata", "dummy"]
2025-11-09T23:42:54.8464963Z      pub async fn submit_block(&self, params: &Value) -> RpcResult<Value> {
2025-11-09T23:42:54.8465100Z          debug!("RPC: submitblock");
2025-11-09T23:42:54.8465525Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:544:
2025-11-09T23:42:54.8465630Z -        
2025-11-09T23:42:54.8465776Z -        let hex_data = params.get(0)
2025-11-09T23:42:54.8465885Z +
2025-11-09T23:42:54.8466014Z +        let hex_data = params
2025-11-09T23:42:54.8466123Z +            .get(0)
2025-11-09T23:42:54.8466260Z              .and_then(|p| p.as_str())
2025-11-09T23:42:54.8466578Z              .ok_or_else(|| RpcError::invalid_params("Missing hexdata parameter"))?;
2025-11-09T23:42:54.8466684Z -        
2025-11-09T23:42:54.8466787Z +
2025-11-09T23:42:54.8466906Z          // Decode hex
2025-11-09T23:42:54.8467072Z          let block_bytes = hex::decode(hex_data)
2025-11-09T23:42:54.8467400Z              .map_err(|e| RpcError::invalid_params(format!("Invalid hex data: {}", e)))?;
2025-11-09T23:42:54.8467820Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:552:
2025-11-09T23:42:54.8467926Z -        
2025-11-09T23:42:54.8468027Z +
2025-11-09T23:42:54.8468155Z          // Deserialize block
2025-11-09T23:42:54.8468454Z          let (block, witnesses) = deserialize_block_with_witnesses(&block_bytes)
2025-11-09T23:42:54.8468839Z              .map_err(|e| RpcError::invalid_params(format!("Failed to deserialize block: {}", e)))?;
2025-11-09T23:42:54.8469255Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:556:
2025-11-09T23:42:54.8469368Z -        
2025-11-09T23:42:54.8469470Z +
2025-11-09T23:42:54.8469605Z          // Get current chain state
2025-11-09T23:42:54.8469770Z -        let height = self.get_current_height()?
2025-11-09T23:42:54.8469894Z +        let height = self
2025-11-09T23:42:54.8470022Z +            .get_current_height()?
2025-11-09T23:42:54.8470468Z              .ok_or_else(|| RpcError::internal_error("Chain not initialized"))?;
2025-11-09T23:42:54.8470625Z          let utxo_set = self.get_utxo_set()?;
2025-11-09T23:42:54.8470730Z -        
2025-11-09T23:42:54.8470832Z +
2025-11-09T23:42:54.8470994Z          // Validate block using consensus layer
2025-11-09T23:42:54.8472228Z          // Note: This validates consensus rules, but doesn't check if block extends chain
2025-11-09T23:42:54.8472429Z          // In production, would also check:
2025-11-09T23:42:54.8472872Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:572:
2025-11-09T23:42:54.8473065Z                  debug!("Block submitted successfully");
2025-11-09T23:42:54.8473196Z                  Ok(json!(null))
2025-11-09T23:42:54.8473311Z              }
2025-11-09T23:42:54.8473524Z -            Ok((ValidationResult::Invalid(reason), _)) => {
2025-11-09T23:42:54.8473832Z -                Err(RpcError::invalid_params(format!("Invalid block: {}", reason)))
2025-11-09T23:42:54.8473952Z -            }
2025-11-09T23:42:54.8474080Z -            Err(e) => {
2025-11-09T23:42:54.8474545Z -                Err(RpcError::internal_error(format!("Validation error: {}", e)))
2025-11-09T23:42:54.8474663Z -            }
2025-11-09T23:42:54.8475045Z +            Ok((ValidationResult::Invalid(reason), _)) => Err(RpcError::invalid_params(format!(
2025-11-09T23:42:54.8475400Z +                "Invalid block: {}",
2025-11-09T23:42:54.8475511Z +                reason
2025-11-09T23:42:54.8475617Z +            ))),
2025-11-09T23:42:54.8475940Z +            Err(e) => Err(RpcError::internal_error(format!("Validation error: {}", e))),
2025-11-09T23:42:54.8476052Z          }
2025-11-09T23:42:54.8476157Z      }
2025-11-09T23:42:54.8476258Z -    
2025-11-09T23:42:54.8476371Z +
2025-11-09T23:42:54.8476511Z      /// Estimate smart fee rate
2025-11-09T23:42:54.8476622Z -    /// 
2025-11-09T23:42:54.8476742Z +    ///
2025-11-09T23:42:54.8477209Z      /// Params: [conf_target (optional, default: 6), estimate_mode (optional, default: "conservative")]
2025-11-09T23:42:54.8477563Z      pub async fn estimate_smart_fee(&self, params: &Value) -> RpcResult<Value> {
2025-11-09T23:42:54.8477733Z          debug!("RPC: estimatesmartfee");
2025-11-09T23:42:54.8478196Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:589:
2025-11-09T23:42:54.8478326Z -        
2025-11-09T23:42:54.8478489Z -        let conf_target = params.get(0)
2025-11-09T23:42:54.8478659Z -            .and_then(|p| p.as_u64())
2025-11-09T23:42:54.8478795Z -            .unwrap_or(6);
2025-11-09T23:42:54.8478910Z -        
2025-11-09T23:42:54.8479083Z -        let estimate_mode = params.get(1)
2025-11-09T23:42:54.8479195Z +
2025-11-09T23:42:54.8479509Z +        let conf_target = params.get(0).and_then(|p| p.as_u64()).unwrap_or(6);
2025-11-09T23:42:54.8479622Z +
2025-11-09T23:42:54.8479780Z +        let estimate_mode = params
2025-11-09T23:42:54.8479904Z +            .get(1)
2025-11-09T23:42:54.8480049Z              .and_then(|p| p.as_str())
2025-11-09T23:42:54.8480210Z              .unwrap_or("conservative");
2025-11-09T23:42:54.8480322Z -        
2025-11-09T23:42:54.8480433Z +
2025-11-09T23:42:54.8480578Z          // Validate estimate_mode
2025-11-09T23:42:54.8480717Z          match estimate_mode {
2025-11-09T23:42:54.8480914Z              "unset" | "economical" | "conservative" => {}
2025-11-09T23:42:54.8481390Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:601:
2025-11-09T23:42:54.8482113Z -            _ => return Err(RpcError::invalid_params(format!("Invalid estimate_mode: {}. Must be 'unset', 'economical', or 'conservative'", estimate_mode)))
2025-11-09T23:42:54.8482232Z +            _ => {
2025-11-09T23:42:54.8482545Z +                return Err(RpcError::invalid_params(format!(
2025-11-09T23:42:54.8482908Z +                    "Invalid estimate_mode: {}. Must be 'unset', 'economical', or 'conservative'",
2025-11-09T23:42:54.8483358Z +                    estimate_mode
2025-11-09T23:42:54.8483480Z +                )))
2025-11-09T23:42:54.8483596Z +            }
2025-11-09T23:42:54.8483722Z          }
2025-11-09T23:42:54.8483836Z -        
2025-11-09T23:42:54.8483942Z +
2025-11-09T23:42:54.8484210Z          // Get mempool transactions and UTXO set for fee calculation
2025-11-09T23:42:54.8484759Z          let mempool_txs = if let Some(ref mempool) = self.mempool {
2025-11-09T23:42:54.8484952Z              let utxo_set = self.get_utxo_set()?;
2025-11-09T23:42:54.8485419Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:608:
2025-11-09T23:42:54.8485554Z          } else {
2025-11-09T23:42:54.8485736Z              vec![]
2025-11-09T23:42:54.8485854Z          };
2025-11-09T23:42:54.8485978Z -        
2025-11-09T23:42:54.8486087Z +
2025-11-09T23:42:54.8486282Z          // Calculate fee rate based on mempool state
2025-11-09T23:42:54.8486532Z          // Simple algorithm: use median fee rate of top transactions
2025-11-09T23:42:54.8486734Z          let fee_rate = if !mempool_txs.is_empty() {
2025-11-09T23:42:54.8487184Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:615:
2025-11-09T23:42:54.8487356Z              let utxo_set = self.get_utxo_set()?;
2025-11-09T23:42:54.8487542Z              let mut fee_rates = Vec::new();
2025-11-09T23:42:54.8487658Z -            
2025-11-09T23:42:54.8488023Z +
2025-11-09T23:42:54.8488441Z              // MempoolManager.get_prioritized_transactions() already calculates fees correctly
2025-11-09T23:42:54.8488847Z              // We can extract fee rates from the prioritized list, but for now calculate directly
2025-11-09T23:42:54.8489007Z              for tx in &mempool_txs {
2025-11-09T23:42:54.8489466Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:621:
2025-11-09T23:42:54.8489766Z                  let fee = self.calculate_transaction_fee(tx); // Now uses UTXO set
2025-11-09T23:42:54.8489984Z                  let size = self.calculate_weight(tx) as usize;
2025-11-09T23:42:54.8490107Z -                
2025-11-09T23:42:54.8490224Z +
2025-11-09T23:42:54.8490360Z                  if size > 0 {
2025-11-09T23:42:54.8490517Z                      // Fee rate in BTC per vbyte
2025-11-09T23:42:54.8490830Z                      let rate = (fee as f64) / (size as f64) / 100_000_000.0; // Convert satoshis to BTC
2025-11-09T23:42:54.8491681Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:627:
2025-11-09T23:42:54.8491842Z                      fee_rates.push(rate);
2025-11-09T23:42:54.8491962Z                  }
2025-11-09T23:42:54.8492076Z              }
2025-11-09T23:42:54.8492185Z -            
2025-11-09T23:42:54.8492286Z +
2025-11-09T23:42:54.8492506Z              // Use median fee rate, or minimum if no transactions
2025-11-09T23:42:54.8492651Z              if !fee_rates.is_empty() {
2025-11-09T23:42:54.8493005Z                  fee_rates.sort_by(|a, b| a.partial_cmp(b).unwrap_or(std::cmp::Ordering::Equal));
2025-11-09T23:42:54.8493466Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:640:
2025-11-09T23:42:54.8493676Z              // No mempool transactions - return minimum fee
2025-11-09T23:42:54.8493800Z              0.00001 // 1 sat/vB
2025-11-09T23:42:54.8493916Z          };
2025-11-09T23:42:54.8494033Z -        
2025-11-09T23:42:54.8494141Z +
2025-11-09T23:42:54.8494498Z          // Adjust based on estimate_mode
2025-11-09T23:42:54.8494694Z          let adjusted_rate = match estimate_mode {
2025-11-09T23:42:54.8495043Z -            "economical" => fee_rate * 0.8, // 20% lower for economical
2025-11-09T23:42:54.8495304Z +            "economical" => fee_rate * 0.8,   // 20% lower for economical
2025-11-09T23:42:54.8495587Z              "conservative" => fee_rate * 1.2, // 20% higher for conservative
2025-11-09T23:42:54.8495719Z              _ => fee_rate,
2025-11-09T23:42:54.8495830Z          };
2025-11-09T23:42:54.8496556Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:650:
2025-11-09T23:42:54.8496670Z -        
2025-11-09T23:42:54.8496781Z +
2025-11-09T23:42:54.8496902Z          Ok(json!({
2025-11-09T23:42:54.8497068Z              "feerate": adjusted_rate,
2025-11-09T23:42:54.8497209Z              "blocks": conf_target
2025-11-09T23:42:54.8497647Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:660:
2025-11-09T23:42:54.8498047Z      pub async fn prioritise_transaction(&self, params: &Value) -> RpcResult<Value> {
2025-11-09T23:42:54.8498230Z          debug!("RPC: prioritisetransaction");
2025-11-09T23:42:54.8498338Z  
2025-11-09T23:42:54.8498490Z -        let txid = params.get(0)
2025-11-09T23:42:54.8498624Z +        let txid = params
2025-11-09T23:42:54.8498826Z +            .get(0)
2025-11-09T23:42:54.8498981Z              .and_then(|p| p.as_str())
2025-11-09T23:42:54.8499360Z              .ok_or_else(|| RpcError::invalid_params("Transaction ID required".to_string()))?;
2025-11-09T23:42:54.8499484Z  
2025-11-09T23:42:54.8500005Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:667:
2025-11-09T23:42:54.8500179Z -        let fee_delta = params.get(1)
2025-11-09T23:42:54.8500318Z +        let fee_delta = params
2025-11-09T23:42:54.8500433Z +            .get(1)
2025-11-09T23:42:54.8500579Z              .and_then(|p| p.as_i64())
2025-11-09T23:42:54.8501156Z              .ok_or_else(|| RpcError::invalid_params("Fee delta required".to_string()))?;
2025-11-09T23:42:54.8501268Z  
2025-11-09T23:42:54.8501700Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:671:
2025-11-09T23:42:54.8501877Z          let hash_bytes = hex::decode(txid)
2025-11-09T23:42:54.8502246Z              .map_err(|e| RpcError::invalid_params(format!("Invalid transaction ID: {}", e)))?;
2025-11-09T23:42:54.8502392Z          if hash_bytes.len() != 32 {
2025-11-09T23:42:54.8502805Z -            return Err(RpcError::invalid_params("Transaction ID must be 32 bytes".to_string()));
2025-11-09T23:42:54.8502993Z +            return Err(RpcError::invalid_params(
2025-11-09T23:42:54.8503189Z +                "Transaction ID must be 32 bytes".to_string(),
2025-11-09T23:42:54.8503303Z +            ));
2025-11-09T23:42:54.8503418Z          }
2025-11-09T23:42:54.8503560Z          let mut hash = [0u8; 32];
2025-11-09T23:42:54.8503721Z          hash.copy_from_slice(&hash_bytes);
2025-11-09T23:42:54.8504170Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:681:
2025-11-09T23:42:54.8504537Z              if mempool.get_transaction(&hash).is_some() {
2025-11-09T23:42:54.8504845Z                  // Note: In production, would update transaction priority/fee delta
2025-11-09T23:42:54.8505015Z                  // For now, just return success
2025-11-09T23:42:54.8505343Z -                debug!("Transaction {} prioritized with fee delta: {}", txid, fee_delta);
2025-11-09T23:42:54.8505462Z +                debug!(
2025-11-09T23:42:54.8505684Z +                    "Transaction {} prioritized with fee delta: {}",
2025-11-09T23:42:54.8505822Z +                    txid, fee_delta
2025-11-09T23:42:54.8505930Z +                );
2025-11-09T23:42:54.8506061Z                  Ok(json!(true))
2025-11-09T23:42:54.8506185Z              } else {
2025-11-09T23:42:54.8506355Z -                Err(RpcError::invalid_params(
2025-11-09T23:42:54.8506591Z -                    format!("Transaction {} not found in mempool", txid)
2025-11-09T23:42:54.8506709Z -                ))
2025-11-09T23:42:54.8506886Z +                Err(RpcError::invalid_params(format!(
2025-11-09T23:42:54.8507060Z +                    "Transaction {} not found in mempool",
2025-11-09T23:42:54.8507175Z +                    txid
2025-11-09T23:42:54.8507291Z +                )))
2025-11-09T23:42:54.8507401Z              }
2025-11-09T23:42:54.8507517Z          } else {
2025-11-09T23:42:54.8507854Z -            Err(RpcError::internal_error("Mempool not initialized".to_string()))
2025-11-09T23:42:54.8508271Z +            Err(RpcError::internal_error(
2025-11-09T23:42:54.8508451Z +                "Mempool not initialized".to_string(),
2025-11-09T23:42:54.8508565Z +            ))
2025-11-09T23:42:54.8508684Z          }
2025-11-09T23:42:54.8508793Z      }
2025-11-09T23:42:54.8508896Z  }
2025-11-09T23:42:54.8509355Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:696:
2025-11-09T23:42:54.8509474Z  
2025-11-09T23:42:54.8509612Z  impl Default for MiningRpc {
2025-11-09T23:42:54.8511873Z -    fn default() -> Self { Self::new() }
2025-11-09T23:42:54.8512050Z +    fn default() -> Self {
2025-11-09T23:42:54.8512173Z +        Self::new()
2025-11-09T23:42:54.8512292Z +    }
2025-11-09T23:42:54.8512410Z  }
2025-11-09T23:42:54.8512521Z  
2025-11-09T23:42:54.8513115Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mod.rs:120:
2025-11-09T23:42:54.8513253Z          self.mining_rpc =
2025-11-09T23:42:54.8513643Z              mining::MiningRpc::with_dependencies(Arc::clone(&storage), Arc::clone(&mempool));
2025-11-09T23:42:54.8514243Z          self.blockchain_rpc = blockchain::BlockchainRpc::with_dependencies(Arc::clone(&storage));
2025-11-09T23:42:54.8514884Z -        let mempool_rpc = mempool::MempoolRpc::with_dependencies(Arc::clone(&mempool), Arc::clone(&storage));
2025-11-09T23:42:54.8515046Z +        let mempool_rpc =
2025-11-09T23:42:54.8515719Z +            mempool::MempoolRpc::with_dependencies(Arc::clone(&mempool), Arc::clone(&storage));
2025-11-09T23:42:54.8515954Z          let rawtx_rpc = rawtx::RawTxRpc::with_dependencies(
2025-11-09T23:42:54.8516119Z              Arc::clone(&storage),
2025-11-09T23:42:54.8516261Z              Arc::clone(&mempool),
2025-11-09T23:42:54.8516690Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mod.rs:148:
2025-11-09T23:42:54.8516811Z      }
2025-11-09T23:42:54.8516921Z  
2025-11-09T23:42:54.8517075Z      /// Set network manager dependency
2025-11-09T23:42:54.8517574Z -    pub fn with_network_manager(mut self, network_manager: Arc<crate::network::NetworkManager>) -> Self {
2025-11-09T23:42:54.8517736Z +    pub fn with_network_manager(
2025-11-09T23:42:54.8519822Z +        mut self,
2025-11-09T23:42:54.8520155Z +        network_manager: Arc<crate::network::NetworkManager>,
2025-11-09T23:42:54.8520301Z +    ) -> Self {
2025-11-09T23:42:54.8520727Z          self.network_rpc = network::NetworkRpc::with_dependencies(Arc::clone(&network_manager));
2025-11-09T23:42:54.8521017Z          self.network_manager = Some(network_manager);
2025-11-09T23:42:54.8521621Z          self
2025-11-09T23:42:54.8522165Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mod.rs:196:
2025-11-09T23:42:54.8522285Z          ));
2025-11-09T23:42:54.8522410Z  
2025-11-09T23:42:54.8522606Z          // Create server with or without authentication
2025-11-09T23:42:54.8523070Z -        let server = if let (Some(ref storage), Some(ref mempool)) = (self.storage.as_ref(), self.mempool.as_ref()) {
2025-11-09T23:42:54.8523525Z -            let blockchain = Arc::new(blockchain::BlockchainRpc::with_dependencies(Arc::clone(storage)));
2025-11-09T23:42:54.8524007Z -            let mempool_rpc = Arc::new(mempool::MempoolRpc::with_dependencies(Arc::clone(mempool), Arc::clone(&storage)));
2025-11-09T23:42:54.8524672Z -            let rawtx_rpc = Arc::new(rawtx::RawTxRpc::with_dependencies(Arc::clone(storage), Arc::clone(mempool), None, None));
2025-11-09T23:42:54.8525128Z -            let mining = Arc::new(mining::MiningRpc::with_dependencies(Arc::clone(storage), Arc::clone(mempool)));
2025-11-09T23:42:54.8525356Z +        let server = if let (Some(ref storage), Some(ref mempool)) =
2025-11-09T23:42:54.8525563Z +            (self.storage.as_ref(), self.mempool.as_ref())
2025-11-09T23:42:54.8525689Z +        {
2025-11-09T23:42:54.8526049Z +            let blockchain = Arc::new(blockchain::BlockchainRpc::with_dependencies(Arc::clone(
2025-11-09T23:42:54.8526164Z +                storage,
2025-11-09T23:42:54.8526492Z +            )));
2025-11-09T23:42:54.8526761Z +            let mempool_rpc = Arc::new(mempool::MempoolRpc::with_dependencies(
2025-11-09T23:42:54.8526894Z +                Arc::clone(mempool),
2025-11-09T23:42:54.8536543Z +                Arc::clone(&storage),
2025-11-09T23:42:54.8536732Z +            ));
2025-11-09T23:42:54.8537035Z +            let rawtx_rpc = Arc::new(rawtx::RawTxRpc::with_dependencies(
2025-11-09T23:42:54.8537210Z +                Arc::clone(storage),
2025-11-09T23:42:54.8537368Z +                Arc::clone(mempool),
2025-11-09T23:42:54.8537487Z +                None,
2025-11-09T23:42:54.8537603Z +                None,
2025-11-09T23:42:54.8537726Z +            ));
2025-11-09T23:42:54.8537996Z +            let mining = Arc::new(mining::MiningRpc::with_dependencies(
2025-11-09T23:42:54.8538146Z +                Arc::clone(storage),
2025-11-09T23:42:54.8538285Z +                Arc::clone(mempool),
2025-11-09T23:42:54.8538406Z +            ));
2025-11-09T23:42:54.8538724Z              let network = if let Some(ref network_manager) = self.network_manager {
2025-11-09T23:42:54.8539102Z -                Arc::new(network::NetworkRpc::with_dependencies(Arc::clone(network_manager)))
2025-11-09T23:42:54.8539375Z +                Arc::new(network::NetworkRpc::with_dependencies(Arc::clone(
2025-11-09T23:42:54.8539514Z +                    network_manager,
2025-11-09T23:42:54.8539632Z +                )))
2025-11-09T23:42:54.8540062Z              } else {
2025-11-09T23:42:54.8540272Z                  Arc::new(network::NetworkRpc::new())
2025-11-09T23:42:54.8540388Z              };
2025-11-09T23:42:54.8540818Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mod.rs:209:
2025-11-09T23:42:54.8540950Z -            
2025-11-09T23:42:54.8541063Z +
2025-11-09T23:42:54.8541230Z              // Use auth manager if configured
2025-11-09T23:42:54.8541451Z              if let Some(ref auth_manager) = self.auth_manager {
2025-11-09T23:42:54.8541666Z                  server::RpcServer::with_dependencies_and_auth(
2025-11-09T23:42:54.8542101Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mod.rs:233:
2025-11-09T23:42:54.8542225Z          } else {
2025-11-09T23:42:54.8542425Z              // No dependencies - use auth if configured
2025-11-09T23:42:54.8542631Z              if let Some(ref auth_manager) = self.auth_manager {
2025-11-09T23:42:54.8542797Z -                server::RpcServer::with_auth(
2025-11-09T23:42:54.8542963Z -                    self.server_addr,
2025-11-09T23:42:54.8543130Z -                    Arc::clone(auth_manager),
2025-11-09T23:42:54.8543249Z -                )
2025-11-09T23:42:54.8543670Z +                server::RpcServer::with_auth(self.server_addr, Arc::clone(auth_manager))
2025-11-09T23:42:54.8543810Z              } else {
2025-11-09T23:42:54.8544008Z                  server::RpcServer::new(self.server_addr)
2025-11-09T23:42:54.8545804Z              }
2025-11-09T23:42:54.8546280Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:18:
2025-11-09T23:42:54.8546429Z  impl NetworkRpc {
2025-11-09T23:42:54.8546590Z      /// Create a new network RPC handler
2025-11-09T23:42:54.8546739Z      pub fn new() -> Self {
2025-11-09T23:42:54.8546886Z -        Self { network_manager: None }
2025-11-09T23:42:54.8546995Z +        Self {
2025-11-09T23:42:54.8547134Z +            network_manager: None,
2025-11-09T23:42:54.8547252Z +        }
2025-11-09T23:42:54.8547361Z      }
2025-11-09T23:42:54.8547472Z  
2025-11-09T23:42:54.8547621Z      /// Create with dependencies
2025-11-09T23:42:54.8548072Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:25:
2025-11-09T23:42:54.8548424Z      pub fn with_dependencies(network_manager: Arc<NetworkManager>) -> Self {
2025-11-09T23:42:54.8548632Z -        Self { network_manager: Some(network_manager) }
2025-11-09T23:42:54.8548761Z +        Self {
2025-11-09T23:42:54.8548943Z +            network_manager: Some(network_manager),
2025-11-09T23:42:54.8549315Z +        }
2025-11-09T23:42:54.8549441Z      }
2025-11-09T23:42:54.8549550Z  
2025-11-09T23:42:54.8549692Z      /// Get network information
2025-11-09T23:42:54.8550146Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:103:
2025-11-09T23:42:54.8550368Z          if let Some(ref network) = self.network_manager {
2025-11-09T23:42:54.8550565Z              let peer_manager = network.peer_manager();
2025-11-09T23:42:54.8550795Z              let peer_addresses = peer_manager.peer_addresses();
2025-11-09T23:42:54.8551057Z -            let peers: Vec<Value> = peer_addresses.iter().map(|addr| {
2025-11-09T23:42:54.8551270Z -                if let Some(peer) = peer_manager.get_peer(addr) {
2025-11-09T23:42:54.8551395Z -                    json!({
2025-11-09T23:42:54.8551766Z -                        "id": addr.port().unwrap_or(0) as u64, // Use port as peer ID (unique per connection)
2025-11-09T23:42:54.8551927Z -                        "addr": addr.to_string(),
2025-11-09T23:42:54.8552086Z -                        "addrlocal": "",
2025-11-09T23:42:54.8552243Z -                        "services": "0000000000000001",
2025-11-09T23:42:54.8552399Z -                        "relaytxes": true,
2025-11-09T23:42:54.8552567Z -                        "lastsend": peer.last_send(),
2025-11-09T23:42:54.8552724Z -                        "lastrecv": peer.last_recv(),
2025-11-09T23:42:54.8553122Z -                        "bytessent": peer.bytes_sent(),
2025-11-09T23:42:54.8553290Z -                        "bytesrecv": peer.bytes_recv(),
2025-11-09T23:42:54.8553456Z -                        "conntime": peer.conntime(),
2025-11-09T23:42:54.8553611Z -                        "timeoffset": 0,
2025-11-09T23:42:54.8553754Z -                        "pingtime": 0.0,
2025-11-09T23:42:54.8553897Z -                        "minping": 0.0,
2025-11-09T23:42:54.8554036Z -                        "version": 70015,
2025-11-09T23:42:54.8554222Z -                        "subver": "/reference-node:0.1.0/",
2025-11-09T23:42:54.8554561Z -                        "inbound": false,
2025-11-09T23:42:54.8554710Z -                        "addnode": false,
2025-11-09T23:42:54.8554875Z -                        "startingheight": 0,
2025-11-09T23:42:54.8555033Z -                        "synced_headers": -1,
2025-11-09T23:42:54.8555184Z -                        "synced_blocks": -1,
2025-11-09T23:42:54.8555323Z -                        "inflight": [],
2025-11-09T23:42:54.8555491Z -                        "whitelisted": false,
2025-11-09T23:42:54.8555649Z -                        "minfeefilter": 0.00001000,
2025-11-09T23:42:54.8555802Z -                        "bytessent_per_msg": {},
2025-11-09T23:42:54.8555964Z -                        "bytesrecv_per_msg": {}
2025-11-09T23:42:54.8556079Z -                    })
2025-11-09T23:42:54.8556197Z -                } else {
2025-11-09T23:42:54.8556329Z -                    json!({})
2025-11-09T23:42:54.8556444Z -                }
2025-11-09T23:42:54.8556581Z -            }).collect();
2025-11-09T23:42:54.8556754Z +            let peers: Vec<Value> = peer_addresses
2025-11-09T23:42:54.8556886Z +                .iter()
2025-11-09T23:42:54.8557016Z +                .map(|addr| {
2025-11-09T23:42:54.8557238Z +                    if let Some(peer) = peer_manager.get_peer(addr) {
2025-11-09T23:42:54.8557373Z +                        json!({
2025-11-09T23:42:54.8557743Z +                            "id": addr.port().unwrap_or(0) as u64, // Use port as peer ID (unique per connection)
2025-11-09T23:42:54.8557919Z +                            "addr": addr.to_string(),
2025-11-09T23:42:54.8558061Z +                            "addrlocal": "",
2025-11-09T23:42:54.8558229Z +                            "services": "0000000000000001",
2025-11-09T23:42:54.8558382Z +                            "relaytxes": true,
2025-11-09T23:42:54.8558551Z +                            "lastsend": peer.last_send(),
2025-11-09T23:42:54.8558727Z +                            "lastrecv": peer.last_recv(),
2025-11-09T23:42:54.8559145Z +                            "bytessent": peer.bytes_sent(),
2025-11-09T23:42:54.8559315Z +                            "bytesrecv": peer.bytes_recv(),
2025-11-09T23:42:54.8559488Z +                            "conntime": peer.conntime(),
2025-11-09T23:42:54.8559639Z +                            "timeoffset": 0,
2025-11-09T23:42:54.8559780Z +                            "pingtime": 0.0,
2025-11-09T23:42:54.8559934Z +                            "minping": 0.0,
2025-11-09T23:42:54.8560093Z +                            "version": 70015,
2025-11-09T23:42:54.8560273Z +                            "subver": "/reference-node:0.1.0/",
2025-11-09T23:42:54.8560415Z +                            "inbound": false,
2025-11-09T23:42:54.8560567Z +                            "addnode": false,
2025-11-09T23:42:54.8560728Z +                            "startingheight": 0,
2025-11-09T23:42:54.8560889Z +                            "synced_headers": -1,
2025-11-09T23:42:54.8561048Z +                            "synced_blocks": -1,
2025-11-09T23:42:54.8561204Z +                            "inflight": [],
2025-11-09T23:42:54.8561422Z +                            "whitelisted": false,
2025-11-09T23:42:54.8561642Z +                            "minfeefilter": 0.00001000,
2025-11-09T23:42:54.8561891Z +                            "bytessent_per_msg": {},
2025-11-09T23:42:54.8562134Z +                            "bytesrecv_per_msg": {}
2025-11-09T23:42:54.8562525Z +                        })
2025-11-09T23:42:54.8562661Z +                    } else {
2025-11-09T23:42:54.8562798Z +                        json!({})
2025-11-09T23:42:54.8562915Z +                    }
2025-11-09T23:42:54.8563029Z +                })
2025-11-09T23:42:54.8563157Z +                .collect();
2025-11-09T23:42:54.8563277Z              Ok(json!(peers))
2025-11-09T23:42:54.8563382Z          } else {
2025-11-09T23:42:54.8563501Z              Ok(json!([]))
2025-11-09T23:42:54.8563927Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:164:
2025-11-09T23:42:54.8564123Z          if let Some(ref network) = self.network_manager {
2025-11-09T23:42:54.8564260Z              // Send ping to all peers
2025-11-09T23:42:54.8564634Z              if let Err(e) = network.ping_all_peers().await {
2025-11-09T23:42:54.8565022Z -                return Err(RpcError::internal_error(format!("Failed to ping peers: {}", e)));
2025-11-09T23:42:54.8565235Z +                return Err(RpcError::internal_error(format!(
2025-11-09T23:42:54.8565403Z +                    "Failed to ping peers: {}",
2025-11-09T23:42:54.8565518Z +                    e
2025-11-09T23:42:54.8565626Z +                )));
2025-11-09T23:42:54.8565786Z              }
2025-11-09T23:42:54.8565986Z              debug!("Sent ping to all connected peers");
2025-11-09T23:42:54.8566098Z          }
2025-11-09T23:42:54.8566515Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:205:
2025-11-09T23:42:54.8566633Z                  "onetry" => {
2025-11-09T23:42:54.8566782Z                      // Try to connect to node once
2025-11-09T23:42:54.8566988Z                      if let Err(e) = network.connect_to_peer(addr).await {
2025-11-09T23:42:54.8567368Z -                        return Err(RpcError::internal_error(format!("Failed to connect to {}: {}", addr, e)));
2025-11-09T23:42:54.8567578Z +                        return Err(RpcError::internal_error(format!(
2025-11-09T23:42:54.8567768Z +                            "Failed to connect to {}: {}",
2025-11-09T23:42:54.8567902Z +                            addr, e
2025-11-09T23:42:54.8568027Z +                        )));
2025-11-09T23:42:54.8568142Z                      }
2025-11-09T23:42:54.8568350Z                      debug!("Connected to node {} (onetry)", addr);
2025-11-09T23:42:54.8568482Z                      Ok(json!(null))
2025-11-09T23:42:54.8568930Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:310:
2025-11-09T23:42:54.8569103Z                  active_connection_limit_hits: 0,
2025-11-09T23:42:54.8569507Z                  resource_exhaustion_events: 0,
2025-11-09T23:42:54.8569623Z              };
2025-11-09T23:42:54.8569735Z -            
2025-11-09T23:42:54.8569857Z +
2025-11-09T23:42:54.8569980Z              Ok(json!({
2025-11-09T23:42:54.8570110Z                  "metrics": {
2025-11-09T23:42:54.8570431Z                      "connection_rate_violations": metrics.connection_rate_violations,
2025-11-09T23:42:54.8570883Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:365:
2025-11-09T23:42:54.8571038Z          let addr: SocketAddr = subnet
2025-11-09T23:42:54.8571162Z              .parse()
2025-11-09T23:42:54.8572180Z              .map_err(|_| RpcError::invalid_params(format!("Invalid address/subnet: {}", subnet)))?;
2025-11-09T23:42:54.8572303Z -        
2025-11-09T23:42:54.8572421Z +
2025-11-09T23:42:54.8572615Z          // Parse bantime (seconds) - 0 = permanent
2025-11-09T23:42:54.8573010Z          let bantime = params.get(2).and_then(|p| p.as_u64()).unwrap_or(86400); // Default 24 hours
2025-11-09T23:42:54.8573140Z -        
2025-11-09T23:42:54.8573257Z +
2025-11-09T23:42:54.8573573Z          // Parse absolute (whether bantime is absolute timestamp or relative)
2025-11-09T23:42:54.8573895Z          let absolute = params.get(3).and_then(|p| p.as_bool()).unwrap_or(false);
2025-11-09T23:42:54.8574015Z -        
2025-11-09T23:42:54.8577047Z +
2025-11-09T23:42:54.8577284Z          if let Some(ref network) = self.network_manager {
2025-11-09T23:42:54.8577490Z              use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:42:54.8577672Z              let now = SystemTime::now()
2025-11-09T23:42:54.8578139Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:378:
2025-11-09T23:42:54.8578309Z                  .duration_since(UNIX_EPOCH)
2025-11-09T23:42:54.8578450Z                  .unwrap()
2025-11-09T23:42:54.8578579Z                  .as_secs();
2025-11-09T23:42:54.8578704Z -            
2025-11-09T23:42:54.8578820Z +
2025-11-09T23:42:54.8579004Z              let unban_timestamp = if absolute {
2025-11-09T23:42:54.8579176Z                  bantime // Already a timestamp
2025-11-09T23:42:54.8579325Z              } else if bantime == 0 {
2025-11-09T23:42:54.8579802Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:386:
2025-11-09T23:42:54.8579929Z              } else {
2025-11-09T23:42:54.8580098Z                  now + bantime // Relative ban
2025-11-09T23:42:54.8580216Z              };
2025-11-09T23:42:54.8580341Z -            
2025-11-09T23:42:54.8580452Z +
2025-11-09T23:42:54.8580586Z              match command {
2025-11-09T23:42:54.8580713Z                  "add" => {
2025-11-09T23:42:54.8580907Z                      network.ban_peer(addr, unban_timestamp);
2025-11-09T23:42:54.8581353Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:422:
2025-11-09T23:42:54.8581465Z  
2025-11-09T23:42:54.8581694Z          if let Some(ref network) = self.network_manager {
2025-11-09T23:42:54.8581878Z              let banned = network.get_banned_peers();
2025-11-09T23:42:54.8582188Z -            let result: Vec<Value> = banned.iter().map(|(addr, unban_timestamp)| {
2025-11-09T23:42:54.8582323Z -                json!({
2025-11-09T23:42:54.8582487Z -                    "address": addr.to_string(),
2025-11-09T23:42:54.8582719Z -                    "banned_until": if *unban_timestamp == u64::MAX {
2025-11-09T23:42:54.8582923Z -                        serde_json::Value::Null // Permanent ban
2025-11-09T23:42:54.8583041Z -                    } else {
2025-11-09T23:42:54.8583259Z -                        serde_json::Value::Number((*unban_timestamp).into())
2025-11-09T23:42:54.8583368Z -                    },
2025-11-09T23:42:54.8583594Z -                    "banned_until_absolute": *unban_timestamp == u64::MAX
2025-11-09T23:42:54.8583738Z +            let result: Vec<Value> = banned
2025-11-09T23:42:54.8583849Z +                .iter()
2025-11-09T23:42:54.8584246Z +                .map(|(addr, unban_timestamp)| {
2025-11-09T23:42:54.8586409Z +                    json!({
2025-11-09T23:42:54.8586572Z +                        "address": addr.to_string(),
2025-11-09T23:42:54.8586780Z +                        "banned_until": if *unban_timestamp == u64::MAX {
2025-11-09T23:42:54.8586966Z +                            serde_json::Value::Null // Permanent ban
2025-11-09T23:42:54.8587089Z +                        } else {
2025-11-09T23:42:54.8587303Z +                            serde_json::Value::Number((*unban_timestamp).into())
2025-11-09T23:42:54.8587422Z +                        },
2025-11-09T23:42:54.8587639Z +                        "banned_until_absolute": *unban_timestamp == u64::MAX
2025-11-09T23:42:54.8587747Z +                    })
2025-11-09T23:42:54.8587857Z                  })
2025-11-09T23:42:54.8587970Z -            }).collect();
2025-11-09T23:42:54.8588083Z +                .collect();
2025-11-09T23:42:54.8588216Z              Ok(json!(result))
2025-11-09T23:42:54.8588329Z          } else {
2025-11-09T23:42:54.8588442Z              Ok(json!([]))
2025-11-09T23:42:54.8588891Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:445:
2025-11-09T23:42:54.8589250Z      pub async fn getaddednodeinfo(&self, params: &Value) -> RpcResult<Value> {
2025-11-09T23:42:54.8589410Z          debug!("RPC: getaddednodeinfo");
2025-11-09T23:42:54.8589783Z  
2025-11-09T23:42:54.8589943Z -        let node = params.get(0)
2025-11-09T23:42:54.8590085Z +        let node = params
2025-11-09T23:42:54.8590202Z +            .get(0)
2025-11-09T23:42:54.8590346Z              .and_then(|p| p.as_str())
2025-11-09T23:42:54.8590727Z              .ok_or_else(|| RpcError::invalid_params("Node address required".to_string()))?;
2025-11-09T23:42:54.8590843Z  
2025-11-09T23:42:54.8591302Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:453:
2025-11-09T23:42:54.8591487Z  
2025-11-09T23:42:54.8591711Z          if let Some(ref network) = self.network_manager {
2025-11-09T23:42:54.8591857Z              // Parse node address
2025-11-09T23:42:54.8592030Z -            let addr: SocketAddr = node.parse()
2025-11-09T23:42:54.8592191Z +            let addr: SocketAddr = node
2025-11-09T23:42:54.8592319Z +                .parse()
2025-11-09T23:42:54.8592696Z                  .map_err(|e| RpcError::invalid_params(format!("Invalid node address: {}", e)))?;
2025-11-09T23:42:54.8592823Z  
2025-11-09T23:42:54.8593012Z              // Check if node is in persistent peer list
2025-11-09T23:42:54.8593462Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:494:
2025-11-09T23:42:54.8593814Z      pub async fn getnodeaddresses(&self, params: &Value) -> RpcResult<Value> {
2025-11-09T23:42:54.8593992Z          debug!("RPC: getnodeaddresses");
2025-11-09T23:42:54.8594106Z  
2025-11-09T23:42:54.8595890Z -        let count = params.get(0)
2025-11-09T23:42:54.8596050Z -            .and_then(|p| p.as_u64())
2025-11-09T23:42:54.8596182Z -            .unwrap_or(1)
2025-11-09T23:42:54.8596341Z -            .min(100) as usize; // Limit to 100
2025-11-09T23:42:54.8596726Z +        let count = params.get(0).and_then(|p| p.as_u64()).unwrap_or(1).min(100) as usize; // Limit to 100
2025-11-09T23:42:54.8596826Z  
2025-11-09T23:42:54.8597012Z          if let Some(ref network) = self.network_manager {
2025-11-09T23:42:54.8597146Z              // Get peer addresses
2025-11-09T23:42:54.8597564Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:504:
2025-11-09T23:42:54.8597768Z              let peer_addrs = network.get_peer_addresses().await;
2025-11-09T23:42:54.8597874Z -            
2025-11-09T23:42:54.8597980Z +
2025-11-09T23:42:54.8598123Z              // Convert to node address format
2025-11-09T23:42:54.8598273Z              let mut addresses = Vec::new();
2025-11-09T23:42:54.8598474Z              for addr in peer_addrs.into_iter().take(count) {
2025-11-09T23:42:54.8599134Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:551:
2025-11-09T23:42:54.8599450Z      pub async fn setnetworkactive(&self, params: &Value) -> RpcResult<Value> {
2025-11-09T23:42:54.8599598Z          debug!("RPC: setnetworkactive");
2025-11-09T23:42:54.8599706Z  
2025-11-09T23:42:54.8599839Z -        let state = params.get(0)
2025-11-09T23:42:54.8599975Z -            .and_then(|p| p.as_bool())
2025-11-09T23:42:54.8600424Z -            .ok_or_else(|| RpcError::invalid_params("State parameter required (true/false)".to_string()))?;
2025-11-09T23:42:54.8600723Z +        let state = params.get(0).and_then(|p| p.as_bool()).ok_or_else(|| {
2025-11-09T23:42:54.8601107Z +            RpcError::invalid_params("State parameter required (true/false)".to_string())
2025-11-09T23:42:54.8601230Z +        })?;
2025-11-09T23:42:54.8601341Z  
2025-11-09T23:42:54.8601550Z          if let Some(ref network) = self.network_manager {
2025-11-09T23:42:54.8601731Z -            network.set_network_active(state).await
2025-11-09T23:42:54.8602156Z -                .map_err(|e| RpcError::internal_error(format!("Failed to set network active: {}", e)))?;
2025-11-09T23:42:54.8602405Z +            network.set_network_active(state).await.map_err(|e| {
2025-11-09T23:42:54.8602756Z +                RpcError::internal_error(format!("Failed to set network active: {}", e))
2025-11-09T23:42:54.8604504Z +            })?;
2025-11-09T23:42:54.8604883Z              Ok(json!(state))
2025-11-09T23:42:54.8605005Z          } else {
2025-11-09T23:42:54.8605364Z -            Err(RpcError::internal_error("Network manager not available".to_string()))
2025-11-09T23:42:54.8605542Z +            Err(RpcError::internal_error(
2025-11-09T23:42:54.8605735Z +                "Network manager not available".to_string(),
2025-11-09T23:42:54.8605851Z +            ))
2025-11-09T23:42:54.8606036Z          }
2025-11-09T23:42:54.8606152Z      }
2025-11-09T23:42:54.8606262Z  }
2025-11-09T23:42:54.8648428Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:68:
2025-11-09T23:42:54.8648663Z          let tx_bytes = hex::decode(hex_string)
2025-11-09T23:42:54.8649037Z              .map_err(|e| RpcError::invalid_params(format!("Invalid hex string: {}", e)))?;
2025-11-09T23:42:54.8649225Z  
2025-11-09T23:42:54.8649649Z -        if let (Some(ref storage), Some(ref mempool)) = (self.storage.as_ref(), self.mempool.as_ref()) {
2025-11-09T23:42:54.8650433Z +        if let (Some(ref storage), Some(ref mempool)) =
2025-11-09T23:42:54.8651019Z +            (self.storage.as_ref(), self.mempool.as_ref())
2025-11-09T23:42:54.8651182Z +        {
2025-11-09T23:42:54.8651656Z              use bllvm_protocol::serialization::transaction::deserialize_transaction;
2025-11-09T23:42:54.8651907Z -            let tx = deserialize_transaction(&tx_bytes)
2025-11-09T23:42:54.8652304Z -                .map_err(|e| RpcError::invalid_params(format!("Failed to parse transaction: {}", e)))?;
2025-11-09T23:42:54.8652426Z -            
2025-11-09T23:42:54.8652696Z +            let tx = deserialize_transaction(&tx_bytes).map_err(|e| {
2025-11-09T23:42:54.8653042Z +                RpcError::invalid_params(format!("Failed to parse transaction: {}", e))
2025-11-09T23:42:54.8653158Z +            })?;
2025-11-09T23:42:54.8653278Z +
2025-11-09T23:42:54.8653491Z              use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:42:54.8653656Z              let txid = calculate_tx_id(&tx);
2025-11-09T23:42:54.8653779Z -            
2025-11-09T23:42:54.8653898Z +
2025-11-09T23:42:54.8654799Z              // Check if already in mempool
2025-11-09T23:42:54.8655030Z              if mempool.get_transaction(&txid).is_some() {
2025-11-09T23:42:54.8655395Z                  return Err(RpcError::invalid_params("Transaction already in mempool"));
2025-11-09T23:42:54.8655832Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:82:
2025-11-09T23:42:54.8655949Z              }
2025-11-09T23:42:54.8656064Z -            
2025-11-09T23:42:54.8656439Z +
2025-11-09T23:42:54.8656587Z              // Check if in chain
2025-11-09T23:42:54.8656915Z -            if storage.transactions().has_transaction(&txid).unwrap_or(false) {
2025-11-09T23:42:54.8657057Z +            if storage
2025-11-09T23:42:54.8657193Z +                .transactions()
2025-11-09T23:42:54.8657344Z +                .has_transaction(&txid)
2025-11-09T23:42:54.8657485Z +                .unwrap_or(false)
2025-11-09T23:42:54.8657622Z +            {
2025-11-09T23:42:54.8657966Z                  return Err(RpcError::invalid_params("Transaction already in chain"));
2025-11-09T23:42:54.8658083Z              }
2025-11-09T23:42:54.8658209Z -            
2025-11-09T23:42:54.8658319Z +
2025-11-09T23:42:54.8658518Z              // Validate transaction using consensus layer
2025-11-09T23:42:54.8658732Z -            let _timer = self.profiler.as_ref().map(|p| {
2025-11-09T23:42:54.8659072Z -                PerformanceTimer::start(Arc::clone(p), OperationType::TxValidation)
2025-11-09T23:42:54.8659190Z -            });
2025-11-09T23:42:54.8659317Z +            let _timer = self
2025-11-09T23:42:54.8659450Z +                .profiler
2025-11-09T23:42:54.8659575Z +                .as_ref()
2025-11-09T23:42:54.8659961Z +                .map(|p| PerformanceTimer::start(Arc::clone(p), OperationType::TxValidation));
2025-11-09T23:42:54.8660152Z              let validation_start = Instant::now();
2025-11-09T23:42:54.8660643Z              use bllvm_protocol::ConsensusProof;
2025-11-09T23:42:54.8660834Z              let consensus = ConsensusProof::new();
2025-11-09T23:42:54.8661260Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:97:
2025-11-09T23:42:54.8661478Z                  Ok(bllvm_protocol::ValidationResult::Valid) => {
2025-11-09T23:42:54.8661695Z                      let validation_time = validation_start.elapsed();
2025-11-09T23:42:54.8661891Z                      // Timer will record duration when dropped
2025-11-09T23:42:54.8662017Z -                    
2025-11-09T23:42:54.8662141Z +
2025-11-09T23:42:54.8662279Z                      // Update metrics
2025-11-09T23:42:54.8662458Z                      if let Some(ref metrics) = self.metrics {
2025-11-09T23:42:54.8662625Z                          metrics.update_performance(|m| {
2025-11-09T23:42:54.8663032Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:104:
2025-11-09T23:42:54.8663249Z                              let time_ms = validation_time.as_secs_f64() * 1000.0;
2025-11-09T23:42:54.8663589Z                              // Update average transaction validation time (exponential moving average)
2025-11-09T23:42:54.8663746Z -                            m.avg_tx_validation_time_ms = 
2025-11-09T23:42:54.8663900Z +                            m.avg_tx_validation_time_ms =
2025-11-09T23:42:54.8664118Z                                  (m.avg_tx_validation_time_ms * 0.9) + (time_ms * 0.1);
2025-11-09T23:42:54.8664278Z                              // Update transactions per second
2025-11-09T23:42:54.8664706Z                              if validation_time.as_secs_f64() > 0.0 {
2025-11-09T23:42:54.8665134Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:111:
2025-11-09T23:42:54.8665250Z                              }
2025-11-09T23:42:54.8665363Z                          });
2025-11-09T23:42:54.8666939Z                      }
2025-11-09T23:42:54.8667046Z -                    
2025-11-09T23:42:54.8667155Z +
2025-11-09T23:42:54.8667446Z                      // Transaction structure is valid, now check inputs against UTXO set
2025-11-09T23:42:54.8667638Z -                    let utxo_set = storage.utxos().get_all_utxos()
2025-11-09T23:42:54.8667991Z -                        .map_err(|e| RpcError::internal_error(format!("Failed to get UTXO set: {}", e)))?;
2025-11-09T23:42:54.8668097Z -                    
2025-11-09T23:42:54.8668339Z +                    let utxo_set = storage.utxos().get_all_utxos().map_err(|e| {
2025-11-09T23:42:54.8668890Z +                        RpcError::internal_error(format!("Failed to get UTXO set: {}", e))
2025-11-09T23:42:54.8669023Z +                    })?;
2025-11-09T23:42:54.8669145Z +
2025-11-09T23:42:54.8669329Z                      // Check if all inputs exist in UTXO set
2025-11-09T23:42:54.8669492Z                      for input in &tx.inputs {
2025-11-09T23:42:54.8669704Z                          if !utxo_set.contains_key(&input.prevout) {
2025-11-09T23:42:54.8670181Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:126:
2025-11-09T23:42:54.8670311Z                              )));
2025-11-09T23:42:54.8670434Z                          }
2025-11-09T23:42:54.8670552Z                      }
2025-11-09T23:42:54.8670657Z -                    
2025-11-09T23:42:54.8670757Z +
2025-11-09T23:42:54.8670885Z                      // Add to mempool
2025-11-09T23:42:54.8671223Z                      // Note: add_transaction requires &mut self, but we have Arc<MempoolManager>
2025-11-09T23:42:54.8671733Z                      // In production, this would need to use interior mutability (Mutex/RwLock)
2025-11-09T23:42:54.8672171Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:133:
2025-11-09T23:42:54.8672444Z                      // For now, we'll skip adding to mempool as it requires mutable access
2025-11-09T23:42:54.8672860Z -                    debug!("Transaction validated but not added to mempool (requires mutable access)");
2025-11-09T23:42:54.8673223Z +                    debug!(
2025-11-09T23:42:54.8673586Z +                        "Transaction validated but not added to mempool (requires mutable access)"
2025-11-09T23:42:54.8673702Z +                    );
2025-11-09T23:42:54.8673824Z                  }
2025-11-09T23:42:54.8674101Z                  Ok(bllvm_protocol::ValidationResult::Invalid(reason)) => {
2025-11-09T23:42:54.8674694Z -                    return Err(RpcError::invalid_params(format!("Transaction validation failed: {}", reason)));
2025-11-09T23:42:54.8674914Z +                    return Err(RpcError::invalid_params(format!(
2025-11-09T23:42:54.8675098Z +                        "Transaction validation failed: {}",
2025-11-09T23:42:54.8675228Z +                        reason
2025-11-09T23:42:54.8675356Z +                    )));
2025-11-09T23:42:54.8675473Z                  }
2025-11-09T23:42:54.8675603Z                  Err(e) => {
2025-11-09T23:42:54.8676033Z -                    return Err(RpcError::internal_error(format!("Transaction validation error: {}", e)));
2025-11-09T23:42:54.8676258Z +                    return Err(RpcError::internal_error(format!(
2025-11-09T23:42:54.8676440Z +                        "Transaction validation error: {}",
2025-11-09T23:42:54.8676569Z +                        e
2025-11-09T23:42:54.8676694Z +                    )));
2025-11-09T23:42:54.8676812Z                  }
2025-11-09T23:42:54.8676927Z              }
2025-11-09T23:42:54.8677043Z -            
2025-11-09T23:42:54.8677160Z +
2025-11-09T23:42:54.8677335Z              Ok(json!(hex::encode(txid)))
2025-11-09T23:42:54.8677455Z          } else {
2025-11-09T23:42:54.8677806Z -            Err(RpcError::invalid_params("RPC not initialized with dependencies"))
2025-11-09T23:42:54.8677980Z +            Err(RpcError::invalid_params(
2025-11-09T23:42:54.8678174Z +                "RPC not initialized with dependencies",
2025-11-09T23:42:54.8678297Z +            ))
2025-11-09T23:42:54.8678415Z          }
2025-11-09T23:42:54.8678527Z      }
2025-11-09T23:42:54.8678641Z  
2025-11-09T23:42:54.8679101Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:175:
2025-11-09T23:42:54.8679301Z          let consensus = ConsensusProof::new();
2025-11-09T23:42:54.8679587Z          let validation_result = consensus.validate_transaction(&tx);
2025-11-09T23:42:54.8679712Z  
2025-11-09T23:42:54.8680130Z -        let allowed = matches!(validation_result, Ok(bllvm_protocol::ValidationResult::Valid));
2025-11-09T23:42:54.8680282Z +        let allowed = matches!(
2025-11-09T23:42:54.8680733Z +            validation_result,
2025-11-09T23:42:54.8680951Z +            Ok(bllvm_protocol::ValidationResult::Valid)
2025-11-09T23:42:54.8681069Z +        );
2025-11-09T23:42:54.8681232Z          let reject_reason = if !allowed {
2025-11-09T23:42:54.8681395Z              match validation_result {
2025-11-09T23:42:54.8681739Z                  Ok(bllvm_protocol::ValidationResult::Invalid(reason)) => Some(reason),
2025-11-09T23:42:54.8682191Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:232:
2025-11-09T23:42:54.8682561Z          use bllvm_protocol::serialization::transaction::deserialize_transaction;
2025-11-09T23:42:54.8682754Z          let tx = deserialize_transaction(&tx_bytes)
2025-11-09T23:42:54.8683161Z              .map_err(|e| RpcError::invalid_params(format!("Failed to parse transaction: {}", e)))?;
2025-11-09T23:42:54.8683287Z -        
2025-11-09T23:42:54.8683396Z +
2025-11-09T23:42:54.8683600Z          use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:42:54.8683766Z          let txid = calculate_tx_id(&tx);
2025-11-09T23:42:54.8683942Z          let txid_hex = hex::encode(txid);
2025-11-09T23:42:54.8684571Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:239:
2025-11-09T23:42:54.8684739Z          let size = tx_bytes.len();
2025-11-09T23:42:54.8684863Z -        
2025-11-09T23:42:54.8684973Z +
2025-11-09T23:42:54.8685350Z          Ok(json!({
2025-11-09T23:42:54.8685500Z              "txid": txid_hex.clone(),
2025-11-09T23:42:54.8685642Z              "hash": txid_hex,
2025-11-09T23:42:54.8686095Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:295:
2025-11-09T23:42:54.8686416Z              if let Ok(Some(tx)) = storage.transactions().get_transaction(&txid_array) {
2025-11-09T23:42:54.8686779Z                  use bllvm_protocol::serialization::transaction::serialize_transaction;
2025-11-09T23:42:54.8687018Z                  let tx_hex = hex::encode(serialize_transaction(&tx));
2025-11-09T23:42:54.8687150Z -                
2025-11-09T23:42:54.8687270Z +
2025-11-09T23:42:54.8687407Z                  if verbose {
2025-11-09T23:42:54.8687630Z                      use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:42:54.8687826Z                      let calculated_txid = calculate_tx_id(&tx);
2025-11-09T23:42:54.8688290Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:417:
2025-11-09T23:42:54.8688550Z              if let Ok(Some(utxo)) = storage.utxos().get_utxo(&outpoint) {
2025-11-09T23:42:54.8688860Z                  let best_hash = storage.chain().get_tip_hash()?.unwrap_or([0u8; 32]);
2025-11-09T23:42:54.8689125Z                  let tip_height = storage.chain().get_height()?.unwrap_or(0);
2025-11-09T23:42:54.8689244Z -                
2025-11-09T23:42:54.8689357Z +
2025-11-09T23:42:54.8689579Z                  // Find block height containing this transaction
2025-11-09T23:42:54.8689756Z                  let mut tx_height: Option<u64> = None;
2025-11-09T23:42:54.8689911Z                  for h in 0..=tip_height {
2025-11-09T23:42:54.8690355Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:437:
2025-11-09T23:42:54.8690490Z                          }
2025-11-09T23:42:54.8690606Z                      }
2025-11-09T23:42:54.8690719Z                  }
2025-11-09T23:42:54.8690839Z -                
2025-11-09T23:42:54.8690960Z +
2025-11-09T23:42:54.8691194Z                  let confirmations = tx_height
2025-11-09T23:42:54.8691324Z                      .map(|h| {
2025-11-09T23:42:54.8691478Z                          if h > tip_height {
2025-11-09T23:42:54.8691912Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:447:
2025-11-09T23:42:54.8692031Z                          }
2025-11-09T23:42:54.8692155Z                      })
2025-11-09T23:42:54.8692293Z                      .unwrap_or(0);
2025-11-09T23:42:54.8692408Z -                
2025-11-09T23:42:54.8692739Z +
2025-11-09T23:42:54.8692871Z                  Ok(json!({
2025-11-09T23:42:54.8693060Z                      "bestblock": hex::encode(best_hash),
2025-11-09T23:42:54.8693232Z                      "confirmations": confirmations,
2025-11-09T23:42:54.8693670Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:470:
2025-11-09T23:42:54.8693787Z      }
2025-11-09T23:42:54.8693907Z  
2025-11-09T23:42:54.8694122Z      /// Build merkle proof for transactions in a block
2025-11-09T23:42:54.8694945Z -    fn build_merkle_proof(transactions: &[bllvm_protocol::Transaction], tx_indices: &[usize]) -> Result<Vec<[u8; 32]>, RpcError> {
2025-11-09T23:42:54.8695171Z -        use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:42:54.8695319Z +    fn build_merkle_proof(
2025-11-09T23:42:54.8695529Z +        transactions: &[bllvm_protocol::Transaction],
2025-11-09T23:42:54.8695672Z +        tx_indices: &[usize],
2025-11-09T23:42:54.8695830Z +    ) -> Result<Vec<[u8; 32]>, RpcError> {
2025-11-09T23:42:54.8696040Z          use crate::storage::hashing::double_sha256;
2025-11-09T23:42:54.8696229Z +        use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:42:54.8696339Z  
2025-11-09T23:42:54.8696497Z          if transactions.is_empty() {
2025-11-09T23:42:54.8696891Z -            return Err(RpcError::internal_error("Block has no transactions".to_string()));
2025-11-09T23:42:54.8697302Z +            return Err(RpcError::internal_error(
2025-11-09T23:42:54.8697491Z +                "Block has no transactions".to_string(),
2025-11-09T23:42:54.8697613Z +            ));
2025-11-09T23:42:54.8697727Z          }
2025-11-09T23:42:54.8697829Z  
2025-11-09T23:42:54.8698000Z          // Calculate all transaction hashes
2025-11-09T23:42:54.8698450Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:482:
2025-11-09T23:42:54.8698673Z -        let mut tx_hashes: Vec<[u8; 32]> = transactions.iter()
2025-11-09T23:42:54.8698831Z -            .map(|tx| calculate_tx_id(tx))
2025-11-09T23:42:54.8698977Z -            .collect();
2025-11-09T23:42:54.8699138Z +        let mut tx_hashes: Vec<[u8; 32]> =
2025-11-09T23:42:54.8699421Z +            transactions.iter().map(|tx| calculate_tx_id(tx)).collect();
2025-11-09T23:42:54.8699541Z  
2025-11-09T23:42:54.8699699Z          let mut proof = Vec::new();
2025-11-09T23:42:54.8699879Z          let mut current_level = tx_hashes.clone();
2025-11-09T23:42:54.8700321Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:501:
2025-11-09T23:42:54.8700519Z                      combined.extend_from_slice(&chunk[1]);
2025-11-09T23:42:54.8700717Z                      let parent_hash = double_sha256(&combined);
2025-11-09T23:42:54.8700881Z                      next_level.push(parent_hash);
2025-11-09T23:42:54.8701003Z -                    
2025-11-09T23:42:54.8701114Z +
2025-11-09T23:42:54.8701299Z                      // Check if we need to add sibling to proof
2025-11-09T23:42:54.8701458Z                      if !proof_added {
2025-11-09T23:42:54.8701609Z                          for &idx in tx_indices {
2025-11-09T23:42:54.8702044Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:581:
2025-11-09T23:42:54.8702216Z                              for tx in &b.transactions {
2025-11-09T23:42:54.8702387Z                                  let txid = calculate_tx_id(tx);
2025-11-09T23:42:54.8702584Z                                  let txid_hex = hex::encode(txid);
2025-11-09T23:42:54.8702888Z -                                if txids.iter().any(|tid| tid.as_str() == Some(txid_hex.as_str())) {
2025-11-09T23:42:54.8703034Z +                                if txids
2025-11-09T23:42:54.8703170Z +                                    .iter()
2025-11-09T23:42:54.8703393Z +                                    .any(|tid| tid.as_str() == Some(txid_hex.as_str()))
2025-11-09T23:42:54.8703530Z +                                {
2025-11-09T23:42:54.8703683Z                                      block = Some(b);
2025-11-09T23:42:54.8704030Z                                      break;
2025-11-09T23:42:54.8704159Z                                  }
2025-11-09T23:42:54.8704803Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:601:
2025-11-09T23:42:54.8705057Z                  for (idx, tx) in block.transactions.iter().enumerate() {
2025-11-09T23:42:54.8705231Z                      let txid = calculate_tx_id(tx);
2025-11-09T23:42:54.8705428Z                      let txid_hex = hex::encode(txid);
2025-11-09T23:42:54.8706616Z -                    if txids.iter().any(|tid| tid.as_str() == Some(txid_hex.as_str())) {
2025-11-09T23:42:54.8706776Z +                    if txids
2025-11-09T23:42:54.8706921Z +                        .iter()
2025-11-09T23:42:54.8707135Z +                        .any(|tid| tid.as_str() == Some(txid_hex.as_str()))
2025-11-09T23:42:54.8707249Z +                    {
2025-11-09T23:42:54.8707409Z                          tx_indices.push(idx);
2025-11-09T23:42:54.8707546Z                      }
2025-11-09T23:42:54.8707660Z                  }
2025-11-09T23:42:54.8708096Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:608:
2025-11-09T23:42:54.8708221Z  
2025-11-09T23:42:54.8708378Z                  if tx_indices.is_empty() {
2025-11-09T23:42:54.8708830Z -                    return Err(RpcError::invalid_params("None of the specified transactions found in block"));
2025-11-09T23:42:54.8709279Z +                    return Err(RpcError::invalid_params(
2025-11-09T23:42:54.8709508Z +                        "None of the specified transactions found in block",
2025-11-09T23:42:54.8709632Z +                    ));
2025-11-09T23:42:54.8709751Z                  }
2025-11-09T23:42:54.8709873Z  
2025-11-09T23:42:54.8710022Z                  // Build merkle proof
2025-11-09T23:42:54.8710460Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:614:
2025-11-09T23:42:54.8710836Z                  let proof_hashes = Self::build_merkle_proof(&block.transactions, &tx_indices)
2025-11-09T23:42:54.8711257Z -                    .map_err(|e| RpcError::internal_error(format!("Failed to build merkle proof: {}", e)))?;
2025-11-09T23:42:54.8711402Z +                    .map_err(|e| {
2025-11-09T23:42:54.8711763Z +                        RpcError::internal_error(format!("Failed to build merkle proof: {}", e))
2025-11-09T23:42:54.8711897Z +                    })?;
2025-11-09T23:42:54.8712013Z  
2025-11-09T23:42:54.8712350Z                  // Serialize proof (simplified - Bitcoin Core uses a more complex format)
2025-11-09T23:42:54.8712537Z                  let mut proof_bytes = Vec::new();
2025-11-09T23:42:54.8712970Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:626:
2025-11-09T23:42:54.8713190Z                  Err(RpcError::invalid_params("Block not found"))
2025-11-09T23:42:54.8713311Z              }
2025-11-09T23:42:54.8713426Z          } else {
2025-11-09T23:42:54.8714762Z -            Err(RpcError::invalid_params("RPC not initialized with dependencies"))
2025-11-09T23:42:54.8714968Z +            Err(RpcError::invalid_params(
2025-11-09T23:42:54.8715162Z +                "RPC not initialized with dependencies",
2025-11-09T23:42:54.8715282Z +            ))
2025-11-09T23:42:54.8715395Z          }
2025-11-09T23:42:54.8715513Z      }
2025-11-09T23:42:54.8715623Z  
2025-11-09T23:42:54.8716084Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:650:
2025-11-09T23:42:54.8716232Z              // Decode proof
2025-11-09T23:42:54.8716433Z              let proof_bytes = hex::decode(proof_hex)
2025-11-09T23:42:54.8716784Z                  .map_err(|e| RpcError::invalid_params(format!("Invalid proof hex: {}", e)))?;
2025-11-09T23:42:54.8716904Z -            
2025-11-09T23:42:54.8717024Z +
2025-11-09T23:42:54.8717184Z              if proof_bytes.is_empty() {
2025-11-09T23:42:54.8717428Z                  return Err(RpcError::invalid_params("Empty proof"));
2025-11-09T23:42:54.8717802Z              }
2025-11-09T23:42:54.8718245Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:681:
2025-11-09T23:42:54.8718547Z              if let Ok(Some(block)) = storage.blocks().get_block(&blockhash_array) {
2025-11-09T23:42:54.8718733Z                  // Calculate merkle root from block
2025-11-09T23:42:54.8718966Z                  use bllvm_protocol::mining::calculate_merkle_root;
2025-11-09T23:42:54.8719278Z -                let calculated_root = calculate_merkle_root(&block.transactions)
2025-11-09T23:42:54.8719721Z -                    .map_err(|e| RpcError::internal_error(format!("Failed to calculate merkle root: {}", e)))?;
2025-11-09T23:42:54.8720104Z +                let calculated_root = calculate_merkle_root(&block.transactions).map_err(|e| {
2025-11-09T23:42:54.8720464Z +                    RpcError::internal_error(format!("Failed to calculate merkle root: {}", e))
2025-11-09T23:42:54.8720577Z +                })?;
2025-11-09T23:42:54.8720695Z  
2025-11-09T23:42:54.8721046Z                  // Verify proof by reconstructing root (simplified - would need txids from proof)
2025-11-09T23:42:54.8721291Z                  // For now, just verify the block's merkle root matches the header
2025-11-09T23:42:54.8721684Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:690:
2025-11-09T23:42:54.8721783Z  
2025-11-09T23:42:54.8722372Z                  // Extract transaction IDs from proof (simplified - full implementation would decode txids)
2025-11-09T23:42:54.8722570Z                  use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:42:54.8722773Z -                let txids: Vec<String> = block.transactions.iter()
2025-11-09T23:42:54.8722920Z +                let txids: Vec<String> = block
2025-11-09T23:42:54.8723045Z +                    .transactions
2025-11-09T23:42:54.8723164Z +                    .iter()
2025-11-09T23:42:54.8723343Z                      .map(|tx| hex::encode(calculate_tx_id(tx)))
2025-11-09T23:42:54.8723469Z                      .collect();
2025-11-09T23:42:54.8723575Z  
2025-11-09T23:42:54.8723959Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:703:
2025-11-09T23:42:54.8724151Z                  Err(RpcError::invalid_params("Block not found"))
2025-11-09T23:42:54.8724260Z              }
2025-11-09T23:42:54.8724545Z          } else {
2025-11-09T23:42:54.8724855Z -            Err(RpcError::invalid_params("RPC not initialized with dependencies"))
2025-11-09T23:42:54.8725001Z +            Err(RpcError::invalid_params(
2025-11-09T23:42:54.8725175Z +                "RPC not initialized with dependencies",
2025-11-09T23:42:54.8725278Z +            ))
2025-11-09T23:42:54.8725379Z          }
2025-11-09T23:42:54.8725485Z      }
2025-11-09T23:42:54.8725585Z  }
2025-11-09T23:42:54.8776644Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:54:
2025-11-09T23:42:54.8776897Z      }
2025-11-09T23:42:54.8777025Z  
2025-11-09T23:42:54.8777314Z      /// Create a new RPC server with authentication
2025-11-09T23:42:54.8777454Z -    pub fn with_auth(
2025-11-09T23:42:54.8777591Z -        addr: SocketAddr,
2025-11-09T23:42:54.8777792Z -        auth_manager: Arc<auth::RpcAuthManager>,
2025-11-09T23:42:54.8777924Z -    ) -> Self {
2025-11-09T23:42:54.8778333Z +    pub fn with_auth(addr: SocketAddr, auth_manager: Arc<auth::RpcAuthManager>) -> Self {
2025-11-09T23:42:54.8778463Z          Self {
2025-11-09T23:42:54.8778591Z              addr,
2025-11-09T23:42:54.8778844Z              blockchain: Arc::new(blockchain::BlockchainRpc::new()),
2025-11-09T23:42:54.8779301Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:134:
2025-11-09T23:42:54.8779483Z              control: Arc::clone(&self.control),
2025-11-09T23:42:54.8779666Z              auth_manager: self.auth_manager.clone(),
2025-11-09T23:42:54.8779781Z          });
2025-11-09T23:42:54.8779892Z -        
2025-11-09T23:42:54.8780271Z +
2025-11-09T23:42:54.8780391Z          loop {
2025-11-09T23:42:54.8780550Z              match listener.accept().await {
2025-11-09T23:42:54.8780712Z                  Ok((stream, addr)) => {
2025-11-09T23:42:54.8781153Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:141:
2025-11-09T23:42:54.8781347Z                      debug!("New RPC connection from {}", addr);
2025-11-09T23:42:54.8781507Z                      let peer_addr = addr;
2025-11-09T23:42:54.8781692Z                      let server = Arc::clone(&server);
2025-11-09T23:42:54.8781812Z -                    
2025-11-09T23:42:54.8781922Z +
2025-11-09T23:42:54.8782098Z                      // Spawn task to handle connection
2025-11-09T23:42:54.8782259Z                      tokio::spawn(async move {
2025-11-09T23:42:54.8782574Z                          // Use hyper for HTTP - it will handle protocol detection and parsing
2025-11-09T23:42:54.8783011Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:148:
2025-11-09T23:42:54.8783179Z                          let io = TokioIo::new(stream);
2025-11-09T23:42:54.8783349Z                          let service = service_fn(move |req| {
2025-11-09T23:42:54.8783702Z -                            Self::handle_http_request_with_server(Arc::clone(&server), req, peer_addr)
2025-11-09T23:42:54.8783904Z +                            Self::handle_http_request_with_server(
2025-11-09T23:42:54.8784266Z +                                Arc::clone(&server),
2025-11-09T23:42:54.8784571Z +                                req,
2025-11-09T23:42:54.8784721Z +                                peer_addr,
2025-11-09T23:42:54.8784842Z +                            )
2025-11-09T23:42:54.8784957Z                          });
2025-11-09T23:42:54.8785077Z -                        
2025-11-09T23:42:54.8785180Z +
2025-11-09T23:42:54.8785321Z                          // Try to serve as HTTP
2025-11-09T23:42:54.8785504Z -                        if let Err(e) = http1::Builder::new()
2025-11-09T23:42:54.8785678Z -                            .serve_connection(io, service)
2025-11-09T23:42:54.8785796Z -                            .await
2025-11-09T23:42:54.8785922Z -                        {
2025-11-09T23:42:54.8786253Z +                        if let Err(e) = http1::Builder::new().serve_connection(io, service).await {
2025-11-09T23:42:54.8786444Z                              // If hyper fails, it might be raw TCP
2025-11-09T23:42:54.8786732Z                              // But we can't recover here since hyper consumed the connection
2025-11-09T23:42:54.8787065Z                              // For now, log and continue - raw TCP support would need separate port
2025-11-09T23:42:54.8787537Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:161:
2025-11-09T23:42:54.8787924Z -                            debug!("HTTP connection failed from {} (might be raw TCP): {}", peer_addr, e);
2025-11-09T23:42:54.8788064Z +                            debug!(
2025-11-09T23:42:54.8788333Z +                                "HTTP connection failed from {} (might be raw TCP): {}",
2025-11-09T23:42:54.8788487Z +                                peer_addr, e
2025-11-09T23:42:54.8788619Z +                            );
2025-11-09T23:42:54.8788742Z                          }
2025-11-09T23:42:54.8788860Z                      });
2025-11-09T23:42:54.8788977Z                  }
2025-11-09T23:42:54.8789444Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:185:
2025-11-09T23:42:54.8789556Z  
2025-11-09T23:42:54.8789760Z          // Extract headers before consuming request body
2025-11-09T23:42:54.8789931Z          let headers = req.headers().clone();
2025-11-09T23:42:54.8790046Z -        
2025-11-09T23:42:54.8790159Z +
2025-11-09T23:42:54.8790300Z          // Check Content-Type
2025-11-09T23:42:54.8790557Z          if let Some(content_type) = headers.get("content-type") {
2025-11-09T23:42:54.8790739Z              if content_type != "application/json" {
2025-11-09T23:42:54.8791462Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:196:
2025-11-09T23:42:54.8791649Z          // Read request body with size limit
2025-11-09T23:42:54.8791809Z          let body = req.collect().await?;
2025-11-09T23:42:54.8791970Z          let body_bytes = body.to_bytes();
2025-11-09T23:42:54.8792091Z -        
2025-11-09T23:42:54.8792200Z +
2025-11-09T23:42:54.8792362Z          // Enforce maximum request size
2025-11-09T23:42:54.8792538Z          if body_bytes.len() > MAX_REQUEST_SIZE {
2025-11-09T23:42:54.8792728Z              return Ok(Self::http_error_response(
2025-11-09T23:42:54.8793184Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:203:
2025-11-09T23:42:54.8793367Z                  StatusCode::PAYLOAD_TOO_LARGE,
2025-11-09T23:42:54.8793803Z -                &format!("Request body too large: {} bytes (max: {} bytes)", body_bytes.len(), MAX_REQUEST_SIZE),
2025-11-09T23:42:54.8793938Z +                &format!(
2025-11-09T23:42:54.8794171Z +                    "Request body too large: {} bytes (max: {} bytes)",
2025-11-09T23:42:54.8794529Z +                    body_bytes.len(),
2025-11-09T23:42:54.8794690Z +                    MAX_REQUEST_SIZE
2025-11-09T23:42:54.8794811Z +                ),
2025-11-09T23:42:54.8794922Z              ));
2025-11-09T23:42:54.8795039Z          }
2025-11-09T23:42:54.8795152Z  
2025-11-09T23:42:54.8796503Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:221:
2025-11-09T23:42:54.8796744Z          // Authenticate request if authentication is enabled
2025-11-09T23:42:54.8796966Z          if let Some(ref auth_manager) = server.auth_manager {
2025-11-09T23:42:54.8797320Z              let auth_result = auth_manager.authenticate_request(&headers, addr).await;
2025-11-09T23:42:54.8797442Z -            
2025-11-09T23:42:54.8797562Z +
2025-11-09T23:42:54.8797731Z              // Check if authentication failed
2025-11-09T23:42:54.8797922Z              if let Some(error) = auth_result.error {
2025-11-09T23:42:54.8798115Z -                return Ok(Self::http_error_response(
2025-11-09T23:42:54.8798280Z -                    StatusCode::UNAUTHORIZED,
2025-11-09T23:42:54.8798407Z -                    &error,
2025-11-09T23:42:54.8798522Z -                ));
2025-11-09T23:42:54.8798855Z +                return Ok(Self::http_error_response(StatusCode::UNAUTHORIZED, &error));
2025-11-09T23:42:54.8798981Z              }
2025-11-09T23:42:54.8799092Z  
2025-11-09T23:42:54.8799240Z              // Check rate limiting
2025-11-09T23:42:54.8799673Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:243:
2025-11-09T23:42:54.8799787Z  
2025-11-09T23:42:54.8800130Z          // Process JSON-RPC request (reuse server instance with cached handlers)
2025-11-09T23:42:54.8800483Z          let response = Self::process_request_with_server(server, &json_body).await;
2025-11-09T23:42:54.8800628Z -        let response_json =
2025-11-09T23:42:54.8800959Z -            serde_json::to_string(&response).unwrap_or_else(|_| "{}".to_string());
2025-11-09T23:42:54.8801388Z +        let response_json = serde_json::to_string(&response).unwrap_or_else(|_| "{}".to_string());
2025-11-09T23:42:54.8801504Z  
2025-11-09T23:42:54.8801648Z          // Build HTTP response
2025-11-09T23:42:54.8801803Z          Ok(Response::builder()
2025-11-09T23:42:54.8802248Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:255:
2025-11-09T23:42:54.8802383Z              .unwrap())
2025-11-09T23:42:54.8802503Z      }
2025-11-09T23:42:54.8802615Z  
2025-11-09T23:42:54.8802723Z -
2025-11-09T23:42:54.8802876Z      /// Create HTTP error response
2025-11-09T23:42:54.8803283Z      fn http_error_response(status: StatusCode, message: &str) -> Response<Full<Bytes>> {
2025-11-09T23:42:54.8803418Z          let body = json!({
2025-11-09T23:42:54.8803858Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:321:
2025-11-09T23:42:54.8804655Z      async fn call_method(&self, method: &str, params: Value) -> Result<Value, errors::RpcError> {
2025-11-09T23:42:54.8804795Z          match method {
2025-11-09T23:42:54.8804938Z              // Blockchain methods
2025-11-09T23:42:54.8805094Z -            "getblockchaininfo" => {
2025-11-09T23:42:54.8805245Z -                self.blockchain
2025-11-09T23:42:54.8805401Z -                    .get_blockchain_info()
2025-11-09T23:42:54.8805533Z -                    .await
2025-11-09T23:42:54.8805824Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:42:54.8805942Z -            }
2025-11-09T23:42:54.8806119Z +            "getblockchaininfo" => self
2025-11-09T23:42:54.8806251Z +                .blockchain
2025-11-09T23:42:54.8806401Z +                .get_blockchain_info()
2025-11-09T23:42:54.8808542Z +                .await
2025-11-09T23:42:54.8808807Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:42:54.8808952Z              "getblock" => {
2025-11-09T23:42:54.8809233Z                  let hash = params.get(0).and_then(|p| p.as_str()).unwrap_or("");
2025-11-09T23:42:54.8809382Z                  self.blockchain
2025-11-09T23:42:54.8809809Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:349:
2025-11-09T23:42:54.8809930Z                      .await
2025-11-09T23:42:54.8810209Z                      .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:42:54.8821484Z              }
2025-11-09T23:42:54.8821707Z -            "getbestblockhash" => {
2025-11-09T23:42:54.8821854Z -                self.blockchain
2025-11-09T23:42:54.8822017Z -                    .get_best_block_hash()
2025-11-09T23:42:54.8822148Z -                    .await
2025-11-09T23:42:54.8822457Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:42:54.8822582Z -            }
2025-11-09T23:42:54.8822731Z -            "getblockcount" => {
2025-11-09T23:42:54.8822900Z -                self.blockchain
2025-11-09T23:42:54.8823044Z -                    .get_block_count()
2025-11-09T23:42:54.8823170Z -                    .await
2025-11-09T23:42:54.8823444Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:42:54.8823571Z -            }
2025-11-09T23:42:54.8823716Z -            "getdifficulty" => {
2025-11-09T23:42:54.8823869Z -                self.blockchain
2025-11-09T23:42:54.8824025Z -                    .get_difficulty()
2025-11-09T23:42:54.8824147Z -                    .await
2025-11-09T23:42:54.8826499Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:42:54.8826632Z -            }
2025-11-09T23:42:54.8826801Z -            "gettxoutsetinfo" => {
2025-11-09T23:42:54.8826941Z -                self.blockchain
2025-11-09T23:42:54.8827094Z -                    .get_txoutset_info()
2025-11-09T23:42:54.8827219Z -                    .await
2025-11-09T23:42:54.8827481Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:42:54.8827589Z -            }
2025-11-09T23:42:54.8827733Z +            "getbestblockhash" => self
2025-11-09T23:42:54.8827864Z +                .blockchain
2025-11-09T23:42:54.8828000Z +                .get_best_block_hash()
2025-11-09T23:42:54.8828116Z +                .await
2025-11-09T23:42:54.8828375Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:42:54.8828519Z +            "getblockcount" => self
2025-11-09T23:42:54.8828637Z +                .blockchain
2025-11-09T23:42:54.8829006Z +                .get_block_count()
2025-11-09T23:42:54.8829121Z +                .await
2025-11-09T23:42:54.8829363Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:42:54.8829496Z +            "getdifficulty" => self
2025-11-09T23:42:54.8829630Z +                .blockchain
2025-11-09T23:42:54.8829770Z +                .get_difficulty()
2025-11-09T23:42:54.8830121Z +                .await
2025-11-09T23:42:54.8830387Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:42:54.8830535Z +            "gettxoutsetinfo" => self
2025-11-09T23:42:54.8830654Z +                .blockchain
2025-11-09T23:42:54.8830788Z +                .get_txoutset_info()
2025-11-09T23:42:54.8830912Z +                .await
2025-11-09T23:42:54.8831172Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:42:54.8831307Z              "verifychain" => {
2025-11-09T23:42:54.8831555Z                  let checklevel = params.get(0).and_then(|p| p.as_u64());
2025-11-09T23:42:54.8831798Z                  let numblocks = params.get(1).and_then(|p| p.as_u64());
2025-11-09T23:42:54.8832251Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:381:
2025-11-09T23:42:54.8832387Z                      .await
2025-11-09T23:42:54.8832657Z                      .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:42:54.8832787Z              }
2025-11-09T23:42:54.8832939Z -            "getchaintips" => {
2025-11-09T23:42:54.8833087Z -                self.blockchain
2025-11-09T23:42:54.8833236Z -                    .get_chain_tips()
2025-11-09T23:42:54.8833359Z -                    .await
2025-11-09T23:42:54.8833638Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:42:54.8834054Z -            }
2025-11-09T23:42:54.8834211Z -            "getchaintxstats" => {
2025-11-09T23:42:54.8836815Z -                self.blockchain
2025-11-09T23:42:54.8837021Z -                    .get_chain_tx_stats(&params)
2025-11-09T23:42:54.8837152Z -                    .await
2025-11-09T23:42:54.8837432Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:42:54.8837558Z -            }
2025-11-09T23:42:54.8837757Z -            "getblockstats" => {
2025-11-09T23:42:54.8837918Z -                self.blockchain
2025-11-09T23:42:54.8838090Z -                    .get_block_stats(&params)
2025-11-09T23:42:54.8838223Z -                    .await
2025-11-09T23:42:54.8838491Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:42:54.8838609Z -            }
2025-11-09T23:42:54.8838771Z -            "pruneblockchain" => {
2025-11-09T23:42:54.8838911Z -                self.blockchain
2025-11-09T23:42:54.8839086Z -                    .prune_blockchain(&params)
2025-11-09T23:42:54.8839219Z -                    .await
2025-11-09T23:42:54.8839482Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:42:54.8839601Z -            }
2025-11-09T23:42:54.8839742Z -            "getpruneinfo" => {
2025-11-09T23:42:54.8839888Z -                self.blockchain
2025-11-09T23:42:54.8840046Z -                    .get_prune_info(&params)
2025-11-09T23:42:54.8840168Z -                    .await
2025-11-09T23:42:54.8840454Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:42:54.8840572Z -            }
2025-11-09T23:42:54.8840718Z -            "invalidateblock" => {
2025-11-09T23:42:54.8840852Z -                self.blockchain
2025-11-09T23:42:54.8841022Z -                    .invalidate_block(&params)
2025-11-09T23:42:54.8841145Z -                    .await
2025-11-09T23:42:54.8841406Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:42:54.8841544Z -            }
2025-11-09T23:42:54.8841692Z -            "reconsiderblock" => {
2025-11-09T23:42:54.8841826Z -                self.blockchain
2025-11-09T23:42:54.8841989Z -                    .reconsider_block(&params)
2025-11-09T23:42:54.8842112Z -                    .await
2025-11-09T23:42:54.8842368Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:42:54.8842487Z -            }
2025-11-09T23:42:54.8842641Z -            "waitfornewblock" => {
2025-11-09T23:42:54.8843029Z -                self.blockchain
2025-11-09T23:42:54.8843195Z -                    .wait_for_new_block(&params)
2025-11-09T23:42:54.8843324Z -                    .await
2025-11-09T23:42:54.8843583Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:42:54.8843703Z -            }
2025-11-09T23:42:54.8843847Z -            "waitforblock" => {
2025-11-09T23:42:54.8844001Z -                self.blockchain
2025-11-09T23:42:54.8844165Z -                    .wait_for_block(&params)
2025-11-09T23:42:54.8844444Z -                    .await
2025-11-09T23:42:54.8844737Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:42:54.8844860Z -            }
2025-11-09T23:42:54.8846787Z -            "waitforblockheight" => {
2025-11-09T23:42:54.8846924Z -                self.blockchain
2025-11-09T23:42:54.8847113Z -                    .wait_for_block_height(&params)
2025-11-09T23:42:54.8847238Z -                    .await
2025-11-09T23:42:54.8847525Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:42:54.8847652Z -            }
2025-11-09T23:42:54.8847797Z +            "getchaintips" => self
2025-11-09T23:42:54.8847926Z +                .blockchain
2025-11-09T23:42:54.8848072Z +                .get_chain_tips()
2025-11-09T23:42:54.8848200Z +                .await
2025-11-09T23:42:54.8848730Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:42:54.8848887Z +            "getchaintxstats" => self
2025-11-09T23:42:54.8849026Z +                .blockchain
2025-11-09T23:42:54.8849184Z +                .get_chain_tx_stats(&params)
2025-11-09T23:42:54.8849308Z +                .await
2025-11-09T23:42:54.8849580Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:42:54.8849731Z +            "getblockstats" => self
2025-11-09T23:42:54.8849862Z +                .blockchain
2025-11-09T23:42:54.8850030Z +                .get_block_stats(&params)
2025-11-09T23:42:54.8850159Z +                .await
2025-11-09T23:42:54.8850421Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:42:54.8850581Z +            "pruneblockchain" => self
2025-11-09T23:42:54.8850722Z +                .blockchain
2025-11-09T23:42:54.8850883Z +                .prune_blockchain(&params)
2025-11-09T23:42:54.8851019Z +                .await
2025-11-09T23:42:54.8851278Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:42:54.8851435Z +            "getpruneinfo" => self
2025-11-09T23:42:54.8851565Z +                .blockchain
2025-11-09T23:42:54.8851716Z +                .get_prune_info(&params)
2025-11-09T23:42:54.8851847Z +                .await
2025-11-09T23:42:54.8852109Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:42:54.8852262Z +            "invalidateblock" => self
2025-11-09T23:42:54.8852406Z +                .blockchain
2025-11-09T23:42:54.8852560Z +                .invalidate_block(&params)
2025-11-09T23:42:54.8852678Z +                .await
2025-11-09T23:42:54.8852932Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:42:54.8853093Z +            "reconsiderblock" => self
2025-11-09T23:42:54.8853218Z +                .blockchain
2025-11-09T23:42:54.8853368Z +                .reconsider_block(&params)
2025-11-09T23:42:54.8853501Z +                .await
2025-11-09T23:42:54.8853752Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:42:54.8853905Z +            "waitfornewblock" => self
2025-11-09T23:42:54.8854032Z +                .blockchain
2025-11-09T23:42:54.8854197Z +                .wait_for_new_block(&params)
2025-11-09T23:42:54.8854493Z +                .await
2025-11-09T23:42:54.8856593Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:42:54.8857026Z +            "waitforblock" => self
2025-11-09T23:42:54.8857163Z +                .blockchain
2025-11-09T23:42:54.8857318Z +                .wait_for_block(&params)
2025-11-09T23:42:54.8857442Z +                .await
2025-11-09T23:42:54.8857719Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:42:54.8857885Z +            "waitforblockheight" => self
2025-11-09T23:42:54.8858015Z +                .blockchain
2025-11-09T23:42:54.8858203Z +                .wait_for_block_height(&params)
2025-11-09T23:42:54.8858319Z +                .await
2025-11-09T23:42:54.8858578Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:42:54.8858698Z  
2025-11-09T23:42:54.8858842Z              // Raw Transaction methods
2025-11-09T23:42:54.8858988Z -            "getrawtransaction" => {
2025-11-09T23:42:54.8859192Z -                self.rawtx.getrawtransaction(&params).await
2025-11-09T23:42:54.8859309Z -            }
2025-11-09T23:42:54.8859466Z -            "sendrawtransaction" => {
2025-11-09T23:42:54.8859672Z -                self.rawtx.sendrawtransaction(&params).await
2025-11-09T23:42:54.8859791Z -            }
2025-11-09T23:42:54.8859940Z -            "testmempoolaccept" => {
2025-11-09T23:42:54.8860157Z -                self.rawtx.testmempoolaccept(&params).await
2025-11-09T23:42:54.8860271Z -            }
2025-11-09T23:42:54.8860435Z -            "decoderawtransaction" => {
2025-11-09T23:42:54.8860851Z -                self.rawtx.decoderawtransaction(&params).await
2025-11-09T23:42:54.8860968Z -            }
2025-11-09T23:42:54.8861118Z -            "gettxout" => {
2025-11-09T23:42:54.8861298Z -                self.rawtx.gettxout(&params).await
2025-11-09T23:42:54.8861413Z -            }
2025-11-09T23:42:54.8861548Z -            "gettxoutproof" => {
2025-11-09T23:42:54.8861740Z -                self.rawtx.gettxoutproof(&params).await
2025-11-09T23:42:54.8861856Z -            }
2025-11-09T23:42:54.8861998Z -            "verifytxoutproof" => {
2025-11-09T23:42:54.8862217Z -                self.rawtx.verifytxoutproof(&params).await
2025-11-09T23:42:54.8862332Z -            }
2025-11-09T23:42:54.8862659Z +            "getrawtransaction" => self.rawtx.getrawtransaction(&params).await,
2025-11-09T23:42:54.8863025Z +            "sendrawtransaction" => self.rawtx.sendrawtransaction(&params).await,
2025-11-09T23:42:54.8863365Z +            "testmempoolaccept" => self.rawtx.testmempoolaccept(&params).await,
2025-11-09T23:42:54.8863750Z +            "decoderawtransaction" => self.rawtx.decoderawtransaction(&params).await,
2025-11-09T23:42:54.8863971Z +            "gettxout" => self.rawtx.gettxout(&params).await,
2025-11-09T23:42:54.8864257Z +            "gettxoutproof" => self.rawtx.gettxoutproof(&params).await,
2025-11-09T23:42:54.8864746Z +            "verifytxoutproof" => self.rawtx.verifytxoutproof(&params).await,
2025-11-09T23:42:54.8864876Z  
2025-11-09T23:42:54.8865028Z              // Mempool methods
2025-11-09T23:42:54.8865179Z -            "getmempoolinfo" => {
2025-11-09T23:42:54.8865400Z -                self.mempool.getmempoolinfo(&params).await
2025-11-09T23:42:54.8865527Z -            }
2025-11-09T23:42:54.8865670Z -            "getrawmempool" => {
2025-11-09T23:42:54.8865870Z -                self.mempool.getrawmempool(&params).await
2025-11-09T23:42:54.8865988Z -            }
2025-11-09T23:42:54.8866139Z -            "savemempool" => {
2025-11-09T23:42:54.8866340Z -                self.mempool.savemempool(&params).await
2025-11-09T23:42:54.8866458Z -            }
2025-11-09T23:42:54.8866620Z -            "getmempoolancestors" => {
2025-11-09T23:42:54.8868678Z -                self.mempool.getmempoolancestors(&params).await
2025-11-09T23:42:54.8868796Z -            }
2025-11-09T23:42:54.8868960Z -            "getmempooldescendants" => {
2025-11-09T23:42:54.8869217Z -                self.mempool.getmempooldescendants(&params).await
2025-11-09T23:42:54.8869335Z -            }
2025-11-09T23:42:54.8869484Z -            "getmempoolentry" => {
2025-11-09T23:42:54.8869968Z -                self.mempool.getmempoolentry(&params).await
2025-11-09T23:42:54.8870088Z -            }
2025-11-09T23:42:54.8870394Z +            "getmempoolinfo" => self.mempool.getmempoolinfo(&params).await,
2025-11-09T23:42:54.8870683Z +            "getrawmempool" => self.mempool.getrawmempool(&params).await,
2025-11-09T23:42:54.8870953Z +            "savemempool" => self.mempool.savemempool(&params).await,
2025-11-09T23:42:54.8871329Z +            "getmempoolancestors" => self.mempool.getmempoolancestors(&params).await,
2025-11-09T23:42:54.8871734Z +            "getmempooldescendants" => self.mempool.getmempooldescendants(&params).await,
2025-11-09T23:42:54.8872064Z +            "getmempoolentry" => self.mempool.getmempoolentry(&params).await,
2025-11-09T23:42:54.8872184Z  
2025-11-09T23:42:54.8872322Z              // Network methods
2025-11-09T23:42:54.8872474Z -            "getnetworkinfo" => {
2025-11-09T23:42:54.8872657Z -                self.network.get_network_info().await
2025-11-09T23:42:54.8872786Z -            }
2025-11-09T23:42:54.8872922Z -            "getpeerinfo" => {
2025-11-09T23:42:54.8873103Z -                self.network.get_peer_info().await
2025-11-09T23:42:54.8873218Z -            }
2025-11-09T23:42:54.8873364Z -            "getconnectioncount" => {
2025-11-09T23:42:54.8873593Z -                self.network.get_connection_count(&params).await
2025-11-09T23:42:54.8873709Z -            }
2025-11-09T23:42:54.8874058Z -            "ping" => {
2025-11-09T23:42:54.8874236Z -                self.network.ping(&params).await
2025-11-09T23:42:54.8874536Z -            }
2025-11-09T23:42:54.8874672Z -            "addnode" => {
2025-11-09T23:42:54.8874855Z -                self.network.add_node(&params).await
2025-11-09T23:42:54.8874985Z -            }
2025-11-09T23:42:54.8875131Z -            "disconnectnode" => {
2025-11-09T23:42:54.8875340Z -                self.network.disconnect_node(&params).await
2025-11-09T23:42:54.8875458Z -            }
2025-11-09T23:42:54.8875621Z -            "getnettotals" => {
2025-11-09T23:42:54.8875821Z -                self.network.get_net_totals(&params).await
2025-11-09T23:42:54.8877512Z -            }
2025-11-09T23:42:54.8877657Z -            "clearbanned" => {
2025-11-09T23:42:54.8877845Z -                self.network.clear_banned(&params).await
2025-11-09T23:42:54.8877958Z -            }
2025-11-09T23:42:54.8878090Z -            "setban" => {
2025-11-09T23:42:54.8878287Z -                self.network.set_ban(&params).await
2025-11-09T23:42:54.8878400Z -            }
2025-11-09T23:42:54.8878537Z -            "listbanned" => {
2025-11-09T23:42:54.8878739Z -                self.network.list_banned(&params).await
2025-11-09T23:42:54.8878855Z -            }
2025-11-09T23:42:54.8879005Z -            "getaddednodeinfo" => {
2025-11-09T23:42:54.8879225Z -                self.network.getaddednodeinfo(&params).await
2025-11-09T23:42:54.8879352Z -            }
2025-11-09T23:42:54.8879494Z -            "getnodeaddresses" => {
2025-11-09T23:42:54.8879717Z -                self.network.getnodeaddresses(&params).await
2025-11-09T23:42:54.8879840Z -            }
2025-11-09T23:42:54.8879987Z -            "setnetworkactive" => {
2025-11-09T23:42:54.8880195Z -                self.network.setnetworkactive(&params).await
2025-11-09T23:42:54.8880320Z -            }
2025-11-09T23:42:54.8880593Z +            "getnetworkinfo" => self.network.get_network_info().await,
2025-11-09T23:42:54.8880830Z +            "getpeerinfo" => self.network.get_peer_info().await,
2025-11-09T23:42:54.8881192Z +            "getconnectioncount" => self.network.get_connection_count(&params).await,
2025-11-09T23:42:54.8881394Z +            "ping" => self.network.ping(&params).await,
2025-11-09T23:42:54.8881607Z +            "addnode" => self.network.add_node(&params).await,
2025-11-09T23:42:54.8881908Z +            "disconnectnode" => self.network.disconnect_node(&params).await,
2025-11-09T23:42:54.8882193Z +            "getnettotals" => self.network.get_net_totals(&params).await,
2025-11-09T23:42:54.8882706Z +            "clearbanned" => self.network.clear_banned(&params).await,
2025-11-09T23:42:54.8882918Z +            "setban" => self.network.set_ban(&params).await,
2025-11-09T23:42:54.8883176Z +            "listbanned" => self.network.list_banned(&params).await,
2025-11-09T23:42:54.8883514Z +            "getaddednodeinfo" => self.network.getaddednodeinfo(&params).await,
2025-11-09T23:42:54.8883843Z +            "getnodeaddresses" => self.network.getnodeaddresses(&params).await,
2025-11-09T23:42:54.8884185Z +            "setnetworkactive" => self.network.setnetworkactive(&params).await,
2025-11-09T23:42:54.8884472Z  
2025-11-09T23:42:54.8884623Z              // Mining methods
2025-11-09T23:42:54.8884773Z -            "getmininginfo" => {
2025-11-09T23:42:54.8884963Z -                self.mining.get_mining_info().await
2025-11-09T23:42:54.8885076Z -            }
2025-11-09T23:42:54.8885228Z -            "getblocktemplate" => {
2025-11-09T23:42:54.8885459Z -                self.mining.get_block_template(&params).await
2025-11-09T23:42:54.8885584Z -            }
2025-11-09T23:42:54.8885721Z -            "submitblock" => {
2025-11-09T23:42:54.8885906Z -                self.mining.submit_block(&params).await
2025-11-09T23:42:54.8886019Z -            }
2025-11-09T23:42:54.8886157Z -            "estimatesmartfee" => {
2025-11-09T23:42:54.8886355Z -                self.mining.estimate_smart_fee(&params).await
2025-11-09T23:42:54.8886704Z -            }
2025-11-09T23:42:54.8886862Z -            "prioritisetransaction" => {
2025-11-09T23:42:54.8887080Z -                self.mining.prioritise_transaction(&params).await
2025-11-09T23:42:54.8887189Z -            }
2025-11-09T23:42:54.8887331Z -            "getblockfilter" => {
2025-11-09T23:42:54.8887471Z -                self.blockchain
2025-11-09T23:42:54.8887635Z -                    .get_block_filter(&params)
2025-11-09T23:42:54.8887762Z -                    .await
2025-11-09T23:42:54.8888038Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:42:54.8888161Z -            }
2025-11-09T23:42:54.8888294Z -            "getindexinfo" => {
2025-11-09T23:42:54.8888428Z -                self.blockchain
2025-11-09T23:42:54.8888574Z -                    .get_index_info(&params)
2025-11-09T23:42:54.8888692Z -                    .await
2025-11-09T23:42:54.8888950Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:42:54.8889065Z -            }
2025-11-09T23:42:54.8889303Z +            "getmininginfo" => self.mining.get_mining_info().await,
2025-11-09T23:42:54.8889621Z +            "getblocktemplate" => self.mining.get_block_template(&params).await,
2025-11-09T23:42:54.8889862Z +            "submitblock" => self.mining.submit_block(&params).await,
2025-11-09T23:42:54.8890163Z +            "estimatesmartfee" => self.mining.estimate_smart_fee(&params).await,
2025-11-09T23:42:54.8890602Z +            "prioritisetransaction" => self.mining.prioritise_transaction(&params).await,
2025-11-09T23:42:54.8890782Z +            "getblockfilter" => self
2025-11-09T23:42:54.8890914Z +                .blockchain
2025-11-09T23:42:54.8891071Z +                .get_block_filter(&params)
2025-11-09T23:42:54.8891198Z +                .await
2025-11-09T23:42:54.8891461Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:42:54.8891596Z +            "getindexinfo" => self
2025-11-09T23:42:54.8891735Z +                .blockchain
2025-11-09T23:42:54.8891871Z +                .get_index_info(&params)
2025-11-09T23:42:54.8891986Z +                .await
2025-11-09T23:42:54.8892242Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:42:54.8892364Z  
2025-11-09T23:42:54.8892496Z              // Control methods
2025-11-09T23:42:54.8892625Z -            "stop" => {
2025-11-09T23:42:54.8892807Z -                self.control.stop(&params).await
2025-11-09T23:42:54.8892922Z -            }
2025-11-09T23:42:54.8893055Z -            "uptime" => {
2025-11-09T23:42:54.8893474Z -                self.control.uptime(&params).await
2025-11-09T23:42:54.8893601Z -            }
2025-11-09T23:42:54.8893749Z -            "getmemoryinfo" => {
2025-11-09T23:42:54.8893953Z -                self.control.getmemoryinfo(&params).await
2025-11-09T23:42:54.8894078Z -            }
2025-11-09T23:42:54.8894217Z -            "getrpcinfo" => {
2025-11-09T23:42:54.8894620Z -                self.control.getrpcinfo(&params).await
2025-11-09T23:42:54.8894756Z -            }
2025-11-09T23:42:54.8894893Z -            "help" => {
2025-11-09T23:42:54.8895072Z -                self.control.help(&params).await
2025-11-09T23:42:54.8895194Z -            }
2025-11-09T23:42:54.8895330Z -            "logging" => {
2025-11-09T23:42:54.8895508Z -                self.control.logging(&params).await
2025-11-09T23:42:54.8895622Z -            }
2025-11-09T23:42:54.8895757Z -            "gethealth" => {
2025-11-09T23:42:54.8895947Z -                self.control.gethealth(&params).await
2025-11-09T23:42:54.8896070Z -            }
2025-11-09T23:42:54.8896208Z -            "getmetrics" => {
2025-11-09T23:42:54.8896406Z -                self.control.getmetrics(&params).await
2025-11-09T23:42:54.8896521Z -            }
2025-11-09T23:42:54.8896714Z +            "stop" => self.control.stop(&params).await,
2025-11-09T23:42:54.8896917Z +            "uptime" => self.control.uptime(&params).await,
2025-11-09T23:42:54.8897217Z +            "getmemoryinfo" => self.control.getmemoryinfo(&params).await,
2025-11-09T23:42:54.8897717Z +            "getrpcinfo" => self.control.getrpcinfo(&params).await,
2025-11-09T23:42:54.8897916Z +            "help" => self.control.help(&params).await,
2025-11-09T23:42:54.8898142Z +            "logging" => self.control.logging(&params).await,
2025-11-09T23:42:54.8898375Z +            "gethealth" => self.control.gethealth(&params).await,
2025-11-09T23:42:54.8898620Z +            "getmetrics" => self.control.getmetrics(&params).await,
2025-11-09T23:42:54.8898744Z  
2025-11-09T23:42:54.8898982Z              _ => Err(errors::RpcError::method_not_found(method)),
2025-11-09T23:42:54.8899093Z          }
2025-11-09T23:42:54.8899555Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:605:
2025-11-09T23:42:54.8899725Z          // Start server on random port
2025-11-09T23:42:54.8900055Z          let listener = tokio::net::TcpListener::bind("127.0.0.1:0").await.unwrap();
2025-11-09T23:42:54.8900279Z          let server_addr = listener.local_addr().unwrap();
2025-11-09T23:42:54.8900406Z -        
2025-11-09T23:42:54.8900517Z +
2025-11-09T23:42:54.8900678Z          // Spawn server task using hyper
2025-11-09T23:42:54.8900886Z          let server_handle = tokio::spawn(async move {
2025-11-09T23:42:54.8901003Z              loop {
2025-11-09T23:42:54.8901431Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:617:
2025-11-09T23:42:54.8901606Z                              let service = service_fn(move |req| {
2025-11-09T23:42:54.8901859Z                                  RpcServer::handle_http_request(req, peer_addr)
2025-11-09T23:42:54.8901994Z                              });
2025-11-09T23:42:54.8902164Z -                            let _ = http1::Builder::new()
2025-11-09T23:42:54.8902341Z -                                .serve_connection(io, service)
2025-11-09T23:42:54.8902469Z -                                .await;
2025-11-09T23:42:54.8902753Z +                            let _ = http1::Builder::new().serve_connection(io, service).await;
2025-11-09T23:42:54.8902904Z                          });
2025-11-09T23:42:54.8903022Z                      }
2025-11-09T23:42:54.8903156Z                      Err(_) => break,
2025-11-09T23:42:54.8903596Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:632:
2025-11-09T23:42:54.8903712Z  
2025-11-09T23:42:54.8903844Z          // Connect to server
2025-11-09T23:42:54.8904166Z          let mut client = TokioTcpStream::connect(server_addr).await.unwrap();
2025-11-09T23:42:54.8904758Z -        
2025-11-09T23:42:54.8904872Z +
2025-11-09T23:42:54.8905031Z          // Send HTTP POST request
2025-11-09T23:42:54.8905327Z          let json_body = r#"{"jsonrpc":"2.0","method":"ping","params":[],"id":1}"#;
2025-11-09T23:42:54.8905491Z          let http_request = format!(
2025-11-09T23:42:54.8905948Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:645:
2025-11-09T23:42:54.8906101Z              json_body.len(),
2025-11-09T23:42:54.8906234Z              json_body
2025-11-09T23:42:54.8906347Z          );
2025-11-09T23:42:54.8906458Z -        
2025-11-09T23:42:54.8906576Z +
2025-11-09T23:42:54.8906834Z          client.write_all(http_request.as_bytes()).await.unwrap();
2025-11-09T23:42:54.8906944Z -        
2025-11-09T23:42:54.8907055Z +
2025-11-09T23:42:54.8907193Z          // Read response
2025-11-09T23:42:54.8907350Z          let mut response = vec![0u8; 4096];
2025-11-09T23:42:54.8907508Z          let n = tokio::time::timeout(
2025-11-09T23:42:54.8907938Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:654:
2025-11-09T23:42:54.8908104Z              tokio::time::Duration::from_secs(2),
2025-11-09T23:42:54.8908257Z -            client.read(&mut response)
2025-11-09T23:42:54.8908406Z -        ).await.unwrap().unwrap();
2025-11-09T23:42:54.8908523Z -        
2025-11-09T23:42:54.8908677Z +            client.read(&mut response),
2025-11-09T23:42:54.8909028Z +        )
2025-11-09T23:42:54.8909152Z +        .await
2025-11-09T23:42:54.8909270Z +        .unwrap()
2025-11-09T23:42:54.8909392Z +        .unwrap();
2025-11-09T23:42:54.8909502Z +
2025-11-09T23:42:54.8909790Z          let response_str = String::from_utf8_lossy(&response[..n]);
2025-11-09T23:42:54.8909905Z -        
2025-11-09T23:42:54.8910019Z +
2025-11-09T23:42:54.8910251Z          // Verify HTTP response (hyper uses lowercase headers)
2025-11-09T23:42:54.8910797Z -        assert!(response_str.contains("HTTP/1.1 200 OK") || response_str.contains("200 OK"), "Response: {}", response_str);
2025-11-09T23:42:54.8911441Z -        assert!(response_str.contains("content-type: application/json") || response_str.contains("Content-Type: application/json"));
2025-11-09T23:42:54.8911589Z +        assert!(
2025-11-09T23:42:54.8911943Z +            response_str.contains("HTTP/1.1 200 OK") || response_str.contains("200 OK"),
2025-11-09T23:42:54.8912083Z +            "Response: {}",
2025-11-09T23:42:54.8912217Z +            response_str
2025-11-09T23:42:54.8912337Z +        );
2025-11-09T23:42:54.8912457Z +        assert!(
2025-11-09T23:42:54.8912710Z +            response_str.contains("content-type: application/json")
2025-11-09T23:42:54.8912986Z +                || response_str.contains("Content-Type: application/json")
2025-11-09T23:42:54.8913102Z +        );
2025-11-09T23:42:54.8913282Z          assert!(response_str.contains("jsonrpc"));
2025-11-09T23:42:54.8913477Z          assert!(response_str.contains("\"result\""));
2025-11-09T23:42:54.8913601Z -        
2025-11-09T23:42:54.8913884Z +
2025-11-09T23:42:54.8914039Z          server_handle.abort();
2025-11-09T23:42:54.8914156Z      }
2025-11-09T23:42:54.8914268Z  
2025-11-09T23:42:54.8914915Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:669:
2025-11-09T23:42:54.8915040Z -
2025-11-09T23:42:54.8915191Z      #[tokio::test]
2025-11-09T23:42:54.8915383Z      async fn test_process_request_valid_json() {
2025-11-09T23:42:54.8915751Z          let request = r#"{"jsonrpc":"2.0","method":"getblockchaininfo","params":[],"id":1}"#;
2025-11-09T23:42:54.8916228Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:684:
2025-11-09T23:42:54.8916345Z  
2025-11-09T23:42:54.8916519Z          assert_eq!(response["jsonrpc"], "2.0");
2025-11-09T23:42:54.8916728Z          assert_eq!(response["error"]["code"], -32700);
2025-11-09T23:42:54.8917105Z -        assert!(response["error"]["message"].as_str().unwrap().contains("Parse error") || 
2025-11-09T23:42:54.8917692Z -                response["error"]["message"].as_str().unwrap().contains("Invalid JSON"));
2025-11-09T23:42:54.8917826Z +        assert!(
2025-11-09T23:42:54.8917992Z +            response["error"]["message"]
2025-11-09T23:42:54.8918119Z +                .as_str()
2025-11-09T23:42:54.8918248Z +                .unwrap()
2025-11-09T23:42:54.8918411Z +                .contains("Parse error")
2025-11-09T23:42:54.8918571Z +                || response["error"]["message"]
2025-11-09T23:42:54.8918712Z +                    .as_str()
2025-11-09T23:42:54.8918840Z +                    .unwrap()
2025-11-09T23:42:54.8919005Z +                    .contains("Invalid JSON")
2025-11-09T23:42:54.8919115Z +        );
2025-11-09T23:42:54.8919226Z      }
2025-11-09T23:42:54.8919342Z  
2025-11-09T23:42:54.8919479Z      #[tokio::test]
2025-11-09T23:42:54.8919939Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:695:
2025-11-09T23:42:54.8920056Z  
2025-11-09T23:42:54.8920233Z          assert_eq!(response["jsonrpc"], "2.0");
2025-11-09T23:42:54.8920446Z          assert_eq!(response["error"]["code"], -32601);
2025-11-09T23:42:54.8920826Z -        assert!(response["error"]["message"].as_str().unwrap().contains("Method not found"));
2025-11-09T23:42:54.8921006Z +        assert!(response["error"]["message"]
2025-11-09T23:42:54.8921129Z +            .as_str()
2025-11-09T23:42:54.8921251Z +            .unwrap()
2025-11-09T23:42:54.8921642Z +            .contains("Method not found"));
2025-11-09T23:42:54.8921795Z          assert_eq!(response["id"], 1);
2025-11-09T23:42:54.8921910Z      }
2025-11-09T23:42:54.8922019Z  
2025-11-09T23:42:54.8922469Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:822:
2025-11-09T23:42:54.8922580Z  
2025-11-09T23:42:54.8922746Z          assert_eq!(response["jsonrpc"], "2.0");
2025-11-09T23:42:54.8922942Z          assert_eq!(response["error"]["code"], -32700);
2025-11-09T23:42:54.8923292Z -        assert!(response["error"]["message"].as_str().unwrap().contains("Parse error") ||
2025-11-09T23:42:54.8923613Z -                response["error"]["message"].as_str().unwrap().contains("Invalid JSON"));
2025-11-09T23:42:54.8923729Z +        assert!(
2025-11-09T23:42:54.8923884Z +            response["error"]["message"]
2025-11-09T23:42:54.8924004Z +                .as_str()
2025-11-09T23:42:54.8924126Z +                .unwrap()
2025-11-09T23:42:54.8924282Z +                .contains("Parse error")
2025-11-09T23:42:54.8924650Z +                || response["error"]["message"]
2025-11-09T23:42:54.8924784Z +                    .as_str()
2025-11-09T23:42:54.8924912Z +                    .unwrap()
2025-11-09T23:42:54.8925080Z +                    .contains("Invalid JSON")
2025-11-09T23:42:54.8925197Z +        );
2025-11-09T23:42:54.8925313Z      }
2025-11-09T23:42:54.8925432Z  
2025-11-09T23:42:54.8925568Z      #[tokio::test]
2025-11-09T23:42:54.8926015Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:833:
2025-11-09T23:42:54.8926138Z  
2025-11-09T23:42:54.8926314Z          assert_eq!(response["jsonrpc"], "2.0");
2025-11-09T23:42:54.8926514Z          assert_eq!(response["error"]["code"], -32601);
2025-11-09T23:42:54.8926892Z -        assert!(response["error"]["message"].as_str().unwrap().contains("Method not found"));
2025-11-09T23:42:54.8927068Z +        assert!(response["error"]["message"]
2025-11-09T23:42:54.8927192Z +            .as_str()
2025-11-09T23:42:54.8927324Z +            .unwrap()
2025-11-09T23:42:54.8927486Z +            .contains("Method not found"));
2025-11-09T23:42:54.8927845Z          assert!(response["error"]["data"].is_string() || response["error"]["data"].is_null());
2025-11-09T23:42:54.8927996Z          assert_eq!(response["id"], 42);
2025-11-09T23:42:54.8928106Z      }
2025-11-09T23:42:54.8928555Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:855:
2025-11-09T23:42:54.8928669Z  
2025-11-09T23:42:54.8928831Z          assert_eq!(response["jsonrpc"], "2.0");
2025-11-09T23:42:54.8929323Z          assert_eq!(response["error"]["code"], -32601);
2025-11-09T23:42:54.8929695Z -        assert!(response["error"]["message"].as_str().unwrap().contains("Method not found"));
2025-11-09T23:42:54.8929859Z +        assert!(response["error"]["message"]
2025-11-09T23:42:54.8929976Z +            .as_str()
2025-11-09T23:42:54.8930102Z +            .unwrap()
2025-11-09T23:42:54.8930263Z +            .contains("Method not found"));
2025-11-09T23:42:54.8930419Z          assert_eq!(response["id"], 1);
2025-11-09T23:42:54.8930530Z      }
2025-11-09T23:42:54.8930637Z  
2025-11-09T23:42:54.8931198Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/blockstore.rs:2:
2025-11-09T23:42:54.8931314Z  //!
2025-11-09T23:42:54.8931571Z  //! Stores blocks by hash and maintains block index by height.
2025-11-09T23:42:54.8931684Z  
2025-11-09T23:42:54.8931897Z +use crate::storage::database::{Database, Tree};
2025-11-09T23:42:54.8932033Z  use anyhow::Result;
2025-11-09T23:42:54.8932215Z  use bllvm_protocol::segwit::Witness;
2025-11-09T23:42:54.8932413Z  use bllvm_protocol::{Block, BlockHeader, Hash};
2025-11-09T23:42:54.8932897Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/blockstore.rs:8:
2025-11-09T23:42:54.8933098Z -use crate::storage::database::{Database, Tree};
2025-11-09T23:42:54.8933231Z  use std::sync::Arc;
2025-11-09T23:42:54.8933350Z  
2025-11-09T23:42:54.8933729Z  /// Block storage manager
2025-11-09T23:42:54.8934230Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/blockstore.rs:45:
2025-11-09T23:42:54.8934530Z  
2025-11-09T23:42:54.8934790Z          self.blocks.insert(block_hash.as_slice(), &block_data)?;
2025-11-09T23:42:54.8935040Z          let header_data = bincode::serialize(&block.header)?;
2025-11-09T23:42:54.8935177Z -        self.headers
2025-11-09T23:42:54.8935373Z -            .insert(block_hash.as_slice(), &header_data)?;
2025-11-09T23:42:54.8935639Z +        self.headers.insert(block_hash.as_slice(), &header_data)?;
2025-11-09T23:42:54.8935760Z  
2025-11-09T23:42:54.8935976Z          // Store header for median time-past calculation
2025-11-09T23:42:54.8936347Z          // We'll need height passed separately, so this will be called after store_height
2025-11-09T23:42:54.8936849Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/blockstore.rs:81:
2025-11-09T23:42:54.8937012Z      /// Store witness data for a block
2025-11-09T23:42:54.8937392Z      pub fn store_witness(&self, block_hash: &Hash, witness: &[Witness]) -> Result<()> {
2025-11-09T23:42:54.8937612Z          let witness_data = bincode::serialize(witness)?;
2025-11-09T23:42:54.8937896Z -        self.witnesses.insert(block_hash.as_slice(), &witness_data)?;
2025-11-09T23:42:54.8938022Z +        self.witnesses
2025-11-09T23:42:54.8938220Z +            .insert(block_hash.as_slice(), &witness_data)?;
2025-11-09T23:42:54.8938340Z          Ok(())
2025-11-09T23:42:54.8938461Z      }
2025-11-09T23:42:54.8938572Z  
2025-11-09T23:42:54.8939020Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/chainstate.rs:2:
2025-11-09T23:42:54.8939132Z  //!
2025-11-09T23:42:54.8939439Z  //! Stores chain metadata including tip, height, and chain parameters.
2025-11-09T23:42:54.8939551Z  
2025-11-09T23:42:54.8939745Z +use crate::storage::database::{Database, Tree};
2025-11-09T23:42:54.8939882Z  use anyhow::Result;
2025-11-09T23:42:54.8940052Z  use bllvm_protocol::{BlockHeader, Hash};
2025-11-09T23:42:54.8940211Z  use serde::{Deserialize, Serialize};
2025-11-09T23:42:54.8940697Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/chainstate.rs:8:
2025-11-09T23:42:54.8940879Z -use crate::storage::database::{Database, Tree};
2025-11-09T23:42:54.8941002Z  use std::sync::Arc;
2025-11-09T23:42:54.8941119Z  
2025-11-09T23:42:54.8941252Z  /// Chain state information
2025-11-09T23:42:54.8941742Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/chainstate.rs:223:
2025-11-09T23:42:54.8942094Z      }
2025-11-09T23:42:54.8942214Z  
2025-11-09T23:42:54.8942384Z      /// Add a chain tip (for fork tracking)
2025-11-09T23:42:54.8942811Z -    pub fn add_chain_tip(&self, hash: &Hash, height: u64, branchlen: u64, status: &str) -> Result<()> {
2025-11-09T23:42:54.8942967Z +    pub fn add_chain_tip(
2025-11-09T23:42:54.8943091Z +        &self,
2025-11-09T23:42:54.8943217Z +        hash: &Hash,
2025-11-09T23:42:54.8943351Z +        height: u64,
2025-11-09T23:42:54.8943491Z +        branchlen: u64,
2025-11-09T23:42:54.8943617Z +        status: &str,
2025-11-09T23:42:54.8943743Z +    ) -> Result<()> {
2025-11-09T23:42:54.8943913Z          #[derive(Serialize, Deserialize)]
2025-11-09T23:42:54.8944046Z          struct TipInfo {
2025-11-09T23:42:54.8944175Z              height: u64,
2025-11-09T23:42:54.8944853Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/chainstate.rs:230:
2025-11-09T23:42:54.8945014Z              branchlen: u64,
2025-11-09T23:42:54.8945155Z              status: String,
2025-11-09T23:42:54.8945267Z          }
2025-11-09T23:42:54.8945388Z -        
2025-11-09T23:42:54.8945497Z +
2025-11-09T23:42:54.8945646Z          let tip_info = TipInfo {
2025-11-09T23:42:54.8945765Z              height,
2025-11-09T23:42:54.8945892Z              branchlen,
2025-11-09T23:42:54.8946381Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/chainstate.rs:255:
2025-11-09T23:42:54.8946743Z              branchlen: u64,
2025-11-09T23:42:54.8946877Z              status: String,
2025-11-09T23:42:54.8946990Z          }
2025-11-09T23:42:54.8947102Z -        
2025-11-09T23:42:54.8947214Z +
2025-11-09T23:42:54.8947368Z          let mut tips = Vec::new();
2025-11-09T23:42:54.8947533Z          for result in self.chain_tips.iter() {
2025-11-09T23:42:54.8947668Z              let (key, data) = result?;
2025-11-09T23:42:54.8948175Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/commitment_store.rs:4:
2025-11-09T23:42:54.8948339Z  //! without requiring full block history.
2025-11-09T23:42:54.8948443Z  
2025-11-09T23:42:54.8948592Z  #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.8948784Z +use crate::storage::database::{Database, Tree};
2025-11-09T23:42:54.8948931Z +#[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.8949056Z  use anyhow::Result;
2025-11-09T23:42:54.8949210Z  #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.8949526Z  use bllvm_protocol::utxo_commitments::data_structures::UtxoCommitment;
2025-11-09T23:42:54.8950044Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/commitment_store.rs:10:
2025-11-09T23:42:54.8950200Z  #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.8950356Z  use bllvm_protocol::Hash;
2025-11-09T23:42:54.8950549Z  #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.8950749Z -use crate::storage::database::{Database, Tree};
2025-11-09T23:42:54.8950903Z -#[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.8951035Z  use std::sync::Arc;
2025-11-09T23:42:54.8951142Z  
2025-11-09T23:42:54.8951292Z  /// UTXO Commitment storage manager
2025-11-09T23:42:54.8951796Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/commitment_store.rs:48:
2025-11-09T23:42:54.8952030Z          let commitment_data = bincode::serialize(commitment)?;
2025-11-09T23:42:54.8952143Z  
2025-11-09T23:42:54.8952272Z          // Store by block hash
2025-11-09T23:42:54.8952584Z -        self.commitments.insert(block_hash.as_slice(), commitment_data)?;
2025-11-09T23:42:54.8952714Z +        self.commitments
2025-11-09T23:42:54.8952925Z +            .insert(block_hash.as_slice(), commitment_data)?;
2025-11-09T23:42:54.8953030Z  
2025-11-09T23:42:54.8953261Z          // Store height index for quick lookup
2025-11-09T23:42:54.8953438Z          let height_bytes = height.to_be_bytes();
2025-11-09T23:42:54.8953943Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/commitment_store.rs:55:
2025-11-09T23:42:54.8956422Z -        self.height_index.insert(height_bytes, block_hash.as_slice())?;
2025-11-09T23:42:54.8956560Z +        self.height_index
2025-11-09T23:42:54.8956758Z +            .insert(height_bytes, block_hash.as_slice())?;
2025-11-09T23:42:54.8956862Z  
2025-11-09T23:42:54.8956972Z          Ok(())
2025-11-09T23:42:54.8957085Z      }
2025-11-09T23:42:54.8957595Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/commitment_store.rs:128:
2025-11-09T23:42:54.8957862Z          Err(anyhow::anyhow!("UTXO commitments feature not enabled"))
2025-11-09T23:42:54.8957972Z      }
2025-11-09T23:42:54.8958077Z  }
2025-11-09T23:42:54.8958189Z -
2025-11-09T23:42:54.8958298Z  
2025-11-09T23:42:54.8959517Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:7:
2025-11-09T23:42:54.8959725Z  use std::path::Path;
2025-11-09T23:42:54.8959845Z  
2025-11-09T23:42:54.8959992Z  /// Database abstraction trait
2025-11-09T23:42:54.8960103Z -/// 
2025-11-09T23:42:54.8960223Z +///
2025-11-09T23:42:54.8960522Z  /// Provides a unified interface for key-value storage operations
2025-11-09T23:42:54.8960777Z  /// that can be implemented by different backends (sled, redb).
2025-11-09T23:42:54.8960934Z  pub trait Database: Send + Sync {
2025-11-09T23:42:54.8961397Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:14:
2025-11-09T23:42:54.8961532Z      /// Open a named tree/table
2025-11-09T23:42:54.8961956Z      fn open_tree(&self, name: &str) -> Result<Box<dyn Tree>>;
2025-11-09T23:42:54.8962065Z -    
2025-11-09T23:42:54.8962176Z +
2025-11-09T23:42:54.8962320Z      /// Flush all pending writes
2025-11-09T23:42:54.8962465Z      fn flush(&self) -> Result<()>;
2025-11-09T23:42:54.8962587Z  }
2025-11-09T23:42:54.8963043Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:20:
2025-11-09T23:42:54.8963162Z  
2025-11-09T23:42:54.8963318Z  /// Tree/Table abstraction trait
2025-11-09T23:42:54.8963450Z -/// 
2025-11-09T23:42:54.8963560Z +///
2025-11-09T23:42:54.8963996Z  /// Represents a named collection of key-value pairs within a database.
2025-11-09T23:42:54.8964165Z  pub trait Tree: Send + Sync {
2025-11-09T23:42:54.8964492Z      /// Insert a key-value pair
2025-11-09T23:42:54.8966493Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:26:
2025-11-09T23:42:54.8966733Z      fn insert(&self, key: &[u8], value: &[u8]) -> Result<()>;
2025-11-09T23:42:54.8966862Z -    
2025-11-09T23:42:54.8966975Z +
2025-11-09T23:42:54.8967115Z      /// Get a value by key
2025-11-09T23:42:54.8967342Z      fn get(&self, key: &[u8]) -> Result<Option<Vec<u8>>>;
2025-11-09T23:42:54.8967453Z -    
2025-11-09T23:42:54.8967564Z +
2025-11-09T23:42:54.8967714Z      /// Remove a key-value pair
2025-11-09T23:42:54.8967896Z      fn remove(&self, key: &[u8]) -> Result<()>;
2025-11-09T23:42:54.8968012Z -    
2025-11-09T23:42:54.8968127Z +
2025-11-09T23:42:54.8968272Z      /// Check if a key exists
2025-11-09T23:42:54.8968496Z      fn contains_key(&self, key: &[u8]) -> Result<bool>;
2025-11-09T23:42:54.8968610Z -    
2025-11-09T23:42:54.8968721Z +
2025-11-09T23:42:54.8968866Z      /// Clear all entries
2025-11-09T23:42:54.8969016Z      fn clear(&self) -> Result<()>;
2025-11-09T23:42:54.8969128Z -    
2025-11-09T23:42:54.8969251Z +
2025-11-09T23:42:54.8969390Z      /// Get number of entries
2025-11-09T23:42:54.8969542Z      fn len(&self) -> Result<usize>;
2025-11-09T23:42:54.8969650Z -    
2025-11-09T23:42:54.8969761Z +
2025-11-09T23:42:54.8969891Z      /// Check if tree is empty
2025-11-09T23:42:54.8970046Z      fn is_empty(&self) -> Result<bool> {
2025-11-09T23:42:54.8970195Z          Ok(self.len()? == 0)
2025-11-09T23:42:54.8970658Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:46:
2025-11-09T23:42:54.8970767Z      }
2025-11-09T23:42:54.8970885Z -    
2025-11-09T23:42:54.8970990Z +
2025-11-09T23:42:54.8971156Z      /// Iterate over all key-value pairs
2025-11-09T23:42:54.8971713Z      fn iter(&self) -> Box<dyn Iterator<Item = Result<(Vec<u8>, Vec<u8>)>> + '_>;
2025-11-09T23:42:54.8971838Z  }
2025-11-09T23:42:54.8972313Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:63:
2025-11-09T23:42:54.8972471Z  ) -> Result<Box<dyn Database>> {
2025-11-09T23:42:54.8972609Z      match backend {
2025-11-09T23:42:54.8972744Z          #[cfg(feature = "sled")]
2025-11-09T23:42:54.8972918Z -        DatabaseBackend::Sled => {
2025-11-09T23:42:54.8973157Z -            Ok(Box::new(sled_impl::SledDatabase::new(data_dir)?))
2025-11-09T23:42:54.8973277Z -        }
2025-11-09T23:42:54.8973615Z +        DatabaseBackend::Sled => Ok(Box::new(sled_impl::SledDatabase::new(data_dir)?)),
2025-11-09T23:42:54.8973758Z          #[cfg(not(feature = "sled"))]
2025-11-09T23:42:54.8973903Z -        DatabaseBackend::Sled => {
2025-11-09T23:42:54.8974204Z -            Err(anyhow::anyhow!("Sled backend not available (feature not enabled)"))
2025-11-09T23:42:54.8974508Z -        }
2025-11-09T23:42:54.8974706Z +        DatabaseBackend::Sled => Err(anyhow::anyhow!(
2025-11-09T23:42:54.8974914Z +            "Sled backend not available (feature not enabled)"
2025-11-09T23:42:54.8975021Z +        )),
2025-11-09T23:42:54.8975144Z          #[cfg(feature = "redb")]
2025-11-09T23:42:54.8977122Z -        DatabaseBackend::Redb => {
2025-11-09T23:42:54.8977343Z -            Ok(Box::new(redb_impl::RedbDatabase::new(data_dir)?))
2025-11-09T23:42:54.8977712Z -        }
2025-11-09T23:42:54.8978093Z +        DatabaseBackend::Redb => Ok(Box::new(redb_impl::RedbDatabase::new(data_dir)?)),
2025-11-09T23:42:54.8978247Z          #[cfg(not(feature = "redb"))]
2025-11-09T23:42:54.8978395Z -        DatabaseBackend::Redb => {
2025-11-09T23:42:54.8978717Z -            Err(anyhow::anyhow!("Redb backend not available (feature not enabled)"))
2025-11-09T23:42:54.8978839Z -        }
2025-11-09T23:42:54.8979026Z +        DatabaseBackend::Redb => Err(anyhow::anyhow!(
2025-11-09T23:42:54.8979249Z +            "Redb backend not available (feature not enabled)"
2025-11-09T23:42:54.8979373Z +        )),
2025-11-09T23:42:54.8979482Z      }
2025-11-09T23:42:54.8979597Z  }
2025-11-09T23:42:54.8979707Z  
2025-11-09T23:42:54.8980192Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:84:
2025-11-09T23:42:54.8980339Z  /// Get default database backend
2025-11-09T23:42:54.8980451Z -/// 
2025-11-09T23:42:54.8980566Z +///
2025-11-09T23:42:54.8980966Z  /// Returns the preferred backend (redb if available, otherwise sled).
2025-11-09T23:42:54.8981344Z  /// This function will not panic - it returns a backend if at least one is available.
2025-11-09T23:42:54.8981533Z  pub fn default_backend() -> DatabaseBackend {
2025-11-09T23:42:54.8982010Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:104:
2025-11-09T23:42:54.8982134Z  }
2025-11-09T23:42:54.8982247Z  
2025-11-09T23:42:54.8982396Z  /// Get fallback database backend
2025-11-09T23:42:54.8982506Z -/// 
2025-11-09T23:42:54.8982618Z +///
2025-11-09T23:42:54.8982836Z  /// Returns an alternative backend if the primary fails.
2025-11-09T23:42:54.8983011Z  /// Returns None if no fallback is available.
2025-11-09T23:42:54.8983388Z  pub fn fallback_backend(primary: DatabaseBackend) -> Option<DatabaseBackend> {
2025-11-09T23:42:54.8983835Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:148:
2025-11-09T23:42:54.8983980Z      impl SledDatabase {
2025-11-09T23:42:54.8984210Z          pub fn new<P: AsRef<Path>>(data_dir: P) -> Result<Self> {
2025-11-09T23:42:54.8986505Z              let db = sled::open(data_dir)?;
2025-11-09T23:42:54.8986629Z -            Ok(Self {
2025-11-09T23:42:54.8986757Z -                db: Arc::new(db),
2025-11-09T23:42:54.8986867Z -            })
2025-11-09T23:42:54.8987005Z +            Ok(Self { db: Arc::new(db) })
2025-11-09T23:42:54.8987110Z          }
2025-11-09T23:42:54.8987220Z      }
2025-11-09T23:42:54.8987574Z  
2025-11-09T23:42:54.8988033Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:224:
2025-11-09T23:42:54.8988425Z      static HEADERS_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("headers");
2025-11-09T23:42:54.8988877Z      static HEIGHT_INDEX_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("height_index");
2025-11-09T23:42:54.8989265Z      static WITNESSES_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("witnesses");
2025-11-09T23:42:54.8989704Z -    static RECENT_HEADERS_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("recent_headers");
2025-11-09T23:42:54.8989956Z +    static RECENT_HEADERS_TABLE: TableDefinition<&[u8], &[u8]> =
2025-11-09T23:42:54.8990137Z +        TableDefinition::new("recent_headers");
2025-11-09T23:42:54.8990520Z      static UTXOS_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("utxos");
2025-11-09T23:42:54.8991003Z -    static SPENT_OUTPUTS_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("spent_outputs");
2025-11-09T23:42:54.8991284Z +    static SPENT_OUTPUTS_TABLE: TableDefinition<&[u8], &[u8]> =
2025-11-09T23:42:54.8991467Z +        TableDefinition::new("spent_outputs");
2025-11-09T23:42:54.8991890Z      static CHAIN_INFO_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("chain_info");
2025-11-09T23:42:54.8992306Z      static WORK_CACHE_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("work_cache");
2025-11-09T23:42:54.8992940Z      static TX_BY_HASH_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("tx_by_hash");
2025-11-09T23:42:54.8993436Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:233:
2025-11-09T23:42:54.8993851Z      static TX_BY_BLOCK_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("tx_by_block");
2025-11-09T23:42:54.8994267Z      static TX_METADATA_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("tx_metadata");
2025-11-09T23:42:54.8994916Z -    static INVALID_BLOCKS_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("invalid_blocks");
2025-11-09T23:42:54.8995175Z +    static INVALID_BLOCKS_TABLE: TableDefinition<&[u8], &[u8]> =
2025-11-09T23:42:54.8995351Z +        TableDefinition::new("invalid_blocks");
2025-11-09T23:42:54.8995773Z      static CHAIN_TIPS_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("chain_tips");
2025-11-09T23:42:54.8995887Z  
2025-11-09T23:42:54.8996036Z      pub struct RedbDatabase {
2025-11-09T23:42:54.8996465Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:243:
2025-11-09T23:42:54.8996691Z          pub fn new<P: AsRef<Path>>(data_dir: P) -> Result<Self> {
2025-11-09T23:42:54.8996891Z              let db_path = data_dir.as_ref().join("redb.db");
2025-11-09T23:42:54.8997044Z              let db = RedbDb::create(&db_path)?;
2025-11-09T23:42:54.8997150Z -            
2025-11-09T23:42:54.8997264Z +
2025-11-09T23:42:54.8997447Z              // Initialize all tables in a write transaction
2025-11-09T23:42:54.8997600Z              let write_txn = db.begin_write()?;
2025-11-09T23:42:54.8997705Z              {
2025-11-09T23:42:54.8998174Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:264:
2025-11-09T23:42:54.8998372Z                  let _ = write_txn.open_table(CHAIN_TIPS_TABLE)?;
2025-11-09T23:42:54.8998475Z              }
2025-11-09T23:42:54.8998608Z              write_txn.commit()?;
2025-11-09T23:42:54.8998716Z -            
2025-11-09T23:42:54.8998830Z -            Ok(Self {
2025-11-09T23:42:54.8998961Z -                db: Arc::new(db),
2025-11-09T23:42:54.9007598Z -            })
2025-11-09T23:42:54.9007757Z +
2025-11-09T23:42:54.9007938Z +            Ok(Self { db: Arc::new(db) })
2025-11-09T23:42:54.9008050Z          }
2025-11-09T23:42:54.9008156Z -        
2025-11-09T23:42:54.9008562Z -        fn get_table_def(&self, name: &str) -> Option<TableDefinition<&'static [u8], &'static [u8]>> {
2025-11-09T23:42:54.9008669Z +
2025-11-09T23:42:54.9009037Z +        fn get_table_def(
2025-11-09T23:42:54.9009149Z +            &self,
2025-11-09T23:42:54.9009288Z +            name: &str,
2025-11-09T23:42:54.9009541Z +        ) -> Option<TableDefinition<&'static [u8], &'static [u8]>> {
2025-11-09T23:42:54.9009667Z              match name {
2025-11-09T23:42:54.9009828Z                  "blocks" => Some(BLOCKS_TABLE),
2025-11-09T23:42:54.9009974Z                  "headers" => Some(HEADERS_TABLE),
2025-11-09T23:42:54.9010431Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:293:
2025-11-09T23:42:54.9010538Z  
2025-11-09T23:42:54.9010693Z      impl Database for RedbDatabase {
2025-11-09T23:42:54.9010919Z          fn open_tree(&self, name: &str) -> Result<Box<dyn Tree>> {
2025-11-09T23:42:54.9011103Z -            let table_def = self.get_table_def(name)
2025-11-09T23:42:54.9011571Z -                .ok_or_else(|| anyhow::anyhow!("Unknown table name: {}. Redb requires pre-defined tables.", name))?;
2025-11-09T23:42:54.9011702Z -            
2025-11-09T23:42:54.9011939Z +            let table_def = self.get_table_def(name).ok_or_else(|| {
2025-11-09T23:42:54.9012091Z +                anyhow::anyhow!(
2025-11-09T23:42:54.9012356Z +                    "Unknown table name: {}. Redb requires pre-defined tables.",
2025-11-09T23:42:54.9012479Z +                    name
2025-11-09T23:42:54.9012599Z +                )
2025-11-09T23:42:54.9012936Z +            })?;
2025-11-09T23:42:54.9013049Z +
2025-11-09T23:42:54.9013193Z              Ok(Box::new(RedbTree {
2025-11-09T23:42:54.9013353Z                  db: Arc::clone(&self.db),
2025-11-09T23:42:54.9013474Z                  table_def,
2025-11-09T23:42:54.9016220Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:374:
2025-11-09T23:42:54.9016427Z              let read_txn = match self.db.begin_read() {
2025-11-09T23:42:54.9016566Z                  Ok(txn) => txn,
2025-11-09T23:42:54.9016686Z                  Err(e) => {
2025-11-09T23:42:54.9017126Z -                    return Box::new(std::iter::once(Err(anyhow::anyhow!("Failed to begin read transaction: {}", e))));
2025-11-09T23:42:54.9017366Z +                    return Box::new(std::iter::once(Err(anyhow::anyhow!(
2025-11-09T23:42:54.9017538Z +                        "Failed to begin read transaction: {}",
2025-11-09T23:42:54.9017654Z +                        e
2025-11-09T23:42:54.9017772Z +                    ))));
2025-11-09T23:42:54.9017886Z                  }
2025-11-09T23:42:54.9017997Z              };
2025-11-09T23:42:54.9018103Z -            
2025-11-09T23:42:54.9018212Z +
2025-11-09T23:42:54.9018439Z              let table = match read_txn.open_table(self.table_def) {
2025-11-09T23:42:54.9018564Z                  Ok(tbl) => tbl,
2025-11-09T23:42:54.9018690Z                  Err(e) => {
2025-11-09T23:42:54.9019137Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:384:
2025-11-09T23:42:54.9019479Z -                    return Box::new(std::iter::once(Err(anyhow::anyhow!("Failed to open table: {}", e))));
2025-11-09T23:42:54.9019703Z +                    return Box::new(std::iter::once(Err(anyhow::anyhow!(
2025-11-09T23:42:54.9019853Z +                        "Failed to open table: {}",
2025-11-09T23:42:54.9019963Z +                        e
2025-11-09T23:42:54.9020068Z +                    ))));
2025-11-09T23:42:54.9020177Z                  }
2025-11-09T23:42:54.9020819Z              };
2025-11-09T23:42:54.9020943Z -            
2025-11-09T23:42:54.9021054Z +
2025-11-09T23:42:54.9021263Z              let items: Vec<Result<(Vec<u8>, Vec<u8>)>> = table
2025-11-09T23:42:54.9021385Z                  .iter()
2025-11-09T23:42:54.9021504Z                  .map(|item| {
2025-11-09T23:42:54.9021950Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:392:
2025-11-09T23:42:54.9022197Z                          .map_err(|e| anyhow::anyhow!("Redb iteration error: {}", e))
2025-11-09T23:42:54.9022303Z                  })
2025-11-09T23:42:54.9022662Z                  .collect();
2025-11-09T23:42:54.9022772Z -            
2025-11-09T23:42:54.9022882Z +
2025-11-09T23:42:54.9023035Z              Box::new(items.into_iter())
2025-11-09T23:42:54.9023154Z          }
2025-11-09T23:42:54.9023266Z      }
2025-11-09T23:42:54.9023752Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:399:
2025-11-09T23:42:54.9023885Z  }
2025-11-09T23:42:54.9023997Z -
2025-11-09T23:42:54.9024111Z  
2025-11-09T23:42:54.9033794Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:4:
2025-11-09T23:42:54.9035181Z  //! Supports multiple database backends via feature flags (sled, redb).
2025-11-09T23:42:54.9035941Z  
2025-11-09T23:42:54.9038302Z  pub mod blockstore;
2025-11-09T23:42:54.9038724Z +pub mod chainstate;
2025-11-09T23:42:54.9038911Z  #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.9039071Z  pub mod commitment_store;
2025-11-09T23:42:54.9039220Z -pub mod chainstate;
2025-11-09T23:42:54.9039363Z  pub mod database;
2025-11-09T23:42:54.9039491Z  pub mod hashing;
2025-11-09T23:42:54.9040159Z  pub mod pruning;
2025-11-09T23:42:54.9040663Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:13:
2025-11-09T23:42:54.9040798Z  pub mod txindex;
2025-11-09T23:42:54.9040928Z  pub mod utxostore;
2025-11-09T23:42:54.9041052Z  
2025-11-09T23:42:54.9041328Z +use crate::config::PruningConfig;
2025-11-09T23:42:54.9041747Z  use anyhow::Result;
2025-11-09T23:42:54.9042222Z  use database::{create_database, default_backend, fallback_backend, Database, DatabaseBackend};
2025-11-09T23:42:54.9042373Z  use std::path::Path;
2025-11-09T23:42:54.9042842Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:19:
2025-11-09T23:42:54.9042982Z  use std::sync::Arc;
2025-11-09T23:42:54.9043128Z -use tracing::{warn, info};
2025-11-09T23:42:54.9043301Z -use crate::config::PruningConfig;
2025-11-09T23:42:54.9043451Z +use tracing::{info, warn};
2025-11-09T23:42:54.9043577Z  
2025-11-09T23:42:54.9043833Z  /// Storage manager that coordinates all storage operations
2025-11-09T23:42:54.9043984Z  pub struct Storage {
2025-11-09T23:42:54.9044623Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:32:
2025-11-09T23:42:54.9044747Z  
2025-11-09T23:42:54.9044877Z  impl Storage {
2025-11-09T23:42:54.9045088Z      /// Create a new storage instance with default backend
2025-11-09T23:42:54.9045214Z -    /// 
2025-11-09T23:42:54.9045328Z +    ///
2025-11-09T23:42:54.9045632Z      /// Attempts to use the default backend (redb), and gracefully falls back
2025-11-09T23:42:54.9045823Z      /// to sled if redb fails and sled is available.
2025-11-09T23:42:54.9046064Z      pub fn new<P: AsRef<Path>>(data_dir: P) -> Result<Self> {
2025-11-09T23:42:54.9046524Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:39:
2025-11-09T23:42:54.9046690Z          let default = default_backend();
2025-11-09T23:42:54.9046816Z -        
2025-11-09T23:42:54.9046934Z +
2025-11-09T23:42:54.9047092Z          // Try default backend first
2025-11-09T23:42:54.9047335Z          match Self::with_backend(data_dir.as_ref(), default) {
2025-11-09T23:42:54.9047490Z              Ok(storage) => Ok(storage),
2025-11-09T23:42:54.9047944Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:44:
2025-11-09T23:42:54.9048087Z              Err(e) => {
2025-11-09T23:42:54.9048271Z                  // If default backend fails, try fallback
2025-11-09T23:42:54.9048536Z                  if let Some(fallback_backend) = fallback_backend(default) {
2025-11-09T23:42:54.9048990Z -                    warn!("Failed to initialize {:?} backend: {}. Falling back to {:?}.", default, e, fallback_backend);
2025-11-09T23:42:54.9049424Z -                    info!("Attempting to initialize storage with fallback backend: {:?}", fallback_backend);
2025-11-09T23:42:54.9049560Z +                    warn!(
2025-11-09T23:42:54.9050076Z +                        "Failed to initialize {:?} backend: {}. Falling back to {:?}.",
2025-11-09T23:42:54.9050253Z +                        default, e, fallback_backend
2025-11-09T23:42:54.9050381Z +                    );
2025-11-09T23:42:54.9050509Z +                    info!(
2025-11-09T23:42:54.9050805Z +                        "Attempting to initialize storage with fallback backend: {:?}",
2025-11-09T23:42:54.9050946Z +                        fallback_backend
2025-11-09T23:42:54.9051064Z +                    );
2025-11-09T23:42:54.9051263Z                      Self::with_backend(data_dir, fallback_backend)
2025-11-09T23:42:54.9051377Z                  } else {
2025-11-09T23:42:54.9051537Z                      Err(anyhow::anyhow!(
2025-11-09T23:42:54.9052061Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:52:
2025-11-09T23:42:54.9052398Z                          "Failed to initialize {:?} backend: {}. No fallback backend available.",
2025-11-09T23:42:54.9052556Z -                        default, e
2025-11-09T23:42:54.9052689Z +                        default,
2025-11-09T23:42:54.9052811Z +                        e
2025-11-09T23:42:54.9052932Z                      ))
2025-11-09T23:42:54.9053058Z                  }
2025-11-09T23:42:54.9053173Z              }
2025-11-09T23:42:54.9053624Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:145:
2025-11-09T23:42:54.9054071Z      pub fn flush(&self) -> Result<()> {
2025-11-09T23:42:54.9054212Z          self.db.flush()
2025-11-09T23:42:54.9054489Z      }
2025-11-09T23:42:54.9054608Z -    
2025-11-09T23:42:54.9054730Z +
2025-11-09T23:42:54.9054976Z      /// Get approximate disk size used by storage (in bytes)
2025-11-09T23:42:54.9055090Z -    /// 
2025-11-09T23:42:54.9057150Z +    ///
2025-11-09T23:42:54.9057446Z      /// Returns an estimate based on tree sizes. If any operation fails,
2025-11-09T23:42:54.9057639Z      /// returns 0 gracefully rather than erroring.
2025-11-09T23:42:54.9057846Z      /// Includes bounds checking to prevent overflow.
2025-11-09T23:42:54.9058291Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:154:
2025-11-09T23:42:54.9058453Z      pub fn disk_size(&self) -> Result<u64> {
2025-11-09T23:42:54.9058728Z          // Estimate based on tree sizes (graceful degradation if counts fail)
2025-11-09T23:42:54.9058876Z          let mut size = 0u64;
2025-11-09T23:42:54.9059004Z -        
2025-11-09T23:42:54.9059118Z +
2025-11-09T23:42:54.9059439Z          // Block size estimate (gracefully handle errors, with bounds checking)
2025-11-09T23:42:54.9059663Z          if let Ok(count) = self.blockstore.block_count() {
2025-11-09T23:42:54.9059943Z              const MAX_BLOCKS: u64 = 10_000_000; // 10M blocks max (safety limit)
2025-11-09T23:42:54.9060369Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:162:
2025-11-09T23:42:54.9060606Z              const BYTES_PER_BLOCK: u64 = 1_024_000; // ~1MB per block
2025-11-09T23:42:54.9060935Z              size = size.saturating_add(safe_count.saturating_mul(BYTES_PER_BLOCK));
2025-11-09T23:42:54.9061043Z          }
2025-11-09T23:42:54.9061163Z -        
2025-11-09T23:42:54.9061266Z +
2025-11-09T23:42:54.9061550Z          // UTXO size estimate (gracefully handle errors, with bounds checking)
2025-11-09T23:42:54.9061758Z          if let Ok(count) = self.utxostore.utxo_count() {
2025-11-09T23:42:54.9062046Z              const MAX_UTXOS: u64 = 1_000_000_000; // 1B UTXOs max (safety limit)
2025-11-09T23:42:54.9062484Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:170:
2025-11-09T23:42:54.9062703Z              const BYTES_PER_UTXO: u64 = 100; // ~100 bytes per UTXO
2025-11-09T23:42:54.9063005Z              size = size.saturating_add(safe_count.saturating_mul(BYTES_PER_UTXO));
2025-11-09T23:42:54.9063107Z          }
2025-11-09T23:42:54.9063206Z -        
2025-11-09T23:42:54.9063314Z +
2025-11-09T23:42:54.9063884Z          // Transaction size estimate (gracefully handle errors, with bounds checking)
2025-11-09T23:42:54.9064096Z          if let Ok(count) = self.txindex.transaction_count() {
2025-11-09T23:42:54.9064510Z              const MAX_TXS: u64 = 1_000_000_000; // 1B transactions max (safety limit)
2025-11-09T23:42:54.9066809Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:178:
2025-11-09T23:42:54.9067078Z              const BYTES_PER_TX: u64 = 500; // ~500 bytes per transaction
2025-11-09T23:42:54.9067389Z              size = size.saturating_add(safe_count.saturating_mul(BYTES_PER_TX));
2025-11-09T23:42:54.9067513Z          }
2025-11-09T23:42:54.9067628Z -        
2025-11-09T23:42:54.9067736Z +
2025-11-09T23:42:54.9068005Z          // Final bounds check: prevent returning unrealistic values
2025-11-09T23:42:54.9068295Z          const MAX_DISK_SIZE: u64 = 10_000_000_000_000; // 10TB max (safety limit)
2025-11-09T23:42:54.9068448Z          Ok(size.min(MAX_DISK_SIZE))
2025-11-09T23:42:54.9068907Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:185:
2025-11-09T23:42:54.9069027Z      }
2025-11-09T23:42:54.9069135Z -    
2025-11-09T23:42:54.9069247Z +
2025-11-09T23:42:54.9069427Z      /// Check storage bounds before operations
2025-11-09T23:42:54.9069765Z      /// Returns true if storage is within safe bounds, false if approaching limits
2025-11-09T23:42:54.9070230Z      pub fn check_storage_bounds(&self) -> Result<bool> {
2025-11-09T23:42:54.9070687Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:190:
2025-11-09T23:42:54.9070908Z          const MAX_BLOCKS: usize = 10_000_000; // 10M blocks
2025-11-09T23:42:54.9071104Z          const MAX_UTXOS: usize = 1_000_000_000; // 1B UTXOs
2025-11-09T23:42:54.9071327Z          const MAX_TXS: usize = 1_000_000_000; // 1B transactions
2025-11-09T23:42:54.9071454Z -        
2025-11-09T23:42:54.9071569Z +
2025-11-09T23:42:54.9071840Z          let block_count = self.blockstore.block_count().unwrap_or(0);
2025-11-09T23:42:54.9072107Z          let utxo_count = self.utxostore.utxo_count().unwrap_or(0);
2025-11-09T23:42:54.9072370Z          let tx_count = self.txindex.transaction_count().unwrap_or(0);
2025-11-09T23:42:54.9072826Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:197:
2025-11-09T23:42:54.9072948Z -        
2025-11-09T23:42:54.9073068Z +
2025-11-09T23:42:54.9073290Z          // Check if we're approaching limits (80% threshold)
2025-11-09T23:42:54.9073502Z          let blocks_ok = block_count < (MAX_BLOCKS * 8 / 10);
2025-11-09T23:42:54.9073702Z          let utxos_ok = utxo_count < (MAX_UTXOS * 8 / 10);
2025-11-09T23:42:54.9074118Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:201:
2025-11-09T23:42:54.9074279Z          let txs_ok = tx_count < (MAX_TXS * 8 / 10);
2025-11-09T23:42:54.9074568Z -        
2025-11-09T23:42:54.9074677Z +
2025-11-09T23:42:54.9074811Z          if !blocks_ok {
2025-11-09T23:42:54.9075238Z -            warn!("Storage bounds: block count ({}) approaching limit ({})", block_count, MAX_BLOCKS);
2025-11-09T23:42:54.9075370Z +            warn!(
2025-11-09T23:42:54.9075633Z +                "Storage bounds: block count ({}) approaching limit ({})",
2025-11-09T23:42:54.9075790Z +                block_count, MAX_BLOCKS
2025-11-09T23:42:54.9075919Z +            );
2025-11-09T23:42:54.9076041Z          }
2025-11-09T23:42:54.9076169Z          if !utxos_ok {
2025-11-09T23:42:54.9076551Z -            warn!("Storage bounds: UTXO count ({}) approaching limit ({})", utxo_count, MAX_UTXOS);
2025-11-09T23:42:54.9076674Z +            warn!(
2025-11-09T23:42:54.9076922Z +                "Storage bounds: UTXO count ({}) approaching limit ({})",
2025-11-09T23:42:54.9077063Z +                utxo_count, MAX_UTXOS
2025-11-09T23:42:54.9077182Z +            );
2025-11-09T23:42:54.9077287Z          }
2025-11-09T23:42:54.9077401Z          if !txs_ok {
2025-11-09T23:42:54.9077779Z -            warn!("Storage bounds: transaction count ({}) approaching limit ({})", tx_count, MAX_TXS);
2025-11-09T23:42:54.9078111Z +            warn!(
2025-11-09T23:42:54.9078381Z +                "Storage bounds: transaction count ({}) approaching limit ({})",
2025-11-09T23:42:54.9078506Z +                tx_count, MAX_TXS
2025-11-09T23:42:54.9078615Z +            );
2025-11-09T23:42:54.9078716Z          }
2025-11-09T23:42:54.9078830Z -        
2025-11-09T23:42:54.9078942Z +
2025-11-09T23:42:54.9079114Z          Ok(blocks_ok && utxos_ok && txs_ok)
2025-11-09T23:42:54.9079238Z      }
2025-11-09T23:42:54.9079350Z -    
2025-11-09T23:42:54.9079465Z +
2025-11-09T23:42:54.9079626Z      /// Get transaction count from txindex
2025-11-09T23:42:54.9079842Z      pub fn transaction_count(&self) -> Result<usize> {
2025-11-09T23:42:54.9080010Z          self.txindex.transaction_count()
2025-11-09T23:42:54.9122293Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:7:
2025-11-09T23:42:54.9122808Z  //! - Custom: Fine-grained control over what to keep
2025-11-09T23:42:54.9122927Z  
2025-11-09T23:42:54.9123221Z  use crate::config::{PruningConfig, PruningMode};
2025-11-09T23:42:54.9123369Z +#[cfg(feature = "bip158")]
2025-11-09T23:42:54.9123622Z +use crate::network::filter_service::BlockFilterService;
2025-11-09T23:42:54.9123807Z  use crate::storage::blockstore::BlockStore;
2025-11-09T23:42:54.9123969Z  #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.9124680Z  use crate::storage::commitment_store::CommitmentStore;
2025-11-09T23:42:54.9125149Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:13:
2025-11-09T23:42:54.9125304Z  #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.9125475Z  use crate::storage::utxostore::UtxoStore;
2025-11-09T23:42:54.9125619Z -#[cfg(feature = "bip158")]
2025-11-09T23:42:54.9125858Z -use crate::network::filter_service::BlockFilterService;
2025-11-09T23:42:54.9126010Z  use anyhow::{anyhow, Result};
2025-11-09T23:42:54.9126183Z  #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.9126330Z  use bllvm_protocol::Hash;
2025-11-09T23:42:54.9126787Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:89:
2025-11-09T23:42:54.9126944Z      pub fn with_features(
2025-11-09T23:42:54.9127093Z          config: PruningConfig,
2025-11-09T23:42:54.9127248Z          blockstore: Arc<BlockStore>,
2025-11-09T23:42:54.9127430Z -        #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.9127663Z -        commitment_store: Option<Arc<CommitmentStore>>,
2025-11-09T23:42:54.9127831Z -        #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.9128004Z -        utxostore: Option<Arc<UtxoStore>>,
2025-11-09T23:42:54.9128162Z -        #[cfg(feature = "bip158")]
2025-11-09T23:42:54.9128385Z -        filter_service: Option<Arc<BlockFilterService>>,
2025-11-09T23:42:54.9128779Z +        #[cfg(feature = "utxo-commitments")] commitment_store: Option<Arc<CommitmentStore>>,
2025-11-09T23:42:54.9129103Z +        #[cfg(feature = "utxo-commitments")] utxostore: Option<Arc<UtxoStore>>,
2025-11-09T23:42:54.9129445Z +        #[cfg(feature = "bip158")] filter_service: Option<Arc<BlockFilterService>>,
2025-11-09T23:42:54.9129569Z      ) -> Self {
2025-11-09T23:42:54.9129688Z          Self {
2025-11-09T23:42:54.9129814Z              config,
2025-11-09T23:42:54.9130292Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:153:
2025-11-09T23:42:54.9130412Z          {
2025-11-09T23:42:54.9130606Z              // Check if UTXO commitments are available
2025-11-09T23:42:54.9130996Z              let has_commitments = self.commitment_store.is_some() && self.utxostore.is_some();
2025-11-09T23:42:54.9131114Z -            
2025-11-09T23:42:54.9131229Z +
2025-11-09T23:42:54.9131444Z              // Check if mode supports incremental pruning
2025-11-09T23:42:54.9131607Z              let mode_supports = matches!(
2025-11-09T23:42:54.9131749Z                  &self.config.mode,
2025-11-09T23:42:54.9132507Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:160:
2025-11-09T23:42:54.9132928Z -                PruningMode::Aggressive { .. } | PruningMode::Custom { keep_commitments: true, .. }
2025-11-09T23:42:54.9133110Z +                PruningMode::Aggressive { .. }
2025-11-09T23:42:54.9133280Z +                    | PruningMode::Custom {
2025-11-09T23:42:54.9133442Z +                        keep_commitments: true,
2025-11-09T23:42:54.9133574Z +                        ..
2025-11-09T23:42:54.9133694Z +                    }
2025-11-09T23:42:54.9133812Z              );
2025-11-09T23:42:54.9133929Z -            
2025-11-09T23:42:54.9134040Z +
2025-11-09T23:42:54.9134212Z              has_commitments && mode_supports
2025-11-09T23:42:54.9134545Z          }
2025-11-09T23:42:54.9134737Z          #[cfg(not(feature = "utxo-commitments"))]
2025-11-09T23:42:54.9136749Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:169:
2025-11-09T23:42:54.9136884Z      }
2025-11-09T23:42:54.9136995Z  
2025-11-09T23:42:54.9137154Z      /// Incremental prune during IBD
2025-11-09T23:42:54.9137278Z -    /// 
2025-11-09T23:42:54.9137393Z +    ///
2025-11-09T23:42:54.9137765Z      /// This method prunes old blocks while keeping a sliding window of recent blocks.
2025-11-09T23:42:54.9138151Z      /// It's designed to be called periodically during IBD to prevent storage from growing
2025-11-09T23:42:54.9138762Z      /// unbounded. Only works when incremental_prune_during_ibd is enabled and UTXO
2025-11-09T23:42:54.9139247Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:203:
2025-11-09T23:42:54.9139365Z  
2025-11-09T23:42:54.9139697Z          // Calculate prune height: keep only the last prune_window_size blocks
2025-11-09T23:42:54.9140108Z          let prune_to_height = current_height.saturating_sub(self.config.prune_window_size);
2025-11-09T23:42:54.9140225Z -        
2025-11-09T23:42:54.9140351Z +
2025-11-09T23:42:54.9140602Z          // Don't prune if window size is larger than current height
2025-11-09T23:42:54.9140867Z          if prune_to_height == 0 || prune_to_height >= current_height {
2025-11-09T23:42:54.9141006Z              return Ok(None);
2025-11-09T23:42:54.9141497Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:245:
2025-11-09T23:42:54.9141705Z              // 1. Incremental pruning is explicitly enabled
2025-11-09T23:42:54.9141979Z              // 2. UTXO commitments are available (for state verification)
2025-11-09T23:42:54.9142226Z              // 3. Aggressive or Custom mode with commitments enabled
2025-11-09T23:42:54.9142561Z -            let can_incremental_prune = self.config.incremental_prune_during_ibd
2025-11-09T23:42:54.9142756Z -                && self.can_incremental_prune_during_ibd();
2025-11-09T23:42:54.9143038Z -            
2025-11-09T23:42:54.9143197Z +            let can_incremental_prune =
2025-11-09T23:42:54.9143619Z +                self.config.incremental_prune_during_ibd && self.can_incremental_prune_during_ibd();
2025-11-09T23:42:54.9143742Z +
2025-11-09T23:42:54.9143897Z              if !can_incremental_prune {
2025-11-09T23:42:54.9146165Z                  return Err(anyhow!(
2025-11-09T23:42:54.9146878Z                      "Cannot prune during initial block download. Wait for IBD to complete, or enable incremental_prune_during_ibd with UTXO commitments."
2025-11-09T23:42:54.9147373Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:254:
2025-11-09T23:42:54.9147501Z                  ));
2025-11-09T23:42:54.9147624Z              }
2025-11-09T23:42:54.9147747Z -            
2025-11-09T23:42:54.9148344Z +
2025-11-09T23:42:54.9148673Z              // For incremental pruning during IBD, ensure we have enough blocks
2025-11-09T23:42:54.9148991Z              if current_height < self.config.min_blocks_for_incremental_prune {
2025-11-09T23:42:54.9149146Z                  return Err(anyhow!(
2025-11-09T23:42:54.9149896Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:295:
2025-11-09T23:42:54.9150508Z              PruningMode::Normal {
2025-11-09T23:42:54.9150677Z                  keep_from_height,
2025-11-09T23:42:54.9150822Z                  min_recent_blocks,
2025-11-09T23:42:54.9151280Z -            } => self.prune_normal(prune_to_height, current_height, *keep_from_height, *min_recent_blocks)?,
2025-11-09T23:42:54.9151438Z +            } => self.prune_normal(
2025-11-09T23:42:54.9151567Z +                prune_to_height,
2025-11-09T23:42:54.9151694Z +                current_height,
2025-11-09T23:42:54.9151822Z +                *keep_from_height,
2025-11-09T23:42:54.9151955Z +                *min_recent_blocks,
2025-11-09T23:42:54.9152062Z +            )?,
2025-11-09T23:42:54.9152218Z              PruningMode::Aggressive {
2025-11-09T23:42:54.9152355Z                  keep_from_height,
2025-11-09T23:42:54.9152488Z                  keep_commitments,
2025-11-09T23:42:54.9152971Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:370:
2025-11-09T23:42:54.9153155Z          let mut stats = PruningStats::default();
2025-11-09T23:42:54.9153272Z  
2025-11-09T23:42:54.9153632Z          // Calculate actual keep height (max of keep_from_height and min_recent_blocks)
2025-11-09T23:42:54.9153847Z -        let effective_keep_height = keep_from_height.max(
2025-11-09T23:42:54.9156847Z -            current_height.saturating_sub(min_recent_blocks)
2025-11-09T23:42:54.9156974Z -        );
2025-11-09T23:42:54.9157135Z +        let effective_keep_height =
2025-11-09T23:42:54.9157493Z +            keep_from_height.max(current_height.saturating_sub(min_recent_blocks));
2025-11-09T23:42:54.9157674Z  
2025-11-09T23:42:54.9157912Z          // Ensure we don't prune below effective keep height
2025-11-09T23:42:54.9158244Z          let actual_prune_height = prune_to_height.min(effective_keep_height);
2025-11-09T23:42:54.9158753Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:415:
2025-11-09T23:42:54.9158972Z          let mut stats = PruningStats::default();
2025-11-09T23:42:54.9159086Z  
2025-11-09T23:42:54.9159261Z          // Calculate effective keep height
2025-11-09T23:42:54.9159480Z -        let effective_keep_height = keep_from_height.max(
2025-11-09T23:42:54.9159670Z -            current_height.saturating_sub(min_blocks)
2025-11-09T23:42:54.9159808Z -        );
2025-11-09T23:42:54.9160260Z +        let effective_keep_height = keep_from_height.max(current_height.saturating_sub(min_blocks));
2025-11-09T23:42:54.9160376Z  
2025-11-09T23:42:54.9160696Z          let actual_prune_height = prune_to_height.min(effective_keep_height);
2025-11-09T23:42:54.9160818Z  
2025-11-09T23:42:54.9161300Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:428:
2025-11-09T23:42:54.9161414Z  
2025-11-09T23:42:54.9161652Z          // Generate UTXO commitments before pruning if enabled
2025-11-09T23:42:54.9161809Z          if keep_commitments {
2025-11-09T23:42:54.9162061Z -            if let (Some(ref commitment_store), Some(ref utxostore)) = 
2025-11-09T23:42:54.9162334Z -                (self.commitment_store.as_ref(), self.utxostore.as_ref()) 
2025-11-09T23:42:54.9162584Z +            if let (Some(ref commitment_store), Some(ref utxostore)) =
2025-11-09T23:42:54.9162844Z +                (self.commitment_store.as_ref(), self.utxostore.as_ref())
2025-11-09T23:42:54.9162969Z              {
2025-11-09T23:42:54.9163267Z                  info!("Generating UTXO commitments for blocks to be pruned...");
2025-11-09T23:42:54.9163459Z                  self.generate_commitments_before_prune(
2025-11-09T23:42:54.9163922Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:439:
2025-11-09T23:42:54.9164066Z                      utxostore,
2025-11-09T23:42:54.9164183Z                  )?;
2025-11-09T23:42:54.9164547Z              } else {
2025-11-09T23:42:54.9165275Z -                warn!("UTXO commitments requested but commitment store or UTXO store not available");
2025-11-09T23:42:54.9165420Z +                warn!(
2025-11-09T23:42:54.9165809Z +                    "UTXO commitments requested but commitment store or UTXO store not available"
2025-11-09T23:42:54.9165926Z +                );
2025-11-09T23:42:54.9166046Z              }
2025-11-09T23:42:54.9166157Z          }
2025-11-09T23:42:54.9166270Z  
2025-11-09T23:42:54.9168511Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:464:
2025-11-09T23:42:54.9168734Z                      // Remove filter from cache but keep filter header
2025-11-09T23:42:54.9168907Z                      if filter_service.has_filter(&hash) {
2025-11-09T23:42:54.9169149Z                          filter_service.remove_filter_for_pruned_block(&hash)?;
2025-11-09T23:42:54.9169544Z -                        debug!("Removed BIP158 filter for pruned block at height {} (header kept)", height);
2025-11-09T23:42:54.9169687Z +                        debug!(
2025-11-09T23:42:54.9170007Z +                            "Removed BIP158 filter for pruned block at height {} (header kept)",
2025-11-09T23:42:54.9170137Z +                            height
2025-11-09T23:42:54.9170255Z +                        );
2025-11-09T23:42:54.9170369Z                      }
2025-11-09T23:42:54.9170487Z                  }
2025-11-09T23:42:54.9170824Z              }
2025-11-09T23:42:54.9171314Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:524:
2025-11-09T23:42:54.9171472Z                  if keep_commitments {
2025-11-09T23:42:54.9171663Z                      #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.9171786Z                      {
2025-11-09T23:42:54.9172052Z -                        if let (Some(ref commitment_store), Some(ref utxostore)) = 
2025-11-09T23:42:54.9172336Z -                            (self.commitment_store.as_ref(), self.utxostore.as_ref()) 
2025-11-09T23:42:54.9173087Z +                        if let (Some(ref commitment_store), Some(ref utxostore)) =
2025-11-09T23:42:54.9173396Z +                            (self.commitment_store.as_ref(), self.utxostore.as_ref())
2025-11-09T23:42:54.9173535Z                          {
2025-11-09T23:42:54.9173724Z                              // Generate commitment if not exists
2025-11-09T23:42:54.9173935Z                              if !commitment_store.has_commitment(&hash)? {
2025-11-09T23:42:54.9174631Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:547:
2025-11-09T23:42:54.9174929Z                          // Filter headers are always kept for chain verification
2025-11-09T23:42:54.9175116Z                          if filter_service.has_filter(&hash) {
2025-11-09T23:42:54.9175378Z                              filter_service.remove_filter_for_pruned_block(&hash)?;
2025-11-09T23:42:54.9175798Z -                            debug!("Removed BIP158 filter for pruned block at height {} (header kept)", height);
2025-11-09T23:42:54.9177820Z +                            debug!(
2025-11-09T23:42:54.9178140Z +                                "Removed BIP158 filter for pruned block at height {} (header kept)",
2025-11-09T23:42:54.9178287Z +                                height
2025-11-09T23:42:54.9178416Z +                            );
2025-11-09T23:42:54.9178542Z                          }
2025-11-09T23:42:54.9178671Z                      }
2025-11-09T23:42:54.9178795Z                  }
2025-11-09T23:42:54.9179258Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:569:
2025-11-09T23:42:54.9179419Z          commitment_store: &CommitmentStore,
2025-11-09T23:42:54.9179562Z          utxostore: &UtxoStore,
2025-11-09T23:42:54.9179688Z      ) -> Result<()> {
2025-11-09T23:42:54.9179999Z -        info!("Generating UTXO commitments for heights 0..{}", prune_to_height);
2025-11-09T23:42:54.9180125Z +        info!(
2025-11-09T23:42:54.9180609Z +            "Generating UTXO commitments for heights 0..{}",
2025-11-09T23:42:54.9180755Z +            prune_to_height
2025-11-09T23:42:54.9180864Z +        );
2025-11-09T23:42:54.9180980Z  
2025-11-09T23:42:54.9181204Z          // For each block to be pruned, generate a commitment
2025-11-09T23:42:54.9181528Z          // We'll generate commitments at checkpoint intervals to save computation
2025-11-09T23:42:54.9182023Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:601:
2025-11-09T23:42:54.9182205Z          commitment_store: &CommitmentStore,
2025-11-09T23:42:54.9182345Z          utxostore: &UtxoStore,
2025-11-09T23:42:54.9182463Z      ) -> Result<()> {
2025-11-09T23:42:54.9182630Z -        #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.9182925Z -        use bllvm_protocol::utxo_commitments::merkle_tree::UtxoMerkleTree;
2025-11-09T23:42:54.9183106Z          use bllvm_protocol::block::connect_block;
2025-11-09T23:42:54.9183275Z          use bllvm_protocol::segwit::Witness;
2025-11-09T23:42:54.9183430Z +        #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.9183718Z +        use bllvm_protocol::utxo_commitments::merkle_tree::UtxoMerkleTree;
2025-11-09T23:42:54.9183829Z  
2025-11-09T23:42:54.9184112Z          // Reconstruct UTXO set at historical height by replaying blocks
2025-11-09T23:42:54.9184597Z          let utxo_set = self.reconstruct_utxo_set_at_height(height, utxostore)?;
2025-11-09T23:42:54.9186566Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:614:
2025-11-09T23:42:54.9186923Z              .map_err(|e| anyhow::anyhow!("Failed to create UTXO Merkle tree: {:?}", e))?;
2025-11-09T23:42:54.9187038Z  
2025-11-09T23:42:54.9187193Z          for (outpoint, utxo) in &utxo_set {
2025-11-09T23:42:54.9187390Z -            utxo_tree.insert(*outpoint, utxo.clone())
2025-11-09T23:42:54.9187515Z +            utxo_tree
2025-11-09T23:42:54.9187680Z +                .insert(*outpoint, utxo.clone())
2025-11-09T23:42:54.9187974Z                  .map_err(|e| anyhow::anyhow!("Failed to insert UTXO: {:?}", e))?;
2025-11-09T23:42:54.9188094Z          }
2025-11-09T23:42:54.9188204Z  
2025-11-09T23:42:54.9188672Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:624:
2025-11-09T23:42:54.9188818Z          // Store commitment
2025-11-09T23:42:54.9189143Z          commitment_store.store_commitment(block_hash, height, &commitment)?;
2025-11-09T23:42:54.9189258Z  
2025-11-09T23:42:54.9189563Z -        debug!("Generated and stored commitment for height {} (hash: {})", 
2025-11-09T23:42:54.9189728Z -               height, hex::encode(block_hash));
2025-11-09T23:42:54.9189840Z +        debug!(
2025-11-09T23:42:54.9190089Z +            "Generated and stored commitment for height {} (hash: {})",
2025-11-09T23:42:54.9190217Z +            height,
2025-11-09T23:42:54.9190369Z +            hex::encode(block_hash)
2025-11-09T23:42:54.9190485Z +        );
2025-11-09T23:42:54.9190600Z  
2025-11-09T23:42:54.9190723Z          Ok(())
2025-11-09T23:42:54.9190836Z      }
2025-11-09T23:42:54.9191313Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:632:
2025-11-09T23:42:54.9191441Z  
2025-11-09T23:42:54.9191667Z      /// Generate UTXO commitment from current UTXO set state
2025-11-09T23:42:54.9191778Z -    /// 
2025-11-09T23:42:54.9191896Z +    ///
2025-11-09T23:42:54.9192319Z      /// This method generates a commitment from the current UTXO set without replaying blocks.
2025-11-09T23:42:54.9192697Z      /// Used during incremental sync when the UTXO set is maintained incrementally.
2025-11-09T23:42:54.9192825Z -    /// 
2025-11-09T23:42:54.9192943Z +    ///
2025-11-09T23:42:54.9193064Z      /// # Arguments
2025-11-09T23:42:54.9193279Z      /// * `block_hash` - Hash of the block at this height
2025-11-09T23:42:54.9193438Z      /// * `height` - Block height
2025-11-09T23:42:54.9193901Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:641:
2025-11-09T23:42:54.9196417Z      /// * `utxo_set` - Current UTXO set (from incremental updates)
2025-11-09T23:42:54.9196697Z      /// * `commitment_store` - Commitment store to save the commitment
2025-11-09T23:42:54.9196814Z -    /// 
2025-11-09T23:42:54.9196932Z +    ///
2025-11-09T23:42:54.9197049Z      /// # Returns
2025-11-09T23:42:54.9197219Z      /// Result indicating success or failure
2025-11-09T23:42:54.9197381Z      #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.9197847Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:658:
2025-11-09T23:42:54.9198198Z              .map_err(|e| anyhow::anyhow!("Failed to create UTXO Merkle tree: {:?}", e))?;
2025-11-09T23:42:54.9198306Z  
2025-11-09T23:42:54.9198460Z          for (outpoint, utxo) in utxo_set {
2025-11-09T23:42:54.9198648Z -            utxo_tree.insert(*outpoint, utxo.clone())
2025-11-09T23:42:54.9198756Z +            utxo_tree
2025-11-09T23:42:54.9198904Z +                .insert(*outpoint, utxo.clone())
2025-11-09T23:42:54.9199176Z                  .map_err(|e| anyhow::anyhow!("Failed to insert UTXO: {:?}", e))?;
2025-11-09T23:42:54.9199297Z          }
2025-11-09T23:42:54.9199397Z  
2025-11-09T23:42:54.9199818Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:668:
2025-11-09T23:42:54.9199956Z          // Store commitment
2025-11-09T23:42:54.9200261Z          commitment_store.store_commitment(block_hash, height, &commitment)?;
2025-11-09T23:42:54.9200584Z  
2025-11-09T23:42:54.9200924Z -        debug!("Generated commitment from current state for height {} (hash: {})", 
2025-11-09T23:42:54.9201097Z -               height, hex::encode(block_hash));
2025-11-09T23:42:54.9201208Z +        debug!(
2025-11-09T23:42:54.9201508Z +            "Generated commitment from current state for height {} (hash: {})",
2025-11-09T23:42:54.9201630Z +            height,
2025-11-09T23:42:54.9201773Z +            hex::encode(block_hash)
2025-11-09T23:42:54.9201893Z +        );
2025-11-09T23:42:54.9202009Z  
2025-11-09T23:42:54.9202121Z          Ok(())
2025-11-09T23:42:54.9202230Z      }
2025-11-09T23:42:54.9202746Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:676:
2025-11-09T23:42:54.9202864Z  
2025-11-09T23:42:54.9203103Z      /// Reconstruct UTXO set at a specific historical height
2025-11-09T23:42:54.9203222Z -    /// 
2025-11-09T23:42:54.9203340Z +    ///
2025-11-09T23:42:54.9203610Z      /// This function replays blocks from genesis to the target height
2025-11-09T23:42:54.9203845Z      /// to reconstruct the exact UTXO set at that point in history.
2025-11-09T23:42:54.9203998Z      #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.9206542Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:703:
2025-11-09T23:42:54.9206668Z                  // Get block
2025-11-09T23:42:54.9206928Z                  if let Some(block) = self.blockstore.get_block(&block_hash)? {
2025-11-09T23:42:54.9207099Z                      // Get witnesses for this block
2025-11-09T23:42:54.9207345Z -                    let witnesses = self.blockstore.get_witness(&block_hash)?
2025-11-09T23:42:54.9207502Z -                        .unwrap_or_else(|| {
2025-11-09T23:42:54.9207721Z -                            // If no witnesses stored, create empty witnesses
2025-11-09T23:42:54.9208000Z -                            block.transactions.iter().map(|_| Vec::new()).collect()
2025-11-09T23:42:54.9208133Z -                        });
2025-11-09T23:42:54.9208271Z +                    let witnesses =
2025-11-09T23:42:54.9208422Z +                        self.blockstore
2025-11-09T23:42:54.9208584Z +                            .get_witness(&block_hash)?
2025-11-09T23:42:54.9208736Z +                            .unwrap_or_else(|| {
2025-11-09T23:42:54.9208955Z +                                // If no witnesses stored, create empty witnesses
2025-11-09T23:42:54.9209207Z +                                block.transactions.iter().map(|_| Vec::new()).collect()
2025-11-09T23:42:54.9209624Z +                            });
2025-11-09T23:42:54.9209745Z  
2025-11-09T23:42:54.9209955Z                      // Apply block to UTXO set using connect_block
2025-11-09T23:42:54.9210315Z                      // This properly handles coinbase transactions and input/output processing
2025-11-09T23:42:54.9210807Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:714:
2025-11-09T23:42:54.9211088Z                      let (validation_result, new_utxo_set) = connect_block(
2025-11-09T23:42:54.9211223Z -                        &block,
2025-11-09T23:42:54.9211357Z -                        &witnesses,
2025-11-09T23:42:54.9211500Z -                        utxo_set,
2025-11-09T23:42:54.9211629Z -                        height,
2025-11-09T23:42:54.9211815Z +                        &block, &witnesses, utxo_set, height,
2025-11-09T23:42:54.9212075Z                          None, // No recent headers needed for historical replay
2025-11-09T23:42:54.9212210Z                      )?;
2025-11-09T23:42:54.9212324Z  
2025-11-09T23:42:54.9212812Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:722:
2025-11-09T23:42:54.9212987Z                      // Check validation result
2025-11-09T23:42:54.9213358Z                      if !matches!(validation_result, bllvm_protocol::ValidationResult::Valid) {
2025-11-09T23:42:54.9214278Z -                        warn!("Block at height {} failed validation during UTXO reconstruction", height);
2025-11-09T23:42:54.9214630Z +                        warn!(
2025-11-09T23:42:54.9214937Z +                            "Block at height {} failed validation during UTXO reconstruction",
2025-11-09T23:42:54.9215067Z +                            height
2025-11-09T23:42:54.9215193Z +                        );
2025-11-09T23:42:54.9215481Z                          // Continue anyway - this might be expected for some edge cases
2025-11-09T23:42:54.9215606Z                      }
2025-11-09T23:42:54.9215719Z  
2025-11-09T23:42:54.9216210Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:740:
2025-11-09T23:42:54.9216334Z              }
2025-11-09T23:42:54.9216448Z          }
2025-11-09T23:42:54.9217058Z  
2025-11-09T23:42:54.9217528Z -        debug!("Reconstructed UTXO set at height {} with {} UTXOs", target_height, utxo_set.len());
2025-11-09T23:42:54.9217667Z +        debug!(
2025-11-09T23:42:54.9217903Z +            "Reconstructed UTXO set at height {} with {} UTXOs",
2025-11-09T23:42:54.9218050Z +            target_height,
2025-11-09T23:42:54.9218182Z +            utxo_set.len()
2025-11-09T23:42:54.9218296Z +        );
2025-11-09T23:42:54.9218430Z          Ok(utxo_set)
2025-11-09T23:42:54.9218543Z      }
2025-11-09T23:42:54.9218655Z  }
2025-11-09T23:42:54.9219149Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:747:
2025-11-09T23:42:54.9219271Z -
2025-11-09T23:42:54.9219392Z  
2025-11-09T23:42:54.9219928Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/txindex.rs:2:
2025-11-09T23:42:54.9220054Z  //!
2025-11-09T23:42:54.9220450Z  //! Provides fast lookup of transactions by hash and maintains transaction metadata.
2025-11-09T23:42:54.9220563Z  
2025-11-09T23:42:54.9220783Z +use crate::storage::database::{Database, Tree};
2025-11-09T23:42:54.9220923Z  use anyhow::Result;
2025-11-09T23:42:54.9221109Z  use bllvm_protocol::{Hash, Transaction};
2025-11-09T23:42:54.9221292Z  use serde::{Deserialize, Serialize};
2025-11-09T23:42:54.9221783Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/txindex.rs:8:
2025-11-09T23:42:54.9221993Z -use crate::storage::database::{Database, Tree};
2025-11-09T23:42:54.9222128Z  use std::sync::Arc;
2025-11-09T23:42:54.9222251Z  
2025-11-09T23:42:54.9222392Z  /// Transaction metadata
2025-11-09T23:42:54.9222863Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/txindex.rs:68:
2025-11-09T23:42:54.9223245Z          };
2025-11-09T23:42:54.9223362Z  
2025-11-09T23:42:54.9223600Z          let metadata_data = bincode::serialize(&metadata)?;
2025-11-09T23:42:54.9223880Z -        self.tx_metadata.insert(tx_hash.as_slice(), &metadata_data)?;
2025-11-09T23:42:54.9224028Z +        self.tx_metadata
2025-11-09T23:42:54.9224232Z +            .insert(tx_hash.as_slice(), &metadata_data)?;
2025-11-09T23:42:54.9224538Z  
2025-11-09T23:42:54.9224685Z          // Index by block
2025-11-09T23:42:54.9224919Z          let block_key = self.block_tx_key(block_hash, tx_index);
2025-11-09T23:42:54.9225398Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/utxostore.rs:2:
2025-11-09T23:42:54.9225524Z  //!
2025-11-09T23:42:54.9225839Z  //! Stores and manages the UTXO set for efficient transaction validation.
2025-11-09T23:42:54.9225950Z  
2025-11-09T23:42:54.9226152Z +use crate::storage::database::{Database, Tree};
2025-11-09T23:42:54.9226302Z  use anyhow::Result;
2025-11-09T23:42:54.9226499Z  use bllvm_protocol::{OutPoint, UtxoSet, UTXO};
2025-11-09T23:42:54.9226678Z -use crate::storage::database::{Database, Tree};
2025-11-09T23:42:54.9226830Z  use std::collections::HashMap;
2025-11-09T23:42:54.9226950Z  use std::sync::Arc;
2025-11-09T23:42:54.9227055Z  
2025-11-09T23:42:54.9227504Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/validation/mod.rs:51:
2025-11-09T23:42:54.9227901Z          context: &BlockValidationContext,
2025-11-09T23:42:54.9228069Z      ) -> Result<(ValidationResult, UtxoSet)> {
2025-11-09T23:42:54.9228250Z          // Create empty witnesses for each transaction
2025-11-09T23:42:54.9228711Z -        let witnesses: Vec<Witness> = context.block.transactions.iter().map(|_| Vec::new()).collect();
2025-11-09T23:42:54.9228876Z +        let witnesses: Vec<Witness> = context
2025-11-09T23:42:54.9228996Z +            .block
2025-11-09T23:42:54.9229132Z +            .transactions
2025-11-09T23:42:54.9229248Z +            .iter()
2025-11-09T23:42:54.9229397Z +            .map(|_| Vec::new())
2025-11-09T23:42:54.9229522Z +            .collect();
2025-11-09T23:42:54.9229659Z          connect_block(
2025-11-09T23:42:54.9229791Z              &context.block,
2025-11-09T23:42:54.9229913Z              &witnesses,
2025-11-09T23:42:54.9230383Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/validation/mod.rs:87:
2025-11-09T23:42:54.9230512Z              .par_iter()
2025-11-09T23:42:54.9230658Z              .map(|context| {
2025-11-09T23:42:54.9230858Z                  // Create empty witnesses for each transaction
2025-11-09T23:42:54.9231337Z -                let witnesses: Vec<Witness> = context.block.transactions.iter().map(|_| Vec::new()).collect();
2025-11-09T23:42:54.9231519Z +                let witnesses: Vec<Witness> = context
2025-11-09T23:42:54.9231642Z +                    .block
2025-11-09T23:42:54.9231783Z +                    .transactions
2025-11-09T23:42:54.9231907Z +                    .iter()
2025-11-09T23:42:54.9232070Z +                    .map(|_| Vec::new())
2025-11-09T23:42:54.9232208Z +                    .collect();
2025-11-09T23:42:54.9232341Z                  connect_block(
2025-11-09T23:42:54.9232577Z error[internal]: left behind trailing whitespace
2025-11-09T23:42:54.9233015Z   --> /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:91:91:1
2025-11-09T23:42:54.9233140Z    |
2025-11-09T23:42:54.9233270Z 91 |                 
2025-11-09T23:42:54.9233384Z    | ^^^^^^^^^^^^^^^^
2025-11-09T23:42:54.9233499Z    |
2025-11-09T23:42:54.9233512Z 
2025-11-09T23:42:54.9233789Z warning: rustfmt has failed to format. See previous 1 errors.
2025-11-09T23:42:54.9233802Z 
2025-11-09T23:42:54.9233942Z                      &context.block,
2025-11-09T23:42:54.9234082Z                      &witnesses,
2025-11-09T23:42:54.9234762Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/validation/mod.rs:116:
2025-11-09T23:42:54.9234883Z  
2025-11-09T23:42:54.9235043Z          for context in contexts {
2025-11-09T23:42:54.9235527Z              // Create empty witnesses for each transaction
2025-11-09T23:42:54.9236143Z -            let witnesses: Vec<Witness> = context.block.transactions.iter().map(|_| Vec::new()).collect();
2025-11-09T23:42:54.9236321Z +            let witnesses: Vec<Witness> = context
2025-11-09T23:42:54.9236445Z +                .block
2025-11-09T23:42:54.9236594Z +                .transactions
2025-11-09T23:42:54.9236732Z +                .iter()
2025-11-09T23:42:54.9236882Z +                .map(|_| Vec::new())
2025-11-09T23:42:54.9237019Z +                .collect();
2025-11-09T23:42:54.9237172Z              let result = connect_block(
2025-11-09T23:42:54.9237312Z                  &context.block,
2025-11-09T23:42:54.9237441Z                  &witnesses,
2025-11-09T23:42:54.9237970Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:9:
2025-11-09T23:42:54.9238136Z  async fn test_request_id_matching() {
2025-11-09T23:42:54.9238387Z      // Test that requests are matched by request_id, not FIFO
2025-11-09T23:42:54.9238711Z      let manager = NetworkManager::new(TransportPreference::TcpOnly);
2025-11-09T23:42:54.9238829Z -    
2025-11-09T23:42:54.9238945Z +
2025-11-09T23:42:54.9239210Z      let peer_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:42:54.9239340Z -    
2025-11-09T23:42:54.9239454Z +
2025-11-09T23:42:54.9239834Z      // Register multiple requests
2025-11-09T23:42:54.9240067Z      let (id1, rx1) = manager.register_request(peer_addr);
2025-11-09T23:42:54.9240277Z      let (id2, rx2) = manager.register_request(peer_addr);
2025-11-09T23:42:54.9240800Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:18:
2025-11-09T23:42:54.9241016Z      let (id3, rx3) = manager.register_request(peer_addr);
2025-11-09T23:42:54.9241130Z -    
2025-11-09T23:42:54.9241243Z +
2025-11-09T23:42:54.9241401Z      // Complete requests out of order
2025-11-09T23:42:54.9241566Z      let response2 = vec![2, 2, 2];
2025-11-09T23:42:54.9241708Z      let response1 = vec![1, 1, 1];
2025-11-09T23:42:54.9242225Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:23:
2025-11-09T23:42:54.9242380Z      let response3 = vec![3, 3, 3];
2025-11-09T23:42:54.9242496Z -    
2025-11-09T23:42:54.9242608Z +
2025-11-09T23:42:54.9242863Z      assert!(manager.complete_request(id2, response2.clone()));
2025-11-09T23:42:54.9243119Z      assert!(manager.complete_request(id1, response1.clone()));
2025-11-09T23:42:54.9243364Z      assert!(manager.complete_request(id3, response3.clone()));
2025-11-09T23:42:54.9243857Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:28:
2025-11-09T23:42:54.9243983Z -    
2025-11-09T23:42:54.9244096Z +
2025-11-09T23:42:54.9244580Z      // Verify each receiver got the correct response
2025-11-09T23:42:54.9244729Z      tokio::select! {
2025-11-09T23:42:54.9244869Z          result = rx1 => {
2025-11-09T23:42:54.9245388Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:35:
2025-11-09T23:42:54.9245540Z              panic!("Request 1 timeout");
2025-11-09T23:42:54.9245659Z          }
2025-11-09T23:42:54.9245772Z      }
2025-11-09T23:42:54.9245880Z -    
2025-11-09T23:42:54.9245995Z +
2025-11-09T23:42:54.9246128Z      tokio::select! {
2025-11-09T23:42:54.9246266Z          result = rx2 => {
2025-11-09T23:42:54.9246457Z              assert_eq!(result.unwrap(), response2);
2025-11-09T23:42:54.9246982Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:44:
2025-11-09T23:42:54.9247145Z              panic!("Request 2 timeout");
2025-11-09T23:42:54.9247262Z          }
2025-11-09T23:42:54.9247373Z      }
2025-11-09T23:42:54.9247489Z -    
2025-11-09T23:42:54.9247601Z +
2025-11-09T23:42:54.9247737Z      tokio::select! {
2025-11-09T23:42:54.9247875Z          result = rx3 => {
2025-11-09T23:42:54.9248297Z              assert_eq!(result.unwrap(), response3);
2025-11-09T23:42:54.9248829Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:59:
2025-11-09T23:42:54.9249015Z  async fn test_request_cancellation() {
2025-11-09T23:42:54.9249331Z      let manager = NetworkManager::new(TransportPreference::TcpOnly);
2025-11-09T23:42:54.9249605Z      let peer_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:42:54.9249731Z -    
2025-11-09T23:42:54.9249857Z +
2025-11-09T23:42:54.9250117Z      let (request_id, rx) = manager.register_request(peer_addr);
2025-11-09T23:42:54.9250230Z -    
2025-11-09T23:42:54.9250352Z +
2025-11-09T23:42:54.9250488Z      // Cancel the request
2025-11-09T23:42:54.9250678Z      assert!(manager.cancel_request(request_id));
2025-11-09T23:42:54.9250788Z -    
2025-11-09T23:42:54.9250908Z +
2025-11-09T23:42:54.9251069Z      // Try to complete it (should fail)
2025-11-09T23:42:54.9251349Z      assert!(!manager.complete_request(request_id, vec![1, 2, 3]));
2025-11-09T23:42:54.9251478Z -    
2025-11-09T23:42:54.9251588Z +
2025-11-09T23:42:54.9251734Z      // Receiver should be closed
2025-11-09T23:42:54.9251872Z      assert!(rx.await.is_err());
2025-11-09T23:42:54.9251987Z  }
2025-11-09T23:42:54.9252495Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:76:
2025-11-09T23:42:54.9252654Z  async fn test_timestamp_cleanup() {
2025-11-09T23:42:54.9253183Z      let manager = NetworkManager::new(TransportPreference::TcpOnly);
2025-11-09T23:42:54.9253426Z      let peer_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:42:54.9253534Z -    
2025-11-09T23:42:54.9253643Z +
2025-11-09T23:42:54.9253768Z      // Register a request
2025-11-09T23:42:54.9254021Z      let (request_id, _rx) = manager.register_request(peer_addr);
2025-11-09T23:42:54.9254136Z -    
2025-11-09T23:42:54.9254251Z +
2025-11-09T23:42:54.9254781Z      // Cleanup requests older than 0 seconds (should remove all)
2025-11-09T23:42:54.9255010Z      let cleaned = manager.cleanup_expired_requests(0);
2025-11-09T23:42:54.9255152Z      assert_eq!(cleaned, 1);
2025-11-09T23:42:54.9255660Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:86:
2025-11-09T23:42:54.9255772Z -    
2025-11-09T23:42:54.9255879Z +
2025-11-09T23:42:54.9256022Z      // Request should be gone
2025-11-09T23:42:54.9256301Z      assert!(!manager.complete_request(request_id, vec![1, 2, 3]));
2025-11-09T23:42:54.9256421Z  }
2025-11-09T23:42:54.9256904Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:92:
2025-11-09T23:42:54.9257129Z  async fn test_multiple_concurrent_requests_per_peer() {
2025-11-09T23:42:54.9257453Z      let manager = NetworkManager::new(TransportPreference::TcpOnly);
2025-11-09T23:42:54.9257716Z      let peer_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:42:54.9257832Z -    
2025-11-09T23:42:54.9257947Z +
2025-11-09T23:42:54.9258145Z      // Register multiple requests from same peer
2025-11-09T23:42:54.9266551Z      let (id1, rx1) = manager.register_request(peer_addr);
2025-11-09T23:42:54.9266837Z      let (id2, rx2) = manager.register_request(peer_addr);
2025-11-09T23:42:54.9267363Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:99:
2025-11-09T23:42:54.9267587Z      let (id3, rx3) = manager.register_request(peer_addr);
2025-11-09T23:42:54.9267724Z -    
2025-11-09T23:42:54.9267835Z +
2025-11-09T23:42:54.9267987Z      // All should be registered
2025-11-09T23:42:54.9268285Z      let pending = manager.get_pending_requests_for_peer(peer_addr);
2025-11-09T23:42:54.9268437Z      assert_eq!(pending.len(), 3);
2025-11-09T23:42:54.9268958Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:104:
2025-11-09T23:42:54.9269127Z      assert!(pending.contains(&id1));
2025-11-09T23:42:54.9269294Z      assert!(pending.contains(&id2));
2025-11-09T23:42:54.9270684Z      assert!(pending.contains(&id3));
2025-11-09T23:42:54.9270839Z -    
2025-11-09T23:42:54.9270959Z +
2025-11-09T23:42:54.9271098Z      // Complete all
2025-11-09T23:42:54.9271282Z      manager.complete_request(id1, vec![1]);
2025-11-09T23:42:54.9271462Z      manager.complete_request(id2, vec![2]);
2025-11-09T23:42:54.9272027Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:111:
2025-11-09T23:42:54.9272237Z      manager.complete_request(id3, vec![3]);
2025-11-09T23:42:54.9272357Z -    
2025-11-09T23:42:54.9272483Z +
2025-11-09T23:42:54.9272641Z      // All should receive responses
2025-11-09T23:42:54.9272815Z      assert_eq!(rx1.await.unwrap(), vec![1]);
2025-11-09T23:42:54.9272980Z      assert_eq!(rx2.await.unwrap(), vec![2]);
2025-11-09T23:42:54.9273498Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:120:
2025-11-09T23:42:54.9273665Z  async fn test_request_metrics() {
2025-11-09T23:42:54.9274001Z      let manager = NetworkManager::new(TransportPreference::TcpOnly);
2025-11-09T23:42:54.9274465Z      let peer_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:42:54.9274588Z -    
2025-11-09T23:42:54.9275030Z +
2025-11-09T23:42:54.9275224Z      // Register and complete a request
2025-11-09T23:42:54.9275457Z      let (id1, _rx1) = manager.register_request(peer_addr);
2025-11-09T23:42:54.9275659Z      manager.complete_request(id1, vec![1, 2, 3]);
2025-11-09T23:42:54.9276454Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:127:
2025-11-09T23:42:54.9276579Z -    
2025-11-09T23:42:54.9276684Z +
2025-11-09T23:42:54.9276813Z      // Check metrics
2025-11-09T23:42:54.9277055Z      let metrics = manager.get_request_metrics(peer_addr);
2025-11-09T23:42:54.9277215Z      assert!(metrics.is_some());
2025-11-09T23:42:54.9277733Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:132:
2025-11-09T23:42:54.9277919Z      assert_eq!(m.total_requests, 1);
2025-11-09T23:42:54.9278092Z      assert_eq!(m.successful_responses, 1);
2025-11-09T23:42:54.9278249Z      assert_eq!(m.failed_requests, 0);
2025-11-09T23:42:54.9278364Z -    
2025-11-09T23:42:54.9278477Z +
2025-11-09T23:42:54.9278601Z      // Record a failure
2025-11-09T23:42:54.9278817Z      let (id2, _rx2) = manager.register_request(peer_addr);
2025-11-09T23:42:54.9278984Z      manager.record_failed_request(id2);
2025-11-09T23:42:54.9279490Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:139:
2025-11-09T23:42:54.9279614Z -    
2025-11-09T23:42:54.9279724Z +
2025-11-09T23:42:54.9280420Z      let metrics = manager.get_request_metrics(peer_addr);
2025-11-09T23:42:54.9280601Z      let m = metrics.unwrap();
2025-11-09T23:42:54.9280755Z      assert_eq!(m.total_requests, 2);
2025-11-09T23:42:54.9281262Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:148:
2025-11-09T23:42:54.9281439Z  async fn test_request_priority() {
2025-11-09T23:42:54.9281752Z      let manager = NetworkManager::new(TransportPreference::TcpOnly);
2025-11-09T23:42:54.9283852Z      let peer_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:42:54.9283970Z -    
2025-11-09T23:42:54.9284083Z +
2025-11-09T23:42:54.9284273Z      // Register requests with different priorities
2025-11-09T23:42:54.9284741Z      let (_id1, _rx1) = manager.register_request_with_priority(peer_addr, 0);
2025-11-09T23:42:54.9285059Z      let (_id2, _rx2) = manager.register_request_with_priority(peer_addr, 5);
2025-11-09T23:42:54.9285578Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:155:
2025-11-09T23:42:54.9285888Z      let (_id3, _rx3) = manager.register_request_with_priority(peer_addr, 10);
2025-11-09T23:42:54.9286004Z -    
2025-11-09T23:42:54.9286121Z +
2025-11-09T23:42:54.9286271Z      // All should be registered
2025-11-09T23:42:54.9286575Z      let pending = manager.get_pending_requests_for_peer(peer_addr);
2025-11-09T23:42:54.9286998Z      assert_eq!(pending.len(), 3);
2025-11-09T23:42:54.9287524Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:160:
2025-11-09T23:42:54.9287654Z  }
2025-11-09T23:42:54.9287765Z -
2025-11-09T23:42:54.9287876Z -
2025-11-09T23:42:54.9287987Z -
2025-11-09T23:42:54.9288113Z  
2025-11-09T23:42:54.9288860Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:8:
2025-11-09T23:42:54.9289048Z  async fn test_ban_list_operations() {
2025-11-09T23:42:54.9289281Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:42:54.9289474Z      let manager = NetworkManager::new(addr);
2025-11-09T23:42:54.9289592Z -    
2025-11-09T23:42:54.9289711Z +
2025-11-09T23:42:54.9289970Z      let test_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:42:54.9290084Z -    
2025-11-09T23:42:54.9290189Z +
2025-11-09T23:42:54.9290324Z      // Test ban
2025-11-09T23:42:54.9290555Z      let now = SystemTime::now()
2025-11-09T23:42:54.9290707Z          .duration_since(UNIX_EPOCH)
2025-11-09T23:42:54.9291263Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:18:
2025-11-09T23:42:54.9291391Z          .as_secs();
2025-11-09T23:42:54.9291606Z      let future_timestamp = now + 3600; // 1 hour from now
2025-11-09T23:42:54.9292054Z      manager.ban_peer(test_addr, future_timestamp);
2025-11-09T23:42:54.9292185Z -    
2025-11-09T23:42:54.9292304Z +
2025-11-09T23:42:54.9292478Z      assert!(manager.is_banned(test_addr));
2025-11-09T23:42:54.9292673Z -    
2025-11-09T23:42:54.9292790Z +
2025-11-09T23:42:54.9292915Z      // Test unban
2025-11-09T23:42:54.9293073Z      manager.unban_peer(test_addr);
2025-11-09T23:42:54.9293248Z      assert!(!manager.is_banned(test_addr));
2025-11-09T23:42:54.9295771Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:30:
2025-11-09T23:42:54.9296114Z  async fn test_ban_list_expiration() {
2025-11-09T23:42:54.9296364Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:42:54.9296561Z      let manager = NetworkManager::new(addr);
2025-11-09T23:42:54.9296677Z -    
2025-11-09T23:42:54.9296796Z +
2025-11-09T23:42:54.9297056Z      let test_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:42:54.9297185Z -    
2025-11-09T23:42:54.9297297Z +
2025-11-09T23:42:54.9297468Z      // Ban with expiration in the past
2025-11-09T23:42:54.9297624Z      let now = SystemTime::now()
2025-11-09T23:42:54.9297771Z          .duration_since(UNIX_EPOCH)
2025-11-09T23:42:54.9298320Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:40:
2025-11-09T23:42:54.9298439Z          .as_secs();
2025-11-09T23:42:54.9298616Z      let past_timestamp = now - 3600; // 1 hour ago
2025-11-09T23:42:54.9298809Z      manager.ban_peer(test_addr, past_timestamp);
2025-11-09T23:42:54.9298941Z -    
2025-11-09T23:42:54.9299055Z +
2025-11-09T23:42:54.9299263Z      // is_banned should automatically check expiration
2025-11-09T23:42:54.9299441Z      assert!(!manager.is_banned(test_addr));
2025-11-09T23:42:54.9299547Z  }
2025-11-09T23:42:54.9300101Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:49:
2025-11-09T23:42:54.9300259Z  async fn test_ban_list_permanent() {
2025-11-09T23:42:54.9300478Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:42:54.9300651Z      let manager = NetworkManager::new(addr);
2025-11-09T23:42:54.9300765Z -    
2025-11-09T23:42:54.9300891Z +
2025-11-09T23:42:54.9301141Z      let test_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:42:54.9301249Z -    
2025-11-09T23:42:54.9301354Z +
2025-11-09T23:42:54.9301512Z      // Permanent ban (timestamp = 0)
2025-11-09T23:42:54.9301661Z      manager.ban_peer(test_addr, 0);
2025-11-09T23:42:54.9301828Z      assert!(manager.is_banned(test_addr));
2025-11-09T23:42:54.9302626Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:58:
2025-11-09T23:42:54.9302741Z -    
2025-11-09T23:42:54.9302848Z +
2025-11-09T23:42:54.9302976Z      // Clear all bans
2025-11-09T23:42:54.9303125Z      manager.clear_bans();
2025-11-09T23:42:54.9303288Z      assert!(!manager.is_banned(test_addr));
2025-11-09T23:42:54.9303842Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:66:
2025-11-09T23:42:54.9304031Z  async fn test_ban_list_multiple_peers() {
2025-11-09T23:42:54.9304243Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:42:54.9304589Z      let manager = NetworkManager::new(addr);
2025-11-09T23:42:54.9304722Z -    
2025-11-09T23:42:54.9304838Z +
2025-11-09T23:42:54.9305070Z      let addr1: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:42:54.9305301Z      let addr2: SocketAddr = "127.0.0.1:8334".parse().unwrap();
2025-11-09T23:42:54.9305545Z      let addr3: SocketAddr = "127.0.0.1:8335".parse().unwrap();
2025-11-09T23:42:54.9306089Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:73:
2025-11-09T23:42:54.9306202Z -    
2025-11-09T23:42:54.9306317Z +
2025-11-09T23:42:54.9306473Z      let now = SystemTime::now()
2025-11-09T23:42:54.9306622Z          .duration_since(UNIX_EPOCH)
2025-11-09T23:42:54.9306956Z          .unwrap()
2025-11-09T23:42:54.9307538Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:77:
2025-11-09T23:42:54.9307660Z          .as_secs();
2025-11-09T23:42:54.9307768Z -    
2025-11-09T23:42:54.9307890Z +
2025-11-09T23:42:54.9308052Z      manager.ban_peer(addr1, now + 3600);
2025-11-09T23:42:54.9308212Z      manager.ban_peer(addr2, 0); // Permanent
2025-11-09T23:42:54.9308382Z      manager.ban_peer(addr3, now + 7200);
2025-11-09T23:42:54.9308945Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:82:
2025-11-09T23:42:54.9309073Z -    
2025-11-09T23:42:54.9309189Z +
2025-11-09T23:42:54.9309410Z      assert_eq!(manager.get_banned_peers().len(), 3);
2025-11-09T23:42:54.9309571Z      assert!(manager.is_banned(addr1));
2025-11-09T23:42:54.9309734Z      assert!(manager.is_banned(addr2));
2025-11-09T23:42:54.9310307Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:86:
2025-11-09T23:42:54.9310478Z      assert!(manager.is_banned(addr3));
2025-11-09T23:42:54.9310596Z -    
2025-11-09T23:42:54.9310702Z +
2025-11-09T23:42:54.9310829Z      // Unban one
2025-11-09T23:42:54.9310978Z      manager.unban_peer(addr2);
2025-11-09T23:42:54.9311182Z      assert_eq!(manager.get_banned_peers().len(), 2);
2025-11-09T23:42:54.9311747Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:91:
2025-11-09T23:42:54.9311918Z      assert!(!manager.is_banned(addr2));
2025-11-09T23:42:54.9312046Z  }
2025-11-09T23:42:54.9312161Z -
2025-11-09T23:42:54.9312287Z  
2025-11-09T23:42:54.9312833Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_tests.rs:22:
2025-11-09T23:42:54.9312999Z          .duration_since(UNIX_EPOCH)
2025-11-09T23:42:54.9313135Z          .unwrap()
2025-11-09T23:42:54.9313260Z          .as_secs();
2025-11-09T23:42:54.9313375Z -    
2025-11-09T23:42:54.9313496Z +
2025-11-09T23:42:54.9313934Z      // Create two ban lists with overlapping entries
2025-11-09T23:42:54.9314095Z      let list1 = BanListMessage {
2025-11-09T23:42:54.9314224Z          is_full: true,
2025-11-09T23:42:54.9314871Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_tests.rs:29:
2025-11-09T23:42:54.9315032Z          ban_list_hash: [0; 32],
2025-11-09T23:42:54.9315170Z          ban_entries: vec![
2025-11-09T23:42:54.9315507Z -            create_test_ban_entry([127, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 8333, now + 3600),
2025-11-09T23:42:54.9316099Z -            create_test_ban_entry([192, 168, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 8333, now + 7200),
2025-11-09T23:42:54.9316259Z +            create_test_ban_entry(
2025-11-09T23:42:54.9316438Z +                [127, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
2025-11-09T23:42:54.9316571Z +                8333,
2025-11-09T23:42:54.9316700Z +                now + 3600,
2025-11-09T23:42:54.9316825Z +            ),
2025-11-09T23:42:54.9316978Z +            create_test_ban_entry(
2025-11-09T23:42:54.9317161Z +                [192, 168, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
2025-11-09T23:42:54.9317283Z +                8333,
2025-11-09T23:42:54.9317415Z +                now + 7200,
2025-11-09T23:42:54.9317543Z +            ),
2025-11-09T23:42:54.9317658Z          ],
2025-11-09T23:42:54.9317790Z          timestamp: now,
2025-11-09T23:42:54.9317915Z      };
2025-11-09T23:42:54.9318389Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_tests.rs:36:
2025-11-09T23:42:54.9318513Z -    
2025-11-09T23:42:54.9318625Z +
2025-11-09T23:42:54.9318782Z      let list2 = BanListMessage {
2025-11-09T23:42:54.9318908Z          is_full: true,
2025-11-09T23:42:54.9319038Z          ban_list_hash: [0; 32],
2025-11-09T23:42:54.9319516Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_tests.rs:40:
2025-11-09T23:42:54.9319659Z          ban_entries: vec![
2025-11-09T23:42:54.9320087Z              // Same address, longer ban
2025-11-09T23:42:54.9320417Z -            create_test_ban_entry([127, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 8333, now + 7200),
2025-11-09T23:42:54.9320577Z +            create_test_ban_entry(
2025-11-09T23:42:54.9320750Z +                [127, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
2025-11-09T23:42:54.9320874Z +                8333,
2025-11-09T23:42:54.9321013Z +                now + 7200,
2025-11-09T23:42:54.9321131Z +            ),
2025-11-09T23:42:54.9321264Z              // New address
2025-11-09T23:42:54.9321599Z -            create_test_ban_entry([10, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 8333, now + 1800),
2025-11-09T23:42:54.9321752Z +            create_test_ban_entry(
2025-11-09T23:42:54.9321925Z +                [10, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
2025-11-09T23:42:54.9322047Z +                8333,
2025-11-09T23:42:54.9322191Z +                now + 1800,
2025-11-09T23:42:54.9322322Z +            ),
2025-11-09T23:42:54.9322437Z          ],
2025-11-09T23:42:54.9322582Z          timestamp: now,
2025-11-09T23:42:54.9322697Z      };
2025-11-09T23:42:54.9323176Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_tests.rs:48:
2025-11-09T23:42:54.9323292Z -    
2025-11-09T23:42:54.9323414Z +
2025-11-09T23:42:54.9323624Z      let merged = merge_ban_lists(vec![&list1, &list2]);
2025-11-09T23:42:54.9323742Z -    
2025-11-09T23:42:54.9323862Z +
2025-11-09T23:42:54.9324019Z      // Should have 3 unique addresses
2025-11-09T23:42:54.9324175Z      assert_eq!(merged.len(), 3);
2025-11-09T23:42:54.9324286Z -    
2025-11-09T23:42:54.9324610Z +
2025-11-09T23:42:54.9324787Z      // 127.0.0.1 should have longer ban (7200)
2025-11-09T23:42:54.9324936Z -    let entry_127 = merged.iter()
2025-11-09T23:42:54.9325092Z -        .find(|e| e.addr.ip[0] == 127)
2025-11-09T23:42:54.9325215Z -        .unwrap();
2025-11-09T23:42:54.9325501Z +    let entry_127 = merged.iter().find(|e| e.addr.ip[0] == 127).unwrap();
2025-11-09T23:42:54.9325725Z      assert_eq!(entry_127.unban_timestamp, now + 7200);
2025-11-09T23:42:54.9325846Z  }
2025-11-09T23:42:54.9325953Z  
2025-11-09T23:42:54.9326403Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_tests.rs:64:
2025-11-09T23:42:54.9326553Z          .duration_since(UNIX_EPOCH)
2025-11-09T23:42:54.9326665Z          .unwrap()
2025-11-09T23:42:54.9326778Z          .as_secs();
2025-11-09T23:42:54.9326883Z -    
2025-11-09T23:42:54.9326991Z +
2025-11-09T23:42:54.9327115Z      // Valid future ban
2025-11-09T23:42:54.9327771Z -    let future_ban = create_test_ban_entry([127, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 8333, now + 3600);
2025-11-09T23:42:54.9327956Z +    let future_ban = create_test_ban_entry(
2025-11-09T23:42:54.9328127Z +        [127, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
2025-11-09T23:42:54.9328239Z +        8333,
2025-11-09T23:42:54.9328359Z +        now + 3600,
2025-11-09T23:42:54.9328485Z +    );
2025-11-09T23:42:54.9328657Z      assert!(validate_ban_entry(&future_ban));
2025-11-09T23:42:54.9328771Z -    
2025-11-09T23:42:54.9328888Z +
2025-11-09T23:42:54.9329029Z      // Valid permanent ban
2025-11-09T23:42:54.9329481Z -    let permanent_ban = create_test_ban_entry([192, 168, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 8333, u64::MAX);
2025-11-09T23:42:54.9329666Z +    let permanent_ban = create_test_ban_entry(
2025-11-09T23:42:54.9329849Z +        [192, 168, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
2025-11-09T23:42:54.9329963Z +        8333,
2025-11-09T23:42:54.9330108Z +        u64::MAX,
2025-11-09T23:42:54.9330227Z +    );
2025-11-09T23:42:54.9330409Z      assert!(validate_ban_entry(&permanent_ban));
2025-11-09T23:42:54.9330527Z -    
2025-11-09T23:42:54.9330642Z +
2025-11-09T23:42:54.9330808Z      // Expired ban (should be invalid)
2025-11-09T23:42:54.9331324Z -    let expired_ban = create_test_ban_entry([10, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 8333, now.saturating_sub(3600));
2025-11-09T23:42:54.9331740Z +    let expired_ban = create_test_ban_entry(
2025-11-09T23:42:54.9331910Z +        [10, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
2025-11-09T23:42:54.9332034Z +        8333,
2025-11-09T23:42:54.9332189Z +        now.saturating_sub(3600),
2025-11-09T23:42:54.9332319Z +    );
2025-11-09T23:42:54.9332505Z      assert!(!validate_ban_entry(&expired_ban));
2025-11-09T23:42:54.9332620Z  }
2025-11-09T23:42:54.9332734Z  
2025-11-09T23:42:54.9333228Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_tests.rs:84:
2025-11-09T23:42:54.9333388Z          .duration_since(UNIX_EPOCH)
2025-11-09T23:42:54.9333507Z          .unwrap()
2025-11-09T23:42:54.9333636Z          .as_secs();
2025-11-09T23:42:54.9333744Z -    
2025-11-09T23:42:54.9333851Z +
2025-11-09T23:42:54.9333983Z      let entries = vec![
2025-11-09T23:42:54.9334471Z -        create_test_ban_entry([127, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 8333, now + 3600),
2025-11-09T23:42:54.9334802Z -        create_test_ban_entry([192, 168, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 8333, now + 7200),
2025-11-09T23:42:54.9334954Z +        create_test_ban_entry(
2025-11-09T23:42:54.9335131Z +            [127, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
2025-11-09T23:42:54.9335248Z +            8333,
2025-11-09T23:42:54.9335373Z +            now + 3600,
2025-11-09T23:42:54.9335486Z +        ),
2025-11-09T23:42:54.9335629Z +        create_test_ban_entry(
2025-11-09T23:42:54.9335806Z +            [192, 168, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
2025-11-09T23:42:54.9335940Z +            8333,
2025-11-09T23:42:54.9336078Z +            now + 7200,
2025-11-09T23:42:54.9336191Z +        ),
2025-11-09T23:42:54.9336299Z      ];
2025-11-09T23:42:54.9336410Z -    
2025-11-09T23:42:54.9336531Z +
2025-11-09T23:42:54.9338762Z      let hash1 = calculate_ban_list_hash(&entries);
2025-11-09T23:42:54.9338974Z      let hash2 = calculate_ban_list_hash(&entries);
2025-11-09T23:42:54.9339092Z -    
2025-11-09T23:42:54.9339219Z +
2025-11-09T23:42:54.9339403Z      // Same entries should produce same hash
2025-11-09T23:42:54.9339553Z      assert_eq!(hash1, hash2);
2025-11-09T23:42:54.9339678Z -    
2025-11-09T23:42:54.9339796Z +
2025-11-09T23:42:54.9339926Z      // Verify hash
2025-11-09T23:42:54.9340145Z      assert!(verify_ban_list_hash(&entries, &hash1));
2025-11-09T23:42:54.9340263Z  }
2025-11-09T23:42:54.9340768Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_tests.rs:102:
2025-11-09T23:42:54.9340882Z -
2025-11-09T23:42:54.9341002Z -
2025-11-09T23:42:54.9341373Z -
2025-11-09T23:42:54.9341490Z  
2025-11-09T23:42:54.9342089Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip158_implementation_tests.rs:1:
2025-11-09T23:42:54.9342247Z  //! Tests for BIP158 implementation
2025-11-09T23:42:54.9342358Z  
2025-11-09T23:42:54.9342736Z  use bllvm_node::bip158::{build_block_filter, match_filter, CompactBlockFilter};
2025-11-09T23:42:54.9343151Z -use bllvm_protocol::{Transaction, TransactionInput, TransactionOutput, OutPoint};
2025-11-09T23:42:54.9343555Z +use bllvm_protocol::{OutPoint, Transaction, TransactionInput, TransactionOutput};
2025-11-09T23:42:54.9343675Z  
2025-11-09T23:42:54.9343797Z  #[test]
2025-11-09T23:42:54.9343996Z  fn test_build_block_filter_with_transactions() {
2025-11-09T23:42:54.9344719Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip158_implementation_tests.rs:15:
2025-11-09T23:42:54.9344859Z          }],
2025-11-09T23:42:54.9344988Z          lock_time: 0,
2025-11-09T23:42:54.9345101Z      };
2025-11-09T23:42:54.9345224Z -    
2025-11-09T23:42:54.9345345Z +
2025-11-09T23:42:54.9345486Z      let tx2 = Transaction {
2025-11-09T23:42:54.9345610Z          version: 1,
2025-11-09T23:42:54.9345745Z          inputs: vec![],
2025-11-09T23:42:54.9348220Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip158_implementation_tests.rs:25:
2025-11-09T23:42:54.9348336Z          }],
2025-11-09T23:42:54.9348717Z          lock_time: 0,
2025-11-09T23:42:54.9348846Z      };
2025-11-09T23:42:54.9348963Z -    
2025-11-09T23:42:54.9349079Z +
2025-11-09T23:42:54.9349343Z      let filter = build_block_filter(&[tx1, tx2], &[]).unwrap();
2025-11-09T23:42:54.9349516Z      assert_eq!(filter.num_elements, 2);
2025-11-09T23:42:54.9349702Z      assert!(!filter.filter_data.is_empty());
2025-11-09T23:42:54.9350287Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip158_implementation_tests.rs:42:
2025-11-09T23:42:54.9350417Z          }],
2025-11-09T23:42:54.9350549Z          lock_time: 0,
2025-11-09T23:42:54.9350675Z      };
2025-11-09T23:42:54.9350798Z -    
2025-11-09T23:42:54.9350913Z +
2025-11-09T23:42:54.9351177Z      let filter = build_block_filter(&[tx.clone()], &[]).unwrap();
2025-11-09T23:42:54.9351293Z -    
2025-11-09T23:42:54.9351414Z +
2025-11-09T23:42:54.9351603Z      // Script that's in the filter should match
2025-11-09T23:42:54.9351881Z      assert!(match_filter(&filter, &tx.outputs[0].script_pubkey));
2025-11-09T23:42:54.9352016Z  }
2025-11-09T23:42:54.9352606Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip158_implementation_tests.rs:67:
2025-11-09T23:42:54.9352730Z          }],
2025-11-09T23:42:54.9352856Z          lock_time: 0,
2025-11-09T23:42:54.9353050Z      };
2025-11-09T23:42:54.9353165Z -    
2025-11-09T23:42:54.9353276Z +
2025-11-09T23:42:54.9353472Z      // Previous output script (UTXO being spent)
2025-11-09T23:42:54.9353674Z      let prev_script = vec![0x54, 0x55]; // OP_4 OP_5
2025-11-09T23:42:54.9353787Z -    
2025-11-09T23:42:54.9353905Z +
2025-11-09T23:42:54.9354236Z      let filter = build_block_filter(&[tx], &[prev_script.clone()]).unwrap();
2025-11-09T23:42:54.9354505Z -    
2025-11-09T23:42:54.9354623Z +
2025-11-09T23:42:54.9354862Z      // Both output script and previous script should match
2025-11-09T23:42:54.9355024Z      assert!(filter.num_elements >= 1);
2025-11-09T23:42:54.9355138Z  }
2025-11-09T23:42:54.9355718Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip158_implementation_tests.rs:79:
2025-11-09T23:42:54.9355855Z -
2025-11-09T23:42:54.9356025Z  
2025-11-09T23:42:54.9356603Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:1:
2025-11-09T23:42:54.9356824Z  //! Tests for BIP70 payment verification and signing
2025-11-09T23:42:54.9356939Z  
2025-11-09T23:42:54.9357397Z -use bllvm_node::bip70::{PaymentRequest, Payment, PaymentOutput, PaymentProtocolServer};
2025-11-09T23:42:54.9357627Z -use bllvm_node::network::protocol::PaymentMessage;
2025-11-09T23:42:54.9358302Z -use bllvm_protocol::{Transaction, TransactionInput, TransactionOutput, OutPoint};
2025-11-09T23:42:54.9358661Z  use bllvm_consensus::serialization::transaction::serialize_transaction;
2025-11-09T23:42:54.9359102Z +use bllvm_node::bip70::{Payment, PaymentOutput, PaymentProtocolServer, PaymentRequest};
2025-11-09T23:42:54.9359326Z +use bllvm_node::network::protocol::PaymentMessage;
2025-11-09T23:42:54.9359742Z +use bllvm_protocol::{OutPoint, Transaction, TransactionInput, TransactionOutput};
2025-11-09T23:42:54.9359914Z  use secp256k1::{Secp256k1, SecretKey};
2025-11-09T23:42:54.9360030Z  
2025-11-09T23:42:54.9360149Z  #[test]
2025-11-09T23:42:54.9360631Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:13:
2025-11-09T23:42:54.9360784Z          script: vec![0x51], // OP_1
2025-11-09T23:42:54.9360922Z          amount: Some(1000),
2025-11-09T23:42:54.9361048Z      };
2025-11-09T23:42:54.9361158Z -    
2025-11-09T23:42:54.9361434Z -    let payment_request = PaymentRequest::new(
2025-11-09T23:42:54.9361590Z -        "main".to_string(),
2025-11-09T23:42:54.9361742Z -        vec![output.clone()],
2025-11-09T23:42:54.9361860Z -        1234567890,
2025-11-09T23:42:54.9361974Z -    );
2025-11-09T23:42:54.9362093Z -    
2025-11-09T23:42:54.9362206Z +
2025-11-09T23:42:54.9362680Z +    let payment_request = PaymentRequest::new("main".to_string(), vec![output.clone()], 1234567890);
2025-11-09T23:42:54.9363038Z +
2025-11-09T23:42:54.9363207Z      // Create a payment transaction
2025-11-09T23:42:54.9363346Z      let tx = Transaction {
2025-11-09T23:42:54.9363471Z          version: 1,
2025-11-09T23:42:54.9363949Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:37:
2025-11-09T23:42:54.9364072Z          }],
2025-11-09T23:42:54.9364201Z          lock_time: 0,
2025-11-09T23:42:54.9364466Z      };
2025-11-09T23:42:54.9364594Z -    
2025-11-09T23:42:54.9364710Z +
2025-11-09T23:42:54.9364903Z      let tx_bytes = serialize_transaction(&tx);
2025-11-09T23:42:54.9365038Z -    
2025-11-09T23:42:54.9365151Z +
2025-11-09T23:42:54.9365344Z      let payment = Payment::new(vec![tx_bytes]);
2025-11-09T23:42:54.9365457Z -    
2025-11-09T23:42:54.9365579Z +
2025-11-09T23:42:54.9365726Z      // Create payment message
2025-11-09T23:42:54.9365892Z      let payment_msg = PaymentMessage {
2025-11-09T23:42:54.9366028Z          payment,
2025-11-09T23:42:54.9366748Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:48:
2025-11-09T23:42:54.9367553Z          payment_id: vec![1, 2, 3, 4],
2025-11-09T23:42:54.9367933Z      };
2025-11-09T23:42:54.9368181Z -    
2025-11-09T23:42:54.9368434Z +
2025-11-09T23:42:54.9368779Z      // Process payment (without merchant key for now)
2025-11-09T23:42:54.9369363Z      let result = PaymentProtocolServer::process_payment(
2025-11-09T23:42:54.9369878Z          &payment_msg,
2025-11-09T23:42:54.9370544Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:54:
2025-11-09T23:42:54.9371324Z          &payment_request,
2025-11-09T23:42:54.9371725Z          None, // No merchant key
2025-11-09T23:42:54.9372109Z      );
2025-11-09T23:42:54.9372388Z -    
2025-11-09T23:42:54.9372659Z +
2025-11-09T23:42:54.9372999Z      // Should succeed (validation passes)
2025-11-09T23:42:54.9373460Z      assert!(result.is_ok());
2025-11-09T23:42:54.9373834Z  }
2025-11-09T23:42:54.9374684Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:63:
2025-11-09T23:42:54.9375507Z  fn test_payment_ack_signing() {
2025-11-09T23:42:54.9375948Z      let secp = Secp256k1::new();
2025-11-09T23:42:54.9376464Z      let merchant_key = SecretKey::from_slice(&[1; 32]).unwrap();
2025-11-09T23:42:54.9376990Z -    
2025-11-09T23:42:54.9377255Z +
2025-11-09T23:42:54.9377594Z      // Create payment request with merchant pubkey
2025-11-09T23:42:54.9378086Z      let output = PaymentOutput {
2025-11-09T23:42:54.9378511Z          script: vec![0x51],
2025-11-09T23:42:54.9379515Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:70:
2025-11-09T23:42:54.9380310Z          amount: Some(1000),
2025-11-09T23:42:54.9380684Z      };
2025-11-09T23:42:54.9380952Z -    
2025-11-09T23:42:54.9381336Z -    let mut payment_request = PaymentRequest::new(
2025-11-09T23:42:54.9381834Z -        "main".to_string(),
2025-11-09T23:42:54.9382202Z -        vec![output],
2025-11-09T23:42:54.9382540Z -        1234567890,
2025-11-09T23:42:54.9382860Z -    );
2025-11-09T23:42:54.9383118Z -    
2025-11-09T23:42:54.9383429Z +
2025-11-09T23:42:54.9384014Z +    let mut payment_request = PaymentRequest::new("main".to_string(), vec![output], 1234567890);
2025-11-09T23:42:54.9384930Z +
2025-11-09T23:42:54.9385235Z      // Set merchant pubkey
2025-11-09T23:42:54.9385873Z      let merchant_pubkey = secp256k1::PublicKey::from_secret_key(&secp, &merchant_key);
2025-11-09T23:42:54.9386781Z      payment_request.merchant_pubkey = Some(merchant_pubkey.serialize().to_vec());
2025-11-09T23:42:54.9387779Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:82:
2025-11-09T23:42:54.9388510Z -    
2025-11-09T23:42:54.9388771Z +
2025-11-09T23:42:54.9389035Z      // Create payment
2025-11-09T23:42:54.9389371Z      let tx = Transaction {
2025-11-09T23:42:54.9389731Z          version: 1,
2025-11-09T23:42:54.9390373Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:97:
2025-11-09T23:42:54.9391330Z          }],
2025-11-09T23:42:54.9391631Z          lock_time: 0,
2025-11-09T23:42:54.9391956Z      };
2025-11-09T23:42:54.9392222Z -    
2025-11-09T23:42:54.9392487Z +
2025-11-09T23:42:54.9392798Z      let tx_bytes = serialize_transaction(&tx);
2025-11-09T23:42:54.9393322Z      let payment = Payment::new(vec![tx_bytes]);
2025-11-09T23:42:54.9393772Z -    
2025-11-09T23:42:54.9394040Z +
2025-11-09T23:42:54.9395987Z      let payment_msg = PaymentMessage {
2025-11-09T23:42:54.9397058Z          payment,
2025-11-09T23:42:54.9397435Z          payment_id: vec![1, 2, 3, 4],
2025-11-09T23:42:54.9398217Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:107:
2025-11-09T23:42:54.9398980Z      };
2025-11-09T23:42:54.9399249Z -    
2025-11-09T23:42:54.9399523Z +
2025-11-09T23:42:54.9399833Z      // Process payment with merchant key
2025-11-09T23:42:54.9400401Z -    let result = PaymentProtocolServer::process_payment(
2025-11-09T23:42:54.9400922Z -        &payment_msg,
2025-11-09T23:42:54.9401264Z -        &payment_request,
2025-11-09T23:42:54.9401631Z -        Some(&merchant_key),
2025-11-09T23:42:54.9401990Z -    );
2025-11-09T23:42:54.9402248Z -    
2025-11-09T23:42:54.9402519Z +    let result =
2025-11-09T23:42:54.9403286Z +        PaymentProtocolServer::process_payment(&payment_msg, &payment_request, Some(&merchant_key));
2025-11-09T23:42:54.9404058Z +
2025-11-09T23:42:54.9404533Z      assert!(result.is_ok());
2025-11-09T23:42:54.9404947Z      let ack_msg = result.unwrap();
2025-11-09T23:42:54.9405360Z -    
2025-11-09T23:42:54.9405631Z +
2025-11-09T23:42:54.9405992Z      // Verify signature is present when key provided
2025-11-09T23:42:54.9406643Z      assert!(!ack_msg.merchant_signature.is_empty());
2025-11-09T23:42:54.9407127Z  }
2025-11-09T23:42:54.9407747Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:122:
2025-11-09T23:42:54.9408473Z -
2025-11-09T23:42:54.9408720Z  
2025-11-09T23:42:54.9409293Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:1:
2025-11-09T23:42:54.9410159Z -use bllvm_protocol::ProtocolVersion;
2025-11-09T23:42:54.9410690Z  use bllvm_node::storage::blockstore::BlockStore;
2025-11-09T23:42:54.9411307Z  use bllvm_node::storage::chainstate::ChainState;
2025-11-09T23:42:54.9411831Z  use bllvm_node::storage::txindex::TxIndex;
2025-11-09T23:42:54.9412595Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:9:
2025-11-09T23:42:54.9413323Z  use bllvm_node::OutPoint;
2025-11-09T23:42:54.9414488Z  use bllvm_node::Transaction;
2025-11-09T23:42:54.9415049Z  use bllvm_node::{ByteString, TransactionInput, TransactionOutput};
2025-11-09T23:42:54.9415685Z +use bllvm_protocol::ProtocolVersion;
2025-11-09T23:42:54.9416154Z  use std::collections::HashMap;
2025-11-09T23:42:54.9416560Z  use tempfile::TempDir;
2025-11-09T23:42:54.9416897Z  
2025-11-09T23:42:54.9417676Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:1:
2025-11-09T23:42:54.9418528Z  //! Tests for fee calculation functionality
2025-11-09T23:42:54.9418954Z  
2025-11-09T23:42:54.9419312Z  use bllvm_node::node::mempool::MempoolManager;
2025-11-09T23:42:54.9419923Z -use bllvm_protocol::{Transaction, UtxoSet, OutPoint, UTXO};
2025-11-09T23:42:54.9420563Z +use bllvm_protocol::{OutPoint, Transaction, UtxoSet, UTXO};
2025-11-09T23:42:54.9421520Z  
2025-11-09T23:42:54.9421781Z  #[test]
2025-11-09T23:42:54.9422100Z  fn test_calculate_transaction_fee() {
2025-11-09T23:42:54.9422926Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:8:
2025-11-09T23:42:54.9423751Z      let mempool = MempoolManager::new();
2025-11-09T23:42:54.9424181Z -    
2025-11-09T23:42:54.9424633Z +
2025-11-09T23:42:54.9426705Z      // Create a simple transaction
2025-11-09T23:42:54.9427203Z      let mut utxo_set = UtxoSet::new();
2025-11-09T23:42:54.9427588Z -    
2025-11-09T23:42:54.9428124Z +
2025-11-09T23:42:54.9428379Z      // Add a UTXO
2025-11-09T23:42:54.9428715Z      let outpoint = OutPoint {
2025-11-09T23:42:54.9429160Z          hash: [0u8; 32],
2025-11-09T23:42:54.9429921Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:16:
2025-11-09T23:42:54.9430741Z          index: 0,
2025-11-09T23:42:54.9431041Z      };
2025-11-09T23:42:54.9431311Z      let utxo = UTXO {
2025-11-09T23:42:54.9431658Z -        value: 100_000_000, // 1 BTC
2025-11-09T23:42:54.9432090Z +        value: 100_000_000,                    // 1 BTC
2025-11-09T23:42:54.9432646Z          script_pubkey: vec![0x76, 0xa9, 0x14], // P2PKH script
2025-11-09T23:42:54.9433146Z      };
2025-11-09T23:42:54.9433447Z      utxo_set.insert(outpoint, utxo);
2025-11-09T23:42:54.9435337Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:23:
2025-11-09T23:42:54.9436290Z -    
2025-11-09T23:42:54.9436571Z +
2025-11-09T23:42:54.9436895Z      // Create transaction with 1 input and 1 output
2025-11-09T23:42:54.9437391Z      let tx = Transaction {
2025-11-09T23:42:54.9437752Z          version: 1,
2025-11-09T23:42:54.9438489Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:36:
2025-11-09T23:42:54.9439309Z          }],
2025-11-09T23:42:54.9439613Z          lock_time: 0,
2025-11-09T23:42:54.9439938Z      };
2025-11-09T23:42:54.9440198Z -    
2025-11-09T23:42:54.9440469Z +
2025-11-09T23:42:54.9440875Z      let fee = mempool.calculate_transaction_fee(&tx, &utxo_set);
2025-11-09T23:42:54.9441419Z -    
2025-11-09T23:42:54.9441680Z +
2025-11-09T23:42:54.9442084Z      // Fee should be 1 BTC - 0.99 BTC = 0.01 BTC = 1,000,000 satoshis
2025-11-09T23:42:54.9442623Z      assert_eq!(fee, 1_000_000);
2025-11-09T23:42:54.9442992Z  }
2025-11-09T23:42:54.9443669Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:46:
2025-11-09T23:42:54.9447020Z  #[test]
2025-11-09T23:42:54.9447391Z  fn test_calculate_transaction_fee_zero_fee() {
2025-11-09T23:42:54.9448307Z      let mempool = MempoolManager::new();
2025-11-09T23:42:54.9448757Z -    
2025-11-09T23:42:54.9449025Z +
2025-11-09T23:42:54.9449334Z      let mut utxo_set = UtxoSet::new();
2025-11-09T23:42:54.9449779Z      let outpoint = OutPoint {
2025-11-09T23:42:54.9450187Z          hash: [0u8; 32],
2025-11-09T23:42:54.9450945Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:57:
2025-11-09T23:42:54.9451793Z          script_pubkey: vec![],
2025-11-09T23:42:54.9452463Z      };
2025-11-09T23:42:54.9452802Z      utxo_set.insert(outpoint, utxo);
2025-11-09T23:42:54.9453210Z -    
2025-11-09T23:42:54.9453484Z +
2025-11-09T23:42:54.9455918Z      // Transaction with same input and output (no fee)
2025-11-09T23:42:54.9456422Z      let tx = Transaction {
2025-11-09T23:42:54.9466756Z          version: 1,
2025-11-09T23:42:54.9467565Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:73:
2025-11-09T23:42:54.9468360Z          }],
2025-11-09T23:42:54.9468634Z          lock_time: 0,
2025-11-09T23:42:54.9468940Z      };
2025-11-09T23:42:54.9469184Z -    
2025-11-09T23:42:54.9469446Z +
2025-11-09T23:42:54.9469846Z      let fee = mempool.calculate_transaction_fee(&tx, &utxo_set);
2025-11-09T23:42:54.9470387Z      assert_eq!(fee, 0);
2025-11-09T23:42:54.9470720Z  }
2025-11-09T23:42:54.9471384Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:81:
2025-11-09T23:42:54.9472216Z  #[test]
2025-11-09T23:42:54.9472583Z  fn test_calculate_transaction_fee_missing_utxo() {
2025-11-09T23:42:54.9473130Z      let mempool = MempoolManager::new();
2025-11-09T23:42:54.9473564Z -    
2025-11-09T23:42:54.9473834Z +
2025-11-09T23:42:54.9474192Z      let utxo_set = UtxoSet::new(); // Empty UTXO set
2025-11-09T23:42:54.9474865Z -    
2025-11-09T23:42:54.9475138Z +
2025-11-09T23:42:54.9475444Z      let outpoint = OutPoint {
2025-11-09T23:42:54.9476119Z          hash: [0u8; 32],
2025-11-09T23:42:54.9476470Z          index: 0,
2025-11-09T23:42:54.9477210Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:90:
2025-11-09T23:42:54.9478029Z      };
2025-11-09T23:42:54.9479832Z -    
2025-11-09T23:42:54.9480103Z +
2025-11-09T23:42:54.9480400Z      let tx = Transaction {
2025-11-09T23:42:54.9480765Z          version: 1,
2025-11-09T23:42:54.9481158Z          inputs: vec![bllvm_protocol::TxIn {
2025-11-09T23:42:54.9482000Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:103:
2025-11-09T23:42:54.9482803Z          }],
2025-11-09T23:42:54.9483096Z          lock_time: 0,
2025-11-09T23:42:54.9483417Z      };
2025-11-09T23:42:54.9483684Z -    
2025-11-09T23:42:54.9483945Z +
2025-11-09T23:42:54.9484520Z      let fee = mempool.calculate_transaction_fee(&tx, &utxo_set);
2025-11-09T23:42:54.9485321Z      // If UTXO is missing, input_total will be 0, so fee will be 0 (or negative, but we return 0)
2025-11-09T23:42:54.9486030Z      assert_eq!(fee, 0);
2025-11-09T23:42:54.9486852Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:110:
2025-11-09T23:42:54.9487693Z  }
2025-11-09T23:42:54.9487942Z -
2025-11-09T23:42:54.9488202Z  
2025-11-09T23:42:54.9488889Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/iroh_peer_tracking_tests.rs:1:
2025-11-09T23:42:54.9489822Z  //! Tests for Iroh peer tracking with TransportAddr
2025-11-09T23:42:54.9490309Z  
2025-11-09T23:42:54.9490724Z -use bllvm_node::network::{NetworkManager, PeerManager};
2025-11-09T23:42:54.9491356Z  use bllvm_node::network::transport::TransportAddr;
2025-11-09T23:42:54.9491962Z +use bllvm_node::network::{NetworkManager, PeerManager};
2025-11-09T23:42:54.9492500Z  use std::net::SocketAddr;
2025-11-09T23:42:54.9492853Z  
2025-11-09T23:42:54.9493124Z  #[test]
2025-11-09T23:42:54.9493806Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/iroh_peer_tracking_tests.rs:8:
2025-11-09T23:42:54.9494893Z  fn test_peer_manager_transport_addr() {
2025-11-09T23:42:54.9495403Z      let mut manager = PeerManager::new(10);
2025-11-09T23:42:54.9495826Z -    
2025-11-09T23:42:54.9496094Z +
2025-11-09T23:42:54.9498131Z      let addr1: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:42:54.9498772Z      let addr2: SocketAddr = "127.0.0.1:8334".parse().unwrap();
2025-11-09T23:42:54.9499275Z -    
2025-11-09T23:42:54.9499554Z +
2025-11-09T23:42:54.9499827Z      // Test TCP peer
2025-11-09T23:42:54.9500489Z      let tcp_addr1 = TransportAddr::Tcp(addr1);
2025-11-09T23:42:54.9501008Z      let tcp_addr2 = TransportAddr::Tcp(addr2);
2025-11-09T23:42:54.9501890Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/iroh_peer_tracking_tests.rs:17:
2025-11-09T23:42:54.9502736Z -    
2025-11-09T23:42:54.9503006Z +
2025-11-09T23:42:54.9503455Z      // Create mock peers (would need actual Peer instances in real test)
2025-11-09T23:42:54.9504187Z      // For now, just test that TransportAddr works as HashMap key
2025-11-09T23:42:54.9505559Z      assert_ne!(tcp_addr1, tcp_addr2);
2025-11-09T23:42:54.9508120Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/iroh_peer_tracking_tests.rs:21:
2025-11-09T23:42:54.9508959Z -    
2025-11-09T23:42:54.9509241Z +
2025-11-09T23:42:54.9509573Z      // Test Iroh peer (different transport type)
2025-11-09T23:42:54.9510515Z      #[cfg(feature = "iroh")]
2025-11-09T23:42:54.9510858Z      {
2025-11-09T23:42:54.9511573Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/iroh_peer_tracking_tests.rs:31:
2025-11-09T23:42:54.9512425Z  #[test]
2025-11-09T23:42:54.9512771Z  fn test_find_transport_addr_by_socket() {
2025-11-09T23:42:54.9513285Z      let mut manager = PeerManager::new(10);
2025-11-09T23:42:54.9513941Z -    
2025-11-09T23:42:54.9514221Z +
2025-11-09T23:42:54.9514811Z      let addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:42:54.9515702Z      let tcp_addr = TransportAddr::Tcp(addr);
2025-11-09T23:42:54.9516146Z -    
2025-11-09T23:42:54.9516413Z +
2025-11-09T23:42:54.9516733Z      // Should not find peer that doesn't exist
2025-11-09T23:42:54.9517340Z      assert!(manager.find_transport_addr_by_socket(addr).is_none());
2025-11-09T23:42:54.9517884Z -    
2025-11-09T23:42:54.9518141Z +
2025-11-09T23:42:54.9518408Z      // After adding, should find it
2025-11-09T23:42:54.9518887Z      // Note: Would need actual Peer instance to test fully
2025-11-09T23:42:54.9519421Z      // This test validates the lookup logic
2025-11-09T23:42:54.9520272Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/iroh_peer_tracking_tests.rs:46:
2025-11-09T23:42:54.9521099Z  #[test]
2025-11-09T23:42:54.9521419Z  fn test_peer_socket_addresses() {
2025-11-09T23:42:54.9521898Z      let mut manager = PeerManager::new(10);
2025-11-09T23:42:54.9522332Z -    
2025-11-09T23:42:54.9522608Z +
2025-11-09T23:42:54.9523008Z      let addr1: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:42:54.9523635Z      let addr2: SocketAddr = "127.0.0.1:8334".parse().unwrap();
2025-11-09T23:42:54.9524120Z -    
2025-11-09T23:42:54.9524611Z +
2025-11-09T23:42:54.9526831Z      // Add TCP peers
2025-11-09T23:42:54.9527255Z      let tcp_addr1 = TransportAddr::Tcp(addr1);
2025-11-09T23:42:54.9527771Z      let tcp_addr2 = TransportAddr::Tcp(addr2);
2025-11-09T23:42:54.9528673Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/iroh_peer_tracking_tests.rs:56:
2025-11-09T23:42:54.9529524Z -    
2025-11-09T23:42:54.9529778Z +
2025-11-09T23:42:54.9530200Z      // Test that peer_socket_addresses returns TCP/Quinn addresses
2025-11-09T23:42:54.9530771Z      // and skips Iroh addresses
2025-11-09T23:42:54.9531258Z      let socket_addrs = manager.peer_socket_addresses();
2025-11-09T23:42:54.9532180Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/iroh_peer_tracking_tests.rs:60:
2025-11-09T23:42:54.9533205Z      // Should be empty since no peers added, but validates method exists
2025-11-09T23:42:54.9533819Z      assert_eq!(socket_addrs.len(), 0);
2025-11-09T23:42:54.9534235Z  }
2025-11-09T23:42:54.9536556Z -
2025-11-09T23:42:54.9536823Z  
2025-11-09T23:42:54.9538003Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:1:
2025-11-09T23:42:54.9539354Z  //! Tests for MempoolManager refactoring
2025-11-09T23:42:54.9539808Z  
2025-11-09T23:42:54.9540171Z  use bllvm_node::node::mempool::MempoolManager;
2025-11-09T23:42:54.9541329Z -use bllvm_protocol::{Transaction, TransactionInput, TransactionOutput, OutPoint, UtxoSet, UTXO};
2025-11-09T23:42:54.9542458Z +use bllvm_protocol::{OutPoint, Transaction, TransactionInput, TransactionOutput, UtxoSet, UTXO};
2025-11-09T23:42:54.9543240Z  use std::collections::HashMap;
2025-11-09T23:42:54.9543602Z  
2025-11-09T23:42:54.9543884Z  #[tokio::test]
2025-11-09T23:42:54.9545870Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:8:
2025-11-09T23:42:54.9546685Z  async fn test_mempool_stores_full_transactions() {
2025-11-09T23:42:54.9547195Z      let mut mempool = MempoolManager::new();
2025-11-09T23:42:54.9547640Z -    
2025-11-09T23:42:54.9547912Z +
2025-11-09T23:42:54.9548195Z      // Create a test transaction
2025-11-09T23:42:54.9548610Z      let tx = Transaction {
2025-11-09T23:42:54.9548966Z          version: 1,
2025-11-09T23:42:54.9549662Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:25:
2025-11-09T23:42:54.9550428Z          }],
2025-11-09T23:42:54.9550741Z          lock_time: 0,
2025-11-09T23:42:54.9551071Z      };
2025-11-09T23:42:54.9551322Z -    
2025-11-09T23:42:54.9551595Z +
2025-11-09T23:42:54.9551866Z      // Add transaction
2025-11-09T23:42:54.9552379Z      let added = mempool.add_transaction(tx.clone()).await.unwrap();
2025-11-09T23:42:54.9554966Z      assert!(added);
2025-11-09T23:42:54.9555693Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:32:
2025-11-09T23:42:54.9556711Z -    
2025-11-09T23:42:54.9556991Z +
2025-11-09T23:42:54.9557270Z      // Verify we can retrieve it
2025-11-09T23:42:54.9557765Z      use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:42:54.9558271Z      let tx_hash = calculate_tx_id(&tx);
2025-11-09T23:42:54.9559044Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:42:
2025-11-09T23:42:54.9559917Z  async fn test_mempool_get_prioritized_transactions() {
2025-11-09T23:42:54.9560508Z      let mut mempool = MempoolManager::new();
2025-11-09T23:42:54.9561028Z      let mut utxo_set: UtxoSet = HashMap::new();
2025-11-09T23:42:54.9561463Z -    
2025-11-09T23:42:54.9561719Z +
2025-11-09T23:42:54.9561979Z      // Create UTXO for input
2025-11-09T23:42:54.9562351Z      let outpoint = OutPoint {
2025-11-09T23:42:54.9562706Z          hash: [0u8; 32],
2025-11-09T23:42:54.9563363Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:49:
2025-11-09T23:42:54.9564769Z          index: 0,
2025-11-09T23:42:54.9565070Z      };
2025-11-09T23:42:54.9565449Z -    utxo_set.insert(outpoint.clone(), UTXO {
2025-11-09T23:42:54.9565913Z -        value: 10000,
2025-11-09T23:42:54.9566273Z -        script_pubkey: vec![0x51],
2025-11-09T23:42:54.9566720Z -    });
2025-11-09T23:42:54.9566994Z -    
2025-11-09T23:42:54.9567265Z +    utxo_set.insert(
2025-11-09T23:42:54.9567609Z +        outpoint.clone(),
2025-11-09T23:42:54.9567952Z +        UTXO {
2025-11-09T23:42:54.9568270Z +            value: 10000,
2025-11-09T23:42:54.9568669Z +            script_pubkey: vec![0x51],
2025-11-09T23:42:54.9569083Z +        },
2025-11-09T23:42:54.9569367Z +    );
2025-11-09T23:42:54.9569624Z +
2025-11-09T23:42:54.9569986Z      // Create two transactions with different fee rates
2025-11-09T23:42:54.9570494Z      // High fee transaction
2025-11-09T23:42:54.9571075Z      let high_fee_tx = Transaction {
2025-11-09T23:42:54.9571969Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:68:
2025-11-09T23:42:54.9572729Z          }],
2025-11-09T23:42:54.9573014Z          lock_time: 0,
2025-11-09T23:42:54.9573342Z      };
2025-11-09T23:42:54.9573605Z -    
2025-11-09T23:42:54.9573865Z +
2025-11-09T23:42:54.9574149Z      // Low fee transaction
2025-11-09T23:42:54.9574642Z      let low_fee_tx = Transaction {
2025-11-09T23:42:54.9575004Z          version: 1,
2025-11-09T23:42:54.9575687Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:86:
2025-11-09T23:42:54.9576716Z          }],
2025-11-09T23:42:54.9578964Z          lock_time: 0,
2025-11-09T23:42:54.9579312Z      };
2025-11-09T23:42:54.9579565Z -    
2025-11-09T23:42:54.9579829Z +
2025-11-09T23:42:54.9580105Z      // Add both transactions
2025-11-09T23:42:54.9580636Z      mempool.add_transaction(low_fee_tx.clone()).await.unwrap();
2025-11-09T23:42:54.9581342Z      mempool.add_transaction(high_fee_tx.clone()).await.unwrap();
2025-11-09T23:42:54.9582264Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:93:
2025-11-09T23:42:54.9583020Z -    
2025-11-09T23:42:54.9583276Z +
2025-11-09T23:42:54.9583621Z      // Get prioritized (should return high fee first)
2025-11-09T23:42:54.9584463Z      let prioritized = mempool.get_prioritized_transactions(10, &utxo_set);
2025-11-09T23:42:54.9586927Z      assert_eq!(prioritized.len(), 1); // Only one has valid UTXO
2025-11-09T23:42:54.9587818Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:97:
2025-11-09T23:42:54.9588590Z -    
2025-11-09T23:42:54.9588866Z +
2025-11-09T23:42:54.9589178Z      // Verify high fee transaction is first
2025-11-09T23:42:54.9589713Z      use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:42:54.9590273Z      let high_fee_hash = calculate_tx_id(&high_fee_tx);
2025-11-09T23:42:54.9591165Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:104:
2025-11-09T23:42:54.9592174Z  #[tokio::test]
2025-11-09T23:42:54.9592553Z  async fn test_mempool_remove_transaction() {
2025-11-09T23:42:54.9593075Z      let mut mempool = MempoolManager::new();
2025-11-09T23:42:54.9593503Z -    
2025-11-09T23:42:54.9593767Z +
2025-11-09T23:42:54.9594036Z      let tx = Transaction {
2025-11-09T23:42:54.9594563Z          version: 1,
2025-11-09T23:42:54.9596900Z          inputs: vec![TransactionInput {
2025-11-09T23:42:54.9597698Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:121:
2025-11-09T23:42:54.9598460Z          }],
2025-11-09T23:42:54.9598746Z          lock_time: 0,
2025-11-09T23:42:54.9599053Z      };
2025-11-09T23:42:54.9599310Z -    
2025-11-09T23:42:54.9599566Z +
2025-11-09T23:42:54.9599935Z      mempool.add_transaction(tx.clone()).await.unwrap();
2025-11-09T23:42:54.9600474Z      assert_eq!(mempool.size(), 1);
2025-11-09T23:42:54.9600875Z -    
2025-11-09T23:42:54.9601144Z +
2025-11-09T23:42:54.9601501Z      use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:42:54.9602015Z      let tx_hash = calculate_tx_id(&tx);
2025-11-09T23:42:54.9602543Z      let removed = mempool.remove_transaction(&tx_hash);
2025-11-09T23:42:54.9603397Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:131:
2025-11-09T23:42:54.9604169Z      assert!(removed);
2025-11-09T23:42:54.9604712Z      assert_eq!(mempool.size(), 0);
2025-11-09T23:42:54.9605120Z  }
2025-11-09T23:42:54.9605377Z -
2025-11-09T23:42:54.9605639Z  
2025-11-09T23:42:54.9606203Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:1:
2025-11-09T23:42:54.9606987Z -use bllvm_protocol::ProtocolVersion;
2025-11-09T23:42:54.9607477Z  use bllvm_node::storage::blockstore::BlockStore;
2025-11-09T23:42:54.9608009Z  use bllvm_node::storage::chainstate::ChainState;
2025-11-09T23:42:54.9608537Z  use bllvm_node::storage::txindex::TxIndex;
2025-11-09T23:42:54.9609282Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:9:
2025-11-09T23:42:54.9610038Z  use bllvm_node::OutPoint;
2025-11-09T23:42:54.9610435Z  use bllvm_node::Transaction;
2025-11-09T23:42:54.9611006Z  use bllvm_node::{ByteString, TransactionInput, TransactionOutput};
2025-11-09T23:42:54.9611639Z +use bllvm_protocol::ProtocolVersion;
2025-11-09T23:42:54.9612099Z  use std::collections::HashMap;
2025-11-09T23:42:54.9612499Z  use tempfile::TempDir;
2025-11-09T23:42:54.9612831Z  
2025-11-09T23:42:54.9613497Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_property_tests.rs:2:
2025-11-09T23:42:54.9615013Z  //!
2025-11-09T23:42:54.9615544Z  //! Uses proptest to verify invariants and properties that should hold for all inputs.
2025-11-09T23:42:54.9616182Z  
2025-11-09T23:42:54.9616435Z -use hex;
2025-11-09T23:42:54.9616727Z -use proptest::prelude::*;
2025-11-09T23:42:54.9618756Z +use bllvm_node::node::mempool::MempoolManager;
2025-11-09T23:42:54.9619331Z +use bllvm_node::rpc::mining::MiningRpc;
2025-11-09T23:42:54.9619944Z +use bllvm_node::storage::Storage;
2025-11-09T23:42:54.9620485Z  use bllvm_protocol::serialization::serialize_transaction;
2025-11-09T23:42:54.9621052Z  use bllvm_protocol::types::{
2025-11-09T23:42:54.9621676Z      BlockHeader, OutPoint, Transaction, TransactionInput, TransactionOutput,
2025-11-09T23:42:54.9622740Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_property_tests.rs:10:
2025-11-09T23:42:54.9623552Z  };
2025-11-09T23:42:54.9623903Z -use bllvm_node::node::mempool::MempoolManager;
2025-11-09T23:42:54.9624633Z -use bllvm_node::rpc::mining::MiningRpc;
2025-11-09T23:42:54.9625120Z -use bllvm_node::storage::Storage;
2025-11-09T23:42:54.9626920Z +use hex;
2025-11-09T23:42:54.9627222Z +use proptest::prelude::*;
2025-11-09T23:42:54.9627618Z  use sha2::{Digest, Sha256};
2025-11-09T23:42:54.9627999Z  use std::sync::Arc;
2025-11-09T23:42:54.9628340Z  use tempfile::TempDir;
2025-11-09T23:42:54.9629162Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_rpc_implementation_tests.rs:1:
2025-11-09T23:42:54.9630312Z  //! Tests for mining RPC implementation
2025-11-09T23:42:54.9630706Z  
2025-11-09T23:42:54.9631044Z +use bllvm_node::node::mempool::MempoolManager;
2025-11-09T23:42:54.9631559Z  use bllvm_node::rpc::mining::MiningRpc;
2025-11-09T23:42:54.9632016Z  use bllvm_node::storage::Storage;
2025-11-09T23:42:54.9632492Z -use bllvm_node::node::mempool::MempoolManager;
2025-11-09T23:42:54.9632977Z +use serde_json::json;
2025-11-09T23:42:54.9633322Z  use std::sync::Arc;
2025-11-09T23:42:54.9633675Z  use tempfile::TempDir;
2025-11-09T23:42:54.9634026Z -use serde_json::json;
2025-11-09T23:42:54.9634546Z  
2025-11-09T23:42:54.9634828Z  #[tokio::test]
2025-11-09T23:42:54.9635161Z  async fn test_get_mining_info() {
2025-11-09T23:42:54.9636042Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_rpc_implementation_tests.rs:12:
2025-11-09T23:42:54.9636984Z      let temp_dir = TempDir::new().unwrap();
2025-11-09T23:42:54.9637532Z      let storage = Storage::new(temp_dir.path()).unwrap();
2025-11-09T23:42:54.9638080Z      let mempool = MempoolManager::new();
2025-11-09T23:42:54.9638494Z -    
2025-11-09T23:42:54.9638731Z +
2025-11-09T23:42:54.9639262Z      let mining_rpc = MiningRpc::with_dependencies(Arc::new(storage), Arc::new(mempool));
2025-11-09T23:42:54.9639920Z -    
2025-11-09T23:42:54.9640185Z +
2025-11-09T23:42:54.9640542Z      let info = mining_rpc.get_mining_info().await.unwrap();
2025-11-09T23:42:54.9641025Z -    
2025-11-09T23:42:54.9641268Z +
2025-11-09T23:42:54.9641554Z      // Verify response structure
2025-11-09T23:42:54.9641963Z      assert!(info.get("blocks").is_some());
2025-11-09T23:42:54.9642443Z      assert!(info.get("pooledtx").is_some());
2025-11-09T23:42:54.9643372Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_rpc_implementation_tests.rs:29:
2025-11-09T23:42:54.9644467Z      let temp_dir = TempDir::new().unwrap();
2025-11-09T23:42:54.9645031Z      let storage = Storage::new(temp_dir.path()).unwrap();
2025-11-09T23:42:54.9645530Z      let mempool = MempoolManager::new();
2025-11-09T23:42:54.9645960Z -    
2025-11-09T23:42:54.9646222Z +
2025-11-09T23:42:54.9646758Z      let mining_rpc = MiningRpc::with_dependencies(Arc::new(storage), Arc::new(mempool));
2025-11-09T23:42:54.9647432Z -    
2025-11-09T23:42:54.9647692Z +
2025-11-09T23:42:54.9647973Z      let params = json!([]);
2025-11-09T23:42:54.9648492Z      let template = mining_rpc.get_block_template(&params).await;
2025-11-09T23:42:54.9649031Z -    
2025-11-09T23:42:54.9649570Z +
2025-11-09T23:42:54.9650428Z      // Should either succeed or fail gracefully
2025-11-09T23:42:54.9651002Z      // (may fail if chain not initialized, which is expected)
2025-11-09T23:42:54.9651603Z      assert!(template.is_ok() || template.is_err());
2025-11-09T23:42:54.9652555Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_rpc_implementation_tests.rs:45:
2025-11-09T23:42:54.9653520Z      let temp_dir = TempDir::new().unwrap();
2025-11-09T23:42:54.9654079Z      let storage = Storage::new(temp_dir.path()).unwrap();
2025-11-09T23:42:54.9654830Z      let mempool = MempoolManager::new();
2025-11-09T23:42:54.9655273Z -    
2025-11-09T23:42:54.9655537Z +
2025-11-09T23:42:54.9656071Z      let mining_rpc = MiningRpc::with_dependencies(Arc::new(storage), Arc::new(mempool));
2025-11-09T23:42:54.9656735Z -    
2025-11-09T23:42:54.9658664Z +
2025-11-09T23:42:54.9659171Z      // Create a minimal invalid block hex (will fail validation, which is expected)
2025-11-09T23:42:54.9660105Z      let invalid_block_hex = "0000000000000000000000000000000000000000000000000000000000000000";
2025-11-09T23:42:54.9660864Z      let params = json!([invalid_block_hex, ""]);
2025-11-09T23:42:54.9661876Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_rpc_implementation_tests.rs:54:
2025-11-09T23:42:54.9662751Z -    
2025-11-09T23:42:54.9663001Z +
2025-11-09T23:42:54.9663365Z      let result = mining_rpc.submit_block(&params).await;
2025-11-09T23:42:54.9664158Z -    
2025-11-09T23:42:54.9666499Z +
2025-11-09T23:42:54.9666877Z      // Should fail validation (expected for invalid block)
2025-11-09T23:42:54.9667398Z      assert!(result.is_err());
2025-11-09T23:42:54.9667770Z  }
2025-11-09T23:42:54.9668512Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_rpc_implementation_tests.rs:63:
2025-11-09T23:42:54.9669465Z      let temp_dir = TempDir::new().unwrap();
2025-11-09T23:42:54.9670002Z      let storage = Storage::new(temp_dir.path()).unwrap();
2025-11-09T23:42:54.9670193Z      let mempool = MempoolManager::new();
2025-11-09T23:42:54.9670302Z -    
2025-11-09T23:42:54.9670405Z +
2025-11-09T23:42:54.9670792Z      let mining_rpc = MiningRpc::with_dependencies(Arc::new(storage), Arc::new(mempool));
2025-11-09T23:42:54.9670904Z -    
2025-11-09T23:42:54.9671011Z +
2025-11-09T23:42:54.9671180Z      let params = json!([6, "conservative"]);
2025-11-09T23:42:54.9671530Z      let fee_estimate = mining_rpc.estimate_smart_fee(&params).await.unwrap();
2025-11-09T23:42:54.9671641Z -    
2025-11-09T23:42:54.9671754Z +
2025-11-09T23:42:54.9671900Z      // Verify response structure
2025-11-09T23:42:54.9672100Z      assert!(fee_estimate.get("feerate").is_some());
2025-11-09T23:42:54.9672297Z      assert!(fee_estimate.get("blocks").is_some());
2025-11-09T23:42:54.9672902Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_rpc_implementation_tests.rs:75:
2025-11-09T23:42:54.9673207Z      assert_eq!(fee_estimate.get("blocks").unwrap().as_u64().unwrap(), 6);
2025-11-09T23:42:54.9673330Z  }
2025-11-09T23:42:54.9673436Z -
2025-11-09T23:42:54.9673543Z  
2025-11-09T23:42:54.9673955Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:1:
2025-11-09T23:42:54.9674139Z -use bllvm_protocol::ProtocolVersion;
2025-11-09T23:42:54.9674333Z  use bllvm_node::storage::blockstore::BlockStore;
2025-11-09T23:42:54.9676495Z  use bllvm_node::storage::chainstate::ChainState;
2025-11-09T23:42:54.9676693Z  use bllvm_node::storage::txindex::TxIndex;
2025-11-09T23:42:54.9677116Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:9:
2025-11-09T23:42:54.9677269Z  use bllvm_node::OutPoint;
2025-11-09T23:42:54.9677428Z  use bllvm_node::Transaction;
2025-11-09T23:42:54.9677732Z  use bllvm_node::{ByteString, TransactionInput, TransactionOutput};
2025-11-09T23:42:54.9677905Z +use bllvm_protocol::ProtocolVersion;
2025-11-09T23:42:54.9678055Z  use std::collections::HashMap;
2025-11-09T23:42:54.9678462Z  use tempfile::TempDir;
2025-11-09T23:42:54.9678576Z  
2025-11-09T23:42:54.9679156Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_rpc_tests.rs:1:
2025-11-09T23:42:54.9679323Z  //! Unit tests for Mining RPC methods
2025-11-09T23:42:54.9679433Z  
2025-11-09T23:42:54.9679696Z -use bllvm_protocol::serialization::serialize_transaction;
2025-11-09T23:42:54.9680097Z -use bllvm_protocol::{BlockHeader, Natural, OutPoint, Transaction, UtxoSet, UTXO};
2025-11-09T23:42:54.9680312Z  use bllvm_node::node::mempool::MempoolManager;
2025-11-09T23:42:54.9680483Z  use bllvm_node::rpc::mining::MiningRpc;
2025-11-09T23:42:54.9680650Z  use bllvm_node::storage::Storage;
2025-11-09T23:42:54.9681127Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_rpc_tests.rs:8:
2025-11-09T23:42:54.9681381Z +use bllvm_protocol::serialization::serialize_transaction;
2025-11-09T23:42:54.9681771Z +use bllvm_protocol::{BlockHeader, Natural, OutPoint, Transaction, UtxoSet, UTXO};
2025-11-09T23:42:54.9681921Z  use std::sync::Arc;
2025-11-09T23:42:54.9682056Z  use tempfile::TempDir;
2025-11-09T23:42:54.9684153Z  // Sha256 not needed directly in tests
2025-11-09T23:42:54.9684900Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/module_process_sharing_tests.rs:3:
2025-11-09T23:42:54.9685208Z  use bllvm_node::module::process::monitor::ModuleProcessMonitor;
2025-11-09T23:42:54.9685818Z  use bllvm_node::module::process::spawner::{ModuleProcess, ModuleProcessSpawner};
2025-11-09T23:42:54.9685968Z  use std::sync::{Arc, Mutex};
2025-11-09T23:42:54.9686103Z -use tokio::sync::mpsc;
2025-11-09T23:42:54.9686238Z  use tempfile::TempDir;
2025-11-09T23:42:54.9686379Z +use tokio::sync::mpsc;
2025-11-09T23:42:54.9686488Z  
2025-11-09T23:42:54.9686609Z  #[tokio::test]
2025-11-09T23:42:54.9686781Z  async fn test_monitor_module_shared() {
2025-11-09T23:42:54.9687358Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/module_process_sharing_tests.rs:11:
2025-11-09T23:42:54.9687544Z      let temp_dir = TempDir::new().unwrap();
2025-11-09T23:42:54.9687772Z      let (crash_tx, _crash_rx) = mpsc::unbounded_channel();
2025-11-09T23:42:54.9688002Z      let monitor = ModuleProcessMonitor::new(crash_tx);
2025-11-09T23:42:54.9688114Z -    
2025-11-09T23:42:54.9688221Z +
2025-11-09T23:42:54.9688529Z      // Create a dummy process (using true command which exits immediately)
2025-11-09T23:42:54.9688750Z -    let process = tokio::process::Command::new("true")
2025-11-09T23:42:54.9688872Z -        .spawn()
2025-11-09T23:42:54.9688992Z -        .unwrap();
2025-11-09T23:42:54.9689108Z -    
2025-11-09T23:42:54.9689408Z +    let process = tokio::process::Command::new("true").spawn().unwrap();
2025-11-09T23:42:54.9689520Z +
2025-11-09T23:42:54.9689696Z      let module_process = ModuleProcess {
2025-11-09T23:42:54.9689854Z          module_name: "test".to_string(),
2025-11-09T23:42:54.9689974Z          process,
2025-11-09T23:42:54.9690552Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/module_process_sharing_tests.rs:23:
2025-11-09T23:42:54.9690765Z          socket_path: std::path::PathBuf::new(),
2025-11-09T23:42:54.9690893Z          client: None,
2025-11-09T23:42:54.9691005Z      };
2025-11-09T23:42:54.9691122Z -    
2025-11-09T23:42:54.9691232Z +
2025-11-09T23:42:54.9691489Z      let shared_process = Arc::new(Mutex::new(module_process));
2025-11-09T23:42:54.9691609Z -    
2025-11-09T23:42:54.9691723Z +
2025-11-09T23:42:54.9691911Z      // Test that monitor_module_shared can be called
2025-11-09T23:42:54.9692120Z      // (will exit quickly since process exits immediately)
2025-11-09T23:42:54.9692531Z -    let result = monitor.monitor_module_shared("test".to_string(), shared_process).await;
2025-11-09T23:42:54.9692642Z -    
2025-11-09T23:42:54.9692779Z +    let result = monitor
2025-11-09T23:42:54.9693044Z +        .monitor_module_shared("test".to_string(), shared_process)
2025-11-09T23:42:54.9693162Z +        .await;
2025-11-09T23:42:54.9693269Z +
2025-11-09T23:42:54.9695711Z      // Should succeed (process exits normally)
2025-11-09T23:42:54.9695890Z      assert!(result.is_ok());
2025-11-09T23:42:54.9696003Z  }
2025-11-09T23:42:54.9696583Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/module_process_sharing_tests.rs:36:
2025-11-09T23:42:54.9696705Z -
2025-11-09T23:42:54.9696812Z  
2025-11-09T23:42:54.9697228Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:1:
2025-11-09T23:42:54.9697418Z -use bllvm_protocol::ProtocolVersion;
2025-11-09T23:42:54.9697633Z  use bllvm_node::storage::blockstore::BlockStore;
2025-11-09T23:42:54.9697833Z  use bllvm_node::storage::chainstate::ChainState;
2025-11-09T23:42:54.9698008Z  use bllvm_node::storage::txindex::TxIndex;
2025-11-09T23:42:54.9698432Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:9:
2025-11-09T23:42:54.9698585Z  use bllvm_node::OutPoint;
2025-11-09T23:42:54.9698731Z  use bllvm_node::Transaction;
2025-11-09T23:42:54.9699064Z  use bllvm_node::{ByteString, TransactionInput, TransactionOutput};
2025-11-09T23:42:54.9699234Z +use bllvm_protocol::ProtocolVersion;
2025-11-09T23:42:54.9699409Z  use std::collections::HashMap;
2025-11-09T23:42:54.9699550Z  use tempfile::TempDir;
2025-11-09T23:42:54.9699659Z  
2025-11-09T23:42:54.9739323Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:8:
2025-11-09T23:42:54.9740426Z  use std::net::SocketAddr;
2025-11-09T23:42:54.9741580Z  use tokio::sync::mpsc;
2025-11-09T23:42:54.9742908Z  mod common;
2025-11-09T23:42:54.9746311Z -use common::*;
2025-11-09T23:42:54.9747607Z  use bllvm_node::network::inventory::{InventoryRequest, MSG_BLOCK, MSG_TX};
2025-11-09T23:42:54.9748191Z  use bllvm_node::network::protocol::InventoryItem as NetworkInventoryItem;
2025-11-09T23:42:54.9759026Z +use common::*;
2025-11-09T23:42:54.9759178Z  
2025-11-09T23:42:54.9759324Z  #[tokio::test]
2025-11-09T23:42:54.9759519Z  async fn test_network_manager_creation() {
2025-11-09T23:42:54.9760038Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:878:
2025-11-09T23:42:54.9760207Z  async fn test_persistent_peers() {
2025-11-09T23:42:54.9760430Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:42:54.9760630Z      let manager = NetworkManager::new(addr);
2025-11-09T23:42:54.9760743Z -    
2025-11-09T23:42:54.9760855Z +
2025-11-09T23:42:54.9761198Z      let peer1: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:42:54.9761430Z      let peer2: SocketAddr = "127.0.0.1:8334".parse().unwrap();
2025-11-09T23:42:54.9761542Z -    
2025-11-09T23:42:54.9761657Z +
2025-11-09T23:42:54.9761813Z      // Test adding persistent peers
2025-11-09T23:42:54.9761977Z      manager.add_persistent_peer(peer1);
2025-11-09T23:42:54.9762140Z      manager.add_persistent_peer(peer2);
2025-11-09T23:42:54.9762619Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:888:
2025-11-09T23:42:54.9762743Z -    
2025-11-09T23:42:54.9762852Z +
2025-11-09T23:42:54.9763077Z      let persistent = manager.get_persistent_peers();
2025-11-09T23:42:54.9763863Z      assert_eq!(persistent.len(), 2);
2025-11-09T23:42:54.9764125Z      assert!(persistent.contains(&peer1));
2025-11-09T23:42:54.9766690Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:892:
2025-11-09T23:42:54.9766878Z      assert!(persistent.contains(&peer2));
2025-11-09T23:42:54.9767002Z -    
2025-11-09T23:42:54.9767106Z +
2025-11-09T23:42:54.9767278Z      // Test removing persistent peer
2025-11-09T23:42:54.9767446Z      manager.remove_persistent_peer(peer1);
2025-11-09T23:42:54.9767644Z      let persistent = manager.get_persistent_peers();
2025-11-09T23:42:54.9768127Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:903:
2025-11-09T23:42:54.9768276Z  async fn test_ban_list() {
2025-11-09T23:42:54.9768495Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:42:54.9768970Z      let manager = NetworkManager::new(addr);
2025-11-09T23:42:54.9769086Z -    
2025-11-09T23:42:54.9769193Z +
2025-11-09T23:42:54.9769471Z      let banned_peer: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:42:54.9769595Z -    
2025-11-09T23:42:54.9769702Z +
2025-11-09T23:42:54.9769872Z      // Test banning a peer (permanent ban)
2025-11-09T23:42:54.9770044Z      manager.ban_peer(banned_peer, 0);
2025-11-09T23:42:54.9770225Z      assert!(manager.is_banned(banned_peer));
2025-11-09T23:42:54.9770714Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:912:
2025-11-09T23:42:54.9770828Z -    
2025-11-09T23:42:54.9770949Z +
2025-11-09T23:42:54.9771101Z      // Test getting banned peers
2025-11-09T23:42:54.9771273Z      let banned = manager.get_banned_peers();
2025-11-09T23:42:54.9771424Z      assert_eq!(banned.len(), 1);
2025-11-09T23:42:54.9771896Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:916:
2025-11-09T23:42:54.9772747Z      assert_eq!(banned[0].0, banned_peer);
2025-11-09T23:42:54.9772887Z -    
2025-11-09T23:42:54.9773005Z +
2025-11-09T23:42:54.9773140Z      // Test unbanning
2025-11-09T23:42:54.9773297Z      manager.unban_peer(banned_peer);
2025-11-09T23:42:54.9773484Z      assert!(!manager.is_banned(banned_peer));
2025-11-09T23:42:54.9773946Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:921:
2025-11-09T23:42:54.9776446Z -    
2025-11-09T23:42:54.9776565Z +
2025-11-09T23:42:54.9776709Z      // Test temporary ban
2025-11-09T23:42:54.9776879Z      use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:42:54.9777020Z      let now = SystemTime::now()
2025-11-09T23:42:54.9777480Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:928:
2025-11-09T23:42:54.9777659Z      let unban_time = now + 3600; // 1 hour from now
2025-11-09T23:42:54.9777831Z      manager.ban_peer(banned_peer, unban_time);
2025-11-09T23:42:54.9778011Z      assert!(manager.is_banned(banned_peer));
2025-11-09T23:42:54.9778126Z -    
2025-11-09T23:42:54.9778235Z +
2025-11-09T23:42:54.9778364Z      // Test clearing all bans
2025-11-09T23:42:54.9778499Z      manager.clear_bans();
2025-11-09T23:42:54.9778664Z      assert!(!manager.is_banned(banned_peer));
2025-11-09T23:42:54.9779124Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:939:
2025-11-09T23:42:54.9779302Z  async fn test_network_stats() {
2025-11-09T23:42:54.9779519Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:42:54.9779702Z      let manager = NetworkManager::new(addr);
2025-11-09T23:42:54.9779813Z -    
2025-11-09T23:42:54.9779928Z +
2025-11-09T23:42:54.9780080Z      // Initially stats should be zero
2025-11-09T23:42:54.9780290Z      let (sent, received) = manager.get_network_stats();
2025-11-09T23:42:54.9780426Z      assert_eq!(sent, 0);
2025-11-09T23:42:54.9780886Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:946:
2025-11-09T23:42:54.9781040Z      assert_eq!(received, 0);
2025-11-09T23:42:54.9781159Z -    
2025-11-09T23:42:54.9781272Z +
2025-11-09T23:42:54.9781403Z      // Track some bytes
2025-11-09T23:42:54.9781554Z      manager.track_bytes_sent(100);
2025-11-09T23:42:54.9781721Z      manager.track_bytes_received(200);
2025-11-09T23:42:54.9782182Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:951:
2025-11-09T23:42:54.9782303Z -    
2025-11-09T23:42:54.9782421Z +
2025-11-09T23:42:54.9782625Z      let (sent, received) = manager.get_network_stats();
2025-11-09T23:42:54.9782760Z      assert_eq!(sent, 100);
2025-11-09T23:42:54.9782899Z      assert_eq!(received, 200);
2025-11-09T23:42:54.9783374Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:955:
2025-11-09T23:42:54.9783491Z -    
2025-11-09T23:42:54.9783602Z +
2025-11-09T23:42:54.9783776Z      // Track more bytes (should accumulate)
2025-11-09T23:42:54.9784184Z      manager.track_bytes_sent(50);
2025-11-09T23:42:54.9784537Z      manager.track_bytes_received(75);
2025-11-09T23:42:54.9785017Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:959:
2025-11-09T23:42:54.9785137Z -    
2025-11-09T23:42:54.9785248Z +
2025-11-09T23:42:54.9785445Z      let (sent, received) = manager.get_network_stats();
2025-11-09T23:42:54.9785594Z      assert_eq!(sent, 150);
2025-11-09T23:42:54.9785735Z      assert_eq!(received, 275);
2025-11-09T23:42:54.9786194Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:966:
2025-11-09T23:42:54.9786352Z  async fn test_ping_all_peers() {
2025-11-09T23:42:54.9786581Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:42:54.9786774Z      let manager = NetworkManager::new(addr);
2025-11-09T23:42:54.9786885Z -    
2025-11-09T23:42:54.9787000Z +
2025-11-09T23:42:54.9787188Z      // Test ping with no peers (should not error)
2025-11-09T23:42:54.9787386Z      let result = manager.ping_all_peers().await;
2025-11-09T23:42:54.9787527Z      assert!(result.is_ok());
2025-11-09T23:42:54.9787989Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:973:
2025-11-09T23:42:54.9788096Z -    
2025-11-09T23:42:54.9788203Z +
2025-11-09T23:42:54.9788525Z      // Note: Testing with actual peers would require setting up connections,
2025-11-09T23:42:54.9789109Z      // which is more complex. This test verifies the method doesn't panic.
2025-11-09T23:42:54.9789216Z  }
2025-11-09T23:42:54.9789666Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:1:
2025-11-09T23:42:54.9789847Z -use bllvm_protocol::ProtocolVersion;
2025-11-09T23:42:54.9790050Z  use bllvm_node::storage::blockstore::BlockStore;
2025-11-09T23:42:54.9790252Z  use bllvm_node::storage::chainstate::ChainState;
2025-11-09T23:42:54.9790426Z  use bllvm_node::storage::txindex::TxIndex;
2025-11-09T23:42:54.9790846Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:9:
2025-11-09T23:42:54.9790994Z  use bllvm_node::OutPoint;
2025-11-09T23:42:54.9791152Z  use bllvm_node::Transaction;
2025-11-09T23:42:54.9791458Z  use bllvm_node::{ByteString, TransactionInput, TransactionOutput};
2025-11-09T23:42:54.9791630Z +use bllvm_protocol::ProtocolVersion;
2025-11-09T23:42:54.9791792Z  use std::collections::HashMap;
2025-11-09T23:42:54.9791940Z  use tempfile::TempDir;
2025-11-09T23:42:54.9792045Z  
2025-11-09T23:42:54.9818151Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/node_tests.rs:5:
2025-11-09T23:42:54.9819319Z  use std::net::SocketAddr;
2025-11-09T23:42:54.9820455Z  use tempfile::TempDir;
2025-11-09T23:42:54.9821579Z  mod common;
2025-11-09T23:42:54.9822709Z -use common::*;
2025-11-09T23:42:54.9823883Z  use bllvm_protocol::ProtocolVersion;
2025-11-09T23:42:54.9825252Z +use common::*;
2025-11-09T23:42:54.9825408Z  
2025-11-09T23:42:54.9825928Z  #[tokio::test]
2025-11-09T23:42:54.9826108Z  async fn test_node_creation() {
2025-11-09T23:42:54.9828999Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/peer_stats_tests.rs:3:
2025-11-09T23:42:54.9830376Z  use bllvm_node::network::peer::Peer;
2025-11-09T23:42:54.9831581Z  use bllvm_node::network::NetworkMessage;
2025-11-09T23:42:54.9833206Z  use std::net::SocketAddr;
2025-11-09T23:42:54.9835178Z -use tokio::sync::mpsc;
2025-11-09T23:42:54.9836029Z  use tokio::net::TcpStream;
2025-11-09T23:42:54.9836183Z +use tokio::sync::mpsc;
2025-11-09T23:42:54.9836305Z  
2025-11-09T23:42:54.9836431Z  #[tokio::test]
2025-11-09T23:42:54.9836618Z  async fn test_peer_stats_initialization() {
2025-11-09T23:42:54.9837118Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/peer_stats_tests.rs:11:
2025-11-09T23:42:54.9837357Z      let addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:42:54.9837539Z      let (tx, _rx) = mpsc::unbounded_channel();
2025-11-09T23:42:54.9837930Z -    
2025-11-09T23:42:54.9838059Z +
2025-11-09T23:42:54.9838198Z      // Create a mock stream
2025-11-09T23:42:54.9838534Z      let listener = tokio::net::TcpListener::bind("127.0.0.1:0").await.unwrap();
2025-11-09T23:42:54.9838748Z      let local_addr = listener.local_addr().unwrap();
2025-11-09T23:42:54.9839256Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/peer_stats_tests.rs:17:
2025-11-09T23:42:54.9839605Z      let stream = tokio::net::TcpStream::connect(local_addr).await.unwrap();
2025-11-09T23:42:54.9839731Z -    
2025-11-09T23:42:54.9839841Z +
2025-11-09T23:42:54.9840031Z      let peer = Peer::new(stream, addr, tx);
2025-11-09T23:42:54.9840147Z -    
2025-11-09T23:42:54.9840264Z +
2025-11-09T23:42:54.9840399Z      // Check initial stats
2025-11-09T23:42:54.9840556Z      assert!(peer.conntime() > 0);
2025-11-09T23:42:54.9840847Z      assert_eq!(peer.conntime(), peer.last_send());
2025-11-09T23:42:54.9841346Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/peer_stats_tests.rs:30:
2025-11-09T23:42:54.9841519Z  async fn test_peer_record_send() {
2025-11-09T23:42:54.9841762Z      let addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:42:54.9841936Z      let (tx, _rx) = mpsc::unbounded_channel();
2025-11-09T23:42:54.9842051Z -    
2025-11-09T23:42:54.9842167Z +
2025-11-09T23:42:54.9842497Z      let listener = tokio::net::TcpListener::bind("127.0.0.1:0").await.unwrap();
2025-11-09T23:42:54.9842960Z      let local_addr = listener.local_addr().unwrap();
2025-11-09T23:42:54.9843281Z      let stream = tokio::net::TcpStream::connect(local_addr).await.unwrap();
2025-11-09T23:42:54.9843788Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/peer_stats_tests.rs:37:
2025-11-09T23:42:54.9843900Z -    
2025-11-09T23:42:54.9844005Z +
2025-11-09T23:42:54.9844196Z      let mut peer = Peer::new(stream, addr, tx);
2025-11-09T23:42:54.9844500Z -    
2025-11-09T23:42:54.9844614Z +
2025-11-09T23:42:54.9844781Z      let initial_send = peer.last_send();
2025-11-09T23:42:54.9844958Z      let initial_bytes = peer.bytes_sent();
2025-11-09T23:42:54.9845068Z -    
2025-11-09T23:42:54.9845175Z +
2025-11-09T23:42:54.9845305Z      // Record a send
2025-11-09T23:42:54.9845446Z      peer.record_send(100);
2025-11-09T23:42:54.9845559Z -    
2025-11-09T23:42:54.9845681Z +
2025-11-09T23:42:54.9845856Z      assert!(peer.last_send() >= initial_send);
2025-11-09T23:42:54.9846074Z      assert_eq!(peer.bytes_sent(), initial_bytes + 100);
2025-11-09T23:42:54.9846189Z  }
2025-11-09T23:42:54.9846694Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/peer_stats_tests.rs:51:
2025-11-09T23:42:54.9846861Z  async fn test_peer_record_receive() {
2025-11-09T23:42:54.9847092Z      let addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:42:54.9847283Z      let (tx, _rx) = mpsc::unbounded_channel();
2025-11-09T23:42:54.9847401Z -    
2025-11-09T23:42:54.9847511Z +
2025-11-09T23:42:54.9847858Z      let listener = tokio::net::TcpListener::bind("127.0.0.1:0").await.unwrap();
2025-11-09T23:42:54.9848079Z      let local_addr = listener.local_addr().unwrap();
2025-11-09T23:42:54.9848390Z      let stream = tokio::net::TcpStream::connect(local_addr).await.unwrap();
2025-11-09T23:42:54.9848886Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/peer_stats_tests.rs:58:
2025-11-09T23:42:54.9849017Z -    
2025-11-09T23:42:54.9849128Z +
2025-11-09T23:42:54.9849333Z      let mut peer = Peer::new(stream, addr, tx);
2025-11-09T23:42:54.9849460Z -    
2025-11-09T23:42:54.9849568Z +
2025-11-09T23:42:54.9849736Z      let initial_recv = peer.last_recv();
2025-11-09T23:42:54.9849902Z      let initial_bytes = peer.bytes_recv();
2025-11-09T23:42:54.9850021Z -    
2025-11-09T23:42:54.9850129Z +
2025-11-09T23:42:54.9850246Z      // Record a receive
2025-11-09T23:42:54.9850396Z      peer.record_receive(200);
2025-11-09T23:42:54.9850508Z -    
2025-11-09T23:42:54.9850615Z +
2025-11-09T23:42:54.9850794Z      assert!(peer.last_recv() >= initial_recv);
2025-11-09T23:42:54.9851281Z      assert_eq!(peer.bytes_recv(), initial_bytes + 200);
2025-11-09T23:42:54.9851395Z  }
2025-11-09T23:42:54.9851895Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/peer_stats_tests.rs:70:
2025-11-09T23:42:54.9853941Z -
2025-11-09T23:42:54.9854061Z  
2025-11-09T23:42:54.9855063Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/protocol_message_processing_tests.rs:1:
2025-11-09T23:42:54.9855320Z  //! Tests for protocol message processing integration
2025-11-09T23:42:54.9855429Z  
2025-11-09T23:42:54.9855585Z  use bllvm_node::network;
2025-11-09T23:42:54.9855745Z -use bllvm_node::storage::Storage;
2025-11-09T23:42:54.9855951Z  use bllvm_node::node::mempool::MempoolManager;
2025-11-09T23:42:54.9856101Z +use bllvm_node::storage::Storage;
2025-11-09T23:42:54.9856380Z  use bllvm_protocol::{BitcoinProtocolEngine, ProtocolVersion};
2025-11-09T23:42:54.9856516Z -use std::sync::Arc;
2025-11-09T23:42:54.9856696Z  use std::net::SocketAddr;
2025-11-09T23:42:54.9856824Z +use std::sync::Arc;
2025-11-09T23:42:54.9856962Z  use tempfile::TempDir;
2025-11-09T23:42:54.9857085Z  
2025-11-09T23:42:54.9857212Z  #[tokio::test]
2025-11-09T23:42:54.9857892Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/protocol_message_processing_tests.rs:14:
2025-11-09T23:42:54.9858190Z      let storage = Arc::new(Storage::new(temp_dir.path()).unwrap());
2025-11-09T23:42:54.9858623Z      let mempool = Arc::new(MempoolManager::new());
2025-11-09T23:42:54.9859099Z      let protocol_engine = Arc::new(BitcoinProtocolEngine::new(ProtocolVersion::Regtest).unwrap());
2025-11-09T23:42:54.9859215Z -    
2025-11-09T23:42:54.9859327Z +
2025-11-09T23:42:54.9859587Z      let network_addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:42:54.9859882Z -    let network_manager = network::NetworkManager::new(network_addr)
2025-11-09T23:42:54.9860134Z -        .with_dependencies(protocol_engine, storage, mempool);
2025-11-09T23:42:54.9860248Z -    
2025-11-09T23:42:54.9860650Z +    let network_manager = network::NetworkManager::new(network_addr).with_dependencies(
2025-11-09T23:42:54.9860796Z +        protocol_engine,
2025-11-09T23:42:54.9860911Z +        storage,
2025-11-09T23:42:54.9861023Z +        mempool,
2025-11-09T23:42:54.9861135Z +    );
2025-11-09T23:42:54.9861255Z +
2025-11-09T23:42:54.9861409Z      // Verify dependencies are set
2025-11-09T23:42:54.9861766Z      // (NetworkManager doesn't expose these, but we can verify it was created)
2025-11-09T23:42:54.9861970Z      assert!(true); // If we got here, setup worked
2025-11-09T23:42:54.9862591Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/protocol_message_processing_tests.rs:29:
2025-11-09T23:42:54.9862770Z      let temp_dir = TempDir::new().unwrap();
2025-11-09T23:42:54.9863007Z      let storage = Storage::new(temp_dir.path()).unwrap();
2025-11-09T23:42:54.9863203Z      let mempool = Arc::new(MempoolManager::new());
2025-11-09T23:42:54.9863317Z -    
2025-11-09T23:42:54.9863437Z +
2025-11-09T23:42:54.9865608Z      // Verify we can create NodeChainAccess with Storage Arcs
2025-11-09T23:42:54.9865847Z      use bllvm_node::network::chain_access::NodeChainAccess;
2025-11-09T23:42:54.9866035Z -    let chain_access = NodeChainAccess::new(
2025-11-09T23:42:54.9866178Z -        storage.blocks(),
2025-11-09T23:42:54.9866310Z -        storage.transactions(),
2025-11-09T23:42:54.9866421Z -        mempool,
2025-11-09T23:42:54.9866546Z -    );
2025-11-09T23:42:54.9866650Z -    
2025-11-09T23:42:54.9867106Z +    let chain_access = NodeChainAccess::new(storage.blocks(), storage.transactions(), mempool);
2025-11-09T23:42:54.9867212Z +
2025-11-09T23:42:54.9867348Z      // Test that it works
2025-11-09T23:42:54.9867473Z      let hash = [0u8; 32];
2025-11-09T23:42:54.9867719Z      assert!(!chain_access.has_object(&hash)); // Empty storage
2025-11-09T23:42:54.9868348Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/protocol_message_processing_tests.rs:44:
2025-11-09T23:42:54.9868674Z  }
2025-11-09T23:42:54.9868783Z -
2025-11-09T23:42:54.9868891Z  
2025-11-09T23:42:54.9917566Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:1:
2025-11-09T23:42:54.9917791Z -use bllvm_protocol::ProtocolVersion;
2025-11-09T23:42:54.9918001Z  use bllvm_node::storage::blockstore::BlockStore;
2025-11-09T23:42:54.9919128Z  use bllvm_node::storage::chainstate::ChainState;
2025-11-09T23:42:54.9919335Z  use bllvm_node::storage::txindex::TxIndex;
2025-11-09T23:42:54.9919747Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:9:
2025-11-09T23:42:54.9919904Z  use bllvm_node::OutPoint;
2025-11-09T23:42:54.9920048Z  use bllvm_node::Transaction;
2025-11-09T23:42:54.9920345Z  use bllvm_node::{ByteString, TransactionInput, TransactionOutput};
2025-11-09T23:42:54.9920964Z +use bllvm_protocol::ProtocolVersion;
2025-11-09T23:42:54.9921152Z  use std::collections::HashMap;
2025-11-09T23:42:54.9921294Z  use tempfile::TempDir;
2025-11-09T23:42:54.9921419Z  
2025-11-09T23:42:54.9932172Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:10:
2025-11-09T23:42:54.9932442Z  #[tokio::test]
2025-11-09T23:42:54.9932615Z  async fn test_message_size_validation() {
2025-11-09T23:42:54.9932907Z      use bllvm_node::network::protocol::MAX_PROTOCOL_MESSAGE_LENGTH;
2025-11-09T23:42:54.9933018Z -    
2025-11-09T23:42:54.9933396Z +
2025-11-09T23:42:54.9933627Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:42:54.9933821Z      let manager = NetworkManager::new(addr);
2025-11-09T23:42:54.9933938Z -    
2025-11-09T23:42:54.9934044Z +
2025-11-09T23:42:54.9934224Z      // Test that oversized messages are rejected
2025-11-09T23:42:54.9934710Z      // This is tested at the TransportConnection level, but we can verify
2025-11-09T23:42:54.9934891Z      // the protocol parser also validates size
2025-11-09T23:42:54.9935387Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:20:
2025-11-09T23:42:54.9935639Z      use bllvm_node::network::protocol::ProtocolParser;
2025-11-09T23:42:54.9935754Z -    
2025-11-09T23:42:54.9935861Z +
2025-11-09T23:42:54.9936017Z      // Create a message that's too large
2025-11-09T23:42:54.9936305Z      let oversized_data = vec![0u8; MAX_PROTOCOL_MESSAGE_LENGTH + 1];
2025-11-09T23:42:54.9936589Z      let result = ProtocolParser::parse_message(&oversized_data);
2025-11-09T23:42:54.9937141Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:29:
2025-11-09T23:42:54.9937301Z  async fn test_rate_limiting() {
2025-11-09T23:42:54.9937534Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:42:54.9937728Z      let manager = NetworkManager::new(addr);
2025-11-09T23:42:54.9937840Z -    
2025-11-09T23:42:54.9937961Z +
2025-11-09T23:42:54.9938258Z      // Rate limiting is tested implicitly through message processing
2025-11-09T23:42:54.9938582Z      // The rate limiter is checked in process_messages for RawMessageReceived
2025-11-09T23:42:54.9938875Z      // This test verifies the rate limiter structure exists and works
2025-11-09T23:42:54.9939367Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:36:
2025-11-09T23:42:54.9939480Z -    
2025-11-09T23:42:54.9939588Z +
2025-11-09T23:42:54.9939775Z      // Add a peer address to test rate limiting
2025-11-09T23:42:54.9940041Z      let test_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:42:54.9940150Z -    
2025-11-09T23:42:54.9940268Z +
2025-11-09T23:42:54.9940519Z      // Rate limiter should be created when first message arrives
2025-11-09T23:42:54.9940807Z      // We can't easily test this without a real connection, but the structure
2025-11-09T23:42:54.9940999Z      // is in place and will be tested in integration tests
2025-11-09T23:42:54.9941450Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:47:
2025-11-09T23:42:54.9941922Z  async fn test_per_ip_connection_limit() {
2025-11-09T23:42:54.9942140Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:42:54.9942335Z      let manager = NetworkManager::new(addr);
2025-11-09T23:42:54.9942450Z -    
2025-11-09T23:42:54.9942559Z +
2025-11-09T23:42:54.9942736Z      // Test that per-IP limits are enforced
2025-11-09T23:42:54.9943008Z      // This is tested in connect_to_peer, but we need a mock transport
2025-11-09T23:42:54.9943181Z      // For now, verify the structure exists
2025-11-09T23:42:54.9943658Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:54:
2025-11-09T23:42:54.9943840Z      let test_ip = "127.0.0.1".parse().unwrap();
2025-11-09T23:42:54.9943949Z -    
2025-11-09T23:42:54.9944057Z +
2025-11-09T23:42:54.9944283Z      // Connection limits are enforced in connect_to_peer
2025-11-09T23:42:54.9947049Z      // Integration test needed for full verification
2025-11-09T23:42:54.9947398Z      assert!(true); // Placeholder - per-IP limits tested in integration
2025-11-09T23:42:54.9947901Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:62:
2025-11-09T23:42:54.9948057Z  async fn test_ban_list_cleanup() {
2025-11-09T23:42:54.9948271Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:42:54.9948452Z      let manager = NetworkManager::new(addr);
2025-11-09T23:42:54.9948573Z -    
2025-11-09T23:42:54.9948934Z +
2025-11-09T23:42:54.9949107Z      // Test that expired bans are cleaned up
2025-11-09T23:42:54.9949293Z      use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:42:54.9949445Z      let now = SystemTime::now()
2025-11-09T23:42:54.9949925Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:69:
2025-11-09T23:42:54.9950086Z          .duration_since(UNIX_EPOCH)
2025-11-09T23:42:54.9950217Z          .unwrap()
2025-11-09T23:42:54.9950338Z          .as_secs();
2025-11-09T23:42:54.9950445Z -    
2025-11-09T23:42:54.9950635Z +
2025-11-09T23:42:54.9950935Z      let test_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:42:54.9951037Z -    
2025-11-09T23:42:54.9951145Z +
2025-11-09T23:42:54.9951314Z      // Ban with expiration in the past
2025-11-09T23:42:54.9951498Z      let past_timestamp = now - 3600; // 1 hour ago
2025-11-09T23:42:54.9951690Z      manager.ban_peer(test_addr, past_timestamp);
2025-11-09T23:42:54.9952182Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:78:
2025-11-09T23:42:54.9952302Z -    
2025-11-09T23:42:54.9952410Z +
2025-11-09T23:42:54.9952637Z      // is_banned should automatically clean up expired bans
2025-11-09T23:42:54.9952830Z      let was_banned = manager.is_banned(test_addr);
2025-11-09T23:42:54.9953125Z      assert!(!was_banned, "Expired ban should be automatically removed");
2025-11-09T23:42:54.9953581Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:82:
2025-11-09T23:42:54.9953699Z -    
2025-11-09T23:42:54.9953804Z +
2025-11-09T23:42:54.9953947Z      // Verify ban was removed
2025-11-09T23:42:54.9954129Z      let banned = manager.get_banned_peers();
2025-11-09T23:42:54.9956427Z -    assert!(!banned.iter().any(|(addr, _)| *addr == test_addr), 
2025-11-09T23:42:54.9956615Z -            "Expired ban should not be in ban list");
2025-11-09T23:42:54.9956727Z +    assert!(
2025-11-09T23:42:54.9956926Z +        !banned.iter().any(|(addr, _)| *addr == test_addr),
2025-11-09T23:42:54.9957092Z +        "Expired ban should not be in ban list"
2025-11-09T23:42:54.9957197Z +    );
2025-11-09T23:42:54.9957308Z  }
2025-11-09T23:42:54.9957410Z  
2025-11-09T23:42:54.9957532Z  #[tokio::test]
2025-11-09T23:42:54.9957987Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:90:
2025-11-09T23:42:54.9958158Z  async fn test_ban_list_permanent() {
2025-11-09T23:42:54.9958364Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:42:54.9958547Z      let manager = NetworkManager::new(addr);
2025-11-09T23:42:54.9958885Z -    
2025-11-09T23:42:54.9958988Z +
2025-11-09T23:42:54.9959239Z      let test_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:42:54.9959343Z -    
2025-11-09T23:42:54.9959452Z +
2025-11-09T23:42:54.9959614Z      // Test permanent ban (timestamp = 0)
2025-11-09T23:42:54.9959757Z      manager.ban_peer(test_addr, 0);
2025-11-09T23:42:54.9960086Z -    assert!(manager.is_banned(test_addr), "Permanent ban should be active");
2025-11-09T23:42:54.9960195Z -    
2025-11-09T23:42:54.9960308Z +    assert!(
2025-11-09T23:42:54.9960459Z +        manager.is_banned(test_addr),
2025-11-09T23:42:54.9960626Z +        "Permanent ban should be active"
2025-11-09T23:42:54.9960736Z +    );
2025-11-09T23:42:54.9960842Z +
2025-11-09T23:42:54.9960967Z      // Clean up
2025-11-09T23:42:54.9961118Z      manager.unban_peer(test_addr);
2025-11-09T23:42:54.9961458Z -    assert!(!manager.is_banned(test_addr), "Unbanned peer should not be banned");
2025-11-09T23:42:54.9961586Z +    assert!(
2025-11-09T23:42:54.9961743Z +        !manager.is_banned(test_addr),
2025-11-09T23:42:54.9961904Z +        "Unbanned peer should not be banned"
2025-11-09T23:42:54.9962011Z +    );
2025-11-09T23:42:54.9962121Z  }
2025-11-09T23:42:54.9962225Z  
2025-11-09T23:42:54.9962348Z  #[tokio::test]
2025-11-09T23:42:54.9962827Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:106:
2025-11-09T23:42:54.9963206Z  async fn test_ban_list_temporary() {
2025-11-09T23:42:54.9963425Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:42:54.9963600Z      let manager = NetworkManager::new(addr);
2025-11-09T23:42:54.9963716Z -    
2025-11-09T23:42:54.9963822Z +
2025-11-09T23:42:54.9963990Z      use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:42:54.9964144Z      let now = SystemTime::now()
2025-11-09T23:42:54.9964287Z          .duration_since(UNIX_EPOCH)
2025-11-09T23:42:54.9964771Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:113:
2025-11-09T23:42:54.9964897Z          .unwrap()
2025-11-09T23:42:54.9965011Z          .as_secs();
2025-11-09T23:42:54.9965113Z -    
2025-11-09T23:42:54.9965218Z +
2025-11-09T23:42:54.9965479Z      let test_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:42:54.9965591Z -    
2025-11-09T23:42:54.9965696Z +
2025-11-09T23:42:54.9965854Z      // Test temporary ban (1 hour from now)
2025-11-09T23:42:54.9966024Z      let future_timestamp = now + 3600;
2025-11-09T23:42:54.9966398Z      manager.ban_peer(test_addr, future_timestamp);
2025-11-09T23:42:54.9966887Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:121:
2025-11-09T23:42:54.9967256Z -    assert!(manager.is_banned(test_addr), "Active temporary ban should be active");
2025-11-09T23:42:54.9967370Z -    
2025-11-09T23:42:54.9967484Z +    assert!(
2025-11-09T23:42:54.9967635Z +        manager.is_banned(test_addr),
2025-11-09T23:42:54.9967828Z +        "Active temporary ban should be active"
2025-11-09T23:42:54.9967942Z +    );
2025-11-09T23:42:54.9968053Z +
2025-11-09T23:42:54.9968182Z      // Clean up
2025-11-09T23:42:54.9968336Z      manager.unban_peer(test_addr);
2025-11-09T23:42:54.9968961Z  }
2025-11-09T23:42:54.9969500Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:128:
2025-11-09T23:42:54.9969663Z  async fn test_clear_bans() {
2025-11-09T23:42:54.9969900Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:42:54.9970099Z      let manager = NetworkManager::new(addr);
2025-11-09T23:42:54.9970217Z -    
2025-11-09T23:42:54.9970331Z +
2025-11-09T23:42:54.9970580Z      let test_addr1: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:42:54.9970838Z      let test_addr2: SocketAddr = "127.0.0.1:8334".parse().unwrap();
2025-11-09T23:42:54.9970952Z -    
2025-11-09T23:42:54.9971062Z +
2025-11-09T23:42:54.9971200Z      // Add multiple bans
2025-11-09T23:42:54.9971631Z      manager.ban_peer(test_addr1, 0);
2025-11-09T23:42:54.9971788Z      manager.ban_peer(test_addr2, 0);
2025-11-09T23:42:54.9972272Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:138:
2025-11-09T23:42:54.9972390Z -    
2025-11-09T23:42:54.9972502Z +
2025-11-09T23:42:54.9972710Z      assert_eq!(manager.get_banned_peers().len(), 2);
2025-11-09T23:42:54.9972827Z -    
2025-11-09T23:42:54.9972955Z +
2025-11-09T23:42:54.9973084Z      // Clear all bans
2025-11-09T23:42:54.9973222Z      manager.clear_bans();
2025-11-09T23:42:54.9973337Z -    
2025-11-09T23:42:54.9973635Z +
2025-11-09T23:42:54.9973835Z      assert_eq!(manager.get_banned_peers().len(), 0);
2025-11-09T23:42:54.9974005Z      assert!(!manager.is_banned(test_addr1));
2025-11-09T23:42:54.9974174Z      assert!(!manager.is_banned(test_addr2));
2025-11-09T23:42:54.9974829Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:147:
2025-11-09T23:42:54.9974955Z  }
2025-11-09T23:42:54.9975077Z -
2025-11-09T23:42:54.9975183Z  
2025-11-09T23:42:54.9975667Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:2:
2025-11-09T23:42:54.9975763Z  
2025-11-09T23:42:54.9975869Z  #[cfg(test)]
2025-11-09T23:42:54.9975970Z  mod tests {
2025-11-09T23:42:54.9976195Z +    use bllvm_node::network::protocol::NetworkAddress;
2025-11-09T23:42:54.9976426Z      use bllvm_node::network::protocol::VersionMessage;
2025-11-09T23:42:54.9977245Z -    use bllvm_node::network::protocol::{NODE_UTXO_COMMITMENTS, NODE_BAN_LIST_SHARING, NODE_PACKAGE_RELAY, NODE_FIBRE};
2025-11-09T23:42:54.9977412Z +    use bllvm_node::network::protocol::{
2025-11-09T23:42:54.9977774Z +        NODE_BAN_LIST_SHARING, NODE_FIBRE, NODE_PACKAGE_RELAY, NODE_UTXO_COMMITMENTS,
2025-11-09T23:42:54.9977884Z +    };
2025-11-09T23:42:54.9978096Z      use bllvm_protocol::bip157::NODE_COMPACT_FILTERS;
2025-11-09T23:42:54.9978315Z -    use bllvm_node::network::protocol::NetworkAddress;
2025-11-09T23:42:54.9978437Z  
2025-11-09T23:42:54.9978700Z      fn create_version_message(services: u64) -> VersionMessage {
2025-11-09T23:42:54.9978834Z          VersionMessage {
2025-11-09T23:42:54.9979371Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:36:
2025-11-09T23:42:54.9979544Z              // Peer with UTXO commitments support
2025-11-09T23:42:54.9979706Z              let services = NODE_UTXO_COMMITMENTS;
2025-11-09T23:42:54.9979921Z              let version = create_version_message(services);
2025-11-09T23:42:54.9980325Z -            assert!(version.supports_utxo_commitments(), "Should support UTXO commitments");
2025-11-09T23:42:54.9980444Z +            assert!(
2025-11-09T23:42:54.9980617Z +                version.supports_utxo_commitments(),
2025-11-09T23:42:54.9980785Z +                "Should support UTXO commitments"
2025-11-09T23:42:54.9980894Z +            );
2025-11-09T23:42:54.9980998Z  
2025-11-09T23:42:54.9981175Z              // Peer without UTXO commitments support
2025-11-09T23:42:54.9981314Z              let services = 0;
2025-11-09T23:42:54.9981835Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:43:
2025-11-09T23:42:54.9982034Z              let version = create_version_message(services);
2025-11-09T23:42:54.9982469Z -            assert!(!version.supports_utxo_commitments(), "Should not support UTXO commitments");
2025-11-09T23:42:54.9982602Z +            assert!(
2025-11-09T23:42:54.9982789Z +                !version.supports_utxo_commitments(),
2025-11-09T23:42:54.9982973Z +                "Should not support UTXO commitments"
2025-11-09T23:42:54.9983087Z +            );
2025-11-09T23:42:54.9983196Z  
2025-11-09T23:42:54.9983438Z              // Peer with multiple flags including UTXO commitments
2025-11-09T23:42:54.9983820Z              let services = NODE_UTXO_COMMITMENTS | NODE_COMPACT_FILTERS | NODE_PACKAGE_RELAY;
2025-11-09T23:42:54.9984502Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:48:
2025-11-09T23:42:54.9984941Z              let version = create_version_message(services);
2025-11-09T23:42:54.9985458Z -            assert!(version.supports_utxo_commitments(), "Should support UTXO commitments with other flags");
2025-11-09T23:42:54.9985872Z -            assert!(version.supports_compact_filters(), "Should also support compact filters");
2025-11-09T23:42:54.9986325Z -            assert!(version.supports_package_relay(), "Should also support package relay");
2025-11-09T23:42:54.9986455Z +            assert!(
2025-11-09T23:42:54.9986642Z +                version.supports_utxo_commitments(),
2025-11-09T23:42:54.9986868Z +                "Should support UTXO commitments with other flags"
2025-11-09T23:42:54.9986993Z +            );
2025-11-09T23:42:54.9987111Z +            assert!(
2025-11-09T23:42:54.9987289Z +                version.supports_compact_filters(),
2025-11-09T23:42:54.9987462Z +                "Should also support compact filters"
2025-11-09T23:42:54.9987595Z +            );
2025-11-09T23:42:54.9987715Z +            assert!(
2025-11-09T23:42:54.9987882Z +                version.supports_package_relay(),
2025-11-09T23:42:54.9988038Z +                "Should also support package relay"
2025-11-09T23:42:54.9988149Z +            );
2025-11-09T23:42:54.9988254Z          }
2025-11-09T23:42:54.9988376Z      }
2025-11-09T23:42:54.9988484Z  
2025-11-09T23:42:54.9989242Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:57:
2025-11-09T23:42:54.9989409Z          // Peer with ban list sharing support
2025-11-09T23:42:54.9989571Z          let services = NODE_BAN_LIST_SHARING;
2025-11-09T23:42:54.9989768Z          let version = create_version_message(services);
2025-11-09T23:42:54.9990161Z -        assert!(version.supports_ban_list_sharing(), "Should support ban list sharing");
2025-11-09T23:42:54.9990282Z +        assert!(
2025-11-09T23:42:54.9990450Z +            version.supports_ban_list_sharing(),
2025-11-09T23:42:54.9990613Z +            "Should support ban list sharing"
2025-11-09T23:42:54.9990723Z +        );
2025-11-09T23:42:54.9990835Z  
2025-11-09T23:42:54.9991003Z          // Peer without ban list sharing support
2025-11-09T23:42:54.9991138Z          let services = 0;
2025-11-09T23:42:54.9991671Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:64:
2025-11-09T23:42:54.9991891Z          let version = create_version_message(services);
2025-11-09T23:42:54.9992307Z -        assert!(!version.supports_ban_list_sharing(), "Should not support ban list sharing");
2025-11-09T23:42:54.9992438Z +        assert!(
2025-11-09T23:42:54.9992618Z +            !version.supports_ban_list_sharing(),
2025-11-09T23:42:54.9992784Z +            "Should not support ban list sharing"
2025-11-09T23:42:54.9992893Z +        );
2025-11-09T23:42:54.9993006Z  
2025-11-09T23:42:54.9993225Z          // Peer with multiple flags including ban list sharing
2025-11-09T23:42:54.9993547Z          let services = NODE_BAN_LIST_SHARING | NODE_COMPACT_FILTERS | NODE_FIBRE;
2025-11-09T23:42:54.9994070Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:69:
2025-11-09T23:42:54.9994273Z          let version = create_version_message(services);
2025-11-09T23:42:54.9994934Z -        assert!(version.supports_ban_list_sharing(), "Should support ban list sharing with other flags");
2025-11-09T23:42:54.9995384Z -        assert!(version.supports_compact_filters(), "Should also support compact filters");
2025-11-09T23:42:54.9995510Z +        assert!(
2025-11-09T23:42:54.9995685Z +            version.supports_ban_list_sharing(),
2025-11-09T23:42:54.9995906Z +            "Should support ban list sharing with other flags"
2025-11-09T23:42:54.9996026Z +        );
2025-11-09T23:42:54.9996143Z +        assert!(
2025-11-09T23:42:54.9996314Z +            version.supports_compact_filters(),
2025-11-09T23:42:54.9996488Z +            "Should also support compact filters"
2025-11-09T23:42:54.9996894Z +        );
2025-11-09T23:42:54.9997207Z          assert!(version.supports_fibre(), "Should also support FIBRE");
2025-11-09T23:42:54.9997323Z      }
2025-11-09T23:42:54.9997443Z  
2025-11-09T23:42:54.9997968Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:77:
2025-11-09T23:42:54.9998144Z          // Peer with compact filters support
2025-11-09T23:42:54.9998326Z          let services = NODE_COMPACT_FILTERS;
2025-11-09T23:42:54.9998531Z          let version = create_version_message(services);
2025-11-09T23:42:54.9998906Z -        assert!(version.supports_compact_filters(), "Should support compact filters");
2025-11-09T23:42:54.9999031Z +        assert!(
2025-11-09T23:42:54.9999206Z +            version.supports_compact_filters(),
2025-11-09T23:42:54.9999368Z +            "Should support compact filters"
2025-11-09T23:42:54.9999482Z +        );
2025-11-09T23:42:54.9999604Z  
2025-11-09T23:42:54.9999771Z          // Peer without compact filters support
2025-11-09T23:42:54.9999916Z          let services = 0;
2025-11-09T23:42:55.0000439Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:84:
2025-11-09T23:42:55.0000646Z          let version = create_version_message(services);
2025-11-09T23:42:55.0001052Z -        assert!(!version.supports_compact_filters(), "Should not support compact filters");
2025-11-09T23:42:55.0001393Z +        assert!(
2025-11-09T23:42:55.0001569Z +            !version.supports_compact_filters(),
2025-11-09T23:42:55.0001723Z +            "Should not support compact filters"
2025-11-09T23:42:55.0001833Z +        );
2025-11-09T23:42:55.0001946Z      }
2025-11-09T23:42:55.0002052Z  
2025-11-09T23:42:55.0002157Z      #[test]
2025-11-09T23:42:55.0002660Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:90:
2025-11-09T23:42:55.0002838Z          // Peer with package relay support
2025-11-09T23:42:55.0003004Z          let services = NODE_PACKAGE_RELAY;
2025-11-09T23:42:55.0003208Z          let version = create_version_message(services);
2025-11-09T23:42:55.0003582Z -        assert!(version.supports_package_relay(), "Should support package relay");
2025-11-09T23:42:55.0003700Z +        assert!(
2025-11-09T23:42:55.0003870Z +            version.supports_package_relay(),
2025-11-09T23:42:55.0004041Z +            "Should support package relay"
2025-11-09T23:42:55.0004164Z +        );
2025-11-09T23:42:55.0004275Z  
2025-11-09T23:42:55.0004617Z          // Peer without package relay support
2025-11-09T23:42:55.0004767Z          let services = 0;
2025-11-09T23:42:55.0005290Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:97:
2025-11-09T23:42:55.0005495Z          let version = create_version_message(services);
2025-11-09T23:42:55.0005882Z -        assert!(!version.supports_package_relay(), "Should not support package relay");
2025-11-09T23:42:55.0006002Z +        assert!(
2025-11-09T23:42:55.0006180Z +            !version.supports_package_relay(),
2025-11-09T23:42:55.0006338Z +            "Should not support package relay"
2025-11-09T23:42:55.0006456Z +        );
2025-11-09T23:42:55.0006565Z      }
2025-11-09T23:42:55.0006673Z  
2025-11-09T23:42:55.0006792Z      #[test]
2025-11-09T23:42:55.0007313Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:115:
2025-11-09T23:42:55.0007467Z      fn test_multiple_flags() {
2025-11-09T23:42:55.0007603Z          // Peer with all flags
2025-11-09T23:42:55.0007771Z          #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:55.0008170Z -        let services = NODE_UTXO_COMMITMENTS | NODE_BAN_LIST_SHARING | NODE_COMPACT_FILTERS | 
2025-11-09T23:42:55.0008339Z -                      NODE_PACKAGE_RELAY | NODE_FIBRE;
2025-11-09T23:42:55.0008934Z +        let services = NODE_UTXO_COMMITMENTS
2025-11-09T23:42:55.0009549Z +            | NODE_BAN_LIST_SHARING
2025-11-09T23:42:55.0009690Z +            | NODE_COMPACT_FILTERS
2025-11-09T23:42:55.0010045Z +            | NODE_PACKAGE_RELAY
2025-11-09T23:42:55.0010164Z +            | NODE_FIBRE;
2025-11-09T23:42:55.0010341Z          #[cfg(not(feature = "utxo-commitments"))]
2025-11-09T23:42:55.0010619Z -        let services = NODE_BAN_LIST_SHARING | NODE_COMPACT_FILTERS | 
2025-11-09T23:42:55.0010792Z -                      NODE_PACKAGE_RELAY | NODE_FIBRE;
2025-11-09T23:42:55.0010919Z +        let services =
2025-11-09T23:42:55.0011288Z +            NODE_BAN_LIST_SHARING | NODE_COMPACT_FILTERS | NODE_PACKAGE_RELAY | NODE_FIBRE;
2025-11-09T23:42:55.0011487Z          let version = create_version_message(services);
2025-11-09T23:42:55.0011598Z -        
2025-11-09T23:42:55.0011709Z +
2025-11-09T23:42:55.0011877Z          #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:55.0012281Z -        assert!(version.supports_utxo_commitments(), "Should support UTXO commitments");
2025-11-09T23:42:55.0012667Z -        assert!(version.supports_ban_list_sharing(), "Should support ban list sharing");
2025-11-09T23:42:55.0013060Z -        assert!(version.supports_compact_filters(), "Should support compact filters");
2025-11-09T23:42:55.0013432Z -        assert!(version.supports_package_relay(), "Should support package relay");
2025-11-09T23:42:55.0013550Z +        assert!(
2025-11-09T23:42:55.0013934Z +            version.supports_utxo_commitments(),
2025-11-09T23:42:55.0014110Z +            "Should support UTXO commitments"
2025-11-09T23:42:55.0014607Z +        );
2025-11-09T23:42:55.0014729Z +        assert!(
2025-11-09T23:42:55.0015386Z +            version.supports_ban_list_sharing(),
2025-11-09T23:42:55.0015603Z +            "Should support ban list sharing"
2025-11-09T23:42:55.0015726Z +        );
2025-11-09T23:42:55.0015840Z +        assert!(
2025-11-09T23:42:55.0016020Z +            version.supports_compact_filters(),
2025-11-09T23:42:55.0016186Z +            "Should support compact filters"
2025-11-09T23:42:55.0016299Z +        );
2025-11-09T23:42:55.0016412Z +        assert!(
2025-11-09T23:42:55.0016591Z +            version.supports_package_relay(),
2025-11-09T23:42:55.0019074Z +            "Should support package relay"
2025-11-09T23:42:55.0019211Z +        );
2025-11-09T23:42:55.0019505Z          assert!(version.supports_fibre(), "Should support FIBRE");
2025-11-09T23:42:55.0019617Z      }
2025-11-09T23:42:55.0019729Z  
2025-11-09T23:42:55.0020267Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:137:
2025-11-09T23:42:55.0020396Z          {
2025-11-09T23:42:55.0020571Z              let services = NODE_UTXO_COMMITMENTS;
2025-11-09T23:42:55.0020779Z              let version = create_version_message(services);
2025-11-09T23:42:55.0020891Z -            
2025-11-09T23:42:55.0021295Z -            assert!(version.supports_utxo_commitments(), "Should support UTXO commitments");
2025-11-09T23:42:55.0021728Z -            assert!(!version.supports_ban_list_sharing(), "Should not support ban list sharing");
2025-11-09T23:42:55.0022143Z -            assert!(!version.supports_compact_filters(), "Should not support compact filters");
2025-11-09T23:42:55.0022265Z +
2025-11-09T23:42:55.0022396Z +            assert!(
2025-11-09T23:42:55.0022580Z +                version.supports_utxo_commitments(),
2025-11-09T23:42:55.0022746Z +                "Should support UTXO commitments"
2025-11-09T23:42:55.0022852Z +            );
2025-11-09T23:42:55.0022976Z +            assert!(
2025-11-09T23:42:55.0023174Z +                !version.supports_ban_list_sharing(),
2025-11-09T23:42:55.0023342Z +                "Should not support ban list sharing"
2025-11-09T23:42:55.0023470Z +            );
2025-11-09T23:42:55.0023590Z +            assert!(
2025-11-09T23:42:55.0023762Z +                !version.supports_compact_filters(),
2025-11-09T23:42:55.0023940Z +                "Should not support compact filters"
2025-11-09T23:42:55.0024053Z +            );
2025-11-09T23:42:55.0024162Z          }
2025-11-09T23:42:55.0024270Z      }
2025-11-09T23:42:55.0024564Z  
2025-11-09T23:42:55.0025341Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:149:
2025-11-09T23:42:55.0025521Z          // Verify bit positions don't overlap
2025-11-09T23:42:55.0025697Z          #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:55.0025812Z          {
2025-11-09T23:42:55.0026177Z -            assert_eq!(NODE_UTXO_COMMITMENTS, 1 << 27, "UTXO commitments should be bit 27");
2025-11-09T23:42:55.0028210Z +            assert_eq!(
2025-11-09T23:42:55.0028361Z +                NODE_UTXO_COMMITMENTS,
2025-11-09T23:42:55.0028476Z +                1 << 27,
2025-11-09T23:42:55.0028643Z +                "UTXO commitments should be bit 27"
2025-11-09T23:42:55.0028766Z +            );
2025-11-09T23:42:55.0028937Z          }
2025-11-09T23:42:55.0029273Z -        assert_eq!(NODE_BAN_LIST_SHARING, 1 << 28, "Ban list sharing should be bit 28");
2025-11-09T23:42:55.0029595Z -        assert_eq!(NODE_PACKAGE_RELAY, 1 << 25, "Package relay should be bit 25");
2025-11-09T23:42:55.0029734Z +        assert_eq!(
2025-11-09T23:42:55.0029876Z +            NODE_BAN_LIST_SHARING,
2025-11-09T23:42:55.0029991Z +            1 << 28,
2025-11-09T23:42:55.0030163Z +            "Ban list sharing should be bit 28"
2025-11-09T23:42:55.0030276Z +        );
2025-11-09T23:42:55.0030396Z +        assert_eq!(
2025-11-09T23:42:55.0030538Z +            NODE_PACKAGE_RELAY,
2025-11-09T23:42:55.0030659Z +            1 << 25,
2025-11-09T23:42:55.0031058Z +            "Package relay should be bit 25"
2025-11-09T23:42:55.0031171Z +        );
2025-11-09T23:42:55.0031422Z          assert_eq!(NODE_FIBRE, 1 << 26, "FIBRE should be bit 26");
2025-11-09T23:42:55.0031535Z -        
2025-11-09T23:42:55.0031646Z +
2025-11-09T23:42:55.0031783Z          // Verify no overlap
2025-11-09T23:42:55.0031957Z          #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:55.0032069Z          {
2025-11-09T23:42:55.0032596Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:161:
2025-11-09T23:42:55.0033021Z -            assert_eq!(NODE_UTXO_COMMITMENTS & NODE_BAN_LIST_SHARING, 0, "Flags should not overlap");
2025-11-09T23:42:55.0033419Z -            assert_eq!(NODE_UTXO_COMMITMENTS & NODE_PACKAGE_RELAY, 0, "Flags should not overlap");
2025-11-09T23:42:55.0033773Z -            assert_eq!(NODE_UTXO_COMMITMENTS & NODE_FIBRE, 0, "Flags should not overlap");
2025-11-09T23:42:55.0033910Z +            assert_eq!(
2025-11-09T23:42:55.0034127Z +                NODE_UTXO_COMMITMENTS & NODE_BAN_LIST_SHARING,
2025-11-09T23:42:55.0034242Z +                0,
2025-11-09T23:42:55.0036508Z +                "Flags should not overlap"
2025-11-09T23:42:55.0036645Z +            );
2025-11-09T23:42:55.0036769Z +            assert_eq!(
2025-11-09T23:42:55.0036968Z +                NODE_UTXO_COMMITMENTS & NODE_PACKAGE_RELAY,
2025-11-09T23:42:55.0037089Z +                0,
2025-11-09T23:42:55.0037235Z +                "Flags should not overlap"
2025-11-09T23:42:55.0037344Z +            );
2025-11-09T23:42:55.0037472Z +            assert_eq!(
2025-11-09T23:42:55.0037647Z +                NODE_UTXO_COMMITMENTS & NODE_FIBRE,
2025-11-09T23:42:55.0037763Z +                0,
2025-11-09T23:42:55.0037911Z +                "Flags should not overlap"
2025-11-09T23:42:55.0038031Z +            );
2025-11-09T23:42:55.0038139Z          }
2025-11-09T23:42:55.0039371Z -        assert_eq!(NODE_BAN_LIST_SHARING & NODE_PACKAGE_RELAY, 0, "Flags should not overlap");
2025-11-09T23:42:55.0039750Z -        assert_eq!(NODE_BAN_LIST_SHARING & NODE_FIBRE, 0, "Flags should not overlap");
2025-11-09T23:42:55.0040444Z -        assert_eq!(NODE_PACKAGE_RELAY & NODE_FIBRE, 0, "Flags should not overlap");
2025-11-09T23:42:55.0040583Z +        assert_eq!(
2025-11-09T23:42:55.0040781Z +            NODE_BAN_LIST_SHARING & NODE_PACKAGE_RELAY,
2025-11-09T23:42:55.0040904Z +            0,
2025-11-09T23:42:55.0041052Z +            "Flags should not overlap"
2025-11-09T23:42:55.0041165Z +        );
2025-11-09T23:42:55.0041292Z +        assert_eq!(
2025-11-09T23:42:55.0041717Z +            NODE_BAN_LIST_SHARING & NODE_FIBRE,
2025-11-09T23:42:55.0041839Z +            0,
2025-11-09T23:42:55.0041985Z +            "Flags should not overlap"
2025-11-09T23:42:55.0042105Z +        );
2025-11-09T23:42:55.0042223Z +        assert_eq!(
2025-11-09T23:42:55.0042386Z +            NODE_PACKAGE_RELAY & NODE_FIBRE,
2025-11-09T23:42:55.0042506Z +            0,
2025-11-09T23:42:55.0042648Z +            "Flags should not overlap"
2025-11-09T23:42:55.0042774Z +        );
2025-11-09T23:42:55.0042886Z      }
2025-11-09T23:42:55.0043001Z  }
2025-11-09T23:42:55.0043109Z -
2025-11-09T23:42:55.0043220Z  
2025-11-09T23:42:55.0043739Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/storage_arcs_tests.rs:1:
2025-11-09T23:42:55.0043907Z  //! Tests for Storage Arc refactoring
2025-11-09T23:42:55.0044040Z  
2025-11-09T23:42:55.0044201Z -use bllvm_node::storage::Storage;
2025-11-09T23:42:55.0046525Z  use bllvm_node::network::chain_access::NodeChainAccess;
2025-11-09T23:42:55.0046747Z  use bllvm_node::node::mempool::MempoolManager;
2025-11-09T23:42:55.0046898Z +use bllvm_node::storage::Storage;
2025-11-09T23:42:55.0047027Z  use std::sync::Arc;
2025-11-09T23:42:55.0047169Z  use tempfile::TempDir;
2025-11-09T23:42:55.0047288Z  
2025-11-09T23:42:55.0047802Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/storage_arcs_tests.rs:10:
2025-11-09T23:42:55.0047956Z  fn test_storage_returns_arcs() {
2025-11-09T23:42:55.0048424Z      let temp_dir = TempDir::new().unwrap();
2025-11-09T23:42:55.0048656Z      let storage = Storage::new(temp_dir.path()).unwrap();
2025-11-09T23:42:55.0048770Z -    
2025-11-09T23:42:55.0048880Z +
2025-11-09T23:42:55.0049030Z      // Verify blocks() returns Arc
2025-11-09T23:42:55.0049183Z      let blocks_arc = storage.blocks();
2025-11-09T23:42:55.0049338Z      let blocks_arc2 = storage.blocks();
2025-11-09T23:42:55.0059380Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/storage_arcs_tests.rs:17:
2025-11-09T23:42:55.0059555Z -    
2025-11-09T23:42:55.0059672Z +
2025-11-09T23:42:55.0059859Z      // Both should be valid Arcs (can clone)
2025-11-09T23:42:55.0060273Z      assert!(Arc::ptr_eq(&blocks_arc, &blocks_arc2) || blocks_arc.block_count().is_ok());
2025-11-09T23:42:55.0060391Z -    
2025-11-09T23:42:55.0060595Z +
2025-11-09T23:42:55.0060773Z      // Verify transactions() returns Arc
2025-11-09T23:42:55.0060937Z      let tx_arc = storage.transactions();
2025-11-09T23:42:55.0061106Z      let tx_arc2 = storage.transactions();
2025-11-09T23:42:55.0061624Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/storage_arcs_tests.rs:24:
2025-11-09T23:42:55.0061736Z -    
2025-11-09T23:42:55.0061846Z +
2025-11-09T23:42:55.0063990Z      assert!(Arc::ptr_eq(&tx_arc, &tx_arc2) || tx_arc.has_transaction(&[0u8; 32]).is_ok());
2025-11-09T23:42:55.0064116Z  }
2025-11-09T23:42:55.0064229Z  
2025-11-09T23:42:55.0064919Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/storage_arcs_tests.rs:30:
2025-11-09T23:42:55.0065143Z      let temp_dir = TempDir::new().unwrap();
2025-11-09T23:42:55.0065376Z      let storage = Storage::new(temp_dir.path()).unwrap();
2025-11-09T23:42:55.0065576Z      let mempool = Arc::new(MempoolManager::new());
2025-11-09T23:42:55.0065691Z -    
2025-11-09T23:42:55.0065799Z +
2025-11-09T23:42:55.0066082Z      // Should be able to create NodeChainAccess with Arcs from Storage
2025-11-09T23:42:55.0066276Z -    let chain_access = NodeChainAccess::new(
2025-11-09T23:42:55.0066426Z -        storage.blocks(),
2025-11-09T23:42:55.0066579Z -        storage.transactions(),
2025-11-09T23:42:55.0066702Z -        mempool,
2025-11-09T23:42:55.0066824Z -    );
2025-11-09T23:42:55.0066932Z -    
2025-11-09T23:42:55.0067391Z +    let chain_access = NodeChainAccess::new(storage.blocks(), storage.transactions(), mempool);
2025-11-09T23:42:55.0067510Z +
2025-11-09T23:42:55.0067649Z      // Verify it works
2025-11-09T23:42:55.0067780Z      let hash = [0u8; 32];
2025-11-09T23:42:55.0068251Z      let has_object = chain_access.has_object(&hash);
2025-11-09T23:42:55.0068784Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/storage_arcs_tests.rs:44:
2025-11-09T23:42:55.0069034Z      assert!(!has_object); // Empty storage, so should be false
2025-11-09T23:42:55.0069148Z  }
2025-11-09T23:42:55.0069257Z -
2025-11-09T23:42:55.0069419Z  
2025-11-09T23:42:55.0069862Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:1:
2025-11-09T23:42:55.0070059Z -use bllvm_protocol::ProtocolVersion;
2025-11-09T23:42:55.0070279Z  use bllvm_node::storage::blockstore::BlockStore;
2025-11-09T23:42:55.0070473Z  use bllvm_node::storage::chainstate::ChainState;
2025-11-09T23:42:55.0070644Z  use bllvm_node::storage::txindex::TxIndex;
2025-11-09T23:42:55.0071060Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:9:
2025-11-09T23:42:55.0071204Z  use bllvm_node::OutPoint;
2025-11-09T23:42:55.0071354Z  use bllvm_node::Transaction;
2025-11-09T23:42:55.0071686Z  use bllvm_node::{ByteString, TransactionInput, TransactionOutput};
2025-11-09T23:42:55.0071861Z +use bllvm_protocol::ProtocolVersion;
2025-11-09T23:42:55.0072014Z  use std::collections::HashMap;
2025-11-09T23:42:55.0072155Z  use tempfile::TempDir;
2025-11-09T23:42:55.0072278Z  
2025-11-09T23:42:55.0086608Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/storage_tests.rs:4:
2025-11-09T23:42:55.0087082Z  use bllvm_node::storage::*;
2025-11-09T23:42:55.0087243Z  use tempfile::TempDir;
2025-11-09T23:42:55.0087362Z  mod common;
2025-11-09T23:42:55.0087486Z -use common::*;
2025-11-09T23:42:55.0087698Z  use bllvm_node::storage::blockstore::BlockStore;
2025-11-09T23:42:55.0087890Z  use bllvm_node::storage::chainstate::ChainState;
2025-11-09T23:42:55.0088071Z  use bllvm_node::storage::txindex::TxIndex;
2025-11-09T23:42:55.0088622Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/storage_tests.rs:11:
2025-11-09T23:42:55.0088854Z  use bllvm_node::storage::utxostore::UtxoStore;
2025-11-09T23:42:55.0088982Z +use common::*;
2025-11-09T23:42:55.0089086Z  
2025-11-09T23:42:55.0089216Z  #[test]
2025-11-09T23:42:55.0089366Z  fn test_storage_creation() {
2025-11-09T23:42:55.0110115Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:1:
2025-11-09T23:42:55.0110682Z -use bllvm_protocol::ProtocolVersion;
2025-11-09T23:42:55.0111099Z  use bllvm_node::storage::blockstore::BlockStore;
2025-11-09T23:42:55.0111322Z  use bllvm_node::storage::chainstate::ChainState;
2025-11-09T23:42:55.0111500Z  use bllvm_node::storage::txindex::TxIndex;
2025-11-09T23:42:55.0111938Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:9:
2025-11-09T23:42:55.0112087Z  use bllvm_node::OutPoint;
2025-11-09T23:42:55.0112238Z  use bllvm_node::Transaction;
2025-11-09T23:42:55.0112544Z  use bllvm_node::{ByteString, TransactionInput, TransactionOutput};
2025-11-09T23:42:55.0112727Z +use bllvm_protocol::ProtocolVersion;
2025-11-09T23:42:55.0112889Z  use std::collections::HashMap;
2025-11-09T23:42:55.0113028Z  use tempfile::TempDir;
2025-11-09T23:42:55.0113150Z  
2025-11-09T23:42:55.0115805Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/stratum_v2_mining_tests.rs:1:
2025-11-09T23:42:55.0125752Z  //! Unit tests for Stratum V2 mining and share validation
2025-11-09T23:42:55.0125881Z  
2025-11-09T23:42:55.0126162Z -use bllvm_protocol::types::{Block, BlockHeader, Hash, Natural};
2025-11-09T23:42:55.0126402Z  use bllvm_node::network::stratum_v2::messages::ShareData;
2025-11-09T23:42:55.0128095Z  use bllvm_node::network::stratum_v2::pool::{JobInfo, StratumV2Pool};
2025-11-09T23:42:55.0128359Z +use bllvm_protocol::types::{Block, BlockHeader, Hash, Natural};
2025-11-09T23:42:55.0128492Z  use tempfile::TempDir;
2025-11-09T23:42:55.0128604Z  mod common;
2025-11-09T23:42:55.0128729Z  use common::*;
2025-11-09T23:42:55.0187630Z ##[error]Process completed with exit code 1.
