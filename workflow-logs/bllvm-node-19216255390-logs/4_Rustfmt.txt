2025-11-09T23:42:47.8939811Z Current runner version: '2.329.0'
2025-11-09T23:42:47.8949502Z Runner name: 'linode-runner-02'
2025-11-09T23:42:47.8950292Z Runner group name: 'default'
2025-11-09T23:42:47.8951212Z Machine name: 'localhost'
2025-11-09T23:42:47.8956347Z ##[group]GITHUB_TOKEN Permissions
2025-11-09T23:42:47.8958666Z Contents: read
2025-11-09T23:42:47.8959344Z Metadata: read
2025-11-09T23:42:47.8959889Z Packages: read
2025-11-09T23:42:47.8960534Z ##[endgroup]
2025-11-09T23:42:47.8962719Z Secret source: Actions
2025-11-09T23:42:47.8963460Z Prepare workflow directory
2025-11-09T23:42:47.9869548Z Prepare all required actions
2025-11-09T23:42:47.9938231Z Getting action download info
2025-11-09T23:42:48.2969373Z Download action repository 'actions/checkout@v4' (SHA:08eba0b27e820071cde6df949e0beb9ba4906955)
2025-11-09T23:42:48.6959492Z Download action repository 'dtolnay/rust-toolchain@master' (SHA:6d653acede28d24f02e3cd41383119e8b1b35921)
2025-11-09T23:42:49.0532047Z Complete job name: Rustfmt
2025-11-09T23:42:49.1201696Z A job started hook has been configured by the self-hosted runner administrator
2025-11-09T23:42:49.1369972Z ##[group]Run '/home/jswift/actions-runner-org2/cleanup-hooks/job-started.sh'
2025-11-09T23:42:49.1401160Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2025-11-09T23:42:49.1402242Z ##[endgroup]
2025-11-09T23:42:49.1604493Z Job started: Sun Nov  9 11:42:49 PM UTC 2025
2025-11-09T23:42:49.1623708Z Available disk space: 12G
2025-11-09T23:42:49.1661434Z Disk usage is 78% - no cleanup needed
2025-11-09T23:42:49.1969809Z ##[group]Run actions/checkout@v4
2025-11-09T23:42:49.1970454Z with:
2025-11-09T23:42:49.1970898Z   repository: BTCDecoded/bllvm-node
2025-11-09T23:42:49.1971677Z   token: ***
2025-11-09T23:42:49.1972117Z   ssh-strict: true
2025-11-09T23:42:49.1972580Z   ssh-user: git
2025-11-09T23:42:49.1973069Z   persist-credentials: true
2025-11-09T23:42:49.1973581Z   clean: true
2025-11-09T23:42:49.1974037Z   sparse-checkout-cone-mode: true
2025-11-09T23:42:49.1974739Z   fetch-depth: 1
2025-11-09T23:42:49.1975208Z   fetch-tags: false
2025-11-09T23:42:49.1975654Z   show-progress: true
2025-11-09T23:42:49.1976107Z   lfs: false
2025-11-09T23:42:49.1976517Z   submodules: false
2025-11-09T23:42:49.1976977Z   set-safe-directory: true
2025-11-09T23:42:49.1977493Z env:
2025-11-09T23:42:49.1977907Z   CARGO_TERM_COLOR: always
2025-11-09T23:42:49.1978386Z ##[endgroup]
2025-11-09T23:42:49.3289273Z Syncing repository: BTCDecoded/bllvm-node
2025-11-09T23:42:49.3291951Z ##[group]Getting Git version info
2025-11-09T23:42:49.3293637Z Working directory is '/home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node'
2025-11-09T23:42:49.3297150Z [command]/usr/bin/git version
2025-11-09T23:42:49.3297748Z git version 2.43.0
2025-11-09T23:42:49.3327220Z ##[endgroup]
2025-11-09T23:42:49.3347203Z Copying '/home/jswift/.gitconfig' to '/home/jswift/actions-runner-org2/_work/_temp/f71c485a-ac1d-4975-bbd9-e110eb3b0640/.gitconfig'
2025-11-09T23:42:49.3370903Z Temporarily overriding HOME='/home/jswift/actions-runner-org2/_work/_temp/f71c485a-ac1d-4975-bbd9-e110eb3b0640' before making global git config changes
2025-11-09T23:42:49.3372800Z Adding repository directory to the temporary git global config as a safe directory
2025-11-09T23:42:49.3375095Z [command]/usr/bin/git config --global --add safe.directory /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node
2025-11-09T23:42:49.3430266Z [command]/usr/bin/git config --local --get remote.origin.url
2025-11-09T23:42:49.3453297Z https://github.com/BTCDecoded/bllvm-node
2025-11-09T23:42:49.3472313Z ##[group]Removing previously created refs, to avoid conflicts
2025-11-09T23:42:49.3476265Z [command]/usr/bin/git rev-parse --symbolic-full-name --verify --quiet HEAD
2025-11-09T23:42:49.3501620Z refs/heads/main
2025-11-09T23:42:49.3516481Z [command]/usr/bin/git checkout --detach
2025-11-09T23:42:49.3606198Z HEAD is now at 59f97d7 fix: Update workflow to use correct repository names (bllvm-protocol, bllvm-consensus)
2025-11-09T23:42:49.3654681Z [command]/usr/bin/git branch --delete --force main
2025-11-09T23:42:49.3688363Z Deleted branch main (was 59f97d7).
2025-11-09T23:42:49.3734258Z ##[endgroup]
2025-11-09T23:42:49.3737621Z [command]/usr/bin/git submodule status
2025-11-09T23:42:49.4029639Z ##[group]Cleaning the repository
2025-11-09T23:42:49.4032762Z [command]/usr/bin/git clean -ffdx
2025-11-09T23:42:49.4114885Z [command]/usr/bin/git reset --hard HEAD
2025-11-09T23:42:49.4222119Z HEAD is now at 59f97d7 fix: Update workflow to use correct repository names (bllvm-protocol, bllvm-consensus)
2025-11-09T23:42:49.4227997Z ##[endgroup]
2025-11-09T23:42:49.4229777Z ##[group]Disabling automatic garbage collection
2025-11-09T23:42:49.4234095Z [command]/usr/bin/git config --local gc.auto 0
2025-11-09T23:42:49.4280597Z ##[endgroup]
2025-11-09T23:42:49.4281387Z ##[group]Setting up auth
2025-11-09T23:42:49.4290013Z [command]/usr/bin/git config --local --name-only --get-regexp core\.sshCommand
2025-11-09T23:42:49.4327886Z [command]/usr/bin/git submodule foreach --recursive sh -c "git config --local --name-only --get-regexp 'core\.sshCommand' && git config --local --unset-all 'core.sshCommand' || :"
2025-11-09T23:42:49.4618411Z [command]/usr/bin/git config --local --name-only --get-regexp http\.https\:\/\/github\.com\/\.extraheader
2025-11-09T23:42:49.4657449Z [command]/usr/bin/git submodule foreach --recursive sh -c "git config --local --name-only --get-regexp 'http\.https\:\/\/github\.com\/\.extraheader' && git config --local --unset-all 'http.https://github.com/.extraheader' || :"
2025-11-09T23:42:49.4936381Z [command]/usr/bin/git config --local http.https://github.com/.extraheader AUTHORIZATION: basic ***
2025-11-09T23:42:49.4980215Z ##[endgroup]
2025-11-09T23:42:49.4981185Z ##[group]Fetching the repository
2025-11-09T23:42:49.4990172Z [command]/usr/bin/git -c protocol.version=2 fetch --no-tags --prune --no-recurse-submodules --depth=1 origin +59f97d736ed79bcffc2396622927997c743a87ed:refs/remotes/origin/main
2025-11-09T23:42:49.7052737Z ##[endgroup]
2025-11-09T23:42:49.7055241Z ##[group]Determining the checkout info
2025-11-09T23:42:49.7057503Z ##[endgroup]
2025-11-09T23:42:49.7058901Z [command]/usr/bin/git sparse-checkout disable
2025-11-09T23:42:49.7117636Z [command]/usr/bin/git config --local --unset-all extensions.worktreeConfig
2025-11-09T23:42:49.7147575Z ##[group]Checking out the ref
2025-11-09T23:42:49.7151038Z [command]/usr/bin/git checkout --progress --force -B main refs/remotes/origin/main
2025-11-09T23:42:49.7233895Z Switched to a new branch 'main'
2025-11-09T23:42:49.7235660Z branch 'main' set up to track 'origin/main'.
2025-11-09T23:42:49.7242273Z ##[endgroup]
2025-11-09T23:42:49.7287548Z [command]/usr/bin/git log -1 --format=%H
2025-11-09T23:42:49.7318348Z 59f97d736ed79bcffc2396622927997c743a87ed
2025-11-09T23:42:49.7637912Z ##[group]Run actions/checkout@v4
2025-11-09T23:42:49.7639057Z with:
2025-11-09T23:42:49.7639953Z   repository: BTCDecoded/bllvm-protocol
2025-11-09T23:42:49.7641213Z   path: _temp-protocol-engine
2025-11-09T23:42:49.7644193Z   token: ***
2025-11-09T23:42:49.7645239Z   ssh-strict: true
2025-11-09T23:42:49.7646170Z   ssh-user: git
2025-11-09T23:42:49.7647112Z   persist-credentials: true
2025-11-09T23:42:49.7648162Z   clean: true
2025-11-09T23:42:49.7649096Z   sparse-checkout-cone-mode: true
2025-11-09T23:42:49.7650238Z   fetch-depth: 1
2025-11-09T23:42:49.7651147Z   fetch-tags: false
2025-11-09T23:42:49.7652079Z   show-progress: true
2025-11-09T23:42:49.7653030Z   lfs: false
2025-11-09T23:42:49.7655769Z   submodules: false
2025-11-09T23:42:49.7656725Z   set-safe-directory: true
2025-11-09T23:42:49.7657729Z env:
2025-11-09T23:42:49.7658549Z   CARGO_TERM_COLOR: always
2025-11-09T23:42:49.7659549Z ##[endgroup]
2025-11-09T23:42:49.8908644Z Syncing repository: BTCDecoded/bllvm-protocol
2025-11-09T23:42:49.8919989Z ##[group]Getting Git version info
2025-11-09T23:42:49.8922606Z Working directory is '/home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/_temp-protocol-engine'
2025-11-09T23:42:49.8995118Z [command]/usr/bin/git version
2025-11-09T23:42:49.9057687Z git version 2.43.0
2025-11-09T23:42:49.9104244Z ##[endgroup]
2025-11-09T23:42:49.9120207Z Copying '/home/jswift/.gitconfig' to '/home/jswift/actions-runner-org2/_work/_temp/17de9b9b-920b-4ea9-a0bc-de8d6d656243/.gitconfig'
2025-11-09T23:42:49.9137852Z Temporarily overriding HOME='/home/jswift/actions-runner-org2/_work/_temp/17de9b9b-920b-4ea9-a0bc-de8d6d656243' before making global git config changes
2025-11-09T23:42:49.9141333Z Adding repository directory to the temporary git global config as a safe directory
2025-11-09T23:42:49.9157646Z [command]/usr/bin/git config --global --add safe.directory /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/_temp-protocol-engine
2025-11-09T23:42:49.9208047Z ##[group]Initializing the repository
2025-11-09T23:42:49.9217831Z [command]/usr/bin/git init /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/_temp-protocol-engine
2025-11-09T23:42:49.9290118Z Initialized empty Git repository in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/_temp-protocol-engine/.git/
2025-11-09T23:42:49.9306368Z [command]/usr/bin/git remote add origin https://github.com/BTCDecoded/bllvm-protocol
2025-11-09T23:42:49.9360865Z ##[endgroup]
2025-11-09T23:42:49.9362990Z ##[group]Disabling automatic garbage collection
2025-11-09T23:42:49.9365637Z [command]/usr/bin/git config --local gc.auto 0
2025-11-09T23:42:49.9419834Z ##[endgroup]
2025-11-09T23:42:49.9422357Z ##[group]Setting up auth
2025-11-09T23:42:49.9428717Z [command]/usr/bin/git config --local --name-only --get-regexp core\.sshCommand
2025-11-09T23:42:49.9477130Z [command]/usr/bin/git submodule foreach --recursive sh -c "git config --local --name-only --get-regexp 'core\.sshCommand' && git config --local --unset-all 'core.sshCommand' || :"
2025-11-09T23:42:49.9790517Z [command]/usr/bin/git config --local --name-only --get-regexp http\.https\:\/\/github\.com\/\.extraheader
2025-11-09T23:42:49.9829727Z [command]/usr/bin/git submodule foreach --recursive sh -c "git config --local --name-only --get-regexp 'http\.https\:\/\/github\.com\/\.extraheader' && git config --local --unset-all 'http.https://github.com/.extraheader' || :"
2025-11-09T23:42:50.0118642Z [command]/usr/bin/git config --local http.https://github.com/.extraheader AUTHORIZATION: basic ***
2025-11-09T23:42:50.0173445Z ##[endgroup]
2025-11-09T23:42:50.0176713Z ##[group]Determining the default branch
2025-11-09T23:42:50.0179062Z Retrieving the default branch name
2025-11-09T23:42:50.3112074Z Default branch 'main'
2025-11-09T23:42:50.3117639Z ##[endgroup]
2025-11-09T23:42:50.3120392Z ##[group]Fetching the repository
2025-11-09T23:42:50.3128568Z [command]/usr/bin/git -c protocol.version=2 fetch --no-tags --prune --no-recurse-submodules --depth=1 origin +refs/heads/main:refs/remotes/origin/main
2025-11-09T23:42:52.5661951Z From https://github.com/BTCDecoded/bllvm-protocol
2025-11-09T23:42:52.5664271Z  * [new branch]      main       -> origin/main
2025-11-09T23:42:52.5691552Z ##[endgroup]
2025-11-09T23:42:52.5692438Z ##[group]Determining the checkout info
2025-11-09T23:42:52.5693928Z ##[endgroup]
2025-11-09T23:42:52.5698373Z [command]/usr/bin/git sparse-checkout disable
2025-11-09T23:42:52.5739567Z [command]/usr/bin/git config --local --unset-all extensions.worktreeConfig
2025-11-09T23:42:52.5772122Z ##[group]Checking out the ref
2025-11-09T23:42:52.5778693Z [command]/usr/bin/git checkout --progress --force -B main refs/remotes/origin/main
2025-11-09T23:42:53.2292696Z Reset branch 'main'
2025-11-09T23:42:53.2293554Z branch 'main' set up to track 'origin/main'.
2025-11-09T23:42:53.2363439Z ##[endgroup]
2025-11-09T23:42:53.2423922Z [command]/usr/bin/git log -1 --format=%H
2025-11-09T23:42:53.2452799Z f5f0b046e78292228238657d2073c8b6558f8ab4
2025-11-09T23:42:53.2604834Z ##[group]Run if [ -d "../bllvm-protocol" ]; then rm -rf ../bllvm-protocol; fi
2025-11-09T23:42:53.2605490Z [36;1mif [ -d "../bllvm-protocol" ]; then rm -rf ../bllvm-protocol; fi[0m
2025-11-09T23:42:53.2605923Z [36;1mmv _temp-protocol-engine ../bllvm-protocol[0m
2025-11-09T23:42:53.2636823Z shell: /usr/bin/bash -e {0}
2025-11-09T23:42:53.2637386Z env:
2025-11-09T23:42:53.2637580Z   CARGO_TERM_COLOR: always
2025-11-09T23:42:53.2637815Z ##[endgroup]
2025-11-09T23:42:53.3187448Z ##[group]Run dtolnay/rust-toolchain@master
2025-11-09T23:42:53.3187797Z with:
2025-11-09T23:42:53.3187993Z   toolchain: 1.88.0
2025-11-09T23:42:53.3188195Z   components: rustfmt
2025-11-09T23:42:53.3188386Z env:
2025-11-09T23:42:53.3188563Z   CARGO_TERM_COLOR: always
2025-11-09T23:42:53.3188770Z ##[endgroup]
2025-11-09T23:42:53.3297762Z ##[group]Run : parse toolchain version
2025-11-09T23:42:53.3298156Z [36;1m: parse toolchain version[0m
2025-11-09T23:42:53.3298453Z [36;1mif [[ -z $toolchain ]]; then[0m
2025-11-09T23:42:53.3298962Z [36;1m  # GitHub does not enforce `required: true` inputs itself. https://github.com/actions/runner/issues/1070[0m
2025-11-09T23:42:53.3299723Z [36;1m  echo "'toolchain' is a required input" >&2[0m
2025-11-09T23:42:53.3300181Z [36;1m  exit 1[0m
2025-11-09T23:42:53.3300498Z [36;1melif [[ $toolchain =~ ^stable' '[0-9]+' '(year|month|week|day)s?' 'ago$ ]]; then[0m
2025-11-09T23:42:53.3300907Z [36;1m  if [[ Linux == macOS ]]; then[0m
2025-11-09T23:42:53.3301431Z [36;1m    echo "toolchain=1.$((($(date -v-$(sed 's/stable \([0-9]*\) \(.\).*/\1\2/' <<< $toolchain) +%s)/60/60/24-16569)/7/6))" >> $GITHUB_OUTPUT[0m
2025-11-09T23:42:53.3301877Z [36;1m  else[0m
2025-11-09T23:42:53.3302244Z [36;1m    echo "toolchain=1.$((($(date --date "${toolchain#stable }" +%s)/60/60/24-16569)/7/6))" >> $GITHUB_OUTPUT[0m
2025-11-09T23:42:53.3302656Z [36;1m  fi[0m
2025-11-09T23:42:53.3302932Z [36;1melif [[ $toolchain =~ ^stable' 'minus' '[0-9]+' 'releases?$ ]]; then[0m
2025-11-09T23:42:53.3303432Z [36;1m  echo "toolchain=1.$((($(date +%s)/60/60/24-16569)/7/6-${toolchain//[^0-9]/}))" >> $GITHUB_OUTPUT[0m
2025-11-09T23:42:53.3303848Z [36;1melif [[ $toolchain =~ ^1\.[0-9]+$ ]]; then[0m
2025-11-09T23:42:53.3304499Z [36;1m  echo "toolchain=1.$((i=${toolchain#1.}, c=($(date +%s)/60/60/24-16569)/7/6, i+9*i*(10*i<=c)+90*i*(100*i<=c)))" >> $GITHUB_OUTPUT[0m
2025-11-09T23:42:53.3304995Z [36;1melse[0m
2025-11-09T23:42:53.3305239Z [36;1m  echo "toolchain=$toolchain" >> $GITHUB_OUTPUT[0m
2025-11-09T23:42:53.3305525Z [36;1mfi[0m
2025-11-09T23:42:53.3338100Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2025-11-09T23:42:53.3338439Z env:
2025-11-09T23:42:53.3338629Z   CARGO_TERM_COLOR: always
2025-11-09T23:42:53.3338846Z   toolchain: 1.88.0
2025-11-09T23:42:53.3339054Z ##[endgroup]
2025-11-09T23:42:53.3479569Z ##[group]Run : construct rustup command line
2025-11-09T23:42:53.3479913Z [36;1m: construct rustup command line[0m
2025-11-09T23:42:53.3480344Z [36;1mecho "targets=$(for t in ${targets//,/ }; do echo -n ' --target' $t; done)" >> $GITHUB_OUTPUT[0m
2025-11-09T23:42:53.3480928Z [36;1mecho "components=$(for c in ${components//,/ }; do echo -n ' --component' $c; done)" >> $GITHUB_OUTPUT[0m
2025-11-09T23:42:53.3483813Z [36;1mecho "downgrade=" >> $GITHUB_OUTPUT[0m
2025-11-09T23:42:53.3516356Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2025-11-09T23:42:53.3516727Z env:
2025-11-09T23:42:53.3516925Z   CARGO_TERM_COLOR: always
2025-11-09T23:42:53.3517168Z   targets: 
2025-11-09T23:42:53.3517368Z   components: rustfmt
2025-11-09T23:42:53.3517577Z ##[endgroup]
2025-11-09T23:42:53.3637061Z ##[group]Run : set $CARGO_HOME
2025-11-09T23:42:53.3637350Z [36;1m: set $CARGO_HOME[0m
2025-11-09T23:42:53.3637683Z [36;1mecho CARGO_HOME=${CARGO_HOME:-"$HOME/.cargo"} >> $GITHUB_ENV[0m
2025-11-09T23:42:53.3671193Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2025-11-09T23:42:53.3671567Z env:
2025-11-09T23:42:53.3671764Z   CARGO_TERM_COLOR: always
2025-11-09T23:42:53.3672006Z ##[endgroup]
2025-11-09T23:42:53.3771867Z ##[group]Run : install rustup if needed
2025-11-09T23:42:53.3772176Z [36;1m: install rustup if needed[0m
2025-11-09T23:42:53.3772465Z [36;1mif ! command -v rustup &>/dev/null; then[0m
2025-11-09T23:42:53.3773178Z [36;1m  curl --proto '=https' --tlsv1.2 --retry 10 --retry-connrefused --location --silent --show-error --fail https://sh.rustup.rs | sh -s -- --default-toolchain none -y[0m
2025-11-09T23:42:53.3776433Z [36;1m  echo "$CARGO_HOME/bin" >> $GITHUB_PATH[0m
2025-11-09T23:42:53.3776783Z [36;1mfi[0m
2025-11-09T23:42:53.3807711Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2025-11-09T23:42:53.3808059Z env:
2025-11-09T23:42:53.3808253Z   CARGO_TERM_COLOR: always
2025-11-09T23:42:53.3808499Z   CARGO_HOME: /home/jswift/.cargo
2025-11-09T23:42:53.3808743Z ##[endgroup]
2025-11-09T23:42:53.4369984Z info: downloading installer
2025-11-09T23:42:53.6679288Z warn: It looks like you have an existing rustup settings file at:
2025-11-09T23:42:53.6679959Z warn: /home/jswift/.rustup/settings.toml
2025-11-09T23:42:53.6680610Z warn: Rustup will install the default toolchain as specified in the settings file,
2025-11-09T23:42:53.6681349Z warn: instead of the one inferred from the default host triple.
2025-11-09T23:42:53.6955759Z info: profile set to 'default'
2025-11-09T23:42:53.6956196Z 
2025-11-09T23:42:53.6956276Z 
2025-11-09T23:42:53.6956514Z Rust is installed now. Great!
2025-11-09T23:42:53.6956885Z 
2025-11-09T23:42:53.6957137Z To get started you may need to restart your current shell.
2025-11-09T23:42:53.6957928Z This would reload your PATH environment variable to include
2025-11-09T23:42:53.6958536Z Cargo's bin directory ($HOME/.cargo/bin).
2025-11-09T23:42:53.6959067Z 
2025-11-09T23:42:53.6959335Z To configure your current shell, you need to source
2025-11-09T23:42:53.6960036Z the corresponding env file under $HOME/.cargo.
2025-11-09T23:42:53.6960546Z 
2025-11-09T23:42:53.6961038Z This is usually done by running one of the following (note the leading DOT):
2025-11-09T23:42:53.6962151Z info: default host triple is x86_64-unknown-linux-gnu
2025-11-09T23:42:53.6962978Z info: skipping toolchain installation
2025-11-09T23:42:53.6963821Z . "$HOME/.cargo/env"            # For sh/bash/zsh/ash/dash/pdksh
2025-11-09T23:42:53.6964831Z source "$HOME/.cargo/env.fish"  # For fish
2025-11-09T23:42:53.6965658Z source $"($nu.home-path)/.cargo/env.nu"  # For nushell
2025-11-09T23:42:53.7112495Z ##[group]Run rustup toolchain install 1.88.0 --component rustfmt --profile minimal --no-self-update
2025-11-09T23:42:53.7113174Z [36;1mrustup toolchain install 1.88.0 --component rustfmt --profile minimal --no-self-update[0m
2025-11-09T23:42:53.7152137Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2025-11-09T23:42:53.7152485Z env:
2025-11-09T23:42:53.7152684Z   CARGO_TERM_COLOR: always
2025-11-09T23:42:53.7152929Z   CARGO_HOME: /home/jswift/.cargo
2025-11-09T23:42:53.7153180Z ##[endgroup]
2025-11-09T23:42:53.8041659Z info: syncing channel updates for '1.88.0-x86_64-unknown-linux-gnu'
2025-11-09T23:42:53.8632901Z info: latest update on 2025-06-26, rust version 1.88.0 (6b00bc388 2025-06-23)
2025-11-09T23:42:53.8947655Z info: component 'rustfmt' for target 'x86_64-unknown-linux-gnu' is up to date
2025-11-09T23:42:53.8973533Z 
2025-11-09T23:42:53.9142090Z   1.88.0-x86_64-unknown-linux-gnu unchanged - rustc 1.88.0 (6b00bc388 2025-06-23)
2025-11-09T23:42:53.9142798Z 
2025-11-09T23:42:53.9213010Z ##[group]Run rustup default 1.88.0
2025-11-09T23:42:53.9213351Z [36;1mrustup default 1.88.0[0m
2025-11-09T23:42:53.9251070Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2025-11-09T23:42:53.9251427Z env:
2025-11-09T23:42:53.9251622Z   CARGO_TERM_COLOR: always
2025-11-09T23:42:53.9251876Z   CARGO_HOME: /home/jswift/.cargo
2025-11-09T23:42:53.9252134Z ##[endgroup]
2025-11-09T23:42:53.9388786Z info: using existing install for '1.88.0-x86_64-unknown-linux-gnu'
2025-11-09T23:42:53.9778520Z info: default toolchain set to '1.88.0-x86_64-unknown-linux-gnu'
2025-11-09T23:42:53.9778942Z 
2025-11-09T23:42:53.9897402Z   1.88.0-x86_64-unknown-linux-gnu unchanged - rustc 1.88.0 (6b00bc388 2025-06-23)
2025-11-09T23:42:53.9898798Z info: note that the toolchain '1.88.0-x86_64-unknown-linux-gnu' is currently in use (overridden by '/home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/rust-toolchain.toml')
2025-11-09T23:42:53.9899864Z 
2025-11-09T23:42:53.9951083Z ##[group]Run : create cachekey
2025-11-09T23:42:53.9951369Z [36;1m: create cachekey[0m
2025-11-09T23:42:53.9952027Z [36;1mDATE=$(rustc +1.88.0 --version --verbose | sed -ne 's/^commit-date: \(20[0-9][0-9]\)-\([01][0-9]\)-\([0-3][0-9]\)$/\1\2\3/p')[0m
2025-11-09T23:42:53.9952645Z [36;1mHASH=$(rustc +1.88.0 --version --verbose | sed -ne 's/^commit-hash: //p')[0m
2025-11-09T23:42:53.9953132Z [36;1mecho "cachekey=$(echo $DATE$HASH | head -c12)" >> $GITHUB_OUTPUT[0m
2025-11-09T23:42:53.9983020Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2025-11-09T23:42:53.9983374Z env:
2025-11-09T23:42:53.9983578Z   CARGO_TERM_COLOR: always
2025-11-09T23:42:53.9983838Z   CARGO_HOME: /home/jswift/.cargo
2025-11-09T23:42:53.9984099Z ##[endgroup]
2025-11-09T23:42:54.0480096Z ##[group]Run : disable incremental compilation
2025-11-09T23:42:54.0480492Z [36;1m: disable incremental compilation[0m
2025-11-09T23:42:54.0480846Z [36;1mif [ -z "${CARGO_INCREMENTAL+set}" ]; then[0m
2025-11-09T23:42:54.0481207Z [36;1m  echo CARGO_INCREMENTAL=0 >> $GITHUB_ENV[0m
2025-11-09T23:42:54.0481479Z [36;1mfi[0m
2025-11-09T23:42:54.0569747Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2025-11-09T23:42:54.0570138Z env:
2025-11-09T23:42:54.0570374Z   CARGO_TERM_COLOR: always
2025-11-09T23:42:54.0570658Z   CARGO_HOME: /home/jswift/.cargo
2025-11-09T23:42:54.0570931Z ##[endgroup]
2025-11-09T23:42:54.0646423Z ##[group]Run : enable colors in Cargo output
2025-11-09T23:42:54.0646745Z [36;1m: enable colors in Cargo output[0m
2025-11-09T23:42:54.0647037Z [36;1mif [ -z "${CARGO_TERM_COLOR+set}" ]; then[0m
2025-11-09T23:42:54.0647371Z [36;1m  echo CARGO_TERM_COLOR=always >> $GITHUB_ENV[0m
2025-11-09T23:42:54.0647643Z [36;1mfi[0m
2025-11-09T23:42:54.0677136Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2025-11-09T23:42:54.0677466Z env:
2025-11-09T23:42:54.0677648Z   CARGO_TERM_COLOR: always
2025-11-09T23:42:54.0677878Z   CARGO_HOME: /home/jswift/.cargo
2025-11-09T23:42:54.0678126Z   CARGO_INCREMENTAL: 0
2025-11-09T23:42:54.0678318Z ##[endgroup]
2025-11-09T23:42:54.0751329Z ##[group]Run : enable Cargo sparse registry
2025-11-09T23:42:54.0751655Z [36;1m: enable Cargo sparse registry[0m
2025-11-09T23:42:54.0752021Z [36;1m# implemented in 1.66, stabilized in 1.68, made default in 1.70[0m
2025-11-09T23:42:54.0752794Z [36;1mif [ -z "${CARGO_REGISTRIES_CRATES_IO_PROTOCOL+set}" -o -f "/home/jswift/actions-runner-org2/_work/_temp"/.implicit_cargo_registries_crates_io_protocol ]; then[0m
2025-11-09T23:42:54.0753570Z [36;1m  if rustc +1.88.0 --version --verbose | grep -q '^release: 1\.6[89]\.'; then[0m
2025-11-09T23:42:54.0754194Z [36;1m    touch "/home/jswift/actions-runner-org2/_work/_temp"/.implicit_cargo_registries_crates_io_protocol || true[0m
2025-11-09T23:42:54.0755148Z [36;1m    echo CARGO_REGISTRIES_CRATES_IO_PROTOCOL=sparse >> $GITHUB_ENV[0m
2025-11-09T23:42:54.0755635Z [36;1m  elif rustc +1.88.0 --version --verbose | grep -q '^release: 1\.6[67]\.'; then[0m
2025-11-09T23:42:54.0756266Z [36;1m    touch "/home/jswift/actions-runner-org2/_work/_temp"/.implicit_cargo_registries_crates_io_protocol || true[0m
2025-11-09T23:42:54.0756857Z [36;1m    echo CARGO_REGISTRIES_CRATES_IO_PROTOCOL=git >> $GITHUB_ENV[0m
2025-11-09T23:42:54.0757191Z [36;1m  fi[0m
2025-11-09T23:42:54.0757365Z [36;1mfi[0m
2025-11-09T23:42:54.0782104Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2025-11-09T23:42:54.0782417Z env:
2025-11-09T23:42:54.0782590Z   CARGO_TERM_COLOR: always
2025-11-09T23:42:54.0782816Z   CARGO_HOME: /home/jswift/.cargo
2025-11-09T23:42:54.0783053Z   CARGO_INCREMENTAL: 0
2025-11-09T23:42:54.0783258Z ##[endgroup]
2025-11-09T23:42:54.1261797Z ##[group]Run : work around spurious network errors in curl 8.0
2025-11-09T23:42:54.1262238Z [36;1m: work around spurious network errors in curl 8.0[0m
2025-11-09T23:42:54.1262787Z [36;1m# https://rust-lang.zulipchat.com/#narrow/stream/246057-t-cargo/topic/timeout.20investigation[0m
2025-11-09T23:42:54.1263392Z [36;1mif rustc +1.88.0 --version --verbose | grep -q '^release: 1\.7[01]\.'; then[0m
2025-11-09T23:42:54.1264179Z [36;1m  echo CARGO_HTTP_MULTIPLEXING=false >> $GITHUB_ENV[0m
2025-11-09T23:42:54.1264807Z [36;1mfi[0m
2025-11-09T23:42:54.1291589Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2025-11-09T23:42:54.1291921Z env:
2025-11-09T23:42:54.1292106Z   CARGO_TERM_COLOR: always
2025-11-09T23:42:54.1292343Z   CARGO_HOME: /home/jswift/.cargo
2025-11-09T23:42:54.1292601Z   CARGO_INCREMENTAL: 0
2025-11-09T23:42:54.1292812Z ##[endgroup]
2025-11-09T23:42:54.1564692Z ##[group]Run rustc +1.88.0 --version --verbose
2025-11-09T23:42:54.1565098Z [36;1mrustc +1.88.0 --version --verbose[0m
2025-11-09T23:42:54.1596577Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2025-11-09T23:42:54.1596913Z env:
2025-11-09T23:42:54.1597100Z   CARGO_TERM_COLOR: always
2025-11-09T23:42:54.1597334Z   CARGO_HOME: /home/jswift/.cargo
2025-11-09T23:42:54.1597594Z   CARGO_INCREMENTAL: 0
2025-11-09T23:42:54.1597798Z ##[endgroup]
2025-11-09T23:42:54.1812987Z rustc 1.88.0 (6b00bc388 2025-06-23)
2025-11-09T23:42:54.1813632Z binary: rustc
2025-11-09T23:42:54.1814616Z commit-hash: 6b00bc3880198600130e1cf62b8f8a93494488cc
2025-11-09T23:42:54.1815297Z commit-date: 2025-06-23
2025-11-09T23:42:54.1815748Z host: x86_64-unknown-linux-gnu
2025-11-09T23:42:54.1816219Z release: 1.88.0
2025-11-09T23:42:54.1816614Z LLVM version: 20.1.5
2025-11-09T23:42:54.1899395Z ##[group]Run cargo fmt -- --check
2025-11-09T23:42:54.1899698Z [36;1mcargo fmt -- --check[0m
2025-11-09T23:42:54.1935372Z shell: /usr/bin/bash -e {0}
2025-11-09T23:42:54.1937512Z env:
2025-11-09T23:42:54.1937693Z   CARGO_TERM_COLOR: always
2025-11-09T23:42:54.1937940Z   CARGO_HOME: /home/jswift/.cargo
2025-11-09T23:42:54.1938180Z   CARGO_INCREMENTAL: 0
2025-11-09T23:42:54.1938390Z ##[endgroup]
2025-11-09T23:42:54.4944110Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:332:
2025-11-09T23:42:54.4946536Z  pub enum PruningMode {
2025-11-09T23:42:54.4947003Z      /// No pruning (keep all blocks)
2025-11-09T23:42:54.4947437Z      Disabled,
2025-11-09T23:42:54.4947750Z -    
2025-11-09T23:42:54.4948029Z +
2025-11-09T23:42:54.4948426Z      /// Normal pruning (keep recent blocks for verification)
2025-11-09T23:42:54.4948943Z      Normal {
2025-11-09T23:42:54.4949300Z          /// Keep blocks from this height onwards
2025-11-09T23:42:54.4950124Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:342:
2025-11-09T23:42:54.4950943Z          #[serde(default = "default_min_recent_blocks")]
2025-11-09T23:42:54.4951455Z          min_recent_blocks: u64,
2025-11-09T23:42:54.4951847Z      },
2025-11-09T23:42:54.4952111Z -    
2025-11-09T23:42:54.4952368Z +
2025-11-09T23:42:54.4952668Z      /// Aggressive pruning with UTXO commitments
2025-11-09T23:42:54.4953182Z      /// Requires: utxo-commitments feature enabled
2025-11-09T23:42:54.4953629Z      Aggressive {
2025-11-09T23:42:54.4957982Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:359:
2025-11-09T23:42:54.4958865Z          #[serde(default = "default_min_blocks")]
2025-11-09T23:42:54.4959357Z          min_blocks: u64,
2025-11-09T23:42:54.4959707Z      },
2025-11-09T23:42:54.4959986Z -    
2025-11-09T23:42:54.4960265Z +
2025-11-09T23:42:54.4960570Z      /// Custom pruning configuration
2025-11-09T23:42:54.4961003Z      Custom {
2025-11-09T23:42:54.4961480Z          /// Keep block headers (always required for PoW verification)
2025-11-09T23:42:54.4962487Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:408:
2025-11-09T23:42:54.4963229Z      /// Pruning mode
2025-11-09T23:42:54.4963618Z      #[serde(default = "default_pruning_mode")]
2025-11-09T23:42:54.4964095Z      pub mode: PruningMode,
2025-11-09T23:42:54.4966709Z -    
2025-11-09T23:42:54.4967995Z +
2025-11-09T23:42:54.4968427Z      /// Automatic pruning (prune periodically as chain grows)
2025-11-09T23:42:54.4969014Z      #[serde(default = "default_false")]
2025-11-09T23:42:54.4969825Z      pub auto_prune: bool,
2025-11-09T23:42:54.4970523Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:415:
2025-11-09T23:42:54.4971262Z -    
2025-11-09T23:42:54.4971542Z +
2025-11-09T23:42:54.4971863Z      /// Automatic pruning interval (blocks)
2025-11-09T23:42:54.4972380Z      /// Prune every N blocks if auto_prune is enabled
2025-11-09T23:42:54.4988575Z      #[serde(default = "default_auto_prune_interval")]
2025-11-09T23:42:54.4989424Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:419:
2025-11-09T23:42:54.4990222Z      pub auto_prune_interval: u64,
2025-11-09T23:42:54.4990623Z -    
2025-11-09T23:42:54.4990903Z +
2025-11-09T23:42:54.4991223Z      /// Minimum blocks to keep (safety margin)
2025-11-09T23:42:54.4991831Z      /// Even with aggressive pruning, keep at least this many blocks
2025-11-09T23:42:54.4992483Z      #[serde(default = "default_min_blocks_to_keep")]
2025-11-09T23:42:54.4993264Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:424:
2025-11-09T23:42:54.4993997Z      pub min_blocks_to_keep: u64,
2025-11-09T23:42:54.4995959Z -    
2025-11-09T23:42:54.4996283Z +
2025-11-09T23:42:54.4997527Z      /// Prune on startup (prune old blocks when node starts)
2025-11-09T23:42:54.4998081Z      #[serde(default = "default_false")]
2025-11-09T23:42:54.4998864Z      pub prune_on_startup: bool,
2025-11-09T23:42:54.4999621Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:429:
2025-11-09T23:42:54.5002383Z -    
2025-11-09T23:42:54.5014890Z +
2025-11-09T23:42:54.5015517Z      /// Allow incremental pruning during IBD (requires UTXO commitments + aggressive mode)
2025-11-09T23:42:54.5016506Z      /// When enabled, old blocks are pruned incrementally during sync, keeping only a window
2025-11-09T23:42:54.5017514Z      /// of recent blocks. This prevents the need to download the full blockchain before pruning.
2025-11-09T23:42:54.5018527Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:433:
2025-11-09T23:42:54.5019304Z      #[serde(default = "default_false")]
2025-11-09T23:42:54.5019775Z      pub incremental_prune_during_ibd: bool,
2025-11-09T23:42:54.5020197Z -    
2025-11-09T23:42:54.5020473Z +
2025-11-09T23:42:54.5020981Z      /// Block window size for incremental pruning (number of recent blocks to keep)
2025-11-09T23:42:54.5021727Z      /// Only used when incremental_prune_during_ibd is true
2025-11-09T23:42:54.5024014Z      #[serde(default = "default_prune_window_size")]
2025-11-09T23:42:54.5025741Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:439:
2025-11-09T23:42:54.5026510Z      pub prune_window_size: u64,
2025-11-09T23:42:54.5026904Z -    
2025-11-09T23:42:54.5027172Z +
2025-11-09T23:42:54.5027608Z      /// Minimum blocks before starting incremental pruning during IBD
2025-11-09T23:42:54.5028267Z      /// Prevents pruning too early in the sync process
2025-11-09T23:42:54.5028888Z      #[serde(default = "default_min_blocks_for_incremental_prune")]
2025-11-09T23:42:54.5029771Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:444:
2025-11-09T23:42:54.5030551Z      pub min_blocks_for_incremental_prune: u64,
2025-11-09T23:42:54.5030999Z -    
2025-11-09T23:42:54.5031258Z +
2025-11-09T23:42:54.5031559Z      /// UTXO commitments integration
2025-11-09T23:42:54.5032015Z      #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.5032604Z      pub utxo_commitments: Option<UtxoCommitmentsPruningConfig>,
2025-11-09T23:42:54.5033490Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:449:
2025-11-09T23:42:54.5034222Z -    
2025-11-09T23:42:54.5035115Z +
2025-11-09T23:42:54.5035426Z      /// BIP158 filter integration
2025-11-09T23:42:54.5035842Z      #[cfg(feature = "bip158")]
2025-11-09T23:42:54.5036309Z      pub bip158_filters: Option<Bip158PruningConfig>,
2025-11-09T23:42:54.5037423Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:486:
2025-11-09T23:42:54.5038207Z                  keep_filtered_blocks: false,
2025-11-09T23:42:54.5038681Z                  min_blocks: 144, // ~1 day at 10 min/block
2025-11-09T23:42:54.5039367Z              },
2025-11-09T23:42:54.5039760Z -            auto_prune: true, // Enable automatic pruning
2025-11-09T23:42:54.5040368Z +            auto_prune: true,         // Enable automatic pruning
2025-11-09T23:42:54.5040957Z              auto_prune_interval: 144, // Prune every ~1 day
2025-11-09T23:42:54.5041471Z              min_blocks_to_keep: 144,
2025-11-09T23:42:54.5041963Z -            prune_on_startup: false, // Still false for safety
2025-11-09T23:42:54.5042713Z -            incremental_prune_during_ibd: true, // Enable incremental pruning during IBD
2025-11-09T23:42:54.5043556Z -            prune_window_size: 144, // Keep sliding window of 144 blocks during IBD
2025-11-09T23:42:54.5063240Z +            prune_on_startup: false,               // Still false for safety
2025-11-09T23:42:54.5066262Z +            incremental_prune_during_ibd: true,    // Enable incremental pruning during IBD
2025-11-09T23:42:54.5067154Z +            prune_window_size: 144,                // Keep sliding window of 144 blocks during IBD
2025-11-09T23:42:54.5071896Z              min_blocks_for_incremental_prune: 288, // Start pruning after 288 blocks (~2 days)
2025-11-09T23:42:54.5072734Z              #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.5073211Z              utxo_commitments: None,
2025-11-09T23:42:54.5073952Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:508:
2025-11-09T23:42:54.5079258Z      /// Keep UTXO commitments for pruned blocks
2025-11-09T23:42:54.5079797Z      #[serde(default = "default_true")]
2025-11-09T23:42:54.5080232Z      pub keep_commitments: bool,
2025-11-09T23:42:54.5080611Z -    
2025-11-09T23:42:54.5080867Z +
2025-11-09T23:42:54.5081244Z      /// Keep filtered blocks (spam-filtered) for pruned range
2025-11-09T23:42:54.5081793Z      #[serde(default = "default_false")]
2025-11-09T23:42:54.5082235Z      pub keep_filtered_blocks: bool,
2025-11-09T23:42:54.5082951Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:515:
2025-11-09T23:42:54.5083643Z -    
2025-11-09T23:42:54.5083903Z +
2025-11-09T23:42:54.5084489Z      /// Generate commitments before pruning (if not already generated)
2025-11-09T23:42:54.5085632Z      #[serde(default = "default_true")]
2025-11-09T23:42:54.5086071Z      pub generate_before_prune: bool,
2025-11-09T23:42:54.5086793Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:519:
2025-11-09T23:42:54.5087487Z -    
2025-11-09T23:42:54.5087734Z +
2025-11-09T23:42:54.5088099Z      /// Maximum age for commitments (days, 0 = keep forever)
2025-11-09T23:42:54.5088655Z      #[serde(default = "default_commitment_max_age")]
2025-11-09T23:42:54.5089145Z      pub max_commitment_age_days: u32,
2025-11-09T23:42:54.5089855Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:546:
2025-11-09T23:42:54.5090762Z      /// Keep BIP158 filters for pruned blocks
2025-11-09T23:42:54.5091225Z      #[serde(default = "default_true")]
2025-11-09T23:42:54.5091636Z      pub keep_filters: bool,
2025-11-09T23:42:54.5091990Z -    
2025-11-09T23:42:54.5092245Z +
2025-11-09T23:42:54.5092642Z      /// Keep filter header chain (always required for verification)
2025-11-09T23:42:54.5093217Z      #[serde(default = "default_true")]
2025-11-09T23:42:54.5094119Z      pub keep_filter_headers: bool,
2025-11-09T23:42:54.5095725Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:553:
2025-11-09T23:42:54.5096459Z -    
2025-11-09T23:42:54.5096723Z +
2025-11-09T23:42:54.5097055Z      /// Maximum age for filters (days, 0 = keep forever)
2025-11-09T23:42:54.5097595Z      #[serde(default = "default_filter_max_age")]
2025-11-09T23:42:54.5098088Z      pub max_filter_age_days: u32,
2025-11-09T23:42:54.5099607Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:578:
2025-11-09T23:42:54.5100384Z      /// Database backend selection
2025-11-09T23:42:54.5100857Z      #[serde(default = "default_database_backend")]
2025-11-09T23:42:54.5101485Z      pub database_backend: DatabaseBackendConfig,
2025-11-09T23:42:54.5101952Z -    
2025-11-09T23:42:54.5102233Z +
2025-11-09T23:42:54.5102503Z      /// Storage path
2025-11-09T23:42:54.5102888Z      #[serde(default = "default_storage_path")]
2025-11-09T23:42:54.5103345Z      pub data_dir: String,
2025-11-09T23:42:54.5104119Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:585:
2025-11-09T23:42:54.5105003Z -    
2025-11-09T23:42:54.5105261Z +
2025-11-09T23:42:54.5105549Z      /// Pruning configuration
2025-11-09T23:42:54.5105966Z      pub pruning: Option<PruningConfig>,
2025-11-09T23:42:54.5106408Z -    
2025-11-09T23:42:54.5106669Z +
2025-11-09T23:42:54.5106952Z      /// Cache sizes
2025-11-09T23:42:54.5107320Z      pub cache: Option<StorageCacheConfig>,
2025-11-09T23:42:54.5107757Z  }
2025-11-09T23:42:54.5108351Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:616:
2025-11-09T23:42:54.5109097Z      /// Block cache size (MB)
2025-11-09T23:42:54.5109530Z      #[serde(default = "default_block_cache_mb")]
2025-11-09T23:42:54.5110263Z      pub block_cache_mb: usize,
2025-11-09T23:42:54.5110662Z -    
2025-11-09T23:42:54.5110925Z +
2025-11-09T23:42:54.5111214Z      /// UTXO cache size (MB)
2025-11-09T23:42:54.5111632Z      #[serde(default = "default_utxo_cache_mb")]
2025-11-09T23:42:54.5112114Z      pub utxo_cache_mb: usize,
2025-11-09T23:42:54.5112796Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:623:
2025-11-09T23:42:54.5113524Z -    
2025-11-09T23:42:54.5114008Z +
2025-11-09T23:42:54.5114282Z      /// Header cache size (MB)
2025-11-09T23:42:54.5114857Z      #[serde(default = "default_header_cache_mb")]
2025-11-09T23:42:54.5115359Z      pub header_cache_mb: usize,
2025-11-09T23:42:54.5116064Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:668:
2025-11-09T23:42:54.5116809Z                  pruning.validate()?;
2025-11-09T23:42:54.5117204Z              }
2025-11-09T23:42:54.5117484Z          }
2025-11-09T23:42:54.5117747Z -        
2025-11-09T23:42:54.5118013Z +
2025-11-09T23:42:54.5118262Z          Ok(())
2025-11-09T23:42:54.5118528Z      }
2025-11-09T23:42:54.5118785Z  }
2025-11-09T23:42:54.5119374Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:686:
2025-11-09T23:42:54.5120048Z                  ));
2025-11-09T23:42:54.5120327Z              }
2025-11-09T23:42:54.5120578Z          }
2025-11-09T23:42:54.5120883Z -        
2025-11-09T23:42:54.5121132Z +
2025-11-09T23:42:54.5121421Z          // Validate min_blocks_to_keep is reasonable
2025-11-09T23:42:54.5121871Z          if self.min_blocks_to_keep == 0 {
2025-11-09T23:42:54.5126680Z              return Err(anyhow::anyhow!(
2025-11-09T23:42:54.5127417Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:693:
2025-11-09T23:42:54.5128296Z                  "min_blocks_to_keep must be greater than 0 for safety"
2025-11-09T23:42:54.5128808Z              ));
2025-11-09T23:42:54.5129124Z          }
2025-11-09T23:42:54.5129403Z -        
2025-11-09T23:42:54.5129683Z +
2025-11-09T23:42:54.5129984Z          // Validate auto_prune_interval
2025-11-09T23:42:54.5130517Z          if self.auto_prune && self.auto_prune_interval == 0 {
2025-11-09T23:42:54.5131065Z              return Err(anyhow::anyhow!(
2025-11-09T23:42:54.5131775Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:700:
2025-11-09T23:42:54.5132710Z                  "auto_prune_interval must be greater than 0 when auto_prune is enabled"
2025-11-09T23:42:54.5133321Z              ));
2025-11-09T23:42:54.5133603Z          }
2025-11-09T23:42:54.5134152Z -        
2025-11-09T23:42:54.5134617Z +
2025-11-09T23:42:54.5134915Z          // Validate mode-specific settings
2025-11-09T23:42:54.5135359Z          match &self.mode {
2025-11-09T23:42:54.5135796Z -            PruningMode::Normal { min_recent_blocks, .. } => {
2025-11-09T23:42:54.5136331Z +            PruningMode::Normal {
2025-11-09T23:42:54.5136725Z +                min_recent_blocks, ..
2025-11-09T23:42:54.5137127Z +            } => {
2025-11-09T23:42:54.5137437Z                  if *min_recent_blocks == 0 {
2025-11-09T23:42:54.5137865Z                      return Err(anyhow::anyhow!(
2025-11-09T23:42:54.5138410Z                          "min_recent_blocks must be greater than 0 in Normal pruning mode"
2025-11-09T23:42:54.5139216Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/config/mod.rs:728:
2025-11-09T23:42:54.5139924Z                  // No validation needed
2025-11-09T23:42:54.5140293Z              }
2025-11-09T23:42:54.5140547Z          }
2025-11-09T23:42:54.5140789Z -        
2025-11-09T23:42:54.5141032Z +
2025-11-09T23:42:54.5141257Z          Ok(())
2025-11-09T23:42:54.5141516Z      }
2025-11-09T23:42:54.5141749Z  }
2025-11-09T23:42:54.5142360Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/lib.rs:25:
2025-11-09T23:42:54.5143001Z  #[global_allocator]
2025-11-09T23:42:54.5143439Z  static GLOBAL: mimalloc::MiMalloc = mimalloc::MiMalloc;
2025-11-09T23:42:54.5144125Z  
2025-11-09T23:42:54.5145326Z -pub mod storage;
2025-11-09T23:42:54.5145671Z +pub mod bip21;
2025-11-09T23:42:54.5145962Z +pub mod config;
2025-11-09T23:42:54.5146233Z +pub mod module;
2025-11-09T23:42:54.5146510Z  pub mod network;
2025-11-09T23:42:54.5146790Z -pub mod rpc;
2025-11-09T23:42:54.5147094Z  pub mod node;
2025-11-09T23:42:54.5147402Z -pub mod config;
2025-11-09T23:42:54.5147704Z +pub mod rpc;
2025-11-09T23:42:54.5148010Z +pub mod storage;
2025-11-09T23:42:54.5148341Z  #[cfg(feature = "production")]
2025-11-09T23:42:54.5148745Z  pub mod validation;
2025-11-09T23:42:54.5149088Z -pub mod module;
2025-11-09T23:42:54.5149408Z -pub mod bip21;
2025-11-09T23:42:54.5149701Z  
2025-11-09T23:42:54.5150001Z  // Re-export config module
2025-11-09T23:42:54.5150391Z  pub use config::*;
2025-11-09T23:42:54.5151007Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/lib.rs:40:
2025-11-09T23:42:54.5151666Z  
2025-11-09T23:42:54.5152024Z  // Re-export commonly used types from protocol-engine
2025-11-09T23:42:54.5152809Z  // This allows depending only on protocol-engine (which transitively provides consensus-proof)
2025-11-09T23:42:54.5153548Z +pub use bllvm_protocol::mempool::Mempool;
2025-11-09T23:42:54.5154042Z  pub use bllvm_protocol::{
2025-11-09T23:42:54.5154760Z -    Block, BlockHeader, Transaction, TransactionInput, TransactionOutput,
2025-11-09T23:42:54.5155557Z -    OutPoint, UTXO, UtxoSet, ValidationResult, Hash, ByteString, Natural, Integer,
2025-11-09T23:42:54.5156191Z -    ConsensusError, Result,
2025-11-09T23:42:54.5156849Z +    Block, BlockHeader, ByteString, ConsensusError, Hash, Integer, Natural, OutPoint, Result,
2025-11-09T23:42:54.5157794Z +    Transaction, TransactionInput, TransactionOutput, UtxoSet, ValidationResult, UTXO,
2025-11-09T23:42:54.5158423Z  };
2025-11-09T23:42:54.5158750Z -pub use bllvm_protocol::mempool::Mempool;
2025-11-09T23:42:54.5159178Z  
2025-11-09T23:42:54.5159481Z  // Re-export protocol-engine types
2025-11-09T23:42:54.5160105Z  pub use bllvm_protocol::{BitcoinProtocolEngine, ProtocolVersion};
2025-11-09T23:42:54.5160973Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/lib.rs:81:
2025-11-09T23:42:54.5161810Z          // Test that protocol-engine works in reference-node context
2025-11-09T23:42:54.5164253Z          let node = ReferenceNode::new(Some(ProtocolVersion::Regtest)).unwrap();
2025-11-09T23:42:54.5165098Z          let protocol = node.protocol();
2025-11-09T23:42:54.5165523Z -        
2025-11-09T23:42:54.5165804Z +
2025-11-09T23:42:54.5166090Z          // Verify protocol version
2025-11-09T23:42:54.5167084Z          assert_eq!(protocol.get_protocol_version(), ProtocolVersion::Regtest);
2025-11-09T23:42:54.5167696Z -        
2025-11-09T23:42:54.5167979Z +
2025-11-09T23:42:54.5168265Z          // Test feature support
2025-11-09T23:42:54.5168766Z          assert!(protocol.supports_feature("fast_mining"));
2025-11-09T23:42:54.5169265Z      }
2025-11-09T23:42:54.5169812Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/lib.rs:94:
2025-11-09T23:42:54.5170626Z          // Test consensus validation through protocol-engine
2025-11-09T23:42:54.5171327Z          let node = ReferenceNode::new(None).unwrap(); // Uses default Regtest
2025-11-09T23:42:54.5171970Z          let protocol = node.protocol();
2025-11-09T23:42:54.5172383Z -        
2025-11-09T23:42:54.5172655Z +
2025-11-09T23:42:54.5172952Z          // Create a simple transaction
2025-11-09T23:42:54.5173392Z          let tx = Transaction {
2025-11-09T23:42:54.5173788Z              version: 1,
2025-11-09T23:42:54.5176520Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/lib.rs:105:
2025-11-09T23:42:54.5177204Z              }],
2025-11-09T23:42:54.5177524Z              lock_time: 0,
2025-11-09T23:42:54.5177871Z          };
2025-11-09T23:42:54.5178142Z -        
2025-11-09T23:42:54.5178413Z +
2025-11-09T23:42:54.5178708Z          // Test transaction validation
2025-11-09T23:42:54.5179470Z          let result = protocol.validate_transaction(&tx);
2025-11-09T23:42:54.5180018Z          assert!(result.is_ok());
2025-11-09T23:42:54.5180685Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/lib.rs:115:
2025-11-09T23:42:54.5181339Z      fn test_reference_node_creation() {
2025-11-09T23:42:54.5181754Z          // Test default (Regtest) creation
2025-11-09T23:42:54.5182212Z          let node = ReferenceNode::new(None).unwrap();
2025-11-09T23:42:54.5182879Z -        assert_eq!(node.protocol().get_protocol_version(), ProtocolVersion::Regtest);
2025-11-09T23:42:54.5183496Z -        
2025-11-09T23:42:54.5183771Z +        assert_eq!(
2025-11-09T23:42:54.5184128Z +            node.protocol().get_protocol_version(),
2025-11-09T23:42:54.5184770Z +            ProtocolVersion::Regtest
2025-11-09T23:42:54.5185144Z +        );
2025-11-09T23:42:54.5185397Z +
2025-11-09T23:42:54.5185650Z          // Test mainnet creation
2025-11-09T23:42:54.5186284Z          let mainnet_node = ReferenceNode::new(Some(ProtocolVersion::BitcoinV1)).unwrap();
2025-11-09T23:42:54.5187233Z -        assert_eq!(mainnet_node.protocol().get_protocol_version(), ProtocolVersion::BitcoinV1);
2025-11-09T23:42:54.5187913Z +        assert_eq!(
2025-11-09T23:42:54.5188294Z +            mainnet_node.protocol().get_protocol_version(),
2025-11-09T23:42:54.5188800Z +            ProtocolVersion::BitcoinV1
2025-11-09T23:42:54.5189192Z +        );
2025-11-09T23:42:54.5189448Z      }
2025-11-09T23:42:54.5189706Z  }
2025-11-09T23:42:54.5189945Z +
2025-11-09T23:42:54.5190535Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/api/hub.rs:81:
2025-11-09T23:42:54.5191372Z              .validate_request(module_id, &request.payload)?;
2025-11-09T23:42:54.5192423Z  
2025-11-09T23:42:54.5192908Z          // Handle handshake specially (no validation needed, just acknowledge)
2025-11-09T23:42:54.5193875Z -        if let RequestPayload::Handshake { module_id: handshake_id, module_name, version } = &request.payload {
2025-11-09T23:42:54.5194881Z +        if let RequestPayload::Handshake {
2025-11-09T23:42:54.5195361Z +            module_id: handshake_id,
2025-11-09T23:42:54.5195794Z +            module_name,
2025-11-09T23:42:54.5196639Z +            version,
2025-11-09T23:42:54.5196988Z +        } = &request.payload
2025-11-09T23:42:54.5198767Z +        {
2025-11-09T23:42:54.5199084Z              // Verify module_id matches
2025-11-09T23:42:54.5199531Z              if handshake_id != module_id {
2025-11-09T23:42:54.5200040Z -                return Err(ModuleError::OperationError(
2025-11-09T23:42:54.5200816Z -                    format!("Handshake module_id mismatch: expected {}, got {}", module_id, handshake_id)
2025-11-09T23:42:54.5201849Z -                ));
2025-11-09T23:42:54.5202298Z +                return Err(ModuleError::OperationError(format!(
2025-11-09T23:42:54.5202914Z +                    "Handshake module_id mismatch: expected {}, got {}",
2025-11-09T23:42:54.5203480Z +                    module_id, handshake_id
2025-11-09T23:42:54.5203914Z +                )));
2025-11-09T23:42:54.5204235Z              }
2025-11-09T23:42:54.5204726Z -            
2025-11-09T23:42:54.5206824Z -            info!("Handshake from module {} (name={}, version={})", module_id, module_name, version);
2025-11-09T23:42:54.5207486Z +
2025-11-09T23:42:54.5207761Z +            info!(
2025-11-09T23:42:54.5208174Z +                "Handshake from module {} (name={}, version={})",
2025-11-09T23:42:54.5208680Z +                module_id, module_name, version
2025-11-09T23:42:54.5209093Z +            );
2025-11-09T23:42:54.5209428Z              return Ok(ResponseMessage::success(
2025-11-09T23:42:54.5209918Z                  request.correlation_id,
2025-11-09T23:42:54.5210398Z                  ResponsePayload::HandshakeAck {
2025-11-09T23:42:54.5211189Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/api/hub.rs:96:
2025-11-09T23:42:54.5212045Z                      node_version: env!("CARGO_PKG_VERSION").to_string(),
2025-11-09T23:42:54.5212813Z -                }
2025-11-09T23:42:54.5213134Z +                },
2025-11-09T23:42:54.5213418Z              ));
2025-11-09T23:42:54.5213942Z          }
2025-11-09T23:42:54.5214207Z  
2025-11-09T23:42:54.5215081Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/api/hub.rs:108:
2025-11-09T23:42:54.5215910Z              RequestPayload::Handshake { .. } => {
2025-11-09T23:42:54.5216476Z                  // Handshake is handled at connection level, not here
2025-11-09T23:42:54.5217698Z                  return Err(crate::module::traits::ModuleError::IpcError(
2025-11-09T23:42:54.5218440Z -                    "Handshake should be handled at connection level".to_string()
2025-11-09T23:42:54.5219191Z +                    "Handshake should be handled at connection level".to_string(),
2025-11-09T23:42:54.5219741Z                  ));
2025-11-09T23:42:54.5220060Z              }
2025-11-09T23:42:54.5220419Z              RequestPayload::GetBlock { hash } => {
2025-11-09T23:42:54.5221276Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/ipc/protocol.rs:76:
2025-11-09T23:42:54.5222134Z  #[derive(Debug, Clone, Serialize, Deserialize)]
2025-11-09T23:42:54.5222647Z  pub enum RequestPayload {
2025-11-09T23:42:54.5223126Z      /// Handshake: Module identifies itself (first message)
2025-11-09T23:42:54.5223799Z -    Handshake { module_id: String, module_name: String, version: String },
2025-11-09T23:42:54.5224582Z -    GetBlock { hash: Hash },
2025-11-09T23:42:54.5224980Z -    GetBlockHeader { hash: Hash },
2025-11-09T23:42:54.5225396Z -    GetTransaction { hash: Hash },
2025-11-09T23:42:54.5225829Z -    HasTransaction { hash: Hash },
2025-11-09T23:42:54.5226217Z +    Handshake {
2025-11-09T23:42:54.5226527Z +        module_id: String,
2025-11-09T23:42:54.5226898Z +        module_name: String,
2025-11-09T23:42:54.5227265Z +        version: String,
2025-11-09T23:42:54.5227602Z +    },
2025-11-09T23:42:54.5227874Z +    GetBlock {
2025-11-09T23:42:54.5228178Z +        hash: Hash,
2025-11-09T23:42:54.5228493Z +    },
2025-11-09T23:42:54.5228773Z +    GetBlockHeader {
2025-11-09T23:42:54.5229124Z +        hash: Hash,
2025-11-09T23:42:54.5229420Z +    },
2025-11-09T23:42:54.5229699Z +    GetTransaction {
2025-11-09T23:42:54.5230068Z +        hash: Hash,
2025-11-09T23:42:54.5230368Z +    },
2025-11-09T23:42:54.5230647Z +    HasTransaction {
2025-11-09T23:42:54.5230974Z +        hash: Hash,
2025-11-09T23:42:54.5231270Z +    },
2025-11-09T23:42:54.5231545Z      GetChainTip,
2025-11-09T23:42:54.5231857Z      GetBlockHeight,
2025-11-09T23:42:54.5232220Z -    GetUtxo { outpoint: OutPoint },
2025-11-09T23:42:54.5233038Z -    SubscribeEvents { event_types: Vec<EventType> },
2025-11-09T23:42:54.5233538Z +    GetUtxo {
2025-11-09T23:42:54.5233865Z +        outpoint: OutPoint,
2025-11-09T23:42:54.5234221Z +    },
2025-11-09T23:42:54.5234710Z +    SubscribeEvents {
2025-11-09T23:42:54.5235074Z +        event_types: Vec<EventType>,
2025-11-09T23:42:54.5235486Z +    },
2025-11-09T23:42:54.5235745Z  }
2025-11-09T23:42:54.5236004Z  
2025-11-09T23:42:54.5236302Z  /// Response message from node to module
2025-11-09T23:42:54.5237136Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/ipc/protocol.rs:100:
2025-11-09T23:42:54.5238003Z  #[derive(Debug, Clone, Serialize, Deserialize)]
2025-11-09T23:42:54.5238499Z  pub enum ResponsePayload {
2025-11-09T23:42:54.5238947Z      /// Handshake acknowledgment with node version
2025-11-09T23:42:54.5239460Z -    HandshakeAck { node_version: String },
2025-11-09T23:42:54.5239895Z +    HandshakeAck {
2025-11-09T23:42:54.5240201Z +        node_version: String,
2025-11-09T23:42:54.5240550Z +    },
2025-11-09T23:42:54.5240838Z      Block(Option<Block>),
2025-11-09T23:42:54.5241237Z      BlockHeader(Option<BlockHeader>),
2025-11-09T23:42:54.5241683Z      Transaction(Option<Transaction>),
2025-11-09T23:42:54.5242559Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/ipc/server.rs:124:
2025-11-09T23:42:54.5243615Z              Some(Ok(bytes)) => {
2025-11-09T23:42:54.5244509Z                  let message: ModuleMessage = bincode::deserialize(bytes.as_ref())
2025-11-09T23:42:54.5245305Z                      .map_err(|e| ModuleError::SerializationError(e.to_string()))?;
2025-11-09T23:42:54.5245887Z -                
2025-11-09T23:42:54.5246188Z +
2025-11-09T23:42:54.5246476Z                  match message {
2025-11-09T23:42:54.5246952Z                      ModuleMessage::Request(request) => {
2025-11-09T23:42:54.5247748Z -                        if let RequestPayload::Handshake { module_id, module_name, version } = request.payload {
2025-11-09T23:42:54.5248560Z +                        if let RequestPayload::Handshake {
2025-11-09T23:42:54.5249044Z +                            module_id,
2025-11-09T23:42:54.5249478Z +                            module_name,
2025-11-09T23:42:54.5249901Z +                            version,
2025-11-09T23:42:54.5250334Z +                        } = request.payload
2025-11-09T23:42:54.5250762Z +                        {
2025-11-09T23:42:54.5251138Z                              info!(
2025-11-09T23:42:54.5251623Z                                  "Module handshake: id={}, name={}, version={}",
2025-11-09T23:42:54.5252167Z                                  module_id, module_name, version
2025-11-09T23:42:54.5252996Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/ipc/server.rs:134:
2025-11-09T23:42:54.5253751Z                              );
2025-11-09T23:42:54.5254086Z -                            
2025-11-09T23:42:54.5254670Z +
2025-11-09T23:42:54.5254966Z                              // Send handshake acknowledgment
2025-11-09T23:42:54.5266225Z                              let ack = ResponseMessage {
2025-11-09T23:42:54.5266800Z                                  correlation_id: request.correlation_id,
2025-11-09T23:42:54.5267635Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/ipc/server.rs:142:
2025-11-09T23:42:54.5268364Z                                  }),
2025-11-09T23:42:54.5268748Z                                  error: None,
2025-11-09T23:42:54.5269142Z                              };
2025-11-09T23:42:54.5269477Z -                            
2025-11-09T23:42:54.5269800Z +
2025-11-09T23:42:54.5270226Z                              let ack_bytes = bincode::serialize(&ModuleMessage::Response(ack))
2025-11-09T23:42:54.5270964Z                                  .map_err(|e| ModuleError::SerializationError(e.to_string()))?;
2025-11-09T23:42:54.5271647Z -                            writer.send(bytes::Bytes::from(ack_bytes)).await
2025-11-09T23:42:54.5272739Z -                                .map_err(|e| ModuleError::IpcError(format!("Failed to send handshake ack: {}", e)))?;
2025-11-09T23:42:54.5273440Z -                            
2025-11-09T23:42:54.5273809Z +                            writer
2025-11-09T23:42:54.5274264Z +                                .send(bytes::Bytes::from(ack_bytes))
2025-11-09T23:42:54.5274921Z +                                .await
2025-11-09T23:42:54.5275442Z +                                .map_err(|e| {
2025-11-09T23:42:54.5275886Z +                                    ModuleError::IpcError(format!(
2025-11-09T23:42:54.5276394Z +                                        "Failed to send handshake ack: {}",
2025-11-09T23:42:54.5276896Z +                                        e
2025-11-09T23:42:54.5277299Z +                                    ))
2025-11-09T23:42:54.5277691Z +                                })?;
2025-11-09T23:42:54.5278053Z +
2025-11-09T23:42:54.5278323Z                              module_id
2025-11-09T23:42:54.5278736Z                          } else {
2025-11-09T23:42:54.5279260Z                              // No handshake - use fallback ID (backward compatibility)
2025-11-09T23:42:54.5280099Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/ipc/server.rs:162:
2025-11-09T23:42:54.5280794Z                      }
2025-11-09T23:42:54.5281307Z                      _ => {
2025-11-09T23:42:54.5281690Z                          return Err(ModuleError::IpcError(
2025-11-09T23:42:54.5282761Z -                            "First message must be a handshake request".to_string()
2025-11-09T23:42:54.5283370Z +                            "First message must be a handshake request".to_string(),
2025-11-09T23:42:54.5283855Z                          ));
2025-11-09T23:42:54.5284161Z                      }
2025-11-09T23:42:54.5284599Z                  }
2025-11-09T23:42:54.5285283Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/ipc/server.rs:169:
2025-11-09T23:42:54.5286066Z              }
2025-11-09T23:42:54.5286382Z              Some(Err(e)) => {
2025-11-09T23:42:54.5288317Z -                return Err(ModuleError::IpcError(format!("Failed to read handshake: {}", e)));
2025-11-09T23:42:54.5289044Z +                return Err(ModuleError::IpcError(format!(
2025-11-09T23:42:54.5289514Z +                    "Failed to read handshake: {}",
2025-11-09T23:42:54.5289935Z +                    e
2025-11-09T23:42:54.5290219Z +                )));
2025-11-09T23:42:54.5290498Z              }
2025-11-09T23:42:54.5290778Z              None => {
2025-11-09T23:42:54.5291377Z -                return Err(ModuleError::IpcError("Connection closed before handshake".to_string()));
2025-11-09T23:42:54.5292093Z +                return Err(ModuleError::IpcError(
2025-11-09T23:42:54.5292607Z +                    "Connection closed before handshake".to_string(),
2025-11-09T23:42:54.5293142Z +                ));
2025-11-09T23:42:54.5293451Z              }
2025-11-09T23:42:54.5293745Z          };
2025-11-09T23:42:54.5294007Z  
2025-11-09T23:42:54.5294808Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/ipc/server.rs:372:
2025-11-09T23:42:54.5297146Z                  // Handshake is handled at connection level
2025-11-09T23:42:54.5297680Z                  Ok(ResponseMessage::success(
2025-11-09T23:42:54.5298170Z                      request.correlation_id,
2025-11-09T23:42:54.5298897Z -                    ResponsePayload::HandshakeAck { node_version: env!("CARGO_PKG_VERSION").to_string() },
2025-11-09T23:42:54.5299700Z +                    ResponsePayload::HandshakeAck {
2025-11-09T23:42:54.5300255Z +                        node_version: env!("CARGO_PKG_VERSION").to_string(),
2025-11-09T23:42:54.5300785Z +                    },
2025-11-09T23:42:54.5301108Z                  ))
2025-11-09T23:42:54.5301412Z              }
2025-11-09T23:42:54.5301778Z              RequestPayload::GetBlock { hash } => {
2025-11-09T23:42:54.5302638Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/manager.rs:159:
2025-11-09T23:42:54.5303825Z          // This allows both to access the process for different purposes
2025-11-09T23:42:54.5304592Z          use std::sync::Arc;
2025-11-09T23:42:54.5305147Z          let shared_process = Arc::new(tokio::sync::Mutex::new(process));
2025-11-09T23:42:54.5305695Z -        
2025-11-09T23:42:54.5305981Z +
2025-11-09T23:42:54.5306320Z          // Create monitor with shared process
2025-11-09T23:42:54.5306939Z          let monitor = ModuleProcessMonitor::new(self.crash_tx.clone());
2025-11-09T23:42:54.5309186Z          let module_name_clone = module_name.to_string();
2025-11-09T23:42:54.5310143Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:87:
2025-11-09T23:42:54.5310918Z  
2025-11-09T23:42:54.5311216Z              // Check heartbeat via IPC
2025-11-09T23:42:54.5311695Z              if let Some(client) = process.client_mut() {
2025-11-09T23:42:54.5312263Z +                use crate::module::ipc::protocol::MessageType;
2025-11-09T23:42:54.5312856Z                  use crate::module::ipc::protocol::RequestMessage;
2025-11-09T23:42:54.5313430Z                  use crate::module::ipc::protocol::RequestPayload;
2025-11-09T23:42:54.5314243Z -                use crate::module::ipc::protocol::MessageType;
2025-11-09T23:42:54.5314880Z -                
2025-11-09T23:42:54.5315433Z +
2025-11-09T23:42:54.5315827Z                  // Use GetChainTip as a lightweight heartbeat check
2025-11-09T23:42:54.5316405Z                  let heartbeat_request = RequestMessage {
2025-11-09T23:42:54.5318722Z                      correlation_id: 0, // Use 0 for heartbeat (won't match any real request)
2025-11-09T23:42:54.5319714Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:97:
2025-11-09T23:42:54.5320607Z                      request_type: MessageType::GetChainTip,
2025-11-09T23:42:54.5321133Z                      payload: RequestPayload::GetChainTip,
2025-11-09T23:42:54.5321598Z                  };
2025-11-09T23:42:54.5321887Z -                
2025-11-09T23:42:54.5322183Z +
2025-11-09T23:42:54.5322472Z                  // Send heartbeat with timeout
2025-11-09T23:42:54.5322999Z -                let heartbeat_result = tokio::time::timeout(
2025-11-09T23:42:54.5323539Z -                    Duration::from_secs(2),
2025-11-09T23:42:54.5324036Z -                    client.request(heartbeat_request)
2025-11-09T23:42:54.5324749Z -                ).await;
2025-11-09T23:42:54.5325097Z -                
2025-11-09T23:42:54.5325445Z +                let heartbeat_result =
2025-11-09T23:42:54.5326125Z +                    tokio::time::timeout(Duration::from_secs(2), client.request(heartbeat_request))
2025-11-09T23:42:54.5328423Z +                        .await;
2025-11-09T23:42:54.5328786Z +
2025-11-09T23:42:54.5329092Z                  match heartbeat_result {
2025-11-09T23:42:54.5329506Z                      Ok(Ok(_)) => {
2025-11-09T23:42:54.5329949Z                          // Heartbeat successful - module is responsive
2025-11-09T23:42:54.5330821Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:120:
2025-11-09T23:42:54.5331615Z                  }
2025-11-09T23:42:54.5331934Z              } else {
2025-11-09T23:42:54.5332354Z                  // No IPC client available - can't check heartbeat
2025-11-09T23:42:54.5333063Z -                debug!("Module {} has no IPC client for heartbeat check", module_name);
2025-11-09T23:42:54.5333673Z +                debug!(
2025-11-09T23:42:54.5334106Z +                    "Module {} has no IPC client for heartbeat check",
2025-11-09T23:42:54.5334815Z +                    module_name
2025-11-09T23:42:54.5335180Z +                );
2025-11-09T23:42:54.5335486Z              }
2025-11-09T23:42:54.5335771Z -            
2025-11-09T23:42:54.5336056Z +
2025-11-09T23:42:54.5336361Z              // Loop continues to next iteration
2025-11-09T23:42:54.5336793Z          }
2025-11-09T23:42:54.5337319Z      }
2025-11-09T23:42:54.5338001Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:145:
2025-11-09T23:42:54.5338927Z                  let mut process_guard = shared_process.lock().await;
2025-11-09T23:42:54.5339461Z                  process_guard.is_running()
2025-11-09T23:42:54.5339887Z              };
2025-11-09T23:42:54.5340179Z -            
2025-11-09T23:42:54.5340473Z +
2025-11-09T23:42:54.5340749Z              if !is_running {
2025-11-09T23:42:54.5341181Z                  // Process exited, check exit status
2025-11-09T23:42:54.5341645Z                  let exit_status = {
2025-11-09T23:42:54.5342466Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:152:
2025-11-09T23:42:54.5343408Z                      let mut process_guard = shared_process.lock().await;
2025-11-09T23:42:54.5343965Z                      process_guard.wait().await?
2025-11-09T23:42:54.5344549Z                  };
2025-11-09T23:42:54.5346738Z -                
2025-11-09T23:42:54.5347031Z +
2025-11-09T23:42:54.5347295Z                  match exit_status {
2025-11-09T23:42:54.5347706Z                      Some(status) => {
2025-11-09T23:42:54.5348143Z                          if status.success() {
2025-11-09T23:42:54.5349272Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:182:
2025-11-09T23:42:54.5350129Z              {
2025-11-09T23:42:54.5350554Z                  let mut process_guard = shared_process.lock().await;
2025-11-09T23:42:54.5351158Z                  if let Some(client) = process_guard.client_mut() {
2025-11-09T23:42:54.5351736Z +                    use crate::module::ipc::protocol::MessageType;
2025-11-09T23:42:54.5352329Z                      use crate::module::ipc::protocol::RequestMessage;
2025-11-09T23:42:54.5352942Z                      use crate::module::ipc::protocol::RequestPayload;
2025-11-09T23:42:54.5353528Z -                    use crate::module::ipc::protocol::MessageType;
2025-11-09T23:42:54.5354017Z -                    
2025-11-09T23:42:54.5354494Z +
2025-11-09T23:42:54.5354881Z                      // Use GetChainTip as a lightweight heartbeat check
2025-11-09T23:42:54.5355458Z                      let heartbeat_request = RequestMessage {
2025-11-09T23:42:54.5356127Z                          correlation_id: 0, // Use 0 for heartbeat (won't match any real request)
2025-11-09T23:42:54.5358871Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:192:
2025-11-09T23:42:54.5359778Z                          request_type: MessageType::GetChainTip,
2025-11-09T23:42:54.5360327Z                          payload: RequestPayload::GetChainTip,
2025-11-09T23:42:54.5360775Z                      };
2025-11-09T23:42:54.5361094Z -                    
2025-11-09T23:42:54.5361392Z +
2025-11-09T23:42:54.5361693Z                      // Send heartbeat with timeout
2025-11-09T23:42:54.5362201Z                      let heartbeat_result = tokio::time::timeout(
2025-11-09T23:42:54.5362710Z                          Duration::from_secs(2),
2025-11-09T23:42:54.5363514Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:199:
2025-11-09T23:42:54.5364642Z -                        client.request(heartbeat_request)
2025-11-09T23:42:54.5365142Z -                    ).await;
2025-11-09T23:42:54.5366998Z -                    
2025-11-09T23:42:54.5367389Z +                        client.request(heartbeat_request),
2025-11-09T23:42:54.5367845Z +                    )
2025-11-09T23:42:54.5368177Z +                    .await;
2025-11-09T23:42:54.5368523Z +
2025-11-09T23:42:54.5368827Z                      match heartbeat_result {
2025-11-09T23:42:54.5369271Z                          Ok(Ok(_)) => {
2025-11-09T23:42:54.5369761Z                              // Heartbeat successful - module is responsive
2025-11-09T23:42:54.5370652Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:215:
2025-11-09T23:42:54.5371762Z                      }
2025-11-09T23:42:54.5372108Z                  } else {
2025-11-09T23:42:54.5372542Z                      // No IPC client available - can't check heartbeat
2025-11-09T23:42:54.5373233Z -                    debug!("Module {} has no IPC client for heartbeat check", module_name);
2025-11-09T23:42:54.5373853Z +                    debug!(
2025-11-09T23:42:54.5374487Z +                        "Module {} has no IPC client for heartbeat check",
2025-11-09T23:42:54.5375014Z +                        module_name
2025-11-09T23:42:54.5375405Z +                    );
2025-11-09T23:42:54.5375704Z                  }
2025-11-09T23:42:54.5375976Z              }
2025-11-09T23:42:54.5376247Z -            
2025-11-09T23:42:54.5376518Z +
2025-11-09T23:42:54.5376825Z              // Loop continues to next iteration
2025-11-09T23:42:54.5377231Z          }
2025-11-09T23:42:54.5377499Z      }
2025-11-09T23:42:54.5378182Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:229:
2025-11-09T23:42:54.5379156Z              ModuleHealth::Crashed("Process exited".to_string())
2025-11-09T23:42:54.5379770Z          } else if let Some(client) = process.client_mut() {
2025-11-09T23:42:54.5380319Z              // Check heartbeat via IPC with short timeout
2025-11-09T23:42:54.5381281Z -            use crate::module::ipc::protocol::{RequestMessage, RequestPayload, MessageType};
2025-11-09T23:42:54.5382198Z +            use crate::module::ipc::protocol::{MessageType, RequestMessage, RequestPayload};
2025-11-09T23:42:54.5382868Z              use tokio::time::timeout;
2025-11-09T23:42:54.5383259Z -            
2025-11-09T23:42:54.5383547Z +
2025-11-09T23:42:54.5383873Z              let heartbeat_request = RequestMessage {
2025-11-09T23:42:54.5384760Z                  correlation_id: 0,
2025-11-09T23:42:54.5385252Z                  request_type: MessageType::GetChainTip,
2025-11-09T23:42:54.5386100Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:238:
2025-11-09T23:42:54.5388915Z                  payload: RequestPayload::GetChainTip,
2025-11-09T23:42:54.5389344Z              };
2025-11-09T23:42:54.5389647Z -            
2025-11-09T23:42:54.5389927Z +
2025-11-09T23:42:54.5390354Z              // Use tokio::runtime::Handle to run async code in sync context
2025-11-09T23:42:54.5391130Z              // This is a simplified check - in production would use proper async context
2025-11-09T23:42:54.5391836Z              match tokio::runtime::Handle::try_current() {
2025-11-09T23:42:54.5392716Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/process/monitor.rs:244:
2025-11-09T23:42:54.5393552Z                  Ok(handle) => {
2025-11-09T23:42:54.5394009Z                      let result = handle.block_on(timeout(
2025-11-09T23:42:54.5394722Z                          Duration::from_secs(1),
2025-11-09T23:42:54.5395222Z -                        client.request(heartbeat_request)
2025-11-09T23:42:54.5395756Z +                        client.request(heartbeat_request),
2025-11-09T23:42:54.5398163Z                      ));
2025-11-09T23:42:54.5398485Z -                    
2025-11-09T23:42:54.5398788Z +
2025-11-09T23:42:54.5399065Z                      match result {
2025-11-09T23:42:54.5399507Z                          Ok(Ok(_)) => ModuleHealth::Healthy,
2025-11-09T23:42:54.5400014Z                          _ => ModuleHealth::Unresponsive,
2025-11-09T23:42:54.5442302Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/sandbox/process.rs:99:
2025-11-09T23:42:54.5443313Z                  if let Some(max_memory) = limits.max_memory_bytes {
2025-11-09T23:42:54.5443891Z                      let soft_limit = max_memory as u64;
2025-11-09T23:42:54.5444613Z                      let hard_limit = max_memory as u64;
2025-11-09T23:42:54.5445222Z -                    setrlimit(Resource::RLIMIT_AS, soft_limit, hard_limit)
2025-11-09T23:42:54.5446204Z -                        .map_err(|e| {
2025-11-09T23:42:54.5446716Z -                            ModuleError::OperationError(format!(
2025-11-09T23:42:54.5447269Z -                                "Failed to set memory limit: {}",
2025-11-09T23:42:54.5447738Z -                                e
2025-11-09T23:42:54.5448126Z -                            ))
2025-11-09T23:42:54.5448503Z -                        })?;
2025-11-09T23:42:54.5449092Z +                    setrlimit(Resource::RLIMIT_AS, soft_limit, hard_limit).map_err(|e| {
2025-11-09T23:42:54.5449974Z +                        ModuleError::OperationError(format!("Failed to set memory limit: {}", e))
2025-11-09T23:42:54.5450640Z +                    })?;
2025-11-09T23:42:54.5451063Z                      debug!("Set memory limit: {} bytes", max_memory);
2025-11-09T23:42:54.5451526Z                  }
2025-11-09T23:42:54.5451809Z  
2025-11-09T23:42:54.5452482Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/sandbox/process.rs:116:
2025-11-09T23:42:54.5453313Z                      #[cfg(feature = "nix")]
2025-11-09T23:42:54.5453695Z                      {
2025-11-09T23:42:54.5454093Z                          use nix::sys::resource::{setrlimit, Resource};
2025-11-09T23:42:54.5454985Z -                        setrlimit(Resource::RLIMIT_NOFILE, soft_limit, hard_limit)
2025-11-09T23:42:54.5455814Z -                            .map_err(|e| {
2025-11-09T23:42:54.5456487Z +                        setrlimit(Resource::RLIMIT_NOFILE, soft_limit, hard_limit).map_err(
2025-11-09T23:42:54.5457122Z +                            |e| {
2025-11-09T23:42:54.5457600Z                                  ModuleError::OperationError(format!(
2025-11-09T23:42:54.5458155Z                                      "Failed to set file descriptor limit: {}",
2025-11-09T23:42:54.5458665Z                                      e
2025-11-09T23:42:54.5459475Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/sandbox/process.rs:124:
2025-11-09T23:42:54.5460328Z                                  ))
2025-11-09T23:42:54.5460719Z -                            })?;
2025-11-09T23:42:54.5461093Z +                            },
2025-11-09T23:42:54.5461456Z +                        )?;
2025-11-09T23:42:54.5461800Z                      }
2025-11-09T23:42:54.5462162Z                      #[cfg(not(feature = "nix"))]
2025-11-09T23:42:54.5462592Z                      {
2025-11-09T23:42:54.5463323Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/sandbox/process.rs:139:
2025-11-09T23:42:54.5465930Z                      #[cfg(feature = "nix")]
2025-11-09T23:42:54.5466414Z                      let hard_limit = max_children as u64;
2025-11-09T23:42:54.5466904Z                      #[cfg(feature = "nix")]
2025-11-09T23:42:54.5467468Z -                    setrlimit(Resource::RLIMIT_NPROC, soft_limit, hard_limit)
2025-11-09T23:42:54.5468053Z -                        .map_err(|e| {
2025-11-09T23:42:54.5468545Z -                            ModuleError::OperationError(format!(
2025-11-09T23:42:54.5469077Z -                                "Failed to set process limit: {}",
2025-11-09T23:42:54.5469521Z -                                e
2025-11-09T23:42:54.5469887Z -                            ))
2025-11-09T23:42:54.5470245Z -                        })?;
2025-11-09T23:42:54.5470841Z +                    setrlimit(Resource::RLIMIT_NPROC, soft_limit, hard_limit).map_err(|e| {
2025-11-09T23:42:54.5471753Z +                        ModuleError::OperationError(format!("Failed to set process limit: {}", e))
2025-11-09T23:42:54.5472414Z +                    })?;
2025-11-09T23:42:54.5472852Z                      debug!("Set process limit: {}", max_children);
2025-11-09T23:42:54.5473329Z                  }
2025-11-09T23:42:54.5473635Z  
2025-11-09T23:42:54.5474499Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/sandbox/process.rs:191:
2025-11-09T23:42:54.5475465Z                          // Field 23 (index 22): rss - Resident Set Size (pages)
2025-11-09T23:42:54.5476469Z                          let utime: u64 = fields.get(13).and_then(|s| s.parse().ok()).unwrap_or(0);
2025-11-09T23:42:54.5477264Z                          let stime: u64 = fields.get(14).and_then(|s| s.parse().ok()).unwrap_or(0);
2025-11-09T23:42:54.5478082Z -                        let rss_pages: u64 = fields.get(22).and_then(|s| s.parse().ok()).unwrap_or(0);
2025-11-09T23:42:54.5478747Z +                        let rss_pages: u64 =
2025-11-09T23:42:54.5479279Z +                            fields.get(22).and_then(|s| s.parse().ok()).unwrap_or(0);
2025-11-09T23:42:54.5479784Z  
2025-11-09T23:42:54.5480127Z                          // Get page size (typically 4096 bytes on Linux)
2025-11-09T23:42:54.5480642Z                          #[cfg(feature = "libc")]
2025-11-09T23:42:54.5481966Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/module/security/validator.rs:155:
2025-11-09T23:42:54.5484748Z          let mut limiters = self.rate_limiters.lock().unwrap();
2025-11-09T23:42:54.5485286Z  
2025-11-09T23:42:54.5485623Z          // Get or create rate limiter for this module
2025-11-09T23:42:54.5486106Z -        let limiter = limiters
2025-11-09T23:42:54.5486530Z -            .entry(module_id.to_string())
2025-11-09T23:42:54.5486983Z -            .or_insert_with(|| {
2025-11-09T23:42:54.5487860Z -                RateLimiter::new(self.max_requests_per_second, self.time_window_seconds)
2025-11-09T23:42:54.5488514Z -            });
2025-11-09T23:42:54.5489031Z +        let limiter = limiters.entry(module_id.to_string()).or_insert_with(|| {
2025-11-09T23:42:54.5489868Z +            RateLimiter::new(self.max_requests_per_second, self.time_window_seconds)
2025-11-09T23:42:54.5490488Z +        });
2025-11-09T23:42:54.5490780Z  
2025-11-09T23:42:54.5491057Z          // Check rate limit
2025-11-09T23:42:54.5491716Z          if !limiter.check_rate_limit(self.max_requests_per_second, self.time_window_seconds) {
2025-11-09T23:42:54.5569494Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:104:
2025-11-09T23:42:54.5570587Z      pub fn add_address(&mut self, addr: NetworkAddress, services: u64) {
2025-11-09T23:42:54.5571254Z          // Convert NetworkAddress to SocketAddr for key
2025-11-09T23:42:54.5571806Z          let socket_addr = self.network_addr_to_socket(&addr);
2025-11-09T23:42:54.5572271Z -        
2025-11-09T23:42:54.5572535Z +
2025-11-09T23:42:54.5572860Z          match self.addresses.get_mut(&socket_addr) {
2025-11-09T23:42:54.5573328Z              Some(entry) => {
2025-11-09T23:42:54.5575861Z                  // Update existing entry
2025-11-09T23:42:54.5576684Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:116:
2025-11-09T23:42:54.5577570Z                  if self.addresses.len() >= self.max_addresses {
2025-11-09T23:42:54.5578179Z                      self.evict_oldest();
2025-11-09T23:42:54.5578630Z                  }
2025-11-09T23:42:54.5579194Z -                self.addresses.insert(socket_addr, AddressEntry::new(addr, services));
2025-11-09T23:42:54.5579882Z +                self.addresses
2025-11-09T23:42:54.5580401Z +                    .insert(socket_addr, AddressEntry::new(addr, services));
2025-11-09T23:42:54.5580914Z              }
2025-11-09T23:42:54.5581176Z          }
2025-11-09T23:42:54.5581429Z      }
2025-11-09T23:42:54.5582023Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:136:
2025-11-09T23:42:54.5582850Z              .filter(|entry| entry.is_fresh(self.expiration_seconds))
2025-11-09T23:42:54.5583400Z              .map(|entry| entry.addr.clone())
2025-11-09T23:42:54.5583851Z              .collect();
2025-11-09T23:42:54.5584189Z -        
2025-11-09T23:42:54.5586557Z +
2025-11-09T23:42:54.5586871Z          // Sort by last_seen (most recent first)
2025-11-09T23:42:54.5587348Z          fresh.sort_by_key(|addr| {
2025-11-09T23:42:54.5587848Z              let socket = self.network_addr_to_socket(addr);
2025-11-09T23:42:54.5589008Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:146:
2025-11-09T23:42:54.5589802Z                  .unwrap_or(0)
2025-11-09T23:42:54.5590142Z          });
2025-11-09T23:42:54.5590459Z          fresh.reverse();
2025-11-09T23:42:54.5590879Z -        
2025-11-09T23:42:54.5591159Z +
2025-11-09T23:42:54.5591489Z          fresh.into_iter().take(count).collect()
2025-11-09T23:42:54.5591938Z      }
2025-11-09T23:42:54.5592207Z  
2025-11-09T23:42:54.5592847Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:158:
2025-11-09T23:42:54.5593660Z      /// Remove expired addresses
2025-11-09T23:42:54.5594117Z      pub fn remove_expired(&mut self) -> usize {
2025-11-09T23:42:54.5594809Z          let before = self.addresses.len();
2025-11-09T23:42:54.5595478Z -        self.addresses.retain(|_, entry| entry.is_fresh(self.expiration_seconds));
2025-11-09T23:42:54.5598549Z +        self.addresses
2025-11-09T23:42:54.5599020Z +            .retain(|_, entry| entry.is_fresh(self.expiration_seconds));
2025-11-09T23:42:54.5599594Z          before - self.addresses.len()
2025-11-09T23:42:54.5599987Z      }
2025-11-09T23:42:54.5600238Z  
2025-11-09T23:42:54.5600885Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:196:
2025-11-09T23:42:54.5602211Z                      || ipv4.is_link_local()
2025-11-09T23:42:54.5602696Z                      || ipv4.is_broadcast()
2025-11-09T23:42:54.5603102Z              }
2025-11-09T23:42:54.5603445Z -            IpAddr::V6(ipv6) => {
2025-11-09T23:42:54.5603911Z -                ipv6.is_loopback() || ipv6.is_unspecified()
2025-11-09T23:42:54.5604587Z -            }
2025-11-09T23:42:54.5605069Z +            IpAddr::V6(ipv6) => ipv6.is_loopback() || ipv6.is_unspecified(),
2025-11-09T23:42:54.5605608Z          }
2025-11-09T23:42:54.5606503Z      }
2025-11-09T23:42:54.5606777Z  
2025-11-09T23:42:54.5607441Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:238:
2025-11-09T23:42:54.5608241Z                      ip: [0; 16],
2025-11-09T23:42:54.5608626Z                      port: 0,
2025-11-09T23:42:54.5608973Z                  };
2025-11-09T23:42:54.5609576Z -                self.iroh_addresses.insert(node_id, AddressEntry::new(placeholder_addr, services));
2025-11-09T23:42:54.5610317Z +                self.iroh_addresses
2025-11-09T23:42:54.5610879Z +                    .insert(node_id, AddressEntry::new(placeholder_addr, services));
2025-11-09T23:42:54.5611439Z              }
2025-11-09T23:42:54.5612248Z          }
2025-11-09T23:42:54.5612554Z      }
2025-11-09T23:42:54.5613212Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:252:
2025-11-09T23:42:54.5614529Z              .filter(|(_, entry)| entry.is_fresh(self.expiration_seconds))
2025-11-09T23:42:54.5615150Z              .map(|(node_id, _)| *node_id)
2025-11-09T23:42:54.5615569Z              .collect();
2025-11-09T23:42:54.5615918Z -        
2025-11-09T23:42:54.5616195Z +
2025-11-09T23:42:54.5616507Z          // Sort by last_seen (most recent first)
2025-11-09T23:42:54.5616993Z          fresh.sort_by_key(|node_id| {
2025-11-09T23:42:54.5617421Z              self.iroh_addresses
2025-11-09T23:42:54.5618193Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:261:
2025-11-09T23:42:54.5618988Z                  .unwrap_or(0)
2025-11-09T23:42:54.5619345Z          });
2025-11-09T23:42:54.5636520Z          fresh.reverse();
2025-11-09T23:42:54.5636964Z -        
2025-11-09T23:42:54.5637246Z +
2025-11-09T23:42:54.5637580Z          fresh.into_iter().take(count).collect()
2025-11-09T23:42:54.5638027Z      }
2025-11-09T23:42:54.5638300Z  
2025-11-09T23:42:54.5638971Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:319:
2025-11-09T23:42:54.5639786Z      }
2025-11-09T23:42:54.5640064Z  
2025-11-09T23:42:54.5640365Z      /// Convert NetworkAddress to SocketAddr
2025-11-09T23:42:54.5641041Z -    /// 
2025-11-09T23:42:54.5641317Z +    ///
2025-11-09T23:42:54.5641790Z      /// Note: This is public for use in NetworkManager when connecting to peers.
2025-11-09T23:42:54.5642608Z      pub fn network_addr_to_socket(&self, addr: &NetworkAddress) -> SocketAddr {
2025-11-09T23:42:54.5643291Z          // Convert IPv6 address bytes to SocketAddr
2025-11-09T23:42:54.5644065Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:327:
2025-11-09T23:42:54.5645189Z          let ip = if addr.ip[0..12] == [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0xff, 0xff] {
2025-11-09T23:42:54.5645773Z              // IPv4-mapped IPv6 address
2025-11-09T23:42:54.5646269Z              IpAddr::V4(std::net::Ipv4Addr::new(
2025-11-09T23:42:54.5646805Z -                addr.ip[12], addr.ip[13], addr.ip[14], addr.ip[15],
2025-11-09T23:42:54.5647284Z +                addr.ip[12],
2025-11-09T23:42:54.5647646Z +                addr.ip[13],
2025-11-09T23:42:54.5648024Z +                addr.ip[14],
2025-11-09T23:42:54.5648411Z +                addr.ip[15],
2025-11-09T23:42:54.5648766Z              ))
2025-11-09T23:42:54.5649079Z          } else {
2025-11-09T23:42:54.5649382Z              // Native IPv6
2025-11-09T23:42:54.5650121Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:342:
2025-11-09T23:42:54.5651232Z                  u16::from_be_bytes([addr.ip[14], addr.ip[15]]),
2025-11-09T23:42:54.5651722Z              ];
2025-11-09T23:42:54.5652089Z              IpAddr::V6(std::net::Ipv6Addr::new(
2025-11-09T23:42:54.5652586Z -                segments[0], segments[1], segments[2], segments[3],
2025-11-09T23:42:54.5653184Z -                segments[4], segments[5], segments[6], segments[7],
2025-11-09T23:42:54.5653666Z +                segments[0],
2025-11-09T23:42:54.5654020Z +                segments[1],
2025-11-09T23:42:54.5654558Z +                segments[2],
2025-11-09T23:42:54.5654911Z +                segments[3],
2025-11-09T23:42:54.5655275Z +                segments[4],
2025-11-09T23:42:54.5655655Z +                segments[5],
2025-11-09T23:42:54.5656018Z +                segments[6],
2025-11-09T23:42:54.5656367Z +                segments[7],
2025-11-09T23:42:54.5656698Z              ))
2025-11-09T23:42:54.5656981Z          };
2025-11-09T23:42:54.5657320Z          SocketAddr::new(ip, addr.port)
2025-11-09T23:42:54.5658142Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:406:
2025-11-09T23:42:54.5659027Z          let addr2 = create_test_address("192.168.1.2", 8333);
2025-11-09T23:42:54.5659558Z          db.add_address(addr1.clone(), 1);
2025-11-09T23:42:54.5660022Z          db.add_address(addr2.clone(), 1);
2025-11-09T23:42:54.5660442Z -        
2025-11-09T23:42:54.5661539Z +
2025-11-09T23:42:54.5661882Z          let fresh = db.get_fresh_addresses(10);
2025-11-09T23:42:54.5662376Z          assert_eq!(fresh.len(), 2);
2025-11-09T23:42:54.5662781Z      }
2025-11-09T23:42:54.5663446Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:417:
2025-11-09T23:42:54.5664265Z          let addr = create_test_address("192.168.1.1", 8333);
2025-11-09T23:42:54.5664964Z          db.add_address(addr.clone(), 1);
2025-11-09T23:42:54.5665397Z          assert_eq!(db.len(), 1);
2025-11-09T23:42:54.5665756Z -        
2025-11-09T23:42:54.5666041Z +
2025-11-09T23:42:54.5666332Z          // Wait for expiration
2025-11-09T23:42:54.5666822Z          std::thread::sleep(std::time::Duration::from_secs(2));
2025-11-09T23:42:54.5667300Z -        
2025-11-09T23:42:54.5667558Z +
2025-11-09T23:42:54.5667878Z          let fresh = db.get_fresh_addresses(10);
2025-11-09T23:42:54.5668400Z          assert_eq!(fresh.len(), 0); // Should be expired
2025-11-09T23:42:54.5668872Z      }
2025-11-09T23:42:54.5669526Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:433:
2025-11-09T23:42:54.5670350Z          db.add_address(addr1.clone(), 1);
2025-11-09T23:42:54.5671101Z          db.add_address(addr2.clone(), 1);
2025-11-09T23:42:54.5671544Z          assert_eq!(db.len(), 2);
2025-11-09T23:42:54.5671930Z -        
2025-11-09T23:42:54.5672201Z +
2025-11-09T23:42:54.5672484Z          // Wait for expiration
2025-11-09T23:42:54.5672974Z          std::thread::sleep(std::time::Duration::from_secs(2));
2025-11-09T23:42:54.5673486Z -        
2025-11-09T23:42:54.5673757Z +
2025-11-09T23:42:54.5674067Z          let removed = db.remove_expired();
2025-11-09T23:42:54.5674719Z          assert_eq!(removed, 2);
2025-11-09T23:42:54.5675132Z          assert_eq!(db.len(), 0);
2025-11-09T23:42:54.5675898Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:448:
2025-11-09T23:42:54.5676781Z          let localhost = create_test_address("127.0.0.1", 8333);
2025-11-09T23:42:54.5677391Z          let private = create_test_address("192.168.1.1", 8333);
2025-11-09T23:42:54.5677959Z          let public = create_test_address("8.8.8.8", 8333);
2025-11-09T23:42:54.5678454Z -        
2025-11-09T23:42:54.5678804Z +
2025-11-09T23:42:54.5679111Z          assert!(db.is_local(&localhost));
2025-11-09T23:42:54.5679574Z          assert!(db.is_local(&private));
2025-11-09T23:42:54.5680979Z          assert!(!db.is_local(&public));
2025-11-09T23:42:54.5682056Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:460:
2025-11-09T23:42:54.5682951Z          let addr = create_test_address("192.168.1.1", 8333);
2025-11-09T23:42:54.5683618Z          let socket = SocketAddr::new("192.168.1.1".parse().unwrap(), 8333);
2025-11-09T23:42:54.5684229Z          let mut ban_list = HashMap::new();
2025-11-09T23:42:54.5684847Z -        
2025-11-09T23:42:54.5685129Z +
2025-11-09T23:42:54.5685411Z          // Not banned
2025-11-09T23:42:54.5685791Z          assert!(!db.is_banned(&addr, &ban_list));
2025-11-09T23:42:54.5686243Z -        
2025-11-09T23:42:54.5686515Z +
2025-11-09T23:42:54.5686796Z          // Banned (permanent)
2025-11-09T23:42:54.5687252Z          ban_list.insert(socket, u64::MAX);
2025-11-09T23:42:54.5687727Z          assert!(db.is_banned(&addr, &ban_list));
2025-11-09T23:42:54.5688556Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:470:
2025-11-09T23:42:54.5689330Z -        
2025-11-09T23:42:54.5689615Z +
2025-11-09T23:42:54.5689910Z          // Banned (temporary, not expired)
2025-11-09T23:42:54.5690775Z          ban_list.clear();
2025-11-09T23:42:54.5691201Z          let future_time = std::time::SystemTime::now()
2025-11-09T23:42:54.5691993Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:474:
2025-11-09T23:42:54.5693282Z              .duration_since(std::time::UNIX_EPOCH)
2025-11-09T23:42:54.5693930Z              .unwrap()
2025-11-09T23:42:54.5694266Z -            .as_secs() + 3600;
2025-11-09T23:42:54.5698346Z +            .as_secs()
2025-11-09T23:42:54.5698699Z +            + 3600;
2025-11-09T23:42:54.5699278Z          ban_list.insert(socket, future_time);
2025-11-09T23:42:54.5699826Z          assert!(db.is_banned(&addr, &ban_list));
2025-11-09T23:42:54.5700286Z -        
2025-11-09T23:42:54.5700562Z +
2025-11-09T23:42:54.5700849Z          // Banned (expired)
2025-11-09T23:42:54.5701218Z          ban_list.clear();
2025-11-09T23:42:54.5701669Z          let past_time = std::time::SystemTime::now()
2025-11-09T23:42:54.5702537Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:483:
2025-11-09T23:42:54.5703398Z              .duration_since(std::time::UNIX_EPOCH)
2025-11-09T23:42:54.5703853Z              .unwrap()
2025-11-09T23:42:54.5704201Z -            .as_secs() - 3600;
2025-11-09T23:42:54.5704736Z +            .as_secs()
2025-11-09T23:42:54.5705067Z +            - 3600;
2025-11-09T23:42:54.5705445Z          ban_list.insert(socket, past_time);
2025-11-09T23:42:54.5705929Z          assert!(!db.is_banned(&addr, &ban_list));
2025-11-09T23:42:54.5706385Z      }
2025-11-09T23:42:54.5707296Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:493:
2025-11-09T23:42:54.5708187Z          let local = create_test_address("127.0.0.1", 8333);
2025-11-09T23:42:54.5708746Z          let banned = create_test_address("192.168.1.1", 8333);
2025-11-09T23:42:54.5709321Z          let public = create_test_address("8.8.8.8", 8333);
2025-11-09T23:42:54.5709811Z -        
2025-11-09T23:42:54.5710082Z +
2025-11-09T23:42:54.5710573Z          let socket_banned = SocketAddr::new("192.168.1.1".parse().unwrap(), 8333);
2025-11-09T23:42:54.5711403Z          let socket_connected = SocketAddr::new("8.8.8.8".parse().unwrap(), 8333);
2025-11-09T23:42:54.5712070Z          let mut ban_list = HashMap::new();
2025-11-09T23:42:54.5712884Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:500:
2025-11-09T23:42:54.5713960Z          ban_list.insert(socket_banned, u64::MAX);
2025-11-09T23:42:54.5714755Z          let connected_peers = vec![socket_connected];
2025-11-09T23:42:54.5715254Z -        
2025-11-09T23:42:54.5715539Z +
2025-11-09T23:42:54.5715879Z          let addresses = vec![local, banned, public];
2025-11-09T23:42:54.5716574Z          let filtered = db.filter_addresses(addresses, &ban_list, &connected_peers);
2025-11-09T23:42:54.5717198Z -        
2025-11-09T23:42:54.5717470Z +
2025-11-09T23:42:54.5718052Z          // Should filter out local, banned, and connected
2025-11-09T23:42:54.5718581Z          assert_eq!(filtered.len(), 0);
2025-11-09T23:42:54.5718976Z      }
2025-11-09T23:42:54.5719636Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:513:
2025-11-09T23:42:54.5720497Z          let addr1 = create_test_address("192.168.1.1", 8333);
2025-11-09T23:42:54.5721070Z          let addr2 = create_test_address("192.168.1.2", 8333);
2025-11-09T23:42:54.5721626Z          let addr3 = create_test_address("192.168.1.3", 8333);
2025-11-09T23:42:54.5722100Z -        
2025-11-09T23:42:54.5722394Z +
2025-11-09T23:42:54.5722703Z          db.add_address(addr1.clone(), 1);
2025-11-09T23:42:54.5723170Z          db.add_address(addr2.clone(), 1);
2025-11-09T23:42:54.5723620Z          assert_eq!(db.len(), 2);
2025-11-09T23:42:54.5724669Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:520:
2025-11-09T23:42:54.5727879Z -        
2025-11-09T23:42:54.5728189Z +
2025-11-09T23:42:54.5728495Z          // Adding third should evict oldest
2025-11-09T23:42:54.5728982Z          db.add_address(addr3.clone(), 1);
2025-11-09T23:42:54.5729477Z          assert_eq!(db.len(), 2); // Should still be 2
2025-11-09T23:42:54.5730330Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:528:
2025-11-09T23:42:54.5731145Z      fn test_add_iroh_address() {
2025-11-09T23:42:54.5731593Z          use iroh_net::NodeId;
2025-11-09T23:42:54.5732033Z          let mut db = AddressDatabase::new(100);
2025-11-09T23:42:54.5732473Z -        
2025-11-09T23:42:54.5732767Z +
2025-11-09T23:42:54.5733063Z          // Create a test NodeId (32 bytes)
2025-11-09T23:42:54.5733515Z          let node_id_bytes = [0u8; 32];
2025-11-09T23:42:54.5734048Z          let node_id = NodeId::from_bytes(&node_id_bytes).unwrap();
2025-11-09T23:42:54.5735209Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:535:
2025-11-09T23:42:54.5736006Z -        
2025-11-09T23:42:54.5736291Z +
2025-11-09T23:42:54.5736589Z          db.add_iroh_address(node_id, 1);
2025-11-09T23:42:54.5737042Z          assert_eq!(db.total_count(), 1);
2025-11-09T23:42:54.5737460Z -        
2025-11-09T23:42:54.5737720Z +
2025-11-09T23:42:54.5738107Z          // Add same address again (should update, not duplicate)
2025-11-09T23:42:54.5738666Z          db.add_iroh_address(node_id, 2);
2025-11-09T23:42:54.5739122Z          assert_eq!(db.total_count(), 1);
2025-11-09T23:42:54.5739897Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:546:
2025-11-09T23:42:54.5740917Z      fn test_get_fresh_iroh_addresses() {
2025-11-09T23:42:54.5741349Z          use iroh_net::NodeId;
2025-11-09T23:42:54.5741743Z          let mut db = AddressDatabase::new(100);
2025-11-09T23:42:54.5742153Z -        
2025-11-09T23:42:54.5742399Z +
2025-11-09T23:42:54.5742671Z          let node_id1_bytes = [1u8; 32];
2025-11-09T23:42:54.5743097Z          let node_id2_bytes = [2u8; 32];
2025-11-09T23:42:54.5743633Z          let node_id1 = NodeId::from_bytes(&node_id1_bytes).unwrap();
2025-11-09T23:42:54.5744661Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:553:
2025-11-09T23:42:54.5745547Z          let node_id2 = NodeId::from_bytes(&node_id2_bytes).unwrap();
2025-11-09T23:42:54.5746506Z -        
2025-11-09T23:42:54.5746784Z +
2025-11-09T23:42:54.5747068Z          db.add_iroh_address(node_id1, 1);
2025-11-09T23:42:54.5747505Z          db.add_iroh_address(node_id2, 1);
2025-11-09T23:42:54.5747913Z -        
2025-11-09T23:42:54.5748196Z +
2025-11-09T23:42:54.5749371Z          let fresh = db.get_fresh_iroh_addresses(10);
2025-11-09T23:42:54.5749865Z          assert_eq!(fresh.len(), 2);
2025-11-09T23:42:54.5750262Z      }
2025-11-09T23:42:54.5750917Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:564:
2025-11-09T23:42:54.5752049Z      fn test_total_count_includes_iroh() {
2025-11-09T23:42:54.5752801Z          use iroh_net::NodeId;
2025-11-09T23:42:54.5753250Z          let mut db = AddressDatabase::new(100);
2025-11-09T23:42:54.5753688Z -        
2025-11-09T23:42:54.5753961Z +
2025-11-09T23:42:54.5754247Z          // Add SocketAddr address
2025-11-09T23:42:54.5754849Z          let addr = create_test_address("192.168.1.1", 8333);
2025-11-09T23:42:54.5754993Z          db.add_address(addr, 1);
2025-11-09T23:42:54.5755461Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/address_db.rs:571:
2025-11-09T23:42:54.5755610Z          assert_eq!(db.total_count(), 1);
2025-11-09T23:42:54.5756168Z -        
2025-11-09T23:42:54.5756281Z +
2025-11-09T23:42:54.5756405Z          // Add Iroh address
2025-11-09T23:42:54.5756538Z          let node_id_bytes = [0u8; 32];
2025-11-09T23:42:54.5760240Z          let node_id = NodeId::from_bytes(&node_id_bytes).unwrap();
2025-11-09T23:42:54.5760806Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:15:
2025-11-09T23:42:54.5760978Z  /// - Combine reasons from all sources
2025-11-09T23:42:54.5761321Z  pub fn merge_ban_lists(ban_lists: Vec<&BanListMessage>) -> Vec<BanEntry> {
2025-11-09T23:42:54.5761657Z      let mut merged: HashMap<NetworkAddress, BanEntry> = HashMap::new();
2025-11-09T23:42:54.5761773Z -    
2025-11-09T23:42:54.5761886Z +
2025-11-09T23:42:54.5762056Z      for ban_list in ban_lists {
2025-11-09T23:42:54.5762195Z          if !ban_list.is_full {
2025-11-09T23:42:54.5762380Z              continue; // Skip hash-only responses
2025-11-09T23:42:54.5762925Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:22:
2025-11-09T23:42:54.5763046Z          }
2025-11-09T23:42:54.5763154Z -        
2025-11-09T23:42:54.5763261Z +
2025-11-09T23:42:54.5763429Z          for entry in &ban_list.ban_entries {
2025-11-09T23:42:54.5763587Z              let addr = entry.addr.clone();
2025-11-09T23:42:54.5763705Z -            
2025-11-09T23:42:54.5763828Z +
2025-11-09T23:42:54.5763979Z              match merged.get_mut(&addr) {
2025-11-09T23:42:54.5764114Z                  Some(existing) => {
2025-11-09T23:42:54.5764478Z                      // Conflict resolution: use longest ban
2025-11-09T23:42:54.5765032Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:36:
2025-11-09T23:42:54.5765272Z                              existing.unban_timestamp = entry.unban_timestamp;
2025-11-09T23:42:54.5765393Z                          }
2025-11-09T23:42:54.5765512Z                      }
2025-11-09T23:42:54.5765889Z -                    
2025-11-09T23:42:54.5766002Z +
2025-11-09T23:42:54.5766153Z                      // Merge reasons
2025-11-09T23:42:54.5766342Z                      if let Some(ref reason) = entry.reason {
2025-11-09T23:42:54.5766593Z -                        existing.reason = existing.reason.as_ref().map(|r| {
2025-11-09T23:42:54.5766760Z -                            format!("{}; {}", r, reason)
2025-11-09T23:42:54.5766942Z -                        }).or_else(|| Some(reason.clone()));
2025-11-09T23:42:54.5767103Z +                        existing.reason = existing
2025-11-09T23:42:54.5767229Z +                            .reason
2025-11-09T23:42:54.5767372Z +                            .as_ref()
2025-11-09T23:42:54.5767549Z +                            .map(|r| format!("{}; {}", r, reason))
2025-11-09T23:42:54.5767721Z +                            .or_else(|| Some(reason.clone()));
2025-11-09T23:42:54.5767851Z                      }
2025-11-09T23:42:54.5767967Z                  }
2025-11-09T23:42:54.5768103Z                  None => {
2025-11-09T23:42:54.5768650Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:50:
2025-11-09T23:42:54.5768778Z              }
2025-11-09T23:42:54.5768888Z          }
2025-11-09T23:42:54.5769001Z      }
2025-11-09T23:42:54.5769118Z -    
2025-11-09T23:42:54.5769232Z +
2025-11-09T23:42:54.5769615Z      // Convert to sorted vector
2025-11-09T23:42:54.5769892Z      let mut result: Vec<BanEntry> = merged.into_values().collect();
2025-11-09T23:42:54.5770024Z      result.sort_by(|a, b| {
2025-11-09T23:42:54.5770516Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:57:
2025-11-09T23:42:54.5770708Z          // Sort by address for deterministic output
2025-11-09T23:42:54.5770863Z -        a.addr.ip.cmp(&b.addr.ip)
2025-11-09T23:42:54.5770978Z +        a.addr
2025-11-09T23:42:54.5771092Z +            .ip
2025-11-09T23:42:54.5771226Z +            .cmp(&b.addr.ip)
2025-11-09T23:42:54.5771443Z              .then_with(|| a.addr.port.cmp(&b.addr.port))
2025-11-09T23:42:54.5771562Z      });
2025-11-09T23:42:54.5771676Z -    
2025-11-09T23:42:54.5771795Z +
2025-11-09T23:42:54.5771913Z      result
2025-11-09T23:42:54.5772021Z  }
2025-11-09T23:42:54.5772131Z  
2025-11-09T23:42:54.5772689Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:72:
2025-11-09T23:42:54.5772845Z              .duration_since(UNIX_EPOCH)
2025-11-09T23:42:54.5772972Z              .unwrap()
2025-11-09T23:42:54.5773109Z              .as_secs();
2025-11-09T23:42:54.5773223Z -        
2025-11-09T23:42:54.5773332Z +
2025-11-09T23:42:54.5773489Z          if now >= entry.unban_timestamp {
2025-11-09T23:42:54.5773672Z              return false; // Ban already expired
2025-11-09T23:42:54.5773786Z          }
2025-11-09T23:42:54.5774539Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:79:
2025-11-09T23:42:54.5774677Z      }
2025-11-09T23:42:54.5774796Z -    
2025-11-09T23:42:54.5774907Z +
2025-11-09T23:42:54.5775081Z      // Additional validation could include:
2025-11-09T23:42:54.5775250Z      // - IP address format validation
2025-11-09T23:42:54.5775391Z      // - Reason length limits
2025-11-09T23:42:54.5775917Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:84:
2025-11-09T23:42:54.5776053Z      // - etc.
2025-11-09T23:42:54.5776166Z -    
2025-11-09T23:42:54.5776273Z +
2025-11-09T23:42:54.5776383Z      true
2025-11-09T23:42:54.5776499Z  }
2025-11-09T23:42:54.5776605Z  
2025-11-09T23:42:54.5777123Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:89:
2025-11-09T23:42:54.5777319Z  /// Calculate hash of ban list (for verification)
2025-11-09T23:42:54.5777605Z  pub fn calculate_ban_list_hash(entries: &[BanEntry]) -> [u8; 32] {
2025-11-09T23:42:54.5777753Z -    use sha2::{Sha256, Digest};
2025-11-09T23:42:54.5777864Z -    
2025-11-09T23:42:54.5778272Z +    use sha2::{Digest, Sha256};
2025-11-09T23:42:54.5778387Z +
2025-11-09T23:42:54.5778567Z      // Sort entries for deterministic hashing
2025-11-09T23:42:54.5778732Z      let mut sorted = entries.to_vec();
2025-11-09T23:42:54.5778873Z      sorted.sort_by(|a, b| {
2025-11-09T23:42:54.5779412Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:96:
2025-11-09T23:42:54.5779555Z -        a.addr.ip.cmp(&b.addr.ip)
2025-11-09T23:42:54.5779675Z +        a.addr
2025-11-09T23:42:54.5779792Z +            .ip
2025-11-09T23:42:54.5779926Z +            .cmp(&b.addr.ip)
2025-11-09T23:42:54.5780122Z              .then_with(|| a.addr.port.cmp(&b.addr.port))
2025-11-09T23:42:54.5780224Z      });
2025-11-09T23:42:54.5780325Z -    
2025-11-09T23:42:54.5780423Z +
2025-11-09T23:42:54.5780551Z      // Serialize and hash
2025-11-09T23:42:54.5780856Z      let serialized = bincode::serialize(&sorted).unwrap_or_default();
2025-11-09T23:42:54.5781041Z      let hash = Sha256::digest(&serialized);
2025-11-09T23:42:54.5781572Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:103:
2025-11-09T23:42:54.5781688Z -    
2025-11-09T23:42:54.5781798Z +
2025-11-09T23:42:54.5781951Z      let mut result = [0u8; 32];
2025-11-09T23:42:54.5783892Z      result.copy_from_slice(&hash);
2025-11-09T23:42:54.5784241Z      result
2025-11-09T23:42:54.5785062Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_merging.rs:111:
2025-11-09T23:42:54.5785292Z      let calculated = calculate_ban_list_hash(entries);
2025-11-09T23:42:54.5785441Z      calculated == *expected_hash
2025-11-09T23:42:54.5785552Z  }
2025-11-09T23:42:54.5785667Z -
2025-11-09T23:42:54.5785770Z -
2025-11-09T23:42:54.5785876Z -
2025-11-09T23:42:54.5785986Z  
2025-11-09T23:42:54.5786527Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_signing.rs:2:
2025-11-09T23:42:54.5786638Z  //!
2025-11-09T23:42:54.5786972Z  //! Provides functions to sign and verify ban lists for authenticity.
2025-11-09T23:42:54.5787092Z  
2025-11-09T23:42:54.5787364Z -use crate::network::protocol::{BanListMessage, BanEntry};
2025-11-09T23:42:54.5787730Z -use secp256k1::{Secp256k1, Message, ecdsa::Signature, SecretKey, PublicKey};
2025-11-09T23:42:54.5787980Z +use crate::network::protocol::{BanEntry, BanListMessage};
2025-11-09T23:42:54.5788329Z +use secp256k1::{ecdsa::Signature, Message, PublicKey, Secp256k1, SecretKey};
2025-11-09T23:42:54.5788443Z  
2025-11-09T23:42:54.5788605Z  /// Sign a ban list with a private key
2025-11-09T23:42:54.5788725Z  ///
2025-11-09T23:42:54.5789272Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_signing.rs:13:
2025-11-09T23:42:54.5789429Z      private_key: &SecretKey,
2025-11-09T23:42:54.5789615Z  ) -> Result<Vec<u8>, secp256k1::Error> {
2025-11-09T23:42:54.5789769Z      let secp = Secp256k1::new();
2025-11-09T23:42:54.5789886Z -    
2025-11-09T23:42:54.5790003Z +
2025-11-09T23:42:54.5790168Z      // Serialize ban list for signing
2025-11-09T23:42:54.5790374Z -    let serialized = bincode::serialize(ban_list)
2025-11-09T23:42:54.5790589Z -        .map_err(|_| secp256k1::Error::InvalidMessage)?;
2025-11-09T23:42:54.5790713Z -    
2025-11-09T23:42:54.5791180Z +    let serialized = bincode::serialize(ban_list).map_err(|_| secp256k1::Error::InvalidMessage)?;
2025-11-09T23:42:54.5791299Z +
2025-11-09T23:42:54.5791448Z      // Hash the serialized data
2025-11-09T23:42:54.5791605Z -    use sha2::{Sha256, Digest};
2025-11-09T23:42:54.5791745Z +    use sha2::{Digest, Sha256};
2025-11-09T23:42:54.5791919Z      let hash = Sha256::digest(&serialized);
2025-11-09T23:42:54.5792035Z -    
2025-11-09T23:42:54.5792143Z +
2025-11-09T23:42:54.5792285Z      // Create message from hash
2025-11-09T23:42:54.5792461Z -    let message = Message::from_slice(&hash)
2025-11-09T23:42:54.5792674Z -        .map_err(|_| secp256k1::Error::InvalidMessage)?;
2025-11-09T23:42:54.5793044Z -    
2025-11-09T23:42:54.5793448Z +    let message = Message::from_slice(&hash).map_err(|_| secp256k1::Error::InvalidMessage)?;
2025-11-09T23:42:54.5793573Z +
2025-11-09T23:42:54.5793693Z      // Sign
2025-11-09T23:42:54.5797080Z      let signature = secp.sign_ecdsa(&message, private_key);
2025-11-09T23:42:54.5797221Z -    
2025-11-09T23:42:54.5797332Z +
2025-11-09T23:42:54.5797479Z      // Serialize signature
2025-11-09T23:42:54.5797658Z      Ok(signature.serialize_compact().to_vec())
2025-11-09T23:42:54.5797768Z  }
2025-11-09T23:42:54.5798507Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_signing.rs:44:
2025-11-09T23:42:54.5798663Z      if signature.len() != 64 {
2025-11-09T23:42:54.5798793Z          return Ok(false);
2025-11-09T23:42:54.5802424Z      }
2025-11-09T23:42:54.5802552Z -    
2025-11-09T23:42:54.5802662Z +
2025-11-09T23:42:54.5802839Z      let secp = Secp256k1::new();
2025-11-09T23:42:54.5802953Z -    
2025-11-09T23:42:54.5803057Z +
2025-11-09T23:42:54.5803203Z      // Serialize ban list
2025-11-09T23:42:54.5803407Z -    let serialized = bincode::serialize(ban_list)
2025-11-09T23:42:54.5803613Z -        .map_err(|_| secp256k1::Error::InvalidMessage)?;
2025-11-09T23:42:54.5803717Z -    
2025-11-09T23:42:54.5804152Z +    let serialized = bincode::serialize(ban_list).map_err(|_| secp256k1::Error::InvalidMessage)?;
2025-11-09T23:42:54.5804261Z +
2025-11-09T23:42:54.5804802Z      // Hash the serialized data
2025-11-09T23:42:54.5804961Z -    use sha2::{Sha256, Digest};
2025-11-09T23:42:54.5805100Z +    use sha2::{Digest, Sha256};
2025-11-09T23:42:54.5805263Z      let hash = Sha256::digest(&serialized);
2025-11-09T23:42:54.5805368Z -    
2025-11-09T23:42:54.5805477Z +
2025-11-09T23:42:54.5805611Z      // Create message from hash
2025-11-09T23:42:54.5805780Z -    let message = Message::from_slice(&hash)
2025-11-09T23:42:54.5805980Z -        .map_err(|_| secp256k1::Error::InvalidMessage)?;
2025-11-09T23:42:54.5806092Z -    
2025-11-09T23:42:54.5806472Z +    let message = Message::from_slice(&hash).map_err(|_| secp256k1::Error::InvalidMessage)?;
2025-11-09T23:42:54.5806585Z +
2025-11-09T23:42:54.5806720Z      // Parse signature
2025-11-09T23:42:54.5806908Z -    let sig = Signature::from_compact(signature)
2025-11-09T23:42:54.5807107Z -        .map_err(|_| secp256k1::Error::InvalidSignature)?;
2025-11-09T23:42:54.5807221Z -    
2025-11-09T23:42:54.5807647Z +    let sig = Signature::from_compact(signature).map_err(|_| secp256k1::Error::InvalidSignature)?;
2025-11-09T23:42:54.5807755Z +
2025-11-09T23:42:54.5807867Z      // Verify
2025-11-09T23:42:54.5808113Z      Ok(secp.verify_ecdsa(&message, &sig, public_key).is_ok())
2025-11-09T23:42:54.5808220Z  }
2025-11-09T23:42:54.5808740Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_signing.rs:86:
2025-11-09T23:42:54.5808908Z      ) -> Result<Self, secp256k1::Error> {
2025-11-09T23:42:54.5809062Z          let secp = Secp256k1::new();
2025-11-09T23:42:54.5809342Z          let public_key = PublicKey::from_secret_key(&secp, private_key);
2025-11-09T23:42:54.5809459Z -        
2025-11-09T23:42:54.5809572Z +
2025-11-09T23:42:54.5809812Z          let signature = sign_ban_list(&ban_list, private_key)?;
2025-11-09T23:42:54.5809930Z -        
2025-11-09T23:42:54.5810046Z +
2025-11-09T23:42:54.5810166Z          Ok(Self {
2025-11-09T23:42:54.5810285Z              ban_list,
2025-11-09T23:42:54.5810416Z              signature,
2025-11-09T23:42:54.5810949Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_signing.rs:95:
2025-11-09T23:42:54.5811083Z              public_key,
2025-11-09T23:42:54.5811195Z          })
2025-11-09T23:42:54.5811313Z      }
2025-11-09T23:42:54.5811413Z -    
2025-11-09T23:42:54.5811511Z +
2025-11-09T23:42:54.5811639Z      /// Verify the signature
2025-11-09T23:42:54.5811879Z      pub fn verify(&self) -> Result<bool, secp256k1::Error> {
2025-11-09T23:42:54.5812226Z          verify_ban_list_signature(&self.ban_list, &self.signature, &self.public_key)
2025-11-09T23:42:54.5813022Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/ban_list_signing.rs:102:
2025-11-09T23:42:54.5813147Z      }
2025-11-09T23:42:54.5813260Z  }
2025-11-09T23:42:54.5813372Z -
2025-11-09T23:42:54.5813480Z -
2025-11-09T23:42:54.5813598Z  
2025-11-09T23:42:54.5814479Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:4:
2025-11-09T23:42:54.5814653Z  //! using the BlockFilterService.
2025-11-09T23:42:54.5814774Z  
2025-11-09T23:42:54.5815031Z  use crate::network::filter_service::BlockFilterService;
2025-11-09T23:42:54.5815185Z -use crate::storage::Storage;
2025-11-09T23:42:54.5815346Z  use crate::network::protocol::{
2025-11-09T23:42:54.5817669Z      CfcheckptMessage, CfheadersMessage, CfilterMessage, FilterHeaderData, GetCfcheckptMessage,
2025-11-09T23:42:54.5817963Z      GetCfheadersMessage, GetCfiltersMessage, ProtocolMessage,
2025-11-09T23:42:54.5818493Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:11:
2025-11-09T23:42:54.5818631Z  };
2025-11-09T23:42:54.5818790Z +use crate::storage::Storage;
2025-11-09T23:42:54.5818938Z  use anyhow::{anyhow, Result};
2025-11-09T23:42:54.5819102Z  use bllvm_protocol::Hash;
2025-11-09T23:42:54.5819237Z  use std::sync::Arc;
2025-11-09T23:42:54.5819987Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:30:
2025-11-09T23:42:54.5820216Z          // Get current height to determine stop height
2025-11-09T23:42:54.5820546Z          let current_height = storage.chain().get_height()?.unwrap_or(0) as u32;
2025-11-09T23:42:54.5820727Z          let start_height = request.start_height;
2025-11-09T23:42:54.5820846Z -        
2025-11-09T23:42:54.5820962Z +
2025-11-09T23:42:54.5821257Z          // Find stop height by iterating from start until we find stop_hash
2025-11-09T23:42:54.5821421Z          let mut stop_height = start_height;
2025-11-09T23:42:54.5821578Z          let mut found_stop = false;
2025-11-09T23:42:54.5822103Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:37:
2025-11-09T23:42:54.5822219Z -        
2025-11-09T23:42:54.5822330Z +
2025-11-09T23:42:54.5822522Z          // Iterate through blocks from start_height
2025-11-09T23:42:54.5822848Z          for height in start_height..=current_height.min(start_height + 2000) {
2025-11-09T23:42:54.5823029Z              // Get block hash by height, then get block
2025-11-09T23:42:54.5823553Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:41:
2025-11-09T23:42:54.5823913Z              if let Ok(Some(block_hash)) = storage.blocks().get_hash_by_height(height as u64) {
2025-11-09T23:42:54.5824184Z                  if let Ok(Some(block)) = storage.blocks().get_block(&block_hash) {
2025-11-09T23:42:54.5824651Z -                
2025-11-09T23:42:54.5824852Z                      // Calculate block hash properly
2025-11-09T23:42:54.5825083Z                      use crate::storage::hashing::double_sha256;
2025-11-09T23:42:54.5827096Z                      let mut header_data = Vec::new();
2025-11-09T23:42:54.5827611Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:51:
2025-11-09T23:42:54.5827910Z                      header_data.extend_from_slice(&block.header.bits.to_le_bytes());
2025-11-09T23:42:54.5828232Z                      header_data.extend_from_slice(&block.header.nonce.to_le_bytes());
2025-11-09T23:42:54.5828464Z                      let calculated_hash = double_sha256(&header_data);
2025-11-09T23:42:54.5828587Z -                    
2025-11-09T23:42:54.5828702Z +
2025-11-09T23:42:54.5828880Z                      // Check if this is the stop hash
2025-11-09T23:42:54.5829583Z                      if calculated_hash == request.stop_hash {
2025-11-09T23:42:54.5829750Z                          found_stop = true;
2025-11-09T23:42:54.5830284Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:58:
2025-11-09T23:42:54.5830718Z                          stop_height = height;
2025-11-09T23:42:54.5830843Z                      }
2025-11-09T23:42:54.5830956Z -                    
2025-11-09T23:42:54.5831074Z +
2025-11-09T23:42:54.5831235Z                      // Try to get cached filter
2025-11-09T23:42:54.5831603Z                      let filter = if let Some(cached) = filter_service.get_filter(&calculated_hash) {
2025-11-09T23:42:54.5831740Z                          cached
2025-11-09T23:42:54.5832252Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:72:
2025-11-09T23:42:54.5832385Z                                  }
2025-11-09T23:42:54.5832510Z                              }
2025-11-09T23:42:54.5832638Z                          }
2025-11-09T23:42:54.5832753Z -                        
2025-11-09T23:42:54.5832861Z +
2025-11-09T23:42:54.5833241Z                          filter_service.generate_and_cache_filter(&block, &prev_scripts, height)?
2025-11-09T23:42:54.5833374Z                      };
2025-11-09T23:42:54.5833486Z -                    
2025-11-09T23:42:54.5833595Z +
2025-11-09T23:42:54.5833912Z                      responses.push(ProtocolMessage::Cfilter(CfilterMessage {
2025-11-09T23:42:54.5834065Z                          filter_type: 0,
2025-11-09T23:42:54.5834727Z                          block_hash: calculated_hash,
2025-11-09T23:42:54.5835312Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:82:
2025-11-09T23:42:54.5835501Z                          filter_data: filter.filter_data,
2025-11-09T23:42:54.5835670Z                          num_elements: filter.num_elements,
2025-11-09T23:42:54.5835794Z                      }));
2025-11-09T23:42:54.5835905Z -                    
2025-11-09T23:42:54.5836010Z +
2025-11-09T23:42:54.5836142Z                      if found_stop {
2025-11-09T23:42:54.5836265Z                          break;
2025-11-09T23:42:54.5836386Z                      }
2025-11-09T23:42:54.5836894Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip157_handler.rs:89:
2025-11-09T23:42:54.5837021Z                  }
2025-11-09T23:42:54.5837133Z              }
2025-11-09T23:42:54.5837240Z          }
2025-11-09T23:42:54.5837349Z -        
2025-11-09T23:42:54.5837468Z +
2025-11-09T23:42:54.5837714Z          if !found_stop && stop_height < current_height {
2025-11-09T23:42:54.5837986Z              // Stop hash not found in reasonable range, return what we have
2025-11-09T23:42:54.5838095Z          }
2025-11-09T23:42:54.5838598Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip70_handler.rs:3:
2025-11-09T23:42:54.5838852Z  //! Handles incoming BIP70 messages from the P2P network.
2025-11-09T23:42:54.5839019Z  //! Similar to bip157_handler.rs pattern.
2025-11-09T23:42:54.5839127Z  
2025-11-09T23:42:54.5839714Z -use bllvm_protocol::payment::{Bip70Error, PaymentProtocolClient, PaymentProtocolServer, PaymentRequest};
2025-11-09T23:42:54.5839888Z  use crate::network::protocol::{
2025-11-09T23:42:54.5840350Z      GetPaymentRequestMessage, PaymentACKMessage, PaymentMessage, PaymentRequestMessage,
2025-11-09T23:42:54.5840497Z      ProtocolMessage,
2025-11-09T23:42:54.5841023Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip70_handler.rs:10:
2025-11-09T23:42:54.5841148Z  };
2025-11-09T23:42:54.5841289Z  use anyhow::Result;
2025-11-09T23:42:54.5841452Z +use bllvm_protocol::payment::{
2025-11-09T23:42:54.5841842Z +    Bip70Error, PaymentProtocolClient, PaymentProtocolServer, PaymentRequest,
2025-11-09T23:42:54.5841954Z +};
2025-11-09T23:42:54.5842076Z +use hex;
2025-11-09T23:42:54.5842230Z  use std::collections::HashMap;
2025-11-09T23:42:54.5842374Z  use std::sync::{Arc, Mutex};
2025-11-09T23:42:54.5842488Z -use hex;
2025-11-09T23:42:54.5842606Z  
2025-11-09T23:42:54.5843055Z  /// In-memory payment request store (simplified - would use persistent storage in production)
2025-11-09T23:42:54.5843667Z  type PaymentRequestStore = Arc<Mutex<HashMap<String, PaymentRequest>>>;
2025-11-09T23:42:54.5844201Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip70_handler.rs:25:
2025-11-09T23:42:54.5844540Z  ) -> Result<PaymentRequestMessage> {
2025-11-09T23:42:54.5844706Z      if let Some(store) = payment_store {
2025-11-09T23:42:54.5844881Z          let store = store.lock().unwrap();
2025-11-09T23:42:54.5845330Z -        let key = format!("{}_{}", hex::encode(&request.payment_id), hex::encode(&request.merchant_pubkey));
2025-11-09T23:42:54.5845470Z +        let key = format!(
2025-11-09T23:42:54.5845589Z +            "{}_{}",
2025-11-09T23:42:54.5845779Z +            hex::encode(&request.payment_id),
2025-11-09T23:42:54.5845962Z +            hex::encode(&request.merchant_pubkey)
2025-11-09T23:42:54.5846081Z +        );
2025-11-09T23:42:54.5846465Z          if let Some(payment_request) = store.get(&key) {
2025-11-09T23:42:54.5846702Z              // Convert to P2P message format
2025-11-09T23:42:54.5847246Z              // Note: In production, merchant_signature would be generated by signing payment_request
2025-11-09T23:42:54.5848464Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip70_handler.rs:37:
2025-11-09T23:42:54.5848844Z              });
2025-11-09T23:42:54.5861336Z          }
2025-11-09T23:42:54.5861734Z      }
2025-11-09T23:42:54.5861859Z -    
2025-11-09T23:42:54.5861968Z +
2025-11-09T23:42:54.5862209Z      Err(anyhow::anyhow!("Payment request not found"))
2025-11-09T23:42:54.5862322Z  }
2025-11-09T23:42:54.5862440Z  
2025-11-09T23:42:54.5862959Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip70_handler.rs:58:
2025-11-09T23:42:54.5863070Z      } else {
2025-11-09T23:42:54.5863191Z          None
2025-11-09T23:42:54.5863303Z      };
2025-11-09T23:42:54.5863418Z -    
2025-11-09T23:42:54.5863526Z +
2025-11-09T23:42:54.5863714Z      if let Some(request) = original_request {
2025-11-09T23:42:54.5863896Z          // Use existing process_payment function
2025-11-09T23:42:54.5864135Z          use bllvm_protocol::payment::PaymentProtocolServer;
2025-11-09T23:42:54.5864838Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip70_handler.rs:65:
2025-11-09T23:42:54.5865464Z -        let payment_ack = PaymentProtocolServer::process_payment(&payment_msg.payment, &request, merchant_private_key)
2025-11-09T23:42:54.5865791Z -            .map_err(|e| anyhow::anyhow!("Payment processing failed: {:?}", e))?;
2025-11-09T23:42:54.5865919Z -        
2025-11-09T23:42:54.5866203Z +        let payment_ack = PaymentProtocolServer::process_payment(
2025-11-09T23:42:54.5866356Z +            &payment_msg.payment,
2025-11-09T23:42:54.5866481Z +            &request,
2025-11-09T23:42:54.5866638Z +            merchant_private_key,
2025-11-09T23:42:54.5866755Z +        )
2025-11-09T23:42:54.5867059Z +        .map_err(|e| anyhow::anyhow!("Payment processing failed: {:?}", e))?;
2025-11-09T23:42:54.5867202Z +
2025-11-09T23:42:54.5867370Z          // Convert to P2P message format
2025-11-09T23:42:54.5867518Z          Ok(PaymentACKMessage {
2025-11-09T23:42:54.5867663Z              payment_ack,
2025-11-09T23:42:54.5868195Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip70_handler.rs:79:
2025-11-09T23:42:54.5868425Z  /// Validate PaymentRequest message from P2P network
2025-11-09T23:42:54.5868882Z  pub fn validate_payment_request_message(msg: &PaymentRequestMessage) -> Result<(), Bip70Error> {
2025-11-09T23:42:54.5869143Z      use bllvm_protocol::payment::PaymentProtocolClient;
2025-11-09T23:42:54.5869676Z -    PaymentProtocolClient::validate_payment_request(&msg.payment_request, Some(&msg.merchant_pubkey))
2025-11-09T23:42:54.5869907Z +    PaymentProtocolClient::validate_payment_request(
2025-11-09T23:42:54.5870066Z +        &msg.payment_request,
2025-11-09T23:42:54.5870217Z +        Some(&msg.merchant_pubkey),
2025-11-09T23:42:54.5870331Z +    )
2025-11-09T23:42:54.5870716Z  }
2025-11-09T23:42:54.5870827Z  
2025-11-09T23:42:54.5871022Z  /// Validate PaymentACK message from merchant
2025-11-09T23:42:54.5871543Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/bip70_handler.rs:88:
2025-11-09T23:42:54.5871711Z      merchant_pubkey: &[u8],
2025-11-09T23:42:54.5871862Z  ) -> Result<(), Bip70Error> {
2025-11-09T23:42:54.5872126Z      use bllvm_protocol::payment::PaymentProtocolClient;
2025-11-09T23:42:54.5872704Z -    PaymentProtocolClient::validate_payment_ack(&ack.payment_ack, &ack.merchant_signature, merchant_pubkey)
2025-11-09T23:42:54.5872913Z +    PaymentProtocolClient::validate_payment_ack(
2025-11-09T23:42:54.5873052Z +        &ack.payment_ack,
2025-11-09T23:42:54.5873191Z +        &ack.merchant_signature,
2025-11-09T23:42:54.5873329Z +        merchant_pubkey,
2025-11-09T23:42:54.5873441Z +    )
2025-11-09T23:42:54.5873552Z  }
2025-11-09T23:42:54.5873675Z  
2025-11-09T23:42:54.5874192Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/chain_access.rs:3:
2025-11-09T23:42:54.5874704Z  //! Implements ChainStateAccess trait to bridge node storage modules
2025-11-09T23:42:54.5875096Z  //! (BlockStore, TxIndex, MempoolManager) with protocol layer network processing.
2025-11-09T23:42:54.5875206Z  
2025-11-09T23:42:54.5875383Z +use crate::node::mempool::MempoolManager;
2025-11-09T23:42:54.5875869Z +use crate::storage::{blockstore::BlockStore, txindex::TxIndex};
2025-11-09T23:42:54.5876025Z  use anyhow::Result;
2025-11-09T23:42:54.5876294Z  use bllvm_protocol::network::{ChainObject, ChainStateAccess};
2025-11-09T23:42:54.5876550Z  use bllvm_protocol::{Block, BlockHeader, Hash, Transaction};
2025-11-09T23:42:54.5877053Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/chain_access.rs:9:
2025-11-09T23:42:54.5877244Z -use crate::node::mempool::MempoolManager;
2025-11-09T23:42:54.5877518Z -use crate::storage::{blockstore::BlockStore, txindex::TxIndex};
2025-11-09T23:42:54.5877678Z  use std::sync::Arc;
2025-11-09T23:42:54.5877791Z  
2025-11-09T23:42:54.5878172Z  /// Chain state access implementation that bridges node storage to protocol layer
2025-11-09T23:42:54.5878693Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/chain_access.rs:68:
2025-11-09T23:42:54.5878929Z      /// This implements the Bitcoin block locator algorithm
2025-11-09T23:42:54.5879315Z      fn get_headers_for_locator(&self, locator: &[Hash], stop: &Hash) -> Vec<BlockHeader> {
2025-11-09T23:42:54.5879487Z          let mut headers = Vec::new();
2025-11-09T23:42:54.5879610Z -        
2025-11-09T23:42:54.5879718Z +
2025-11-09T23:42:54.5879884Z          // Bitcoin block locator algorithm:
2025-11-09T23:42:54.5880064Z          // 1. Start with the most recent block hash
2025-11-09T23:42:54.5880403Z          // 2. Go back exponentially (1, 2, 4, 8, 16, ...) until we find a common ancestor
2025-11-09T23:42:54.5880922Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/chain_access.rs:75:
2025-11-09T23:42:54.5881177Z          // 3. Stop when we reach the stop hash or run out of hashes
2025-11-09T23:42:54.5881300Z -        
2025-11-09T23:42:54.5881411Z +
2025-11-09T23:42:54.5881551Z          for hash in locator {
2025-11-09T23:42:54.5881728Z              // If we've reached the stop hash, stop
2025-11-09T23:42:54.5881862Z              if hash == stop {
2025-11-09T23:42:54.5882369Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/chain_access.rs:80:
2025-11-09T23:42:54.5882489Z                  break;
2025-11-09T23:42:54.5882614Z              }
2025-11-09T23:42:54.5882729Z -            
2025-11-09T23:42:54.5882836Z +
2025-11-09T23:42:54.5882993Z              // Try to get the header
2025-11-09T23:42:54.5883251Z              if let Ok(Some(header)) = self.blockstore.get_header(hash) {
2025-11-09T23:42:54.5883406Z                  headers.push(header);
2025-11-09T23:42:54.5883910Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/chain_access.rs:89:
2025-11-09T23:42:54.5884603Z                  continue;
2025-11-09T23:42:54.5884734Z              }
2025-11-09T23:42:54.5884847Z          }
2025-11-09T23:42:54.5884969Z -        
2025-11-09T23:42:54.5885074Z +
2025-11-09T23:42:54.5885189Z          headers
2025-11-09T23:42:54.5885300Z      }
2025-11-09T23:42:54.5885422Z  
2025-11-09T23:42:54.5885936Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/chain_access.rs:130:
2025-11-09T23:42:54.5886072Z      height: Option<u64>,
2025-11-09T23:42:54.5886320Z  ) -> Result<bllvm_protocol::network::NetworkResponse> {
2025-11-09T23:42:54.5886673Z      use bllvm_protocol::network::{process_network_message, ChainStateAccess};
2025-11-09T23:42:54.5886786Z -    
2025-11-09T23:42:54.5886909Z +
2025-11-09T23:42:54.5887056Z      process_network_message(
2025-11-09T23:42:54.5887175Z          engine,
2025-11-09T23:42:54.5887294Z          message,
2025-11-09T23:42:54.5887789Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/chain_access.rs:138:
2025-11-09T23:42:54.5887995Z          Some(chain_access as &dyn ChainStateAccess),
2025-11-09T23:42:54.5888106Z          utxo_set,
2025-11-09T23:42:54.5888224Z          height,
2025-11-09T23:42:54.5888513Z -    ).map_err(|e| anyhow::anyhow!("Network message processing error: {}", e))
2025-11-09T23:42:54.5888621Z +    )
2025-11-09T23:42:54.5889129Z +    .map_err(|e| anyhow::anyhow!("Network message processing error: {}", e))
2025-11-09T23:42:54.5889267Z  }
2025-11-09T23:42:54.5889378Z -
2025-11-09T23:42:54.5889487Z  
2025-11-09T23:42:54.5890111Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dns_seeds.rs:38:
2025-11-09T23:42:54.5890263Z      max_addresses: usize,
2025-11-09T23:42:54.5890418Z  ) -> Vec<NetworkAddress> {
2025-11-09T23:42:54.5890582Z      let mut addresses = Vec::new();
2025-11-09T23:42:54.5890694Z -    
2025-11-09T23:42:54.5890812Z +
2025-11-09T23:42:54.5890947Z      for seed in seeds {
2025-11-09T23:42:54.5891150Z          match resolve_dns_seed(*seed, port).await {
2025-11-09T23:42:54.5891285Z              Ok(mut addrs) => {
2025-11-09T23:42:54.5891780Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dns_seeds.rs:53:
2025-11-09T23:42:54.5891893Z              }
2025-11-09T23:42:54.5892006Z          }
2025-11-09T23:42:54.5892124Z      }
2025-11-09T23:42:54.5892244Z -    
2025-11-09T23:42:54.5892353Z +
2025-11-09T23:42:54.5892494Z      // Limit to max_addresses
2025-11-09T23:42:54.5892665Z      addresses.truncate(max_addresses);
2025-11-09T23:42:54.5892784Z      addresses
2025-11-09T23:42:54.5893256Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dns_seeds.rs:63:
2025-11-09T23:42:54.5893648Z  async fn resolve_dns_seed(seed: &str, port: u16) -> Result<Vec<NetworkAddress>, String> {
2025-11-09T23:42:54.5893845Z      // Create hostname:port string for DNS lookup
2025-11-09T23:42:54.5894025Z      let hostname = format!("{}:{}", seed, port);
2025-11-09T23:42:54.5894150Z -    
2025-11-09T23:42:54.5894268Z +
2025-11-09T23:42:54.5894602Z      // Perform DNS lookup with timeout
2025-11-09T23:42:54.5894788Z      let timeout = Duration::from_secs(5);
2025-11-09T23:42:54.5895136Z      let lookup_result = tokio::time::timeout(timeout, lookup_host(&hostname))
2025-11-09T23:42:54.5895634Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dns_seeds.rs:70:
2025-11-09T23:42:54.5895755Z          .await
2025-11-09T23:42:54.5896004Z          .map_err(|_| format!("DNS lookup timeout for {}", seed))?;
2025-11-09T23:42:54.5896121Z -    
2025-11-09T23:42:54.5896268Z -    let socket_addrs = lookup_result
2025-11-09T23:42:54.5896513Z -        .map_err(|e| format!("DNS lookup failed for {}: {}", seed, e))?;
2025-11-09T23:42:54.5896638Z -    
2025-11-09T23:42:54.5896750Z +
2025-11-09T23:42:54.5896889Z +    let socket_addrs =
2025-11-09T23:42:54.5897232Z +        lookup_result.map_err(|e| format!("DNS lookup failed for {}: {}", seed, e))?;
2025-11-09T23:42:54.5898479Z +
2025-11-09T23:42:54.5898678Z      // Convert SocketAddr to NetworkAddress
2025-11-09T23:42:54.5898852Z      let mut addresses = Vec::new();
2025-11-09T23:42:54.5899021Z      for socket_addr in socket_addrs {
2025-11-09T23:42:54.5899523Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dns_seeds.rs:79:
2025-11-09T23:42:54.5899827Z          addresses.push(socket_addr_to_network_address(socket_addr));
2025-11-09T23:42:54.5899954Z      }
2025-11-09T23:42:54.5900067Z -    
2025-11-09T23:42:54.5900177Z +
2025-11-09T23:42:54.5900310Z      Ok(addresses)
2025-11-09T23:42:54.5900427Z  }
2025-11-09T23:42:54.5900530Z  
2025-11-09T23:42:54.5900995Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dns_seeds.rs:85:
2025-11-09T23:42:54.5901175Z  /// Convert SocketAddr to NetworkAddress
2025-11-09T23:42:54.5901545Z  fn socket_addr_to_network_address(socket_addr: SocketAddr) -> NetworkAddress {
2025-11-09T23:42:54.5901720Z      use std::net::IpAddr;
2025-11-09T23:42:54.5901838Z -    
2025-11-09T23:42:54.5901942Z +
2025-11-09T23:42:54.5902107Z      let ip_bytes = match socket_addr.ip() {
2025-11-09T23:42:54.5902244Z          IpAddr::V4(ipv4) => {
2025-11-09T23:42:54.5902396Z              // IPv4-mapped IPv6 format
2025-11-09T23:42:54.5903083Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dns_seeds.rs:95:
2025-11-09T23:42:54.5903287Z              bytes[12..16].copy_from_slice(&ipv4.octets());
2025-11-09T23:42:54.5903856Z              bytes
2025-11-09T23:42:54.5903986Z          }
2025-11-09T23:42:54.5904129Z -        IpAddr::V6(ipv6) => {
2025-11-09T23:42:54.5906551Z -            ipv6.octets()
2025-11-09T23:42:54.5906679Z -        }
2025-11-09T23:42:54.5906837Z +        IpAddr::V6(ipv6) => ipv6.octets(),
2025-11-09T23:42:54.5906939Z      };
2025-11-09T23:42:54.5907058Z -    
2025-11-09T23:42:54.5907164Z +
2025-11-09T23:42:54.5907290Z      NetworkAddress {
2025-11-09T23:42:54.5907493Z          services: 0, // Will be updated when we connect
2025-11-09T23:42:54.5907646Z          ip: ip_bytes,
2025-11-09T23:42:54.5908144Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dns_seeds.rs:125:
2025-11-09T23:42:54.5908296Z          assert_eq!(addr.ip[15], 1);
2025-11-09T23:42:54.5908421Z      }
2025-11-09T23:42:54.5908529Z  }
2025-11-09T23:42:54.5908638Z -
2025-11-09T23:42:54.5908755Z  
2025-11-09T23:42:54.5909292Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:9:
2025-11-09T23:42:54.5909446Z  use std::sync::Arc;
2025-11-09T23:42:54.5909630Z  use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:42:54.5909787Z  use tokio::sync::Mutex;
2025-11-09T23:42:54.5909944Z -use tracing::{debug, warn, error};
2025-11-09T23:42:54.5910100Z +use tracing::{debug, error, warn};
2025-11-09T23:42:54.5910211Z  
2025-11-09T23:42:54.5910560Z  /// Connection rate limiter (tracks connection attempts per time window)
2025-11-09T23:42:54.5910737Z  pub struct ConnectionRateLimiter {
2025-11-09T23:42:54.5911251Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:40:
2025-11-09T23:42:54.5911369Z  
2025-11-09T23:42:54.5911558Z          // Clean up old entries outside the time window
2025-11-09T23:42:54.5911790Z          let cutoff = now.saturating_sub(self.window_seconds);
2025-11-09T23:42:54.5911913Z -        
2025-11-09T23:42:54.5912039Z +
2025-11-09T23:42:54.5912400Z          let attempts = self.connection_attempts.entry(ip).or_insert_with(Vec::new);
2025-11-09T23:42:54.5912611Z          attempts.retain(|&timestamp| timestamp > cutoff);
2025-11-09T23:42:54.5912731Z  
2025-11-09T23:42:54.5913247Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:47:
2025-11-09T23:42:54.5913407Z          // Check if we're within the limit
2025-11-09T23:42:54.5913647Z          if attempts.len() >= self.max_connections_per_window {
2025-11-09T23:42:54.5916287Z -            warn!("Connection rate limit exceeded for IP {}: {} attempts in {} seconds", 
2025-11-09T23:42:54.5916756Z -                  ip, attempts.len(), self.window_seconds);
2025-11-09T23:42:54.5916879Z +            warn!(
2025-11-09T23:42:54.5917222Z +                "Connection rate limit exceeded for IP {}: {} attempts in {} seconds",
2025-11-09T23:42:54.5917347Z +                ip,
2025-11-09T23:42:54.5917498Z +                attempts.len(),
2025-11-09T23:42:54.5917650Z +                self.window_seconds
2025-11-09T23:42:54.5917769Z +            );
2025-11-09T23:42:54.5917887Z              false
2025-11-09T23:42:54.5918014Z          } else {
2025-11-09T23:42:54.5918179Z              // Record this connection attempt
2025-11-09T23:42:54.5918715Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:72:
2025-11-09T23:42:54.5918829Z  
2025-11-09T23:42:54.5919040Z      /// Get current connection attempt count for an IP
2025-11-09T23:42:54.5919272Z      pub fn get_attempt_count(&self, ip: IpAddr) -> usize {
2025-11-09T23:42:54.5919605Z -        self.connection_attempts.get(&ip).map(|v| v.len()).unwrap_or(0)
2025-11-09T23:42:54.5919781Z +        self.connection_attempts
2025-11-09T23:42:54.5919909Z +            .get(&ip)
2025-11-09T23:42:54.5920094Z +            .map(|v| v.len())
2025-11-09T23:42:54.5920238Z +            .unwrap_or(0)
2025-11-09T23:42:54.5920352Z      }
2025-11-09T23:42:54.5920696Z  }
2025-11-09T23:42:54.5920824Z  
2025-11-09T23:42:54.5921362Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:171:
2025-11-09T23:42:54.5921524Z      /// Create with default settings
2025-11-09T23:42:54.5921687Z      pub fn default() -> Self {
2025-11-09T23:42:54.5921825Z          Self::new(
2025-11-09T23:42:54.5922024Z -            10,   // Max 10 connections per IP per window
2025-11-09T23:42:54.5922172Z -            60,   // 60 second window
2025-11-09T23:42:54.5922349Z +            10,    // Max 10 connections per IP per window
2025-11-09T23:42:54.5922486Z +            60,    // 60 second window
2025-11-09T23:42:54.5922646Z              10000, // Max 10k messages in queue
2025-11-09T23:42:54.5922805Z -            200,  // Max 200 active connections
2025-11-09T23:42:54.5922959Z +            200,   // Max 200 active connections
2025-11-09T23:42:54.5923069Z          )
2025-11-09T23:42:54.5923187Z      }
2025-11-09T23:42:54.5923308Z  
2025-11-09T23:42:54.5923851Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:194:
2025-11-09T23:42:54.5924041Z              metrics.connection_rate_violations += 1;
2025-11-09T23:42:54.5924153Z  
2025-11-09T23:42:54.5924553Z              if *count >= self.auto_ban_connection_violations {
2025-11-09T23:42:54.5924953Z -                warn!("Auto-banning IP {} for repeated connection rate violations ({} violations)", 
2025-11-09T23:42:54.5925100Z -                      ip, *count);
2025-11-09T23:42:54.5925224Z +                warn!(
2025-11-09T23:42:54.5925594Z +                    "Auto-banning IP {} for repeated connection rate violations ({} violations)",
2025-11-09T23:42:54.5925733Z +                    ip, *count
2025-11-09T23:42:54.5925845Z +                );
2025-11-09T23:42:54.5926008Z                  metrics.auto_bans_applied += 1;
2025-11-09T23:42:54.5926208Z                  // Return false to reject, caller should ban
2025-11-09T23:42:54.5926344Z                  return false;
2025-11-09T23:42:54.5926870Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:212:
2025-11-09T23:42:54.5927048Z      /// Check if message queue is within limits
2025-11-09T23:42:54.5927397Z      pub async fn check_message_queue_size(&self, current_size: usize) -> bool {
2025-11-09T23:42:54.5927602Z          if current_size > self.max_message_queue_size {
2025-11-09T23:42:54.5927994Z -            warn!("Message queue size exceeded: {} > {}", current_size, self.max_message_queue_size);
2025-11-09T23:42:54.5928122Z +            warn!(
2025-11-09T23:42:54.5928557Z +                "Message queue size exceeded: {} > {}",
2025-11-09T23:42:54.5928743Z +                current_size, self.max_message_queue_size
2025-11-09T23:42:54.5928864Z +            );
2025-11-09T23:42:54.5929050Z              let mut metrics = self.metrics.lock().await;
2025-11-09T23:42:54.5929224Z              metrics.message_queue_overflows += 1;
2025-11-09T23:42:54.5929345Z              false
2025-11-09T23:42:54.5929892Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:224:
2025-11-09T23:42:54.5930064Z      /// Check if we can accept more connections
2025-11-09T23:42:54.5930410Z      pub async fn check_active_connections(&self, current_count: usize) -> bool {
2025-11-09T23:42:54.5930618Z          if current_count >= self.max_active_connections {
2025-11-09T23:42:54.5931061Z -            warn!("Active connection limit exceeded: {} >= {}", current_count, self.max_active_connections);
2025-11-09T23:42:54.5931175Z +            warn!(
2025-11-09T23:42:54.5931391Z +                "Active connection limit exceeded: {} >= {}",
2025-11-09T23:42:54.5931572Z +                current_count, self.max_active_connections
2025-11-09T23:42:54.5931682Z +            );
2025-11-09T23:42:54.5931865Z              let mut metrics = self.metrics.lock().await;
2025-11-09T23:42:54.5932257Z              metrics.active_connection_limit_hits += 1;
2025-11-09T23:42:54.5932395Z              false
2025-11-09T23:42:54.5932940Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:262:
2025-11-09T23:42:54.5933141Z      /// Check if we're under DoS attack (heuristic)
2025-11-09T23:42:54.5933336Z      pub async fn detect_dos_attack(&self) -> bool {
2025-11-09T23:42:54.5933552Z          let metrics = self.resource_metrics.lock().await;
2025-11-09T23:42:54.5933670Z -        
2025-11-09T23:42:54.5933786Z +
2025-11-09T23:42:54.5934129Z          // Heuristic: If message queue is > 80% full and connections are > 80% of max
2025-11-09T23:42:54.5936567Z          let queue_threshold = (self.max_message_queue_size as f64 * 0.8) as usize;
2025-11-09T23:42:54.5936891Z          let conn_threshold = (self.max_active_connections as f64 * 0.8) as usize;
2025-11-09T23:42:54.5937438Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:269:
2025-11-09T23:42:54.5937567Z  
2025-11-09T23:42:54.5937782Z -        metrics.message_queue_size > queue_threshold 
2025-11-09T23:42:54.5937973Z -            && metrics.active_connections > conn_threshold
2025-11-09T23:42:54.5938431Z +        metrics.message_queue_size > queue_threshold && metrics.active_connections > conn_threshold
2025-11-09T23:42:54.5938548Z      }
2025-11-09T23:42:54.5938657Z  
2025-11-09T23:42:54.5938855Z      /// Cleanup old connection rate limiter entries
2025-11-09T23:42:54.5939368Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/dos_protection.rs:368:
2025-11-09T23:42:54.5939543Z          assert!(dos.should_auto_ban(ip).await);
2025-11-09T23:42:54.5939663Z      }
2025-11-09T23:42:54.5939775Z  }
2025-11-09T23:42:54.5939885Z -
2025-11-09T23:42:54.5939996Z  
2025-11-09T23:42:54.5940514Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/filter_service.rs:3:
2025-11-09T23:42:54.5940900Z  //! Generates, caches, and serves compact block filters for light client support.
2025-11-09T23:42:54.5941176Z  //! Maintains filter header chain for efficient verification.
2025-11-09T23:42:54.5941295Z  
2025-11-09T23:42:54.5941454Z +use anyhow::{anyhow, Result};
2025-11-09T23:42:54.5941600Z  use bllvm_protocol::bip157;
2025-11-09T23:42:54.5941914Z  use bllvm_protocol::bip158::{build_block_filter, CompactBlockFilter};
2025-11-09T23:42:54.5942077Z -use anyhow::{anyhow, Result};
2025-11-09T23:42:54.5942345Z  use bllvm_protocol::{Block, BlockHeader, Hash, Transaction};
2025-11-09T23:42:54.5942501Z  use std::collections::HashMap;
2025-11-09T23:42:54.5942649Z  use std::sync::{Arc, RwLock};
2025-11-09T23:42:54.5943463Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/filter_service.rs:211:
2025-11-09T23:42:54.5943819Z      pub fn remove_filter_for_pruned_block(&self, block_hash: &Hash) -> Result<()> {
2025-11-09T23:42:54.5943972Z          // Remove filter from cache
2025-11-09T23:42:54.5944190Z          self.filters.write().unwrap().remove(block_hash);
2025-11-09T23:42:54.5944307Z -        
2025-11-09T23:42:54.5946495Z +
2025-11-09T23:42:54.5946835Z          // Note: We do NOT remove the filter header - it's required for verification
2025-11-09T23:42:54.5947111Z          // The filter header chain must remain intact even after pruning
2025-11-09T23:42:54.5947221Z -        
2025-11-09T23:42:54.5947337Z +
2025-11-09T23:42:54.5947454Z          Ok(())
2025-11-09T23:42:54.5947564Z      }
2025-11-09T23:42:54.5947670Z  
2025-11-09T23:42:54.5948243Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/message_bridge.rs:80:
2025-11-09T23:42:54.5948677Z      /// 3. Convert the `NetworkResponse` to wire format messages using `extract_send_messages()`
2025-11-09T23:42:54.5948792Z      ///
2025-11-09T23:42:54.5949205Z      /// For now, this method only handles message conversion, not processing.
2025-11-09T23:42:54.5949369Z -    pub fn process_incoming_message(
2025-11-09T23:42:54.5949490Z -        data: &[u8],
2025-11-09T23:42:54.5949864Z -        transport: TransportType,
2025-11-09T23:42:54.5950034Z -    ) -> Result<Vec<Vec<u8>>> {
2025-11-09T23:42:54.5950481Z +    pub fn process_incoming_message(data: &[u8], transport: TransportType) -> Result<Vec<Vec<u8>>> {
2025-11-09T23:42:54.5950638Z          // Convert to protocol message
2025-11-09T23:42:54.5950955Z          let protocol_msg = Self::from_transport_message(data, transport)?;
2025-11-09T23:42:54.5951068Z  
2025-11-09T23:42:54.6721611Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:4:
2025-11-09T23:42:54.6722026Z  //! message handling for communication with other Bitcoin nodes.
2025-11-09T23:42:54.6722276Z  
2025-11-09T23:42:54.6722453Z  pub mod address_db;
2025-11-09T23:42:54.6722647Z +pub mod ban_list_merging;
2025-11-09T23:42:54.6722844Z +pub mod ban_list_signing;
2025-11-09T23:42:54.6723026Z  pub mod chain_access;
2025-11-09T23:42:54.6723199Z  pub mod dns_seeds;
2025-11-09T23:42:54.6723401Z +pub mod dos_protection;
2025-11-09T23:42:54.6723593Z  pub mod inventory;
2025-11-09T23:42:54.6723790Z  pub mod message_bridge;
2025-11-09T23:42:54.6723960Z  pub mod peer;
2025-11-09T23:42:54.6724763Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:12:
2025-11-09T23:42:54.6724942Z  pub mod protocol;
2025-11-09T23:42:54.6725135Z  pub mod protocol_adapter;
2025-11-09T23:42:54.6725337Z  pub mod protocol_extensions;
2025-11-09T23:42:54.6725521Z -pub mod ban_list_merging;
2025-11-09T23:42:54.6725697Z -pub mod ban_list_signing;
2025-11-09T23:42:54.6725879Z -pub mod dos_protection;
2025-11-09T23:42:54.6726045Z  pub mod relay;
2025-11-09T23:42:54.6726233Z  pub mod tcp_transport;
2025-11-09T23:42:54.6726404Z  pub mod transport;
2025-11-09T23:42:54.6727009Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:40:
2025-11-09T23:42:54.6727255Z  // Payment Protocol (BIP70) - P2P handlers
2025-11-09T23:42:54.6727418Z  pub mod bip70_handler;
2025-11-09T23:42:54.6727561Z  
2025-11-09T23:42:54.6727728Z -
2025-11-09T23:42:54.6727963Z  // Privacy and Performance Enhancements
2025-11-09T23:42:54.6728164Z  #[cfg(feature = "dandelion")]
2025-11-09T23:42:54.6728623Z  pub mod dandelion; // Dandelion++ privacy-preserving transaction relay
2025-11-09T23:42:54.6729243Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:50:
2025-11-09T23:42:54.6729573Z  pub mod txhash; // Non-consensus hashing helpers for relay
2025-11-09T23:42:54.6729743Z  
2025-11-09T23:42:54.6730158Z  use crate::network::protocol::{ProtocolMessage, ProtocolParser};
2025-11-09T23:42:54.6730389Z +use crate::node::mempool::MempoolManager;
2025-11-09T23:42:54.6730898Z +use crate::storage::Storage;
2025-11-09T23:42:54.6731080Z  use anyhow::Result;
2025-11-09T23:42:54.6731268Z  use bllvm_protocol::mempool::Mempool;
2025-11-09T23:42:54.6731617Z  use bllvm_protocol::{BitcoinProtocolEngine, ConsensusProof, UtxoSet};
2025-11-09T23:42:54.6732104Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:58:
2025-11-09T23:42:54.6732255Z  use std::sync::{Arc, Mutex};
2025-11-09T23:42:54.6732401Z  use tokio::sync::mpsc;
2025-11-09T23:42:54.6732578Z  use tracing::{error, info, warn};
2025-11-09T23:42:54.6732753Z -use crate::storage::Storage;
2025-11-09T23:42:54.6732956Z -use crate::node::mempool::MempoolManager;
2025-11-09T23:42:54.6733078Z  
2025-11-09T23:42:54.6733300Z  use crate::network::tcp_transport::TcpTransport;
2025-11-09T23:42:54.6733473Z  use crate::network::transport::{
2025-11-09T23:42:54.6734028Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:86:
2025-11-09T23:42:54.6734188Z  }
2025-11-09T23:42:54.6734469Z  
2025-11-09T23:42:54.6734704Z  /// Peer manager for tracking connected peers
2025-11-09T23:42:54.6734844Z -/// 
2025-11-09T23:42:54.6734996Z +///
2025-11-09T23:42:54.6735930Z  /// Uses TransportAddr as key to support all transport types (TCP, Quinn, Iroh).
2025-11-09T23:42:54.6738163Z  /// This allows proper peer identification for Iroh (NodeId) while maintaining
2025-11-09T23:42:54.6738377Z  /// compatibility with TCP/Quinn (SocketAddr).
2025-11-09T23:42:54.6738858Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:130:
2025-11-09T23:42:54.6739128Z      pub fn peer_addresses(&self) -> Vec<TransportAddr> {
2025-11-09T23:42:54.6739335Z          self.peers.keys().cloned().collect()
2025-11-09T23:42:54.6739463Z      }
2025-11-09T23:42:54.6739598Z -    
2025-11-09T23:42:54.6739728Z +
2025-11-09T23:42:54.6740060Z      /// Get peer addresses as SocketAddr (for backward compatibility)
2025-11-09T23:42:54.6740371Z      /// Only returns SocketAddr for TCP/Quinn peers, skips Iroh peers
2025-11-09T23:42:54.6740636Z      pub fn peer_socket_addresses(&self) -> Vec<SocketAddr> {
2025-11-09T23:42:54.6741142Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:137:
2025-11-09T23:42:54.6741297Z -        self.peers.keys()
2025-11-09T23:42:54.6741436Z +        self.peers
2025-11-09T23:42:54.6741583Z +            .keys()
2025-11-09T23:42:54.6741738Z              .filter_map(|addr| {
2025-11-09T23:42:54.6741880Z                  match addr {
2025-11-09T23:42:54.6742099Z                      TransportAddr::Tcp(sock) => Some(*sock),
2025-11-09T23:42:54.6742603Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:150:
2025-11-09T23:42:54.6742791Z      pub fn can_accept_peer(&self) -> bool {
2025-11-09T23:42:54.6742956Z          self.peers.len() < self.max_peers
2025-11-09T23:42:54.6743074Z      }
2025-11-09T23:42:54.6743183Z -    
2025-11-09T23:42:54.6743293Z +
2025-11-09T23:42:54.6743475Z      /// Select best peers based on quality score
2025-11-09T23:42:54.6743599Z -    /// 
2025-11-09T23:42:54.6743715Z +    ///
2025-11-09T23:42:54.6743958Z      /// Returns peers sorted by quality score (highest first)
2025-11-09T23:42:54.6744256Z      pub fn select_best_peers(&self, count: usize) -> Vec<TransportAddr> {
2025-11-09T23:42:54.6745354Z -        let mut peers: Vec<_> = self.peers.iter()
2025-11-09T23:42:54.6745513Z +        let mut peers: Vec<_> = self
2025-11-09T23:42:54.6745634Z +            .peers
2025-11-09T23:42:54.6745759Z +            .iter()
2025-11-09T23:42:54.6746001Z              .map(|(addr, peer)| (addr.clone(), peer.quality_score()))
2025-11-09T23:42:54.6746125Z              .collect();
2025-11-09T23:42:54.6746245Z -        
2025-11-09T23:42:54.6746356Z +
2025-11-09T23:42:54.6746521Z          // Sort by quality score (descending)
2025-11-09T23:42:54.6746836Z          peers.sort_by(|a, b| b.1.partial_cmp(&a.1).unwrap_or(std::cmp::Ordering::Equal));
2025-11-09T23:42:54.6747092Z -        
2025-11-09T23:42:54.6747160Z +
2025-11-09T23:42:54.6747251Z          // Return top N addresses
2025-11-09T23:42:54.6747341Z -        peers.into_iter()
2025-11-09T23:42:54.6747421Z +        peers
2025-11-09T23:42:54.6747497Z +            .into_iter()
2025-11-09T23:42:54.6747570Z              .take(count)
2025-11-09T23:42:54.6747659Z              .map(|(addr, _)| addr)
2025-11-09T23:42:54.6747737Z              .collect()
2025-11-09T23:42:54.6748010Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:170:
2025-11-09T23:42:54.6748085Z      }
2025-11-09T23:42:54.6748150Z -    
2025-11-09T23:42:54.6748215Z +
2025-11-09T23:42:54.6748306Z      /// Select reliable peers only
2025-11-09T23:42:54.6748377Z -    /// 
2025-11-09T23:42:54.6748443Z +    ///
2025-11-09T23:42:54.6748568Z      /// Returns peers that meet reliability criteria
2025-11-09T23:42:54.6748734Z      pub fn select_reliable_peers(&self) -> Vec<TransportAddr> {
2025-11-09T23:42:54.6748817Z -        self.peers.iter()
2025-11-09T23:42:54.6748894Z +        self.peers
2025-11-09T23:42:54.6748962Z +            .iter()
2025-11-09T23:42:54.6749203Z              .filter(|(_, peer)| peer.quality_score() > 0.5) // Use quality_score as reliability indicator
2025-11-09T23:42:54.6749293Z              .map(|(addr, _)| addr.clone())
2025-11-09T23:42:54.6749366Z              .collect()
2025-11-09T23:42:54.6749753Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:180:
2025-11-09T23:42:54.6749823Z      }
2025-11-09T23:42:54.6749889Z -    
2025-11-09T23:42:54.6749953Z +
2025-11-09T23:42:54.6750050Z      /// Get peer quality statistics
2025-11-09T23:42:54.6750189Z      pub fn get_quality_stats(&self) -> (usize, usize, f64) {
2025-11-09T23:42:54.6750285Z          let total = self.peers.len();
2025-11-09T23:42:54.6750541Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:185:
2025-11-09T23:42:54.6750638Z -        let reliable = self.peers.values()
2025-11-09T23:42:54.6750726Z +        let reliable = self
2025-11-09T23:42:54.6750796Z +            .peers
2025-11-09T23:42:54.6750871Z +            .values()
2025-11-09T23:42:54.6751090Z              .filter(|peer| peer.quality_score() > 0.5) // Use quality_score as reliability indicator
2025-11-09T23:42:54.6751161Z              .count();
2025-11-09T23:42:54.6751257Z          let avg_quality = if total > 0 {
2025-11-09T23:42:54.6751507Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:189:
2025-11-09T23:42:54.6751595Z -            self.peers.values()
2025-11-09T23:42:54.6751672Z +            self.peers
2025-11-09T23:42:54.6751747Z +                .values()
2025-11-09T23:42:54.6751849Z                  .map(|peer| peer.quality_score())
2025-11-09T23:42:54.6751943Z -                .sum::<f64>() / total as f64
2025-11-09T23:42:54.6752026Z +                .sum::<f64>()
2025-11-09T23:42:54.6752102Z +                / total as f64
2025-11-09T23:42:54.6752172Z          } else {
2025-11-09T23:42:54.6752249Z              0.0
2025-11-09T23:42:54.6752316Z          };
2025-11-09T23:42:54.6752555Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:195:
2025-11-09T23:42:54.6752622Z -        
2025-11-09T23:42:54.6752694Z +
2025-11-09T23:42:54.6752783Z          (total, reliable, avg_quality)
2025-11-09T23:42:54.6752849Z      }
2025-11-09T23:42:54.6752927Z -    
2025-11-09T23:42:54.6752991Z +
2025-11-09T23:42:54.6753129Z      /// Find peer by SocketAddr (tries TCP and Quinn variants)
2025-11-09T23:42:54.6753223Z      /// Returns the TransportAddr if found
2025-11-09T23:42:54.6753458Z      pub fn find_transport_addr_by_socket(&self, addr: SocketAddr) -> Option<TransportAddr> {
2025-11-09T23:42:54.6753700Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:204:
2025-11-09T23:42:54.6753804Z          if self.peers.contains_key(&tcp_addr) {
2025-11-09T23:42:54.6753894Z              return Some(tcp_addr);
2025-11-09T23:42:54.6754061Z          }
2025-11-09T23:42:54.6754126Z -        
2025-11-09T23:42:54.6754189Z +
2025-11-09T23:42:54.6754267Z          // Try Quinn
2025-11-09T23:42:54.6754519Z          #[cfg(feature = "quinn")]
2025-11-09T23:42:54.6754593Z          {
2025-11-09T23:42:54.6754844Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:213:
2025-11-09T23:42:54.6754938Z                  return Some(quinn_addr);
2025-11-09T23:42:54.6755006Z              }
2025-11-09T23:42:54.6755071Z          }
2025-11-09T23:42:54.6755143Z -        
2025-11-09T23:42:54.6755207Z +
2025-11-09T23:42:54.6755272Z          None
2025-11-09T23:42:54.6755341Z      }
2025-11-09T23:42:54.6755405Z  }
2025-11-09T23:42:54.6755640Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:245:
2025-11-09T23:42:54.6755717Z              last_refill: now,
2025-11-09T23:42:54.6755790Z          }
2025-11-09T23:42:54.6755854Z      }
2025-11-09T23:42:54.6755917Z -    
2025-11-09T23:42:54.6755991Z +
2025-11-09T23:42:54.6756127Z      /// Check if a message can be consumed and consume a token
2025-11-09T23:42:54.6756235Z      pub fn check_and_consume(&mut self) -> bool {
2025-11-09T23:42:54.6756312Z          self.refill();
2025-11-09T23:42:54.6756557Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:256:
2025-11-09T23:42:54.6756626Z              false
2025-11-09T23:42:54.6756829Z          }
2025-11-09T23:42:54.6756905Z      }
2025-11-09T23:42:54.6756969Z -    
2025-11-09T23:42:54.6757032Z +
2025-11-09T23:42:54.6757129Z      /// Refill tokens based on elapsed time
2025-11-09T23:42:54.6757216Z      fn refill(&mut self) {
2025-11-09T23:42:54.6757323Z          use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:42:54.6757560Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:264:
2025-11-09T23:42:54.6757656Z              .duration_since(UNIX_EPOCH)
2025-11-09T23:42:54.6757728Z              .unwrap()
2025-11-09T23:42:54.6757806Z              .as_secs();
2025-11-09T23:42:54.6757872Z -        
2025-11-09T23:42:54.6757941Z +
2025-11-09T23:42:54.6758028Z          if now > self.last_refill {
2025-11-09T23:42:54.6758125Z              let elapsed = now - self.last_refill;
2025-11-09T23:42:54.6758254Z              let tokens_to_add = (elapsed as u32) * self.rate;
2025-11-09T23:42:54.6758493Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:271:
2025-11-09T23:42:54.6758701Z -            self.tokens = self.tokens.saturating_add(tokens_to_add).min(self.burst_limit);
2025-11-09T23:42:54.6758788Z +            self.tokens = self
2025-11-09T23:42:54.6758862Z +                .tokens
2025-11-09T23:42:54.6758958Z +                .saturating_add(tokens_to_add)
2025-11-09T23:42:54.6759044Z +                .min(self.burst_limit);
2025-11-09T23:42:54.6759134Z              self.last_refill = now;
2025-11-09T23:42:54.6759199Z          }
2025-11-09T23:42:54.6759267Z      }
2025-11-09T23:42:54.6759514Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:452:
2025-11-09T23:42:54.6759689Z              enable_self_advertisement: true, // Default: advertise ourselves
2025-11-09T23:42:54.6759755Z          }
2025-11-09T23:42:54.6759821Z      }
2025-11-09T23:42:54.6759893Z -    
2025-11-09T23:42:54.6759957Z +
2025-11-09T23:42:54.6760088Z      /// Set dependencies for protocol message processing
2025-11-09T23:42:54.6760182Z      pub fn with_dependencies(
2025-11-09T23:42:54.6760251Z          mut self,
2025-11-09T23:42:54.6760559Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:525:
2025-11-09T23:42:54.6760814Z      /// Discover peers from DNS seeds and add to address database
2025-11-09T23:42:54.6761064Z      pub async fn discover_peers_from_dns(&self, network: &str, port: u16) -> Result<()> {
2025-11-09T23:42:54.6761159Z          use crate::network::dns_seeds;
2025-11-09T23:42:54.6761226Z -        
2025-11-09T23:42:54.6761296Z +
2025-11-09T23:42:54.6761523Z          let seeds = match network {
2025-11-09T23:42:54.6761636Z              "mainnet" => dns_seeds::MAINNET_DNS_SEEDS,
2025-11-09T23:42:54.6761746Z              "testnet" => dns_seeds::TESTNET_DNS_SEEDS,
2025-11-09T23:42:54.6761990Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:534:
2025-11-09T23:42:54.6762068Z                  return Ok(());
2025-11-09T23:42:54.6762139Z              }
2025-11-09T23:42:54.6762211Z          };
2025-11-09T23:42:54.6762280Z -        
2025-11-09T23:42:54.6762341Z +
2025-11-09T23:42:54.6762494Z          info!("Discovering peers from DNS seeds for {}", network);
2025-11-09T23:42:54.6762671Z          let addresses = dns_seeds::resolve_dns_seeds(seeds, port, 100).await;
2025-11-09T23:42:54.6762737Z -        
2025-11-09T23:42:54.6762801Z +
2025-11-09T23:42:54.6762902Z          // Add discovered addresses to database
2025-11-09T23:42:54.6762978Z          {
2025-11-09T23:42:54.6763103Z              let mut db = self.address_database.lock().unwrap();
2025-11-09T23:42:54.6763348Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:545:
2025-11-09T23:42:54.6763516Z                  db.add_address(addr, 0); // Services will be updated on connection
2025-11-09T23:42:54.6763582Z              }
2025-11-09T23:42:54.6763647Z          }
2025-11-09T23:42:54.6763718Z -        
2025-11-09T23:42:54.6763783Z +
2025-11-09T23:42:54.6764067Z          info!("Discovered {} addresses from DNS seeds", addresses.len());
2025-11-09T23:42:54.6764139Z          Ok(())
2025-11-09T23:42:54.6764208Z      }
2025-11-09T23:42:54.6766454Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:555:
2025-11-09T23:42:54.6766562Z          for peer_addr in persistent_peers {
2025-11-09T23:42:54.6766664Z              // Add to persistent peer set
2025-11-09T23:42:54.6766769Z              self.add_persistent_peer(*peer_addr);
2025-11-09T23:42:54.6766838Z -            
2025-11-09T23:42:54.6766903Z +
2025-11-09T23:42:54.6766994Z              // Try to connect
2025-11-09T23:42:54.6767132Z              info!("Connecting to persistent peer: {}", peer_addr);
2025-11-09T23:42:54.6767270Z              if let Err(e) = self.connect_to_peer(*peer_addr).await {
2025-11-09T23:42:54.6767522Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:566:
2025-11-09T23:42:54.6767589Z      }
2025-11-09T23:42:54.6767659Z  
2025-11-09T23:42:54.6767781Z      /// Discover Iroh peers and add to address database
2025-11-09T23:42:54.6767856Z -    /// 
2025-11-09T23:42:54.6767922Z +    ///
2025-11-09T23:42:54.6768021Z      /// Iroh peers are discovered through:
2025-11-09T23:42:54.6768146Z      /// 1. Incoming connections (automatically stored)
2025-11-09T23:42:54.6768237Z      /// 2. DERP servers (if configured)
2025-11-09T23:42:54.6768478Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:573:
2025-11-09T23:42:54.6768578Z      /// 3. Gossip discovery (if available)
2025-11-09T23:42:54.6768649Z -    /// 
2025-11-09T23:42:54.6768714Z +    ///
2025-11-09T23:42:54.6768911Z      /// This method can be extended to use Iroh's gossip discovery APIs when available.
2025-11-09T23:42:54.6768996Z      #[cfg(feature = "iroh")]
2025-11-09T23:42:54.6769140Z      pub async fn discover_iroh_peers(&self) -> Result<usize> {
2025-11-09T23:42:54.6769392Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:579:
2025-11-09T23:42:54.6769565Z          // 1. Incoming connections (handled automatically in accept loop)
2025-11-09T23:42:54.6769679Z          // 2. DERP servers (configured in IrohTransport)
2025-11-09T23:42:54.6769839Z          // 3. Gossip discovery (would require iroh-gossip-discovery crate)
2025-11-09T23:42:54.6769905Z -        
2025-11-09T23:42:54.6769978Z +
2025-11-09T23:42:54.6770058Z          // For now, we rely on:
2025-11-09T23:42:54.6770158Z          // - Persistent Iroh peers from config
2025-11-09T23:42:54.6770278Z          // - Incoming connections (stored automatically)
2025-11-09T23:42:54.6770654Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:586:
2025-11-09T23:42:54.6770775Z          // - DERP servers (handled by Iroh's MagicEndpoint)
2025-11-09T23:42:54.6770856Z -        
2025-11-09T23:42:54.6770919Z +
2025-11-09T23:42:54.6771079Z          // Future: Integrate with iroh-gossip-discovery when available
2025-11-09T23:42:54.6771280Z          info!("Iroh peer discovery: relying on DERP servers and incoming connections");
2025-11-09T23:42:54.6771470Z          Ok(0) // Return 0 for now - discovery happens through Iroh's native mechanisms
2025-11-09T23:42:54.6771709Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:593:
2025-11-09T23:42:54.6771818Z      /// Connect to Iroh peers from address database
2025-11-09T23:42:54.6771905Z      #[cfg(feature = "iroh")]
2025-11-09T23:42:54.6772141Z      pub async fn connect_iroh_peers_from_database(&self, target_count: usize) -> Result<usize> {
2025-11-09T23:42:54.6772268Z -        use crate::network::transport::TransportAddr;
2025-11-09T23:42:54.6772370Z          use crate::network::peer::Peer;
2025-11-09T23:42:54.6772436Z -        
2025-11-09T23:42:54.6772552Z +        use crate::network::transport::TransportAddr;
2025-11-09T23:42:54.6772619Z +
2025-11-09T23:42:54.6772714Z          // Count current Iroh peers
2025-11-09T23:42:54.6772914Z          let current_iroh_count = {
2025-11-09T23:42:54.6773033Z              let pm = self.peer_manager.lock().unwrap();
2025-11-09T23:42:54.6773282Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:604:
2025-11-09T23:42:54.6773421Z                  .filter(|addr| matches!(addr, TransportAddr::Iroh(_)))
2025-11-09T23:42:54.6773495Z                  .count()
2025-11-09T23:42:54.6773561Z          };
2025-11-09T23:42:54.6773633Z -        
2025-11-09T23:42:54.6773700Z +
2025-11-09T23:42:54.6773799Z          if current_iroh_count >= target_count {
2025-11-09T23:42:54.6773891Z              return Ok(0);
2025-11-09T23:42:54.6773957Z          }
2025-11-09T23:42:54.6774196Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:611:
2025-11-09T23:42:54.6774264Z -        
2025-11-09T23:42:54.6776337Z +
2025-11-09T23:42:54.6776454Z          let needed = target_count - current_iroh_count;
2025-11-09T23:42:54.6776696Z -        info!("Need {} more Iroh peers (current: {}, target: {})", needed, current_iroh_count, target_count);
2025-11-09T23:42:54.6776769Z -        
2025-11-09T23:42:54.6776836Z +        info!(
2025-11-09T23:42:54.6776959Z +            "Need {} more Iroh peers (current: {}, target: {})",
2025-11-09T23:42:54.6777070Z +            needed, current_iroh_count, target_count
2025-11-09T23:42:54.6777134Z +        );
2025-11-09T23:42:54.6777201Z +
2025-11-09T23:42:54.6777294Z          // Get fresh Iroh NodeIds from database
2025-11-09T23:42:54.6777376Z          let node_ids = {
2025-11-09T23:42:54.6777492Z              let db = self.address_database.lock().unwrap();
2025-11-09T23:42:54.6777736Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:618:
2025-11-09T23:42:54.6777906Z              db.get_fresh_iroh_addresses(needed * 2) // Get 2x needed for retries
2025-11-09T23:42:54.6777971Z          };
2025-11-09T23:42:54.6778039Z -        
2025-11-09T23:42:54.6778104Z +
2025-11-09T23:42:54.6778196Z          if node_ids.is_empty() {
2025-11-09T23:42:54.6778331Z              warn!("No fresh Iroh addresses available in database");
2025-11-09T23:42:54.6778426Z              return Ok(0);
2025-11-09T23:42:54.6778666Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:624:
2025-11-09T23:42:54.6778732Z          }
2025-11-09T23:42:54.6778804Z -        
2025-11-09T23:42:54.6778868Z +
2025-11-09T23:42:54.6778947Z          // Get Iroh transport
2025-11-09T23:42:54.6779076Z          let iroh_transport = match &self.iroh_transport {
2025-11-09T23:42:54.6779168Z              Some(transport) => transport,
2025-11-09T23:42:54.6779535Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:631:
2025-11-09T23:42:54.6779614Z                  return Ok(0);
2025-11-09T23:42:54.6779688Z              }
2025-11-09T23:42:54.6779753Z          };
2025-11-09T23:42:54.6779818Z -        
2025-11-09T23:42:54.6779889Z +
2025-11-09T23:42:54.6779980Z          // Try to connect to Iroh peers
2025-11-09T23:42:54.6780061Z          let mut connected = 0;
2025-11-09T23:42:54.6780189Z          for node_id in node_ids.into_iter().take(needed * 2) {
2025-11-09T23:42:54.6780431Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:638:
2025-11-09T23:42:54.6780545Z              let node_id_bytes = node_id.as_bytes().to_vec();
2025-11-09T23:42:54.6780713Z              let transport_addr = TransportAddr::Iroh(node_id_bytes.clone());
2025-11-09T23:42:54.6780785Z -            
2025-11-09T23:42:54.6780850Z +
2025-11-09T23:42:54.6780954Z              // Connect directly using Iroh transport
2025-11-09T23:42:54.6781124Z              match iroh_transport.connect(transport_addr.clone()).await {
2025-11-09T23:42:54.6781199Z                  Ok(conn) => {
2025-11-09T23:42:54.6781440Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:650:
2025-11-09T23:42:54.6781530Z                          transport_addr.clone(),
2025-11-09T23:42:54.6781744Z                          self.peer_tx.clone(),
2025-11-09T23:42:54.6781815Z                      );
2025-11-09T23:42:54.6781885Z -                    
2025-11-09T23:42:54.6781955Z +
2025-11-09T23:42:54.6782041Z                      // Add peer to manager
2025-11-09T23:42:54.6782109Z                      {
2025-11-09T23:42:54.6782234Z                          let mut pm = self.peer_manager.lock().unwrap();
2025-11-09T23:42:54.6782482Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:659:
2025-11-09T23:42:54.6782562Z                              continue;
2025-11-09T23:42:54.6782635Z                          }
2025-11-09T23:42:54.6782709Z                      }
2025-11-09T23:42:54.6782854Z -                    
2025-11-09T23:42:54.6782965Z +
2025-11-09T23:42:54.6783135Z                      // Store mapping for Iroh (if needed)
2025-11-09T23:42:54.6783298Z                      {
2025-11-09T23:42:54.6783533Z                          let mut socket_to_transport = self.socket_to_transport.lock().unwrap();
2025-11-09T23:42:54.6783816Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:666:
2025-11-09T23:42:54.6784202Z                          socket_to_transport.insert(placeholder_socket, transport_addr.clone());
2025-11-09T23:42:54.6786510Z                      }
2025-11-09T23:42:54.6800392Z -                    
2025-11-09T23:42:54.6800554Z +
2025-11-09T23:42:54.6800860Z                      info!("Successfully connected to Iroh peer: {}", node_id);
2025-11-09T23:42:54.6801012Z                      connected += 1;
2025-11-09T23:42:54.6801194Z                      if connected >= needed {
2025-11-09T23:42:54.6801618Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:677:
2025-11-09T23:42:54.6801695Z                  }
2025-11-09T23:42:54.6801772Z              }
2025-11-09T23:42:54.6801838Z          }
2025-11-09T23:42:54.6801907Z -        
2025-11-09T23:42:54.6802115Z -        info!("Connected to {} new Iroh peers from address database", connected);
2025-11-09T23:42:54.6802195Z +
2025-11-09T23:42:54.6802267Z +        info!(
2025-11-09T23:42:54.6802417Z +            "Connected to {} new Iroh peers from address database",
2025-11-09T23:42:54.6802500Z +            connected
2025-11-09T23:42:54.6802566Z +        );
2025-11-09T23:42:54.6802639Z          Ok(connected)
2025-11-09T23:42:54.6802704Z      }
2025-11-09T23:42:54.6802775Z  
2025-11-09T23:42:54.6803043Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:685:
2025-11-09T23:42:54.6803209Z      /// Connect to peers from address database when below target count
2025-11-09T23:42:54.6803487Z -    /// 
2025-11-09T23:42:54.6803555Z +    ///
2025-11-09T23:42:54.6803755Z      /// Works with both SocketAddr-based addresses (TCP/Quinn) and Iroh NodeIds.
2025-11-09T23:42:54.6803988Z      pub async fn connect_peers_from_database(&self, target_count: usize) -> Result<usize> {
2025-11-09T23:42:54.6804111Z          let current_count = self.peer_count();
2025-11-09T23:42:54.6804534Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:692:
2025-11-09T23:42:54.6804607Z          }
2025-11-09T23:42:54.6804680Z  
2025-11-09T23:42:54.6804791Z          let needed = target_count - current_count;
2025-11-09T23:42:54.6805006Z -        info!("Need {} more peers (current: {}, target: {})", needed, current_count, target_count);
2025-11-09T23:42:54.6805082Z +        info!(
2025-11-09T23:42:54.6805200Z +            "Need {} more peers (current: {}, target: {})",
2025-11-09T23:42:54.6805298Z +            needed, current_count, target_count
2025-11-09T23:42:54.6805368Z +        );
2025-11-09T23:42:54.6805439Z  
2025-11-09T23:42:54.6805540Z          // Get fresh addresses from database
2025-11-09T23:42:54.6805672Z          let ban_list = self.ban_list.lock().unwrap().clone();
2025-11-09T23:42:54.6805937Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:715:
2025-11-09T23:42:54.6806176Z          // Convert addresses to SocketAddrs first
2025-11-09T23:42:54.6806275Z          let sockets: Vec<SocketAddr> = {
2025-11-09T23:42:54.6806394Z              let db = self.address_database.lock().unwrap();
2025-11-09T23:42:54.6806485Z -            addresses.iter()
2025-11-09T23:42:54.6806556Z +            addresses
2025-11-09T23:42:54.6806630Z +                .iter()
2025-11-09T23:42:54.6806721Z                  .take(needed * 2)
2025-11-09T23:42:54.6806834Z                  .map(|addr| db.network_addr_to_socket(addr))
2025-11-09T23:42:54.6806908Z                  .collect()
2025-11-09T23:42:54.6807170Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:724:
2025-11-09T23:42:54.6807257Z          // Try to connect to addresses
2025-11-09T23:42:54.6807339Z          let mut connected = 0;
2025-11-09T23:42:54.6807422Z          for socket in sockets {
2025-11-09T23:42:54.6807492Z -
2025-11-09T23:42:54.6807623Z              if let Err(e) = self.connect_to_peer(socket).await {
2025-11-09T23:42:54.6807742Z                  debug!("Failed to connect to {}: {}", socket, e);
2025-11-09T23:42:54.6807845Z                  // Continue trying other addresses
2025-11-09T23:42:54.6808097Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:737:
2025-11-09T23:42:54.6808164Z          }
2025-11-09T23:42:54.6808228Z  
2025-11-09T23:42:54.6808404Z          info!("Connected to {} new peers from address database", connected);
2025-11-09T23:42:54.6808472Z -        
2025-11-09T23:42:54.6808538Z +
2025-11-09T23:42:54.6808666Z          // Also try to connect Iroh peers if Iroh is enabled
2025-11-09T23:42:54.6808754Z          #[cfg(feature = "iroh")]
2025-11-09T23:42:54.6808870Z          if self.transport_preference.allows_iroh() {
2025-11-09T23:42:54.6809110Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:744:
2025-11-09T23:42:54.6809324Z              let iroh_connected = self.connect_iroh_peers_from_database(target_count).await?;
2025-11-09T23:42:54.6809415Z              connected += iroh_connected;
2025-11-09T23:42:54.6809480Z          }
2025-11-09T23:42:54.6809553Z -        
2025-11-09T23:42:54.6809618Z +
2025-11-09T23:42:54.6809692Z          Ok(connected)
2025-11-09T23:42:54.6809764Z      }
2025-11-09T23:42:54.6809828Z  
2025-11-09T23:42:54.6810067Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:751:
2025-11-09T23:42:54.6810173Z      /// Initialize peer connections after startup
2025-11-09T23:42:54.6810249Z -    /// 
2025-11-09T23:42:54.6810316Z +    ///
2025-11-09T23:42:54.6810570Z      /// This is automatically called by `start()` to:
2025-11-09T23:42:54.6810738Z      /// 1. Discover peers from DNS seeds (for TCP/Quinn transports)
2025-11-09T23:42:54.6810845Z      /// 2. Connect to persistent peers from config
2025-11-09T23:42:54.6811083Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:756:
2025-11-09T23:42:54.6811287Z      /// 3. Discover Iroh peers (if Iroh is enabled) - uses Iroh's DERP servers and gossip
2025-11-09T23:42:54.6811448Z      /// 4. Connect to peers from address database to reach target count
2025-11-09T23:42:54.6811514Z -    /// 
2025-11-09T23:42:54.6811580Z +    ///
2025-11-09T23:42:54.6811800Z      /// Note: The address database now supports both SocketAddr-based addresses (TCP/Quinn)
2025-11-09T23:42:54.6811925Z      /// and Iroh NodeIds. Iroh peers are discovered through:
2025-11-09T23:42:54.6812049Z      /// - DERP servers (handled by Iroh's MagicEndpoint)
2025-11-09T23:42:54.6812291Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:770:
2025-11-09T23:42:54.6812381Z          target_peer_count: usize,
2025-11-09T23:42:54.6812457Z      ) -> Result<()> {
2025-11-09T23:42:54.6812618Z          // 1. Discover peers from DNS seeds (only for TCP/Quinn, not Iroh)
2025-11-09T23:42:54.6812810Z -        let should_discover_dns = self.transport_preference.allows_tcp() || 
2025-11-09T23:42:54.6813080Z +        let should_discover_dns = self.transport_preference.allows_tcp() || {
2025-11-09T23:42:54.6813170Z +            #[cfg(feature = "quinn")]
2025-11-09T23:42:54.6813245Z              {
2025-11-09T23:42:54.6813334Z -                #[cfg(feature = "quinn")]
2025-11-09T23:42:54.6813402Z -                {
2025-11-09T23:42:54.6813522Z -                    self.transport_preference.allows_quinn()
2025-11-09T23:42:54.6813589Z -                }
2025-11-09T23:42:54.6813925Z -                #[cfg(not(feature = "quinn"))]
2025-11-09T23:42:54.6813996Z -                {
2025-11-09T23:42:54.6814083Z -                    false
2025-11-09T23:42:54.6814154Z -                }
2025-11-09T23:42:54.6814220Z -            };
2025-11-09T23:42:54.6814451Z +                self.transport_preference.allows_quinn()
2025-11-09T23:42:54.6814525Z +            }
2025-11-09T23:42:54.6814615Z +            #[cfg(not(feature = "quinn"))]
2025-11-09T23:42:54.6814680Z +            {
2025-11-09T23:42:54.6814762Z +                false
2025-11-09T23:42:54.6814828Z +            }
2025-11-09T23:42:54.6814893Z +        };
2025-11-09T23:42:54.6814976Z          if should_discover_dns {
2025-11-09T23:42:54.6815144Z              if let Err(e) = self.discover_peers_from_dns(network, port).await {
2025-11-09T23:42:54.6815258Z                  warn!("DNS seed discovery failed: {}", e);
2025-11-09T23:42:54.6815502Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:807:
2025-11-09T23:42:54.6815664Z          // 4. Connect to peers from address database to reach target count
2025-11-09T23:42:54.6815787Z          // Wait a bit for persistent peers to connect first
2025-11-09T23:42:54.6815953Z          tokio::time::sleep(tokio::time::Duration::from_secs(2)).await;
2025-11-09T23:42:54.6816025Z -        
2025-11-09T23:42:54.6816089Z +
2025-11-09T23:42:54.6816267Z          if let Err(e) = self.connect_peers_from_database(target_peer_count).await {
2025-11-09T23:42:54.6816411Z              warn!("Failed to connect peers from database: {}", e);
2025-11-09T23:42:54.6816479Z          }
2025-11-09T23:42:54.6816721Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:821:
2025-11-09T23:42:54.6818692Z              "Starting network manager with transport preference: {:?}",
2025-11-09T23:42:54.6818804Z              self.transport_preference
2025-11-09T23:42:54.6818872Z          );
2025-11-09T23:42:54.6818939Z -        
2025-11-09T23:42:54.6819010Z +
2025-11-09T23:42:54.6819092Z          // Start listening first
2025-11-09T23:42:54.6819158Z  
2025-11-09T23:42:54.6819258Z          // Initialize Quinn transport if enabled
2025-11-09T23:42:54.6819678Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:886:
2025-11-09T23:42:54.6819782Z                              let ip = socket_addr.ip();
2025-11-09T23:42:54.6819904Z                              if !dos_protection.check_connection(ip).await {
2025-11-09T23:42:54.6820124Z                                  warn!("Connection rate limit exceeded for IP {}, rejecting connection", ip);
2025-11-09T23:42:54.6820199Z -                                
2025-11-09T23:42:54.6820264Z +
2025-11-09T23:42:54.6820375Z                                  // Check if we should auto-ban
2025-11-09T23:42:54.6820494Z                                  if dos_protection.should_auto_ban(ip).await {
2025-11-09T23:42:54.6820680Z                                      warn!("Auto-banning IP {} for repeated connection rate violations", ip);
2025-11-09T23:42:54.6820921Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:899:
2025-11-09T23:42:54.6821060Z                                      let mut ban_list_guard = ban_list.lock().unwrap();
2025-11-09T23:42:54.6821195Z                                      ban_list_guard.insert(socket_addr, unban_timestamp);
2025-11-09T23:42:54.6821271Z                                  }
2025-11-09T23:42:54.6821352Z -                                
2025-11-09T23:42:54.6821535Z +
2025-11-09T23:42:54.6821645Z                                  // Close connection immediately
2025-11-09T23:42:54.6821736Z                                  drop(conn);
2025-11-09T23:42:54.6821818Z                                  continue;
2025-11-09T23:42:54.6822056Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:910:
2025-11-09T23:42:54.6822171Z                                  let pm = peer_manager_clone.lock().unwrap();
2025-11-09T23:42:54.6822266Z                                  pm.peer_count()
2025-11-09T23:42:54.6822339Z                              };
2025-11-09T23:42:54.6822539Z -                            if !dos_protection.check_active_connections(current_connections).await {
2025-11-09T23:42:54.6822633Z +                            if !dos_protection
2025-11-09T23:42:54.6822766Z +                                .check_active_connections(current_connections)
2025-11-09T23:42:54.6822845Z +                                .await
2025-11-09T23:42:54.6822928Z +                            {
2025-11-09T23:42:54.6823160Z                                  warn!("Active connection limit exceeded, rejecting connection from {}", socket_addr);
2025-11-09T23:42:54.6823246Z                                  drop(conn);
2025-11-09T23:42:54.6823326Z                                  continue;
2025-11-09T23:42:54.6823579Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:918:
2025-11-09T23:42:54.6823645Z  
2025-11-09T23:42:54.6823745Z                              // Send connection notification
2025-11-09T23:42:54.6823901Z                              let transport_addr = TransportAddr::Tcp(socket_addr);
2025-11-09T23:42:54.6824111Z -                            let _ = peer_tx.send(NetworkMessage::PeerConnected(transport_addr.clone()));
2025-11-09T23:42:54.6824187Z +                            let _ =
2025-11-09T23:42:54.6824505Z +                                peer_tx.send(NetworkMessage::PeerConnected(transport_addr.clone()));
2025-11-09T23:42:54.6824576Z  
2025-11-09T23:42:54.6824733Z                              // Handle connection in background with graceful error handling
2025-11-09T23:42:54.6824846Z                              let peer_tx_clone = peer_tx.clone();
2025-11-09T23:42:54.6825085Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:927:
2025-11-09T23:42:54.6825198Z                                  // Create peer from transport connection
2025-11-09T23:42:54.6825306Z                                  use crate::network::peer::Peer;
2025-11-09T23:42:54.6826989Z                                  use crate::network::transport::TransportAddr;
2025-11-09T23:42:54.6827222Z -                                
2025-11-09T23:42:54.6827288Z +
2025-11-09T23:42:54.6827427Z                                  let peer = peer::Peer::from_transport_connection(
2025-11-09T23:42:54.6827505Z                                      conn,
2025-11-09T23:42:54.6827596Z                                      socket_addr,
2025-11-09T23:42:54.6827845Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:934:
2025-11-09T23:42:54.6827957Z                                      TransportAddr::Tcp(socket_addr),
2025-11-09T23:42:54.6828058Z                                      peer_tx_clone.clone(),
2025-11-09T23:42:54.6828134Z                                  );
2025-11-09T23:42:54.6828212Z -                                
2025-11-09T23:42:54.6828279Z +
2025-11-09T23:42:54.6828409Z                                  // Add peer to manager (with graceful error handling)
2025-11-09T23:42:54.6828522Z                                  match peer_manager_for_peer.lock() {
2025-11-09T23:42:54.6828613Z                                      Ok(mut pm) => {
2025-11-09T23:42:54.6828850Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:941:
2025-11-09T23:42:54.6829004Z                                          if let Err(e) = pm.add_peer(transport_addr.clone(), peer) {
2025-11-09T23:42:54.6829509Z                                              warn!("Failed to add peer {}: {}", socket_addr, e);
2025-11-09T23:42:54.6829978Z -                                            let _ = peer_tx_clone.send(NetworkMessage::PeerDisconnected(transport_addr.clone()));
2025-11-09T23:42:54.6830177Z +                                            let _ = peer_tx_clone.send(
2025-11-09T23:42:54.6830387Z +                                                NetworkMessage::PeerDisconnected(
2025-11-09T23:42:54.6830569Z +                                                    transport_addr.clone(),
2025-11-09T23:42:54.6830718Z +                                                ),
2025-11-09T23:42:54.6830861Z +                                            );
2025-11-09T23:42:54.6831005Z                                              return;
2025-11-09T23:42:54.6831142Z                                          }
2025-11-09T23:42:54.6831477Z -                                        info!("Successfully added peer {} (transport: {:?})", socket_addr, transport_addr);
2025-11-09T23:42:54.6831568Z +                                        info!(
2025-11-09T23:42:54.6831704Z +                                            "Successfully added peer {} (transport: {:?})",
2025-11-09T23:42:54.6831822Z +                                            socket_addr, transport_addr
2025-11-09T23:42:54.6831903Z +                                        );
2025-11-09T23:42:54.6831982Z                                      }
2025-11-09T23:42:54.6832069Z                                      Err(e) => {
2025-11-09T23:42:54.6832252Z -                                        warn!("Failed to lock peer manager for {}: {}", socket_addr, e);
2025-11-09T23:42:54.6832505Z -                                        let _ = peer_tx_clone.send(NetworkMessage::PeerDisconnected(transport_addr.clone()));
2025-11-09T23:42:54.6832591Z +                                        warn!(
2025-11-09T23:42:54.6832724Z +                                            "Failed to lock peer manager for {}: {}",
2025-11-09T23:42:54.6832822Z +                                            socket_addr, e
2025-11-09T23:42:54.6832901Z +                                        );
2025-11-09T23:42:54.6832990Z +                                        let _ =
2025-11-09T23:42:54.6833145Z +                                            peer_tx_clone.send(NetworkMessage::PeerDisconnected(
2025-11-09T23:42:54.6833251Z +                                                transport_addr.clone(),
2025-11-09T23:42:54.6833335Z +                                            ));
2025-11-09T23:42:54.6833415Z                                          return;
2025-11-09T23:42:54.6833612Z                                      }
2025-11-09T23:42:54.6833689Z                                  }
2025-11-09T23:42:54.6833952Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:954:
2025-11-09T23:42:54.6834029Z -                                
2025-11-09T23:42:54.6834096Z +
2025-11-09T23:42:54.6834550Z                                  // Connection will be cleaned up automatically when read/write tasks exit
2025-11-09T23:42:54.6834824Z                                  // Peer removal happens in process_messages when PeerDisconnected is received
2025-11-09T23:42:54.6834903Z                              });
2025-11-09T23:42:54.6835165Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:974:
2025-11-09T23:42:54.6835307Z                      let peer_manager = Arc::clone(&self.peer_manager);
2025-11-09T23:42:54.6835451Z                      let dos_protection = Arc::clone(&self.dos_protection);
2025-11-09T23:42:54.6835577Z                      let ban_list = Arc::clone(&self.ban_list);
2025-11-09T23:42:54.6835648Z -                    
2025-11-09T23:42:54.6835714Z +
2025-11-09T23:42:54.6835810Z                      tokio::spawn(async move {
2025-11-09T23:42:54.6835893Z                          loop {
2025-11-09T23:42:54.6836154Z                              match quinn_listener.accept().await {
2025-11-09T23:42:54.6836410Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:993:
2025-11-09T23:42:54.6838131Z                                      let ip = socket_addr.ip();
2025-11-09T23:42:54.6838266Z                                      if !dos_protection.check_connection(ip).await {
2025-11-09T23:42:54.6838500Z                                          warn!("Connection rate limit exceeded for IP {}, rejecting Quinn connection", ip);
2025-11-09T23:42:54.6838590Z -                                        
2025-11-09T23:42:54.6838655Z +
2025-11-09T23:42:54.6838788Z                                          if dos_protection.should_auto_ban(ip).await {
2025-11-09T23:42:54.6838981Z                                              warn!("Auto-banning IP {} for repeated connection rate violations", ip);
2025-11-09T23:42:54.6839135Z                                              let unban_timestamp = std::time::SystemTime::now()
2025-11-09T23:42:54.6839392Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1013:
2025-11-09T23:42:54.6839507Z                                          let pm = peer_manager.lock().unwrap();
2025-11-09T23:42:54.6839610Z                                          pm.peer_count()
2025-11-09T23:42:54.6839687Z                                      };
2025-11-09T23:42:54.6839888Z -                                    if !dos_protection.check_active_connections(current_connections).await {
2025-11-09T23:42:54.6839989Z +                                    if !dos_protection
2025-11-09T23:42:54.6840119Z +                                        .check_active_connections(current_connections)
2025-11-09T23:42:54.6840206Z +                                        .await
2025-11-09T23:42:54.6840287Z +                                    {
2025-11-09T23:42:54.6840542Z                                          warn!("Active connection limit exceeded, rejecting Quinn connection from {}", socket_addr);
2025-11-09T23:42:54.6840636Z                                          drop(conn);
2025-11-09T23:42:54.6840721Z                                          continue;
2025-11-09T23:42:54.6840979Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1021:
2025-11-09T23:42:54.6841045Z  
2025-11-09T23:42:54.6841155Z                                      // Send connection notification
2025-11-09T23:42:54.6841333Z                                      let quinn_transport_addr = TransportAddr::Quinn(socket_addr);
2025-11-09T23:42:54.6841559Z -                                    let _ = peer_tx.send(NetworkMessage::PeerConnected(quinn_transport_addr.clone()));
2025-11-09T23:42:54.6841830Z +                                    let _ = peer_tx.send(NetworkMessage::PeerConnected(
2025-11-09T23:42:54.6841943Z +                                        quinn_transport_addr.clone(),
2025-11-09T23:42:54.6842051Z +                                    ));
2025-11-09T23:42:54.6842163Z  
2025-11-09T23:42:54.6842475Z                                      // Handle connection in background with graceful error handling
2025-11-09T23:42:54.6842662Z                                      let peer_tx_clone = peer_tx.clone();
2025-11-09T23:42:54.6842974Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1029:
2025-11-09T23:42:54.6843648Z                                      tokio::spawn(async move {
2025-11-09T23:42:54.6843958Z                                          use crate::network::peer::Peer;
2025-11-09T23:42:54.6846390Z                                          use crate::network::transport::TransportAddr;
2025-11-09T23:42:54.6846750Z -                                        
2025-11-09T23:42:54.6846991Z +
2025-11-09T23:42:54.6847232Z                                          let quinn_addr = TransportAddr::Quinn(socket_addr);
2025-11-09T23:42:54.6847598Z                                          let peer = peer::Peer::from_transport_connection(
2025-11-09T23:42:54.6848071Z                                              conn,
2025-11-09T23:42:54.6848508Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1037:
2025-11-09T23:42:54.6848941Z                                              quinn_addr,
2025-11-09T23:42:54.6849211Z                                              peer_tx_clone.clone(),
2025-11-09T23:42:54.6849819Z                                          );
2025-11-09T23:42:54.6850067Z -                                        
2025-11-09T23:42:54.6850288Z +
2025-11-09T23:42:54.6850504Z                                          // Add peer to manager (with graceful error handling)
2025-11-09T23:42:54.6850832Z                                          match peer_manager_clone.lock() {
2025-11-09T23:42:54.6851117Z                                              Ok(mut pm) => {
2025-11-09T23:42:54.6851532Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1044:
2025-11-09T23:42:54.6852009Z -                                                if let Err(e) = pm.add_peer(quinn_addr.clone(), peer) {
2025-11-09T23:42:54.6852383Z -                                                    warn!("Failed to add Quinn peer {}: {}", socket_addr, e);
2025-11-09T23:42:54.6852843Z -                                                    let _ = peer_tx_clone.send(NetworkMessage::PeerDisconnected(quinn_addr.clone()));
2025-11-09T23:42:54.6853240Z +                                                if let Err(e) =
2025-11-09T23:42:54.6853531Z +                                                    pm.add_peer(quinn_addr.clone(), peer)
2025-11-09T23:42:54.6853822Z +                                                {
2025-11-09T23:42:54.6854070Z +                                                    warn!(
2025-11-09T23:42:54.6854492Z +                                                        "Failed to add Quinn peer {}: {}",
2025-11-09T23:42:54.6854789Z +                                                        socket_addr, e
2025-11-09T23:42:54.6856837Z +                                                    );
2025-11-09T23:42:54.6857113Z +                                                    let _ = peer_tx_clone.send(
2025-11-09T23:42:54.6857422Z +                                                        NetworkMessage::PeerDisconnected(
2025-11-09T23:42:54.6857725Z +                                                            quinn_addr.clone(),
2025-11-09T23:42:54.6857998Z +                                                        ),
2025-11-09T23:42:54.6858297Z +                                                    );
2025-11-09T23:42:54.6858559Z                                                      return;
2025-11-09T23:42:54.6858966Z                                                  }
2025-11-09T23:42:54.6859276Z -                                                info!("Successfully added Quinn peer {}", socket_addr);
2025-11-09T23:42:54.6859587Z +                                                info!(
2025-11-09T23:42:54.6859876Z +                                                    "Successfully added Quinn peer {}",
2025-11-09T23:42:54.6860170Z +                                                    socket_addr
2025-11-09T23:42:54.6860433Z +                                                );
2025-11-09T23:42:54.6860682Z                                              }
2025-11-09T23:42:54.6860926Z                                              Err(e) => {
2025-11-09T23:42:54.6861299Z                                                  warn!("Failed to lock peer manager for Quinn peer {}: {}", socket_addr, e);
2025-11-09T23:42:54.6861838Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1053:
2025-11-09T23:42:54.6862420Z -                                                let _ = peer_tx_clone.send(NetworkMessage::PeerDisconnected(quinn_addr.clone()));
2025-11-09T23:42:54.6862828Z +                                                let _ = peer_tx_clone.send(
2025-11-09T23:42:54.6863254Z +                                                    NetworkMessage::PeerDisconnected(
2025-11-09T23:42:54.6863563Z +                                                        quinn_addr.clone(),
2025-11-09T23:42:54.6863852Z +                                                    ),
2025-11-09T23:42:54.6864115Z +                                                );
2025-11-09T23:42:54.6864496Z                                                  return;
2025-11-09T23:42:54.6864738Z                                              }
2025-11-09T23:42:54.6864974Z                                          }
2025-11-09T23:42:54.6865384Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1065:
2025-11-09T23:42:54.6865792Z                      });
2025-11-09T23:42:54.6865985Z                  }
2025-11-09T23:42:54.6866163Z                  Err(e) => {
2025-11-09T23:42:54.6866473Z -                    warn!("Failed to start Quinn listener (graceful degradation): {}", e);
2025-11-09T23:42:54.6866801Z +                    warn!(
2025-11-09T23:42:54.6867082Z +                        "Failed to start Quinn listener (graceful degradation): {}",
2025-11-09T23:42:54.6867385Z +                        e
2025-11-09T23:42:54.6867583Z +                    );
2025-11-09T23:42:54.6867855Z                      // Continue with other transports - don't fail entire startup
2025-11-09T23:42:54.6868157Z                  }
2025-11-09T23:42:54.6868331Z              }
2025-11-09T23:42:54.6868676Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1107:
2025-11-09T23:42:54.6869125Z                                          let pm = peer_manager.lock().unwrap();
2025-11-09T23:42:54.6869414Z                                          pm.peer_count()
2025-11-09T23:42:54.6869664Z                                      };
2025-11-09T23:42:54.6870014Z -                                    if !dos_protection.check_active_connections(current_connections).await {
2025-11-09T23:42:54.6870388Z +                                    if !dos_protection
2025-11-09T23:42:54.6870686Z +                                        .check_active_connections(current_connections)
2025-11-09T23:42:54.6870977Z +                                        .await
2025-11-09T23:42:54.6871211Z +                                    {
2025-11-09T23:42:54.6871546Z                                          warn!("Active connection limit exceeded, rejecting Iroh connection");
2025-11-09T23:42:54.6871905Z                                          drop(conn);
2025-11-09T23:42:54.6872549Z                                          continue;
2025-11-09T23:42:54.6872966Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1114:
2025-11-09T23:42:54.6873555Z                                      }
2025-11-09T23:42:54.6873773Z  
2025-11-09T23:42:54.6874028Z                                      // Send connection notification using TransportAddr directly
2025-11-09T23:42:54.6874648Z -                                    let _ = peer_tx.send(NetworkMessage::PeerConnected(iroh_addr.clone()));
2025-11-09T23:42:54.6875033Z +                                    let _ = peer_tx
2025-11-09T23:42:54.6875361Z +                                        .send(NetworkMessage::PeerConnected(iroh_addr.clone()));
2025-11-09T23:42:54.6875662Z  
2025-11-09T23:42:54.6875915Z                                      // Handle connection in background with graceful error handling
2025-11-09T23:42:54.6876272Z                                      let peer_tx_clone = peer_tx.clone();
2025-11-09T23:42:54.6876721Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1121:
2025-11-09T23:42:54.6877194Z                                      let peer_manager_clone = Arc::clone(&peer_manager);
2025-11-09T23:42:54.6877526Z                                      let iroh_addr_clone = iroh_addr.clone();
2025-11-09T23:42:54.6877894Z -                                    let socket_to_transport_clone = Arc::clone(&socket_to_transport);
2025-11-09T23:42:54.6878382Z +                                    let socket_to_transport_clone =
2025-11-09T23:42:54.6878681Z +                                        Arc::clone(&socket_to_transport);
2025-11-09T23:42:54.6879026Z                                      let address_database_clone = Arc::clone(&address_database);
2025-11-09T23:42:54.6879368Z                                      tokio::spawn(async move {
2025-11-09T23:42:54.6879654Z                                          use crate::network::peer::Peer;
2025-11-09T23:42:54.6880092Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1127:
2025-11-09T23:42:54.6880505Z -                                        
2025-11-09T23:42:54.6880726Z +
2025-11-09T23:42:54.6880987Z                                          // For Iroh, we need a SocketAddr for Peer::from_transport_connection
2025-11-09T23:42:54.6881406Z                                          // Generate a unique placeholder based on key hash for lookups
2025-11-09T23:42:54.6881874Z -                                        let placeholder_socket = if let TransportAddr::Iroh(ref key) = iroh_addr_clone {
2025-11-09T23:42:54.6882385Z -                                            // Use first 4 bytes of key for IP, last 2 bytes for port to create unique placeholder
2025-11-09T23:42:54.6882785Z -                                            let ip_bytes = if key.len() >= 4 {
2025-11-09T23:42:54.6883083Z -                                                [key[0], key[1], key[2], key[3]]
2025-11-09T23:42:54.6883370Z +                                        let placeholder_socket =
2025-11-09T23:42:54.6883703Z +                                            if let TransportAddr::Iroh(ref key) = iroh_addr_clone {
2025-11-09T23:42:54.6884239Z +                                                // Use first 4 bytes of key for IP, last 2 bytes for port to create unique placeholder
2025-11-09T23:42:54.6887222Z +                                                let ip_bytes = if key.len() >= 4 {
2025-11-09T23:42:54.6887556Z +                                                    [key[0], key[1], key[2], key[3]]
2025-11-09T23:42:54.6887848Z +                                                } else {
2025-11-09T23:42:54.6888121Z +                                                    [0, 0, 0, 0]
2025-11-09T23:42:54.6888380Z +                                                };
2025-11-09T23:42:54.6888656Z +                                                let port = if key.len() >= 6 {
2025-11-09T23:42:54.6888964Z +                                                    u16::from_be_bytes([
2025-11-09T23:42:54.6889248Z +                                                        key[key.len() - 2],
2025-11-09T23:42:54.6889708Z +                                                        key[key.len() - 1],
2025-11-09T23:42:54.6889973Z +                                                    ])
2025-11-09T23:42:54.6890229Z +                                                } else {
2025-11-09T23:42:54.6890478Z +                                                    0
2025-11-09T23:42:54.6890735Z +                                                };
2025-11-09T23:42:54.6891033Z +                                                std::net::SocketAddr::from((ip_bytes, port))
2025-11-09T23:42:54.6891330Z                                              } else {
2025-11-09T23:42:54.6891588Z -                                                [0, 0, 0, 0]
2025-11-09T23:42:54.6891878Z +                                                std::net::SocketAddr::from(([0, 0, 0, 0], 0))
2025-11-09T23:42:54.6892172Z                                              };
2025-11-09T23:42:54.6892439Z -                                            let port = if key.len() >= 6 {
2025-11-09T23:42:54.6892793Z -                                                u16::from_be_bytes([key[key.len()-2], key[key.len()-1]])
2025-11-09T23:42:54.6893189Z -                                            } else {
2025-11-09T23:42:54.6893439Z -                                                0
2025-11-09T23:42:54.6893686Z -                                            };
2025-11-09T23:42:54.6894099Z -                                            std::net::SocketAddr::from((ip_bytes, port))
2025-11-09T23:42:54.6896427Z -                                        } else {
2025-11-09T23:42:54.6896718Z -                                            std::net::SocketAddr::from(([0, 0, 0, 0], 0))
2025-11-09T23:42:54.6897009Z -                                        };
2025-11-09T23:42:54.6897252Z -                                        
2025-11-09T23:42:54.6897474Z +
2025-11-09T23:42:54.6897705Z                                          let peer = peer::Peer::from_transport_connection(
2025-11-09T23:42:54.6898013Z                                              conn,
2025-11-09T23:42:54.6898284Z                                              placeholder_socket,
2025-11-09T23:42:54.6898727Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1150:
2025-11-09T23:42:54.6899173Z                                              iroh_addr_clone.clone(),
2025-11-09T23:42:54.6899467Z                                              peer_tx_clone.clone(),
2025-11-09T23:42:54.6899727Z                                          );
2025-11-09T23:42:54.6899967Z -                                        
2025-11-09T23:42:54.6900180Z +
2025-11-09T23:42:54.6900399Z                                          // Add peer to manager (with graceful error handling)
2025-11-09T23:42:54.6900997Z                                          match peer_manager_clone.lock() {
2025-11-09T23:42:54.6901293Z                                              Ok(mut pm) => {
2025-11-09T23:42:54.6901712Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1157:
2025-11-09T23:42:54.6902206Z -                                                if let Err(e) = pm.add_peer(iroh_addr_clone.clone(), peer) {
2025-11-09T23:42:54.6902541Z +                                                if let Err(e) =
2025-11-09T23:42:54.6902842Z +                                                    pm.add_peer(iroh_addr_clone.clone(), peer)
2025-11-09T23:42:54.6903140Z +                                                {
2025-11-09T23:42:54.6903412Z                                                      warn!("Failed to add Iroh peer: {}", e);
2025-11-09T23:42:54.6903854Z -                                                    let _ = peer_tx_clone.send(NetworkMessage::PeerDisconnected(iroh_addr_clone.clone()));
2025-11-09T23:42:54.6904400Z +                                                    let _ = peer_tx_clone.send(
2025-11-09T23:42:54.6904718Z +                                                        NetworkMessage::PeerDisconnected(
2025-11-09T23:42:54.6905181Z +                                                            iroh_addr_clone.clone(),
2025-11-09T23:42:54.6905459Z +                                                        ),
2025-11-09T23:42:54.6905716Z +                                                    );
2025-11-09T23:42:54.6905968Z                                                      return;
2025-11-09T23:42:54.6907742Z                                                  }
2025-11-09T23:42:54.6908126Z                                                  // Store mapping from placeholder SocketAddr to TransportAddr for Iroh lookups
2025-11-09T23:42:54.6908679Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1163:
2025-11-09T23:42:54.6909281Z -                                                socket_to_transport_clone.lock().unwrap().insert(placeholder_socket, iroh_addr_clone.clone());
2025-11-09T23:42:54.6909706Z -                                                
2025-11-09T23:42:54.6910013Z +                                                socket_to_transport_clone.lock().unwrap().insert(
2025-11-09T23:42:54.6910340Z +                                                    placeholder_socket,
2025-11-09T23:42:54.6910634Z +                                                    iroh_addr_clone.clone(),
2025-11-09T23:42:54.6910909Z +                                                );
2025-11-09T23:42:54.6911264Z +
2025-11-09T23:42:54.6911487Z                                                  // Store Iroh NodeId in address database
2025-11-09T23:42:54.6911870Z -                                                if let TransportAddr::Iroh(ref node_id_bytes) = iroh_addr_clone {
2025-11-09T23:42:54.6912266Z +                                                if let TransportAddr::Iroh(ref node_id_bytes) =
2025-11-09T23:42:54.6912579Z +                                                    iroh_addr_clone
2025-11-09T23:42:54.6912832Z +                                                {
2025-11-09T23:42:54.6913103Z                                                      if node_id_bytes.len() == 32 {
2025-11-09T23:42:54.6913400Z                                                          use iroh_net::NodeId;
2025-11-09T23:42:54.6913920Z -                                                        if let Ok(node_id) = NodeId::from_bytes(node_id_bytes) {
2025-11-09T23:42:54.6916339Z -                                                            let address_db_clone = address_database_clone.clone();
2025-11-09T23:42:54.6916676Z +                                                        if let Ok(node_id) =
2025-11-09T23:42:54.6916980Z +                                                            NodeId::from_bytes(node_id_bytes)
2025-11-09T23:42:54.6917265Z +                                                        {
2025-11-09T23:42:54.6917535Z +                                                            let address_db_clone =
2025-11-09T23:42:54.6917832Z +                                                                address_database_clone.clone();
2025-11-09T23:42:54.6918152Z                                                              tokio::spawn(async move {
2025-11-09T23:42:54.6918477Z -                                                                let mut db = address_db_clone.lock().unwrap();
2025-11-09T23:42:54.6918900Z -                                                                db.add_iroh_address(node_id, 0); // Services will be updated on version exchange
2025-11-09T23:42:54.6919302Z +                                                                let mut db = address_db_clone
2025-11-09T23:42:54.6919586Z +                                                                    .lock()
2025-11-09T23:42:54.6919863Z +                                                                    .unwrap();
2025-11-09T23:42:54.6920156Z +                                                                db.add_iroh_address(node_id, 0);
2025-11-09T23:42:54.6920482Z +                                                                // Services will be updated on version exchange
2025-11-09T23:42:54.6920927Z                                                              });
2025-11-09T23:42:54.6921187Z                                                          }
2025-11-09T23:42:54.6921438Z                                                      }
2025-11-09T23:42:54.6921863Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1177:
2025-11-09T23:42:54.6922286Z                                                  }
2025-11-09T23:42:54.6922528Z -                                                
2025-11-09T23:42:54.6922762Z +
2025-11-09T23:42:54.6923045Z                                                  info!("Successfully added Iroh peer (transport: {:?})", iroh_addr_clone);
2025-11-09T23:42:54.6923412Z                                              }
2025-11-09T23:42:54.6923659Z                                              Err(e) => {
2025-11-09T23:42:54.6924072Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1182:
2025-11-09T23:42:54.6924695Z -                                                warn!("Failed to lock peer manager for Iroh peer: {}", e);
2025-11-09T23:42:54.6925171Z -                                                let _ = peer_tx_clone.send(NetworkMessage::PeerDisconnected(iroh_addr_clone.clone()));
2025-11-09T23:42:54.6925727Z +                                                warn!(
2025-11-09T23:42:54.6926039Z +                                                    "Failed to lock peer manager for Iroh peer: {}",
2025-11-09T23:42:54.6926342Z +                                                    e
2025-11-09T23:42:54.6926589Z +                                                );
2025-11-09T23:42:54.6926854Z +                                                let _ = peer_tx_clone.send(
2025-11-09T23:42:54.6927167Z +                                                    NetworkMessage::PeerDisconnected(
2025-11-09T23:42:54.6927473Z +                                                        iroh_addr_clone.clone(),
2025-11-09T23:42:54.6927750Z +                                                    ),
2025-11-09T23:42:54.6927991Z +                                                );
2025-11-09T23:42:54.6928233Z                                                  return;
2025-11-09T23:42:54.6928521Z                                              }
2025-11-09T23:42:54.6928760Z                                          }
2025-11-09T23:42:54.6929175Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1195:
2025-11-09T23:42:54.6929581Z                      });
2025-11-09T23:42:54.6929770Z                  }
2025-11-09T23:42:54.6929945Z                  Err(e) => {
2025-11-09T23:42:54.6930248Z -                    warn!("Failed to start Iroh listener (graceful degradation): {}", e);
2025-11-09T23:42:54.6930576Z +                    warn!(
2025-11-09T23:42:54.6930848Z +                        "Failed to start Iroh listener (graceful degradation): {}",
2025-11-09T23:42:54.6931157Z +                        e
2025-11-09T23:42:54.6931352Z +                    );
2025-11-09T23:42:54.6931622Z                      // Continue with other transports - don't fail entire startup
2025-11-09T23:42:54.6931926Z                  }
2025-11-09T23:42:54.6932100Z              }
2025-11-09T23:42:54.6932449Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1203:
2025-11-09T23:42:54.6932856Z  
2025-11-09T23:42:54.6933041Z          // Start periodic ban cleanup task
2025-11-09T23:42:54.6933307Z          self.start_ban_cleanup_task();
2025-11-09T23:42:54.6933542Z -        
2025-11-09T23:42:54.6933697Z +
2025-11-09T23:42:54.6933880Z          // Start pending request cleanup task
2025-11-09T23:42:54.6936164Z          self.start_request_cleanup_task();
2025-11-09T23:42:54.6936404Z -        
2025-11-09T23:42:54.6936558Z +
2025-11-09T23:42:54.6936740Z          // Start DoS protection cleanup task
2025-11-09T23:42:54.6942682Z          self.start_dos_protection_cleanup_task();
2025-11-09T23:42:54.6943477Z -        
2025-11-09T23:42:54.6943658Z +
2025-11-09T23:42:54.6945976Z          // Note: Peer connection initialization (DNS seeds, persistent peers, etc.)
2025-11-09T23:42:54.6946479Z          // should be called separately via initialize_peer_connections() after start()
2025-11-09T23:42:54.6946974Z          // This allows the caller to provide config, network type, and target peer count
2025-11-09T23:42:54.6947520Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1216:
2025-11-09T23:42:54.6947930Z -        
2025-11-09T23:42:54.6948085Z +
2025-11-09T23:42:54.6948241Z          Ok(())
2025-11-09T23:42:54.6948406Z      }
2025-11-09T23:42:54.6948562Z -    
2025-11-09T23:42:54.6948710Z +
2025-11-09T23:42:54.6948963Z      /// Generate a new request ID for async request-response patterns
2025-11-09T23:42:54.6949338Z      pub fn generate_request_id(&self) -> u64 {
2025-11-09T23:42:54.6949666Z          let mut counter = self.request_id_counter.lock().unwrap();
2025-11-09T23:42:54.6950160Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1224:
2025-11-09T23:42:54.6950619Z          *counter = counter.wrapping_add(1);
2025-11-09T23:42:54.6950878Z          id
2025-11-09T23:42:54.6951046Z      }
2025-11-09T23:42:54.6951212Z -    
2025-11-09T23:42:54.6951369Z +
2025-11-09T23:42:54.6951777Z      /// Register a pending request and return the response receiver
2025-11-09T23:42:54.6952137Z      /// Returns (request_id, response_receiver)
2025-11-09T23:42:54.6952615Z -    pub fn register_request(&self, peer_addr: SocketAddr) -> (u64, tokio::sync::oneshot::Receiver<Vec<u8>>) {
2025-11-09T23:42:54.6953412Z +    pub fn register_request(
2025-11-09T23:42:54.6953636Z +        &self,
2025-11-09T23:42:54.6953840Z +        peer_addr: SocketAddr,
2025-11-09T23:42:54.6954122Z +    ) -> (u64, tokio::sync::oneshot::Receiver<Vec<u8>>) {
2025-11-09T23:42:54.6954647Z          self.register_request_with_priority(peer_addr, 0)
2025-11-09T23:42:54.6954938Z      }
2025-11-09T23:42:54.6955111Z -    
2025-11-09T23:42:54.6955272Z +
2025-11-09T23:42:54.6955569Z      /// Register a pending request with priority and return the response receiver
2025-11-09T23:42:54.6955963Z      /// Returns (request_id, response_receiver)
2025-11-09T23:42:54.6956268Z      /// Priority: 0 = normal, higher = more important
2025-11-09T23:42:54.6956987Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1237:
2025-11-09T23:42:54.6957701Z -    pub fn register_request_with_priority(&self, peer_addr: SocketAddr, priority: u8) -> (u64, tokio::sync::oneshot::Receiver<Vec<u8>>) {
2025-11-09T23:42:54.6958485Z +    pub fn register_request_with_priority(
2025-11-09T23:42:54.6958744Z +        &self,
2025-11-09T23:42:54.6958945Z +        peer_addr: SocketAddr,
2025-11-09T23:42:54.6959175Z +        priority: u8,
2025-11-09T23:42:54.6959421Z +    ) -> (u64, tokio::sync::oneshot::Receiver<Vec<u8>>) {
2025-11-09T23:42:54.6959741Z          let request_id = self.generate_request_id();
2025-11-09T23:42:54.6960055Z          let (tx, rx) = tokio::sync::oneshot::channel();
2025-11-09T23:42:54.6960319Z -        
2025-11-09T23:42:54.6960483Z +
2025-11-09T23:42:54.6960693Z          use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:42:54.6960979Z          let timestamp = SystemTime::now()
2025-11-09T23:42:54.6961250Z              .duration_since(UNIX_EPOCH)
2025-11-09T23:42:54.6961694Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1244:
2025-11-09T23:42:54.6962114Z              .unwrap()
2025-11-09T23:42:54.6962318Z              .as_secs();
2025-11-09T23:42:54.6962511Z -        
2025-11-09T23:42:54.6962680Z +
2025-11-09T23:42:54.6962869Z          let pending_req = PendingRequest {
2025-11-09T23:42:54.6963134Z              sender: tx,
2025-11-09T23:42:54.6963329Z              peer_addr,
2025-11-09T23:42:54.6963709Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1251:
2025-11-09T23:42:54.6966352Z              priority,
2025-11-09T23:42:54.6966573Z              retry_count: 0,
2025-11-09T23:42:54.6966792Z          };
2025-11-09T23:42:54.6966958Z -        
2025-11-09T23:42:54.6967254Z -        self.pending_requests.lock().unwrap().insert(request_id, pending_req);
2025-11-09T23:42:54.6967603Z +
2025-11-09T23:42:54.6967786Z +        self.pending_requests
2025-11-09T23:42:54.6968014Z +            .lock()
2025-11-09T23:42:54.6968212Z +            .unwrap()
2025-11-09T23:42:54.6968428Z +            .insert(request_id, pending_req);
2025-11-09T23:42:54.6968696Z          (request_id, rx)
2025-11-09T23:42:54.6968895Z      }
2025-11-09T23:42:54.6969058Z -    
2025-11-09T23:42:54.6969223Z +
2025-11-09T23:42:54.6969440Z      /// Complete a pending request by sending the response
2025-11-09T23:42:54.6969849Z      pub fn complete_request(&self, request_id: u64, response: Vec<u8>) -> bool {
2025-11-09T23:42:54.6970270Z          let mut pending = self.pending_requests.lock().unwrap();
2025-11-09T23:42:54.6970764Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1266:
2025-11-09T23:42:54.6971182Z              false
2025-11-09T23:42:54.6971371Z          }
2025-11-09T23:42:54.6971536Z      }
2025-11-09T23:42:54.6971702Z -    
2025-11-09T23:42:54.6971861Z +
2025-11-09T23:42:54.6972040Z      /// Cancel a pending request
2025-11-09T23:42:54.6972466Z      pub fn cancel_request(&self, request_id: u64) -> bool {
2025-11-09T23:42:54.6972826Z          let mut pending = self.pending_requests.lock().unwrap();
2025-11-09T23:42:54.6973305Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1273:
2025-11-09T23:42:54.6973743Z          pending.remove(&request_id).is_some()
2025-11-09T23:42:54.6973999Z      }
2025-11-09T23:42:54.6974158Z -    
2025-11-09T23:42:54.6974435Z +
2025-11-09T23:42:54.6974635Z      /// Get pending requests for a specific peer
2025-11-09T23:42:54.6975033Z      pub fn get_pending_requests_for_peer(&self, peer_addr: SocketAddr) -> Vec<u64> {
2025-11-09T23:42:54.6975470Z          let pending = self.pending_requests.lock().unwrap();
2025-11-09T23:42:54.6975926Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1279:
2025-11-09T23:42:54.6978035Z -        pending.iter()
2025-11-09T23:42:54.6978235Z +        pending
2025-11-09T23:42:54.6978420Z +            .iter()
2025-11-09T23:42:54.6978655Z              .filter(|(_, req)| req.peer_addr == peer_addr)
2025-11-09T23:42:54.6978941Z              .map(|(id, _)| *id)
2025-11-09T23:42:54.6979160Z              .collect()
2025-11-09T23:42:54.6979526Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1283:
2025-11-09T23:42:54.6979932Z      }
2025-11-09T23:42:54.6980091Z -    
2025-11-09T23:42:54.6980258Z +
2025-11-09T23:42:54.6980482Z      /// Clean up expired requests (older than max_age_seconds)
2025-11-09T23:42:54.6980884Z      pub fn cleanup_expired_requests(&self, max_age_seconds: u64) -> usize {
2025-11-09T23:42:54.6981261Z          use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:42:54.6981697Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1289:
2025-11-09T23:42:54.6982123Z              .duration_since(UNIX_EPOCH)
2025-11-09T23:42:54.6982375Z              .unwrap()
2025-11-09T23:42:54.6982578Z              .as_secs();
2025-11-09T23:42:54.6982779Z -        
2025-11-09T23:42:54.6982950Z +
2025-11-09T23:42:54.6983175Z          let mut pending = self.pending_requests.lock().unwrap();
2025-11-09T23:42:54.6983510Z -        let expired: Vec<u64> = pending.iter()
2025-11-09T23:42:54.6983784Z +        let expired: Vec<u64> = pending
2025-11-09T23:42:54.6984026Z +            .iter()
2025-11-09T23:42:54.6984430Z              .filter(|(_, req)| now.saturating_sub(req.timestamp) > max_age_seconds)
2025-11-09T23:42:54.6984778Z              .map(|(id, _)| *id)
2025-11-09T23:42:54.6984998Z              .collect();
2025-11-09T23:42:54.6985378Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1298:
2025-11-09T23:42:54.6985927Z -        
2025-11-09T23:42:54.6986090Z +
2025-11-09T23:42:54.6986263Z          for id in &expired {
2025-11-09T23:42:54.6986493Z              pending.remove(id);
2025-11-09T23:42:54.6986716Z          }
2025-11-09T23:42:54.6987060Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1302:
2025-11-09T23:42:54.6987867Z -        
2025-11-09T23:42:54.6988033Z +
2025-11-09T23:42:54.6988201Z          expired.len()
2025-11-09T23:42:54.6988392Z      }
2025-11-09T23:42:54.6988555Z -    
2025-11-09T23:42:54.6988719Z +
2025-11-09T23:42:54.6988951Z      /// Start periodic task to clean up expired pending requests
2025-11-09T23:42:54.6989286Z      fn start_request_cleanup_task(&self) {
2025-11-09T23:42:54.6989624Z          let pending_requests = Arc::clone(&self.pending_requests);
2025-11-09T23:42:54.6990114Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1309:
2025-11-09T23:42:54.6990533Z -        
2025-11-09T23:42:54.6990703Z +
2025-11-09T23:42:54.6990877Z          tokio::spawn(async move {
2025-11-09T23:42:54.6991249Z              let mut interval = tokio::time::interval(tokio::time::Duration::from_secs(60));
2025-11-09T23:42:54.6991614Z              loop {
2025-11-09T23:42:54.6992116Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1313:
2025-11-09T23:42:54.6992553Z                  interval.tick().await;
2025-11-09T23:42:54.6992792Z -                
2025-11-09T23:42:54.6992974Z +
2025-11-09T23:42:54.6993196Z                  // Clean up old pending requests (older than 5 minutes)
2025-11-09T23:42:54.6993540Z                  use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:42:54.6993829Z                  let now = SystemTime::now()
2025-11-09T23:42:54.6996232Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1319:
2025-11-09T23:42:54.6996647Z                      .unwrap()
2025-11-09T23:42:54.6996880Z                      .as_secs();
2025-11-09T23:42:54.6997125Z                  let timeout_seconds = 300; // 5 minutes
2025-11-09T23:42:54.6997378Z -                
2025-11-09T23:42:54.6997551Z +
2025-11-09T23:42:54.6997769Z                  let mut pending = pending_requests.lock().unwrap();
2025-11-09T23:42:54.6998077Z                  let initial_count = pending.len();
2025-11-09T23:42:54.6998360Z -                pending.retain(|_, req| {
2025-11-09T23:42:54.6998669Z -                    now.saturating_sub(req.timestamp) < timeout_seconds
2025-11-09T23:42:54.6998958Z -                });
2025-11-09T23:42:54.6999281Z +                pending.retain(|_, req| now.saturating_sub(req.timestamp) < timeout_seconds);
2025-11-09T23:42:54.6999681Z                  let removed = initial_count - pending.len();
2025-11-09T23:42:54.6999959Z                  if removed > 0 {
2025-11-09T23:42:54.7000345Z -                    debug!("Cleaned up {} stale pending requests (older than {}s)", removed, timeout_seconds);
2025-11-09T23:42:54.7000761Z +                    debug!(
2025-11-09T23:42:54.7001038Z +                        "Cleaned up {} stale pending requests (older than {}s)",
2025-11-09T23:42:54.7001359Z +                        removed, timeout_seconds
2025-11-09T23:42:54.7001613Z +                    );
2025-11-09T23:42:54.7001802Z                  }
2025-11-09T23:42:54.7002006Z                  if !pending.is_empty() {
2025-11-09T23:42:54.7002298Z                      debug!("Pending requests: {}", pending.len());
2025-11-09T23:42:54.7002765Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1335:
2025-11-09T23:42:54.7003179Z              }
2025-11-09T23:42:54.7003361Z          });
2025-11-09T23:42:54.7003531Z      }
2025-11-09T23:42:54.7003697Z -    
2025-11-09T23:42:54.7003866Z +
2025-11-09T23:42:54.7004082Z      /// Start periodic task to clean up DoS protection data
2025-11-09T23:42:54.7006364Z      fn start_dos_protection_cleanup_task(&self) {
2025-11-09T23:42:54.7006840Z          let dos_protection = Arc::clone(&self.dos_protection);
2025-11-09T23:42:54.7007308Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1342:
2025-11-09T23:42:54.7007755Z          let ban_list = Arc::clone(&self.ban_list);
2025-11-09T23:42:54.7008022Z -        
2025-11-09T23:42:54.7008187Z +
2025-11-09T23:42:54.7008372Z          tokio::spawn(async move {
2025-11-09T23:42:54.7008785Z              let mut interval = tokio::time::interval(tokio::time::Duration::from_secs(300)); // Every 5 minutes
2025-11-09T23:42:54.7009195Z              loop {
2025-11-09T23:42:54.7009554Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1347:
2025-11-09T23:42:54.7009976Z                  interval.tick().await;
2025-11-09T23:42:54.7010217Z -                
2025-11-09T23:42:54.7010389Z +
2025-11-09T23:42:54.7010594Z                  // Cleanup old connection rate limiter entries
2025-11-09T23:42:54.7010899Z                  dos_protection.cleanup().await;
2025-11-09T23:42:54.7011214Z -                
2025-11-09T23:42:54.7011394Z +
2025-11-09T23:42:54.7011584Z                  // Auto-ban IPs that should be banned
2025-11-09T23:42:54.7012013Z                  // Note: This is a simplified version - in production, you'd want more sophisticated logic
2025-11-09T23:42:54.7012452Z                  let dos_clone = Arc::clone(&dos_protection);
2025-11-09T23:42:54.7013124Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1361:
2025-11-09T23:42:54.7013539Z              }
2025-11-09T23:42:54.7013864Z          });
2025-11-09T23:42:54.7014040Z      }
2025-11-09T23:42:54.7014199Z -    
2025-11-09T23:42:54.7014475Z +
2025-11-09T23:42:54.7014679Z      /// Start periodic task to clean up expired bans
2025-11-09T23:42:54.7014971Z      fn start_ban_cleanup_task(&self) {
2025-11-09T23:42:54.7015255Z          let ban_list = Arc::clone(&self.ban_list);
2025-11-09T23:42:54.7015694Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1369:
2025-11-09T23:42:54.7016310Z              let mut interval = tokio::time::interval(tokio::time::Duration::from_secs(300)); // Every 5 minutes
2025-11-09T23:42:54.7016723Z              loop {
2025-11-09T23:42:54.7016920Z                  interval.tick().await;
2025-11-09T23:42:54.7017150Z -                
2025-11-09T23:42:54.7017331Z +
2025-11-09T23:42:54.7017530Z                  use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:42:54.7017823Z                  let now = SystemTime::now()
2025-11-09T23:42:54.7018090Z                      .duration_since(UNIX_EPOCH)
2025-11-09T23:42:54.7018516Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1376:
2025-11-09T23:42:54.7018928Z                      .unwrap()
2025-11-09T23:42:54.7019148Z                      .as_secs();
2025-11-09T23:42:54.7019364Z -                
2025-11-09T23:42:54.7019535Z +
2025-11-09T23:42:54.7019745Z                  let mut ban_list_guard = ban_list.lock().unwrap();
2025-11-09T23:42:54.7020071Z                  let expired: Vec<SocketAddr> = ban_list_guard
2025-11-09T23:42:54.7020350Z                      .iter()
2025-11-09T23:42:54.7020728Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1384:
2025-11-09T23:42:54.7021140Z                      })
2025-11-09T23:42:54.7021350Z                      .map(|(addr, _)| *addr)
2025-11-09T23:42:54.7021601Z                      .collect();
2025-11-09T23:42:54.7021819Z -                
2025-11-09T23:42:54.7021988Z +
2025-11-09T23:42:54.7022167Z                  for addr in expired {
2025-11-09T23:42:54.7022432Z                      ban_list_guard.remove(&addr);
2025-11-09T23:42:54.7022731Z                      debug!("Cleaned up expired ban for {}", addr);
2025-11-09T23:42:54.7023177Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1391:
2025-11-09T23:42:54.7023582Z                  }
2025-11-09T23:42:54.7023758Z -                
2025-11-09T23:42:54.7024091Z +
2025-11-09T23:42:54.7024266Z                  if !expired.is_empty() {
2025-11-09T23:42:54.7024697Z                      info!("Cleaned up {} expired ban(s)", expired.len());
2025-11-09T23:42:54.7024991Z                  }
2025-11-09T23:42:54.7025343Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1406:
2025-11-09T23:42:54.7025805Z      pub fn peer_addresses(&self) -> Vec<SocketAddr> {
2025-11-09T23:42:54.7026162Z          self.peer_manager.lock().unwrap().peer_socket_addresses()
2025-11-09T23:42:54.7026463Z      }
2025-11-09T23:42:54.7026618Z -    
2025-11-09T23:42:54.7026778Z +
2025-11-09T23:42:54.7026966Z      /// Get all peer addresses (as TransportAddr)
2025-11-09T23:42:54.7027316Z      pub fn peer_transport_addresses(&self) -> Vec<TransportAddr> {
2025-11-09T23:42:54.7027679Z          self.peer_manager.lock().unwrap().peer_addresses()
2025-11-09T23:42:54.7028138Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1429:
2025-11-09T23:42:54.7028657Z      /// Uses peer quality to prioritize reliable peers for critical messages
2025-11-09T23:42:54.7029139Z      pub async fn broadcast_with_quality_priority(&self, message: Vec<u8>) -> Result<()> {
2025-11-09T23:42:54.7029563Z          let pm = self.peer_manager.lock().unwrap();
2025-11-09T23:42:54.7029821Z -        
2025-11-09T23:42:54.7029985Z +
2025-11-09T23:42:54.7030285Z          // Get reliable peers first
2025-11-09T23:42:54.7030579Z          let reliable_peers = pm.select_reliable_peers();
2025-11-09T23:42:54.7030864Z          drop(pm);
2025-11-09T23:42:54.7031224Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1436:
2025-11-09T23:42:54.7031294Z -        
2025-11-09T23:42:54.7031364Z +
2025-11-09T23:42:54.7031459Z          // Send to reliable peers first
2025-11-09T23:42:54.7031549Z          for addr in &reliable_peers {
2025-11-09T23:42:54.7031761Z -            if let Err(e) = self.send_to_peer_by_transport(addr.clone(), message.clone()).await {
2025-11-09T23:42:54.7031848Z +            if let Err(e) = self
2025-11-09T23:42:54.7031992Z +                .send_to_peer_by_transport(addr.clone(), message.clone())
2025-11-09T23:42:54.7032070Z +                .await
2025-11-09T23:42:54.7032140Z +            {
2025-11-09T23:42:54.7032286Z                  warn!("Failed to send to reliable peer {:?}: {}", addr, e);
2025-11-09T23:42:54.7032357Z              }
2025-11-09T23:42:54.7032436Z          }
2025-11-09T23:42:54.7032683Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1443:
2025-11-09T23:42:54.7032753Z -        
2025-11-09T23:42:54.7032826Z +
2025-11-09T23:42:54.7032921Z          // Then send to remaining peers
2025-11-09T23:42:54.7033035Z          let pm = self.peer_manager.lock().unwrap();
2025-11-09T23:42:54.7033136Z          let all_peers = pm.peer_addresses();
2025-11-09T23:42:54.7033385Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1447:
2025-11-09T23:42:54.7033511Z -        let remaining_peers: Vec<_> = all_peers.iter()
2025-11-09T23:42:54.7033612Z +        let remaining_peers: Vec<_> = all_peers
2025-11-09T23:42:54.7033692Z +            .iter()
2025-11-09T23:42:54.7033813Z              .filter(|addr| !reliable_peers.contains(addr))
2025-11-09T23:42:54.7033892Z              .collect();
2025-11-09T23:42:54.7033970Z          drop(pm);
2025-11-09T23:42:54.7034220Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1451:
2025-11-09T23:42:54.7034410Z -        
2025-11-09T23:42:54.7034480Z +
2025-11-09T23:42:54.7034575Z          for addr in remaining_peers {
2025-11-09T23:42:54.7034775Z -            if let Err(e) = self.send_to_peer_by_transport(addr.clone(), message.clone()).await {
2025-11-09T23:42:54.7034858Z +            if let Err(e) = self
2025-11-09T23:42:54.7035003Z +                .send_to_peer_by_transport(addr.clone(), message.clone())
2025-11-09T23:42:54.7035075Z +                .await
2025-11-09T23:42:54.7035275Z +            {
2025-11-09T23:42:54.7035397Z                  warn!("Failed to send to peer {:?}: {}", addr, e);
2025-11-09T23:42:54.7035473Z              }
2025-11-09T23:42:54.7035542Z          }
2025-11-09T23:42:54.7035788Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1457:
2025-11-09T23:42:54.7035863Z -        
2025-11-09T23:42:54.7035935Z +
2025-11-09T23:42:54.7036007Z          Ok(())
2025-11-09T23:42:54.7036076Z      }
2025-11-09T23:42:54.7036149Z  
2025-11-09T23:42:54.7036399Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1464:
2025-11-09T23:42:54.7036515Z          let pm = self.peer_manager.lock().unwrap();
2025-11-09T23:42:54.7036627Z          let best_peers = pm.select_best_peers(1);
2025-11-09T23:42:54.7036700Z          drop(pm);
2025-11-09T23:42:54.7036769Z -        
2025-11-09T23:42:54.7036837Z +
2025-11-09T23:42:54.7036946Z          if let Some(addr) = best_peers.first() {
2025-11-09T23:42:54.7037106Z -            self.send_to_peer_by_transport(addr.clone(), message).await?;
2025-11-09T23:42:54.7037243Z +            self.send_to_peer_by_transport(addr.clone(), message)
2025-11-09T23:42:54.7037324Z +                .await?;
2025-11-09T23:42:54.7037406Z              Ok(addr.clone())
2025-11-09T23:42:54.7037479Z          } else {
2025-11-09T23:42:54.7037718Z              Err(anyhow::anyhow!("No peers available"))
2025-11-09T23:42:54.7037982Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1479:
2025-11-09T23:42:54.7038093Z          let pm = self.peer_manager.lock().unwrap();
2025-11-09T23:42:54.7038216Z          let reliable_peers = pm.select_reliable_peers();
2025-11-09T23:42:54.7038298Z          drop(pm);
2025-11-09T23:42:54.7038367Z -        
2025-11-09T23:42:54.7038435Z +
2025-11-09T23:42:54.7038528Z          if reliable_peers.is_empty() {
2025-11-09T23:42:54.7038690Z              return Err(anyhow::anyhow!("No reliable peers available"));
2025-11-09T23:42:54.7038764Z          }
2025-11-09T23:42:54.7039014Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1486:
2025-11-09T23:42:54.7039088Z -        
2025-11-09T23:42:54.7039156Z +
2025-11-09T23:42:54.7039248Z          // Select best reliable peer
2025-11-09T23:42:54.7039362Z          let pm = self.peer_manager.lock().unwrap();
2025-11-09T23:42:54.7039471Z -        let best_reliable = reliable_peers.iter()
2025-11-09T23:42:54.7039553Z -            .max_by(|a, b| {
2025-11-09T23:42:54.7039746Z -                let score_a = pm.get_peer(a).map(|p| p.quality_score()).unwrap_or(0.0);
2025-11-09T23:42:54.7039918Z -                let score_b = pm.get_peer(b).map(|p| p.quality_score()).unwrap_or(0.0);
2025-11-09T23:42:54.7040101Z -                score_a.partial_cmp(&score_b).unwrap_or(std::cmp::Ordering::Equal)
2025-11-09T23:42:54.7040172Z -            });
2025-11-09T23:42:54.7040324Z +        let best_reliable = reliable_peers.iter().max_by(|a, b| {
2025-11-09T23:42:54.7040497Z +            let score_a = pm.get_peer(a).map(|p| p.quality_score()).unwrap_or(0.0);
2025-11-09T23:42:54.7040658Z +            let score_b = pm.get_peer(b).map(|p| p.quality_score()).unwrap_or(0.0);
2025-11-09T23:42:54.7040736Z +            score_a
2025-11-09T23:42:54.7040828Z +                .partial_cmp(&score_b)
2025-11-09T23:42:54.7040941Z +                .unwrap_or(std::cmp::Ordering::Equal)
2025-11-09T23:42:54.7041014Z +        });
2025-11-09T23:42:54.7041096Z          drop(pm);
2025-11-09T23:42:54.7041166Z -        
2025-11-09T23:42:54.7041234Z +
2025-11-09T23:42:54.7041338Z          if let Some(addr) = best_reliable {
2025-11-09T23:42:54.7041497Z -            self.send_to_peer_by_transport(addr.clone(), message).await?;
2025-11-09T23:42:54.7041632Z +            self.send_to_peer_by_transport(addr.clone(), message)
2025-11-09T23:42:54.7041708Z +                .await?;
2025-11-09T23:42:54.7041795Z              Ok(addr.clone())
2025-11-09T23:42:54.7041867Z          } else {
2025-11-09T23:42:54.7042106Z              Err(anyhow::anyhow!("No reliable peers available"))
2025-11-09T23:42:54.7042373Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1509:
2025-11-09T23:42:54.7042461Z          let transport_addr = {
2025-11-09T23:42:54.7042577Z              let pm = self.peer_manager.lock().unwrap();
2025-11-09T23:42:54.7042689Z              pm.find_transport_addr_by_socket(addr)
2025-11-09T23:42:54.7042775Z -                .or_else(|| {
2025-11-09T23:42:54.7042938Z -                    self.socket_to_transport.lock().unwrap().get(&addr).cloned()
2025-11-09T23:42:54.7043010Z -                })
2025-11-09T23:42:54.7043196Z +                .or_else(|| self.socket_to_transport.lock().unwrap().get(&addr).cloned())
2025-11-09T23:42:54.7043266Z          };
2025-11-09T23:42:54.7043335Z -        
2025-11-09T23:42:54.7043407Z +
2025-11-09T23:42:54.7043523Z          if let Some(transport_addr) = transport_addr {
2025-11-09T23:42:54.7043678Z -            self.send_to_peer_by_transport(transport_addr, message).await
2025-11-09T23:42:54.7043823Z +            self.send_to_peer_by_transport(transport_addr, message)
2025-11-09T23:42:54.7043902Z +                .await
2025-11-09T23:42:54.7043973Z          } else {
2025-11-09T23:42:54.7044100Z              // Fallback: try TCP (for backward compatibility)
2025-11-09T23:42:54.7044566Z -            self.send_to_peer_by_transport(TransportAddr::Tcp(addr), message).await
2025-11-09T23:42:54.7044740Z +            self.send_to_peer_by_transport(TransportAddr::Tcp(addr), message)
2025-11-09T23:42:54.7044816Z +                .await
2025-11-09T23:42:54.7044891Z          }
2025-11-09T23:42:54.7044960Z      }
2025-11-09T23:42:54.7045028Z -    
2025-11-09T23:42:54.7045095Z +
2025-11-09T23:42:54.7045305Z      /// Send a message to a specific peer (by TransportAddr - supports all transports)
2025-11-09T23:42:54.7045564Z -    pub async fn send_to_peer_by_transport(&self, addr: TransportAddr, message: Vec<u8>) -> Result<()> {
2025-11-09T23:42:54.7045672Z +    pub async fn send_to_peer_by_transport(
2025-11-09T23:42:54.7045748Z +        &self,
2025-11-09T23:42:54.7045835Z +        addr: TransportAddr,
2025-11-09T23:42:54.7045915Z +        message: Vec<u8>,
2025-11-09T23:42:54.7045992Z +    ) -> Result<()> {
2025-11-09T23:42:54.7046096Z          let message_len = message.len();
2025-11-09T23:42:54.7046177Z          // Track bytes sent
2025-11-09T23:42:54.7046290Z          self.track_bytes_sent(message_len as u64);
2025-11-09T23:42:54.7046551Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1530:
2025-11-09T23:42:54.7046621Z -        
2025-11-09T23:42:54.7046690Z +
2025-11-09T23:42:54.7046809Z          let mut pm = self.peer_manager.lock().unwrap();
2025-11-09T23:42:54.7046926Z          if let Some(peer) = pm.get_peer_mut(&addr) {
2025-11-09T23:42:54.7047028Z              peer.send_message(message).await?;
2025-11-09T23:42:54.7047278Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1539:
2025-11-09T23:42:54.7047354Z      }
2025-11-09T23:42:54.7047422Z  
2025-11-09T23:42:54.7047519Z      /// Connect to a peer at the given address
2025-11-09T23:42:54.7047586Z -    /// 
2025-11-09T23:42:54.7047663Z +    ///
2025-11-09T23:42:54.7047862Z      /// Attempts to connect using available transports with graceful degradation:
2025-11-09T23:42:54.7048021Z      /// 1. Tries preferred transport (based on transport_preference)
2025-11-09T23:42:54.7048149Z      /// 2. Falls back to TCP if preferred transport fails
2025-11-09T23:42:54.7048397Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1547:
2025-11-09T23:42:54.7048567Z      pub async fn connect_to_peer(&self, addr: SocketAddr) -> Result<()> {
2025-11-09T23:42:54.7048672Z          use crate::network::peer::Peer;
2025-11-09T23:42:54.7048792Z          use crate::network::transport::TransportAddr;
2025-11-09T23:42:54.7048862Z -        
2025-11-09T23:42:54.7048928Z +
2025-11-09T23:42:54.7049142Z          // Check DoS protection: connection rate limiting (for outgoing connections too)
2025-11-09T23:42:54.7049379Z          let ip = addr.ip();
2025-11-09T23:42:54.7049510Z          if !self.dos_protection.check_connection(ip).await {
2025-11-09T23:42:54.7049766Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1554:
2025-11-09T23:42:54.7049998Z -            warn!("Connection rate limit exceeded for IP {}, rejecting outgoing connection", ip);
2025-11-09T23:42:54.7050072Z -            
2025-11-09T23:42:54.7050152Z +            warn!(
2025-11-09T23:42:54.7050350Z +                "Connection rate limit exceeded for IP {}, rejecting outgoing connection",
2025-11-09T23:42:54.7050423Z +                ip
2025-11-09T23:42:54.7050497Z +            );
2025-11-09T23:42:54.7050572Z +
2025-11-09T23:42:54.7050666Z              // Check if we should auto-ban
2025-11-09T23:42:54.7050796Z              if self.dos_protection.should_auto_ban(ip).await {
2025-11-09T23:42:54.7050986Z -                warn!("Auto-banning IP {} for repeated connection rate violations", ip);
2025-11-09T23:42:54.7051065Z +                warn!(
2025-11-09T23:42:54.7051223Z +                    "Auto-banning IP {} for repeated connection rate violations",
2025-11-09T23:42:54.7051302Z +                    ip
2025-11-09T23:42:54.7051373Z +                );
2025-11-09T23:42:54.7051453Z                  // Ban the IP
2025-11-09T23:42:54.7051682Z                  let unban_timestamp = std::time::SystemTime::now()
2025-11-09T23:42:54.7051802Z                      .duration_since(std::time::UNIX_EPOCH)
2025-11-09T23:42:54.7053943Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1564:
2025-11-09T23:42:54.7054035Z                      + 3600; // Ban for 1 hour
2025-11-09T23:42:54.7054166Z                  let mut ban_list = self.ban_list.lock().unwrap();
2025-11-09T23:42:54.7054397Z                  ban_list.insert(addr, unban_timestamp);
2025-11-09T23:42:54.7054620Z -                return Err(anyhow::anyhow!("IP {} is banned due to connection rate violations", ip));
2025-11-09T23:42:54.7054729Z +                return Err(anyhow::anyhow!(
2025-11-09T23:42:54.7054857Z +                    "IP {} is banned due to connection rate violations",
2025-11-09T23:42:54.7054940Z +                    ip
2025-11-09T23:42:54.7055013Z +                ));
2025-11-09T23:42:54.7055080Z              }
2025-11-09T23:42:54.7055154Z -            
2025-11-09T23:42:54.7055358Z -            return Err(anyhow::anyhow!("Connection rate limit exceeded for IP {}", ip));
2025-11-09T23:42:54.7055428Z +
2025-11-09T23:42:54.7055523Z +            return Err(anyhow::anyhow!(
2025-11-09T23:42:54.7055647Z +                "Connection rate limit exceeded for IP {}",
2025-11-09T23:42:54.7055718Z +                ip
2025-11-09T23:42:54.7055787Z +            ));
2025-11-09T23:42:54.7055862Z          }
2025-11-09T23:42:54.7055930Z -        
2025-11-09T23:42:54.7055996Z +
2025-11-09T23:42:54.7056118Z          // Eclipse attack prevention: check IP diversity
2025-11-09T23:42:54.7056235Z          if !self.check_eclipse_prevention(ip) {
2025-11-09T23:42:54.7056342Z              let prefix = self.get_ip_prefix(ip);
2025-11-09T23:42:54.7056592Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1576:
2025-11-09T23:42:54.7056893Z              warn!("Eclipse attack prevention: too many connections from IP range {:?}, rejecting connection from {}", 
2025-11-09T23:42:54.7056980Z                    prefix, ip);
2025-11-09T23:42:54.7057238Z -            return Err(anyhow::anyhow!("Eclipse attack prevention: too many connections from IP range"));
2025-11-09T23:42:54.7057336Z +            return Err(anyhow::anyhow!(
2025-11-09T23:42:54.7057506Z +                "Eclipse attack prevention: too many connections from IP range"
2025-11-09T23:42:54.7057578Z +            ));
2025-11-09T23:42:54.7057647Z          }
2025-11-09T23:42:54.7057723Z -        
2025-11-09T23:42:54.7057791Z +
2025-11-09T23:42:54.7057880Z          let mut last_error = None;
2025-11-09T23:42:54.7058083Z -        
2025-11-09T23:42:54.7058155Z +
2025-11-09T23:42:54.7058314Z          // Try transports in preference order with graceful degradation
2025-11-09T23:42:54.7058473Z          let transports_to_try = self.get_transports_for_connection();
2025-11-09T23:42:54.7058547Z -        
2025-11-09T23:42:54.7058618Z +
2025-11-09T23:42:54.7058728Z          for transport_type in transports_to_try {
2025-11-09T23:42:54.7058909Z              match self.try_connect_with_transport(&transport_type, addr).await {
2025-11-09T23:42:54.7059009Z                  Ok((peer, transport_addr)) => {
2025-11-09T23:42:54.7059262Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1591:
2025-11-09T23:42:54.7059391Z                          let mut pm = self.peer_manager.lock().unwrap();
2025-11-09T23:42:54.7059516Z                          pm.add_peer(transport_addr.clone(), peer)?;
2025-11-09T23:42:54.7059590Z                      }
2025-11-09T23:42:54.7059667Z -                    
2025-11-09T23:42:54.7059741Z +
2025-11-09T23:42:54.7059918Z                      // Note: Peer handler is managed by Peer::from_transport_connection
2025-11-09T23:42:54.7060035Z                      // No need to spawn additional handler task
2025-11-09T23:42:54.7060113Z -                    
2025-11-09T23:42:54.7060499Z -                    info!("Successfully connected to {} via {:?} (transport: {:?})", addr, transport_type, transport_addr);
2025-11-09T23:42:54.7060572Z +
2025-11-09T23:42:54.7060652Z +                    info!(
2025-11-09T23:42:54.7060818Z +                        "Successfully connected to {} via {:?} (transport: {:?})",
2025-11-09T23:42:54.7060931Z +                        addr, transport_type, transport_addr
2025-11-09T23:42:54.7061005Z +                    );
2025-11-09T23:42:54.7061094Z                      return Ok(());
2025-11-09T23:42:54.7061167Z                  }
2025-11-09T23:42:54.7061247Z                  Err(e) => {
2025-11-09T23:42:54.7061510Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1602:
2025-11-09T23:42:54.7061693Z -                    warn!("Failed to connect to {} via {:?}: {}", addr, transport_type, e);
2025-11-09T23:42:54.7061769Z +                    warn!(
2025-11-09T23:42:54.7061878Z +                        "Failed to connect to {} via {:?}: {}",
2025-11-09T23:42:54.7061985Z +                        addr, transport_type, e
2025-11-09T23:42:54.7062059Z +                    );
2025-11-09T23:42:54.7062151Z                      last_error = Some(e);
2025-11-09T23:42:54.7062254Z                      // Continue to next transport
2025-11-09T23:42:54.7062325Z                  }
2025-11-09T23:42:54.7062577Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1606:
2025-11-09T23:42:54.7062648Z              }
2025-11-09T23:42:54.7062725Z          }
2025-11-09T23:42:54.7062794Z -        
2025-11-09T23:42:54.7062864Z +
2025-11-09T23:42:54.7062961Z          // All transports failed
2025-11-09T23:42:54.7063178Z          Err(last_error.unwrap_or_else(|| anyhow::anyhow!("All transport attempts failed")))
2025-11-09T23:42:54.7063259Z      }
2025-11-09T23:42:54.7063688Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1612:
2025-11-09T23:42:54.7063785Z -    
2025-11-09T23:42:54.7063856Z +
2025-11-09T23:42:54.7064002Z      /// Helper: Get list of transports to try for a connection
2025-11-09T23:42:54.7066248Z      fn get_transports_for_connection(&self) -> Vec<crate::network::transport::TransportType> {
2025-11-09T23:42:54.7066351Z          let mut transports = Vec::new();
2025-11-09T23:42:54.7066598Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1616:
2025-11-09T23:42:54.7066673Z -        
2025-11-09T23:42:54.7066742Z +
2025-11-09T23:42:54.7066845Z          // Add transports in preference order
2025-11-09T23:42:54.7066960Z          if self.transport_preference.allows_tcp() {
2025-11-09T23:42:54.7067295Z              transports.push(crate::network::transport::TransportType::Tcp);
2025-11-09T23:42:54.7067544Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1620:
2025-11-09T23:42:54.7067617Z          }
2025-11-09T23:42:54.7067692Z -        
2025-11-09T23:42:54.7067761Z +
2025-11-09T23:42:54.7067848Z          #[cfg(feature = "quinn")]
2025-11-09T23:42:54.7067968Z          if self.transport_preference.allows_quinn() {
2025-11-09T23:42:54.7068095Z              if let Some(ref _quinn) = self.quinn_transport {
2025-11-09T23:42:54.7068338Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1625:
2025-11-09T23:42:54.7068521Z                  transports.push(crate::network::transport::TransportType::Quinn);
2025-11-09T23:42:54.7068597Z              }
2025-11-09T23:42:54.7068674Z          }
2025-11-09T23:42:54.7068750Z -        
2025-11-09T23:42:54.7068818Z +
2025-11-09T23:42:54.7068906Z          #[cfg(feature = "iroh")]
2025-11-09T23:42:54.7069034Z          if self.transport_preference.allows_iroh() {
2025-11-09T23:42:54.7069153Z              if let Some(ref _iroh) = self.iroh_transport {
2025-11-09T23:42:54.7069399Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1632:
2025-11-09T23:42:54.7074033Z                  transports.push(crate::network::transport::TransportType::Iroh);
2025-11-09T23:42:54.7074470Z              }
2025-11-09T23:42:54.7074562Z          }
2025-11-09T23:42:54.7074637Z -        
2025-11-09T23:42:54.7074709Z +
2025-11-09T23:42:54.7074862Z          // Always try TCP as fallback if not already in list
2025-11-09T23:42:54.7075133Z -        if !transports.iter().any(|t| matches!(t, crate::network::transport::TransportType::Tcp)) {
2025-11-09T23:42:54.7075217Z +        if !transports
2025-11-09T23:42:54.7075293Z +            .iter()
2025-11-09T23:42:54.7075481Z +            .any(|t| matches!(t, crate::network::transport::TransportType::Tcp))
2025-11-09T23:42:54.7075556Z +        {
2025-11-09T23:42:54.7075752Z              transports.push(crate::network::transport::TransportType::Tcp);
2025-11-09T23:42:54.7075829Z          }
2025-11-09T23:42:54.7075901Z -        
2025-11-09T23:42:54.7075970Z +
2025-11-09T23:42:54.7076047Z          transports
2025-11-09T23:42:54.7076123Z      }
2025-11-09T23:42:54.7076192Z -    
2025-11-09T23:42:54.7076260Z +
2025-11-09T23:42:54.7076396Z      /// Helper: Try connecting with a specific transport
2025-11-09T23:42:54.7076874Z -    async fn try_connect_with_transport(&self, transport_type: &crate::network::transport::TransportType, addr: SocketAddr) -> Result<(peer::Peer, TransportAddr)> {
2025-11-09T23:42:54.7076999Z -        use crate::network::transport::TransportAddr;
2025-11-09T23:42:54.7077101Z +    async fn try_connect_with_transport(
2025-11-09T23:42:54.7077179Z +        &self,
2025-11-09T23:42:54.7077340Z +        transport_type: &crate::network::transport::TransportType,
2025-11-09T23:42:54.7077427Z +        addr: SocketAddr,
2025-11-09T23:42:54.7077552Z +    ) -> Result<(peer::Peer, TransportAddr)> {
2025-11-09T23:42:54.7077652Z          use crate::network::peer::Peer;
2025-11-09T23:42:54.7077724Z -        
2025-11-09T23:42:54.7077847Z +        use crate::network::transport::TransportAddr;
2025-11-09T23:42:54.7077924Z +
2025-11-09T23:42:54.7078015Z          match transport_type {
2025-11-09T23:42:54.7078156Z              crate::network::transport::TransportType::Tcp => {
2025-11-09T23:42:54.7078298Z                  // Use TcpTransport to create connection properly
2025-11-09T23:42:54.7078571Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1684:
2025-11-09T23:42:54.7078710Z              crate::network::transport::TransportType::Iroh => {
2025-11-09T23:42:54.7078831Z                  // Iroh requires public key, not SocketAddr
2025-11-09T23:42:54.7079017Z                  // For now, return error - would need peer discovery or address resolution
2025-11-09T23:42:54.7079212Z -                Err(anyhow::anyhow!("Iroh transport requires public key, not SocketAddr"))
2025-11-09T23:42:54.7079440Z +                Err(anyhow::anyhow!(
2025-11-09T23:42:54.7079589Z +                    "Iroh transport requires public key, not SocketAddr"
2025-11-09T23:42:54.7079662Z +                ))
2025-11-09T23:42:54.7079734Z              }
2025-11-09T23:42:54.7079810Z          }
2025-11-09T23:42:54.7079880Z      }
2025-11-09T23:42:54.7080142Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1691:
2025-11-09T23:42:54.7080219Z -    
2025-11-09T23:42:54.7080288Z +
2025-11-09T23:42:54.7080397Z      /// Send ping message to all connected peers
2025-11-09T23:42:54.7080525Z      pub async fn ping_all_peers(&self) -> Result<()> {
2025-11-09T23:42:54.7080746Z -        use crate::network::protocol::{ProtocolMessage, ProtocolParser, PingMessage};
2025-11-09T23:42:54.7080950Z +        use crate::network::protocol::{PingMessage, ProtocolMessage, ProtocolParser};
2025-11-09T23:42:54.7081055Z          use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:42:54.7081137Z -        
2025-11-09T23:42:54.7081206Z +
2025-11-09T23:42:54.7081298Z          // Generate nonce for ping
2025-11-09T23:42:54.7081394Z          let nonce = SystemTime::now()
2025-11-09T23:42:54.7081498Z              .duration_since(UNIX_EPOCH)
2025-11-09T23:42:54.7081876Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1700:
2025-11-09T23:42:54.7081957Z              .unwrap()
2025-11-09T23:42:54.7082049Z              .as_nanos() as u64;
2025-11-09T23:42:54.7082120Z -        
2025-11-09T23:42:54.7082188Z +
2025-11-09T23:42:54.7082351Z          let ping_msg = ProtocolMessage::Ping(PingMessage { nonce });
2025-11-09T23:42:54.7082514Z          let wire_msg = ProtocolParser::serialize_message(&ping_msg)?;
2025-11-09T23:42:54.7082584Z -        
2025-11-09T23:42:54.7082653Z +
2025-11-09T23:42:54.7082827Z          let peer_addrs = self.peer_manager.lock().unwrap().peer_addresses();
2025-11-09T23:42:54.7082918Z          for addr in peer_addrs {
2025-11-09T23:42:54.7083165Z              // Convert TransportAddr to SocketAddr for send_to_peer, or use send_to_peer_by_transport
2025-11-09T23:42:54.7083425Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1726:
2025-11-09T23:42:54.7083499Z                  }
2025-11-09T23:42:54.7083570Z              }
2025-11-09T23:42:54.7083644Z          }
2025-11-09T23:42:54.7083719Z -        
2025-11-09T23:42:54.7083786Z +
2025-11-09T23:42:54.7083858Z          Ok(())
2025-11-09T23:42:54.7083933Z      }
2025-11-09T23:42:54.7084001Z  
2025-11-09T23:42:54.7084248Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1761:
2025-11-09T23:42:54.7084566Z          // Track message queue size manually (unbounded channel doesn't have len())
2025-11-09T23:42:54.7084667Z          let mut message_count = 0u64;
2025-11-09T23:42:54.7084819Z          let mut last_metrics_update = std::time::SystemTime::now();
2025-11-09T23:42:54.7084894Z -        
2025-11-09T23:42:54.7084971Z +
2025-11-09T23:42:54.7085103Z          while let Some(message) = self.peer_rx.recv().await {
2025-11-09T23:42:54.7085189Z              message_count += 1;
2025-11-09T23:42:54.7085265Z -            
2025-11-09T23:42:54.7085335Z +
2025-11-09T23:42:54.7085499Z              // Update metrics periodically (every 100 messages or 10 seconds)
2025-11-09T23:42:54.7085614Z              let now = std::time::SystemTime::now();
2025-11-09T23:42:54.7085737Z -            let should_update = message_count % 100 == 0 
2025-11-09T23:42:54.7085851Z +            let should_update = message_count % 100 == 0
2025-11-09T23:42:54.7086021Z                  || now.duration_since(last_metrics_update).unwrap().as_secs() >= 10;
2025-11-09T23:42:54.7086097Z -            
2025-11-09T23:42:54.7086164Z +
2025-11-09T23:42:54.7086255Z              if should_update {
2025-11-09T23:42:54.7086374Z                  let pm = self.peer_manager.lock().unwrap();
2025-11-09T23:42:54.7086491Z                  let active_connections = pm.peer_count();
2025-11-09T23:42:54.7086940Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1776:
2025-11-09T23:42:54.7087092Z                  let bytes_received = *self.bytes_received.lock().unwrap();
2025-11-09T23:42:54.7087224Z                  let bytes_sent = *self.bytes_sent.lock().unwrap();
2025-11-09T23:42:54.7087301Z -                
2025-11-09T23:42:54.7087372Z +
2025-11-09T23:42:54.7087543Z                  // Approximate queue size (messages processed since last check)
2025-11-09T23:42:54.7087651Z                  let queue_size = message_count as usize;
2025-11-09T23:42:54.7087722Z -                
2025-11-09T23:42:54.7087789Z +
2025-11-09T23:42:54.7087895Z                  // Check message queue size limit
2025-11-09T23:42:54.7088071Z -                if !self.dos_protection.check_message_queue_size(queue_size).await {
2025-11-09T23:42:54.7088330Z -                    warn!("Message queue size limit exceeded (processed {} messages), potential DoS", queue_size);
2025-11-09T23:42:54.7088416Z +                if !self
2025-11-09T23:42:54.7088504Z +                    .dos_protection
2025-11-09T23:42:54.7088607Z +                    .check_message_queue_size(queue_size)
2025-11-09T23:42:54.7088684Z +                    .await
2025-11-09T23:42:54.7088760Z +                {
2025-11-09T23:42:54.7089017Z +                    warn!(
2025-11-09T23:42:54.7089235Z +                        "Message queue size limit exceeded (processed {} messages), potential DoS",
2025-11-09T23:42:54.7089322Z +                        queue_size
2025-11-09T23:42:54.7089396Z +                    );
2025-11-09T23:42:54.7089497Z                      // Optionally detect DoS attack
2025-11-09T23:42:54.7089639Z                      if self.dos_protection.detect_dos_attack().await {
2025-11-09T23:42:54.7089846Z                          warn!("DoS attack detected - message queue and connections at high levels");
2025-11-09T23:42:54.7090106Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1790:
2025-11-09T23:42:54.7090229Z                      // Reset counter to prevent false positives
2025-11-09T23:42:54.7090324Z                      message_count = 0;
2025-11-09T23:42:54.7090394Z                  }
2025-11-09T23:42:54.7090464Z -                
2025-11-09T23:42:54.7090581Z -                self.dos_protection.update_metrics(
2025-11-09T23:42:54.7090671Z -                    active_connections,
2025-11-09T23:42:54.7090753Z -                    queue_size,
2025-11-09T23:42:54.7090844Z -                    bytes_received,
2025-11-09T23:42:54.7090922Z -                    bytes_sent,
2025-11-09T23:42:54.7090999Z -                ).await;
2025-11-09T23:42:54.7091069Z -                
2025-11-09T23:42:54.7091144Z +
2025-11-09T23:42:54.7091229Z +                self.dos_protection
2025-11-09T23:42:54.7091435Z +                    .update_metrics(active_connections, queue_size, bytes_received, bytes_sent)
2025-11-09T23:42:54.7091519Z +                    .await;
2025-11-09T23:42:54.7091587Z +
2025-11-09T23:42:54.7091683Z                  last_metrics_update = now;
2025-11-09T23:42:54.7091790Z                  message_count = 0; // Reset after update
2025-11-09T23:42:54.7091868Z              }
2025-11-09T23:42:54.7092123Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1811:
2025-11-09T23:42:54.7092253Z                      let mut pm = self.peer_manager.lock().unwrap();
2025-11-09T23:42:54.7092371Z                      // Remove peer directly using TransportAddr
2025-11-09T23:42:54.7092465Z                      pm.remove_peer(&addr);
2025-11-09T23:42:54.7092538Z -                    
2025-11-09T23:42:54.7092607Z +
2025-11-09T23:42:54.7092777Z                      // Clean up per-IP connection count (only for TCP/Quinn, not Iroh)
2025-11-09T23:42:54.7092877Z                      if let Some(ip) = match &addr {
2025-11-09T23:42:54.7093006Z                          TransportAddr::Tcp(sock) => Some(sock.ip()),
2025-11-09T23:42:54.7093365Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1828:
2025-11-09T23:42:54.7093446Z                              }
2025-11-09T23:42:54.7093521Z                          }
2025-11-09T23:42:54.7093597Z                      }
2025-11-09T23:42:54.7093668Z -                    
2025-11-09T23:42:54.7093738Z +
2025-11-09T23:42:54.7093931Z                      // Clean up rate limiter (use SocketAddr for TCP/Quinn, or a key for Iroh)
2025-11-09T23:42:54.7094007Z                      {
2025-11-09T23:42:54.7094154Z                          let mut rates = self.peer_message_rates.lock().unwrap();
2025-11-09T23:42:54.7094537Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1844:
2025-11-09T23:42:54.7094647Z                              rates.remove(&sock_addr);
2025-11-09T23:42:54.7094723Z                          }
2025-11-09T23:42:54.7094795Z                      }
2025-11-09T23:42:54.7094866Z -                    
2025-11-09T23:42:54.7094947Z +
2025-11-09T23:42:54.7095067Z                      // Clean up eclipse attack prevention tracking
2025-11-09T23:42:54.7095164Z                      if let Some(ip) = match &addr {
2025-11-09T23:42:54.7095295Z                          TransportAddr::Tcp(sock) => Some(sock.ip()),
2025-11-09T23:42:54.7095666Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1967:
2025-11-09T23:42:54.7095741Z                      {
2025-11-09T23:42:54.7095875Z                          let mut pm = self.peer_manager.lock().unwrap();
2025-11-09T23:42:54.7096035Z                          // Try to find peer by SocketAddr (TCP or Quinn, or Iroh mapping)
2025-11-09T23:42:54.7096207Z -                        let transport_addr = pm.find_transport_addr_by_socket(peer_addr)
2025-11-09T23:42:54.7096301Z -                            .or_else(|| {
2025-11-09T23:42:54.7096395Z +                        let transport_addr =
2025-11-09T23:42:54.7096542Z +                            pm.find_transport_addr_by_socket(peer_addr).or_else(|| {
2025-11-09T23:42:54.7096643Z                                  // Check Iroh mapping
2025-11-09T23:42:54.7096828Z -                                self.socket_to_transport.lock().unwrap().get(&peer_addr).cloned()
2025-11-09T23:42:54.7096931Z +                                self.socket_to_transport
2025-11-09T23:42:54.7097022Z +                                    .lock()
2025-11-09T23:42:54.7097114Z +                                    .unwrap()
2025-11-09T23:42:54.7097209Z +                                    .get(&peer_addr)
2025-11-09T23:42:54.7097291Z +                                    .cloned()
2025-11-09T23:42:54.7097376Z                              });
2025-11-09T23:42:54.7097500Z                          if let Some(transport_addr) = transport_addr {
2025-11-09T23:42:54.7097642Z                              if let Some(peer) = pm.get_peer_mut(&transport_addr) {
2025-11-09T23:42:54.7097893Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1978:
2025-11-09T23:42:54.7097981Z                              }
2025-11-09T23:42:54.7098056Z                          }
2025-11-09T23:42:54.7098126Z                      }
2025-11-09T23:42:54.7098202Z -                    
2025-11-09T23:42:54.7098270Z +
2025-11-09T23:42:54.7098386Z                      // Check rate limiting before processing
2025-11-09T23:42:54.7098535Z                      let mut rates = self.peer_message_rates.lock().unwrap();
2025-11-09T23:42:54.7098694Z                      let rate_limiter = rates.entry(peer_addr).or_insert_with(|| {
2025-11-09T23:42:54.7098948Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1985:
2025-11-09T23:42:54.7099058Z                          // Default: 100 burst, 10 messages/second
2025-11-09T23:42:54.7099170Z                          PeerRateLimiter::new(100, 10)
2025-11-09T23:42:54.7099244Z                      });
2025-11-09T23:42:54.7099316Z -                    
2025-11-09T23:42:54.7099516Z +
2025-11-09T23:42:54.7099628Z                      if !rate_limiter.check_and_consume() {
2025-11-09T23:42:54.7099815Z -                        warn!("Rate limit exceeded for peer {}, dropping message", peer_addr);
2025-11-09T23:42:54.7099894Z +                        warn!(
2025-11-09T23:42:54.7100038Z +                            "Rate limit exceeded for peer {}, dropping message",
2025-11-09T23:42:54.7100123Z +                            peer_addr
2025-11-09T23:42:54.7100198Z +                        );
2025-11-09T23:42:54.7100358Z                          // Optionally ban peer after repeated rate limit violations
2025-11-09T23:42:54.7100459Z                          // For now, just drop the message
2025-11-09T23:42:54.7100541Z                          continue;
2025-11-09T23:42:54.7100801Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:1994:
2025-11-09T23:42:54.7100874Z                      }
2025-11-09T23:42:54.7100956Z                      drop(rates);
2025-11-09T23:42:54.7101035Z -                    
2025-11-09T23:42:54.7101108Z +
2025-11-09T23:42:54.7101309Z                      // Check if this is a response to a pending request (UTXOSet or FilteredBlock)
2025-11-09T23:42:54.7101492Z                      // Extract request_id from message and route to correct pending request
2025-11-09T23:42:54.7101743Z                      if let Ok(parsed) = ProtocolParser::parse_message(&data) {
2025-11-09T23:42:54.7101998Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2002:
2025-11-09T23:42:54.7102172Z                              ProtocolMessage::FilteredBlock(msg) => Some(msg.request_id),
2025-11-09T23:42:54.7102259Z                              _ => None,
2025-11-09T23:42:54.7102335Z                          };
2025-11-09T23:42:54.7102408Z -                        
2025-11-09T23:42:54.7102477Z +
2025-11-09T23:42:54.7102597Z                          if let Some(request_id) = request_id_opt {
2025-11-09T23:42:54.7102715Z                              // Route to pending request by request_id
2025-11-09T23:42:54.7102865Z                              let mut pending = self.pending_requests.lock().unwrap();
2025-11-09T23:42:54.7103119Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2015:
2025-11-09T23:42:54.7103194Z                              }
2025-11-09T23:42:54.7103272Z                          }
2025-11-09T23:42:54.7103347Z                      }
2025-11-09T23:42:54.7103420Z -                    
2025-11-09T23:42:54.7103491Z +
2025-11-09T23:42:54.7103597Z                      // Process through protocol layer
2025-11-09T23:42:54.7103769Z                      if let Err(e) = self.handle_incoming_wire_tcp(peer_addr, data).await {
2025-11-09T23:42:54.7103921Z                          warn!("Failed to process message from {}: {}", peer_addr, e);
2025-11-09T23:42:54.7104166Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2034:
2025-11-09T23:42:54.7104418Z      /// 3. Creates NodeChainAccess from storage modules
2025-11-09T23:42:54.7104572Z      /// 4. Calls bllvm_protocol::network::process_network_message()
2025-11-09T23:42:54.7104763Z      /// 5. Converts NetworkResponse back to wire format and enqueues for sending
2025-11-09T23:42:54.7105031Z -    pub async fn handle_incoming_wire_tcp(&self, peer_addr: SocketAddr, data: Vec<u8>) -> Result<()> {
2025-11-09T23:42:54.7105133Z +    pub async fn handle_incoming_wire_tcp(
2025-11-09T23:42:54.7105206Z +        &self,
2025-11-09T23:42:54.7105293Z +        peer_addr: SocketAddr,
2025-11-09T23:42:54.7105374Z +        data: Vec<u8>,
2025-11-09T23:42:54.7105453Z +    ) -> Result<()> {
2025-11-09T23:42:54.7105539Z          // Track bytes received
2025-11-09T23:42:54.7105659Z          self.track_bytes_received(data.len() as u64);
2025-11-09T23:42:54.7105731Z -        
2025-11-09T23:42:54.7105799Z +
2025-11-09T23:42:54.7105886Z          // Check if peer is banned
2025-11-09T23:42:54.7106118Z          if self.is_banned(peer_addr) {
2025-11-09T23:42:54.7106269Z              warn!("Rejecting message from banned peer: {}", peer_addr);
2025-11-09T23:42:54.7106524Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2044:
2025-11-09T23:42:54.7108099Z              return Ok(()); // Silently drop messages from banned peers
2025-11-09T23:42:54.7108174Z          }
2025-11-09T23:42:54.7108310Z          let parsed = ProtocolParser::parse_message(&data)?;
2025-11-09T23:42:54.7108385Z -        
2025-11-09T23:42:54.7108455Z +
2025-11-09T23:42:54.7108606Z          // Handle special cases that don't go through protocol layer
2025-11-09T23:42:54.7108687Z          match parsed {
2025-11-09T23:42:54.7108768Z              // BIP331
2025-11-09T23:42:54.7109016Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2097:
2025-11-09T23:42:54.7109126Z                  // Continue to protocol layer processing
2025-11-09T23:42:54.7109206Z              }
2025-11-09T23:42:54.7109279Z          }
2025-11-09T23:42:54.7109348Z -        
2025-11-09T23:42:54.7109416Z +
2025-11-09T23:42:54.7109568Z          // Process with protocol layer if dependencies are available
2025-11-09T23:42:54.7109775Z -        if let (Some(ref protocol_engine), Some(ref storage), Some(ref mempool_manager)) = 
2025-11-09T23:42:54.7110148Z -            (self.protocol_engine.as_ref(), self.storage.as_ref(), self.mempool_manager.as_ref()) {
2025-11-09T23:42:54.7110228Z -            
2025-11-09T23:42:54.7110428Z +        if let (Some(ref protocol_engine), Some(ref storage), Some(ref mempool_manager)) = (
2025-11-09T23:42:54.7110525Z +            self.protocol_engine.as_ref(),
2025-11-09T23:42:54.7110617Z +            self.storage.as_ref(),
2025-11-09T23:42:54.7110712Z +            self.mempool_manager.as_ref(),
2025-11-09T23:42:54.7110781Z +        ) {
2025-11-09T23:42:54.7110973Z              // Convert ProtocolMessage to bllvm_protocol::network::NetworkMessage
2025-11-09T23:42:54.7111126Z              use crate::network::protocol_adapter::ProtocolAdapter;
2025-11-09T23:42:54.7111336Z              let protocol_msg = ProtocolAdapter::protocol_to_consensus_message(&parsed)?;
2025-11-09T23:42:54.7111586Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2108:
2025-11-09T23:42:54.7111659Z -            
2025-11-09T23:42:54.7111727Z +
2025-11-09T23:42:54.7111817Z              // Get or create PeerState
2025-11-09T23:42:54.7111958Z              let mut peer_states = self.peer_states.lock().unwrap();
2025-11-09T23:42:54.7112076Z -            let peer_state = peer_states.entry(peer_addr)
2025-11-09T23:42:54.7112170Z +            let peer_state = peer_states
2025-11-09T23:42:54.7112254Z +                .entry(peer_addr)
2025-11-09T23:42:54.7112418Z                  .or_insert_with(|| bllvm_protocol::network::PeerState::new());
2025-11-09T23:42:54.7112486Z -            
2025-11-09T23:42:54.7112554Z +
2025-11-09T23:42:54.7112649Z              // Create NodeChainAccess
2025-11-09T23:42:54.7112789Z              use crate::network::chain_access::NodeChainAccess;
2025-11-09T23:42:54.7112906Z              let chain_access = NodeChainAccess::new(
2025-11-09T23:42:54.7113157Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2118:
2025-11-09T23:42:54.7113252Z                  storage.transactions(),
2025-11-09T23:42:54.7113361Z                  Arc::clone(mempool_manager),
2025-11-09T23:42:54.7113432Z              );
2025-11-09T23:42:54.7113499Z -            
2025-11-09T23:42:54.7113569Z +
2025-11-09T23:42:54.7113654Z              // Get UTXO set and height
2025-11-09T23:42:54.7113992Z -            let utxo_set = storage.utxos().get_all_utxos()
2025-11-09T23:42:54.7114079Z +            let utxo_set = storage
2025-11-09T23:42:54.7114158Z +                .utxos()
2025-11-09T23:42:54.7114240Z +                .get_all_utxos()
2025-11-09T23:42:54.7114528Z                  .map_err(|e| anyhow::anyhow!("Failed to get UTXO set: {}", e))?;
2025-11-09T23:42:54.7114786Z -            let height = storage.chain().get_height()
2025-11-09T23:42:54.7114870Z +            let height = storage
2025-11-09T23:42:54.7114944Z +                .chain()
2025-11-09T23:42:54.7115022Z +                .get_height()
2025-11-09T23:42:54.7116570Z                  .map_err(|e| anyhow::anyhow!("Failed to get height: {}", e))?
2025-11-09T23:42:54.7116654Z                  .unwrap_or(0);
2025-11-09T23:42:54.7116724Z -            
2025-11-09T23:42:54.7116797Z +
2025-11-09T23:42:54.7116905Z              // Process message with protocol layer
2025-11-09T23:42:54.7117102Z              use bllvm_protocol::network::{process_network_message, ChainStateAccess};
2025-11-09T23:42:54.7117202Z              match process_network_message(
2025-11-09T23:42:54.7117467Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2140:
2025-11-09T23:42:54.7117629Z                      // Convert response to wire format and send via transport layer
2025-11-09T23:42:54.7117770Z                      use crate::network::message_bridge::MessageBridge;
2025-11-09T23:42:54.7117904Z                      use crate::network::transport::TransportType;
2025-11-09T23:42:54.7118172Z -                    if let Ok(wire_messages) = MessageBridge::extract_send_messages(&response, TransportType::Tcp) {
2025-11-09T23:42:54.7118271Z +                    if let Ok(wire_messages) =
2025-11-09T23:42:54.7118596Z +                        MessageBridge::extract_send_messages(&response, TransportType::Tcp)
2025-11-09T23:42:54.7118674Z +                    {
2025-11-09T23:42:54.7118782Z                          for wire_msg in wire_messages {
2025-11-09T23:42:54.7118942Z                              if let Err(e) = self.send_to_peer(peer_addr, wire_msg).await {
2025-11-09T23:42:54.7119114Z                                  warn!("Failed to send protocol response to {}: {}", peer_addr, e);
2025-11-09T23:42:54.7119368Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2158:
2025-11-09T23:42:54.7119503Z              // Dependencies not set - fall back to old behavior
2025-11-09T23:42:54.7119708Z              debug!("Protocol layer dependencies not set, skipping protocol processing");
2025-11-09T23:42:54.7119778Z          }
2025-11-09T23:42:54.7119847Z -        
2025-11-09T23:42:54.7119920Z +
2025-11-09T23:42:54.7119992Z          Ok(())
2025-11-09T23:42:54.7120064Z      }
2025-11-09T23:42:54.7120135Z  
2025-11-09T23:42:54.7120384Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2360:
2025-11-09T23:42:54.7120511Z          // Handle the request with storage and filter service
2025-11-09T23:42:54.7120647Z          let storage = self.storage.as_ref().map(Arc::clone);
2025-11-09T23:42:54.7120734Z          let response =
2025-11-09T23:42:54.7120992Z -            handle_get_filtered_block(get_filtered_block_msg, storage, Some(&self.filter_service)).await?;
2025-11-09T23:42:54.7121222Z +            handle_get_filtered_block(get_filtered_block_msg, storage, Some(&self.filter_service))
2025-11-09T23:42:54.7121307Z +                .await?;
2025-11-09T23:42:54.7121376Z  
2025-11-09T23:42:54.7121467Z          // Serialize and send response
2025-11-09T23:42:54.7121555Z          let response_wire =
2025-11-09T23:42:54.7121803Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2466:
2025-11-09T23:42:54.7121929Z      /// Handle GetAddr request - return known addresses
2025-11-09T23:42:54.7122107Z      async fn handle_get_addr(&self, peer_addr: SocketAddr) -> Result<()> {
2025-11-09T23:42:54.7122324Z          use crate::network::protocol::{AddrMessage, ProtocolMessage, ProtocolParser};
2025-11-09T23:42:54.7122393Z -        
2025-11-09T23:42:54.7122460Z +
2025-11-09T23:42:54.7122633Z          // Get fresh addresses from database (up to 2500, Bitcoin Core limit)
2025-11-09T23:42:54.7122758Z          let ban_list = self.ban_list.lock().unwrap().clone();
2025-11-09T23:42:54.7122867Z          let connected_peers: Vec<SocketAddr> = {
2025-11-09T23:42:54.7123228Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2473:
2025-11-09T23:42:54.7123342Z              let pm = self.peer_manager.lock().unwrap();
2025-11-09T23:42:54.7123434Z              pm.peer_socket_addresses()
2025-11-09T23:42:54.7123505Z          };
2025-11-09T23:42:54.7123578Z -        
2025-11-09T23:42:54.7123646Z +
2025-11-09T23:42:54.7123731Z          let addresses = {
2025-11-09T23:42:54.7123861Z              let mut db = self.address_database.lock().unwrap();
2025-11-09T23:42:54.7123968Z              let fresh = db.get_fresh_addresses(2500);
2025-11-09T23:42:54.7124215Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2480:
2025-11-09T23:42:54.7124479Z              db.filter_addresses(fresh, &ban_list, &connected_peers)
2025-11-09T23:42:54.7124549Z          };
2025-11-09T23:42:54.7124619Z -        
2025-11-09T23:42:54.7124686Z +
2025-11-09T23:42:54.7124771Z          // Create Addr message
2025-11-09T23:42:54.7124881Z          let addr_msg = AddrMessage { addresses };
2025-11-09T23:42:54.7125004Z          let response = ProtocolMessage::Addr(addr_msg);
2025-11-09T23:42:54.7125253Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2486:
2025-11-09T23:42:54.7125410Z          let wire_msg = ProtocolParser::serialize_message(&response)?;
2025-11-09T23:42:54.7125606Z -        
2025-11-09T23:42:54.7125677Z +
2025-11-09T23:42:54.7125763Z          // Send response
2025-11-09T23:42:54.7125881Z          self.send_to_peer(peer_addr, wire_msg).await?;
2025-11-09T23:42:54.7125953Z          Ok(())
2025-11-09T23:42:54.7126204Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2493:
2025-11-09T23:42:54.7126356Z      /// Handle Addr message - store addresses and optionally relay
2025-11-09T23:42:54.7126564Z      async fn handle_addr(&self, peer_addr: SocketAddr, msg: AddrMessage) -> Result<()> {
2025-11-09T23:42:54.7126685Z          use crate::network::protocol::NetworkAddress;
2025-11-09T23:42:54.7126758Z -        
2025-11-09T23:42:54.7126825Z +
2025-11-09T23:42:54.7126927Z          // Get peer services from peer state
2025-11-09T23:42:54.7127018Z          let peer_services = {
2025-11-09T23:42:54.7127145Z              let peer_states = self.peer_states.lock().unwrap();
2025-11-09T23:42:54.7127396Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2502:
2025-11-09T23:42:54.7127497Z                  .map(|state| state.services)
2025-11-09T23:42:54.7127577Z                  .unwrap_or(0)
2025-11-09T23:42:54.7127647Z          };
2025-11-09T23:42:54.7127715Z -        
2025-11-09T23:42:54.7127786Z +
2025-11-09T23:42:54.7127876Z          // Store addresses in database
2025-11-09T23:42:54.7127945Z          {
2025-11-09T23:42:54.7128067Z              let mut db = self.address_database.lock().unwrap();
2025-11-09T23:42:54.7128322Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2510:
2025-11-09T23:42:54.7128443Z                  db.add_address(addr.clone(), peer_services);
2025-11-09T23:42:54.7128514Z              }
2025-11-09T23:42:54.7128587Z          }
2025-11-09T23:42:54.7128656Z -        
2025-11-09T23:42:54.7128724Z +
2025-11-09T23:42:54.7128858Z          // Relay addresses to other peers (with rate limiting)
2025-11-09T23:42:54.7128998Z          self.relay_addresses(peer_addr, &msg.addresses).await?;
2025-11-09T23:42:54.7129066Z -        
2025-11-09T23:42:54.7129134Z +
2025-11-09T23:42:54.7129211Z          Ok(())
2025-11-09T23:42:54.7129292Z      }
2025-11-09T23:42:54.7129403Z  
2025-11-09T23:42:54.7129846Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2525:
2025-11-09T23:42:54.7129949Z      ) -> Result<()> {
2025-11-09T23:42:54.7130162Z          use crate::network::protocol::{AddrMessage, ProtocolMessage, ProtocolParser};
2025-11-09T23:42:54.7130273Z          use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:42:54.7130494Z -        
2025-11-09T23:42:54.7130562Z +
2025-11-09T23:42:54.7130785Z          // Rate limiting: don't send addr messages too frequently (Bitcoin Core: ~every 2.4 hours)
2025-11-09T23:42:54.7130886Z          let now = SystemTime::now()
2025-11-09T23:42:54.7130979Z              .duration_since(UNIX_EPOCH)
2025-11-09T23:42:54.7131229Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2532:
2025-11-09T23:42:54.7131311Z              .unwrap()
2025-11-09T23:42:54.7131388Z              .as_secs();
2025-11-09T23:42:54.7131535Z          let min_interval = 2 * 60 * 60 + 24 * 60; // 2.4 hours in seconds
2025-11-09T23:42:54.7131605Z -        
2025-11-09T23:42:54.7131679Z +
2025-11-09T23:42:54.7131747Z          {
2025-11-09T23:42:54.7131880Z              let last_sent = *self.last_addr_sent.lock().unwrap();
2025-11-09T23:42:54.7132006Z              if now.saturating_sub(last_sent) < min_interval {
2025-11-09T23:42:54.7132253Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2540:
2025-11-09T23:42:54.7132339Z                  return Ok(());
2025-11-09T23:42:54.7132413Z              }
2025-11-09T23:42:54.7132482Z          }
2025-11-09T23:42:54.7132549Z -        
2025-11-09T23:42:54.7132615Z +
2025-11-09T23:42:54.7132774Z          // Filter addresses (exclude local, banned, already connected)
2025-11-09T23:42:54.7133027Z          let ban_list = self.ban_list.lock().unwrap().clone();
2025-11-09T23:42:54.7133139Z          let connected_peers: Vec<SocketAddr> = {
2025-11-09T23:42:54.7133390Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2547:
2025-11-09T23:42:54.7133502Z              let pm = self.peer_manager.lock().unwrap();
2025-11-09T23:42:54.7133592Z              pm.peer_socket_addresses()
2025-11-09T23:42:54.7133661Z          };
2025-11-09T23:42:54.7133738Z -        
2025-11-09T23:42:54.7133806Z +
2025-11-09T23:42:54.7133886Z          let filtered = {
2025-11-09T23:42:54.7134006Z              let db = self.address_database.lock().unwrap();
2025-11-09T23:42:54.7134192Z              db.filter_addresses(addresses.to_vec(), &ban_list, &connected_peers)
2025-11-09T23:42:54.7134571Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2554:
2025-11-09T23:42:54.7134643Z          };
2025-11-09T23:42:54.7134716Z -        
2025-11-09T23:42:54.7134785Z +
2025-11-09T23:42:54.7134882Z          if filtered.is_empty() {
2025-11-09T23:42:54.7134967Z              return Ok(());
2025-11-09T23:42:54.7135037Z          }
2025-11-09T23:42:54.7135723Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2559:
2025-11-09T23:42:54.7135796Z -        
2025-11-09T23:42:54.7135868Z +
2025-11-09T23:42:54.7136275Z          // Limit to 1000 addresses per message (Bitcoin Core limit)
2025-11-09T23:42:54.7136759Z          let addresses_to_relay: Vec<NetworkAddress> = filtered.into_iter().take(1000).collect();
2025-11-09T23:42:54.7136838Z -        
2025-11-09T23:42:54.7136912Z +
2025-11-09T23:42:54.7136993Z          // Create Addr message
2025-11-09T23:42:54.7137088Z          let addr_msg = AddrMessage {
2025-11-09T23:42:54.7137191Z              addresses: addresses_to_relay,
2025-11-09T23:42:54.7137450Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2566:
2025-11-09T23:42:54.7137519Z          };
2025-11-09T23:42:54.7137662Z          let relay_msg = ProtocolMessage::Addr(addr_msg);
2025-11-09T23:42:54.7137821Z          let wire_msg = ProtocolParser::serialize_message(&relay_msg)?;
2025-11-09T23:42:54.7137890Z -        
2025-11-09T23:42:54.7137960Z +
2025-11-09T23:42:54.7138054Z          // Send to all peers except sender
2025-11-09T23:42:54.7138151Z          let peer_addrs: Vec<SocketAddr> = {
2025-11-09T23:42:54.7138265Z              let pm = self.peer_manager.lock().unwrap();
2025-11-09T23:42:54.7138519Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2575:
2025-11-09T23:42:54.7138620Z                  .filter(|addr| *addr != sender_addr)
2025-11-09T23:42:54.7138935Z                  .collect()
2025-11-09T23:42:54.7139066Z          };
2025-11-09T23:42:54.7139178Z -        
2025-11-09T23:42:54.7139291Z +
2025-11-09T23:42:54.7139456Z          for peer_addr in peer_addrs {
2025-11-09T23:42:54.7139695Z              if let Err(e) = self.send_to_peer(peer_addr, wire_msg.clone()).await {
2025-11-09T23:42:54.7139853Z                  warn!("Failed to relay addresses to {}: {}", peer_addr, e);
2025-11-09T23:42:54.7140116Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2582:
2025-11-09T23:42:54.7140192Z              }
2025-11-09T23:42:54.7140259Z          }
2025-11-09T23:42:54.7140331Z -        
2025-11-09T23:42:54.7140402Z +
2025-11-09T23:42:54.7140490Z          // Update last sent time
2025-11-09T23:42:54.7140601Z          *self.last_addr_sent.lock().unwrap() = now;
2025-11-09T23:42:54.7140668Z -        
2025-11-09T23:42:54.7140738Z +
2025-11-09T23:42:54.7140811Z          Ok(())
2025-11-09T23:42:54.7140881Z      }
2025-11-09T23:42:54.7140949Z  
2025-11-09T23:42:54.7141205Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2593:
2025-11-09T23:42:54.7141310Z          if !self.enable_self_advertisement {
2025-11-09T23:42:54.7141433Z              return Ok(()); // Self-advertisement disabled
2025-11-09T23:42:54.7142054Z          }
2025-11-09T23:42:54.7142145Z -        
2025-11-09T23:42:54.7142437Z -        use crate::network::protocol::{AddrMessage, NetworkAddress, ProtocolMessage, ProtocolParser};
2025-11-09T23:42:54.7142775Z +
2025-11-09T23:42:54.7142885Z +        use crate::network::protocol::{
2025-11-09T23:42:54.7143065Z +            AddrMessage, NetworkAddress, ProtocolMessage, ProtocolParser,
2025-11-09T23:42:54.7143134Z +        };
2025-11-09T23:42:54.7143231Z          use std::net::IpAddr;
2025-11-09T23:42:54.7143301Z -        
2025-11-09T23:42:54.7143368Z +
2025-11-09T23:42:54.7143477Z          // Convert SocketAddr to NetworkAddress
2025-11-09T23:42:54.7143587Z          let ip_bytes = match listen_addr.ip() {
2025-11-09T23:42:54.7143677Z              IpAddr::V4(ipv4) => {
2025-11-09T23:42:54.7143942Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2607:
2025-11-09T23:42:54.7144070Z                  bytes[12..16].copy_from_slice(&ipv4.octets());
2025-11-09T23:42:54.7144148Z                  bytes
2025-11-09T23:42:54.7144220Z              }
2025-11-09T23:42:54.7144454Z -            IpAddr::V6(ipv6) => {
2025-11-09T23:42:54.7144539Z -                ipv6.octets()
2025-11-09T23:42:54.7144608Z -            }
2025-11-09T23:42:54.7144709Z +            IpAddr::V6(ipv6) => ipv6.octets(),
2025-11-09T23:42:54.7144783Z          };
2025-11-09T23:42:54.7144851Z -        
2025-11-09T23:42:54.7144918Z +
2025-11-09T23:42:54.7145019Z          let our_addr = NetworkAddress {
2025-11-09T23:42:54.7145095Z              services,
2025-11-09T23:42:54.7145174Z              ip: ip_bytes,
2025-11-09T23:42:54.7145435Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2618:
2025-11-09T23:42:54.7145533Z              port: listen_addr.port(),
2025-11-09T23:42:54.7145602Z          };
2025-11-09T23:42:54.7145669Z -        
2025-11-09T23:42:54.7145741Z +
2025-11-09T23:42:54.7145851Z          // Create Addr message with just our address
2025-11-09T23:42:54.7145945Z          let addr_msg = AddrMessage {
2025-11-09T23:42:54.7146044Z              addresses: vec![our_addr.clone()],
2025-11-09T23:42:54.7147838Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2624:
2025-11-09T23:42:54.7147906Z          };
2025-11-09T23:42:54.7148035Z          let relay_msg = ProtocolMessage::Addr(addr_msg);
2025-11-09T23:42:54.7148203Z          let wire_msg = ProtocolParser::serialize_message(&relay_msg)?;
2025-11-09T23:42:54.7148272Z -        
2025-11-09T23:42:54.7148339Z +
2025-11-09T23:42:54.7148435Z          // Send to all connected peers
2025-11-09T23:42:54.7148689Z          let peer_addrs: Vec<SocketAddr> = {
2025-11-09T23:42:54.7148807Z              let pm = self.peer_manager.lock().unwrap();
2025-11-09T23:42:54.7149057Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2631:
2025-11-09T23:42:54.7149155Z              pm.peer_socket_addresses()
2025-11-09T23:42:54.7149224Z          };
2025-11-09T23:42:54.7149293Z -        
2025-11-09T23:42:54.7149368Z +
2025-11-09T23:42:54.7149462Z          for peer_addr in peer_addrs {
2025-11-09T23:42:54.7149629Z              if let Err(e) = self.send_to_peer(peer_addr, wire_msg.clone()).await {
2025-11-09T23:42:54.7149774Z                  warn!("Failed to advertise self to {}: {}", peer_addr, e);
2025-11-09T23:42:54.7150029Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2637:
2025-11-09T23:42:54.7150099Z              }
2025-11-09T23:42:54.7150169Z          }
2025-11-09T23:42:54.7150240Z -        
2025-11-09T23:42:54.7150308Z +
2025-11-09T23:42:54.7150417Z          // Also store our own address in database
2025-11-09T23:42:54.7150489Z          {
2025-11-09T23:42:54.7150617Z              let mut db = self.address_database.lock().unwrap();
2025-11-09T23:42:54.7150863Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2643:
2025-11-09T23:42:54.7150963Z              db.add_address(our_addr, services);
2025-11-09T23:42:54.7151158Z          }
2025-11-09T23:42:54.7151231Z -        
2025-11-09T23:42:54.7151300Z +
2025-11-09T23:42:54.7151376Z          Ok(())
2025-11-09T23:42:54.7151451Z      }
2025-11-09T23:42:54.7151519Z  
2025-11-09T23:42:54.7151766Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2649:
2025-11-09T23:42:54.7151859Z      /// Get list of banned peers
2025-11-09T23:42:54.7152002Z      pub fn get_banned_peers(&self) -> Vec<(SocketAddr, u64)> {
2025-11-09T23:42:54.7152118Z          let ban_list = self.ban_list.lock().unwrap();
2025-11-09T23:42:54.7152298Z -        ban_list.iter().map(|(addr, timestamp)| (*addr, *timestamp)).collect()
2025-11-09T23:42:54.7152374Z +        ban_list
2025-11-09T23:42:54.7152448Z +            .iter()
2025-11-09T23:42:54.7152565Z +            .map(|(addr, timestamp)| (*addr, *timestamp))
2025-11-09T23:42:54.7152646Z +            .collect()
2025-11-09T23:42:54.7152716Z      }
2025-11-09T23:42:54.7152783Z  
2025-11-09T23:42:54.7152901Z      /// Get peer addresses (async version for RPC)
2025-11-09T23:42:54.7153150Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2714:
2025-11-09T23:42:54.7153237Z          peer_addr: SocketAddr,
2025-11-09T23:42:54.7153365Z          msg: crate::network::protocol::GetBanListMessage,
2025-11-09T23:42:54.7153448Z      ) -> Result<()> {
2025-11-09T23:42:54.7153646Z -        use crate::network::protocol::{BanEntry, BanListMessage, NetworkAddress};
2025-11-09T23:42:54.7153802Z          use crate::network::ban_list_merging::calculate_ban_list_hash;
2025-11-09T23:42:54.7153993Z +        use crate::network::protocol::{BanEntry, BanListMessage, NetworkAddress};
2025-11-09T23:42:54.7154105Z          use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:42:54.7154174Z  
2025-11-09T23:42:54.7154584Z -        debug!("GetBanList request from {}: full={}, min_duration={}", 
2025-11-09T23:42:54.7154726Z -               peer_addr, msg.request_full, msg.min_ban_duration);
2025-11-09T23:42:54.7154803Z +        debug!(
2025-11-09T23:42:54.7154949Z +            "GetBanList request from {}: full={}, min_duration={}",
2025-11-09T23:42:54.7155076Z +            peer_addr, msg.request_full, msg.min_ban_duration
2025-11-09T23:42:54.7155148Z +        );
2025-11-09T23:42:54.7155215Z  
2025-11-09T23:42:54.7155307Z          // Get current ban list
2025-11-09T23:42:54.7155421Z          let ban_list = self.ban_list.lock().unwrap();
2025-11-09T23:42:54.7155681Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2776:
2025-11-09T23:42:54.7155785Z          let response = BanListMessage {
2025-11-09T23:42:54.7156013Z              is_full: msg.request_full,
2025-11-09T23:42:54.7156093Z              ban_list_hash,
2025-11-09T23:42:54.7156277Z -            ban_entries: if msg.request_full { ban_entries } else { Vec::new() },
2025-11-09T23:42:54.7156385Z +            ban_entries: if msg.request_full {
2025-11-09T23:42:54.7156464Z +                ban_entries
2025-11-09T23:42:54.7156541Z +            } else {
2025-11-09T23:42:54.7156626Z +                Vec::new()
2025-11-09T23:42:54.7156701Z +            },
2025-11-09T23:42:54.7156782Z              timestamp: now,
2025-11-09T23:42:54.7156851Z          };
2025-11-09T23:42:54.7156922Z  
2025-11-09T23:42:54.7157180Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2785:
2025-11-09T23:42:54.7157365Z          let serialized = ProtocolParser::serialize_message(&response_msg)?;
2025-11-09T23:42:54.7157496Z          self.send_to_peer(peer_addr, serialized).await?;
2025-11-09T23:42:54.7157566Z  
2025-11-09T23:42:54.7157726Z -        debug!("Sent BanList response to {}: {} entries", peer_addr, 
2025-11-09T23:42:54.7157863Z -               if msg.request_full { ban_entries.len() } else { 0 });
2025-11-09T23:42:54.7157935Z +        debug!(
2025-11-09T23:42:54.7158046Z +            "Sent BanList response to {}: {} entries",
2025-11-09T23:42:54.7158125Z +            peer_addr,
2025-11-09T23:42:54.7158337Z +            if msg.request_full {
2025-11-09T23:42:54.7158423Z +                ban_entries.len()
2025-11-09T23:42:54.7158496Z +            } else {
2025-11-09T23:42:54.7158571Z +                0
2025-11-09T23:42:54.7158641Z +            }
2025-11-09T23:42:54.7158708Z +        );
2025-11-09T23:42:54.7158777Z  
2025-11-09T23:42:54.7158854Z          Ok(())
2025-11-09T23:42:54.7158921Z      }
2025-11-09T23:42:54.7159175Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2800:
2025-11-09T23:42:54.7159388Z          use crate::network::ban_list_merging::{validate_ban_entry, verify_ban_list_hash};
2025-11-09T23:42:54.7159479Z          use std::net::IpAddr;
2025-11-09T23:42:54.7159546Z  
2025-11-09T23:42:54.7159685Z -        debug!("BanList received from {}: full={}, {} entries", 
2025-11-09T23:42:54.7159816Z -               peer_addr, msg.is_full, msg.ban_entries.len());
2025-11-09T23:42:54.7159887Z +        debug!(
2025-11-09T23:42:54.7160008Z +            "BanList received from {}: full={}, {} entries",
2025-11-09T23:42:54.7160091Z +            peer_addr,
2025-11-09T23:42:54.7160170Z +            msg.is_full,
2025-11-09T23:42:54.7160253Z +            msg.ban_entries.len()
2025-11-09T23:42:54.7160323Z +        );
2025-11-09T23:42:54.7160395Z  
2025-11-09T23:42:54.7160655Z          // Verify hash if full list provided
2025-11-09T23:42:54.7160733Z          if msg.is_full {
2025-11-09T23:42:54.7160997Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2813:
2025-11-09T23:42:54.7161067Z  
2025-11-09T23:42:54.7161221Z          // If hash-only, we can't merge (would need to request full list)
2025-11-09T23:42:54.7161310Z          if !msg.is_full {
2025-11-09T23:42:54.7161499Z -            debug!("Received hash-only ban list from {}, skipping merge", peer_addr);
2025-11-09T23:42:54.7161572Z +            debug!(
2025-11-09T23:42:54.7161716Z +                "Received hash-only ban list from {}, skipping merge",
2025-11-09T23:42:54.7161799Z +                peer_addr
2025-11-09T23:42:54.7161868Z +            );
2025-11-09T23:42:54.7161947Z              return Ok(());
2025-11-09T23:42:54.7162019Z          }
2025-11-09T23:42:54.7162087Z  
2025-11-09T23:42:54.7162341Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2831:
2025-11-09T23:42:54.7162436Z                  // IPv4-mapped IPv6 address
2025-11-09T23:42:54.7162549Z                  let ipv4_bytes = &entry.addr.ip[12..16];
2025-11-09T23:42:54.7162656Z                  IpAddr::V4(std::net::Ipv4Addr::new(
2025-11-09T23:42:54.7162798Z -                    ipv4_bytes[0], ipv4_bytes[1], ipv4_bytes[2], ipv4_bytes[3]
2025-11-09T23:42:54.7162997Z +                    ipv4_bytes[0],
2025-11-09T23:42:54.7163075Z +                    ipv4_bytes[1],
2025-11-09T23:42:54.7163151Z +                    ipv4_bytes[2],
2025-11-09T23:42:54.7163232Z +                    ipv4_bytes[3],
2025-11-09T23:42:54.7163301Z                  ))
2025-11-09T23:42:54.7163373Z              } else {
2025-11-09T23:42:54.7163457Z                  // IPv6 address
2025-11-09T23:42:54.7163726Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2882:
2025-11-09T23:42:54.7163808Z              ban_list.len()
2025-11-09T23:42:54.7163878Z          };
2025-11-09T23:42:54.7164048Z          let resource_metrics = self.dos_protection.get_metrics().await;
2025-11-09T23:42:54.7164116Z -        
2025-11-09T23:42:54.7164183Z +
2025-11-09T23:42:54.7164426Z          crate::node::metrics::NetworkMetrics {
2025-11-09T23:42:54.7164533Z              peer_count: active_connections,
2025-11-09T23:42:54.7164620Z              bytes_sent: sent,
2025-11-09T23:42:54.7164879Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2889:
2025-11-09T23:42:54.7166704Z              bytes_received: received,
2025-11-09T23:42:54.7166825Z -            messages_sent: 0, // Would need to track this
2025-11-09T23:42:54.7166946Z +            messages_sent: 0,     // Would need to track this
2025-11-09T23:42:54.7167194Z              messages_received: 0, // Would need to track this
2025-11-09T23:42:54.7167293Z              active_connections,
2025-11-09T23:42:54.7167396Z              banned_peers: banned_peers_count,
2025-11-09T23:42:54.7167652Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2894:
2025-11-09T23:42:54.7167785Z              connection_attempts: 0, // Would need to track this
2025-11-09T23:42:54.7167911Z              connection_failures: 0, // Would need to track this
2025-11-09T23:42:54.7168045Z              dos_protection: crate::node::metrics::DosMetrics {
2025-11-09T23:42:54.7168209Z -                connection_rate_violations: 0, // Would need to track this
2025-11-09T23:42:54.7168325Z -                auto_bans: 0, // Would need to track this
2025-11-09T23:42:54.7168466Z -                message_queue_overflows: 0, // Would need to track this
2025-11-09T23:42:54.7168628Z +                connection_rate_violations: 0,   // Would need to track this
2025-11-09T23:42:54.7168761Z +                auto_bans: 0,                    // Would need to track this
2025-11-09T23:42:54.7168910Z +                message_queue_overflows: 0,      // Would need to track this
2025-11-09T23:42:54.7169058Z                  active_connection_limit_hits: 0, // Would need to track this
2025-11-09T23:42:54.7169210Z -                resource_exhaustion_events: 0, // Would need to track this
2025-11-09T23:42:54.7169358Z +                resource_exhaustion_events: 0,   // Would need to track this
2025-11-09T23:42:54.7169429Z              },
2025-11-09T23:42:54.7169502Z          }
2025-11-09T23:42:54.7169575Z      }
2025-11-09T23:42:54.7169828Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2913:
2025-11-09T23:42:54.7169936Z      /// Create version message with service flags
2025-11-09T23:42:54.7170015Z      ///
2025-11-09T23:42:54.7170199Z      /// Creates version message with service flags for all supported features
2025-11-09T23:42:54.7170274Z -    /// 
2025-11-09T23:42:54.7170423Z +    ///
2025-11-09T23:42:54.7170519Z      /// Sets service flags based on:
2025-11-09T23:42:54.7170708Z      /// - BIP157: NODE_COMPACT_FILTERS (always enabled if filter service exists)
2025-11-09T23:42:54.7170869Z      /// - UTXO Commitments: NODE_UTXO_COMMITMENTS (if feature enabled)
2025-11-09T23:42:54.7171123Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2937:
2025-11-09T23:42:54.7171193Z  
2025-11-09T23:42:54.7171304Z          // Add service flags for supported features
2025-11-09T23:42:54.7171415Z          let mut services_with_filters = services;
2025-11-09T23:42:54.7171643Z -        
2025-11-09T23:42:54.7171713Z +
2025-11-09T23:42:54.7171900Z          // BIP157 Compact Block Filters (always enabled if filter service exists)
2025-11-09T23:42:54.7172022Z          services_with_filters |= NODE_COMPACT_FILTERS;
2025-11-09T23:42:54.7172093Z -        
2025-11-09T23:42:54.7172160Z +
2025-11-09T23:42:54.7172270Z          // UTXO Commitments (if feature enabled)
2025-11-09T23:42:54.7172372Z          #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.7172442Z          {
2025-11-09T23:42:54.7172690Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2947:
2025-11-09T23:42:54.7172894Z              services_with_filters |= crate::network::protocol::NODE_UTXO_COMMITMENTS;
2025-11-09T23:42:54.7172962Z          }
2025-11-09T23:42:54.7173057Z -        
2025-11-09T23:42:54.7173171Z +
2025-11-09T23:42:54.7173328Z          // Ban List Sharing (if config enabled)
2025-11-09T23:42:54.7173485Z          if self.ban_list_sharing_config.is_some() {
2025-11-09T23:42:54.7173684Z              services_with_filters |= crate::network::protocol::NODE_BAN_LIST_SHARING;
2025-11-09T23:42:54.7173937Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2953:
2025-11-09T23:42:54.7174007Z          }
2025-11-09T23:42:54.7174080Z -        
2025-11-09T23:42:54.7176421Z +
2025-11-09T23:42:54.7176528Z          // Dandelion (if feature enabled)
2025-11-09T23:42:54.7176620Z          #[cfg(feature = "dandelion")]
2025-11-09T23:42:54.7176697Z          {
2025-11-09T23:42:54.7176951Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/mod.rs:2958:
2025-11-09T23:42:54.7177127Z              services_with_filters |= crate::network::protocol::NODE_DANDELION;
2025-11-09T23:42:54.7177202Z          }
2025-11-09T23:42:54.7177272Z -        
2025-11-09T23:42:54.7177339Z +
2025-11-09T23:42:54.7177447Z          // Package Relay (BIP331) - always enabled
2025-11-09T23:42:54.7177641Z          services_with_filters |= crate::network::protocol::NODE_PACKAGE_RELAY;
2025-11-09T23:42:54.7177710Z -        
2025-11-09T23:42:54.7177778Z +
2025-11-09T23:42:54.7177868Z          // FIBRE - always enabled
2025-11-09T23:42:54.7178030Z          services_with_filters |= crate::network::protocol::NODE_FIBRE;
2025-11-09T23:42:54.7178099Z  
2025-11-09T23:42:54.7178400Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/package_relay.rs:138:
2025-11-09T23:42:54.7178596Z      pub fn new(transactions: Vec<Transaction>) -> Result<Self, PackageError> {
2025-11-09T23:42:54.7178713Z          Self::new_with_utxo_set(transactions, None)
2025-11-09T23:42:54.7178783Z      }
2025-11-09T23:42:54.7178858Z -    
2025-11-09T23:42:54.7178924Z +
2025-11-09T23:42:54.7179098Z      /// Create a new transaction package with UTXO set for fee calculation
2025-11-09T23:42:54.7179187Z      pub fn new_with_utxo_set(
2025-11-09T23:42:54.7179288Z          transactions: Vec<Transaction>,
2025-11-09T23:42:54.7179576Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/package_relay.rs:168:
2025-11-09T23:42:54.7179705Z          // Calculate combined fee from UTXO set if provided
2025-11-09T23:42:54.7179845Z          let combined_fee = if let Some(utxo_set) = utxo_set {
2025-11-09T23:42:54.7180016Z              // Calculate fee for each transaction: sum(inputs) - sum(outputs)
2025-11-09T23:42:54.7180118Z -            transactions.iter().map(|tx| {
2025-11-09T23:42:54.7180234Z -                let input_total: u64 = tx.inputs.iter()
2025-11-09T23:42:54.7180359Z -                    .filter_map(|inp| utxo_set.get(&inp.prevout))
2025-11-09T23:42:54.7180458Z -                    .map(|utxo| utxo.value as u64)
2025-11-09T23:42:54.7180537Z -                    .sum();
2025-11-09T23:42:54.7180654Z -                let output_total: u64 = tx.outputs.iter()
2025-11-09T23:42:54.7180752Z -                    .map(|out| out.value as u64)
2025-11-09T23:42:54.7180828Z -                    .sum();
2025-11-09T23:42:54.7181066Z -                if input_total > output_total {
2025-11-09T23:42:54.7181166Z -                    input_total - output_total
2025-11-09T23:42:54.7181242Z -                } else {
2025-11-09T23:42:54.7181318Z -                    0
2025-11-09T23:42:54.7181388Z -                }
2025-11-09T23:42:54.7181462Z -            }).sum()
2025-11-09T23:42:54.7181553Z +            transactions
2025-11-09T23:42:54.7181629Z +                .iter()
2025-11-09T23:42:54.7181708Z +                .map(|tx| {
2025-11-09T23:42:54.7181812Z +                    let input_total: u64 = tx
2025-11-09T23:42:54.7181892Z +                        .inputs
2025-11-09T23:42:54.7181969Z +                        .iter()
2025-11-09T23:42:54.7182101Z +                        .filter_map(|inp| utxo_set.get(&inp.prevout))
2025-11-09T23:42:54.7182201Z +                        .map(|utxo| utxo.value as u64)
2025-11-09T23:42:54.7182278Z +                        .sum();
2025-11-09T23:42:54.7182484Z +                    let output_total: u64 = tx.outputs.iter().map(|out| out.value as u64).sum();
2025-11-09T23:42:54.7188502Z +                    if input_total > output_total {
2025-11-09T23:42:54.7188652Z +                        input_total - output_total
2025-11-09T23:42:54.7188742Z +                    } else {
2025-11-09T23:42:54.7188822Z +                        0
2025-11-09T23:42:54.7189075Z +                    }
2025-11-09T23:42:54.7189152Z +                })
2025-11-09T23:42:54.7189232Z +                .sum()
2025-11-09T23:42:54.7189304Z          } else {
2025-11-09T23:42:54.7189419Z              0 // Fee calculation requires UTXO set
2025-11-09T23:42:54.7189497Z          };
2025-11-09T23:42:54.7189778Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:4:
2025-11-09T23:42:54.7189849Z  
2025-11-09T23:42:54.7189947Z  use anyhow::Result;
2025-11-09T23:42:54.7190043Z  use std::net::SocketAddr;
2025-11-09T23:42:54.7190122Z +use std::sync::Arc;
2025-11-09T23:42:54.7190237Z  use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:42:54.7190329Z  use tokio::sync::mpsc;
2025-11-09T23:42:54.7190425Z  use tracing::{debug, info, warn};
2025-11-09T23:42:54.7190700Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:10:
2025-11-09T23:42:54.7190790Z -use std::sync::Arc;
2025-11-09T23:42:54.7190861Z  
2025-11-09T23:42:54.7191030Z +use super::transport::{TransportAddr, TransportConnection};
2025-11-09T23:42:54.7191125Z  use super::NetworkMessage;
2025-11-09T23:42:54.7191291Z -use super::transport::{TransportConnection, TransportAddr};
2025-11-09T23:42:54.7191360Z  
2025-11-09T23:42:54.7191452Z  /// Peer connection state
2025-11-09T23:42:54.7191527Z -/// 
2025-11-09T23:42:54.7191597Z +///
2025-11-09T23:42:54.7191834Z  /// Supports multiple transport types (TCP, Quinn, Iroh) via TransportConnection trait
2025-11-09T23:42:54.7191921Z  pub struct Peer {
2025-11-09T23:42:54.7192007Z      addr: SocketAddr,
2025-11-09T23:42:54.7192384Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:48:
2025-11-09T23:42:54.7192503Z  
2025-11-09T23:42:54.7192639Z  impl Peer {
2025-11-09T23:42:54.7192885Z      /// Create a new peer connection from a TransportConnection
2025-11-09T23:42:54.7193003Z -    /// 
2025-11-09T23:42:54.7193121Z +    ///
2025-11-09T23:42:54.7193376Z      /// This is the preferred method as it supports all transport types (TCP, Quinn, Iroh).
2025-11-09T23:42:54.7193550Z      /// The connection is managed via channels for concurrent read/write.
2025-11-09T23:42:54.7193728Z      pub fn from_transport_connection<C: TransportConnection + 'static>(
2025-11-09T23:42:54.7194003Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:59:
2025-11-09T23:42:54.7194081Z      ) -> Self {
2025-11-09T23:42:54.7194189Z          // Create channel for sending messages
2025-11-09T23:42:54.7194499Z          let (send_tx, send_rx) = mpsc::unbounded_channel::<Vec<u8>>();
2025-11-09T23:42:54.7194783Z -        
2025-11-09T23:42:54.7194899Z +
2025-11-09T23:42:54.7195128Z          let transport_addr_clone = transport_addr.clone();
2025-11-09T23:42:54.7195317Z          let message_tx_clone = message_tx.clone();
2025-11-09T23:42:54.7195434Z -        
2025-11-09T23:42:54.7195555Z +
2025-11-09T23:42:54.7195783Z          // Wrap connection in Arc<Mutex> to share between read and write tasks
2025-11-09T23:42:54.7195882Z          use std::sync::Arc;
2025-11-09T23:42:54.7195975Z          use tokio::sync::Mutex;
2025-11-09T23:42:54.7196238Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:69:
2025-11-09T23:42:54.7196348Z          let conn = Arc::new(Mutex::new(conn));
2025-11-09T23:42:54.7196448Z          let conn_read = Arc::clone(&conn);
2025-11-09T23:42:54.7196546Z          let conn_write = Arc::clone(&conn);
2025-11-09T23:42:54.7196627Z -        
2025-11-09T23:42:54.7196697Z +
2025-11-09T23:42:54.7196831Z          // Spawn read task using TransportConnection::recv
2025-11-09T23:42:54.7196936Z          tokio::spawn(async move {
2025-11-09T23:42:54.7197013Z              loop {
2025-11-09T23:42:54.7197264Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:83:
2025-11-09T23:42:54.7197342Z                          }
2025-11-09T23:42:54.7197419Z                      }
2025-11-09T23:42:54.7197490Z                  };
2025-11-09T23:42:54.7197719Z -                
2025-11-09T23:42:54.7197794Z +
2025-11-09T23:42:54.7197888Z                  if data.is_empty() {
2025-11-09T23:42:54.7197964Z                      break;
2025-11-09T23:42:54.7198036Z                  }
2025-11-09T23:42:54.7198287Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:90:
2025-11-09T23:42:54.7198358Z -                
2025-11-09T23:42:54.7198425Z +
2025-11-09T23:42:54.7198554Z                  let peer_addr = match &transport_addr_clone {
2025-11-09T23:42:54.7198701Z                      super::transport::TransportAddr::Tcp(sock) => *sock,
2025-11-09T23:42:54.7198801Z                      #[cfg(feature = "quinn")]
2025-11-09T23:42:54.7199055Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:100:
2025-11-09T23:42:54.7199289Z                  let _ = message_tx_clone.send(NetworkMessage::RawMessageReceived(data, peer_addr));
2025-11-09T23:42:54.7199361Z              }
2025-11-09T23:42:54.7199434Z          });
2025-11-09T23:42:54.7199513Z -        
2025-11-09T23:42:54.7199581Z +
2025-11-09T23:42:54.7199716Z          // Spawn write task using TransportConnection::send
2025-11-09T23:42:54.7199811Z          tokio::spawn(async move {
2025-11-09T23:42:54.7199901Z              let mut send_rx = send_rx;
2025-11-09T23:42:54.7200156Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:107:
2025-11-09T23:42:54.7200228Z -            
2025-11-09T23:42:54.7200301Z +
2025-11-09T23:42:54.7200374Z              loop {
2025-11-09T23:42:54.7200469Z                  match send_rx.recv().await {
2025-11-09T23:42:54.7200561Z                      Some(data) => {
2025-11-09T23:42:54.7200808Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:124:
2025-11-09T23:42:54.7200880Z                      }
2025-11-09T23:42:54.7200954Z                  }
2025-11-09T23:42:54.7201029Z              }
2025-11-09T23:42:54.7201097Z -            
2025-11-09T23:42:54.7201167Z +
2025-11-09T23:42:54.7201296Z              // Gracefully close connection on write task exit
2025-11-09T23:42:54.7201435Z              // Connection will be closed when conn_guard is dropped
2025-11-09T23:42:54.7201506Z          });
2025-11-09T23:42:54.7201750Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:131:
2025-11-09T23:42:54.7201828Z -        
2025-11-09T23:42:54.7201897Z +
2025-11-09T23:42:54.7201987Z          let now = SystemTime::now()
2025-11-09T23:42:54.7202089Z              .duration_since(UNIX_EPOCH)
2025-11-09T23:42:54.7202163Z              .unwrap()
2025-11-09T23:42:54.7202516Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:135:
2025-11-09T23:42:54.7202599Z              .as_secs();
2025-11-09T23:42:54.7202667Z -        
2025-11-09T23:42:54.7202735Z +
2025-11-09T23:42:54.7202807Z          Self {
2025-11-09T23:42:54.7202884Z              addr,
2025-11-09T23:42:54.7202967Z              transport_addr,
2025-11-09T23:42:54.7203215Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:153:
2025-11-09T23:42:54.7203312Z              last_tx_received: None,
2025-11-09T23:42:54.7203382Z          }
2025-11-09T23:42:54.7203449Z      }
2025-11-09T23:42:54.7203516Z -    
2025-11-09T23:42:54.7203589Z +
2025-11-09T23:42:54.7203784Z      /// Create a new peer connection from a TCP stream (backward compatibility)
2025-11-09T23:42:54.7203855Z -    /// 
2025-11-09T23:42:54.7203930Z +    ///
2025-11-09T23:42:54.7204115Z      /// This is a convenience method that wraps a TcpStream in a TcpConnection.
2025-11-09T23:42:54.7206783Z      #[deprecated(note = "Use from_transport_connection instead for transport abstraction")]
2025-11-09T23:42:54.7206877Z      pub fn new(
2025-11-09T23:42:54.7207155Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:165:
2025-11-09T23:42:54.7207236Z      ) -> Self {
2025-11-09T23:42:54.7207513Z          use super::tcp_transport::TcpConnection;
2025-11-09T23:42:54.7207633Z          use super::transport::TransportAddr;
2025-11-09T23:42:54.7207707Z -        
2025-11-09T23:42:54.7207777Z +
2025-11-09T23:42:54.7207913Z          let peer_addr = stream.peer_addr().unwrap_or(addr);
2025-11-09T23:42:54.7208014Z          let tcp_conn = TcpConnection {
2025-11-09T23:42:54.7208092Z              stream,
2025-11-09T23:42:54.7208358Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:172:
2025-11-09T23:42:54.7208481Z              peer_addr: TransportAddr::Tcp(peer_addr),
2025-11-09T23:42:54.7208567Z              connected: true,
2025-11-09T23:42:54.7208643Z          };
2025-11-09T23:42:54.7208718Z -        
2025-11-09T23:42:54.7208784Z +
2025-11-09T23:42:54.7209010Z          Self::from_transport_connection(tcp_conn, addr, TransportAddr::Tcp(addr), message_tx)
2025-11-09T23:42:54.7209080Z      }
2025-11-09T23:42:54.7209154Z  
2025-11-09T23:42:54.7209409Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:189:
2025-11-09T23:42:54.7209516Z          self.handle_peer_communication().await?;
2025-11-09T23:42:54.7209593Z  
2025-11-09T23:42:54.7209692Z          // Send disconnection notification
2025-11-09T23:42:54.7209772Z -        let _ = self
2025-11-09T23:42:54.7209849Z -            .message_tx
2025-11-09T23:42:54.7210060Z -            .send(NetworkMessage::PeerDisconnected(self.transport_addr.clone()));
2025-11-09T23:42:54.7210229Z +        let _ = self.message_tx.send(NetworkMessage::PeerDisconnected(
2025-11-09T23:42:54.7210325Z +            self.transport_addr.clone(),
2025-11-09T23:42:54.7210409Z +        ));
2025-11-09T23:42:54.7210479Z  
2025-11-09T23:42:54.7210550Z          Ok(())
2025-11-09T23:42:54.7210618Z      }
2025-11-09T23:42:54.7210887Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:198:
2025-11-09T23:42:54.7210955Z  
2025-11-09T23:42:54.7211053Z      /// Handle peer communication loop
2025-11-09T23:42:54.7211132Z -    /// 
2025-11-09T23:42:54.7211202Z +    ///
2025-11-09T23:42:54.7211370Z      /// Note: The read loop is now handled in `new()` via stream splitting.
2025-11-09T23:42:54.7211500Z      /// This method just waits for the connection to close.
2025-11-09T23:42:54.7211660Z      async fn handle_peer_communication(&mut self) -> Result<()> {
2025-11-09T23:42:54.7211911Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:205:
2025-11-09T23:42:54.7212039Z          // We just wait here to detect when connection closes
2025-11-09T23:42:54.7212228Z          // In a real implementation, we'd monitor the read task or connection state
2025-11-09T23:42:54.7212546Z          tokio::time::sleep(tokio::time::Duration::from_secs(1)).await;
2025-11-09T23:42:54.7212617Z -        
2025-11-09T23:42:54.7212691Z +
2025-11-09T23:42:54.7212937Z          // Connection close is automatically detected by the read task in from_transport_connection
2025-11-09T23:42:54.7213156Z          // When recv() returns empty data or error, the task breaks and sends PeerDisconnected
2025-11-09T23:42:54.7213253Z          self.connected = false;
2025-11-09T23:42:54.7213505Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/peer.rs:248:
2025-11-09T23:42:54.7213574Z      }
2025-11-09T23:42:54.7213644Z  
2025-11-09T23:42:54.7214014Z      /// Send a message to the peer
2025-11-09T23:42:54.7216103Z -    /// 
2025-11-09T23:42:54.7216175Z +    ///
2025-11-09T23:42:54.7216339Z      /// Messages are sent via a channel to a background write task.
2025-11-09T23:42:54.7216500Z      pub async fn send_message(&self, message: Vec<u8>) -> Result<()> {
2025-11-09T23:42:54.7216601Z          let message_len = message.len();
2025-11-09T23:42:54.7217163Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol.rs:2:
2025-11-09T23:42:54.7217242Z  //!
2025-11-09T23:42:54.7217449Z  //! Implements Bitcoin P2P protocol message serialization and deserialization.
2025-11-09T23:42:54.7217669Z  
2025-11-09T23:42:54.7217809Z -use bllvm_protocol::bip157::NODE_COMPACT_FILTERS;
2025-11-09T23:42:54.7217930Z  use crate::network::transport::TransportType;
2025-11-09T23:42:54.7218012Z  use anyhow::Result;
2025-11-09T23:42:54.7218132Z +use bllvm_protocol::bip157::NODE_COMPACT_FILTERS;
2025-11-09T23:42:54.7218294Z  use bllvm_protocol::{Block, BlockHeader, Hash, Transaction};
2025-11-09T23:42:54.7218395Z  use serde::{Deserialize, Serialize};
2025-11-09T23:42:54.7218464Z  
2025-11-09T23:42:54.7218740Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol.rs:145:
2025-11-09T23:42:54.7218870Z      pub fn supports_utxo_commitments(&self) -> bool {
2025-11-09T23:42:54.7218983Z          (self.services & NODE_UTXO_COMMITMENTS) != 0
2025-11-09T23:42:54.7219055Z      }
2025-11-09T23:42:54.7219124Z -    
2025-11-09T23:42:54.7219191Z +
2025-11-09T23:42:54.7219296Z      /// Check if peer supports ban list sharing
2025-11-09T23:42:54.7219422Z      pub fn supports_ban_list_sharing(&self) -> bool {
2025-11-09T23:42:54.7219531Z          (self.services & NODE_BAN_LIST_SHARING) != 0
2025-11-09T23:42:54.7219793Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol.rs:152:
2025-11-09T23:42:54.7219867Z      }
2025-11-09T23:42:54.7219937Z -    
2025-11-09T23:42:54.7220005Z +
2025-11-09T23:42:54.7220135Z      /// Check if peer supports BIP157 compact block filters
2025-11-09T23:42:54.7220256Z      pub fn supports_compact_filters(&self) -> bool {
2025-11-09T23:42:54.7220383Z          use bllvm_protocol::bip157::NODE_COMPACT_FILTERS;
2025-11-09T23:42:54.7220641Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol.rs:157:
2025-11-09T23:42:54.7220759Z          (self.services & NODE_COMPACT_FILTERS) != 0
2025-11-09T23:42:54.7220828Z      }
2025-11-09T23:42:54.7220896Z -    
2025-11-09T23:42:54.7220969Z +
2025-11-09T23:42:54.7221087Z      /// Check if peer supports package relay (BIP331)
2025-11-09T23:42:54.7221203Z      pub fn supports_package_relay(&self) -> bool {
2025-11-09T23:42:54.7221310Z          (self.services & NODE_PACKAGE_RELAY) != 0
2025-11-09T23:42:54.7221572Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol.rs:163:
2025-11-09T23:42:54.7221642Z      }
2025-11-09T23:42:54.7221711Z -    
2025-11-09T23:42:54.7221783Z +
2025-11-09T23:42:54.7221878Z      /// Check if peer supports FIBRE
2025-11-09T23:42:54.7221979Z      pub fn supports_fibre(&self) -> bool {
2025-11-09T23:42:54.7222073Z          (self.services & NODE_FIBRE) != 0
2025-11-09T23:42:54.7224204Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol.rs:168:
2025-11-09T23:42:54.7224574Z      }
2025-11-09T23:42:54.7224642Z -    
2025-11-09T23:42:54.7224717Z +
2025-11-09T23:42:54.7224811Z      #[cfg(feature = "dandelion")]
2025-11-09T23:42:54.7224910Z      /// Check if peer supports Dandelion
2025-11-09T23:42:54.7225017Z      pub fn supports_dandelion(&self) -> bool {
2025-11-09T23:42:54.7225335Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol_extensions.rs:7:
2025-11-09T23:42:54.7225477Z  //! - FilteredBlock: Response with filtered transactions
2025-11-09T23:42:54.7225546Z  
2025-11-09T23:42:54.7225649Z  use crate::network::protocol::*;
2025-11-09T23:42:54.7225741Z -use crate::storage::Storage;
2025-11-09T23:42:54.7225851Z  use crate::network::txhash::calculate_txid;
2025-11-09T23:42:54.7225947Z +use crate::storage::Storage;
2025-11-09T23:42:54.7226027Z  use anyhow::Result;
2025-11-09T23:42:54.7226123Z  #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.7226304Z  use bllvm_protocol::utxo_commitments::merkle_tree::UtxoMerkleTree;
2025-11-09T23:42:54.7226615Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol_extensions.rs:41:
2025-11-09T23:42:54.7226703Z      // Get UTXO set from storage
2025-11-09T23:42:54.7226825Z      let utxo_set = storage.utxos().get_all_utxos()?;
2025-11-09T23:42:54.7227051Z      let utxo_count = utxo_set.len() as u64;
2025-11-09T23:42:54.7227122Z -    
2025-11-09T23:42:54.7227193Z +
2025-11-09T23:42:54.7227289Z      // Calculate total supply
2025-11-09T23:42:54.7227488Z      let total_supply: u64 = utxo_set.values().map(|utxo| utxo.value as u64).sum();
2025-11-09T23:42:54.7227559Z  
2025-11-09T23:42:54.7227858Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol_extensions.rs:49:
2025-11-09T23:42:54.7227962Z      #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.7228072Z      let mut utxo_tree = UtxoMerkleTree::new()
2025-11-09T23:42:54.7228260Z          .map_err(|e| anyhow::anyhow!("Failed to create UTXO Merkle tree: {:?}", e))?;
2025-11-09T23:42:54.7228340Z -    
2025-11-09T23:42:54.7228410Z +
2025-11-09T23:42:54.7228506Z      #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.7228601Z      for (outpoint, utxo) in &utxo_set {
2025-11-09T23:42:54.7228714Z -        utxo_tree.insert(*outpoint, utxo.clone())
2025-11-09T23:42:54.7228794Z +        utxo_tree
2025-11-09T23:42:54.7228892Z +            .insert(*outpoint, utxo.clone())
2025-11-09T23:42:54.7229079Z              .map_err(|e| anyhow::anyhow!("Failed to insert UTXO into tree: {:?}", e))?;
2025-11-09T23:42:54.7229148Z      }
2025-11-09T23:42:54.7229222Z  
2025-11-09T23:42:54.7229525Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol_extensions.rs:68:
2025-11-09T23:42:54.7229609Z      // Generate commitment
2025-11-09T23:42:54.7229705Z      #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.7229893Z      let commitment = utxo_tree.generate_commitment(block_hash, block_height);
2025-11-09T23:42:54.7229973Z -    
2025-11-09T23:42:54.7230041Z +
2025-11-09T23:42:54.7230145Z      #[cfg(not(feature = "utxo-commitments"))]
2025-11-09T23:42:54.7230306Z      let commitment = crate::network::protocol::UTXOCommitment {
2025-11-09T23:42:54.7230391Z          merkle_root: [0; 32],
2025-11-09T23:42:54.7230700Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol_extensions.rs:161:
2025-11-09T23:42:54.7230797Z      #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.7231048Z      let (filtered_txs, spam_summary_from_filter) = spam_filter.filter_block(&block.transactions);
2025-11-09T23:42:54.7231147Z      #[cfg(not(feature = "utxo-commitments"))]
2025-11-09T23:42:54.7231707Z -    let (filtered_txs, spam_summary_from_filter): (Vec<bllvm_protocol::Transaction>, crate::network::protocol::SpamSummary) = (block.transactions.clone(), crate::network::protocol::SpamSummary {
2025-11-09T23:42:54.7231797Z -        filtered_count: 0,
2025-11-09T23:42:54.7231996Z -        filtered_size: 0,
2025-11-09T23:42:54.7232131Z -        by_type: crate::network::protocol::SpamBreakdown {
2025-11-09T23:42:54.7232219Z -            ordinals: 0,
2025-11-09T23:42:54.7232305Z -            inscriptions: 0,
2025-11-09T23:42:54.7232380Z -            dust: 0,
2025-11-09T23:42:54.7232453Z -            brc20: 0,
2025-11-09T23:42:54.7232582Z +    let (filtered_txs, spam_summary_from_filter): (
2025-11-09T23:42:54.7232683Z +        Vec<bllvm_protocol::Transaction>,
2025-11-09T23:42:54.7232793Z +        crate::network::protocol::SpamSummary,
2025-11-09T23:42:54.7232869Z +    ) = (
2025-11-09T23:42:54.7232966Z +        block.transactions.clone(),
2025-11-09T23:42:54.7233072Z +        crate::network::protocol::SpamSummary {
2025-11-09T23:42:54.7233154Z +            filtered_count: 0,
2025-11-09T23:42:54.7233243Z +            filtered_size: 0,
2025-11-09T23:42:54.7233375Z +            by_type: crate::network::protocol::SpamBreakdown {
2025-11-09T23:42:54.7233456Z +                ordinals: 0,
2025-11-09T23:42:54.7233547Z +                inscriptions: 0,
2025-11-09T23:42:54.7233620Z +                dust: 0,
2025-11-09T23:42:54.7233705Z +                brc20: 0,
2025-11-09T23:42:54.7233775Z +            },
2025-11-09T23:42:54.7233843Z          },
2025-11-09T23:42:54.7233917Z -    });
2025-11-09T23:42:54.7233986Z -    
2025-11-09T23:42:54.7234054Z +    );
2025-11-09T23:42:54.7236223Z +
2025-11-09T23:42:54.7236342Z      // Convert spam summary to protocol types
2025-11-09T23:42:54.7236437Z      let spam_summary = SpamSummary {
2025-11-09T23:42:54.7236586Z          filtered_count: spam_summary_from_filter.filtered_count,
2025-11-09T23:42:54.7236911Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol_extensions.rs:186:
2025-11-09T23:42:54.7236980Z  
2025-11-09T23:42:54.7237217Z      // Generate transaction indices (positions of filtered transactions in original block)
2025-11-09T23:42:54.7237328Z      let mut transaction_indices = Vec::new();
2025-11-09T23:42:54.7237519Z -    let filtered_txids: std::collections::HashSet<_> = filtered_txs.iter()
2025-11-09T23:42:54.7237612Z -        .map(|tx| calculate_txid(tx))
2025-11-09T23:42:54.7237687Z -        .collect();
2025-11-09T23:42:54.7237818Z +    let filtered_txids: std::collections::HashSet<_> =
2025-11-09T23:42:54.7237972Z +        filtered_txs.iter().map(|tx| calculate_txid(tx)).collect();
2025-11-09T23:42:54.7238139Z      for (original_idx, tx) in block.transactions.iter().enumerate() {
2025-11-09T23:42:54.7238254Z          let txid = calculate_txid(tx);
2025-11-09T23:42:54.7238353Z          if filtered_txids.contains(&txid) {
2025-11-09T23:42:54.7238663Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol_extensions.rs:200:
2025-11-09T23:42:54.7238763Z      #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.7238869Z      let mut utxo_tree = UtxoMerkleTree::new()
2025-11-09T23:42:54.7239056Z          .map_err(|e| anyhow::anyhow!("Failed to create UTXO Merkle tree: {:?}", e))?;
2025-11-09T23:42:54.7239127Z -    
2025-11-09T23:42:54.7239200Z +
2025-11-09T23:42:54.7239294Z      #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.7239397Z      // Add outputs from filtered transactions
2025-11-09T23:42:54.7239486Z      for tx in &filtered_txs {
2025-11-09T23:42:54.7239796Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/protocol_extensions.rs:227:
2025-11-09T23:42:54.7239893Z      // Generate commitment for filtered block
2025-11-09T23:42:54.7239985Z      #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.7240197Z      let commitment = utxo_tree.generate_commitment(message.block_hash, block_height);
2025-11-09T23:42:54.7240267Z -    
2025-11-09T23:42:54.7240336Z +
2025-11-09T23:42:54.7240442Z      #[cfg(not(feature = "utxo-commitments"))]
2025-11-09T23:42:54.7240596Z      let commitment = crate::network::protocol::UTXOCommitment {
2025-11-09T23:42:54.7240678Z          merkle_root: [0; 32],
2025-11-09T23:42:54.7241107Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/stratum_v2/pool.rs:191:
2025-11-09T23:42:54.7241178Z  
2025-11-09T23:42:54.7241261Z          // Store template
2025-11-09T23:42:54.7241367Z          self.current_template = Some(template);
2025-11-09T23:42:54.7241441Z -        
2025-11-09T23:42:54.7241509Z +
2025-11-09T23:42:54.7241589Z          (job_id, messages)
2025-11-09T23:42:54.7241665Z      }
2025-11-09T23:42:54.7241733Z  
2025-11-09T23:42:54.7242021Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/stratum_v2/pool.rs:463:
2025-11-09T23:42:54.7242161Z          if let Some(coinbase) = template.transactions.first() {
2025-11-09T23:42:54.7242266Z              // Serialize coinbase transaction
2025-11-09T23:42:54.7242421Z              let coinbase_bytes = self.serialize_transaction(coinbase);
2025-11-09T23:42:54.7242491Z -            
2025-11-09T23:42:54.7242565Z +
2025-11-09T23:42:54.7242696Z              // Extract merkle path from coinbase (index 0) to root
2025-11-09T23:42:54.7242842Z              let merkle_path = self.extract_merkle_path(template, 0);
2025-11-09T23:42:54.7242912Z -            
2025-11-09T23:42:54.7242986Z +
2025-11-09T23:42:54.7243186Z              // For Stratum V2, coinbase prefix is the full coinbase (miners can modify it)
2025-11-09T23:42:54.7243315Z              // Coinbase suffix is empty (not used in Stratum V2)
2025-11-09T23:42:54.7243551Z              (coinbase_bytes, vec![], merkle_path)
2025-11-09T23:42:54.7243848Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/stratum_v2/pool.rs:477:
2025-11-09T23:42:54.7243918Z  
2025-11-09T23:42:54.7244086Z      /// Extract merkle path from a specific transaction index to root
2025-11-09T23:42:54.7244414Z      fn extract_merkle_path(&self, block: &Block, tx_index: usize) -> Vec<Hash> {
2025-11-09T23:42:54.7244543Z -        use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:42:54.7244657Z          use crate::storage::hashing::double_sha256;
2025-11-09T23:42:54.7244785Z +        use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:42:54.7244853Z  
2025-11-09T23:42:54.7245051Z          if block.transactions.is_empty() || tx_index >= block.transactions.len() {
2025-11-09T23:42:54.7245137Z              return vec![];
2025-11-09T23:42:54.7245428Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/stratum_v2/pool.rs:485:
2025-11-09T23:42:54.7245499Z          }
2025-11-09T23:42:54.7245569Z  
2025-11-09T23:42:54.7245668Z          // Calculate all transaction hashes
2025-11-09T23:42:54.7245812Z -        let mut tx_hashes: Vec<Hash> = block.transactions.iter()
2025-11-09T23:42:54.7245908Z +        let mut tx_hashes: Vec<Hash> = block
2025-11-09T23:42:54.7245992Z +            .transactions
2025-11-09T23:42:54.7246065Z +            .iter()
2025-11-09T23:42:54.7246159Z              .map(|tx| calculate_tx_id(tx))
2025-11-09T23:42:54.7246241Z              .collect();
2025-11-09T23:42:54.7246310Z  
2025-11-09T23:42:54.7246598Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/stratum_v2/pool.rs:528:
2025-11-09T23:42:54.7246708Z                      combined.extend_from_slice(&chunk[0]);
2025-11-09T23:42:54.7246828Z                      let parent_hash = double_sha256(&combined);
2025-11-09T23:42:54.7246927Z                      next_level.push(parent_hash);
2025-11-09T23:42:54.7247002Z -                    
2025-11-09T23:42:54.7247073Z +
2025-11-09T23:42:54.7247245Z                      // If current_index is the last (odd) transaction, no sibling to add
2025-11-09T23:42:54.7247346Z                      let pair_start = pair_idx * 2;
2025-11-09T23:42:54.7247451Z                      if current_index == pair_start {
2025-11-09T23:42:54.7247794Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/stratum_v2/server.rs:214:
2025-11-09T23:42:54.7247904Z          // Get block template from MiningCoordinator
2025-11-09T23:42:54.7247992Z          let template = {
2025-11-09T23:42:54.7248280Z              let mut coordinator = self.mining_coordinator.write().await;
2025-11-09T23:42:54.7248401Z -            coordinator.generate_block_template().await
2025-11-09T23:42:54.7248656Z -                .map_err(|e| StratumV2Error::MiningJob(format!("Failed to generate block template: {}", e)))?
2025-11-09T23:42:54.7248816Z +            coordinator.generate_block_template().await.map_err(|e| {
2025-11-09T23:42:54.7249035Z +                StratumV2Error::MiningJob(format!("Failed to generate block template: {}", e))
2025-11-09T23:42:54.7249104Z +            })?
2025-11-09T23:42:54.7249180Z          };
2025-11-09T23:42:54.7249250Z  
2025-11-09T23:42:54.7249493Z -        debug!("Generated new block template with {} transactions", template.transactions.len());
2025-11-09T23:42:54.7249568Z +        debug!(
2025-11-09T23:42:54.7249703Z +            "Generated new block template with {} transactions",
2025-11-09T23:42:54.7249804Z +            template.transactions.len()
2025-11-09T23:42:54.7249878Z +        );
2025-11-09T23:42:54.7249949Z  
2025-11-09T23:42:54.7250114Z          // Set template in pool and get distribution messages
2025-11-09T23:42:54.7250214Z          let (job_id, messages) = {
2025-11-09T23:42:54.7250518Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/stratum_v2/server.rs:273:
2025-11-09T23:42:54.7250740Z          if let Some(ref mut conn) = *conn {
2025-11-09T23:42:54.7250957Z              // Use channel-specific sending - transports that support channels (QUIC/Iroh)
2025-11-09T23:42:54.7251161Z              // will route to the appropriate channel stream, others will use default send()
2025-11-09T23:42:54.7251323Z -            conn.send_on_channel(channel_id, &encoded).await.map_err(|e| {
2025-11-09T23:42:54.7251513Z -                StratumV2Error::Network(format!("Failed to send job message: {}", e))
2025-11-09T23:42:54.7251583Z -            })?;
2025-11-09T23:42:54.7251700Z +            conn.send_on_channel(channel_id, &encoded)
2025-11-09T23:42:54.7251779Z +                .await
2025-11-09T23:42:54.7251862Z +                .map_err(|e| {
2025-11-09T23:42:54.7252056Z +                    StratumV2Error::Network(format!("Failed to send job message: {}", e))
2025-11-09T23:42:54.7252127Z +                })?;
2025-11-09T23:42:54.7252197Z          } else {
2025-11-09T23:42:54.7252352Z              return Err(StratumV2Error::Connection(anyhow::anyhow!(
2025-11-09T23:42:54.7252446Z                  "Connection not available"
2025-11-09T23:42:54.7289329Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:101:
2025-11-09T23:42:54.7290453Z                  {
2025-11-09T23:42:54.7291061Z                      use crate::network::transport::TransportAddr;
2025-11-09T23:42:54.7291202Z                      use hex;
2025-11-09T23:42:54.7291340Z -                    
2025-11-09T23:42:54.7291457Z +
2025-11-09T23:42:54.7291793Z                      let node_id_hex = peer_id.strip_prefix("iroh:").ok_or_else(|| {
2025-11-09T23:42:54.7292310Z                          bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-09T23:42:54.7292548Z                              format!("Invalid Iroh peer_id format: {}", peer_id)
2025-11-09T23:42:54.7293190Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:108:
2025-11-09T23:42:54.7293351Z                          )
2025-11-09T23:42:54.7293486Z                      })?;
2025-11-09T23:42:54.7293616Z -                    
2025-11-09T23:42:54.7293743Z +
2025-11-09T23:42:54.7294024Z                      let node_id_bytes = hex::decode(node_id_hex).map_err(|e| {
2025-11-09T23:42:54.7294753Z                          bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-09T23:42:54.7294995Z                              format!("Invalid Iroh node ID hex: {}", e)
2025-11-09T23:42:54.7295835Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:114:
2025-11-09T23:42:54.7296263Z                          )
2025-11-09T23:42:54.7296403Z                      })?;
2025-11-09T23:42:54.7296539Z -                    
2025-11-09T23:42:54.7296660Z +
2025-11-09T23:42:54.7296950Z                      // Validate node ID length (Iroh uses 32-byte public keys)
2025-11-09T23:42:54.7297147Z                      if node_id_bytes.len() != 32 {
2025-11-09T23:42:54.7297754Z                          return Err(bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-09T23:42:54.7298413Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:120:
2025-11-09T23:42:54.7298857Z                              format!("Invalid Iroh node ID length: expected 32 bytes, got {}", node_id_bytes.len())
2025-11-09T23:42:54.7298995Z                          ));
2025-11-09T23:42:54.7299124Z                      }
2025-11-09T23:42:54.7299260Z -                    
2025-11-09T23:42:54.7299392Z +
2025-11-09T23:42:54.7299736Z                      // Create placeholder SocketAddr for Iroh (same approach as mod.rs)
2025-11-09T23:42:54.7299992Z                      // Use first 4 bytes of key for IP, last 2 bytes for port
2025-11-09T23:42:54.7300595Z -                    let ip_bytes = [node_id_bytes[0], node_id_bytes[1], node_id_bytes[2], node_id_bytes[3]];
2025-11-09T23:42:54.7300771Z +                    let ip_bytes = [
2025-11-09T23:42:54.7300932Z +                        node_id_bytes[0],
2025-11-09T23:42:54.7301096Z +                        node_id_bytes[1],
2025-11-09T23:42:54.7301245Z +                        node_id_bytes[2],
2025-11-09T23:42:54.7301384Z +                        node_id_bytes[3],
2025-11-09T23:42:54.7301503Z +                    ];
2025-11-09T23:42:54.7301817Z                      let port = u16::from_be_bytes([node_id_bytes[30], node_id_bytes[31]]);
2025-11-09T23:42:54.7302149Z                      let placeholder_addr = std::net::SocketAddr::from((ip_bytes, port));
2025-11-09T23:42:54.7302282Z -                    
2025-11-09T23:42:54.7302399Z +
2025-11-09T23:42:54.7302656Z                      let transport_addr = TransportAddr::Iroh(node_id_bytes);
2025-11-09T23:42:54.7302873Z                      Some((placeholder_addr, Some(transport_addr)))
2025-11-09T23:42:54.7302994Z                  }
2025-11-09T23:42:54.7303577Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:148:
2025-11-09T23:42:54.7303701Z                      ));
2025-11-09T23:42:54.7303813Z                  }
2025-11-09T23:42:54.7303929Z              };
2025-11-09T23:42:54.7304040Z -            
2025-11-09T23:42:54.7304149Z +
2025-11-09T23:42:54.7304482Z              // Store TransportAddr mapping if Iroh
2025-11-09T23:42:54.7304713Z              if let Some(transport_addr) = transport_addr_opt {
2025-11-09T23:42:54.7304913Z                  let network = network_manager.read().await;
2025-11-09T23:42:54.7305522Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:155:
2025-11-09T23:42:54.7305812Z                  // Store mapping from placeholder SocketAddr to TransportAddr
2025-11-09T23:42:54.7306202Z -                network.socket_to_transport.lock().unwrap().insert(peer_addr, transport_addr);
2025-11-09T23:42:54.7306335Z +                network
2025-11-09T23:42:54.7306497Z +                    .socket_to_transport
2025-11-09T23:42:54.7306621Z +                    .lock()
2025-11-09T23:42:54.7306749Z +                    .unwrap()
2025-11-09T23:42:54.7306934Z +                    .insert(peer_addr, transport_addr);
2025-11-09T23:42:54.7307069Z                  drop(network);
2025-11-09T23:42:54.7307183Z              }
2025-11-09T23:42:54.7307294Z  
2025-11-09T23:42:54.7307897Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:160:
2025-11-09T23:42:54.7308285Z              // Check if peer supports UTXO commitments before sending request
2025-11-09T23:42:54.7308738Z              let network = network_manager.read().await;
2025-11-09T23:42:54.7308852Z -            
2025-11-09T23:42:54.7308967Z +
2025-11-09T23:42:54.7309161Z              // Get peer version to check capabilities
2025-11-09T23:42:54.7309336Z              let peer_supports_utxo_commitments = {
2025-11-09T23:42:54.7309585Z                  let peer_states = network.peer_states.lock().unwrap();
2025-11-09T23:42:54.7310162Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:178:
2025-11-09T23:42:54.7310292Z                      false
2025-11-09T23:42:54.7310405Z                  }
2025-11-09T23:42:54.7310521Z              };
2025-11-09T23:42:54.7310632Z -            
2025-11-09T23:42:54.7310746Z +
2025-11-09T23:42:54.7311080Z              // If we know the peer doesn't support UTXO commitments, return error early
2025-11-09T23:42:54.7311268Z              if !peer_supports_utxo_commitments {
2025-11-09T23:42:54.7311414Z                  drop(network);
2025-11-09T23:42:54.7312000Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:186:
2025-11-09T23:42:54.7312527Z                      format!("Peer {} does not support UTXO commitments (missing NODE_UTXO_COMMITMENTS service flag)", peer_id)
2025-11-09T23:42:54.7312876Z                  ));
2025-11-09T23:42:54.7313004Z              }
2025-11-09T23:42:54.7313126Z -            
2025-11-09T23:42:54.7313236Z +
2025-11-09T23:42:54.7313425Z              // Register pending request before sending
2025-11-09T23:42:54.7313992Z              let (request_id, response_rx) = network.register_request(peer_addr);
2025-11-09T23:42:54.7314236Z              drop(network); // Release read lock before async wait
2025-11-09T23:42:54.7316349Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:193:
2025-11-09T23:42:54.7316471Z -            
2025-11-09T23:42:54.7316610Z +
2025-11-09T23:42:54.7316808Z              // Create GetUTXOSet message with request_id
2025-11-09T23:42:54.7317003Z -            let get_utxo_set_msg = GetUTXOSetMessage { 
2025-11-09T23:42:54.7317189Z +            let get_utxo_set_msg = GetUTXOSetMessage {
2025-11-09T23:42:54.7317327Z                  request_id,
2025-11-09T23:42:54.7317455Z -                height, 
2025-11-09T23:42:54.7317592Z -                block_hash 
2025-11-09T23:42:54.7317718Z +                height,
2025-11-09T23:42:54.7317847Z +                block_hash,
2025-11-09T23:42:54.7317955Z              };
2025-11-09T23:42:54.7318064Z  
2025-11-09T23:42:54.7318409Z              // Serialize message using protocol adapter (handles TCP vs Iroh format)
2025-11-09T23:42:54.7319099Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:203:
2025-11-09T23:42:54.7319641Z                  .map_err(|e| bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-09T23:42:54.7319879Z                      format!("Failed to serialize GetUTXOSet: {}", e)
2025-11-09T23:42:54.7320000Z                  ))?;
2025-11-09T23:42:54.7320111Z -            
2025-11-09T23:42:54.7320225Z +
2025-11-09T23:42:54.7320407Z              // Send message to peer via NetworkManager
2025-11-09T23:42:54.7320520Z              {
2025-11-09T23:42:54.7320723Z                  let network = network_manager.read().await;
2025-11-09T23:42:54.7321298Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:212:
2025-11-09T23:42:54.7321595Z                          format!("Failed to send GetUTXOSet to peer {}: {}", peer_addr, e)
2025-11-09T23:42:54.7321711Z                      ))?;
2025-11-09T23:42:54.7321830Z              }
2025-11-09T23:42:54.7321933Z -            
2025-11-09T23:42:54.7322041Z +
2025-11-09T23:42:54.7322228Z              // Await response with timeout (30 seconds)
2025-11-09T23:42:54.7322593Z              tokio::select! {
2025-11-09T23:42:54.7322738Z                  result = response_rx => {
2025-11-09T23:42:54.7323322Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:224:
2025-11-09T23:42:54.7323870Z                                  .map_err(|e| bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-09T23:42:54.7326160Z                                      format!("Failed to parse UTXOSet response: {}", e)
2025-11-09T23:42:54.7326301Z                                  ))?;
2025-11-09T23:42:54.7326430Z -                            
2025-11-09T23:42:54.7326541Z +
2025-11-09T23:42:54.7326697Z                              match parsed {
2025-11-09T23:42:54.7326929Z                                  ProtocolMessage::UTXOSet(utxo_set_msg) => {
2025-11-09T23:42:54.7327107Z                                      // Convert to UtxoCommitment
2025-11-09T23:42:54.7327689Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:291:
2025-11-09T23:42:54.7327819Z                  {
2025-11-09T23:42:54.7328046Z                      use crate::network::transport::TransportAddr;
2025-11-09T23:42:54.7328170Z                      use hex;
2025-11-09T23:42:54.7328287Z -                    
2025-11-09T23:42:54.7328400Z +
2025-11-09T23:42:54.7328938Z                      let node_id_hex = peer_id.strip_prefix("iroh:").ok_or_else(|| {
2025-11-09T23:42:54.7329438Z                          bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-09T23:42:54.7329681Z                              format!("Invalid Iroh peer_id format: {}", peer_id)
2025-11-09T23:42:54.7330271Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:298:
2025-11-09T23:42:54.7330393Z                          )
2025-11-09T23:42:54.7330524Z                      })?;
2025-11-09T23:42:54.7330647Z -                    
2025-11-09T23:42:54.7330764Z +
2025-11-09T23:42:54.7331022Z                      let node_id_bytes = hex::decode(node_id_hex).map_err(|e| {
2025-11-09T23:42:54.7331515Z                          bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-09T23:42:54.7331703Z                              format!("Invalid Iroh node ID hex: {}", e)
2025-11-09T23:42:54.7332297Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:304:
2025-11-09T23:42:54.7332428Z                          )
2025-11-09T23:42:54.7332545Z                      })?;
2025-11-09T23:42:54.7332659Z -                    
2025-11-09T23:42:54.7332772Z +
2025-11-09T23:42:54.7333024Z                      // Validate node ID length (Iroh uses 32-byte public keys)
2025-11-09T23:42:54.7333187Z                      if node_id_bytes.len() != 32 {
2025-11-09T23:42:54.7333701Z                          return Err(bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-09T23:42:54.7334277Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:310:
2025-11-09T23:42:54.7334815Z                              format!("Invalid Iroh node ID length: expected 32 bytes, got {}", node_id_bytes.len())
2025-11-09T23:42:54.7334947Z                          ));
2025-11-09T23:42:54.7335063Z                      }
2025-11-09T23:42:54.7335171Z -                    
2025-11-09T23:42:54.7335274Z +
2025-11-09T23:42:54.7335580Z                      // Create placeholder SocketAddr for Iroh (same approach as mod.rs)
2025-11-09T23:42:54.7335804Z                      // Use first 4 bytes of key for IP, last 2 bytes for port
2025-11-09T23:42:54.7336599Z -                    let ip_bytes = [node_id_bytes[0], node_id_bytes[1], node_id_bytes[2], node_id_bytes[3]];
2025-11-09T23:42:54.7337504Z +                    let ip_bytes = [
2025-11-09T23:42:54.7337670Z +                        node_id_bytes[0],
2025-11-09T23:42:54.7338078Z +                        node_id_bytes[1],
2025-11-09T23:42:54.7338221Z +                        node_id_bytes[2],
2025-11-09T23:42:54.7338369Z +                        node_id_bytes[3],
2025-11-09T23:42:54.7338488Z +                    ];
2025-11-09T23:42:54.7338818Z                      let port = u16::from_be_bytes([node_id_bytes[30], node_id_bytes[31]]);
2025-11-09T23:42:54.7339166Z                      let placeholder_addr = std::net::SocketAddr::from((ip_bytes, port));
2025-11-09T23:42:54.7339288Z -                    
2025-11-09T23:42:54.7339401Z +
2025-11-09T23:42:54.7339686Z                      let transport_addr = TransportAddr::Iroh(node_id_bytes);
2025-11-09T23:42:54.7339905Z                      Some((placeholder_addr, Some(transport_addr)))
2025-11-09T23:42:54.7340024Z                  }
2025-11-09T23:42:54.7340598Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:338:
2025-11-09T23:42:54.7340738Z                      ));
2025-11-09T23:42:54.7340854Z                  }
2025-11-09T23:42:54.7340964Z              };
2025-11-09T23:42:54.7341081Z -            
2025-11-09T23:42:54.7341192Z +
2025-11-09T23:42:54.7341372Z              // Store TransportAddr mapping if Iroh
2025-11-09T23:42:54.7341596Z              if let Some(transport_addr) = transport_addr_opt {
2025-11-09T23:42:54.7342014Z                  let network = network_manager.read().await;
2025-11-09T23:42:54.7342638Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:345:
2025-11-09T23:42:54.7342934Z                  // Store mapping from placeholder SocketAddr to TransportAddr
2025-11-09T23:42:54.7343333Z -                network.socket_to_transport.lock().unwrap().insert(peer_addr, transport_addr);
2025-11-09T23:42:54.7343459Z +                network
2025-11-09T23:42:54.7343611Z +                    .socket_to_transport
2025-11-09T23:42:54.7343740Z +                    .lock()
2025-11-09T23:42:54.7343881Z +                    .unwrap()
2025-11-09T23:42:54.7344058Z +                    .insert(peer_addr, transport_addr);
2025-11-09T23:42:54.7344196Z                  drop(network);
2025-11-09T23:42:54.7344487Z              }
2025-11-09T23:42:54.7344603Z  
2025-11-09T23:42:54.7345211Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:351:
2025-11-09T23:42:54.7345414Z              let network = network_manager.read().await;
2025-11-09T23:42:54.7345720Z              let (request_id, response_rx) = network.register_request(peer_addr);
2025-11-09T23:42:54.7346432Z              drop(network); // Release read lock before async wait
2025-11-09T23:42:54.7346561Z -            
2025-11-09T23:42:54.7346670Z +
2025-11-09T23:42:54.7346876Z              // Create GetFilteredBlock message with request_id
2025-11-09T23:42:54.7347104Z              use crate::network::protocol::FilterPreferences;
2025-11-09T23:42:54.7347361Z              let get_filtered_block_msg = GetFilteredBlockMessage {
2025-11-09T23:42:54.7347972Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:371:
2025-11-09T23:42:54.7348505Z                  .map_err(|e| bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-09T23:42:54.7348769Z                      format!("Failed to serialize GetFilteredBlock: {}", e)
2025-11-09T23:42:54.7348890Z                  ))?;
2025-11-09T23:42:54.7349007Z -            
2025-11-09T23:42:54.7349128Z +
2025-11-09T23:42:54.7349316Z              // Send message to peer via NetworkManager
2025-11-09T23:42:54.7349430Z              {
2025-11-09T23:42:54.7349623Z                  let network = network_manager.read().await;
2025-11-09T23:42:54.7350219Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:380:
2025-11-09T23:42:54.7350553Z                          format!("Failed to send GetFilteredBlock to peer {}: {}", peer_addr, e)
2025-11-09T23:42:54.7350937Z                      ))?;
2025-11-09T23:42:54.7351058Z              }
2025-11-09T23:42:54.7351168Z -            
2025-11-09T23:42:54.7351284Z +
2025-11-09T23:42:54.7351473Z              // Await response with timeout (30 seconds)
2025-11-09T23:42:54.7351632Z              tokio::select! {
2025-11-09T23:42:54.7351802Z                  result = response_rx => {
2025-11-09T23:42:54.7352410Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/network/utxo_commitments_client.rs:392:
2025-11-09T23:42:54.7352949Z                                  .map_err(|e| bllvm_protocol::utxo_commitments::data_structures::UtxoCommitmentError::SerializationError(
2025-11-09T23:42:54.7353227Z                                      format!("Failed to parse FilteredBlock response: {}", e)
2025-11-09T23:42:54.7353363Z                                  ))?;
2025-11-09T23:42:54.7353493Z -                            
2025-11-09T23:42:54.7353606Z +
2025-11-09T23:42:54.7353774Z                              match parsed {
2025-11-09T23:42:54.7354071Z                                  ProtocolMessage::FilteredBlock(filtered_block_msg) => {
2025-11-09T23:42:54.7354250Z                                      // Convert to FilteredBlock
2025-11-09T23:42:54.7354931Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/health.rs:144:
2025-11-09T23:42:54.7355330Z          // Determine overall status
2025-11-09T23:42:54.7355765Z          let overall_status = if components.iter().any(|c| c.status == HealthStatus::Down) {
2025-11-09T23:42:54.7355921Z              HealthStatus::Down
2025-11-09T23:42:54.7356256Z -        } else if components.iter().any(|c| c.status == HealthStatus::Unhealthy) {
2025-11-09T23:42:54.7356410Z +        } else if components
2025-11-09T23:42:54.7356533Z +            .iter()
2025-11-09T23:42:54.7356741Z +            .any(|c| c.status == HealthStatus::Unhealthy)
2025-11-09T23:42:54.7356863Z +        {
2025-11-09T23:42:54.7357025Z              HealthStatus::Unhealthy
2025-11-09T23:42:54.7357352Z -        } else if components.iter().any(|c| c.status == HealthStatus::Degraded) {
2025-11-09T23:42:54.7357497Z +        } else if components
2025-11-09T23:42:54.7357617Z +            .iter()
2025-11-09T23:42:54.7357803Z +            .any(|c| c.status == HealthStatus::Degraded)
2025-11-09T23:42:54.7357907Z +        {
2025-11-09T23:42:54.7358062Z              HealthStatus::Degraded
2025-11-09T23:42:54.7358177Z          } else {
2025-11-09T23:42:54.7358314Z              HealthStatus::Healthy
2025-11-09T23:42:54.7358749Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/health.rs:180:
2025-11-09T23:42:54.7358874Z          Self::new()
2025-11-09T23:42:54.7358991Z      }
2025-11-09T23:42:54.7359101Z  }
2025-11-09T23:42:54.7359207Z -
2025-11-09T23:42:54.7359313Z  
2025-11-09T23:42:54.7370958Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:1:
2025-11-09T23:42:54.7371121Z  //! Mempool manager
2025-11-09T23:42:54.7371247Z -//! 
2025-11-09T23:42:54.7371362Z +//!
2025-11-09T23:42:54.7371662Z  //! Handles transaction mempool management, validation, and relay.
2025-11-09T23:42:54.7371774Z  
2025-11-09T23:42:54.7373816Z  use anyhow::Result;
2025-11-09T23:42:54.7375043Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:6:
2025-11-09T23:42:54.7375337Z -use bllvm_protocol::{Transaction, UtxoSet, Hash, OutPoint};
2025-11-09T23:42:54.7375530Z  use bllvm_protocol::mempool::Mempool;
2025-11-09T23:42:54.7375787Z +use bllvm_protocol::{Hash, OutPoint, Transaction, UtxoSet};
2025-11-09T23:42:54.7375961Z  use std::collections::{HashMap, HashSet};
2025-11-09T23:42:54.7376116Z  use tracing::{debug, info};
2025-11-09T23:42:54.7376233Z  
2025-11-09T23:42:54.7376687Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:31:
2025-11-09T23:42:54.7376862Z              spent_outputs: HashSet::new(),
2025-11-09T23:42:54.7376986Z          }
2025-11-09T23:42:54.7377364Z      }
2025-11-09T23:42:54.7377478Z -    
2025-11-09T23:42:54.7377589Z +
2025-11-09T23:42:54.7377749Z      /// Start the mempool manager
2025-11-09T23:42:54.7378109Z      pub async fn start(&mut self) -> Result<()> {
2025-11-09T23:42:54.7378277Z          info!("Starting mempool manager");
2025-11-09T23:42:54.7378757Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:38:
2025-11-09T23:42:54.7378874Z -        
2025-11-09T23:42:54.7378984Z +
2025-11-09T23:42:54.7379134Z          // Initialize mempool
2025-11-09T23:42:54.7379300Z          self.initialize_mempool().await?;
2025-11-09T23:42:54.7379414Z -        
2025-11-09T23:42:54.7379522Z +
2025-11-09T23:42:54.7379688Z          // Start mempool processing loop
2025-11-09T23:42:54.7379846Z          self.process_loop().await?;
2025-11-09T23:42:54.7379960Z -        
2025-11-09T23:42:54.7380071Z +
2025-11-09T23:42:54.7380193Z          Ok(())
2025-11-09T23:42:54.7380303Z      }
2025-11-09T23:42:54.7380422Z -    
2025-11-09T23:42:54.7380539Z +
2025-11-09T23:42:54.7380735Z      /// Run mempool processing once (for testing)
2025-11-09T23:42:54.7380961Z      pub async fn process_once(&mut self) -> Result<()> {
2025-11-09T23:42:54.7381122Z          // Process pending transactions
2025-11-09T23:42:54.7381568Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:51:
2025-11-09T23:42:54.7381949Z          self.process_pending_transactions().await?;
2025-11-09T23:42:54.7382063Z -        
2025-11-09T23:42:54.7382173Z +
2025-11-09T23:42:54.7382315Z          // Clean up old transactions
2025-11-09T23:42:54.7382482Z          self.cleanup_old_transactions().await?;
2025-11-09T23:42:54.7382596Z -        
2025-11-09T23:42:54.7382711Z +
2025-11-09T23:42:54.7382822Z          Ok(())
2025-11-09T23:42:54.7382929Z      }
2025-11-09T23:42:54.7383046Z -    
2025-11-09T23:42:54.7383156Z +
2025-11-09T23:42:54.7383288Z      /// Initialize mempool
2025-11-09T23:42:54.7383510Z      async fn initialize_mempool(&mut self) -> Result<()> {
2025-11-09T23:42:54.7383676Z          debug!("Initializing mempool");
2025-11-09T23:42:54.7384110Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:62:
2025-11-09T23:42:54.7386291Z -        
2025-11-09T23:42:54.7386414Z +
2025-11-09T23:42:54.7386627Z          // Load existing mempool from storage if available
2025-11-09T23:42:54.7386886Z          // In a real implementation, this would restore mempool state
2025-11-09T23:42:54.7386995Z -        
2025-11-09T23:42:54.7387104Z +
2025-11-09T23:42:54.7387212Z          Ok(())
2025-11-09T23:42:54.7387315Z      }
2025-11-09T23:42:54.7387424Z -    
2025-11-09T23:42:54.7387525Z +
2025-11-09T23:42:54.7387674Z      /// Main mempool processing loop
2025-11-09T23:42:54.7387876Z      async fn process_loop(&mut self) -> Result<()> {
2025-11-09T23:42:54.7388006Z          loop {
2025-11-09T23:42:54.7388455Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:72:
2025-11-09T23:42:54.7388627Z              // Process pending transactions
2025-11-09T23:42:54.7388824Z              self.process_pending_transactions().await?;
2025-11-09T23:42:54.7388936Z -            
2025-11-09T23:42:54.7389046Z +
2025-11-09T23:42:54.7389199Z              // Clean up old transactions
2025-11-09T23:42:54.7389386Z              self.cleanup_old_transactions().await?;
2025-11-09T23:42:54.7389527Z -            
2025-11-09T23:42:54.7389636Z +
2025-11-09T23:42:54.7389804Z              // Small delay to prevent busy waiting
2025-11-09T23:42:54.7390114Z              tokio::time::sleep(tokio::time::Duration::from_millis(100)).await;
2025-11-09T23:42:54.7390236Z          }
2025-11-09T23:42:54.7390691Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:81:
2025-11-09T23:42:54.7390806Z      }
2025-11-09T23:42:54.7390923Z -    
2025-11-09T23:42:54.7391032Z +
2025-11-09T23:42:54.7391197Z      /// Process pending transactions
2025-11-09T23:42:54.7391492Z      async fn process_pending_transactions(&mut self) -> Result<()> {
2025-11-09T23:42:54.7391942Z          // In a real implementation, this would:
2025-11-09T23:42:54.7402844Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:87:
2025-11-09T23:42:54.7403133Z          // 2. Validate transactions using consensus-proof
2025-11-09T23:42:54.7403324Z          // 3. Add valid transactions to mempool
2025-11-09T23:42:54.7403499Z          // 4. Relay transactions to peers
2025-11-09T23:42:54.7403627Z -        
2025-11-09T23:42:54.7403740Z +
2025-11-09T23:42:54.7403938Z          debug!("Processing pending transactions");
2025-11-09T23:42:54.7406949Z          Ok(())
2025-11-09T23:42:54.7407088Z      }
2025-11-09T23:42:54.7407570Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:94:
2025-11-09T23:42:54.7407692Z -    
2025-11-09T23:42:54.7407813Z +
2025-11-09T23:42:54.7407970Z      /// Clean up old transactions
2025-11-09T23:42:54.7408243Z      async fn cleanup_old_transactions(&mut self) -> Result<()> {
2025-11-09T23:42:54.7408442Z          // In a real implementation, this would:
2025-11-09T23:42:54.7408904Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:98:
2025-11-09T23:42:54.7409082Z          // 1. Remove transactions that are too old
2025-11-09T23:42:54.7409600Z          // 2. Remove transactions that conflict with new blocks
2025-11-09T23:42:54.7409796Z          // 3. Update transaction priorities
2025-11-09T23:42:54.7409911Z -        
2025-11-09T23:42:54.7410021Z +
2025-11-09T23:42:54.7410202Z          debug!("Cleaning up old transactions");
2025-11-09T23:42:54.7410316Z          Ok(())
2025-11-09T23:42:54.7410424Z      }
2025-11-09T23:42:54.7410880Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:105:
2025-11-09T23:42:54.7411468Z -    
2025-11-09T23:42:54.7411603Z +
2025-11-09T23:42:54.7411757Z      /// Add transaction to mempool
2025-11-09T23:42:54.7412075Z      pub async fn add_transaction(&mut self, tx: Transaction) -> Result<bool> {
2025-11-09T23:42:54.7412252Z          debug!("Adding transaction to mempool");
2025-11-09T23:42:54.7412679Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:109:
2025-11-09T23:42:54.7412798Z -        
2025-11-09T23:42:54.7412910Z +
2025-11-09T23:42:54.7413170Z          // Check for conflicts with existing mempool transactions
2025-11-09T23:42:54.7413325Z          for input in &tx.inputs {
2025-11-09T23:42:54.7413565Z              if self.spent_outputs.contains(&input.prevout) {
2025-11-09T23:42:54.7416363Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:114:
2025-11-09T23:42:54.7416518Z                  return Ok(false);
2025-11-09T23:42:54.7416640Z              }
2025-11-09T23:42:54.7416754Z          }
2025-11-09T23:42:54.7416870Z -        
2025-11-09T23:42:54.7416981Z +
2025-11-09T23:42:54.7417219Z          // Add transaction to mempool (store full transaction)
2025-11-09T23:42:54.7417445Z          use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:42:54.7417609Z          let tx_hash = calculate_tx_id(&tx);
2025-11-09T23:42:54.7418076Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:121:
2025-11-09T23:42:54.7418279Z          self.transactions.insert(tx_hash, tx.clone());
2025-11-09T23:42:54.7418436Z          self.mempool.insert(tx_hash);
2025-11-09T23:42:54.7418557Z -        
2025-11-09T23:42:54.7418665Z +
2025-11-09T23:42:54.7418801Z          // Track spent outputs
2025-11-09T23:42:54.7418936Z          for input in &tx.inputs {
2025-11-09T23:42:54.7419160Z              self.spent_outputs.insert(input.prevout.clone());
2025-11-09T23:42:54.7419609Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:127:
2025-11-09T23:42:54.7419730Z          }
2025-11-09T23:42:54.7419845Z -        
2025-11-09T23:42:54.7419953Z +
2025-11-09T23:42:54.7420073Z          Ok(true)
2025-11-09T23:42:54.7420429Z      }
2025-11-09T23:42:54.7420547Z -    
2025-11-09T23:42:54.7420658Z +
2025-11-09T23:42:54.7420799Z      /// Get mempool size
2025-11-09T23:42:54.7420941Z      pub fn size(&self) -> usize {
2025-11-09T23:42:54.7421081Z          self.transactions.len()
2025-11-09T23:42:54.7421503Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:135:
2025-11-09T23:42:54.7421618Z      }
2025-11-09T23:42:54.7421724Z -    
2025-11-09T23:42:54.7421818Z +
2025-11-09T23:42:54.7421963Z      /// Get mempool transaction hashes
2025-11-09T23:42:54.7422154Z      pub fn transaction_hashes(&self) -> Vec<Hash> {
2025-11-09T23:42:54.7422332Z          self.transactions.keys().cloned().collect()
2025-11-09T23:42:54.7422758Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:140:
2025-11-09T23:42:54.7422871Z      }
2025-11-09T23:42:54.7422986Z -    
2025-11-09T23:42:54.7423095Z +
2025-11-09T23:42:54.7423241Z      /// Get transaction by hash
2025-11-09T23:42:54.7423547Z      pub fn get_transaction(&self, hash: &Hash) -> Option<Transaction> {
2025-11-09T23:42:54.7423713Z          self.transactions.get(hash).cloned()
2025-11-09T23:42:54.7424153Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:145:
2025-11-09T23:42:54.7424269Z      }
2025-11-09T23:42:54.7424389Z -    
2025-11-09T23:42:54.7424498Z +
2025-11-09T23:42:54.7424839Z      /// Get all transactions
2025-11-09T23:42:54.7425079Z      pub fn get_transactions(&self) -> Vec<Transaction> {
2025-11-09T23:42:54.7425266Z          self.transactions.values().cloned().collect()
2025-11-09T23:42:54.7426378Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:150:
2025-11-09T23:42:54.7426513Z      }
2025-11-09T23:42:54.7426632Z -    
2025-11-09T23:42:54.7426746Z +
2025-11-09T23:42:54.7426941Z      /// Get prioritized transactions by fee rate
2025-11-09T23:42:54.7427066Z -    /// 
2025-11-09T23:42:54.7427181Z +    ///
2025-11-09T23:42:54.7427598Z      /// Returns transactions sorted by fee rate (satoshis per vbyte) in descending order.
2025-11-09T23:42:54.7428213Z      /// Requires UTXO set to calculate fee rates.
2025-11-09T23:42:54.7428716Z -    pub fn get_prioritized_transactions(&self, limit: usize, utxo_set: &UtxoSet) -> Vec<Transaction> {
2025-11-09T23:42:54.7428895Z +    pub fn get_prioritized_transactions(
2025-11-09T23:42:54.7429024Z +        &self,
2025-11-09T23:42:54.7429157Z +        limit: usize,
2025-11-09T23:42:54.7429289Z +        utxo_set: &UtxoSet,
2025-11-09T23:42:54.7429428Z +    ) -> Vec<Transaction> {
2025-11-09T23:42:54.7429693Z          let mut tx_with_fees: Vec<(Transaction, u64)> = Vec::new();
2025-11-09T23:42:54.7429809Z -        
2025-11-09T23:42:54.7429918Z +
2025-11-09T23:42:54.7430096Z          for tx in self.transactions.values() {
2025-11-09T23:42:54.7430271Z              // Calculate fee for this transaction
2025-11-09T23:42:54.7430502Z              let fee = self.calculate_transaction_fee(tx, utxo_set);
2025-11-09T23:42:54.7430951Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:162:
2025-11-09T23:42:54.7431069Z -            
2025-11-09T23:42:54.7431178Z +
2025-11-09T23:42:54.7431530Z              // Calculate transaction size (simplified - use serialized size estimate)
2025-11-09T23:42:54.7431730Z              let size = self.estimate_transaction_size(tx);
2025-11-09T23:42:54.7431857Z -            
2025-11-09T23:42:54.7431964Z +
2025-11-09T23:42:54.7432142Z              // Calculate fee rate (satoshis per vbyte)
2025-11-09T23:42:54.7432298Z              let fee_rate = if size > 0 {
2025-11-09T23:42:54.7432678Z                  fee * 1000 / size as u64 // Convert to satoshis per vbyte (multiply by 1000 for precision)
2025-11-09T23:42:54.7433141Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:169:
2025-11-09T23:42:54.7433270Z              } else {
2025-11-09T23:42:54.7433385Z                  0
2025-11-09T23:42:54.7433501Z              };
2025-11-09T23:42:54.7433875Z -            
2025-11-09T23:42:54.7433996Z +
2025-11-09T23:42:54.7434181Z              tx_with_fees.push((tx.clone(), fee_rate));
2025-11-09T23:42:54.7436321Z          }
2025-11-09T23:42:54.7436446Z -        
2025-11-09T23:42:54.7436565Z +
2025-11-09T23:42:54.7436724Z          // Sort by fee rate (descending)
2025-11-09T23:42:54.7436921Z          tx_with_fees.sort_by(|a, b| b.1.cmp(&a.1));
2025-11-09T23:42:54.7437047Z -        
2025-11-09T23:42:54.7437158Z +
2025-11-09T23:42:54.7437312Z          // Return top N transactions
2025-11-09T23:42:54.7437456Z -        tx_with_fees.into_iter()
2025-11-09T23:42:54.7437584Z +        tx_with_fees
2025-11-09T23:42:54.7437715Z +            .into_iter()
2025-11-09T23:42:54.7437840Z              .take(limit)
2025-11-09T23:42:54.7437981Z              .map(|(tx, _)| tx)
2025-11-09T23:42:54.7438104Z              .collect()
2025-11-09T23:42:54.7438567Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:184:
2025-11-09T23:42:54.7438694Z      }
2025-11-09T23:42:54.7438812Z -    
2025-11-09T23:42:54.7438925Z +
2025-11-09T23:42:54.7439076Z      /// Calculate transaction fee
2025-11-09T23:42:54.7439197Z -    /// 
2025-11-09T23:42:54.7439311Z +    ///
2025-11-09T23:42:54.7439483Z      /// Fee = sum of inputs - sum of outputs
2025-11-09T23:42:54.7440112Z      pub fn calculate_transaction_fee(&self, tx: &Transaction, utxo_set: &UtxoSet) -> u64 {
2025-11-09T23:42:54.7440293Z          let mut input_total = 0u64;
2025-11-09T23:42:54.7440768Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:191:
2025-11-09T23:42:54.7440885Z -        
2025-11-09T23:42:54.7441003Z +
2025-11-09T23:42:54.7441160Z          // Sum input values from UTXO set
2025-11-09T23:42:54.7441308Z          for input in &tx.inputs {
2025-11-09T23:42:54.7441531Z              if let Some(utxo) = utxo_set.get(&input.prevout) {
2025-11-09T23:42:54.7441988Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:195:
2025-11-09T23:42:54.7442172Z                  input_total += utxo.value as u64;
2025-11-09T23:42:54.7442284Z              }
2025-11-09T23:42:54.7442403Z          }
2025-11-09T23:42:54.7442516Z -        
2025-11-09T23:42:54.7442623Z +
2025-11-09T23:42:54.7442763Z          // Sum output values
2025-11-09T23:42:54.7443107Z          let output_total: u64 = tx.outputs.iter().map(|out| out.value as u64).sum();
2025-11-09T23:42:54.7443223Z -        
2025-11-09T23:42:54.7443332Z +
2025-11-09T23:42:54.7443515Z          // Fee is difference (inputs - outputs)
2025-11-09T23:42:54.7443671Z          if input_total > output_total {
2025-11-09T23:42:54.7443824Z              input_total - output_total
2025-11-09T23:42:54.7444477Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:206:
2025-11-09T23:42:54.7446443Z              0
2025-11-09T23:42:54.7446556Z          }
2025-11-09T23:42:54.7446669Z      }
2025-11-09T23:42:54.7446785Z -    
2025-11-09T23:42:54.7446904Z +
2025-11-09T23:42:54.7447076Z      /// Estimate transaction size in vbytes
2025-11-09T23:42:54.7447197Z -    /// 
2025-11-09T23:42:54.7447307Z +    ///
2025-11-09T23:42:54.7447661Z      /// Simplified estimation - in production, would use actual serialized size
2025-11-09T23:42:54.7447956Z      fn estimate_transaction_size(&self, tx: &Transaction) -> usize {
2025-11-09T23:42:54.7448235Z          // Base transaction size: version (4) + locktime (4) = 8 bytes
2025-11-09T23:42:54.7448695Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:215:
2025-11-09T23:42:54.7448832Z          let mut size = 8;
2025-11-09T23:42:54.7448954Z -        
2025-11-09T23:42:54.7449063Z +
2025-11-09T23:42:54.7449320Z          // Input size: prevout (36) + script_sig (var) + sequence (4)
2025-11-09T23:42:54.7449475Z          for input in &tx.inputs {
2025-11-09T23:42:54.7449621Z              size += 36; // prevout
2025-11-09T23:42:54.7450070Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:220:
2025-11-09T23:42:54.7450491Z              size += input.script_sig.len();
2025-11-09T23:42:54.7450634Z              size += 4; // sequence
2025-11-09T23:42:54.7450747Z          }
2025-11-09T23:42:54.7450857Z -        
2025-11-09T23:42:54.7450972Z +
2025-11-09T23:42:54.7451172Z          // Output size: value (8) + script_pubkey (var)
2025-11-09T23:42:54.7451333Z          for output in &tx.outputs {
2025-11-09T23:42:54.7451466Z              size += 8; // value
2025-11-09T23:42:54.7451924Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:227:
2025-11-09T23:42:54.7452097Z              size += output.script_pubkey.len();
2025-11-09T23:42:54.7452209Z          }
2025-11-09T23:42:54.7452326Z -        
2025-11-09T23:42:54.7452435Z +
2025-11-09T23:42:54.7452778Z          // Add witness discount if segwit (simplified - assume no witness for now)
2025-11-09T23:42:54.7452899Z          size
2025-11-09T23:42:54.7453017Z      }
2025-11-09T23:42:54.7453483Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:233:
2025-11-09T23:42:54.7453597Z -    
2025-11-09T23:42:54.7453715Z +
2025-11-09T23:42:54.7453878Z      /// Remove transaction from mempool
2025-11-09T23:42:54.7454131Z      pub fn remove_transaction(&mut self, hash: &Hash) -> bool {
2025-11-09T23:42:54.7454795Z          if let Some(tx) = self.transactions.remove(hash) {
2025-11-09T23:42:54.7455301Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:237:
2025-11-09T23:42:54.7455465Z              self.mempool.remove(hash);
2025-11-09T23:42:54.7455580Z -            
2025-11-09T23:42:54.7455698Z +
2025-11-09T23:42:54.7455864Z              // Remove spent outputs tracking
2025-11-09T23:42:54.7456016Z              for input in &tx.inputs {
2025-11-09T23:42:54.7456221Z                  self.spent_outputs.remove(&input.prevout);
2025-11-09T23:42:54.7456691Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:242:
2025-11-09T23:42:54.7456820Z              }
2025-11-09T23:42:54.7456933Z -            
2025-11-09T23:42:54.7457052Z +
2025-11-09T23:42:54.7457168Z              true
2025-11-09T23:42:54.7457280Z          } else {
2025-11-09T23:42:54.7457397Z              false
2025-11-09T23:42:54.7457865Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:247:
2025-11-09T23:42:54.7457989Z          }
2025-11-09T23:42:54.7458101Z      }
2025-11-09T23:42:54.7458217Z -    
2025-11-09T23:42:54.7458328Z +
2025-11-09T23:42:54.7458455Z      /// Clear mempool
2025-11-09T23:42:54.7458600Z      pub fn clear(&mut self) {
2025-11-09T23:42:54.7458761Z          self.transactions.clear();
2025-11-09T23:42:54.7459224Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:253:
2025-11-09T23:42:54.7459371Z          self.mempool.clear();
2025-11-09T23:42:54.7459535Z          self.spent_outputs.clear();
2025-11-09T23:42:54.7459649Z      }
2025-11-09T23:42:54.7459767Z -    
2025-11-09T23:42:54.7459875Z +
2025-11-09T23:42:54.7460060Z      /// Save mempool to disk for persistence
2025-11-09T23:42:54.7460425Z      pub fn save_to_disk<P: AsRef<std::path::Path>>(&self, path: P) -> Result<()> {
2025-11-09T23:42:54.7460768Z +        use bllvm_protocol::serialization::transaction::serialize_transaction;
2025-11-09T23:42:54.7460912Z          use std::fs::File;
2025-11-09T23:42:54.7461057Z          use std::io::Write;
2025-11-09T23:42:54.7461400Z -        use bllvm_protocol::serialization::transaction::serialize_transaction;
2025-11-09T23:42:54.7461525Z -        
2025-11-09T23:42:54.7461636Z +
2025-11-09T23:42:54.7461831Z          let transactions = self.get_transactions();
2025-11-09T23:42:54.7462005Z          let mut file = File::create(path)?;
2025-11-09T23:42:54.7462123Z -        
2025-11-09T23:42:54.7462229Z +
2025-11-09T23:42:54.7462373Z          // Write transaction count
2025-11-09T23:42:54.7462641Z          file.write_all(&(transactions.len() as u32).to_le_bytes())?;
2025-11-09T23:42:54.7463045Z -        
2025-11-09T23:42:54.7463157Z +
2025-11-09T23:42:54.7463303Z          // Write each transaction
2025-11-09T23:42:54.7463451Z          for tx in transactions {
2025-11-09T23:42:54.7463647Z              let serialized = serialize_transaction(&tx);
2025-11-09T23:42:54.7464116Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:272:
2025-11-09T23:42:54.7464549Z              file.write_all(&(serialized.len() as u32).to_le_bytes())?;
2025-11-09T23:42:54.7464714Z              file.write_all(&serialized)?;
2025-11-09T23:42:54.7464826Z          }
2025-11-09T23:42:54.7466825Z -        
2025-11-09T23:42:54.7466940Z +
2025-11-09T23:42:54.7467072Z          file.sync_all()?;
2025-11-09T23:42:54.7467188Z          Ok(())
2025-11-09T23:42:54.7467308Z      }
2025-11-09T23:42:54.7467767Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:279:
2025-11-09T23:42:54.7467877Z  }
2025-11-09T23:42:54.7467984Z  
2025-11-09T23:42:54.7468159Z  impl Default for MempoolManager {
2025-11-09T23:42:54.7468335Z -    fn default() -> Self { Self::new() }
2025-11-09T23:42:54.7468476Z +    fn default() -> Self {
2025-11-09T23:42:54.7468607Z +        Self::new()
2025-11-09T23:42:54.7468715Z +    }
2025-11-09T23:42:54.7468825Z  }
2025-11-09T23:42:54.7468935Z  
2025-11-09T23:42:54.7469519Z  // Implement MempoolProvider trait for integration with MiningCoordinator
2025-11-09T23:42:54.7469993Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:298:
2025-11-09T23:42:54.7470123Z          self.size()
2025-11-09T23:42:54.7470246Z      }
2025-11-09T23:42:54.7470356Z  
2025-11-09T23:42:54.7470998Z -    fn get_prioritized_transactions(&self, limit: usize, utxo_set: &bllvm_protocol::UtxoSet) -> Vec<bllvm_protocol::Transaction> {
2025-11-09T23:42:54.7471170Z +    fn get_prioritized_transactions(
2025-11-09T23:42:54.7471283Z +        &self,
2025-11-09T23:42:54.7471408Z +        limit: usize,
2025-11-09T23:42:54.7471593Z +        utxo_set: &bllvm_protocol::UtxoSet,
2025-11-09T23:42:54.7471770Z +    ) -> Vec<bllvm_protocol::Transaction> {
2025-11-09T23:42:54.7471991Z          self.get_prioritized_transactions(limit, utxo_set)
2025-11-09T23:42:54.7472104Z      }
2025-11-09T23:42:54.7472221Z  
2025-11-09T23:42:54.7472689Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:312:
2025-11-09T23:42:54.7472832Z  impl MempoolManager {
2025-11-09T23:42:54.7472977Z      /// Load mempool from disk
2025-11-09T23:42:54.7473358Z      pub fn load_from_disk<P: AsRef<std::path::Path>>(&mut self, path: P) -> Result<()> {
2025-11-09T23:42:54.7473713Z +        use bllvm_protocol::serialization::transaction::deserialize_transaction;
2025-11-09T23:42:54.7473855Z          use std::fs::File;
2025-11-09T23:42:54.7474004Z          use std::io::Read;
2025-11-09T23:42:54.7474520Z -        use bllvm_protocol::serialization::transaction::deserialize_transaction;
2025-11-09T23:42:54.7474640Z -        
2025-11-09T23:42:54.7476616Z +
2025-11-09T23:42:54.7476784Z          let mut file = File::open(path)?;
2025-11-09T23:42:54.7476939Z          let mut count_bytes = [0u8; 4];
2025-11-09T23:42:54.7477099Z          file.read_exact(&mut count_bytes)?;
2025-11-09T23:42:54.7477553Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:322:
2025-11-09T23:42:54.7477776Z          let count = u32::from_le_bytes(count_bytes) as usize;
2025-11-09T23:42:54.7477890Z -        
2025-11-09T23:42:54.7478003Z +
2025-11-09T23:42:54.7478132Z          for _ in 0..count {
2025-11-09T23:42:54.7478277Z              let mut len_bytes = [0u8; 4];
2025-11-09T23:42:54.7478435Z              file.read_exact(&mut len_bytes)?;
2025-11-09T23:42:54.7478886Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:327:
2025-11-09T23:42:54.7479093Z              let len = u32::from_le_bytes(len_bytes) as usize;
2025-11-09T23:42:54.7479200Z -            
2025-11-09T23:42:54.7479306Z +
2025-11-09T23:42:54.7479668Z              let mut tx_bytes = vec![0u8; len];
2025-11-09T23:42:54.7479815Z              file.read_exact(&mut tx_bytes)?;
2025-11-09T23:42:54.7479925Z -            
2025-11-09T23:42:54.7480026Z +
2025-11-09T23:42:54.7480210Z              let tx = deserialize_transaction(&tx_bytes)?;
2025-11-09T23:42:54.7480357Z              let _ = self.add_transaction(tx);
2025-11-09T23:42:54.7480473Z          }
2025-11-09T23:42:54.7480899Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mempool.rs:335:
2025-11-09T23:42:54.7481003Z -        
2025-11-09T23:42:54.7481111Z +
2025-11-09T23:42:54.7481219Z          Ok(())
2025-11-09T23:42:54.7481322Z      }
2025-11-09T23:42:54.7481425Z  }
2025-11-09T23:42:54.7481891Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/metrics.rs:2:
2025-11-09T23:42:54.7481998Z  //!
2025-11-09T23:42:54.7482402Z  //! Provides comprehensive metrics for monitoring node health, performance, and behavior.
2025-11-09T23:42:54.7482518Z  
2025-11-09T23:42:54.7482674Z +use serde::{Deserialize, Serialize};
2025-11-09T23:42:54.7482795Z  use std::sync::Arc;
2025-11-09T23:42:54.7482924Z  use std::sync::Mutex;
2025-11-09T23:42:54.7483117Z  use std::time::{Duration, SystemTime, UNIX_EPOCH};
2025-11-09T23:42:54.7483530Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/metrics.rs:8:
2025-11-09T23:42:54.7483835Z -use serde::{Deserialize, Serialize};
2025-11-09T23:42:54.7484044Z  
2025-11-09T23:42:54.7484182Z  /// Comprehensive node metrics
2025-11-09T23:42:54.7484579Z  #[derive(Debug, Clone, Serialize, Deserialize)]
2025-11-09T23:42:54.7485015Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/metrics.rs:251:
2025-11-09T23:42:54.7485149Z          Self::new()
2025-11-09T23:42:54.7485266Z      }
2025-11-09T23:42:54.7485381Z  }
2025-11-09T23:42:54.7485490Z -
2025-11-09T23:42:54.7485593Z  
2025-11-09T23:42:54.7519551Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/miner.rs:20:
2025-11-09T23:42:54.7519763Z  
2025-11-09T23:42:54.7519969Z      /// Get prioritized transactions (by fee rate)
2025-11-09T23:42:54.7520190Z      /// Requires UTXO set for accurate fee calculation
2025-11-09T23:42:54.7520720Z -    fn get_prioritized_transactions(&self, limit: usize, utxo_set: &bllvm_protocol::UtxoSet) -> Vec<Transaction>;
2025-11-09T23:42:54.7520894Z +    fn get_prioritized_transactions(
2025-11-09T23:42:54.7521015Z +        &self,
2025-11-09T23:42:54.7521141Z +        limit: usize,
2025-11-09T23:42:54.7521311Z +        utxo_set: &bllvm_protocol::UtxoSet,
2025-11-09T23:42:54.7521448Z +    ) -> Vec<Transaction>;
2025-11-09T23:42:54.7521571Z  
2025-11-09T23:42:54.7521728Z      /// Remove transaction from mempool
2025-11-09T23:42:54.7521973Z      fn remove_transaction(&mut self, hash: &[u8; 32]) -> bool;
2025-11-09T23:42:54.7522425Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/miner.rs:57:
2025-11-09T23:42:54.7522545Z  
2025-11-09T23:42:54.7522710Z      /// Select transactions for block
2025-11-09T23:42:54.7523027Z      /// Note: Requires UTXO set for fee calculation - caller must provide it
2025-11-09T23:42:54.7523666Z -    pub fn select_transactions(&self, mempool: &dyn MempoolProvider, utxo_set: &bllvm_protocol::UtxoSet) -> Vec<Transaction> {
2025-11-09T23:42:54.7523823Z +    pub fn select_transactions(
2025-11-09T23:42:54.7523949Z +        &self,
2025-11-09T23:42:54.7524117Z +        mempool: &dyn MempoolProvider,
2025-11-09T23:42:54.7524554Z +        utxo_set: &bllvm_protocol::UtxoSet,
2025-11-09T23:42:54.7524717Z +    ) -> Vec<Transaction> {
2025-11-09T23:42:54.7524878Z          let mut selected = Vec::new();
2025-11-09T23:42:54.7525022Z          let mut current_size = 0;
2025-11-09T23:42:54.7525163Z          let mut current_weight = 0;
2025-11-09T23:42:54.7525611Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/miner.rs:392:
2025-11-09T23:42:54.7525727Z  
2025-11-09T23:42:54.7525992Z          // Get chain tip from storage for prev_block_hash and difficulty
2025-11-09T23:42:54.7526594Z          let (prev_block_hash, bits, height) = if let Some(ref storage) = self.storage {
2025-11-09T23:42:54.7526844Z -            if let Some(tip_header) = storage.chain().get_tip_header()
2025-11-09T23:42:54.7527131Z -                .map_err(|e| anyhow::anyhow!("Failed to get tip header: {}", e))? {
2025-11-09T23:42:54.7527341Z -                let tip_hash = storage.chain().get_tip_hash()
2025-11-09T23:42:54.7527512Z +            if let Some(tip_header) = storage
2025-11-09T23:42:54.7527646Z +                .chain()
2025-11-09T23:42:54.7527786Z +                .get_tip_header()
2025-11-09T23:42:54.7528064Z +                .map_err(|e| anyhow::anyhow!("Failed to get tip header: {}", e))?
2025-11-09T23:42:54.7528185Z +            {
2025-11-09T23:42:54.7528329Z +                let tip_hash = storage
2025-11-09T23:42:54.7528455Z +                    .chain()
2025-11-09T23:42:54.7528594Z +                    .get_tip_hash()
2025-11-09T23:42:54.7528874Z                      .map_err(|e| anyhow::anyhow!("Failed to get tip hash: {}", e))?
2025-11-09T23:42:54.7529018Z                      .unwrap_or([0u8; 32]);
2025-11-09T23:42:54.7529226Z -                let chain_height = storage.chain().get_height()
2025-11-09T23:42:54.7529387Z +                let chain_height = storage
2025-11-09T23:42:54.7529516Z +                    .chain()
2025-11-09T23:42:54.7529875Z +                    .get_height()
2025-11-09T23:42:54.7530197Z                      .map_err(|e| anyhow::anyhow!("Failed to get chain height: {}", e))?
2025-11-09T23:42:54.7530334Z                      .unwrap_or(0);
2025-11-09T23:42:54.7530519Z                  (tip_hash, tip_header.bits, chain_height)
2025-11-09T23:42:54.7530968Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/miner.rs:412:
2025-11-09T23:42:54.7531091Z  
2025-11-09T23:42:54.7531295Z          // Get UTXO set from storage for fee calculation
2025-11-09T23:42:54.7531531Z          let utxo_set = if let Some(ref storage) = self.storage {
2025-11-09T23:42:54.7531715Z -            storage.utxos().get_all_utxos()
2025-11-09T23:42:54.7531839Z +            storage
2025-11-09T23:42:54.7531965Z +                .utxos()
2025-11-09T23:42:54.7532106Z +                .get_all_utxos()
2025-11-09T23:42:54.7532375Z                  .map_err(|e| anyhow::anyhow!("Failed to get UTXO set: {}", e))?
2025-11-09T23:42:54.7532502Z          } else {
2025-11-09T23:42:54.7532744Z              // No storage - use empty UTXO set (will result in 0 fees)
2025-11-09T23:42:54.7533194Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/miner.rs:616:
2025-11-09T23:42:54.7533348Z          self.transactions.len()
2025-11-09T23:42:54.7533461Z      }
2025-11-09T23:42:54.7533581Z  
2025-11-09T23:42:54.7534125Z -    fn get_prioritized_transactions(&self, limit: usize, _utxo_set: &bllvm_protocol::UtxoSet) -> Vec<Transaction> {
2025-11-09T23:42:54.7534581Z +    fn get_prioritized_transactions(
2025-11-09T23:42:54.7534726Z +        &self,
2025-11-09T23:42:54.7534858Z +        limit: usize,
2025-11-09T23:42:54.7535040Z +        _utxo_set: &bllvm_protocol::UtxoSet,
2025-11-09T23:42:54.7535176Z +    ) -> Vec<Transaction> {
2025-11-09T23:42:54.7535538Z          // Mock implementation ignores UTXO set and uses pre-calculated priorities
2025-11-09T23:42:54.7535703Z          self.prioritized_transactions
2025-11-09T23:42:54.7535831Z              .iter()
2025-11-09T23:42:54.7536286Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/miner.rs:786:
2025-11-09T23:42:54.7536478Z          assert_eq!(mempool.get_mempool_size(), 0);
2025-11-09T23:42:54.7536686Z          assert!(mempool.get_transactions().is_empty());
2025-11-09T23:42:54.7536919Z          let empty_utxo_set = bllvm_protocol::UtxoSet::new();
2025-11-09T23:42:54.7537297Z -        assert!(mempool.get_prioritized_transactions(10, &empty_utxo_set).is_empty());
2025-11-09T23:42:54.7537432Z +        assert!(mempool
2025-11-09T23:42:54.7537909Z +            .get_prioritized_transactions(10, &empty_utxo_set)
2025-11-09T23:42:54.7538050Z +            .is_empty());
2025-11-09T23:42:54.7538161Z      }
2025-11-09T23:42:54.7538263Z  
2025-11-09T23:42:54.7538368Z      #[test]
2025-11-09T23:42:54.7635450Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:5:
2025-11-09T23:42:54.7635615Z  
2025-11-09T23:42:54.7635785Z  pub mod block_processor;
2025-11-09T23:42:54.7635930Z  pub mod event_publisher;
2025-11-09T23:42:54.7636054Z +pub mod health;
2025-11-09T23:42:54.7636180Z  pub mod mempool;
2025-11-09T23:42:54.7636314Z -pub mod miner;
2025-11-09T23:42:54.7636434Z -pub mod sync;
2025-11-09T23:42:54.7636558Z  pub mod metrics;
2025-11-09T23:42:54.7636686Z -pub mod health;
2025-11-09T23:42:54.7636807Z +pub mod miner;
2025-11-09T23:42:54.7636939Z  pub mod performance;
2025-11-09T23:42:54.7637057Z +pub mod sync;
2025-11-09T23:42:54.7637171Z  
2025-11-09T23:42:54.7637314Z  use anyhow::Result;
2025-11-09T23:42:54.7637451Z  use std::net::SocketAddr;
2025-11-09T23:42:54.7638734Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:70:
2025-11-09T23:42:54.7638843Z  
2025-11-09T23:42:54.7638984Z          // Initialize components
2025-11-09T23:42:54.7639342Z          let protocol_version = protocol_version.unwrap_or(ProtocolVersion::Regtest);
2025-11-09T23:42:54.7639474Z -        let protocol =
2025-11-09T23:42:54.7639938Z -            BitcoinProtocolEngine::new(protocol_version)?;
2025-11-09T23:42:54.7640235Z +        let protocol = BitcoinProtocolEngine::new(protocol_version)?;
2025-11-09T23:42:54.7640424Z          let protocol_arc = Arc::new(protocol);
2025-11-09T23:42:54.7640598Z          let storage = Storage::new(data_dir)?;
2025-11-09T23:42:54.7640767Z          let storage_arc = Arc::new(storage);
2025-11-09T23:42:54.7641199Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:78:
2025-11-09T23:42:54.7641509Z          let mempool_manager_arc = Arc::new(mempool::MempoolManager::new());
2025-11-09T23:42:54.7641732Z -        let network = NetworkManager::new(network_addr)
2025-11-09T23:42:54.7642261Z -            .with_dependencies(Arc::clone(&protocol_arc), Arc::clone(&storage_arc), Arc::clone(&mempool_manager_arc));
2025-11-09T23:42:54.7642596Z +        let network = NetworkManager::new(network_addr).with_dependencies(
2025-11-09T23:42:54.7642771Z +            Arc::clone(&protocol_arc),
2025-11-09T23:42:54.7642928Z +            Arc::clone(&storage_arc),
2025-11-09T23:42:54.7643110Z +            Arc::clone(&mempool_manager_arc),
2025-11-09T23:42:54.7643226Z +        );
2025-11-09T23:42:54.7643393Z          let network_arc = Arc::new(network);
2025-11-09T23:42:54.7643636Z          let metrics_arc = Arc::new(MetricsCollector::new());
2025-11-09T23:42:54.7643921Z          let profiler_arc = Arc::new(PerformanceProfiler::new(1000));
2025-11-09T23:42:54.7644603Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:187:
2025-11-09T23:42:54.7644815Z          info!("Sync coordinator initialized");
2025-11-09T23:42:54.7644989Z          info!("Mempool manager initialized");
2025-11-09T23:42:54.7645337Z          info!("Mining coordinator initialized");
2025-11-09T23:42:54.7645453Z -        
2025-11-09T23:42:54.7645574Z +
2025-11-09T23:42:54.7645718Z          // Start network manager
2025-11-09T23:42:54.7645991Z          if let Err(e) = self.network.start(self.network_addr).await {
2025-11-09T23:42:54.7646215Z              warn!("Failed to start network manager: {}", e);
2025-11-09T23:42:54.7646659Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:194:
2025-11-09T23:42:54.7646860Z              // Continue anyway - network might be optional
2025-11-09T23:42:54.7646979Z          }
2025-11-09T23:42:54.7647091Z -        
2025-11-09T23:42:54.7647198Z +
2025-11-09T23:42:54.7647396Z          // Initialize peer connections automatically
2025-11-09T23:42:54.7647589Z          self.initialize_peer_connections().await?;
2025-11-09T23:42:54.7647986Z  
2025-11-09T23:42:54.7648430Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:203:
2025-11-09T23:42:54.7648598Z              if config.prune_on_startup {
2025-11-09T23:42:54.7648919Z                  let current_height = self.storage.chain().get_height()?.unwrap_or(0);
2025-11-09T23:42:54.7649084Z                  let is_ibd = current_height == 0;
2025-11-09T23:42:54.7649207Z -                
2025-11-09T23:42:54.7649322Z +
2025-11-09T23:42:54.7649517Z                  if !is_ibd && pruning_manager.is_enabled() {
2025-11-09T23:42:54.7649829Z                      info!("Prune on startup enabled, checking if pruning is needed...");
2025-11-09T23:42:54.7649954Z -                    
2025-11-09T23:42:54.7650062Z +
2025-11-09T23:42:54.7650284Z                      // Calculate prune height based on configuration
2025-11-09T23:42:54.7650476Z                      let prune_height = match &config.mode {
2025-11-09T23:42:54.7650704Z                          crate::config::PruningMode::Disabled => {
2025-11-09T23:42:54.7651157Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:213:
2025-11-09T23:42:54.7651312Z                              // Skip if disabled
2025-11-09T23:42:54.7651448Z                              None
2025-11-09T23:42:54.7651564Z                          }
2025-11-09T23:42:54.7652058Z -                        crate::config::PruningMode::Normal { keep_from_height, .. } => {
2025-11-09T23:42:54.7652245Z +                        crate::config::PruningMode::Normal {
2025-11-09T23:42:54.7652393Z +                            keep_from_height, ..
2025-11-09T23:42:54.7652515Z +                        } => {
2025-11-09T23:42:54.7652689Z                              // Prune up to keep_from_height
2025-11-09T23:42:54.7652846Z                              Some(*keep_from_height)
2025-11-09T23:42:54.7652981Z                          }
2025-11-09T23:42:54.7653391Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:220:
2025-11-09T23:42:54.7653570Z                          #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.7653879Z -                        crate::config::PruningMode::Aggressive { keep_from_height, .. } => {
2025-11-09T23:42:54.7654065Z +                        crate::config::PruningMode::Aggressive {
2025-11-09T23:42:54.7654222Z +                            keep_from_height, ..
2025-11-09T23:42:54.7654523Z +                        } => {
2025-11-09T23:42:54.7654703Z                              // Prune up to keep_from_height
2025-11-09T23:42:54.7654869Z                              Some(*keep_from_height)
2025-11-09T23:42:54.7654993Z                          }
2025-11-09T23:42:54.7655427Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:228:
2025-11-09T23:42:54.7655639Z                              // Fall back to no pruning if feature is disabled
2025-11-09T23:42:54.7655768Z                              None
2025-11-09T23:42:54.7655881Z                          }
2025-11-09T23:42:54.7656227Z -                        crate::config::PruningMode::Custom { keep_bodies_from_height, .. } => {
2025-11-09T23:42:54.7656420Z +                        crate::config::PruningMode::Custom {
2025-11-09T23:42:54.7656581Z +                            keep_bodies_from_height,
2025-11-09T23:42:54.7656703Z +                            ..
2025-11-09T23:42:54.7656830Z +                        } => {
2025-11-09T23:42:54.7657031Z                              // Prune up to keep_bodies_from_height
2025-11-09T23:42:54.7657203Z                              Some(*keep_bodies_from_height)
2025-11-09T23:42:54.7657321Z                          }
2025-11-09T23:42:54.7657758Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:235:
2025-11-09T23:42:54.7657879Z                      };
2025-11-09T23:42:54.7657998Z -                    
2025-11-09T23:42:54.7658119Z +
2025-11-09T23:42:54.7658328Z                      if let Some(prune_to_height) = prune_height {
2025-11-09T23:42:54.7658775Z                          if prune_to_height < current_height {
2025-11-09T23:42:54.7659198Z -                            match pruning_manager.prune_to_height(prune_to_height, current_height, is_ibd) {
2025-11-09T23:42:54.7659407Z +                            match pruning_manager.prune_to_height(
2025-11-09T23:42:54.7659571Z +                                prune_to_height,
2025-11-09T23:42:54.7659723Z +                                current_height,
2025-11-09T23:42:54.7659868Z +                                is_ibd,
2025-11-09T23:42:54.7659997Z +                            ) {
2025-11-09T23:42:54.7660146Z                                  Ok(stats) => {
2025-11-09T23:42:54.7660494Z                                      info!("Startup pruning completed: {} blocks pruned, {} blocks kept", 
2025-11-09T23:42:54.7660716Z                                            stats.blocks_pruned, stats.blocks_kept);
2025-11-09T23:42:54.7661158Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:243:
2025-11-09T23:42:54.7661378Z                                      // Flush storage to persist pruning changes
2025-11-09T23:42:54.7661581Z                                      if let Err(e) = self.storage.flush() {
2025-11-09T23:42:54.7661879Z -                                        warn!("Failed to flush storage after startup pruning: {}", e);
2025-11-09T23:42:54.7662238Z +                                        warn!(
2025-11-09T23:42:54.7662517Z +                                            "Failed to flush storage after startup pruning: {}",
2025-11-09T23:42:54.7662660Z +                                            e
2025-11-09T23:42:54.7662789Z +                                        );
2025-11-09T23:42:54.7662923Z                                      }
2025-11-09T23:42:54.7663048Z                                  }
2025-11-09T23:42:54.7663190Z                                  Err(e) => {
2025-11-09T23:42:54.7663627Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:292:
2025-11-09T23:42:54.7663747Z      }
2025-11-09T23:42:54.7663852Z  
2025-11-09T23:42:54.7664038Z      /// Initialize peer connections automatically
2025-11-09T23:42:54.7664154Z -    /// 
2025-11-09T23:42:54.7664267Z +    ///
2025-11-09T23:42:54.7664782Z      /// Determines network type from protocol version and uses config if available.
2025-11-09T23:42:54.7665062Z      async fn initialize_peer_connections(&self) -> Result<()> {
2025-11-09T23:42:54.7665264Z          // Determine network type from protocol version
2025-11-09T23:42:54.7665679Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:306:
2025-11-09T23:42:54.7665858Z                  if let Some(ref config) = self.config {
2025-11-09T23:42:54.7666137Z                      if let Some(ref persistent_peers) = config.persistent_peers {
2025-11-09T23:42:54.7666826Z                          if !persistent_peers.is_empty() {
2025-11-09T23:42:54.7667230Z -                            if let Err(e) = self.network.connect_persistent_peers(persistent_peers).await {
2025-11-09T23:42:54.7667392Z +                            if let Err(e) = self
2025-11-09T23:42:54.7667526Z +                                .network
2025-11-09T23:42:54.7667746Z +                                .connect_persistent_peers(persistent_peers)
2025-11-09T23:42:54.7667901Z +                                .await
2025-11-09T23:42:54.7668025Z +                            {
2025-11-09T23:42:54.7668306Z                                  warn!("Failed to connect to some persistent peers: {}", e);
2025-11-09T23:42:54.7668431Z                              }
2025-11-09T23:42:54.7668561Z                          }
2025-11-09T23:42:54.7668990Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:315:
2025-11-09T23:42:54.7669124Z                  return Ok(());
2025-11-09T23:42:54.7669248Z              }
2025-11-09T23:42:54.7669362Z          };
2025-11-09T23:42:54.7669478Z -        
2025-11-09T23:42:54.7669827Z +
2025-11-09T23:42:54.7669983Z          // Get port from network address
2025-11-09T23:42:54.7670153Z          let port = self.network_addr.port();
2025-11-09T23:42:54.7670268Z -        
2025-11-09T23:42:54.7670384Z +
2025-11-09T23:42:54.7670711Z          // Default target peer count (Bitcoin Core uses 8-125, we'll use 8 as default)
2025-11-09T23:42:54.7670852Z          let target_peer_count = 8;
2025-11-09T23:42:54.7670967Z -        
2025-11-09T23:42:54.7671083Z +
2025-11-09T23:42:54.7671289Z          // Use config if available, otherwise use defaults
2025-11-09T23:42:54.7671448Z          let default_config = NodeConfig {
2025-11-09T23:42:54.7671620Z              listen_addr: Some(self.network_addr),
2025-11-09T23:42:54.7673929Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:328:
2025-11-09T23:42:54.7674085Z              ..Default::default()
2025-11-09T23:42:54.7674198Z          };
2025-11-09T23:42:54.7674603Z          let config = self.config.as_ref().unwrap_or(&default_config);
2025-11-09T23:42:54.7674724Z -        
2025-11-09T23:42:54.7674823Z +
2025-11-09T23:42:54.7674974Z          // Initialize peer connections
2025-11-09T23:42:54.7675199Z -        if let Err(e) = self.network.initialize_peer_connections(
2025-11-09T23:42:54.7675307Z -            config,
2025-11-09T23:42:54.7675427Z -            network,
2025-11-09T23:42:54.7675738Z -            port,
2025-11-09T23:42:54.7675887Z -            target_peer_count,
2025-11-09T23:42:54.7676005Z -        ).await {
2025-11-09T23:42:54.7676147Z +        if let Err(e) = self
2025-11-09T23:42:54.7676260Z +            .network
2025-11-09T23:42:54.7676571Z +            .initialize_peer_connections(config, network, port, target_peer_count)
2025-11-09T23:42:54.7676685Z +            .await
2025-11-09T23:42:54.7676787Z +        {
2025-11-09T23:42:54.7677001Z              warn!("Failed to initialize peer connections: {}", e);
2025-11-09T23:42:54.7677237Z              // Don't fail startup - peer connections are best-effort
2025-11-09T23:42:54.7677369Z          }
2025-11-09T23:42:54.7677801Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:342:
2025-11-09T23:42:54.7677915Z -        
2025-11-09T23:42:54.7678031Z +
2025-11-09T23:42:54.7678146Z          Ok(())
2025-11-09T23:42:54.7678253Z      }
2025-11-09T23:42:54.7678363Z  
2025-11-09T23:42:54.7678808Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:368:
2025-11-09T23:42:54.7678932Z                  ) {
2025-11-09T23:42:54.7679069Z                      Ok(true) => {
2025-11-09T23:42:54.7679318Z                          info!("Block accepted at height {}", current_height);
2025-11-09T23:42:54.7679444Z -                        
2025-11-09T23:42:54.7679555Z +
2025-11-09T23:42:54.7679791Z                          // Persist UTXO set to storage after block validation
2025-11-09T23:42:54.7680117Z                          // This is critical for commitment generation and incremental pruning
2025-11-09T23:42:54.7680401Z                          if let Err(e) = self.storage.utxos().store_utxo_set(&utxo_set) {
2025-11-09T23:42:54.7680831Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:375:
2025-11-09T23:42:54.7681180Z -                            warn!("Failed to persist UTXO set after block {}: {}", current_height, e);
2025-11-09T23:42:54.7681316Z +                            warn!(
2025-11-09T23:42:54.7681534Z +                                "Failed to persist UTXO set after block {}: {}",
2025-11-09T23:42:54.7681698Z +                                current_height, e
2025-11-09T23:42:54.7681824Z +                            );
2025-11-09T23:42:54.7681941Z                          }
2025-11-09T23:42:54.7682059Z -                        
2025-11-09T23:42:54.7682175Z +
2025-11-09T23:42:54.7682446Z                          // Generate UTXO commitment from current state (if enabled)
2025-11-09T23:42:54.7682807Z                          // Use current_height (the block that was just validated) before incrementing
2025-11-09T23:42:54.7683262Z                          #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.7683706Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:381:
2025-11-09T23:42:54.7683836Z                          {
2025-11-09T23:42:54.7684108Z                              if let Some(pruning_manager) = self.storage.pruning() {
2025-11-09T23:42:54.7686283Z -                                if let (Some(commitment_store), Some(_utxostore)) = 
2025-11-09T23:42:54.7686637Z -                                    (pruning_manager.commitment_store(), pruning_manager.utxostore()) 
2025-11-09T23:42:54.7686781Z -                                {
2025-11-09T23:42:54.7687017Z +                                if let (Some(commitment_store), Some(_utxostore)) = (
2025-11-09T23:42:54.7687218Z +                                    pruning_manager.commitment_store(),
2025-11-09T23:42:54.7687407Z +                                    pruning_manager.utxostore(),
2025-11-09T23:42:54.7687555Z +                                ) {
2025-11-09T23:42:54.7687894Z                                      // Get block hash from storage (block was just stored at current_height)
2025-11-09T23:42:54.7688092Z                                      let blocks_arc = self.storage.blocks();
2025-11-09T23:42:54.7688702Z -                                    if let Ok(Some(block_hash)) = blocks_arc.get_hash_by_height(current_height) {
2025-11-09T23:42:54.7688906Z +                                    if let Ok(Some(block_hash)) =
2025-11-09T23:42:54.7689119Z +                                        blocks_arc.get_hash_by_height(current_height)
2025-11-09T23:42:54.7689247Z +                                    {
2025-11-09T23:42:54.7689467Z                                          // Generate commitment from current UTXO set state
2025-11-09T23:42:54.7689777Z -                                        if let Err(e) = pruning_manager.generate_commitment_from_current_state(
2025-11-09T23:42:54.7689942Z -                                            &block_hash,
2025-11-09T23:42:54.7690094Z -                                            current_height,
2025-11-09T23:42:54.7690234Z -                                            &utxo_set,
2025-11-09T23:42:54.7690389Z -                                            &commitment_store,
2025-11-09T23:42:54.7690532Z -                                        ) {
2025-11-09T23:42:54.7690885Z -                                            warn!("Failed to generate commitment for block {}: {}", current_height, e);
2025-11-09T23:42:54.7691055Z +                                        if let Err(e) = pruning_manager
2025-11-09T23:42:54.7691276Z +                                            .generate_commitment_from_current_state(
2025-11-09T23:42:54.7691431Z +                                                &block_hash,
2025-11-09T23:42:54.7691584Z +                                                current_height,
2025-11-09T23:42:54.7691733Z +                                                &utxo_set,
2025-11-09T23:42:54.7691896Z +                                                &commitment_store,
2025-11-09T23:42:54.7692037Z +                                            )
2025-11-09T23:42:54.7692169Z +                                        {
2025-11-09T23:42:54.7692315Z +                                            warn!(
2025-11-09T23:42:54.7692570Z +                                                "Failed to generate commitment for block {}: {}",
2025-11-09T23:42:54.7692735Z +                                                current_height, e
2025-11-09T23:42:54.7692867Z +                                            );
2025-11-09T23:42:54.7693007Z                                          } else {
2025-11-09T23:42:54.7693310Z -                                            debug!("Generated UTXO commitment for block {}", current_height);
2025-11-09T23:42:54.7693451Z +                                            debug!(
2025-11-09T23:42:54.7693656Z +                                                "Generated UTXO commitment for block {}",
2025-11-09T23:42:54.7694045Z +                                                current_height
2025-11-09T23:42:54.7694181Z +                                            );
2025-11-09T23:42:54.7696401Z                                          }
2025-11-09T23:42:54.7696565Z                                      } else {
2025-11-09T23:42:54.7697003Z                                          warn!("Could not find block hash for height {} to generate commitment", current_height);
2025-11-09T23:42:54.7697446Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:403:
2025-11-09T23:42:54.7697586Z                                  }
2025-11-09T23:42:54.7697709Z                              }
2025-11-09T23:42:54.7697829Z                          }
2025-11-09T23:42:54.7697948Z -                        
2025-11-09T23:42:54.7698071Z +
2025-11-09T23:42:54.7698260Z                          // Increment height after processing
2025-11-09T23:42:54.7698421Z                          current_height += 1;
2025-11-09T23:42:54.7698547Z -                        
2025-11-09T23:42:54.7698658Z +
2025-11-09T23:42:54.7698858Z                          // Check for incremental pruning during IBD
2025-11-09T23:42:54.7699190Z                          // Consider IBD if we're still syncing (height < tip or no recent blocks)
2025-11-09T23:42:54.7699801Z                          let is_ibd = current_height < 1000; // Simple heuristic: consider IBD if < 1000 blocks
2025-11-09T23:42:54.7700263Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:413:
2025-11-09T23:42:54.7700517Z                          if let Some(pruning_manager) = self.storage.pruning() {
2025-11-09T23:42:54.7701033Z -                            if let Ok(Some(prune_stats)) = pruning_manager.incremental_prune_during_ibd(current_height, is_ibd) {
2025-11-09T23:42:54.7701208Z +                            if let Ok(Some(prune_stats)) =
2025-11-09T23:42:54.7701571Z +                                pruning_manager.incremental_prune_during_ibd(current_height, is_ibd)
2025-11-09T23:42:54.7701705Z +                            {
2025-11-09T23:42:54.7702066Z                                  info!("Incremental pruning during IBD: {} blocks pruned, {} bytes freed", 
2025-11-09T23:42:54.7702343Z                                        prune_stats.blocks_pruned, prune_stats.storage_freed);
2025-11-09T23:42:54.7702551Z                                  // Flush storage to persist pruning changes
2025-11-09T23:42:54.7702980Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:418:
2025-11-09T23:42:54.7703164Z                                  if let Err(e) = self.storage.flush() {
2025-11-09T23:42:54.7703486Z -                                    warn!("Failed to flush storage after incremental pruning: {}", e);
2025-11-09T23:42:54.7703629Z +                                    warn!(
2025-11-09T23:42:54.7703900Z +                                        "Failed to flush storage after incremental pruning: {}",
2025-11-09T23:42:54.7704056Z +                                        e
2025-11-09T23:42:54.7704185Z +                                    );
2025-11-09T23:42:54.7704479Z                                  }
2025-11-09T23:42:54.7704610Z                              }
2025-11-09T23:42:54.7704737Z                          }
2025-11-09T23:42:54.7705182Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:423:
2025-11-09T23:42:54.7705308Z -                        
2025-11-09T23:42:54.7705426Z +
2025-11-09T23:42:54.7705663Z                          // Check for automatic pruning after block acceptance
2025-11-09T23:42:54.7705913Z                          if let Some(pruning_manager) = self.storage.pruning() {
2025-11-09T23:42:54.7706112Z                              let stats = pruning_manager.get_stats();
2025-11-09T23:42:54.7706553Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:427:
2025-11-09T23:42:54.7707050Z -                            let should_prune = pruning_manager.should_auto_prune(
2025-11-09T23:42:54.7707207Z -                                current_height,
2025-11-09T23:42:54.7707391Z -                                stats.last_prune_height,
2025-11-09T23:42:54.7707516Z -                            );
2025-11-09T23:42:54.7707638Z -                            
2025-11-09T23:42:54.7707841Z +                            let should_prune = pruning_manager
2025-11-09T23:42:54.7708140Z +                                .should_auto_prune(current_height, stats.last_prune_height);
2025-11-09T23:42:54.7708251Z +
2025-11-09T23:42:54.7708405Z                              if should_prune {
2025-11-09T23:42:54.7708735Z                                  info!("Automatic pruning triggered at height {}", current_height);
2025-11-09T23:42:54.7708866Z -                                
2025-11-09T23:42:54.7708980Z +
2025-11-09T23:42:54.7709209Z                                  // Calculate prune height based on configuration
2025-11-09T23:42:54.7709478Z                                  let prune_height = match &pruning_manager.config.mode {
2025-11-09T23:42:54.7709720Z                                      crate::config::PruningMode::Disabled => None,
2025-11-09T23:42:54.7710158Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:438:
2025-11-09T23:42:54.7710689Z -                                    crate::config::PruningMode::Normal { keep_from_height, .. } => {
2025-11-09T23:42:54.7710912Z +                                    crate::config::PruningMode::Normal {
2025-11-09T23:42:54.7711097Z +                                        keep_from_height, ..
2025-11-09T23:42:54.7711230Z +                                    } => {
2025-11-09T23:42:54.7711507Z                                          // Prune to keep_from_height, but ensure we keep min_blocks
2025-11-09T23:42:54.7711780Z                                          let min_keep = pruning_manager.config.min_blocks_to_keep;
2025-11-09T23:42:54.7712324Z -                                        let effective_keep = (*keep_from_height).max(current_height.saturating_sub(min_keep));
2025-11-09T23:42:54.7712537Z +                                        let effective_keep = (*keep_from_height)
2025-11-09T23:42:54.7712769Z +                                            .max(current_height.saturating_sub(min_keep));
2025-11-09T23:42:54.7712954Z                                          Some(effective_keep)
2025-11-09T23:42:54.7713089Z                                      }
2025-11-09T23:42:54.7713277Z                                      #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.7714044Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:445:
2025-11-09T23:42:54.7716368Z -                                    crate::config::PruningMode::Aggressive { keep_from_height, min_blocks, .. } => {
2025-11-09T23:42:54.7716597Z +                                    crate::config::PruningMode::Aggressive {
2025-11-09T23:42:54.7716791Z +                                        keep_from_height,
2025-11-09T23:42:54.7716941Z +                                        min_blocks,
2025-11-09T23:42:54.7717071Z +                                        ..
2025-11-09T23:42:54.7717198Z +                                    } => {
2025-11-09T23:42:54.7717454Z                                          // Prune to keep_from_height, respecting min_blocks
2025-11-09T23:42:54.7717897Z -                                        let effective_keep = (*keep_from_height).max(current_height.saturating_sub(*min_blocks));
2025-11-09T23:42:54.7718091Z +                                        let effective_keep = (*keep_from_height)
2025-11-09T23:42:54.7718335Z +                                            .max(current_height.saturating_sub(*min_blocks));
2025-11-09T23:42:54.7718525Z                                          Some(effective_keep)
2025-11-09T23:42:54.7719100Z                                      }
2025-11-09T23:42:54.7719588Z                                      #[cfg(not(feature = "utxo-commitments"))]
2025-11-09T23:42:54.7720025Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:453:
2025-11-09T23:42:54.7720272Z                                          // Fall back to no pruning if feature is disabled
2025-11-09T23:42:54.7720417Z                                          None
2025-11-09T23:42:54.7720553Z                                      }
2025-11-09T23:42:54.7720932Z -                                    crate::config::PruningMode::Custom { keep_bodies_from_height, .. } => {
2025-11-09T23:42:54.7721131Z +                                    crate::config::PruningMode::Custom {
2025-11-09T23:42:54.7721299Z +                                        keep_bodies_from_height,
2025-11-09T23:42:54.7729423Z +                                        ..
2025-11-09T23:42:54.7729591Z +                                    } => {
2025-11-09T23:42:54.7729887Z                                          // Prune to keep_bodies_from_height, respecting min_blocks
2025-11-09T23:42:54.7730168Z                                          let min_keep = pruning_manager.config.min_blocks_to_keep;
2025-11-09T23:42:54.7730649Z -                                        let effective_keep = (*keep_bodies_from_height).max(current_height.saturating_sub(min_keep));
2025-11-09T23:42:54.7731101Z +                                        let effective_keep = (*keep_bodies_from_height)
2025-11-09T23:42:54.7731336Z +                                            .max(current_height.saturating_sub(min_keep));
2025-11-09T23:42:54.7731517Z                                          Some(effective_keep)
2025-11-09T23:42:54.7731649Z                                      }
2025-11-09T23:42:54.7731775Z                                  };
2025-11-09T23:42:54.7732210Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:463:
2025-11-09T23:42:54.7732333Z -                                
2025-11-09T23:42:54.7732441Z +
2025-11-09T23:42:54.7732662Z                                  if let Some(prune_to_height) = prune_height {
2025-11-09T23:42:54.7732849Z                                      if prune_to_height < current_height {
2025-11-09T23:42:54.7733250Z -                                        match pruning_manager.prune_to_height(prune_to_height, current_height, false) {
2025-11-09T23:42:54.7733468Z +                                        match pruning_manager.prune_to_height(
2025-11-09T23:42:54.7733654Z +                                            prune_to_height,
2025-11-09T23:42:54.7733819Z +                                            current_height,
2025-11-09T23:42:54.7733965Z +                                            false,
2025-11-09T23:42:54.7736243Z +                                        ) {
2025-11-09T23:42:54.7736438Z                                              Ok(prune_stats) => {
2025-11-09T23:42:54.7736809Z                                                  info!("Automatic pruning completed: {} blocks pruned, {} blocks kept", 
2025-11-09T23:42:54.7737111Z                                                        prune_stats.blocks_pruned, prune_stats.blocks_kept);
2025-11-09T23:42:54.7737556Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:596:
2025-11-09T23:42:54.7737701Z      /// Get health report
2025-11-09T23:42:54.7737973Z      pub fn health_check(&self) -> health::HealthReport {
2025-11-09T23:42:54.7738166Z          use crate::node::health::HealthChecker;
2025-11-09T23:42:54.7738285Z -        
2025-11-09T23:42:54.7738398Z +
2025-11-09T23:42:54.7738583Z          let checker = HealthChecker::new();
2025-11-09T23:42:54.7738820Z          let network_healthy = self.network.is_network_active();
2025-11-09T23:42:54.7739172Z          let storage_healthy = self.storage.check_storage_bounds().unwrap_or(false);
2025-11-09T23:42:54.7739618Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/mod.rs:603:
2025-11-09T23:42:54.7739913Z          let rpc_healthy = true; // RPC is always healthy if node is running
2025-11-09T23:42:54.7740290Z -        
2025-11-09T23:42:54.7740416Z +
2025-11-09T23:42:54.7740629Z          // Get metrics if available (simplified for now)
2025-11-09T23:42:54.7740780Z          checker.check_health(
2025-11-09T23:42:54.7740916Z              network_healthy,
2025-11-09T23:42:54.7741533Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/performance.rs:2:
2025-11-09T23:42:54.7741657Z  //!
2025-11-09T23:42:54.7742087Z  //! Provides performance tracking, profiling hooks, and performance metrics collection.
2025-11-09T23:42:54.7742199Z  
2025-11-09T23:42:54.7742379Z +use serde::{Deserialize, Serialize};
2025-11-09T23:42:54.7742514Z  use std::sync::Arc;
2025-11-09T23:42:54.7742647Z  use std::sync::Mutex;
2025-11-09T23:42:54.7742797Z  use std::time::{Duration, Instant};
2025-11-09T23:42:54.7743280Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/performance.rs:8:
2025-11-09T23:42:54.7743467Z -use serde::{Deserialize, Serialize};
2025-11-09T23:42:54.7743581Z  
2025-11-09T23:42:54.7743816Z  /// Performance profiler for tracking operation timings
2025-11-09T23:42:54.7743995Z  pub struct PerformanceProfiler {
2025-11-09T23:42:54.7746358Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/performance.rs:87:
2025-11-09T23:42:54.7746794Z          let total: Duration = times.iter().sum();
2025-11-09T23:42:54.7746954Z          let count = times.len();
2025-11-09T23:42:54.7747098Z          let avg = total / count as u32;
2025-11-09T23:42:54.7747210Z -        
2025-11-09T23:42:54.7747332Z +
2025-11-09T23:42:54.7747489Z          let mut sorted = times.to_vec();
2025-11-09T23:42:54.7747620Z          sorted.sort();
2025-11-09T23:42:54.7747735Z -        
2025-11-09T23:42:54.7747853Z +
2025-11-09T23:42:54.7748014Z          let p50 = sorted[count / 2];
2025-11-09T23:42:54.7748176Z          let p95 = sorted[(count * 95) / 100];
2025-11-09T23:42:54.7748341Z          let p99 = sorted[(count * 99) / 100];
2025-11-09T23:42:54.7748798Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/performance.rs:166:
2025-11-09T23:42:54.7748956Z      /// Stop the timer and record the duration
2025-11-09T23:42:54.7749096Z      pub fn stop(self) -> Duration {
2025-11-09T23:42:54.7749261Z          let duration = self.start.elapsed();
2025-11-09T23:42:54.7749364Z -        
2025-11-09T23:42:54.7749471Z +
2025-11-09T23:42:54.7749613Z          match self.operation_type {
2025-11-09T23:42:54.7749791Z              OperationType::BlockProcessing => {
2025-11-09T23:42:54.7749996Z                  self.profiler.record_block_processing(duration);
2025-11-09T23:42:54.7750469Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/performance.rs:181:
2025-11-09T23:42:54.7750704Z                  self.profiler.record_network_operation(duration);
2025-11-09T23:42:54.7750820Z              }
2025-11-09T23:42:54.7750935Z          }
2025-11-09T23:42:54.7751056Z -        
2025-11-09T23:42:54.7751172Z +
2025-11-09T23:42:54.7751293Z          duration
2025-11-09T23:42:54.7751403Z      }
2025-11-09T23:42:54.7751522Z  }
2025-11-09T23:42:54.7752009Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/performance.rs:191:
2025-11-09T23:42:54.7752188Z          Self::new(1000) // Keep last 1000 samples
2025-11-09T23:42:54.7752310Z      }
2025-11-09T23:42:54.7752422Z  }
2025-11-09T23:42:54.7752527Z -
2025-11-09T23:42:54.7752635Z  
2025-11-09T23:42:54.7753100Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/sync.rs:188:
2025-11-09T23:42:54.7753278Z          metrics: Option<Arc<MetricsCollector>>,
2025-11-09T23:42:54.7753474Z          profiler: Option<Arc<PerformanceProfiler>>,
2025-11-09T23:42:54.7753617Z      ) -> Result<bool> {
2025-11-09T23:42:54.7753793Z -        let _timer = profiler.as_ref().map(|p| {
2025-11-09T23:42:54.7756154Z -            PerformanceTimer::start(Arc::clone(p), OperationType::BlockProcessing)
2025-11-09T23:42:54.7756508Z -        });
2025-11-09T23:42:54.7756647Z +        let _timer = profiler
2025-11-09T23:42:54.7756768Z +            .as_ref()
2025-11-09T23:42:54.7757164Z +            .map(|p| PerformanceTimer::start(Arc::clone(p), OperationType::BlockProcessing));
2025-11-09T23:42:54.7757337Z          let start_time = Instant::now();
2025-11-09T23:42:54.7757446Z  
2025-11-09T23:42:54.7757684Z          // Parse block from wire format (extracts witness data)
2025-11-09T23:42:54.7758097Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/sync.rs:231:
2025-11-09T23:42:54.7758255Z                  metrics.update_performance(|m| {
2025-11-09T23:42:54.7758461Z                      let time_ms = processing_time.as_secs_f64() * 1000.0;
2025-11-09T23:42:54.7758756Z                      // Update average block processing time (exponential moving average)
2025-11-09T23:42:54.7758916Z -                    m.avg_block_processing_time_ms = 
2025-11-09T23:42:54.7759069Z +                    m.avg_block_processing_time_ms =
2025-11-09T23:42:54.7759301Z                          (m.avg_block_processing_time_ms * 0.9) + (time_ms * 0.1);
2025-11-09T23:42:54.7759458Z                      // Update blocks per second
2025-11-09T23:42:54.7759623Z                      if processing_time.as_secs_f64() > 0.0 {
2025-11-09T23:42:54.7760745Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/node/sync.rs:240:
2025-11-09T23:42:54.7760914Z                  });
2025-11-09T23:42:54.7761261Z              }
2025-11-09T23:42:54.7761381Z  
2025-11-09T23:42:54.7761836Z -            info!("Block validated and stored at height {} (took {:?})", current_height, processing_time);
2025-11-09T23:42:54.7761971Z +            info!(
2025-11-09T23:42:54.7762214Z +                "Block validated and stored at height {} (took {:?})",
2025-11-09T23:42:54.7762385Z +                current_height, processing_time
2025-11-09T23:42:54.7762510Z +            );
2025-11-09T23:42:54.7762631Z              Ok(true)
2025-11-09T23:42:54.7762761Z          } else {
2025-11-09T23:42:54.7763057Z              error!("Block validation failed at height {}", current_height);
2025-11-09T23:42:54.7763500Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:85:
2025-11-09T23:42:54.7763737Z          let elapsed = now.saturating_sub(self.last_refill);
2025-11-09T23:42:54.7763876Z          if elapsed > 0 {
2025-11-09T23:42:54.7764174Z              let tokens_to_add = (elapsed as u32).saturating_mul(self.rate);
2025-11-09T23:42:54.7766463Z -            self.tokens = self.tokens.saturating_add(tokens_to_add).min(self.burst_limit);
2025-11-09T23:42:54.7766624Z +            self.tokens = self
2025-11-09T23:42:54.7766757Z +                .tokens
2025-11-09T23:42:54.7766920Z +                .saturating_add(tokens_to_add)
2025-11-09T23:42:54.7767070Z +                .min(self.burst_limit);
2025-11-09T23:42:54.7767216Z              self.last_refill = now;
2025-11-09T23:42:54.7767340Z          }
2025-11-09T23:42:54.7767459Z  
2025-11-09T23:42:54.7767905Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:134:
2025-11-09T23:42:54.7768028Z      }
2025-11-09T23:42:54.7768139Z  
2025-11-09T23:42:54.7768299Z      /// Create with custom rate limits
2025-11-09T23:42:54.7768440Z -    pub fn with_rate_limits(
2025-11-09T23:42:54.7768584Z -        auth_required: bool,
2025-11-09T23:42:54.7768726Z -        default_burst: u32,
2025-11-09T23:42:54.7768861Z -        default_rate: u32,
2025-11-09T23:42:54.7768991Z -    ) -> Self {
2025-11-09T23:42:54.7769424Z +    pub fn with_rate_limits(auth_required: bool, default_burst: u32, default_rate: u32) -> Self {
2025-11-09T23:42:54.7769547Z          Self {
2025-11-09T23:42:54.7769798Z              valid_tokens: Arc::new(Mutex::new(HashMap::new())),
2025-11-09T23:42:54.7770061Z              valid_certificates: Arc::new(Mutex::new(HashMap::new())),
2025-11-09T23:42:54.7770495Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:154:
2025-11-09T23:42:54.7770996Z          let user_id = UserId::Token(AuthToken::new(token.clone()));
2025-11-09T23:42:54.7771212Z          let mut tokens = self.valid_tokens.lock().await;
2025-11-09T23:42:54.7771387Z          tokens.insert(token, user_id.clone());
2025-11-09T23:42:54.7771500Z -        
2025-11-09T23:42:54.7771620Z +
2025-11-09T23:42:54.7771795Z          // Initialize rate limiter for this user
2025-11-09T23:42:54.7772075Z          let (burst, rate) = self.get_rate_limit_for_user(&user_id).await;
2025-11-09T23:42:54.7772293Z          let mut limiters = self.rate_limiters.lock().await;
2025-11-09T23:42:54.7772721Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:161:
2025-11-09T23:42:54.7773004Z          limiters.insert(user_id, RpcRateLimiter::new(burst, rate));
2025-11-09T23:42:54.7773114Z -        
2025-11-09T23:42:54.7773231Z +
2025-11-09T23:42:54.7773348Z          Ok(())
2025-11-09T23:42:54.7773462Z      }
2025-11-09T23:42:54.7773580Z  
2025-11-09T23:42:54.7773994Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:178:
2025-11-09T23:42:54.7774237Z          let user_id = UserId::Certificate(fingerprint.clone());
2025-11-09T23:42:54.7774710Z          let mut certs = self.valid_certificates.lock().await;
2025-11-09T23:42:54.7774910Z          certs.insert(fingerprint, user_id.clone());
2025-11-09T23:42:54.7775025Z -        
2025-11-09T23:42:54.7775350Z +
2025-11-09T23:42:54.7775537Z          // Initialize rate limiter for this user
2025-11-09T23:42:54.7775794Z          let (burst, rate) = self.get_rate_limit_for_user(&user_id).await;
2025-11-09T23:42:54.7775997Z          let mut limiters = self.rate_limiters.lock().await;
2025-11-09T23:42:54.7776434Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:185:
2025-11-09T23:42:54.7776725Z          limiters.insert(user_id, RpcRateLimiter::new(burst, rate));
2025-11-09T23:42:54.7776842Z -        
2025-11-09T23:42:54.7776951Z +
2025-11-09T23:42:54.7777083Z          Ok(())
2025-11-09T23:42:54.7777182Z      }
2025-11-09T23:42:54.7777285Z  
2025-11-09T23:42:54.7777731Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:201:
2025-11-09T23:42:54.7778086Z      pub async fn set_user_rate_limit(&self, user_id: &UserId, burst: u32, rate: u32) {
2025-11-09T23:42:54.7778316Z          let mut limits = self.user_rate_limits.lock().await;
2025-11-09T23:42:54.7778538Z          limits.insert(user_id.clone(), (burst, rate));
2025-11-09T23:42:54.7778649Z -        
2025-11-09T23:42:54.7778748Z +
2025-11-09T23:42:54.7778922Z          // Update existing rate limiter if present
2025-11-09T23:42:54.7779134Z          let mut limiters = self.rate_limiters.lock().await;
2025-11-09T23:42:54.7779325Z          if let Some(limiter) = limiters.get_mut(user_id) {
2025-11-09T23:42:54.7779764Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:212:
2025-11-09T23:42:54.7780021Z      /// Get rate limit for a user (checks per-user limits first)
2025-11-09T23:42:54.7780345Z      async fn get_rate_limit_for_user(&self, user_id: &UserId) -> (u32, u32) {
2025-11-09T23:42:54.7780548Z          let limits = self.user_rate_limits.lock().await;
2025-11-09T23:42:54.7780813Z -        limits.get(user_id).copied().unwrap_or(self.default_rate_limit)
2025-11-09T23:42:54.7780933Z +        limits
2025-11-09T23:42:54.7781067Z +            .get(user_id)
2025-11-09T23:42:54.7781198Z +            .copied()
2025-11-09T23:42:54.7781376Z +            .unwrap_or(self.default_rate_limit)
2025-11-09T23:42:54.7781489Z      }
2025-11-09T23:42:54.7781600Z  
2025-11-09T23:42:54.7781775Z      /// Authenticate a request from HTTP headers
2025-11-09T23:42:54.7782182Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:283:
2025-11-09T23:42:54.7782321Z      /// Check rate limit for a user
2025-11-09T23:42:54.7782593Z      pub async fn check_rate_limit(&self, user_id: &UserId) -> bool {
2025-11-09T23:42:54.7782797Z          let mut limiters = self.rate_limiters.lock().await;
2025-11-09T23:42:54.7783113Z -        
2025-11-09T23:42:54.7783213Z +
2025-11-09T23:42:54.7783384Z          // Get or create rate limiter for this user
2025-11-09T23:42:54.7783667Z          let limiter = limiters.entry(user_id.clone()).or_insert_with(|| {
2025-11-09T23:42:54.7783859Z              let (burst, rate) = self.default_rate_limit;
2025-11-09T23:42:54.7784466Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:290:
2025-11-09T23:42:54.7784677Z              RpcRateLimiter::new(burst, rate)
2025-11-09T23:42:54.7784785Z          });
2025-11-09T23:42:54.7784888Z -        
2025-11-09T23:42:54.7784995Z +
2025-11-09T23:42:54.7785129Z          limiter.check_and_consume()
2025-11-09T23:42:54.7785231Z      }
2025-11-09T23:42:54.7785331Z  
2025-11-09T23:42:54.7785720Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:311:
2025-11-09T23:42:54.7785952Z          auth.add_token("test-token-123".to_string()).await.unwrap();
2025-11-09T23:42:54.7786066Z  
2025-11-09T23:42:54.7786242Z          let mut headers = hyper::HeaderMap::new();
2025-11-09T23:42:54.7787892Z -        headers.insert(
2025-11-09T23:42:54.7788029Z -            "authorization",
2025-11-09T23:42:54.7788522Z -            "***".parse().unwrap(),
2025-11-09T23:42:54.7788633Z -        );
2025-11-09T23:42:54.7789181Z +        headers.insert("authorization", "***".parse().unwrap());
2025-11-09T23:42:54.7789297Z  
2025-11-09T23:42:54.7789518Z          let addr: SocketAddr = "127.0.0.1:8080".parse().unwrap();
2025-11-09T23:42:54.7789784Z          let result = auth.authenticate_request(&headers, addr).await;
2025-11-09T23:42:54.7790204Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:329:
2025-11-09T23:42:54.7790427Z          auth.add_token("valid-token".to_string()).await.unwrap();
2025-11-09T23:42:54.7790528Z  
2025-11-09T23:42:54.7790715Z          let mut headers = hyper::HeaderMap::new();
2025-11-09T23:42:54.7790844Z -        headers.insert(
2025-11-09T23:42:54.7790967Z -            "authorization",
2025-11-09T23:42:54.7791214Z -            "***".parse().unwrap(),
2025-11-09T23:42:54.7791324Z -        );
2025-11-09T23:42:54.7791693Z +        headers.insert("authorization", "***".parse().unwrap());
2025-11-09T23:42:54.7791814Z  
2025-11-09T23:42:54.7792047Z          let addr: SocketAddr = "127.0.0.1:8080".parse().unwrap();
2025-11-09T23:42:54.7792305Z          let result = auth.authenticate_request(&headers, addr).await;
2025-11-09T23:42:54.7792730Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/auth.rs:368:
2025-11-09T23:42:54.7792899Z          assert!(result.error.is_none());
2025-11-09T23:42:54.7793013Z      }
2025-11-09T23:42:54.7793119Z  }
2025-11-09T23:42:54.7793228Z -
2025-11-09T23:42:54.7793329Z  
2025-11-09T23:42:54.7982370Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:30:
2025-11-09T23:42:54.7982589Z  
2025-11-09T23:42:54.7982748Z      /// Create with dependencies
2025-11-09T23:42:54.7983029Z      pub fn with_dependencies(storage: Arc<Storage>) -> Self {
2025-11-09T23:42:54.7983190Z -        Self { storage: Some(storage) }
2025-11-09T23:42:54.7983307Z +        Self {
2025-11-09T23:42:54.7983464Z +            storage: Some(storage),
2025-11-09T23:42:54.7983575Z +        }
2025-11-09T23:42:54.7983685Z      }
2025-11-09T23:42:54.7983795Z  
2025-11-09T23:42:54.7984063Z      /// Calculate difficulty from bits (compact target format)
2025-11-09T23:42:54.7984717Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:39:
2025-11-09T23:42:54.7985193Z          // MAX_TARGET for Bitcoin mainnet is 0x00000000FFFF0000000000000000000000000000000000000000000000000000
2025-11-09T23:42:54.7985490Z          // But we use a simpler calculation: difficulty = 2^256 / (target + 1)
2025-11-09T23:42:54.7985778Z          // For display purposes, we normalize to genesis difficulty = 1.0
2025-11-09T23:42:54.7986216Z -        const MAX_TARGET: u128 = 0x00000000FFFF0000000000000000000000000000000000000000000000000000u128;
2025-11-09T23:42:54.7986630Z -        
2025-11-09T23:42:54.7986781Z +        const MAX_TARGET: u128 =
2025-11-09T23:42:54.7987103Z +            0x00000000FFFF0000000000000000000000000000000000000000000000000000u128;
2025-11-09T23:42:54.7987214Z +
2025-11-09T23:42:54.7987403Z          // Simplified difficulty calculation
2025-11-09T23:42:54.7987687Z          // For display purposes, use a simple approximation based on bits
2025-11-09T23:42:54.7987865Z          if let Ok(_target) = expand_target(bits) {
2025-11-09T23:42:54.7988333Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:73:
2025-11-09T23:42:54.7988535Z      fn calculate_block_subsidy(height: u64) -> u64 {
2025-11-09T23:42:54.7988804Z          const INITIAL_SUBSIDY: u64 = 50_000_000_000; // 50 BTC in satoshis
2025-11-09T23:42:54.7988972Z          const HALVING_INTERVAL: u64 = 210_000;
2025-11-09T23:42:54.7989084Z -        
2025-11-09T23:42:54.7989204Z +
2025-11-09T23:42:54.7989381Z          let halvings = height / HALVING_INTERVAL;
2025-11-09T23:42:54.7989501Z -        
2025-11-09T23:42:54.7989608Z +
2025-11-09T23:42:54.7989817Z          // Subsidy halves each halving, but can't go below 0
2025-11-09T23:42:54.7989962Z          if halvings >= 64 {
2025-11-09T23:42:54.7990389Z              // After 64 halvings, subsidy is 0 (satoshi precision limit)
2025-11-09T23:42:54.7990861Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:82:
2025-11-09T23:42:54.7990994Z              return 0;
2025-11-09T23:42:54.7991109Z          }
2025-11-09T23:42:54.7991213Z -        
2025-11-09T23:42:54.7991317Z +
2025-11-09T23:42:54.7991464Z          INITIAL_SUBSIDY >> halvings
2025-11-09T23:42:54.7991574Z      }
2025-11-09T23:42:54.7991677Z  
2025-11-09T23:42:54.7992134Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:88:
2025-11-09T23:42:54.7992394Z      /// Calculate hash_serialized_2 for UTXO set (double SHA256)
2025-11-09T23:42:54.7992522Z -    /// 
2025-11-09T23:42:54.7992636Z +    ///
2025-11-09T23:42:54.7992971Z      /// Serializes UTXO set deterministically and computes double SHA256 hash.
2025-11-09T23:42:54.7993299Z      /// Matches Bitcoin Core's gettxoutsetinfo hash_serialized_2 calculation.
2025-11-09T23:42:54.7993673Z      fn calculate_utxo_set_hash(utxo_set: &bllvm_protocol::UtxoSet) -> [u8; 32] {
2025-11-09T23:42:54.7996258Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:93:
2025-11-09T23:42:54.7996420Z -        use sha2::{Sha256, Digest};
2025-11-09T23:42:54.7996616Z          use crate::storage::hashing::double_sha256;
2025-11-09T23:42:54.7996737Z -        
2025-11-09T23:42:54.7996884Z +        use sha2::{Digest, Sha256};
2025-11-09T23:42:54.7996996Z +
2025-11-09T23:42:54.7997350Z          // Sort UTXOs for deterministic hashing (by outpoint: hash first, then index)
2025-11-09T23:42:54.7997571Z          let mut entries: Vec<_> = utxo_set.iter().collect();
2025-11-09T23:42:54.7997841Z -        entries.sort_by(|(a, _), (b, _)| {
2025-11-09T23:42:54.7998004Z -            match a.hash.cmp(&b.hash) {
2025-11-09T23:42:54.7998240Z -                std::cmp::Ordering::Equal => a.index.cmp(&b.index),
2025-11-09T23:42:54.7998377Z -                other => other,
2025-11-09T23:42:54.7998492Z -            }
2025-11-09T23:42:54.7998764Z +        entries.sort_by(|(a, _), (b, _)| match a.hash.cmp(&b.hash) {
2025-11-09T23:42:54.7998998Z +            std::cmp::Ordering::Equal => a.index.cmp(&b.index),
2025-11-09T23:42:54.7999132Z +            other => other,
2025-11-09T23:42:54.7999247Z          });
2025-11-09T23:42:54.7999371Z -        
2025-11-09T23:42:54.7999486Z +
2025-11-09T23:42:54.7999634Z          // Serialize each UTXO entry
2025-11-09T23:42:54.7999801Z          let mut serialized = Vec::new();
2025-11-09T23:42:54.7999969Z          for (outpoint, utxo) in entries {
2025-11-09T23:42:54.8000449Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:108:
2025-11-09T23:42:54.8001036Z              // Serialize outpoint (32-byte hash + 8-byte index, little-endian)
2025-11-09T23:42:54.8001267Z              serialized.extend_from_slice(&outpoint.hash);
2025-11-09T23:42:54.8001556Z              serialized.extend_from_slice(&outpoint.index.to_le_bytes());
2025-11-09T23:42:54.8001670Z -            
2025-11-09T23:42:54.8001803Z +
2025-11-09T23:42:54.8002165Z              // Serialize UTXO (8-byte value + script_pubkey + 8-byte height, little-endian)
2025-11-09T23:42:54.8002426Z              serialized.extend_from_slice(&utxo.value.to_le_bytes());
2025-11-09T23:42:54.8002654Z              serialized.extend_from_slice(&utxo.script_pubkey);
2025-11-09T23:42:54.8003137Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:115:
2025-11-09T23:42:54.8003416Z              serialized.extend_from_slice(&utxo.height.to_le_bytes());
2025-11-09T23:42:54.8003534Z          }
2025-11-09T23:42:54.8003669Z -        
2025-11-09T23:42:54.8003782Z +
2025-11-09T23:42:54.8003920Z          // Double SHA256 hash
2025-11-09T23:42:54.8006123Z          double_sha256(&serialized)
2025-11-09T23:42:54.8006252Z      }
2025-11-09T23:42:54.8006729Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:121:
2025-11-09T23:42:54.8006853Z -    
2025-11-09T23:42:54.8007218Z +
2025-11-09T23:42:54.8007419Z      /// Calculate confirmations for a block
2025-11-09T23:42:54.8007764Z      fn calculate_confirmations(block_height: u64, tip_height: u64) -> i64 {
2025-11-09T23:42:54.8007930Z          if block_height > tip_height {
2025-11-09T23:42:54.8008406Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:222:
2025-11-09T23:42:54.8008607Z              }))
2025-11-09T23:42:54.8008726Z          } else {
2025-11-09T23:42:54.8009073Z              // Graceful degradation: return default values when storage unavailable
2025-11-09T23:42:54.8009590Z -            tracing::debug!("getblockchaininfo called but storage not available, returning default values");
2025-11-09T23:42:54.8009733Z +            tracing::debug!(
2025-11-09T23:42:54.8010135Z +                "getblockchaininfo called but storage not available, returning default values"
2025-11-09T23:42:54.8010256Z +            );
2025-11-09T23:42:54.8010381Z              Ok(json!({
2025-11-09T23:42:54.8010527Z                  "chain": "main",
2025-11-09T23:42:54.8010667Z                  "blocks": 0,
2025-11-09T23:42:54.8011136Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:311:
2025-11-09T23:42:54.8011394Z          debug!("RPC: getblockheader {} verbose={}", hash, verbose);
2025-11-09T23:42:54.8011515Z  
2025-11-09T23:42:54.8011696Z          if let Some(ref storage) = self.storage {
2025-11-09T23:42:54.8011867Z -            let hash_bytes = hex::decode(hash)
2025-11-09T23:42:54.8012103Z -                .map_err(|e| anyhow::anyhow!("Invalid hash: {}", e))?;
2025-11-09T23:42:54.8012252Z +            let hash_bytes =
2025-11-09T23:42:54.8012565Z +                hex::decode(hash).map_err(|e| anyhow::anyhow!("Invalid hash: {}", e))?;
2025-11-09T23:42:54.8012721Z              if hash_bytes.len() != 32 {
2025-11-09T23:42:54.8012970Z                  return Err(anyhow::anyhow!("Invalid hash length"));
2025-11-09T23:42:54.8013087Z              }
2025-11-09T23:42:54.8013558Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:319:
2025-11-09T23:42:54.8013930Z              let mut hash_array = [0u8; 32];
2025-11-09T23:42:54.8014114Z              hash_array.copy_from_slice(&hash_bytes);
2025-11-09T23:42:54.8014225Z -            
2025-11-09T23:42:54.8014494Z +
2025-11-09T23:42:54.8014780Z              if let Ok(Some(header)) = storage.blocks().get_header(&hash_array) {
2025-11-09T23:42:54.8014910Z                  if verbose {
2025-11-09T23:42:54.8015109Z                      // Find block height by searching height index
2025-11-09T23:42:54.8015826Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:360:
2025-11-09T23:42:54.8015935Z  
2025-11-09T23:42:54.8016080Z                      // Find next block hash
2025-11-09T23:42:54.8016298Z                      let next_blockhash = block_height.and_then(|h| {
2025-11-09T23:42:54.8016442Z -                        storage.blocks()
2025-11-09T23:42:54.8016576Z +                        storage
2025-11-09T23:42:54.8016988Z +                            .blocks()
2025-11-09T23:42:54.8017152Z                              .get_hash_by_height(h + 1)
2025-11-09T23:42:54.8017273Z                              .ok()
2025-11-09T23:42:54.8017398Z                              .flatten()
2025-11-09T23:42:54.8017871Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:380:
2025-11-09T23:42:54.8017991Z                          }
2025-11-09T23:42:54.8018181Z                          Self::format_chainwork(total_work)
2025-11-09T23:42:54.8018314Z                      } else {
2025-11-09T23:42:54.8018640Z -                        "0000000000000000000000000000000000000000000000000000000000000000".to_string()
2025-11-09T23:42:54.8018908Z +                        "0000000000000000000000000000000000000000000000000000000000000000"
2025-11-09T23:42:54.8019052Z +                            .to_string()
2025-11-09T23:42:54.8019364Z                      };
2025-11-09T23:42:54.8019477Z  
2025-11-09T23:42:54.8019604Z                      Ok(json!({
2025-11-09T23:42:54.8020036Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:443:
2025-11-09T23:42:54.8020262Z              if let Ok(Some(hash)) = storage.chain().get_tip_hash() {
2025-11-09T23:42:54.8020420Z                  Ok(json!(hex::encode(hash)))
2025-11-09T23:42:54.8020537Z              } else {
2025-11-09T23:42:54.8020832Z -                Ok(json!("0000000000000000000000000000000000000000000000000000000000000000"))
2025-11-09T23:42:54.8020958Z +                Ok(json!(
2025-11-09T23:42:54.8021335Z +                    "0000000000000000000000000000000000000000000000000000000000000000"
2025-11-09T23:42:54.8021444Z +                ))
2025-11-09T23:42:54.8021547Z              }
2025-11-09T23:42:54.8021651Z          } else {
2025-11-09T23:42:54.8021940Z -            Ok(json!("0000000000000000000000000000000000000000000000000000000000000000"))
2025-11-09T23:42:54.8022059Z +            Ok(json!(
2025-11-09T23:42:54.8022300Z +                "0000000000000000000000000000000000000000000000000000000000000000"
2025-11-09T23:42:54.8022407Z +            ))
2025-11-09T23:42:54.8022507Z          }
2025-11-09T23:42:54.8022608Z      }
2025-11-09T23:42:54.8022706Z  
2025-11-09T23:42:54.8023127Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:494:
2025-11-09T23:42:54.8023301Z              let utxos = storage.utxos().get_all_utxos()?;
2025-11-09T23:42:54.8023433Z              let txouts = utxos.len();
2025-11-09T23:42:54.8023730Z              let total_amount: u64 = utxos.values().map(|utxo| utxo.value as u64).sum();
2025-11-09T23:42:54.8023832Z -            
2025-11-09T23:42:54.8023928Z +
2025-11-09T23:42:54.8024232Z              // Calculate hash_serialized_2 (double SHA256 of serialized UTXO set)
2025-11-09T23:42:54.8026608Z              let hash_serialized_2 = Self::calculate_utxo_set_hash(&utxos);
2025-11-09T23:42:54.8026740Z  
2025-11-09T23:42:54.8027206Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:540:
2025-11-09T23:42:54.8027567Z              // Use protocol engine which provides the correct validate_block signature
2025-11-09T23:42:54.8027905Z              let engine = BitcoinProtocolEngine::new(ProtocolVersion::Regtest)
2025-11-09T23:42:54.8028232Z                  .map_err(|e| anyhow::anyhow!("Failed to create protocol engine: {}", e))?;
2025-11-09T23:42:54.8028353Z -            
2025-11-09T23:42:54.8028469Z +
2025-11-09T23:42:54.8028667Z              let check_level = checklevel.unwrap_or(3);
2025-11-09T23:42:54.8029105Z              let num_blocks = numblocks.unwrap_or(288);
2025-11-09T23:42:54.8029226Z -            
2025-11-09T23:42:54.8029336Z +
2025-11-09T23:42:54.8029603Z              let tip_height = storage.chain().get_height()?.unwrap_or(0);
2025-11-09T23:42:54.8029749Z              if tip_height == 0 {
2025-11-09T23:42:54.8029959Z                  return Ok(json!(true)); // Empty chain is valid
2025-11-09T23:42:54.8030433Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:557:
2025-11-09T23:42:54.8030549Z              };
2025-11-09T23:42:54.8030653Z  
2025-11-09T23:42:54.8030806Z              let mut errors = Vec::new();
2025-11-09T23:42:54.8031013Z -            let mut utxo_set = storage.utxos().get_all_utxos()
2025-11-09T23:42:54.8031162Z +            let mut utxo_set = storage
2025-11-09T23:42:54.8031288Z +                .utxos()
2025-11-09T23:42:54.8031420Z +                .get_all_utxos()
2025-11-09T23:42:54.8031700Z                  .map_err(|e| anyhow::anyhow!("Failed to get UTXO set: {}", e))?;
2025-11-09T23:42:54.8031823Z  
2025-11-09T23:42:54.8032004Z              // Verify blocks from start_height to tip
2025-11-09T23:42:54.8032490Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:572:
2025-11-09T23:42:54.8032658Z                                  // For now, just continue
2025-11-09T23:42:54.8032981Z                              }
2025-11-09T23:42:54.8033279Z                              Ok(bllvm_protocol::ValidationResult::Invalid(reason)) => {
2025-11-09T23:42:54.8033618Z -                                errors.push(format!("Block at height {} invalid: {}", height, reason));
2025-11-09T23:42:54.8033786Z +                                errors.push(format!(
2025-11-09T23:42:54.8033963Z +                                    "Block at height {} invalid: {}",
2025-11-09T23:42:54.8034113Z +                                    height, reason
2025-11-09T23:42:54.8036393Z +                                ));
2025-11-09T23:42:54.8036580Z                                  if check_level >= 4 {
2025-11-09T23:42:54.8036767Z                                      // Level 4: Stop on first error
2025-11-09T23:42:54.8036902Z                                      break;
2025-11-09T23:42:54.8037369Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:579:
2025-11-09T23:42:54.8037510Z                                  }
2025-11-09T23:42:54.8037639Z                              }
2025-11-09T23:42:54.8037775Z                              Err(e) => {
2025-11-09T23:42:54.8038137Z -                                errors.push(format!("Block at height {} validation error: {}", height, e));
2025-11-09T23:42:54.8038314Z +                                errors.push(format!(
2025-11-09T23:42:54.8038522Z +                                    "Block at height {} validation error: {}",
2025-11-09T23:42:54.8038668Z +                                    height, e
2025-11-09T23:42:54.8038806Z +                                ));
2025-11-09T23:42:54.8038955Z                                  if check_level >= 4 {
2025-11-09T23:42:54.8039091Z                                      break;
2025-11-09T23:42:54.8039219Z                                  }
2025-11-09T23:42:54.8039703Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:588:
2025-11-09T23:42:54.8039823Z  
2025-11-09T23:42:54.8040023Z                          // Check level 3: Verify block header linkage
2025-11-09T23:42:54.8040206Z                          if check_level >= 3 && height > 0 {
2025-11-09T23:42:54.8040565Z -                            if let Ok(Some(prev_hash)) = storage.blocks().get_hash_by_height(height - 1) {
2025-11-09T23:42:54.8040743Z +                            if let Ok(Some(prev_hash)) =
2025-11-09T23:42:54.8040980Z +                                storage.blocks().get_hash_by_height(height - 1)
2025-11-09T23:42:54.8041108Z +                            {
2025-11-09T23:42:54.8041589Z                                  if block.header.prev_block_hash != prev_hash {
2025-11-09T23:42:54.8041744Z                                      errors.push(format!(
2025-11-09T23:42:54.8042068Z                                          "Block at height {} has incorrect prev_block_hash: expected {}, got {}",
2025-11-09T23:42:54.8042523Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:606:
2025-11-09T23:42:54.8042688Z                          // Check level 2: Verify merkle root
2025-11-09T23:42:54.8042838Z                          if check_level >= 2 {
2025-11-09T23:42:54.8043072Z                              use bllvm_protocol::mining::calculate_merkle_root;
2025-11-09T23:42:54.8043393Z -                            if let Ok(calculated_root) = calculate_merkle_root(&block.transactions) {
2025-11-09T23:42:54.8043709Z +                            if let Ok(calculated_root) = calculate_merkle_root(&block.transactions)
2025-11-09T23:42:54.8043835Z +                            {
2025-11-09T23:42:54.8044069Z                                  if calculated_root != block.header.merkle_root {
2025-11-09T23:42:54.8046259Z                                      errors.push(format!(
2025-11-09T23:42:54.8046497Z                                          "Block at height {} has incorrect merkle root",
2025-11-09T23:42:54.8047124Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:657:
2025-11-09T23:42:54.8047303Z          if let Some(ref storage) = self.storage {
2025-11-09T23:42:54.8047477Z              // Get all chain tips (including forks)
2025-11-09T23:42:54.8047628Z              let mut tips = Vec::new();
2025-11-09T23:42:54.8047737Z -            
2025-11-09T23:42:54.8047848Z +
2025-11-09T23:42:54.8047975Z              // Add active tip
2025-11-09T23:42:54.8048212Z              if let Ok(Some(tip_hash)) = storage.chain().get_tip_hash() {
2025-11-09T23:42:54.8048467Z                  let tip_height = storage.chain().get_height()?.unwrap_or(0);
2025-11-09T23:42:54.8048936Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:668:
2025-11-09T23:42:54.8049077Z                      "status": "active"
2025-11-09T23:42:54.8049195Z                  }));
2025-11-09T23:42:54.8049316Z              }
2025-11-09T23:42:54.8049429Z -            
2025-11-09T23:42:54.8049540Z +
2025-11-09T23:42:54.8049728Z              // Add other tracked tips (forks, etc.)
2025-11-09T23:42:54.8049970Z              if let Ok(chain_tips) = storage.chain().get_chain_tips() {
2025-11-09T23:42:54.8050195Z                  for (hash, height, branchlen, status) in chain_tips {
2025-11-09T23:42:54.8050638Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:678:
2025-11-09T23:42:54.8050772Z                              continue;
2025-11-09T23:42:54.8051448Z                          }
2025-11-09T23:42:54.8051589Z                      }
2025-11-09T23:42:54.8051721Z -                    
2025-11-09T23:42:54.8051843Z +
2025-11-09T23:42:54.8051996Z                      tips.push(json!({
2025-11-09T23:42:54.8052157Z                          "height": height,
2025-11-09T23:42:54.8052340Z                          "hash": hex::encode(hash),
2025-11-09T23:42:54.8052828Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:687:
2025-11-09T23:42:54.8052963Z                      }));
2025-11-09T23:42:54.8053086Z                  }
2025-11-09T23:42:54.8053200Z              }
2025-11-09T23:42:54.8053316Z -            
2025-11-09T23:42:54.8053431Z +
2025-11-09T23:42:54.8053568Z              Ok(json!(tips))
2025-11-09T23:42:54.8053687Z          } else {
2025-11-09T23:42:54.8053814Z              Ok(json!([]))
2025-11-09T23:42:54.8056361Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:700:
2025-11-09T23:42:54.8056704Z      pub async fn get_chain_tx_stats(&self, params: &Value) -> Result<Value> {
2025-11-09T23:42:54.8056867Z          debug!("RPC: getchaintxstats");
2025-11-09T23:42:54.8057251Z  
2025-11-09T23:42:54.8057396Z -        let nblocks = params
2025-11-09T23:42:54.8057515Z -            .get(0)
2025-11-09T23:42:54.8057667Z -            .and_then(|p| p.as_u64())
2025-11-09T23:42:54.8057939Z -            .unwrap_or(144); // Default: 1 day (144 blocks at 10 min/block)
2025-11-09T23:42:54.8058432Z +        let nblocks = params.get(0).and_then(|p| p.as_u64()).unwrap_or(144); // Default: 1 day (144 blocks at 10 min/block)
2025-11-09T23:42:54.8058547Z  
2025-11-09T23:42:54.8058743Z          if let Some(ref storage) = self.storage {
2025-11-09T23:42:54.8059013Z              let tip_height = storage.chain().get_height()?.unwrap_or(0);
2025-11-09T23:42:54.8059492Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:710:
2025-11-09T23:42:54.8059625Z -            
2025-11-09T23:42:54.8059737Z +
2025-11-09T23:42:54.8059879Z              if tip_height == 0 {
2025-11-09T23:42:54.8060016Z                  return Ok(json!({
2025-11-09T23:42:54.8060168Z                      "time": 0,
2025-11-09T23:42:54.8060639Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:729:
2025-11-09T23:42:54.8060819Z              // Get timestamps and transaction counts
2025-11-09T23:42:54.8061012Z              let mut timestamps = Vec::new();
2025-11-09T23:42:54.8061492Z              let mut tx_counts = Vec::new();
2025-11-09T23:42:54.8061634Z -            
2025-11-09T23:42:54.8061748Z +
2025-11-09T23:42:54.8061956Z              for height in start_height..=tip_height {
2025-11-09T23:42:54.8062261Z                  if let Ok(Some(hash)) = storage.blocks().get_hash_by_height(height) {
2025-11-09T23:42:54.8062520Z                      if let Ok(Some(block)) = storage.blocks().get_block(&hash) {
2025-11-09T23:42:54.8063012Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:756:
2025-11-09T23:42:54.8063340Z              let window_interval = last_timestamp.saturating_sub(first_timestamp);
2025-11-09T23:42:54.8063557Z              let window_tx_count: u64 = tx_counts.iter().sum();
2025-11-09T23:42:54.8063762Z              let window_block_count = timestamps.len() as u64;
2025-11-09T23:42:54.8063868Z -            
2025-11-09T23:42:54.8063972Z +
2025-11-09T23:42:54.8064131Z              let txrate = if window_interval > 0 {
2025-11-09T23:42:54.8064340Z                  window_tx_count as f64 / window_interval as f64
2025-11-09T23:42:54.8064454Z              } else {
2025-11-09T23:42:54.8064903Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:794:
2025-11-09T23:42:54.8065214Z      pub async fn get_block_stats(&self, params: &Value) -> Result<Value> {
2025-11-09T23:42:54.8065367Z          debug!("RPC: getblockstats");
2025-11-09T23:42:54.8065473Z  
2025-11-09T23:42:54.8065688Z -        let hash_or_height: Option<String> = params.get(0)
2025-11-09T23:42:54.8065867Z +        let hash_or_height: Option<String> = params
2025-11-09T23:42:54.8065997Z +            .get(0)
2025-11-09T23:42:54.8066146Z              .and_then(|p| p.as_str())
2025-11-09T23:42:54.8066492Z              .map(|s| s.to_string())
2025-11-09T23:42:54.8066626Z              .or_else(|| {
2025-11-09T23:42:54.8067103Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:801:
2025-11-09T23:42:54.8067250Z -                params.get(0)
2025-11-09T23:42:54.8067382Z +                params
2025-11-09T23:42:54.8067513Z +                    .get(0)
2025-11-09T23:42:54.8067677Z                      .and_then(|p| p.as_u64())
2025-11-09T23:42:54.8067836Z                      .map(|h| h.to_string())
2025-11-09T23:42:54.8067956Z              });
2025-11-09T23:42:54.8068421Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:808:
2025-11-09T23:42:54.8068652Z              let block_hash = if let Some(hoh) = hash_or_height {
2025-11-09T23:42:54.8068819Z                  // Try to parse as height first
2025-11-09T23:42:54.8069270Z                  if let Ok(height) = hoh.parse::<u64>() {
2025-11-09T23:42:54.8069473Z -                    storage.blocks().get_hash_by_height(height)?
2025-11-09T23:42:54.8069610Z +                    storage
2025-11-09T23:42:54.8069741Z +                        .blocks()
2025-11-09T23:42:54.8069906Z +                        .get_hash_by_height(height)?
2025-11-09T23:42:54.8070241Z                          .ok_or_else(|| anyhow::anyhow!("Block at height {} not found", height))?
2025-11-09T23:42:54.8070366Z                  } else {
2025-11-09T23:42:54.8070497Z                      // Parse as hash
2025-11-09T23:42:54.8070945Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:823:
2025-11-09T23:42:54.8071050Z                  }
2025-11-09T23:42:54.8071156Z              } else {
2025-11-09T23:42:54.8071286Z                  // Default to tip
2025-11-09T23:42:54.8071443Z -                storage.chain().get_tip_hash()?
2025-11-09T23:42:54.8071565Z +                storage
2025-11-09T23:42:54.8071700Z +                    .chain()
2025-11-09T23:42:54.8071847Z +                    .get_tip_hash()?
2025-11-09T23:42:54.8072102Z                      .ok_or_else(|| anyhow::anyhow!("Chain not initialized"))?
2025-11-09T23:42:54.8072219Z              };
2025-11-09T23:42:54.8072342Z  
2025-11-09T23:42:54.8073029Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:831:
2025-11-09T23:42:54.8073234Z                  let tx_count = block.transactions.len();
2025-11-09T23:42:54.8073467Z                  let block_size = bincode::serialize(&block)?.len();
2025-11-09T23:42:54.8073844Z                  let block_weight = block_size; // Simplified - would calculate weight properly
2025-11-09T23:42:54.8073951Z -                
2025-11-09T23:42:54.8074048Z +
2025-11-09T23:42:54.8074179Z                  // Get block height
2025-11-09T23:42:54.8074630Z -                let height = storage.blocks().get_height_by_hash(&block_hash)?
2025-11-09T23:42:54.8074793Z +                let height = storage
2025-11-09T23:42:54.8074918Z +                    .blocks()
2025-11-09T23:42:54.8075075Z +                    .get_height_by_hash(&block_hash)?
2025-11-09T23:42:54.8075210Z                      .unwrap_or(0);
2025-11-09T23:42:54.8075326Z -                
2025-11-09T23:42:54.8075441Z +
2025-11-09T23:42:54.8075599Z                  // Count inputs and outputs
2025-11-09T23:42:54.8075819Z -                let input_count: usize = block.transactions.iter()
2025-11-09T23:42:54.8075987Z -                    .map(|tx| tx.inputs.len())
2025-11-09T23:42:54.8076111Z -                    .sum();
2025-11-09T23:42:54.8078221Z -                let output_count: usize = block.transactions.iter()
2025-11-09T23:42:54.8078371Z -                    .map(|tx| tx.outputs.len())
2025-11-09T23:42:54.8078490Z -                    .sum();
2025-11-09T23:42:54.8078591Z -                
2025-11-09T23:42:54.8078969Z +                let input_count: usize = block.transactions.iter().map(|tx| tx.inputs.len()).sum();
2025-11-09T23:42:54.8079135Z +                let output_count: usize =
2025-11-09T23:42:54.8079403Z +                    block.transactions.iter().map(|tx| tx.outputs.len()).sum();
2025-11-09T23:42:54.8079503Z +
2025-11-09T23:42:54.8079638Z                  // Sum output values
2025-11-09T23:42:54.8079833Z -                let total_out: u64 = block.transactions.iter()
2025-11-09T23:42:54.8079967Z +                let total_out: u64 = block
2025-11-09T23:42:54.8080088Z +                    .transactions
2025-11-09T23:42:54.8080204Z +                    .iter()
2025-11-09T23:42:54.8080359Z                      .flat_map(|tx| tx.outputs.iter())
2025-11-09T23:42:54.8080509Z                      .map(|out| out.value as u64)
2025-11-09T23:42:54.8080665Z                      .sum::<u64>();
2025-11-09T23:42:54.8081142Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:852:
2025-11-09T23:42:54.8081253Z -                
2025-11-09T23:42:54.8081610Z +
2025-11-09T23:42:54.8081768Z                  // Calculate block subsidy
2025-11-09T23:42:54.8082004Z                  let subsidy = Self::calculate_block_subsidy(height);
2025-11-09T23:42:54.8082116Z -                
2025-11-09T23:42:54.8082226Z +
2025-11-09T23:42:54.8082589Z                  // Calculate total fees (simplified - would need UTXO set for accurate calculation)
2025-11-09T23:42:54.8082915Z                  // For now, estimate: total_out - (subsidy * 100_000_000) if coinbase exists
2025-11-09T23:42:54.8083152Z                  let total_fees = if !block.transactions.is_empty() {
2025-11-09T23:42:54.8083584Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:859:
2025-11-09T23:42:54.8083739Z                      // Coinbase is first transaction
2025-11-09T23:42:54.8084008Z -                    let coinbase_outputs: u64 = block.transactions[0].outputs.iter()
2025-11-09T23:42:54.8084215Z +                    let coinbase_outputs: u64 = block.transactions[0]
2025-11-09T23:42:54.8084514Z +                        .outputs
2025-11-09T23:42:54.8084651Z +                        .iter()
2025-11-09T23:42:54.8084812Z                          .map(|out| out.value as u64)
2025-11-09T23:42:54.8084933Z                          .sum();
2025-11-09T23:42:54.8085211Z                      // Fee = total outputs - (coinbase outputs which include subsidy)
2025-11-09T23:42:54.8087807Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:903:
2025-11-09T23:42:54.8087927Z              }
2025-11-09T23:42:54.8088030Z          } else {
2025-11-09T23:42:54.8088355Z              // Graceful degradation: return informative error instead of failing silently
2025-11-09T23:42:54.8088795Z -            Err(anyhow::anyhow!("Storage not available. This operation requires storage to be initialized."))
2025-11-09T23:42:54.8088923Z +            Err(anyhow::anyhow!(
2025-11-09T23:42:54.8089242Z +                "Storage not available. This operation requires storage to be initialized."
2025-11-09T23:42:54.8089360Z +            ))
2025-11-09T23:42:54.8089460Z          }
2025-11-09T23:42:54.8089560Z      }
2025-11-09T23:42:54.8089663Z  
2025-11-09T23:42:54.8090091Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:913:
2025-11-09T23:42:54.8090421Z      pub async fn prune_blockchain(&self, params: &Value) -> Result<Value> {
2025-11-09T23:42:54.8090593Z          debug!("RPC: pruneblockchain");
2025-11-09T23:42:54.8090711Z  
2025-11-09T23:42:54.8090865Z -        let height = params.get(0)
2025-11-09T23:42:54.8091002Z +        let height = params
2025-11-09T23:42:54.8091230Z +            .get(0)
2025-11-09T23:42:54.8091390Z              .and_then(|p| p.as_u64())
2025-11-09T23:42:54.8091665Z              .ok_or_else(|| anyhow::anyhow!("Height parameter required"))?;
2025-11-09T23:42:54.8091767Z  
2025-11-09T23:42:54.8092225Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:920:
2025-11-09T23:42:54.8092411Z          if let Some(ref storage) = self.storage {
2025-11-09T23:42:54.8092656Z              let tip_height = storage.chain().get_height()?.unwrap_or(0);
2025-11-09T23:42:54.8092765Z -            
2025-11-09T23:42:54.8093356Z +
2025-11-09T23:42:54.8093679Z              // Check if IBD is in progress (height == 0 indicates no blocks synced)
2025-11-09T23:42:54.8093861Z              let is_ibd = tip_height == 0;
2025-11-09T23:42:54.8093977Z -            
2025-11-09T23:42:54.8094090Z +
2025-11-09T23:42:54.8094236Z              if height >= tip_height {
2025-11-09T23:42:54.8094895Z -                return Err(anyhow::anyhow!("Cannot prune to height >= tip height ({} >= {})", height, tip_height));
2025-11-09T23:42:54.8095066Z +                return Err(anyhow::anyhow!(
2025-11-09T23:42:54.8095293Z +                    "Cannot prune to height >= tip height ({} >= {})",
2025-11-09T23:42:54.8095429Z +                    height,
2025-11-09T23:42:54.8095560Z +                    tip_height
2025-11-09T23:42:54.8095928Z +                ));
2025-11-09T23:42:54.8096035Z              }
2025-11-09T23:42:54.8096147Z  
2025-11-09T23:42:54.8096290Z              // Get pruning manager
2025-11-09T23:42:54.8096752Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:931:
2025-11-09T23:42:54.8096993Z              if let Some(pruning_manager) = storage.pruning() {
2025-11-09T23:42:54.8097139Z                  // Perform pruning
2025-11-09T23:42:54.8097479Z                  let stats = pruning_manager.prune_to_height(height, tip_height, is_ibd)?;
2025-11-09T23:42:54.8097605Z -                
2025-11-09T23:42:54.8097713Z +
2025-11-09T23:42:54.8097881Z                  // Flush storage to persist changes
2025-11-09T23:42:54.8098014Z                  storage.flush()?;
2025-11-09T23:42:54.8098133Z -                
2025-11-09T23:42:54.8098240Z +
2025-11-09T23:42:54.8098364Z                  Ok(json!({
2025-11-09T23:42:54.8098527Z                      "pruned_height": height,
2025-11-09T23:42:54.8098717Z                      "blocks_pruned": stats.blocks_pruned,
2025-11-09T23:42:54.8099177Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:943:
2025-11-09T23:42:54.8099371Z                      "storage_freed_bytes": stats.storage_freed,
2025-11-09T23:42:54.8099494Z                  }))
2025-11-09T23:42:54.8099809Z              } else {
2025-11-09T23:42:54.8100240Z -                Err(anyhow::anyhow!("Pruning is not enabled. Configure pruning in node configuration."))
2025-11-09T23:42:54.8100404Z +                Err(anyhow::anyhow!(
2025-11-09T23:42:54.8100693Z +                    "Pruning is not enabled. Configure pruning in node configuration."
2025-11-09T23:42:54.8100813Z +                ))
2025-11-09T23:42:54.8100929Z              }
2025-11-09T23:42:54.8101057Z          } else {
2025-11-09T23:42:54.8101422Z              // Graceful degradation: return informative error instead of failing silently
2025-11-09T23:42:54.8101904Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:950:
2025-11-09T23:42:54.8102401Z -            Err(anyhow::anyhow!("Storage not available. This operation requires storage to be initialized."))
2025-11-09T23:42:54.8102553Z +            Err(anyhow::anyhow!(
2025-11-09T23:42:54.8102912Z +                "Storage not available. This operation requires storage to be initialized."
2025-11-09T23:42:54.8103034Z +            ))
2025-11-09T23:42:54.8103142Z          }
2025-11-09T23:42:54.8103240Z      }
2025-11-09T23:42:54.8103339Z  
2025-11-09T23:42:54.8103774Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:960:
2025-11-09T23:42:54.8103945Z          if let Some(ref storage) = self.storage {
2025-11-09T23:42:54.8104194Z              let tip_height = storage.chain().get_height()?.unwrap_or(0);
2025-11-09T23:42:54.8104601Z              let is_pruning_enabled = storage.is_pruning_enabled();
2025-11-09T23:42:54.8106564Z -            
2025-11-09T23:42:54.8106677Z +
2025-11-09T23:42:54.8106881Z              if let Some(pruning_manager) = storage.pruning() {
2025-11-09T23:42:54.8107045Z                  let stats = pruning_manager.get_stats();
2025-11-09T23:42:54.8107230Z                  let config = &pruning_manager.config;
2025-11-09T23:42:54.8107694Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:967:
2025-11-09T23:42:54.8107809Z -                
2025-11-09T23:42:54.8107907Z +
2025-11-09T23:42:54.8108047Z                  // Determine pruning mode
2025-11-09T23:42:54.8108211Z                  let mode_str = match &config.mode {
2025-11-09T23:42:54.8108428Z                      crate::config::PruningMode::Disabled => "disabled",
2025-11-09T23:42:54.8108838Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:975:
2025-11-09T23:42:54.8109091Z                      _ => "unknown", // Fallback for Aggressive if feature not enabled
2025-11-09T23:42:54.8109310Z                      crate::config::PruningMode::Custom { .. } => "custom",
2025-11-09T23:42:54.8109619Z                  };
2025-11-09T23:42:54.8109723Z -                
2025-11-09T23:42:54.8109829Z +
2025-11-09T23:42:54.8109943Z                  Ok(json!({
2025-11-09T23:42:54.8110107Z                      "pruning_enabled": is_pruning_enabled,
2025-11-09T23:42:54.8110251Z                      "mode": mode_str,
2025-11-09T23:42:54.8110721Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1013:
2025-11-09T23:42:54.8111052Z      pub async fn invalidate_block(&self, params: &Value) -> Result<Value> {
2025-11-09T23:42:54.8111205Z          debug!("RPC: invalidateblock");
2025-11-09T23:42:54.8111315Z  
2025-11-09T23:42:54.8111478Z -        let blockhash = params.get(0)
2025-11-09T23:42:54.8111606Z +        let blockhash = params
2025-11-09T23:42:54.8111711Z +            .get(0)
2025-11-09T23:42:54.8111843Z              .and_then(|p| p.as_str())
2025-11-09T23:42:54.8112212Z              .ok_or_else(|| anyhow::anyhow!("Block hash parameter required"))?;
2025-11-09T23:42:54.8112321Z  
2025-11-09T23:42:54.8112825Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1020:
2025-11-09T23:42:54.8113025Z -        let hash_bytes = hex::decode(blockhash)
2025-11-09T23:42:54.8113524Z -            .map_err(|e| anyhow::anyhow!("Invalid block hash: {}", e))?;
2025-11-09T23:42:54.8113655Z +        let hash_bytes =
2025-11-09T23:42:54.8114139Z +            hex::decode(blockhash).map_err(|e| anyhow::anyhow!("Invalid block hash: {}", e))?;
2025-11-09T23:42:54.8116361Z          if hash_bytes.len() != 32 {
2025-11-09T23:42:54.8125141Z              return Err(anyhow::anyhow!("Block hash must be 32 bytes"));
2025-11-09T23:42:54.8125304Z          }
2025-11-09T23:42:54.8125819Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1028:
2025-11-09T23:42:54.8126014Z          if let Some(ref storage) = self.storage {
2025-11-09T23:42:54.8126191Z              // Mark block as invalid
2025-11-09T23:42:54.8126363Z              storage.chain().mark_invalid(&hash)?;
2025-11-09T23:42:54.8126480Z -            
2025-11-09T23:42:54.8126604Z +
2025-11-09T23:42:54.8126924Z              // Check if this is the current tip - if so, we'd need to trigger a reorg
2025-11-09T23:42:54.8127253Z              // For now, we just mark it as invalid and let the node handle it on next block
2025-11-09T23:42:54.8127513Z              if let Ok(Some(tip_hash)) = storage.chain().get_tip_hash() {
2025-11-09T23:42:54.8127997Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1040:
2025-11-09T23:42:54.8128130Z              Ok(json!(null))
2025-11-09T23:42:54.8128243Z          } else {
2025-11-09T23:42:54.8128603Z              // Graceful degradation: return informative error instead of failing silently
2025-11-09T23:42:54.8129077Z -            Err(anyhow::anyhow!("Storage not available. This operation requires storage to be initialized."))
2025-11-09T23:42:54.8129221Z +            Err(anyhow::anyhow!(
2025-11-09T23:42:54.8129557Z +                "Storage not available. This operation requires storage to be initialized."
2025-11-09T23:42:54.8129671Z +            ))
2025-11-09T23:42:54.8129779Z          }
2025-11-09T23:42:54.8129894Z      }
2025-11-09T23:42:54.8130000Z  
2025-11-09T23:42:54.8130478Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1050:
2025-11-09T23:42:54.8130774Z      pub async fn reconsider_block(&self, params: &Value) -> Result<Value> {
2025-11-09T23:42:54.8130928Z          debug!("RPC: reconsiderblock");
2025-11-09T23:42:54.8131026Z  
2025-11-09T23:42:54.8131176Z -        let blockhash = params.get(0)
2025-11-09T23:42:54.8131331Z +        let blockhash = params
2025-11-09T23:42:54.8131445Z +            .get(0)
2025-11-09T23:42:54.8131587Z              .and_then(|p| p.as_str())
2025-11-09T23:42:54.8131853Z              .ok_or_else(|| anyhow::anyhow!("Block hash parameter required"))?;
2025-11-09T23:42:54.8132203Z  
2025-11-09T23:42:54.8132641Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1057:
2025-11-09T23:42:54.8132801Z -        let hash_bytes = hex::decode(blockhash)
2025-11-09T23:42:54.8133047Z -            .map_err(|e| anyhow::anyhow!("Invalid block hash: {}", e))?;
2025-11-09T23:42:54.8133169Z +        let hash_bytes =
2025-11-09T23:42:54.8133576Z +            hex::decode(blockhash).map_err(|e| anyhow::anyhow!("Invalid block hash: {}", e))?;
2025-11-09T23:42:54.8133759Z          if hash_bytes.len() != 32 {
2025-11-09T23:42:54.8134082Z              return Err(anyhow::anyhow!("Block hash must be 32 bytes"));
2025-11-09T23:42:54.8134182Z          }
2025-11-09T23:42:54.8134889Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1065:
2025-11-09T23:42:54.8135192Z          if let Some(ref storage) = self.storage {
2025-11-09T23:42:54.8135346Z              // Remove from invalid blocks set
2025-11-09T23:42:54.8135518Z              storage.chain().unmark_invalid(&hash)?;
2025-11-09T23:42:54.8135628Z -            
2025-11-09T23:42:54.8135726Z +
2025-11-09T23:42:54.8136013Z              // If this block is now valid, it may be reconsidered for chain inclusion
2025-11-09T23:42:54.8138218Z              // The node will handle this on next block processing
2025-11-09T23:42:54.8138327Z  
2025-11-09T23:42:54.8138983Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1072:
2025-11-09T23:42:54.8139115Z              Ok(json!(null))
2025-11-09T23:42:54.8139228Z          } else {
2025-11-09T23:42:54.8139555Z              // Graceful degradation: return informative error instead of failing silently
2025-11-09T23:42:54.8140050Z -            Err(anyhow::anyhow!("Storage not available. This operation requires storage to be initialized."))
2025-11-09T23:42:54.8140192Z +            Err(anyhow::anyhow!(
2025-11-09T23:42:54.8140602Z +                "Storage not available. This operation requires storage to be initialized."
2025-11-09T23:42:54.8140713Z +            ))
2025-11-09T23:42:54.8140813Z          }
2025-11-09T23:42:54.8140963Z      }
2025-11-09T23:42:54.8141063Z  
2025-11-09T23:42:54.8141585Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1079:
2025-11-09T23:42:54.8141838Z      /// Wait for new block
2025-11-09T23:42:54.8141969Z      ///
2025-11-09T23:42:54.8142377Z      /// Params: ["timeout"] (optional, timeout in seconds, default: no timeout)
2025-11-09T23:42:54.8142504Z -    /// 
2025-11-09T23:42:54.8142616Z +    ///
2025-11-09T23:42:54.8142944Z      /// Note: Full implementation requires async notification infrastructure.
2025-11-09T23:42:54.8143266Z      /// Currently returns current tip immediately. Future enhancement will:
2025-11-09T23:42:54.8143500Z      /// 1. Subscribe to block notifications
2025-11-09T23:42:54.8143965Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1088:
2025-11-09T23:42:54.8144945Z      pub async fn wait_for_new_block(&self, params: &Value) -> Result<Value> {
2025-11-09T23:42:54.8145165Z          debug!("RPC: waitfornewblock");
2025-11-09T23:42:54.8145279Z  
2025-11-09T23:42:54.8145440Z -        let _timeout = params.get(0)
2025-11-09T23:42:54.8145586Z +        let _timeout = params
2025-11-09T23:42:54.8147713Z +            .get(0)
2025-11-09T23:42:54.8147882Z              .and_then(|p| p.as_u64())
2025-11-09T23:42:54.8148100Z              .map(|t| tokio::time::Duration::from_secs(t));
2025-11-09T23:42:54.8148216Z  
2025-11-09T23:42:54.8148683Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1104:
2025-11-09T23:42:54.8148796Z              }
2025-11-09T23:42:54.8149747Z          } else {
2025-11-09T23:42:54.8150160Z              // Graceful degradation: return informative error instead of failing silently
2025-11-09T23:42:54.8150668Z -            Err(anyhow::anyhow!("Storage not available. This operation requires storage to be initialized."))
2025-11-09T23:42:54.8151096Z +            Err(anyhow::anyhow!(
2025-11-09T23:42:54.8151480Z +                "Storage not available. This operation requires storage to be initialized."
2025-11-09T23:42:54.8151600Z +            ))
2025-11-09T23:42:54.8151713Z          }
2025-11-09T23:42:54.8151831Z      }
2025-11-09T23:42:54.8151942Z  
2025-11-09T23:42:54.8152432Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1111:
2025-11-09T23:42:54.8152574Z      /// Wait for specific block
2025-11-09T23:42:54.8152692Z      ///
2025-11-09T23:42:54.8152979Z      /// Params: ["blockhash", "timeout"] (block hash, optional timeout)
2025-11-09T23:42:54.8153094Z -    /// 
2025-11-09T23:42:54.8153208Z +    ///
2025-11-09T23:42:54.8153541Z      /// Note: Full implementation requires async notification infrastructure.
2025-11-09T23:42:54.8153862Z      /// Currently checks if block exists immediately. Future enhancement will:
2025-11-09T23:42:54.8154025Z      /// 1. Subscribe to block notifications
2025-11-09T23:42:54.8154720Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1120:
2025-11-09T23:42:54.8155034Z      pub async fn wait_for_block(&self, params: &Value) -> Result<Value> {
2025-11-09T23:42:54.8155193Z          debug!("RPC: waitforblock");
2025-11-09T23:42:54.8155313Z  
2025-11-09T23:42:54.8155775Z -        let blockhash = params.get(0)
2025-11-09T23:42:54.8155931Z +        let blockhash = params
2025-11-09T23:42:54.8156054Z +            .get(0)
2025-11-09T23:42:54.8156200Z              .and_then(|p| p.as_str())
2025-11-09T23:42:54.8156483Z              .ok_or_else(|| anyhow::anyhow!("Block hash parameter required"))?;
2025-11-09T23:42:54.8156591Z  
2025-11-09T23:42:54.8157055Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1127:
2025-11-09T23:42:54.8157202Z -        let _timeout = params.get(1)
2025-11-09T23:42:54.8157330Z +        let _timeout = params
2025-11-09T23:42:54.8157452Z +            .get(1)
2025-11-09T23:42:54.8157584Z              .and_then(|p| p.as_u64())
2025-11-09T23:42:54.8157770Z              .map(|t| tokio::time::Duration::from_secs(t));
2025-11-09T23:42:54.8157869Z  
2025-11-09T23:42:54.8158311Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1131:
2025-11-09T23:42:54.8158481Z -        let hash_bytes = hex::decode(blockhash)
2025-11-09T23:42:54.8158714Z -            .map_err(|e| anyhow::anyhow!("Invalid block hash: {}", e))?;
2025-11-09T23:42:54.8158838Z +        let hash_bytes =
2025-11-09T23:42:54.8159197Z +            hex::decode(blockhash).map_err(|e| anyhow::anyhow!("Invalid block hash: {}", e))?;
2025-11-09T23:42:54.8159334Z          if hash_bytes.len() != 32 {
2025-11-09T23:42:54.8159582Z              return Err(anyhow::anyhow!("Block hash must be 32 bytes"));
2025-11-09T23:42:54.8159686Z          }
2025-11-09T23:42:54.8160108Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1140:
2025-11-09T23:42:54.8160291Z          // For now, check if block exists immediately
2025-11-09T23:42:54.8160451Z          if let Some(ref storage) = self.storage {
2025-11-09T23:42:54.8160670Z              if let Ok(Some(_block)) = storage.blocks().get_block(&hash) {
2025-11-09T23:42:54.8160890Z -                let height = storage.blocks().get_height_by_hash(&hash)?
2025-11-09T23:42:54.8161026Z -                    .unwrap_or(0);
2025-11-09T23:42:54.8161317Z +                let height = storage.blocks().get_height_by_hash(&hash)?.unwrap_or(0);
2025-11-09T23:42:54.8161445Z                  Ok(json!({
2025-11-09T23:42:54.8161595Z                      "hash": blockhash,
2025-11-09T23:42:54.8161734Z                      "height": height
2025-11-09T23:42:54.8162208Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1151:
2025-11-09T23:42:54.8162339Z              }
2025-11-09T23:42:54.8162459Z          } else {
2025-11-09T23:42:54.8162832Z              // Graceful degradation: return informative error instead of failing silently
2025-11-09T23:42:54.8163526Z -            Err(anyhow::anyhow!("Storage not available. This operation requires storage to be initialized."))
2025-11-09T23:42:54.8163670Z +            Err(anyhow::anyhow!(
2025-11-09T23:42:54.8163991Z +                "Storage not available. This operation requires storage to be initialized."
2025-11-09T23:42:54.8164104Z +            ))
2025-11-09T23:42:54.8164212Z          }
2025-11-09T23:42:54.8164485Z      }
2025-11-09T23:42:54.8164590Z  
2025-11-09T23:42:54.8165037Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1158:
2025-11-09T23:42:54.8165172Z      /// Wait for block height
2025-11-09T23:42:54.8165273Z      ///
2025-11-09T23:42:54.8165536Z      /// Params: ["height", "timeout"] (block height, optional timeout)
2025-11-09T23:42:54.8165656Z -    /// 
2025-11-09T23:42:54.8165771Z +    ///
2025-11-09T23:42:54.8166101Z      /// Note: Full implementation requires async notification infrastructure.
2025-11-09T23:42:54.8166495Z      /// Currently checks if block at height exists immediately. Future enhancement will:
2025-11-09T23:42:54.8166670Z      /// 1. Subscribe to block notifications
2025-11-09T23:42:54.8167148Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1167:
2025-11-09T23:42:54.8167710Z      pub async fn wait_for_block_height(&self, params: &Value) -> Result<Value> {
2025-11-09T23:42:54.8167911Z          debug!("RPC: waitforblockheight");
2025-11-09T23:42:54.8168024Z  
2025-11-09T23:42:54.8168171Z -        let height = params.get(0)
2025-11-09T23:42:54.8168306Z +        let height = params
2025-11-09T23:42:54.8168417Z +            .get(0)
2025-11-09T23:42:54.8168557Z              .and_then(|p| p.as_u64())
2025-11-09T23:42:54.8168825Z              .ok_or_else(|| anyhow::anyhow!("Height parameter required"))?;
2025-11-09T23:42:54.8168940Z  
2025-11-09T23:42:54.8169396Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1174:
2025-11-09T23:42:54.8169549Z -        let _timeout = params.get(1)
2025-11-09T23:42:54.8169684Z +        let _timeout = params
2025-11-09T23:42:54.8169791Z +            .get(1)
2025-11-09T23:42:54.8169925Z              .and_then(|p| p.as_u64())
2025-11-09T23:42:54.8170121Z              .map(|t| tokio::time::Duration::from_secs(t));
2025-11-09T23:42:54.8170298Z          if let Some(ref storage) = self.storage {
2025-11-09T23:42:54.8170741Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1186:
2025-11-09T23:42:54.8170995Z                      Err(anyhow::anyhow!("Block at height {} not found", height))
2025-11-09T23:42:54.8171109Z                  }
2025-11-09T23:42:54.8171221Z              } else {
2025-11-09T23:42:54.8171601Z -                Err(anyhow::anyhow!("Block at height {} not yet available (tip: {})", height, tip_height))
2025-11-09T23:42:54.8171743Z +                Err(anyhow::anyhow!(
2025-11-09T23:42:54.8171958Z +                    "Block at height {} not yet available (tip: {})",
2025-11-09T23:42:54.8172085Z +                    height,
2025-11-09T23:42:54.8172219Z +                    tip_height
2025-11-09T23:42:54.8172330Z +                ))
2025-11-09T23:42:54.8172440Z              }
2025-11-09T23:42:54.8172550Z          } else {
2025-11-09T23:42:54.8173499Z              // Graceful degradation: return informative error instead of failing silently
2025-11-09T23:42:54.8173981Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1193:
2025-11-09T23:42:54.8174617Z -            Err(anyhow::anyhow!("Storage not available. This operation requires storage to be initialized."))
2025-11-09T23:42:54.8174765Z +            Err(anyhow::anyhow!(
2025-11-09T23:42:54.8175105Z +                "Storage not available. This operation requires storage to be initialized."
2025-11-09T23:42:54.8175213Z +            ))
2025-11-09T23:42:54.8175320Z          }
2025-11-09T23:42:54.8175640Z      }
2025-11-09T23:42:54.8175744Z  
2025-11-09T23:42:54.8176199Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1200:
2025-11-09T23:42:54.8176500Z      pub async fn get_block_filter(&self, params: &Value) -> Result<Value> {
2025-11-09T23:42:54.8176648Z          debug!("RPC: getblockfilter");
2025-11-09T23:42:54.8176752Z  
2025-11-09T23:42:54.8176912Z -        let blockhash = params.get(0)
2025-11-09T23:42:54.8177047Z +        let blockhash = params
2025-11-09T23:42:54.8177158Z +            .get(0)
2025-11-09T23:42:54.8177292Z              .and_then(|p| p.as_str())
2025-11-09T23:42:54.8177569Z              .ok_or_else(|| anyhow::anyhow!("Block hash parameter required"))?;
2025-11-09T23:42:54.8177673Z  
2025-11-09T23:42:54.8178119Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1207:
2025-11-09T23:42:54.8178277Z -        let filtertype = params.get(1)
2025-11-09T23:42:54.8178413Z -            .and_then(|p| p.as_u64())
2025-11-09T23:42:54.8178587Z -            .unwrap_or(0); // Default: Basic filter
2025-11-09T23:42:54.8178982Z +        let filtertype = params.get(1).and_then(|p| p.as_u64()).unwrap_or(0); // Default: Basic filter
2025-11-09T23:42:54.8179097Z  
2025-11-09T23:42:54.8179231Z          if filtertype != 0 {
2025-11-09T23:42:54.8179703Z              return Err(anyhow::anyhow!("Only filter type 0 (Basic) is supported"));
2025-11-09T23:42:54.8180158Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1213:
2025-11-09T23:42:54.8180262Z          }
2025-11-09T23:42:54.8180368Z  
2025-11-09T23:42:54.8180549Z -        let hash_bytes = hex::decode(blockhash)
2025-11-09T23:42:54.8180787Z -            .map_err(|e| anyhow::anyhow!("Invalid block hash: {}", e))?;
2025-11-09T23:42:54.8180912Z +        let hash_bytes =
2025-11-09T23:42:54.8181277Z +            hex::decode(blockhash).map_err(|e| anyhow::anyhow!("Invalid block hash: {}", e))?;
2025-11-09T23:42:54.8181423Z          if hash_bytes.len() != 32 {
2025-11-09T23:42:54.8181681Z              return Err(anyhow::anyhow!("Block hash must be 32 bytes"));
2025-11-09T23:42:54.8181787Z          }
2025-11-09T23:42:54.8182238Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1226:
2025-11-09T23:42:54.8182463Z                  // Get filter service from network manager (if available)
2025-11-09T23:42:54.8182639Z                  // For now, generate filter directly
2025-11-09T23:42:54.8182859Z                  use bllvm_protocol::bip158::build_block_filter;
2025-11-09T23:42:54.8182974Z -                
2025-11-09T23:42:54.8183085Z +
2025-11-09T23:42:54.8183291Z                  // Get previous outpoint scripts from UTXO set
2025-11-09T23:42:54.8183542Z                  // For each input, find the UTXO and get its script_pubkey
2025-11-09T23:42:54.8183728Z                  let mut previous_scripts = Vec::new();
2025-11-09T23:42:54.8184192Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1239:
2025-11-09T23:42:54.8184471Z                          }
2025-11-09T23:42:54.8184591Z                      }
2025-11-09T23:42:54.8184705Z                  }
2025-11-09T23:42:54.8184826Z -                
2025-11-09T23:42:54.8184935Z +
2025-11-09T23:42:54.8185252Z                  match build_block_filter(&block.transactions, &previous_scripts) {
2025-11-09T23:42:54.8185396Z                      Ok(filter) => {
2025-11-09T23:42:54.8185533Z                          Ok(json!({
2025-11-09T23:42:54.8186002Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1247:
2025-11-09T23:42:54.8186292Z                              "header": hex::encode([0u8; 32]), // Would calculate filter header
2025-11-09T23:42:54.8186428Z                          }))
2025-11-09T23:42:54.8186541Z                      }
2025-11-09T23:42:54.8186804Z -                    Err(e) => Err(anyhow::anyhow!("Failed to build filter: {}", e))
2025-11-09T23:42:54.8187063Z +                    Err(e) => Err(anyhow::anyhow!("Failed to build filter: {}", e)),
2025-11-09T23:42:54.8187376Z                  }
2025-11-09T23:42:54.8187492Z              } else {
2025-11-09T23:42:54.8187668Z                  Err(anyhow::anyhow!("Block not found"))
2025-11-09T23:42:54.8188131Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/blockchain.rs:1254:
2025-11-09T23:42:54.8188250Z              }
2025-11-09T23:42:54.8188358Z          } else {
2025-11-09T23:42:54.8188713Z              // Graceful degradation: return informative error instead of failing silently
2025-11-09T23:42:54.8189191Z -            Err(anyhow::anyhow!("Storage not available. This operation requires storage to be initialized."))
2025-11-09T23:42:54.8189335Z +            Err(anyhow::anyhow!(
2025-11-09T23:42:54.8189696Z +                "Storage not available. This operation requires storage to be initialized."
2025-11-09T23:42:54.8189812Z +            ))
2025-11-09T23:42:54.8189922Z          }
2025-11-09T23:42:54.8190042Z      }
2025-11-09T23:42:54.8190157Z  
2025-11-09T23:42:54.8190800Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/control.rs:89:
2025-11-09T23:42:54.8191135Z      pub async fn getmemoryinfo(&self, params: &Value) -> RpcResult<Value> {
2025-11-09T23:42:54.8191302Z          debug!("RPC: getmemoryinfo");
2025-11-09T23:42:54.8191413Z  
2025-11-09T23:42:54.8191791Z -        let mode = params
2025-11-09T23:42:54.8191924Z -            .get(0)
2025-11-09T23:42:54.8192088Z -            .and_then(|p| p.as_str())
2025-11-09T23:42:54.8192223Z -            .unwrap_or("stats");
2025-11-09T23:42:54.8192523Z +        let mode = params.get(0).and_then(|p| p.as_str()).unwrap_or("stats");
2025-11-09T23:42:54.8192640Z  
2025-11-09T23:42:54.8192764Z          match mode {
2025-11-09T23:42:54.8192890Z              "stats" => {
2025-11-09T23:42:54.8193337Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/control.rs:224:
2025-11-09T23:42:54.8193466Z          } else {
2025-11-09T23:42:54.8193696Z              // No command specified, return list of all commands
2025-11-09T23:42:54.8193833Z              let commands = vec![
2025-11-09T23:42:54.8194157Z -                "getblockchaininfo", "getblock", "getblockhash", "getblockheader",
2025-11-09T23:42:54.8194694Z -                "getbestblockhash", "getblockcount", "getdifficulty", "gettxoutsetinfo",
2025-11-09T23:42:54.8195081Z -                "verifychain", "getrawtransaction", "sendrawtransaction", "testmempoolaccept",
2025-11-09T23:42:54.8195435Z -                "decoderawtransaction", "gettxout", "gettxoutproof", "verifytxoutproof",
2025-11-09T23:42:54.8195820Z -                "getmempoolinfo", "getrawmempool", "savemempool", "getnetworkinfo",
2025-11-09T23:42:54.8196169Z -                "getpeerinfo", "getconnectioncount", "ping", "addnode", "disconnectnode",
2025-11-09T23:42:54.8196498Z -                "getnettotals", "clearbanned", "setban", "listbanned", "getmininginfo",
2025-11-09T23:42:54.8198409Z -                "getblocktemplate", "submitblock", "estimatesmartfee", "stop", "uptime",
2025-11-09T23:42:54.8198643Z -                "getmemoryinfo", "getrpcinfo", "help", "logging",
2025-11-09T23:42:54.8198794Z +                "getblockchaininfo",
2025-11-09T23:42:54.8198934Z +                "getblock",
2025-11-09T23:42:54.8199073Z +                "getblockhash",
2025-11-09T23:42:54.8199219Z +                "getblockheader",
2025-11-09T23:42:54.8199362Z +                "getbestblockhash",
2025-11-09T23:42:54.8199484Z +                "getblockcount",
2025-11-09T23:42:54.8199610Z +                "getdifficulty",
2025-11-09T23:42:54.8199756Z +                "gettxoutsetinfo",
2025-11-09T23:42:54.8199876Z +                "verifychain",
2025-11-09T23:42:54.8200017Z +                "getrawtransaction",
2025-11-09T23:42:54.8200162Z +                "sendrawtransaction",
2025-11-09T23:42:54.8200317Z +                "testmempoolaccept",
2025-11-09T23:42:54.8200474Z +                "decoderawtransaction",
2025-11-09T23:42:54.8200886Z +                "gettxout",
2025-11-09T23:42:54.8201029Z +                "gettxoutproof",
2025-11-09T23:42:54.8201411Z +                "verifytxoutproof",
2025-11-09T23:42:54.8201546Z +                "getmempoolinfo",
2025-11-09T23:42:54.8201678Z +                "getrawmempool",
2025-11-09T23:42:54.8201813Z +                "savemempool",
2025-11-09T23:42:54.8201953Z +                "getnetworkinfo",
2025-11-09T23:42:54.8202086Z +                "getpeerinfo",
2025-11-09T23:42:54.8202241Z +                "getconnectioncount",
2025-11-09T23:42:54.8202369Z +                "ping",
2025-11-09T23:42:54.8202489Z +                "addnode",
2025-11-09T23:42:54.8202625Z +                "disconnectnode",
2025-11-09T23:42:54.8202761Z +                "getnettotals",
2025-11-09T23:42:54.8202887Z +                "clearbanned",
2025-11-09T23:42:54.8203009Z +                "setban",
2025-11-09T23:42:54.8203139Z +                "listbanned",
2025-11-09T23:42:54.8203322Z +                "getmininginfo",
2025-11-09T23:42:54.8203522Z +                "getblocktemplate",
2025-11-09T23:42:54.8203687Z +                "submitblock",
2025-11-09T23:42:54.8203867Z +                "estimatesmartfee",
2025-11-09T23:42:54.8203982Z +                "stop",
2025-11-09T23:42:54.8204102Z +                "uptime",
2025-11-09T23:42:54.8204244Z +                "getmemoryinfo",
2025-11-09T23:42:54.8204817Z +                "getrpcinfo",
2025-11-09T23:42:54.8204971Z +                "help",
2025-11-09T23:42:54.8205101Z +                "logging",
2025-11-09T23:42:54.8205229Z              ];
2025-11-09T23:42:54.8205344Z  
2025-11-09T23:42:54.8205507Z              Ok(json!(commands.join("\n")))
2025-11-09T23:42:54.8207201Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/control.rs:275:
2025-11-09T23:42:54.8207384Z          // 1. Store a reference to the EnvFilter layer
2025-11-09T23:42:54.8207588Z          // 2. Provide methods to update the filter dynamically
2025-11-09T23:42:54.8207776Z          // 3. Rebuild the subscriber with the new filter
2025-11-09T23:42:54.8207888Z -        
2025-11-09T23:42:54.8208053Z +
2025-11-09T23:42:54.8208235Z          // Check current filter state from environment
2025-11-09T23:42:54.8208443Z -        let current_filter = std::env::var("RUST_LOG")
2025-11-09T23:42:54.8208620Z -            .unwrap_or_else(|_| "info".to_string());
2025-11-09T23:42:54.8208741Z -        
2025-11-09T23:42:54.8209132Z +        let current_filter = std::env::var("RUST_LOG").unwrap_or_else(|_| "info".to_string());
2025-11-09T23:42:54.8209245Z +
2025-11-09T23:42:54.8209474Z          // Determine if debug logging is active based on filter
2025-11-09T23:42:54.8209684Z -        let active = current_filter.contains("debug") || 
2025-11-09T23:42:54.8210413Z -                     current_filter.contains("trace") ||
2025-11-09T23:42:54.8210617Z -                     !exclude.contains(&"all".to_string());
2025-11-09T23:42:54.8210817Z +        let active = current_filter.contains("debug")
2025-11-09T23:42:54.8211002Z +            || current_filter.contains("trace")
2025-11-09T23:42:54.8211167Z +            || !exclude.contains(&"all".to_string());
2025-11-09T23:42:54.8211279Z  
2025-11-09T23:42:54.8211399Z          Ok(json!({
2025-11-09T23:42:54.8211539Z              "active": active,
2025-11-09T23:42:54.8212009Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/control.rs:297:
2025-11-09T23:42:54.8212292Z      /// Returns comprehensive health report for all node components
2025-11-09T23:42:54.8212605Z      pub async fn gethealth(&self, _params: &Value) -> RpcResult<Value> {
2025-11-09T23:42:54.8212754Z          debug!("RPC: gethealth");
2025-11-09T23:42:54.8212860Z -        
2025-11-09T23:42:54.8212969Z +
2025-11-09T23:42:54.8213238Z          // This would need access to Node instance to get full health report
2025-11-09T23:42:54.8213399Z          // For now, return basic health status
2025-11-09T23:42:54.8213521Z          Ok(json!({
2025-11-09T23:42:54.8214159Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/control.rs:312:
2025-11-09T23:42:54.8214794Z      /// Returns comprehensive metrics for monitoring
2025-11-09T23:42:54.8215092Z      pub async fn getmetrics(&self, _params: &Value) -> RpcResult<Value> {
2025-11-09T23:42:54.8215243Z          debug!("RPC: getmetrics");
2025-11-09T23:42:54.8215344Z -        
2025-11-09T23:42:54.8215458Z +
2025-11-09T23:42:54.8215738Z          // This would need access to MetricsCollector to get full metrics
2025-11-09T23:42:54.8215905Z          // For now, return basic metrics
2025-11-09T23:42:54.8216117Z          let uptime = self.start_time.elapsed().as_secs();
2025-11-09T23:42:54.8216574Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/control.rs:328:
2025-11-09T23:42:54.8216725Z          Self::new()
2025-11-09T23:42:54.8216835Z      }
2025-11-09T23:42:54.8216945Z  }
2025-11-09T23:42:54.8217056Z -
2025-11-09T23:42:54.8217173Z  
2025-11-09T23:42:54.8217618Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:23:
2025-11-09T23:42:54.8217766Z  impl MempoolRpc {
2025-11-09T23:42:54.8217938Z      /// Create a new mempool RPC handler
2025-11-09T23:42:54.8218076Z      pub fn new() -> Self {
2025-11-09T23:42:54.8218246Z -        Self { mempool: None, storage: None }
2025-11-09T23:42:54.8218365Z +        Self {
2025-11-09T23:42:54.8218710Z +            mempool: None,
2025-11-09T23:42:54.8218859Z +            storage: None,
2025-11-09T23:42:54.8218980Z +        }
2025-11-09T23:42:54.8219100Z      }
2025-11-09T23:42:54.8219206Z  
2025-11-09T23:42:54.8219355Z      /// Create with dependencies
2025-11-09T23:42:54.8219803Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:30:
2025-11-09T23:42:54.8220217Z      pub fn with_dependencies(mempool: Arc<MempoolManager>, storage: Arc<Storage>) -> Self {
2025-11-09T23:42:54.8220977Z -        Self { mempool: Some(mempool), storage: Some(storage) }
2025-11-09T23:42:54.8221113Z +        Self {
2025-11-09T23:42:54.8221283Z +            mempool: Some(mempool),
2025-11-09T23:42:54.8221423Z +            storage: Some(storage),
2025-11-09T23:42:54.8221534Z +        }
2025-11-09T23:42:54.8221651Z      }
2025-11-09T23:42:54.8221761Z  
2025-11-09T23:42:54.8221905Z      /// Get mempool information
2025-11-09T23:42:54.8222346Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:40:
2025-11-09T23:42:54.8222611Z          if let Some(ref mempool) = self.mempool {
2025-11-09T23:42:54.8222767Z              let size = mempool.size();
2025-11-09T23:42:54.8222978Z              let transactions = mempool.get_transactions();
2025-11-09T23:42:54.8223204Z -            let bytes: usize = transactions.iter().map(|tx| {
2025-11-09T23:42:54.8223550Z -                use bllvm_protocol::serialization::transaction::serialize_transaction;
2025-11-09T23:42:54.8223712Z -                serialize_transaction(tx).len()
2025-11-09T23:42:54.8223833Z -            }).sum();
2025-11-09T23:42:54.8224010Z +            let bytes: usize = transactions
2025-11-09T23:42:54.8224132Z +                .iter()
2025-11-09T23:42:54.8224259Z +                .map(|tx| {
2025-11-09T23:42:54.8224784Z +                    use bllvm_protocol::serialization::transaction::serialize_transaction;
2025-11-09T23:42:54.8224961Z +                    serialize_transaction(tx).len()
2025-11-09T23:42:54.8225082Z +                })
2025-11-09T23:42:54.8225205Z +                .sum();
2025-11-09T23:42:54.8225318Z  
2025-11-09T23:42:54.8225439Z              Ok(json!({
2025-11-09T23:42:54.8225561Z                  "loaded": true,
2025-11-09T23:42:54.8225994Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:56:
2025-11-09T23:42:54.8226098Z              }))
2025-11-09T23:42:54.8226211Z          } else {
2025-11-09T23:42:54.8226570Z              // Graceful degradation: return empty mempool info when mempool unavailable
2025-11-09T23:42:54.8227039Z -            tracing::debug!("getmempoolinfo called but mempool not available, returning empty mempool");
2025-11-09T23:42:54.8227449Z +            tracing::debug!(
2025-11-09T23:42:54.8227796Z +                "getmempoolinfo called but mempool not available, returning empty mempool"
2025-11-09T23:42:54.8227920Z +            );
2025-11-09T23:42:54.8228036Z              Ok(json!({
2025-11-09T23:42:54.8228178Z                  "loaded": false,
2025-11-09T23:42:54.8228312Z                  "size": 0,
2025-11-09T23:42:54.8228757Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:82:
2025-11-09T23:42:54.8228970Z              let transactions = mempool.get_transactions();
2025-11-09T23:42:54.8229187Z              use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:42:54.8229527Z              use bllvm_protocol::serialization::transaction::serialize_transaction;
2025-11-09T23:42:54.8229646Z -            
2025-11-09T23:42:54.8229754Z +
2025-11-09T23:42:54.8229894Z              if verbose {
2025-11-09T23:42:54.8230091Z                  let mut result = serde_json::Map::new();
2025-11-09T23:42:54.8230240Z                  for tx in transactions {
2025-11-09T23:42:54.8230691Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:90:
2025-11-09T23:42:54.8230869Z                      let txid_hex = hex::encode(txid);
2025-11-09T23:42:54.8231258Z                      let txid_hex_clone = txid_hex.clone();
2025-11-09T23:42:54.8231490Z                      let size = serialize_transaction(&tx).len();
2025-11-09T23:42:54.8231609Z -                    
2025-11-09T23:42:54.8231719Z +
2025-11-09T23:42:54.8231890Z                      result.insert(txid_hex, json!({
2025-11-09T23:42:54.8232039Z                          "size": size,
2025-11-09T23:42:54.8232499Z                          "fee": if let (Some(ref mempool), Some(ref storage)) = (self.mempool.as_ref(), self.storage.as_ref()) {
2025-11-09T23:42:54.8232963Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:126:
2025-11-09T23:42:54.8233100Z                  }
2025-11-09T23:42:54.8233238Z                  Ok(json!(result))
2025-11-09T23:42:54.8233357Z              } else {
2025-11-09T23:42:54.8233605Z -                let txids: Vec<String> = transactions.iter().map(|tx| {
2025-11-09T23:42:54.8233782Z -                    let txid = calculate_tx_id(tx);
2025-11-09T23:42:54.8233935Z -                    hex::encode(txid)
2025-11-09T23:42:54.8234067Z -                }).collect();
2025-11-09T23:42:54.8234249Z +                let txids: Vec<String> = transactions
2025-11-09T23:42:54.8234563Z +                    .iter()
2025-11-09T23:42:54.8234701Z +                    .map(|tx| {
2025-11-09T23:42:54.8234870Z +                        let txid = calculate_tx_id(tx);
2025-11-09T23:42:54.8235021Z +                        hex::encode(txid)
2025-11-09T23:42:54.8235138Z +                    })
2025-11-09T23:42:54.8235264Z +                    .collect();
2025-11-09T23:42:54.8235409Z                  Ok(json!(txids))
2025-11-09T23:42:54.8235531Z              }
2025-11-09T23:42:54.8235643Z          } else {
2025-11-09T23:42:54.8236110Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:174:
2025-11-09T23:42:54.8236287Z          if let Some(mempool) = &self.mempool {
2025-11-09T23:42:54.8236618Z              let data_dir = std::env::var("DATA_DIR").unwrap_or_else(|_| "data".to_string());
2025-11-09T23:42:54.8236950Z              let mempool_path = std::path::Path::new(&data_dir).join("mempool.dat");
2025-11-09T23:42:54.8237070Z -            
2025-11-09T23:42:54.8237179Z +
2025-11-09T23:42:54.8237416Z              // Arc implements Deref, so we can call methods directly
2025-11-09T23:42:54.8237643Z              if let Err(e) = mempool.save_to_disk(&mempool_path) {
2025-11-09T23:42:54.8237912Z -                return Err(crate::rpc::errors::RpcError::internal_error(
2025-11-09T23:42:54.8238104Z -                    format!("Failed to save mempool: {}", e)
2025-11-09T23:42:54.8238454Z -                ));
2025-11-09T23:42:54.8238741Z +                return Err(crate::rpc::errors::RpcError::internal_error(format!(
2025-11-09T23:42:54.8238896Z +                    "Failed to save mempool: {}",
2025-11-09T23:42:54.8239017Z +                    e
2025-11-09T23:42:54.8239146Z +                )));
2025-11-09T23:42:54.8239262Z              }
2025-11-09T23:42:54.8239404Z              Ok(json!(null))
2025-11-09T23:42:54.8239529Z          } else {
2025-11-09T23:42:54.8239990Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:186:
2025-11-09T23:42:54.8240214Z              Err(crate::rpc::errors::RpcError::internal_error(
2025-11-09T23:42:54.8240400Z -                "Mempool not initialized".to_string()
2025-11-09T23:42:54.8240580Z +                "Mempool not initialized".to_string(),
2025-11-09T23:42:54.8240694Z              ))
2025-11-09T23:42:54.8240805Z          }
2025-11-09T23:42:54.8240918Z      }
2025-11-09T23:42:54.8241376Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:195:
2025-11-09T23:42:54.8241766Z      pub async fn getmempoolancestors(&self, params: &Value) -> RpcResult<Value> {
2025-11-09T23:42:54.8241948Z          debug!("RPC: getmempoolancestors");
2025-11-09T23:42:54.8242059Z  
2025-11-09T23:42:54.8242206Z -        let txid = params.get(0)
2025-11-09T23:42:54.8242571Z -            .and_then(|p| p.as_str())
2025-11-09T23:42:54.8243067Z -            .ok_or_else(|| crate::rpc::errors::RpcError::invalid_params("Transaction ID required".to_string()))?;
2025-11-09T23:42:54.8243352Z +        let txid = params.get(0).and_then(|p| p.as_str()).ok_or_else(|| {
2025-11-09T23:42:54.8243752Z +            crate::rpc::errors::RpcError::invalid_params("Transaction ID required".to_string())
2025-11-09T23:42:54.8243879Z +        })?;
2025-11-09T23:42:54.8243993Z  
2025-11-09T23:42:54.8244475Z          let verbose = params.get(1).and_then(|p| p.as_bool()).unwrap_or(false);
2025-11-09T23:42:54.8244611Z  
2025-11-09T23:42:54.8245083Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:204:
2025-11-09T23:42:54.8245261Z -        let hash_bytes = hex::decode(txid)
2025-11-09T23:42:54.8245698Z -            .map_err(|e| crate::rpc::errors::RpcError::invalid_params(format!("Invalid transaction ID: {}", e)))?;
2025-11-09T23:42:54.8245910Z +        let hash_bytes = hex::decode(txid).map_err(|e| {
2025-11-09T23:42:54.8246308Z +            crate::rpc::errors::RpcError::invalid_params(format!("Invalid transaction ID: {}", e))
2025-11-09T23:42:54.8246418Z +        })?;
2025-11-09T23:42:54.8246560Z          if hash_bytes.len() != 32 {
2025-11-09T23:42:54.8247024Z -            return Err(crate::rpc::errors::RpcError::invalid_params("Transaction ID must be 32 bytes".to_string()));
2025-11-09T23:42:54.8247276Z +            return Err(crate::rpc::errors::RpcError::invalid_params(
2025-11-09T23:42:54.8247484Z +                "Transaction ID must be 32 bytes".to_string(),
2025-11-09T23:42:54.8247600Z +            ));
2025-11-09T23:42:54.8247713Z          }
2025-11-09T23:42:54.8247840Z          let mut hash = [0u8; 32];
2025-11-09T23:42:54.8248000Z          hash.copy_from_slice(&hash_bytes);
2025-11-09T23:42:54.8248431Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:222:
2025-11-09T23:42:54.8248655Z                          let ancestor_txid_clone = ancestor_txid.clone();
2025-11-09T23:42:54.8248998Z                          use bllvm_protocol::serialization::transaction::serialize_transaction;
2025-11-09T23:42:54.8249220Z                          let size = serialize_transaction(&ancestor_tx).len();
2025-11-09T23:42:54.8249329Z -                        
2025-11-09T23:42:54.8249431Z +
2025-11-09T23:42:54.8249604Z                          result.insert(ancestor_txid, json!({
2025-11-09T23:42:54.8249733Z                              "size": size,
2025-11-09T23:42:54.8249918Z                              "fee": if let Some(ref storage) = self.storage {
2025-11-09T23:42:54.8250650Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:278:
2025-11-09T23:42:54.8251003Z      pub async fn getmempooldescendants(&self, params: &Value) -> RpcResult<Value> {
2025-11-09T23:42:54.8251175Z          debug!("RPC: getmempooldescendants");
2025-11-09T23:42:54.8251294Z  
2025-11-09T23:42:54.8251443Z -        let txid = params.get(0)
2025-11-09T23:42:54.8251603Z -            .and_then(|p| p.as_str())
2025-11-09T23:42:54.8252055Z -            .ok_or_else(|| crate::rpc::errors::RpcError::invalid_params("Transaction ID required".to_string()))?;
2025-11-09T23:42:54.8252308Z +        let txid = params.get(0).and_then(|p| p.as_str()).ok_or_else(|| {
2025-11-09T23:42:54.8252662Z +            crate::rpc::errors::RpcError::invalid_params("Transaction ID required".to_string())
2025-11-09T23:42:54.8252767Z +        })?;
2025-11-09T23:42:54.8252878Z  
2025-11-09T23:42:54.8253169Z          let verbose = params.get(1).and_then(|p| p.as_bool()).unwrap_or(false);
2025-11-09T23:42:54.8253289Z  
2025-11-09T23:42:54.8253754Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:287:
2025-11-09T23:42:54.8253925Z -        let hash_bytes = hex::decode(txid)
2025-11-09T23:42:54.8254576Z -            .map_err(|e| crate::rpc::errors::RpcError::invalid_params(format!("Invalid transaction ID: {}", e)))?;
2025-11-09T23:42:54.8255022Z +        let hash_bytes = hex::decode(txid).map_err(|e| {
2025-11-09T23:42:54.8255447Z +            crate::rpc::errors::RpcError::invalid_params(format!("Invalid transaction ID: {}", e))
2025-11-09T23:42:54.8255569Z +        })?;
2025-11-09T23:42:54.8255717Z          if hash_bytes.len() != 32 {
2025-11-09T23:42:54.8256230Z -            return Err(crate::rpc::errors::RpcError::invalid_params("Transaction ID must be 32 bytes".to_string()));
2025-11-09T23:42:54.8256493Z +            return Err(crate::rpc::errors::RpcError::invalid_params(
2025-11-09T23:42:54.8256691Z +                "Transaction ID must be 32 bytes".to_string(),
2025-11-09T23:42:54.8256825Z +            ));
2025-11-09T23:42:54.8256937Z          }
2025-11-09T23:42:54.8257077Z          let mut hash = [0u8; 32];
2025-11-09T23:42:54.8257243Z          hash.copy_from_slice(&hash_bytes);
2025-11-09T23:42:54.8257700Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:295:
2025-11-09T23:42:54.8257891Z          if let Some(ref mempool) = self.mempool {
2025-11-09T23:42:54.8258344Z              // Find descendants by checking which transactions spend outputs created by this transaction
2025-11-09T23:42:54.8258526Z              let mut descendants = Vec::new();
2025-11-09T23:42:54.8258639Z -            
2025-11-09T23:42:54.8258743Z +
2025-11-09T23:42:54.8258950Z              if let Some(tx) = mempool.get_transaction(&hash) {
2025-11-09T23:42:54.8259159Z                  // Get all output outpoints from this transaction
2025-11-09T23:42:54.8259344Z                  let mut output_outpoints = Vec::new();
2025-11-09T23:42:54.8259809Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:329:
2025-11-09T23:42:54.8260057Z                          let descendant_txid_clone = descendant_txid.clone();
2025-11-09T23:42:54.8260406Z                          use bllvm_protocol::serialization::transaction::serialize_transaction;
2025-11-09T23:42:54.8260659Z                          let size = serialize_transaction(&descendant_tx).len();
2025-11-09T23:42:54.8260783Z -                        
2025-11-09T23:42:54.8260893Z +
2025-11-09T23:42:54.8261080Z                          result.insert(descendant_txid, json!({
2025-11-09T23:42:54.8261227Z                              "size": size,
2025-11-09T23:42:54.8261435Z                              "fee": if let Some(ref storage) = self.storage {
2025-11-09T23:42:54.8261885Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:385:
2025-11-09T23:42:54.8262227Z      pub async fn getmempoolentry(&self, params: &Value) -> RpcResult<Value> {
2025-11-09T23:42:54.8262621Z          debug!("RPC: getmempoolentry");
2025-11-09T23:42:54.8262736Z  
2025-11-09T23:42:54.8262882Z -        let txid = params.get(0)
2025-11-09T23:42:54.8263042Z -            .and_then(|p| p.as_str())
2025-11-09T23:42:54.8263505Z -            .ok_or_else(|| crate::rpc::errors::RpcError::invalid_params("Transaction ID required".to_string()))?;
2025-11-09T23:42:54.8263792Z +        let txid = params.get(0).and_then(|p| p.as_str()).ok_or_else(|| {
2025-11-09T23:42:54.8267043Z +            crate::rpc::errors::RpcError::invalid_params("Transaction ID required".to_string())
2025-11-09T23:42:54.8267178Z +        })?;
2025-11-09T23:42:54.8267290Z  
2025-11-09T23:42:54.8267621Z          let verbose = params.get(1).and_then(|p| p.as_bool()).unwrap_or(false);
2025-11-09T23:42:54.8267728Z  
2025-11-09T23:42:54.8268185Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:394:
2025-11-09T23:42:54.8268368Z -        let hash_bytes = hex::decode(txid)
2025-11-09T23:42:54.8268861Z -            .map_err(|e| crate::rpc::errors::RpcError::invalid_params(format!("Invalid transaction ID: {}", e)))?;
2025-11-09T23:42:54.8269067Z +        let hash_bytes = hex::decode(txid).map_err(|e| {
2025-11-09T23:42:54.8269457Z +            crate::rpc::errors::RpcError::invalid_params(format!("Invalid transaction ID: {}", e))
2025-11-09T23:42:54.8269582Z +        })?;
2025-11-09T23:42:54.8269935Z          if hash_bytes.len() != 32 {
2025-11-09T23:42:54.8270447Z -            return Err(crate::rpc::errors::RpcError::invalid_params("Transaction ID must be 32 bytes".to_string()));
2025-11-09T23:42:54.8270725Z +            return Err(crate::rpc::errors::RpcError::invalid_params(
2025-11-09T23:42:54.8270918Z +                "Transaction ID must be 32 bytes".to_string(),
2025-11-09T23:42:54.8271040Z +            ));
2025-11-09T23:42:54.8271152Z          }
2025-11-09T23:42:54.8271303Z          let mut hash = [0u8; 32];
2025-11-09T23:42:54.8271470Z          hash.copy_from_slice(&hash_bytes);
2025-11-09T23:42:54.8272182Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:403:
2025-11-09T23:42:54.8272403Z              if let Some(tx) = mempool.get_transaction(&hash) {
2025-11-09T23:42:54.8272726Z                  use bllvm_protocol::serialization::transaction::serialize_transaction;
2025-11-09T23:42:54.8272911Z                  let size = serialize_transaction(&tx).len();
2025-11-09T23:42:54.8273046Z -                
2025-11-09T23:42:54.8273162Z +
2025-11-09T23:42:54.8273333Z                  // Get ancestors and descendants
2025-11-09T23:42:54.8273564Z                  let ancestors = self.get_ancestors(mempool, &hash);
2025-11-09T23:42:54.8273830Z                  let descendants = self.get_descendants(mempool, &hash);
2025-11-09T23:42:54.8276298Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:410:
2025-11-09T23:42:54.8276426Z -                
2025-11-09T23:42:54.8276545Z +
2025-11-09T23:42:54.8276728Z                  let ancestor_count = ancestors.len();
2025-11-09T23:42:54.8276931Z                  let descendant_count = descendants.len();
2025-11-09T23:42:54.8277134Z -                let ancestor_size: usize = ancestors.iter()
2025-11-09T23:42:54.8277304Z +                let ancestor_size: usize = ancestors
2025-11-09T23:42:54.8277431Z +                    .iter()
2025-11-09T23:42:54.8277627Z                      .filter_map(|h| mempool.get_transaction(h))
2025-11-09T23:42:54.8277812Z                      .map(|tx| serialize_transaction(&tx).len())
2025-11-09T23:42:54.8277934Z                      .sum();
2025-11-09T23:42:54.8278401Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:417:
2025-11-09T23:42:54.8278623Z -                let descendant_size: usize = descendants.iter()
2025-11-09T23:42:54.8278810Z +                let descendant_size: usize = descendants
2025-11-09T23:42:54.8278933Z +                    .iter()
2025-11-09T23:42:54.8279134Z                      .filter_map(|h| mempool.get_transaction(h))
2025-11-09T23:42:54.8279538Z                      .map(|tx| serialize_transaction(&tx).len())
2025-11-09T23:42:54.8279657Z                      .sum();
2025-11-09T23:42:54.8280121Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:454:
2025-11-09T23:42:54.8280294Z                      "bip125-replaceable": false
2025-11-09T23:42:54.8280419Z                  }))
2025-11-09T23:42:54.8280541Z              } else {
2025-11-09T23:42:54.8280766Z -                Err(crate::rpc::errors::RpcError::invalid_params(
2025-11-09T23:42:54.8280982Z -                    format!("Transaction {} not found in mempool", txid)
2025-11-09T23:42:54.8281089Z -                ))
2025-11-09T23:42:54.8281338Z +                Err(crate::rpc::errors::RpcError::invalid_params(format!(
2025-11-09T23:42:54.8281532Z +                    "Transaction {} not found in mempool",
2025-11-09T23:42:54.8281654Z +                    txid
2025-11-09T23:42:54.8281768Z +                )))
2025-11-09T23:42:54.8281904Z              }
2025-11-09T23:42:54.8282021Z          } else {
2025-11-09T23:42:54.8282240Z              Err(crate::rpc::errors::RpcError::internal_error(
2025-11-09T23:42:54.8282687Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:463:
2025-11-09T23:42:54.8282857Z -                "Mempool not initialized".to_string()
2025-11-09T23:42:54.8283197Z +                "Mempool not initialized".to_string(),
2025-11-09T23:42:54.8283312Z              ))
2025-11-09T23:42:54.8283426Z          }
2025-11-09T23:42:54.8283534Z      }
2025-11-09T23:42:54.8283945Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:468:
2025-11-09T23:42:54.8284122Z      /// Helper: Get ancestors for a transaction
2025-11-09T23:42:54.8284644Z      fn get_ancestors(&self, mempool: &MempoolManager, tx_hash: &Hash) -> Vec<Hash> {
2025-11-09T23:42:54.8284811Z          let mut ancestors = Vec::new();
2025-11-09T23:42:54.8284921Z -        
2025-11-09T23:42:54.8285051Z +
2025-11-09T23:42:54.8285269Z          if let Some(tx) = mempool.get_transaction(tx_hash) {
2025-11-09T23:42:54.8285629Z              // Find transactions that this transaction depends on (spends their outputs)
2025-11-09T23:42:54.8285854Z              use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:42:54.8286319Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:478:
2025-11-09T23:42:54.8286497Z                  for ancestor_tx in transactions {
2025-11-09T23:42:54.8286729Z                      let ancestor_hash = calculate_tx_id(&ancestor_tx);
2025-11-09T23:42:54.8286990Z                      for (idx, _output) in ancestor_tx.outputs.iter().enumerate() {
2025-11-09T23:42:54.8287361Z -                        if input.prevout.hash == ancestor_hash && input.prevout.index == idx as u64 {
2025-11-09T23:42:54.8287722Z +                        if input.prevout.hash == ancestor_hash && input.prevout.index == idx as u64
2025-11-09T23:42:54.8287855Z +                        {
2025-11-09T23:42:54.8288053Z                              if !ancestors.contains(&ancestor_hash) {
2025-11-09T23:42:54.8288232Z                                  ancestors.push(ancestor_hash);
2025-11-09T23:42:54.8288356Z                              }
2025-11-09T23:42:54.8288810Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:487:
2025-11-09T23:42:54.8288934Z                  }
2025-11-09T23:42:54.8289054Z              }
2025-11-09T23:42:54.8289166Z          }
2025-11-09T23:42:54.8289280Z -        
2025-11-09T23:42:54.8289387Z +
2025-11-09T23:42:54.8289514Z          ancestors
2025-11-09T23:42:54.8289619Z      }
2025-11-09T23:42:54.8289728Z  
2025-11-09T23:42:54.8290194Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:494:
2025-11-09T23:42:54.8290381Z      /// Helper: Get descendants for a transaction
2025-11-09T23:42:54.8290754Z      fn get_descendants(&self, mempool: &MempoolManager, tx_hash: &Hash) -> Vec<Hash> {
2025-11-09T23:42:54.8291169Z          let mut descendants = Vec::new();
2025-11-09T23:42:54.8291281Z -        
2025-11-09T23:42:54.8291399Z +
2025-11-09T23:42:54.8291626Z          if let Some(tx) = mempool.get_transaction(tx_hash) {
2025-11-09T23:42:54.8291832Z              // Get all output outpoints from this transaction
2025-11-09T23:42:54.8292024Z              let mut output_outpoints = Vec::new();
2025-11-09T23:42:54.8293971Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mempool.rs:520:
2025-11-09T23:42:54.8294089Z                  }
2025-11-09T23:42:54.8294211Z              }
2025-11-09T23:42:54.8294509Z          }
2025-11-09T23:42:54.8294633Z -        
2025-11-09T23:42:54.8294742Z +
2025-11-09T23:42:54.8294876Z          descendants
2025-11-09T23:42:54.8294989Z      }
2025-11-09T23:42:54.8295093Z  }
2025-11-09T23:42:54.8318961Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:1:
2025-11-09T23:42:54.8319170Z  //! Mining RPC methods
2025-11-09T23:42:54.8319305Z -//! 
2025-11-09T23:42:54.8319421Z +//!
2025-11-09T23:42:54.8319844Z  //! Implements mining-related JSON-RPC methods for block template generation and mining.
2025-11-09T23:42:54.8320100Z  //! Uses formally verified consensus-proof mining functions.
2025-11-09T23:42:54.8320216Z  
2025-11-09T23:42:54.8320899Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:6:
2025-11-09T23:42:54.8321069Z -use serde_json::{Value, json};
2025-11-09T23:42:54.8321221Z -use tracing::{debug, warn};
2025-11-09T23:42:54.8321353Z -use hex;
2025-11-09T23:42:54.8321536Z +use crate::node::mempool::MempoolManager;
2025-11-09T23:42:54.8321731Z  use crate::rpc::errors::{RpcError, RpcResult};
2025-11-09T23:42:54.8322398Z -use bllvm_protocol::{ConsensusProof, types::{BlockHeader, Transaction, UtxoSet, Natural, ByteString, Hash}, ValidationResult};
2025-11-09T23:42:54.8322651Z -use bllvm_protocol::serialization::serialize_transaction;
2025-11-09T23:42:54.8322796Z +use crate::storage::Storage;
2025-11-09T23:42:54.8322987Z  use bllvm_protocol::mining::BlockTemplate;
2025-11-09T23:42:54.8323298Z -use bllvm_protocol::serialization::deserialize_block_with_witnesses;
2025-11-09T23:42:54.8323471Z  use bllvm_protocol::pow::expand_target;
2025-11-09T23:42:54.8323603Z -use std::sync::Arc;
2025-11-09T23:42:54.8323754Z -use crate::storage::Storage;
2025-11-09T23:42:54.8323936Z -use crate::node::mempool::MempoolManager;
2025-11-09T23:42:54.8324249Z +use bllvm_protocol::serialization::deserialize_block_with_witnesses;
2025-11-09T23:42:54.8324672Z +use bllvm_protocol::serialization::serialize_transaction;
2025-11-09T23:42:54.8324813Z +use bllvm_protocol::{
2025-11-09T23:42:54.8325139Z +    types::{BlockHeader, ByteString, Hash, Natural, Transaction, UtxoSet},
2025-11-09T23:42:54.8325316Z +    ConsensusProof, ValidationResult,
2025-11-09T23:42:54.8325425Z +};
2025-11-09T23:42:54.8325539Z +use hex;
2025-11-09T23:42:54.8325682Z +use serde_json::{json, Value};
2025-11-09T23:42:54.8325840Z  use sha2::{Digest, Sha256};
2025-11-09T23:42:54.8325968Z +use std::sync::Arc;
2025-11-09T23:42:54.8326106Z +use tracing::{debug, warn};
2025-11-09T23:42:54.8326223Z  
2025-11-09T23:42:54.8326384Z  /// Mining RPC methods with dependencies
2025-11-09T23:42:54.8326524Z  pub struct MiningRpc {
2025-11-09T23:42:54.8326969Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:36:
2025-11-09T23:42:54.8327102Z              mempool: None,
2025-11-09T23:42:54.8327206Z          }
2025-11-09T23:42:54.8327305Z      }
2025-11-09T23:42:54.8327415Z -    
2025-11-09T23:42:54.8327515Z +
2025-11-09T23:42:54.8327710Z      /// Create with dependencies (storage and mempool)
2025-11-09T23:42:54.8328101Z      pub fn with_dependencies(storage: Arc<Storage>, mempool: Arc<MempoolManager>) -> Self {
2025-11-09T23:42:54.8328224Z          Self {
2025-11-09T23:42:54.8328655Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:45:
2025-11-09T23:42:54.8328809Z              mempool: Some(mempool),
2025-11-09T23:42:54.8329124Z          }
2025-11-09T23:42:54.8329230Z      }
2025-11-09T23:42:54.8329340Z -    
2025-11-09T23:42:54.8329449Z +
2025-11-09T23:42:54.8329595Z      /// Get mining information
2025-11-09T23:42:54.8329842Z      pub async fn get_mining_info(&self) -> RpcResult<Value> {
2025-11-09T23:42:54.8330000Z          debug!("RPC: getmininginfo");
2025-11-09T23:42:54.8330457Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:52:
2025-11-09T23:42:54.8330572Z -        
2025-11-09T23:42:54.8330678Z +
2025-11-09T23:42:54.8330856Z          // Get current block height from storage
2025-11-09T23:42:54.8331087Z          let blocks = if let Some(ref storage) = self.storage {
2025-11-09T23:42:54.8331247Z -            storage.chain().get_height()
2025-11-09T23:42:54.8331362Z +            storage
2025-11-09T23:42:54.8331498Z +                .chain()
2025-11-09T23:42:54.8331629Z +                .get_height()
2025-11-09T23:42:54.8331999Z                  .map_err(|e| RpcError::internal_error(format!("Failed to get height: {}", e)))?
2025-11-09T23:42:54.8332150Z                  .unwrap_or(0)
2025-11-09T23:42:54.8332267Z          } else {
2025-11-09T23:42:54.8332734Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:59:
2025-11-09T23:42:54.8332852Z              0
2025-11-09T23:42:54.8332966Z          };
2025-11-09T23:42:54.8333294Z -        
2025-11-09T23:42:54.8333430Z +
2025-11-09T23:42:54.8333574Z          // Get mempool size
2025-11-09T23:42:54.8333827Z          let pooledtx = if let Some(ref mempool) = self.mempool {
2025-11-09T23:42:54.8333974Z              mempool.size()
2025-11-09T23:42:54.8334641Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:65:
2025-11-09T23:42:54.8334777Z          } else {
2025-11-09T23:42:54.8334890Z              0
2025-11-09T23:42:54.8335006Z          };
2025-11-09T23:42:54.8335121Z -        
2025-11-09T23:42:54.8335230Z +
2025-11-09T23:42:54.8335573Z          // Get difficulty from latest block's bits field (graceful degradation)
2025-11-09T23:42:54.8335830Z          let difficulty = if let Some(ref storage) = self.storage {
2025-11-09T23:42:54.8345405Z              if let Ok(Some(tip_header)) = storage.chain().get_tip_header() {
2025-11-09T23:42:54.8345920Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:78:
2025-11-09T23:42:54.8346260Z              tracing::debug!("Storage not available, using default difficulty");
2025-11-09T23:42:54.8346428Z              1.0 // Graceful fallback if no storage
2025-11-09T23:42:54.8346540Z          };
2025-11-09T23:42:54.8346656Z -        
2025-11-09T23:42:54.8346757Z +
2025-11-09T23:42:54.8347114Z          // Calculate network hashrate from recent block timestamps (graceful degradation)
2025-11-09T23:42:54.8347380Z          let networkhashps = if let Some(ref storage) = self.storage {
2025-11-09T23:42:54.8347683Z -            self.calculate_network_hashrate(storage).unwrap_or_else(|e| {
2025-11-09T23:42:54.8348041Z -                tracing::debug!("Failed to calculate network hashrate: {}, using 0.0", e);
2025-11-09T23:42:54.8348157Z -                0.0
2025-11-09T23:42:54.8348281Z -            })
2025-11-09T23:42:54.8348458Z +            self.calculate_network_hashrate(storage)
2025-11-09T23:42:54.8348604Z +                .unwrap_or_else(|e| {
2025-11-09T23:42:54.8348949Z +                    tracing::debug!("Failed to calculate network hashrate: {}, using 0.0", e);
2025-11-09T23:42:54.8349076Z +                    0.0
2025-11-09T23:42:54.8349183Z +                })
2025-11-09T23:42:54.8349295Z          } else {
2025-11-09T23:42:54.8349621Z              tracing::debug!("Storage not available, network hashrate unavailable");
2025-11-09T23:42:54.8349729Z              0.0
2025-11-09T23:42:54.8350165Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:91:
2025-11-09T23:42:54.8350285Z          };
2025-11-09T23:42:54.8350393Z -        
2025-11-09T23:42:54.8350762Z +
2025-11-09T23:42:54.8350968Z          // Get current block template info (if available)
2025-11-09T23:42:54.8351385Z          let currentblocksize = 0;
2025-11-09T23:42:54.8351534Z          let currentblockweight = 0;
2025-11-09T23:42:54.8351968Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:96:
2025-11-09T23:42:54.8352122Z          let currentblocktx = 0;
2025-11-09T23:42:54.8352227Z -        
2025-11-09T23:42:54.8352337Z +
2025-11-09T23:42:54.8352534Z          // Determine chain name from storage chain params
2025-11-09T23:42:54.8352750Z          let chain = if let Some(ref storage) = self.storage {
2025-11-09T23:42:54.8352969Z              if let Ok(Some(info)) = storage.chain().load_chain_info() {
2025-11-09T23:42:54.8353376Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:110:
2025-11-09T23:42:54.8353506Z          } else {
2025-11-09T23:42:54.8353636Z              "main" // Default
2025-11-09T23:42:54.8353759Z          };
2025-11-09T23:42:54.8353869Z -        
2025-11-09T23:42:54.8353967Z +
2025-11-09T23:42:54.8354080Z          Ok(json!({
2025-11-09T23:42:54.8354200Z              "blocks": blocks,
2025-11-09T23:42:54.8354632Z              "currentblocksize": currentblocksize,
2025-11-09T23:42:54.8355040Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:123:
2025-11-09T23:42:54.8355392Z              "warnings": ""
2025-11-09T23:42:54.8355514Z          }))
2025-11-09T23:42:54.8355621Z      }
2025-11-09T23:42:54.8355728Z -    
2025-11-09T23:42:54.8355830Z +
2025-11-09T23:42:54.8355963Z      /// Get block template
2025-11-09T23:42:54.8356065Z -    /// 
2025-11-09T23:42:54.8356166Z +    ///
2025-11-09T23:42:54.8356332Z      /// Params: [template_request (optional)]
2025-11-09T23:42:54.8356432Z -    /// 
2025-11-09T23:42:54.8356541Z +    ///
2025-11-09T23:42:54.8356951Z      /// Uses formally verified consensus-proof::mining::create_block_template() function
2025-11-09T23:42:54.8357328Z      /// which has Kani proofs ensuring correctness per Orange Paper Section 12.4
2025-11-09T23:42:54.8357672Z      pub async fn get_block_template(&self, params: &Value) -> RpcResult<Value> {
2025-11-09T23:42:54.8358109Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:134:
2025-11-09T23:42:54.8358289Z          debug!("RPC: getblocktemplate");
2025-11-09T23:42:54.8358415Z -        
2025-11-09T23:42:54.8358526Z +
2025-11-09T23:42:54.8358673Z          // 1. Get current chainstate
2025-11-09T23:42:54.8358892Z -        let height: Natural = self.get_current_height()?
2025-11-09T23:42:54.8359031Z +        let height: Natural = self
2025-11-09T23:42:54.8359164Z +            .get_current_height()?
2025-11-09T23:42:54.8359467Z              .ok_or_else(|| RpcError::internal_error("Chain not initialized"))?;
2025-11-09T23:42:54.8359646Z -        let prev_header = self.get_tip_header()?
2025-11-09T23:42:54.8359788Z +        let prev_header = self
2025-11-09T23:42:54.8359932Z +            .get_tip_header()?
2025-11-09T23:42:54.8360167Z              .ok_or_else(|| RpcError::internal_error("No chain tip"))?;
2025-11-09T23:42:54.8360379Z          let prev_headers = self.get_headers_for_difficulty()?;
2025-11-09T23:42:54.8360483Z -        
2025-11-09T23:42:54.8360590Z +
2025-11-09T23:42:54.8360726Z          // 2. Get mempool transactions
2025-11-09T23:42:54.8361019Z          let mempool_txs: Vec<Transaction> = self.get_mempool_transactions()?;
2025-11-09T23:42:54.8361130Z -        
2025-11-09T23:42:54.8361234Z +
2025-11-09T23:42:54.8361355Z          // 3. Get UTXO set
2025-11-09T23:42:54.8361515Z          let utxo_set = self.get_utxo_set()?;
2025-11-09T23:42:54.8361642Z -        
2025-11-09T23:42:54.8361751Z +
2025-11-09T23:42:54.8362019Z          // 4. Extract coinbase parameters from request or use defaults
2025-11-09T23:42:54.8362409Z          let coinbase_script = self.extract_coinbase_script(params).unwrap_or_default();
2025-11-09T23:42:54.8362798Z          let coinbase_address = self.extract_coinbase_address(params).unwrap_or_default();
2025-11-09T23:42:54.8363494Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:152:
2025-11-09T23:42:54.8363619Z -        
2025-11-09T23:42:54.8363725Z +
2025-11-09T23:42:54.8363951Z          // 5. Use formally verified function from consensus-proof
2025-11-09T23:42:54.8364272Z          // This function has Kani proofs: kani_create_block_template_completeness
2025-11-09T23:42:54.8364689Z          let template = match self.consensus.create_block_template(
2025-11-09T23:42:54.8365113Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:164:
2025-11-09T23:42:54.8365234Z              Ok(t) => t,
2025-11-09T23:42:54.8365356Z              Err(e) => {
2025-11-09T23:42:54.8365552Z                  warn!("Failed to create block template: {}", e);
2025-11-09T23:42:54.8365950Z -                return Err(RpcError::internal_error(format!("Template creation failed: {}", e)));
2025-11-09T23:42:54.8366172Z +                return Err(RpcError::internal_error(format!(
2025-11-09T23:42:54.8366341Z +                    "Template creation failed: {}",
2025-11-09T23:42:54.8366457Z +                    e
2025-11-09T23:42:54.8366568Z +                )));
2025-11-09T23:42:54.8366685Z              }
2025-11-09T23:42:54.8366790Z          };
2025-11-09T23:42:54.8366895Z -        
2025-11-09T23:42:54.8367231Z +
2025-11-09T23:42:54.8367430Z          // 6. Convert to JSON-RPC format (BIP 22/23)
2025-11-09T23:42:54.8367694Z          self.template_to_json_rpc(&template, &prev_header, height)
2025-11-09T23:42:54.8367806Z      }
2025-11-09T23:42:54.8368392Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:174:
2025-11-09T23:42:54.8368548Z -    
2025-11-09T23:42:54.8368694Z +
2025-11-09T23:42:54.8368919Z      /// Convert BlockTemplate to JSON-RPC format
2025-11-09T23:42:54.8369104Z      fn template_to_json_rpc(
2025-11-09T23:42:54.8369266Z          &self,
2025-11-09T23:42:54.8369725Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:181:
2025-11-09T23:42:54.8369887Z      ) -> RpcResult<Value> {
2025-11-09T23:42:54.8370104Z          // Convert previous block hash to hex (big-endian)
2025-11-09T23:42:54.8370381Z          let prev_hash_hex = hex::encode(prev_header.prev_block_hash);
2025-11-09T23:42:54.8370509Z -        
2025-11-09T23:42:54.8370629Z +
2025-11-09T23:42:54.8370860Z          // Convert target to hex (64 characters, big-endian)
2025-11-09T23:42:54.8371090Z          let target_hex = format!("{:064x}", template.target);
2025-11-09T23:42:54.8371200Z -        
2025-11-09T23:42:54.8371310Z +
2025-11-09T23:42:54.8371474Z          // Convert bits to hex (8 characters)
2025-11-09T23:42:54.8371710Z          let bits_hex = format!("{:08x}", template.header.bits);
2025-11-09T23:42:54.8371820Z -        
2025-11-09T23:42:54.8371929Z +
2025-11-09T23:42:54.8372099Z          // Convert transactions to JSON array
2025-11-09T23:42:54.8372360Z -        let transactions_json: Vec<Value> = template.transactions
2025-11-09T23:42:54.8372560Z +        let transactions_json: Vec<Value> = template
2025-11-09T23:42:54.8372694Z +            .transactions
2025-11-09T23:42:54.8372901Z              .iter()
2025-11-09T23:42:54.8373127Z              .map(|tx| self.transaction_to_json(tx))
2025-11-09T23:42:54.8373309Z              .collect();
2025-11-09T23:42:54.8373782Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:196:
2025-11-09T23:42:54.8373899Z -        
2025-11-09T23:42:54.8374005Z +
2025-11-09T23:42:54.8374178Z          // Calculate coinbase value (subsidy + fees)
2025-11-09T23:42:54.8374632Z          let coinbase_value = self.calculate_coinbase_value(template, height);
2025-11-09T23:42:54.8374737Z -        
2025-11-09T23:42:54.8374831Z +
2025-11-09T23:42:54.8374978Z          // Get active rules (BIP 9 feature flags)
2025-11-09T23:42:54.8375131Z          let rules = self.get_active_rules(height);
2025-11-09T23:42:54.8375489Z -        
2025-11-09T23:42:54.8375589Z +
2025-11-09T23:42:54.8375738Z          // Get minimum time (median time + 1)
2025-11-09T23:42:54.8376703Z          let min_time = self.get_min_time(height);
2025-11-09T23:42:54.8376812Z -        
2025-11-09T23:42:54.8376919Z +
2025-11-09T23:42:54.8377030Z          Ok(json!({
2025-11-09T23:42:54.8377182Z              "capabilities": ["proposal"],
2025-11-09T23:42:54.8377363Z              "version": template.header.version as i32,
2025-11-09T23:42:54.8377803Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:228:
2025-11-09T23:42:54.8377949Z              "height": template.height
2025-11-09T23:42:54.8378054Z          }))
2025-11-09T23:42:54.8378162Z      }
2025-11-09T23:42:54.8378262Z -    
2025-11-09T23:42:54.8378361Z +
2025-11-09T23:42:54.8378547Z      // Helper methods - access chainstate and mempool
2025-11-09T23:42:54.8378666Z -    
2025-11-09T23:42:54.8378777Z +
2025-11-09T23:42:54.8379039Z      fn get_current_height(&self) -> RpcResult<Option<Natural>> {
2025-11-09T23:42:54.8379228Z          if let Some(ref storage) = self.storage {
2025-11-09T23:42:54.8379387Z -            storage.chain().get_height()
2025-11-09T23:42:54.8379501Z +            storage
2025-11-09T23:42:54.8379624Z +                .chain()
2025-11-09T23:42:54.8379752Z +                .get_height()
2025-11-09T23:42:54.8380324Z                  .map_err(|e| RpcError::internal_error(format!("Failed to get height: {}", e)))
2025-11-09T23:42:54.8380433Z          } else {
2025-11-09T23:42:54.8380543Z              Ok(None)
2025-11-09T23:42:54.8380960Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:240:
2025-11-09T23:42:54.8381066Z          }
2025-11-09T23:42:54.8381172Z      }
2025-11-09T23:42:54.8381269Z -    
2025-11-09T23:42:54.8381364Z +
2025-11-09T23:42:54.8381597Z      fn get_tip_header(&self) -> RpcResult<Option<BlockHeader>> {
2025-11-09T23:42:54.8381757Z          if let Some(ref storage) = self.storage {
2025-11-09T23:42:54.8381916Z -            storage.chain().get_tip_header()
2025-11-09T23:42:54.8382022Z +            storage
2025-11-09T23:42:54.8382140Z +                .chain()
2025-11-09T23:42:54.8382265Z +                .get_tip_header()
2025-11-09T23:42:54.8382610Z                  .map_err(|e| RpcError::internal_error(format!("Failed to get tip header: {}", e)))
2025-11-09T23:42:54.8382714Z          } else {
2025-11-09T23:42:54.8382835Z              Ok(None)
2025-11-09T23:42:54.8383274Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:249:
2025-11-09T23:42:54.8383382Z          }
2025-11-09T23:42:54.8383491Z      }
2025-11-09T23:42:54.8383590Z -    
2025-11-09T23:42:54.8383687Z +
2025-11-09T23:42:54.8383967Z      fn get_headers_for_difficulty(&self) -> RpcResult<Vec<BlockHeader>> {
2025-11-09T23:42:54.8384139Z          if let Some(ref storage) = self.storage {
2025-11-09T23:42:54.8384524Z              // Get last 2016 headers for difficulty adjustment
2025-11-09T23:42:54.8384943Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:255:
2025-11-09T23:42:54.8385328Z              // For now, return just the tip (full implementation would get last 2016)
2025-11-09T23:42:54.8385536Z -            if let Some(tip) = storage.chain().get_tip_header()
2025-11-09T23:42:54.8385665Z +            if let Some(tip) = storage
2025-11-09T23:42:54.8385794Z +                .chain()
2025-11-09T23:42:54.8385917Z +                .get_tip_header()
2025-11-09T23:42:54.8386234Z                  .map_err(|e| RpcError::internal_error(format!("Failed to get tip: {}", e)))?
2025-11-09T23:42:54.8386336Z              {
2025-11-09T23:42:54.8386474Z                  Ok(vec![tip])
2025-11-09T23:42:54.8386897Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:264:
2025-11-09T23:42:54.8387012Z              Ok(vec![])
2025-11-09T23:42:54.8387131Z          }
2025-11-09T23:42:54.8387244Z      }
2025-11-09T23:42:54.8387357Z -    
2025-11-09T23:42:54.8387731Z +
2025-11-09T23:42:54.8388058Z      fn get_mempool_transactions(&self) -> RpcResult<Vec<Transaction>> {
2025-11-09T23:42:54.8388309Z          if let Some(ref mempool) = self.mempool {
2025-11-09T23:42:54.8388483Z              // Get UTXO set for fee calculation
2025-11-09T23:42:54.8388930Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:271:
2025-11-09T23:42:54.8389108Z              let utxo_set = self.get_utxo_set()?;
2025-11-09T23:42:54.8389217Z -            
2025-11-09T23:42:54.8389330Z +
2025-11-09T23:42:54.8389703Z              // Get prioritized transactions (limit to reasonable number for block template)
2025-11-09T23:42:54.8389842Z              let limit = 1000;
2025-11-09T23:42:54.8390111Z              Ok(mempool.get_prioritized_transactions(limit, &utxo_set))
2025-11-09T23:42:54.8390578Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:277:
2025-11-09T23:42:54.8390703Z              Ok(vec![])
2025-11-09T23:42:54.8390826Z          }
2025-11-09T23:42:54.8390950Z      }
2025-11-09T23:42:54.8391060Z -    
2025-11-09T23:42:54.8391166Z +
2025-11-09T23:42:54.8391413Z      /// Calculate difficulty from bits (compact target format)
2025-11-09T23:42:54.8391696Z      /// Uses the same logic as BlockchainRpc::calculate_difficulty
2025-11-09T23:42:54.8391882Z      fn calculate_difficulty(bits: u64) -> f64 {
2025-11-09T23:42:54.8394258Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:284:
2025-11-09T23:42:54.8394633Z          // Difficulty = MAX_TARGET / target
2025-11-09T23:42:54.8395128Z          // MAX_TARGET for Bitcoin mainnet is 0x00000000FFFF0000000000000000000000000000000000000000000000000000
2025-11-09T23:42:54.8395420Z          // For display purposes, we normalize to genesis difficulty = 1.0
2025-11-09T23:42:54.8395881Z -        const MAX_TARGET: u128 = 0x00000000FFFF0000000000000000000000000000000000000000000000000000u128;
2025-11-09T23:42:54.8396004Z -        
2025-11-09T23:42:54.8396166Z +        const MAX_TARGET: u128 =
2025-11-09T23:42:54.8396499Z +            0x00000000FFFF0000000000000000000000000000000000000000000000000000u128;
2025-11-09T23:42:54.8396624Z +
2025-11-09T23:42:54.8396866Z          // Simplified difficulty calculation using bits directly
2025-11-09T23:42:54.8397143Z          // For display purposes, use a simple approximation based on bits
2025-11-09T23:42:54.8397324Z          let mantissa = (bits & 0x00ffffff) as f64;
2025-11-09T23:42:54.8397832Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:295:
2025-11-09T23:42:54.8398008Z          let max_mantissa = 0x00ffff00 as f64;
2025-11-09T23:42:54.8398167Z          (max_mantissa / mantissa).max(1.0)
2025-11-09T23:42:54.8398279Z      }
2025-11-09T23:42:54.8398388Z -    
2025-11-09T23:42:54.8398495Z +
2025-11-09T23:42:54.8398739Z      /// Calculate network hashrate from recent block timestamps
2025-11-09T23:42:54.8398984Z      /// Estimates hashrate based on the time between recent blocks
2025-11-09T23:42:54.8399370Z      fn calculate_network_hashrate(&self, storage: &Storage) -> Result<f64, anyhow::Error> {
2025-11-09T23:42:54.8399804Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:302:
2025-11-09T23:42:54.8399943Z          // Get tip height
2025-11-09T23:42:54.8400131Z -        let tip_height = storage.chain().get_height()?
2025-11-09T23:42:54.8400284Z +        let tip_height = storage
2025-11-09T23:42:54.8400394Z +            .chain()
2025-11-09T23:42:54.8400509Z +            .get_height()?
2025-11-09T23:42:54.8400739Z              .ok_or_else(|| anyhow::anyhow!("Chain not initialized"))?;
2025-11-09T23:42:54.8400849Z -        
2025-11-09T23:42:54.8400949Z +
2025-11-09T23:42:54.8401123Z          // Need at least 2 blocks to calculate hashrate
2025-11-09T23:42:54.8401254Z          if tip_height < 1 {
2025-11-09T23:42:54.8401383Z              return Ok(0.0);
2025-11-09T23:42:54.8401823Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:309:
2025-11-09T23:42:54.8402196Z          }
2025-11-09T23:42:54.8402319Z -        
2025-11-09T23:42:54.8402434Z +
2025-11-09T23:42:54.8402684Z          // Get last 144 blocks (approximately 1 day at 10 min/block)
2025-11-09T23:42:54.8402859Z          // Or use fewer blocks if chain is shorter
2025-11-09T23:42:54.8403036Z          let num_blocks = (tip_height + 1).min(144);
2025-11-09T23:42:54.8403490Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:314:
2025-11-09T23:42:54.8403773Z          let start_height = tip_height.saturating_sub(num_blocks - 1);
2025-11-09T23:42:54.8403895Z -        
2025-11-09T23:42:54.8406223Z +
2025-11-09T23:42:54.8406407Z          // Get timestamps from blocks
2025-11-09T23:42:54.8406589Z          let mut timestamps = Vec::new();
2025-11-09T23:42:54.8406778Z          for height in start_height..=tip_height {
2025-11-09T23:42:54.8408536Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:322:
2025-11-09T23:42:54.8408700Z                  }
2025-11-09T23:42:54.8408815Z              }
2025-11-09T23:42:54.8408932Z          }
2025-11-09T23:42:54.8409045Z -        
2025-11-09T23:42:54.8409164Z +
2025-11-09T23:42:54.8409388Z          if timestamps.len() < 2 {
2025-11-09T23:42:54.8409528Z              return Ok(0.0);
2025-11-09T23:42:54.8409645Z          }
2025-11-09T23:42:54.8410323Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:329:
2025-11-09T23:42:54.8410452Z -        
2025-11-09T23:42:54.8410561Z +
2025-11-09T23:42:54.8410749Z          // Calculate average time between blocks
2025-11-09T23:42:54.8410912Z          let first_timestamp = timestamps[0].1;
2025-11-09T23:42:54.8411140Z          let last_timestamp = timestamps[timestamps.len() - 1].1;
2025-11-09T23:42:54.8411550Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:333:
2025-11-09T23:42:54.8411820Z          let time_span = last_timestamp.saturating_sub(first_timestamp);
2025-11-09T23:42:54.8412018Z          let num_intervals = timestamps.len() - 1;
2025-11-09T23:42:54.8412133Z -        
2025-11-09T23:42:54.8412252Z +
2025-11-09T23:42:54.8412428Z          if time_span == 0 || num_intervals == 0 {
2025-11-09T23:42:54.8412563Z              return Ok(0.0);
2025-11-09T23:42:54.8412688Z          }
2025-11-09T23:42:54.8413154Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:339:
2025-11-09T23:42:54.8413275Z -        
2025-11-09T23:42:54.8413384Z +
2025-11-09T23:42:54.8413669Z          let avg_time_per_block = time_span as f64 / num_intervals as f64;
2025-11-09T23:42:54.8416097Z -        
2025-11-09T23:42:54.8416220Z +
2025-11-09T23:42:54.8416391Z          // Get difficulty from tip block
2025-11-09T23:42:54.8416669Z -        let tip_hash = storage.blocks().get_hash_by_height(tip_height)?
2025-11-09T23:42:54.8416812Z +        let tip_hash = storage
2025-11-09T23:42:54.8416933Z +            .blocks()
2025-11-09T23:42:54.8417187Z +            .get_hash_by_height(tip_height)?
2025-11-09T23:42:54.8417440Z              .ok_or_else(|| anyhow::anyhow!("Tip block not found"))?;
2025-11-09T23:42:54.8417675Z -        let tip_block = storage.blocks().get_block(&tip_hash)?
2025-11-09T23:42:54.8417825Z +        let tip_block = storage
2025-11-09T23:42:54.8417940Z +            .blocks()
2025-11-09T23:42:54.8418091Z +            .get_block(&tip_hash)?
2025-11-09T23:42:54.8418321Z              .ok_or_else(|| anyhow::anyhow!("Tip block not found"))?;
2025-11-09T23:42:54.8418634Z          let difficulty = Self::calculate_difficulty(tip_block.header.bits);
2025-11-09T23:42:54.8418752Z -        
2025-11-09T23:42:54.8418858Z +
2025-11-09T23:42:54.8419131Z          // Calculate hashrate: difficulty * 2^32 / avg_time_per_block
2025-11-09T23:42:54.8419388Z          // This estimates the network hashrate in hashes per second
2025-11-09T23:42:54.8419734Z          // 2^32 is the number of hashes needed on average to find a block at difficulty 1.0
2025-11-09T23:42:54.8420450Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:352:
2025-11-09T23:42:54.8420686Z          const HASHES_PER_DIFFICULTY: f64 = 4294967296.0; // 2^32
2025-11-09T23:42:54.8421019Z          let hashrate = (difficulty * HASHES_PER_DIFFICULTY) / avg_time_per_block;
2025-11-09T23:42:54.8421134Z -        
2025-11-09T23:42:54.8421247Z +
2025-11-09T23:42:54.8421380Z          Ok(hashrate)
2025-11-09T23:42:54.8421495Z      }
2025-11-09T23:42:54.8421614Z -    
2025-11-09T23:42:54.8421724Z +
2025-11-09T23:42:54.8421911Z      fn get_utxo_set(&self) -> RpcResult<UtxoSet> {
2025-11-09T23:42:54.8422095Z          if let Some(ref storage) = self.storage {
2025-11-09T23:42:54.8422248Z              // Get UTXO set from storage
2025-11-09T23:42:54.8422705Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:361:
2025-11-09T23:42:54.8422872Z -            storage.utxos().get_all_utxos()
2025-11-09T23:42:54.8422999Z +            storage
2025-11-09T23:42:54.8423129Z +                .utxos()
2025-11-09T23:42:54.8423258Z +                .get_all_utxos()
2025-11-09T23:42:54.8423642Z                  .map_err(|e| RpcError::internal_error(format!("Failed to get UTXO set: {}", e)))
2025-11-09T23:42:54.8423762Z          } else {
2025-11-09T23:42:54.8423903Z              Ok(UtxoSet::new())
2025-11-09T23:42:54.8424707Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:365:
2025-11-09T23:42:54.8424834Z          }
2025-11-09T23:42:54.8424939Z      }
2025-11-09T23:42:54.8425038Z -    
2025-11-09T23:42:54.8425141Z +
2025-11-09T23:42:54.8425479Z      fn extract_coinbase_script(&self, params: &Value) -> Option<ByteString> {
2025-11-09T23:42:54.8425704Z          // Extract coinbase script from params if provided
2025-11-09T23:42:54.8425914Z          if let Some(template_request) = params.get(0) {
2025-11-09T23:42:54.8428152Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:379:
2025-11-09T23:42:54.8428310Z          // Default: empty script
2025-11-09T23:42:54.8428428Z          Some(vec![])
2025-11-09T23:42:54.8428537Z      }
2025-11-09T23:42:54.8428635Z -    
2025-11-09T23:42:54.8428736Z +
2025-11-09T23:42:54.8429050Z      fn extract_coinbase_address(&self, params: &Value) -> Option<ByteString> {
2025-11-09T23:42:54.8429260Z          // Extract coinbase address from params if provided
2025-11-09T23:42:54.8429449Z          if let Some(template_request) = params.get(0) {
2025-11-09T23:42:54.8429899Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:393:
2025-11-09T23:42:54.8430037Z          // Default: empty
2025-11-09T23:42:54.8430148Z          Some(vec![])
2025-11-09T23:42:54.8430252Z      }
2025-11-09T23:42:54.8430360Z -    
2025-11-09T23:42:54.8430459Z +
2025-11-09T23:42:54.8430688Z      fn transaction_to_json(&self, tx: &Transaction) -> Value {
2025-11-09T23:42:54.8431294Z          // Convert transaction to JSON-RPC format
2025-11-09T23:42:54.8431457Z          let tx_bytes = serialize_transaction(tx);
2025-11-09T23:42:54.8431896Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:401:
2025-11-09T23:42:54.8432075Z          let fee = self.calculate_transaction_fee(tx);
2025-11-09T23:42:54.8432232Z          let sigops = self.count_sigops(tx);
2025-11-09T23:42:54.8432402Z          let weight = self.calculate_weight(tx);
2025-11-09T23:42:54.8432521Z -        
2025-11-09T23:42:54.8432638Z +
2025-11-09T23:42:54.8432762Z          json!({
2025-11-09T23:42:54.8432930Z              "data": hex::encode(&tx_bytes),
2025-11-09T23:42:54.8433084Z              "txid": hex::encode(tx_hash),
2025-11-09T23:42:54.8433542Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:410:
2025-11-09T23:42:54.8433672Z              "weight": weight,
2025-11-09T23:42:54.8433782Z          })
2025-11-09T23:42:54.8433901Z      }
2025-11-09T23:42:54.8434008Z -    
2025-11-09T23:42:54.8434118Z +
2025-11-09T23:42:54.8434525Z      fn calculate_tx_hash(&self, tx_bytes: &[u8]) -> [u8; 32] {
2025-11-09T23:42:54.8435084Z          // Transaction hash is double SHA256 of transaction bytes
2025-11-09T23:42:54.8435253Z          let hash1 = Sha256::digest(tx_bytes);
2025-11-09T23:42:54.8435696Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:417:
2025-11-09T23:42:54.8435875Z          let hash2 = Sha256::digest(hash1);
2025-11-09T23:42:54.8435989Z -        
2025-11-09T23:42:54.8436100Z +
2025-11-09T23:42:54.8436250Z          let mut result = [0u8; 32];
2025-11-09T23:42:54.8436406Z          result.copy_from_slice(&hash2);
2025-11-09T23:42:54.8436525Z          result
2025-11-09T23:42:54.8436965Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:422:
2025-11-09T23:42:54.8437084Z      }
2025-11-09T23:42:54.8437192Z -    
2025-11-09T23:42:54.8437302Z +
2025-11-09T23:42:54.8437588Z      fn calculate_transaction_fee(&self, tx: &Transaction) -> u64 {
2025-11-09T23:42:54.8437819Z          // Use MempoolManager's fee calculation if available
2025-11-09T23:42:54.8438000Z          if let Some(ref mempool) = self.mempool {
2025-11-09T23:42:54.8438452Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:447:
2025-11-09T23:42:54.8438570Z              0
2025-11-09T23:42:54.8438682Z          }
2025-11-09T23:42:54.8438794Z      }
2025-11-09T23:42:54.8439127Z -    
2025-11-09T23:42:54.8439248Z +
2025-11-09T23:42:54.8439451Z      fn count_sigops(&self, tx: &Transaction) -> u32 {
2025-11-09T23:42:54.8439605Z          // Use consensus layer sigop counting
2025-11-09T23:42:54.8439756Z          #[cfg(feature = "sigop")]
2025-11-09T23:42:54.8440198Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:456:
2025-11-09T23:42:54.8440479Z              // Convert protocol transaction to consensus transaction format
2025-11-09T23:42:54.8440631Z              let consensus_tx = ConsensusTx {
2025-11-09T23:42:54.8440767Z                  version: tx.version,
2025-11-09T23:42:54.8441080Z -                inputs: tx.inputs.iter().map(|inp| bllvm_protocol::TransactionInput {
2025-11-09T23:42:54.8441279Z -                    prevout: bllvm_protocol::OutPoint {
2025-11-09T23:42:54.8441441Z -                        hash: inp.prevout.hash,
2025-11-09T23:42:54.8441608Z -                        index: inp.prevout.index,
2025-11-09T23:42:54.8441739Z -                    },
2025-11-09T23:42:54.8441920Z -                    script_sig: inp.script_sig.clone(),
2025-11-09T23:42:54.8442075Z -                    sequence: inp.sequence,
2025-11-09T23:42:54.8442207Z -                }).collect(),
2025-11-09T23:42:54.8442570Z -                outputs: tx.outputs.iter().map(|out| bllvm_protocol::TransactionOutput {
2025-11-09T23:42:54.8442714Z -                    value: out.value,
2025-11-09T23:42:54.8442906Z -                    script_pubkey: out.script_pubkey.clone(),
2025-11-09T23:42:54.8443031Z -                }).collect(),
2025-11-09T23:42:54.8443161Z +                inputs: tx
2025-11-09T23:42:54.8443291Z +                    .inputs
2025-11-09T23:42:54.8443408Z +                    .iter()
2025-11-09T23:42:54.8443630Z +                    .map(|inp| bllvm_protocol::TransactionInput {
2025-11-09T23:42:54.8443818Z +                        prevout: bllvm_protocol::OutPoint {
2025-11-09T23:42:54.8443989Z +                            hash: inp.prevout.hash,
2025-11-09T23:42:54.8444172Z +                            index: inp.prevout.index,
2025-11-09T23:42:54.8444452Z +                        },
2025-11-09T23:42:54.8446453Z +                        script_sig: inp.script_sig.clone(),
2025-11-09T23:42:54.8446609Z +                        sequence: inp.sequence,
2025-11-09T23:42:54.8446733Z +                    })
2025-11-09T23:42:54.8446863Z +                    .collect(),
2025-11-09T23:42:54.8446991Z +                outputs: tx
2025-11-09T23:42:54.8447126Z +                    .outputs
2025-11-09T23:42:54.8447247Z +                    .iter()
2025-11-09T23:42:54.8447696Z +                    .map(|out| bllvm_protocol::TransactionOutput {
2025-11-09T23:42:54.8447825Z +                        value: out.value,
2025-11-09T23:42:54.8448007Z +                        script_pubkey: out.script_pubkey.clone(),
2025-11-09T23:42:54.8448119Z +                    })
2025-11-09T23:42:54.8448235Z +                    .collect(),
2025-11-09T23:42:54.8448379Z                  lock_time: tx.lock_time,
2025-11-09T23:42:54.8448483Z              };
2025-11-09T23:42:54.8448687Z              use bllvm_protocol::sigop::get_legacy_sigop_count;
2025-11-09T23:42:54.8449207Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:480:
2025-11-09T23:42:54.8449370Z              for output in &tx.outputs {
2025-11-09T23:42:54.8449549Z                  for &byte in &output.script_pubkey {
2025-11-09T23:42:54.8449680Z                      match byte {
2025-11-09T23:42:54.8449856Z -                        0xac => count += 1, // OP_CHECKSIG
2025-11-09T23:42:54.8450048Z -                        0xad => count += 1, // OP_CHECKSIGVERIFY
2025-11-09T23:42:54.8450222Z -                        0xae => count += 1, // OP_CHECKMULTISIG
2025-11-09T23:42:54.8450388Z +                        0xac => count += 1,  // OP_CHECKSIG
2025-11-09T23:42:54.8450565Z +                        0xad => count += 1,  // OP_CHECKSIGVERIFY
2025-11-09T23:42:54.8450944Z +                        0xae => count += 1,  // OP_CHECKMULTISIG
2025-11-09T23:42:54.8451176Z                          0xaf => count += 20, // OP_CHECKMULTISIGVERIFY
2025-11-09T23:42:54.8451304Z                          _ => {}
2025-11-09T23:42:54.8451420Z                      }
2025-11-09T23:42:54.8451869Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:491:
2025-11-09T23:42:54.8451994Z              count
2025-11-09T23:42:54.8452104Z          }
2025-11-09T23:42:54.8452211Z      }
2025-11-09T23:42:54.8452326Z -    
2025-11-09T23:42:54.8452433Z +
2025-11-09T23:42:54.8452664Z      fn calculate_weight(&self, tx: &Transaction) -> u64 {
2025-11-09T23:42:54.8452962Z          // Transaction weight = (base_size * 3) + total_size (for SegWit)
2025-11-09T23:42:54.8453193Z          // For now, return base size * 4 (non-SegWit transaction)
2025-11-09T23:42:54.8453649Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:498:
2025-11-09T23:42:54.8453890Z          let base_size = serialize_transaction(tx).len() as u64;
2025-11-09T23:42:54.8454021Z          base_size * 4
2025-11-09T23:42:54.8454127Z      }
2025-11-09T23:42:54.8454233Z -    
2025-11-09T23:42:54.8454518Z +
2025-11-09T23:42:54.8454935Z      fn calculate_coinbase_value(&self, template: &BlockTemplate, _height: Natural) -> u64 {
2025-11-09T23:42:54.8455203Z          // Use consensus-proof's get_block_subsidy (formally verified)
2025-11-09T23:42:54.8455526Z          let subsidy = self.consensus.get_block_subsidy(template.height) as u64;
2025-11-09T23:42:54.8455960Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:505:
2025-11-09T23:42:54.8456079Z -        
2025-11-09T23:42:54.8456182Z +
2025-11-09T23:42:54.8456352Z          // Calculate total fees from transactions
2025-11-09T23:42:54.8456515Z -        let fees: u64 = template.transactions
2025-11-09T23:42:54.8456644Z +        let fees: u64 = template
2025-11-09T23:42:54.8456766Z +            .transactions
2025-11-09T23:42:54.8456890Z              .iter()
2025-11-09T23:42:54.8457078Z              .map(|tx| self.calculate_transaction_fee(tx))
2025-11-09T23:42:54.8457185Z              .sum();
2025-11-09T23:42:54.8457604Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:511:
2025-11-09T23:42:54.8457710Z -        
2025-11-09T23:42:54.8457813Z +
2025-11-09T23:42:54.8457930Z          subsidy + fees
2025-11-09T23:42:54.8458042Z      }
2025-11-09T23:42:54.8458147Z -    
2025-11-09T23:42:54.8458248Z +
2025-11-09T23:42:54.8458490Z      fn get_active_rules(&self, height: Natural) -> Vec<String> {
2025-11-09T23:42:54.8458877Z          // Determine active BIP 9 rules based on height
2025-11-09T23:42:54.8459167Z          let mut rules = vec!["csv".to_string()]; // CSV always active after height
2025-11-09T23:42:54.8459597Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:518:
2025-11-09T23:42:54.8459715Z -        
2025-11-09T23:42:54.8459924Z -        if height >= 481824 { // SegWit activation (mainnet)
2025-11-09T23:42:54.8460042Z +
2025-11-09T23:42:54.8460197Z +        if height >= 481824 {
2025-11-09T23:42:54.8460370Z +            // SegWit activation (mainnet)
2025-11-09T23:42:54.8460546Z              rules.push("segwit".to_string());
2025-11-09T23:42:54.8460656Z          }
2025-11-09T23:42:54.8460767Z -        
2025-11-09T23:42:54.8460968Z -        if height >= 709632 { // Taproot activation (mainnet)
2025-11-09T23:42:54.8461070Z +
2025-11-09T23:42:54.8461201Z +        if height >= 709632 {
2025-11-09T23:42:54.8461353Z +            // Taproot activation (mainnet)
2025-11-09T23:42:54.8461518Z              rules.push("taproot".to_string());
2025-11-09T23:42:54.8461625Z          }
2025-11-09T23:42:54.8461734Z -        
2025-11-09T23:42:54.8461836Z +
2025-11-09T23:42:54.8461944Z          rules
2025-11-09T23:42:54.8462056Z      }
2025-11-09T23:42:54.8462161Z -    
2025-11-09T23:42:54.8462265Z +
2025-11-09T23:42:54.8462469Z      fn get_min_time(&self, _height: Natural) -> Natural {
2025-11-09T23:42:54.8462856Z          // Get minimum time (median time of last 11 blocks + 1)
2025-11-09T23:42:54.8463005Z          // For now, return current time
2025-11-09T23:42:54.8463428Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:535:
2025-11-09T23:42:54.8463550Z              .unwrap()
2025-11-09T23:42:54.8463678Z              .as_secs() as Natural
2025-11-09T23:42:54.8463783Z      }
2025-11-09T23:42:54.8463884Z -    
2025-11-09T23:42:54.8463994Z +
2025-11-09T23:42:54.8464133Z      /// Submit a block to the network
2025-11-09T23:42:54.8464242Z -    /// 
2025-11-09T23:42:54.8464530Z +    ///
2025-11-09T23:42:54.8464676Z      /// Params: ["hexdata", "dummy"]
2025-11-09T23:42:54.8464966Z      pub async fn submit_block(&self, params: &Value) -> RpcResult<Value> {
2025-11-09T23:42:54.8465103Z          debug!("RPC: submitblock");
2025-11-09T23:42:54.8465529Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:544:
2025-11-09T23:42:54.8465641Z -        
2025-11-09T23:42:54.8465780Z -        let hex_data = params.get(0)
2025-11-09T23:42:54.8465888Z +
2025-11-09T23:42:54.8466017Z +        let hex_data = params
2025-11-09T23:42:54.8466127Z +            .get(0)
2025-11-09T23:42:54.8466264Z              .and_then(|p| p.as_str())
2025-11-09T23:42:54.8466582Z              .ok_or_else(|| RpcError::invalid_params("Missing hexdata parameter"))?;
2025-11-09T23:42:54.8466688Z -        
2025-11-09T23:42:54.8466790Z +
2025-11-09T23:42:54.8466910Z          // Decode hex
2025-11-09T23:42:54.8467076Z          let block_bytes = hex::decode(hex_data)
2025-11-09T23:42:54.8467404Z              .map_err(|e| RpcError::invalid_params(format!("Invalid hex data: {}", e)))?;
2025-11-09T23:42:54.8467824Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:552:
2025-11-09T23:42:54.8467929Z -        
2025-11-09T23:42:54.8468030Z +
2025-11-09T23:42:54.8468158Z          // Deserialize block
2025-11-09T23:42:54.8468464Z          let (block, witnesses) = deserialize_block_with_witnesses(&block_bytes)
2025-11-09T23:42:54.8468844Z              .map_err(|e| RpcError::invalid_params(format!("Failed to deserialize block: {}", e)))?;
2025-11-09T23:42:54.8469258Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:556:
2025-11-09T23:42:54.8469371Z -        
2025-11-09T23:42:54.8469473Z +
2025-11-09T23:42:54.8469609Z          // Get current chain state
2025-11-09T23:42:54.8469774Z -        let height = self.get_current_height()?
2025-11-09T23:42:54.8469898Z +        let height = self
2025-11-09T23:42:54.8470025Z +            .get_current_height()?
2025-11-09T23:42:54.8470473Z              .ok_or_else(|| RpcError::internal_error("Chain not initialized"))?;
2025-11-09T23:42:54.8470629Z          let utxo_set = self.get_utxo_set()?;
2025-11-09T23:42:54.8470733Z -        
2025-11-09T23:42:54.8470836Z +
2025-11-09T23:42:54.8470998Z          // Validate block using consensus layer
2025-11-09T23:42:54.8472246Z          // Note: This validates consensus rules, but doesn't check if block extends chain
2025-11-09T23:42:54.8472434Z          // In production, would also check:
2025-11-09T23:42:54.8472885Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:572:
2025-11-09T23:42:54.8473069Z                  debug!("Block submitted successfully");
2025-11-09T23:42:54.8473200Z                  Ok(json!(null))
2025-11-09T23:42:54.8473315Z              }
2025-11-09T23:42:54.8473528Z -            Ok((ValidationResult::Invalid(reason), _)) => {
2025-11-09T23:42:54.8473836Z -                Err(RpcError::invalid_params(format!("Invalid block: {}", reason)))
2025-11-09T23:42:54.8473956Z -            }
2025-11-09T23:42:54.8474084Z -            Err(e) => {
2025-11-09T23:42:54.8474551Z -                Err(RpcError::internal_error(format!("Validation error: {}", e)))
2025-11-09T23:42:54.8474667Z -            }
2025-11-09T23:42:54.8475247Z +            Ok((ValidationResult::Invalid(reason), _)) => Err(RpcError::invalid_params(format!(
2025-11-09T23:42:54.8475404Z +                "Invalid block: {}",
2025-11-09T23:42:54.8475515Z +                reason
2025-11-09T23:42:54.8475621Z +            ))),
2025-11-09T23:42:54.8475944Z +            Err(e) => Err(RpcError::internal_error(format!("Validation error: {}", e))),
2025-11-09T23:42:54.8476056Z          }
2025-11-09T23:42:54.8476160Z      }
2025-11-09T23:42:54.8476261Z -    
2025-11-09T23:42:54.8476375Z +
2025-11-09T23:42:54.8476515Z      /// Estimate smart fee rate
2025-11-09T23:42:54.8476626Z -    /// 
2025-11-09T23:42:54.8476746Z +    ///
2025-11-09T23:42:54.8477214Z      /// Params: [conf_target (optional, default: 6), estimate_mode (optional, default: "conservative")]
2025-11-09T23:42:54.8477568Z      pub async fn estimate_smart_fee(&self, params: &Value) -> RpcResult<Value> {
2025-11-09T23:42:54.8477745Z          debug!("RPC: estimatesmartfee");
2025-11-09T23:42:54.8478211Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:589:
2025-11-09T23:42:54.8478330Z -        
2025-11-09T23:42:54.8478494Z -        let conf_target = params.get(0)
2025-11-09T23:42:54.8478664Z -            .and_then(|p| p.as_u64())
2025-11-09T23:42:54.8478800Z -            .unwrap_or(6);
2025-11-09T23:42:54.8478914Z -        
2025-11-09T23:42:54.8479086Z -        let estimate_mode = params.get(1)
2025-11-09T23:42:54.8479201Z +
2025-11-09T23:42:54.8479513Z +        let conf_target = params.get(0).and_then(|p| p.as_u64()).unwrap_or(6);
2025-11-09T23:42:54.8479626Z +
2025-11-09T23:42:54.8479785Z +        let estimate_mode = params
2025-11-09T23:42:54.8479908Z +            .get(1)
2025-11-09T23:42:54.8480053Z              .and_then(|p| p.as_str())
2025-11-09T23:42:54.8480214Z              .unwrap_or("conservative");
2025-11-09T23:42:54.8480326Z -        
2025-11-09T23:42:54.8480438Z +
2025-11-09T23:42:54.8480582Z          // Validate estimate_mode
2025-11-09T23:42:54.8480721Z          match estimate_mode {
2025-11-09T23:42:54.8480927Z              "unset" | "economical" | "conservative" => {}
2025-11-09T23:42:54.8481396Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:601:
2025-11-09T23:42:54.8482119Z -            _ => return Err(RpcError::invalid_params(format!("Invalid estimate_mode: {}. Must be 'unset', 'economical', or 'conservative'", estimate_mode)))
2025-11-09T23:42:54.8482237Z +            _ => {
2025-11-09T23:42:54.8482552Z +                return Err(RpcError::invalid_params(format!(
2025-11-09T23:42:54.8482922Z +                    "Invalid estimate_mode: {}. Must be 'unset', 'economical', or 'conservative'",
2025-11-09T23:42:54.8483365Z +                    estimate_mode
2025-11-09T23:42:54.8483484Z +                )))
2025-11-09T23:42:54.8483602Z +            }
2025-11-09T23:42:54.8483727Z          }
2025-11-09T23:42:54.8483839Z -        
2025-11-09T23:42:54.8483946Z +
2025-11-09T23:42:54.8484223Z          // Get mempool transactions and UTXO set for fee calculation
2025-11-09T23:42:54.8484777Z          let mempool_txs = if let Some(ref mempool) = self.mempool {
2025-11-09T23:42:54.8484958Z              let utxo_set = self.get_utxo_set()?;
2025-11-09T23:42:54.8485426Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:608:
2025-11-09T23:42:54.8485558Z          } else {
2025-11-09T23:42:54.8485742Z              vec![]
2025-11-09T23:42:54.8485859Z          };
2025-11-09T23:42:54.8485981Z -        
2025-11-09T23:42:54.8486092Z +
2025-11-09T23:42:54.8486286Z          // Calculate fee rate based on mempool state
2025-11-09T23:42:54.8486536Z          // Simple algorithm: use median fee rate of top transactions
2025-11-09T23:42:54.8486737Z          let fee_rate = if !mempool_txs.is_empty() {
2025-11-09T23:42:54.8487190Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:615:
2025-11-09T23:42:54.8487360Z              let utxo_set = self.get_utxo_set()?;
2025-11-09T23:42:54.8487547Z              let mut fee_rates = Vec::new();
2025-11-09T23:42:54.8487895Z -            
2025-11-09T23:42:54.8488028Z +
2025-11-09T23:42:54.8488456Z              // MempoolManager.get_prioritized_transactions() already calculates fees correctly
2025-11-09T23:42:54.8488853Z              // We can extract fee rates from the prioritized list, but for now calculate directly
2025-11-09T23:42:54.8489012Z              for tx in &mempool_txs {
2025-11-09T23:42:54.8489471Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:621:
2025-11-09T23:42:54.8489771Z                  let fee = self.calculate_transaction_fee(tx); // Now uses UTXO set
2025-11-09T23:42:54.8489989Z                  let size = self.calculate_weight(tx) as usize;
2025-11-09T23:42:54.8490111Z -                
2025-11-09T23:42:54.8490228Z +
2025-11-09T23:42:54.8490364Z                  if size > 0 {
2025-11-09T23:42:54.8490522Z                      // Fee rate in BTC per vbyte
2025-11-09T23:42:54.8490852Z                      let rate = (fee as f64) / (size as f64) / 100_000_000.0; // Convert satoshis to BTC
2025-11-09T23:42:54.8491688Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:627:
2025-11-09T23:42:54.8491847Z                      fee_rates.push(rate);
2025-11-09T23:42:54.8491966Z                  }
2025-11-09T23:42:54.8492079Z              }
2025-11-09T23:42:54.8492188Z -            
2025-11-09T23:42:54.8492290Z +
2025-11-09T23:42:54.8492510Z              // Use median fee rate, or minimum if no transactions
2025-11-09T23:42:54.8492654Z              if !fee_rates.is_empty() {
2025-11-09T23:42:54.8493009Z                  fee_rates.sort_by(|a, b| a.partial_cmp(b).unwrap_or(std::cmp::Ordering::Equal));
2025-11-09T23:42:54.8493471Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:640:
2025-11-09T23:42:54.8493680Z              // No mempool transactions - return minimum fee
2025-11-09T23:42:54.8493805Z              0.00001 // 1 sat/vB
2025-11-09T23:42:54.8493920Z          };
2025-11-09T23:42:54.8494037Z -        
2025-11-09T23:42:54.8494152Z +
2025-11-09T23:42:54.8494505Z          // Adjust based on estimate_mode
2025-11-09T23:42:54.8494698Z          let adjusted_rate = match estimate_mode {
2025-11-09T23:42:54.8495049Z -            "economical" => fee_rate * 0.8, // 20% lower for economical
2025-11-09T23:42:54.8495309Z +            "economical" => fee_rate * 0.8,   // 20% lower for economical
2025-11-09T23:42:54.8495593Z              "conservative" => fee_rate * 1.2, // 20% higher for conservative
2025-11-09T23:42:54.8495724Z              _ => fee_rate,
2025-11-09T23:42:54.8495834Z          };
2025-11-09T23:42:54.8496563Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:650:
2025-11-09T23:42:54.8496674Z -        
2025-11-09T23:42:54.8496785Z +
2025-11-09T23:42:54.8496908Z          Ok(json!({
2025-11-09T23:42:54.8497072Z              "feerate": adjusted_rate,
2025-11-09T23:42:54.8497213Z              "blocks": conf_target
2025-11-09T23:42:54.8497660Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:660:
2025-11-09T23:42:54.8498053Z      pub async fn prioritise_transaction(&self, params: &Value) -> RpcResult<Value> {
2025-11-09T23:42:54.8498234Z          debug!("RPC: prioritisetransaction");
2025-11-09T23:42:54.8498342Z  
2025-11-09T23:42:54.8498494Z -        let txid = params.get(0)
2025-11-09T23:42:54.8498628Z +        let txid = params
2025-11-09T23:42:54.8498832Z +            .get(0)
2025-11-09T23:42:54.8498986Z              .and_then(|p| p.as_str())
2025-11-09T23:42:54.8499365Z              .ok_or_else(|| RpcError::invalid_params("Transaction ID required".to_string()))?;
2025-11-09T23:42:54.8499487Z  
2025-11-09T23:42:54.8500011Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:667:
2025-11-09T23:42:54.8500183Z -        let fee_delta = params.get(1)
2025-11-09T23:42:54.8500322Z +        let fee_delta = params
2025-11-09T23:42:54.8500438Z +            .get(1)
2025-11-09T23:42:54.8500801Z              .and_then(|p| p.as_i64())
2025-11-09T23:42:54.8501160Z              .ok_or_else(|| RpcError::invalid_params("Fee delta required".to_string()))?;
2025-11-09T23:42:54.8501272Z  
2025-11-09T23:42:54.8501705Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:671:
2025-11-09T23:42:54.8501882Z          let hash_bytes = hex::decode(txid)
2025-11-09T23:42:54.8502251Z              .map_err(|e| RpcError::invalid_params(format!("Invalid transaction ID: {}", e)))?;
2025-11-09T23:42:54.8502398Z          if hash_bytes.len() != 32 {
2025-11-09T23:42:54.8502810Z -            return Err(RpcError::invalid_params("Transaction ID must be 32 bytes".to_string()));
2025-11-09T23:42:54.8502997Z +            return Err(RpcError::invalid_params(
2025-11-09T23:42:54.8503193Z +                "Transaction ID must be 32 bytes".to_string(),
2025-11-09T23:42:54.8503307Z +            ));
2025-11-09T23:42:54.8503423Z          }
2025-11-09T23:42:54.8503564Z          let mut hash = [0u8; 32];
2025-11-09T23:42:54.8503733Z          hash.copy_from_slice(&hash_bytes);
2025-11-09T23:42:54.8504175Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:681:
2025-11-09T23:42:54.8504543Z              if mempool.get_transaction(&hash).is_some() {
2025-11-09T23:42:54.8504851Z                  // Note: In production, would update transaction priority/fee delta
2025-11-09T23:42:54.8505019Z                  // For now, just return success
2025-11-09T23:42:54.8505347Z -                debug!("Transaction {} prioritized with fee delta: {}", txid, fee_delta);
2025-11-09T23:42:54.8505466Z +                debug!(
2025-11-09T23:42:54.8505695Z +                    "Transaction {} prioritized with fee delta: {}",
2025-11-09T23:42:54.8505825Z +                    txid, fee_delta
2025-11-09T23:42:54.8505934Z +                );
2025-11-09T23:42:54.8506065Z                  Ok(json!(true))
2025-11-09T23:42:54.8506189Z              } else {
2025-11-09T23:42:54.8506368Z -                Err(RpcError::invalid_params(
2025-11-09T23:42:54.8506595Z -                    format!("Transaction {} not found in mempool", txid)
2025-11-09T23:42:54.8506713Z -                ))
2025-11-09T23:42:54.8506890Z +                Err(RpcError::invalid_params(format!(
2025-11-09T23:42:54.8507064Z +                    "Transaction {} not found in mempool",
2025-11-09T23:42:54.8507179Z +                    txid
2025-11-09T23:42:54.8507295Z +                )))
2025-11-09T23:42:54.8507405Z              }
2025-11-09T23:42:54.8507522Z          } else {
2025-11-09T23:42:54.8507859Z -            Err(RpcError::internal_error("Mempool not initialized".to_string()))
2025-11-09T23:42:54.8508276Z +            Err(RpcError::internal_error(
2025-11-09T23:42:54.8508456Z +                "Mempool not initialized".to_string(),
2025-11-09T23:42:54.8508569Z +            ))
2025-11-09T23:42:54.8508688Z          }
2025-11-09T23:42:54.8508797Z      }
2025-11-09T23:42:54.8508900Z  }
2025-11-09T23:42:54.8509366Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mining.rs:696:
2025-11-09T23:42:54.8509477Z  
2025-11-09T23:42:54.8509616Z  impl Default for MiningRpc {
2025-11-09T23:42:54.8511883Z -    fn default() -> Self { Self::new() }
2025-11-09T23:42:54.8512055Z +    fn default() -> Self {
2025-11-09T23:42:54.8512178Z +        Self::new()
2025-11-09T23:42:54.8512297Z +    }
2025-11-09T23:42:54.8512415Z  }
2025-11-09T23:42:54.8512525Z  
2025-11-09T23:42:54.8513121Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mod.rs:120:
2025-11-09T23:42:54.8513257Z          self.mining_rpc =
2025-11-09T23:42:54.8513647Z              mining::MiningRpc::with_dependencies(Arc::clone(&storage), Arc::clone(&mempool));
2025-11-09T23:42:54.8514248Z          self.blockchain_rpc = blockchain::BlockchainRpc::with_dependencies(Arc::clone(&storage));
2025-11-09T23:42:54.8514891Z -        let mempool_rpc = mempool::MempoolRpc::with_dependencies(Arc::clone(&mempool), Arc::clone(&storage));
2025-11-09T23:42:54.8515285Z +        let mempool_rpc =
2025-11-09T23:42:54.8515724Z +            mempool::MempoolRpc::with_dependencies(Arc::clone(&mempool), Arc::clone(&storage));
2025-11-09T23:42:54.8515959Z          let rawtx_rpc = rawtx::RawTxRpc::with_dependencies(
2025-11-09T23:42:54.8516122Z              Arc::clone(&storage),
2025-11-09T23:42:54.8516265Z              Arc::clone(&mempool),
2025-11-09T23:42:54.8516695Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mod.rs:148:
2025-11-09T23:42:54.8516815Z      }
2025-11-09T23:42:54.8516925Z  
2025-11-09T23:42:54.8517079Z      /// Set network manager dependency
2025-11-09T23:42:54.8517580Z -    pub fn with_network_manager(mut self, network_manager: Arc<crate::network::NetworkManager>) -> Self {
2025-11-09T23:42:54.8517740Z +    pub fn with_network_manager(
2025-11-09T23:42:54.8519826Z +        mut self,
2025-11-09T23:42:54.8520161Z +        network_manager: Arc<crate::network::NetworkManager>,
2025-11-09T23:42:54.8520305Z +    ) -> Self {
2025-11-09T23:42:54.8520744Z          self.network_rpc = network::NetworkRpc::with_dependencies(Arc::clone(&network_manager));
2025-11-09T23:42:54.8521023Z          self.network_manager = Some(network_manager);
2025-11-09T23:42:54.8521627Z          self
2025-11-09T23:42:54.8522170Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mod.rs:196:
2025-11-09T23:42:54.8522289Z          ));
2025-11-09T23:42:54.8522414Z  
2025-11-09T23:42:54.8522610Z          // Create server with or without authentication
2025-11-09T23:42:54.8523083Z -        let server = if let (Some(ref storage), Some(ref mempool)) = (self.storage.as_ref(), self.mempool.as_ref()) {
2025-11-09T23:42:54.8523530Z -            let blockchain = Arc::new(blockchain::BlockchainRpc::with_dependencies(Arc::clone(storage)));
2025-11-09T23:42:54.8524011Z -            let mempool_rpc = Arc::new(mempool::MempoolRpc::with_dependencies(Arc::clone(mempool), Arc::clone(&storage)));
2025-11-09T23:42:54.8524690Z -            let rawtx_rpc = Arc::new(rawtx::RawTxRpc::with_dependencies(Arc::clone(storage), Arc::clone(mempool), None, None));
2025-11-09T23:42:54.8525132Z -            let mining = Arc::new(mining::MiningRpc::with_dependencies(Arc::clone(storage), Arc::clone(mempool)));
2025-11-09T23:42:54.8525360Z +        let server = if let (Some(ref storage), Some(ref mempool)) =
2025-11-09T23:42:54.8525569Z +            (self.storage.as_ref(), self.mempool.as_ref())
2025-11-09T23:42:54.8525693Z +        {
2025-11-09T23:42:54.8526053Z +            let blockchain = Arc::new(blockchain::BlockchainRpc::with_dependencies(Arc::clone(
2025-11-09T23:42:54.8526168Z +                storage,
2025-11-09T23:42:54.8526496Z +            )));
2025-11-09T23:42:54.8526765Z +            let mempool_rpc = Arc::new(mempool::MempoolRpc::with_dependencies(
2025-11-09T23:42:54.8526898Z +                Arc::clone(mempool),
2025-11-09T23:42:54.8536574Z +                Arc::clone(&storage),
2025-11-09T23:42:54.8536737Z +            ));
2025-11-09T23:42:54.8537054Z +            let rawtx_rpc = Arc::new(rawtx::RawTxRpc::with_dependencies(
2025-11-09T23:42:54.8537215Z +                Arc::clone(storage),
2025-11-09T23:42:54.8537372Z +                Arc::clone(mempool),
2025-11-09T23:42:54.8537491Z +                None,
2025-11-09T23:42:54.8537607Z +                None,
2025-11-09T23:42:54.8537731Z +            ));
2025-11-09T23:42:54.8538000Z +            let mining = Arc::new(mining::MiningRpc::with_dependencies(
2025-11-09T23:42:54.8538150Z +                Arc::clone(storage),
2025-11-09T23:42:54.8538289Z +                Arc::clone(mempool),
2025-11-09T23:42:54.8538410Z +            ));
2025-11-09T23:42:54.8538729Z              let network = if let Some(ref network_manager) = self.network_manager {
2025-11-09T23:42:54.8539107Z -                Arc::new(network::NetworkRpc::with_dependencies(Arc::clone(network_manager)))
2025-11-09T23:42:54.8539379Z +                Arc::new(network::NetworkRpc::with_dependencies(Arc::clone(
2025-11-09T23:42:54.8539518Z +                    network_manager,
2025-11-09T23:42:54.8539921Z +                )))
2025-11-09T23:42:54.8540068Z              } else {
2025-11-09T23:42:54.8540277Z                  Arc::new(network::NetworkRpc::new())
2025-11-09T23:42:54.8540392Z              };
2025-11-09T23:42:54.8540824Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mod.rs:209:
2025-11-09T23:42:54.8540954Z -            
2025-11-09T23:42:54.8541067Z +
2025-11-09T23:42:54.8541235Z              // Use auth manager if configured
2025-11-09T23:42:54.8541456Z              if let Some(ref auth_manager) = self.auth_manager {
2025-11-09T23:42:54.8541672Z                  server::RpcServer::with_dependencies_and_auth(
2025-11-09T23:42:54.8542107Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/mod.rs:233:
2025-11-09T23:42:54.8542230Z          } else {
2025-11-09T23:42:54.8542429Z              // No dependencies - use auth if configured
2025-11-09T23:42:54.8542635Z              if let Some(ref auth_manager) = self.auth_manager {
2025-11-09T23:42:54.8542810Z -                server::RpcServer::with_auth(
2025-11-09T23:42:54.8542968Z -                    self.server_addr,
2025-11-09T23:42:54.8543134Z -                    Arc::clone(auth_manager),
2025-11-09T23:42:54.8543253Z -                )
2025-11-09T23:42:54.8543686Z +                server::RpcServer::with_auth(self.server_addr, Arc::clone(auth_manager))
2025-11-09T23:42:54.8543814Z              } else {
2025-11-09T23:42:54.8544013Z                  server::RpcServer::new(self.server_addr)
2025-11-09T23:42:54.8545809Z              }
2025-11-09T23:42:54.8546286Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:18:
2025-11-09T23:42:54.8546434Z  impl NetworkRpc {
2025-11-09T23:42:54.8546595Z      /// Create a new network RPC handler
2025-11-09T23:42:54.8546743Z      pub fn new() -> Self {
2025-11-09T23:42:54.8546889Z -        Self { network_manager: None }
2025-11-09T23:42:54.8546999Z +        Self {
2025-11-09T23:42:54.8547144Z +            network_manager: None,
2025-11-09T23:42:54.8547256Z +        }
2025-11-09T23:42:54.8547365Z      }
2025-11-09T23:42:54.8547476Z  
2025-11-09T23:42:54.8547625Z      /// Create with dependencies
2025-11-09T23:42:54.8548079Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:25:
2025-11-09T23:42:54.8548429Z      pub fn with_dependencies(network_manager: Arc<NetworkManager>) -> Self {
2025-11-09T23:42:54.8548637Z -        Self { network_manager: Some(network_manager) }
2025-11-09T23:42:54.8548765Z +        Self {
2025-11-09T23:42:54.8548947Z +            network_manager: Some(network_manager),
2025-11-09T23:42:54.8549321Z +        }
2025-11-09T23:42:54.8549445Z      }
2025-11-09T23:42:54.8549555Z  
2025-11-09T23:42:54.8549696Z      /// Get network information
2025-11-09T23:42:54.8550152Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:103:
2025-11-09T23:42:54.8550373Z          if let Some(ref network) = self.network_manager {
2025-11-09T23:42:54.8550577Z              let peer_manager = network.peer_manager();
2025-11-09T23:42:54.8550800Z              let peer_addresses = peer_manager.peer_addresses();
2025-11-09T23:42:54.8551062Z -            let peers: Vec<Value> = peer_addresses.iter().map(|addr| {
2025-11-09T23:42:54.8551275Z -                if let Some(peer) = peer_manager.get_peer(addr) {
2025-11-09T23:42:54.8551399Z -                    json!({
2025-11-09T23:42:54.8551770Z -                        "id": addr.port().unwrap_or(0) as u64, // Use port as peer ID (unique per connection)
2025-11-09T23:42:54.8551932Z -                        "addr": addr.to_string(),
2025-11-09T23:42:54.8552091Z -                        "addrlocal": "",
2025-11-09T23:42:54.8552247Z -                        "services": "0000000000000001",
2025-11-09T23:42:54.8552404Z -                        "relaytxes": true,
2025-11-09T23:42:54.8552571Z -                        "lastsend": peer.last_send(),
2025-11-09T23:42:54.8552928Z -                        "lastrecv": peer.last_recv(),
2025-11-09T23:42:54.8553126Z -                        "bytessent": peer.bytes_sent(),
2025-11-09T23:42:54.8553294Z -                        "bytesrecv": peer.bytes_recv(),
2025-11-09T23:42:54.8553461Z -                        "conntime": peer.conntime(),
2025-11-09T23:42:54.8553616Z -                        "timeoffset": 0,
2025-11-09T23:42:54.8553758Z -                        "pingtime": 0.0,
2025-11-09T23:42:54.8553902Z -                        "minping": 0.0,
2025-11-09T23:42:54.8554040Z -                        "version": 70015,
2025-11-09T23:42:54.8554227Z -                        "subver": "/reference-node:0.1.0/",
2025-11-09T23:42:54.8554568Z -                        "inbound": false,
2025-11-09T23:42:54.8554714Z -                        "addnode": false,
2025-11-09T23:42:54.8554879Z -                        "startingheight": 0,
2025-11-09T23:42:54.8555037Z -                        "synced_headers": -1,
2025-11-09T23:42:54.8555188Z -                        "synced_blocks": -1,
2025-11-09T23:42:54.8555344Z -                        "inflight": [],
2025-11-09T23:42:54.8555496Z -                        "whitelisted": false,
2025-11-09T23:42:54.8555653Z -                        "minfeefilter": 0.00001000,
2025-11-09T23:42:54.8555807Z -                        "bytessent_per_msg": {},
2025-11-09T23:42:54.8555968Z -                        "bytesrecv_per_msg": {}
2025-11-09T23:42:54.8556083Z -                    })
2025-11-09T23:42:54.8556201Z -                } else {
2025-11-09T23:42:54.8556334Z -                    json!({})
2025-11-09T23:42:54.8556447Z -                }
2025-11-09T23:42:54.8556586Z -            }).collect();
2025-11-09T23:42:54.8556758Z +            let peers: Vec<Value> = peer_addresses
2025-11-09T23:42:54.8556890Z +                .iter()
2025-11-09T23:42:54.8557021Z +                .map(|addr| {
2025-11-09T23:42:54.8557242Z +                    if let Some(peer) = peer_manager.get_peer(addr) {
2025-11-09T23:42:54.8557377Z +                        json!({
2025-11-09T23:42:54.8557756Z +                            "id": addr.port().unwrap_or(0) as u64, // Use port as peer ID (unique per connection)
2025-11-09T23:42:54.8557922Z +                            "addr": addr.to_string(),
2025-11-09T23:42:54.8558065Z +                            "addrlocal": "",
2025-11-09T23:42:54.8558234Z +                            "services": "0000000000000001",
2025-11-09T23:42:54.8558386Z +                            "relaytxes": true,
2025-11-09T23:42:54.8558555Z +                            "lastsend": peer.last_send(),
2025-11-09T23:42:54.8558732Z +                            "lastrecv": peer.last_recv(),
2025-11-09T23:42:54.8559151Z +                            "bytessent": peer.bytes_sent(),
2025-11-09T23:42:54.8559319Z +                            "bytesrecv": peer.bytes_recv(),
2025-11-09T23:42:54.8559493Z +                            "conntime": peer.conntime(),
2025-11-09T23:42:54.8559644Z +                            "timeoffset": 0,
2025-11-09T23:42:54.8559791Z +                            "pingtime": 0.0,
2025-11-09T23:42:54.8559940Z +                            "minping": 0.0,
2025-11-09T23:42:54.8560097Z +                            "version": 70015,
2025-11-09T23:42:54.8560277Z +                            "subver": "/reference-node:0.1.0/",
2025-11-09T23:42:54.8560419Z +                            "inbound": false,
2025-11-09T23:42:54.8560571Z +                            "addnode": false,
2025-11-09T23:42:54.8560732Z +                            "startingheight": 0,
2025-11-09T23:42:54.8560893Z +                            "synced_headers": -1,
2025-11-09T23:42:54.8561052Z +                            "synced_blocks": -1,
2025-11-09T23:42:54.8561207Z +                            "inflight": [],
2025-11-09T23:42:54.8561426Z +                            "whitelisted": false,
2025-11-09T23:42:54.8561646Z +                            "minfeefilter": 0.00001000,
2025-11-09T23:42:54.8561896Z +                            "bytessent_per_msg": {},
2025-11-09T23:42:54.8562394Z +                            "bytesrecv_per_msg": {}
2025-11-09T23:42:54.8562529Z +                        })
2025-11-09T23:42:54.8562666Z +                    } else {
2025-11-09T23:42:54.8562802Z +                        json!({})
2025-11-09T23:42:54.8562919Z +                    }
2025-11-09T23:42:54.8563033Z +                })
2025-11-09T23:42:54.8563160Z +                .collect();
2025-11-09T23:42:54.8563281Z              Ok(json!(peers))
2025-11-09T23:42:54.8563386Z          } else {
2025-11-09T23:42:54.8563505Z              Ok(json!([]))
2025-11-09T23:42:54.8563931Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:164:
2025-11-09T23:42:54.8564127Z          if let Some(ref network) = self.network_manager {
2025-11-09T23:42:54.8564435Z              // Send ping to all peers
2025-11-09T23:42:54.8564638Z              if let Err(e) = network.ping_all_peers().await {
2025-11-09T23:42:54.8565036Z -                return Err(RpcError::internal_error(format!("Failed to ping peers: {}", e)));
2025-11-09T23:42:54.8565238Z +                return Err(RpcError::internal_error(format!(
2025-11-09T23:42:54.8565407Z +                    "Failed to ping peers: {}",
2025-11-09T23:42:54.8565522Z +                    e
2025-11-09T23:42:54.8565629Z +                )));
2025-11-09T23:42:54.8565789Z              }
2025-11-09T23:42:54.8565989Z              debug!("Sent ping to all connected peers");
2025-11-09T23:42:54.8566101Z          }
2025-11-09T23:42:54.8566519Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:205:
2025-11-09T23:42:54.8566637Z                  "onetry" => {
2025-11-09T23:42:54.8566786Z                      // Try to connect to node once
2025-11-09T23:42:54.8566993Z                      if let Err(e) = network.connect_to_peer(addr).await {
2025-11-09T23:42:54.8567372Z -                        return Err(RpcError::internal_error(format!("Failed to connect to {}: {}", addr, e)));
2025-11-09T23:42:54.8567588Z +                        return Err(RpcError::internal_error(format!(
2025-11-09T23:42:54.8567773Z +                            "Failed to connect to {}: {}",
2025-11-09T23:42:54.8567906Z +                            addr, e
2025-11-09T23:42:54.8568032Z +                        )));
2025-11-09T23:42:54.8568146Z                      }
2025-11-09T23:42:54.8568354Z                      debug!("Connected to node {} (onetry)", addr);
2025-11-09T23:42:54.8568486Z                      Ok(json!(null))
2025-11-09T23:42:54.8568935Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:310:
2025-11-09T23:42:54.8569107Z                  active_connection_limit_hits: 0,
2025-11-09T23:42:54.8569514Z                  resource_exhaustion_events: 0,
2025-11-09T23:42:54.8569628Z              };
2025-11-09T23:42:54.8569739Z -            
2025-11-09T23:42:54.8569862Z +
2025-11-09T23:42:54.8569984Z              Ok(json!({
2025-11-09T23:42:54.8570113Z                  "metrics": {
2025-11-09T23:42:54.8570444Z                      "connection_rate_violations": metrics.connection_rate_violations,
2025-11-09T23:42:54.8570887Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:365:
2025-11-09T23:42:54.8571042Z          let addr: SocketAddr = subnet
2025-11-09T23:42:54.8571726Z              .parse()
2025-11-09T23:42:54.8572187Z              .map_err(|_| RpcError::invalid_params(format!("Invalid address/subnet: {}", subnet)))?;
2025-11-09T23:42:54.8572307Z -        
2025-11-09T23:42:54.8572425Z +
2025-11-09T23:42:54.8572619Z          // Parse bantime (seconds) - 0 = permanent
2025-11-09T23:42:54.8573016Z          let bantime = params.get(2).and_then(|p| p.as_u64()).unwrap_or(86400); // Default 24 hours
2025-11-09T23:42:54.8573144Z -        
2025-11-09T23:42:54.8573261Z +
2025-11-09T23:42:54.8573579Z          // Parse absolute (whether bantime is absolute timestamp or relative)
2025-11-09T23:42:54.8573901Z          let absolute = params.get(3).and_then(|p| p.as_bool()).unwrap_or(false);
2025-11-09T23:42:54.8574249Z -        
2025-11-09T23:42:54.8577059Z +
2025-11-09T23:42:54.8577289Z          if let Some(ref network) = self.network_manager {
2025-11-09T23:42:54.8577494Z              use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:42:54.8577677Z              let now = SystemTime::now()
2025-11-09T23:42:54.8578145Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:378:
2025-11-09T23:42:54.8578314Z                  .duration_since(UNIX_EPOCH)
2025-11-09T23:42:54.8578455Z                  .unwrap()
2025-11-09T23:42:54.8578583Z                  .as_secs();
2025-11-09T23:42:54.8578710Z -            
2025-11-09T23:42:54.8578825Z +
2025-11-09T23:42:54.8579009Z              let unban_timestamp = if absolute {
2025-11-09T23:42:54.8579181Z                  bantime // Already a timestamp
2025-11-09T23:42:54.8579330Z              } else if bantime == 0 {
2025-11-09T23:42:54.8579808Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:386:
2025-11-09T23:42:54.8579941Z              } else {
2025-11-09T23:42:54.8580102Z                  now + bantime // Relative ban
2025-11-09T23:42:54.8580220Z              };
2025-11-09T23:42:54.8580347Z -            
2025-11-09T23:42:54.8580456Z +
2025-11-09T23:42:54.8580590Z              match command {
2025-11-09T23:42:54.8580717Z                  "add" => {
2025-11-09T23:42:54.8580912Z                      network.ban_peer(addr, unban_timestamp);
2025-11-09T23:42:54.8581358Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:422:
2025-11-09T23:42:54.8581469Z  
2025-11-09T23:42:54.8581699Z          if let Some(ref network) = self.network_manager {
2025-11-09T23:42:54.8581882Z              let banned = network.get_banned_peers();
2025-11-09T23:42:54.8582193Z -            let result: Vec<Value> = banned.iter().map(|(addr, unban_timestamp)| {
2025-11-09T23:42:54.8582327Z -                json!({
2025-11-09T23:42:54.8582491Z -                    "address": addr.to_string(),
2025-11-09T23:42:54.8582731Z -                    "banned_until": if *unban_timestamp == u64::MAX {
2025-11-09T23:42:54.8582928Z -                        serde_json::Value::Null // Permanent ban
2025-11-09T23:42:54.8583044Z -                    } else {
2025-11-09T23:42:54.8583263Z -                        serde_json::Value::Number((*unban_timestamp).into())
2025-11-09T23:42:54.8583371Z -                    },
2025-11-09T23:42:54.8583599Z -                    "banned_until_absolute": *unban_timestamp == u64::MAX
2025-11-09T23:42:54.8583741Z +            let result: Vec<Value> = banned
2025-11-09T23:42:54.8583853Z +                .iter()
2025-11-09T23:42:54.8584251Z +                .map(|(addr, unban_timestamp)| {
2025-11-09T23:42:54.8586416Z +                    json!({
2025-11-09T23:42:54.8586576Z +                        "address": addr.to_string(),
2025-11-09T23:42:54.8586792Z +                        "banned_until": if *unban_timestamp == u64::MAX {
2025-11-09T23:42:54.8586978Z +                            serde_json::Value::Null // Permanent ban
2025-11-09T23:42:54.8587093Z +                        } else {
2025-11-09T23:42:54.8587307Z +                            serde_json::Value::Number((*unban_timestamp).into())
2025-11-09T23:42:54.8587426Z +                        },
2025-11-09T23:42:54.8587643Z +                        "banned_until_absolute": *unban_timestamp == u64::MAX
2025-11-09T23:42:54.8587751Z +                    })
2025-11-09T23:42:54.8587860Z                  })
2025-11-09T23:42:54.8587974Z -            }).collect();
2025-11-09T23:42:54.8588087Z +                .collect();
2025-11-09T23:42:54.8588220Z              Ok(json!(result))
2025-11-09T23:42:54.8588333Z          } else {
2025-11-09T23:42:54.8588447Z              Ok(json!([]))
2025-11-09T23:42:54.8588897Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:445:
2025-11-09T23:42:54.8589256Z      pub async fn getaddednodeinfo(&self, params: &Value) -> RpcResult<Value> {
2025-11-09T23:42:54.8589662Z          debug!("RPC: getaddednodeinfo");
2025-11-09T23:42:54.8589788Z  
2025-11-09T23:42:54.8589947Z -        let node = params.get(0)
2025-11-09T23:42:54.8590089Z +        let node = params
2025-11-09T23:42:54.8590206Z +            .get(0)
2025-11-09T23:42:54.8590351Z              .and_then(|p| p.as_str())
2025-11-09T23:42:54.8590732Z              .ok_or_else(|| RpcError::invalid_params("Node address required".to_string()))?;
2025-11-09T23:42:54.8590848Z  
2025-11-09T23:42:54.8591307Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:453:
2025-11-09T23:42:54.8591492Z  
2025-11-09T23:42:54.8591716Z          if let Some(ref network) = self.network_manager {
2025-11-09T23:42:54.8591861Z              // Parse node address
2025-11-09T23:42:54.8592035Z -            let addr: SocketAddr = node.parse()
2025-11-09T23:42:54.8592195Z +            let addr: SocketAddr = node
2025-11-09T23:42:54.8592323Z +                .parse()
2025-11-09T23:42:54.8592708Z                  .map_err(|e| RpcError::invalid_params(format!("Invalid node address: {}", e)))?;
2025-11-09T23:42:54.8592828Z  
2025-11-09T23:42:54.8593017Z              // Check if node is in persistent peer list
2025-11-09T23:42:54.8593468Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:494:
2025-11-09T23:42:54.8593829Z      pub async fn getnodeaddresses(&self, params: &Value) -> RpcResult<Value> {
2025-11-09T23:42:54.8593996Z          debug!("RPC: getnodeaddresses");
2025-11-09T23:42:54.8594110Z  
2025-11-09T23:42:54.8595896Z -        let count = params.get(0)
2025-11-09T23:42:54.8596055Z -            .and_then(|p| p.as_u64())
2025-11-09T23:42:54.8596187Z -            .unwrap_or(1)
2025-11-09T23:42:54.8596346Z -            .min(100) as usize; // Limit to 100
2025-11-09T23:42:54.8596730Z +        let count = params.get(0).and_then(|p| p.as_u64()).unwrap_or(1).min(100) as usize; // Limit to 100
2025-11-09T23:42:54.8596830Z  
2025-11-09T23:42:54.8597022Z          if let Some(ref network) = self.network_manager {
2025-11-09T23:42:54.8597151Z              // Get peer addresses
2025-11-09T23:42:54.8597568Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:504:
2025-11-09T23:42:54.8597773Z              let peer_addrs = network.get_peer_addresses().await;
2025-11-09T23:42:54.8597878Z -            
2025-11-09T23:42:54.8597983Z +
2025-11-09T23:42:54.8598127Z              // Convert to node address format
2025-11-09T23:42:54.8598277Z              let mut addresses = Vec::new();
2025-11-09T23:42:54.8598486Z              for addr in peer_addrs.into_iter().take(count) {
2025-11-09T23:42:54.8599140Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/network.rs:551:
2025-11-09T23:42:54.8599455Z      pub async fn setnetworkactive(&self, params: &Value) -> RpcResult<Value> {
2025-11-09T23:42:54.8599602Z          debug!("RPC: setnetworkactive");
2025-11-09T23:42:54.8599710Z  
2025-11-09T23:42:54.8599843Z -        let state = params.get(0)
2025-11-09T23:42:54.8599986Z -            .and_then(|p| p.as_bool())
2025-11-09T23:42:54.8600429Z -            .ok_or_else(|| RpcError::invalid_params("State parameter required (true/false)".to_string()))?;
2025-11-09T23:42:54.8600729Z +        let state = params.get(0).and_then(|p| p.as_bool()).ok_or_else(|| {
2025-11-09T23:42:54.8601112Z +            RpcError::invalid_params("State parameter required (true/false)".to_string())
2025-11-09T23:42:54.8601236Z +        })?;
2025-11-09T23:42:54.8601346Z  
2025-11-09T23:42:54.8601555Z          if let Some(ref network) = self.network_manager {
2025-11-09T23:42:54.8601736Z -            network.set_network_active(state).await
2025-11-09T23:42:54.8602161Z -                .map_err(|e| RpcError::internal_error(format!("Failed to set network active: {}", e)))?;
2025-11-09T23:42:54.8602410Z +            network.set_network_active(state).await.map_err(|e| {
2025-11-09T23:42:54.8602762Z +                RpcError::internal_error(format!("Failed to set network active: {}", e))
2025-11-09T23:42:54.8604727Z +            })?;
2025-11-09T23:42:54.8604889Z              Ok(json!(state))
2025-11-09T23:42:54.8605009Z          } else {
2025-11-09T23:42:54.8605369Z -            Err(RpcError::internal_error("Network manager not available".to_string()))
2025-11-09T23:42:54.8605547Z +            Err(RpcError::internal_error(
2025-11-09T23:42:54.8605740Z +                "Network manager not available".to_string(),
2025-11-09T23:42:54.8605855Z +            ))
2025-11-09T23:42:54.8606040Z          }
2025-11-09T23:42:54.8606157Z      }
2025-11-09T23:42:54.8606267Z  }
2025-11-09T23:42:54.8648445Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:68:
2025-11-09T23:42:54.8648669Z          let tx_bytes = hex::decode(hex_string)
2025-11-09T23:42:54.8649043Z              .map_err(|e| RpcError::invalid_params(format!("Invalid hex string: {}", e)))?;
2025-11-09T23:42:54.8649229Z  
2025-11-09T23:42:54.8649664Z -        if let (Some(ref storage), Some(ref mempool)) = (self.storage.as_ref(), self.mempool.as_ref()) {
2025-11-09T23:42:54.8650454Z +        if let (Some(ref storage), Some(ref mempool)) =
2025-11-09T23:42:54.8651025Z +            (self.storage.as_ref(), self.mempool.as_ref())
2025-11-09T23:42:54.8651186Z +        {
2025-11-09T23:42:54.8651660Z              use bllvm_protocol::serialization::transaction::deserialize_transaction;
2025-11-09T23:42:54.8651912Z -            let tx = deserialize_transaction(&tx_bytes)
2025-11-09T23:42:54.8652310Z -                .map_err(|e| RpcError::invalid_params(format!("Failed to parse transaction: {}", e)))?;
2025-11-09T23:42:54.8652431Z -            
2025-11-09T23:42:54.8652701Z +            let tx = deserialize_transaction(&tx_bytes).map_err(|e| {
2025-11-09T23:42:54.8653047Z +                RpcError::invalid_params(format!("Failed to parse transaction: {}", e))
2025-11-09T23:42:54.8653162Z +            })?;
2025-11-09T23:42:54.8653283Z +
2025-11-09T23:42:54.8653497Z              use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:42:54.8653669Z              let txid = calculate_tx_id(&tx);
2025-11-09T23:42:54.8653784Z -            
2025-11-09T23:42:54.8653902Z +
2025-11-09T23:42:54.8654811Z              // Check if already in mempool
2025-11-09T23:42:54.8655035Z              if mempool.get_transaction(&txid).is_some() {
2025-11-09T23:42:54.8655400Z                  return Err(RpcError::invalid_params("Transaction already in mempool"));
2025-11-09T23:42:54.8655837Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:82:
2025-11-09T23:42:54.8655953Z              }
2025-11-09T23:42:54.8656068Z -            
2025-11-09T23:42:54.8656445Z +
2025-11-09T23:42:54.8656593Z              // Check if in chain
2025-11-09T23:42:54.8656921Z -            if storage.transactions().has_transaction(&txid).unwrap_or(false) {
2025-11-09T23:42:54.8657061Z +            if storage
2025-11-09T23:42:54.8657197Z +                .transactions()
2025-11-09T23:42:54.8657349Z +                .has_transaction(&txid)
2025-11-09T23:42:54.8657500Z +                .unwrap_or(false)
2025-11-09T23:42:54.8657626Z +            {
2025-11-09T23:42:54.8657971Z                  return Err(RpcError::invalid_params("Transaction already in chain"));
2025-11-09T23:42:54.8658087Z              }
2025-11-09T23:42:54.8658213Z -            
2025-11-09T23:42:54.8658324Z +
2025-11-09T23:42:54.8658523Z              // Validate transaction using consensus layer
2025-11-09T23:42:54.8658737Z -            let _timer = self.profiler.as_ref().map(|p| {
2025-11-09T23:42:54.8659077Z -                PerformanceTimer::start(Arc::clone(p), OperationType::TxValidation)
2025-11-09T23:42:54.8659194Z -            });
2025-11-09T23:42:54.8659321Z +            let _timer = self
2025-11-09T23:42:54.8659455Z +                .profiler
2025-11-09T23:42:54.8659579Z +                .as_ref()
2025-11-09T23:42:54.8659968Z +                .map(|p| PerformanceTimer::start(Arc::clone(p), OperationType::TxValidation));
2025-11-09T23:42:54.8660389Z              let validation_start = Instant::now();
2025-11-09T23:42:54.8660647Z              use bllvm_protocol::ConsensusProof;
2025-11-09T23:42:54.8660838Z              let consensus = ConsensusProof::new();
2025-11-09T23:42:54.8661272Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:97:
2025-11-09T23:42:54.8661482Z                  Ok(bllvm_protocol::ValidationResult::Valid) => {
2025-11-09T23:42:54.8661702Z                      let validation_time = validation_start.elapsed();
2025-11-09T23:42:54.8661895Z                      // Timer will record duration when dropped
2025-11-09T23:42:54.8662022Z -                    
2025-11-09T23:42:54.8662145Z +
2025-11-09T23:42:54.8662283Z                      // Update metrics
2025-11-09T23:42:54.8662462Z                      if let Some(ref metrics) = self.metrics {
2025-11-09T23:42:54.8662629Z                          metrics.update_performance(|m| {
2025-11-09T23:42:54.8663036Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:104:
2025-11-09T23:42:54.8663261Z                              let time_ms = validation_time.as_secs_f64() * 1000.0;
2025-11-09T23:42:54.8663593Z                              // Update average transaction validation time (exponential moving average)
2025-11-09T23:42:54.8663750Z -                            m.avg_tx_validation_time_ms = 
2025-11-09T23:42:54.8663904Z +                            m.avg_tx_validation_time_ms =
2025-11-09T23:42:54.8664122Z                                  (m.avg_tx_validation_time_ms * 0.9) + (time_ms * 0.1);
2025-11-09T23:42:54.8664282Z                              // Update transactions per second
2025-11-09T23:42:54.8664713Z                              if validation_time.as_secs_f64() > 0.0 {
2025-11-09T23:42:54.8665139Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:111:
2025-11-09T23:42:54.8665255Z                              }
2025-11-09T23:42:54.8665367Z                          });
2025-11-09T23:42:54.8666943Z                      }
2025-11-09T23:42:54.8667056Z -                    
2025-11-09T23:42:54.8667159Z +
2025-11-09T23:42:54.8667451Z                      // Transaction structure is valid, now check inputs against UTXO set
2025-11-09T23:42:54.8667642Z -                    let utxo_set = storage.utxos().get_all_utxos()
2025-11-09T23:42:54.8667995Z -                        .map_err(|e| RpcError::internal_error(format!("Failed to get UTXO set: {}", e)))?;
2025-11-09T23:42:54.8668101Z -                    
2025-11-09T23:42:54.8668344Z +                    let utxo_set = storage.utxos().get_all_utxos().map_err(|e| {
2025-11-09T23:42:54.8668897Z +                        RpcError::internal_error(format!("Failed to get UTXO set: {}", e))
2025-11-09T23:42:54.8669027Z +                    })?;
2025-11-09T23:42:54.8669150Z +
2025-11-09T23:42:54.8669334Z                      // Check if all inputs exist in UTXO set
2025-11-09T23:42:54.8669498Z                      for input in &tx.inputs {
2025-11-09T23:42:54.8669717Z                          if !utxo_set.contains_key(&input.prevout) {
2025-11-09T23:42:54.8670187Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:126:
2025-11-09T23:42:54.8670316Z                              )));
2025-11-09T23:42:54.8670438Z                          }
2025-11-09T23:42:54.8670556Z                      }
2025-11-09T23:42:54.8670661Z -                    
2025-11-09T23:42:54.8670760Z +
2025-11-09T23:42:54.8670889Z                      // Add to mempool
2025-11-09T23:42:54.8671228Z                      // Note: add_transaction requires &mut self, but we have Arc<MempoolManager>
2025-11-09T23:42:54.8671740Z                      // In production, this would need to use interior mutability (Mutex/RwLock)
2025-11-09T23:42:54.8672176Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:133:
2025-11-09T23:42:54.8672448Z                      // For now, we'll skip adding to mempool as it requires mutable access
2025-11-09T23:42:54.8673081Z -                    debug!("Transaction validated but not added to mempool (requires mutable access)");
2025-11-09T23:42:54.8673228Z +                    debug!(
2025-11-09T23:42:54.8673591Z +                        "Transaction validated but not added to mempool (requires mutable access)"
2025-11-09T23:42:54.8673705Z +                    );
2025-11-09T23:42:54.8673829Z                  }
2025-11-09T23:42:54.8674106Z                  Ok(bllvm_protocol::ValidationResult::Invalid(reason)) => {
2025-11-09T23:42:54.8674701Z -                    return Err(RpcError::invalid_params(format!("Transaction validation failed: {}", reason)));
2025-11-09T23:42:54.8674919Z +                    return Err(RpcError::invalid_params(format!(
2025-11-09T23:42:54.8675104Z +                        "Transaction validation failed: {}",
2025-11-09T23:42:54.8675233Z +                        reason
2025-11-09T23:42:54.8675360Z +                    )));
2025-11-09T23:42:54.8675477Z                  }
2025-11-09T23:42:54.8675615Z                  Err(e) => {
2025-11-09T23:42:54.8676038Z -                    return Err(RpcError::internal_error(format!("Transaction validation error: {}", e)));
2025-11-09T23:42:54.8676262Z +                    return Err(RpcError::internal_error(format!(
2025-11-09T23:42:54.8676445Z +                        "Transaction validation error: {}",
2025-11-09T23:42:54.8676573Z +                        e
2025-11-09T23:42:54.8676698Z +                    )));
2025-11-09T23:42:54.8676817Z                  }
2025-11-09T23:42:54.8676931Z              }
2025-11-09T23:42:54.8677055Z -            
2025-11-09T23:42:54.8677165Z +
2025-11-09T23:42:54.8677340Z              Ok(json!(hex::encode(txid)))
2025-11-09T23:42:54.8677459Z          } else {
2025-11-09T23:42:54.8677811Z -            Err(RpcError::invalid_params("RPC not initialized with dependencies"))
2025-11-09T23:42:54.8677985Z +            Err(RpcError::invalid_params(
2025-11-09T23:42:54.8678178Z +                "RPC not initialized with dependencies",
2025-11-09T23:42:54.8678308Z +            ))
2025-11-09T23:42:54.8678420Z          }
2025-11-09T23:42:54.8678531Z      }
2025-11-09T23:42:54.8678646Z  
2025-11-09T23:42:54.8679108Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:175:
2025-11-09T23:42:54.8679306Z          let consensus = ConsensusProof::new();
2025-11-09T23:42:54.8679593Z          let validation_result = consensus.validate_transaction(&tx);
2025-11-09T23:42:54.8679717Z  
2025-11-09T23:42:54.8680136Z -        let allowed = matches!(validation_result, Ok(bllvm_protocol::ValidationResult::Valid));
2025-11-09T23:42:54.8680287Z +        let allowed = matches!(
2025-11-09T23:42:54.8680740Z +            validation_result,
2025-11-09T23:42:54.8680957Z +            Ok(bllvm_protocol::ValidationResult::Valid)
2025-11-09T23:42:54.8681075Z +        );
2025-11-09T23:42:54.8681237Z          let reject_reason = if !allowed {
2025-11-09T23:42:54.8681400Z              match validation_result {
2025-11-09T23:42:54.8681752Z                  Ok(bllvm_protocol::ValidationResult::Invalid(reason)) => Some(reason),
2025-11-09T23:42:54.8682197Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:232:
2025-11-09T23:42:54.8682566Z          use bllvm_protocol::serialization::transaction::deserialize_transaction;
2025-11-09T23:42:54.8682758Z          let tx = deserialize_transaction(&tx_bytes)
2025-11-09T23:42:54.8683167Z              .map_err(|e| RpcError::invalid_params(format!("Failed to parse transaction: {}", e)))?;
2025-11-09T23:42:54.8683291Z -        
2025-11-09T23:42:54.8683400Z +
2025-11-09T23:42:54.8683604Z          use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:42:54.8683771Z          let txid = calculate_tx_id(&tx);
2025-11-09T23:42:54.8683947Z          let txid_hex = hex::encode(txid);
2025-11-09T23:42:54.8684580Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:239:
2025-11-09T23:42:54.8684744Z          let size = tx_bytes.len();
2025-11-09T23:42:54.8684867Z -        
2025-11-09T23:42:54.8685211Z +
2025-11-09T23:42:54.8685354Z          Ok(json!({
2025-11-09T23:42:54.8685505Z              "txid": txid_hex.clone(),
2025-11-09T23:42:54.8685646Z              "hash": txid_hex,
2025-11-09T23:42:54.8686101Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:295:
2025-11-09T23:42:54.8686422Z              if let Ok(Some(tx)) = storage.transactions().get_transaction(&txid_array) {
2025-11-09T23:42:54.8686784Z                  use bllvm_protocol::serialization::transaction::serialize_transaction;
2025-11-09T23:42:54.8687024Z                  let tx_hex = hex::encode(serialize_transaction(&tx));
2025-11-09T23:42:54.8687154Z -                
2025-11-09T23:42:54.8687274Z +
2025-11-09T23:42:54.8687412Z                  if verbose {
2025-11-09T23:42:54.8687634Z                      use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:42:54.8687832Z                      let calculated_txid = calculate_tx_id(&tx);
2025-11-09T23:42:54.8688302Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:417:
2025-11-09T23:42:54.8688554Z              if let Ok(Some(utxo)) = storage.utxos().get_utxo(&outpoint) {
2025-11-09T23:42:54.8688865Z                  let best_hash = storage.chain().get_tip_hash()?.unwrap_or([0u8; 32]);
2025-11-09T23:42:54.8689130Z                  let tip_height = storage.chain().get_height()?.unwrap_or(0);
2025-11-09T23:42:54.8689250Z -                
2025-11-09T23:42:54.8689362Z +
2025-11-09T23:42:54.8689583Z                  // Find block height containing this transaction
2025-11-09T23:42:54.8689761Z                  let mut tx_height: Option<u64> = None;
2025-11-09T23:42:54.8689915Z                  for h in 0..=tip_height {
2025-11-09T23:42:54.8690361Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:437:
2025-11-09T23:42:54.8690495Z                          }
2025-11-09T23:42:54.8690610Z                      }
2025-11-09T23:42:54.8690724Z                  }
2025-11-09T23:42:54.8690851Z -                
2025-11-09T23:42:54.8690964Z +
2025-11-09T23:42:54.8691199Z                  let confirmations = tx_height
2025-11-09T23:42:54.8691329Z                      .map(|h| {
2025-11-09T23:42:54.8691482Z                          if h > tip_height {
2025-11-09T23:42:54.8691917Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:447:
2025-11-09T23:42:54.8692036Z                          }
2025-11-09T23:42:54.8692160Z                      })
2025-11-09T23:42:54.8692299Z                      .unwrap_or(0);
2025-11-09T23:42:54.8692412Z -                
2025-11-09T23:42:54.8692743Z +
2025-11-09T23:42:54.8692875Z                  Ok(json!({
2025-11-09T23:42:54.8693065Z                      "bestblock": hex::encode(best_hash),
2025-11-09T23:42:54.8693237Z                      "confirmations": confirmations,
2025-11-09T23:42:54.8693675Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:470:
2025-11-09T23:42:54.8693799Z      }
2025-11-09T23:42:54.8693912Z  
2025-11-09T23:42:54.8694126Z      /// Build merkle proof for transactions in a block
2025-11-09T23:42:54.8694953Z -    fn build_merkle_proof(transactions: &[bllvm_protocol::Transaction], tx_indices: &[usize]) -> Result<Vec<[u8; 32]>, RpcError> {
2025-11-09T23:42:54.8695177Z -        use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:42:54.8695324Z +    fn build_merkle_proof(
2025-11-09T23:42:54.8695535Z +        transactions: &[bllvm_protocol::Transaction],
2025-11-09T23:42:54.8695676Z +        tx_indices: &[usize],
2025-11-09T23:42:54.8695836Z +    ) -> Result<Vec<[u8; 32]>, RpcError> {
2025-11-09T23:42:54.8696044Z          use crate::storage::hashing::double_sha256;
2025-11-09T23:42:54.8696233Z +        use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:42:54.8696344Z  
2025-11-09T23:42:54.8696511Z          if transactions.is_empty() {
2025-11-09T23:42:54.8697103Z -            return Err(RpcError::internal_error("Block has no transactions".to_string()));
2025-11-09T23:42:54.8697308Z +            return Err(RpcError::internal_error(
2025-11-09T23:42:54.8697496Z +                "Block has no transactions".to_string(),
2025-11-09T23:42:54.8697618Z +            ));
2025-11-09T23:42:54.8697731Z          }
2025-11-09T23:42:54.8697833Z  
2025-11-09T23:42:54.8698005Z          // Calculate all transaction hashes
2025-11-09T23:42:54.8698455Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:482:
2025-11-09T23:42:54.8698678Z -        let mut tx_hashes: Vec<[u8; 32]> = transactions.iter()
2025-11-09T23:42:54.8698836Z -            .map(|tx| calculate_tx_id(tx))
2025-11-09T23:42:54.8698983Z -            .collect();
2025-11-09T23:42:54.8699143Z +        let mut tx_hashes: Vec<[u8; 32]> =
2025-11-09T23:42:54.8699426Z +            transactions.iter().map(|tx| calculate_tx_id(tx)).collect();
2025-11-09T23:42:54.8699546Z  
2025-11-09T23:42:54.8699703Z          let mut proof = Vec::new();
2025-11-09T23:42:54.8699892Z          let mut current_level = tx_hashes.clone();
2025-11-09T23:42:54.8700334Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:501:
2025-11-09T23:42:54.8700523Z                      combined.extend_from_slice(&chunk[1]);
2025-11-09T23:42:54.8700722Z                      let parent_hash = double_sha256(&combined);
2025-11-09T23:42:54.8700885Z                      next_level.push(parent_hash);
2025-11-09T23:42:54.8701008Z -                    
2025-11-09T23:42:54.8701119Z +
2025-11-09T23:42:54.8701303Z                      // Check if we need to add sibling to proof
2025-11-09T23:42:54.8701463Z                      if !proof_added {
2025-11-09T23:42:54.8701614Z                          for &idx in tx_indices {
2025-11-09T23:42:54.8702049Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:581:
2025-11-09T23:42:54.8702221Z                              for tx in &b.transactions {
2025-11-09T23:42:54.8702398Z                                  let txid = calculate_tx_id(tx);
2025-11-09T23:42:54.8702589Z                                  let txid_hex = hex::encode(txid);
2025-11-09T23:42:54.8702893Z -                                if txids.iter().any(|tid| tid.as_str() == Some(txid_hex.as_str())) {
2025-11-09T23:42:54.8703039Z +                                if txids
2025-11-09T23:42:54.8703174Z +                                    .iter()
2025-11-09T23:42:54.8703397Z +                                    .any(|tid| tid.as_str() == Some(txid_hex.as_str()))
2025-11-09T23:42:54.8703535Z +                                {
2025-11-09T23:42:54.8703687Z                                      block = Some(b);
2025-11-09T23:42:54.8704035Z                                      break;
2025-11-09T23:42:54.8704164Z                                  }
2025-11-09T23:42:54.8704810Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:601:
2025-11-09T23:42:54.8705063Z                  for (idx, tx) in block.transactions.iter().enumerate() {
2025-11-09T23:42:54.8705244Z                      let txid = calculate_tx_id(tx);
2025-11-09T23:42:54.8705432Z                      let txid_hex = hex::encode(txid);
2025-11-09T23:42:54.8706628Z -                    if txids.iter().any(|tid| tid.as_str() == Some(txid_hex.as_str())) {
2025-11-09T23:42:54.8706782Z +                    if txids
2025-11-09T23:42:54.8706926Z +                        .iter()
2025-11-09T23:42:54.8707140Z +                        .any(|tid| tid.as_str() == Some(txid_hex.as_str()))
2025-11-09T23:42:54.8707253Z +                    {
2025-11-09T23:42:54.8707414Z                          tx_indices.push(idx);
2025-11-09T23:42:54.8707550Z                      }
2025-11-09T23:42:54.8707665Z                  }
2025-11-09T23:42:54.8708102Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:608:
2025-11-09T23:42:54.8708226Z  
2025-11-09T23:42:54.8708383Z                  if tx_indices.is_empty() {
2025-11-09T23:42:54.8709061Z -                    return Err(RpcError::invalid_params("None of the specified transactions found in block"));
2025-11-09T23:42:54.8709284Z +                    return Err(RpcError::invalid_params(
2025-11-09T23:42:54.8709513Z +                        "None of the specified transactions found in block",
2025-11-09T23:42:54.8709638Z +                    ));
2025-11-09T23:42:54.8709756Z                  }
2025-11-09T23:42:54.8709877Z  
2025-11-09T23:42:54.8710027Z                  // Build merkle proof
2025-11-09T23:42:54.8710466Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:614:
2025-11-09T23:42:54.8710841Z                  let proof_hashes = Self::build_merkle_proof(&block.transactions, &tx_indices)
2025-11-09T23:42:54.8711264Z -                    .map_err(|e| RpcError::internal_error(format!("Failed to build merkle proof: {}", e)))?;
2025-11-09T23:42:54.8711407Z +                    .map_err(|e| {
2025-11-09T23:42:54.8711777Z +                        RpcError::internal_error(format!("Failed to build merkle proof: {}", e))
2025-11-09T23:42:54.8711902Z +                    })?;
2025-11-09T23:42:54.8712018Z  
2025-11-09T23:42:54.8712355Z                  // Serialize proof (simplified - Bitcoin Core uses a more complex format)
2025-11-09T23:42:54.8712541Z                  let mut proof_bytes = Vec::new();
2025-11-09T23:42:54.8712975Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:626:
2025-11-09T23:42:54.8713195Z                  Err(RpcError::invalid_params("Block not found"))
2025-11-09T23:42:54.8713316Z              }
2025-11-09T23:42:54.8713431Z          } else {
2025-11-09T23:42:54.8714774Z -            Err(RpcError::invalid_params("RPC not initialized with dependencies"))
2025-11-09T23:42:54.8714973Z +            Err(RpcError::invalid_params(
2025-11-09T23:42:54.8715167Z +                "RPC not initialized with dependencies",
2025-11-09T23:42:54.8715286Z +            ))
2025-11-09T23:42:54.8715401Z          }
2025-11-09T23:42:54.8715518Z      }
2025-11-09T23:42:54.8715637Z  
2025-11-09T23:42:54.8716089Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:650:
2025-11-09T23:42:54.8716237Z              // Decode proof
2025-11-09T23:42:54.8716438Z              let proof_bytes = hex::decode(proof_hex)
2025-11-09T23:42:54.8716789Z                  .map_err(|e| RpcError::invalid_params(format!("Invalid proof hex: {}", e)))?;
2025-11-09T23:42:54.8716918Z -            
2025-11-09T23:42:54.8717028Z +
2025-11-09T23:42:54.8717188Z              if proof_bytes.is_empty() {
2025-11-09T23:42:54.8717433Z                  return Err(RpcError::invalid_params("Empty proof"));
2025-11-09T23:42:54.8717809Z              }
2025-11-09T23:42:54.8718249Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:681:
2025-11-09T23:42:54.8718553Z              if let Ok(Some(block)) = storage.blocks().get_block(&blockhash_array) {
2025-11-09T23:42:54.8718738Z                  // Calculate merkle root from block
2025-11-09T23:42:54.8718979Z                  use bllvm_protocol::mining::calculate_merkle_root;
2025-11-09T23:42:54.8719283Z -                let calculated_root = calculate_merkle_root(&block.transactions)
2025-11-09T23:42:54.8719727Z -                    .map_err(|e| RpcError::internal_error(format!("Failed to calculate merkle root: {}", e)))?;
2025-11-09T23:42:54.8720109Z +                let calculated_root = calculate_merkle_root(&block.transactions).map_err(|e| {
2025-11-09T23:42:54.8720469Z +                    RpcError::internal_error(format!("Failed to calculate merkle root: {}", e))
2025-11-09T23:42:54.8720581Z +                })?;
2025-11-09T23:42:54.8720698Z  
2025-11-09T23:42:54.8721050Z                  // Verify proof by reconstructing root (simplified - would need txids from proof)
2025-11-09T23:42:54.8721295Z                  // For now, just verify the block's merkle root matches the header
2025-11-09T23:42:54.8721687Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:690:
2025-11-09T23:42:54.8721970Z  
2025-11-09T23:42:54.8722376Z                  // Extract transaction IDs from proof (simplified - full implementation would decode txids)
2025-11-09T23:42:54.8722574Z                  use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:42:54.8722777Z -                let txids: Vec<String> = block.transactions.iter()
2025-11-09T23:42:54.8722924Z +                let txids: Vec<String> = block
2025-11-09T23:42:54.8723055Z +                    .transactions
2025-11-09T23:42:54.8723168Z +                    .iter()
2025-11-09T23:42:54.8723347Z                      .map(|tx| hex::encode(calculate_tx_id(tx)))
2025-11-09T23:42:54.8723473Z                      .collect();
2025-11-09T23:42:54.8723578Z  
2025-11-09T23:42:54.8723963Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/rawtx.rs:703:
2025-11-09T23:42:54.8724155Z                  Err(RpcError::invalid_params("Block not found"))
2025-11-09T23:42:54.8724264Z              }
2025-11-09T23:42:54.8724557Z          } else {
2025-11-09T23:42:54.8724859Z -            Err(RpcError::invalid_params("RPC not initialized with dependencies"))
2025-11-09T23:42:54.8725005Z +            Err(RpcError::invalid_params(
2025-11-09T23:42:54.8725180Z +                "RPC not initialized with dependencies",
2025-11-09T23:42:54.8725282Z +            ))
2025-11-09T23:42:54.8725383Z          }
2025-11-09T23:42:54.8725489Z      }
2025-11-09T23:42:54.8725589Z  }
2025-11-09T23:42:54.8776661Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:54:
2025-11-09T23:42:54.8776902Z      }
2025-11-09T23:42:54.8777030Z  
2025-11-09T23:42:54.8777319Z      /// Create a new RPC server with authentication
2025-11-09T23:42:54.8777459Z -    pub fn with_auth(
2025-11-09T23:42:54.8777596Z -        addr: SocketAddr,
2025-11-09T23:42:54.8777797Z -        auth_manager: Arc<auth::RpcAuthManager>,
2025-11-09T23:42:54.8777928Z -    ) -> Self {
2025-11-09T23:42:54.8778346Z +    pub fn with_auth(addr: SocketAddr, auth_manager: Arc<auth::RpcAuthManager>) -> Self {
2025-11-09T23:42:54.8778467Z          Self {
2025-11-09T23:42:54.8778595Z              addr,
2025-11-09T23:42:54.8778850Z              blockchain: Arc::new(blockchain::BlockchainRpc::new()),
2025-11-09T23:42:54.8779306Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:134:
2025-11-09T23:42:54.8779487Z              control: Arc::clone(&self.control),
2025-11-09T23:42:54.8779671Z              auth_manager: self.auth_manager.clone(),
2025-11-09T23:42:54.8779784Z          });
2025-11-09T23:42:54.8779896Z -        
2025-11-09T23:42:54.8780276Z +
2025-11-09T23:42:54.8780395Z          loop {
2025-11-09T23:42:54.8780555Z              match listener.accept().await {
2025-11-09T23:42:54.8780716Z                  Ok((stream, addr)) => {
2025-11-09T23:42:54.8781157Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:141:
2025-11-09T23:42:54.8781361Z                      debug!("New RPC connection from {}", addr);
2025-11-09T23:42:54.8781512Z                      let peer_addr = addr;
2025-11-09T23:42:54.8781696Z                      let server = Arc::clone(&server);
2025-11-09T23:42:54.8781816Z -                    
2025-11-09T23:42:54.8781926Z +
2025-11-09T23:42:54.8782102Z                      // Spawn task to handle connection
2025-11-09T23:42:54.8782263Z                      tokio::spawn(async move {
2025-11-09T23:42:54.8782578Z                          // Use hyper for HTTP - it will handle protocol detection and parsing
2025-11-09T23:42:54.8783015Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:148:
2025-11-09T23:42:54.8783183Z                          let io = TokioIo::new(stream);
2025-11-09T23:42:54.8783353Z                          let service = service_fn(move |req| {
2025-11-09T23:42:54.8783716Z -                            Self::handle_http_request_with_server(Arc::clone(&server), req, peer_addr)
2025-11-09T23:42:54.8784107Z +                            Self::handle_http_request_with_server(
2025-11-09T23:42:54.8784270Z +                                Arc::clone(&server),
2025-11-09T23:42:54.8784577Z +                                req,
2025-11-09T23:42:54.8784725Z +                                peer_addr,
2025-11-09T23:42:54.8784846Z +                            )
2025-11-09T23:42:54.8784961Z                          });
2025-11-09T23:42:54.8785081Z -                        
2025-11-09T23:42:54.8785184Z +
2025-11-09T23:42:54.8785325Z                          // Try to serve as HTTP
2025-11-09T23:42:54.8785508Z -                        if let Err(e) = http1::Builder::new()
2025-11-09T23:42:54.8785683Z -                            .serve_connection(io, service)
2025-11-09T23:42:54.8785800Z -                            .await
2025-11-09T23:42:54.8785928Z -                        {
2025-11-09T23:42:54.8786258Z +                        if let Err(e) = http1::Builder::new().serve_connection(io, service).await {
2025-11-09T23:42:54.8786458Z                              // If hyper fails, it might be raw TCP
2025-11-09T23:42:54.8786738Z                              // But we can't recover here since hyper consumed the connection
2025-11-09T23:42:54.8787071Z                              // For now, log and continue - raw TCP support would need separate port
2025-11-09T23:42:54.8787543Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:161:
2025-11-09T23:42:54.8787928Z -                            debug!("HTTP connection failed from {} (might be raw TCP): {}", peer_addr, e);
2025-11-09T23:42:54.8788069Z +                            debug!(
2025-11-09T23:42:54.8788338Z +                                "HTTP connection failed from {} (might be raw TCP): {}",
2025-11-09T23:42:54.8788492Z +                                peer_addr, e
2025-11-09T23:42:54.8788623Z +                            );
2025-11-09T23:42:54.8788745Z                          }
2025-11-09T23:42:54.8788865Z                      });
2025-11-09T23:42:54.8788990Z                  }
2025-11-09T23:42:54.8789448Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:185:
2025-11-09T23:42:54.8789560Z  
2025-11-09T23:42:54.8789765Z          // Extract headers before consuming request body
2025-11-09T23:42:54.8789935Z          let headers = req.headers().clone();
2025-11-09T23:42:54.8790051Z -        
2025-11-09T23:42:54.8790163Z +
2025-11-09T23:42:54.8790304Z          // Check Content-Type
2025-11-09T23:42:54.8790562Z          if let Some(content_type) = headers.get("content-type") {
2025-11-09T23:42:54.8790743Z              if content_type != "application/json" {
2025-11-09T23:42:54.8791471Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:196:
2025-11-09T23:42:54.8791655Z          // Read request body with size limit
2025-11-09T23:42:54.8791814Z          let body = req.collect().await?;
2025-11-09T23:42:54.8791974Z          let body_bytes = body.to_bytes();
2025-11-09T23:42:54.8792096Z -        
2025-11-09T23:42:54.8792212Z +
2025-11-09T23:42:54.8792367Z          // Enforce maximum request size
2025-11-09T23:42:54.8792542Z          if body_bytes.len() > MAX_REQUEST_SIZE {
2025-11-09T23:42:54.8792733Z              return Ok(Self::http_error_response(
2025-11-09T23:42:54.8793189Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:203:
2025-11-09T23:42:54.8793372Z                  StatusCode::PAYLOAD_TOO_LARGE,
2025-11-09T23:42:54.8793809Z -                &format!("Request body too large: {} bytes (max: {} bytes)", body_bytes.len(), MAX_REQUEST_SIZE),
2025-11-09T23:42:54.8793943Z +                &format!(
2025-11-09T23:42:54.8794177Z +                    "Request body too large: {} bytes (max: {} bytes)",
2025-11-09T23:42:54.8794536Z +                    body_bytes.len(),
2025-11-09T23:42:54.8794695Z +                    MAX_REQUEST_SIZE
2025-11-09T23:42:54.8794816Z +                ),
2025-11-09T23:42:54.8794926Z              ));
2025-11-09T23:42:54.8795043Z          }
2025-11-09T23:42:54.8795971Z  
2025-11-09T23:42:54.8796510Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:221:
2025-11-09T23:42:54.8796748Z          // Authenticate request if authentication is enabled
2025-11-09T23:42:54.8796973Z          if let Some(ref auth_manager) = server.auth_manager {
2025-11-09T23:42:54.8797325Z              let auth_result = auth_manager.authenticate_request(&headers, addr).await;
2025-11-09T23:42:54.8797447Z -            
2025-11-09T23:42:54.8797568Z +
2025-11-09T23:42:54.8797737Z              // Check if authentication failed
2025-11-09T23:42:54.8797927Z              if let Some(error) = auth_result.error {
2025-11-09T23:42:54.8798120Z -                return Ok(Self::http_error_response(
2025-11-09T23:42:54.8798285Z -                    StatusCode::UNAUTHORIZED,
2025-11-09T23:42:54.8798411Z -                    &error,
2025-11-09T23:42:54.8798535Z -                ));
2025-11-09T23:42:54.8798869Z +                return Ok(Self::http_error_response(StatusCode::UNAUTHORIZED, &error));
2025-11-09T23:42:54.8798985Z              }
2025-11-09T23:42:54.8799097Z  
2025-11-09T23:42:54.8799244Z              // Check rate limiting
2025-11-09T23:42:54.8799677Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:243:
2025-11-09T23:42:54.8799791Z  
2025-11-09T23:42:54.8800135Z          // Process JSON-RPC request (reuse server instance with cached handlers)
2025-11-09T23:42:54.8800488Z          let response = Self::process_request_with_server(server, &json_body).await;
2025-11-09T23:42:54.8800633Z -        let response_json =
2025-11-09T23:42:54.8800964Z -            serde_json::to_string(&response).unwrap_or_else(|_| "{}".to_string());
2025-11-09T23:42:54.8801394Z +        let response_json = serde_json::to_string(&response).unwrap_or_else(|_| "{}".to_string());
2025-11-09T23:42:54.8801508Z  
2025-11-09T23:42:54.8801652Z          // Build HTTP response
2025-11-09T23:42:54.8801809Z          Ok(Response::builder()
2025-11-09T23:42:54.8802260Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:255:
2025-11-09T23:42:54.8802387Z              .unwrap())
2025-11-09T23:42:54.8802509Z      }
2025-11-09T23:42:54.8802620Z  
2025-11-09T23:42:54.8802728Z -
2025-11-09T23:42:54.8802881Z      /// Create HTTP error response
2025-11-09T23:42:54.8803289Z      fn http_error_response(status: StatusCode, message: &str) -> Response<Full<Bytes>> {
2025-11-09T23:42:54.8803423Z          let body = json!({
2025-11-09T23:42:54.8803862Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:321:
2025-11-09T23:42:54.8804663Z      async fn call_method(&self, method: &str, params: Value) -> Result<Value, errors::RpcError> {
2025-11-09T23:42:54.8804800Z          match method {
2025-11-09T23:42:54.8804942Z              // Blockchain methods
2025-11-09T23:42:54.8805099Z -            "getblockchaininfo" => {
2025-11-09T23:42:54.8805250Z -                self.blockchain
2025-11-09T23:42:54.8805412Z -                    .get_blockchain_info()
2025-11-09T23:42:54.8805537Z -                    .await
2025-11-09T23:42:54.8805829Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:42:54.8805947Z -            }
2025-11-09T23:42:54.8806123Z +            "getblockchaininfo" => self
2025-11-09T23:42:54.8806256Z +                .blockchain
2025-11-09T23:42:54.8806406Z +                .get_blockchain_info()
2025-11-09T23:42:54.8808546Z +                .await
2025-11-09T23:42:54.8808812Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:42:54.8808956Z              "getblock" => {
2025-11-09T23:42:54.8809238Z                  let hash = params.get(0).and_then(|p| p.as_str()).unwrap_or("");
2025-11-09T23:42:54.8809386Z                  self.blockchain
2025-11-09T23:42:54.8809814Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:349:
2025-11-09T23:42:54.8809935Z                      .await
2025-11-09T23:42:54.8810435Z                      .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:42:54.8821501Z              }
2025-11-09T23:42:54.8821712Z -            "getbestblockhash" => {
2025-11-09T23:42:54.8821858Z -                self.blockchain
2025-11-09T23:42:54.8822022Z -                    .get_best_block_hash()
2025-11-09T23:42:54.8822153Z -                    .await
2025-11-09T23:42:54.8822462Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:42:54.8822586Z -            }
2025-11-09T23:42:54.8822736Z -            "getblockcount" => {
2025-11-09T23:42:54.8822905Z -                self.blockchain
2025-11-09T23:42:54.8823049Z -                    .get_block_count()
2025-11-09T23:42:54.8823175Z -                    .await
2025-11-09T23:42:54.8823450Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:42:54.8823576Z -            }
2025-11-09T23:42:54.8823732Z -            "getdifficulty" => {
2025-11-09T23:42:54.8823875Z -                self.blockchain
2025-11-09T23:42:54.8824030Z -                    .get_difficulty()
2025-11-09T23:42:54.8824152Z -                    .await
2025-11-09T23:42:54.8826507Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:42:54.8826637Z -            }
2025-11-09T23:42:54.8826806Z -            "gettxoutsetinfo" => {
2025-11-09T23:42:54.8826946Z -                self.blockchain
2025-11-09T23:42:54.8827098Z -                    .get_txoutset_info()
2025-11-09T23:42:54.8827223Z -                    .await
2025-11-09T23:42:54.8827485Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:42:54.8827593Z -            }
2025-11-09T23:42:54.8827743Z +            "getbestblockhash" => self
2025-11-09T23:42:54.8827869Z +                .blockchain
2025-11-09T23:42:54.8828004Z +                .get_best_block_hash()
2025-11-09T23:42:54.8828120Z +                .await
2025-11-09T23:42:54.8828386Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:42:54.8828523Z +            "getblockcount" => self
2025-11-09T23:42:54.8828640Z +                .blockchain
2025-11-09T23:42:54.8829009Z +                .get_block_count()
2025-11-09T23:42:54.8829125Z +                .await
2025-11-09T23:42:54.8829367Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:42:54.8829501Z +            "getdifficulty" => self
2025-11-09T23:42:54.8829634Z +                .blockchain
2025-11-09T23:42:54.8829774Z +                .get_difficulty()
2025-11-09T23:42:54.8830125Z +                .await
2025-11-09T23:42:54.8830392Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:42:54.8830539Z +            "gettxoutsetinfo" => self
2025-11-09T23:42:54.8830658Z +                .blockchain
2025-11-09T23:42:54.8830800Z +                .get_txoutset_info()
2025-11-09T23:42:54.8830923Z +                .await
2025-11-09T23:42:54.8831177Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:42:54.8831311Z              "verifychain" => {
2025-11-09T23:42:54.8831560Z                  let checklevel = params.get(0).and_then(|p| p.as_u64());
2025-11-09T23:42:54.8831803Z                  let numblocks = params.get(1).and_then(|p| p.as_u64());
2025-11-09T23:42:54.8832257Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:381:
2025-11-09T23:42:54.8832391Z                      .await
2025-11-09T23:42:54.8832662Z                      .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:42:54.8832792Z              }
2025-11-09T23:42:54.8832952Z -            "getchaintips" => {
2025-11-09T23:42:54.8833091Z -                self.blockchain
2025-11-09T23:42:54.8833240Z -                    .get_chain_tips()
2025-11-09T23:42:54.8833364Z -                    .await
2025-11-09T23:42:54.8833917Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:42:54.8834059Z -            }
2025-11-09T23:42:54.8834216Z -            "getchaintxstats" => {
2025-11-09T23:42:54.8836827Z -                self.blockchain
2025-11-09T23:42:54.8837028Z -                    .get_chain_tx_stats(&params)
2025-11-09T23:42:54.8837156Z -                    .await
2025-11-09T23:42:54.8837437Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:42:54.8837563Z -            }
2025-11-09T23:42:54.8837762Z -            "getblockstats" => {
2025-11-09T23:42:54.8837923Z -                self.blockchain
2025-11-09T23:42:54.8838095Z -                    .get_block_stats(&params)
2025-11-09T23:42:54.8838227Z -                    .await
2025-11-09T23:42:54.8838498Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:42:54.8838614Z -            }
2025-11-09T23:42:54.8838777Z -            "pruneblockchain" => {
2025-11-09T23:42:54.8838924Z -                self.blockchain
2025-11-09T23:42:54.8839092Z -                    .prune_blockchain(&params)
2025-11-09T23:42:54.8839223Z -                    .await
2025-11-09T23:42:54.8839488Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:42:54.8839605Z -            }
2025-11-09T23:42:54.8839746Z -            "getpruneinfo" => {
2025-11-09T23:42:54.8839892Z -                self.blockchain
2025-11-09T23:42:54.8840050Z -                    .get_prune_info(&params)
2025-11-09T23:42:54.8840172Z -                    .await
2025-11-09T23:42:54.8840460Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:42:54.8840576Z -            }
2025-11-09T23:42:54.8840722Z -            "invalidateblock" => {
2025-11-09T23:42:54.8840865Z -                self.blockchain
2025-11-09T23:42:54.8841027Z -                    .invalidate_block(&params)
2025-11-09T23:42:54.8841150Z -                    .await
2025-11-09T23:42:54.8841420Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:42:54.8841548Z -            }
2025-11-09T23:42:54.8841696Z -            "reconsiderblock" => {
2025-11-09T23:42:54.8841831Z -                self.blockchain
2025-11-09T23:42:54.8841993Z -                    .reconsider_block(&params)
2025-11-09T23:42:54.8842116Z -                    .await
2025-11-09T23:42:54.8842373Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:42:54.8842491Z -            }
2025-11-09T23:42:54.8842646Z -            "waitfornewblock" => {
2025-11-09T23:42:54.8843034Z -                self.blockchain
2025-11-09T23:42:54.8843199Z -                    .wait_for_new_block(&params)
2025-11-09T23:42:54.8843328Z -                    .await
2025-11-09T23:42:54.8843588Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:42:54.8843707Z -            }
2025-11-09T23:42:54.8843859Z -            "waitforblock" => {
2025-11-09T23:42:54.8844006Z -                self.blockchain
2025-11-09T23:42:54.8844169Z -                    .wait_for_block(&params)
2025-11-09T23:42:54.8844450Z -                    .await
2025-11-09T23:42:54.8844742Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:42:54.8844864Z -            }
2025-11-09T23:42:54.8846792Z -            "waitforblockheight" => {
2025-11-09T23:42:54.8846940Z -                self.blockchain
2025-11-09T23:42:54.8847118Z -                    .wait_for_block_height(&params)
2025-11-09T23:42:54.8847242Z -                    .await
2025-11-09T23:42:54.8847530Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:42:54.8847657Z -            }
2025-11-09T23:42:54.8847802Z +            "getchaintips" => self
2025-11-09T23:42:54.8847930Z +                .blockchain
2025-11-09T23:42:54.8848077Z +                .get_chain_tips()
2025-11-09T23:42:54.8848427Z +                .await
2025-11-09T23:42:54.8848735Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:42:54.8848891Z +            "getchaintxstats" => self
2025-11-09T23:42:54.8849030Z +                .blockchain
2025-11-09T23:42:54.8849188Z +                .get_chain_tx_stats(&params)
2025-11-09T23:42:54.8849312Z +                .await
2025-11-09T23:42:54.8849586Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:42:54.8849737Z +            "getblockstats" => self
2025-11-09T23:42:54.8849866Z +                .blockchain
2025-11-09T23:42:54.8850034Z +                .get_block_stats(&params)
2025-11-09T23:42:54.8850163Z +                .await
2025-11-09T23:42:54.8850426Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:42:54.8850585Z +            "pruneblockchain" => self
2025-11-09T23:42:54.8850726Z +                .blockchain
2025-11-09T23:42:54.8850899Z +                .prune_blockchain(&params)
2025-11-09T23:42:54.8851023Z +                .await
2025-11-09T23:42:54.8851292Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:42:54.8851440Z +            "getpruneinfo" => self
2025-11-09T23:42:54.8851569Z +                .blockchain
2025-11-09T23:42:54.8851721Z +                .get_prune_info(&params)
2025-11-09T23:42:54.8851851Z +                .await
2025-11-09T23:42:54.8852114Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:42:54.8852266Z +            "invalidateblock" => self
2025-11-09T23:42:54.8852410Z +                .blockchain
2025-11-09T23:42:54.8852564Z +                .invalidate_block(&params)
2025-11-09T23:42:54.8852682Z +                .await
2025-11-09T23:42:54.8852938Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:42:54.8853097Z +            "reconsiderblock" => self
2025-11-09T23:42:54.8853222Z +                .blockchain
2025-11-09T23:42:54.8853378Z +                .reconsider_block(&params)
2025-11-09T23:42:54.8853506Z +                .await
2025-11-09T23:42:54.8853756Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:42:54.8853909Z +            "waitfornewblock" => self
2025-11-09T23:42:54.8854037Z +                .blockchain
2025-11-09T23:42:54.8854202Z +                .wait_for_new_block(&params)
2025-11-09T23:42:54.8854499Z +                .await
2025-11-09T23:42:54.8856598Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:42:54.8857033Z +            "waitforblock" => self
2025-11-09T23:42:54.8857168Z +                .blockchain
2025-11-09T23:42:54.8857323Z +                .wait_for_block(&params)
2025-11-09T23:42:54.8857453Z +                .await
2025-11-09T23:42:54.8857723Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:42:54.8857890Z +            "waitforblockheight" => self
2025-11-09T23:42:54.8858029Z +                .blockchain
2025-11-09T23:42:54.8858207Z +                .wait_for_block_height(&params)
2025-11-09T23:42:54.8858323Z +                .await
2025-11-09T23:42:54.8858582Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:42:54.8858702Z  
2025-11-09T23:42:54.8858846Z              // Raw Transaction methods
2025-11-09T23:42:54.8858992Z -            "getrawtransaction" => {
2025-11-09T23:42:54.8859197Z -                self.rawtx.getrawtransaction(&params).await
2025-11-09T23:42:54.8859313Z -            }
2025-11-09T23:42:54.8859470Z -            "sendrawtransaction" => {
2025-11-09T23:42:54.8859676Z -                self.rawtx.sendrawtransaction(&params).await
2025-11-09T23:42:54.8859795Z -            }
2025-11-09T23:42:54.8859945Z -            "testmempoolaccept" => {
2025-11-09T23:42:54.8860161Z -                self.rawtx.testmempoolaccept(&params).await
2025-11-09T23:42:54.8860275Z -            }
2025-11-09T23:42:54.8860625Z -            "decoderawtransaction" => {
2025-11-09T23:42:54.8860856Z -                self.rawtx.decoderawtransaction(&params).await
2025-11-09T23:42:54.8860973Z -            }
2025-11-09T23:42:54.8861123Z -            "gettxout" => {
2025-11-09T23:42:54.8861302Z -                self.rawtx.gettxout(&params).await
2025-11-09T23:42:54.8861418Z -            }
2025-11-09T23:42:54.8861551Z -            "gettxoutproof" => {
2025-11-09T23:42:54.8861745Z -                self.rawtx.gettxoutproof(&params).await
2025-11-09T23:42:54.8861860Z -            }
2025-11-09T23:42:54.8862003Z -            "verifytxoutproof" => {
2025-11-09T23:42:54.8862222Z -                self.rawtx.verifytxoutproof(&params).await
2025-11-09T23:42:54.8862336Z -            }
2025-11-09T23:42:54.8862664Z +            "getrawtransaction" => self.rawtx.getrawtransaction(&params).await,
2025-11-09T23:42:54.8863029Z +            "sendrawtransaction" => self.rawtx.sendrawtransaction(&params).await,
2025-11-09T23:42:54.8863382Z +            "testmempoolaccept" => self.rawtx.testmempoolaccept(&params).await,
2025-11-09T23:42:54.8863755Z +            "decoderawtransaction" => self.rawtx.decoderawtransaction(&params).await,
2025-11-09T23:42:54.8863976Z +            "gettxout" => self.rawtx.gettxout(&params).await,
2025-11-09T23:42:54.8864263Z +            "gettxoutproof" => self.rawtx.gettxoutproof(&params).await,
2025-11-09T23:42:54.8864754Z +            "verifytxoutproof" => self.rawtx.verifytxoutproof(&params).await,
2025-11-09T23:42:54.8864882Z  
2025-11-09T23:42:54.8865032Z              // Mempool methods
2025-11-09T23:42:54.8865183Z -            "getmempoolinfo" => {
2025-11-09T23:42:54.8865405Z -                self.mempool.getmempoolinfo(&params).await
2025-11-09T23:42:54.8865532Z -            }
2025-11-09T23:42:54.8865676Z -            "getrawmempool" => {
2025-11-09T23:42:54.8865875Z -                self.mempool.getrawmempool(&params).await
2025-11-09T23:42:54.8865993Z -            }
2025-11-09T23:42:54.8866150Z -            "savemempool" => {
2025-11-09T23:42:54.8866345Z -                self.mempool.savemempool(&params).await
2025-11-09T23:42:54.8866462Z -            }
2025-11-09T23:42:54.8866624Z -            "getmempoolancestors" => {
2025-11-09T23:42:54.8868683Z -                self.mempool.getmempoolancestors(&params).await
2025-11-09T23:42:54.8868801Z -            }
2025-11-09T23:42:54.8868964Z -            "getmempooldescendants" => {
2025-11-09T23:42:54.8869222Z -                self.mempool.getmempooldescendants(&params).await
2025-11-09T23:42:54.8869339Z -            }
2025-11-09T23:42:54.8869490Z -            "getmempoolentry" => {
2025-11-09T23:42:54.8869975Z -                self.mempool.getmempoolentry(&params).await
2025-11-09T23:42:54.8870093Z -            }
2025-11-09T23:42:54.8870399Z +            "getmempoolinfo" => self.mempool.getmempoolinfo(&params).await,
2025-11-09T23:42:54.8870688Z +            "getrawmempool" => self.mempool.getrawmempool(&params).await,
2025-11-09T23:42:54.8870966Z +            "savemempool" => self.mempool.savemempool(&params).await,
2025-11-09T23:42:54.8871335Z +            "getmempoolancestors" => self.mempool.getmempoolancestors(&params).await,
2025-11-09T23:42:54.8871740Z +            "getmempooldescendants" => self.mempool.getmempooldescendants(&params).await,
2025-11-09T23:42:54.8872069Z +            "getmempoolentry" => self.mempool.getmempoolentry(&params).await,
2025-11-09T23:42:54.8872188Z  
2025-11-09T23:42:54.8872327Z              // Network methods
2025-11-09T23:42:54.8872478Z -            "getnetworkinfo" => {
2025-11-09T23:42:54.8872661Z -                self.network.get_network_info().await
2025-11-09T23:42:54.8872790Z -            }
2025-11-09T23:42:54.8872926Z -            "getpeerinfo" => {
2025-11-09T23:42:54.8873108Z -                self.network.get_peer_info().await
2025-11-09T23:42:54.8873222Z -            }
2025-11-09T23:42:54.8873368Z -            "getconnectioncount" => {
2025-11-09T23:42:54.8873597Z -                self.network.get_connection_count(&params).await
2025-11-09T23:42:54.8873916Z -            }
2025-11-09T23:42:54.8874063Z -            "ping" => {
2025-11-09T23:42:54.8874241Z -                self.network.ping(&params).await
2025-11-09T23:42:54.8874541Z -            }
2025-11-09T23:42:54.8874677Z -            "addnode" => {
2025-11-09T23:42:54.8874859Z -                self.network.add_node(&params).await
2025-11-09T23:42:54.8874989Z -            }
2025-11-09T23:42:54.8875136Z -            "disconnectnode" => {
2025-11-09T23:42:54.8875344Z -                self.network.disconnect_node(&params).await
2025-11-09T23:42:54.8875462Z -            }
2025-11-09T23:42:54.8875626Z -            "getnettotals" => {
2025-11-09T23:42:54.8875826Z -                self.network.get_net_totals(&params).await
2025-11-09T23:42:54.8877515Z -            }
2025-11-09T23:42:54.8877662Z -            "clearbanned" => {
2025-11-09T23:42:54.8877849Z -                self.network.clear_banned(&params).await
2025-11-09T23:42:54.8877963Z -            }
2025-11-09T23:42:54.8878111Z -            "setban" => {
2025-11-09T23:42:54.8878291Z -                self.network.set_ban(&params).await
2025-11-09T23:42:54.8878404Z -            }
2025-11-09T23:42:54.8878542Z -            "listbanned" => {
2025-11-09T23:42:54.8878743Z -                self.network.list_banned(&params).await
2025-11-09T23:42:54.8878860Z -            }
2025-11-09T23:42:54.8879010Z -            "getaddednodeinfo" => {
2025-11-09T23:42:54.8879237Z -                self.network.getaddednodeinfo(&params).await
2025-11-09T23:42:54.8879355Z -            }
2025-11-09T23:42:54.8879499Z -            "getnodeaddresses" => {
2025-11-09T23:42:54.8879721Z -                self.network.getnodeaddresses(&params).await
2025-11-09T23:42:54.8879845Z -            }
2025-11-09T23:42:54.8879991Z -            "setnetworkactive" => {
2025-11-09T23:42:54.8880199Z -                self.network.setnetworkactive(&params).await
2025-11-09T23:42:54.8880325Z -            }
2025-11-09T23:42:54.8880605Z +            "getnetworkinfo" => self.network.get_network_info().await,
2025-11-09T23:42:54.8880835Z +            "getpeerinfo" => self.network.get_peer_info().await,
2025-11-09T23:42:54.8881197Z +            "getconnectioncount" => self.network.get_connection_count(&params).await,
2025-11-09T23:42:54.8881398Z +            "ping" => self.network.ping(&params).await,
2025-11-09T23:42:54.8881611Z +            "addnode" => self.network.add_node(&params).await,
2025-11-09T23:42:54.8881914Z +            "disconnectnode" => self.network.disconnect_node(&params).await,
2025-11-09T23:42:54.8882198Z +            "getnettotals" => self.network.get_net_totals(&params).await,
2025-11-09T23:42:54.8882713Z +            "clearbanned" => self.network.clear_banned(&params).await,
2025-11-09T23:42:54.8882923Z +            "setban" => self.network.set_ban(&params).await,
2025-11-09T23:42:54.8883181Z +            "listbanned" => self.network.list_banned(&params).await,
2025-11-09T23:42:54.8883519Z +            "getaddednodeinfo" => self.network.getaddednodeinfo(&params).await,
2025-11-09T23:42:54.8883856Z +            "getnodeaddresses" => self.network.getnodeaddresses(&params).await,
2025-11-09T23:42:54.8884189Z +            "setnetworkactive" => self.network.setnetworkactive(&params).await,
2025-11-09T23:42:54.8884478Z  
2025-11-09T23:42:54.8884627Z              // Mining methods
2025-11-09T23:42:54.8884778Z -            "getmininginfo" => {
2025-11-09T23:42:54.8884967Z -                self.mining.get_mining_info().await
2025-11-09T23:42:54.8885081Z -            }
2025-11-09T23:42:54.8885233Z -            "getblocktemplate" => {
2025-11-09T23:42:54.8885463Z -                self.mining.get_block_template(&params).await
2025-11-09T23:42:54.8885588Z -            }
2025-11-09T23:42:54.8885726Z -            "submitblock" => {
2025-11-09T23:42:54.8885910Z -                self.mining.submit_block(&params).await
2025-11-09T23:42:54.8886023Z -            }
2025-11-09T23:42:54.8886161Z -            "estimatesmartfee" => {
2025-11-09T23:42:54.8886586Z -                self.mining.estimate_smart_fee(&params).await
2025-11-09T23:42:54.8886707Z -            }
2025-11-09T23:42:54.8886866Z -            "prioritisetransaction" => {
2025-11-09T23:42:54.8887085Z -                self.mining.prioritise_transaction(&params).await
2025-11-09T23:42:54.8887192Z -            }
2025-11-09T23:42:54.8887336Z -            "getblockfilter" => {
2025-11-09T23:42:54.8887475Z -                self.blockchain
2025-11-09T23:42:54.8887640Z -                    .get_block_filter(&params)
2025-11-09T23:42:54.8887766Z -                    .await
2025-11-09T23:42:54.8888043Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:42:54.8888165Z -            }
2025-11-09T23:42:54.8888298Z -            "getindexinfo" => {
2025-11-09T23:42:54.8888432Z -                self.blockchain
2025-11-09T23:42:54.8888579Z -                    .get_index_info(&params)
2025-11-09T23:42:54.8888696Z -                    .await
2025-11-09T23:42:54.8888961Z -                    .map_err(|e| errors::RpcError::internal_error(e.to_string()))
2025-11-09T23:42:54.8889069Z -            }
2025-11-09T23:42:54.8889307Z +            "getmininginfo" => self.mining.get_mining_info().await,
2025-11-09T23:42:54.8889625Z +            "getblocktemplate" => self.mining.get_block_template(&params).await,
2025-11-09T23:42:54.8889866Z +            "submitblock" => self.mining.submit_block(&params).await,
2025-11-09T23:42:54.8890167Z +            "estimatesmartfee" => self.mining.estimate_smart_fee(&params).await,
2025-11-09T23:42:54.8890608Z +            "prioritisetransaction" => self.mining.prioritise_transaction(&params).await,
2025-11-09T23:42:54.8890788Z +            "getblockfilter" => self
2025-11-09T23:42:54.8890918Z +                .blockchain
2025-11-09T23:42:54.8891075Z +                .get_block_filter(&params)
2025-11-09T23:42:54.8891203Z +                .await
2025-11-09T23:42:54.8891465Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:42:54.8891608Z +            "getindexinfo" => self
2025-11-09T23:42:54.8891738Z +                .blockchain
2025-11-09T23:42:54.8891875Z +                .get_index_info(&params)
2025-11-09T23:42:54.8891991Z +                .await
2025-11-09T23:42:54.8892247Z +                .map_err(|e| errors::RpcError::internal_error(e.to_string())),
2025-11-09T23:42:54.8892368Z  
2025-11-09T23:42:54.8892501Z              // Control methods
2025-11-09T23:42:54.8892629Z -            "stop" => {
2025-11-09T23:42:54.8892812Z -                self.control.stop(&params).await
2025-11-09T23:42:54.8892927Z -            }
2025-11-09T23:42:54.8893060Z -            "uptime" => {
2025-11-09T23:42:54.8893479Z -                self.control.uptime(&params).await
2025-11-09T23:42:54.8893607Z -            }
2025-11-09T23:42:54.8893753Z -            "getmemoryinfo" => {
2025-11-09T23:42:54.8893958Z -                self.control.getmemoryinfo(&params).await
2025-11-09T23:42:54.8894082Z -            }
2025-11-09T23:42:54.8894221Z -            "getrpcinfo" => {
2025-11-09T23:42:54.8894636Z -                self.control.getrpcinfo(&params).await
2025-11-09T23:42:54.8894761Z -            }
2025-11-09T23:42:54.8894898Z -            "help" => {
2025-11-09T23:42:54.8895076Z -                self.control.help(&params).await
2025-11-09T23:42:54.8895199Z -            }
2025-11-09T23:42:54.8895334Z -            "logging" => {
2025-11-09T23:42:54.8895513Z -                self.control.logging(&params).await
2025-11-09T23:42:54.8895626Z -            }
2025-11-09T23:42:54.8895761Z -            "gethealth" => {
2025-11-09T23:42:54.8895951Z -                self.control.gethealth(&params).await
2025-11-09T23:42:54.8896074Z -            }
2025-11-09T23:42:54.8896212Z -            "getmetrics" => {
2025-11-09T23:42:54.8896410Z -                self.control.getmetrics(&params).await
2025-11-09T23:42:54.8896525Z -            }
2025-11-09T23:42:54.8896719Z +            "stop" => self.control.stop(&params).await,
2025-11-09T23:42:54.8896922Z +            "uptime" => self.control.uptime(&params).await,
2025-11-09T23:42:54.8897447Z +            "getmemoryinfo" => self.control.getmemoryinfo(&params).await,
2025-11-09T23:42:54.8897722Z +            "getrpcinfo" => self.control.getrpcinfo(&params).await,
2025-11-09T23:42:54.8897920Z +            "help" => self.control.help(&params).await,
2025-11-09T23:42:54.8898147Z +            "logging" => self.control.logging(&params).await,
2025-11-09T23:42:54.8898380Z +            "gethealth" => self.control.gethealth(&params).await,
2025-11-09T23:42:54.8898625Z +            "getmetrics" => self.control.getmetrics(&params).await,
2025-11-09T23:42:54.8898749Z  
2025-11-09T23:42:54.8898986Z              _ => Err(errors::RpcError::method_not_found(method)),
2025-11-09T23:42:54.8899098Z          }
2025-11-09T23:42:54.8899561Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:605:
2025-11-09T23:42:54.8899729Z          // Start server on random port
2025-11-09T23:42:54.8900070Z          let listener = tokio::net::TcpListener::bind("127.0.0.1:0").await.unwrap();
2025-11-09T23:42:54.8900284Z          let server_addr = listener.local_addr().unwrap();
2025-11-09T23:42:54.8900410Z -        
2025-11-09T23:42:54.8900522Z +
2025-11-09T23:42:54.8900683Z          // Spawn server task using hyper
2025-11-09T23:42:54.8900891Z          let server_handle = tokio::spawn(async move {
2025-11-09T23:42:54.8901008Z              loop {
2025-11-09T23:42:54.8901435Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:617:
2025-11-09T23:42:54.8901611Z                              let service = service_fn(move |req| {
2025-11-09T23:42:54.8901863Z                                  RpcServer::handle_http_request(req, peer_addr)
2025-11-09T23:42:54.8901998Z                              });
2025-11-09T23:42:54.8902168Z -                            let _ = http1::Builder::new()
2025-11-09T23:42:54.8902345Z -                                .serve_connection(io, service)
2025-11-09T23:42:54.8902473Z -                                .await;
2025-11-09T23:42:54.8902770Z +                            let _ = http1::Builder::new().serve_connection(io, service).await;
2025-11-09T23:42:54.8902908Z                          });
2025-11-09T23:42:54.8903026Z                      }
2025-11-09T23:42:54.8903161Z                      Err(_) => break,
2025-11-09T23:42:54.8903600Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:632:
2025-11-09T23:42:54.8903716Z  
2025-11-09T23:42:54.8903849Z          // Connect to server
2025-11-09T23:42:54.8904173Z          let mut client = TokioTcpStream::connect(server_addr).await.unwrap();
2025-11-09T23:42:54.8904764Z -        
2025-11-09T23:42:54.8904876Z +
2025-11-09T23:42:54.8905036Z          // Send HTTP POST request
2025-11-09T23:42:54.8905342Z          let json_body = r#"{"jsonrpc":"2.0","method":"ping","params":[],"id":1}"#;
2025-11-09T23:42:54.8905495Z          let http_request = format!(
2025-11-09T23:42:54.8905962Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:645:
2025-11-09T23:42:54.8906105Z              json_body.len(),
2025-11-09T23:42:54.8906239Z              json_body
2025-11-09T23:42:54.8906352Z          );
2025-11-09T23:42:54.8906462Z -        
2025-11-09T23:42:54.8906581Z +
2025-11-09T23:42:54.8906839Z          client.write_all(http_request.as_bytes()).await.unwrap();
2025-11-09T23:42:54.8906948Z -        
2025-11-09T23:42:54.8907059Z +
2025-11-09T23:42:54.8907199Z          // Read response
2025-11-09T23:42:54.8907355Z          let mut response = vec![0u8; 4096];
2025-11-09T23:42:54.8907513Z          let n = tokio::time::timeout(
2025-11-09T23:42:54.8907942Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:654:
2025-11-09T23:42:54.8908108Z              tokio::time::Duration::from_secs(2),
2025-11-09T23:42:54.8908262Z -            client.read(&mut response)
2025-11-09T23:42:54.8908410Z -        ).await.unwrap().unwrap();
2025-11-09T23:42:54.8908527Z -        
2025-11-09T23:42:54.8908900Z +            client.read(&mut response),
2025-11-09T23:42:54.8909033Z +        )
2025-11-09T23:42:54.8909156Z +        .await
2025-11-09T23:42:54.8909275Z +        .unwrap()
2025-11-09T23:42:54.8909397Z +        .unwrap();
2025-11-09T23:42:54.8909507Z +
2025-11-09T23:42:54.8909795Z          let response_str = String::from_utf8_lossy(&response[..n]);
2025-11-09T23:42:54.8909909Z -        
2025-11-09T23:42:54.8910023Z +
2025-11-09T23:42:54.8910257Z          // Verify HTTP response (hyper uses lowercase headers)
2025-11-09T23:42:54.8910804Z -        assert!(response_str.contains("HTTP/1.1 200 OK") || response_str.contains("200 OK"), "Response: {}", response_str);
2025-11-09T23:42:54.8911448Z -        assert!(response_str.contains("content-type: application/json") || response_str.contains("Content-Type: application/json"));
2025-11-09T23:42:54.8911594Z +        assert!(
2025-11-09T23:42:54.8911949Z +            response_str.contains("HTTP/1.1 200 OK") || response_str.contains("200 OK"),
2025-11-09T23:42:54.8912097Z +            "Response: {}",
2025-11-09T23:42:54.8912221Z +            response_str
2025-11-09T23:42:54.8912341Z +        );
2025-11-09T23:42:54.8912461Z +        assert!(
2025-11-09T23:42:54.8912716Z +            response_str.contains("content-type: application/json")
2025-11-09T23:42:54.8912991Z +                || response_str.contains("Content-Type: application/json")
2025-11-09T23:42:54.8913106Z +        );
2025-11-09T23:42:54.8913287Z          assert!(response_str.contains("jsonrpc"));
2025-11-09T23:42:54.8913482Z          assert!(response_str.contains("\"result\""));
2025-11-09T23:42:54.8913605Z -        
2025-11-09T23:42:54.8913890Z +
2025-11-09T23:42:54.8914044Z          server_handle.abort();
2025-11-09T23:42:54.8914161Z      }
2025-11-09T23:42:54.8914273Z  
2025-11-09T23:42:54.8914923Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:669:
2025-11-09T23:42:54.8915045Z -
2025-11-09T23:42:54.8915196Z      #[tokio::test]
2025-11-09T23:42:54.8915396Z      async fn test_process_request_valid_json() {
2025-11-09T23:42:54.8915757Z          let request = r#"{"jsonrpc":"2.0","method":"getblockchaininfo","params":[],"id":1}"#;
2025-11-09T23:42:54.8916233Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:684:
2025-11-09T23:42:54.8916349Z  
2025-11-09T23:42:54.8916524Z          assert_eq!(response["jsonrpc"], "2.0");
2025-11-09T23:42:54.8916740Z          assert_eq!(response["error"]["code"], -32700);
2025-11-09T23:42:54.8917110Z -        assert!(response["error"]["message"].as_str().unwrap().contains("Parse error") || 
2025-11-09T23:42:54.8917698Z -                response["error"]["message"].as_str().unwrap().contains("Invalid JSON"));
2025-11-09T23:42:54.8917830Z +        assert!(
2025-11-09T23:42:54.8917996Z +            response["error"]["message"]
2025-11-09T23:42:54.8918124Z +                .as_str()
2025-11-09T23:42:54.8918252Z +                .unwrap()
2025-11-09T23:42:54.8918415Z +                .contains("Parse error")
2025-11-09T23:42:54.8918584Z +                || response["error"]["message"]
2025-11-09T23:42:54.8918716Z +                    .as_str()
2025-11-09T23:42:54.8918844Z +                    .unwrap()
2025-11-09T23:42:54.8919010Z +                    .contains("Invalid JSON")
2025-11-09T23:42:54.8919120Z +        );
2025-11-09T23:42:54.8919231Z      }
2025-11-09T23:42:54.8919347Z  
2025-11-09T23:42:54.8919483Z      #[tokio::test]
2025-11-09T23:42:54.8919944Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:695:
2025-11-09T23:42:54.8920061Z  
2025-11-09T23:42:54.8920237Z          assert_eq!(response["jsonrpc"], "2.0");
2025-11-09T23:42:54.8920451Z          assert_eq!(response["error"]["code"], -32601);
2025-11-09T23:42:54.8920832Z -        assert!(response["error"]["message"].as_str().unwrap().contains("Method not found"));
2025-11-09T23:42:54.8921010Z +        assert!(response["error"]["message"]
2025-11-09T23:42:54.8921134Z +            .as_str()
2025-11-09T23:42:54.8921460Z +            .unwrap()
2025-11-09T23:42:54.8921646Z +            .contains("Method not found"));
2025-11-09T23:42:54.8921801Z          assert_eq!(response["id"], 1);
2025-11-09T23:42:54.8921915Z      }
2025-11-09T23:42:54.8922023Z  
2025-11-09T23:42:54.8922474Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:822:
2025-11-09T23:42:54.8922585Z  
2025-11-09T23:42:54.8922751Z          assert_eq!(response["jsonrpc"], "2.0");
2025-11-09T23:42:54.8922947Z          assert_eq!(response["error"]["code"], -32700);
2025-11-09T23:42:54.8923296Z -        assert!(response["error"]["message"].as_str().unwrap().contains("Parse error") ||
2025-11-09T23:42:54.8923618Z -                response["error"]["message"].as_str().unwrap().contains("Invalid JSON"));
2025-11-09T23:42:54.8923733Z +        assert!(
2025-11-09T23:42:54.8923888Z +            response["error"]["message"]
2025-11-09T23:42:54.8924008Z +                .as_str()
2025-11-09T23:42:54.8924130Z +                .unwrap()
2025-11-09T23:42:54.8924481Z +                .contains("Parse error")
2025-11-09T23:42:54.8924654Z +                || response["error"]["message"]
2025-11-09T23:42:54.8924788Z +                    .as_str()
2025-11-09T23:42:54.8924916Z +                    .unwrap()
2025-11-09T23:42:54.8925084Z +                    .contains("Invalid JSON")
2025-11-09T23:42:54.8925201Z +        );
2025-11-09T23:42:54.8925317Z      }
2025-11-09T23:42:54.8925436Z  
2025-11-09T23:42:54.8925572Z      #[tokio::test]
2025-11-09T23:42:54.8926020Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:833:
2025-11-09T23:42:54.8926142Z  
2025-11-09T23:42:54.8926319Z          assert_eq!(response["jsonrpc"], "2.0");
2025-11-09T23:42:54.8926518Z          assert_eq!(response["error"]["code"], -32601);
2025-11-09T23:42:54.8926897Z -        assert!(response["error"]["message"].as_str().unwrap().contains("Method not found"));
2025-11-09T23:42:54.8927072Z +        assert!(response["error"]["message"]
2025-11-09T23:42:54.8927203Z +            .as_str()
2025-11-09T23:42:54.8927329Z +            .unwrap()
2025-11-09T23:42:54.8927490Z +            .contains("Method not found"));
2025-11-09T23:42:54.8927850Z          assert!(response["error"]["data"].is_string() || response["error"]["data"].is_null());
2025-11-09T23:42:54.8928000Z          assert_eq!(response["id"], 42);
2025-11-09T23:42:54.8928111Z      }
2025-11-09T23:42:54.8928560Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/rpc/server.rs:855:
2025-11-09T23:42:54.8928673Z  
2025-11-09T23:42:54.8928835Z          assert_eq!(response["jsonrpc"], "2.0");
2025-11-09T23:42:54.8929329Z          assert_eq!(response["error"]["code"], -32601);
2025-11-09T23:42:54.8929700Z -        assert!(response["error"]["message"].as_str().unwrap().contains("Method not found"));
2025-11-09T23:42:54.8929863Z +        assert!(response["error"]["message"]
2025-11-09T23:42:54.8929989Z +            .as_str()
2025-11-09T23:42:54.8930106Z +            .unwrap()
2025-11-09T23:42:54.8930274Z +            .contains("Method not found"));
2025-11-09T23:42:54.8930423Z          assert_eq!(response["id"], 1);
2025-11-09T23:42:54.8930534Z      }
2025-11-09T23:42:54.8930641Z  
2025-11-09T23:42:54.8931210Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/blockstore.rs:2:
2025-11-09T23:42:54.8931319Z  //!
2025-11-09T23:42:54.8931576Z  //! Stores blocks by hash and maintains block index by height.
2025-11-09T23:42:54.8931688Z  
2025-11-09T23:42:54.8931901Z +use crate::storage::database::{Database, Tree};
2025-11-09T23:42:54.8932037Z  use anyhow::Result;
2025-11-09T23:42:54.8932220Z  use bllvm_protocol::segwit::Witness;
2025-11-09T23:42:54.8932417Z  use bllvm_protocol::{Block, BlockHeader, Hash};
2025-11-09T23:42:54.8932902Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/blockstore.rs:8:
2025-11-09T23:42:54.8933102Z -use crate::storage::database::{Database, Tree};
2025-11-09T23:42:54.8933235Z  use std::sync::Arc;
2025-11-09T23:42:54.8933571Z  
2025-11-09T23:42:54.8933734Z  /// Block storage manager
2025-11-09T23:42:54.8934235Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/blockstore.rs:45:
2025-11-09T23:42:54.8934536Z  
2025-11-09T23:42:54.8934796Z          self.blocks.insert(block_hash.as_slice(), &block_data)?;
2025-11-09T23:42:54.8935045Z          let header_data = bincode::serialize(&block.header)?;
2025-11-09T23:42:54.8935181Z -        self.headers
2025-11-09T23:42:54.8935378Z -            .insert(block_hash.as_slice(), &header_data)?;
2025-11-09T23:42:54.8935645Z +        self.headers.insert(block_hash.as_slice(), &header_data)?;
2025-11-09T23:42:54.8935764Z  
2025-11-09T23:42:54.8935981Z          // Store header for median time-past calculation
2025-11-09T23:42:54.8936353Z          // We'll need height passed separately, so this will be called after store_height
2025-11-09T23:42:54.8936855Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/blockstore.rs:81:
2025-11-09T23:42:54.8937025Z      /// Store witness data for a block
2025-11-09T23:42:54.8937398Z      pub fn store_witness(&self, block_hash: &Hash, witness: &[Witness]) -> Result<()> {
2025-11-09T23:42:54.8937618Z          let witness_data = bincode::serialize(witness)?;
2025-11-09T23:42:54.8937901Z -        self.witnesses.insert(block_hash.as_slice(), &witness_data)?;
2025-11-09T23:42:54.8938026Z +        self.witnesses
2025-11-09T23:42:54.8938225Z +            .insert(block_hash.as_slice(), &witness_data)?;
2025-11-09T23:42:54.8938345Z          Ok(())
2025-11-09T23:42:54.8938465Z      }
2025-11-09T23:42:54.8938576Z  
2025-11-09T23:42:54.8939024Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/chainstate.rs:2:
2025-11-09T23:42:54.8939136Z  //!
2025-11-09T23:42:54.8939444Z  //! Stores chain metadata including tip, height, and chain parameters.
2025-11-09T23:42:54.8939556Z  
2025-11-09T23:42:54.8939749Z +use crate::storage::database::{Database, Tree};
2025-11-09T23:42:54.8939891Z  use anyhow::Result;
2025-11-09T23:42:54.8940056Z  use bllvm_protocol::{BlockHeader, Hash};
2025-11-09T23:42:54.8940215Z  use serde::{Deserialize, Serialize};
2025-11-09T23:42:54.8940703Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/chainstate.rs:8:
2025-11-09T23:42:54.8940883Z -use crate::storage::database::{Database, Tree};
2025-11-09T23:42:54.8941006Z  use std::sync::Arc;
2025-11-09T23:42:54.8941123Z  
2025-11-09T23:42:54.8941256Z  /// Chain state information
2025-11-09T23:42:54.8941748Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/chainstate.rs:223:
2025-11-09T23:42:54.8942099Z      }
2025-11-09T23:42:54.8942218Z  
2025-11-09T23:42:54.8942388Z      /// Add a chain tip (for fork tracking)
2025-11-09T23:42:54.8942816Z -    pub fn add_chain_tip(&self, hash: &Hash, height: u64, branchlen: u64, status: &str) -> Result<()> {
2025-11-09T23:42:54.8942972Z +    pub fn add_chain_tip(
2025-11-09T23:42:54.8943095Z +        &self,
2025-11-09T23:42:54.8943230Z +        hash: &Hash,
2025-11-09T23:42:54.8943355Z +        height: u64,
2025-11-09T23:42:54.8943495Z +        branchlen: u64,
2025-11-09T23:42:54.8943621Z +        status: &str,
2025-11-09T23:42:54.8943746Z +    ) -> Result<()> {
2025-11-09T23:42:54.8943918Z          #[derive(Serialize, Deserialize)]
2025-11-09T23:42:54.8944050Z          struct TipInfo {
2025-11-09T23:42:54.8944179Z              height: u64,
2025-11-09T23:42:54.8944862Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/chainstate.rs:230:
2025-11-09T23:42:54.8945018Z              branchlen: u64,
2025-11-09T23:42:54.8945159Z              status: String,
2025-11-09T23:42:54.8945271Z          }
2025-11-09T23:42:54.8945392Z -        
2025-11-09T23:42:54.8945502Z +
2025-11-09T23:42:54.8945651Z          let tip_info = TipInfo {
2025-11-09T23:42:54.8945770Z              height,
2025-11-09T23:42:54.8945897Z              branchlen,
2025-11-09T23:42:54.8946599Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/chainstate.rs:255:
2025-11-09T23:42:54.8946748Z              branchlen: u64,
2025-11-09T23:42:54.8946881Z              status: String,
2025-11-09T23:42:54.8946995Z          }
2025-11-09T23:42:54.8947107Z -        
2025-11-09T23:42:54.8947218Z +
2025-11-09T23:42:54.8947372Z          let mut tips = Vec::new();
2025-11-09T23:42:54.8947536Z          for result in self.chain_tips.iter() {
2025-11-09T23:42:54.8947672Z              let (key, data) = result?;
2025-11-09T23:42:54.8948179Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/commitment_store.rs:4:
2025-11-09T23:42:54.8948343Z  //! without requiring full block history.
2025-11-09T23:42:54.8948446Z  
2025-11-09T23:42:54.8948596Z  #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.8948788Z +use crate::storage::database::{Database, Tree};
2025-11-09T23:42:54.8948935Z +#[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.8949060Z  use anyhow::Result;
2025-11-09T23:42:54.8949222Z  #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.8949531Z  use bllvm_protocol::utxo_commitments::data_structures::UtxoCommitment;
2025-11-09T23:42:54.8950049Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/commitment_store.rs:10:
2025-11-09T23:42:54.8950204Z  #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.8950361Z  use bllvm_protocol::Hash;
2025-11-09T23:42:54.8950554Z  #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.8950754Z -use crate::storage::database::{Database, Tree};
2025-11-09T23:42:54.8950908Z -#[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.8951039Z  use std::sync::Arc;
2025-11-09T23:42:54.8951146Z  
2025-11-09T23:42:54.8951296Z  /// UTXO Commitment storage manager
2025-11-09T23:42:54.8951800Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/commitment_store.rs:48:
2025-11-09T23:42:54.8952035Z          let commitment_data = bincode::serialize(commitment)?;
2025-11-09T23:42:54.8952146Z  
2025-11-09T23:42:54.8952282Z          // Store by block hash
2025-11-09T23:42:54.8952589Z -        self.commitments.insert(block_hash.as_slice(), commitment_data)?;
2025-11-09T23:42:54.8952718Z +        self.commitments
2025-11-09T23:42:54.8952930Z +            .insert(block_hash.as_slice(), commitment_data)?;
2025-11-09T23:42:54.8953034Z  
2025-11-09T23:42:54.8953266Z          // Store height index for quick lookup
2025-11-09T23:42:54.8953443Z          let height_bytes = height.to_be_bytes();
2025-11-09T23:42:54.8953947Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/commitment_store.rs:55:
2025-11-09T23:42:54.8956428Z -        self.height_index.insert(height_bytes, block_hash.as_slice())?;
2025-11-09T23:42:54.8956564Z +        self.height_index
2025-11-09T23:42:54.8956762Z +            .insert(height_bytes, block_hash.as_slice())?;
2025-11-09T23:42:54.8956866Z  
2025-11-09T23:42:54.8956976Z          Ok(())
2025-11-09T23:42:54.8957089Z      }
2025-11-09T23:42:54.8957608Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/commitment_store.rs:128:
2025-11-09T23:42:54.8957866Z          Err(anyhow::anyhow!("UTXO commitments feature not enabled"))
2025-11-09T23:42:54.8957977Z      }
2025-11-09T23:42:54.8958081Z  }
2025-11-09T23:42:54.8958193Z -
2025-11-09T23:42:54.8958301Z  
2025-11-09T23:42:54.8959524Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:7:
2025-11-09T23:42:54.8959730Z  use std::path::Path;
2025-11-09T23:42:54.8959849Z  
2025-11-09T23:42:54.8959996Z  /// Database abstraction trait
2025-11-09T23:42:54.8960107Z -/// 
2025-11-09T23:42:54.8960228Z +///
2025-11-09T23:42:54.8960527Z  /// Provides a unified interface for key-value storage operations
2025-11-09T23:42:54.8960781Z  /// that can be implemented by different backends (sled, redb).
2025-11-09T23:42:54.8960939Z  pub trait Database: Send + Sync {
2025-11-09T23:42:54.8961401Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:14:
2025-11-09T23:42:54.8961732Z      /// Open a named tree/table
2025-11-09T23:42:54.8961961Z      fn open_tree(&self, name: &str) -> Result<Box<dyn Tree>>;
2025-11-09T23:42:54.8962075Z -    
2025-11-09T23:42:54.8962179Z +
2025-11-09T23:42:54.8962325Z      /// Flush all pending writes
2025-11-09T23:42:54.8962470Z      fn flush(&self) -> Result<()>;
2025-11-09T23:42:54.8962592Z  }
2025-11-09T23:42:54.8963049Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:20:
2025-11-09T23:42:54.8963167Z  
2025-11-09T23:42:54.8963332Z  /// Tree/Table abstraction trait
2025-11-09T23:42:54.8963454Z -/// 
2025-11-09T23:42:54.8963566Z +///
2025-11-09T23:42:54.8964003Z  /// Represents a named collection of key-value pairs within a database.
2025-11-09T23:42:54.8964170Z  pub trait Tree: Send + Sync {
2025-11-09T23:42:54.8964500Z      /// Insert a key-value pair
2025-11-09T23:42:54.8966498Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:26:
2025-11-09T23:42:54.8966750Z      fn insert(&self, key: &[u8], value: &[u8]) -> Result<()>;
2025-11-09T23:42:54.8966867Z -    
2025-11-09T23:42:54.8966979Z +
2025-11-09T23:42:54.8967120Z      /// Get a value by key
2025-11-09T23:42:54.8967347Z      fn get(&self, key: &[u8]) -> Result<Option<Vec<u8>>>;
2025-11-09T23:42:54.8967457Z -    
2025-11-09T23:42:54.8967568Z +
2025-11-09T23:42:54.8967725Z      /// Remove a key-value pair
2025-11-09T23:42:54.8967900Z      fn remove(&self, key: &[u8]) -> Result<()>;
2025-11-09T23:42:54.8968017Z -    
2025-11-09T23:42:54.8968131Z +
2025-11-09T23:42:54.8968277Z      /// Check if a key exists
2025-11-09T23:42:54.8968500Z      fn contains_key(&self, key: &[u8]) -> Result<bool>;
2025-11-09T23:42:54.8968614Z -    
2025-11-09T23:42:54.8968733Z +
2025-11-09T23:42:54.8968871Z      /// Clear all entries
2025-11-09T23:42:54.8969020Z      fn clear(&self) -> Result<()>;
2025-11-09T23:42:54.8969133Z -    
2025-11-09T23:42:54.8969255Z +
2025-11-09T23:42:54.8969404Z      /// Get number of entries
2025-11-09T23:42:54.8969547Z      fn len(&self) -> Result<usize>;
2025-11-09T23:42:54.8969660Z -    
2025-11-09T23:42:54.8969764Z +
2025-11-09T23:42:54.8969894Z      /// Check if tree is empty
2025-11-09T23:42:54.8970050Z      fn is_empty(&self) -> Result<bool> {
2025-11-09T23:42:54.8970199Z          Ok(self.len()? == 0)
2025-11-09T23:42:54.8970663Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:46:
2025-11-09T23:42:54.8970771Z      }
2025-11-09T23:42:54.8970889Z -    
2025-11-09T23:42:54.8970995Z +
2025-11-09T23:42:54.8971160Z      /// Iterate over all key-value pairs
2025-11-09T23:42:54.8971720Z      fn iter(&self) -> Box<dyn Iterator<Item = Result<(Vec<u8>, Vec<u8>)>> + '_>;
2025-11-09T23:42:54.8971842Z  }
2025-11-09T23:42:54.8972319Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:63:
2025-11-09T23:42:54.8972476Z  ) -> Result<Box<dyn Database>> {
2025-11-09T23:42:54.8972614Z      match backend {
2025-11-09T23:42:54.8972759Z          #[cfg(feature = "sled")]
2025-11-09T23:42:54.8972922Z -        DatabaseBackend::Sled => {
2025-11-09T23:42:54.8973161Z -            Ok(Box::new(sled_impl::SledDatabase::new(data_dir)?))
2025-11-09T23:42:54.8973281Z -        }
2025-11-09T23:42:54.8973620Z +        DatabaseBackend::Sled => Ok(Box::new(sled_impl::SledDatabase::new(data_dir)?)),
2025-11-09T23:42:54.8973762Z          #[cfg(not(feature = "sled"))]
2025-11-09T23:42:54.8973907Z -        DatabaseBackend::Sled => {
2025-11-09T23:42:54.8974208Z -            Err(anyhow::anyhow!("Sled backend not available (feature not enabled)"))
2025-11-09T23:42:54.8974512Z -        }
2025-11-09T23:42:54.8974711Z +        DatabaseBackend::Sled => Err(anyhow::anyhow!(
2025-11-09T23:42:54.8974918Z +            "Sled backend not available (feature not enabled)"
2025-11-09T23:42:54.8975025Z +        )),
2025-11-09T23:42:54.8975148Z          #[cfg(feature = "redb")]
2025-11-09T23:42:54.8977127Z -        DatabaseBackend::Redb => {
2025-11-09T23:42:54.8977581Z -            Ok(Box::new(redb_impl::RedbDatabase::new(data_dir)?))
2025-11-09T23:42:54.8977716Z -        }
2025-11-09T23:42:54.8978099Z +        DatabaseBackend::Redb => Ok(Box::new(redb_impl::RedbDatabase::new(data_dir)?)),
2025-11-09T23:42:54.8978251Z          #[cfg(not(feature = "redb"))]
2025-11-09T23:42:54.8978400Z -        DatabaseBackend::Redb => {
2025-11-09T23:42:54.8978722Z -            Err(anyhow::anyhow!("Redb backend not available (feature not enabled)"))
2025-11-09T23:42:54.8978843Z -        }
2025-11-09T23:42:54.8979030Z +        DatabaseBackend::Redb => Err(anyhow::anyhow!(
2025-11-09T23:42:54.8979254Z +            "Redb backend not available (feature not enabled)"
2025-11-09T23:42:54.8979377Z +        )),
2025-11-09T23:42:54.8979486Z      }
2025-11-09T23:42:54.8979601Z  }
2025-11-09T23:42:54.8979711Z  
2025-11-09T23:42:54.8980197Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:84:
2025-11-09T23:42:54.8980351Z  /// Get default database backend
2025-11-09T23:42:54.8980455Z -/// 
2025-11-09T23:42:54.8980571Z +///
2025-11-09T23:42:54.8980972Z  /// Returns the preferred backend (redb if available, otherwise sled).
2025-11-09T23:42:54.8981348Z  /// This function will not panic - it returns a backend if at least one is available.
2025-11-09T23:42:54.8981537Z  pub fn default_backend() -> DatabaseBackend {
2025-11-09T23:42:54.8982015Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:104:
2025-11-09T23:42:54.8982138Z  }
2025-11-09T23:42:54.8982251Z  
2025-11-09T23:42:54.8982400Z  /// Get fallback database backend
2025-11-09T23:42:54.8982511Z -/// 
2025-11-09T23:42:54.8982621Z +///
2025-11-09T23:42:54.8982841Z  /// Returns an alternative backend if the primary fails.
2025-11-09T23:42:54.8983015Z  /// Returns None if no fallback is available.
2025-11-09T23:42:54.8983393Z  pub fn fallback_backend(primary: DatabaseBackend) -> Option<DatabaseBackend> {
2025-11-09T23:42:54.8983846Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:148:
2025-11-09T23:42:54.8983984Z      impl SledDatabase {
2025-11-09T23:42:54.8984216Z          pub fn new<P: AsRef<Path>>(data_dir: P) -> Result<Self> {
2025-11-09T23:42:54.8986512Z              let db = sled::open(data_dir)?;
2025-11-09T23:42:54.8986633Z -            Ok(Self {
2025-11-09T23:42:54.8986761Z -                db: Arc::new(db),
2025-11-09T23:42:54.8986870Z -            })
2025-11-09T23:42:54.8987009Z +            Ok(Self { db: Arc::new(db) })
2025-11-09T23:42:54.8987113Z          }
2025-11-09T23:42:54.8987224Z      }
2025-11-09T23:42:54.8987578Z  
2025-11-09T23:42:54.8988037Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:224:
2025-11-09T23:42:54.8988430Z      static HEADERS_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("headers");
2025-11-09T23:42:54.8988882Z      static HEIGHT_INDEX_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("height_index");
2025-11-09T23:42:54.8989276Z      static WITNESSES_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("witnesses");
2025-11-09T23:42:54.8989708Z -    static RECENT_HEADERS_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("recent_headers");
2025-11-09T23:42:54.8989960Z +    static RECENT_HEADERS_TABLE: TableDefinition<&[u8], &[u8]> =
2025-11-09T23:42:54.8990142Z +        TableDefinition::new("recent_headers");
2025-11-09T23:42:54.8990526Z      static UTXOS_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("utxos");
2025-11-09T23:42:54.8991011Z -    static SPENT_OUTPUTS_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("spent_outputs");
2025-11-09T23:42:54.8991290Z +    static SPENT_OUTPUTS_TABLE: TableDefinition<&[u8], &[u8]> =
2025-11-09T23:42:54.8991471Z +        TableDefinition::new("spent_outputs");
2025-11-09T23:42:54.8991894Z      static CHAIN_INFO_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("chain_info");
2025-11-09T23:42:54.8992529Z      static WORK_CACHE_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("work_cache");
2025-11-09T23:42:54.8992945Z      static TX_BY_HASH_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("tx_by_hash");
2025-11-09T23:42:54.8993442Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:233:
2025-11-09T23:42:54.8993855Z      static TX_BY_BLOCK_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("tx_by_block");
2025-11-09T23:42:54.8994441Z      static TX_METADATA_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("tx_metadata");
2025-11-09T23:42:54.8994921Z -    static INVALID_BLOCKS_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("invalid_blocks");
2025-11-09T23:42:54.8995179Z +    static INVALID_BLOCKS_TABLE: TableDefinition<&[u8], &[u8]> =
2025-11-09T23:42:54.8995355Z +        TableDefinition::new("invalid_blocks");
2025-11-09T23:42:54.8995778Z      static CHAIN_TIPS_TABLE: TableDefinition<&[u8], &[u8]> = TableDefinition::new("chain_tips");
2025-11-09T23:42:54.8995898Z  
2025-11-09T23:42:54.8996040Z      pub struct RedbDatabase {
2025-11-09T23:42:54.8996478Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:243:
2025-11-09T23:42:54.8996695Z          pub fn new<P: AsRef<Path>>(data_dir: P) -> Result<Self> {
2025-11-09T23:42:54.8996895Z              let db_path = data_dir.as_ref().join("redb.db");
2025-11-09T23:42:54.8997048Z              let db = RedbDb::create(&db_path)?;
2025-11-09T23:42:54.8997155Z -            
2025-11-09T23:42:54.8997268Z +
2025-11-09T23:42:54.8997451Z              // Initialize all tables in a write transaction
2025-11-09T23:42:54.8997604Z              let write_txn = db.begin_write()?;
2025-11-09T23:42:54.8997708Z              {
2025-11-09T23:42:54.8998179Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:264:
2025-11-09T23:42:54.8998376Z                  let _ = write_txn.open_table(CHAIN_TIPS_TABLE)?;
2025-11-09T23:42:54.8998478Z              }
2025-11-09T23:42:54.8998617Z              write_txn.commit()?;
2025-11-09T23:42:54.8998719Z -            
2025-11-09T23:42:54.8998834Z -            Ok(Self {
2025-11-09T23:42:54.8998965Z -                db: Arc::new(db),
2025-11-09T23:42:54.9007615Z -            })
2025-11-09T23:42:54.9007762Z +
2025-11-09T23:42:54.9007943Z +            Ok(Self { db: Arc::new(db) })
2025-11-09T23:42:54.9008055Z          }
2025-11-09T23:42:54.9008160Z -        
2025-11-09T23:42:54.9008567Z -        fn get_table_def(&self, name: &str) -> Option<TableDefinition<&'static [u8], &'static [u8]>> {
2025-11-09T23:42:54.9008673Z +
2025-11-09T23:42:54.9009041Z +        fn get_table_def(
2025-11-09T23:42:54.9009155Z +            &self,
2025-11-09T23:42:54.9009292Z +            name: &str,
2025-11-09T23:42:54.9009546Z +        ) -> Option<TableDefinition<&'static [u8], &'static [u8]>> {
2025-11-09T23:42:54.9009671Z              match name {
2025-11-09T23:42:54.9009833Z                  "blocks" => Some(BLOCKS_TABLE),
2025-11-09T23:42:54.9009986Z                  "headers" => Some(HEADERS_TABLE),
2025-11-09T23:42:54.9010437Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:293:
2025-11-09T23:42:54.9010550Z  
2025-11-09T23:42:54.9010697Z      impl Database for RedbDatabase {
2025-11-09T23:42:54.9010923Z          fn open_tree(&self, name: &str) -> Result<Box<dyn Tree>> {
2025-11-09T23:42:54.9011109Z -            let table_def = self.get_table_def(name)
2025-11-09T23:42:54.9011577Z -                .ok_or_else(|| anyhow::anyhow!("Unknown table name: {}. Redb requires pre-defined tables.", name))?;
2025-11-09T23:42:54.9011706Z -            
2025-11-09T23:42:54.9011944Z +            let table_def = self.get_table_def(name).ok_or_else(|| {
2025-11-09T23:42:54.9012095Z +                anyhow::anyhow!(
2025-11-09T23:42:54.9012361Z +                    "Unknown table name: {}. Redb requires pre-defined tables.",
2025-11-09T23:42:54.9012484Z +                    name
2025-11-09T23:42:54.9012799Z +                )
2025-11-09T23:42:54.9012941Z +            })?;
2025-11-09T23:42:54.9013053Z +
2025-11-09T23:42:54.9013198Z              Ok(Box::new(RedbTree {
2025-11-09T23:42:54.9013358Z                  db: Arc::clone(&self.db),
2025-11-09T23:42:54.9013478Z                  table_def,
2025-11-09T23:42:54.9016229Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:374:
2025-11-09T23:42:54.9016442Z              let read_txn = match self.db.begin_read() {
2025-11-09T23:42:54.9016570Z                  Ok(txn) => txn,
2025-11-09T23:42:54.9016690Z                  Err(e) => {
2025-11-09T23:42:54.9017131Z -                    return Box::new(std::iter::once(Err(anyhow::anyhow!("Failed to begin read transaction: {}", e))));
2025-11-09T23:42:54.9017371Z +                    return Box::new(std::iter::once(Err(anyhow::anyhow!(
2025-11-09T23:42:54.9017543Z +                        "Failed to begin read transaction: {}",
2025-11-09T23:42:54.9017659Z +                        e
2025-11-09T23:42:54.9017783Z +                    ))));
2025-11-09T23:42:54.9017890Z                  }
2025-11-09T23:42:54.9018001Z              };
2025-11-09T23:42:54.9018107Z -            
2025-11-09T23:42:54.9018217Z +
2025-11-09T23:42:54.9018444Z              let table = match read_txn.open_table(self.table_def) {
2025-11-09T23:42:54.9018568Z                  Ok(tbl) => tbl,
2025-11-09T23:42:54.9018694Z                  Err(e) => {
2025-11-09T23:42:54.9019142Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:384:
2025-11-09T23:42:54.9019484Z -                    return Box::new(std::iter::once(Err(anyhow::anyhow!("Failed to open table: {}", e))));
2025-11-09T23:42:54.9019707Z +                    return Box::new(std::iter::once(Err(anyhow::anyhow!(
2025-11-09T23:42:54.9019856Z +                        "Failed to open table: {}",
2025-11-09T23:42:54.9019966Z +                        e
2025-11-09T23:42:54.9020072Z +                    ))));
2025-11-09T23:42:54.9020190Z                  }
2025-11-09T23:42:54.9020826Z              };
2025-11-09T23:42:54.9020947Z -            
2025-11-09T23:42:54.9021058Z +
2025-11-09T23:42:54.9021268Z              let items: Vec<Result<(Vec<u8>, Vec<u8>)>> = table
2025-11-09T23:42:54.9021389Z                  .iter()
2025-11-09T23:42:54.9021508Z                  .map(|item| {
2025-11-09T23:42:54.9021954Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:392:
2025-11-09T23:42:54.9022202Z                          .map_err(|e| anyhow::anyhow!("Redb iteration error: {}", e))
2025-11-09T23:42:54.9022307Z                  })
2025-11-09T23:42:54.9022666Z                  .collect();
2025-11-09T23:42:54.9022775Z -            
2025-11-09T23:42:54.9022885Z +
2025-11-09T23:42:54.9023039Z              Box::new(items.into_iter())
2025-11-09T23:42:54.9023158Z          }
2025-11-09T23:42:54.9023271Z      }
2025-11-09T23:42:54.9023765Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/database.rs:399:
2025-11-09T23:42:54.9023891Z  }
2025-11-09T23:42:54.9024002Z -
2025-11-09T23:42:54.9024115Z  
2025-11-09T23:42:54.9033817Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:4:
2025-11-09T23:42:54.9035200Z  //! Supports multiple database backends via feature flags (sled, redb).
2025-11-09T23:42:54.9035949Z  
2025-11-09T23:42:54.9038309Z  pub mod blockstore;
2025-11-09T23:42:54.9038735Z +pub mod chainstate;
2025-11-09T23:42:54.9038917Z  #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.9039075Z  pub mod commitment_store;
2025-11-09T23:42:54.9039225Z -pub mod chainstate;
2025-11-09T23:42:54.9039367Z  pub mod database;
2025-11-09T23:42:54.9039496Z  pub mod hashing;
2025-11-09T23:42:54.9040169Z  pub mod pruning;
2025-11-09T23:42:54.9040669Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:13:
2025-11-09T23:42:54.9040802Z  pub mod txindex;
2025-11-09T23:42:54.9040932Z  pub mod utxostore;
2025-11-09T23:42:54.9041056Z  
2025-11-09T23:42:54.9041589Z +use crate::config::PruningConfig;
2025-11-09T23:42:54.9041752Z  use anyhow::Result;
2025-11-09T23:42:54.9042228Z  use database::{create_database, default_backend, fallback_backend, Database, DatabaseBackend};
2025-11-09T23:42:54.9042378Z  use std::path::Path;
2025-11-09T23:42:54.9042848Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:19:
2025-11-09T23:42:54.9042987Z  use std::sync::Arc;
2025-11-09T23:42:54.9043133Z -use tracing::{warn, info};
2025-11-09T23:42:54.9043306Z -use crate::config::PruningConfig;
2025-11-09T23:42:54.9043456Z +use tracing::{info, warn};
2025-11-09T23:42:54.9043582Z  
2025-11-09T23:42:54.9043850Z  /// Storage manager that coordinates all storage operations
2025-11-09T23:42:54.9043988Z  pub struct Storage {
2025-11-09T23:42:54.9044631Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:32:
2025-11-09T23:42:54.9044751Z  
2025-11-09T23:42:54.9044881Z  impl Storage {
2025-11-09T23:42:54.9045102Z      /// Create a new storage instance with default backend
2025-11-09T23:42:54.9045218Z -    /// 
2025-11-09T23:42:54.9045332Z +    ///
2025-11-09T23:42:54.9045637Z      /// Attempts to use the default backend (redb), and gracefully falls back
2025-11-09T23:42:54.9045828Z      /// to sled if redb fails and sled is available.
2025-11-09T23:42:54.9046069Z      pub fn new<P: AsRef<Path>>(data_dir: P) -> Result<Self> {
2025-11-09T23:42:54.9046530Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:39:
2025-11-09T23:42:54.9046695Z          let default = default_backend();
2025-11-09T23:42:54.9046820Z -        
2025-11-09T23:42:54.9046940Z +
2025-11-09T23:42:54.9047097Z          // Try default backend first
2025-11-09T23:42:54.9047340Z          match Self::with_backend(data_dir.as_ref(), default) {
2025-11-09T23:42:54.9047494Z              Ok(storage) => Ok(storage),
2025-11-09T23:42:54.9047955Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:44:
2025-11-09T23:42:54.9048091Z              Err(e) => {
2025-11-09T23:42:54.9048275Z                  // If default backend fails, try fallback
2025-11-09T23:42:54.9048542Z                  if let Some(fallback_backend) = fallback_backend(default) {
2025-11-09T23:42:54.9048995Z -                    warn!("Failed to initialize {:?} backend: {}. Falling back to {:?}.", default, e, fallback_backend);
2025-11-09T23:42:54.9049429Z -                    info!("Attempting to initialize storage with fallback backend: {:?}", fallback_backend);
2025-11-09T23:42:54.9049565Z +                    warn!(
2025-11-09T23:42:54.9050083Z +                        "Failed to initialize {:?} backend: {}. Falling back to {:?}.",
2025-11-09T23:42:54.9050258Z +                        default, e, fallback_backend
2025-11-09T23:42:54.9050386Z +                    );
2025-11-09T23:42:54.9050514Z +                    info!(
2025-11-09T23:42:54.9050816Z +                        "Attempting to initialize storage with fallback backend: {:?}",
2025-11-09T23:42:54.9050950Z +                        fallback_backend
2025-11-09T23:42:54.9051068Z +                    );
2025-11-09T23:42:54.9051268Z                      Self::with_backend(data_dir, fallback_backend)
2025-11-09T23:42:54.9051382Z                  } else {
2025-11-09T23:42:54.9051542Z                      Err(anyhow::anyhow!(
2025-11-09T23:42:54.9052067Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:52:
2025-11-09T23:42:54.9052403Z                          "Failed to initialize {:?} backend: {}. No fallback backend available.",
2025-11-09T23:42:54.9052561Z -                        default, e
2025-11-09T23:42:54.9052694Z +                        default,
2025-11-09T23:42:54.9052816Z +                        e
2025-11-09T23:42:54.9052936Z                      ))
2025-11-09T23:42:54.9053062Z                  }
2025-11-09T23:42:54.9053177Z              }
2025-11-09T23:42:54.9053883Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:145:
2025-11-09T23:42:54.9054076Z      pub fn flush(&self) -> Result<()> {
2025-11-09T23:42:54.9054217Z          self.db.flush()
2025-11-09T23:42:54.9054495Z      }
2025-11-09T23:42:54.9054612Z -    
2025-11-09T23:42:54.9054736Z +
2025-11-09T23:42:54.9054980Z      /// Get approximate disk size used by storage (in bytes)
2025-11-09T23:42:54.9055094Z -    /// 
2025-11-09T23:42:54.9057155Z +    ///
2025-11-09T23:42:54.9057451Z      /// Returns an estimate based on tree sizes. If any operation fails,
2025-11-09T23:42:54.9057643Z      /// returns 0 gracefully rather than erroring.
2025-11-09T23:42:54.9057850Z      /// Includes bounds checking to prevent overflow.
2025-11-09T23:42:54.9058296Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:154:
2025-11-09T23:42:54.9058458Z      pub fn disk_size(&self) -> Result<u64> {
2025-11-09T23:42:54.9058733Z          // Estimate based on tree sizes (graceful degradation if counts fail)
2025-11-09T23:42:54.9058888Z          let mut size = 0u64;
2025-11-09T23:42:54.9059008Z -        
2025-11-09T23:42:54.9059123Z +
2025-11-09T23:42:54.9059443Z          // Block size estimate (gracefully handle errors, with bounds checking)
2025-11-09T23:42:54.9059667Z          if let Ok(count) = self.blockstore.block_count() {
2025-11-09T23:42:54.9059948Z              const MAX_BLOCKS: u64 = 10_000_000; // 10M blocks max (safety limit)
2025-11-09T23:42:54.9060374Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:162:
2025-11-09T23:42:54.9060610Z              const BYTES_PER_BLOCK: u64 = 1_024_000; // ~1MB per block
2025-11-09T23:42:54.9060939Z              size = size.saturating_add(safe_count.saturating_mul(BYTES_PER_BLOCK));
2025-11-09T23:42:54.9061047Z          }
2025-11-09T23:42:54.9061167Z -        
2025-11-09T23:42:54.9061270Z +
2025-11-09T23:42:54.9061554Z          // UTXO size estimate (gracefully handle errors, with bounds checking)
2025-11-09T23:42:54.9061769Z          if let Ok(count) = self.utxostore.utxo_count() {
2025-11-09T23:42:54.9062050Z              const MAX_UTXOS: u64 = 1_000_000_000; // 1B UTXOs max (safety limit)
2025-11-09T23:42:54.9062488Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:170:
2025-11-09T23:42:54.9062707Z              const BYTES_PER_UTXO: u64 = 100; // ~100 bytes per UTXO
2025-11-09T23:42:54.9063009Z              size = size.saturating_add(safe_count.saturating_mul(BYTES_PER_UTXO));
2025-11-09T23:42:54.9063111Z          }
2025-11-09T23:42:54.9063209Z -        
2025-11-09T23:42:54.9063317Z +
2025-11-09T23:42:54.9063888Z          // Transaction size estimate (gracefully handle errors, with bounds checking)
2025-11-09T23:42:54.9064100Z          if let Ok(count) = self.txindex.transaction_count() {
2025-11-09T23:42:54.9064515Z              const MAX_TXS: u64 = 1_000_000_000; // 1B transactions max (safety limit)
2025-11-09T23:42:54.9066820Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:178:
2025-11-09T23:42:54.9067082Z              const BYTES_PER_TX: u64 = 500; // ~500 bytes per transaction
2025-11-09T23:42:54.9067394Z              size = size.saturating_add(safe_count.saturating_mul(BYTES_PER_TX));
2025-11-09T23:42:54.9067517Z          }
2025-11-09T23:42:54.9067632Z -        
2025-11-09T23:42:54.9067741Z +
2025-11-09T23:42:54.9068010Z          // Final bounds check: prevent returning unrealistic values
2025-11-09T23:42:54.9068300Z          const MAX_DISK_SIZE: u64 = 10_000_000_000_000; // 10TB max (safety limit)
2025-11-09T23:42:54.9068452Z          Ok(size.min(MAX_DISK_SIZE))
2025-11-09T23:42:54.9068912Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:185:
2025-11-09T23:42:54.9069031Z      }
2025-11-09T23:42:54.9069140Z -    
2025-11-09T23:42:54.9069251Z +
2025-11-09T23:42:54.9069432Z      /// Check storage bounds before operations
2025-11-09T23:42:54.9069987Z      /// Returns true if storage is within safe bounds, false if approaching limits
2025-11-09T23:42:54.9070235Z      pub fn check_storage_bounds(&self) -> Result<bool> {
2025-11-09T23:42:54.9070704Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:190:
2025-11-09T23:42:54.9070913Z          const MAX_BLOCKS: usize = 10_000_000; // 10M blocks
2025-11-09T23:42:54.9071108Z          const MAX_UTXOS: usize = 1_000_000_000; // 1B UTXOs
2025-11-09T23:42:54.9071331Z          const MAX_TXS: usize = 1_000_000_000; // 1B transactions
2025-11-09T23:42:54.9071459Z -        
2025-11-09T23:42:54.9071573Z +
2025-11-09T23:42:54.9071844Z          let block_count = self.blockstore.block_count().unwrap_or(0);
2025-11-09T23:42:54.9072112Z          let utxo_count = self.utxostore.utxo_count().unwrap_or(0);
2025-11-09T23:42:54.9072376Z          let tx_count = self.txindex.transaction_count().unwrap_or(0);
2025-11-09T23:42:54.9072832Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:197:
2025-11-09T23:42:54.9072952Z -        
2025-11-09T23:42:54.9073080Z +
2025-11-09T23:42:54.9073295Z          // Check if we're approaching limits (80% threshold)
2025-11-09T23:42:54.9073506Z          let blocks_ok = block_count < (MAX_BLOCKS * 8 / 10);
2025-11-09T23:42:54.9073705Z          let utxos_ok = utxo_count < (MAX_UTXOS * 8 / 10);
2025-11-09T23:42:54.9074122Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:201:
2025-11-09T23:42:54.9074283Z          let txs_ok = tx_count < (MAX_TXS * 8 / 10);
2025-11-09T23:42:54.9074572Z -        
2025-11-09T23:42:54.9074681Z +
2025-11-09T23:42:54.9074815Z          if !blocks_ok {
2025-11-09T23:42:54.9075244Z -            warn!("Storage bounds: block count ({}) approaching limit ({})", block_count, MAX_BLOCKS);
2025-11-09T23:42:54.9075375Z +            warn!(
2025-11-09T23:42:54.9075638Z +                "Storage bounds: block count ({}) approaching limit ({})",
2025-11-09T23:42:54.9075795Z +                block_count, MAX_BLOCKS
2025-11-09T23:42:54.9075931Z +            );
2025-11-09T23:42:54.9076046Z          }
2025-11-09T23:42:54.9076173Z          if !utxos_ok {
2025-11-09T23:42:54.9076556Z -            warn!("Storage bounds: UTXO count ({}) approaching limit ({})", utxo_count, MAX_UTXOS);
2025-11-09T23:42:54.9076678Z +            warn!(
2025-11-09T23:42:54.9076927Z +                "Storage bounds: UTXO count ({}) approaching limit ({})",
2025-11-09T23:42:54.9077067Z +                utxo_count, MAX_UTXOS
2025-11-09T23:42:54.9077186Z +            );
2025-11-09T23:42:54.9077291Z          }
2025-11-09T23:42:54.9077405Z          if !txs_ok {
2025-11-09T23:42:54.9077783Z -            warn!("Storage bounds: transaction count ({}) approaching limit ({})", tx_count, MAX_TXS);
2025-11-09T23:42:54.9078116Z +            warn!(
2025-11-09T23:42:54.9078386Z +                "Storage bounds: transaction count ({}) approaching limit ({})",
2025-11-09T23:42:54.9078510Z +                tx_count, MAX_TXS
2025-11-09T23:42:54.9078619Z +            );
2025-11-09T23:42:54.9078726Z          }
2025-11-09T23:42:54.9078835Z -        
2025-11-09T23:42:54.9078955Z +
2025-11-09T23:42:54.9079120Z          Ok(blocks_ok && utxos_ok && txs_ok)
2025-11-09T23:42:54.9079242Z      }
2025-11-09T23:42:54.9079355Z -    
2025-11-09T23:42:54.9079470Z +
2025-11-09T23:42:54.9079631Z      /// Get transaction count from txindex
2025-11-09T23:42:54.9079847Z      pub fn transaction_count(&self) -> Result<usize> {
2025-11-09T23:42:54.9080015Z          self.txindex.transaction_count()
2025-11-09T23:42:54.9122309Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:7:
2025-11-09T23:42:54.9122813Z  //! - Custom: Fine-grained control over what to keep
2025-11-09T23:42:54.9122931Z  
2025-11-09T23:42:54.9123226Z  use crate::config::{PruningConfig, PruningMode};
2025-11-09T23:42:54.9123373Z +#[cfg(feature = "bip158")]
2025-11-09T23:42:54.9123627Z +use crate::network::filter_service::BlockFilterService;
2025-11-09T23:42:54.9123812Z  use crate::storage::blockstore::BlockStore;
2025-11-09T23:42:54.9124276Z  #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.9124685Z  use crate::storage::commitment_store::CommitmentStore;
2025-11-09T23:42:54.9125154Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:13:
2025-11-09T23:42:54.9125308Z  #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.9125487Z  use crate::storage::utxostore::UtxoStore;
2025-11-09T23:42:54.9125624Z -#[cfg(feature = "bip158")]
2025-11-09T23:42:54.9125862Z -use crate::network::filter_service::BlockFilterService;
2025-11-09T23:42:54.9126015Z  use anyhow::{anyhow, Result};
2025-11-09T23:42:54.9126187Z  #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.9126334Z  use bllvm_protocol::Hash;
2025-11-09T23:42:54.9126792Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:89:
2025-11-09T23:42:54.9126948Z      pub fn with_features(
2025-11-09T23:42:54.9127098Z          config: PruningConfig,
2025-11-09T23:42:54.9127261Z          blockstore: Arc<BlockStore>,
2025-11-09T23:42:54.9127435Z -        #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.9127668Z -        commitment_store: Option<Arc<CommitmentStore>>,
2025-11-09T23:42:54.9127835Z -        #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.9128009Z -        utxostore: Option<Arc<UtxoStore>>,
2025-11-09T23:42:54.9128166Z -        #[cfg(feature = "bip158")]
2025-11-09T23:42:54.9128390Z -        filter_service: Option<Arc<BlockFilterService>>,
2025-11-09T23:42:54.9128784Z +        #[cfg(feature = "utxo-commitments")] commitment_store: Option<Arc<CommitmentStore>>,
2025-11-09T23:42:54.9129119Z +        #[cfg(feature = "utxo-commitments")] utxostore: Option<Arc<UtxoStore>>,
2025-11-09T23:42:54.9129451Z +        #[cfg(feature = "bip158")] filter_service: Option<Arc<BlockFilterService>>,
2025-11-09T23:42:54.9129574Z      ) -> Self {
2025-11-09T23:42:54.9129693Z          Self {
2025-11-09T23:42:54.9129818Z              config,
2025-11-09T23:42:54.9130302Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:153:
2025-11-09T23:42:54.9130417Z          {
2025-11-09T23:42:54.9130610Z              // Check if UTXO commitments are available
2025-11-09T23:42:54.9131001Z              let has_commitments = self.commitment_store.is_some() && self.utxostore.is_some();
2025-11-09T23:42:54.9131118Z -            
2025-11-09T23:42:54.9131234Z +
2025-11-09T23:42:54.9131449Z              // Check if mode supports incremental pruning
2025-11-09T23:42:54.9131612Z              let mode_supports = matches!(
2025-11-09T23:42:54.9131754Z                  &self.config.mode,
2025-11-09T23:42:54.9132514Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:160:
2025-11-09T23:42:54.9132933Z -                PruningMode::Aggressive { .. } | PruningMode::Custom { keep_commitments: true, .. }
2025-11-09T23:42:54.9133116Z +                PruningMode::Aggressive { .. }
2025-11-09T23:42:54.9133284Z +                    | PruningMode::Custom {
2025-11-09T23:42:54.9133453Z +                        keep_commitments: true,
2025-11-09T23:42:54.9133579Z +                        ..
2025-11-09T23:42:54.9133698Z +                    }
2025-11-09T23:42:54.9133816Z              );
2025-11-09T23:42:54.9133934Z -            
2025-11-09T23:42:54.9134044Z +
2025-11-09T23:42:54.9134217Z              has_commitments && mode_supports
2025-11-09T23:42:54.9134552Z          }
2025-11-09T23:42:54.9134742Z          #[cfg(not(feature = "utxo-commitments"))]
2025-11-09T23:42:54.9136756Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:169:
2025-11-09T23:42:54.9136889Z      }
2025-11-09T23:42:54.9137000Z  
2025-11-09T23:42:54.9137159Z      /// Incremental prune during IBD
2025-11-09T23:42:54.9137282Z -    /// 
2025-11-09T23:42:54.9137397Z +    ///
2025-11-09T23:42:54.9137771Z      /// This method prunes old blocks while keeping a sliding window of recent blocks.
2025-11-09T23:42:54.9138383Z      /// It's designed to be called periodically during IBD to prevent storage from growing
2025-11-09T23:42:54.9138767Z      /// unbounded. Only works when incremental_prune_during_ibd is enabled and UTXO
2025-11-09T23:42:54.9139253Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:203:
2025-11-09T23:42:54.9139369Z  
2025-11-09T23:42:54.9139703Z          // Calculate prune height: keep only the last prune_window_size blocks
2025-11-09T23:42:54.9140113Z          let prune_to_height = current_height.saturating_sub(self.config.prune_window_size);
2025-11-09T23:42:54.9140230Z -        
2025-11-09T23:42:54.9140356Z +
2025-11-09T23:42:54.9140608Z          // Don't prune if window size is larger than current height
2025-11-09T23:42:54.9140872Z          if prune_to_height == 0 || prune_to_height >= current_height {
2025-11-09T23:42:54.9141011Z              return Ok(None);
2025-11-09T23:42:54.9141503Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:245:
2025-11-09T23:42:54.9141718Z              // 1. Incremental pruning is explicitly enabled
2025-11-09T23:42:54.9141985Z              // 2. UTXO commitments are available (for state verification)
2025-11-09T23:42:54.9142230Z              // 3. Aggressive or Custom mode with commitments enabled
2025-11-09T23:42:54.9142566Z -            let can_incremental_prune = self.config.incremental_prune_during_ibd
2025-11-09T23:42:54.9142760Z -                && self.can_incremental_prune_during_ibd();
2025-11-09T23:42:54.9143044Z -            
2025-11-09T23:42:54.9143202Z +            let can_incremental_prune =
2025-11-09T23:42:54.9143624Z +                self.config.incremental_prune_during_ibd && self.can_incremental_prune_during_ibd();
2025-11-09T23:42:54.9143747Z +
2025-11-09T23:42:54.9143902Z              if !can_incremental_prune {
2025-11-09T23:42:54.9146172Z                  return Err(anyhow!(
2025-11-09T23:42:54.9146892Z                      "Cannot prune during initial block download. Wait for IBD to complete, or enable incremental_prune_during_ibd with UTXO commitments."
2025-11-09T23:42:54.9147380Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:254:
2025-11-09T23:42:54.9147506Z                  ));
2025-11-09T23:42:54.9147628Z              }
2025-11-09T23:42:54.9147751Z -            
2025-11-09T23:42:54.9148353Z +
2025-11-09T23:42:54.9148679Z              // For incremental pruning during IBD, ensure we have enough blocks
2025-11-09T23:42:54.9148996Z              if current_height < self.config.min_blocks_for_incremental_prune {
2025-11-09T23:42:54.9149151Z                  return Err(anyhow!(
2025-11-09T23:42:54.9149904Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:295:
2025-11-09T23:42:54.9150519Z              PruningMode::Normal {
2025-11-09T23:42:54.9150682Z                  keep_from_height,
2025-11-09T23:42:54.9150827Z                  min_recent_blocks,
2025-11-09T23:42:54.9151295Z -            } => self.prune_normal(prune_to_height, current_height, *keep_from_height, *min_recent_blocks)?,
2025-11-09T23:42:54.9151442Z +            } => self.prune_normal(
2025-11-09T23:42:54.9151571Z +                prune_to_height,
2025-11-09T23:42:54.9151697Z +                current_height,
2025-11-09T23:42:54.9151826Z +                *keep_from_height,
2025-11-09T23:42:54.9151959Z +                *min_recent_blocks,
2025-11-09T23:42:54.9152066Z +            )?,
2025-11-09T23:42:54.9152222Z              PruningMode::Aggressive {
2025-11-09T23:42:54.9152358Z                  keep_from_height,
2025-11-09T23:42:54.9152493Z                  keep_commitments,
2025-11-09T23:42:54.9152976Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:370:
2025-11-09T23:42:54.9153167Z          let mut stats = PruningStats::default();
2025-11-09T23:42:54.9153276Z  
2025-11-09T23:42:54.9153637Z          // Calculate actual keep height (max of keep_from_height and min_recent_blocks)
2025-11-09T23:42:54.9156565Z -        let effective_keep_height = keep_from_height.max(
2025-11-09T23:42:54.9156852Z -            current_height.saturating_sub(min_recent_blocks)
2025-11-09T23:42:54.9156978Z -        );
2025-11-09T23:42:54.9157140Z +        let effective_keep_height =
2025-11-09T23:42:54.9157498Z +            keep_from_height.max(current_height.saturating_sub(min_recent_blocks));
2025-11-09T23:42:54.9157678Z  
2025-11-09T23:42:54.9157919Z          // Ensure we don't prune below effective keep height
2025-11-09T23:42:54.9158250Z          let actual_prune_height = prune_to_height.min(effective_keep_height);
2025-11-09T23:42:54.9158759Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:415:
2025-11-09T23:42:54.9158977Z          let mut stats = PruningStats::default();
2025-11-09T23:42:54.9159090Z  
2025-11-09T23:42:54.9159266Z          // Calculate effective keep height
2025-11-09T23:42:54.9159486Z -        let effective_keep_height = keep_from_height.max(
2025-11-09T23:42:54.9159684Z -            current_height.saturating_sub(min_blocks)
2025-11-09T23:42:54.9159812Z -        );
2025-11-09T23:42:54.9160266Z +        let effective_keep_height = keep_from_height.max(current_height.saturating_sub(min_blocks));
2025-11-09T23:42:54.9160380Z  
2025-11-09T23:42:54.9160702Z          let actual_prune_height = prune_to_height.min(effective_keep_height);
2025-11-09T23:42:54.9160822Z  
2025-11-09T23:42:54.9161305Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:428:
2025-11-09T23:42:54.9161419Z  
2025-11-09T23:42:54.9161657Z          // Generate UTXO commitments before pruning if enabled
2025-11-09T23:42:54.9161813Z          if keep_commitments {
2025-11-09T23:42:54.9162066Z -            if let (Some(ref commitment_store), Some(ref utxostore)) = 
2025-11-09T23:42:54.9162347Z -                (self.commitment_store.as_ref(), self.utxostore.as_ref()) 
2025-11-09T23:42:54.9162590Z +            if let (Some(ref commitment_store), Some(ref utxostore)) =
2025-11-09T23:42:54.9162857Z +                (self.commitment_store.as_ref(), self.utxostore.as_ref())
2025-11-09T23:42:54.9162974Z              {
2025-11-09T23:42:54.9163271Z                  info!("Generating UTXO commitments for blocks to be pruned...");
2025-11-09T23:42:54.9163463Z                  self.generate_commitments_before_prune(
2025-11-09T23:42:54.9163928Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:439:
2025-11-09T23:42:54.9164070Z                      utxostore,
2025-11-09T23:42:54.9164187Z                  )?;
2025-11-09T23:42:54.9164554Z              } else {
2025-11-09T23:42:54.9165293Z -                warn!("UTXO commitments requested but commitment store or UTXO store not available");
2025-11-09T23:42:54.9165425Z +                warn!(
2025-11-09T23:42:54.9165814Z +                    "UTXO commitments requested but commitment store or UTXO store not available"
2025-11-09T23:42:54.9165930Z +                );
2025-11-09T23:42:54.9166051Z              }
2025-11-09T23:42:54.9166169Z          }
2025-11-09T23:42:54.9166275Z  
2025-11-09T23:42:54.9168523Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:464:
2025-11-09T23:42:54.9168738Z                      // Remove filter from cache but keep filter header
2025-11-09T23:42:54.9168911Z                      if filter_service.has_filter(&hash) {
2025-11-09T23:42:54.9169153Z                          filter_service.remove_filter_for_pruned_block(&hash)?;
2025-11-09T23:42:54.9169549Z -                        debug!("Removed BIP158 filter for pruned block at height {} (header kept)", height);
2025-11-09T23:42:54.9169692Z +                        debug!(
2025-11-09T23:42:54.9170012Z +                            "Removed BIP158 filter for pruned block at height {} (header kept)",
2025-11-09T23:42:54.9170141Z +                            height
2025-11-09T23:42:54.9170260Z +                        );
2025-11-09T23:42:54.9170373Z                      }
2025-11-09T23:42:54.9170702Z                  }
2025-11-09T23:42:54.9170828Z              }
2025-11-09T23:42:54.9171320Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:524:
2025-11-09T23:42:54.9171477Z                  if keep_commitments {
2025-11-09T23:42:54.9171668Z                      #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.9171790Z                      {
2025-11-09T23:42:54.9172057Z -                        if let (Some(ref commitment_store), Some(ref utxostore)) = 
2025-11-09T23:42:54.9172341Z -                            (self.commitment_store.as_ref(), self.utxostore.as_ref()) 
2025-11-09T23:42:54.9173100Z +                        if let (Some(ref commitment_store), Some(ref utxostore)) =
2025-11-09T23:42:54.9173401Z +                            (self.commitment_store.as_ref(), self.utxostore.as_ref())
2025-11-09T23:42:54.9173540Z                          {
2025-11-09T23:42:54.9173729Z                              // Generate commitment if not exists
2025-11-09T23:42:54.9173954Z                              if !commitment_store.has_commitment(&hash)? {
2025-11-09T23:42:54.9174642Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:547:
2025-11-09T23:42:54.9174934Z                          // Filter headers are always kept for chain verification
2025-11-09T23:42:54.9175121Z                          if filter_service.has_filter(&hash) {
2025-11-09T23:42:54.9175383Z                              filter_service.remove_filter_for_pruned_block(&hash)?;
2025-11-09T23:42:54.9175803Z -                            debug!("Removed BIP158 filter for pruned block at height {} (header kept)", height);
2025-11-09T23:42:54.9177824Z +                            debug!(
2025-11-09T23:42:54.9178145Z +                                "Removed BIP158 filter for pruned block at height {} (header kept)",
2025-11-09T23:42:54.9178293Z +                                height
2025-11-09T23:42:54.9178422Z +                            );
2025-11-09T23:42:54.9178554Z                          }
2025-11-09T23:42:54.9178675Z                      }
2025-11-09T23:42:54.9178799Z                  }
2025-11-09T23:42:54.9179262Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:569:
2025-11-09T23:42:54.9179425Z          commitment_store: &CommitmentStore,
2025-11-09T23:42:54.9179566Z          utxostore: &UtxoStore,
2025-11-09T23:42:54.9179692Z      ) -> Result<()> {
2025-11-09T23:42:54.9180004Z -        info!("Generating UTXO commitments for heights 0..{}", prune_to_height);
2025-11-09T23:42:54.9180131Z +        info!(
2025-11-09T23:42:54.9180616Z +            "Generating UTXO commitments for heights 0..{}",
2025-11-09T23:42:54.9180760Z +            prune_to_height
2025-11-09T23:42:54.9180869Z +        );
2025-11-09T23:42:54.9180984Z  
2025-11-09T23:42:54.9181209Z          // For each block to be pruned, generate a commitment
2025-11-09T23:42:54.9181533Z          // We'll generate commitments at checkpoint intervals to save computation
2025-11-09T23:42:54.9182036Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:601:
2025-11-09T23:42:54.9182209Z          commitment_store: &CommitmentStore,
2025-11-09T23:42:54.9182350Z          utxostore: &UtxoStore,
2025-11-09T23:42:54.9182467Z      ) -> Result<()> {
2025-11-09T23:42:54.9182635Z -        #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.9182929Z -        use bllvm_protocol::utxo_commitments::merkle_tree::UtxoMerkleTree;
2025-11-09T23:42:54.9183111Z          use bllvm_protocol::block::connect_block;
2025-11-09T23:42:54.9183279Z          use bllvm_protocol::segwit::Witness;
2025-11-09T23:42:54.9183434Z +        #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.9183723Z +        use bllvm_protocol::utxo_commitments::merkle_tree::UtxoMerkleTree;
2025-11-09T23:42:54.9183832Z  
2025-11-09T23:42:54.9184116Z          // Reconstruct UTXO set at historical height by replaying blocks
2025-11-09T23:42:54.9184827Z          let utxo_set = self.reconstruct_utxo_set_at_height(height, utxostore)?;
2025-11-09T23:42:54.9186574Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:614:
2025-11-09T23:42:54.9186929Z              .map_err(|e| anyhow::anyhow!("Failed to create UTXO Merkle tree: {:?}", e))?;
2025-11-09T23:42:54.9187042Z  
2025-11-09T23:42:54.9187197Z          for (outpoint, utxo) in &utxo_set {
2025-11-09T23:42:54.9187395Z -            utxo_tree.insert(*outpoint, utxo.clone())
2025-11-09T23:42:54.9187519Z +            utxo_tree
2025-11-09T23:42:54.9187685Z +                .insert(*outpoint, utxo.clone())
2025-11-09T23:42:54.9187980Z                  .map_err(|e| anyhow::anyhow!("Failed to insert UTXO: {:?}", e))?;
2025-11-09T23:42:54.9188099Z          }
2025-11-09T23:42:54.9188209Z  
2025-11-09T23:42:54.9188677Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:624:
2025-11-09T23:42:54.9188822Z          // Store commitment
2025-11-09T23:42:54.9189156Z          commitment_store.store_commitment(block_hash, height, &commitment)?;
2025-11-09T23:42:54.9189262Z  
2025-11-09T23:42:54.9189568Z -        debug!("Generated and stored commitment for height {} (hash: {})", 
2025-11-09T23:42:54.9189732Z -               height, hex::encode(block_hash));
2025-11-09T23:42:54.9189844Z +        debug!(
2025-11-09T23:42:54.9190101Z +            "Generated and stored commitment for height {} (hash: {})",
2025-11-09T23:42:54.9190222Z +            height,
2025-11-09T23:42:54.9190374Z +            hex::encode(block_hash)
2025-11-09T23:42:54.9190490Z +        );
2025-11-09T23:42:54.9190604Z  
2025-11-09T23:42:54.9190728Z          Ok(())
2025-11-09T23:42:54.9190841Z      }
2025-11-09T23:42:54.9191327Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:632:
2025-11-09T23:42:54.9191447Z  
2025-11-09T23:42:54.9191672Z      /// Generate UTXO commitment from current UTXO set state
2025-11-09T23:42:54.9191782Z -    /// 
2025-11-09T23:42:54.9191901Z +    ///
2025-11-09T23:42:54.9192335Z      /// This method generates a commitment from the current UTXO set without replaying blocks.
2025-11-09T23:42:54.9192703Z      /// Used during incremental sync when the UTXO set is maintained incrementally.
2025-11-09T23:42:54.9192830Z -    /// 
2025-11-09T23:42:54.9192948Z +    ///
2025-11-09T23:42:54.9193069Z      /// # Arguments
2025-11-09T23:42:54.9193284Z      /// * `block_hash` - Hash of the block at this height
2025-11-09T23:42:54.9193443Z      /// * `height` - Block height
2025-11-09T23:42:54.9193905Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:641:
2025-11-09T23:42:54.9196424Z      /// * `utxo_set` - Current UTXO set (from incremental updates)
2025-11-09T23:42:54.9196702Z      /// * `commitment_store` - Commitment store to save the commitment
2025-11-09T23:42:54.9196819Z -    /// 
2025-11-09T23:42:54.9196936Z +    ///
2025-11-09T23:42:54.9197053Z      /// # Returns
2025-11-09T23:42:54.9197232Z      /// Result indicating success or failure
2025-11-09T23:42:54.9197385Z      #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.9197852Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:658:
2025-11-09T23:42:54.9198203Z              .map_err(|e| anyhow::anyhow!("Failed to create UTXO Merkle tree: {:?}", e))?;
2025-11-09T23:42:54.9198310Z  
2025-11-09T23:42:54.9198464Z          for (outpoint, utxo) in utxo_set {
2025-11-09T23:42:54.9198651Z -            utxo_tree.insert(*outpoint, utxo.clone())
2025-11-09T23:42:54.9198759Z +            utxo_tree
2025-11-09T23:42:54.9198909Z +                .insert(*outpoint, utxo.clone())
2025-11-09T23:42:54.9199181Z                  .map_err(|e| anyhow::anyhow!("Failed to insert UTXO: {:?}", e))?;
2025-11-09T23:42:54.9199301Z          }
2025-11-09T23:42:54.9199401Z  
2025-11-09T23:42:54.9199824Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:668:
2025-11-09T23:42:54.9199961Z          // Store commitment
2025-11-09T23:42:54.9200471Z          commitment_store.store_commitment(block_hash, height, &commitment)?;
2025-11-09T23:42:54.9200588Z  
2025-11-09T23:42:54.9200937Z -        debug!("Generated commitment from current state for height {} (hash: {})", 
2025-11-09T23:42:54.9201102Z -               height, hex::encode(block_hash));
2025-11-09T23:42:54.9201212Z +        debug!(
2025-11-09T23:42:54.9201512Z +            "Generated commitment from current state for height {} (hash: {})",
2025-11-09T23:42:54.9201635Z +            height,
2025-11-09T23:42:54.9201777Z +            hex::encode(block_hash)
2025-11-09T23:42:54.9201896Z +        );
2025-11-09T23:42:54.9202013Z  
2025-11-09T23:42:54.9202125Z          Ok(())
2025-11-09T23:42:54.9202235Z      }
2025-11-09T23:42:54.9202753Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:676:
2025-11-09T23:42:54.9202868Z  
2025-11-09T23:42:54.9203109Z      /// Reconstruct UTXO set at a specific historical height
2025-11-09T23:42:54.9203236Z -    /// 
2025-11-09T23:42:54.9203344Z +    ///
2025-11-09T23:42:54.9203616Z      /// This function replays blocks from genesis to the target height
2025-11-09T23:42:54.9203851Z      /// to reconstruct the exact UTXO set at that point in history.
2025-11-09T23:42:54.9204003Z      #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:54.9206548Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:703:
2025-11-09T23:42:54.9206672Z                  // Get block
2025-11-09T23:42:54.9206933Z                  if let Some(block) = self.blockstore.get_block(&block_hash)? {
2025-11-09T23:42:54.9207104Z                      // Get witnesses for this block
2025-11-09T23:42:54.9207351Z -                    let witnesses = self.blockstore.get_witness(&block_hash)?
2025-11-09T23:42:54.9207507Z -                        .unwrap_or_else(|| {
2025-11-09T23:42:54.9207725Z -                            // If no witnesses stored, create empty witnesses
2025-11-09T23:42:54.9208011Z -                            block.transactions.iter().map(|_| Vec::new()).collect()
2025-11-09T23:42:54.9208137Z -                        });
2025-11-09T23:42:54.9208275Z +                    let witnesses =
2025-11-09T23:42:54.9208426Z +                        self.blockstore
2025-11-09T23:42:54.9208588Z +                            .get_witness(&block_hash)?
2025-11-09T23:42:54.9208741Z +                            .unwrap_or_else(|| {
2025-11-09T23:42:54.9208959Z +                                // If no witnesses stored, create empty witnesses
2025-11-09T23:42:54.9209211Z +                                block.transactions.iter().map(|_| Vec::new()).collect()
2025-11-09T23:42:54.9209630Z +                            });
2025-11-09T23:42:54.9209749Z  
2025-11-09T23:42:54.9209960Z                      // Apply block to UTXO set using connect_block
2025-11-09T23:42:54.9210322Z                      // This properly handles coinbase transactions and input/output processing
2025-11-09T23:42:54.9210821Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:714:
2025-11-09T23:42:54.9211093Z                      let (validation_result, new_utxo_set) = connect_block(
2025-11-09T23:42:54.9211229Z -                        &block,
2025-11-09T23:42:54.9211362Z -                        &witnesses,
2025-11-09T23:42:54.9211504Z -                        utxo_set,
2025-11-09T23:42:54.9211633Z -                        height,
2025-11-09T23:42:54.9211821Z +                        &block, &witnesses, utxo_set, height,
2025-11-09T23:42:54.9212080Z                          None, // No recent headers needed for historical replay
2025-11-09T23:42:54.9212214Z                      )?;
2025-11-09T23:42:54.9212329Z  
2025-11-09T23:42:54.9212820Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:722:
2025-11-09T23:42:54.9212992Z                      // Check validation result
2025-11-09T23:42:54.9213601Z                      if !matches!(validation_result, bllvm_protocol::ValidationResult::Valid) {
2025-11-09T23:42:54.9214461Z -                        warn!("Block at height {} failed validation during UTXO reconstruction", height);
2025-11-09T23:42:54.9214636Z +                        warn!(
2025-11-09T23:42:54.9214941Z +                            "Block at height {} failed validation during UTXO reconstruction",
2025-11-09T23:42:54.9215071Z +                            height
2025-11-09T23:42:54.9215197Z +                        );
2025-11-09T23:42:54.9215486Z                          // Continue anyway - this might be expected for some edge cases
2025-11-09T23:42:54.9215611Z                      }
2025-11-09T23:42:54.9215725Z  
2025-11-09T23:42:54.9216215Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:740:
2025-11-09T23:42:54.9216339Z              }
2025-11-09T23:42:54.9216452Z          }
2025-11-09T23:42:54.9217068Z  
2025-11-09T23:42:54.9217545Z -        debug!("Reconstructed UTXO set at height {} with {} UTXOs", target_height, utxo_set.len());
2025-11-09T23:42:54.9217672Z +        debug!(
2025-11-09T23:42:54.9217908Z +            "Reconstructed UTXO set at height {} with {} UTXOs",
2025-11-09T23:42:54.9218054Z +            target_height,
2025-11-09T23:42:54.9218186Z +            utxo_set.len()
2025-11-09T23:42:54.9218300Z +        );
2025-11-09T23:42:54.9218435Z          Ok(utxo_set)
2025-11-09T23:42:54.9218548Z      }
2025-11-09T23:42:54.9218659Z  }
2025-11-09T23:42:54.9219155Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/pruning.rs:747:
2025-11-09T23:42:54.9219275Z -
2025-11-09T23:42:54.9219396Z  
2025-11-09T23:42:54.9219934Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/txindex.rs:2:
2025-11-09T23:42:54.9220059Z  //!
2025-11-09T23:42:54.9220455Z  //! Provides fast lookup of transactions by hash and maintains transaction metadata.
2025-11-09T23:42:54.9220569Z  
2025-11-09T23:42:54.9220788Z +use crate::storage::database::{Database, Tree};
2025-11-09T23:42:54.9220934Z  use anyhow::Result;
2025-11-09T23:42:54.9221114Z  use bllvm_protocol::{Hash, Transaction};
2025-11-09T23:42:54.9221297Z  use serde::{Deserialize, Serialize};
2025-11-09T23:42:54.9221789Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/txindex.rs:8:
2025-11-09T23:42:54.9221998Z -use crate::storage::database::{Database, Tree};
2025-11-09T23:42:54.9222133Z  use std::sync::Arc;
2025-11-09T23:42:54.9222255Z  
2025-11-09T23:42:54.9222396Z  /// Transaction metadata
2025-11-09T23:42:54.9222868Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/txindex.rs:68:
2025-11-09T23:42:54.9223250Z          };
2025-11-09T23:42:54.9223366Z  
2025-11-09T23:42:54.9223604Z          let metadata_data = bincode::serialize(&metadata)?;
2025-11-09T23:42:54.9223893Z -        self.tx_metadata.insert(tx_hash.as_slice(), &metadata_data)?;
2025-11-09T23:42:54.9224034Z +        self.tx_metadata
2025-11-09T23:42:54.9224243Z +            .insert(tx_hash.as_slice(), &metadata_data)?;
2025-11-09T23:42:54.9224545Z  
2025-11-09T23:42:54.9224690Z          // Index by block
2025-11-09T23:42:54.9224924Z          let block_key = self.block_tx_key(block_hash, tx_index);
2025-11-09T23:42:54.9225404Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/utxostore.rs:2:
2025-11-09T23:42:54.9225529Z  //!
2025-11-09T23:42:54.9225844Z  //! Stores and manages the UTXO set for efficient transaction validation.
2025-11-09T23:42:54.9225954Z  
2025-11-09T23:42:54.9226158Z +use crate::storage::database::{Database, Tree};
2025-11-09T23:42:54.9226306Z  use anyhow::Result;
2025-11-09T23:42:54.9226503Z  use bllvm_protocol::{OutPoint, UtxoSet, UTXO};
2025-11-09T23:42:54.9226682Z -use crate::storage::database::{Database, Tree};
2025-11-09T23:42:54.9226833Z  use std::collections::HashMap;
2025-11-09T23:42:54.9226954Z  use std::sync::Arc;
2025-11-09T23:42:54.9227059Z  
2025-11-09T23:42:54.9227720Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/validation/mod.rs:51:
2025-11-09T23:42:54.9227906Z          context: &BlockValidationContext,
2025-11-09T23:42:54.9228073Z      ) -> Result<(ValidationResult, UtxoSet)> {
2025-11-09T23:42:54.9228254Z          // Create empty witnesses for each transaction
2025-11-09T23:42:54.9228716Z -        let witnesses: Vec<Witness> = context.block.transactions.iter().map(|_| Vec::new()).collect();
2025-11-09T23:42:54.9228880Z +        let witnesses: Vec<Witness> = context
2025-11-09T23:42:54.9229000Z +            .block
2025-11-09T23:42:54.9229137Z +            .transactions
2025-11-09T23:42:54.9229253Z +            .iter()
2025-11-09T23:42:54.9229402Z +            .map(|_| Vec::new())
2025-11-09T23:42:54.9229526Z +            .collect();
2025-11-09T23:42:54.9229663Z          connect_block(
2025-11-09T23:42:54.9229795Z              &context.block,
2025-11-09T23:42:54.9229916Z              &witnesses,
2025-11-09T23:42:54.9230388Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/validation/mod.rs:87:
2025-11-09T23:42:54.9230523Z              .par_iter()
2025-11-09T23:42:54.9230662Z              .map(|context| {
2025-11-09T23:42:54.9230862Z                  // Create empty witnesses for each transaction
2025-11-09T23:42:54.9231343Z -                let witnesses: Vec<Witness> = context.block.transactions.iter().map(|_| Vec::new()).collect();
2025-11-09T23:42:54.9231524Z +                let witnesses: Vec<Witness> = context
2025-11-09T23:42:54.9231645Z +                    .block
2025-11-09T23:42:54.9231788Z +                    .transactions
2025-11-09T23:42:54.9231912Z +                    .iter()
2025-11-09T23:42:54.9232075Z +                    .map(|_| Vec::new())
2025-11-09T23:42:54.9232213Z +                    .collect();
2025-11-09T23:42:54.9232345Z                  connect_block(
2025-11-09T23:42:54.9232581Z error[internal]: left behind trailing whitespace
2025-11-09T23:42:54.9233021Z   --> /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/storage/mod.rs:91:91:1
2025-11-09T23:42:54.9233153Z    |
2025-11-09T23:42:54.9233274Z 91 |                 
2025-11-09T23:42:54.9233389Z    | ^^^^^^^^^^^^^^^^
2025-11-09T23:42:54.9233503Z    |
2025-11-09T23:42:54.9233517Z 
2025-11-09T23:42:54.9233793Z warning: rustfmt has failed to format. See previous 1 errors.
2025-11-09T23:42:54.9233805Z 
2025-11-09T23:42:54.9233946Z                      &context.block,
2025-11-09T23:42:54.9234087Z                      &witnesses,
2025-11-09T23:42:54.9234770Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/src/validation/mod.rs:116:
2025-11-09T23:42:54.9234888Z  
2025-11-09T23:42:54.9235048Z          for context in contexts {
2025-11-09T23:42:54.9235534Z              // Create empty witnesses for each transaction
2025-11-09T23:42:54.9236149Z -            let witnesses: Vec<Witness> = context.block.transactions.iter().map(|_| Vec::new()).collect();
2025-11-09T23:42:54.9236326Z +            let witnesses: Vec<Witness> = context
2025-11-09T23:42:54.9236451Z +                .block
2025-11-09T23:42:54.9236607Z +                .transactions
2025-11-09T23:42:54.9236736Z +                .iter()
2025-11-09T23:42:54.9236886Z +                .map(|_| Vec::new())
2025-11-09T23:42:54.9237024Z +                .collect();
2025-11-09T23:42:54.9237177Z              let result = connect_block(
2025-11-09T23:42:54.9237316Z                  &context.block,
2025-11-09T23:42:54.9237445Z                  &witnesses,
2025-11-09T23:42:54.9237975Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:9:
2025-11-09T23:42:54.9238140Z  async fn test_request_id_matching() {
2025-11-09T23:42:54.9238392Z      // Test that requests are matched by request_id, not FIFO
2025-11-09T23:42:54.9238716Z      let manager = NetworkManager::new(TransportPreference::TcpOnly);
2025-11-09T23:42:54.9238834Z -    
2025-11-09T23:42:54.9238950Z +
2025-11-09T23:42:54.9239226Z      let peer_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:42:54.9239346Z -    
2025-11-09T23:42:54.9239667Z +
2025-11-09T23:42:54.9239840Z      // Register multiple requests
2025-11-09T23:42:54.9240072Z      let (id1, rx1) = manager.register_request(peer_addr);
2025-11-09T23:42:54.9240282Z      let (id2, rx2) = manager.register_request(peer_addr);
2025-11-09T23:42:54.9240805Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:18:
2025-11-09T23:42:54.9241021Z      let (id3, rx3) = manager.register_request(peer_addr);
2025-11-09T23:42:54.9241135Z -    
2025-11-09T23:42:54.9241248Z +
2025-11-09T23:42:54.9241405Z      // Complete requests out of order
2025-11-09T23:42:54.9241570Z      let response2 = vec![2, 2, 2];
2025-11-09T23:42:54.9241713Z      let response1 = vec![1, 1, 1];
2025-11-09T23:42:54.9242231Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:23:
2025-11-09T23:42:54.9242385Z      let response3 = vec![3, 3, 3];
2025-11-09T23:42:54.9242500Z -    
2025-11-09T23:42:54.9242613Z +
2025-11-09T23:42:54.9242876Z      assert!(manager.complete_request(id2, response2.clone()));
2025-11-09T23:42:54.9243123Z      assert!(manager.complete_request(id1, response1.clone()));
2025-11-09T23:42:54.9243369Z      assert!(manager.complete_request(id3, response3.clone()));
2025-11-09T23:42:54.9243863Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:28:
2025-11-09T23:42:54.9243988Z -    
2025-11-09T23:42:54.9244099Z +
2025-11-09T23:42:54.9244586Z      // Verify each receiver got the correct response
2025-11-09T23:42:54.9244740Z      tokio::select! {
2025-11-09T23:42:54.9244873Z          result = rx1 => {
2025-11-09T23:42:54.9245393Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:35:
2025-11-09T23:42:54.9245544Z              panic!("Request 1 timeout");
2025-11-09T23:42:54.9245664Z          }
2025-11-09T23:42:54.9245776Z      }
2025-11-09T23:42:54.9245884Z -    
2025-11-09T23:42:54.9245999Z +
2025-11-09T23:42:54.9246139Z      tokio::select! {
2025-11-09T23:42:54.9246271Z          result = rx2 => {
2025-11-09T23:42:54.9246462Z              assert_eq!(result.unwrap(), response2);
2025-11-09T23:42:54.9246989Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:44:
2025-11-09T23:42:54.9247150Z              panic!("Request 2 timeout");
2025-11-09T23:42:54.9247267Z          }
2025-11-09T23:42:54.9247378Z      }
2025-11-09T23:42:54.9247493Z -    
2025-11-09T23:42:54.9247605Z +
2025-11-09T23:42:54.9247742Z      tokio::select! {
2025-11-09T23:42:54.9247878Z          result = rx3 => {
2025-11-09T23:42:54.9248302Z              assert_eq!(result.unwrap(), response3);
2025-11-09T23:42:54.9248837Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:59:
2025-11-09T23:42:54.9249019Z  async fn test_request_cancellation() {
2025-11-09T23:42:54.9249336Z      let manager = NetworkManager::new(TransportPreference::TcpOnly);
2025-11-09T23:42:54.9249617Z      let peer_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:42:54.9249745Z -    
2025-11-09T23:42:54.9249861Z +
2025-11-09T23:42:54.9250122Z      let (request_id, rx) = manager.register_request(peer_addr);
2025-11-09T23:42:54.9250235Z -    
2025-11-09T23:42:54.9250356Z +
2025-11-09T23:42:54.9250493Z      // Cancel the request
2025-11-09T23:42:54.9250683Z      assert!(manager.cancel_request(request_id));
2025-11-09T23:42:54.9250793Z -    
2025-11-09T23:42:54.9250913Z +
2025-11-09T23:42:54.9251074Z      // Try to complete it (should fail)
2025-11-09T23:42:54.9251353Z      assert!(!manager.complete_request(request_id, vec![1, 2, 3]));
2025-11-09T23:42:54.9251482Z -    
2025-11-09T23:42:54.9251593Z +
2025-11-09T23:42:54.9251738Z      // Receiver should be closed
2025-11-09T23:42:54.9251877Z      assert!(rx.await.is_err());
2025-11-09T23:42:54.9251991Z  }
2025-11-09T23:42:54.9252501Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:76:
2025-11-09T23:42:54.9252875Z  async fn test_timestamp_cleanup() {
2025-11-09T23:42:54.9253188Z      let manager = NetworkManager::new(TransportPreference::TcpOnly);
2025-11-09T23:42:54.9253430Z      let peer_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:42:54.9253538Z -    
2025-11-09T23:42:54.9253647Z +
2025-11-09T23:42:54.9253773Z      // Register a request
2025-11-09T23:42:54.9254026Z      let (request_id, _rx) = manager.register_request(peer_addr);
2025-11-09T23:42:54.9254140Z -    
2025-11-09T23:42:54.9254256Z +
2025-11-09T23:42:54.9254788Z      // Cleanup requests older than 0 seconds (should remove all)
2025-11-09T23:42:54.9255014Z      let cleaned = manager.cleanup_expired_requests(0);
2025-11-09T23:42:54.9255156Z      assert_eq!(cleaned, 1);
2025-11-09T23:42:54.9255665Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:86:
2025-11-09T23:42:54.9255776Z -    
2025-11-09T23:42:54.9255883Z +
2025-11-09T23:42:54.9256027Z      // Request should be gone
2025-11-09T23:42:54.9256321Z      assert!(!manager.complete_request(request_id, vec![1, 2, 3]));
2025-11-09T23:42:54.9256425Z  }
2025-11-09T23:42:54.9256908Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:92:
2025-11-09T23:42:54.9257133Z  async fn test_multiple_concurrent_requests_per_peer() {
2025-11-09T23:42:54.9257459Z      let manager = NetworkManager::new(TransportPreference::TcpOnly);
2025-11-09T23:42:54.9257722Z      let peer_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:42:54.9257836Z -    
2025-11-09T23:42:54.9257952Z +
2025-11-09T23:42:54.9258151Z      // Register multiple requests from same peer
2025-11-09T23:42:54.9266580Z      let (id1, rx1) = manager.register_request(peer_addr);
2025-11-09T23:42:54.9266842Z      let (id2, rx2) = manager.register_request(peer_addr);
2025-11-09T23:42:54.9267369Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:99:
2025-11-09T23:42:54.9267603Z      let (id3, rx3) = manager.register_request(peer_addr);
2025-11-09T23:42:54.9267728Z -    
2025-11-09T23:42:54.9267839Z +
2025-11-09T23:42:54.9267992Z      // All should be registered
2025-11-09T23:42:54.9268291Z      let pending = manager.get_pending_requests_for_peer(peer_addr);
2025-11-09T23:42:54.9268441Z      assert_eq!(pending.len(), 3);
2025-11-09T23:42:54.9268963Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:104:
2025-11-09T23:42:54.9269132Z      assert!(pending.contains(&id1));
2025-11-09T23:42:54.9269299Z      assert!(pending.contains(&id2));
2025-11-09T23:42:54.9270698Z      assert!(pending.contains(&id3));
2025-11-09T23:42:54.9270844Z -    
2025-11-09T23:42:54.9270963Z +
2025-11-09T23:42:54.9271103Z      // Complete all
2025-11-09T23:42:54.9271288Z      manager.complete_request(id1, vec![1]);
2025-11-09T23:42:54.9271467Z      manager.complete_request(id2, vec![2]);
2025-11-09T23:42:54.9272045Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:111:
2025-11-09T23:42:54.9272241Z      manager.complete_request(id3, vec![3]);
2025-11-09T23:42:54.9272361Z -    
2025-11-09T23:42:54.9272487Z +
2025-11-09T23:42:54.9272645Z      // All should receive responses
2025-11-09T23:42:54.9272820Z      assert_eq!(rx1.await.unwrap(), vec![1]);
2025-11-09T23:42:54.9272994Z      assert_eq!(rx2.await.unwrap(), vec![2]);
2025-11-09T23:42:54.9273505Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:120:
2025-11-09T23:42:54.9273670Z  async fn test_request_metrics() {
2025-11-09T23:42:54.9274006Z      let manager = NetworkManager::new(TransportPreference::TcpOnly);
2025-11-09T23:42:54.9274472Z      let peer_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:42:54.9274592Z -    
2025-11-09T23:42:54.9275037Z +
2025-11-09T23:42:54.9275229Z      // Register and complete a request
2025-11-09T23:42:54.9275463Z      let (id1, _rx1) = manager.register_request(peer_addr);
2025-11-09T23:42:54.9275912Z      manager.complete_request(id1, vec![1, 2, 3]);
2025-11-09T23:42:54.9276472Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:127:
2025-11-09T23:42:54.9276582Z -    
2025-11-09T23:42:54.9276688Z +
2025-11-09T23:42:54.9276818Z      // Check metrics
2025-11-09T23:42:54.9277060Z      let metrics = manager.get_request_metrics(peer_addr);
2025-11-09T23:42:54.9277220Z      assert!(metrics.is_some());
2025-11-09T23:42:54.9277738Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:132:
2025-11-09T23:42:54.9277924Z      assert_eq!(m.total_requests, 1);
2025-11-09T23:42:54.9278097Z      assert_eq!(m.successful_responses, 1);
2025-11-09T23:42:54.9278254Z      assert_eq!(m.failed_requests, 0);
2025-11-09T23:42:54.9278368Z -    
2025-11-09T23:42:54.9278480Z +
2025-11-09T23:42:54.9278605Z      // Record a failure
2025-11-09T23:42:54.9278822Z      let (id2, _rx2) = manager.register_request(peer_addr);
2025-11-09T23:42:54.9278996Z      manager.record_failed_request(id2);
2025-11-09T23:42:54.9279496Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:139:
2025-11-09T23:42:54.9279619Z -    
2025-11-09T23:42:54.9279728Z +
2025-11-09T23:42:54.9280432Z      let metrics = manager.get_request_metrics(peer_addr);
2025-11-09T23:42:54.9280605Z      let m = metrics.unwrap();
2025-11-09T23:42:54.9280759Z      assert_eq!(m.total_requests, 2);
2025-11-09T23:42:54.9281267Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:148:
2025-11-09T23:42:54.9281444Z  async fn test_request_priority() {
2025-11-09T23:42:54.9281757Z      let manager = NetworkManager::new(TransportPreference::TcpOnly);
2025-11-09T23:42:54.9283858Z      let peer_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:42:54.9283976Z -    
2025-11-09T23:42:54.9284087Z +
2025-11-09T23:42:54.9284278Z      // Register requests with different priorities
2025-11-09T23:42:54.9284757Z      let (_id1, _rx1) = manager.register_request_with_priority(peer_addr, 0);
2025-11-09T23:42:54.9285064Z      let (_id2, _rx2) = manager.register_request_with_priority(peer_addr, 5);
2025-11-09T23:42:54.9285585Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:155:
2025-11-09T23:42:54.9285893Z      let (_id3, _rx3) = manager.register_request_with_priority(peer_addr, 10);
2025-11-09T23:42:54.9286009Z -    
2025-11-09T23:42:54.9286126Z +
2025-11-09T23:42:54.9286276Z      // All should be registered
2025-11-09T23:42:54.9286579Z      let pending = manager.get_pending_requests_for_peer(peer_addr);
2025-11-09T23:42:54.9287005Z      assert_eq!(pending.len(), 3);
2025-11-09T23:42:54.9287530Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/async_routing_tests.rs:160:
2025-11-09T23:42:54.9287659Z  }
2025-11-09T23:42:54.9287770Z -
2025-11-09T23:42:54.9287880Z -
2025-11-09T23:42:54.9287991Z -
2025-11-09T23:42:54.9288118Z  
2025-11-09T23:42:54.9288880Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:8:
2025-11-09T23:42:54.9289053Z  async fn test_ban_list_operations() {
2025-11-09T23:42:54.9289286Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:42:54.9289480Z      let manager = NetworkManager::new(addr);
2025-11-09T23:42:54.9289596Z -    
2025-11-09T23:42:54.9289715Z +
2025-11-09T23:42:54.9289975Z      let test_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:42:54.9290088Z -    
2025-11-09T23:42:54.9290192Z +
2025-11-09T23:42:54.9290328Z      // Test ban
2025-11-09T23:42:54.9290561Z      let now = SystemTime::now()
2025-11-09T23:42:54.9290711Z          .duration_since(UNIX_EPOCH)
2025-11-09T23:42:54.9291269Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:18:
2025-11-09T23:42:54.9291396Z          .as_secs();
2025-11-09T23:42:54.9291838Z      let future_timestamp = now + 3600; // 1 hour from now
2025-11-09T23:42:54.9292060Z      manager.ban_peer(test_addr, future_timestamp);
2025-11-09T23:42:54.9292191Z -    
2025-11-09T23:42:54.9292309Z +
2025-11-09T23:42:54.9292483Z      assert!(manager.is_banned(test_addr));
2025-11-09T23:42:54.9292679Z -    
2025-11-09T23:42:54.9292795Z +
2025-11-09T23:42:54.9292920Z      // Test unban
2025-11-09T23:42:54.9293078Z      manager.unban_peer(test_addr);
2025-11-09T23:42:54.9293253Z      assert!(!manager.is_banned(test_addr));
2025-11-09T23:42:54.9295783Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:30:
2025-11-09T23:42:54.9296120Z  async fn test_ban_list_expiration() {
2025-11-09T23:42:54.9296369Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:42:54.9296566Z      let manager = NetworkManager::new(addr);
2025-11-09T23:42:54.9296681Z -    
2025-11-09T23:42:54.9296801Z +
2025-11-09T23:42:54.9297073Z      let test_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:42:54.9297190Z -    
2025-11-09T23:42:54.9297302Z +
2025-11-09T23:42:54.9297472Z      // Ban with expiration in the past
2025-11-09T23:42:54.9297628Z      let now = SystemTime::now()
2025-11-09T23:42:54.9297775Z          .duration_since(UNIX_EPOCH)
2025-11-09T23:42:54.9298325Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:40:
2025-11-09T23:42:54.9298443Z          .as_secs();
2025-11-09T23:42:54.9298621Z      let past_timestamp = now - 3600; // 1 hour ago
2025-11-09T23:42:54.9298813Z      manager.ban_peer(test_addr, past_timestamp);
2025-11-09T23:42:54.9298946Z -    
2025-11-09T23:42:54.9299060Z +
2025-11-09T23:42:54.9299268Z      // is_banned should automatically check expiration
2025-11-09T23:42:54.9299445Z      assert!(!manager.is_banned(test_addr));
2025-11-09T23:42:54.9299551Z  }
2025-11-09T23:42:54.9300106Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:49:
2025-11-09T23:42:54.9300271Z  async fn test_ban_list_permanent() {
2025-11-09T23:42:54.9300482Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:42:54.9300655Z      let manager = NetworkManager::new(addr);
2025-11-09T23:42:54.9300770Z -    
2025-11-09T23:42:54.9300895Z +
2025-11-09T23:42:54.9301145Z      let test_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:42:54.9301253Z -    
2025-11-09T23:42:54.9301358Z +
2025-11-09T23:42:54.9301516Z      // Permanent ban (timestamp = 0)
2025-11-09T23:42:54.9301665Z      manager.ban_peer(test_addr, 0);
2025-11-09T23:42:54.9301833Z      assert!(manager.is_banned(test_addr));
2025-11-09T23:42:54.9302632Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:58:
2025-11-09T23:42:54.9302745Z -    
2025-11-09T23:42:54.9302852Z +
2025-11-09T23:42:54.9302988Z      // Clear all bans
2025-11-09T23:42:54.9303129Z      manager.clear_bans();
2025-11-09T23:42:54.9303299Z      assert!(!manager.is_banned(test_addr));
2025-11-09T23:42:54.9303847Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:66:
2025-11-09T23:42:54.9304035Z  async fn test_ban_list_multiple_peers() {
2025-11-09T23:42:54.9304247Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:42:54.9304595Z      let manager = NetworkManager::new(addr);
2025-11-09T23:42:54.9304729Z -    
2025-11-09T23:42:54.9304842Z +
2025-11-09T23:42:54.9305074Z      let addr1: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:42:54.9305305Z      let addr2: SocketAddr = "127.0.0.1:8334".parse().unwrap();
2025-11-09T23:42:54.9305550Z      let addr3: SocketAddr = "127.0.0.1:8335".parse().unwrap();
2025-11-09T23:42:54.9306094Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:73:
2025-11-09T23:42:54.9306206Z -    
2025-11-09T23:42:54.9306321Z +
2025-11-09T23:42:54.9306478Z      let now = SystemTime::now()
2025-11-09T23:42:54.9306832Z          .duration_since(UNIX_EPOCH)
2025-11-09T23:42:54.9306968Z          .unwrap()
2025-11-09T23:42:54.9307542Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:77:
2025-11-09T23:42:54.9307664Z          .as_secs();
2025-11-09T23:42:54.9307771Z -    
2025-11-09T23:42:54.9307895Z +
2025-11-09T23:42:54.9308056Z      manager.ban_peer(addr1, now + 3600);
2025-11-09T23:42:54.9308216Z      manager.ban_peer(addr2, 0); // Permanent
2025-11-09T23:42:54.9308386Z      manager.ban_peer(addr3, now + 7200);
2025-11-09T23:42:54.9308950Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:82:
2025-11-09T23:42:54.9309078Z -    
2025-11-09T23:42:54.9309194Z +
2025-11-09T23:42:54.9309415Z      assert_eq!(manager.get_banned_peers().len(), 3);
2025-11-09T23:42:54.9309576Z      assert!(manager.is_banned(addr1));
2025-11-09T23:42:54.9309738Z      assert!(manager.is_banned(addr2));
2025-11-09T23:42:54.9310322Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:86:
2025-11-09T23:42:54.9310483Z      assert!(manager.is_banned(addr3));
2025-11-09T23:42:54.9310600Z -    
2025-11-09T23:42:54.9310706Z +
2025-11-09T23:42:54.9310833Z      // Unban one
2025-11-09T23:42:54.9310983Z      manager.unban_peer(addr2);
2025-11-09T23:42:54.9311186Z      assert_eq!(manager.get_banned_peers().len(), 2);
2025-11-09T23:42:54.9311752Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_integration_tests.rs:91:
2025-11-09T23:42:54.9311923Z      assert!(!manager.is_banned(addr2));
2025-11-09T23:42:54.9312050Z  }
2025-11-09T23:42:54.9312165Z -
2025-11-09T23:42:54.9312291Z  
2025-11-09T23:42:54.9312841Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_tests.rs:22:
2025-11-09T23:42:54.9313004Z          .duration_since(UNIX_EPOCH)
2025-11-09T23:42:54.9313140Z          .unwrap()
2025-11-09T23:42:54.9313264Z          .as_secs();
2025-11-09T23:42:54.9313388Z -    
2025-11-09T23:42:54.9313500Z +
2025-11-09T23:42:54.9313941Z      // Create two ban lists with overlapping entries
2025-11-09T23:42:54.9314100Z      let list1 = BanListMessage {
2025-11-09T23:42:54.9314230Z          is_full: true,
2025-11-09T23:42:54.9314878Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_tests.rs:29:
2025-11-09T23:42:54.9315037Z          ban_list_hash: [0; 32],
2025-11-09T23:42:54.9315175Z          ban_entries: vec![
2025-11-09T23:42:54.9315513Z -            create_test_ban_entry([127, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 8333, now + 3600),
2025-11-09T23:42:54.9316107Z -            create_test_ban_entry([192, 168, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 8333, now + 7200),
2025-11-09T23:42:54.9316265Z +            create_test_ban_entry(
2025-11-09T23:42:54.9316443Z +                [127, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
2025-11-09T23:42:54.9316575Z +                8333,
2025-11-09T23:42:54.9316713Z +                now + 3600,
2025-11-09T23:42:54.9316830Z +            ),
2025-11-09T23:42:54.9316982Z +            create_test_ban_entry(
2025-11-09T23:42:54.9317167Z +                [192, 168, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
2025-11-09T23:42:54.9317289Z +                8333,
2025-11-09T23:42:54.9317419Z +                now + 7200,
2025-11-09T23:42:54.9317547Z +            ),
2025-11-09T23:42:54.9317663Z          ],
2025-11-09T23:42:54.9317795Z          timestamp: now,
2025-11-09T23:42:54.9317921Z      };
2025-11-09T23:42:54.9318394Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_tests.rs:36:
2025-11-09T23:42:54.9318518Z -    
2025-11-09T23:42:54.9318630Z +
2025-11-09T23:42:54.9318786Z      let list2 = BanListMessage {
2025-11-09T23:42:54.9318912Z          is_full: true,
2025-11-09T23:42:54.9319042Z          ban_list_hash: [0; 32],
2025-11-09T23:42:54.9319521Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_tests.rs:40:
2025-11-09T23:42:54.9319910Z          ban_entries: vec![
2025-11-09T23:42:54.9320092Z              // Same address, longer ban
2025-11-09T23:42:54.9320430Z -            create_test_ban_entry([127, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 8333, now + 7200),
2025-11-09T23:42:54.9320581Z +            create_test_ban_entry(
2025-11-09T23:42:54.9320756Z +                [127, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
2025-11-09T23:42:54.9320879Z +                8333,
2025-11-09T23:42:54.9321018Z +                now + 7200,
2025-11-09T23:42:54.9321136Z +            ),
2025-11-09T23:42:54.9321269Z              // New address
2025-11-09T23:42:54.9321605Z -            create_test_ban_entry([10, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 8333, now + 1800),
2025-11-09T23:42:54.9321757Z +            create_test_ban_entry(
2025-11-09T23:42:54.9321930Z +                [10, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
2025-11-09T23:42:54.9322051Z +                8333,
2025-11-09T23:42:54.9322206Z +                now + 1800,
2025-11-09T23:42:54.9322327Z +            ),
2025-11-09T23:42:54.9322442Z          ],
2025-11-09T23:42:54.9322586Z          timestamp: now,
2025-11-09T23:42:54.9322703Z      };
2025-11-09T23:42:54.9323182Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_tests.rs:48:
2025-11-09T23:42:54.9323296Z -    
2025-11-09T23:42:54.9323418Z +
2025-11-09T23:42:54.9323630Z      let merged = merge_ban_lists(vec![&list1, &list2]);
2025-11-09T23:42:54.9323746Z -    
2025-11-09T23:42:54.9323867Z +
2025-11-09T23:42:54.9324024Z      // Should have 3 unique addresses
2025-11-09T23:42:54.9324180Z      assert_eq!(merged.len(), 3);
2025-11-09T23:42:54.9324290Z -    
2025-11-09T23:42:54.9324616Z +
2025-11-09T23:42:54.9324792Z      // 127.0.0.1 should have longer ban (7200)
2025-11-09T23:42:54.9324940Z -    let entry_127 = merged.iter()
2025-11-09T23:42:54.9325097Z -        .find(|e| e.addr.ip[0] == 127)
2025-11-09T23:42:54.9325219Z -        .unwrap();
2025-11-09T23:42:54.9325515Z +    let entry_127 = merged.iter().find(|e| e.addr.ip[0] == 127).unwrap();
2025-11-09T23:42:54.9325731Z      assert_eq!(entry_127.unban_timestamp, now + 7200);
2025-11-09T23:42:54.9325851Z  }
2025-11-09T23:42:54.9325957Z  
2025-11-09T23:42:54.9326408Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_tests.rs:64:
2025-11-09T23:42:54.9326556Z          .duration_since(UNIX_EPOCH)
2025-11-09T23:42:54.9326669Z          .unwrap()
2025-11-09T23:42:54.9326782Z          .as_secs();
2025-11-09T23:42:54.9326887Z -    
2025-11-09T23:42:54.9326995Z +
2025-11-09T23:42:54.9327118Z      // Valid future ban
2025-11-09T23:42:54.9327778Z -    let future_ban = create_test_ban_entry([127, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 8333, now + 3600);
2025-11-09T23:42:54.9327961Z +    let future_ban = create_test_ban_entry(
2025-11-09T23:42:54.9328132Z +        [127, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
2025-11-09T23:42:54.9328243Z +        8333,
2025-11-09T23:42:54.9328378Z +        now + 3600,
2025-11-09T23:42:54.9328489Z +    );
2025-11-09T23:42:54.9328661Z      assert!(validate_ban_entry(&future_ban));
2025-11-09T23:42:54.9328775Z -    
2025-11-09T23:42:54.9328892Z +
2025-11-09T23:42:54.9329033Z      // Valid permanent ban
2025-11-09T23:42:54.9329487Z -    let permanent_ban = create_test_ban_entry([192, 168, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 8333, u64::MAX);
2025-11-09T23:42:54.9329679Z +    let permanent_ban = create_test_ban_entry(
2025-11-09T23:42:54.9329853Z +        [192, 168, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
2025-11-09T23:42:54.9329966Z +        8333,
2025-11-09T23:42:54.9330113Z +        u64::MAX,
2025-11-09T23:42:54.9330233Z +    );
2025-11-09T23:42:54.9330414Z      assert!(validate_ban_entry(&permanent_ban));
2025-11-09T23:42:54.9330531Z -    
2025-11-09T23:42:54.9330653Z +
2025-11-09T23:42:54.9330813Z      // Expired ban (should be invalid)
2025-11-09T23:42:54.9331550Z -    let expired_ban = create_test_ban_entry([10, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 8333, now.saturating_sub(3600));
2025-11-09T23:42:54.9331745Z +    let expired_ban = create_test_ban_entry(
2025-11-09T23:42:54.9331915Z +        [10, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
2025-11-09T23:42:54.9332039Z +        8333,
2025-11-09T23:42:54.9332194Z +        now.saturating_sub(3600),
2025-11-09T23:42:54.9332323Z +    );
2025-11-09T23:42:54.9332510Z      assert!(!validate_ban_entry(&expired_ban));
2025-11-09T23:42:54.9332625Z  }
2025-11-09T23:42:54.9332739Z  
2025-11-09T23:42:54.9333234Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_tests.rs:84:
2025-11-09T23:42:54.9333393Z          .duration_since(UNIX_EPOCH)
2025-11-09T23:42:54.9333511Z          .unwrap()
2025-11-09T23:42:54.9333640Z          .as_secs();
2025-11-09T23:42:54.9333747Z -    
2025-11-09T23:42:54.9333855Z +
2025-11-09T23:42:54.9333987Z      let entries = vec![
2025-11-09T23:42:54.9334476Z -        create_test_ban_entry([127, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 8333, now + 3600),
2025-11-09T23:42:54.9334814Z -        create_test_ban_entry([192, 168, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 8333, now + 7200),
2025-11-09T23:42:54.9334958Z +        create_test_ban_entry(
2025-11-09T23:42:54.9335136Z +            [127, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
2025-11-09T23:42:54.9335252Z +            8333,
2025-11-09T23:42:54.9335378Z +            now + 3600,
2025-11-09T23:42:54.9335499Z +        ),
2025-11-09T23:42:54.9335633Z +        create_test_ban_entry(
2025-11-09T23:42:54.9335811Z +            [192, 168, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
2025-11-09T23:42:54.9335945Z +            8333,
2025-11-09T23:42:54.9336083Z +            now + 7200,
2025-11-09T23:42:54.9336194Z +        ),
2025-11-09T23:42:54.9336303Z      ];
2025-11-09T23:42:54.9336414Z -    
2025-11-09T23:42:54.9336535Z +
2025-11-09T23:42:54.9338768Z      let hash1 = calculate_ban_list_hash(&entries);
2025-11-09T23:42:54.9338979Z      let hash2 = calculate_ban_list_hash(&entries);
2025-11-09T23:42:54.9339107Z -    
2025-11-09T23:42:54.9339224Z +
2025-11-09T23:42:54.9339409Z      // Same entries should produce same hash
2025-11-09T23:42:54.9339557Z      assert_eq!(hash1, hash2);
2025-11-09T23:42:54.9339682Z -    
2025-11-09T23:42:54.9339800Z +
2025-11-09T23:42:54.9339930Z      // Verify hash
2025-11-09T23:42:54.9340151Z      assert!(verify_ban_list_hash(&entries, &hash1));
2025-11-09T23:42:54.9340267Z  }
2025-11-09T23:42:54.9340774Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/ban_list_tests.rs:102:
2025-11-09T23:42:54.9340886Z -
2025-11-09T23:42:54.9341007Z -
2025-11-09T23:42:54.9341378Z -
2025-11-09T23:42:54.9341494Z  
2025-11-09T23:42:54.9342095Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip158_implementation_tests.rs:1:
2025-11-09T23:42:54.9342251Z  //! Tests for BIP158 implementation
2025-11-09T23:42:54.9342363Z  
2025-11-09T23:42:54.9342752Z  use bllvm_node::bip158::{build_block_filter, match_filter, CompactBlockFilter};
2025-11-09T23:42:54.9343164Z -use bllvm_protocol::{Transaction, TransactionInput, TransactionOutput, OutPoint};
2025-11-09T23:42:54.9343562Z +use bllvm_protocol::{OutPoint, Transaction, TransactionInput, TransactionOutput};
2025-11-09T23:42:54.9343679Z  
2025-11-09T23:42:54.9343801Z  #[test]
2025-11-09T23:42:54.9344000Z  fn test_build_block_filter_with_transactions() {
2025-11-09T23:42:54.9344728Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip158_implementation_tests.rs:15:
2025-11-09T23:42:54.9344864Z          }],
2025-11-09T23:42:54.9344992Z          lock_time: 0,
2025-11-09T23:42:54.9345105Z      };
2025-11-09T23:42:54.9345228Z -    
2025-11-09T23:42:54.9345349Z +
2025-11-09T23:42:54.9345490Z      let tx2 = Transaction {
2025-11-09T23:42:54.9345614Z          version: 1,
2025-11-09T23:42:54.9345749Z          inputs: vec![],
2025-11-09T23:42:54.9348225Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip158_implementation_tests.rs:25:
2025-11-09T23:42:54.9348573Z          }],
2025-11-09T23:42:54.9348722Z          lock_time: 0,
2025-11-09T23:42:54.9348850Z      };
2025-11-09T23:42:54.9348967Z -    
2025-11-09T23:42:54.9349084Z +
2025-11-09T23:42:54.9349348Z      let filter = build_block_filter(&[tx1, tx2], &[]).unwrap();
2025-11-09T23:42:54.9349522Z      assert_eq!(filter.num_elements, 2);
2025-11-09T23:42:54.9349708Z      assert!(!filter.filter_data.is_empty());
2025-11-09T23:42:54.9350293Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip158_implementation_tests.rs:42:
2025-11-09T23:42:54.9350421Z          }],
2025-11-09T23:42:54.9350554Z          lock_time: 0,
2025-11-09T23:42:54.9350681Z      };
2025-11-09T23:42:54.9350804Z -    
2025-11-09T23:42:54.9350917Z +
2025-11-09T23:42:54.9351183Z      let filter = build_block_filter(&[tx.clone()], &[]).unwrap();
2025-11-09T23:42:54.9351298Z -    
2025-11-09T23:42:54.9351418Z +
2025-11-09T23:42:54.9351608Z      // Script that's in the filter should match
2025-11-09T23:42:54.9351897Z      assert!(match_filter(&filter, &tx.outputs[0].script_pubkey));
2025-11-09T23:42:54.9352021Z  }
2025-11-09T23:42:54.9352612Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip158_implementation_tests.rs:67:
2025-11-09T23:42:54.9352734Z          }],
2025-11-09T23:42:54.9352862Z          lock_time: 0,
2025-11-09T23:42:54.9353055Z      };
2025-11-09T23:42:54.9353170Z -    
2025-11-09T23:42:54.9353280Z +
2025-11-09T23:42:54.9353476Z      // Previous output script (UTXO being spent)
2025-11-09T23:42:54.9353679Z      let prev_script = vec![0x54, 0x55]; // OP_4 OP_5
2025-11-09T23:42:54.9353792Z -    
2025-11-09T23:42:54.9353910Z +
2025-11-09T23:42:54.9354241Z      let filter = build_block_filter(&[tx], &[prev_script.clone()]).unwrap();
2025-11-09T23:42:54.9354512Z -    
2025-11-09T23:42:54.9354627Z +
2025-11-09T23:42:54.9354867Z      // Both output script and previous script should match
2025-11-09T23:42:54.9355029Z      assert!(filter.num_elements >= 1);
2025-11-09T23:42:54.9355142Z  }
2025-11-09T23:42:54.9355734Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip158_implementation_tests.rs:79:
2025-11-09T23:42:54.9355859Z -
2025-11-09T23:42:54.9356029Z  
2025-11-09T23:42:54.9356610Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:1:
2025-11-09T23:42:54.9356830Z  //! Tests for BIP70 payment verification and signing
2025-11-09T23:42:54.9356943Z  
2025-11-09T23:42:54.9357402Z -use bllvm_node::bip70::{PaymentRequest, Payment, PaymentOutput, PaymentProtocolServer};
2025-11-09T23:42:54.9357633Z -use bllvm_node::network::protocol::PaymentMessage;
2025-11-09T23:42:54.9358310Z -use bllvm_protocol::{Transaction, TransactionInput, TransactionOutput, OutPoint};
2025-11-09T23:42:54.9358666Z  use bllvm_consensus::serialization::transaction::serialize_transaction;
2025-11-09T23:42:54.9359108Z +use bllvm_node::bip70::{Payment, PaymentOutput, PaymentProtocolServer, PaymentRequest};
2025-11-09T23:42:54.9359339Z +use bllvm_node::network::protocol::PaymentMessage;
2025-11-09T23:42:54.9359748Z +use bllvm_protocol::{OutPoint, Transaction, TransactionInput, TransactionOutput};
2025-11-09T23:42:54.9359919Z  use secp256k1::{Secp256k1, SecretKey};
2025-11-09T23:42:54.9360035Z  
2025-11-09T23:42:54.9360155Z  #[test]
2025-11-09T23:42:54.9360636Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:13:
2025-11-09T23:42:54.9360788Z          script: vec![0x51], // OP_1
2025-11-09T23:42:54.9360927Z          amount: Some(1000),
2025-11-09T23:42:54.9361052Z      };
2025-11-09T23:42:54.9361163Z -    
2025-11-09T23:42:54.9361440Z -    let payment_request = PaymentRequest::new(
2025-11-09T23:42:54.9361595Z -        "main".to_string(),
2025-11-09T23:42:54.9361747Z -        vec![output.clone()],
2025-11-09T23:42:54.9361865Z -        1234567890,
2025-11-09T23:42:54.9361978Z -    );
2025-11-09T23:42:54.9362098Z -    
2025-11-09T23:42:54.9362211Z +
2025-11-09T23:42:54.9362909Z +    let payment_request = PaymentRequest::new("main".to_string(), vec![output.clone()], 1234567890);
2025-11-09T23:42:54.9363042Z +
2025-11-09T23:42:54.9363211Z      // Create a payment transaction
2025-11-09T23:42:54.9363350Z      let tx = Transaction {
2025-11-09T23:42:54.9363475Z          version: 1,
2025-11-09T23:42:54.9363954Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:37:
2025-11-09T23:42:54.9364076Z          }],
2025-11-09T23:42:54.9364205Z          lock_time: 0,
2025-11-09T23:42:54.9364472Z      };
2025-11-09T23:42:54.9364600Z -    
2025-11-09T23:42:54.9364715Z +
2025-11-09T23:42:54.9364908Z      let tx_bytes = serialize_transaction(&tx);
2025-11-09T23:42:54.9365043Z -    
2025-11-09T23:42:54.9365154Z +
2025-11-09T23:42:54.9365349Z      let payment = Payment::new(vec![tx_bytes]);
2025-11-09T23:42:54.9365461Z -    
2025-11-09T23:42:54.9365583Z +
2025-11-09T23:42:54.9365730Z      // Create payment message
2025-11-09T23:42:54.9365897Z      let payment_msg = PaymentMessage {
2025-11-09T23:42:54.9366033Z          payment,
2025-11-09T23:42:54.9366764Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:48:
2025-11-09T23:42:54.9367558Z          payment_id: vec![1, 2, 3, 4],
2025-11-09T23:42:54.9367937Z      };
2025-11-09T23:42:54.9368185Z -    
2025-11-09T23:42:54.9368438Z +
2025-11-09T23:42:54.9368784Z      // Process payment (without merchant key for now)
2025-11-09T23:42:54.9369367Z      let result = PaymentProtocolServer::process_payment(
2025-11-09T23:42:54.9369883Z          &payment_msg,
2025-11-09T23:42:54.9370550Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:54:
2025-11-09T23:42:54.9371330Z          &payment_request,
2025-11-09T23:42:54.9371731Z          None, // No merchant key
2025-11-09T23:42:54.9372114Z      );
2025-11-09T23:42:54.9372393Z -    
2025-11-09T23:42:54.9372664Z +
2025-11-09T23:42:54.9373006Z      // Should succeed (validation passes)
2025-11-09T23:42:54.9373466Z      assert!(result.is_ok());
2025-11-09T23:42:54.9373840Z  }
2025-11-09T23:42:54.9374708Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:63:
2025-11-09T23:42:54.9375513Z  fn test_payment_ack_signing() {
2025-11-09T23:42:54.9375952Z      let secp = Secp256k1::new();
2025-11-09T23:42:54.9376470Z      let merchant_key = SecretKey::from_slice(&[1; 32]).unwrap();
2025-11-09T23:42:54.9376994Z -    
2025-11-09T23:42:54.9377261Z +
2025-11-09T23:42:54.9377600Z      // Create payment request with merchant pubkey
2025-11-09T23:42:54.9378091Z      let output = PaymentOutput {
2025-11-09T23:42:54.9378516Z          script: vec![0x51],
2025-11-09T23:42:54.9379522Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:70:
2025-11-09T23:42:54.9380317Z          amount: Some(1000),
2025-11-09T23:42:54.9380689Z      };
2025-11-09T23:42:54.9380957Z -    
2025-11-09T23:42:54.9381341Z -    let mut payment_request = PaymentRequest::new(
2025-11-09T23:42:54.9381839Z -        "main".to_string(),
2025-11-09T23:42:54.9382219Z -        vec![output],
2025-11-09T23:42:54.9382545Z -        1234567890,
2025-11-09T23:42:54.9382865Z -    );
2025-11-09T23:42:54.9383122Z -    
2025-11-09T23:42:54.9383434Z +
2025-11-09T23:42:54.9384019Z +    let mut payment_request = PaymentRequest::new("main".to_string(), vec![output], 1234567890);
2025-11-09T23:42:54.9384940Z +
2025-11-09T23:42:54.9385241Z      // Set merchant pubkey
2025-11-09T23:42:54.9385887Z      let merchant_pubkey = secp256k1::PublicKey::from_secret_key(&secp, &merchant_key);
2025-11-09T23:42:54.9386787Z      payment_request.merchant_pubkey = Some(merchant_pubkey.serialize().to_vec());
2025-11-09T23:42:54.9387785Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:82:
2025-11-09T23:42:54.9388516Z -    
2025-11-09T23:42:54.9388775Z +
2025-11-09T23:42:54.9389040Z      // Create payment
2025-11-09T23:42:54.9389376Z      let tx = Transaction {
2025-11-09T23:42:54.9389735Z          version: 1,
2025-11-09T23:42:54.9390599Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:97:
2025-11-09T23:42:54.9391337Z          }],
2025-11-09T23:42:54.9391635Z          lock_time: 0,
2025-11-09T23:42:54.9391960Z      };
2025-11-09T23:42:54.9392226Z -    
2025-11-09T23:42:54.9392490Z +
2025-11-09T23:42:54.9392803Z      let tx_bytes = serialize_transaction(&tx);
2025-11-09T23:42:54.9393327Z      let payment = Payment::new(vec![tx_bytes]);
2025-11-09T23:42:54.9393779Z -    
2025-11-09T23:42:54.9394044Z +
2025-11-09T23:42:54.9395994Z      let payment_msg = PaymentMessage {
2025-11-09T23:42:54.9397066Z          payment,
2025-11-09T23:42:54.9397441Z          payment_id: vec![1, 2, 3, 4],
2025-11-09T23:42:54.9398226Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:107:
2025-11-09T23:42:54.9398986Z      };
2025-11-09T23:42:54.9399253Z -    
2025-11-09T23:42:54.9399528Z +
2025-11-09T23:42:54.9399839Z      // Process payment with merchant key
2025-11-09T23:42:54.9400416Z -    let result = PaymentProtocolServer::process_payment(
2025-11-09T23:42:54.9400928Z -        &payment_msg,
2025-11-09T23:42:54.9401269Z -        &payment_request,
2025-11-09T23:42:54.9401635Z -        Some(&merchant_key),
2025-11-09T23:42:54.9401994Z -    );
2025-11-09T23:42:54.9402251Z -    
2025-11-09T23:42:54.9402524Z +    let result =
2025-11-09T23:42:54.9403303Z +        PaymentProtocolServer::process_payment(&payment_msg, &payment_request, Some(&merchant_key));
2025-11-09T23:42:54.9404065Z +
2025-11-09T23:42:54.9404541Z      assert!(result.is_ok());
2025-11-09T23:42:54.9404952Z      let ack_msg = result.unwrap();
2025-11-09T23:42:54.9405365Z -    
2025-11-09T23:42:54.9405636Z +
2025-11-09T23:42:54.9405998Z      // Verify signature is present when key provided
2025-11-09T23:42:54.9406652Z      assert!(!ack_msg.merchant_signature.is_empty());
2025-11-09T23:42:54.9407133Z  }
2025-11-09T23:42:54.9407753Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/bip70_tests.rs:122:
2025-11-09T23:42:54.9408478Z -
2025-11-09T23:42:54.9408733Z  
2025-11-09T23:42:54.9409300Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:1:
2025-11-09T23:42:54.9410167Z -use bllvm_protocol::ProtocolVersion;
2025-11-09T23:42:54.9410696Z  use bllvm_node::storage::blockstore::BlockStore;
2025-11-09T23:42:54.9411314Z  use bllvm_node::storage::chainstate::ChainState;
2025-11-09T23:42:54.9411836Z  use bllvm_node::storage::txindex::TxIndex;
2025-11-09T23:42:54.9412600Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:9:
2025-11-09T23:42:54.9413335Z  use bllvm_node::OutPoint;
2025-11-09T23:42:54.9414497Z  use bllvm_node::Transaction;
2025-11-09T23:42:54.9415055Z  use bllvm_node::{ByteString, TransactionInput, TransactionOutput};
2025-11-09T23:42:54.9415691Z +use bllvm_protocol::ProtocolVersion;
2025-11-09T23:42:54.9416159Z  use std::collections::HashMap;
2025-11-09T23:42:54.9416565Z  use tempfile::TempDir;
2025-11-09T23:42:54.9416902Z  
2025-11-09T23:42:54.9417693Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:1:
2025-11-09T23:42:54.9418543Z  //! Tests for fee calculation functionality
2025-11-09T23:42:54.9418959Z  
2025-11-09T23:42:54.9419318Z  use bllvm_node::node::mempool::MempoolManager;
2025-11-09T23:42:54.9419928Z -use bllvm_protocol::{Transaction, UtxoSet, OutPoint, UTXO};
2025-11-09T23:42:54.9420568Z +use bllvm_protocol::{OutPoint, Transaction, UtxoSet, UTXO};
2025-11-09T23:42:54.9421526Z  
2025-11-09T23:42:54.9421786Z  #[test]
2025-11-09T23:42:54.9422105Z  fn test_calculate_transaction_fee() {
2025-11-09T23:42:54.9422931Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:8:
2025-11-09T23:42:54.9423761Z      let mempool = MempoolManager::new();
2025-11-09T23:42:54.9424186Z -    
2025-11-09T23:42:54.9424641Z +
2025-11-09T23:42:54.9426710Z      // Create a simple transaction
2025-11-09T23:42:54.9427218Z      let mut utxo_set = UtxoSet::new();
2025-11-09T23:42:54.9427844Z -    
2025-11-09T23:42:54.9428128Z +
2025-11-09T23:42:54.9428384Z      // Add a UTXO
2025-11-09T23:42:54.9428720Z      let outpoint = OutPoint {
2025-11-09T23:42:54.9429164Z          hash: [0u8; 32],
2025-11-09T23:42:54.9429927Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:16:
2025-11-09T23:42:54.9430745Z          index: 0,
2025-11-09T23:42:54.9431045Z      };
2025-11-09T23:42:54.9431316Z      let utxo = UTXO {
2025-11-09T23:42:54.9431663Z -        value: 100_000_000, // 1 BTC
2025-11-09T23:42:54.9432096Z +        value: 100_000_000,                    // 1 BTC
2025-11-09T23:42:54.9432651Z          script_pubkey: vec![0x76, 0xa9, 0x14], // P2PKH script
2025-11-09T23:42:54.9433151Z      };
2025-11-09T23:42:54.9433452Z      utxo_set.insert(outpoint, utxo);
2025-11-09T23:42:54.9435350Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:23:
2025-11-09T23:42:54.9436296Z -    
2025-11-09T23:42:54.9436576Z +
2025-11-09T23:42:54.9436913Z      // Create transaction with 1 input and 1 output
2025-11-09T23:42:54.9437396Z      let tx = Transaction {
2025-11-09T23:42:54.9437757Z          version: 1,
2025-11-09T23:42:54.9438495Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:36:
2025-11-09T23:42:54.9439316Z          }],
2025-11-09T23:42:54.9439618Z          lock_time: 0,
2025-11-09T23:42:54.9439942Z      };
2025-11-09T23:42:54.9440203Z -    
2025-11-09T23:42:54.9440475Z +
2025-11-09T23:42:54.9440881Z      let fee = mempool.calculate_transaction_fee(&tx, &utxo_set);
2025-11-09T23:42:54.9441425Z -    
2025-11-09T23:42:54.9441686Z +
2025-11-09T23:42:54.9442089Z      // Fee should be 1 BTC - 0.99 BTC = 0.01 BTC = 1,000,000 satoshis
2025-11-09T23:42:54.9442628Z      assert_eq!(fee, 1_000_000);
2025-11-09T23:42:54.9442997Z  }
2025-11-09T23:42:54.9443685Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:46:
2025-11-09T23:42:54.9447044Z  #[test]
2025-11-09T23:42:54.9447396Z  fn test_calculate_transaction_fee_zero_fee() {
2025-11-09T23:42:54.9448316Z      let mempool = MempoolManager::new();
2025-11-09T23:42:54.9448763Z -    
2025-11-09T23:42:54.9449029Z +
2025-11-09T23:42:54.9449339Z      let mut utxo_set = UtxoSet::new();
2025-11-09T23:42:54.9449785Z      let outpoint = OutPoint {
2025-11-09T23:42:54.9450193Z          hash: [0u8; 32],
2025-11-09T23:42:54.9450952Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:57:
2025-11-09T23:42:54.9451799Z          script_pubkey: vec![],
2025-11-09T23:42:54.9452470Z      };
2025-11-09T23:42:54.9452807Z      utxo_set.insert(outpoint, utxo);
2025-11-09T23:42:54.9453215Z -    
2025-11-09T23:42:54.9453488Z +
2025-11-09T23:42:54.9455925Z      // Transaction with same input and output (no fee)
2025-11-09T23:42:54.9456427Z      let tx = Transaction {
2025-11-09T23:42:54.9466772Z          version: 1,
2025-11-09T23:42:54.9467585Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:73:
2025-11-09T23:42:54.9468365Z          }],
2025-11-09T23:42:54.9468638Z          lock_time: 0,
2025-11-09T23:42:54.9468944Z      };
2025-11-09T23:42:54.9469188Z -    
2025-11-09T23:42:54.9469451Z +
2025-11-09T23:42:54.9469851Z      let fee = mempool.calculate_transaction_fee(&tx, &utxo_set);
2025-11-09T23:42:54.9470393Z      assert_eq!(fee, 0);
2025-11-09T23:42:54.9470725Z  }
2025-11-09T23:42:54.9471390Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:81:
2025-11-09T23:42:54.9472222Z  #[test]
2025-11-09T23:42:54.9472589Z  fn test_calculate_transaction_fee_missing_utxo() {
2025-11-09T23:42:54.9473136Z      let mempool = MempoolManager::new();
2025-11-09T23:42:54.9473569Z -    
2025-11-09T23:42:54.9473839Z +
2025-11-09T23:42:54.9474198Z      let utxo_set = UtxoSet::new(); // Empty UTXO set
2025-11-09T23:42:54.9474872Z -    
2025-11-09T23:42:54.9475144Z +
2025-11-09T23:42:54.9475704Z      let outpoint = OutPoint {
2025-11-09T23:42:54.9476125Z          hash: [0u8; 32],
2025-11-09T23:42:54.9476474Z          index: 0,
2025-11-09T23:42:54.9477217Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:90:
2025-11-09T23:42:54.9478036Z      };
2025-11-09T23:42:54.9479837Z -    
2025-11-09T23:42:54.9480109Z +
2025-11-09T23:42:54.9480405Z      let tx = Transaction {
2025-11-09T23:42:54.9480770Z          version: 1,
2025-11-09T23:42:54.9481165Z          inputs: vec![bllvm_protocol::TxIn {
2025-11-09T23:42:54.9482006Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:103:
2025-11-09T23:42:54.9482808Z          }],
2025-11-09T23:42:54.9483102Z          lock_time: 0,
2025-11-09T23:42:54.9483422Z      };
2025-11-09T23:42:54.9483688Z -    
2025-11-09T23:42:54.9483949Z +
2025-11-09T23:42:54.9484527Z      let fee = mempool.calculate_transaction_fee(&tx, &utxo_set);
2025-11-09T23:42:54.9485338Z      // If UTXO is missing, input_total will be 0, so fee will be 0 (or negative, but we return 0)
2025-11-09T23:42:54.9486036Z      assert_eq!(fee, 0);
2025-11-09T23:42:54.9486858Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/fee_calculation_tests.rs:110:
2025-11-09T23:42:54.9487698Z  }
2025-11-09T23:42:54.9487947Z -
2025-11-09T23:42:54.9488206Z  
2025-11-09T23:42:54.9488902Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/iroh_peer_tracking_tests.rs:1:
2025-11-09T23:42:54.9489827Z  //! Tests for Iroh peer tracking with TransportAddr
2025-11-09T23:42:54.9490314Z  
2025-11-09T23:42:54.9490730Z -use bllvm_node::network::{NetworkManager, PeerManager};
2025-11-09T23:42:54.9491361Z  use bllvm_node::network::transport::TransportAddr;
2025-11-09T23:42:54.9491967Z +use bllvm_node::network::{NetworkManager, PeerManager};
2025-11-09T23:42:54.9492505Z  use std::net::SocketAddr;
2025-11-09T23:42:54.9492857Z  
2025-11-09T23:42:54.9493128Z  #[test]
2025-11-09T23:42:54.9493820Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/iroh_peer_tracking_tests.rs:8:
2025-11-09T23:42:54.9494900Z  fn test_peer_manager_transport_addr() {
2025-11-09T23:42:54.9495408Z      let mut manager = PeerManager::new(10);
2025-11-09T23:42:54.9495830Z -    
2025-11-09T23:42:54.9496098Z +
2025-11-09T23:42:54.9498137Z      let addr1: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:42:54.9498778Z      let addr2: SocketAddr = "127.0.0.1:8334".parse().unwrap();
2025-11-09T23:42:54.9499281Z -    
2025-11-09T23:42:54.9499559Z +
2025-11-09T23:42:54.9499832Z      // Test TCP peer
2025-11-09T23:42:54.9500495Z      let tcp_addr1 = TransportAddr::Tcp(addr1);
2025-11-09T23:42:54.9501014Z      let tcp_addr2 = TransportAddr::Tcp(addr2);
2025-11-09T23:42:54.9501895Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/iroh_peer_tracking_tests.rs:17:
2025-11-09T23:42:54.9502742Z -    
2025-11-09T23:42:54.9503010Z +
2025-11-09T23:42:54.9503471Z      // Create mock peers (would need actual Peer instances in real test)
2025-11-09T23:42:54.9504195Z      // For now, just test that TransportAddr works as HashMap key
2025-11-09T23:42:54.9505571Z      assert_ne!(tcp_addr1, tcp_addr2);
2025-11-09T23:42:54.9508126Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/iroh_peer_tracking_tests.rs:21:
2025-11-09T23:42:54.9508966Z -    
2025-11-09T23:42:54.9509245Z +
2025-11-09T23:42:54.9509579Z      // Test Iroh peer (different transport type)
2025-11-09T23:42:54.9510524Z      #[cfg(feature = "iroh")]
2025-11-09T23:42:54.9510862Z      {
2025-11-09T23:42:54.9511580Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/iroh_peer_tracking_tests.rs:31:
2025-11-09T23:42:54.9512431Z  #[test]
2025-11-09T23:42:54.9512776Z  fn test_find_transport_addr_by_socket() {
2025-11-09T23:42:54.9513291Z      let mut manager = PeerManager::new(10);
2025-11-09T23:42:54.9513948Z -    
2025-11-09T23:42:54.9514233Z +
2025-11-09T23:42:54.9515085Z      let addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:42:54.9515708Z      let tcp_addr = TransportAddr::Tcp(addr);
2025-11-09T23:42:54.9516151Z -    
2025-11-09T23:42:54.9516418Z +
2025-11-09T23:42:54.9516739Z      // Should not find peer that doesn't exist
2025-11-09T23:42:54.9517346Z      assert!(manager.find_transport_addr_by_socket(addr).is_none());
2025-11-09T23:42:54.9517889Z -    
2025-11-09T23:42:54.9518145Z +
2025-11-09T23:42:54.9518412Z      // After adding, should find it
2025-11-09T23:42:54.9518891Z      // Note: Would need actual Peer instance to test fully
2025-11-09T23:42:54.9519426Z      // This test validates the lookup logic
2025-11-09T23:42:54.9520279Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/iroh_peer_tracking_tests.rs:46:
2025-11-09T23:42:54.9521106Z  #[test]
2025-11-09T23:42:54.9521425Z  fn test_peer_socket_addresses() {
2025-11-09T23:42:54.9521903Z      let mut manager = PeerManager::new(10);
2025-11-09T23:42:54.9522338Z -    
2025-11-09T23:42:54.9522623Z +
2025-11-09T23:42:54.9523014Z      let addr1: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:42:54.9523640Z      let addr2: SocketAddr = "127.0.0.1:8334".parse().unwrap();
2025-11-09T23:42:54.9524134Z -    
2025-11-09T23:42:54.9524618Z +
2025-11-09T23:42:54.9526838Z      // Add TCP peers
2025-11-09T23:42:54.9527262Z      let tcp_addr1 = TransportAddr::Tcp(addr1);
2025-11-09T23:42:54.9527775Z      let tcp_addr2 = TransportAddr::Tcp(addr2);
2025-11-09T23:42:54.9528679Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/iroh_peer_tracking_tests.rs:56:
2025-11-09T23:42:54.9529529Z -    
2025-11-09T23:42:54.9529782Z +
2025-11-09T23:42:54.9530205Z      // Test that peer_socket_addresses returns TCP/Quinn addresses
2025-11-09T23:42:54.9530776Z      // and skips Iroh addresses
2025-11-09T23:42:54.9531263Z      let socket_addrs = manager.peer_socket_addresses();
2025-11-09T23:42:54.9532195Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/iroh_peer_tracking_tests.rs:60:
2025-11-09T23:42:54.9533212Z      // Should be empty since no peers added, but validates method exists
2025-11-09T23:42:54.9533825Z      assert_eq!(socket_addrs.len(), 0);
2025-11-09T23:42:54.9534241Z  }
2025-11-09T23:42:54.9536563Z -
2025-11-09T23:42:54.9536828Z  
2025-11-09T23:42:54.9538014Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:1:
2025-11-09T23:42:54.9539365Z  //! Tests for MempoolManager refactoring
2025-11-09T23:42:54.9539814Z  
2025-11-09T23:42:54.9540176Z  use bllvm_node::node::mempool::MempoolManager;
2025-11-09T23:42:54.9541337Z -use bllvm_protocol::{Transaction, TransactionInput, TransactionOutput, OutPoint, UtxoSet, UTXO};
2025-11-09T23:42:54.9542464Z +use bllvm_protocol::{OutPoint, Transaction, TransactionInput, TransactionOutput, UtxoSet, UTXO};
2025-11-09T23:42:54.9543245Z  use std::collections::HashMap;
2025-11-09T23:42:54.9543606Z  
2025-11-09T23:42:54.9543888Z  #[tokio::test]
2025-11-09T23:42:54.9545886Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:8:
2025-11-09T23:42:54.9546690Z  async fn test_mempool_stores_full_transactions() {
2025-11-09T23:42:54.9547199Z      let mut mempool = MempoolManager::new();
2025-11-09T23:42:54.9547645Z -    
2025-11-09T23:42:54.9547916Z +
2025-11-09T23:42:54.9548200Z      // Create a test transaction
2025-11-09T23:42:54.9548615Z      let tx = Transaction {
2025-11-09T23:42:54.9548971Z          version: 1,
2025-11-09T23:42:54.9549668Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:25:
2025-11-09T23:42:54.9550434Z          }],
2025-11-09T23:42:54.9550746Z          lock_time: 0,
2025-11-09T23:42:54.9551075Z      };
2025-11-09T23:42:54.9551326Z -    
2025-11-09T23:42:54.9551600Z +
2025-11-09T23:42:54.9551871Z      // Add transaction
2025-11-09T23:42:54.9552386Z      let added = mempool.add_transaction(tx.clone()).await.unwrap();
2025-11-09T23:42:54.9554978Z      assert!(added);
2025-11-09T23:42:54.9555945Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:32:
2025-11-09T23:42:54.9556718Z -    
2025-11-09T23:42:54.9556996Z +
2025-11-09T23:42:54.9557275Z      // Verify we can retrieve it
2025-11-09T23:42:54.9557771Z      use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:42:54.9558287Z      let tx_hash = calculate_tx_id(&tx);
2025-11-09T23:42:54.9559050Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:42:
2025-11-09T23:42:54.9559923Z  async fn test_mempool_get_prioritized_transactions() {
2025-11-09T23:42:54.9560514Z      let mut mempool = MempoolManager::new();
2025-11-09T23:42:54.9561033Z      let mut utxo_set: UtxoSet = HashMap::new();
2025-11-09T23:42:54.9561467Z -    
2025-11-09T23:42:54.9561722Z +
2025-11-09T23:42:54.9561984Z      // Create UTXO for input
2025-11-09T23:42:54.9562355Z      let outpoint = OutPoint {
2025-11-09T23:42:54.9562716Z          hash: [0u8; 32],
2025-11-09T23:42:54.9563375Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:49:
2025-11-09T23:42:54.9564781Z          index: 0,
2025-11-09T23:42:54.9565076Z      };
2025-11-09T23:42:54.9565455Z -    utxo_set.insert(outpoint.clone(), UTXO {
2025-11-09T23:42:54.9565919Z -        value: 10000,
2025-11-09T23:42:54.9566278Z -        script_pubkey: vec![0x51],
2025-11-09T23:42:54.9566728Z -    });
2025-11-09T23:42:54.9566999Z -    
2025-11-09T23:42:54.9567269Z +    utxo_set.insert(
2025-11-09T23:42:54.9567613Z +        outpoint.clone(),
2025-11-09T23:42:54.9567966Z +        UTXO {
2025-11-09T23:42:54.9568275Z +            value: 10000,
2025-11-09T23:42:54.9568674Z +            script_pubkey: vec![0x51],
2025-11-09T23:42:54.9569089Z +        },
2025-11-09T23:42:54.9569372Z +    );
2025-11-09T23:42:54.9569630Z +
2025-11-09T23:42:54.9569992Z      // Create two transactions with different fee rates
2025-11-09T23:42:54.9570499Z      // High fee transaction
2025-11-09T23:42:54.9571090Z      let high_fee_tx = Transaction {
2025-11-09T23:42:54.9571977Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:68:
2025-11-09T23:42:54.9572734Z          }],
2025-11-09T23:42:54.9573018Z          lock_time: 0,
2025-11-09T23:42:54.9573348Z      };
2025-11-09T23:42:54.9573609Z -    
2025-11-09T23:42:54.9573871Z +
2025-11-09T23:42:54.9574155Z      // Low fee transaction
2025-11-09T23:42:54.9574648Z      let low_fee_tx = Transaction {
2025-11-09T23:42:54.9575009Z          version: 1,
2025-11-09T23:42:54.9575692Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:86:
2025-11-09T23:42:54.9576722Z          }],
2025-11-09T23:42:54.9578971Z          lock_time: 0,
2025-11-09T23:42:54.9579317Z      };
2025-11-09T23:42:54.9579568Z -    
2025-11-09T23:42:54.9579833Z +
2025-11-09T23:42:54.9580109Z      // Add both transactions
2025-11-09T23:42:54.9580641Z      mempool.add_transaction(low_fee_tx.clone()).await.unwrap();
2025-11-09T23:42:54.9581356Z      mempool.add_transaction(high_fee_tx.clone()).await.unwrap();
2025-11-09T23:42:54.9582270Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:93:
2025-11-09T23:42:54.9583025Z -    
2025-11-09T23:42:54.9583280Z +
2025-11-09T23:42:54.9583626Z      // Get prioritized (should return high fee first)
2025-11-09T23:42:54.9584471Z      let prioritized = mempool.get_prioritized_transactions(10, &utxo_set);
2025-11-09T23:42:54.9586933Z      assert_eq!(prioritized.len(), 1); // Only one has valid UTXO
2025-11-09T23:42:54.9587832Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:97:
2025-11-09T23:42:54.9588596Z -    
2025-11-09T23:42:54.9588870Z +
2025-11-09T23:42:54.9589183Z      // Verify high fee transaction is first
2025-11-09T23:42:54.9589718Z      use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:42:54.9590280Z      let high_fee_hash = calculate_tx_id(&high_fee_tx);
2025-11-09T23:42:54.9591392Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:104:
2025-11-09T23:42:54.9592180Z  #[tokio::test]
2025-11-09T23:42:54.9592558Z  async fn test_mempool_remove_transaction() {
2025-11-09T23:42:54.9593079Z      let mut mempool = MempoolManager::new();
2025-11-09T23:42:54.9593507Z -    
2025-11-09T23:42:54.9593772Z +
2025-11-09T23:42:54.9594040Z      let tx = Transaction {
2025-11-09T23:42:54.9594571Z          version: 1,
2025-11-09T23:42:54.9596905Z          inputs: vec![TransactionInput {
2025-11-09T23:42:54.9597704Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:121:
2025-11-09T23:42:54.9598467Z          }],
2025-11-09T23:42:54.9598751Z          lock_time: 0,
2025-11-09T23:42:54.9599059Z      };
2025-11-09T23:42:54.9599314Z -    
2025-11-09T23:42:54.9599570Z +
2025-11-09T23:42:54.9599940Z      mempool.add_transaction(tx.clone()).await.unwrap();
2025-11-09T23:42:54.9600480Z      assert_eq!(mempool.size(), 1);
2025-11-09T23:42:54.9600880Z -    
2025-11-09T23:42:54.9601160Z +
2025-11-09T23:42:54.9601507Z      use bllvm_protocol::mempool::calculate_tx_id;
2025-11-09T23:42:54.9602021Z      let tx_hash = calculate_tx_id(&tx);
2025-11-09T23:42:54.9602549Z      let removed = mempool.remove_transaction(&tx_hash);
2025-11-09T23:42:54.9603405Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mempool_tests.rs:131:
2025-11-09T23:42:54.9604175Z      assert!(removed);
2025-11-09T23:42:54.9604719Z      assert_eq!(mempool.size(), 0);
2025-11-09T23:42:54.9605126Z  }
2025-11-09T23:42:54.9605381Z -
2025-11-09T23:42:54.9605644Z  
2025-11-09T23:42:54.9606210Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:1:
2025-11-09T23:42:54.9606993Z -use bllvm_protocol::ProtocolVersion;
2025-11-09T23:42:54.9607482Z  use bllvm_node::storage::blockstore::BlockStore;
2025-11-09T23:42:54.9608014Z  use bllvm_node::storage::chainstate::ChainState;
2025-11-09T23:42:54.9608543Z  use bllvm_node::storage::txindex::TxIndex;
2025-11-09T23:42:54.9609297Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:9:
2025-11-09T23:42:54.9610044Z  use bllvm_node::OutPoint;
2025-11-09T23:42:54.9610440Z  use bllvm_node::Transaction;
2025-11-09T23:42:54.9611011Z  use bllvm_node::{ByteString, TransactionInput, TransactionOutput};
2025-11-09T23:42:54.9611645Z +use bllvm_protocol::ProtocolVersion;
2025-11-09T23:42:54.9612105Z  use std::collections::HashMap;
2025-11-09T23:42:54.9612504Z  use tempfile::TempDir;
2025-11-09T23:42:54.9612836Z  
2025-11-09T23:42:54.9613502Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_property_tests.rs:2:
2025-11-09T23:42:54.9615022Z  //!
2025-11-09T23:42:54.9615549Z  //! Uses proptest to verify invariants and properties that should hold for all inputs.
2025-11-09T23:42:54.9616188Z  
2025-11-09T23:42:54.9616440Z -use hex;
2025-11-09T23:42:54.9616731Z -use proptest::prelude::*;
2025-11-09T23:42:54.9618762Z +use bllvm_node::node::mempool::MempoolManager;
2025-11-09T23:42:54.9619396Z +use bllvm_node::rpc::mining::MiningRpc;
2025-11-09T23:42:54.9619950Z +use bllvm_node::storage::Storage;
2025-11-09T23:42:54.9620490Z  use bllvm_protocol::serialization::serialize_transaction;
2025-11-09T23:42:54.9621057Z  use bllvm_protocol::types::{
2025-11-09T23:42:54.9621681Z      BlockHeader, OutPoint, Transaction, TransactionInput, TransactionOutput,
2025-11-09T23:42:54.9622746Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_property_tests.rs:10:
2025-11-09T23:42:54.9623558Z  };
2025-11-09T23:42:54.9623908Z -use bllvm_node::node::mempool::MempoolManager;
2025-11-09T23:42:54.9624642Z -use bllvm_node::rpc::mining::MiningRpc;
2025-11-09T23:42:54.9625125Z -use bllvm_node::storage::Storage;
2025-11-09T23:42:54.9626924Z +use hex;
2025-11-09T23:42:54.9627226Z +use proptest::prelude::*;
2025-11-09T23:42:54.9627622Z  use sha2::{Digest, Sha256};
2025-11-09T23:42:54.9628004Z  use std::sync::Arc;
2025-11-09T23:42:54.9628346Z  use tempfile::TempDir;
2025-11-09T23:42:54.9629400Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_rpc_implementation_tests.rs:1:
2025-11-09T23:42:54.9630316Z  //! Tests for mining RPC implementation
2025-11-09T23:42:54.9630710Z  
2025-11-09T23:42:54.9631048Z +use bllvm_node::node::mempool::MempoolManager;
2025-11-09T23:42:54.9631564Z  use bllvm_node::rpc::mining::MiningRpc;
2025-11-09T23:42:54.9632020Z  use bllvm_node::storage::Storage;
2025-11-09T23:42:54.9632497Z -use bllvm_node::node::mempool::MempoolManager;
2025-11-09T23:42:54.9632983Z +use serde_json::json;
2025-11-09T23:42:54.9633326Z  use std::sync::Arc;
2025-11-09T23:42:54.9633680Z  use tempfile::TempDir;
2025-11-09T23:42:54.9634030Z -use serde_json::json;
2025-11-09T23:42:54.9634553Z  
2025-11-09T23:42:54.9634833Z  #[tokio::test]
2025-11-09T23:42:54.9635166Z  async fn test_get_mining_info() {
2025-11-09T23:42:54.9636047Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_rpc_implementation_tests.rs:12:
2025-11-09T23:42:54.9637001Z      let temp_dir = TempDir::new().unwrap();
2025-11-09T23:42:54.9637544Z      let storage = Storage::new(temp_dir.path()).unwrap();
2025-11-09T23:42:54.9638084Z      let mempool = MempoolManager::new();
2025-11-09T23:42:54.9638497Z -    
2025-11-09T23:42:54.9638734Z +
2025-11-09T23:42:54.9639268Z      let mining_rpc = MiningRpc::with_dependencies(Arc::new(storage), Arc::new(mempool));
2025-11-09T23:42:54.9639926Z -    
2025-11-09T23:42:54.9640189Z +
2025-11-09T23:42:54.9640547Z      let info = mining_rpc.get_mining_info().await.unwrap();
2025-11-09T23:42:54.9641028Z -    
2025-11-09T23:42:54.9641272Z +
2025-11-09T23:42:54.9641558Z      // Verify response structure
2025-11-09T23:42:54.9641977Z      assert!(info.get("blocks").is_some());
2025-11-09T23:42:54.9642448Z      assert!(info.get("pooledtx").is_some());
2025-11-09T23:42:54.9643378Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_rpc_implementation_tests.rs:29:
2025-11-09T23:42:54.9644481Z      let temp_dir = TempDir::new().unwrap();
2025-11-09T23:42:54.9645035Z      let storage = Storage::new(temp_dir.path()).unwrap();
2025-11-09T23:42:54.9645534Z      let mempool = MempoolManager::new();
2025-11-09T23:42:54.9645964Z -    
2025-11-09T23:42:54.9646226Z +
2025-11-09T23:42:54.9646764Z      let mining_rpc = MiningRpc::with_dependencies(Arc::new(storage), Arc::new(mempool));
2025-11-09T23:42:54.9647436Z -    
2025-11-09T23:42:54.9647696Z +
2025-11-09T23:42:54.9647978Z      let params = json!([]);
2025-11-09T23:42:54.9648498Z      let template = mining_rpc.get_block_template(&params).await;
2025-11-09T23:42:54.9649036Z -    
2025-11-09T23:42:54.9649576Z +
2025-11-09T23:42:54.9650437Z      // Should either succeed or fail gracefully
2025-11-09T23:42:54.9651009Z      // (may fail if chain not initialized, which is expected)
2025-11-09T23:42:54.9651609Z      assert!(template.is_ok() || template.is_err());
2025-11-09T23:42:54.9652580Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_rpc_implementation_tests.rs:45:
2025-11-09T23:42:54.9653526Z      let temp_dir = TempDir::new().unwrap();
2025-11-09T23:42:54.9654084Z      let storage = Storage::new(temp_dir.path()).unwrap();
2025-11-09T23:42:54.9654838Z      let mempool = MempoolManager::new();
2025-11-09T23:42:54.9655279Z -    
2025-11-09T23:42:54.9655542Z +
2025-11-09T23:42:54.9656077Z      let mining_rpc = MiningRpc::with_dependencies(Arc::new(storage), Arc::new(mempool));
2025-11-09T23:42:54.9656739Z -    
2025-11-09T23:42:54.9658668Z +
2025-11-09T23:42:54.9659177Z      // Create a minimal invalid block hex (will fail validation, which is expected)
2025-11-09T23:42:54.9660111Z      let invalid_block_hex = "0000000000000000000000000000000000000000000000000000000000000000";
2025-11-09T23:42:54.9660870Z      let params = json!([invalid_block_hex, ""]);
2025-11-09T23:42:54.9661883Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_rpc_implementation_tests.rs:54:
2025-11-09T23:42:54.9662757Z -    
2025-11-09T23:42:54.9663005Z +
2025-11-09T23:42:54.9663643Z      let result = mining_rpc.submit_block(&params).await;
2025-11-09T23:42:54.9664164Z -    
2025-11-09T23:42:54.9666506Z +
2025-11-09T23:42:54.9666883Z      // Should fail validation (expected for invalid block)
2025-11-09T23:42:54.9667403Z      assert!(result.is_err());
2025-11-09T23:42:54.9667776Z  }
2025-11-09T23:42:54.9668516Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_rpc_implementation_tests.rs:63:
2025-11-09T23:42:54.9669471Z      let temp_dir = TempDir::new().unwrap();
2025-11-09T23:42:54.9670006Z      let storage = Storage::new(temp_dir.path()).unwrap();
2025-11-09T23:42:54.9670197Z      let mempool = MempoolManager::new();
2025-11-09T23:42:54.9670306Z -    
2025-11-09T23:42:54.9670409Z +
2025-11-09T23:42:54.9670797Z      let mining_rpc = MiningRpc::with_dependencies(Arc::new(storage), Arc::new(mempool));
2025-11-09T23:42:54.9670907Z -    
2025-11-09T23:42:54.9671014Z +
2025-11-09T23:42:54.9671194Z      let params = json!([6, "conservative"]);
2025-11-09T23:42:54.9671533Z      let fee_estimate = mining_rpc.estimate_smart_fee(&params).await.unwrap();
2025-11-09T23:42:54.9671643Z -    
2025-11-09T23:42:54.9671757Z +
2025-11-09T23:42:54.9671904Z      // Verify response structure
2025-11-09T23:42:54.9672104Z      assert!(fee_estimate.get("feerate").is_some());
2025-11-09T23:42:54.9672300Z      assert!(fee_estimate.get("blocks").is_some());
2025-11-09T23:42:54.9672908Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_rpc_implementation_tests.rs:75:
2025-11-09T23:42:54.9673212Z      assert_eq!(fee_estimate.get("blocks").unwrap().as_u64().unwrap(), 6);
2025-11-09T23:42:54.9673333Z  }
2025-11-09T23:42:54.9673439Z -
2025-11-09T23:42:54.9673547Z  
2025-11-09T23:42:54.9673960Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:1:
2025-11-09T23:42:54.9674142Z -use bllvm_protocol::ProtocolVersion;
2025-11-09T23:42:54.9674337Z  use bllvm_node::storage::blockstore::BlockStore;
2025-11-09T23:42:54.9676507Z  use bllvm_node::storage::chainstate::ChainState;
2025-11-09T23:42:54.9676698Z  use bllvm_node::storage::txindex::TxIndex;
2025-11-09T23:42:54.9677121Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:9:
2025-11-09T23:42:54.9677274Z  use bllvm_node::OutPoint;
2025-11-09T23:42:54.9677432Z  use bllvm_node::Transaction;
2025-11-09T23:42:54.9677736Z  use bllvm_node::{ByteString, TransactionInput, TransactionOutput};
2025-11-09T23:42:54.9677910Z +use bllvm_protocol::ProtocolVersion;
2025-11-09T23:42:54.9678059Z  use std::collections::HashMap;
2025-11-09T23:42:54.9678468Z  use tempfile::TempDir;
2025-11-09T23:42:54.9678580Z  
2025-11-09T23:42:54.9679164Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_rpc_tests.rs:1:
2025-11-09T23:42:54.9679327Z  //! Unit tests for Mining RPC methods
2025-11-09T23:42:54.9679437Z  
2025-11-09T23:42:54.9679709Z -use bllvm_protocol::serialization::serialize_transaction;
2025-11-09T23:42:54.9680111Z -use bllvm_protocol::{BlockHeader, Natural, OutPoint, Transaction, UtxoSet, UTXO};
2025-11-09T23:42:54.9680316Z  use bllvm_node::node::mempool::MempoolManager;
2025-11-09T23:42:54.9680488Z  use bllvm_node::rpc::mining::MiningRpc;
2025-11-09T23:42:54.9680654Z  use bllvm_node::storage::Storage;
2025-11-09T23:42:54.9681130Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/mining_rpc_tests.rs:8:
2025-11-09T23:42:54.9681385Z +use bllvm_protocol::serialization::serialize_transaction;
2025-11-09T23:42:54.9681776Z +use bllvm_protocol::{BlockHeader, Natural, OutPoint, Transaction, UtxoSet, UTXO};
2025-11-09T23:42:54.9681924Z  use std::sync::Arc;
2025-11-09T23:42:54.9682060Z  use tempfile::TempDir;
2025-11-09T23:42:54.9684157Z  // Sha256 not needed directly in tests
2025-11-09T23:42:54.9684909Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/module_process_sharing_tests.rs:3:
2025-11-09T23:42:54.9685436Z  use bllvm_node::module::process::monitor::ModuleProcessMonitor;
2025-11-09T23:42:54.9685830Z  use bllvm_node::module::process::spawner::{ModuleProcess, ModuleProcessSpawner};
2025-11-09T23:42:54.9685971Z  use std::sync::{Arc, Mutex};
2025-11-09T23:42:54.9686107Z -use tokio::sync::mpsc;
2025-11-09T23:42:54.9686242Z  use tempfile::TempDir;
2025-11-09T23:42:54.9686382Z +use tokio::sync::mpsc;
2025-11-09T23:42:54.9686492Z  
2025-11-09T23:42:54.9686613Z  #[tokio::test]
2025-11-09T23:42:54.9686785Z  async fn test_monitor_module_shared() {
2025-11-09T23:42:54.9687362Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/module_process_sharing_tests.rs:11:
2025-11-09T23:42:54.9687547Z      let temp_dir = TempDir::new().unwrap();
2025-11-09T23:42:54.9687777Z      let (crash_tx, _crash_rx) = mpsc::unbounded_channel();
2025-11-09T23:42:54.9688006Z      let monitor = ModuleProcessMonitor::new(crash_tx);
2025-11-09T23:42:54.9688117Z -    
2025-11-09T23:42:54.9688225Z +
2025-11-09T23:42:54.9688542Z      // Create a dummy process (using true command which exits immediately)
2025-11-09T23:42:54.9688754Z -    let process = tokio::process::Command::new("true")
2025-11-09T23:42:54.9688876Z -        .spawn()
2025-11-09T23:42:54.9689002Z -        .unwrap();
2025-11-09T23:42:54.9689111Z -    
2025-11-09T23:42:54.9689413Z +    let process = tokio::process::Command::new("true").spawn().unwrap();
2025-11-09T23:42:54.9689523Z +
2025-11-09T23:42:54.9689699Z      let module_process = ModuleProcess {
2025-11-09T23:42:54.9689858Z          module_name: "test".to_string(),
2025-11-09T23:42:54.9689978Z          process,
2025-11-09T23:42:54.9690566Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/module_process_sharing_tests.rs:23:
2025-11-09T23:42:54.9690769Z          socket_path: std::path::PathBuf::new(),
2025-11-09T23:42:54.9690897Z          client: None,
2025-11-09T23:42:54.9691008Z      };
2025-11-09T23:42:54.9691126Z -    
2025-11-09T23:42:54.9691236Z +
2025-11-09T23:42:54.9691494Z      let shared_process = Arc::new(Mutex::new(module_process));
2025-11-09T23:42:54.9691620Z -    
2025-11-09T23:42:54.9691726Z +
2025-11-09T23:42:54.9691915Z      // Test that monitor_module_shared can be called
2025-11-09T23:42:54.9692124Z      // (will exit quickly since process exits immediately)
2025-11-09T23:42:54.9692535Z -    let result = monitor.monitor_module_shared("test".to_string(), shared_process).await;
2025-11-09T23:42:54.9692647Z -    
2025-11-09T23:42:54.9692783Z +    let result = monitor
2025-11-09T23:42:54.9693050Z +        .monitor_module_shared("test".to_string(), shared_process)
2025-11-09T23:42:54.9693165Z +        .await;
2025-11-09T23:42:54.9693273Z +
2025-11-09T23:42:54.9695720Z      // Should succeed (process exits normally)
2025-11-09T23:42:54.9695895Z      assert!(result.is_ok());
2025-11-09T23:42:54.9696008Z  }
2025-11-09T23:42:54.9696588Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/module_process_sharing_tests.rs:36:
2025-11-09T23:42:54.9696709Z -
2025-11-09T23:42:54.9696816Z  
2025-11-09T23:42:54.9697241Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:1:
2025-11-09T23:42:54.9697430Z -use bllvm_protocol::ProtocolVersion;
2025-11-09T23:42:54.9697637Z  use bllvm_node::storage::blockstore::BlockStore;
2025-11-09T23:42:54.9697837Z  use bllvm_node::storage::chainstate::ChainState;
2025-11-09T23:42:54.9698012Z  use bllvm_node::storage::txindex::TxIndex;
2025-11-09T23:42:54.9698438Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:9:
2025-11-09T23:42:54.9698589Z  use bllvm_node::OutPoint;
2025-11-09T23:42:54.9698735Z  use bllvm_node::Transaction;
2025-11-09T23:42:54.9699069Z  use bllvm_node::{ByteString, TransactionInput, TransactionOutput};
2025-11-09T23:42:54.9699238Z +use bllvm_protocol::ProtocolVersion;
2025-11-09T23:42:54.9699413Z  use std::collections::HashMap;
2025-11-09T23:42:54.9699554Z  use tempfile::TempDir;
2025-11-09T23:42:54.9699663Z  
2025-11-09T23:42:54.9739575Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:8:
2025-11-09T23:42:54.9740432Z  use std::net::SocketAddr;
2025-11-09T23:42:54.9741585Z  use tokio::sync::mpsc;
2025-11-09T23:42:54.9742917Z  mod common;
2025-11-09T23:42:54.9746320Z -use common::*;
2025-11-09T23:42:54.9747612Z  use bllvm_node::network::inventory::{InventoryRequest, MSG_BLOCK, MSG_TX};
2025-11-09T23:42:54.9748195Z  use bllvm_node::network::protocol::InventoryItem as NetworkInventoryItem;
2025-11-09T23:42:54.9759041Z +use common::*;
2025-11-09T23:42:54.9759182Z  
2025-11-09T23:42:54.9759327Z  #[tokio::test]
2025-11-09T23:42:54.9759534Z  async fn test_network_manager_creation() {
2025-11-09T23:42:54.9760044Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:878:
2025-11-09T23:42:54.9760211Z  async fn test_persistent_peers() {
2025-11-09T23:42:54.9760434Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:42:54.9760634Z      let manager = NetworkManager::new(addr);
2025-11-09T23:42:54.9760746Z -    
2025-11-09T23:42:54.9760867Z +
2025-11-09T23:42:54.9761203Z      let peer1: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:42:54.9761434Z      let peer2: SocketAddr = "127.0.0.1:8334".parse().unwrap();
2025-11-09T23:42:54.9761546Z -    
2025-11-09T23:42:54.9761661Z +
2025-11-09T23:42:54.9761817Z      // Test adding persistent peers
2025-11-09T23:42:54.9761980Z      manager.add_persistent_peer(peer1);
2025-11-09T23:42:54.9762144Z      manager.add_persistent_peer(peer2);
2025-11-09T23:42:54.9762624Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:888:
2025-11-09T23:42:54.9762747Z -    
2025-11-09T23:42:54.9762856Z +
2025-11-09T23:42:54.9763082Z      let persistent = manager.get_persistent_peers();
2025-11-09T23:42:54.9763873Z      assert_eq!(persistent.len(), 2);
2025-11-09T23:42:54.9764130Z      assert!(persistent.contains(&peer1));
2025-11-09T23:42:54.9766699Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:892:
2025-11-09T23:42:54.9766894Z      assert!(persistent.contains(&peer2));
2025-11-09T23:42:54.9767005Z -    
2025-11-09T23:42:54.9767121Z +
2025-11-09T23:42:54.9767283Z      // Test removing persistent peer
2025-11-09T23:42:54.9767449Z      manager.remove_persistent_peer(peer1);
2025-11-09T23:42:54.9767647Z      let persistent = manager.get_persistent_peers();
2025-11-09T23:42:54.9768132Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:903:
2025-11-09T23:42:54.9768280Z  async fn test_ban_list() {
2025-11-09T23:42:54.9768498Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:42:54.9768976Z      let manager = NetworkManager::new(addr);
2025-11-09T23:42:54.9769089Z -    
2025-11-09T23:42:54.9769197Z +
2025-11-09T23:42:54.9769476Z      let banned_peer: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:42:54.9769598Z -    
2025-11-09T23:42:54.9769706Z +
2025-11-09T23:42:54.9769876Z      // Test banning a peer (permanent ban)
2025-11-09T23:42:54.9770056Z      manager.ban_peer(banned_peer, 0);
2025-11-09T23:42:54.9770229Z      assert!(manager.is_banned(banned_peer));
2025-11-09T23:42:54.9770719Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:912:
2025-11-09T23:42:54.9770831Z -    
2025-11-09T23:42:54.9770952Z +
2025-11-09T23:42:54.9771106Z      // Test getting banned peers
2025-11-09T23:42:54.9771277Z      let banned = manager.get_banned_peers();
2025-11-09T23:42:54.9771428Z      assert_eq!(banned.len(), 1);
2025-11-09T23:42:54.9771900Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:916:
2025-11-09T23:42:54.9772757Z      assert_eq!(banned[0].0, banned_peer);
2025-11-09T23:42:54.9772891Z -    
2025-11-09T23:42:54.9773009Z +
2025-11-09T23:42:54.9773143Z      // Test unbanning
2025-11-09T23:42:54.9773301Z      manager.unban_peer(banned_peer);
2025-11-09T23:42:54.9773488Z      assert!(!manager.is_banned(banned_peer));
2025-11-09T23:42:54.9774182Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:921:
2025-11-09T23:42:54.9776452Z -    
2025-11-09T23:42:54.9776577Z +
2025-11-09T23:42:54.9776712Z      // Test temporary ban
2025-11-09T23:42:54.9776883Z      use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:42:54.9777024Z      let now = SystemTime::now()
2025-11-09T23:42:54.9777484Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:928:
2025-11-09T23:42:54.9777663Z      let unban_time = now + 3600; // 1 hour from now
2025-11-09T23:42:54.9777835Z      manager.ban_peer(banned_peer, unban_time);
2025-11-09T23:42:54.9778014Z      assert!(manager.is_banned(banned_peer));
2025-11-09T23:42:54.9778130Z -    
2025-11-09T23:42:54.9778239Z +
2025-11-09T23:42:54.9778367Z      // Test clearing all bans
2025-11-09T23:42:54.9778502Z      manager.clear_bans();
2025-11-09T23:42:54.9778667Z      assert!(!manager.is_banned(banned_peer));
2025-11-09T23:42:54.9779140Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:939:
2025-11-09T23:42:54.9779306Z  async fn test_network_stats() {
2025-11-09T23:42:54.9779523Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:42:54.9779706Z      let manager = NetworkManager::new(addr);
2025-11-09T23:42:54.9779824Z -    
2025-11-09T23:42:54.9779932Z +
2025-11-09T23:42:54.9780084Z      // Initially stats should be zero
2025-11-09T23:42:54.9780293Z      let (sent, received) = manager.get_network_stats();
2025-11-09T23:42:54.9780429Z      assert_eq!(sent, 0);
2025-11-09T23:42:54.9780891Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:946:
2025-11-09T23:42:54.9781044Z      assert_eq!(received, 0);
2025-11-09T23:42:54.9781162Z -    
2025-11-09T23:42:54.9781275Z +
2025-11-09T23:42:54.9781408Z      // Track some bytes
2025-11-09T23:42:54.9781558Z      manager.track_bytes_sent(100);
2025-11-09T23:42:54.9781725Z      manager.track_bytes_received(200);
2025-11-09T23:42:54.9782194Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:951:
2025-11-09T23:42:54.9782306Z -    
2025-11-09T23:42:54.9782424Z +
2025-11-09T23:42:54.9782629Z      let (sent, received) = manager.get_network_stats();
2025-11-09T23:42:54.9782763Z      assert_eq!(sent, 100);
2025-11-09T23:42:54.9782903Z      assert_eq!(received, 200);
2025-11-09T23:42:54.9783379Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:955:
2025-11-09T23:42:54.9783495Z -    
2025-11-09T23:42:54.9783606Z +
2025-11-09T23:42:54.9783779Z      // Track more bytes (should accumulate)
2025-11-09T23:42:54.9784190Z      manager.track_bytes_sent(50);
2025-11-09T23:42:54.9784544Z      manager.track_bytes_received(75);
2025-11-09T23:42:54.9785022Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:959:
2025-11-09T23:42:54.9785141Z -    
2025-11-09T23:42:54.9785252Z +
2025-11-09T23:42:54.9785456Z      let (sent, received) = manager.get_network_stats();
2025-11-09T23:42:54.9785598Z      assert_eq!(sent, 150);
2025-11-09T23:42:54.9785738Z      assert_eq!(received, 275);
2025-11-09T23:42:54.9786198Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:966:
2025-11-09T23:42:54.9786358Z  async fn test_ping_all_peers() {
2025-11-09T23:42:54.9786585Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:42:54.9786778Z      let manager = NetworkManager::new(addr);
2025-11-09T23:42:54.9786889Z -    
2025-11-09T23:42:54.9787004Z +
2025-11-09T23:42:54.9787192Z      // Test ping with no peers (should not error)
2025-11-09T23:42:54.9787390Z      let result = manager.ping_all_peers().await;
2025-11-09T23:42:54.9787539Z      assert!(result.is_ok());
2025-11-09T23:42:54.9787993Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/network_tests.rs:973:
2025-11-09T23:42:54.9788099Z -    
2025-11-09T23:42:54.9788207Z +
2025-11-09T23:42:54.9788787Z      // Note: Testing with actual peers would require setting up connections,
2025-11-09T23:42:54.9789114Z      // which is more complex. This test verifies the method doesn't panic.
2025-11-09T23:42:54.9789219Z  }
2025-11-09T23:42:54.9789671Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:1:
2025-11-09T23:42:54.9789851Z -use bllvm_protocol::ProtocolVersion;
2025-11-09T23:42:54.9790054Z  use bllvm_node::storage::blockstore::BlockStore;
2025-11-09T23:42:54.9790255Z  use bllvm_node::storage::chainstate::ChainState;
2025-11-09T23:42:54.9790429Z  use bllvm_node::storage::txindex::TxIndex;
2025-11-09T23:42:54.9790850Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:9:
2025-11-09T23:42:54.9790998Z  use bllvm_node::OutPoint;
2025-11-09T23:42:54.9791156Z  use bllvm_node::Transaction;
2025-11-09T23:42:54.9791461Z  use bllvm_node::{ByteString, TransactionInput, TransactionOutput};
2025-11-09T23:42:54.9791635Z +use bllvm_protocol::ProtocolVersion;
2025-11-09T23:42:54.9791805Z  use std::collections::HashMap;
2025-11-09T23:42:54.9791944Z  use tempfile::TempDir;
2025-11-09T23:42:54.9792048Z  
2025-11-09T23:42:54.9818166Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/node_tests.rs:5:
2025-11-09T23:42:54.9819325Z  use std::net::SocketAddr;
2025-11-09T23:42:54.9820462Z  use tempfile::TempDir;
2025-11-09T23:42:54.9821587Z  mod common;
2025-11-09T23:42:54.9822717Z -use common::*;
2025-11-09T23:42:54.9823891Z  use bllvm_protocol::ProtocolVersion;
2025-11-09T23:42:54.9825266Z +use common::*;
2025-11-09T23:42:54.9825412Z  
2025-11-09T23:42:54.9825934Z  #[tokio::test]
2025-11-09T23:42:54.9826112Z  async fn test_node_creation() {
2025-11-09T23:42:54.9829012Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/peer_stats_tests.rs:3:
2025-11-09T23:42:54.9830386Z  use bllvm_node::network::peer::Peer;
2025-11-09T23:42:54.9831587Z  use bllvm_node::network::NetworkMessage;
2025-11-09T23:42:54.9833216Z  use std::net::SocketAddr;
2025-11-09T23:42:54.9835208Z -use tokio::sync::mpsc;
2025-11-09T23:42:54.9836040Z  use tokio::net::TcpStream;
2025-11-09T23:42:54.9836186Z +use tokio::sync::mpsc;
2025-11-09T23:42:54.9836309Z  
2025-11-09T23:42:54.9836435Z  #[tokio::test]
2025-11-09T23:42:54.9836622Z  async fn test_peer_stats_initialization() {
2025-11-09T23:42:54.9837124Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/peer_stats_tests.rs:11:
2025-11-09T23:42:54.9837362Z      let addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:42:54.9837544Z      let (tx, _rx) = mpsc::unbounded_channel();
2025-11-09T23:42:54.9837945Z -    
2025-11-09T23:42:54.9838062Z +
2025-11-09T23:42:54.9838204Z      // Create a mock stream
2025-11-09T23:42:54.9838539Z      let listener = tokio::net::TcpListener::bind("127.0.0.1:0").await.unwrap();
2025-11-09T23:42:54.9838752Z      let local_addr = listener.local_addr().unwrap();
2025-11-09T23:42:54.9839270Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/peer_stats_tests.rs:17:
2025-11-09T23:42:54.9839610Z      let stream = tokio::net::TcpStream::connect(local_addr).await.unwrap();
2025-11-09T23:42:54.9839734Z -    
2025-11-09T23:42:54.9839845Z +
2025-11-09T23:42:54.9840037Z      let peer = Peer::new(stream, addr, tx);
2025-11-09T23:42:54.9840150Z -    
2025-11-09T23:42:54.9840267Z +
2025-11-09T23:42:54.9840405Z      // Check initial stats
2025-11-09T23:42:54.9840560Z      assert!(peer.conntime() > 0);
2025-11-09T23:42:54.9840851Z      assert_eq!(peer.conntime(), peer.last_send());
2025-11-09T23:42:54.9841351Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/peer_stats_tests.rs:30:
2025-11-09T23:42:54.9841531Z  async fn test_peer_record_send() {
2025-11-09T23:42:54.9841766Z      let addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:42:54.9841940Z      let (tx, _rx) = mpsc::unbounded_channel();
2025-11-09T23:42:54.9842054Z -    
2025-11-09T23:42:54.9842170Z +
2025-11-09T23:42:54.9842740Z      let listener = tokio::net::TcpListener::bind("127.0.0.1:0").await.unwrap();
2025-11-09T23:42:54.9842964Z      let local_addr = listener.local_addr().unwrap();
2025-11-09T23:42:54.9843285Z      let stream = tokio::net::TcpStream::connect(local_addr).await.unwrap();
2025-11-09T23:42:54.9843792Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/peer_stats_tests.rs:37:
2025-11-09T23:42:54.9843903Z -    
2025-11-09T23:42:54.9844016Z +
2025-11-09T23:42:54.9844200Z      let mut peer = Peer::new(stream, addr, tx);
2025-11-09T23:42:54.9844505Z -    
2025-11-09T23:42:54.9844618Z +
2025-11-09T23:42:54.9844786Z      let initial_send = peer.last_send();
2025-11-09T23:42:54.9844962Z      let initial_bytes = peer.bytes_sent();
2025-11-09T23:42:54.9845071Z -    
2025-11-09T23:42:54.9845185Z +
2025-11-09T23:42:54.9845309Z      // Record a send
2025-11-09T23:42:54.9845451Z      peer.record_send(100);
2025-11-09T23:42:54.9845563Z -    
2025-11-09T23:42:54.9845684Z +
2025-11-09T23:42:54.9845867Z      assert!(peer.last_send() >= initial_send);
2025-11-09T23:42:54.9846078Z      assert_eq!(peer.bytes_sent(), initial_bytes + 100);
2025-11-09T23:42:54.9846193Z  }
2025-11-09T23:42:54.9846700Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/peer_stats_tests.rs:51:
2025-11-09T23:42:54.9846864Z  async fn test_peer_record_receive() {
2025-11-09T23:42:54.9847096Z      let addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:42:54.9847287Z      let (tx, _rx) = mpsc::unbounded_channel();
2025-11-09T23:42:54.9847404Z -    
2025-11-09T23:42:54.9847516Z +
2025-11-09T23:42:54.9847864Z      let listener = tokio::net::TcpListener::bind("127.0.0.1:0").await.unwrap();
2025-11-09T23:42:54.9848083Z      let local_addr = listener.local_addr().unwrap();
2025-11-09T23:42:54.9848394Z      let stream = tokio::net::TcpStream::connect(local_addr).await.unwrap();
2025-11-09T23:42:54.9848903Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/peer_stats_tests.rs:58:
2025-11-09T23:42:54.9849022Z -    
2025-11-09T23:42:54.9849139Z +
2025-11-09T23:42:54.9849337Z      let mut peer = Peer::new(stream, addr, tx);
2025-11-09T23:42:54.9849463Z -    
2025-11-09T23:42:54.9849572Z +
2025-11-09T23:42:54.9849740Z      let initial_recv = peer.last_recv();
2025-11-09T23:42:54.9849914Z      let initial_bytes = peer.bytes_recv();
2025-11-09T23:42:54.9850025Z -    
2025-11-09T23:42:54.9850134Z +
2025-11-09T23:42:54.9850249Z      // Record a receive
2025-11-09T23:42:54.9850400Z      peer.record_receive(200);
2025-11-09T23:42:54.9850511Z -    
2025-11-09T23:42:54.9850619Z +
2025-11-09T23:42:54.9850797Z      assert!(peer.last_recv() >= initial_recv);
2025-11-09T23:42:54.9851287Z      assert_eq!(peer.bytes_recv(), initial_bytes + 200);
2025-11-09T23:42:54.9851399Z  }
2025-11-09T23:42:54.9851900Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/peer_stats_tests.rs:70:
2025-11-09T23:42:54.9853945Z -
2025-11-09T23:42:54.9854065Z  
2025-11-09T23:42:54.9855083Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/protocol_message_processing_tests.rs:1:
2025-11-09T23:42:54.9855324Z  //! Tests for protocol message processing integration
2025-11-09T23:42:54.9855432Z  
2025-11-09T23:42:54.9855589Z  use bllvm_node::network;
2025-11-09T23:42:54.9855749Z -use bllvm_node::storage::Storage;
2025-11-09T23:42:54.9855955Z  use bllvm_node::node::mempool::MempoolManager;
2025-11-09T23:42:54.9856104Z +use bllvm_node::storage::Storage;
2025-11-09T23:42:54.9856384Z  use bllvm_protocol::{BitcoinProtocolEngine, ProtocolVersion};
2025-11-09T23:42:54.9856519Z -use std::sync::Arc;
2025-11-09T23:42:54.9856699Z  use std::net::SocketAddr;
2025-11-09T23:42:54.9856828Z +use std::sync::Arc;
2025-11-09T23:42:54.9856967Z  use tempfile::TempDir;
2025-11-09T23:42:54.9857088Z  
2025-11-09T23:42:54.9857216Z  #[tokio::test]
2025-11-09T23:42:54.9857897Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/protocol_message_processing_tests.rs:14:
2025-11-09T23:42:54.9858419Z      let storage = Arc::new(Storage::new(temp_dir.path()).unwrap());
2025-11-09T23:42:54.9858627Z      let mempool = Arc::new(MempoolManager::new());
2025-11-09T23:42:54.9859102Z      let protocol_engine = Arc::new(BitcoinProtocolEngine::new(ProtocolVersion::Regtest).unwrap());
2025-11-09T23:42:54.9859219Z -    
2025-11-09T23:42:54.9859331Z +
2025-11-09T23:42:54.9859591Z      let network_addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:42:54.9859885Z -    let network_manager = network::NetworkManager::new(network_addr)
2025-11-09T23:42:54.9860137Z -        .with_dependencies(protocol_engine, storage, mempool);
2025-11-09T23:42:54.9860252Z -    
2025-11-09T23:42:54.9860654Z +    let network_manager = network::NetworkManager::new(network_addr).with_dependencies(
2025-11-09T23:42:54.9860800Z +        protocol_engine,
2025-11-09T23:42:54.9860914Z +        storage,
2025-11-09T23:42:54.9861026Z +        mempool,
2025-11-09T23:42:54.9861148Z +    );
2025-11-09T23:42:54.9861259Z +
2025-11-09T23:42:54.9861421Z      // Verify dependencies are set
2025-11-09T23:42:54.9861770Z      // (NetworkManager doesn't expose these, but we can verify it was created)
2025-11-09T23:42:54.9861974Z      assert!(true); // If we got here, setup worked
2025-11-09T23:42:54.9862597Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/protocol_message_processing_tests.rs:29:
2025-11-09T23:42:54.9862774Z      let temp_dir = TempDir::new().unwrap();
2025-11-09T23:42:54.9863011Z      let storage = Storage::new(temp_dir.path()).unwrap();
2025-11-09T23:42:54.9863207Z      let mempool = Arc::new(MempoolManager::new());
2025-11-09T23:42:54.9863322Z -    
2025-11-09T23:42:54.9863443Z +
2025-11-09T23:42:54.9865615Z      // Verify we can create NodeChainAccess with Storage Arcs
2025-11-09T23:42:54.9865853Z      use bllvm_node::network::chain_access::NodeChainAccess;
2025-11-09T23:42:54.9866039Z -    let chain_access = NodeChainAccess::new(
2025-11-09T23:42:54.9866182Z -        storage.blocks(),
2025-11-09T23:42:54.9866313Z -        storage.transactions(),
2025-11-09T23:42:54.9866433Z -        mempool,
2025-11-09T23:42:54.9866549Z -    );
2025-11-09T23:42:54.9866654Z -    
2025-11-09T23:42:54.9867110Z +    let chain_access = NodeChainAccess::new(storage.blocks(), storage.transactions(), mempool);
2025-11-09T23:42:54.9867216Z +
2025-11-09T23:42:54.9867351Z      // Test that it works
2025-11-09T23:42:54.9867476Z      let hash = [0u8; 32];
2025-11-09T23:42:54.9867723Z      assert!(!chain_access.has_object(&hash)); // Empty storage
2025-11-09T23:42:54.9868353Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/protocol_message_processing_tests.rs:44:
2025-11-09T23:42:54.9868679Z  }
2025-11-09T23:42:54.9868787Z -
2025-11-09T23:42:54.9868895Z  
2025-11-09T23:42:54.9917583Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:1:
2025-11-09T23:42:54.9917795Z -use bllvm_protocol::ProtocolVersion;
2025-11-09T23:42:54.9918005Z  use bllvm_node::storage::blockstore::BlockStore;
2025-11-09T23:42:54.9919150Z  use bllvm_node::storage::chainstate::ChainState;
2025-11-09T23:42:54.9919340Z  use bllvm_node::storage::txindex::TxIndex;
2025-11-09T23:42:54.9919751Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:9:
2025-11-09T23:42:54.9919908Z  use bllvm_node::OutPoint;
2025-11-09T23:42:54.9920053Z  use bllvm_node::Transaction;
2025-11-09T23:42:54.9920350Z  use bllvm_node::{ByteString, TransactionInput, TransactionOutput};
2025-11-09T23:42:54.9920982Z +use bllvm_protocol::ProtocolVersion;
2025-11-09T23:42:54.9921156Z  use std::collections::HashMap;
2025-11-09T23:42:54.9921298Z  use tempfile::TempDir;
2025-11-09T23:42:54.9921423Z  
2025-11-09T23:42:54.9932187Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:10:
2025-11-09T23:42:54.9932446Z  #[tokio::test]
2025-11-09T23:42:54.9932618Z  async fn test_message_size_validation() {
2025-11-09T23:42:54.9932911Z      use bllvm_node::network::protocol::MAX_PROTOCOL_MESSAGE_LENGTH;
2025-11-09T23:42:54.9933267Z -    
2025-11-09T23:42:54.9933401Z +
2025-11-09T23:42:54.9933633Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:42:54.9933825Z      let manager = NetworkManager::new(addr);
2025-11-09T23:42:54.9933941Z -    
2025-11-09T23:42:54.9934047Z +
2025-11-09T23:42:54.9934228Z      // Test that oversized messages are rejected
2025-11-09T23:42:54.9934724Z      // This is tested at the TransportConnection level, but we can verify
2025-11-09T23:42:54.9934895Z      // the protocol parser also validates size
2025-11-09T23:42:54.9935392Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:20:
2025-11-09T23:42:54.9935642Z      use bllvm_node::network::protocol::ProtocolParser;
2025-11-09T23:42:54.9935758Z -    
2025-11-09T23:42:54.9935864Z +
2025-11-09T23:42:54.9936021Z      // Create a message that's too large
2025-11-09T23:42:54.9936309Z      let oversized_data = vec![0u8; MAX_PROTOCOL_MESSAGE_LENGTH + 1];
2025-11-09T23:42:54.9936602Z      let result = ProtocolParser::parse_message(&oversized_data);
2025-11-09T23:42:54.9937147Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:29:
2025-11-09T23:42:54.9937313Z  async fn test_rate_limiting() {
2025-11-09T23:42:54.9937541Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:42:54.9937733Z      let manager = NetworkManager::new(addr);
2025-11-09T23:42:54.9937843Z -    
2025-11-09T23:42:54.9937964Z +
2025-11-09T23:42:54.9938261Z      // Rate limiting is tested implicitly through message processing
2025-11-09T23:42:54.9938587Z      // The rate limiter is checked in process_messages for RawMessageReceived
2025-11-09T23:42:54.9938880Z      // This test verifies the rate limiter structure exists and works
2025-11-09T23:42:54.9939371Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:36:
2025-11-09T23:42:54.9939483Z -    
2025-11-09T23:42:54.9939592Z +
2025-11-09T23:42:54.9939785Z      // Add a peer address to test rate limiting
2025-11-09T23:42:54.9940046Z      let test_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:42:54.9940154Z -    
2025-11-09T23:42:54.9940271Z +
2025-11-09T23:42:54.9940524Z      // Rate limiter should be created when first message arrives
2025-11-09T23:42:54.9940811Z      // We can't easily test this without a real connection, but the structure
2025-11-09T23:42:54.9941013Z      // is in place and will be tested in integration tests
2025-11-09T23:42:54.9941453Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:47:
2025-11-09T23:42:54.9941929Z  async fn test_per_ip_connection_limit() {
2025-11-09T23:42:54.9942144Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:42:54.9942339Z      let manager = NetworkManager::new(addr);
2025-11-09T23:42:54.9942454Z -    
2025-11-09T23:42:54.9942564Z +
2025-11-09T23:42:54.9942739Z      // Test that per-IP limits are enforced
2025-11-09T23:42:54.9943020Z      // This is tested in connect_to_peer, but we need a mock transport
2025-11-09T23:42:54.9943186Z      // For now, verify the structure exists
2025-11-09T23:42:54.9943663Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:54:
2025-11-09T23:42:54.9943844Z      let test_ip = "127.0.0.1".parse().unwrap();
2025-11-09T23:42:54.9943953Z -    
2025-11-09T23:42:54.9944061Z +
2025-11-09T23:42:54.9944286Z      // Connection limits are enforced in connect_to_peer
2025-11-09T23:42:54.9947062Z      // Integration test needed for full verification
2025-11-09T23:42:54.9947403Z      assert!(true); // Placeholder - per-IP limits tested in integration
2025-11-09T23:42:54.9947906Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:62:
2025-11-09T23:42:54.9948061Z  async fn test_ban_list_cleanup() {
2025-11-09T23:42:54.9948275Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:42:54.9948457Z      let manager = NetworkManager::new(addr);
2025-11-09T23:42:54.9948813Z -    
2025-11-09T23:42:54.9948939Z +
2025-11-09T23:42:54.9949111Z      // Test that expired bans are cleaned up
2025-11-09T23:42:54.9949296Z      use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:42:54.9949449Z      let now = SystemTime::now()
2025-11-09T23:42:54.9949930Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:69:
2025-11-09T23:42:54.9950100Z          .duration_since(UNIX_EPOCH)
2025-11-09T23:42:54.9950221Z          .unwrap()
2025-11-09T23:42:54.9950342Z          .as_secs();
2025-11-09T23:42:54.9950449Z -    
2025-11-09T23:42:54.9950640Z +
2025-11-09T23:42:54.9950939Z      let test_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:42:54.9951041Z -    
2025-11-09T23:42:54.9951149Z +
2025-11-09T23:42:54.9951317Z      // Ban with expiration in the past
2025-11-09T23:42:54.9951502Z      let past_timestamp = now - 3600; // 1 hour ago
2025-11-09T23:42:54.9951693Z      manager.ban_peer(test_addr, past_timestamp);
2025-11-09T23:42:54.9952195Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:78:
2025-11-09T23:42:54.9952305Z -    
2025-11-09T23:42:54.9952414Z +
2025-11-09T23:42:54.9952649Z      // is_banned should automatically clean up expired bans
2025-11-09T23:42:54.9952833Z      let was_banned = manager.is_banned(test_addr);
2025-11-09T23:42:54.9953130Z      assert!(!was_banned, "Expired ban should be automatically removed");
2025-11-09T23:42:54.9953585Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:82:
2025-11-09T23:42:54.9953702Z -    
2025-11-09T23:42:54.9953807Z +
2025-11-09T23:42:54.9953951Z      // Verify ban was removed
2025-11-09T23:42:54.9954133Z      let banned = manager.get_banned_peers();
2025-11-09T23:42:54.9956432Z -    assert!(!banned.iter().any(|(addr, _)| *addr == test_addr), 
2025-11-09T23:42:54.9956618Z -            "Expired ban should not be in ban list");
2025-11-09T23:42:54.9956731Z +    assert!(
2025-11-09T23:42:54.9956937Z +        !banned.iter().any(|(addr, _)| *addr == test_addr),
2025-11-09T23:42:54.9957095Z +        "Expired ban should not be in ban list"
2025-11-09T23:42:54.9957200Z +    );
2025-11-09T23:42:54.9957311Z  }
2025-11-09T23:42:54.9957412Z  
2025-11-09T23:42:54.9957535Z  #[tokio::test]
2025-11-09T23:42:54.9957992Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:90:
2025-11-09T23:42:54.9958162Z  async fn test_ban_list_permanent() {
2025-11-09T23:42:54.9958367Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:42:54.9958551Z      let manager = NetworkManager::new(addr);
2025-11-09T23:42:54.9958889Z -    
2025-11-09T23:42:54.9958991Z +
2025-11-09T23:42:54.9959243Z      let test_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:42:54.9959353Z -    
2025-11-09T23:42:54.9959456Z +
2025-11-09T23:42:54.9959618Z      // Test permanent ban (timestamp = 0)
2025-11-09T23:42:54.9959766Z      manager.ban_peer(test_addr, 0);
2025-11-09T23:42:54.9960090Z -    assert!(manager.is_banned(test_addr), "Permanent ban should be active");
2025-11-09T23:42:54.9960198Z -    
2025-11-09T23:42:54.9960312Z +    assert!(
2025-11-09T23:42:54.9960472Z +        manager.is_banned(test_addr),
2025-11-09T23:42:54.9960629Z +        "Permanent ban should be active"
2025-11-09T23:42:54.9960739Z +    );
2025-11-09T23:42:54.9960846Z +
2025-11-09T23:42:54.9960970Z      // Clean up
2025-11-09T23:42:54.9961121Z      manager.unban_peer(test_addr);
2025-11-09T23:42:54.9961462Z -    assert!(!manager.is_banned(test_addr), "Unbanned peer should not be banned");
2025-11-09T23:42:54.9961589Z +    assert!(
2025-11-09T23:42:54.9961747Z +        !manager.is_banned(test_addr),
2025-11-09T23:42:54.9961907Z +        "Unbanned peer should not be banned"
2025-11-09T23:42:54.9962014Z +    );
2025-11-09T23:42:54.9962124Z  }
2025-11-09T23:42:54.9962228Z  
2025-11-09T23:42:54.9962352Z  #[tokio::test]
2025-11-09T23:42:54.9963035Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:106:
2025-11-09T23:42:54.9963210Z  async fn test_ban_list_temporary() {
2025-11-09T23:42:54.9963428Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:42:54.9963604Z      let manager = NetworkManager::new(addr);
2025-11-09T23:42:54.9963719Z -    
2025-11-09T23:42:54.9963825Z +
2025-11-09T23:42:54.9963993Z      use std::time::{SystemTime, UNIX_EPOCH};
2025-11-09T23:42:54.9964148Z      let now = SystemTime::now()
2025-11-09T23:42:54.9964290Z          .duration_since(UNIX_EPOCH)
2025-11-09T23:42:54.9964774Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:113:
2025-11-09T23:42:54.9964901Z          .unwrap()
2025-11-09T23:42:54.9965014Z          .as_secs();
2025-11-09T23:42:54.9965117Z -    
2025-11-09T23:42:54.9965222Z +
2025-11-09T23:42:54.9965484Z      let test_addr: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:42:54.9965594Z -    
2025-11-09T23:42:54.9965699Z +
2025-11-09T23:42:54.9965867Z      // Test temporary ban (1 hour from now)
2025-11-09T23:42:54.9966029Z      let future_timestamp = now + 3600;
2025-11-09T23:42:54.9966404Z      manager.ban_peer(test_addr, future_timestamp);
2025-11-09T23:42:54.9966892Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:121:
2025-11-09T23:42:54.9967262Z -    assert!(manager.is_banned(test_addr), "Active temporary ban should be active");
2025-11-09T23:42:54.9967373Z -    
2025-11-09T23:42:54.9967487Z +    assert!(
2025-11-09T23:42:54.9967648Z +        manager.is_banned(test_addr),
2025-11-09T23:42:54.9967833Z +        "Active temporary ban should be active"
2025-11-09T23:42:54.9967946Z +    );
2025-11-09T23:42:54.9968056Z +
2025-11-09T23:42:54.9968187Z      // Clean up
2025-11-09T23:42:54.9968340Z      manager.unban_peer(test_addr);
2025-11-09T23:42:54.9968971Z  }
2025-11-09T23:42:54.9969512Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:128:
2025-11-09T23:42:54.9969678Z  async fn test_clear_bans() {
2025-11-09T23:42:54.9969905Z      let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
2025-11-09T23:42:54.9970103Z      let manager = NetworkManager::new(addr);
2025-11-09T23:42:54.9970223Z -    
2025-11-09T23:42:54.9970334Z +
2025-11-09T23:42:54.9970584Z      let test_addr1: SocketAddr = "127.0.0.1:8333".parse().unwrap();
2025-11-09T23:42:54.9970843Z      let test_addr2: SocketAddr = "127.0.0.1:8334".parse().unwrap();
2025-11-09T23:42:54.9970956Z -    
2025-11-09T23:42:54.9971065Z +
2025-11-09T23:42:54.9971204Z      // Add multiple bans
2025-11-09T23:42:54.9971636Z      manager.ban_peer(test_addr1, 0);
2025-11-09T23:42:54.9971792Z      manager.ban_peer(test_addr2, 0);
2025-11-09T23:42:54.9972277Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:138:
2025-11-09T23:42:54.9972394Z -    
2025-11-09T23:42:54.9972505Z +
2025-11-09T23:42:54.9972714Z      assert_eq!(manager.get_banned_peers().len(), 2);
2025-11-09T23:42:54.9972841Z -    
2025-11-09T23:42:54.9972958Z +
2025-11-09T23:42:54.9973087Z      // Clear all bans
2025-11-09T23:42:54.9973225Z      manager.clear_bans();
2025-11-09T23:42:54.9973341Z -    
2025-11-09T23:42:54.9973639Z +
2025-11-09T23:42:54.9973839Z      assert_eq!(manager.get_banned_peers().len(), 0);
2025-11-09T23:42:54.9974008Z      assert!(!manager.is_banned(test_addr1));
2025-11-09T23:42:54.9974177Z      assert!(!manager.is_banned(test_addr2));
2025-11-09T23:42:54.9974837Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/security_tests.rs:147:
2025-11-09T23:42:54.9974958Z  }
2025-11-09T23:42:54.9975080Z -
2025-11-09T23:42:54.9975186Z  
2025-11-09T23:42:54.9975671Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:2:
2025-11-09T23:42:54.9975773Z  
2025-11-09T23:42:54.9975872Z  #[cfg(test)]
2025-11-09T23:42:54.9975972Z  mod tests {
2025-11-09T23:42:54.9976200Z +    use bllvm_node::network::protocol::NetworkAddress;
2025-11-09T23:42:54.9976654Z      use bllvm_node::network::protocol::VersionMessage;
2025-11-09T23:42:54.9977250Z -    use bllvm_node::network::protocol::{NODE_UTXO_COMMITMENTS, NODE_BAN_LIST_SHARING, NODE_PACKAGE_RELAY, NODE_FIBRE};
2025-11-09T23:42:54.9977416Z +    use bllvm_node::network::protocol::{
2025-11-09T23:42:54.9977778Z +        NODE_BAN_LIST_SHARING, NODE_FIBRE, NODE_PACKAGE_RELAY, NODE_UTXO_COMMITMENTS,
2025-11-09T23:42:54.9977888Z +    };
2025-11-09T23:42:54.9978099Z      use bllvm_protocol::bip157::NODE_COMPACT_FILTERS;
2025-11-09T23:42:54.9978319Z -    use bllvm_node::network::protocol::NetworkAddress;
2025-11-09T23:42:54.9978440Z  
2025-11-09T23:42:54.9978705Z      fn create_version_message(services: u64) -> VersionMessage {
2025-11-09T23:42:54.9978837Z          VersionMessage {
2025-11-09T23:42:54.9979374Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:36:
2025-11-09T23:42:54.9979547Z              // Peer with UTXO commitments support
2025-11-09T23:42:54.9979717Z              let services = NODE_UTXO_COMMITMENTS;
2025-11-09T23:42:54.9979925Z              let version = create_version_message(services);
2025-11-09T23:42:54.9980329Z -            assert!(version.supports_utxo_commitments(), "Should support UTXO commitments");
2025-11-09T23:42:54.9980448Z +            assert!(
2025-11-09T23:42:54.9980620Z +                version.supports_utxo_commitments(),
2025-11-09T23:42:54.9980788Z +                "Should support UTXO commitments"
2025-11-09T23:42:54.9980897Z +            );
2025-11-09T23:42:54.9981001Z  
2025-11-09T23:42:54.9981178Z              // Peer without UTXO commitments support
2025-11-09T23:42:54.9981317Z              let services = 0;
2025-11-09T23:42:54.9981839Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:43:
2025-11-09T23:42:54.9982044Z              let version = create_version_message(services);
2025-11-09T23:42:54.9982481Z -            assert!(!version.supports_utxo_commitments(), "Should not support UTXO commitments");
2025-11-09T23:42:54.9982607Z +            assert!(
2025-11-09T23:42:54.9982793Z +                !version.supports_utxo_commitments(),
2025-11-09T23:42:54.9982977Z +                "Should not support UTXO commitments"
2025-11-09T23:42:54.9983091Z +            );
2025-11-09T23:42:54.9983199Z  
2025-11-09T23:42:54.9983443Z              // Peer with multiple flags including UTXO commitments
2025-11-09T23:42:54.9983825Z              let services = NODE_UTXO_COMMITMENTS | NODE_COMPACT_FILTERS | NODE_PACKAGE_RELAY;
2025-11-09T23:42:54.9984508Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:48:
2025-11-09T23:42:54.9984959Z              let version = create_version_message(services);
2025-11-09T23:42:54.9985463Z -            assert!(version.supports_utxo_commitments(), "Should support UTXO commitments with other flags");
2025-11-09T23:42:54.9985883Z -            assert!(version.supports_compact_filters(), "Should also support compact filters");
2025-11-09T23:42:54.9986329Z -            assert!(version.supports_package_relay(), "Should also support package relay");
2025-11-09T23:42:54.9986459Z +            assert!(
2025-11-09T23:42:54.9986647Z +                version.supports_utxo_commitments(),
2025-11-09T23:42:54.9986872Z +                "Should support UTXO commitments with other flags"
2025-11-09T23:42:54.9986997Z +            );
2025-11-09T23:42:54.9987115Z +            assert!(
2025-11-09T23:42:54.9987293Z +                version.supports_compact_filters(),
2025-11-09T23:42:54.9987473Z +                "Should also support compact filters"
2025-11-09T23:42:54.9987599Z +            );
2025-11-09T23:42:54.9987719Z +            assert!(
2025-11-09T23:42:54.9987886Z +                version.supports_package_relay(),
2025-11-09T23:42:54.9988042Z +                "Should also support package relay"
2025-11-09T23:42:54.9988152Z +            );
2025-11-09T23:42:54.9988258Z          }
2025-11-09T23:42:54.9988380Z      }
2025-11-09T23:42:54.9988698Z  
2025-11-09T23:42:54.9989246Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:57:
2025-11-09T23:42:54.9989412Z          // Peer with ban list sharing support
2025-11-09T23:42:54.9989575Z          let services = NODE_BAN_LIST_SHARING;
2025-11-09T23:42:54.9989772Z          let version = create_version_message(services);
2025-11-09T23:42:54.9990164Z -        assert!(version.supports_ban_list_sharing(), "Should support ban list sharing");
2025-11-09T23:42:54.9990285Z +        assert!(
2025-11-09T23:42:54.9990453Z +            version.supports_ban_list_sharing(),
2025-11-09T23:42:54.9990617Z +            "Should support ban list sharing"
2025-11-09T23:42:54.9990726Z +        );
2025-11-09T23:42:54.9990838Z  
2025-11-09T23:42:54.9991007Z          // Peer without ban list sharing support
2025-11-09T23:42:54.9991142Z          let services = 0;
2025-11-09T23:42:54.9991684Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:64:
2025-11-09T23:42:54.9991896Z          let version = create_version_message(services);
2025-11-09T23:42:54.9992312Z -        assert!(!version.supports_ban_list_sharing(), "Should not support ban list sharing");
2025-11-09T23:42:54.9992442Z +        assert!(
2025-11-09T23:42:54.9992622Z +            !version.supports_ban_list_sharing(),
2025-11-09T23:42:54.9992787Z +            "Should not support ban list sharing"
2025-11-09T23:42:54.9992897Z +        );
2025-11-09T23:42:54.9993009Z  
2025-11-09T23:42:54.9993229Z          // Peer with multiple flags including ban list sharing
2025-11-09T23:42:54.9993551Z          let services = NODE_BAN_LIST_SHARING | NODE_COMPACT_FILTERS | NODE_FIBRE;
2025-11-09T23:42:54.9994075Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:69:
2025-11-09T23:42:54.9994276Z          let version = create_version_message(services);
2025-11-09T23:42:54.9994950Z -        assert!(version.supports_ban_list_sharing(), "Should support ban list sharing with other flags");
2025-11-09T23:42:54.9995389Z -        assert!(version.supports_compact_filters(), "Should also support compact filters");
2025-11-09T23:42:54.9995513Z +        assert!(
2025-11-09T23:42:54.9995689Z +            version.supports_ban_list_sharing(),
2025-11-09T23:42:54.9995910Z +            "Should support ban list sharing with other flags"
2025-11-09T23:42:54.9996030Z +        );
2025-11-09T23:42:54.9996147Z +        assert!(
2025-11-09T23:42:54.9996318Z +            version.supports_compact_filters(),
2025-11-09T23:42:54.9996493Z +            "Should also support compact filters"
2025-11-09T23:42:54.9996901Z +        );
2025-11-09T23:42:54.9997212Z          assert!(version.supports_fibre(), "Should also support FIBRE");
2025-11-09T23:42:54.9997328Z      }
2025-11-09T23:42:54.9997447Z  
2025-11-09T23:42:54.9997972Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:77:
2025-11-09T23:42:54.9998157Z          // Peer with compact filters support
2025-11-09T23:42:54.9998331Z          let services = NODE_COMPACT_FILTERS;
2025-11-09T23:42:54.9998535Z          let version = create_version_message(services);
2025-11-09T23:42:54.9998910Z -        assert!(version.supports_compact_filters(), "Should support compact filters");
2025-11-09T23:42:54.9999034Z +        assert!(
2025-11-09T23:42:54.9999210Z +            version.supports_compact_filters(),
2025-11-09T23:42:54.9999373Z +            "Should support compact filters"
2025-11-09T23:42:54.9999485Z +        );
2025-11-09T23:42:54.9999607Z  
2025-11-09T23:42:54.9999775Z          // Peer without compact filters support
2025-11-09T23:42:54.9999920Z          let services = 0;
2025-11-09T23:42:55.0000445Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:84:
2025-11-09T23:42:55.0000650Z          let version = create_version_message(services);
2025-11-09T23:42:55.0001262Z -        assert!(!version.supports_compact_filters(), "Should not support compact filters");
2025-11-09T23:42:55.0001397Z +        assert!(
2025-11-09T23:42:55.0001573Z +            !version.supports_compact_filters(),
2025-11-09T23:42:55.0001727Z +            "Should not support compact filters"
2025-11-09T23:42:55.0001836Z +        );
2025-11-09T23:42:55.0001949Z      }
2025-11-09T23:42:55.0002055Z  
2025-11-09T23:42:55.0002161Z      #[test]
2025-11-09T23:42:55.0002665Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:90:
2025-11-09T23:42:55.0002843Z          // Peer with package relay support
2025-11-09T23:42:55.0003008Z          let services = NODE_PACKAGE_RELAY;
2025-11-09T23:42:55.0003211Z          let version = create_version_message(services);
2025-11-09T23:42:55.0003586Z -        assert!(version.supports_package_relay(), "Should support package relay");
2025-11-09T23:42:55.0003703Z +        assert!(
2025-11-09T23:42:55.0003874Z +            version.supports_package_relay(),
2025-11-09T23:42:55.0004054Z +            "Should support package relay"
2025-11-09T23:42:55.0004168Z +        );
2025-11-09T23:42:55.0004279Z  
2025-11-09T23:42:55.0004624Z          // Peer without package relay support
2025-11-09T23:42:55.0004771Z          let services = 0;
2025-11-09T23:42:55.0005296Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:97:
2025-11-09T23:42:55.0005498Z          let version = create_version_message(services);
2025-11-09T23:42:55.0005886Z -        assert!(!version.supports_package_relay(), "Should not support package relay");
2025-11-09T23:42:55.0006005Z +        assert!(
2025-11-09T23:42:55.0006183Z +            !version.supports_package_relay(),
2025-11-09T23:42:55.0006342Z +            "Should not support package relay"
2025-11-09T23:42:55.0006460Z +        );
2025-11-09T23:42:55.0006568Z      }
2025-11-09T23:42:55.0006677Z  
2025-11-09T23:42:55.0006796Z      #[test]
2025-11-09T23:42:55.0007325Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:115:
2025-11-09T23:42:55.0007472Z      fn test_multiple_flags() {
2025-11-09T23:42:55.0007606Z          // Peer with all flags
2025-11-09T23:42:55.0007775Z          #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:55.0008174Z -        let services = NODE_UTXO_COMMITMENTS | NODE_BAN_LIST_SHARING | NODE_COMPACT_FILTERS | 
2025-11-09T23:42:55.0008343Z -                      NODE_PACKAGE_RELAY | NODE_FIBRE;
2025-11-09T23:42:55.0008943Z +        let services = NODE_UTXO_COMMITMENTS
2025-11-09T23:42:55.0009554Z +            | NODE_BAN_LIST_SHARING
2025-11-09T23:42:55.0009693Z +            | NODE_COMPACT_FILTERS
2025-11-09T23:42:55.0010049Z +            | NODE_PACKAGE_RELAY
2025-11-09T23:42:55.0010167Z +            | NODE_FIBRE;
2025-11-09T23:42:55.0010346Z          #[cfg(not(feature = "utxo-commitments"))]
2025-11-09T23:42:55.0010623Z -        let services = NODE_BAN_LIST_SHARING | NODE_COMPACT_FILTERS | 
2025-11-09T23:42:55.0010795Z -                      NODE_PACKAGE_RELAY | NODE_FIBRE;
2025-11-09T23:42:55.0010931Z +        let services =
2025-11-09T23:42:55.0011293Z +            NODE_BAN_LIST_SHARING | NODE_COMPACT_FILTERS | NODE_PACKAGE_RELAY | NODE_FIBRE;
2025-11-09T23:42:55.0011491Z          let version = create_version_message(services);
2025-11-09T23:42:55.0011601Z -        
2025-11-09T23:42:55.0011713Z +
2025-11-09T23:42:55.0011880Z          #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:55.0012286Z -        assert!(version.supports_utxo_commitments(), "Should support UTXO commitments");
2025-11-09T23:42:55.0012672Z -        assert!(version.supports_ban_list_sharing(), "Should support ban list sharing");
2025-11-09T23:42:55.0013065Z -        assert!(version.supports_compact_filters(), "Should support compact filters");
2025-11-09T23:42:55.0013437Z -        assert!(version.supports_package_relay(), "Should support package relay");
2025-11-09T23:42:55.0013554Z +        assert!(
2025-11-09T23:42:55.0013938Z +            version.supports_utxo_commitments(),
2025-11-09T23:42:55.0014478Z +            "Should support UTXO commitments"
2025-11-09T23:42:55.0014613Z +        );
2025-11-09T23:42:55.0014733Z +        assert!(
2025-11-09T23:42:55.0015396Z +            version.supports_ban_list_sharing(),
2025-11-09T23:42:55.0015608Z +            "Should support ban list sharing"
2025-11-09T23:42:55.0015730Z +        );
2025-11-09T23:42:55.0015843Z +        assert!(
2025-11-09T23:42:55.0016025Z +            version.supports_compact_filters(),
2025-11-09T23:42:55.0016189Z +            "Should support compact filters"
2025-11-09T23:42:55.0016302Z +        );
2025-11-09T23:42:55.0016415Z +        assert!(
2025-11-09T23:42:55.0016595Z +            version.supports_package_relay(),
2025-11-09T23:42:55.0019083Z +            "Should support package relay"
2025-11-09T23:42:55.0019215Z +        );
2025-11-09T23:42:55.0019509Z          assert!(version.supports_fibre(), "Should support FIBRE");
2025-11-09T23:42:55.0019621Z      }
2025-11-09T23:42:55.0019733Z  
2025-11-09T23:42:55.0020281Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:137:
2025-11-09T23:42:55.0020399Z          {
2025-11-09T23:42:55.0020575Z              let services = NODE_UTXO_COMMITMENTS;
2025-11-09T23:42:55.0020783Z              let version = create_version_message(services);
2025-11-09T23:42:55.0020895Z -            
2025-11-09T23:42:55.0021299Z -            assert!(version.supports_utxo_commitments(), "Should support UTXO commitments");
2025-11-09T23:42:55.0021733Z -            assert!(!version.supports_ban_list_sharing(), "Should not support ban list sharing");
2025-11-09T23:42:55.0022147Z -            assert!(!version.supports_compact_filters(), "Should not support compact filters");
2025-11-09T23:42:55.0022269Z +
2025-11-09T23:42:55.0022400Z +            assert!(
2025-11-09T23:42:55.0022583Z +                version.supports_utxo_commitments(),
2025-11-09T23:42:55.0022749Z +                "Should support UTXO commitments"
2025-11-09T23:42:55.0022863Z +            );
2025-11-09T23:42:55.0022987Z +            assert!(
2025-11-09T23:42:55.0023178Z +                !version.supports_ban_list_sharing(),
2025-11-09T23:42:55.0023347Z +                "Should not support ban list sharing"
2025-11-09T23:42:55.0023474Z +            );
2025-11-09T23:42:55.0023593Z +            assert!(
2025-11-09T23:42:55.0023766Z +                !version.supports_compact_filters(),
2025-11-09T23:42:55.0023944Z +                "Should not support compact filters"
2025-11-09T23:42:55.0024056Z +            );
2025-11-09T23:42:55.0024165Z          }
2025-11-09T23:42:55.0024274Z      }
2025-11-09T23:42:55.0024569Z  
2025-11-09T23:42:55.0025348Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:149:
2025-11-09T23:42:55.0025526Z          // Verify bit positions don't overlap
2025-11-09T23:42:55.0025701Z          #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:55.0025816Z          {
2025-11-09T23:42:55.0028083Z -            assert_eq!(NODE_UTXO_COMMITMENTS, 1 << 27, "UTXO commitments should be bit 27");
2025-11-09T23:42:55.0028214Z +            assert_eq!(
2025-11-09T23:42:55.0028364Z +                NODE_UTXO_COMMITMENTS,
2025-11-09T23:42:55.0028480Z +                1 << 27,
2025-11-09T23:42:55.0028647Z +                "UTXO commitments should be bit 27"
2025-11-09T23:42:55.0028769Z +            );
2025-11-09T23:42:55.0028941Z          }
2025-11-09T23:42:55.0029277Z -        assert_eq!(NODE_BAN_LIST_SHARING, 1 << 28, "Ban list sharing should be bit 28");
2025-11-09T23:42:55.0029600Z -        assert_eq!(NODE_PACKAGE_RELAY, 1 << 25, "Package relay should be bit 25");
2025-11-09T23:42:55.0029738Z +        assert_eq!(
2025-11-09T23:42:55.0029881Z +            NODE_BAN_LIST_SHARING,
2025-11-09T23:42:55.0029995Z +            1 << 28,
2025-11-09T23:42:55.0030167Z +            "Ban list sharing should be bit 28"
2025-11-09T23:42:55.0030279Z +        );
2025-11-09T23:42:55.0030400Z +        assert_eq!(
2025-11-09T23:42:55.0030542Z +            NODE_PACKAGE_RELAY,
2025-11-09T23:42:55.0030879Z +            1 << 25,
2025-11-09T23:42:55.0031062Z +            "Package relay should be bit 25"
2025-11-09T23:42:55.0031175Z +        );
2025-11-09T23:42:55.0031426Z          assert_eq!(NODE_FIBRE, 1 << 26, "FIBRE should be bit 26");
2025-11-09T23:42:55.0031539Z -        
2025-11-09T23:42:55.0031650Z +
2025-11-09T23:42:55.0031787Z          // Verify no overlap
2025-11-09T23:42:55.0031961Z          #[cfg(feature = "utxo-commitments")]
2025-11-09T23:42:55.0032072Z          {
2025-11-09T23:42:55.0032601Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/service_flags_tests.rs:161:
2025-11-09T23:42:55.0033026Z -            assert_eq!(NODE_UTXO_COMMITMENTS & NODE_BAN_LIST_SHARING, 0, "Flags should not overlap");
2025-11-09T23:42:55.0033423Z -            assert_eq!(NODE_UTXO_COMMITMENTS & NODE_PACKAGE_RELAY, 0, "Flags should not overlap");
2025-11-09T23:42:55.0033778Z -            assert_eq!(NODE_UTXO_COMMITMENTS & NODE_FIBRE, 0, "Flags should not overlap");
2025-11-09T23:42:55.0033921Z +            assert_eq!(
2025-11-09T23:42:55.0034131Z +                NODE_UTXO_COMMITMENTS & NODE_BAN_LIST_SHARING,
2025-11-09T23:42:55.0034246Z +                0,
2025-11-09T23:42:55.0036525Z +                "Flags should not overlap"
2025-11-09T23:42:55.0036649Z +            );
2025-11-09T23:42:55.0036772Z +            assert_eq!(
2025-11-09T23:42:55.0036973Z +                NODE_UTXO_COMMITMENTS & NODE_PACKAGE_RELAY,
2025-11-09T23:42:55.0037093Z +                0,
2025-11-09T23:42:55.0037239Z +                "Flags should not overlap"
2025-11-09T23:42:55.0037347Z +            );
2025-11-09T23:42:55.0037484Z +            assert_eq!(
2025-11-09T23:42:55.0037650Z +                NODE_UTXO_COMMITMENTS & NODE_FIBRE,
2025-11-09T23:42:55.0037767Z +                0,
2025-11-09T23:42:55.0037915Z +                "Flags should not overlap"
2025-11-09T23:42:55.0038035Z +            );
2025-11-09T23:42:55.0038142Z          }
2025-11-09T23:42:55.0039391Z -        assert_eq!(NODE_BAN_LIST_SHARING & NODE_PACKAGE_RELAY, 0, "Flags should not overlap");
2025-11-09T23:42:55.0039756Z -        assert_eq!(NODE_BAN_LIST_SHARING & NODE_FIBRE, 0, "Flags should not overlap");
2025-11-09T23:42:55.0040451Z -        assert_eq!(NODE_PACKAGE_RELAY & NODE_FIBRE, 0, "Flags should not overlap");
2025-11-09T23:42:55.0040587Z +        assert_eq!(
2025-11-09T23:42:55.0040785Z +            NODE_BAN_LIST_SHARING & NODE_PACKAGE_RELAY,
2025-11-09T23:42:55.0040907Z +            0,
2025-11-09T23:42:55.0041055Z +            "Flags should not overlap"
2025-11-09T23:42:55.0041168Z +        );
2025-11-09T23:42:55.0041296Z +        assert_eq!(
2025-11-09T23:42:55.0041723Z +            NODE_BAN_LIST_SHARING & NODE_FIBRE,
2025-11-09T23:42:55.0041842Z +            0,
2025-11-09T23:42:55.0041988Z +            "Flags should not overlap"
2025-11-09T23:42:55.0042108Z +        );
2025-11-09T23:42:55.0042227Z +        assert_eq!(
2025-11-09T23:42:55.0042389Z +            NODE_PACKAGE_RELAY & NODE_FIBRE,
2025-11-09T23:42:55.0042510Z +            0,
2025-11-09T23:42:55.0042659Z +            "Flags should not overlap"
2025-11-09T23:42:55.0042778Z +        );
2025-11-09T23:42:55.0042890Z      }
2025-11-09T23:42:55.0043005Z  }
2025-11-09T23:42:55.0043112Z -
2025-11-09T23:42:55.0043223Z  
2025-11-09T23:42:55.0043746Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/storage_arcs_tests.rs:1:
2025-11-09T23:42:55.0043911Z  //! Tests for Storage Arc refactoring
2025-11-09T23:42:55.0044042Z  
2025-11-09T23:42:55.0044205Z -use bllvm_node::storage::Storage;
2025-11-09T23:42:55.0046532Z  use bllvm_node::network::chain_access::NodeChainAccess;
2025-11-09T23:42:55.0046750Z  use bllvm_node::node::mempool::MempoolManager;
2025-11-09T23:42:55.0046902Z +use bllvm_node::storage::Storage;
2025-11-09T23:42:55.0047030Z  use std::sync::Arc;
2025-11-09T23:42:55.0047174Z  use tempfile::TempDir;
2025-11-09T23:42:55.0047292Z  
2025-11-09T23:42:55.0047807Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/storage_arcs_tests.rs:10:
2025-11-09T23:42:55.0048222Z  fn test_storage_returns_arcs() {
2025-11-09T23:42:55.0048429Z      let temp_dir = TempDir::new().unwrap();
2025-11-09T23:42:55.0048661Z      let storage = Storage::new(temp_dir.path()).unwrap();
2025-11-09T23:42:55.0048775Z -    
2025-11-09T23:42:55.0048883Z +
2025-11-09T23:42:55.0049034Z      // Verify blocks() returns Arc
2025-11-09T23:42:55.0049187Z      let blocks_arc = storage.blocks();
2025-11-09T23:42:55.0049341Z      let blocks_arc2 = storage.blocks();
2025-11-09T23:42:55.0059398Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/storage_arcs_tests.rs:17:
2025-11-09T23:42:55.0059559Z -    
2025-11-09T23:42:55.0059676Z +
2025-11-09T23:42:55.0059863Z      // Both should be valid Arcs (can clone)
2025-11-09T23:42:55.0060279Z      assert!(Arc::ptr_eq(&blocks_arc, &blocks_arc2) || blocks_arc.block_count().is_ok());
2025-11-09T23:42:55.0060395Z -    
2025-11-09T23:42:55.0060599Z +
2025-11-09T23:42:55.0060777Z      // Verify transactions() returns Arc
2025-11-09T23:42:55.0060952Z      let tx_arc = storage.transactions();
2025-11-09T23:42:55.0061110Z      let tx_arc2 = storage.transactions();
2025-11-09T23:42:55.0061628Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/storage_arcs_tests.rs:24:
2025-11-09T23:42:55.0061740Z -    
2025-11-09T23:42:55.0061850Z +
2025-11-09T23:42:55.0063995Z      assert!(Arc::ptr_eq(&tx_arc, &tx_arc2) || tx_arc.has_transaction(&[0u8; 32]).is_ok());
2025-11-09T23:42:55.0064119Z  }
2025-11-09T23:42:55.0064233Z  
2025-11-09T23:42:55.0064928Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/storage_arcs_tests.rs:30:
2025-11-09T23:42:55.0065146Z      let temp_dir = TempDir::new().unwrap();
2025-11-09T23:42:55.0065381Z      let storage = Storage::new(temp_dir.path()).unwrap();
2025-11-09T23:42:55.0065580Z      let mempool = Arc::new(MempoolManager::new());
2025-11-09T23:42:55.0065694Z -    
2025-11-09T23:42:55.0065803Z +
2025-11-09T23:42:55.0066093Z      // Should be able to create NodeChainAccess with Arcs from Storage
2025-11-09T23:42:55.0066281Z -    let chain_access = NodeChainAccess::new(
2025-11-09T23:42:55.0066431Z -        storage.blocks(),
2025-11-09T23:42:55.0066584Z -        storage.transactions(),
2025-11-09T23:42:55.0066705Z -        mempool,
2025-11-09T23:42:55.0066827Z -    );
2025-11-09T23:42:55.0066935Z -    
2025-11-09T23:42:55.0067397Z +    let chain_access = NodeChainAccess::new(storage.blocks(), storage.transactions(), mempool);
2025-11-09T23:42:55.0067514Z +
2025-11-09T23:42:55.0067653Z      // Verify it works
2025-11-09T23:42:55.0067784Z      let hash = [0u8; 32];
2025-11-09T23:42:55.0068258Z      let has_object = chain_access.has_object(&hash);
2025-11-09T23:42:55.0068789Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/storage_arcs_tests.rs:44:
2025-11-09T23:42:55.0069039Z      assert!(!has_object); // Empty storage, so should be false
2025-11-09T23:42:55.0069152Z  }
2025-11-09T23:42:55.0069261Z -
2025-11-09T23:42:55.0069424Z  
2025-11-09T23:42:55.0069877Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:1:
2025-11-09T23:42:55.0070063Z -use bllvm_protocol::ProtocolVersion;
2025-11-09T23:42:55.0070283Z  use bllvm_node::storage::blockstore::BlockStore;
2025-11-09T23:42:55.0070477Z  use bllvm_node::storage::chainstate::ChainState;
2025-11-09T23:42:55.0070648Z  use bllvm_node::storage::txindex::TxIndex;
2025-11-09T23:42:55.0071064Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:9:
2025-11-09T23:42:55.0071208Z  use bllvm_node::OutPoint;
2025-11-09T23:42:55.0071358Z  use bllvm_node::Transaction;
2025-11-09T23:42:55.0071691Z  use bllvm_node::{ByteString, TransactionInput, TransactionOutput};
2025-11-09T23:42:55.0071864Z +use bllvm_protocol::ProtocolVersion;
2025-11-09T23:42:55.0072018Z  use std::collections::HashMap;
2025-11-09T23:42:55.0072159Z  use tempfile::TempDir;
2025-11-09T23:42:55.0072281Z  
2025-11-09T23:42:55.0086863Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/storage_tests.rs:4:
2025-11-09T23:42:55.0087087Z  use bllvm_node::storage::*;
2025-11-09T23:42:55.0087247Z  use tempfile::TempDir;
2025-11-09T23:42:55.0087365Z  mod common;
2025-11-09T23:42:55.0087489Z -use common::*;
2025-11-09T23:42:55.0087702Z  use bllvm_node::storage::blockstore::BlockStore;
2025-11-09T23:42:55.0087894Z  use bllvm_node::storage::chainstate::ChainState;
2025-11-09T23:42:55.0088075Z  use bllvm_node::storage::txindex::TxIndex;
2025-11-09T23:42:55.0088638Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/storage_tests.rs:11:
2025-11-09T23:42:55.0088858Z  use bllvm_node::storage::utxostore::UtxoStore;
2025-11-09T23:42:55.0088986Z +use common::*;
2025-11-09T23:42:55.0089091Z  
2025-11-09T23:42:55.0089219Z  #[test]
2025-11-09T23:42:55.0089370Z  fn test_storage_creation() {
2025-11-09T23:42:55.0110131Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:1:
2025-11-09T23:42:55.0110698Z -use bllvm_protocol::ProtocolVersion;
2025-11-09T23:42:55.0111122Z  use bllvm_node::storage::blockstore::BlockStore;
2025-11-09T23:42:55.0111326Z  use bllvm_node::storage::chainstate::ChainState;
2025-11-09T23:42:55.0111504Z  use bllvm_node::storage::txindex::TxIndex;
2025-11-09T23:42:55.0111943Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/common.rs:9:
2025-11-09T23:42:55.0112092Z  use bllvm_node::OutPoint;
2025-11-09T23:42:55.0112242Z  use bllvm_node::Transaction;
2025-11-09T23:42:55.0112557Z  use bllvm_node::{ByteString, TransactionInput, TransactionOutput};
2025-11-09T23:42:55.0112731Z +use bllvm_protocol::ProtocolVersion;
2025-11-09T23:42:55.0112893Z  use std::collections::HashMap;
2025-11-09T23:42:55.0113032Z  use tempfile::TempDir;
2025-11-09T23:42:55.0113154Z  
2025-11-09T23:42:55.0115821Z Diff in /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node/tests/stratum_v2_mining_tests.rs:1:
2025-11-09T23:42:55.0125763Z  //! Unit tests for Stratum V2 mining and share validation
2025-11-09T23:42:55.0125885Z  
2025-11-09T23:42:55.0126177Z -use bllvm_protocol::types::{Block, BlockHeader, Hash, Natural};
2025-11-09T23:42:55.0126405Z  use bllvm_node::network::stratum_v2::messages::ShareData;
2025-11-09T23:42:55.0128099Z  use bllvm_node::network::stratum_v2::pool::{JobInfo, StratumV2Pool};
2025-11-09T23:42:55.0128362Z +use bllvm_protocol::types::{Block, BlockHeader, Hash, Natural};
2025-11-09T23:42:55.0128495Z  use tempfile::TempDir;
2025-11-09T23:42:55.0128607Z  mod common;
2025-11-09T23:42:55.0128732Z  use common::*;
2025-11-09T23:42:55.0187645Z ##[error]Process completed with exit code 1.
2025-11-09T23:42:55.0306814Z Post job cleanup.
2025-11-09T23:42:55.1682990Z Post job cleanup.
2025-11-09T23:42:55.2838387Z [command]/usr/bin/git version
2025-11-09T23:42:55.2888307Z git version 2.43.0
2025-11-09T23:42:55.2941678Z Copying '/home/jswift/.gitconfig' to '/home/jswift/actions-runner-org2/_work/_temp/a99467cc-ef3f-4393-b0f9-77ff32e46175/.gitconfig'
2025-11-09T23:42:55.2957990Z Temporarily overriding HOME='/home/jswift/actions-runner-org2/_work/_temp/a99467cc-ef3f-4393-b0f9-77ff32e46175' before making global git config changes
2025-11-09T23:42:55.2959932Z Adding repository directory to the temporary git global config as a safe directory
2025-11-09T23:42:55.2964465Z [command]/usr/bin/git config --global --add safe.directory /home/jswift/actions-runner-org2/_work/bllvm-node/bllvm-node
2025-11-09T23:42:55.3021899Z [command]/usr/bin/git config --local --name-only --get-regexp core\.sshCommand
2025-11-09T23:42:55.3070462Z [command]/usr/bin/git submodule foreach --recursive sh -c "git config --local --name-only --get-regexp 'core\.sshCommand' && git config --local --unset-all 'core.sshCommand' || :"
2025-11-09T23:42:55.3369369Z [command]/usr/bin/git config --local --name-only --get-regexp http\.https\:\/\/github\.com\/\.extraheader
2025-11-09T23:42:55.3403087Z http.https://github.com/.extraheader
2025-11-09T23:42:55.3421652Z [command]/usr/bin/git config --local --unset-all http.https://github.com/.extraheader
2025-11-09T23:42:55.3469201Z [command]/usr/bin/git submodule foreach --recursive sh -c "git config --local --name-only --get-regexp 'http\.https\:\/\/github\.com\/\.extraheader' && git config --local --unset-all 'http.https://github.com/.extraheader' || :"
2025-11-09T23:42:55.3913471Z A job completed hook has been configured by the self-hosted runner administrator
2025-11-09T23:42:55.3949459Z ##[group]Run '/home/jswift/actions-runner-org2/cleanup-hooks/job-completed.sh'
2025-11-09T23:42:55.3974850Z shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
2025-11-09T23:42:55.3975188Z ##[endgroup]
2025-11-09T23:42:55.4042071Z Job completed: Sun Nov  9 11:42:55 PM UTC 2025
2025-11-09T23:42:55.4077961Z Available disk space: 12G
2025-11-09T23:42:55.4078650Z Cleaning up after job completion...
2025-11-09T23:42:55.4891772Z Cleanup completed. Available disk space: 12G
2025-11-09T23:42:55.4945722Z Cleaning up orphan processes
